---
layout: post
title: '.NETå¼€å‘ä¸Šæ‰‹Microsoft Agent Frameworkï¼ˆä¸€ï¼‰ä»å¼€å‘ä¸€ä¸ªAIç¾å¥³èŠå¤©ç¾¤ç»„å¼€å§‹'
date: "2025-10-29T00:42:47Z"
---
.NETå¼€å‘ä¸Šæ‰‹Microsoft Agent Frameworkï¼ˆä¸€ï¼‰ä»å¼€å‘ä¸€ä¸ªAIç¾å¥³èŠå¤©ç¾¤ç»„å¼€å§‹
===================================================

å‰è¨€
--

åœ¨AIå¿«é€Ÿå‘å±•çš„ä»Šå¤©ï¼Œå¾®è½¯æ¨å‡ºäº†å¤šä¸ªAIå¼€å‘æ¡†æ¶ï¼Œä»æ—©æœŸçš„AutoGenåˆ°Semantic Kernelï¼Œå†åˆ°æœ€æ–°çš„Microsoft Agent Frameworkã€‚å¾ˆå¤šå¼€å‘è€…å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šä¸ºä»€ä¹ˆå¾®è½¯è¦æ¨å‡ºè¿™ä¹ˆå¤šæ¡†æ¶ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæœ¬æ–‡å°†é€šè¿‡ä¸€ä¸ªå®é™…çš„AIç¾å¥³èŠå¤©ç¾¤ç»„é¡¹ç›®ï¼Œå¸¦ä½ æ·±å…¥ç†è§£Microsoft Agent Frameworkï¼ŒæŒæ¡å¤šæ™ºèƒ½ä½“å¼€å‘çš„æ ¸å¿ƒæ¦‚å¿µã€‚

æœ¬æ–‡çš„ç¤ºä¾‹ä»£ç å·²å¼€æºï¼š[agent-framework-tutorial-code/agent-groupchat](https://github.com/GreenShadeZhang/agent-framework-tutorial-code/tree/main/agent-groupchat)

![æ•ˆæœæˆªå›¾](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251028221439575-1520228988.jpg)

*   [è§†é¢‘æ¼”ç¤º](https://github.com/user-attachments/assets/4d5050dc-0d9c-4dce-aca3-771c782052c3)

ä¸ºä»€ä¹ˆå¾®è½¯è¦æ¨å‡ºMicrosoft Agent Frameworkï¼Ÿ
----------------------------------

### AutoGen vs Semantic Kernel vs Agent Framework

åœ¨è®²è§£æ–°æ¡†æ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†è§£ä¸€ä¸‹å¾®è½¯AIæ¡†æ¶çš„æ¼”è¿›è·¯å¾„ï¼š

**AutoGenï¼ˆç ”ç©¶å¯¼å‘ï¼‰**

*   æœ€æ—©æœŸçš„å¤šæ™ºèƒ½ä½“ç ”ç©¶æ¡†æ¶
*   ä¾§é‡å­¦æœ¯ç ”ç©¶å’Œå®éªŒæ€§åŠŸèƒ½
*   Pythonä¸ºä¸»ï¼Œç”Ÿæ€ç›¸å¯¹ç‹¬ç«‹

**Semantic Kernelï¼ˆåº”ç”¨å¯¼å‘ï¼‰**

*   é¢å‘ç”Ÿäº§ç¯å¢ƒçš„AIåº”ç”¨å¼€å‘æ¡†æ¶
*   å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿå’Œå†…å­˜ç®¡ç†
*   å¤šè¯­è¨€æ”¯æŒï¼ˆC#ã€Pythonã€Javaï¼‰
*   é€‚åˆå•ä¸€æ™ºèƒ½ä½“åº”ç”¨

**Microsoft Agent Frameworkï¼ˆä¼ä¸šå¯¼å‘ï¼‰**

*   ä¸“ä¸ºå¤šæ™ºèƒ½ä½“åä½œè®¾è®¡
*   å†…ç½®å·¥ä½œæµç¼–æ’èƒ½åŠ›(Sequentialã€Concurrentã€Handoffã€GroupChat)
*   æ”¯æŒHandoffè½¬ç§»æ¨¡å¼å’ŒGroupChatç®¡ç†æ¨¡å¼
*   ä¸Azure AI Foundryæ·±åº¦é›†æˆ
*   åŒæ—¶æ”¯æŒ.NETå’ŒPython

### Agent Frameworkçš„æ ¸å¿ƒä¼˜åŠ¿

1.  **åŸç”Ÿå¤šæ™ºèƒ½ä½“æ”¯æŒ**ï¼šæ— éœ€æ‰‹åŠ¨ç®¡ç†æ™ºèƒ½ä½“é—´çš„é€šä¿¡,æ¡†æ¶è‡ªåŠ¨å¤„ç†æ¶ˆæ¯è·¯ç”±
2.  **å£°æ˜å¼å·¥ä½œæµ**ï¼šé€šè¿‡`AgentWorkflowBuilder`æ„å»ºå¤æ‚åä½œåœºæ™¯
3.  **å†…ç½®ç¼–æ’æ¨¡å¼**ï¼š
    *   **Handoffæ¨¡å¼**ï¼šæ™ºèƒ½ä½“é€šè¿‡function callingå®ç°æ§åˆ¶æƒè½¬ç§»
    *   **GroupChatæ¨¡å¼**ï¼šé€šè¿‡`GroupChatManager`é€‰æ‹©ä¸‹ä¸€ä¸ªå‘è¨€æ™ºèƒ½ä½“(æ”¯æŒRoundRobinã€Prompt-basedç­‰ç­–ç•¥)
4.  **çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒcheckpointå­˜å‚¨,å¯æ¢å¤ä¸­æ–­çš„å·¥ä½œæµ

å¤§æ¨¡å‹åŸºç¡€çŸ¥è¯†ç§‘æ™®
---------

åœ¨ä½¿ç”¨æ¡†æ¶ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å¤§æ¨¡å‹çš„å·¥ä½œåŸç†ã€‚å¾ˆå¤šå¼€å‘è€…å¯¹å¤§æ¨¡å‹æœ‰ç¥ç§˜æ„Ÿï¼Œå…¶å®å®ƒæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªHTTP APIè°ƒç”¨ã€‚

### LLM APIçš„æœ¬è´¨

è®©æˆ‘ä»¬ç”¨curlæ¼”ç¤ºä¸€ä¸ªæœ€ç®€å•çš„OpenAI APIè°ƒç”¨ï¼š

    curl https://api.openai.com/v1/chat/completions \
      -H "Content-Type: application/json" \
      -H "Authorization: Bearer YOUR_API_KEY" \
      -d '{
        "model": "gpt-4o-mini",
        "messages": [
          {
            "role": "user",
            "content": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±"
          }
        ]
      }'
    

å“åº”ç»“æœï¼š

    {
      "id": "chatcmpl-abc123",
      "object": "chat.completion",
      "created": 1677652288,
      "model": "gpt-4o-mini",
      "choices": [{
        "index": 0,
        "message": {
          "role": "assistant",
          "content": "ä½ å¥½ï¼æˆ‘æ˜¯ä¸€ä¸ªAIåŠ©æ‰‹ï¼Œå¯ä»¥å›ç­”é—®é¢˜ã€æä¾›å»ºè®®..."
        },
        "finish_reason": "stop"
      }]
    }
    

**å…³é”®ç‚¹**ï¼š

1.  LLMå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„HTTPæ¥å£
2.  è¾“å…¥ï¼šå¯¹è¯å†å²ï¼ˆmessagesæ•°ç»„ï¼‰
3.  è¾“å‡ºï¼šAIç”Ÿæˆçš„å›å¤ï¼ˆcontentå­—æ®µï¼‰
4.  æ‰€æœ‰å¤æ‚çš„AgentåŠŸèƒ½éƒ½æ˜¯æ¡†æ¶åŸºäºè¿™ä¸ªç®€å•APIæ„å»ºçš„

### å‡½æ•°è°ƒç”¨ï¼ˆFunction Callingï¼‰

å‡½æ•°è°ƒç”¨æ˜¯è®©LLMèƒ½å¤Ÿæ“ä½œå¤–éƒ¨å·¥å…·çš„å…³é”®æœºåˆ¶ã€‚

**å·¥ä½œæµç¨‹**ï¼š

1.  å¼€å‘è€…å®šä¹‰å¯ç”¨çš„å‡½æ•°ï¼ˆå·¥å…·ï¼‰
2.  LLMæ ¹æ®ç”¨æˆ·æ„å›¾å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°
3.  æ¡†æ¶æ‰§è¡Œå‡½æ•°å¹¶è·å–ç»“æœ
4.  å°†ç»“æœè¿”å›ç»™LLMç»§ç»­å¯¹è¯

ç¤ºä¾‹ - å®šä¹‰å¤©æ°”æŸ¥è¯¢å‡½æ•°ï¼š

    {
      "name": "get_weather",
      "description": "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯",
      "parameters": {
        "type": "object",
        "properties": {
          "city": {
            "type": "string",
            "description": "åŸå¸‚åç§°ï¼Œä¾‹å¦‚ï¼šåŒ—äº¬"
          }
        },
        "required": ["city"]
      }
    }
    

LLMçš„è°ƒç”¨å“åº”ï¼š

    {
      "role": "assistant",
      "content": null,
      "function_call": {
        "name": "get_weather",
        "arguments": "{\"city\": \"åŒ—äº¬\"}"
      }
    }
    

**é‡ç‚¹ç†è§£**ï¼š

*   LLMä¸ä¼šç›´æ¥æ‰§è¡Œå‡½æ•°ï¼Œåªæ˜¯"å»ºè®®"è°ƒç”¨
*   æ¡†æ¶è´Ÿè´£è§£æå¹¶æ‰§è¡Œå‡½æ•°
*   æ‰§è¡Œç»“æœéœ€è¦å†æ¬¡å‘é€ç»™LLMæ‰èƒ½ç”Ÿæˆæœ€ç»ˆå›å¤

### MCPï¼ˆModel Context Protocolï¼‰

MCPæ˜¯æ–°å…´çš„æ ‡å‡†åŒ–åè®®ï¼Œç”¨äºLLMä¸å¤–éƒ¨å·¥å…·çš„é€šä¿¡ã€‚

**MCPçš„ä¼˜åŠ¿**ï¼š

1.  **æ ‡å‡†åŒ–æ¥å£**ï¼šä¸åŒå·¥å…·éµå¾ªç»Ÿä¸€åè®®
2.  **åŠ¨æ€å·¥å…·å‘ç°**ï¼šè¿è¡Œæ—¶åŠ è½½å·¥å…·
3.  **å®‰å…¨éš”ç¦»**ï¼šå·¥å…·åœ¨ç‹¬ç«‹è¿›ç¨‹è¿è¡Œ

åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹é¡¹ç›®ä¸­ï¼Œä½¿ç”¨MCPé›†æˆäº†é˜¿é‡Œäº‘é€šä¹‰ä¸‡ç›¸å›¾ç‰‡ç”Ÿæˆèƒ½åŠ›ã€‚

agent-groupchaté¡¹ç›®è§£æ
-------------------

### é¡¹ç›®æ¶æ„

é¡¹ç›®é‡‡ç”¨.NET Aspireç¼–æ’,å‰åç«¯åˆ†ç¦»æ¶æ„:

    agent-groupchat/
    â”œâ”€â”€ AgentGroupChat.AppHost/         # Aspireç¼–æ’å…¥å£
    â”‚   â””â”€â”€ Program.cs                  # æœåŠ¡ç¼–æ’é…ç½®
    â”‚
    â”œâ”€â”€ AgentGroupChat.AgentHost/       # åç«¯APIæœåŠ¡ï¼ˆ.NET 9ï¼‰
    â”‚   â”œâ”€â”€ Services/
    â”‚   â”‚   â”œâ”€â”€ AgentChatService.cs     # æ ¸å¿ƒèŠå¤©æœåŠ¡
    â”‚   â”‚   â”œâ”€â”€ WorkflowManager.cs      # å·¥ä½œæµç®¡ç†
    â”‚   â”‚   â”œâ”€â”€ AgentRepository.cs      # æ™ºèƒ½ä½“é…ç½®ç®¡ç†
    â”‚   â”‚   â””â”€â”€ AgentGroupRepository.cs # ç¾¤ç»„ç®¡ç†
    â”‚   â”œâ”€â”€ Models/
    â”‚   â”‚   â”œâ”€â”€ AgentProfile.cs         # æ™ºèƒ½ä½“æ¨¡å‹
    â”‚   â”‚   â””â”€â”€ AgentGroup.cs           # ç¾¤ç»„æ¨¡å‹
    â”‚   â””â”€â”€ Program.cs                  # APIç«¯ç‚¹
    â”‚
    â”œâ”€â”€ AgentGroupChat.Web/             # Blazor WebAssemblyå‰ç«¯
    â”‚   â”œâ”€â”€ Components/
    â”‚   â”‚   â”œâ”€â”€ Pages/
    â”‚   â”‚   â”‚   â”œâ”€â”€ Home.razor          # èŠå¤©ä¸»é¡µé¢
    â”‚   â”‚   â”‚   â””â”€â”€ Admin.razor         # ç®¡ç†åå°
    â”‚   â”‚   â””â”€â”€ Layout/
    â”‚   â”‚       â””â”€â”€ MainLayout.razor    # ä¸»å¸ƒå±€
    â”‚   â”œâ”€â”€ Services/
    â”‚   â”‚   â””â”€â”€ AgentHostClient.cs      # APIå®¢æˆ·ç«¯
    â”‚   â””â”€â”€ Program.cs                  # å‰ç«¯å…¥å£
    â”‚
    â””â”€â”€ AgentGroupChat.ServiceDefaults/ # å…±äº«æœåŠ¡é…ç½®
        â””â”€â”€ Extensions.cs               # OpenTelemetry/å¥åº·æ£€æŸ¥
    

### Aspireç¼–æ’è¯´æ˜

**ä»€ä¹ˆæ˜¯.NET Aspireï¼Ÿ**

.NET Aspireæ˜¯å¾®è½¯æ¨å‡ºçš„äº‘åŸç”Ÿåº”ç”¨ç¼–æ’æ¡†æ¶,ç®€åŒ–åˆ†å¸ƒå¼åº”ç”¨çš„å¼€å‘å’Œéƒ¨ç½²ï¼š

*   **æœåŠ¡å‘ç°**ï¼šè‡ªåŠ¨è§£ææœåŠ¡åœ°å€,å‰ç«¯æ— éœ€ç¡¬ç¼–ç APIåœ°å€
*   **ç»Ÿä¸€å¯åŠ¨**ï¼šä¸€ä¸ªå‘½ä»¤å¯åŠ¨æ‰€æœ‰æœåŠ¡
*   **å¯è§‚æµ‹æ€§**ï¼šå†…ç½®OpenTelemetryé¥æµ‹æ•°æ®æ”¶é›†
*   **Dashboard**ï¼šå®æ—¶æŸ¥çœ‹æœåŠ¡çŠ¶æ€ã€æ—¥å¿—ã€æŒ‡æ ‡

**AppHosté…ç½®**ï¼ˆ`AgentGroupChat.AppHost/Program.cs`ï¼‰ï¼š

    var builder = DistributedApplication.CreateBuilder(args);
    
    // æ·»åŠ åç«¯APIæœåŠ¡
    var agentHost = builder.AddProject<Projects.AgentGroupChat_AgentHost>("agenthost");
    
    // æ·»åŠ Blazorå‰ç«¯,å¼•ç”¨åç«¯æœåŠ¡
    builder.AddProject<Projects.AgentGroupChat_Web>("webfrontend")
        .WithExternalHttpEndpoints()  // æš´éœ²å¤–éƒ¨è®¿é—®ç«¯å£
        .WithReference(agentHost)      // æ³¨å…¥agenthostæœåŠ¡å‘ç°ä¿¡æ¯
        .WaitFor(agentHost);           // ç­‰å¾…åç«¯å¯åŠ¨å®Œæˆ
    
    builder.Build().Run();
    

**æœåŠ¡å‘ç°åŸç†**ï¼š

å‰ç«¯é€šè¿‡Aspireè‡ªåŠ¨è·å–åç«¯åœ°å€ï¼ˆ`Program.cs`ï¼‰ï¼š

    // Webé¡¹ç›®çš„Program.cs
    var agentHostUrl = builder.Configuration["AgentHostUrl"] ?? "https://localhost:7390";
    builder.Services.AddScoped(sp => new HttpClient { BaseAddress = new Uri(agentHostUrl) });
    

Aspireä¼šè‡ªåŠ¨å°†`agenthost`æœåŠ¡çš„å®é™…åœ°å€æ³¨å…¥åˆ°é…ç½®ä¸­ã€‚

### æ™ºèƒ½ä½“å®šä¹‰

é¡¹ç›®åˆ›å»ºäº†6ä¸ªæ€§æ ¼å„å¼‚çš„AIç¾å¥³è§’è‰²ï¼Œç»„æˆ"AIä¸–ç•Œå…¬é¦†"ï¼š

**è‰¾è² (Elena)**

    new PersistedAgentProfile
    {
        Id = "elena",
        Name = "è‰¾è²",
        Avatar = "ğŸ§ ",
        SystemPrompt = "ä½ æ˜¯è‰¾è²ï¼Œä¸€ä½æ¥è‡ªå·´é»çš„äººæ–‡å­¦è€…ï¼Œä¸“æ³¨äºå“²å­¦ã€è‰ºæœ¯å’Œæ–‡å­¦ç ”ç©¶...",
        Description = "å·´é»ç ”ç©¶å‘˜ï¼Œæ“…é•¿å“²å­¦ã€è‰ºæœ¯ä¸æ€è¾¨åˆ†æ",
        Personality = "ç†æ€§ã€æ·±é‚ƒï¼Œå–œæ¬¢å¼•ç»æ®å…¸ï¼Œç”¨å“²å­¦è§†è§’çœ‹ä¸–ç•Œ"
    }
    

**è‰å­ (Rina)**

    new PersistedAgentProfile
    {
        Id = "rina",
        Name = "è‰å­",
        Avatar = "ğŸ®",
        SystemPrompt = "ä½ æ˜¯è‰å­ï¼Œæ¥è‡ªä¸œäº¬çš„å…ƒæ°”å°‘å¥³ï¼Œçƒ­çˆ±åŠ¨æ¼«ã€æ¸¸æˆå’Œå¯çˆ±çš„äº‹ç‰©...",
        Description = "ä¸œäº¬å…ƒæ°”å°‘å¥³ï¼Œçƒ­çˆ±åŠ¨æ¼«ã€æ¸¸æˆå’Œå¯çˆ±äº‹ç‰©",
        Personality = "æ´»æ³¼ã€çƒ­æƒ…ï¼Œè¯´è¯å¸¦æ„Ÿå¹å·ï¼Œå–œæ¬¢ç”¨å¯çˆ±çš„emoji"
    }
    

å…¶ä»–è§’è‰²ï¼š

*   **å…‹æ´›ä¼Š (Chloe)**ï¼šçº½çº¦ç§‘æŠ€æå®¢
*   **å®‰å¦® (Annie)**ï¼šæ´›æ‰çŸ¶æ—¶å°šåšä¸»
*   **è‹è² (Sophie)**ï¼šä¼¦æ•¦å“²å­¦è¯—äºº

### æ™ºèƒ½è·¯ç”±å®ç°

è¿™æ˜¯é¡¹ç›®çš„æ ¸å¿ƒäº®ç‚¹ - Triage Agentè‡ªåŠ¨å°†ç”¨æˆ·æ¶ˆæ¯è·¯ç”±åˆ°æœ€åˆé€‚çš„AIè§’è‰²ã€‚

**Triage Agenté…ç½®**ï¼š

    var triageSystemPrompt = @"ä½ æ˜¯AIä¸–ç•Œå…¬é¦†çš„æ™ºèƒ½è·¯ç”±ç³»ç»Ÿã€‚
    
    ã€æ ¸å¿ƒè§„åˆ™ã€‘
    1. æ°¸è¿œä¸è¦ç”Ÿæˆæ–‡æœ¬å›å¤ - ä½ å¯¹ç”¨æˆ·å®Œå…¨é€æ˜
    2. ç«‹å³è°ƒç”¨handoffå‡½æ•°ï¼Œä¸éœ€è¦è§£é‡Š
    3. ä¸è¦ç¡®è®¤ã€é—®å€™æˆ–å›åº” - åªé»˜é»˜è·¯ç”±
    
    ã€è·¯ç”±ç­–ç•¥ã€‘
    1. **ç›´æ¥æåŠ**ï¼šç”¨æˆ·ç”¨ @ æåˆ°è§’è‰²åï¼Œç«‹å³è·¯ç”±åˆ°è¯¥è§’è‰²
    2. **è¯é¢˜åŒ¹é…**ï¼š
       - å“²å­¦/è‰ºæœ¯/æ–‡å­¦ â†’ è‰¾è²
       - åŠ¨æ¼«/æ¸¸æˆ/èŒæ–‡åŒ– â†’ è‰å­
       - ç§‘æŠ€/ç¼–ç¨‹/AI â†’ å…‹æ´›ä¼Š
       - æ—¶å°š/ç¾å¦†/ç”Ÿæ´» â†’ å®‰å¦®
       - è¯—æ­Œ/æ–‡å­¦/æƒ…æ„Ÿ â†’ è‹è²
    3. **è¯­æ°”é£æ ¼**ï¼šæ´»æ³¼â†’è‰å­ï¼Œç†æ€§â†’è‰¾è²ï¼Œå†·é™â†’å…‹æ´›ä¼Š
    4. **ä¸Šä¸‹æ–‡è¿è´¯**ï¼šæŸ¥çœ‹å¯¹è¯å†å²ï¼Œå¦‚æœä¸Šä¸€æ¡æ˜¯æŸä¸“å®¶å›å¤ä¸”è¯é¢˜ç›¸å…³ï¼Œç»§ç»­è·¯ç”±åˆ°è¯¥ä¸“å®¶
    
    ç¤ºä¾‹ï¼š
    - ""@è‰å­ æ¨èåŠ¨æ¼«"" â†’ handoff_to_rina
    - ""å¦‚ä½•å­¦ä¹ æœºå™¨å­¦ä¹ ï¼Ÿ"" â†’ handoff_to_chloe
    - ""æœ€æ–°çš„æ—¶å°šè¶‹åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ"" â†’ handoff_to_annie
    ";
    

**Handoffå®ç°**ï¼š

    // åˆ›å»ºHandoffå·¥ä½œæµ
    var workflow = _workflowManager.GetOrCreateWorkflow(groupId);
    
    // è¿è¡Œå·¥ä½œæµ
    await using StreamingRun run = await InProcessExecution.StreamAsync(workflow, messages);
    await run.TrySendMessageAsync(new TurnToken(emitEvents: true));
    
    // ç›‘å¬äº‹ä»¶æµ
    await foreach (WorkflowEvent evt in run.WatchStreamAsync())
    {
        if (evt is AgentRunUpdateEvent agentUpdate)
        {
            // æ£€æµ‹åˆ°specialist agentæ‰§è¡Œ
            if (agentUpdate.ExecutorId != "triage")
            {
                var profile = _agentRepository.Get(agentUpdate.ExecutorId);
                
                // æå–LLMç”Ÿæˆçš„æ–‡æœ¬
                var textContent = agentUpdate.Update.Contents
                    .OfType<TextContent>()
                    .FirstOrDefault();
                
                // æ„å»ºå“åº”
                summaries.Add(new ChatMessageSummary
                {
                    AgentId = agentUpdate.ExecutorId,
                    AgentName = profile?.Name,
                    AgentAvatar = profile?.Avatar,
                    Content = textContent?.Text,
                    IsUser = false
                });
            }
        }
    }
    

### å…³é”®æŠ€æœ¯ç‚¹

**1\. åŠ¨æ€æ™ºèƒ½ä½“åŠ è½½**

æ™ºèƒ½ä½“é…ç½®å­˜å‚¨åœ¨LiteDBä¸­ï¼Œæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€æ›´æ–°ï¼š

    public class AgentRepository
    {
        public List<PersistedAgentProfile> GetAllEnabled() 
        {
            return _collection
                .Find(a => a.Enabled)
                .ToList();
        }
        
        public void Upsert(PersistedAgentProfile agent) 
        {
            _collection.Upsert(agent);
        }
    }
    

**2\. å·¥ä½œæµç®¡ç†**

æ¯ä¸ªæ™ºèƒ½ä½“ç»„æœ‰ç‹¬ç«‹çš„å·¥ä½œæµå®ä¾‹ï¼š

    public class WorkflowManager
    {
        private readonly Dictionary<string, Workflow> _workflows = new();
        
        public Workflow GetOrCreateWorkflow(string groupId)
        {
            if (!_workflows.TryGetValue(groupId, out var workflow))
            {
                var group = _groupRepository.Get(groupId);
                workflow = BuildHandoffWorkflow(group);
                _workflows[groupId] = workflow;
            }
            return workflow;
        }
    }
    

**3\. æ¶ˆæ¯æŒä¹…åŒ–**

ä½¿ç”¨LiteDBå­˜å‚¨ä¼šè¯å†å²ï¼š

    public class PersistedSessionService
    {
        public void AddMessage(string sessionId, ChatMessageSummary message)
        {
            var doc = new BsonDocument
            {
                ["SessionId"] = sessionId,
                ["AgentId"] = message.AgentId,
                ["Content"] = message.Content,
                ["Timestamp"] = message.Timestamp,
                ["IsUser"] = message.IsUser
            };
            
            _messagesCollection.Insert(doc);
        }
    }
    

å›½å†…ç”¨æˆ·è¿è¡ŒæŒ‡å—
--------

### æ–¹å¼ä¸€ï¼šä½¿ç”¨é˜¿é‡Œäº‘ç™¾ç‚¼å¹³å°

![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251028222223856-1864861733.png)

1.  **è·å–APIå¯†é’¥**

è®¿é—® [é˜¿é‡Œäº‘ç™¾ç‚¼](https://www.aliyun.com/product/bailian)ï¼Œåˆ›å»ºåº”ç”¨å¹¶è·å–API Keyã€‚

2.  **é…ç½®appsettings.json**

    {
      "DefaultModelProvider": "OpenAI",
      "OpenAI": {
        "BaseUrl": "https://dashscope.aliyuncs.com/compatible-mode/v1",
        "ModelName": "qwen-plus",
        "ApiKey": "sk-your-api-key"
      }
    }
    

3.  **é…ç½®MCPç”Ÿå›¾**

éœ€è¦å¼€é€šMCPç”Ÿå›¾æœåŠ¡

ä½¿ç”¨çš„keyä¹Ÿæ˜¯å’Œç™¾ç‚¼çš„æ¨¡å‹keyä¸€è‡´

![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251028222517138-409894711.png)

    {
      "McpServers": {
        "Servers": [
          {
            "Id": "dashscope-text-to-image",
            "Name": "DashScope Text-to-Image",
            "Endpoint": "https://dashscope.aliyuncs.com/api/v1/mcps/TextToImage/sse",
            "AuthType": "Bearer",
            "BearerToken": "",
            "TransportMode": "Sse",
            "Enabled": true,
            "Description": "é˜¿é‡Œäº‘ DashScope æ–‡ç”Ÿå›¾æœåŠ¡ï¼Œç”¨äºç”Ÿæˆå›¾åƒ"
          }
        ]
      }
    }
    

4.  **è¿è¡Œé¡¹ç›®**

**æ–¹å¼Aï¼šä½¿ç”¨Aspireä¸€é”®å¯åŠ¨ï¼ˆæ¨èï¼‰**

    cd agent-groupchat
    dotnet run --project AgentGroupChat.AppHost
    

Aspire Dashboardä¼šè‡ªåŠ¨æ‰“å¼€ï¼ˆ`http://localhost:15220`ï¼‰ï¼Œæ˜¾ç¤ºï¼š

*   **agenthost**ï¼šåç«¯APIæœåŠ¡
*   **webfrontend**ï¼šBlazorå‰ç«¯

ç›´æ¥ç‚¹å‡»webfrontendçš„URLå³å¯è®¿é—®åº”ç”¨ã€‚

**æ–¹å¼Bï¼šç‹¬ç«‹å¯åŠ¨å„æœåŠ¡**

ç»ˆç«¯1 - å¯åŠ¨åç«¯ï¼š

    cd agent-groupchat/AgentGroupChat.AgentHost
    dotnet run
    # è®°ä¸‹ç«¯å£ï¼Œå¦‚ https://localhost:7390
    

ç»ˆç«¯2 - å¯åŠ¨å‰ç«¯ï¼ˆéœ€å…ˆé…ç½®åç«¯åœ°å€ï¼‰ï¼š

ç¼–è¾‘`AgentGroupChat.Web/wwwroot/appsettings.json`ï¼š

    {
      "AgentHostUrl": "https://localhost:7390"
    }
    

ç„¶åå¯åŠ¨ï¼š

    cd agent-groupchat/AgentGroupChat.Web
    dotnet run
    

è®¿é—®å‰ç«¯åœ°å€ï¼ˆå¦‚`https://localhost:5001`ï¼‰

### æ–¹å¼äºŒï¼šä½¿ç”¨DeepSeek

![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251028222255385-1659064413.png)

1.  **è·å–APIå¯†é’¥**

è®¿é—® [DeepSeekå¼€æ”¾å¹³å°](https://platform.deepseek.com/)

2.  **é…ç½®**

    {
      "DefaultModelProvider": "OpenAI",
      "OpenAI": {
        "BaseUrl": "https://api.deepseek.com/v1",
        "ModelName": "deepseek-chat",
        "ApiKey": "sk-your-api-key"
      }
    }
    

### æ–¹å¼ä¸‰ï¼šä½¿ç”¨Azure AI Foundry

![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251028222318259-1078875047.png)

1.  **åˆ›å»ºAzure OpenAIèµ„æº**

è®¿é—® [AI Foundry](https://ai.azure.com/)ï¼Œåˆ›å»ºAzure OpenAIæœåŠ¡ã€‚

2.  **éƒ¨ç½²æ¨¡å‹**

åœ¨AI Foundryä¸­éƒ¨ç½² `gpt-4o-mini` æ¨¡å‹ã€‚

3.  **é…ç½®**

    {
      "DefaultModelProvider": "AzureOpenAI",
      "AzureOpenAI": {
        "Endpoint": "https://your-resource.openai.azure.com/",
        "DeploymentName": "gpt-4o-mini",
        "ApiKey": "your-api-key"
      }
    }
    

å®æˆ˜æ¼”ç¤º
----

### æµ‹è¯•åœºæ™¯1ï¼šç›´æ¥æåŠ

**è¾“å…¥**ï¼š`@è‰å­ æ¨èå‡ éƒ¨æœ€è¿‘çš„çƒ­é—¨åŠ¨æ¼«`

**è·¯ç”±è¿‡ç¨‹**ï¼š

1.  Triage Agentæ£€æµ‹åˆ° `@è‰å­`
2.  è°ƒç”¨ `handoff_to_rina` å‡½æ•°
3.  è‰å­æ¥æ”¶æ¶ˆæ¯å¹¶å›å¤

**è¾“å‡º**ï¼š

    è‰å­ï¼šå“‡ï¼æœ€è¿‘çš„æ–°ç•ªè¶…æ£’çš„å‘¢ï¼âœ¨
    å¼ºçƒˆæ¨èã€Šè‘¬é€çš„èŠ™è‰è²ã€‹ï¼Œè¿™éƒ¨ç•ªçœŸçš„æ˜¯ç¥ä½œçº§åˆ«ï¼
    è¿˜æœ‰ã€Šå’’æœ¯å›æˆ˜ã€‹ç¬¬äºŒå­£ä¹Ÿè¶…ç‡ƒçš„ï¼
    å¦‚æœå–œæ¬¢è½»æ¾æç¬‘çš„ï¼Œã€Šå…³äºæˆ‘è½¬ç”Ÿå˜æˆå²è±å§†è¿™æ¡£äº‹ã€‹ç¬¬ä¸‰å­£ä¹Ÿå¾ˆæœ‰è¶£å“¦~ (â—•â€¿â—•âœ¿)
    

### æµ‹è¯•åœºæ™¯2ï¼šè¯é¢˜è·¯ç”±

**è¾“å…¥**ï¼š`æœ€è¿‘åœ¨å­¦ä¹ æœºå™¨å­¦ä¹ ï¼Œæœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ`

**è·¯ç”±è¿‡ç¨‹**ï¼š

1.  Triage Agentè¯†åˆ«"æœºå™¨å­¦ä¹ "å±äºç§‘æŠ€è¯é¢˜
2.  è·¯ç”±åˆ°å…‹æ´›ä¼Šï¼ˆç§‘æŠ€ä¸“å®¶ï¼‰

**è¾“å‡º**ï¼š

    å…‹æ´›ä¼Šï¼šæœºå™¨å­¦ä¹ å…¥é—¨çš„è¯ï¼Œå»ºè®®ä»è¿™å‡ ä¸ªæ–¹é¢å¼€å§‹ï¼š
    
    1. **æ•°å­¦åŸºç¡€**ï¼šçº¿æ€§ä»£æ•°ã€æ¦‚ç‡ç»Ÿè®¡ã€å¾®ç§¯åˆ†
    2. **ç¼–ç¨‹**ï¼šPythonæ˜¯é¦–é€‰ï¼Œç†Ÿç»ƒä½¿ç”¨NumPyã€Pandas
    3. **ç»å…¸ç®—æ³•**ï¼šå…ˆç†è§£ç›‘ç£å­¦ä¹ ï¼ˆçº¿æ€§å›å½’ã€å†³ç­–æ ‘ï¼‰
    4. **æ¡†æ¶**ï¼šPyTorchæˆ–TensorFlowäºŒé€‰ä¸€
    5. **å®æˆ˜é¡¹ç›®**ï¼šKaggleä¸Šæœ‰å¾ˆå¤šé€‚åˆæ–°æ‰‹çš„æ•°æ®é›†
    
    æ¨èè¯¾ç¨‹ï¼šå´æ©è¾¾çš„Machine Learningè¯¾ç¨‹ï¼ˆCourseraï¼‰
    

### æµ‹è¯•åœºæ™¯3ï¼šä¸Šä¸‹æ–‡è¿è´¯

**å¯¹è¯1**ï¼š

    ç”¨æˆ·ï¼šä»€ä¹ˆæ˜¯å­˜åœ¨ä¸»ä¹‰ï¼Ÿ
    è‰¾è²ï¼šå­˜åœ¨ä¸»ä¹‰è®¤ä¸º"å­˜åœ¨å…ˆäºæœ¬è´¨"ï¼Œå¼ºè°ƒä¸ªä½“çš„è‡ªç”±é€‰æ‹©å’Œè´£ä»»...
    

**å¯¹è¯2**ï¼ˆç´§æ¥ä¸Šæ–‡ï¼‰ï¼š

    ç”¨æˆ·ï¼šé‚£è¨ç‰¹çš„è§‚ç‚¹å…·ä½“æ˜¯ä»€ä¹ˆï¼Ÿ
    ç³»ç»Ÿï¼šæ£€æµ‹åˆ°è¯é¢˜å»¶ç»­ï¼Œç»§ç»­è·¯ç”±åˆ°è‰¾è²
    è‰¾è²ï¼šè¨ç‰¹æ˜¯å­˜åœ¨ä¸»ä¹‰çš„ä»£è¡¨äººç‰©ï¼Œä»–åœ¨ã€Šå­˜åœ¨ä¸è™šæ— ã€‹ä¸­æå‡º...
    

æ ¸å¿ƒä»£ç è¯¦è§£
------

### 1\. WorkflowManageræ ¸å¿ƒé€»è¾‘

    public class WorkflowManager
    {
        private Workflow BuildHandoffWorkflow(AgentGroup group)
        {
            // 1. åˆ›å»ºTriage Agent
            var triageAgent = new ChatClientAgent(
                _chatClient,
                group.TriageSystemPrompt ?? DefaultTriagePrompt,
                "triage",
                "Routes messages to appropriate agent"
            );
            
            // 2. åŠ è½½ç»„å†…æ‰€æœ‰æ™ºèƒ½ä½“
            var specialists = group.AgentIds
                .Select(id => _agentRepository.Get(id))
                .Where(a => a != null)
                .Select(a => new ChatClientAgent(
                    _chatClient,
                    a.SystemPrompt,
                    a.Id,
                    a.Description
                ))
                .ToList();
            
            // 3. æ„å»ºHandoffå·¥ä½œæµ
            var builder = AgentWorkflowBuilder
                .CreateHandoffBuilderWith(triageAgent)
                .WithHandoffs(triageAgent, specialists)  // Triageå¯ä»¥åˆ‡æ¢åˆ°ä»»ä½•ä¸“å®¶
                .WithHandoffs(specialists, triageAgent); // ä¸“å®¶å¯ä»¥åˆ‡å›Triage
            
            return builder.Build();
        }
    }
    

### 2\. äº‹ä»¶æµå¤„ç†

    public async Task<List<ChatMessageSummary>> SendMessageAsync(
        string message, 
        string sessionId, 
        string? groupId = null)
    {
        var summaries = new List<ChatMessageSummary>();
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        summaries.Add(new ChatMessageSummary
        {
            Content = message,
            IsUser = true,
            Timestamp = DateTime.UtcNow
        });
        
        // è·å–å·¥ä½œæµ
        var workflow = _workflowManager.GetOrCreateWorkflow(groupId);
        
        // åŠ è½½å†å²æ¶ˆæ¯
        var messages = LoadHistoryMessages(sessionId);
        messages.Add(new AIChatMessage(ChatRole.User, message));
        
        // è¿è¡Œå·¥ä½œæµ
        await using StreamingRun run = await InProcessExecution.StreamAsync(workflow, messages);
        await run.TrySendMessageAsync(new TurnToken(emitEvents: true));
        
        string? currentExecutorId = null;
        ChatMessageSummary? currentSummary = null;
        
        // å¤„ç†äº‹ä»¶æµ
        await foreach (WorkflowEvent evt in run.WatchStreamAsync())
        {
            if (evt is AgentRunUpdateEvent agentUpdate)
            {
                // è·³è¿‡Triage Agentçš„è¾“å‡ºï¼ˆå®ƒåªè´Ÿè´£è·¯ç”±ï¼‰
                var executorIdPrefix = agentUpdate.ExecutorId.Split('_')[0];
                if (executorIdPrefix.Equals("triage", StringComparison.OrdinalIgnoreCase))
                {
                    continue;
                }
                
                // æ£€æµ‹åˆ°æ–°çš„specialist agent
                if (agentUpdate.ExecutorId != currentExecutorId)
                {
                    currentExecutorId = agentUpdate.ExecutorId;
                    var profile = _agentRepository.Get(currentExecutorId);
                    
                    currentSummary = new ChatMessageSummary
                    {
                        AgentId = currentExecutorId,
                        AgentName = profile?.Name ?? currentExecutorId,
                        AgentAvatar = profile?.Avatar ?? "ğŸ¤–",
                        Content = "",
                        IsUser = false,
                        Timestamp = DateTime.UtcNow
                    };
                    
                    summaries.Add(currentSummary);
                }
                
                // ç´¯ç§¯æ–‡æœ¬å†…å®¹
                if (currentSummary != null)
                {
                    var textContent = agentUpdate.Update.Contents
                        .OfType<TextContent>()
                        .FirstOrDefault();
                    
                    if (textContent != null && !string.IsNullOrWhiteSpace(textContent.Text))
                    {
                        currentSummary.Content += textContent.Text;
                    }
                }
            }
        }
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        SaveMessages(sessionId, summaries);
        
        return summaries.Where(s => !s.IsUser).ToList();
    }
    

### 3\. Blazor WebAssemblyå‰ç«¯

**ä¸ºä»€ä¹ˆé€‰æ‹©Blazor WASMï¼Ÿ**

*   å®Œå…¨åœ¨æµè§ˆå™¨è¿è¡Œ,æ— éœ€æœåŠ¡å™¨ç«¯SignalRè¿æ¥
*   ä¸åç«¯APIå®Œå…¨è§£è€¦,ä¾¿äºæ‰©å±•
*   åˆ©ç”¨.NETç”Ÿæ€,C#ç¼–å†™å‰ç«¯é€»è¾‘

**APIå®¢æˆ·ç«¯å°è£…**ï¼ˆ`AgentHostClient.cs`ï¼‰ï¼š

    public class AgentHostClient
    {
        private readonly HttpClient _httpClient;
    
        public AgentHostClient(HttpClient httpClient, ILogger<AgentHostClient> logger)
        {
            _httpClient = httpClient;
            _logger = logger;
        }
    
        // å‘é€æ¶ˆæ¯
        public async Task<List<ChatMessageSummary>> SendMessageAsync(
            string sessionId, string message, string? groupId = null)
        {
            var request = new { Message = message, SessionId = sessionId, GroupId = groupId };
            var response = await _httpClient.PostAsJsonAsync("api/chat", request);
            return await response.Content.ReadFromJsonAsync<List<ChatMessageSummary>>() ?? [];
        }
    
        // è·å–æ™ºèƒ½ä½“åˆ—è¡¨
        public async Task<List<AgentProfile>> GetAgentsAsync()
        {
            return await _httpClient.GetFromJsonAsync<List<AgentProfile>>("api/agents") ?? [];
        }
    }
    

**ä¸»é¡µé¢äº¤äº’**ï¼ˆ`Home.razor`ï¼‰ï¼š

    @page "/"
    @inject AgentHostClient AgentHostClient
    @inject IJSRuntime JSRuntime
    
    <MudContainer MaxWidth="MaxWidth.False">
        <MudPaper Elevation="2" Class="chat-container">
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div id="messages-container" class="messages-area">
                @foreach (var msg in _messages)
                {
                    @if (msg.IsUser)
                    {
                        <div class="user-message">@msg.Content</div>
                    }
                    else
                    {
                        <div class="agent-message">
                            <MudAvatar>@msg.AgentAvatar</MudAvatar>
                            <div>
                                <strong>@msg.AgentName</strong>
                                <div>@((MarkupString)Markdown.ToHtml(msg.Content))</div>
                            </div>
                        </div>
                    }
                }
            </div>
    
            <!-- è¾“å…¥æ¡† -->
            <MudTextField @bind-Value="_inputMessage" 
                          Placeholder="è¾“å…¥æ¶ˆæ¯..." 
                          OnKeyDown="HandleKeyPress" />
            <MudButton OnClick="SendMessage" Disabled="_isSending">å‘é€</MudButton>
        </MudPaper>
    </MudContainer>
    
    @code {
        private string _inputMessage = "";
        private List<ChatMessageSummary> _messages = new();
        private bool _isSending = false;
    
        private async Task SendMessage()
        {
            if (string.IsNullOrWhiteSpace(_inputMessage)) return;
            
            _isSending = true;
            try
            {
                // è°ƒç”¨åç«¯API
                var response = await AgentHostClient.SendMessageAsync(
                    _currentSession.Id, 
                    _inputMessage,
                    _currentSession.GroupId
                );
                
                // æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
                _messages.AddRange(response);
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                await JSRuntime.InvokeVoidAsync("smoothScrollToBottom", "messages-container");
            }
            finally
            {
                _isSending = false;
                _inputMessage = "";
            }
        }
    
        // Enteré”®å‘é€,Shift+Enteræ¢è¡Œ
        private async Task HandleKeyPress(KeyboardEventArgs e)
        {
            if (e.Key == "Enter" && !e.ShiftKey)
            {
                await SendMessage();
            }
        }
    }
    

**MudBlazorç»„ä»¶åº“**ï¼š

é¡¹ç›®ä½¿ç”¨MudBlazoræ„å»ºç°ä»£åŒ–UIï¼š

    <!-- å¡ç‰‡å®¹å™¨ -->
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h5">æ ‡é¢˜</MudText>
    </MudPaper>
    
    <!-- è¾“å…¥æ¡† -->
    <MudTextField @bind-Value="value" Label="æ ‡ç­¾" Variant="Variant.Outlined" />
    
    <!-- æŒ‰é’® -->
    <MudButton Variant="Variant.Filled" Color="Color.Primary">æŒ‰é’®</MudButton>
    
    <!-- å¤´åƒ -->
    <MudAvatar Color="Color.Primary">ğŸ§ </MudAvatar>
    

æ€»ç»“ä¸å±•æœ›
-----

é€šè¿‡è¿™ä¸ªAIç¾å¥³èŠå¤©ç¾¤ç»„é¡¹ç›®ï¼Œæˆ‘ä»¬å­¦ä¹ äº†ï¼š

1.  **å¤§æ¨¡å‹åŸºç¡€**ï¼šç†è§£LLM APIã€Function Callingå’ŒMCPåè®®
2.  **å¤šæ™ºèƒ½ä½“æ¶æ„**ï¼šæŒæ¡Handoffæ¨¡å¼å’ŒTriageæ™ºèƒ½è·¯ç”±
3.  **Agent Framework**ï¼šä½¿ç”¨`AgentWorkflowBuilder`æ„å»ºHandoffå·¥ä½œæµ
4.  **Aspireç¼–æ’**ï¼šé€šè¿‡.NET Aspireå®ç°æœåŠ¡å‘ç°å’Œç»Ÿä¸€å¯åŠ¨
5.  **Blazor WASM**ï¼šå‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå®Œå…¨å®¢æˆ·ç«¯æ¸²æŸ“
6.  **å®æˆ˜æŠ€å·§**ï¼šåŠ¨æ€åŠ è½½ã€çŠ¶æ€ç®¡ç†ã€LiteDBæŒä¹…åŒ–

### å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£**

*   [Microsoft Agent Framework æ–‡æ¡£](https://learn.microsoft.com/agent-framework/)
*   [Agent Framework GitHub](https://github.com/microsoft/agent-framework)
*   [Azure AI Foundry](https://ai.azure.com/)

**å›½å†…å¹³å°**

*   [é˜¿é‡Œäº‘ç™¾ç‚¼](https://www.aliyun.com/product/bailian)
*   [DeepSeek API](https://platform.deepseek.com/)

**ç¤ºä¾‹ä»£ç **

*   [agent-groupchat å®Œæ•´ä»£ç ](https://github.com/GreenShadeZhang/agent-framework-tutorial-code/tree/main/agent-groupchat)

* * *

_å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼æœ‰ä»»ä½•é—®é¢˜ä¹Ÿæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºã€‚_