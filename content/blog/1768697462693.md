---
layout: post
title: 'æ·±å…¥ç†è§£é£ä¹¦ Webhook ç­¾åéªŒè¯ï¼šä¸€æ¬¡è¸©å‘åˆ°å¡«å‘çš„å®Œæ•´è®°å½•'
date: "2026-01-18T00:51:02Z"
---
æ·±å…¥ç†è§£é£ä¹¦ Webhook ç­¾åéªŒè¯ï¼šä¸€æ¬¡è¸©å‘åˆ°å¡«å‘çš„å®Œæ•´è®°å½•
================================

> ä½œä¸ºä¸€åå‹¤åŠ³çš„ç‰›é©¬ï¼Œæˆ‘åœ¨å¯¹æ¥é£ä¹¦å¼€æ”¾å¹³å°æ—¶é‡åˆ°äº†ä¸€ä¸ªçœ‹ä¼¼ç®€å•å´è®©äººæŠ“ç‹‚çš„é—®é¢˜â€”â€”ç­¾åéªŒè¯æ€»æ˜¯å¤±è´¥ã€‚ç»è¿‡ä¸€ç•ªæ·±å…¥ç ”ç©¶ï¼Œæˆ‘å‘ç°è¿™ä¸ªé—®é¢˜èƒŒåéšè—ç€è®¸å¤šå®¹æ˜“è¢«å¿½è§†çš„ç»†èŠ‚ã€‚ä»Šå¤©ï¼Œæˆ‘æƒ³ç”¨æœ€é€šä¿—çš„è¯­è¨€ï¼ŒæŠŠè¿™æ®µç»å†è®°å½•ä¸‹æ¥ã€‚

æ•…äº‹çš„å¼€å§‹ï¼šä¸€ä¸ªç¥ç§˜çš„ç­¾åéªŒè¯å¤±è´¥
-----------------

### é—®é¢˜ç°åœº

é‚£æ˜¯ä¸€ä¸ªæ™®é€šçš„å·¥ä½œæ—¥ä¸‹åˆï¼Œæˆ‘æ­£åœ¨ä¸ºå…¬å¸çš„å†…éƒ¨ç³»ç»Ÿå¯¹æ¥é£ä¹¦çš„äº‹ä»¶è®¢é˜…åŠŸèƒ½ã€‚ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆé¡ºåˆ©ï¼š

*   âœ… åº”ç”¨åˆ›å»ºå®Œæˆ
*   âœ… äº‹ä»¶è®¢é˜…é…ç½®å®Œæˆ
*   âœ… Webhook åœ°å€å¡«å†™æ­£ç¡®
*   âœ… ä»£ç éƒ¨ç½²ä¸Šçº¿

ä½†æ˜¯ï¼Œå½“æˆ‘æ»¡æ€€æœŸå¾…åœ°åœ¨é£ä¹¦åå°ç‚¹å‡»"éªŒè¯"æŒ‰é’®æ—¶ï¼Œç³»ç»Ÿæ—¥å¿—é‡Œå‡ºç°äº†è¿™æ ·ä¸€è¡Œçº¢è‰²çš„é”™è¯¯ï¼š

    warn: Mud.Feishu.Webhook.FeishuEventValidator[0]       
    è¯·æ±‚å¤´ç­¾åéªŒè¯å¤±è´¥: è®¡ç®— +OGVt6ye......, æœŸæœ› bc5b503a......
    

**ä»€ä¹ˆï¼Ÿç­¾åéªŒè¯å¤±è´¥ï¼Ÿ**

æˆ‘æ£€æŸ¥äº†é…ç½®æ–‡ä»¶ï¼Œå¯†é’¥éƒ½å¡«å¯¹äº†ï¼›æˆ‘æ£€æŸ¥äº†ä»£ç é€»è¾‘ï¼Œçœ‹èµ·æ¥ä¹Ÿæ²¡é—®é¢˜ã€‚ä½†å°±æ˜¯éªŒè¯ä¸é€šè¿‡ï¼

### åˆæ­¥åˆ†æ

è®©æˆ‘ä»¬å…ˆçœ‹çœ‹æ—¥å¿—é‡Œçš„å…¶ä»–ä¿¡æ¯ï¼š

    dbug: Mud.Feishu.Webhook.FeishuEventDecryptor[0]
    è§£å¯†æˆåŠŸï¼Œç»“æœé•¿åº¦: 489
    
    dbug: Mud.Feishu.Webhook.FeishuEventDecryptor[0]
    è§£å¯†åçš„JSONæ•°æ®: {"schema":"2.0","header":{"event_id":"...","token":"fCt8xobp..."}}
    
    info: Mud.Feishu.Webhook.FeishuEventDecryptor[0]
    äº‹ä»¶æ•°æ®è§£å¯†æˆåŠŸ - EventType: [contact.department.created_v3]
    

æœ‰æ„æ€çš„æ˜¯ï¼š

*   âœ… æ•°æ®è§£å¯†æˆåŠŸäº†
*   âœ… äº‹ä»¶ç±»å‹è¯†åˆ«æ­£ç¡®
*   âŒ ä½†ç­¾åéªŒè¯å¤±è´¥äº†

è¿™è¯´æ˜ä»€ä¹ˆï¼Ÿè¯´æ˜æˆ‘çš„ **Encrypt Keyï¼ˆåŠ å¯†å¯†é’¥ï¼‰æ˜¯å¯¹çš„**ï¼Œä½†ç­¾åéªŒè¯çš„é€»è¾‘è‚¯å®šå“ªé‡Œå‡ºäº†é—®é¢˜ã€‚

* * *

é£ä¹¦ Webhook çš„å®‰å…¨æœºåˆ¶
----------------

åœ¨æ·±å…¥é—®é¢˜ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆç†è§£é£ä¹¦æ˜¯å¦‚ä½•ä¿æŠ¤ Webhook å®‰å…¨çš„ã€‚

### ä¸¤æŠŠé’¥åŒ™çš„æ•…äº‹

é£ä¹¦ç»™æ¯ä¸ªåº”ç”¨é…ç½®äº†ä¸¤æŠŠ"é’¥åŒ™"ï¼š

graph TB subgraph "é£ä¹¦åº”ç”¨çš„ä¸¤æŠŠé’¥åŒ™" A\["ğŸ”‘ Verification Token<br/>(éªŒè¯ä»¤ç‰Œ)"\] B\["ğŸ” Encrypt Key<br/>(åŠ å¯†å¯†é’¥)"\] A --> A1\["ç”¨é€”ï¼šURL éªŒè¯è¯·æ±‚"\] A --> A2\["æ ¼å¼ï¼šéšæœºå­—ç¬¦ä¸²"\] A --> A3\["ç¤ºä¾‹ï¼šfCt8xobpOKdb4yA0UoKJrhNTUaXTzJnf"\] B --> B1\["ç”¨é€”ï¼šæ•°æ®åŠ å¯†/è§£å¯†ã€ç­¾åéªŒè¯"\] B --> B2\["æ ¼å¼ï¼š32 ä½å­—ç¬¦ä¸²"\] B --> B3\["ç¤ºä¾‹ï¼šgo4kwHmzAbCdEfGhIjKlMnOpQrStUvWx"\] end style A fill:#e1f5ff style B fill:#fff3e0

**ç®€å•æ¥è¯´ï¼š**

*   **Verification Token** å°±åƒä½ å®¶çš„é—¨ç‰Œå·ï¼Œç”¨æ¥ç¡®è®¤"è¿™æ˜¯ä½ å®¶"
*   **Encrypt Key** å°±åƒä½ å®¶çš„é’¥åŒ™ï¼Œç”¨æ¥"å¼€é—¨"å’Œ"éªŒè¯èº«ä»½"

### é£ä¹¦å‘é€è¯·æ±‚çš„å®Œæ•´æµç¨‹

å½“é£ä¹¦è¦ç»™ä½ çš„æœåŠ¡å™¨å‘é€äº‹ä»¶é€šçŸ¥æ—¶ï¼Œå®ƒä¼šç»å†è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼š

sequenceDiagram participant FS as é£ä¹¦æœåŠ¡å™¨ participant YS as ä½ çš„æœåŠ¡å™¨ Note over FS: æ­¥éª¤ 1ï¼šå‡†å¤‡äº‹ä»¶æ•°æ® FS->>FS: {"event\_type": "...", "data": {...}} Note over FS: æ­¥éª¤ 2ï¼šä½¿ç”¨ Encrypt Key åŠ å¯†æ•°æ® FS->>FS: "Ul/tHTDEQkOlKZuqYTS7t+zTb8z/..." Note over FS: æ­¥éª¤ 3ï¼šç”Ÿæˆç­¾å FS->>FS: timestamp + nonce + key + body FS->>FS: â†“ SHA-256 FS->>FS: f2d909fb8a7c3e1d... Note over FS: æ­¥éª¤ 4ï¼šå‘é€ HTTP è¯·æ±‚ FS->>YS: POST /webhook<br/>Headers:<br/>X-Lark-Request-Timestamp: 1768...<br/>X-Lark-Request-Nonce: 149323894<br/>X-Lark-Signature: f2d909fb...<br/>Body: {"encrypt": "Ul/tHTDEQkO..."} Note over YS: æ¥æ”¶å¹¶å¤„ç†è¯·æ±‚

### ä½ çš„æœåŠ¡å™¨éœ€è¦åšä»€ä¹ˆ

æ”¶åˆ°é£ä¹¦çš„è¯·æ±‚åï¼Œä½ éœ€è¦æŒ‰ç…§ç›¸åçš„é¡ºåºéªŒè¯å’Œå¤„ç†ï¼š

flowchart TD Start(\[æ”¶åˆ°é£ä¹¦è¯·æ±‚\]) --> Step1\[æ­¥éª¤ 1ï¼šéªŒè¯ç­¾å âš ï¸\] Step1 --> |éªŒè¯é€šè¿‡| Step2\[æ­¥éª¤ 2ï¼šè§£å¯†æ•°æ®\] Step1 --> |éªŒè¯å¤±è´¥| Reject\[âŒ æ‹’ç»è¯·æ±‚\] Step2 --> |è§£å¯†æˆåŠŸ| Step3\[æ­¥éª¤ 3ï¼šå¤„ç†äº‹ä»¶\] Step2 --> |è§£å¯†å¤±è´¥| Reject Step3 --> Step4\[æ­¥éª¤ 4ï¼šè¿”å›å“åº”\] Step4 --> Success\[âœ… è¿”å›æˆåŠŸ\] style Step1 fill:#ffebee style Step2 fill:#e3f2fd style Step3 fill:#e8f5e9 style Step4 fill:#fff3e0 style Success fill:#c8e6c9 style Reject fill:#ffcdd2

* * *

æˆ‘è¸©è¿‡çš„å››ä¸ªå¤§å‘
--------

ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘åœ¨å®ç°ç­¾åéªŒè¯æ—¶è¸©è¿‡çš„å‘ã€‚å¦‚æœä½ ä¹Ÿé‡åˆ°äº†ç­¾åéªŒè¯å¤±è´¥çš„é—®é¢˜ï¼Œå¾ˆå¯èƒ½å°±æ˜¯å› ä¸ºè¿™äº›åŸå› ã€‚

### å‘ #1ï¼šç”¨é”™äº†ç­¾åç®—æ³•

#### âŒ æˆ‘æœ€åˆçš„é”™è¯¯å®ç°

    // æˆ‘ä»¥ä¸ºé£ä¹¦ç”¨çš„æ˜¯ HMAC-SHA256ï¼ˆå› ä¸ºå¾ˆå¤šå¹³å°éƒ½ç”¨è¿™ä¸ªï¼‰
    var signString = $"{timestamp}\n{nonce}\n{body}";
    using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(encryptKey));
    var hashBytes = hmac.ComputeHash(Encoding.UTF8.GetBytes(signString));
    var signature = Convert.ToBase64String(hashBytes);
    

**ä¸ºä»€ä¹ˆé”™äº†ï¼Ÿ**

æˆ‘å‚è€ƒäº†å¾®ä¿¡ã€é’‰é’‰ç­‰å¹³å°çš„å®ç°ï¼Œå®ƒä»¬å¤§å¤šä½¿ç”¨ HMAC-SHA256 ç®—æ³•ã€‚ä½†é£ä¹¦ä¸ä¸€æ ·ï¼

#### âœ… æ­£ç¡®çš„å®ç°

    // é£ä¹¦ä½¿ç”¨çš„æ˜¯çº¯ SHA-256 å“ˆå¸Œï¼ˆä¸æ˜¯ HMACï¼‰
    var signString = $"{timestamp}{nonce}{encryptKey}{body}";
    using var sha256 = SHA256.Create();
    var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
    var signature = BitConverter.ToString(hashBytes).Replace("-", "").ToLower();
    

**å¯¹æ¯”è¡¨æ ¼ï¼š**

ç‰¹æ€§

HMAC-SHA256

SHA-256

æ˜¯å¦éœ€è¦å¯†é’¥

âœ… éœ€è¦ï¼ˆä½œä¸º HMAC çš„å¯†é’¥ï¼‰

âŒ ä¸éœ€è¦ï¼ˆå¯†é’¥ç›´æ¥æ‹¼æ¥åˆ°å­—ç¬¦ä¸²ä¸­ï¼‰

ç®—æ³•ç±»å‹

æ¶ˆæ¯è®¤è¯ç 

å“ˆå¸Œå‡½æ•°

é£ä¹¦ä½¿ç”¨

âŒ

âœ…

å¾®ä¿¡ä½¿ç”¨

âœ…

âŒ

### å‘ #2ï¼šç­¾åå­—ç¬¦ä¸²æ ¼å¼é”™è¯¯

#### âŒ æˆ‘æœ€åˆçš„é”™è¯¯å®ç°

    // æˆ‘ä»¥ä¸ºå„éƒ¨åˆ†è¦ç”¨æ¢è¡Œç¬¦åˆ†éš”ï¼ˆå› ä¸ºçœ‹èµ·æ¥æ›´"è§„èŒƒ"ï¼‰
    var signString = $"{timestamp}\n{nonce}\n{body}";
    

**ä¸ºä»€ä¹ˆé”™äº†ï¼Ÿ**

æˆ‘æƒ³å½“ç„¶åœ°è®¤ä¸ºï¼Œæ—¢ç„¶æ˜¯å¤šä¸ªéƒ¨åˆ†ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œåº”è¯¥ç”¨æŸç§åˆ†éš”ç¬¦ã€‚æ¢è¡Œç¬¦ `\n` çœ‹èµ·æ¥æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚

ä½†å®é™…ä¸Šï¼Œé£ä¹¦çš„ç­¾åå­—ç¬¦ä¸²æ˜¯**ç›´æ¥æ‹¼æ¥**çš„ï¼Œè€Œä¸”è¿˜è¦åŒ…å« **Encrypt Key**ï¼

#### âœ… æ­£ç¡®çš„å®ç°

    // ç›´æ¥æ‹¼æ¥ï¼Œæ— ä»»ä½•åˆ†éš”ç¬¦
    var signString = $"{timestamp}{nonce}{encryptKey}{body}";
    

**ç¤ºä¾‹å¯¹æ¯”ï¼š**

    âŒ é”™è¯¯æ ¼å¼ï¼ˆæœ‰æ¢è¡Œç¬¦ï¼Œç¼ºå°‘ encryptKeyï¼‰ï¼š
    1768550348
    149323894
    {"encrypt":"Ul/tHTDEQkO..."}
    
    âœ… æ­£ç¡®æ ¼å¼ï¼ˆç›´æ¥æ‹¼æ¥ï¼ŒåŒ…å« encryptKeyï¼‰ï¼š
    1768550348149323894go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx{"encrypt":"Ul/tHTDEQkO..."}
    

### å‘ #3ï¼šç”¨é”™äº†å¯†é’¥

#### âŒ æˆ‘æ›¾ç»çš„å›°æƒ‘

    // æˆ‘çœ‹åˆ°è§£å¯†åçš„æ•°æ®é‡Œæœ‰ä¸ª token å­—æ®µ
    // {"header":{"token":"fCt8xobpOKdb4yA0UoKJrhNTUaXTzJnf"}}
    // æˆ‘æƒ³ï¼šè¿™ä¸ª token åº”è¯¥å°±æ˜¯ç”¨æ¥éªŒè¯ç­¾åçš„å§ï¼Ÿ
    
    var signString = $"{timestamp}{nonce}{verificationToken}{body}";
    

**ä¸ºä»€ä¹ˆé”™äº†ï¼Ÿ**

è¿™æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯ã€‚å› ä¸ºï¼š

1.  è§£å¯†åçš„æ•°æ®é‡Œç¡®å®æœ‰ä¸ª `token` å­—æ®µ
2.  è¿™ä¸ª token çš„å€¼æ­£å¥½æ˜¯ Verification Token
3.  åå­—å«"éªŒè¯ä»¤ç‰Œ"ï¼Œå¬èµ·æ¥å°±åº”è¯¥ç”¨æ¥éªŒè¯

ä½†å®é™…ä¸Šï¼Œ**ç­¾åéªŒè¯è¦ç”¨ Encrypt Key**ï¼

#### âœ… æ­£ç¡®çš„ç†è§£

å¯†é’¥ç±»å‹

ç”¨é€”

åœ¨ç­¾åéªŒè¯ä¸­

Verification Token

URL éªŒè¯è¯·æ±‚

âŒ ä¸ä½¿ç”¨

Encrypt Key

æ•°æ®åŠ å¯†/è§£å¯† + ç­¾åéªŒè¯

âœ… ä½¿ç”¨è¿™ä¸ª

**è®°å¿†æŠ€å·§ï¼š**

*   **Verification Token** = é—¨ç‰Œå·ï¼ˆç¡®è®¤åœ°å€ï¼‰
*   **Encrypt Key** = é’¥åŒ™ï¼ˆå¼€é—¨ + éªŒè¯èº«ä»½ï¼‰

### å‘ #4ï¼šè¾“å‡ºæ ¼å¼ä¸å¯¹

#### âŒ æˆ‘æœ€åˆçš„é”™è¯¯å®ç°

    // æˆ‘ä¹ æƒ¯æ€§åœ°æŠŠå“ˆå¸Œç»“æœè½¬æˆ Base64
    var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
    var signature = Convert.ToBase64String(hashBytes);
    // ç»“æœï¼šlL4qIgAs8Kx... (Base64 æ ¼å¼)
    

**ä¸ºä»€ä¹ˆé”™äº†ï¼Ÿ**

Base64 æ˜¯å¾ˆå¸¸è§çš„ç¼–ç æ–¹å¼ï¼Œæˆ‘åœ¨å…¶ä»–é¡¹ç›®ä¸­ç»å¸¸è¿™æ ·ç”¨ã€‚ä½†é£ä¹¦è¦çš„æ˜¯**å°å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸²**ï¼

#### âœ… æ­£ç¡®çš„å®ç°

    // è½¬æ¢ä¸ºå°å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸²
    var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
    var signature = BitConverter.ToString(hashBytes).Replace("-", "").ToLower();
    // ç»“æœï¼šf2d909fb8a7c... (å°å†™åå…­è¿›åˆ¶)
    

**æ ¼å¼å¯¹æ¯”ï¼š**

    åŸå§‹å“ˆå¸Œå€¼ï¼ˆå­—èŠ‚æ•°ç»„ï¼‰ï¼š
    [242, 217, 9, 251, 138, 124, 62, 29, ...]
    
    âŒ Base64 ç¼–ç ï¼š
    8tkJ+4p8Ph0...
    
    âœ… å°å†™åå…­è¿›åˆ¶ï¼š
    f2d909fb8a7c3e1d...
    

* * *

æ­£ç¡®çš„å®ç°æ–¹å¼
-------

ç»è¿‡ä¸€ç•ªæŠ˜è…¾ï¼Œæˆ‘ç»ˆäºææ¸…æ¥šäº†æ­£ç¡®çš„å®ç°æ–¹å¼ã€‚è®©æˆ‘ç”¨æœ€æ¸…æ™°çš„æ–¹å¼å±•ç¤ºç»™ä½ ã€‚

### å®Œæ•´çš„éªŒè¯æµç¨‹

flowchart TD Start(\[é£ä¹¦ Webhook ç­¾åéªŒè¯æµç¨‹\]) --> Step1\[ç¬¬ 1 æ­¥ï¼šæå–è¯·æ±‚å¤´ä¿¡æ¯\] Step1 --> Step1a\[X-Lark-Request-Timestamp â†’ timestamp\] Step1 --> Step1b\[X-Lark-Request-Nonce â†’ nonce\] Step1 --> Step1c\[X-Lark-Signature â†’ expectedSignature\] Step1a --> Step2\[ç¬¬ 2 æ­¥ï¼šè¯»å–è¯·æ±‚ä½“\] Step1b --> Step2 Step1c --> Step2 Step2 --> Step2a\[åŸå§‹ JSON å­—ç¬¦ä¸² â†’ body\] Step2a --> Step3\[ç¬¬ 3 æ­¥ï¼šé˜²é‡æ”¾æ”»å‡»æ£€æŸ¥\] Step3 --> Check1{nonce æ˜¯å¦å·²ä½¿ç”¨?} Check1 --> |æ˜¯| Reject1\[âŒ æ‹’ç»è¯·æ±‚\] Check1 --> |å¦| Check2{timestamp æ˜¯å¦æœ‰æ•ˆ?} Check2 --> |å¦| Reject2\[âŒ æ‹’ç»è¯·æ±‚\] Check2 --> |æ˜¯| Step4\[ç¬¬ 4 æ­¥ï¼šæ„å»ºç­¾åå­—ç¬¦ä¸²\] Step4 --> Step4a\["signString = timestamp + nonce + encryptKey + body"\] Step4a --> Step5\[ç¬¬ 5 æ­¥ï¼šè®¡ç®— SHA-256 å“ˆå¸Œ\] Step5 --> Step5a\["SHA256(signString) â†’ hashBytes"\] Step5a --> Step6\[ç¬¬ 6 æ­¥ï¼šè½¬æ¢ä¸ºå°å†™åå…­è¿›åˆ¶\] Step6 --> Step6a\["BitConverter.ToString(hashBytes)<br/>.Replace('-', '').ToLower()"\] Step6a --> Step7\[ç¬¬ 7 æ­¥ï¼šå›ºå®šæ—¶é—´æ¯”è¾ƒ\] Step7 --> Compare{ç­¾åæ˜¯å¦ç›¸ç­‰?} Compare --> |æ˜¯| Success\[âœ… éªŒè¯é€šè¿‡\] Compare --> |å¦| Fail\[âŒ éªŒè¯å¤±è´¥\] style Step1 fill:#e3f2fd style Step3 fill:#fff3e0 style Step4 fill:#f3e5f5 style Step5 fill:#e8f5e9 style Step6 fill:#fce4ec style Step7 fill:#e0f2f1 style Success fill:#c8e6c9 style Fail fill:#ffcdd2 style Reject1 fill:#ffcdd2 style Reject2 fill:#ffcdd2

### C# å®Œæ•´ä»£ç å®ç°

    public async Task<bool> ValidateSignature(
        long timestamp, 
        string nonce, 
        string body, 
        string headerSignature, 
        string encryptKey)
    {
        try
        {
            // ========== ç¬¬ 1 æ­¥ï¼šåŸºç¡€éªŒè¯ ==========
            
            // æ£€æŸ¥å¿…è¦å‚æ•°
            if (string.IsNullOrEmpty(headerSignature))
            {
                _logger.LogWarning("è¯·æ±‚å¤´ä¸­ç¼ºå°‘ X-Lark-Signature");
                return false;
            }
            
            if (timestamp == 0 || string.IsNullOrEmpty(nonce))
            {
                _logger.LogWarning("æ—¶é—´æˆ³æˆ– nonce ä¸ºç©º");
                return false;
            }
            
            // ========== ç¬¬ 2 æ­¥ï¼šé˜²é‡æ”¾æ”»å‡» ==========
            
            // æ£€æŸ¥ nonce æ˜¯å¦å·²ä½¿ç”¨ï¼ˆéœ€è¦é…åˆ Redis ç­‰ç¼“å­˜å®ç°ï¼‰
            if (await IsNonceUsed(nonce))
            {
                _logger.LogWarning("Nonce {Nonce} å·²ä½¿ç”¨è¿‡ï¼Œæ‹’ç»é‡æ”¾æ”»å‡»", nonce);
                return false;
            }
            
            // éªŒè¯æ—¶é—´æˆ³ï¼ˆå®¹é”™ 60 ç§’ï¼‰
            if (!IsTimestampValid(timestamp, toleranceSeconds: 60))
            {
                _logger.LogWarning("è¯·æ±‚æ—¶é—´æˆ³æ— æ•ˆ: {Timestamp}", timestamp);
                return false;
            }
            
            // ========== ç¬¬ 3 æ­¥ï¼šæ„å»ºç­¾åå­—ç¬¦ä¸² ==========
            
            // æ³¨æ„ï¼šç›´æ¥æ‹¼æ¥ï¼Œæ— åˆ†éš”ç¬¦
            var signString = $"{timestamp}{nonce}{encryptKey}{body}";
            
            // è°ƒè¯•æ—¥å¿—ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
            _logger.LogDebug("ç­¾åå­—ç¬¦ä¸²å‰ 100 å­—ç¬¦: {SignStringPrefix}", 
                signString.Substring(0, Math.Min(100, signString.Length)));
            
            // ========== ç¬¬ 4 æ­¥ï¼šè®¡ç®— SHA-256 å“ˆå¸Œ ==========
            
            using var sha256 = SHA256.Create();
            var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
            
            // ========== ç¬¬ 5 æ­¥ï¼šè½¬æ¢ä¸ºå°å†™åå…­è¿›åˆ¶å­—ç¬¦ä¸² ==========
            
            var computedSignature = BitConverter.ToString(hashBytes)
                .Replace("-", "")
                .ToLower();
            
            _logger.LogDebug("è®¡ç®—çš„ç­¾å: {ComputedSignature}", computedSignature);
            _logger.LogDebug("æœŸæœ›çš„ç­¾å: {ExpectedSignature}", headerSignature);
            
            // ========== ç¬¬ 6 æ­¥ï¼šå›ºå®šæ—¶é—´æ¯”è¾ƒ ==========
            
            // ä½¿ç”¨å›ºå®šæ—¶é—´æ¯”è¾ƒé˜²æ­¢è®¡æ—¶æ”»å‡»
            var isValid = FixedTimeEquals(computedSignature, headerSignature);
            
            if (isValid)
            {
                _logger.LogInformation("ç­¾åéªŒè¯æˆåŠŸ");
                // æ ‡è®° nonce ä¸ºå·²ä½¿ç”¨
                await MarkNonceAsUsed(nonce);
            }
            else
            {
                _logger.LogWarning("ç­¾åéªŒè¯å¤±è´¥");
            }
            
            return isValid;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "éªŒè¯ç­¾åæ—¶å‘ç”Ÿé”™è¯¯");
            return false;
        }
    }
    
    /// <summary>
    /// å›ºå®šæ—¶é—´æ¯”è¾ƒï¼Œé˜²æ­¢è®¡æ—¶æ”»å‡»
    /// </summary>
    private static bool FixedTimeEquals(string a, string b)
    {
        if (a.Length != b.Length)
            return false;
        
        var result = 0;
        for (var i = 0; i < a.Length; i++)
        {
            result |= a[i] ^ b[i];
        }
        
        return result == 0;
    }
    
    /// <summary>
    /// éªŒè¯æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…
    /// </summary>
    private bool IsTimestampValid(long timestamp, int toleranceSeconds)
    {
        var requestTime = DateTimeOffset.FromUnixTimeSeconds(timestamp);
        var now = DateTimeOffset.UtcNow;
        var diff = Math.Abs((now - requestTime).TotalSeconds);
        
        return diff <= toleranceSeconds;
    }
    

### å…¶ä»–è¯­è¨€å®ç°å‚è€ƒ

#### Python å®ç°

    import hashlib
    import time
    
    def validate_signature(timestamp, nonce, body, header_signature, encrypt_key):
        """éªŒè¯é£ä¹¦ Webhook ç­¾å"""
        
        # 1. åŸºç¡€éªŒè¯
        if not header_signature or not nonce or timestamp == 0:
            return False
        
        # 2. æ—¶é—´æˆ³éªŒè¯ï¼ˆå®¹é”™ 60 ç§’ï¼‰
        current_time = int(time.time())
        if abs(current_time - timestamp) > 60:
            return False
        
        # 3. æ„å»ºç­¾åå­—ç¬¦ä¸²ï¼ˆç›´æ¥æ‹¼æ¥ï¼‰
        sign_string = f"{timestamp}{nonce}{encrypt_key}{body}"
        
        # 4. è®¡ç®— SHA-256 å“ˆå¸Œ
        hash_obj = hashlib.sha256(sign_string.encode('utf-8'))
        
        # 5. è½¬æ¢ä¸ºå°å†™åå…­è¿›åˆ¶
        computed_signature = hash_obj.hexdigest().lower()
        
        # 6. æ¯”è¾ƒç­¾å
        return computed_signature == header_signature.lower()
    

#### JavaScript/Node.js å®ç°

    const crypto = require('crypto');
    
    function validateSignature(timestamp, nonce, body, headerSignature, encryptKey) {
        // 1. åŸºç¡€éªŒè¯
        if (!headerSignature || !nonce || !timestamp) {
            return false;
        }
        
        // 2. æ—¶é—´æˆ³éªŒè¯ï¼ˆå®¹é”™ 60 ç§’ï¼‰
        const currentTime = Math.floor(Date.now() / 1000);
        if (Math.abs(currentTime - timestamp) > 60) {
            return false;
        }
        
        // 3. æ„å»ºç­¾åå­—ç¬¦ä¸²ï¼ˆç›´æ¥æ‹¼æ¥ï¼‰
        const signString = `${timestamp}${nonce}${encryptKey}${body}`;
        
        // 4. è®¡ç®— SHA-256 å“ˆå¸Œå¹¶è½¬æ¢ä¸ºå°å†™åå…­è¿›åˆ¶
        const computedSignature = crypto
            .createHash('sha256')
            .update(signString, 'utf8')
            .digest('hex')
            .toLowerCase();
        
        // 5. æ¯”è¾ƒç­¾å
        return computedSignature === headerSignature.toLowerCase();
    }
    

* * *

å®‰å…¨é˜²æŠ¤çš„è‰ºæœ¯
-------

ç­¾åéªŒè¯åªæ˜¯å®‰å…¨é˜²æŠ¤çš„ç¬¬ä¸€æ­¥ã€‚è¦æ„å»ºä¸€ä¸ªçœŸæ­£å®‰å…¨å¯é çš„ Webhook æœåŠ¡ï¼Œè¿˜éœ€è¦è€ƒè™‘æ›´å¤šç»†èŠ‚ã€‚

### é˜²é‡æ”¾æ”»å‡»ï¼šNonce å»é‡æœºåˆ¶

#### ä»€ä¹ˆæ˜¯é‡æ”¾æ”»å‡»ï¼Ÿ

æƒ³è±¡è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼š

    1. é»‘å®¢æˆªè·äº†ä¸€ä¸ªåˆæ³•çš„é£ä¹¦è¯·æ±‚
    2. é»‘å®¢é‡å¤å‘é€è¿™ä¸ªè¯·æ±‚ 100 æ¬¡
    3. ä½ çš„æœåŠ¡å™¨å¤„ç†äº† 100 æ¬¡ç›¸åŒçš„äº‹ä»¶
    4. ğŸ’¥ ä¸šåŠ¡é€»è¾‘è¢«é‡å¤æ‰§è¡Œï¼Œé€ æˆæ•°æ®æ··ä¹±
    

#### å¦‚ä½•é˜²æ­¢ï¼Ÿ

ä½¿ç”¨ **Nonceï¼ˆNumber used onceï¼‰** æœºåˆ¶ï¼š

sequenceDiagram participant Client as å®¢æˆ·ç«¯ participant Server as æœåŠ¡å™¨ participant Redis as Redis ç¼“å­˜ Note over Client,Redis: Nonce å»é‡æµç¨‹ Client->>Server: å‘é€è¯·æ±‚ (Nonce: 149323894) Server->>Server: æå– Nonce: 149323894 Server->>Redis: EXISTS "feishu:nonce:149323894" alt Nonce å·²å­˜åœ¨ Redis-->>Server: è¿”å› true Server-->>Client: âŒ æ‹’ç»è¯·æ±‚ï¼ˆé‡æ”¾æ”»å‡»ï¼‰ else Nonce ä¸å­˜åœ¨ Redis-->>Server: è¿”å› false Server->>Server: âœ… ç»§ç»­å¤„ç† Server->>Redis: SET "feishu:nonce:149323894" "1" EX 300 Note over Redis: 5 åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸ Server-->>Client: è¿”å›å¤„ç†ç»“æœ end

#### ä»£ç å®ç°ï¼ˆä½¿ç”¨ Redisï¼‰

    public class NonceDeduplicator
    {
        private readonly IDistributedCache _cache;
        private readonly ILogger<NonceDeduplicator> _logger;
        
        public async Task<bool> IsNonceUsed(string nonce)
        {
            var key = $"feishu:nonce:{nonce}";
            var value = await _cache.GetStringAsync(key);
            return value != null;
        }
        
        public async Task MarkNonceAsUsed(string nonce)
        {
            var key = $"feishu:nonce:{nonce}";
            var options = new DistributedCacheEntryOptions
            {
                // 5 åˆ†é’Ÿåè‡ªåŠ¨è¿‡æœŸï¼ˆä¸æ—¶é—´æˆ³å®¹é”™æ—¶é—´ä¸€è‡´ï¼‰
                AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(5)
            };
            
            await _cache.SetStringAsync(key, "1", options);
            _logger.LogDebug("Nonce {Nonce} å·²æ ‡è®°ä¸ºå·²ä½¿ç”¨", nonce);
        }
    }
    

### é˜²é‡æ”¾æ”»å‡»ï¼šæ—¶é—´æˆ³éªŒè¯

#### ä¸ºä»€ä¹ˆéœ€è¦æ—¶é—´æˆ³éªŒè¯ï¼Ÿ

    åœºæ™¯ 1ï¼šç½‘ç»œå»¶è¿Ÿ
    é£ä¹¦å‘é€æ—¶é—´ï¼š14:00:00
    åˆ°è¾¾ä½ æœåŠ¡å™¨ï¼š14:00:05
    âœ… 5 ç§’å»¶è¿Ÿï¼Œå¯ä»¥æ¥å—
    
    åœºæ™¯ 2ï¼šæ¶æ„æ”»å‡»
    é£ä¹¦å‘é€æ—¶é—´ï¼š14:00:00
    é»‘å®¢é‡æ”¾æ—¶é—´ï¼š15:00:00
    âŒ 1 å°æ—¶å»¶è¿Ÿï¼Œæ˜æ˜¾å¼‚å¸¸
    

#### å®¹é”™æ—¶é—´è®¾ç½®å»ºè®®

ç¯å¢ƒ

å»ºè®®å®¹é”™æ—¶é—´

åŸå› 

ç”Ÿäº§ç¯å¢ƒ

60 ç§’

å¹³è¡¡å®‰å…¨æ€§å’Œå¯ç”¨æ€§

æµ‹è¯•ç¯å¢ƒ

300 ç§’

æ–¹ä¾¿è°ƒè¯•

å¼€å‘ç¯å¢ƒ

600 ç§’

æœ¬åœ°æ—¶é—´å¯èƒ½ä¸å‡†

#### ä»£ç å®ç°

    public bool IsTimestampValid(long timestamp, int toleranceSeconds = 60)
    {
        // é£ä¹¦çš„æ—¶é—´æˆ³æ˜¯ç§’çº§çš„
        var requestTime = DateTimeOffset.FromUnixTimeSeconds(timestamp);
        var now = DateTimeOffset.UtcNow;
        
        // è®¡ç®—æ—¶é—´å·®ï¼ˆç»å¯¹å€¼ï¼‰
        var diff = Math.Abs((now - requestTime).TotalSeconds);
        
        if (diff > toleranceSeconds)
        {
            _logger.LogWarning(
                "æ—¶é—´æˆ³è¶…å‡ºå®¹é”™èŒƒå›´: è¯·æ±‚æ—¶é—´ {RequestTime}, å½“å‰æ—¶é—´ {CurrentTime}, å·®å¼‚ {Diff}ç§’",
                requestTime, now, diff);
            return false;
        }
        
        return true;
    }
    

### é˜²é‡æ”¾æ”»å‡»ï¼šå¯†é’¥ç®¡ç†

#### âŒ å±é™©çš„åšæ³•

    // åƒä¸‡ä¸è¦è¿™æ ·åšï¼
    public class FeishuConfig
    {
        public const string EncryptKey = "go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx";
        public const string VerificationToken = "fCt8xobpOKdb4yA0UoKJrhNTUaXTzJnf";
    }
    

**ä¸ºä»€ä¹ˆå±é™©ï¼Ÿ**

*   ä»£ç ä¼šè¢«æäº¤åˆ° Git ä»“åº“
*   ä»»ä½•èƒ½çœ‹åˆ°ä»£ç çš„äººéƒ½èƒ½çœ‹åˆ°å¯†é’¥
*   å¯†é’¥æ³„éœ²åå¾ˆéš¾è¿½è¸ª

#### âœ… å®‰å…¨çš„åšæ³•

**æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡**

    // appsettings.jsonï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
    {
      "FeishuWebhook": {
        "RoutePrefix": "feishu/webhook"
      }
    }
    
    // ç¯å¢ƒå˜é‡ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šé…ç½®ï¼‰
    FEISHU_ENCRYPT_KEY=go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx
    FEISHU_VERIFICATION_TOKEN=fCt8xobpOKdb4yA0UoKJrhNTUaXTzJnf
    
    // ä»£ç ä¸­è¯»å–
    var encryptKey = Environment.GetEnvironmentVariable("FEISHU_ENCRYPT_KEY");
    

**æ–¹æ¡ˆ 2ï¼šä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡**

    // ä½¿ç”¨ Azure Key Vault
    var client = new SecretClient(vaultUri, new DefaultAzureCredential());
    var secret = await client.GetSecretAsync("feishu-encrypt-key");
    var encryptKey = secret.Value.Value;
    
    // ä½¿ç”¨ AWS Secrets Manager
    var client = new AmazonSecretsManagerClient();
    var request = new GetSecretValueRequest { SecretId = "feishu/encrypt-key" };
    var response = await client.GetSecretValueAsync(request);
    var encryptKey = response.SecretString;
    

### é˜²é‡æ”¾æ”»å‡»ï¼šå¤šåº”ç”¨åœºæ™¯

å¦‚æœä½ çš„å…¬å¸æœ‰å¤šä¸ªé£ä¹¦åº”ç”¨ï¼Œå¯ä»¥è®©å®ƒä»¬å…±äº«ä¸€ä¸ª Webhook ç«¯ç‚¹ï¼š

graph TB subgraph "å¤šåº”ç”¨é…ç½®ç¤ºä¾‹" A\["åº”ç”¨ A<br/>(cli\_a98ea7d1a0ba100b)"\] B\["åº”ç”¨ B<br/>(cli\_b12345678901234c)"\] C\["åº”ç”¨ C<br/>(cli\_c98765432109876d)"\] A --> A1\["Encrypt Key:<br/>go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx"\] A --> A2\["Verification Token:<br/>fCt8xobpOKdb4yA0UoKJrhNTUaXTzJnf"\] B --> B1\["Encrypt Key:<br/>xY9zAbCdEfGhIjKlMnOpQrStUvWx1234"\] B --> B2\["Verification Token:<br/>gHt9ypcqPLec5zB1VpLKsiOUVbYUaKog"\] C --> C1\["Encrypt Key:<br/>1234AbCdEfGhIjKlMnOpQrStUvWxYz56"\] C --> C2\["Verification Token:<br/>hJu0zqdqQMfd6aC2WqMLtjPVWcZVbLph"\] end style A fill:#e3f2fd style B fill:#f3e5f5 style C fill:#e8f5e9

#### é…ç½®æ–‡ä»¶

    {
      "FeishuWebhook": {
        "MultiAppEncryptKeys": {
          "cli_a98ea7d1a0ba100b": "go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx",
          "cli_b12345678901234c": "xY9zAbCdEfGhIjKlMnOpQrStUvWx1234",
          "cli_c98765432109876d": "1234AbCdEfGhIjKlMnOpQrStUvWxYz56"
        },
        "DefaultAppId": "cli_a98ea7d1a0ba100b"
      }
    }
    

#### ä»£ç å®ç°

    private string GetEncryptKey(string appId)
    {
        // å°è¯•ä»å¤šåº”ç”¨é…ç½®ä¸­è·å–
        if (_options.MultiAppEncryptKeys.TryGetValue(appId, out var key))
        {
            _logger.LogDebug("ä½¿ç”¨åº”ç”¨ {AppId} çš„ä¸“ç”¨å¯†é’¥", appId);
            return key;
        }
        
        // å›é€€åˆ°é»˜è®¤å¯†é’¥
        if (!string.IsNullOrEmpty(_options.DefaultAppId) &&
            _options.MultiAppEncryptKeys.TryGetValue(_options.DefaultAppId, out var defaultKey))
        {
            _logger.LogWarning("æœªæ‰¾åˆ°åº”ç”¨ {AppId} çš„å¯†é’¥ï¼Œä½¿ç”¨é»˜è®¤å¯†é’¥", appId);
            return defaultKey;
        }
        
        // æœ€åå›é€€åˆ°ä¸»å¯†é’¥
        _logger.LogWarning("ä½¿ç”¨ä¸»å¯†é’¥");
        return _options.EncryptKey;
    }
    

* * *

é—®é¢˜æ’æŸ¥æŒ‡å—
------

å½“ç­¾åéªŒè¯å¤±è´¥æ—¶ï¼Œä¸è¦æ…Œå¼ ã€‚æŒ‰ç…§è¿™ä¸ªæ¸…å•é€é¡¹æ£€æŸ¥ï¼Œ99% çš„é—®é¢˜éƒ½èƒ½æ‰¾åˆ°åŸå› ã€‚

### æ’æŸ¥æ¸…å•

flowchart TD Start(\[ç­¾åéªŒè¯å¤±è´¥\]) --> Check1{ç¬¬ 1 æ­¥ï¼šæ£€æŸ¥å¯†é’¥é…ç½®} Check1 --> Q1a\[Encrypt Key æ˜¯å¦æ­£ç¡®?\] Check1 --> Q1b\[é•¿åº¦æ˜¯å¦ä¸º 32 å­—ç¬¦?\] Check1 --> Q1c\[æ˜¯å¦æœ‰å¤šä½™çš„ç©ºæ ¼æˆ–æ¢è¡Œç¬¦?\] Check1 --> Q1d\[æ˜¯å¦ä½¿ç”¨äº† Verification Token?\] Q1a --> |æœ‰é—®é¢˜| Fix1\[ä¿®æ­£å¯†é’¥\] Q1b --> |æœ‰é—®é¢˜| Fix1 Q1c --> |æœ‰é—®é¢˜| Fix1 Q1d --> |æœ‰é—®é¢˜| Fix1 Q1a --> |æ­£å¸¸| Check2{ç¬¬ 2 æ­¥ï¼šæ£€æŸ¥ç­¾åå­—ç¬¦ä¸²æ„å»º} Q1b --> |æ­£å¸¸| Check2 Q1c --> |æ­£å¸¸| Check2 Q1d --> |æ­£å¸¸| Check2 Check2 --> Q2a\[æ˜¯å¦ç›´æ¥æ‹¼æ¥?\] Check2 --> Q2b\[é¡ºåºæ˜¯å¦æ­£ç¡®?\] Check2 --> Q2c\[body æ˜¯å¦ä¸ºåŸå§‹è¯·æ±‚ä½“?\] Check2 --> Q2d\[æ˜¯å¦åŒ…å«äº† Encrypt Key?\] Q2a --> |æœ‰é—®é¢˜| Fix2\[ä¿®æ­£æ‹¼æ¥æ–¹å¼\] Q2b --> |æœ‰é—®é¢˜| Fix2 Q2c --> |æœ‰é—®é¢˜| Fix2 Q2d --> |æœ‰é—®é¢˜| Fix2 Q2a --> |æ­£å¸¸| Check3{ç¬¬ 3 æ­¥ï¼šæ£€æŸ¥ç­¾åç®—æ³•} Q2b --> |æ­£å¸¸| Check3 Q2c --> |æ­£å¸¸| Check3 Q2d --> |æ­£å¸¸| Check3 Check3 --> Q3a\[æ˜¯å¦ä½¿ç”¨ SHA-256?\] Check3 --> Q3b\[è¾“å‡ºæ ¼å¼æ˜¯å¦ä¸ºå°å†™åå…­è¿›åˆ¶?\] Q3a --> |æœ‰é—®é¢˜| Fix3\[ä¿®æ­£ç®—æ³•\] Q3b --> |æœ‰é—®é¢˜| Fix3 Q3a --> |æ­£å¸¸| Check4{ç¬¬ 4 æ­¥ï¼šæ£€æŸ¥æ—¶é—´æˆ³å’Œ Nonce} Q3b --> |æ­£å¸¸| Check4 Check4 --> Q4a\[æ—¶é—´æˆ³æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´å†…?\] Check4 --> Q4b\[æœåŠ¡å™¨æ—¶é—´æ˜¯å¦å‡†ç¡®?\] Check4 --> Q4c\[Nonce æ˜¯å¦è¢«è¯¯æ ‡è®°?\] Q4a --> |æœ‰é—®é¢˜| Fix4\[ä¿®æ­£æ—¶é—´ç›¸å…³é—®é¢˜\] Q4b --> |æœ‰é—®é¢˜| Fix4 Q4c --> |æœ‰é—®é¢˜| Fix4 Q4a --> |æ­£å¸¸| Success\[âœ… é—®é¢˜å·²è§£å†³\] Q4b --> |æ­£å¸¸| Success Q4c --> |æ­£å¸¸| Success Fix1 --> Retry\[é‡æ–°æµ‹è¯•\] Fix2 --> Retry Fix3 --> Retry Fix4 --> Retry Retry --> Start style Check1 fill:#e3f2fd style Check2 fill:#f3e5f5 style Check3 fill:#e8f5e9 style Check4 fill:#fff3e0 style Success fill:#c8e6c9 style Fix1 fill:#ffebee style Fix2 fill:#ffebee style Fix3 fill:#ffebee style Fix4 fill:#ffebee

### æ’æŸ¥æŠ€å·§

#### æŠ€å·§ 1ï¼šæ‰“å°å…³é”®ä¿¡æ¯

    _logger.LogDebug("========== ç­¾åéªŒè¯è°ƒè¯•ä¿¡æ¯ ==========");
    _logger.LogDebug("Timestamp: {Timestamp}", timestamp);
    _logger.LogDebug("Nonce: {Nonce}", nonce);
    _logger.LogDebug("Encrypt Key å‰ 8 ä½: {KeyPrefix}", 
        encryptKey.Substring(0, 8));
    _logger.LogDebug("Body é•¿åº¦: {BodyLength}", body.Length);
    _logger.LogDebug("Body å‰ 100 å­—ç¬¦: {BodyPrefix}", 
        body.Substring(0, Math.Min(100, body.Length)));
    _logger.LogDebug("ç­¾åå­—ç¬¦ä¸²å‰ 150 å­—ç¬¦: {SignStringPrefix}", 
        signString.Substring(0, Math.Min(150, signString.Length)));
    _logger.LogDebug("è®¡ç®—çš„ç­¾å: {ComputedSignature}", computedSignature);
    _logger.LogDebug("æœŸæœ›çš„ç­¾å: {ExpectedSignature}", headerSignature);
    _logger.LogDebug("========================================");
    

#### æŠ€å·§ 2ï¼šä½¿ç”¨åœ¨çº¿å·¥å…·éªŒè¯

ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç®€å•çš„åœ¨çº¿å·¥å…·æ¥éªŒè¯ç­¾åè®¡ç®—ï¼š

    <!DOCTYPE html>
    <html>
    <head>
        <title>é£ä¹¦ç­¾åéªŒè¯å·¥å…·</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    </head>
    <body>
        <h1>é£ä¹¦ç­¾åéªŒè¯å·¥å…·</h1>
        
        <label>Timestamp:</label>
        <input type="text" id="timestamp" placeholder="1768550348"><br>
        
        <label>Nonce:</label>
        <input type="text" id="nonce" placeholder="149323894"><br>
        
        <label>Encrypt Key:</label>
        <input type="text" id="encryptKey" placeholder="32ä½å¯†é’¥"><br>
        
        <label>Body:</label>
        <textarea id="body" rows="5" placeholder='{"encrypt":"..."}'></textarea><br>
        
        <button onclick="calculate()">è®¡ç®—ç­¾å</button>
        
        <h3>ç»“æœï¼š</h3>
        <div id="result"></div>
        
        <script>
        function calculate() {
            const timestamp = document.getElementById('timestamp').value;
            const nonce = document.getElementById('nonce').value;
            const encryptKey = document.getElementById('encryptKey').value;
            const body = document.getElementById('body').value;
            
            // æ„å»ºç­¾åå­—ç¬¦ä¸²
            const signString = timestamp + nonce + encryptKey + body;
            
            // è®¡ç®— SHA-256
            const hash = CryptoJS.SHA256(signString);
            const signature = hash.toString(CryptoJS.enc.Hex).toLowerCase();
            
            // æ˜¾ç¤ºç»“æœ
            document.getElementById('result').innerHTML = `
                <p><strong>ç­¾åå­—ç¬¦ä¸²å‰ 100 å­—ç¬¦ï¼š</strong><br>
                ${signString.substring(0, 100)}...</p>
                <p><strong>è®¡ç®—çš„ç­¾åï¼š</strong><br>
                <code style="color: green; font-size: 14px;">${signature}</code></p>
            `;
        }
        </script>
    </body>
    </html>
    

#### æŠ€å·§ 3ï¼šå•å…ƒæµ‹è¯•

    [Fact]
    public async Task ValidateSignature_WithCorrectData_ShouldReturnTrue()
    {
        // Arrange
        var timestamp = 1768550348L;
        var nonce = "149323894";
        var encryptKey = "go4kwHmzAbCdEfGhIjKlMnOpQrStUvWx";
        var body = "{\"encrypt\":\"Ul/tHTDEQkOlKZuqYTS7t...\"}";
        
        // æ‰‹åŠ¨è®¡ç®—æœŸæœ›çš„ç­¾å
        var signString = $"{timestamp}{nonce}{encryptKey}{body}";
        using var sha256 = SHA256.Create();
        var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
        var expectedSignature = BitConverter.ToString(hashBytes).Replace("-", "").ToLower();
        
        // Act
        var result = await _validator.ValidateSignature(
            timestamp, nonce, body, expectedSignature, encryptKey);
        
        // Assert
        Assert.True(result);
    }
    

### æ’æŸ¥é€ŸæŸ¥è¡¨

é”™è¯¯ç°è±¡

å¯èƒ½åŸå› 

è§£å†³æ–¹æ¡ˆ

ä¼˜å…ˆçº§

ç­¾åä¸åŒ¹é…

ä½¿ç”¨äº† HMAC-SHA256

æ”¹ç”¨çº¯ SHA-256

â­â­â­

ç­¾åä¸åŒ¹é…

ç­¾åå­—ç¬¦ä¸²æœ‰æ¢è¡Œç¬¦

ç›´æ¥æ‹¼æ¥ï¼Œæ— åˆ†éš”ç¬¦

â­â­â­

ç­¾åä¸åŒ¹é…

ä½¿ç”¨äº† Verification Token

æ”¹ç”¨ Encrypt Key

â­â­â­

ç­¾åä¸åŒ¹é…

è¾“å‡ºæ ¼å¼ä¸º Base64

æ”¹ç”¨å°å†™åå…­è¿›åˆ¶

â­â­â­

ç­¾åä¸åŒ¹é…

ç­¾åå­—ç¬¦ä¸²ç¼ºå°‘ Encrypt Key

æ·»åŠ  Encrypt Key

â­â­â­

æ—¶é—´æˆ³æ— æ•ˆ

æœåŠ¡å™¨æ—¶é—´ä¸åŒæ­¥

åŒæ­¥æœåŠ¡å™¨æ—¶é—´

â­â­

Nonce é‡å¤

Redis ç¼“å­˜é…ç½®é”™è¯¯

æ£€æŸ¥ Redis è¿æ¥

â­â­

è§£å¯†æˆåŠŸä½†ç­¾åå¤±è´¥

å¯†é’¥é…ç½®æ··ä¹±

ç¡®è®¤ä½¿ç”¨æ­£ç¡®çš„å¯†é’¥

â­â­

* * *

æ€»ç»“ä¸æ€è€ƒ
-----

### æ ¸å¿ƒè¦ç‚¹å›é¡¾

è®©æˆ‘ç”¨ä¸€å¼ å›¾æ€»ç»“é£ä¹¦ç­¾åéªŒè¯çš„æ ¸å¿ƒè¦ç‚¹ï¼š

mindmap root((é£ä¹¦ Webhook<br/>ç­¾åéªŒè¯æ ¸å¿ƒè¦ç‚¹)) 1ï¸âƒ£ ç­¾åç®—æ³• âœ… SHA-256 âŒ HMAC-SHA256 2ï¸âƒ£ ç­¾åå­—ç¬¦ä¸² âœ… ç›´æ¥æ‹¼æ¥ timestamp + nonce + encryptKey + body âŒ ä½¿ç”¨æ¢è¡Œç¬¦åˆ†éš” 3ï¸âƒ£ ä½¿ç”¨çš„å¯†é’¥ âœ… Encrypt Key âŒ Verification Token 4ï¸âƒ£ è¾“å‡ºæ ¼å¼ âœ… å°å†™åå…­è¿›åˆ¶ f2d909fb... âŒ Base64 ç¼–ç  5ï¸âƒ£ å®‰å…¨é˜²æŠ¤ âœ… Nonce å»é‡ âœ… æ—¶é—´æˆ³éªŒè¯ âœ… å›ºå®šæ—¶é—´æ¯”è¾ƒ âœ… å¯†é’¥å®‰å…¨å­˜å‚¨

### å¯¹æ¯”å…¶ä»–å¹³å°

ä¸ºäº†å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ï¼Œæˆ‘æ•´ç†äº†å‡ ä¸ªä¸»æµå¹³å°çš„ç­¾åéªŒè¯å¯¹æ¯”ï¼š

å¹³å°

ç­¾åç®—æ³•

å¯†é’¥ç±»å‹

å­—ç¬¦ä¸²æ ¼å¼

è¾“å‡ºæ ¼å¼

åˆ†éš”ç¬¦

**é£ä¹¦**

SHA-256

Encrypt Key

timestamp+nonce+key+body

å°å†™ Hex

æ— 

å¾®ä¿¡

SHA-1

Token

å­—å…¸åºæ’åºåæ‹¼æ¥

å°å†™ Hex

æ— 

é’‰é’‰

HMAC-SHA256

App Secret

timestamp+\\n+secret

Base64

\\n

ä¼ä¸šå¾®ä¿¡

SHA-256

Token

å­—å…¸åºæ’åºåæ‹¼æ¥

å°å†™ Hex

æ— 

Slack

HMAC-SHA256

Signing Secret

version:timestamp:body

Hex

:

**å…³é”®å‘ç°ï¼š**

*   é£ä¹¦å’Œå¾®ä¿¡éƒ½ç”¨çº¯å“ˆå¸Œï¼ˆSHAï¼‰ï¼Œä¸ç”¨ HMAC
*   é’‰é’‰å’Œ Slack ç”¨ HMAC-SHA256
*   å¤§éƒ¨åˆ†å¹³å°è¾“å‡ºåå…­è¿›åˆ¶ï¼Œåªæœ‰é’‰é’‰ç”¨ Base64
*   é£ä¹¦çš„ç‰¹æ®Šä¹‹å¤„ï¼šç­¾åå­—ç¬¦ä¸²ä¸­åŒ…å«å¯†é’¥æœ¬èº«

### æ’æŸ¥ç»éªŒæ€»ç»“

ç»è¿‡è¿™æ¬¡è¸©å‘ç»å†ï¼Œæˆ‘æ€»ç»“äº†å‡ ç‚¹ç»éªŒï¼š

#### ğŸ’¡ ç»éªŒ 1ï¼šä¸è¦æƒ³å½“ç„¶

> "æˆ‘ä»¥ä¸ºé£ä¹¦åº”è¯¥å’Œå¾®ä¿¡ä¸€æ ·..."  
> "æˆ‘è§‰å¾—åº”è¯¥ç”¨æ¢è¡Œç¬¦åˆ†éš”..."  
> "æˆ‘çŒœæµ‹åº”è¯¥ç”¨ Verification Token..."

**æ•™è®­ï¼š** æ¯ä¸ªå¹³å°éƒ½æœ‰è‡ªå·±çš„å®ç°æ–¹å¼ï¼Œä¸è¦åŸºäºå…¶ä»–å¹³å°çš„ç»éªŒåšå‡è®¾ã€‚**ä»”ç»†é˜…è¯»å®˜æ–¹æ–‡æ¡£**æ˜¯æœ€é‡è¦çš„ã€‚

#### ğŸ’¡ ç»éªŒ 2ï¼šæ—¥å¿—æ˜¯ä½ æœ€å¥½çš„æœ‹å‹

åœ¨è°ƒè¯•ç­¾åéªŒè¯é—®é¢˜æ—¶ï¼Œè¯¦ç»†çš„æ—¥å¿—å¸®äº†æˆ‘å¤§å¿™ï¼š

    // å¥½çš„æ—¥å¿—ç¤ºä¾‹
    _logger.LogDebug("ç­¾åå­—ç¬¦ä¸²: {SignString}", signString);
    _logger.LogDebug("è®¡ç®—çš„ç­¾å: {Computed}, æœŸæœ›çš„ç­¾å: {Expected}", 
        computed, expected);
    
    // ä¸å¥½çš„æ—¥å¿—ç¤ºä¾‹
    _logger.LogError("ç­¾åéªŒè¯å¤±è´¥");  // æ²¡æœ‰ä»»ä½•æœ‰ç”¨ä¿¡æ¯
    

#### ğŸ’¡ ç»éªŒ 3ï¼šå®‰å…¨æ€§å’Œå¯ç”¨æ€§çš„å¹³è¡¡

*   **å¼€å‘ç¯å¢ƒ**ï¼šå¯ä»¥æ”¾å®½é™åˆ¶ï¼Œæ–¹ä¾¿è°ƒè¯•
*   **æµ‹è¯•ç¯å¢ƒ**ï¼šæ¥è¿‘ç”Ÿäº§ç¯å¢ƒçš„é…ç½®
*   **ç”Ÿäº§ç¯å¢ƒ**ï¼šä¸¥æ ¼çš„å®‰å…¨ç­–ç•¥

    var toleranceSeconds = _environment.IsProduction() ? 60 : 300;
    

#### ğŸ’¡ ç»éªŒ 4ï¼šå†™å•å…ƒæµ‹è¯•

ç­¾åéªŒè¯çš„é€»è¾‘ç›¸å¯¹ç‹¬ç«‹ï¼Œéå¸¸é€‚åˆå†™å•å…ƒæµ‹è¯•ï¼š

    [Theory]
    [InlineData(1768550348, "149323894", "go4kwHmz...", "{...}", "f2d909fb...")]
    public async Task ValidateSignature_WithKnownData_ShouldMatch(
        long timestamp, string nonce, string key, string body, string expected)
    {
        var result = await _validator.ValidateSignature(
            timestamp, nonce, body, expected, key);
        Assert.True(result);
    }
    

### å»¶ä¼¸æ€è€ƒ

#### ğŸ¤” ä¸ºä»€ä¹ˆé£ä¹¦ä¸ç”¨ HMAC-SHA256ï¼Ÿ

HMAC-SHA256 æ˜¯æ›´æ ‡å‡†çš„ç­¾åç®—æ³•ï¼Œä¸ºä»€ä¹ˆé£ä¹¦é€‰æ‹©äº†çº¯ SHA-256ï¼Ÿ

æˆ‘çš„çŒœæµ‹ï¼š

1.  **æ€§èƒ½è€ƒè™‘**ï¼šSHA-256 æ¯” HMAC-SHA256 ç¨å¿«
2.  **å®ç°ç®€å•**ï¼šä¸éœ€è¦é¢å¤–çš„ HMAC åº“
3.  **å†å²åŸå› **ï¼šå¯èƒ½æ˜¯æ—©æœŸè®¾è®¡çš„é—ç•™

ä½†ä»å®‰å…¨è§’åº¦çœ‹ï¼ŒHMAC-SHA256 ä¼šæ›´å¥½ï¼Œå› ä¸ºå®ƒä¸“é—¨è®¾è®¡ç”¨äºæ¶ˆæ¯è®¤è¯ã€‚

#### ğŸ¤” ä¸ºä»€ä¹ˆè¦æŠŠå¯†é’¥æ”¾åœ¨ç­¾åå­—ç¬¦ä¸²é‡Œï¼Ÿ

è¿™æ˜¯é£ä¹¦çš„ä¸€ä¸ªç‰¹æ®Šè®¾è®¡ã€‚é€šå¸¸çš„åšæ³•æ˜¯ï¼š

*   **HMAC æ–¹å¼**ï¼šå¯†é’¥ä½œä¸º HMAC çš„å¯†é’¥å‚æ•°
*   **é£ä¹¦æ–¹å¼**ï¼šå¯†é’¥ç›´æ¥æ‹¼æ¥åˆ°å­—ç¬¦ä¸²ä¸­

è¿™ç§æ–¹å¼çš„ä¼˜ç‚¹ï¼š

*   å®ç°ç®€å•ï¼Œä¸éœ€è¦ HMAC åº“
*   å¯†é’¥å‚ä¸å“ˆå¸Œè®¡ç®—ï¼Œæä¾›äº†ä¸€å®šçš„å®‰å…¨æ€§

ç¼ºç‚¹ï¼š

*   ä¸å¦‚ HMAC æ ‡å‡†å’Œå®‰å…¨
*   å®¹æ˜“è¢«è¯¯è§£ï¼ˆå¾ˆå¤šäººä¼šå¿˜è®°åŠ å¯†é’¥ï¼‰

### æ¨ è èµ„ æº

å¦‚æœä½ æƒ³æ·±å…¥å­¦ä¹ ï¼Œè¿™é‡Œæœ‰ä¸€äº›æ¨èèµ„æºï¼š

#### ğŸ“š å®˜æ–¹æ–‡æ¡£

*   [é£ä¹¦å¼€æ”¾å¹³å° - äº‹ä»¶è®¢é˜…](https://open.feishu.cn/document/server-docs/event-subscription-guide/overview)
*   [é£ä¹¦å¼€æ”¾å¹³å° - ç­¾åéªŒè¯](https://open.feishu.cn/document/event-subscription-guide/event-subscriptions/event-subscription-configure-/choose-a-subscription-mode/send-notifications-to-developers-server)

#### ğŸ› ï¸ å¼€æºé¡¹ç›®

*   [Mud.Feishu SDK Github](https://github.com/mudtools/MudFeishu)
*   [Mud.Feishu SDK Gitee](https://gitee.com/mudtools/MudFeishu)
*   [é£ä¹¦å®˜æ–¹ SDK](https://github.com/larksuite) - å¤šè¯­è¨€å®˜æ–¹ SDK

* * *

å†™åœ¨æœ€å
----

ä»æœ€åˆçš„ç­¾åéªŒè¯å¤±è´¥ï¼Œåˆ°æœ€ç»ˆææ¸…æ¥šæ‰€æœ‰ç»†èŠ‚ï¼Œè¿™ä¸ªè¿‡ç¨‹è®©æˆ‘æ·±åˆ»ä½“ä¼šåˆ°ï¼š

> **æŠ€æœ¯ç»†èŠ‚å†³å®šæˆè´¥ã€‚** ä¸€ä¸ªå°å°çš„ç®—æ³•å·®å¼‚ã€ä¸€ä¸ªå­—ç¬¦ä¸²æ ¼å¼çš„ä¸åŒï¼Œéƒ½å¯èƒ½å¯¼è‡´åŠŸèƒ½å®Œå…¨æ— æ³•å·¥ä½œã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ï¼š

*   âœ… ç†è§£é£ä¹¦ Webhook ç­¾åéªŒè¯çš„å®Œæ•´æœºåˆ¶
*   âœ… é¿å…æˆ‘è¸©è¿‡çš„å‘
*   âœ… å¿«é€Ÿå®šä½å’Œè§£å†³ç­¾åéªŒè¯é—®é¢˜
*   âœ… æ„å»ºå®‰å…¨å¯é çš„ Webhook æœåŠ¡

å¦‚æœä½ åœ¨å®ç°è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€è®¨è®ºã€‚å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œä¹Ÿæ¬¢è¿åˆ†äº«ç»™æ›´å¤šéœ€è¦çš„äººã€‚

**ç¥ä½ çš„é£ä¹¦é›†æˆä¹‹æ—…ä¸€å¸†é£é¡ºï¼** ğŸš€

* * *

é™„å½•ï¼šå¿«é€Ÿå‚è€ƒ
-------

### A. ç­¾åéªŒè¯ä»£ç æ¨¡æ¿ï¼ˆC#ï¼‰

    public async Task<bool> ValidateFeishuSignature(HttpRequest request)
    {
        // 1. æå–è¯·æ±‚å¤´
        var timestamp = long.Parse(request.Headers["X-Lark-Request-Timestamp"]);
        var nonce = request.Headers["X-Lark-Request-Nonce"].ToString();
        var signature = request.Headers["X-Lark-Signature"].ToString();
        
        // 2. è¯»å–è¯·æ±‚ä½“
        request.EnableBuffering();
        var body = await new StreamReader(request.Body).ReadToEndAsync();
        request.Body.Position = 0;
        
        // 3. æ„å»ºç­¾åå­—ç¬¦ä¸²
        var signString = $"{timestamp}{nonce}{_encryptKey}{body}";
        
        // 4. è®¡ç®— SHA-256
        using var sha256 = SHA256.Create();
        var hash = sha256.ComputeHash(Encoding.UTF8.GetBytes(signString));
        var computed = BitConverter.ToString(hash).Replace("-", "").ToLower();
        
        // 5. æ¯”è¾ƒç­¾å
        return computed == signature;
    }
    

### B. é…ç½®æ–‡ä»¶æ¨¡æ¿

    {
      "FeishuWebhook": {
        "VerificationToken": "ä»é£ä¹¦åå°è·å–",
        "EncryptKey": "ä»é£ä¹¦åå°è·å–ï¼ˆ32ä½ï¼‰",
        "RoutePrefix": "feishu/webhook",
        "TimestampToleranceSeconds": 60,
        "EnableRequestLogging": true,
        "EnableBackgroundProcessing": false
      }
    }
    

### C. æœ¯è¯­è¡¨

æœ¯è¯­

è‹±æ–‡

è§£é‡Š

ç­¾å

Signature

ç”¨äºéªŒè¯æ•°æ®å®Œæ•´æ€§å’Œæ¥æºçš„å­—ç¬¦ä¸²

å“ˆå¸Œ

Hash

å°†ä»»æ„é•¿åº¦æ•°æ®è½¬æ¢ä¸ºå›ºå®šé•¿åº¦çš„ç®—æ³•

HMAC

Hash-based Message Authentication Code

åŸºäºå“ˆå¸Œçš„æ¶ˆæ¯è®¤è¯ç 

Nonce

Number used once

ä¸€æ¬¡æ€§éšæœºæ•°ï¼Œç”¨äºé˜²é‡æ”¾æ”»å‡»

æ—¶é—´æˆ³

Timestamp

Unix æ—¶é—´æˆ³ï¼Œè¡¨ç¤ºè¯·æ±‚å‘é€æ—¶é—´

é‡æ”¾æ”»å‡»

Replay Attack

é‡å¤å‘é€å·²æˆªè·çš„åˆæ³•è¯·æ±‚

è®¡æ—¶æ”»å‡»

Timing Attack

é€šè¿‡æµ‹é‡æ“ä½œæ—¶é—´æ¥æ¨æ–­ä¿¡æ¯