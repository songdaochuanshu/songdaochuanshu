---
layout: post
title: 'é«˜å¯ç”¨é«˜å¹¶å‘å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼šNginx ä¸ API Gateway çš„ååŒå®è·µ'
date: "2025-08-22T00:40:37Z"
---
é«˜å¯ç”¨é«˜å¹¶å‘å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼šNginx ä¸ API Gateway çš„ååŒå®è·µ
=======================================

ğŸŒ **é«˜å¯ç”¨é«˜å¹¶å‘å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼šNginx ä¸ API Gateway çš„ååŒå®è·µ**
==============================================

> **ä½œè€…**ï¼šå¤æ¸¡è“æŒ‰  
> **æŠ€æœ¯æ ˆ**ï¼šNginx ä¸ API Gateway
> 
> **ä¸ªäººå¾®ä¿¡å…¬ä¼—å·**ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆæ·±å…¥æµ…å‡ºè°ˆjavaï¼‰  
> æ„Ÿè§‰æœ¬ç¯‡å¯¹ä½ æœ‰å¸®åŠ©å¯ä»¥å…³æ³¨ä¸€ä¸‹ï¼Œä¼šä¸å®šæœŸæ›´æ–°çŸ¥è¯†å’Œé¢è¯•èµ„æ–™ã€æŠ€å·§ï¼ï¼ï¼

ä¸€ã€Nginx å’Œ Gateway çš„å…³ç³»ï¼šæ˜¯æ›¿ä»£è¿˜æ˜¯åä½œï¼Ÿ
------------------------------

**ä¸æ˜¯æ›¿ä»£å…³ç³»ï¼Œè€Œæ˜¯åä½œå…³ç³»ã€‚**

### 1\. Nginx çš„è§’è‰²ï¼ˆé€šå¸¸åœ¨æœ€å¤–å±‚ï¼‰

*   **åå‘ä»£ç† & è´Ÿè½½å‡è¡¡**ï¼šå°†å‰ç«¯è¯·æ±‚åˆ†å‘åˆ°å¤šä¸ªåç«¯æœåŠ¡æˆ–ç½‘å…³å®ä¾‹ã€‚
*   **é™æ€èµ„æºæœåŠ¡**ï¼šéƒ¨ç½²å‰ç«¯ï¼ˆå¦‚ Vue/React æ‰“åŒ…åçš„é™æ€æ–‡ä»¶ï¼‰ã€‚
*   **SSL ç»ˆæ­¢**ï¼šå¤„ç† HTTPSï¼Œå‡è½»åç«¯å‹åŠ›ã€‚
*   **å®‰å…¨é˜²æŠ¤**ï¼šå¦‚é˜² DDOSã€é™æµã€WAFï¼ˆé…åˆæ¨¡å—ï¼‰ã€‚
*   **é«˜å¯ç”¨å…¥å£**ï¼šä½œä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ã€‚

### 2\. API Gateway çš„è§’è‰²ï¼ˆåœ¨å¾®æœåŠ¡å±‚å‰é¢ï¼‰

*   **æœåŠ¡è·¯ç”±**ï¼šæ ¹æ®è·¯å¾„å°†è¯·æ±‚è½¬å‘åˆ°å…·ä½“çš„å¾®æœåŠ¡ï¼ˆå¦‚ `/user/**` â†’ user-serviceï¼‰ã€‚
*   **è®¤è¯é‰´æƒ**ï¼šç»Ÿä¸€å¤„ç† JWTã€OAuth2 ç­‰ã€‚
*   **é™æµç†”æ–­**ï¼šé˜²æ­¢æŸä¸ªæœåŠ¡è¢«å‹å®ã€‚
*   **æ—¥å¿—ç›‘æ§**ï¼šç»Ÿä¸€è®°å½•è¯·æ±‚æ—¥å¿—ã€é“¾è·¯è¿½è¸ªã€‚
*   **åè®®è½¬æ¢**ï¼šå¦‚ REST â†’ gRPCã€‚

* * *

äºŒã€å…¸å‹æ¶æ„å›¾ï¼ˆé«˜å¯ç”¨ + é«˜å¹¶å‘ï¼‰
------------------

    ç”¨æˆ· â†’ DNS â†’ [Nginx LB (HA)] â†’ [API Gateway é›†ç¾¤] â†’ [å¾®æœåŠ¡é›†ç¾¤]
                    â†‘                   â†‘
               (é™æ€èµ„æº)         (åŠ¨æ€è·¯ç”±/é‰´æƒ/é™æµ)
    

### ç»„ä»¶è¯´æ˜ï¼š

1.  Nginx é›†ç¾¤ï¼ˆä¸»å¤‡æˆ–åŒæ´»ï¼‰ï¼š
    *   ä½¿ç”¨ Keepalived + VIP å®ç°é«˜å¯ç”¨ã€‚
    *   å¤šå° Nginx å‰ç½®è´Ÿè½½å‡è¡¡ï¼ˆå¯å†åŠ  LVS/F5 æˆ–äº‘ SLBï¼‰ã€‚
2.  API Gateway é›†ç¾¤ï¼š
    *   å¤šå®ä¾‹éƒ¨ç½²ï¼Œæ³¨å†Œåˆ° Nginx æˆ–æœåŠ¡å‘ç°ï¼ˆå¦‚ Nacos/Eurekaï¼‰ã€‚
    *   æ”¯æŒæ¨ªå‘æ‰©å±•ï¼Œåº”å¯¹é«˜å¹¶å‘ã€‚
3.  å¾®æœåŠ¡é›†ç¾¤ï¼š
    *   æ¯ä¸ªæœåŠ¡å¤šå®ä¾‹éƒ¨ç½²ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒå‘ç°ã€‚

* * *

ä¸‰ã€é…ç½®ç¤ºä¾‹
------

### 1\. Nginx é…ç½®ï¼ˆåå‘ä»£ç†åˆ° Gatewayï¼‰

    # nginx.conf æˆ– conf.d/gateway.conf
    
    upstream gateway_backend {
        server 192.168.1.10:8080 weight=5;  # Gateway å®ä¾‹1
        server 192.168.1.11:8080 weight=5;  # Gateway å®ä¾‹2
        # å¯é…ç½®å¥åº·æ£€æŸ¥
        keepalive 32;
    }
    
    server {
        listen 80;
        server_name api.yourdomain.com;
    
        # é™æ€èµ„æºï¼ˆå‰ç«¯ï¼‰
        location / {
            root /usr/share/nginx/html;
            try_files $uri $uri/ /index.html;
        }
    
        # åŠ¨æ€è¯·æ±‚ä»£ç†åˆ°ç½‘å…³
        location /api/ {
            proxy_pass http://gateway_backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    
        # WebSocket æ”¯æŒ
        location /ws/ {
            proxy_pass http://gateway_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
    

### 2\. Spring Cloud Gateway é…ç½®ï¼ˆapplication.ymlï¼‰

    spring:
      cloud:
        gateway:
          routes:
            - id: user-service
              uri: lb://user-service  # ä»æ³¨å†Œä¸­å¿ƒè´Ÿè½½å‡è¡¡
              predicates:
                - Path=/api/user/**
              filters:
                - StripPrefix=2  # å»æ‰ /api/user å‰ç¼€
    
            - id: order-service
              uri: lb://order-service
              predicates:
                - Path=/api/order/**
              filters:
                - StripPrefix=2
    
          # å…¨å±€é™æµï¼ˆRedis + Token Bucketï¼‰
          redis-rate-limiter:
            replenishRate: 10   # æ¯ç§’è¡¥å……10ä¸ªä»¤ç‰Œ
            burstCapacity: 20   # æ¡¶å®¹é‡20
    
        # æœåŠ¡å‘ç°ï¼ˆå¦‚ Nacosï¼‰
        nacos:
          discovery:
            server-addr: 192.168.1.100:8848
    

* * *

å››ã€å¦‚ä½•å®ç°é«˜å¯ç”¨ & é«˜å¹¶å‘ï¼Ÿ
----------------

ç›®æ ‡

å®ç°æ–¹å¼

**é«˜å¯ç”¨**

\- Nginx ä¸»å¤‡ï¼ˆKeepalivedï¼‰  
\- Gateway å¤šå®ä¾‹ + å¥åº·æ£€æŸ¥  
\- å¾®æœåŠ¡å¤šå‰¯æœ¬ + ç†”æ–­é™çº§ï¼ˆHystrix/Sentinelï¼‰  
\- æ•°æ®åº“ä¸»ä»/é›†ç¾¤

**é«˜å¹¶å‘**

\- Nginx è´Ÿè½½å‡è¡¡ + ç¼“å­˜é™æ€èµ„æº  
\- Gateway å¼‚æ­¥éé˜»å¡ï¼ˆNettyï¼‰  
\- Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®  
\- æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°ï¼ˆKafka/RabbitMQï¼‰  
\- æ°´å¹³æ‰©å±• Gateway å’Œå¾®æœåŠ¡

**å®‰å…¨**

\- Nginx WAFï¼ˆå¦‚ ModSecurityï¼‰  
\- Gateway ç»Ÿä¸€é‰´æƒ  
\- HTTPS + JWT

**å¯è§‚æµ‹æ€§**

\- Gateway é›†æˆ Prometheus + Grafana  
\- æ—¥å¿—æ”¶é›†ï¼ˆELKï¼‰  
\- é“¾è·¯è¿½è¸ªï¼ˆSkyWalking/Zipkinï¼‰

* * *

äº”ã€å¸¸è§è¯¯åŒº
------

âŒ **åªç”¨ Nginx ä¸ç”¨ Gateway**  
â†’ é€‚åˆç®€å•ç³»ç»Ÿï¼Œä½†å¾®æœåŠ¡å¤šäº†éš¾ä»¥ç»´æŠ¤è·¯ç”±å’Œé‰´æƒã€‚

âŒ **åªç”¨ Gateway ä¸ç”¨ Nginx**  
â†’ Gateway ä¹Ÿèƒ½åšè´Ÿè½½å‡è¡¡ï¼Œä½† Nginx æ›´æˆç†Ÿï¼Œé€‚åˆåšæœ€å¤–å±‚é˜²æŠ¤å’Œé™æ€èµ„æºæœåŠ¡ã€‚

âœ… **æ¨èï¼šNginx + Gateway ååŒå·¥ä½œ**

*   Nginx åšâ€œé—¨å«â€å’Œâ€œå‰å°â€
*   Gateway åšâ€œè°ƒåº¦ä¸­å¿ƒâ€å’Œâ€œå®‰å…¨å®¡è®¡â€

* * *

å…­ã€è¿›é˜¶å»ºè®®
------

1.  **ä½¿ç”¨äº‘åŸç”Ÿæ–¹æ¡ˆ**ï¼šå¦‚ Kubernetes + Ingress (Nginx Ingress Controller) + Istio/Envoy Gatewayã€‚
2.  **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šé…åˆ CI/CD å·¥å…·ï¼ˆJenkins/GitLab CIï¼‰è‡ªåŠ¨å‘å¸ƒ Gateway é…ç½®ã€‚
3.  **ç°åº¦å‘å¸ƒ**ï¼šåœ¨ Gateway å±‚å®ç°åŸºäº Header çš„æµé‡åˆ‡åˆ†ã€‚
4.  **æ€§èƒ½å‹æµ‹**ï¼šä½¿ç”¨ JMeter æˆ– wrk æµ‹è¯• Nginx + Gateway çš„ååèƒ½åŠ›ã€‚

* * *

æ€»ç»“
--

*   âœ… **å‰ç«¯ç”¨ Nginx éƒ¨ç½²é™æ€èµ„æº**
*   âœ… **åç«¯ç”¨ API Gateway åšç»Ÿä¸€å…¥å£ã€è·¯ç”±ã€é‰´æƒ**
*   âœ… **Nginx åå‘ä»£ç†åˆ° Gateway é›†ç¾¤ï¼Œå®ç°é«˜å¯ç”¨**
*   âœ… **é€šè¿‡è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ã€å¼‚æ­¥ã€é›†ç¾¤åŒ–å®ç°é«˜å¹¶å‘**