---
layout: post
title: 'ã€æ¸²æŸ“æµæ°´çº¿ã€‘[å‡ ä½•é˜¶æ®µ]-[å½’ä¸€åŒ–NDC]ä»¥UnityURPä¸ºä¾‹'
date: "2025-08-17T00:47:20Z"
---
ã€æ¸²æŸ“æµæ°´çº¿ã€‘\[å‡ ä½•é˜¶æ®µ\]-\[å½’ä¸€åŒ–NDC\]ä»¥UnityURPä¸ºä¾‹
=====================================

![ã€æ¸²æŸ“æµæ°´çº¿ã€‘[å‡ ä½•é˜¶æ®µ]-[å½’ä¸€åŒ–NDC]ä»¥UnityURPä¸ºä¾‹](https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250816173701263-971092966.png) æœ¬æ–‡æ¢è®¨UnityURPæ¸²æŸ“ç®¡çº¿ä¸­çš„NDCï¼ˆå½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼‰è½¬æ¢è¿‡ç¨‹ï¼Œè¯¦ç»†è§£æäº†é€è§†é™¤æ³•å°†é½æ¬¡åæ ‡è½¬æ¢ä¸ºNDCç©ºé—´çš„æ ¸å¿ƒåŸç†ã€‚æ–‡ç« æŒ‡å‡ºURPæ ¹æ®å¹³å°å·®å¼‚ï¼ˆOpenGL/Direct3Dï¼‰é‡‡ç”¨ä¸åŒçš„NDCèŒƒå›´ï¼ˆ\[-1,1\]æˆ–\[0,1\]ï¼‰ï¼Œå¹¶é€šè¿‡Shaderä»£ç ç¤ºä¾‹å±•ç¤ºäº†æ‰‹åŠ¨è®¡ç®—NDCåæ ‡çš„æ–¹æ³•ã€‚ç‰¹åˆ«å¼ºè°ƒäº†æ·±åº¦å€¼åœ¨ä¸åŒå¹³å°çš„ç‰¹æ®Šå¤„ç†æ–¹å¼ï¼Œä»¥åŠNDCåæ ‡åœ¨è§†é”¥è£å‰ªã€å±å¹•ç©ºé—´ç‰¹æ•ˆç­‰å®é™…åº”ç”¨åœºæ™¯ä¸­çš„é‡è¦ä½œç”¨ã€‚æ–‡ä¸­è¿˜åŒ…å«äº†å‡ ä½•ç€è‰²å™¨å®ç°å±å¹•ç©ºé—´ç²’å­ç”Ÿæˆçš„å®Œæ•´ä»£ç ç¤ºä¾‹ï¼Œä¸ºå¼€å‘è€…æä¾›äº†å®ç”¨çš„æŠ€æœ¯å‚è€ƒã€‚

*   **NDCç©ºé—´**â€Œï¼šé€è§†é™¤æ³•çš„ç»“æœï¼Œé¡¶ç‚¹åæ ‡å·²å½’ä¸€åŒ–ï¼Œå¯ç›´æ¥ç”¨äºè§†å£æ˜ å°„å’Œè£å‰ªâ€Œ

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

*   åœ¨æ¸²æŸ“ç®¡çº¿ä¸­ï¼Œâ€Œ**å½’ä¸€åŒ–ä¸¥æ ¼ç­‰åŒäºé€è§†é™¤æ³•**â€Œï¼Œæ˜¯é½æ¬¡åæ ‡åˆ°NDCç©ºé—´è½¬æ¢çš„æ ¸å¿ƒæ­¥éª¤â€Œã€‚Unityä¸­è¿™æ­¥ï¼Œè‡ªåŠ¨æ‰§è¡Œã€‚
*   æ•°æ®å½’ä¸€åŒ–ä¸»è¦é€šè¿‡â€Œ**NDCç©ºé—´ï¼ˆå½’ä¸€åŒ–è®¾å¤‡åæ ‡ï¼‰è½¬æ¢**â€Œå®ç°ï¼Œå…¶æ ¸å¿ƒåŸç†æ˜¯å°†è£å‰ªç©ºé—´åæ ‡ç»Ÿä¸€æ˜ å°„åˆ°æ ‡å‡†èŒƒå›´ï¼ˆ\[-1,1\]çš„ç«‹æ–¹ä½“å†…ï¼ˆOpenGLæ ‡å‡†ï¼‰æˆ–\[0,1\]ï¼ˆDirectXæ ‡å‡†ï¼‰ï¼‰
*   å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªçŸ©å½¢å†…çš„åæ ‡ä½“ç³»ã€‚ç»è¿‡è½¬åŒ–åçš„åæ ‡ä½“ç³»æ˜¯ é™åˆ¶åœ¨ä¸€ä¸ªç«‹æ–¹ä½“å†…çš„åæ ‡ä½“ç³»ã€‚æ— è®ºx y zè½´åœ¨åæ ‡ä½“ç³»å†…çš„èŒƒå›´éƒ½æ˜¯(-1, 1)ã€‚å½’ä¸€åŒ–åï¼Œzè½´å‘å±å¹•å†…ã€‚
*   å½’ä¸€åŒ–èŒƒå›´åœ¨OpenGLä¸­èŒƒå›´ä¸º\[-1, 1\]ï¼ŒDirectXä¸­ä¸º\[0, 1\]ã€‚æ˜ å°„åˆ°å±å¹•æ—¶(0, 0)ç‚¹ï¼šGpenGLæ˜¯å·¦ä¸‹è§’ï¼ŒDirectXæ˜¯å·¦ä¸Šè§’ã€‚

å½’ä¸€åŒ–åŸç†
=====

é€è§†é™¤æ³•ï¼ˆPerspective Divisionï¼‰
--------------------------

å°†é½æ¬¡è£å‰ªç©ºé—´åæ ‡çš„`(x,y,z)`åˆ†é‡é™¤ä»¥`w`åˆ†é‡ï¼Œå¾—åˆ°NDCåæ ‡

æ­¤æ“ä½œå°†åæ ‡å½’ä¸€åŒ–è‡³\[-1,1\]èŒƒå›´ï¼ˆOpenGL/Unityï¼‰æˆ–\[0,1\]èŒƒå›´ï¼ˆDirect3Dï¼‰â€Œã€‚

NDCExample.shader
-----------------

*   1.URPæ ‡å‡†åæ ‡è½¬æ¢æµç¨‹
*   2.æ‰‹åŠ¨NDCåæ ‡è®¡ç®—
*   3.é€šè¿‡v2fç»“æ„ä¼ é€’NDCæ•°æ®

    // hlsl
    Shader "Custom/NDCDemo"
    {
        SubShader
        {
            Pass
            {
                HLSLPROGRAM
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
    
                struct Attributes { float4 vertex : POSITION; };
                struct Varyings { float4 pos : SV_POSITION; float3 ndc : TEXCOORD0; };
    
                Varyings vert(Attributes v)
                {
                    Varyings o;
                    o.pos = TransformObjectToHClip(v.vertex.xyz);
                    // æ‰‹åŠ¨è®¡ç®—NDCåæ ‡
                    o.ndc = o.pos.xyz / o.pos.w; 
                    return o;
                }
                ENDHLSL
            }
        }
    }
    
    

URPä¸­çš„NDC
========

Unity URP(Universal Render Pipeline)ä¸­ï¼Œå½’ä¸€åŒ–çš„è®¾å¤‡åæ ‡(NDC)æ˜ å°„èŒƒå›´å–å†³äºå…·ä½“çš„APIå¹³å°ï¼š

1.  â€Œ**Direct3Dé£æ ¼å¹³å°**â€Œï¼ˆå¦‚Windowsã€Xboxç­‰ï¼‰ï¼š
    *   NDCèŒƒå›´æ˜¯ â€Œ**\[-1, 1\]Â³**â€Œï¼ˆx,y,zä¸‰ä¸ªç»´åº¦ï¼‰
    *   æ·±åº¦å€¼(z)æ˜ å°„åˆ°\[0,1ï¼ˆé€šè¿‡æŠ•å½±çŸ©é˜µè½¬æ¢ï¼‰
2.  â€Œ**OpenGLé£æ ¼å¹³å°**â€Œï¼ˆå¦‚MacOSã€Linuxç­‰ï¼‰ï¼š
    *   NDCèŒƒå›´æ˜¯ â€Œ**\[-1, 1\]Â³**â€Œ
    *   æ·±åº¦å€¼(z)ä¿æŒ\[-1,1\]

URPé»˜è®¤ä½¿ç”¨â€Œ**\[-1,1\]Â³**â€Œçš„NDCèŒƒå›´ï¼ˆä¸Built-inç®¡çº¿ä¸€è‡´ï¼‰ï¼Œä½†æœ€ç»ˆä¼šé€‚é…ç›®æ ‡å¹³å°çš„çº¦å®šã€‚

åæ ‡è½¬æ¢ç¤ºä¾‹è¿‡ç¨‹
--------

å‡è®¾æœ‰ä¸€ä¸ªä¸–ç•Œç©ºé—´ç‚¹(2, 1, 5)ï¼š

1.  é€šè¿‡è§†å›¾çŸ©é˜µè½¬æ¢åˆ°è§†å›¾ç©ºé—´ï¼ˆç›¸æœºç©ºé—´ï¼‰
2.  é€šè¿‡URPæŠ•å½±çŸ©é˜µè½¬æ¢åˆ°è£å‰ªç©ºé—´ï¼ˆclip spaceï¼‰
3.  é€è§†é™¤æ³•å¾—åˆ°NDCåæ ‡ï¼ˆwåˆ†é‡é™¤æ³•ï¼‰

å…·ä½“æ•°å€¼ç¤ºä¾‹ï¼ˆå‡è®¾ä½¿ç”¨D3Dé£æ ¼ï¼‰ï¼š

    ä¸–ç•Œåæ ‡ (2, 1, 5)
    â†“ è§†å›¾çŸ©é˜µè½¬æ¢
    è§†å›¾åæ ‡ (1.5, 0.8, 4.2)
    â†“ æŠ•å½±çŸ©é˜µè½¬æ¢
    è£å‰ªåæ ‡ (3.2, 1.6, 8.4, 4.2)
    â†“ é€è§†é™¤æ³• (x/w, y/w, z/w)
    NDCåæ ‡ (0.76, 0.38, 2.0) â†’ è¶…å‡º[-1,1]ä¼šè¢«è£å‰ª
    

æ·±åº¦å€¼ç‰¹æ®Šå¤„ç†
-------

åœ¨URPä¸­ï¼Œæ·±åº¦ç¼“å†²åŒºçš„å€¼ä¼šè¢«é‡æ–°æ˜ å°„ï¼š

*   åŸå§‹NDCçš„z âˆˆ \[-1,1\]ï¼ˆOpenGLï¼‰æˆ– \[0,1\]ï¼ˆD3Dï¼‰
*   æœ€ç»ˆå­˜å‚¨åˆ°æ·±åº¦çº¹ç†æ—¶ç»Ÿä¸€æ˜ å°„åˆ°\[0,1\]èŒƒå›´

### å¯ä»¥é€šè¿‡ShaderéªŒè¯ï¼š

    hlsl
    // åœ¨Fragment Shaderä¸­ï¼š
    float ndcZ = clipPos.z / clipPos.w; // é€è§†é™¤æ³•åçš„zå€¼
    float depth = ndcZ * 0.5 + 0.5;    // D3Då¹³å°ä¸‹å®é™…å­˜å‚¨å€¼
    

URPé€šè¿‡\_UNITY\_UV\_STARTS\_AT\_TOPç­‰å®å¤„ç†ä¸åŒå¹³å°çš„åæ ‡å·®å¼‚ï¼Œä¿è¯è·¨å¹³å°ä¸€è‡´æ€§ã€‚

NDCè½¬æ¢åœ¨å®é™…ä¸­çš„åº”ç”¨
============

è™½ç„¶é»˜è®¤NDCè®¡ç®—æ˜¯å›ºå®šåŠ é€Ÿè®¡ç®—çš„è¿‡ç¨‹ï¼Œä½†æ˜¯æœ‰æ—¶éœ€è¦æ‰‹åŠ¨è®¡ç®—å®ç°ä¸€äº›å®šåˆ¶æ•ˆæœã€‚

åœ¨Unity URPä¸­ï¼Œå‡ ä½•ç€è‰²å™¨(Geometry Shader)æ‰‹åŠ¨è®¡ç®—NDCå¹¶å®ç°å±å¹•æ˜ å°„çš„å…¸å‹åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

**1\. è§†é”¥è£å‰ª**

*   å°†ä¸–ç•Œåæ ‡è½¬æ¢ä¸ºNDCååˆ¤æ–­æ˜¯å¦åœ¨\[-1,1\]èŒƒå›´å†…

**2\. å±å¹•ç©ºé—´ç‰¹æ•ˆ**

*   â€Œ é€šè¿‡NDCåæ ‡è®¡ç®—UVç”¨äºé‡‡æ ·å±å¹•çº¹ç†

**3\. å‡ ä½•ä½“åŠ¨æ€ç”Ÿæˆ**

*   â€Œ æ ¹æ®NDCåæ ‡æ§åˆ¶é¡¶ç‚¹ç”ŸæˆèŒƒå›´

è®¡ç®—NDCå¹¶å®ç°å±å¹•ç©ºé—´ç²’å­ç”Ÿæˆç¤ºä¾‹ScreenSpaceParticle.shader
--------------------------------------------

*   åœ¨å‡ ä½•ç€è‰²å™¨ä¸­é€šè¿‡`clipPos.xyz / clipPos.w`å®Œæˆé€è§†é™¤æ³•å¾—åˆ°NDCåæ ‡
*   ä½¿ç”¨NDCåæ ‡æ—¶éœ€æ³¨æ„ï¼š
    *   D3Då¹³å°ä¸‹yè½´éœ€è¦å–åï¼ˆ`screenUV.y = 1 - screenUV.y`ï¼‰
    *   æ·±åº¦å€¼åœ¨D3Då¹³å°éœ€æ˜ å°„åˆ°\[0,1\]èŒƒå›´
*   ç¤ºä¾‹å®ç°äº†å±å¹•ç©ºé—´ç²’å­ç”Ÿæˆæ•ˆæœï¼Œå¯é€šè¿‡NDCåæ ‡æ§åˆ¶ç”ŸæˆèŒƒå›´

å®é™…åº”ç”¨æ—¶å¯ç»“åˆ\_UNITY\_MATRIX\_VPçŸ©é˜µè¿›è¡Œå®Œæ•´åæ ‡ç©ºé—´è½¬æ¢é“¾éªŒè¯ã€‚

    
    Shader "Custom/NDCGeometryShader"
    {
        Properties { _MainTex ("Texture", 2D) = "white" {} }
        SubShader
        {
            Tags { "RenderType"="Opaque" }
            Pass
            {
                HLSLPROGRAM
                #pragma vertex vert
                #pragma geometry geom
                #pragma fragment frag
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
    
                struct v2g {
                    float4 pos : SV_POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                struct g2f {
                    float4 pos : SV_POSITION;
                    float2 uv : TEXCOORD0;
                    float3 ndc : TEXCOORD1;
                };
    
                v2g vert(appdata_base v) {
                    v2g o;
                    o.pos = TransformObjectToHClip(v.vertex);
                    o.uv = v.texcoord;
                    return o;
                }
    
                [maxvertexcount(4)]
                void geom(point v2g input[1], inout TriangleStream<g2f> stream) {
                    // æ‰‹åŠ¨è®¡ç®—NDCåæ ‡
                    float4 clipPos = input[0].pos;
                    float3 ndc = clipPos.xyz / clipPos.w;
    
                    // å±å¹•ç©ºé—´æ‰©å±•ï¼ˆç”Ÿæˆå››è¾¹å½¢ç²’å­ï¼‰
                    float size = 0.1;
                    g2f o;
                    for(int i=0; i<4; i++) {
                        o.pos = clipPos;
                        o.pos.xy += float2((i%2)*2-1, (i/2)*2-1) * size * clipPos.w;
                        o.uv = input[0].uv;
                        o.ndc = ndc;
                        stream.Append(o);
                    }
                    stream.RestartStrip();
                }
    
                half4 frag(g2f i) : SV_Target {
                    // ä½¿ç”¨NDCåæ ‡é‡‡æ ·å±å¹•çº¹ç†
                    float2 screenUV = i.ndc.xy * 0.5 + 0.5;
                    return SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, screenUV);
                }
                ENDHLSL
            }
        }
    }
    

* * *

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

ï¼ˆæ¬¢è¿_ç‚¹èµç•™è¨€_æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰