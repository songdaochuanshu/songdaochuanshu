---
layout: post
title: 'MySQL多表查询'
date: "2025-09-09T00:39:26Z"
---
MySQL多表查询
=========

MySQL 多表查询是指同时从两个或多个关联表中检索数据，通过表之间的关系（如外键关联）将分散的数据整合起来。这是实际开发中最常用的查询方式之一，尤其在关系型数据库中，数据通常按业务逻辑拆分到不同表中存储。

### 1、核心概念

#### 1.1 多表关系

*   一对多(多对一)
*   多对多
*   一对一

#### 1.2 多表查询分类

1.  连接查询

*   内连接：相当于查询A、B交集部分数据
*   外连接：
*   左外连接：查询左表所有数据，以及两张表交集部分数据
*   右外连接：查询右表所有数据，以及两张表交集部分数据
*   自连接：当前表与自身的连接查询，自连接必须使用表别名

2.  子查询

*   标量子查询（子查询结果为单个值）
*   列子查询(子查询结果为一列)
*   行子查询(子查询结果为一行)
*   表子查询(子查询结果为多行多列)

#### 1.3 表结构准备

    -- 创建dept表
    create table dept(
        id int auto_increment comment 'ID' primary key,
        name varchar(50) not null comment '部门名称'
    )comment '部门表';
    
    -- 创建emp表
    create table emp(
        id int auto_increment comment 'ID' primary key,
        name varchar(50) not null comment '姓名',
        age int comment '年龄',
        job varchar(20) comment '职位',
        salary int comment '薪资',
        entrydate date comment '入职时间',
        managerid int comment '直属领导ID',
        dept_id int comment '部门ID'
    )comment '员工表';
    
    -- 添加外键
    alter table emp add constraint fk_emp_dept_id foreign key (dept_id) references dept(id);
    

### 2、内连接

内连接查询的是两张表交集部分的数据。

内连接的语法分为两种: **隐式内连接**、**显式内连接**。

**隐式内连接**

    SELECT 字段列表 FROM 表1 , 表2 WHERE 条件 ... ;
    

**显式内连接**

    SELECT 字段列表 FROM 表1 [ INNER ] JOIN 表2 ON 连接条件 ... ;
    
    

**示例**

    
    -- 查询每一个员工的姓名 , 及关联的部门的名称 (隐式内连接实现)
    select emp.name , dept.name from emp , dept where emp.dept_id = dept.id ;
    
    -- 为每一张表起别名,简化SQL编写
    select e.name,d.name from emp e , dept d where e.dept_id = d.id;
    
    -- 查询每一个员工的姓名 , 及关联的部门的名称 (显式内连接实现) 
    select e.name, d.name from emp e inner join dept d on e.dept_id = d.id;
    
    -- 为每一张表起别名,简化SQL编写
    select e.name, d.name from emp e join dept d on e.dept_id = d.id;
    
    

**表的别名:**

*   tablea as 别名1 , tableb as 别名2 ;
*   tablea 别名1 , tableb 别名2 ;

**注意事项:**  
一旦为表起了别名，就不能再使用表名来指定对应的字段了，此时只能够使用别名来指定字段。

### 3、外连接

外连接分为两种，分别是：左外连接 和 右外连接。

#### 3.1 语法

**左外连接**

    SELECT 字段列表 FROM 表1 LEFT [ OUTER ] JOIN 表2 ON 条件 ... ;
    

左外连接相当于查询表1(**左表**)的所有数据，当然也包含表1和表2**交集**部分的数据。

**右外连接**

    SELECT 字段列表 FROM 表1 RIGHT [ OUTER ] JOIN 表2 ON 条件 ... ;
    

右外连接相当于查询表2(**右表**)的所有数据，当然也包含表1和表2**交集**部分的数据。

#### 3.2 示例

    
    --  查询emp表的所有数据, 和对应的部门信息
    select e.*, d.name from emp e left outer join dept d on e.dept_id = d.id;
    
    select e.*, d.name from emp e left join dept d on e.dept_id = d.id;
    
    -- 查询dept表的所有数据, 和对应的员工信息(右外连接)
    select d.*, e.* from emp e right outer join dept d on e.dept_id = d.id;
    select d.*, e.* from dept d left outer join emp e on e.dept_id = d.id;
    
    

左外连接和右外连接是可以**相互替换**的，只需要调整在连接查询时SQL中，表结构的先后顺序就可以了。而我们在日常开发使用时，更偏向于**左**外连接。

### 4、自连接

自连接查询，顾名思义，就是自己连接自己，也就是把一张表连接查询多次。而对于自连接查询，可以是内连接查询，也可以是外连接查询。

#### 4.1 语法

    SELECT 字段列表 FROM 表A 别名A JOIN 表A 别名B ON 条件 ... ;
    

#### 4.2 示例

    
    -- 查询员工 及其 所属领导的名字
    select a.name , b.name from emp a , emp b where a.managerid = b.id;
    
    -- 查询所有员工 emp 及其领导的名字 emp , 如果员工没有领导, 也需要查询出来
    select a.name '员工', b.name '领导' from emp a left join emp b on a.managerid = b.id;
    

**注意：**在自连接查询中，必须要为表起别名，要不然我们不清楚所指定的条件、返回的字段，到底是哪一张表的字段。

### 5、联合查询

对于union查询，就是把多次查询的结果合并起来，形成一个新的查询结果集。

#### 5.1 语法

    SELECT 字段列表 FROM 表A ...
    UNION [ ALL ]
    SELECT 字段列表 FROM 表B ....;
    

*   对于联合查询的多张表的**列数必须保持一致**，**字段类型**也需要保持一致。
*   union all 会将全部的数据直接合并在一起，union 会对合并之后的数据**去重**。

#### 5.2 示例

    
    -- 将薪资低于 5000 的员工 , 和 年龄大于 50 岁的员工全部查询出来.
    select * from emp where salary < 5000
    union all
    select * from emp where age > 50;
    

**注意：**如果多条查询语句查询出来的结果，字段数量不一致，在进行union/union all联合查询时，将会报错。

### 6、子查询

SQL语句中嵌套SELECT语句，称为嵌套查询，又称子查询。

#### 6.1 语法

    SELECT * FROM t1 WHERE column1 = ( SELECT column1 FROM t2 );
    
    

子查询外部的语句可以是INSERT / UPDATE / DELETE / SELECT 的任何一个。

#### 6.2 分类

根据子**查询结果**不同，分为：

1.  标量子查询（子查询结果为单个值）
2.  列子查询(子查询结果为一列)
3.  行子查询(子查询结果为一行)
4.  表子查询(子查询结果为多行多列)

根据子**查询位置**，分为：

1.  WHERE之后
2.  FROM之后
3.  SELECT之后

#### 6.3 标量子查询

子查询返回的结果是单个值（数字、字符串、日期等），最简单的形式，这种子查询称为标量子查询。  
常用的操作符：= <> > >= < <=

**示例**

    --  查询 "销售部" 的所有员工信息
     select * from emp where dept_id = (select id from dept where name = '销售部');
    
    -- 查询在 "方东白" 入职之后的员工信息
    select * from emp where entrydate > (select entrydate from emp where name = '方东
    白')；
    

#### 6.4 列子查询

子查询返回的结果是一列（可以是多行），这种子查询称为列子查询。  
常用的操作符：IN 、NOT IN 、 ANY 、SOME 、 ALL

**示例**

    -- 查询 "销售部" 和 "市场部" 的所有员工信息
    select * from emp where dept_id in (select id from dept where name = '销售部' or
    name = '市场部');
    
    -- 查询比 财务部 所有人工资都高的员工信息
    select * from emp where salary > all ( select salary from emp where dept_id =
    (select id from dept where name = '财务部') );
    
    -- 查询比研发部其中任意一人工资高的员工信息
    select * from emp where salary > any ( select salary from emp where dept_id = (select id from dept where name = '研发部') );
    
    

#### 6.5 行子查询

子查询返回的结果是一行（可以是多列），这种子查询称为行子查询。  
常用的操作符：= 、<> 、IN 、NOT IN

**示例**

    -- 查询与 "张无忌" 的薪资及直属领导相同的员工信息 ;
    select * from emp where (salary,managerid) = (select salary, managerid from emp where name = '张无忌');
    
    

#### 6.6 表子查询

子查询返回的结果是多行多列，这种子查询称为表子查询。  
常用的操作符：IN

**示例**

    
    -- 查询与 "鹿杖客" , "宋远桥" 的职位和薪资相同的员工信息
    select * from emp where (job,salary) in ( select job, salary from emp where name =
    '鹿杖客' or name = '宋远桥' );
    
    -- 查询入职日期是 "2006-01-01" 之后的员工信息 , 及其部门信息
    select e.*, d.* from (select * from emp where entrydate > '2006-01-01') e left join dept d on e.dept_id = d.id ;
    
    

### 7、综合练习

#### 7.1 表结构准备

新增薪资等级表

    create table salgrade(
        grade int,
        losal int,
        hisal int
    ) comment '薪资等级表';
    

#### 7.2 示例

    
    -- 查询员工的姓名、年龄、职位、部门信息 （隐式内连接）
    -- 连接条件: emp.dept_id = dept.id
    select e.name , e.age , e.job , d.name from emp e , dept d where e.dept_id = d.id;
    
    -- 查询年龄小于30岁的员工的姓名、年龄、职位、部门信息（显式内连接）
    -- 连接条件: emp.dept_id = dept.id
    select e.name , e.age , e.job , d.name from emp e inner join dept d on e.dept_id = d.id where e.age < 30;
    
    -- 查询拥有员工的部门ID、部门名称
    -- 连接条件: emp.dept_id = dept.id
    select distinct d.id , d.name from emp e , dept d where e.dept_id = d.id;
    
    -- 查询所有年龄大于40岁的员工, 及其归属的部门名称; 如果员工没有分配部门, 也需要展示出来(外连接)
    -- 连接条件: emp.dept_id = dept.id
    select e.*, d.name from emp e left join dept d on e.dept_id = d.id where e.age > 40 ;
    
    -- 查询所有员工的工资等级
    -- 连接条件 : emp.salary >= salgrade.losal and emp.salary <= salgrade.hisal
    
    -- 方式一
    select e.* , s.grade , s.losal, s.hisal from emp e , salgrade s where e.salary >=
    s.losal and e.salary <= s.hisal;
    -- 方式二
    select e.* , s.grade , s.losal, s.hisal from emp e , salgrade s where e.salary
    between s.losal and s.hisal;
    
    -- 查询 "研发部" 所有员工的信息及 工资等级
    -- 连接条件 : emp.salary between salgrade.losal and salgrade.hisal , emp.dept_id = dept.id
    select e.* , s.grade from emp e , dept d , salgrade s where e.dept_id = d.id and (e.salary between s.losal and s.hisal ) and d.name = '研发部';
    
    -- 查询 "研发部" 员工的平均工资
    -- 连接条件 : emp.dept_id = dept.id
    select avg(e.salary) from emp e, dept d where e.dept_id = d.id and d.name = '研发部';
    
    -- 查询工资比 "灭绝" 高的员工信息。
    select * from emp where salary > ( select salary from emp where name = '灭绝' );
    
    -- 查询比平均薪资高的员工信息
    select * from emp where salary > ( select avg(salary) from emp );
    
    -- 查询低于本部门平均工资的员工信息
    select * from emp e2 where e2.salary < ( select avg(e1.salary) from emp e1 where e1.dept_id = e2.dept_id );
    
    -- 查询所有的部门信息, 并统计部门的员工人数
    select d.id, d.name , ( select count(*) from emp e where e.dept_id = d.id ) '人数' from dept d;
    
    -- 查询所有学生的选课情况, 展示出学生名称, 学号, 课程名称
    -- 连接条件: student.id = student_course.studentid , course.id = student_course.courseid
    select s.name , s.no , c.name from student s , student_course sc , course c where s.id = sc.studentid and sc.courseid = c.id ;