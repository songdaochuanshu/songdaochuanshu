---
layout: post
title: 'è®°å½•ä¸€æ¬¡bugï¼šä¸å¯è§å­—ç¬¦/é›¶å®½å­—ç¬¦'
date: "2026-02-11T01:06:47Z"
---
è®°å½•ä¸€æ¬¡bugï¼šä¸å¯è§å­—ç¬¦/é›¶å®½å­—ç¬¦
==================

### 1\. ç°è±¡

åœ¨å¤„ç† CSV æ–‡ä»¶å¯¼å…¥æ—¶ï¼Œä½ å¯èƒ½é‡åˆ°è¿‡è¿™ç§â€œçµå¼‚äº‹ä»¶â€ï¼š

*   CSV æ–‡ä»¶ç¬¬ä¸€åˆ—å« `tag_id`ã€‚
*   ç¨‹åºç”¨ `encoding/csv` è¯»è¿› Map åï¼Œå°è¯•ç”¨ `mp["tag_id"]` å–å€¼ã€‚
*   ç»“æœï¼š æ°¸è¿œè¿”å›ç©ºå€¼ï¼Œä½†æ‰“å°æ•´ä¸ª Map æ—¶ï¼Œè‚‰çœ¼çœ‹ Key ç¡®å®æ˜¯ `tag_id`ã€‚
*   è€Œè¿™å…¶å®æ˜¯ä½ é‡åˆ°äº†**é›¶å®½å­—ç¬¦**ï¼š ã€ZWNBSPã€‘ã€‚

ç‚¹å‡»æŸ¥çœ‹ä»£ç 

    package main
    
    import (
    	"bytes"
    	"encoding/csv"
    	"fmt"
    	"strings"
    	"unicode"
    )
    
    /*
      [æ¨¡æ‹Ÿ CSV è¡¨æ ¼ç»“æ„]
      æ–‡ä»¶ç¼–ç : UTF-8 with BOM (å­—èŠ‚æµå¼€å¤´åŒ…å« \xef\xbb\xbf)
    
      |  åˆ—å (Header)   |  æ•°æ® (Row 1)  |
      |-----------------|---------------|
      | [ZWNBSP]tag_id  |      1        |
      |      name       |    Popular    |
    
      æ³¨ï¼š[ZWNBSP] åœ¨ç¼–è¾‘å™¨å’Œ Excel ä¸­å®Œå…¨ä¸å¯è§ï¼Œä½†åœ¨å†…å­˜ä¸­å  3 ä¸ªå­—èŠ‚ã€‚
    */
    
    func main() {
    	// 1. æ¨¡æ‹Ÿ CSV å†…å®¹ï¼šæ‰‹åŠ¨åœ¨å¼€å¤´åŠ å…¥ UTF-8 BOM (\xef\xbb\xbf)
    	content := "\xef\xbb\xbf" + "tag_id,name\n1,Gemini"
    
    	// 2. è§£æ CSV
    	reader := csv.NewReader(bytes.NewBufferString(content))
    	records, _ := reader.ReadAll()
    
    	// 3. æ„å»º Map
    	header := records[0]
    	row := records[1]
    	mp := make(map[string]string)
    	for i, colName := range header {
    		mp[colName] = row[i]
    	}
    
    	// 4. å°è¯•é€šè¿‡æ ‡å‡†å­—ç¬¦ä¸² Key è¯»å–
    	targetKey := "tag_id"
    	val, exists := mp[targetKey]
    
    	/*
    	   [é¢„è®¡æ‰“å°ç»“æœ]
    
    	   --- ç»“æœæ¼”ç¤º ---
    	   ç›´æ¥æ‰“å° Map: map[tag_id:1 name:Gemini]  <-- è‚‰çœ¼çœ‹å®Œå…¨æ­£å¸¸
    	   å°è¯•è¯»å– Key [tag_id]: æˆåŠŸ? false, å€¼:     <-- å®é™…ä¸Šæ‰¾ä¸åˆ°ï¼Œå› ä¸ºå¤šå‡ºæ¥çš„ 3 å­—èŠ‚åœ¨ä½œç¥Ÿ
    
    	   --- çœŸç›¸æ­ç§˜ (åå…­è¿›åˆ¶å¯¹æ¯”) ---
    	   Map é‡Œçš„ Key (Hex): efbbbf7461675f6964  <-- å‰é¢å¤šå‡ºäº† efbbbf (ZWNBSP)
    	   ä»£ç é‡Œçš„ Key (Hex): 7461675f6964        <-- çº¯å‡€çš„ tag_id
    	*/
    
    	fmt.Println("--- ç»“æœæ¼”ç¤º ---")
    	fmt.Printf("ç›´æ¥æ‰“å° Map: %v\n", mp)
    	fmt.Printf("å°è¯•è¯»å– Key [%s]: æˆåŠŸ? %v, å€¼: %s\n", targetKey, exists, val)
    
    	fmt.Println("\n--- çœŸç›¸æ­ç§˜ (åå…­è¿›åˆ¶å¯¹æ¯”) ---")
    	for k := range mp {
    		if strings.Contains(k, "tag_id") {
    			fmt.Printf("Map é‡Œçš„ Key (Hex): %x\n", k)
    			fmt.Printf("ä»£ç é‡Œçš„ Key (Hex): %x\n", targetKey)
    		}
    	}
    
    	// 5. ä½¿ç”¨æ¸…æ´—å‡½æ•°ä¿®å¤
    	fmt.Println("\n--- ä¿®å¤åå°è¯• ---")
    	cleanMp := make(map[string]string)
    	for i, colName := range header {
    		cleanMp[CleanString(colName)] = row[i]
    	}
    	_, existsNow := cleanMp[targetKey]
    	fmt.Printf("æ¸…æ´—åè¯»å– Key [%s]: æˆåŠŸ? %v\n", targetKey, existsNow)
    }
    
    // CleanString æ˜¯å¤„ç† CSV åˆ—åçš„â€œå¼ºåŠ›å»æ±¡å‰‚â€
    func CleanString(s string) string {
    	// ç§»é™¤ BOM å‰ç¼€å¹¶å‰”é™¤æ‰€æœ‰ä¸å¯è§å­—ç¬¦
    	return strings.Map(func(r rune) rune {
    		if unicode.IsGraphic(r) {
    			return r
    		}
    		return -1
    	}, strings.TrimPrefix(s, "\xef\xbb\xbf"))
    }

é›¶å®½å­—ç¬¦ = çœ‹ä¸è§çš„å­—ç¬¦,ä½†å®ƒçœŸçš„åœ¨æ–‡æœ¬é‡Œã€‚

### 2\. åˆ†æ

#### **ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§å­—ç¬¦ï¼Ÿ**

è¿™ç±»é—®é¢˜é€šå¸¸ç”± **BOM (Byte Order Mark)** å¼•èµ·ã€‚

*   **æ¥æºï¼š** å½“ä½ ä½¿ç”¨ Windows Excel å¦å­˜ä¸º UTF-8 æ ¼å¼æ—¶ï¼Œæˆ–é£ä¹¦è¡¨æ ¼ä¿å­˜ä¸ºcsvæ–‡ä»¶æ—¶ï¼ŒExcel ä¼šåœ¨æ–‡ä»¶æœ€å¼€å¤´è‡ªåŠ¨æ·»åŠ  `0xEF 0xBB 0xBF` ä¸‰ä¸ªå­—èŠ‚ã€‚
    
*   **æœ¬è´¨ï¼š** åœ¨ Unicode ä¸­ï¼Œè¿™è¢«ç§°ä¸º **ZWNBSP**ï¼ˆZero Width No-Break Spaceï¼Œé›¶å®½ä¸æ¢è¡Œç©ºæ ¼ï¼Œ`U+FEFF`ï¼‰ã€‚å®ƒçš„è®¾è®¡åˆè¡·æ˜¯æ ‡è®°å­—èŠ‚åºï¼Œä½†åœ¨ç°ä»£ UTF-8 ç¯å¢ƒä¸‹ï¼Œå®ƒå¾€å¾€å˜æˆäº†â€œæ•°æ®æ‚è´¨â€ã€‚
    

#### **ä¸ºä»€ä¹ˆ Go æ— æ³•åŒ¹é…ï¼Ÿ**

Go çš„ `map[string]string` æŸ¥æ‰¾æ˜¯åŸºäº**å­—èŠ‚æµ**çš„ç²¾ç¡®åŒ¹é…ã€‚

*   **é¢„æœŸ Keyï¼š** `[116 97 103 95 105 100]` (å³ `tag_id`)
    
*   **å®é™…çš„ Keyï¼š** `[239 187 191 116 97 103 95 105 100]` (å³ `\ufefftag_id`)
    

å¸¸è§çš„é›¶å®½å­—ç¬¦ï¼š

**åç§°**

**Unicode**

**ä½œç”¨è¯´æ˜**

**å¯¹ç¨‹åºçš„å¹²æ‰°**

**é›¶å®½æ— æ–­è¡Œç©ºæ ¼ (ZWNBSP/BOM)**

`\uFEFF`

é˜²æ­¢è‡ªåŠ¨æ¢è¡Œï¼›åœ¨æ–‡ä»¶å¤´ä½œä¸º BOM æ ‡è®°ç¼–ç 

**æœ€å¸¸è§**ã€‚å¯¼è‡´ CSV é¦–åˆ— Key æ— æ³•è¯»å–ã€‚

**é›¶å®½ç©ºæ ¼ (ZWSP)**

`\u200B`

ç”¨äºåˆ†éš”é•¿å•è¯ä»¥ä¾¿åœ¨å¿…è¦æ—¶æ¢è¡Œ

æ’å…¥åœ¨å­—ç¬¦ä¸²ä¸­é—´ï¼Œå¯¼è‡´ `len()` é•¿åº¦å¢åŠ ã€‚

**é›¶å®½è¿æ¥ç¬¦ (ZWJ)**

`\u200D`

ç”¨äºç»„åˆå¤šä¸ª Emojiï¼ˆå¦‚ ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ï¼‰æˆ–å¤æ‚æ–‡å­—

å¼ºè¡Œè¿‡æ»¤ä¼šå¯¼è‡´ç»„åˆ Emoji è¢«æ‹†è§£ã€‚

**é›¶å®½éè¿æ¥ç¬¦ (ZWNJ)**

`\u200C`

æ‰“æ–­å­—ç¬¦è¿å†™ï¼ˆå¸¸è§äºé˜¿æ‹‰ä¼¯è¯­ã€å°åº¦æ–‡ï¼‰

æ”¹å˜æ–‡æœ¬çš„äºŒè¿›åˆ¶è¡¨ç¤ºã€‚

**å·¦å³æ–‡å­—æ–¹å‘ç¬¦ (LRM/RLM)**

`\u200E` / `\u200F`

æ··åˆæ’ç‰ˆæ—¶æ§åˆ¶æ–‡å­—ä»å·¦å¾€å³æˆ–ä»å³å¾€å·¦

å¯¼è‡´å­—ç¬¦ä¸²æ¯”è¾ƒé€»è¾‘å¤±æ•ˆã€‚

* * *

### 3\. è§£å†³

    package main
    
    import (
    	"regexp"
    )
    
    // ç”¨æ­£åˆ™åŒ¹é…å¸¸è§çš„é›¶å®½å­—ç¬¦åŒºé—´
    var reZeroWidth = regexp.MustCompile(`[\u200B-\u200D\uFEFF\u200E\u200F]`)
    
    func SafeClean(s string) string {
    	return reZeroWidth.ReplaceAllString(strings.TrimSpace(s), "")
    }
    

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[æ±Ÿæ°´ä¸ºç«­](https://www.cnblogs.com/Az1r/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/Az1r/p/19600679](https://www.cnblogs.com/Az1r/p/19600679)