---
layout: post
title: 'Dynamicâ€‘SQL2 æŸ¥è¯¢ç¯‡ï¼šMyBatis å¢å¼ºåˆ©å™¨ï¼Œè®© SQL åƒå†™ Java ä¸€æ ·ä¸æ»‘'
date: "2026-01-22T00:46:24Z"
---
Dynamicâ€‘SQL2 æŸ¥è¯¢ç¯‡ï¼šMyBatis å¢å¼ºåˆ©å™¨ï¼Œè®© SQL åƒå†™ Java ä¸€æ ·ä¸æ»‘
================================================

Dynamicâ€‘SQL2 æŸ¥è¯¢ç¯‡ï¼šMyBatis å¢å¼ºåˆ©å™¨ï¼Œè®© SQL åƒå†™ Java ä¸€æ ·ä¸æ»‘
================================================

> **dynamicâ€‘sql2 çš„æŸ¥è¯¢èƒ½åŠ›è®¾è®¡ç›®æ ‡ï¼š** å†™ SQL è¦åƒå†™ Java ä¸€æ ·è‡ªç„¶ï¼›å¤æ‚æŸ¥è¯¢è¦åƒæ­ç§¯æœ¨ä¸€æ ·ç»„åˆï¼›ç»“æœæ˜ å°„è¦åƒæ“ä½œé›†åˆä¸€æ ·é¡ºæ»‘ã€‚

æœ¬ç¯‡ç®€è¿°äº†ï¼š

*   åŸºç¡€æŸ¥è¯¢
*   ç»“æœæ˜ å°„
*   åˆ†ç»„ / Map / åˆ†é¡µ
*   Join / å­æŸ¥è¯¢ / JSON è¡¨
*   åŠ¨æ€åˆ—å¼•ç”¨
*   æ’åºä¸ SQL æ³¨å…¥é˜²å¾¡
*   å¿½ç•¥åˆ—
*   å‡½æ•°æŸ¥è¯¢
*   æ­£åˆ™åŒ¹é…æ¡ä»¶
*   **åŠ¨æ€åº“è¡¨åç§°ï¼ˆschema/tableï¼‰æœºåˆ¶**
*   **åˆ†é¡µä½“ç³»ï¼ˆdynamicâ€‘sql2 / MyBatis / é€»è¾‘åˆ†é¡µï¼‰**

å¼•å…¥ä¾èµ–
====

> æˆªæ­¢è‡³`2026-01-21`ï¼Œæœ€æ–°ç‰ˆæ˜¯`0.1.8`ï¼Œé¡¹ç›®åœ°å€ï¼š[https://github.com/pengweizhong/dynamic-sql2](https://github.com/pengweizhong/dynamic-sql2)

            <!-- Spring2.x -->
            <dependency>
                <groupId>com.dynamic-sql</groupId>
                <artifactId>dynamic-sql2-spring-boot-starter</artifactId>
                <version>0.1.8</version>
            </dependency>
            <!-- Spring3.x -->
            <dependency>
                <groupId>com.dynamic-sql</groupId>
                <artifactId>dynamic-sql2-spring-boot3-starter</artifactId>
                <version>0.1.8</version>
            </dependency>
    

åœ¨`repository`å±‚æ³¨å…¥`SqlContext` å¢åˆ æ”¹æŸ¥éƒ½å’Œæ­¤å¯¹è±¡äº¤äº’ï¼š

        @Resource
        private SqlContext sqlContext;
    

1\. åŸºç¡€æŸ¥è¯¢ä¸ç»“æœæ˜ å°„
=============

1.1 æŸ¥è¯¢åˆ—è¡¨
--------

    List<Product> list = sqlContext.select()
            .allColumn()
            .from(Product.class)
            .fetch()
            .toList();
    

1.2 æŸ¥è¯¢å•åˆ—ï¼ˆæ ‡é‡ï¼‰
------------

    LocalDate one = sqlContext.select()
            .column(Product::getCreatedAt)
            .from(Product.class)
            .limit(1)
            .fetch(LocalDate.class)
            .toOne();
    

1.3 æŸ¥è¯¢å•æ¡è®°å½•
----------

    Product product = sqlContext.select()
            .allColumn()
            .from(Product.class)
            .where(c -> c.andEqualTo(Product::getProductId, 7))
            .fetch()
            .toOne();
    

æˆ–ä½¿ç”¨ä¸»é”®å¿«æ·æ–¹å¼ï¼š

    Product product2 = sqlContext.selectByPrimaryKey(Product.class, 7);
    

2\. toList / toOne / toMap / toGroupingBy
=========================================

2.1 åˆ†ç»„ toGroupingBy
-------------------

    Map<Integer, HashSet<String>> groupingBy = sqlContext.select()
            .distinct()
            .allColumn()
            .from(User.class)
            .fetch()
            .toGroupingBy(
                    User::getUserId,
                    user -> user.getName() + "_hello",
                    HashSet::new,
                    ConcurrentHashMap::new
            );
    

2.2 åˆ†ç»„ï¼ˆå¸¦ DTOï¼‰
-------------

    LinkedHashMap<String, HashSet<Integer>> groupingBy = sqlContext.select()
            .allColumn()
            .from(User.class)
            .limit(10)
            .fetch(User.class)
            .toGroupingBy(
                    User::getName,
                    User::getUserId,
                    HashSet::new,
                    LinkedHashMap::new
            );
    

2.3 toMapï¼ˆå«é‡å¤ key å¤„ç†ï¼‰
---------------------

    Map<Integer, String> map = sqlContext.select()
            .distinct()
            .allColumn()
            .from(User.class)
            .fetch()
            .toMap(
                    user -> 123,
                    user -> user.getName() + "_hello"
            );
    

é‡å¤ key ä¼šæŠ›å¼‚å¸¸ï¼Œå¯è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥ï¼š

    .toMap(
        ProductView::getProductName,
        v -> v,
        (v1, v2) -> v1
    );
    

3\. Join / å­æŸ¥è¯¢ / JSON è¡¨
=======================

3.1 å¤šçº§ join + åˆ«å ï¼ˆè‡ªå…³è”ï¼‰
----------------------

    List<Map<String, Object>> list = sqlContext.select()
            .column("d1", DepartmentEntity::getId, "l5Id")
            .column("d2", DepartmentEntity::getId, "l4Id")
            .column("d3", DepartmentEntity::getId, "l3Id")
            .column("d4", DepartmentEntity::getId, "l2Id")
            .column("d5", DepartmentEntity::getId, "l1Id")
            .from(DepartmentEntity.class, "d1")
            .leftJoin(DepartmentEntity.class, "d2", c -> c.andEqualTo(new Column("d1","id"), new Column("d2","parent_id")))
            .leftJoin(DepartmentEntity.class, "d3", c -> c.andEqualTo(new Column("d2","id"), new Column("d3","parent_id")))
            .leftJoin(DepartmentEntity.class, "d4", c -> c.andEqualTo(new Column("d3","id"), new Column("d4","parent_id")))
            .leftJoin(DepartmentEntity.class, "d5", c -> c.andEqualTo(new Column("d4","id"), new Column("d5","parent_id")))
            .where(c -> c.andIn(DepartmentEntity::getId, Arrays.asList(1,2,3)))
            .fetchOriginalMap()
            .toList();
    

3.2 å­æŸ¥è¯¢ join
------------

    List<Map<String, Object>> list = sqlContext.select()
            .allColumn(Product.class)
            .from(Product.class)
            .innerJoin(
                    select -> select.allColumn(Product.class)
                            .from(Category.class)
                            .join(Product.class, on -> on.andEqualTo(Category::getCategoryId, Product::getCategoryId))
                            .where(c -> c.andLessThanOrEqualTo(Category::getCategoryId, 10)),
                    "t",
                    on -> on.andEqualTo(Product::getProductId, bindAlias("t", Product::getProductId))
            )
            .fetchOriginalMap()
            .toList();
    

3.3 JSON è¡¨å±•å¼€ï¼ˆJsonTableï¼‰
-----------------------

    List<Object> list = sqlContext.select()
            .column("o", Order::getOrderId)
            .column("jt", Product::getProductName)
            .from(Order.class, "o")
            .join(() -> new JsonTable(
                            "o",
                            Order::getOrderDetails,
                            "$.items[*]",
                            JsonColumn.builder()
                                    .column("product_name")
                                    .dataType("VARCHAR(150)")
                                    .jsonPath("$.product")
                                    .build()
                    ),
                    "jt",
                    null
            )
            .fetch()
            .toList();
    

4\. åŠ¨æ€åˆ—å¼•ç”¨ ColumnReference
=========================

    List<Product> list = sqlContext.select()
            .column(Product::getProductId)
            .columnReference(columnReference())
            .from(Product.class)
            .fetch()
            .toList();
    

    AbstractColumnReference columnReference() {
        return ColumnReference.withColumns()
                .column(Product::getProductId)
                .columnReference(columnReference2())
                .column(Product::getProductName);
    }
    

5\. æ’åºä¸ SQL æ³¨å…¥é˜²å¾¡
================

5.1 é“¾å¼æ’åº
--------

    List<User> list = sqlContext.select()
            .allColumn()
            .from(User.class, "u")
            .orderBy(true, sortField, SortOrder.DESC)
            .thenOrderBy(false, User::getUserId)
            .thenOrderBy(true, User::getName)
            .fetch()
            .toList();
    

5.2 ORDER BY æ³¨å…¥æµ‹è¯•
-----------------

    sqlContext.select()
            .allColumn()
            .from(User.class)
            .orderBy("user_id; drop table users; --", SortOrder.DESC)
            .fetch()
            .toList();
    

æ¡†æ¶ä¼šæ‹’ç»éæ³•å­—æ®µåï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…æ³¨å…¥ã€‚

6\. å¿½ç•¥åˆ— ignoreColumn
====================

    List<?> list = sqlContext.select()
            .allColumn()
            .ignoreColumn(TempUserEntity::getName)
            .ignoreColumn(TempDeptEntity::getName)
            .from(TempUserEntity.class)
            .join(TempDeptEntity.class, on -> on.andEqualTo(TempUserEntity::getId, TempDeptEntity::getId))
            .fetch()
            .toList();
    

7\. æ—¥æœŸå‡½æ•° DateFormat / Now
=========================

    YearMonth yearMonth = sqlContext.select()
            .column(new DateFormat(new Now(), "%Y-%m"))
            .from(Dual.class)
            .fetch(YearMonth.class)
            .toOne();
    

8\. æ­£åˆ™åŒ¹é… andMatchesï¼ˆæ‰©å±•ç‚¹ï¼‰
========================

    List<User> list = sqlContext.select()
            .allColumn()
            .from(User.class)
            .where(c -> c.andMatches(User::getEmail, ".*@gmail\\.com"))
            .fetch()
            .toList();
    

9\. åŠ¨æ€åº“è¡¨åç§°ï¼ˆschema/tableï¼‰
========================

`dynamicâ€‘sql2` çš„ `@Table` æ”¯æŒå ä½ç¬¦è§£æï¼Œå¯åŠ¨æ€ï¼š

*   schema
*   table
*   alias
*   dataSourceName

9.1 åŠ¨æ€ schema
-------------

ä»0.1.8èµ·ï¼Œè‡ªå®šä¹‰å€¼åº“è¡¨è§£æå™¨ï¼Œè¿™åœ¨åŒä¸€å®ä¾‹ç›¸ä¼¼ä¸šåŠ¡ä¸‹è·¨åº“æ—¶ä¸åŒçš„å‘½ä»¤åº“è¡¨å‘½åè§„åˆ™æ—¶éå¸¸æœ‰ç”¨ï¼Œä¸ä¼šå½±å“æŸ¥è¯¢é€Ÿåº¦ã€‚

    @Table(schema = "${tenant.schema:user_center}", name = "t_user")
    

é…ç½®ï¼š

    tenant.schema = tenant_001
    

SQLæ•ˆæœç‰‡æ®µï¼š

    FROM tenant_001.t_user
    

9.2 åŠ¨æ€è¡¨åï¼ˆå«é»˜è®¤å€¼ï¼‰
--------------

    @Table(name = "${tenant.table.user:t_user}")
    

9.3 åŠ¨æ€æ•°æ®æºï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
----------------

    @Table(dataSourceName = "ds_user")
    

9.4 å…¨å±€alias
-----------

    @Table(name = "t_user", alias = "u")
    

10\. åˆ†é¡µä½“ç³»ï¼ˆPageHelperï¼‰
=====================

`dynamic-sql2`å†…ç½®äº†åˆ†é¡µæ”¯æŒçš„æŸ¥è¯¢

10.1 dynamicâ€‘sql2 åˆ†é¡µ
--------------------

    PageInfo<List<User>> pageInfo = PageHelper.of(1, 10)
            .selectPage(() -> sqlContext.select()
                    .allColumn()
                    .from(User.class)
                    .fetch()
                    .toList());
    

10.2 MyBatis åˆ†é¡µ
---------------

    PageInfo<List<User>> pageInfo = PageHelper.ofMybatis(1, 10)
            .selectPage(() -> sqlContext.select()
                    .allColumn()
                    .from(User.class)
                    .fetch()
                    .toList());
    

Dynamic-SQL2æ”¯æŒmybatisçš„åˆ†é¡µï¼Œä½†æ˜¯éœ€è¦å¼•å…¥æ‹“å±•åŒ…ï¼š

    <!-- Source: https://mvnrepository.com/artifact/com.dynamic-sql/dynamic-sql2-extension -->
    <dependency>
        <groupId>com.dynamic-sql</groupId>
        <artifactId>dynamic-sql2-extension</artifactId>
        <version>0.1.6</version>
        <scope>compile</scope>
    </dependency>
    

è¯¥æ‹“å±•åŒ…é™¤äº†æ”¯æŒMybatisåˆ†é¡µå¤–ï¼Œå’Œå…¶æ˜ å°„è§„åˆ™ä¹Ÿæ˜¯å®Œå…¨å…¼å®¹ã€‚

10.3 applyWhereï¼ˆå®éªŒæ€§ï¼‰
--------------------

è¯¥åœºæ™¯æœ‰æ—¶ä¼šé‡åˆ°ç±»ä¼¼æƒ…å†µï¼šæœ‰çš„ä¾èµ–jaræœ‰è‡ªå·±ç‹¬ç«‹çš„é€»è¾‘ä½“ç³»ï¼Œä½†æ˜¯åˆæƒ³ä¿®æ”¹å…¶å†…éƒ¨SQLï¼Œåœ¨ä¸æ”¹å˜å†…éƒ¨é€»è¾‘çš„æƒ…å†µä¸‹ï¼Œåœ¨å¤–éƒ¨å°è¯•ä¿®æ”¹SQLè¯­å¥ã€‚ç›®å‰åªæ˜¯å®éªŒé˜¶æ®µï¼Œæœ‰è¶³å¤Ÿçš„åœºæ™¯åœºæ™¯æ”¯æ’‘å’Œæ›´å¤šçš„æµ‹è¯•åï¼Œæ‰ä¼šReleaseè¯¥ç‰¹æ€§ã€‚

    PageInfo<List<User>> pageInfo = PageHelper.of(1, 3)
            .applyWhere(c -> c.andGreaterThanOrEqualTo(User::getAge, 18))
            .selectPage(
        			//å‡è®¾è¿™æ˜¯æ— æ³•ä¿®æ”¹/ä¸å…è®¸æ›´æ”¹çš„å†…éƒ¨SQLï¼Œé€šå¸¸æ˜¯jarçš„å½¢å¼æä¾›
        			() -> sqlContext.select()
                    .allColumn()
                    .from(User.class)
                    .fetch()
                    .toList());
    

10.4 é€»è¾‘åˆ†é¡µï¼ˆé›†åˆå†…å­˜åˆ†é¡µï¼‰
-----------------

    PageInfo<List<Integer>> pageInfo = PageHelper.ofLogic(2, 3)
            .selectPage(Arrays.asList(1,2,3,4,5,6,7));
    

11\. åˆ†é¡µ + åŠ¨æ€åº“è¡¨åç§°ç¤ºä¾‹
==================

    @Table(
        schema = "${tenant.schema:user_center}",
        name = "${tenant.table.user:t_user}",
        alias = "u"
    )
    public class User {}
    

åˆ†é¡µæŸ¥è¯¢ï¼š

    PageInfo<List<User>> pageInfo = PageHelper.of(1, 10)
            .selectPage(() -> sqlContext.select()
                    .allColumn()
                    .from(User.class)
                    .fetch()
                    .toList());
    

æœ€ç»ˆ SQLï¼š

    SELECT u.* 
    FROM tenant_001.user_2025 u 
    LIMIT 10 OFFSET 0
    

æ‹“å±•
==

è‡ªå®šä¹‰å‡½æ•°
-----

å¯¹äº`Dynamic-SQL2`æ²¡æœ‰æä¾›çš„å‡½æ•°ï¼Œå¦‚ä½•è‡ªå®šä¹‰å‘¢ï¼Ÿéå¸¸ç®€å•ï¼Œç»§æ‰¿`ColumnFunctionDecorator`æŠ½è±¡ç±»é‡å†™`getFunctionToString`æ–¹æ³•å³å¯ï¼Œç„¶åä»£ç ä¸­å°±å¯ä»¥å¼•ç”¨äº†ã€‚

æ¯”å¦‚å·²å­˜åœ¨çš„`max`å‡½æ•°ä¸ºä¾‹ï¼š

    /*
     * Copyright (c) 2024 PengWeizhong. All Rights Reserved.
     *
     * This source code is licensed under the MIT License.
     * You may obtain a copy of the License at:
     * https://opensource.org/licenses/MIT
     *
     * See the LICENSE file in the project root for more information.
     */
    package com.dynamic.sql.core.column.function.windows.aggregate;
    
    
    import com.dynamic.sql.core.FieldFn;
    import com.dynamic.sql.core.Version;
    import com.dynamic.sql.core.column.function.AbstractColumFunction;
    import com.dynamic.sql.core.column.function.ColumnFunctionDecorator;
    import com.dynamic.sql.core.column.function.windows.WindowsFunction;
    import com.dynamic.sql.enums.SqlDialect;
    import com.dynamic.sql.utils.ExceptionUtils;
    import com.dynamic.sql.model.TableAliasMapping;
    
    import java.util.Map;
    
    
    public class Max extends ColumnFunctionDecorator implements AggregateFunction, WindowsFunction {
    
        public Max(AbstractColumFunction delegateFunction) {
            super(delegateFunction);
        }
    
        public <T, F> Max(FieldFn<T, F> fn) {
            super(fn);
        }
    
        public <T, F> Max(String tableAlias, FieldFn<T, F> fn) {
            super(tableAlias, fn);
        }
    
        @Override
        public String getFunctionToString(SqlDialect sqlDialect, Version version, Map<String, TableAliasMapping> aliasTableMap) throws UnsupportedOperationException {
            if (sqlDialect == SqlDialect.ORACLE) {
                return "MAX(" + delegateFunction.getFunctionToString(sqlDialect, version, aliasTableMap) + ")".concat(appendArithmeticSql(sqlDialect, version));
            }
            if (sqlDialect == SqlDialect.MYSQL) {
                return "max(" + delegateFunction.getFunctionToString(sqlDialect, version, aliasTableMap) + ")".concat(appendArithmeticSql(sqlDialect, version));
            }
            throw ExceptionUtils.unsupportedFunctionException("max", sqlDialect);
        }
    }
    
    

ä¹‹ååœ¨ä»£ç ä¸­ç›´æ¥å¼•ç”¨è¯¥ç±»ï¼š

        @Test
        void testMax() {
            Integer max = sqlContext.select()
                    .column(new Max(Product::getProductId))
                    .from(Product.class)
                    .fetch(Integer.class)
                    .toOne();
            System.out.println(max);
        }
    

æ‰“å°çš„SQL

    2026-01-21 13:27:03 [main] DEBUG com.dynamic.sql.core.database.SqlDebugger - dataSource -->     Preparing: select max(`p`.`product_id`) as productId from `dynamic_sql2`.`products` as `p`
    2026-01-21 13:27:03 [main] DEBUG com.dynamic.sql.core.database.SqlDebugger - dataSource -->    Parameters: 
    2026-01-21 13:27:03 [main] DEBUG com.dynamic.sql.core.database.SqlDebugger - dataSource <--         Total: 1
    

`AggregateFunction`å’Œ`WindowsFunction`æ ‡è¯†å‡½æ•°çš„åˆ†ç±»ï¼Œå› ä¸ºæœ‰äº›åœºæ™¯ä¸‹å‡½æ•°åµŒå¥—ä½¿ç”¨æ—¶ï¼Œä¼šè¦æ±‚æ˜¯çª—å£å‡½æ•°æˆ–å¿…é¡»æ˜¯å­—ç¬¦ä¸²å‡½æ•°ï¼Œå› æ­¤å£°æ˜ç±»å‹æ›´åŠ ç¬¦åˆå¼€å‘è§„èŒƒï¼Œå¦‚æœè‡ªå®šä¹‰çš„è¯ï¼Œå¯ä»¥ä¸ç”¨å…³å¿ƒå…·ä½“çš„å‡½æ•°åˆ†ç±»ï¼Œç›´æ¥ç»§æ‰¿`ColumnFunctionDecorator`å³å¯ã€‚

ç›®å‰å®šä¹‰çš„å‡½æ•°åˆ†ç±»æ¥å£ï¼š

*   AggregateFunction ï¼š èšåˆå‡½æ•°
*   ScalarFunction ï¼š æ ‡é‡å‡½æ•°

`Max`å‡½æ•°ä¾èµ–çš„å…¨éƒ¨ä½“ç³»å¦‚å›¾æ‰€ç¤ºï¼š

å›½äº§æ•°æ®åº“
-----

å¯¹äºå›½äº§æ•°æ®åº“ï¼Œé€šå¸¸éƒ½ä¼šæ”¯æŒå’Œå…¼å®¹mysqlè¯­æ³•ï¼Œå› æ­¤é€šå¸¸ä¸ç”¨å¤ªæ‹…å¿ƒä¸å…¼å®¹çš„é—®é¢˜ã€‚ä½†æ˜¯`dynamic-sql2`å¯åŠ¨æ—¶ä¼šæ£€æµ‹å—æ”¯æŒçš„æ•°æ®åº“ï¼Œå¯¹äºä¸æ”¯æŒçš„æ•°æ®åº“ä¼šæ”¯æŒæŠ¥é”™ï¼Œåªè¦ä½ ç¡®è®¤å½“å‰æ‰€ä½¿ç”¨çš„æ•°æ®åº“æä¾›å•†å…¼å®¹`Mysql`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®Œå…¨ä½¿ç”¨`dynamic-sql2`ï¼

æ¨èä¸€æ¬¾å¥½ç”¨çš„ IDEA Mybatis æ’ä»¶
-----------------------

æœ€å–œæ¬¢çš„ç‰¹æ€§ä¹‹ä¸€æ˜¯åœ¨æ§åˆ¶å°å¯ä»¥å°†æ‰“å°çš„SQLç›´æ¥åˆå¹¶ä¸ºå¯æ‰§è¡Œçš„SQLè¯­å¥ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ç‰¹åˆ«æœ‰ç”¨ï¼

æ’ä»¶ä¸»é¡µï¼š[https://plugins.jetbrains.com/plugin/9837-mybatiscodehelperpro](https://plugins.jetbrains.com/plugin/9837-mybatiscodehelperpro)

ğŸ‰ å®Œç»“æ’’èŠ±ï¼Œæ¬¢è¿åæ§½ğŸ‰
==============