---
layout: post
title: 'Javaé”è¿™æ ·ç”¨ï¼Œä»å•æœºåˆ°åˆ†å¸ƒå¼ä¸€æ­¥åˆ°ä½'
date: "2025-07-15T00:45:42Z"
---
Javaé”è¿™æ ·ç”¨ï¼Œä»å•æœºåˆ°åˆ†å¸ƒå¼ä¸€æ­¥åˆ°ä½
====================

Javaé”è¿™æ ·ç”¨ï¼Œä»å•æœºåˆ°åˆ†å¸ƒå¼ä¸€æ­¥åˆ°ä½
====================

> å•æœºé”å·²ç»ä¸å¤Ÿç”¨äº†ï¼Ÿåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•ä¿è¯æ•°æ®å®‰å…¨ï¼Ÿä»Šå¤©æˆ‘ä»¬æ¥èŠèŠä»å•æœºé”åˆ°åˆ†å¸ƒå¼é”çš„å®Œæ•´è§£å†³æ–¹æ¡ˆï¼Œæœ€åç”¨ä¸€ä¸ªæ³¨è§£å°±èƒ½æå®šæ‰€æœ‰é”çš„é—®é¢˜ï¼

ä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ
-------

åœ¨å¤šçº¿ç¨‹æˆ–å¤šè¿›ç¨‹ç¯å¢ƒä¸­ï¼Œå¤šä¸ªæ“ä½œåŒæ—¶è®¿é—®åŒä¸€èµ„æºæ—¶å¯èƒ½å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚é”å°±æ˜¯ç”¨æ¥ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ“ä½œèƒ½è®¿é—®å…±äº«èµ„æºã€‚

**é”çš„ä½œç”¨ï¼š**

*   ä¿è¯æ•°æ®ä¸€è‡´æ€§
*   é˜²æ­¢å¹¶å‘å†²çª
*   ç¡®ä¿æ“ä½œçš„åŸå­æ€§

**ç®€å•ç†è§£ï¼š** å°±åƒå•æ‰€é—¨ä¸Šçš„é”ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªäººä½¿ç”¨ï¼Œå…¶ä»–äººå¿…é¡»ç­‰å¾…ã€‚

å•æœºé”çš„å±€é™æ€§
-------

### synchronizedå…³é”®å­—

Javaæœ€ç®€å•çš„é”æœºåˆ¶ã€‚

    public class CounterService {
        private int count = 0;
        
        public synchronized void increment() {
            count++;
        }
        
        public synchronized int getCount() {
            return count;
        }
    }
    

### ReentrantLockå¯é‡å…¥é”

æ›´çµæ´»çš„é”æœºåˆ¶ã€‚

    public class CounterService {
        private int count = 0;
        private final ReentrantLock lock = new ReentrantLock();
        
        public void increment() {
            lock.lock();
            try {
                count++;
            } finally {
                lock.unlock();
            }
        }
    }
    

**å•æœºé”çš„é—®é¢˜ï¼š**

*   åªèƒ½åœ¨å•ä¸ªJVMå†…ç”Ÿæ•ˆ
*   å¤šä¸ªæœåŠ¡å®ä¾‹ä¹‹é—´æ— æ³•äº’æ–¥
*   åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¤±æ•ˆ

åˆ†å¸ƒå¼ç¯å¢ƒçš„æŒ‘æˆ˜
--------

å½“åº”ç”¨éƒ¨ç½²åœ¨å¤šå°æœåŠ¡å™¨ä¸Šæ—¶ï¼Œå•æœºé”å°±ä¸å¤Ÿç”¨äº†ã€‚

![image](https://img2024.cnblogs.com/blog/1826646/202507/1826646-20250714104107580-1340198113.png)

**åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„é—®é¢˜ï¼š**

*   å¤šä¸ªæœåŠ¡å®ä¾‹å¯èƒ½åŒæ—¶æ‰§è¡Œç›¸åŒæ“ä½œ
*   åº“å­˜æ‰£å‡ã€è®¢å•ç”Ÿæˆç­‰åœºæ™¯å®¹æ˜“å‡ºç°æ•°æ®ä¸ä¸€è‡´
*   éœ€è¦è·¨JVMçš„é”æœºåˆ¶

åŸºäºRedisçš„åˆ†å¸ƒå¼é”
------------

### ç®€å•çš„Redisåˆ†å¸ƒå¼é”

ä½¿ç”¨Redisçš„SETå‘½ä»¤å®ç°ã€‚

    @Component
    public class SimpleRedisLock {
        
        @Autowired
        private StringRedisTemplate redisTemplate;
        
        public boolean tryLock(String key, String value, long expireTime) {
            Boolean result = redisTemplate.opsForValue()
                .setIfAbsent(key, value, expireTime, TimeUnit.SECONDS);
            return Boolean.TRUE.equals(result);
        }
        
        public void releaseLock(String key, String value) {
            String script = "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                           "return redis.call('del', KEYS[1]) else return 0 end";
            redisTemplate.execute(new DefaultRedisScript<>(script, Long.class), 
                                Arrays.asList(key), value);
        }
    }
    

### ä½¿ç”¨ç¤ºä¾‹

    @Service
    public class OrderService {
        
        @Autowired
        private SimpleRedisLock redisLock;
        
        public void createOrder(Long userId) {
            String lockKey = "order:user:" + userId;
            String lockValue = UUID.randomUUID().toString();
            
            if (redisLock.tryLock(lockKey, lockValue, 30)) {
                try {
                    // æ‰§è¡Œè®¢å•åˆ›å»ºé€»è¾‘
                    doCreateOrder(userId);
                } finally {
                    redisLock.releaseLock(lockKey, lockValue);
                }
            } else {
                throw new RuntimeException("è·å–é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
            }
        }
        
        private void doCreateOrder(Long userId) {
            // å…·ä½“çš„è®¢å•åˆ›å»ºé€»è¾‘
        }
    }
    

åŸºäºRedissonçš„åˆ†å¸ƒå¼é”
---------------

Redissonæä¾›äº†æ›´å®Œå–„çš„åˆ†å¸ƒå¼é”å®ç°ã€‚

### å¼•å…¥ä¾èµ–

    <dependency>
        <groupId>org.redisson</groupId>
        <artifactId>redisson-spring-boot-starter</artifactId>
        <version>3.20.1</version>
    </dependency>
    

### é…ç½®Redisson

    @Configuration
    public class RedissonConfig {
        
        @Bean
        public RedissonClient redissonClient() {
            Config config = new Config();
            config.useSingleServer()
                  .setAddress("redis://localhost:6379")
                  .setDatabase(0);
            return Redisson.create(config);
        }
    }
    

### ä½¿ç”¨Redissoné”

    @Service
    public class OrderService {
        
        @Autowired
        private RedissonClient redissonClient;
        
        public void createOrder(Long userId) {
            String lockKey = "order:user:" + userId;
            RLock lock = redissonClient.getLock(lockKey);
            
            try {
                if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                    // æ‰§è¡Œè®¢å•åˆ›å»ºé€»è¾‘
                    doCreateOrder(userId);
                } else {
                    throw new RuntimeException("è·å–é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
                }
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("è·å–é”è¢«ä¸­æ–­");
            } finally {
                if (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        }
    }
    

**Redissonçš„ä¼˜åŠ¿ï¼š**

*   è‡ªåŠ¨ç»­æœŸæœºåˆ¶
*   å¯é‡å…¥é”æ”¯æŒ
*   å…¬å¹³é”ã€è¯»å†™é”ç­‰å¤šç§é”ç±»å‹
*   å¼‚å¸¸å¤„ç†æ›´å®Œå–„

æ³¨è§£å¼åˆ†å¸ƒå¼é”å·¥å…·
---------

æ‰‹åŠ¨åŠ é”è§£é”å®¹æ˜“å‡ºé”™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ³¨è§£æ¥ç®€åŒ–ä½¿ç”¨ã€‚

### è‡ªå®šä¹‰é”æ³¨è§£

    @Target(ElementType.METHOD)
    @Retention(RetentionPolicy.RUNTIME)
    public @interface DistributedLock {
        
        String key() default "";
        
        long waitTime() default 10;
        
        long leaseTime() default 30;
        
        TimeUnit timeUnit() default TimeUnit.SECONDS;
        
        String errorMessage() default "è·å–é”å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
    }
    

### AOPåˆ‡é¢å®ç°

    @Aspect
    @Component
    public class DistributedLockAspect {
        
        @Autowired
        private RedissonClient redissonClient;
        
        @Around("@annotation(distributedLock)")
        public Object around(ProceedingJoinPoint joinPoint, DistributedLock distributedLock) throws Throwable {
            String lockKey = generateLockKey(joinPoint, distributedLock.key());
            RLock lock = redissonClient.getLock(lockKey);
            
            try {
                boolean acquired = lock.tryLock(
                    distributedLock.waitTime(), 
                    distributedLock.leaseTime(), 
                    distributedLock.timeUnit()
                );
                
                if (!acquired) {
                    throw new RuntimeException(distributedLock.errorMessage());
                }
                
                return joinPoint.proceed();
                
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("è·å–é”è¢«ä¸­æ–­");
            } finally {
                if (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
        }
        
        private String generateLockKey(ProceedingJoinPoint joinPoint, String key) {
            if (StringUtils.hasText(key)) {
                return parseKey(key, joinPoint);
            }
            
            String className = joinPoint.getTarget().getClass().getSimpleName();
            String methodName = joinPoint.getSignature().getName();
            return className + ":" + methodName;
        }
        
        private String parseKey(String key, ProceedingJoinPoint joinPoint) {
            if (key.contains("#")) {
                // æ”¯æŒSpELè¡¨è¾¾å¼è§£æå‚æ•°
                return parseSpEL(key, joinPoint);
            }
            return key;
        }
        
        private String parseSpEL(String key, ProceedingJoinPoint joinPoint) {
            // SpELè¡¨è¾¾å¼è§£æå®ç°
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨Springçš„SpELè§£æå™¨
            return key.replace("#userId", String.valueOf(joinPoint.getArgs()[0]));
        }
    }
    

### ä½¿ç”¨æ³¨è§£å¼åˆ†å¸ƒå¼é”

    @Service
    public class OrderService {
        
        @DistributedLock(key = "order:user:#userId", waitTime = 5, leaseTime = 30)
        public void createOrder(Long userId) {
            // æ–¹æ³•æ‰§è¡Œæ—¶è‡ªåŠ¨åŠ é”
            doCreateOrder(userId);
            // æ–¹æ³•æ‰§è¡Œå®Œæˆåè‡ªåŠ¨é‡Šæ”¾é”
        }
        
        @DistributedLock(key = "inventory:product:#productId")
        public void decreaseInventory(Long productId, Integer quantity) {
            // åº“å­˜æ‰£å‡é€»è¾‘
            doDecreaseInventory(productId, quantity);
        }
        
        private void doCreateOrder(Long userId) {
            // å…·ä½“çš„è®¢å•åˆ›å»ºé€»è¾‘
        }
        
        private void doDecreaseInventory(Long productId, Integer quantity) {
            // å…·ä½“çš„åº“å­˜æ‰£å‡é€»è¾‘
        }
    }
    

åˆ†å¸ƒå¼é”çš„æ³¨æ„äº‹é¡¹
---------

### 1\. é”è¶…æ—¶æ—¶é—´è®¾ç½®

é”çš„è¶…æ—¶æ—¶é—´è¦æ ¹æ®ä¸šåŠ¡æ‰§è¡Œæ—¶é—´åˆç†è®¾ç½®ã€‚

    // æ ¹æ®ä¸šåŠ¡å¤æ‚åº¦è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
    @DistributedLock(key = "complex:task:#taskId", leaseTime = 60) // å¤æ‚ä»»åŠ¡60ç§’
    public void executeComplexTask(String taskId) {
        // å¤æ‚ä¸šåŠ¡é€»è¾‘
    }
    
    @DistributedLock(key = "simple:task:#taskId", leaseTime = 10) // ç®€å•ä»»åŠ¡10ç§’
    public void executeSimpleTask(String taskId) {
        // ç®€å•ä¸šåŠ¡é€»è¾‘
    }
    

### 2\. é”çš„ç²’åº¦æ§åˆ¶

é”çš„ç²’åº¦è¦åˆé€‚ï¼Œæ—¢è¦ä¿è¯å®‰å…¨æ€§ï¼Œåˆè¦é¿å…æ€§èƒ½é—®é¢˜ã€‚

    // ç»†ç²’åº¦é” - é’ˆå¯¹å…·ä½“ç”¨æˆ·
    @DistributedLock(key = "user:operation:#userId")
    public void userOperation(Long userId) {
        // åªé”å®šç‰¹å®šç”¨æˆ·çš„æ“ä½œ
    }
    
    // ç²—ç²’åº¦é” - å…¨å±€é”ï¼ˆæ…ç”¨ï¼‰
    @DistributedLock(key = "global:operation")
    public void globalOperation() {
        // å…¨å±€æ“ä½œï¼Œä¼šå½±å“æ‰€æœ‰ç”¨æˆ·
    }
    

### 3\. å¼‚å¸¸å¤„ç†

ç¡®ä¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹é”èƒ½æ­£ç¡®é‡Šæ”¾ã€‚

    @DistributedLock(key = "order:#orderId", errorMessage = "è®¢å•æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·å‹¿é‡å¤æ“ä½œ")
    public void processOrder(Long orderId) {
        try {
            // ä¸šåŠ¡é€»è¾‘
            doProcessOrder(orderId);
        } catch (Exception e) {
            // è®°å½•æ—¥å¿—
            log.error("è®¢å•å¤„ç†å¤±è´¥: {}", orderId, e);
            throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿äº‹åŠ¡å›æ»š
        }
        // é”ä¼šåœ¨æ–¹æ³•ç»“æŸæ—¶è‡ªåŠ¨é‡Šæ”¾
    }
    

æ€§èƒ½ä¼˜åŒ–å»ºè®®
------

### 1\. è¿æ¥æ± é…ç½®

    @Configuration
    public class RedissonConfig {
        
        @Bean
        public RedissonClient redissonClient() {
            Config config = new Config();
            config.useSingleServer()
                  .setAddress("redis://localhost:6379")
                  .setConnectionPoolSize(50)    // è¿æ¥æ± å¤§å°
                  .setConnectionMinimumIdleSize(10); // æœ€å°ç©ºé—²è¿æ¥
            return Redisson.create(config);
        }
    }
    

### 2\. é”ç­‰å¾…ç­–ç•¥

    // å¿«é€Ÿå¤±è´¥ç­–ç•¥
    @DistributedLock(key = "quick:#id", waitTime = 0)
    public void quickOperation(String id) {
        // ä¸ç­‰å¾…ï¼Œç«‹å³è¿”å›
    }
    
    // é€‚åº¦ç­‰å¾…ç­–ç•¥
    @DistributedLock(key = "normal:#id", waitTime = 3)
    public void normalOperation(String id) {
        // ç­‰å¾…3ç§’
    }
    

æ€»ç»“
--

Javaé”çš„æ¼”è¿›è¿‡ç¨‹ï¼š

**å•æœºé”ï¼š**

*   synchronizedã€ReentrantLock
*   åªèƒ½åœ¨å•ä¸ªJVMå†…ä½¿ç”¨

**åˆ†å¸ƒå¼é”ï¼š**

*   åŸºäºRediså®ç°
*   æ”¯æŒè·¨JVMåè°ƒ

**æ³¨è§£å¼åˆ†å¸ƒå¼é”ï¼š**

*   ä½¿ç”¨ç®€å•ï¼Œä¸€ä¸ªæ³¨è§£æå®š
*   å‡å°‘é‡å¤ä»£ç ï¼Œé™ä½å‡ºé”™æ¦‚ç‡

**é€‰æ‹©å»ºè®®ï¼š**

*   å•æœºåº”ç”¨ï¼šä½¿ç”¨synchronizedæˆ–ReentrantLock
*   åˆ†å¸ƒå¼åº”ç”¨ï¼šä½¿ç”¨Redissonåˆ†å¸ƒå¼é”
*   è¿½æ±‚ç®€æ´ï¼šä½¿ç”¨æ³¨è§£å¼åˆ†å¸ƒå¼é”

æŒæ¡è¿™å¥—é”çš„å‡çº§æ–¹æ¡ˆï¼Œè®©ä½ çš„åº”ç”¨åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½ä¿è¯æ•°æ®å®‰å…¨ï¼

* * *

**å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ä¸è¦å¿˜è®°ï¼š**

*   ğŸ‘ **ç‚¹èµ**æ”¯æŒä¸€ä¸‹
*   ğŸ”” **å…³æ³¨**æˆ‘ï¼Œè·å–æ›´å¤šJavaæŠ€æœ¯å¹²è´§
*   â­ **æ¨è**ç»™ä½ çš„æœ‹å‹åŒäº‹

> å…³æ³¨å¾®ä¿¡å…¬ä¼—å·ã€åˆ’æ°´çš„ç¨‹åºçŒ¿ã€‘ï¼Œä¸“æ³¨äºJavaæŠ€æœ¯åˆ†äº«ã€‚è®©æˆ‘ä»¬ä¸€èµ·åœ¨æŠ€æœ¯çš„æµ·æ´‹ä¸­æˆé•¿ï¼

![qrcode_for_gh_f4013377461f_258](https://img2024.cnblogs.com/blog/1826646/202507/1826646-20250714104228006-2128695892.jpg)