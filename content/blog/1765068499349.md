---
layout: post
title: 'XNU Inside: iOS 模拟器'
date: "2025-12-07T00:48:19Z"
---
XNU Inside: iOS 模拟器
===================

IOS 模拟器各种目录介绍

1 Simulator.app
===============

`iOS`模拟器`App`位于`XCode`中:

    /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app
    

`Simulator.app`只是定义了模拟器的`UI`。

想要完整的运行模拟器，还需要很多其他组件。

2 CoreSimulator & SimulatorKit
==============================

`CoreSimulator`是一个`Framework`，它位于:

    /Library/Developer/PrivateFrameworks/CoreSimulator.framework/Versions/A/CoreSimulator
    

这个`Framework`会启动一个`XPC`服务:`com.apple.CoreSimulator.CoreSimulatorService`。

这个`XPC`服务统管`Mac`上的所有模拟器。

当创建一个新的模拟器时，就是由这个`XPC`服务创建对应的模拟器设备文件和运行时。

`CoreSimlator.framework`还依赖于`SimulatorKit.framework`:

    /Applications/Xcode.app/Contents/Developer/Library/PrivateFrameworks/SimulatorKit.framework/Versions/A/SimulatorKit
    

3 模拟器设备文件
=========

有了模拟器设备文件，在`XCode`的设备列表中，才会显示出有哪些模拟器可用:

模拟器设备文件定义在:

    /Library/Developer/CoreSimulator/Profiles/DeviceTypes
    

这个目录下的每一个`.simdevicetpye`文件定义了一个模拟器设备。

每一个`.simdevicetype`文件都是一个`bundle`文件。

这个`bundle`文件中最重要的是位于`Resources`文件夹下的`2`个`plist`文件:

`profile.plist`定义了这个模拟器的特征，比如屏幕大小。

`capabilities.plist`定义了这个模拟器支持的功能。

4 模拟器运行时
========

`iOS`模拟器要运行，还需要对应的运行时支持。

运行时文件定义在:

    /Library/Developer/CoreSimulator/Volumes/iOS_23A343/Library/Developer/CoreSimulator/Profiles/Runtimes
    

这个目录下的每一个`.simruntime`文件定义对应模拟器的运行时。

每一个`simruntime`文件是一个`bundle`文件。

这个`bundle`文件中最重要的是位于`Resources`文件夹下的`plist`文件:`profile.plist`。

`profile.plist`里定义这个模拟器支持的`iOS`系统版本，以及依赖的服务。

5 模拟器的启动
========

模拟器由`launchd_sim`启动，它位于模拟器运行时下:

    /Library/Developer/CoreSimulator/Volumes/iOS_23A343/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS\ 26.0.simruntime/Contents/Resources/RuntimeRoot/sbin/launchd_sim
    

`launchd_sim`会依次将模拟器所需要的服务启动起来。

这些依赖的服务都定义在`com.apple.CoreSimulator.bridge.plist`中，它位于:

    /Library/Developer/PrivateFrameworks/CoreSimulator.framework/Versions/A/Resources/Platforms/iphoneos/Library/LaunchDaemons/com.apple.CoreSimulator.bridge.plist
    

模拟器启动完成之后，它的根文件系统挂载在`RuntimeRoot`目录:

    /Library/Developer/CoreSimulator/Volumes/iOS_23A343/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS\ 26.0.simruntime/Contents/Resources/RuntimeRoot
    

它的数据部分挂载如下目录:

    ~/Library/Developer/CoreSimulator/Devices/UUID
    

当在模拟器环境下执行

    po NSHomeDirectory()
    

会得到如下输出:

    po NSHomeDirectory()
    /Users/huchao03/Library/Developer/CoreSimulator/Devices/4115D910-245F-425D-8E82-EAE2E238147A/data/Containers/Data/Application/
    E6BDDBF1-447D-4D37-98F8-E61F48080A48
    

当模拟器需要访问相应的文件系统，`CoreSimulatorBridge`就会拦截这个请求，将其代理到对应目录上。

`CoreSimulatorBridge`位于:

    /Library/Developer/PrivateFrameworks/CoreSimulator.framework/Versions/A/Resources/Platforms/iphoneos/usr/libexec/CoreSimulatorBridge
    

6 dyld\_sim
===========

模拟器运行时，加载链接动态库时，不是使用的`dyld`，而是`dyld_sim`。

`dyld_sim`位于`RuntimeRoot`中:

    /Library/Developer/CoreSimulator/Volumes/iOS_23A343/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS\ 26.0.simruntime/Contents/Resources/RuntimeRoot/usr/lib/dyld_sim
    

7 simctl
========

`simctl`命令行工具可以运行、杀死模拟器。

`simctl`是`XCode`自带的工具，运行是需要使用`xcrun`命令:

    xcrun simctl list
    

`simctl`位于:

    /Applications/Xcode.app/Contents/Developer/usr/bin/simctl