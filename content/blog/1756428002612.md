---
layout: post
title: 'Flutter å·¥ç¨‹æ„æ¶è®¾è®¡ï¼ˆMVVM + Repositoryï¼‰'
date: "2025-08-29T00:40:02Z"
---
Flutter å·¥ç¨‹æ„æ¶è®¾è®¡ï¼ˆMVVM + Repositoryï¼‰
=================================

> è®¤çœŸå¯¹å¾…æ¯æ—¶ã€æ¯åˆ»æ¯ä¸€ä»¶äº‹ï¼ŒæŠŠæ¡å½“ä¸‹ã€ç«‹å³å»åšã€‚

ç§»åŠ¨åº”ç”¨å¼€å‘é¢†åŸŸçš„æŠ€æœ¯æ¼”è¿›æ­£æŒç»­æ¨åŠ¨ç€è·¨å¹³å°è§£å†³æ–¹æ¡ˆçš„åˆ›æ–°ã€‚åœ¨ Android ä¸ iOS ç­‰å¤šå¹³å°å¹¶å­˜çš„ç°çŠ¶ä¸‹ï¼Œä¼ ç»ŸåŸç”Ÿå¼€å‘é¢ä¸´â€Œä»£ç å¤ç”¨ç‡ä½â€Œå’Œâ€Œå¼€å‘æ•ˆç‡ç“¶é¢ˆâ€Œç­‰æ ¸å¿ƒæŒ‘æˆ˜ã€‚Flutter ä½œä¸º Google æ¨å‡ºçš„ç°ä»£åŒ– UI å·¥å…·åŒ…ï¼Œé€šè¿‡â€Œè‡ªç»˜å¼•æ“â€Œå’Œâ€Œå“åº”å¼æ¡†æ¶â€Œå®ç°äº†çœŸæ­£çš„è·¨å¹³å°ä¸€è‡´æ€§ï¼Œå…¶â€Œ"ä¸€æ¬¡ç¼–å†™ï¼Œå¤„å¤„è¿è¡Œ"â€Œçš„ç†å¿µå·²åœ¨å…¨çƒèŒƒå›´å†…å¾—åˆ°éªŒè¯â€”â€”æ ¹æ®å¾€å¹´ Dart å¼€å‘è€…è°ƒç ”ï¼Œé‡‡ç”¨ Flutter çš„ä¼ä¸šé¡¹ç›®å¹³å‡ç¼©çŸ­äº†40%å·¦å³çš„å¼€å‘å‘¨æœŸã€‚æœ¬æ–‡åŸºäº â€Œ**MVVM+Repository** â€Œæ¶æ„æ¨¡å¼ï¼Œç³»ç»Ÿé˜è¿° Flutter åœ¨å·¥ç¨‹åŒ–å®è·µä¸­çš„è§£å†³æ–¹æ¡ˆã€‚

è¿™æ¬¡å…¬å¸åœ¨æ–°é¡¹ç›®æŠ€æœ¯å†æ¬¡é€‰å‹çš„å‰æ™¯ä¸‹ï¼Œè®©æˆ‘å¯¹ Flutter åšä¸€æ¬¡æŠ€æœ¯æ„æ¶åˆ†äº«ã€‚ä¸ºäº†æŠŠ Flutter è¯´æ¸…æ¥šï¼Œå¦‚ä½•å»åšæ¶æ„ä¼ä¸šçº§é¡¹ç›®ï¼Œé¡¹ç›®æ¶æ„ä¸­åº”è¯¥åŒ…å«å“ªäº›æŠ€æœ¯ç‚¹ï¼Œæˆ‘åšäº†ä¸‹é¢ç»“æ„æ€§çš„æŠ€æœ¯æ€»ç»“ï¼Œå‰é¢éƒ¨åˆ†æˆ‘ä¼šé’ˆå¯¹æŠ€æœ¯ã€å·¥å…·é“¾ç”Ÿæ€åšä¸€ä¸ªç³»ç»Ÿè§£æï¼Œæœ€åä¸€éƒ¨åˆ†è¯¦ç»†æ ¹æ®ä¸šåŠ¡ç‚¹æ¥é˜è¿° **MVVM+Repository** â€Œæ¶æ„ã€‚

ç‰¹åˆ«åœ°ï¼Œæœ¬æ–‡æ–¹æ¡ˆèåˆäº†ç¬”è€…åœ¨2022å¹´ä¸»å¯¼å…¬å¸çš„â€Œ**ä¼ä¸šçº§ç§»åŠ¨åº”ç”¨é‡æ„ç»éªŒï¼ˆNative + KMM + React æ¶æ„ï¼‰**â€Œï¼Œå…¶ä¸­å¯¹çŠ¶æ€ç®¡ç†ã€æ¨¡å—åŒ–è§£è€¦ç­‰å…³é”®é—®é¢˜çš„è§£å†³è·¯å¾„ï¼Œå‡åœ¨æœ¬æ¶æ„ä¸­å¾—åˆ°å»¶ç»­ä¸å‡çº§ã€‚é€šè¿‡å®Œæ•´çš„ä»£ç ç¤ºä¾‹ä¸æ¶æ„å›¾è§£è¿›è¡Œè§£æã€‚

å½“ç„¶ï¼Œåœ¨äº’ç›¸å­¦ä¹ è¿‡ç¨‹ä¸­æ¬¢è¿æŒ‡å‡ºå…¶ä¸­çš„ä¸è¶³å’Œæ”¹è¿›æ„è§ï¼Œåç»­æœ‰æ—¶é—´ä¼šå¯¹åŸºç¡€æ¶æ„ä¸€äº›å»¶ç»­çš„ä¸œè¥¿æˆ‘ä¹Ÿä¼šé™†ç»­è¡¥å……è¿›æ¥ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹åŸºç¡€é¡¹ç›®ç»“æ„çš„å®šä¹‰ï¼Œæœ‰ä¸ªå¤§æ¦‚äº†è§£å†å¾€ä¸‹çœ‹ã€‚

    # é¡¹ç›®ç›®å½•ç»“æ„å®šä¹‰
    pubassistant/
    â”œâ”€â”€ android/                                # Android å¹³å°ä»£ç 
    â”œâ”€â”€ ios/                                    # iOS å¹³å°ä»£ç 
    â”œâ”€â”€ assets/                                 # é™æ€èµ„æº
    â”‚   â”œâ”€â”€ images/                             # å›¾ç‰‡èµ„æº
    â”‚   â”œâ”€â”€ fonts/                              # å­—ä½“æ–‡ä»¶
    â”‚   â””â”€â”€ json/                               # æœ¬åœ°JSONæ–‡ä»¶
    â”œâ”€â”€ lib/                                    # Flutter æºä»£ç 
    â”‚   â”œâ”€â”€ generated/                          # èµ„æºç®¡ç†ç”Ÿæˆå™¨
    â”‚   â”‚   â””â”€â”€ assets.dart                     # assets
    â”‚   â”œâ”€â”€ src/
    â”‚   â”‚   â”œâ”€â”€ core/                           # æ ¸å¿ƒå±‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ constants/                  # å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_constants.dart      # åº”ç”¨å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_strings.dart        # å­—ç¬¦ä¸²å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_layouts.dart        # å¸ƒå±€å°ºå¯¸å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ app_colors.dart         # é¢œè‰²å¸¸é‡
    â”‚   â”‚   â”‚   â”œâ”€â”€ di/                         # ä¾èµ–æ³¨å…¥é…ç½®æ ¸å¿ƒæ–‡ä»¶
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ injector.dart           # GetIt
    â”‚   â”‚   â”‚   â”œâ”€â”€ routes/                     # è·¯ç”±é…ç½®
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_pages.dart          # é¡µé¢è·¯ç”±è¡¨
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ app_router.dart         # è·¯ç”±ç”Ÿæˆå™¨
    â”‚   â”‚   â”‚   â”œâ”€â”€ theme/                      # ä¸»é¢˜é…ç½®
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_theme.dart          # ä¸»é¢˜é…ç½®
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ text_styles.dart        # æ–‡æœ¬æ ·å¼è§„èŒƒ
    â”‚   â”‚   â”‚   â”œâ”€â”€ network/                    # ç½‘ç»œå±‚å°è£…
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dio_client.dart         # Dio å®ä¾‹é…ç½®
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ exceptions/             # è‡ªå®šä¹‰å¼‚å¸¸ç±»
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ interceptors/           # æ‹¦æˆªå™¨ï¼ˆæ—¥å¿—ã€Tokenåˆ·æ–°ï¼‰ 
    â”‚   â”‚   â”‚   â”œâ”€â”€ database/                   # æ•°æ®åº“å±‚å°è£…
    â”‚   â”‚   â”‚   â””â”€â”€ utils/                      # å·¥å…·ç±»
    â”‚   â”‚   â”‚       â””â”€â”€ storage_util.dart       # å­˜å‚¨å·¥å…·
    â”‚   â”‚   â”œâ”€â”€ features/                       # ä¸šåŠ¡åŠŸèƒ½æ¨¡å—åˆ’åˆ†å±‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ data/                       # æ•°æ®å±‚ï¼šèšç„¦æ•°æ®è·å–ä¸å­˜å‚¨é€»è¾‘
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models/                     # æ•°æ®æ¨¡å‹
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/               # æ•°æ®ä»“åº“
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ services/                   # æ•°æ®æœåŠ¡ï¼ˆAPIæ¥å£ï¼‰
    â”‚   â”‚   â”‚   â”œâ”€â”€ domain/                     # ä¸šåŠ¡å±‚ï¼šå¤„ç†ä¸šåŠ¡è§„åˆ™ä¸é€»è¾‘æµè½¬ï¼Œå¦‚æ•°æ®éªŒè¯ã€æµç¨‹ç¼–æ’ã€é¢†åŸŸæ¨¡å‹è½¬æ¢
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entities/                   # ä¸šåŠ¡å®ä½“
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ repositories/               # æŠ½è±¡ä»“åº“æ¥å£
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ use_cases/                  # ä¸šåŠ¡é€»è¾‘ç”¨ä¾‹
    â”‚   â”‚   â”‚   â””â”€â”€ presentation/               # è¡¨ç°å±‚
    â”‚   â”‚   â”‚       â”œâ”€â”€ pages/                      # UI é¡µé¢
    â”‚   â”‚   â”‚       â”œâ”€â”€ widgets/                    # æ¨¡å—å†…å¤ç”¨ç»„ä»¶
    â”‚   â”‚   â”‚       â”œâ”€â”€ view_models/                # è§†å›¾æ¨¡å‹
    â”‚   â”‚   â”‚       â”œâ”€â”€ router/                     # æ¨¡å—ç‹¬ç«‹è·¯ç”±
    â”‚   â”‚   â”‚       â””â”€â”€ state/                      # çŠ¶æ€ç®¡ç†
    â”‚   â”‚   â””â”€â”€ config/                         # ç¯å¢ƒé…ç½®
    â”‚   â”‚       â””â”€â”€ app_config.dart
    â”‚   â””â”€â”€ main.dart                           # åº”ç”¨å…¥å£
    â”œâ”€â”€ test/                                   # æµ‹è¯•ç›®å½•
    â”œâ”€â”€ scripts/                                # æ„å»º/éƒ¨ç½²è„šæœ¬
    â”œâ”€â”€ environments/                           # ç¯å¢ƒé…ç½®æ–‡ä»¶
    â”‚   â”œâ”€â”€ dev.env
    â”‚   â”œâ”€â”€ staging.env
    â”‚   â””â”€â”€ prod.env
    â””â”€â”€ pubspec.yaml                            # ä¾èµ–ç®¡ç†
    

ä¸€. ç¯å¢ƒé…ç½®
-------

### 1\. ç¯å¢ƒé…ç½®çš„æ ¸å¿ƒä½œç”¨

*   éš”ç¦»ç¯å¢ƒï¼Œåˆ†ç¦»å¼€å‘/æ¼”ç¤º/ç”Ÿäº§ç¯å¢ƒçš„é…ç½®
*   â€Œ**æ•æ„Ÿä¿¡æ¯ä¿æŠ¤**â€Œï¼šé¿å…ç¡¬ç¼–ç æ•æ„Ÿ URL åˆ°æºç ä¸­
*   â€Œ**åŠ¨æ€åŠ è½½**â€Œï¼šé€šè¿‡æ„å»ºè„šæœ¬è‡ªåŠ¨æ³¨å…¥å¯¹åº”é…ç½®

### 2\. åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ï¼ˆenvironments/ç›®å½•ï¼‰

è¿™é‡Œä¸€èˆ¬é…ç½®ä¸€ä¸ªå¼€å‘ç¯å¢ƒå’Œä¸€ä¸ªç”Ÿäº§ç¯å¢ƒå°±è¡Œäº†ï¼Œç›®å‰æˆ‘ä»¬å…¬å¸æ¶‰åŠåˆ°å¤§é‡å®¢æˆ·æ¼”ç¤ºï¼Œè¿™é‡Œå¢åŠ ä¸€ä¸ªæ¼”ç¤ºç¯å¢ƒï¼Œæ€»çš„æ¥è¯´æŒ‰éœ€é…ç½®ã€‚

    â”œâ”€â”€ environments/                           # ç¯å¢ƒé…ç½®æ–‡ä»¶
    â”‚   â”œâ”€â”€ dev.env
    â”‚   â”œâ”€â”€ staging.env
    â”‚   â””â”€â”€ prod.env
    

dev.env é…ç½®è¯¦æƒ…ç¤ºä¾‹ï¼š

    API_BASE_URL=https://api.dev.example.com
    ENV_NAME=Development
    ENABLE_DEBUG_LOGS=true
    

### 3\. æ·»åŠ  flutter\_dotenv ä¾èµ–

    dependencies:
      flutter_dotenv: ^5.2.1
    

### 4\. åˆ›å»ºé…ç½®åŠ è½½å™¨

é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`lib/src/config/env_loader.dart`

    // åˆ›å»ºé…ç½®åŠ è½½å™¨
    class EnvLoader {
      static Future<void> load() async {
        const env = String.fromEnvironment("ENV", defaultValue: 'dev');
        await dotenv.load(fileName: 'environments/$env.env');
      }
    
      static String get apiBaseUrl => dotenv.get('API_BASE_URL');
      static String get envName => dotenv.get('ENV_NAME');
      static bool get enableDebugLogs => dotenv.get('ENABLE_DEBUG_LOGS') == 'true';
    }
    

### 5\. main.dart ä¸­åˆå§‹åŒ–ç¯å¢ƒ

    void main() async {
      // åˆå§‹åŒ–ç¯å¢ƒé…ç½®
      await EnvLoader.load();
      runApp(const MyApp());
    }
    

### 6\. å¯åŠ¨å’Œæ‰“åŒ…æ—¶æŒ‡å®šç¯å¢ƒ

#### 6.1 è°ƒè¯•å¼€å‘ç¯å¢ƒ

    # 1. å‘½ä»¤å¯åŠ¨å¼€å‘ç¯å¢ƒ
    flutter run --dart-define=ENV=dev
      
    # 2. é…ç½®IDEè¿è¡Œå‚æ•°
    # åœ¨IDEçš„ "Run"->"Edit Configurations" ä¸­ï¼š  
      - æ‰¾åˆ° Flutter è¿è¡Œé…ç½®
      - åœ¨"Additional arguments"æ·»åŠ ï¼š--dart-define=ENV=dev
    

#### 6.2 æ­£å¼ç¯å¢ƒæ‰“åŒ…

Android APKï¼š

    # ç”Ÿäº§ç¯å¢ƒ
    flutter build apk --dart-define=ENV=prod
    # æ¼”ç¤ºç¯å¢ƒ
    flutter build apk --dart-define=ENV=staging
    

iOS IPAï¼š

*   å‘½ä»¤è¡Œæ‰“åŒ…ï¼š
    
        # ç”Ÿäº§ç¯å¢ƒ
        flutter build ipa --dart-define=ENV=prod --release
        # æ¼”ç¤ºç¯å¢ƒ
        flutter build ipa --dart-define=ENV=staging --release
        
    
*   Xcode é…ç½®ï¼š
    
    æ‰“å¼€ ios.Runner.xcworkspaceï¼Œé€‰æ‹© Target Build Settingsï¼Œæ·»åŠ  DART\_DEFINES ç¯å¢ƒå˜é‡ `DART_DEFINES=ENV=prod`ã€‚
    

### 7\. ä½¿ç”¨ç¤ºä¾‹

    Text(EnvLoader.envName) 
    

äºŒ. é™æ€èµ„æºé…ç½®
---------

### 1\. èµ„æºç›®å½•ç»“æ„è®¾è®¡

    â”œâ”€â”€ assets/                                 # é™æ€èµ„æº
    â”‚   â”œâ”€â”€ images/                             # å›¾ç‰‡èµ„æº
    â”‚   â”œâ”€â”€ fonts/                              # å­—ä½“æ–‡ä»¶
    â”‚   â””â”€â”€ json/                               # æœ¬åœ°JSONæ–‡ä»¶
    

### 2\. pubspec.yaml é…ç½®

    flutter:
      assets:
        - assets/images/
        - assets/json/
      fonts:
        - family: Rbt
          fonts:
            - asset: assets/fonts/Rbt-Framework.ttf
    

### 3\. èµ„æºå›¾ç‰‡å¼•ç”¨ç±»ç”Ÿæˆ

è¿™é‡Œæ˜¯è‡ªå®šä¹‰å·¥å…·å®ç°ç¤ºä¾‹ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨é€šè¿‡èµ„æºä»£ç ç”Ÿæˆå·¥å…·å®ç°è‡ªåŠ¨ç”Ÿæˆçš„ `generated/assets.dart` å·¥å…·ç±»å®ç°æ–‡ä»¶ã€‚è¯¥æœºåˆ¶æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å…ƒç¼–ç¨‹æ‰‹æ®µï¼Œå°†æ–‡ä»¶ç³»ç»Ÿçš„èµ„æºç»„ç»‡ç»“æ„è½¬åŒ–ä¸ºç±»å‹å®‰å…¨çš„ç¼–ç¨‹æ¥å£ï¼Œå±äº Flutter ç°ä»£åŒ–å¼€å‘å·¥å…·é“¾çš„å…¸å‹å®è·µï¼Œåé¢ä¼šå…·ä½“ä»‹ç»ã€‚

    // lib/src/core/constants/assets_constants.dart
    class AppAssets {
      static const String framework = 'assets/images/framework/home_head_image.jpg';
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    Image.asset(AppAssets.framework)
    

### 4\. å­—ä½“èµ„æºä½¿ç”¨

å…¨å±€åº”ç”¨ï¼š

    MaterialApp(
      theme: ThemeData(
        fontFamily: 'Rbt',  // ä½¿ç”¨å£°æ˜çš„å­—ä½“å®¶æ—å
      ),
    );
    

å±€éƒ¨åº”ç”¨ï¼š

    Text(
      'è‡ªå®šä¹‰å­—ä½“',
      style: TextStyle(
        fontFamily: 'Rbt',
        fontWeight: FontWeight.bold,  // åŒ¹é…é…ç½®çš„å­—é‡
      ),
    );
    

### 5\. json æ–‡ä»¶ä½¿ç”¨

æ¨èä½¿ç”¨ json\_serializableã€json\_annotationã€build\_runner åº“ï¼Œè¿›è¡Œä¸€ä¸ªé€šç”¨çš„å°è£…ï¼Œè¿™éƒ¨åˆ†ä¼šåœ¨åç»­æ¡†æ¶é¡¹ç›®ä¸­è¿›è¡Œå¼€æºï¼Œæ¬¢è¿ starã€‚

ä¸‰. èµ„æºç®¡ç†ç”Ÿæˆå™¨
----------

åœ¨ Flutter é¡¹ç›®ä¸­ï¼Œ`generated/assets.dart` æ˜¯ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼Œä¸»è¦ç”¨äºâ€Œ**èµ„æºç®¡ç†çš„ä»£ç åŒ–**â€Œå’Œâ€Œ**å¼€å‘æ•ˆç‡ä¼˜åŒ–**â€Œã€‚ä»¥ä¸‹æ˜¯å…¶æ ¸å¿ƒä½œç”¨ä¸ç”Ÿæˆé€»è¾‘ï¼š

### 1\. æ ¸å¿ƒä½œç”¨

1ï¼‰**èµ„æºè·¯å¾„çš„é™æ€åŒ–è®¿é—®**â€Œ

å°† `assets` ç›®å½•ä¸‹çš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€å­—ä½“ï¼‰è½¬æ¢ä¸º Dart å¸¸é‡ï¼Œé¿å…æ‰‹åŠ¨è¾“å…¥è·¯å¾„å­—ç¬¦ä¸²ï¼Œå‡å°‘æ‹¼å†™é”™è¯¯ã€‚

    // ç¤ºä¾‹ï¼šé€šè¿‡ç”Ÿæˆçš„å¸¸é‡è®¿é—®å›¾ç‰‡
    Image.asset(Assets.images.logo); 
    // æ›¿ä»£ 
    Image.asset('assets/images/logo.png')
    

2ï¼‰**ç±»å‹å®‰å…¨ä¸æ™ºèƒ½æç¤º**â€Œ

èµ„æºåç§°é€šè¿‡ä»£ç ç”Ÿæˆå™¨æ˜ å°„ä¸ºå¼ºç±»å‹å±æ€§ï¼ŒIDE å¯æä¾›è‡ªåŠ¨è¡¥å…¨ï¼Œæå‡å¼€å‘ä½“éªŒã€‚

3ï¼‰â€Œ**å¤šåˆ†è¾¨ç‡èµ„æºé€‚é…**â€Œ

è‡ªåŠ¨å¤„ç†ä¸åŒåˆ†è¾¨ç‡çš„èµ„æºæ–‡ä»¶ï¼ˆå¦‚ `logo@2x.png`ï¼‰ï¼Œç”Ÿæˆç»Ÿä¸€çš„è®¿é—®æ¥å£ã€‚

### 2\. è‡ªåŠ¨ç”Ÿæˆçš„è§¦å‘æœºåˆ¶

1ï¼‰â€Œ**ä¾èµ–æ’ä»¶**â€Œ

é€šå¸¸ç”± `flutter_gen` æˆ– `flutter_generate_assets` ç­‰æ’ä»¶å®ç°ï¼Œè¿™äº›æ’ä»¶åŸºäº Dart çš„ `build_runner` å·¥å…·é“¾ã€‚

2ï¼‰â€Œ**é…ç½®æ–‡ä»¶é©±åŠ¨**â€Œ

åœ¨ `pubspec.yaml` ä¸­å£°æ˜èµ„æºåï¼Œæ’ä»¶ä¼šç›‘å¬æ–‡ä»¶å˜åŒ–å¹¶è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼š

    flutter:
      assets:
        - assets/images/
    

3ï¼‰**ç¼–è¯‘æ—¶ç”Ÿæˆ**â€Œ

æ‰§è¡Œ `flutter pub run build_runner build` å‘½ä»¤è§¦å‘ç”Ÿæˆï¼Œç»“æœä¿å­˜åœ¨ `lib/generated/` ç›®å½•ä¸‹ã€‚

### 3\. ä¼˜åŠ¿å¯¹æ¯”æ‰‹åŠ¨ç®¡ç†

ç‰¹æ€§

æ‰‹åŠ¨ç®¡ç†

è‡ªåŠ¨ç”Ÿæˆ (`generated/assets.dart`)

â€Œ**è·¯å¾„å‡†ç¡®æ€§**â€Œ

æ˜“å‡ºé”™

100% å‡†ç¡®

â€Œ**é‡æ„å‹å¥½æ€§**â€Œ

éœ€å…¨å±€æœç´¢æ›¿æ¢

è‡ªåŠ¨åŒæ­¥ä¿®æ”¹

â€Œ**å¤šè¯­è¨€æ”¯æŒ**â€Œ

éœ€é¢å¤–å·¥å…·

å¯æ•´åˆå›½é™…åŒ–èµ„æº

### 4\. é«˜çº§åº”ç”¨åœºæ™¯

1ï¼‰**ä¸å›½é™…åŒ–ç»“åˆ**â€Œ

é€šè¿‡æ³¨è§£ç”Ÿæˆå¤šè¯­è¨€èµ„æºçš„è®¿é—®ä»£ç ï¼Œä¾‹å¦‚ `Assets.translations.homeTitle`ã€‚

2ï¼‰â€Œ**è‡ªå®šä¹‰èµ„æºç±»å‹**â€Œ

æ‰©å±•æ”¯æŒ JSONã€éŸ³é¢‘ç­‰éå›¾ç‰‡èµ„æºï¼Œç”Ÿæˆå¯¹åº”çš„è§£ææ–¹æ³•ã€‚

å››. å¸¸é‡é…ç½®é›†
--------

å¸¸ç”¨å¸¸é‡é…ç½®é›†åˆç»“æ„å‚è€ƒå¦‚ä¸‹ï¼Œå½“ç„¶æˆ‘ä»¬åœ¨å¼€å‘è¿‡ç¨‹ä¸­åº”è¯¥æ ¹æ®å…·ä½“å®é™…æƒ…å†µè¿›è¡Œå¢åŠ å’Œä¿®æ”¹ã€‚

    core/                           # æ ¸å¿ƒå±‚
    â”‚   â”‚   â”‚   â”œâ”€â”€ constants/                  # å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_constants.dart      # åº”ç”¨å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_strings.dart        # å­—ç¬¦ä¸²å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ app_layouts.dart        # å¸ƒå±€å°ºå¯¸å¸¸é‡
    â”‚   â”‚   â”‚   â”‚   â””â”€â”€ app_colors.dart         # é¢œè‰²å¸¸é‡
    

    class AppConstants {
      // åº”ç”¨åŸºç¡€ä¿¡æ¯
      static const String appName = 'pubassistant';
      static const String appVersion = '1.0.0.0';
      static const int appBuildNumber = 1000;
    }
    

äº”. Theme ä¸»é¢˜é…ç½®
-------------

Theme ä¸»é¢˜ç³»ç»Ÿçš„æ ¸å¿ƒæ–‡ä»¶ï¼Œç”¨äºé›†ä¸­ç®¡ç†åº”ç”¨çš„è§†è§‰æ ·å¼å’Œæ–‡æœ¬é£æ ¼ã€‚

### 1\. å…¨å±€ä¸»é¢˜é…ç½®

â€Œ**åŠŸèƒ½**â€Œï¼šå®šä¹‰åº”ç”¨çš„æ•´ä½“è§†è§‰é£æ ¼ï¼ŒåŒ…æ‹¬é¢œè‰²ã€ç»„ä»¶æ ·å¼ã€äº®åº¦æ¨¡å¼ç­‰ï¼Œé€šè¿‡ `ThemeData` ç±»å®ç°ç»Ÿä¸€ç®¡ç†ã€‚å…¸å‹å†…å®¹ï¼š

    import 'package:flutter/material.dart';
    import 'text_styles.dart';  // å…³è”æ–‡æœ¬æ ·å¼
    
    class AppTheme {
      // æ˜äº®ä¸»é¢˜
      static ThemeData lightTheme = ThemeData(
        colorScheme: ColorScheme.light(
          primary: Colors.blueAccent,
          secondary: Colors.green,
        ),
        appBarTheme: AppBarTheme(
          backgroundColor: Colors.blueAccent,
          titleTextStyle: TextStyles.headlineMedium,
        ),
        buttonTheme: ButtonThemeData(
          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
        ),
        textTheme: TextTheme(
          displayLarge: TextStyles.displayLarge,  // å¼•ç”¨æ–‡æœ¬æ ·å¼
          bodyMedium: TextStyles.bodyMedium,
        ),
      );
    
      // é»‘æš—ä¸»é¢˜
      static ThemeData darkTheme = ThemeData.dark().copyWith(
        colorScheme: ColorScheme.dark(
          primary: Colors.indigo,
          secondary: Colors.tealAccent,
        ),
      );
    }
    

â€Œ**å…³é”®ç‚¹**â€Œï¼š

*   ä½¿ç”¨ `ColorScheme` å®šä¹‰ä¸»è‰²ã€è¾…è‰²ç­‰é…è‰²æ–¹æ¡ˆï¼›
*   é€šè¿‡ `appBarTheme`ã€`buttonTheme` ç­‰å®šåˆ¶ç»„ä»¶æ ·å¼ï¼›
*   å¼•ç”¨ `text_styles.dart` ä¸­çš„æ–‡æœ¬æ ·å¼ä¿æŒä¸€è‡´æ€§ï¼›

### 2\. æ–‡æœ¬æ ·å¼è§„èŒƒ

â€Œ**åŠŸèƒ½**â€Œï¼šé›†ä¸­ç®¡ç†æ‰€æœ‰æ–‡æœ¬æ ·å¼ï¼ˆå¦‚æ ‡é¢˜ã€æ­£æ–‡ã€æŒ‰é’®æ–‡å­—ç­‰ï¼‰ï¼Œé¿å…æ•£è½åœ¨å„å¤„é‡å¤å®šä¹‰ã€‚å…¸å‹å†…å®¹â€Œï¼š

    class TextStyles {
      // æ ‡é¢˜æ ·å¼
      static const TextStyle displayLarge = TextStyle(
        fontSize: 24,
        fontWeight: FontWeight.bold,
        color: Colors.black87,
      );
    
      // æ­£æ–‡å­—ä½“
      static const TextStyle bodyMedium = TextStyle(
        fontSize: 16,
        height: 1.5,
        color: Color(0xFF424242),
      );
    
      // æŒ‰é’®æ–‡å­—
      static const TextStyle buttonLabel = TextStyle(
        fontSize: 14,
        fontWeight: FontWeight.w600,
        letterSpacing: 0.5
      );
    }
    

â€Œ**å…³é”®ç‚¹**â€Œï¼š

*   ä½¿ç”¨ `const` å®šä¹‰é™æ€æ ·å¼æå‡æ€§èƒ½ï¼›
*   åŒ…å«å­—ä½“å¤§å°ã€é¢œè‰²ã€å­—é‡ã€è¡Œé«˜ç­‰å±æ€§ï¼›
*   æ”¯æŒè‡ªå®šä¹‰å­—ä½“ï¼ˆéœ€åœ¨ `pubspec.yaml` é…ç½®ï¼‰ã€‚

### 3\. ä½¿ç”¨æ–¹å¼

â€Œ**åœ¨ `main.dart` ä¸­åº”ç”¨ä¸»é¢˜**â€Œï¼š

    MaterialApp(
      theme: AppTheme.lightTheme,  // ä½¿ç”¨é¢„å®šä¹‰ä¸»é¢˜
      darkTheme: AppTheme.darkTheme,
      home: MyApp(),
    );
    

â€Œ**åœ¨ç»„ä»¶ä¸­è°ƒç”¨æ–‡æœ¬æ ·å¼**â€Œï¼š

    Text('Hello', style: TextStyles.displayLarge);
    

### 4\. è®¾è®¡å»ºè®®

*   â€Œ**åˆ†å±‚ç®¡ç†**â€Œï¼šå°†é¢œè‰²ã€é—´è·ç­‰åŸºç¡€å˜é‡å•ç‹¬æå–ï¼ˆå¦‚ `colors.dart`ï¼‰ï¼Œè¿™ä¸€ç‚¹å°±æ˜¯å¸¸é‡é…ç½®é›†ä¸­æåˆ°çš„ï¼›
*   **æ‰©å±•æ€§**â€Œï¼šé€šè¿‡ `copyWith` æ–¹æ³•å±€éƒ¨è¦†ç›–ä¸»é¢˜ï¼›
*   **ä¸€è‡´æ€§**â€Œï¼šé¿å…ç›´æ¥åœ¨ç»„ä»¶å†…ç¡¬ç¼–ç æ ·å¼ï¼›

å…­. ç½‘ç»œè¯·æ±‚æ–¹æ¡ˆ
---------

dio æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ HTTP ç½‘ç»œè¯·æ±‚åº“ï¼Œæ”¯æŒå…¨å±€é…ç½®ã€Restful APIã€FormDataã€æ‹¦æˆªå™¨ã€ è¯·æ±‚å–æ¶ˆã€Cookie ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½ã€è¶…æ—¶ã€è‡ªå®šä¹‰é€‚é…å™¨ã€è½¬æ¢å™¨ç­‰ã€‚

é¡¹ç›®é‡Œé€šè¿‡å°è£…è®¾è®¡ http\_exceptionã€http\_interceptorã€http\_optionsã€http\_request ç±»ï¼Œé€‚åº”äºå¤§å‹é¡¹ç›®çš„å¼€å‘åº”ç”¨ã€‚

ä¸ƒ. æ•°æ®å­˜å‚¨æ–¹æ¡ˆ
---------

### 1\. åå¥½è®¾ç½®

æ¨è shared\_preferences æ–¹æ¡ˆï¼Œé¡¹ç›®é‡Œè¿›è¡Œäº†ä¸€å±‚åº”ç”¨å°è£…ã€‚

### 2\. æ•°æ®åº“æ–¹æ¡ˆè®¾è®¡

#### 2.1 æ ¸å¿ƒè®¾è®¡åŸç†

æ•°æ®åº“å°è£…é‡‡ç”¨äº†åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œä¸»è¦ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼šåŸºç¡€æä¾›è€…ç±»(DbBaseProvider)ã€æ•°æ®åº“åŠ©æ‰‹ç±»(DbHelper)å’Œå…·ä½“ä¸šåŠ¡æä¾›è€…(UserDbProvider)ã€‚

1.  â€Œ**å•ä¸€èŒè´£åŸåˆ™**â€Œï¼šæ¯ä¸ªç±»éƒ½æœ‰æ˜ç¡®çš„èŒè´£åˆ’åˆ†ï¼›
    *   DbBaseProviderï¼šæä¾›åŸºç¡€è¡¨æ“ä½œèƒ½åŠ›ï¼›
    *   DbHelperï¼šç®¡ç†æ•°æ®åº“è¿æ¥å’Œåˆå§‹åŒ–ï¼›
    *   UserDbProviderï¼šå®ç°å…·ä½“ä¸šåŠ¡è¡¨æ“ä½œï¼›
2.  â€Œ**æ¨¡æ¿æ–¹æ³•æ¨¡å¼**â€Œï¼šDbBaseProvider ä¸­å®šä¹‰äº†æŠ½è±¡æ–¹æ³•(getTableName, createTableString)ï¼Œè¦æ±‚å­ç±»å¿…é¡»å®ç°ï¼›
3.  â€Œ**å•ä¾‹æ¨¡å¼**â€Œï¼šDbHelper é‡‡ç”¨å•ä¾‹ç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªæ•°æ®åº“è¿æ¥ï¼›
4.  â€Œ**æ‡’åŠ è½½**â€Œï¼šæ•°æ®åº“è¿æ¥åœ¨é¦–æ¬¡ä½¿ç”¨æ—¶æ‰åˆå§‹åŒ–ï¼›

#### 2.2 å°è£…ä¼˜ç‚¹

1.  â€Œ**ç»“æ„æ¸…æ™°**â€Œï¼šåˆ†å±‚æ˜ç¡®ï¼ŒèŒè´£åˆ†ç¦»ï¼›
    
2.  â€Œ**å¤ç”¨æ€§å¼º**â€Œï¼šåŸºç¡€åŠŸèƒ½å°è£…åœ¨çˆ¶ç±»ï¼Œå­ç±»åªéœ€å…³æ³¨ä¸šåŠ¡è¡¨ç»“æ„ï¼›
    
3.  â€Œæ€§èƒ½ä¼˜åŒ–ï¼š
    
    *   å•ä¾‹æ¨¡å¼é¿å…é‡å¤åˆ›å»ºè¿æ¥ï¼›
    *   è¡¨å­˜åœ¨æ£€æŸ¥é¿å…é‡å¤å»ºè¡¨ï¼›
4.  â€Œ**æ‰©å±•æ€§å¥½**â€Œï¼šæ–°å¢è¡¨åªéœ€ç»§æ‰¿ DbBaseProviderï¼›
    
5.  â€Œ**çº¿ç¨‹å®‰å…¨**â€Œï¼šæ‰€æœ‰æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼›
    

#### 2.3 å¸¸è§é—®é¢˜å’Œæ”¹è¿›æ³¨æ„ç‚¹

æ³¨æ„äº‹é¡¹ï¼š

1.  â€Œ**æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å‰æœŸè®¾è®¡ä¸è¶³**â€Œï¼šDbHelper ä¸­è™½ç„¶æœ‰ version å­—æ®µä½†æ²¡æœ‰ç”¨äºå‡çº§é€»è¾‘ï¼Œç¼ºå°‘æ•°æ®åº“å‡çº§è¿ç§»æœºåˆ¶ã€‚å¢å¼ºçš„ç‰ˆæœ¬ç®¡ç†â€Œï¼šæ·»åŠ äº† onUpgrade å’Œ onDowngrade å›è°ƒã€æ¯ä¸ª Provider å¯å®šä¹‰å‡çº§ SQLï¼›
2.  **äº‹åŠ¡æ”¯æŒä¸è¶³**â€Œï¼šæä¾›äº‹åŠ¡æ“ä½œæ–¹æ³•å°è£…ï¼›
3.  â€Œ**é”™è¯¯å¤„ç†ç¼ºå¤±**â€Œï¼šæ²¡æœ‰ç»Ÿä¸€çš„å¯¹æ•°æ®åº“æ“ä½œå¼‚å¸¸çš„æ•è·å’Œå¤„ç†æœºåˆ¶ï¼›
4.  â€Œ**SQL æ³¨å…¥é£é™©**â€Œï¼šUserDbProvider ä¸­ç›´æ¥æ‹¼æ¥ SQL å­—ç¬¦ä¸²ï¼Œéƒ¨åˆ† SQL è¯­å¥ç›´æ¥æ‹¼æ¥å­—ç¬¦ä¸²å‚æ•°ï¼Œä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é˜²æ­¢ SQL æ³¨å…¥ï¼›
5.  **æ€§èƒ½ä¼˜åŒ–ç©ºé—´**â€Œï¼šæ•°æ®åº“è¿æ¥æ²¡æœ‰å…³é—­æœºåˆ¶ï¼›

æœ€ä½³å®è·µå»ºè®®ï¼š

1.  â€Œ**å¢åŠ æ¨¡å‹å±‚**â€Œï¼šå»ºè®®æ·»åŠ Useræ¨¡å‹ç±»ï¼Œæ›¿ä»£ç›´æ¥ä½¿ç”¨Mapï¼›
2.  â€Œ**ä½¿ç”¨ORMæ¡†æ¶**â€Œï¼šè€ƒè™‘ä½¿ç”¨flooræˆ–moorç­‰Dart ORMæ¡†æ¶ï¼›
3.  â€Œ**æ—¥å¿—è®°å½•**â€Œï¼šæ·»åŠ æ•°æ®åº“æ“ä½œæ—¥å¿—ï¼›
4.  â€Œ**å¤‡ä»½æœºåˆ¶**â€Œï¼šå®ç°å®šæœŸå¤‡ä»½åŠŸèƒ½ï¼›
5.  â€Œ**æ€§èƒ½ç›‘æ§**â€Œï¼šæ·»åŠ æŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡ï¼›

æ€»ç»“ï¼šå°è£…éµå¾ªäº†åŸºæœ¬çš„è½¯ä»¶è®¾è®¡åŸåˆ™ï¼Œæä¾›äº†æ¸…æ™°çš„æ‰©å±•æ¥å£ã€‚ä¸»è¦æ”¹è¿›ç©ºé—´åœ¨äºé”™è¯¯å¤„ç†ã€ç±»å‹å®‰å…¨å’Œç‰ˆæœ¬ç®¡ç†æ–¹é¢ã€‚é€šè¿‡å¼•å…¥æ¨¡å‹å±‚å’Œ ORM æ¡†æ¶å¯ä»¥è¿›ä¸€æ­¥æå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚

å…«. çŠ¶æ€ç®¡ç†
-------

InheritedWidget æä¾›äº†åœ¨ Widget æ ‘ä¸­ä»ä¸Šå¾€ä¸‹å…±äº«æ•°æ®çš„èƒ½åŠ›ï¼›

å…¨å±€äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰å®ç°è·¨é¡µé¢ã€è·¨ç»„ä»¶çš„é€šä¿¡ï¼Œè¿›è¡Œæ•°æ®ä¼ é€’ä¸äº¤äº’ã€‚å…·ä½“çš„å®ç°å°è£…ç»“åˆé¡¹ç›®ï¼›

ChangeNotifier(provider) + ValueNotifierï¼›

BLoCï¼ˆæ¨è bloc + flutter\_bloc + Cubitï¼‰ï¼›

ä¹. è·¯ç”±ç®¡ç†
-------

åœ¨ Flutter é¡¹ç›®ä¸­ï¼Œgo\_router å’Œ auto\_route éƒ½æ˜¯ä¼˜ç§€çš„ç¬¬ä¸‰æ–¹è·¯ç”±åº“ï¼Œä½†å®ƒä»¬çš„å®šä½å’Œç‰¹æ€§æœ‰æ‰€ä¸åŒã€‚ä»¥ä¸‹æ˜¯ä¸¤è€…çš„å¯¹æ¯”åˆ†æåŠé€‰å‹å»ºè®®ï¼š

### 1\. æ ¸å¿ƒç‰¹æ€§å¯¹æ¯”

â€Œ**go\_routerï¼š**

*   åŸºäº URL çš„è·¯ç”±ç®¡ç†ï¼Œæ”¯æŒæ·±åº¦é“¾æ¥å’Œ Web å…¼å®¹æ€§ã€‚
*   æä¾›è·¯ç”±å®ˆå«ï¼ˆå¦‚ç™»å½•éªŒè¯ã€æƒé™æ§åˆ¶ï¼‰å’Œé‡å®šå‘åŠŸèƒ½ã€‚
*   æ”¯æŒåµŒå¥—è·¯ç”±å’ŒåŠ¨æ€å‚æ•°è§£æï¼Œè¯­æ³•ç®€æ´ã€‚
*   ä¸ Navigator API å…¼å®¹ï¼Œé€‚åˆéœ€è¦ Web æ”¯æŒæˆ–å¤æ‚è·¯ç”±é€»è¾‘çš„é¡¹ç›®ã€‚

â€Œ**auto\_routeï¼š**â€Œ

*   åŸºäºä»£ç ç”Ÿæˆçš„è·¯ç”±æ–¹æ¡ˆï¼Œé€šè¿‡æ³¨è§£è‡ªåŠ¨ç”Ÿæˆè·¯ç”±ä»£ç ã€‚
*   å¼ºç±»å‹è·¯ç”±å‚æ•°ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥å‡å°‘è¿è¡Œæ—¶é”™è¯¯ã€‚
*   æ”¯æŒåµŒå¥—å¯¼èˆªå’Œè‡ªå®šä¹‰è¿‡æ¸¡åŠ¨ç”»ã€‚
*   é€‚åˆè¿½æ±‚ç±»å‹å®‰å…¨å’Œå‡å°‘æ ·æ¿ä»£ç çš„å›¢é˜Ÿã€‚

### 2\. æ€§èƒ½ä¸å¤æ‚åº¦

*   â€Œ**go\_router**â€Œï¼šè¿è¡Œæ—¶é…ç½®è·¯ç”±ï¼Œçµæ´»æ€§é«˜ä½†å¯èƒ½å¢åŠ è¿è¡Œæ—¶å¼€é”€ã€‚
*   â€Œ**auto\_route**â€Œï¼šç¼–è¯‘æ—¶ç”Ÿæˆä»£ç ï¼Œæ€§èƒ½æ›´ä¼˜ä½†éœ€ä¾èµ–ä»£ç ç”Ÿæˆæ­¥éª¤ã€‚

### 3\. é€‰å‹å»ºè®®

â€Œ**é€‰æ‹© go\_router çš„åœºæ™¯**â€Œï¼š

*   éœ€è¦æ·±åº¦é“¾æ¥æˆ– Web æ”¯æŒã€‚
*   é¡¹ç›®ä¸­æœ‰å¤æ‚è·¯ç”±æ‹¦æˆªéœ€æ±‚ï¼ˆå¦‚åŠ¨æ€æƒé™æ§åˆ¶ï¼‰ã€‚
*   å›¢é˜Ÿåå¥½å£°æ˜å¼é…ç½®è€Œéä»£ç ç”Ÿæˆã€‚

â€Œ**é€‰æ‹© auto\_route çš„åœºæ™¯**â€Œï¼š

*   è¿½æ±‚ç±»å‹å®‰å…¨å’Œç¼–è¯‘æ—¶æ£€æŸ¥ã€‚
*   éœ€è¦å‡å°‘æ‰‹åŠ¨ç¼–å†™è·¯ç”±æ ·æ¿ä»£ç ã€‚
*   é¡¹ç›®å·²ä½¿ç”¨å…¶ä»–ä»£ç ç”Ÿæˆå·¥å…·ï¼ˆå¦‚freezedï¼‰ã€‚

### 4\. æ··åˆä½¿ç”¨æ–¹æ¡ˆ

å¯¹äºå¤§å‹é¡¹ç›®ï¼Œå¯ç»“åˆä¸¤è€…ä¼˜åŠ¿ï¼š

*   ä½¿ç”¨ auto\_route ç®¡ç†åŸºç¡€é¡µé¢è·¯ç”±ï¼›
*   é€šè¿‡ go\_router å¤„ç†éœ€è¦åŠ¨æ€æ‹¦æˆªæˆ– Web é›†æˆçš„ç‰¹æ®Šè·¯ç”±ï¼›

å»ºè®®æ ¹æ®å›¢é˜ŸæŠ€æœ¯æ ˆå’Œé¡¹ç›®éœ€æ±‚ï¼ˆå¦‚æ˜¯å¦è·¨å¹³å°ã€æ˜¯å¦éœ€è¦å¼ºç±»å‹æ”¯æŒï¼‰åšå‡ºé€‰æ‹©ã€‚

å. Flutter MVVM + Repository æ¶æ„
-------------------------------

ä»¥ä¸‹æ˜¯ Flutter MVVM + Repository æ¶æ„çš„ä¸šåŠ¡ç¤ºä¾‹è§£æã€‚

### 1\. æ¶æ„ç»“æ„å’Œå„å±‚èŒè´£

#### 1.1 ç›®å½•æ¶æ„ç»“æ„

    â”œâ”€â”€ features/                 # ä¸šåŠ¡åŠŸèƒ½æ¨¡å—åˆ’åˆ†å±‚
    â”‚   â”œâ”€â”€ data/                     # æ•°æ®å±‚ï¼šèšç„¦æ•°æ®è·å–ä¸å­˜å‚¨é€»è¾‘
    â”‚   â”‚   â”œâ”€â”€ models/                     # æ•°æ®æ¨¡å‹
    â”‚   â”‚   â”œâ”€â”€ repositories/               # æ•°æ®ä»“åº“
    â”‚   â”‚   â””â”€â”€ services/                   # æ•°æ®æœåŠ¡ï¼ˆAPIæ¥å£ï¼‰
    â”‚   â”œâ”€â”€ domain/                     # ä¸šåŠ¡å±‚ï¼šå¤„ç†ä¸šåŠ¡è§„åˆ™ä¸é€»è¾‘æµè½¬ï¼Œå¦‚æ•°æ®éªŒè¯ã€æµç¨‹ç¼–æ’ã€é¢†åŸŸæ¨¡å‹è½¬æ¢
    â”‚   â”‚   â”œâ”€â”€ entities/                   # ä¸šåŠ¡å®ä½“
    â”‚   â”‚   â”œâ”€â”€ repositories/               # æŠ½è±¡ä»“åº“æ¥å£
    â”‚   â”‚   â””â”€â”€ use_cases/                  # ä¸šåŠ¡é€»è¾‘ç”¨ä¾‹
    â”‚   â””â”€â”€ presentation/               # è¡¨ç°å±‚
    â”‚       â”œâ”€â”€ pages/                      # UI é¡µé¢
    â”‚       â”œâ”€â”€ widgets/                    # æ¨¡å—å†…å¤ç”¨ç»„ä»¶
    â”‚       â”œâ”€â”€ view_models/                # è§†å›¾æ¨¡å‹
    â”‚       â”œâ”€â”€ router/                     # æ¨¡å—ç‹¬ç«‹è·¯ç”±
    â””â”€â”€     â””â”€â”€ state/                      # çŠ¶æ€ç®¡ç†
    

#### 1.2 MVVM + Repository æ¶æ„å±‚èŒè´£è¯´æ˜

â€Œ**Model å±‚**â€Œï¼š

*   `data/models`ï¼šæ•°æ®æ¨¡å‹ï¼ˆDTOï¼‰
*   `domain/entities`ï¼šä¸šåŠ¡å®ä½“
*   `data/services`ï¼šæ•°æ®æºå®ç°ï¼ˆSQLite/APIï¼‰

â€Œ**ViewModel å±‚**â€Œï¼šè°ƒç”¨ UseCaseã€å¤„ç†ä¸šåŠ¡é€»è¾‘ã€ç®¡ç† UI çŠ¶æ€ã€‚

*       presentation/viewmodels
        
    

â€Œ**View å±‚**â€Œï¼šçº¯ UI å±•ç¤ºã€é€šè¿‡ Consumer ç›‘å¬ ViewModelã€‚

*       presentation/pages
        
    

â€Œ**Repository å±‚**â€Œï¼š

*   `domain/repositories`ï¼šæŠ½è±¡æ¥å£ã€‚
*   `data/repositories`ï¼šå…·ä½“å®ç°ã€‚

#### 1.3 ViewModel å±‚è§£æ

åœ¨ Flutter åŠŸèƒ½ä¼˜å…ˆç»“æ„ä¸­èå…¥ ViewModel å±‚æ—¶ï¼Œæ ¸å¿ƒåŒºåˆ«å¦‚ä¸‹ï¼š

##### 1ï¼‰ViewModel å±‚çš„å®šä½ä¸å®ç°

åœ¨ç°æœ‰ç»“æ„ä¸­ï¼Œ`presentation/state/` ç›®å½•å³ ViewModel å±‚çš„å¤©ç„¶ä½ç½®ï¼Œç”¨äºç®¡ç† UI çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘åè°ƒã€‚ViewModel åœ¨ MVVM æ¶æ„ä¸­ä¸»è¦æ‰¿æ‹…ä»¥ä¸‹è§’è‰²ï¼š

*   **çŠ¶æ€ç®¡ç†**â€Œï¼šè´Ÿè´£ç®¡ç†åº”ç”¨çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ UI çŠ¶æ€ï¼ˆå¦‚åŠ è½½ä¸­ã€é”™è¯¯ï¼‰å’Œä¸šåŠ¡æ•°æ®çŠ¶æ€ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰ã€‚
    
*   â€Œ**ä¸šåŠ¡é€»è¾‘å¤„ç†**â€Œï¼šå°è£…ä¸šåŠ¡é€»è¾‘ï¼ŒåŒ…æ‹¬æ•°æ®è·å–ã€è½¬æ¢å’Œå¤„ç†ã€‚
    
*   **æ•°æ®å±‚äº¤äº’**â€Œï¼šé€šè¿‡ UseCase æˆ– Repository ä¸æ•°æ®å±‚äº¤äº’ï¼Œè·å–æˆ–å­˜å‚¨æ•°æ®ã€‚
    

å…¸å‹å®ç°æ–¹å¼ï¼š

    class UserViewModel with ChangeNotifier {
      final GetUserByIdUseCase _getUserByIdUseCase;
      UserEntity? _userEntity;
      bool _isLoading = false;
      String? _error;
    
      UserEntity? get user => _userEntity;
      bool get isLoading => _isLoading;
      String? get error => _error;
    
      UserViewModel(this._getUserByIdUseCase);
    
      Future<void> fetchUser(String userId) async {
        _isLoading = true;
        notifyListeners();
    
        try {
          _userEntity = await _getUserByIdUseCase.execute(userId);
          _error = null;
        } catch(e) {
          _error = e.toString();
        } finally {
          _isLoading = false;
          notifyListeners();
        }
      }
    }
    

æ­¤å¤„ `presentation/state/` å­˜æ”¾ ViewModelï¼Œé€šè¿‡ `use_cases` è°ƒç”¨é¢†åŸŸé€»è¾‘ã€‚

##### 2ï¼‰æ·»åŠ  ViewModel å±‚çš„ä¼˜åŠ¿

**èŒè´£åˆ†ç¦»**â€Œï¼Œè§£å†³UIä¸ä¸šåŠ¡é€»è¾‘è€¦åˆé—®é¢˜ã€‚

*   Viewï¼šçº¯ UI æ¸²æŸ“ (`pages/`, `widgets/`)
*   ViewModelï¼šçŠ¶æ€ç®¡ç†/é€»è¾‘åè°ƒ (`state/`)
*   Modelï¼šæ•°æ®æ“ä½œ (`repositories/`, `services/`)

â€Œ**å¯æµ‹è¯•æ€§æå‡**â€Œï¼ŒViewModel ç‹¬ç«‹äº Widget æ ‘ï¼Œå¯ç›´æ¥è¿›è¡Œå•å…ƒæµ‹è¯•ã€‚

    test('UserViewModel should emit loading state', () {
      final vm = UserViewModel(mockUseCase);
      vm.fetchUser('123');
      expect(vm.state, ViewState.isLoading);
    });
    

â€Œ**çŠ¶æ€ç”Ÿå‘½å‘¨æœŸç®¡ç†**â€Œï¼Œè‡ªåŠ¨å¤„ç†é¡µé¢é”€æ¯æ—¶çš„èµ„æºé‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚

â€Œ**è·¨ç»„ä»¶çŠ¶æ€å…±äº«**â€Œï¼Œé€šè¿‡ Provider/Riverpod å®ç°å¤šä¸ª Widget è®¿é—®åŒä¸€çŠ¶æ€æºã€‚

##### 3ï¼‰ä¸åŠ  ViewModel å±‚çš„ç¼ºé™·

â€Œ**é€»è¾‘è‡ƒè‚¿**â€Œï¼Œä¸šåŠ¡ä»£ç ä¾µå…¥ Widgetï¼Œå¯¼è‡´ä¸‡è¡Œ `StatefulWidget` åœ°ç‹±ã€‚

    // åä¾‹ï¼šä¸šåŠ¡é€»è¾‘æ··å…¥UIå±‚
    class LoginPage extends StatefulWidget {
      Future<void> _login() async {
        // APIè°ƒç”¨+çŠ¶æ€ç®¡ç†+å¯¼èˆªè·³è½¬
      }
    }
    

â€Œ**æµ‹è¯•å›°éš¾**â€Œï¼Œéœ€å¯åŠ¨å®Œæ•´ Widget æ ‘æµ‹è¯•åŸºç¡€é€»è¾‘ã€‚

â€Œ**çŠ¶æ€åˆ†æ•£**â€Œï¼Œç›¸åŒä¸šåŠ¡çŠ¶æ€å¯èƒ½è¢«é‡å¤å®ç°äºä¸åŒWidgeã€‚

##### 4ï¼‰å…³é”®å®è·µå»ºè®®

**å±‚çº§äº¤äº’è§„èŒƒ**â€Œï¼Œéµå¾ªå•å‘ä¾èµ–ï¼šå¤–å±‚â†’å†…å±‚

    View[Widget] -->|ç›‘å¬| ViewModel
    ViewModel -->|è°ƒç”¨| UseCase
    UseCase -->|ä¾èµ–æŠ½è±¡| Repository
    Repository -->|ç»„åˆ| DataSource
    

â€Œ**çŠ¶æ€ç®¡ç†é€‰å‹**â€Œ

*   ä¸­å°é¡¹ç›®ï¼š`ChangeNotifier` + `Provider`
*   å¤§å‹é¡¹ç›®ï¼š`Riverpod`/`Bloc` + `Freezed`

â€Œ**æ¨¡å—åŒ–æ‰©å±•**â€Œï¼Œä¿æŒå„åŠŸèƒ½æ¨¡å—å†…èšæ€§

### 2\. ä¸šåŠ¡è°ƒç”¨åœºæ™¯ï¼ˆè·å–ç”¨æˆ·ä¿¡æ¯ï¼‰

å‡è®¾æˆ‘ä»¬éœ€è¦é€šè¿‡ API è·å–ç”¨æˆ·æ•°æ®ï¼Œå¹¶è¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¦‚æ•°æ®éªŒè¯ã€æ¨¡å‹è½¬æ¢ï¼‰ã€‚

#### 2.1 æ•°æ®å±‚ï¼ˆdata/ï¼‰

**ç›®çš„**â€Œï¼šèšç„¦æ•°æ®è·å–ä¸å­˜å‚¨é€»è¾‘ï¼Œå®ç°å…·ä½“çš„æ•°æ®è·å–é€»è¾‘ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œï¼‰ã€‚

##### 1ï¼‰/data/models/user\_model.dart

    // data/models/user_model.dart
    // æ•°æ®æ¨¡å‹ï¼šå¯¹åº” API è¿”å›çš„ JSON ç»“æ„ï¼ˆå«åºåˆ—åŒ–æ³¨è§£ï¼‰
    @JsonSerializable()
    class UserModel {
      @JsonKey(name: 'user_id') 
      final String id;
      final String username;
      final int age;
    
      UserModel({required this.id, required this.username, required this.age});
      
      factory UserModel.fromJson(Map<String, dynamic> json) => _$UserModelFromJson(json);
    }
    

##### 2ï¼‰data/services/user\_api\_service.dart

    // data/services/user_api_service.dart
    // æ•°æ®æœåŠ¡ï¼šä¸ API äº¤äº’ï¼ˆå…·ä½“å®ç°ï¼‰
    class UserApiService {
      final Dio dio;
    
      UserApiService(this.dio);
    
      Future<UserModel> fetchUser(String userId) async {
        final response = await dio.get('/users/$userId');
        return UserModel.fromJson(response.data);
      }
    }
    

##### 3ï¼‰data/repositories/user\_repository\_impl.dart

1.  ç»„åˆå¤šä¸ªæ•°æ®æºã€‚
2.  DTO ä¸ Entity è½¬æ¢ã€‚

    // data/repositories/user_repository_impl.dart
    // ä»“åº“å®ç°ï¼šå°†æ•°æ®è½¬æ¢ä¸ºä¸šåŠ¡å®ä½“ï¼ˆå®ç° domain å±‚çš„æŠ½è±¡æ¥å£ï¼‰
    class UserRepositoryImpl implements UserRepository {
      final UserApiService apiService;
    
      UserRepositoryImpl(this.apiService);
    
      @override
      Future<UserEntity> getUserById(String userId) async {
        final userModel = await apiService.fetchUser(userId);
        return UserEntity(
          id: userModel.id,
          name: userModel.username, // å­—æ®µåè½¬æ¢ï¼ˆAPI username â†’ ä¸šåŠ¡ nameï¼‰
          age: userModel.age,
        );
      }
    }
    

#### 2.2 ä¸šåŠ¡å±‚ï¼ˆdomain/ï¼‰

**ç›®çš„**â€Œï¼šå¤„ç†ä¸šåŠ¡è§„åˆ™ä¸æ ¸å¿ƒé€»è¾‘æµè½¬ã€æŠ½è±¡æ¥å£ï¼Œå¦‚æ•°æ®éªŒè¯ã€æµç¨‹ç¼–æ’ã€é¢†åŸŸæ¨¡å‹è½¬æ¢ï¼ˆä¸å…·ä½“æŠ€æœ¯æ— å…³ï¼‰ã€‚

##### 1ï¼‰domain/entities/user\_entity.dart

    // domain/entities/user_entity.dart
    // ä¸šåŠ¡å®ä½“ï¼šçº¯ Dart å¯¹è±¡ï¼Œä»…åŒ…å«ä¸šåŠ¡æ ¸å¿ƒå±æ€§ï¼ˆæ—  JSON æ³¨è§£ï¼‰
    class UserEntity {
      final String id;
      final String name;
      final int age;
    
      UserEntity({required this.id, required this.name, required this.age});
      
      // ä¸šåŠ¡é€»è¾‘æ–¹æ³•ï¼ˆå¦‚å¹´é¾„éªŒè¯ï¼‰
      bool isAdult() => age >= 18;
    }
    

##### 2ï¼‰domain/repositories/user\_repository.dart

    // domain/repositories/user_repository.dart
    // ä»“åº“æŠ½è±¡æ¥å£ï¼šå®šä¹‰ä¸šåŠ¡éœ€è¦çš„æ•°æ®æ“ä½œæ–¹æ³•ï¼ˆä¸ä¾èµ–å…·ä½“å®ç°ï¼‰
    abstract class UserRepository {
      Future<UserEntity> getUserById(String userId);
    }
    

##### 3ï¼‰domain/use\_cases/user\_id\_usecase.dart

1.  éµå¾ªå•ä¸€èŒè´£åŸåˆ™
2.  è°ƒç”¨ Repository æ¥å£

    // domain/use_cases/user_id_usecase.dart
    // ä¸šåŠ¡ç”¨ä¾‹ï¼šç¼–æ’æ•°æ®è·å–å’Œä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚éªŒè¯ï¼‰
    class GetUserByIdUseCase {
      final UserRepository repository; // ä¾èµ–æŠ½è±¡æ¥å£
      
      GetUserByIdUseCase(this.repository);
    
      Future<UserEntity> execute(String userId) async {
        final user = await repository.getUserById(userId);
        if (!user.isAdult()) {
          throw Exception('User must be an adult'); // ä¸šåŠ¡è§„åˆ™éªŒè¯
        }
        return user;
      }
    }
    

#### 2.3 è¡¨ç°å±‚ï¼ˆpresentation/ï¼‰

##### 1ï¼‰ä¾èµ–æ³¨å…¥ï¼šinjection\_container

    final getIt = GetIt.instance;
    
    void setupDependencies() {
      setupApiDependencies();
      setupRepositoryDependencies();
      setupCaseDependencies();
      setupViewModelDependencies();
    }
    
    void setupApiDependencies() {
      // æ•°æ®å±‚
      getIt.registerSingleton<UserApiService>(UserApiService(Dio()));
    }
    
    void setupRepositoryDependencies() {
      // ä»“åº“å±‚
      getIt.registerSingleton<UserRepository>(
          UserRepositoryImpl(getIt<UserApiService>())
      );
    }
    
    void setupCaseDependencies() {
      // ä¸šåŠ¡ç”¨ä¾‹å±‚
      getIt.registerSingleton<GetUserByIdUseCase>(
          GetUserByIdUseCase(getIt<UserRepository>())
      );
    }
    
    void setupViewModelDependencies() {
      // ViewModelï¼ˆå·¥å‚æ¨¡å¼ï¼Œæ¯æ¬¡æ–°å»ºå®ä¾‹ï¼‰
      getIt.registerFactory<UserViewModel>(
              () => UserViewModel(getIt<GetUserByIdUseCase>())
      );
    }
    

##### 2ï¼‰view\_models/user\_view\_model.dart

çŠ¶æ€ç®¡ç†é‡‡ç”¨ ChangeNotifierï¼Œç»Ÿä¸€å¤„ç†æˆåŠŸ/å¤±è´¥ã€‚

    class UserViewModel with ChangeNotifier {
      final GetUserByIdUseCase _getUserByIdUseCase;
      UserEntity? _userEntity;
      bool _isLoading = false;
      String? _error;
    
      // çŠ¶æ€æš´éœ²ç»™è§†å›¾å±‚
      UserEntity? get user => _userEntity;
      bool get isLoading => _isLoading;
      String? get error => _error;
    
      UserViewModel(this._getUserByIdUseCase);
    
      Future<void> fetchUser(String userId) async {
        _isLoading = true;
        notifyListeners();
    
        try {
          _userEntity = await _getUserByIdUseCase.execute(userId);
          _error = null;
        } catch(e) {
          _error = e.toString();
        } finally {
          _isLoading = false;
          notifyListeners();
        }
      }
    }
    

##### 3ï¼‰pages/home\_page.dart

    class HomePage extends StatefulWidget {
      const HomePage({super.key});
    
      @override
      State<HomePage> createState() => _HomePageState();
    }
    
    class _HomePageState extends State<HomePage> {
    
      @override
      void initState() {
        super.initState();
    
        WidgetsBinding.instance.addPostFrameCallback((_) {
          final viewModel = Provider.of<UserViewModel>(context, listen: false);
          viewModel.fetchUser("1234");
        });
      }
      
      @override
      Widget build(BuildContext context) {
        return Scaffold(
          appBar: AppBar(title: const Text('Home Page')),
          body: Consumer<UserViewModel>(
            builder: (context, viewModel, child) {
              if (viewModel.isLoading) {
                return const Center(child: CircularProgressIndicator());
              }
              if (viewModel.error != null) {
                return Center(child: Text('Error: ${viewModel.error}'));
              }
              return ElevatedButton(
                  onPressed: () => context.push('/detail', extra: {'id': '${viewModel.user?.id}'}),
                  child: Text('Go to the Details page With id: ${viewModel.user?.name}')
              );
            },
          )
        );
      }
    }
    

##### 4ï¼‰å±€éƒ¨æ³¨å…¥

âš ï¸ åœ¨å…·ä½“é¡µé¢å±€éƒ¨æ³¨å†Œä¸šåŠ¡é€»è¾‘ç±»ï¼ˆå¦‚ `LoginViewModel`ï¼‰ã€‚

    class LoginPage extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return ChangeNotifierProvider(
          create: (_) => LoginViewModel(
            loginUseCase: sl<LoginUseCase>(),
          ),
          child: _LoginView(),
        );
      }
    }
    

##### 5ï¼‰å…¥å£ç±»å…¨å±€æ³¨å†Œ

âš ï¸ æˆ‘ä»¬åº”è¯¥åªåœ¨ `main.dart` å…¨å±€æ³¨å†ŒåŸºç¡€æœåŠ¡ï¼ˆå¦‚ `NetworkService`ï¼‰ã€‚

    void main() async {
      // åˆå§‹åŒ–ç¯å¢ƒé…ç½®
      await EnvLoader.load();
      setupDependencies();
      runApp(
          MultiProvider(
            providers: [
              ChangeNotifierProvider(create: (_) => getIt<UserViewModel>()),
            ],
            child: const MyApp(),
          )
      );
    }
    

### 3\. æ¶æ„è®¾è®¡ç‰¹ç‚¹

#### 3.1 ä¾èµ–å…³ç³»å›¾â€Œ

    presentation å±‚ â†’ domain/use_cases â†’ domain/repositoriesï¼ˆæ¥å£ï¼‰
                                          â†‘
    data/servicesï¼ˆAPI/Databaseï¼‰ â† data/repositoriesï¼ˆå®ç°ï¼‰
    

#### 3.2 å…³é”®åŒºåˆ«ä¸å¿…è¦æ€§

â€Œ**å±‚é¢**â€Œ

â€Œ**domain/ ä¸šåŠ¡å±‚**â€Œ

â€Œ**data/ æ•°æ®å±‚**â€Œ

â€Œ**æ˜¯å¦å†—ä½™ï¼Ÿ**â€Œ

â€Œ**æ¨¡å‹**â€Œ

`UserEntity`ï¼ˆä¸šåŠ¡å±æ€§+é€»è¾‘æ–¹æ³•ï¼‰

`UserModel`ï¼ˆçº¯æ•°æ®æ˜ å°„ï¼‰

å¦ï¼Œé¢å‘ä¸åŒåœºæ™¯

â€Œ**ä»“åº“**â€Œ

æ¥å£ï¼ˆ`UserRepository`ï¼‰

å®ç°ï¼ˆ`UserRepositoryImpl`ï¼‰

å¦ï¼ŒæŠ½è±¡ä¸å®ç°åˆ†ç¦»

â€Œ**å…³æ³¨ç‚¹**â€Œ

ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚å¹´é¾„éªŒè¯ï¼‰

æŠ€æœ¯ç»†èŠ‚ï¼ˆå¦‚ JSON è§£æã€ç½‘ç»œè¯·æ±‚ï¼‰

æ˜ç¡®åˆ†å·¥

ğŸ“Š æ¶æ„æ•ˆèƒ½å¯¹æ¯”

ç»´åº¦

æ—  Repository

æœ‰ Repository

â€Œ**æ•°æ®æºåˆ‡æ¢**â€Œ

éœ€ä¿®æ”¹ ViewModel

ä»…è°ƒæ•´ Repository å®ç°

â€Œ**æµ‹è¯•æˆæœ¬**â€Œ

éœ€å¯åŠ¨å®Œæ•´ç½‘ç»œç¯å¢ƒ

Mock å•ä¸€æ¥å£å³å¯

â€Œ**é”™è¯¯å¤„ç†**â€Œ

åˆ†æ•£åœ¨å„ ViewModel

é›†ä¸­å¤„ç†

â€Œ**ä»£ç å¤ç”¨**â€Œ

ç›¸ä¼¼é€»è¾‘éœ€é‡å¤å®ç°

è·¨æ¨¡å—å…±äº«æ•°æ®ç­–ç•¥

#### 3.3 æ¶æ„æ€»ç»“â€Œ

**ä¸é‡å¤è®¾è®¡**â€Œï¼šä¸šåŠ¡å±‚å®šä¹‰ â€Œ**â€œåšä»€ä¹ˆâ€**â€Œï¼ˆæŠ½è±¡æ¥å£ã€ä¸šåŠ¡è§„åˆ™ï¼‰ï¼Œæ•°æ®å±‚å®ç° â€Œ**â€œæ€ä¹ˆåšâ€**â€Œï¼ˆå…·ä½“æŠ€æœ¯ç»†èŠ‚ï¼‰ã€‚

ä¼˜åŠ¿ï¼šä¸šåŠ¡å±‚å¯ç‹¬ç«‹æµ‹è¯•ï¼ˆæ— éœ€ä¾èµ–ç½‘ç»œ/æ•°æ®åº“ï¼‰ï¼›æ•°æ®æºåˆ‡æ¢çµæ´»ï¼ˆå¦‚ä» API åˆ‡æ¢ä¸ºæœ¬åœ°ç¼“å­˜åªéœ€ä¿®æ”¹ `data/` å±‚ï¼‰ï¼›ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™ï¼ˆé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚ç»†èŠ‚ï¼‰ã€‚

å½“åº”ç”¨æ¶‰åŠå¤šæ•°æ®æºååŒï¼ˆå¦‚å®æ—¶API+æœ¬åœ°ç¼“å­˜ï¼‰æ—¶ï¼ŒRepository çš„ä»·å€¼å°¤ä¸ºçªå‡ºã€‚

### 4\. Repository è§£æ

Repository æ˜¯ MVVM æ¶æ„ä¸­â€Œ**æ•°æ®å±‚çš„ç»Ÿä¸€ç®¡ç†è€…**â€Œï¼Œé€šè¿‡æŠ½è±¡æ•°æ®è®¿é—®ç»†èŠ‚ã€æ ‡å‡†åŒ–æ•°æ®æ ¼å¼å’Œé›†ä¸­åŒ–ç­–ç•¥å¤„ç†ï¼Œæ˜¾è‘—æå‡ä»£ç çš„å¯ç»´æŠ¤æ€§ã€æ‰©å±•æ€§å’Œæµ‹è¯•ä¾¿åˆ©æ€§ã€‚å…¶è®¾è®¡æœ¬è´¨ç¬¦åˆâ€œé«˜å†…èšä½è€¦åˆâ€çš„æ¶æ„åŸåˆ™ï¼Œæ˜¯å¤æ‚ Flutter é¡¹ç›®æ¨èçš„å®è·µæ¨¡å¼ã€‚

åœ¨ Flutter çš„ MVVM + Repository æ¶æ„ä¸­ï¼ŒRepository å±‚æ‰®æ¼”ç€æ ¸å¿ƒåè°ƒï¼ˆæ•°æ®ä¸­é©±ï¼‰è§’è‰²ï¼Œæœ¬è´¨ä¸Šæ˜¯æ•°æ®å±‚çš„ç»Ÿä¸€æŠ½è±¡ç½‘å…³ã€‚å…¶æ ¸å¿ƒä»·å€¼ä½“ç°åœ¨ä»¥ä¸‹æ–¹é¢ã€‚

#### 4.1 æ•°æ®æŠ½è±¡ä¸ç»Ÿä¸€å…¥å£

1ï¼‰â€Œ**éš”ç¦»æ•°æ®æºç»†èŠ‚**â€Œï¼šRepository ä½œä¸ºæ•°æ®è®¿é—®å±‚ï¼Œå°†ç½‘ç»œ APIã€æœ¬åœ°æ•°æ®åº“ï¼ˆå¦‚SQLiteï¼‰ã€ç¼“å­˜ï¼ˆå¦‚ Hiveï¼‰ç­‰æ•°æ®æºçš„å…·ä½“å®ç°ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦ã€‚ViewModel ä»…é€šè¿‡ Repository æä¾›çš„ç»Ÿä¸€æ¥å£è·å–æ•°æ®ï¼Œæ— éœ€å…³å¿ƒæ•°æ®æ¥è‡ª REST è¯·æ±‚è¿˜æ˜¯æœ¬åœ°å­˜å‚¨ã€‚

    abstract class UserRepository {
      Future<User> fetchUser(); // ç»Ÿä¸€æ¥å£
    }
    

2ï¼‰â€Œ**æ•°æ®è½¬æ¢ä¸æ ‡å‡†åŒ–**â€Œï¼šå°†åŸå§‹æ•°æ®ï¼ˆå¦‚ JSONï¼‰è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹ï¼ˆDomain Modelï¼‰ï¼Œç¡®ä¿ ViewModel æ¥æ”¶çš„æ˜¯å¯ç›´æ¥ä½¿ç”¨çš„ä¸šåŠ¡å®ä½“ï¼ˆEntityï¼‰ï¼Œè€ŒéåŸå§‹ API å“åº”ã€‚

    User _mapToEntity(UserDto dto) {
      return User(id: dto.id, name: dto.username);
    }
    

3ï¼‰**å¤šæ•°æ®æºåè°ƒå™¨**â€Œï¼šæ™ºèƒ½ç»„åˆè¿œç¨‹ä¸æœ¬åœ°æ•°æ®æºï¼Œå®ç°å¦‚ã€Œç¼“å­˜ä¼˜å…ˆã€ç­–ç•¥ï¼š

    Future<User> fetchUser() async {
      if (localDataSource.hasData) {
        return localDataSource.getUser();
      } else {
        final remoteUser = await api.getUser();
        await localDataSource.cache(remoteUser);
        return remoteUser;
      }
    }
    

#### 4.2 æ¶æ„ä¼˜åŠ¿ä¸è®¾è®¡ä»·å€¼

ä¸ºä½• MVVM éœ€è¦ Repository?

1ï¼‰â€Œ**é™ä½è€¦åˆæ€§ï¼Œæ‰“ç ´ ViewModel æ•°æ®è€¦åˆ**â€Œï¼šé€šè¿‡ Repository æ¨¡å¼ï¼Œæ•°æ®æºå˜æ›´ï¼ˆå¦‚åˆ‡æ¢ API æä¾›å•†ï¼‰åªéœ€ä¿®æ”¹ Repository å†…éƒ¨å®ç°ï¼Œæ— éœ€æ”¹åŠ¨ ViewModel æˆ– UI å±‚ä»£ç ã€‚ä¸åŠ  Repository æ—¶ï¼ŒViewModel ç›´æ¥å¯¹æ¥ API å¯¼è‡´ï¼š

*   ä¸šåŠ¡é€»è¾‘ä¸æ•°æ®è·å–å¼ºè€¦åˆï¼›
*   åˆ‡æ¢æ•°æ®æºéœ€ä¿®æ”¹ ViewModelï¼›

    // åä¾‹ï¼šViewModel ç›´æ¥è°ƒç”¨API
    class ProfileVM {
      final ApiService _api; // ç›´æ¥ä¾èµ–å…·ä½“å®ç°
      Future<void> loadData() => _api.getProfile();
    }
    

2ï¼‰â€Œ**ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶**â€Œï¼šRepository å¯é›†ä¸­å¤„ç†æ•°æ®å±‚å¼‚å¸¸ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶/è§£æé”™è¯¯ï¼‰ï¼Œé¿å… ViewModel é‡å¤å®ç°é”™è¯¯å¤„ç†ã€‚

3ï¼‰**å¢å¼ºå¯æµ‹è¯•æ€§ï¼Œæµ‹è¯•æ•ˆç‡å€å¢**â€Œï¼šViewModel æµ‹è¯•åªéœ€ Mock Repository æ¥å£ï¼Œæ— éœ€æ„å»ºçœŸå®ç½‘ç»œç¯å¢ƒã€‚å¯è½»æ¾æ›¿æ¢ä¸º Mock å®ç°ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•æ—¶æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚æˆ–æ•°æ®åº“æ“ä½œï¼š

    test('VMæµ‹è¯•', () {
      when(mockRepo.getUser()).thenReturn(mockUser);
      expect(viewModel.user, mockUser);
    });
    

4ï¼‰**é›†ä¸­ç®¡ç†æ•°æ®ç­–ç•¥ï¼š**â€Œåœ¨ Repository å†…éƒ¨å®ç°ç¼“å­˜é€»è¾‘ï¼ˆå¦‚â€œå…ˆæœ¬åœ°åç½‘ç»œâ€ï¼‰ã€æ•°æ®åˆå¹¶æˆ–é”™è¯¯é‡è¯•ç­‰å¤æ‚ç­–ç•¥ï¼Œç®€åŒ– ViewModel çš„èŒè´£ã€‚

#### 4.3 ä¸ ViewModel çš„åä½œæµç¨‹

â€Œ**å…¸å‹æ•°æ®æµ**â€Œï¼šViewModel è°ƒç”¨ Repository æ–¹æ³• â†’ Repository ä»æ•°æ®æºè·å–æ•°æ® â†’ è¿”å›æ ‡å‡†åŒ–æ¨¡å‹ â†’ ViewModel æ›´æ–°çŠ¶æ€å¹¶è§¦å‘ UI æ¸²æŸ“ã€‚ä»£ç ç¤ºä¾‹ï¼š

    class UserViewModel {
      final UserRepository repository;
      Future<void> loadUser() async {
        final user = await repository.fetchUser(); // é€šè¿‡Repositoryè·å–æ•°æ®
        // æ›´æ–°çŠ¶æ€...
      }
    }
    

â€Œ**é”™è¯¯å¤„ç†æ¡¥æ¢**â€Œï¼šRepository ç»Ÿä¸€æ•è·æ•°æ®æºå¼‚å¸¸ï¼ˆå¦‚ç½‘ç»œè¶…æ—¶ï¼‰ï¼Œè½¬æ¢ä¸ºä¸šåŠ¡å±‚å¯ç†è§£çš„é”™è¯¯ç±»å‹ï¼Œé¿å… ViewModel ç›´æ¥å¤„ç†åº•å±‚å¼‚å¸¸ã€‚

#### 4.4 å®é™…åº”ç”¨åœºæ™¯

*   â€Œ**å¤šæ•°æ®æºåè°ƒ**â€Œï¼šåˆå¹¶ API å“åº”ä¸æœ¬åœ°æ•°æ®åº“æ•°æ®ã€‚
*   â€Œ**ç¦»çº¿ä¼˜å…ˆç­–ç•¥**â€Œï¼šä¼˜å…ˆè¿”å›ç¼“å­˜æ•°æ®ï¼Œåå°åŒæ­¥æœ€æ–°å†…å®¹ã€‚
*   â€Œ**æƒé™ç®¡ç†**â€Œï¼šåœ¨ Repository å±‚å¤„ç†è®¤è¯ä»¤ç‰Œçš„åˆ·æ–°ä¸æ³¨å…¥ã€‚

### â€Œ5. ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ä¸è¿è¡Œæ—¶ç»‘å®šçš„å®ç°åŸç†

#### 5.1 æ ¸å¿ƒæ¦‚å¿µï¼šä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰â€Œ

*   â€Œ**æŠ½è±¡æ¥å£ï¼ˆ`UserRepository`ï¼‰**â€Œï¼šä¸šåŠ¡å±‚ä»…ä¾èµ–æŠ½è±¡ï¼Œä¸å…³å¿ƒå…·ä½“å®ç°ï¼ˆå¦‚ `UserRepositoryImpl`ï¼‰ã€‚
*   â€Œ**å®ç°ç±»ï¼ˆ`UserRepositoryImpl`ï¼‰**â€Œï¼šæ•°æ®å±‚é€šè¿‡å®ç°æ¥å£æä¾›å…·ä½“åŠŸèƒ½ï¼Œä½†ä¸šåŠ¡å±‚æ— éœ€ç›´æ¥å¼•ç”¨å®ƒã€‚

#### â€Œ5.2 ä¾èµ–æ³¨å…¥çš„ç»‘å®šè¿‡ç¨‹â€Œ

##### â€Œ**æ­¥éª¤1ï¼šå®šä¹‰æŠ½è±¡ä¸å®ç°**â€Œ

    // æŠ½è±¡æ¥å£ï¼ˆä¸šåŠ¡å±‚ï¼‰
    abstract class UserRepository { ... }
    
    // å®ç°ç±»ï¼ˆæ•°æ®å±‚ï¼‰
    class UserRepositoryImpl implements UserRepository { ... }
    

##### â€Œ**æ­¥éª¤2ï¼šä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆDI Containerï¼‰çš„é…ç½®**â€Œ

åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼ˆå¦‚ `get_it`ã€`injectable`ï¼‰æ³¨å†Œç»‘å®šå…³ç³»ï¼š

    // ç¤ºä¾‹ï¼šä½¿ç”¨ get_it æ³¨å†Œä¾èµ–
    final getIt = GetIt.instance;
    
    void setupDependencies() {
      // æ³¨å†Œæ¥å£ä¸å®ç°çš„ç»‘å®šå…³ç³»
      getIt.registerSingleton<UserRepository>(UserRepositoryImpl(apiService));
      
      // æ³¨å†Œ UseCaseï¼Œè‡ªåŠ¨æ³¨å…¥ UserRepositoryImpl å®ä¾‹
      getIt.registerFactory(() => GetUserByIdUseCase(getIt<UserRepository>()));
    }
    

##### â€Œ**æ­¥éª¤3ï¼šè¿è¡Œæ—¶è§£æä¾èµ–**â€Œ

å½“ `GetUserByIdUseCase` è¢«å®ä¾‹åŒ–æ—¶ï¼š

1.  DI å®¹å™¨æ£€æµ‹å…¶æ„é€ å‡½æ•°éœ€è¦ `UserRepository` ç±»å‹å‚æ•°ï¼›
2.  æ ¹æ®æ³¨å†Œçš„ç»‘å®šå…³ç³»ï¼Œè‡ªåŠ¨æä¾› `UserRepositoryImpl` çš„å®ä¾‹ã€‚

#### â€Œ5.3 å…³é”®ç‚¹è§£æâ€Œ

*   â€Œ**è¿è¡Œæ—¶åŠ¨æ€ç»‘å®š**â€Œï¼šå®é™…ä¼ å…¥çš„ `UserRepositoryImpl` å®ä¾‹æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶ç”± DI å®¹å™¨åŠ¨æ€è§£æçš„ï¼Œè€Œéç¼–ç æ—¶ç¡¬ä¾èµ–ã€‚
*   â€Œ**è§£è€¦ä¼˜åŠ¿**â€Œï¼šä¸šåŠ¡å±‚ï¼ˆ`GetUserByIdUseCase`ï¼‰ä»…ä¾èµ–æ¥å£ï¼Œæ›´æ¢æ•°æ®æºï¼ˆå¦‚ä» API æ”¹ä¸ºæœ¬åœ°æ•°æ®åº“ï¼‰åªéœ€ä¿®æ”¹å®ç°ç±»ï¼Œæ— éœ€æ”¹åŠ¨ä¸šåŠ¡ä»£ç ã€‚

#### â€Œ5.4 ä»£ç æ‰§è¡Œæµç¨‹ç¤ºä¾‹

    void main() {
      // åˆå§‹åŒ– DI å®¹å™¨
      setupDependencies();
      
      // è·å– UseCase å®ä¾‹ï¼ˆè‡ªåŠ¨æ³¨å…¥ UserRepositoryImplï¼‰
      final useCase = getIt<GetUserByIdUseCase>();
      useCase.execute("123"); // å®é™…è°ƒç”¨ UserRepositoryImpl çš„æ–¹æ³•
    }
    

#### 5.5 æ€»ç»“â€Œ

**å¦‚ä½•åšåˆ°**â€Œï¼šé€šè¿‡ DI å®¹å™¨åœ¨è¿è¡Œæ—¶å°†æ¥å£ä¸å®ç°ç»‘å®šï¼Œä¸šåŠ¡å±‚é€šè¿‡æ„é€ å‡½æ•°å£°æ˜ä¾èµ–æ¥å£ï¼Œå®¹å™¨è‡ªåŠ¨æ³¨å…¥å…·ä½“å®ç°ã€‚

**æ ¸å¿ƒä»·å€¼**â€Œï¼šå®ç°å±‚é—´è§£è€¦ï¼Œæå‡ä»£ç å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

å¦‚éœ€è¿›ä¸€æ­¥äº†è§£å…·ä½“ DI æ¡†æ¶çš„ä½¿ç”¨ï¼Œå¯å‚è€ƒ `get_it` æˆ– `injectable` çš„å®˜æ–¹æ–‡æ¡£ã€‚

### 6\. ViewModel é›†ä¸­æ³¨å†Œé—®é¢˜

åœ¨ Flutter ä¸­ä½¿ç”¨ MVVM + repository æ¶æ„æ—¶ï¼Œç¡®å®ä¸éœ€è¦å°†æ‰€æœ‰ ViewModel éƒ½åœ¨ main å‡½æ•°ä¸­é€šè¿‡ MultiProvider é›†ä¸­æ³¨å†Œã€‚ä»¥ä¸‹æ˜¯å‡ ç§ä¼˜åŒ–æ–¹æ¡ˆï¼Œå¯ä»¥é¿å… main å‡½æ•°è‡ƒè‚¿å¹¶å®ç°æŒ‰éœ€æ³¨å†Œï¼Œå‰é¢æåˆ°äº†ä¸€äº›å®ç”¨è§„åˆ™ï¼Œåœ¨å…·ä½“é¡µé¢å±€éƒ¨æ³¨å†Œä¸šåŠ¡é€»è¾‘ç±»ï¼ˆå¦‚ `LoginViewModel`ï¼‰ï¼Œåº”è¯¥åªåœ¨ `main.dart` å…¨å±€æ³¨å†ŒåŸºç¡€æœåŠ¡ï¼ˆå¦‚ `NetworkService`ï¼‰ã€‚

#### 6.1 â€ŒGetIt å·¥å‚æ¨¡å¼ + Provider åŠ¨æ€æ³¨å†Œâ€Œ

ç»“åˆ GetIt çš„å·¥å‚æ¨¡å¼æ³¨å†Œå’Œ Provider çš„æŒ‰éœ€ä½¿ç”¨ï¼Œå¯ä»¥é¿å…åœ¨ main ä¸­é¢„æ³¨å†Œæ‰€æœ‰ ViewModelï¼š

    // injection_container.dart
    void setupViewModelDependencies() {
      getIt.registerFactory<UserViewModel>(
        () => UserViewModel(getIt<GetUserByIdUseCase>())
      );
      // å…¶ä»–ViewModelåŒç†
    }
    
    // é¡µé¢ä¸­ä½¿ç”¨æ—¶åŠ¨æ€è·å–
    final viewModel = Provider.of<UserViewModel>(
      context,
      listen: false,
      create: (_) => getIt<UserViewModel>(), // ä»GetItå·¥å‚åˆ›å»º
    );
    

#### 6.2 â€Œæ‡’åŠ è½½ Providerâ€Œ

é€šè¿‡ `ProxyProvider` æˆ– `ChangeNotifierProxyProvider` å®ç° ViewModel çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼š

    // main.dartä¸­ä»…æ³¨å†ŒåŸºç¡€æœåŠ¡
    void main() {
      runApp(
        MultiProvider(
          providers: [
            Provider(create: (_) => Dio()),
            Provider(create: (_) => UserApiService(getIt<Dio>())),
          ],
          child: MyApp(),
        ),
      );
    }
    
    // é¡µé¢ä¸­æŒ‰éœ€ç»„åˆ ViewModel
    Provider(
      create: (context) => UserViewModel(
        GetUserByIdUseCase(
          UserRepositoryImpl(
            context.read<UserApiService>()
          )
        )
      ),
      child: Consumer<UserViewModel>(...),
    )
    

#### 6.3 â€Œè·¯ç”±çº§ Provider æ³¨å†Œ

ä½¿ç”¨ `onGenerateRoute` åœ¨è·¯ç”±è·³è½¬æ—¶åŠ¨æ€æ³¨å†Œï¼š

    MaterialApp(
      onGenerateRoute: (settings) {
        return MaterialPageRoute(
          builder: (context) {
            return Provider(
              create: (_) => getIt<UserViewModel>(), // æˆ–ç›´æ¥æ„é€ 
              child: const HomePage(),
            );
          },
        );
      },
    )
    

#### 6.4 æ–¹æ¡ˆå¯¹æ¯”

æ–¹æ¡ˆ

ä¼˜ç‚¹

ç¼ºç‚¹

é€‚ç”¨åœºæ™¯

GetIt+Provider

è§£è€¦æ³¨å†Œä¸ä½¿ç”¨ï¼Œæ”¯æŒå…¨å±€å•ä¾‹

éœ€ç»´æŠ¤GetItå®¹å™¨

ä¸­å¤§å‹é¡¹ç›®

æ‡’åŠ è½½ProxyProvider

ä¾èµ–å…³ç³»æ¸…æ™°

åµŒå¥—å¯èƒ½è¾ƒæ·±

ä¾èµ–é“¾å¤æ‚çš„åœºæ™¯

è·¯ç”±çº§æ³¨å†Œ

ç²¾ç¡®æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ

éœ€æ‰‹åŠ¨ç®¡ç†è·¯ç”±

é¡µé¢ç‹¬ç«‹æ€§å¼ºçš„åº”ç”¨

æœ€ä½³å®è·µå»ºè®®ï¼š

â€Œ**æ ¸å¿ƒæœåŠ¡**â€Œï¼ˆå¦‚API Clientã€æ•°æ®åº“ï¼‰ä»åœ¨ main ä¸­æ³¨å†Œã€‚

**é¡µé¢çº§ ViewModel**â€Œ é€šè¿‡ GetIt å·¥å‚æˆ–è·¯ç”±åŠ¨æ€åˆ›å»ºã€‚

ä½¿ç”¨ `context.read()` æ›¿ä»£ `Provider.of` å‡å°‘ä¸å¿…è¦çš„ rebuildã€‚

é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œå¯ä»¥ä¿æŒ main å‡½æ•°ç®€æ´ï¼ŒåŒæ—¶äº«å— MVVM æ¶æ„çš„æ¸…æ™°åˆ†å±‚ä¼˜åŠ¿ã€‚

åä¸€. åç»­
------

ç‰©ä¸å°½ç¾ï¼Œäº‹æ— ä¸‡å…¨ã€‚æˆ‘å¾ˆæ¸…æ¥šï¼Œä¸Šé¢æåˆ°çš„å¾ˆå¤šç»†èŠ‚æ–¹é¢å­˜åœ¨ä¸€äº›ä¸è¶³ï¼Œä½†ä½œä¸ºä¸€ç¯‡å¯å‚è€ƒæŠ€æœ¯æ–‡æ¡£ï¼Œè¿˜æ˜¯ç›´æ¥å€Ÿé‰´å’Œ star çš„ã€‚æˆ‘åœ¨åé¢é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹æ¶æ„ï¼ˆæ–‡ç« å’Œæ¶æ„ä»£ç ï¼‰è¿›ä¸€æ­¥åœ¨å®è·µä¸­åšä¸æ–­çš„ä¼˜åŒ–ï¼Œä»£ç é“¾æ¥åç»­å†æ”¾å‡ºæ¥ï¼Œ Thanks è§‚çœ‹ã€‚