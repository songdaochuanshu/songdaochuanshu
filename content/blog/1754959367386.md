---
layout: post
title: 'ã€æ¸²æŸ“æµæ°´çº¿ã€‘[åº”ç”¨é˜¶æ®µ]-[æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—]ä»¥UnityURPä¸ºä¾‹'
date: "2025-08-12T00:42:47Z"
---
ã€æ¸²æŸ“æµæ°´çº¿ã€‘\[åº”ç”¨é˜¶æ®µ\]-\[æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—\]ä»¥UnityURPä¸ºä¾‹
=====================================

![ã€æ¸²æŸ“æµæ°´çº¿ã€‘[åº”ç”¨é˜¶æ®µ]-[æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—]ä»¥UnityURPä¸ºä¾‹](https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250811111444989-385893265.png) æœ¬æ–‡ä»¥Unity URPæ¸²æŸ“ç®¡çº¿ä¸ºä¾‹ï¼Œè¯¦ç»†è§£æäº†ä»æ•°æ®åˆ°å›¾åƒçš„æ¸²æŸ“æµç¨‹ã€‚å†…å®¹æ¶µç›–æ¨¡å‹æ•°æ®è·å–ï¼ˆé¡¶ç‚¹åæ ‡ã€æ³•çº¿ç­‰ï¼‰ã€å˜æ¢çŸ©é˜µè®¡ç®—ï¼ˆMVPçŸ©é˜µï¼‰ã€æ¸²æŸ“çŠ¶æ€è®¾ç½®ï¼ˆå‰”é™¤ã€æ·±åº¦æµ‹è¯•ç­‰ï¼‰å’Œæ¸²æŸ“æŒ‡ä»¤æäº¤ï¼ˆDrawCallï¼‰ç­‰å…³é”®ç¯èŠ‚ã€‚æ–‡ç« æ·±å…¥åˆ†æäº†URPä¸­æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—çš„å®ç°æœºåˆ¶ï¼ŒåŒ…æ‹¬ScriptableRenderContextå’ŒCommandBufferçš„ä½¿ç”¨ï¼Œä»¥åŠShaderLabé…ç½®çŠ¶æ€çš„è§£æä¸å¤„ç†æµç¨‹ã€‚åŒæ—¶æä¾›äº†åŠ¨æ€ä¿®æ”¹æ¸²æŸ“çŠ¶æ€çš„ä»£ç ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£URPæ¸²æŸ“ç®¡çº¿çš„åº•å±‚å®ç°åŸç†å’Œä¼˜åŒ–æ–¹æ³•ã€‚

åº”ç”¨é˜¶æ®µæœ€åæ˜¯CPUå‘GPUæäº¤éœ€è¦æ¸²æŸ“çš„æ•°æ®ã€‚é€šå¸¸æ•°æ®ä¼šè¢«å¤åˆ¶åˆ°æ˜¾å­˜ä¸­ï¼Œç„¶åè®¾ç½®æ¸²æŸ“å‚æ•°ï¼Œæœ€åè°ƒç”¨æ¸²æŸ“æ¥å£ã€‚PCä¸­æ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯ç§»åŠ¨è®¾å¤‡ä¸€èˆ¬æ²¡æœ‰å•ç‹¬çš„æ˜¾å­˜ã€‚ä½¿ç”¨å†…å­˜ä¸ºGPUæœåŠ¡ã€‚ä»–ä»¬ä½¿ç”¨åŒä¸€å†…å­˜åœ°å€ã€‚é™¤éè¦è¯»/å†™è¿™æ®µå†…å­˜å†…å®¹æ‰ä¼šå¤åˆ¶å‡ºä¸€ä»½è°ƒæ•´CPUå’ŒGPUä¹‹é—´åä½œã€‚

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

**æ¸²æŸ“çŠ¶æ€**ï¼š
=========

*   ä¸€è¿ä¸²å¼€å…³æˆ–æ–¹æ³•ï¼Œä»¥åŠæ–¹æ³•çš„åœ°å€æŒ‡å‘ï¼ˆé˜¶æ®µä¸­çš„å„ç§å¯é…ç½®çš„é˜¶æ®µç­‰éƒ½æ˜¯åœ¨è¿™é‡Œï¼‰ã€‚SetPassCallã€‚ä¾‹å¦‚æ˜¯å¦å¼€å¯æ··åˆã€ç”¨å“ªä¸ªçº¹ç†ã€å“ªä¸ªé¡¶ç‚¹ç€è‰²å™¨ã€æ˜¯å¦èƒŒé¢å‰”é™¤ç­‰ï¼Œåœ¨Unityä¸­åˆ™æ˜¯ShaderLabè¯­æ³•è§„åˆ™ä¸­è§„å®šçš„å„ç§æ ‡ç­¾ã€‚

**æ¸²æŸ“æŒ‡ä»¤**ï¼š
=========

*   è°ƒç”¨å…·ä½“æ¸²æŸ“çš„å¯¹è±¡ã€‚drawcallæ˜¯ä¸€ä¸ªæ¸²æŸ“æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤ä»…æŒ‡å‘ä¸€è¿ä¸²å›¾å…ƒï¼ˆç‚¹çº¿é¢ ç½‘æ ¼æ‹†åˆ†åçš„çŠ¶æ€ï¼‰ï¼Œå¹¶ä¸ä¼šåŒ…å«ä»»ä½•å…¶ä»–æè´¨ä¿¡æ¯ã€‚æ¯ä¸ªçŠ¶æ€å‰éƒ½ä¼´éšç€ä¸€è¿ä¸²æ¸²æŸ“çŠ¶æ€è®¾ç½®ï¼Œæ‰€ä»¥æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—ä¸­ï¼Œæ¸²æŸ“çŠ¶æ€å’Œæ¸²æŸ“æŒ‡ä»¤æ˜¯äº¤æ›¿å‡ºç°ã€‚

**æ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—**ï¼š
===========

*   å…¶ä¸­åŒ…å«æ¸²æŸ“çŠ¶æ€ã€æ¸²æŸ“æŒ‡ä»¤çš„ç¼“å†²åŒºã€‚CPUå‘ç¼“å†²åŒºæ”¾å…¥æŒ‡ä»¤ï¼ŒGPUæ‰§è¡ŒæŒ‡ä»¤ã€‚CPUå‘é€æ¸²æŸ“çŠ¶æ€åï¼ŒCPUéœ€è¦æ§åˆ¶æ€»çº¿å°†æ•°æ®ä»å†…å­˜æ¬è¿åˆ°æ˜¾å­˜ï¼Œæ¬è¿è¿‡ç¨‹è€—è´¹å¤§é‡æ—¶é—´ã€‚drawcallå¤šäº†åä¼šå¯¼è‡´å¤§é‡å†…å­˜æ¬è¿ï¼Œè¿è¡Œé€Ÿåº¦ä¸‹é™ã€‚

æ‰“åŒ…æ•°æ®
====

**æ¨¡å‹ä¿¡æ¯**
--------

æ¨¡å‹æ•°æ®ä¸»è¦ä»ç½‘æ ¼èµ„æºï¼ˆMeshï¼‰ä¸­è·å–ï¼ŒåŒ…å«ä»¥ä¸‹æ ¸å¿ƒå±æ€§ï¼š

1.  â€Œ**é¡¶ç‚¹åæ ‡**â€Œæè¿°æ¨¡å‹å±€éƒ¨ç©ºé—´çš„é¡¶ç‚¹ä½ç½®åæ ‡ï¼ˆx, y, zï¼‰ã€‚
2.  â€Œ**æ³•çº¿ä¿¡æ¯**â€Œå®šä¹‰é¡¶ç‚¹æœå‘ï¼Œç”¨äºå…‰ç…§è®¡ç®—å’Œè¡¨é¢å¹³æ»‘åº¦ã€‚
3.  â€Œ**UVä¿¡æ¯**â€ŒäºŒç»´çº¹ç†æ˜ å°„åæ ‡ï¼ˆu, vï¼‰ï¼ŒèŒƒå›´\[0,1\]ï¼Œæ§åˆ¶è´´å›¾åœ¨æ¨¡å‹è¡¨é¢çš„åˆ†å¸ƒã€‚
4.  â€Œ**åˆ‡çº¿å‘é‡**â€Œä¸æ³•çº¿é…åˆæ„å»ºåˆ‡çº¿ç©ºé—´ï¼Œç”¨äºæ³•çº¿è´´å›¾ç­‰é«˜çº§æ¸²æŸ“æ•ˆæœã€‚
5.  â€Œ**é¡¶ç‚¹é¢œè‰²**â€Œå­˜å‚¨é€é¡¶ç‚¹é¢œè‰²å€¼ï¼Œå¯ç”¨äºç‰¹æ®Šç€è‰²æ•ˆæœã€‚
6.  â€Œ**ç´¢å¼•åˆ—è¡¨**â€Œå®šä¹‰é¡¶ç‚¹è¿æ¥é¡ºåºï¼Œä¼˜åŒ–ç»˜åˆ¶æ•ˆç‡ï¼ˆå‡å°‘é‡å¤é¡¶ç‚¹ï¼‰

*   â€Œ**æ•°æ®æ¥æº**â€Œï¼š
    *   ç”±å»ºæ¨¡å·¥å…·ï¼ˆå¦‚Blender/Mayaï¼‰å¯¼å‡ºæ—¶ç”Ÿæˆï¼Œéšæ¨¡å‹æ–‡ä»¶ï¼ˆ.fbx/.objï¼‰å¯¼å…¥Unityã€‚
        
    *   ç¨‹åºåŒ–ç½‘æ ¼é€šè¿‡`Mesh`ç±»APIåŠ¨æ€è®¾ç½®ï¼ˆå¦‚`mesh.vertices`,Â `mesh.uv`ï¼‰
        
    *   **å˜æ¢çŸ©é˜µ**
        
        çŸ©é˜µæ•°æ®ç”±CPUè®¡ç®—å¹¶ä¼ é€’ç»™GPUï¼š
        
        *   â€Œ**æ¨¡å‹çŸ©é˜µ Model Matrixï¼ˆMï¼‰** â€Œæ¨¡å‹å±€éƒ¨åæ ‡â†’ä¸–ç•Œåæ ‡ï¼Œç”±ç‰©ä½“çš„`Transform`ç»„ä»¶ï¼ˆä½ç½®/æ—‹è½¬/ç¼©æ”¾ï¼‰è®¡ç®—å¾—å‡ºã€‚
            *   è®¡ç®—é¡ºåºï¼šç¼©æ”¾ â†’ æ—‹è½¬ â†’ å¹³ç§»ï¼ˆSRTï¼‰
        *   â€Œ**è§†å›¾çŸ©é˜µ View Matrixï¼ˆVï¼‰** â€Œä¸–ç•Œåæ ‡â†’æ‘„åƒæœºåæ ‡ï¼ŒåŸºäº`Camera`ç»„ä»¶çš„ä½å§¿ï¼ˆä½ç½®/æœå‘/ä¸Šæ–¹å‘ï¼‰ç”Ÿæˆã€‚
            *   è®¡ç®—åŸç†ï¼šå…ˆé€†å¹³ç§»ï¼ˆæ‘„åƒæœºåˆ°åŸç‚¹ï¼‰ï¼Œå†é€†æ—‹è½¬ï¼ˆå¯¹é½åæ ‡è½´ï¼‰
        *   â€Œ**æŠ•å½±çŸ©é˜µ Projection Matrixï¼ˆPï¼‰** â€Œæ‘„åƒæœºåæ ‡â†’é½æ¬¡è£å‰ªåæ ‡ï¼Œé€šè¿‡ç›¸æœºå‚æ•°è®¡ç®—ï¼š
            *   å‚æ•°æ¥æºï¼šFOVã€è¿‘/è¿œè£å‰ªé¢ã€å®½é«˜æ¯”
            *   é€è§†æŠ•å½±ï¼ˆè¿‘å¤§è¿œå°ï¼‰æˆ–æ­£äº¤æŠ•å½±ï¼ˆç­‰æ¯”ä¾‹ç¼©æ”¾ï¼‰
            *   `Field of View (FOV)`ï¼šè§†è§’èŒƒå›´
            *   `Near/Far Clipping Planes`ï¼šè¿‘è¿œè£å‰ªå¹³é¢
            *   `Aspect Ratio`ï¼šå±å¹•å®½é«˜æ¯”ã€‚
        *   â€Œ**MVPçŸ©é˜µ**â€Œæœ€ç»ˆå˜æ¢çŸ©é˜µï¼š`MVP = P Ã— V Ã— M`
        *   **è®¡ç®—ä¸»ä½“ä¸å­˜å‚¨ä½ç½®**
            
            çŸ©é˜µç±»å‹
            
            è®¡ç®—è€…
            
            å­˜å‚¨ä½ç½®ï¼ˆGPUç«¯ï¼‰
            
            è®¿é—®æ–¹å¼ï¼ˆShaderï¼‰
            
            â€Œ**æ¨¡å‹çŸ©é˜µ (M)** â€Œ
            
            Transformç»„ä»¶ (CPUè®¡ç®—)
            
            `unity_ObjectToWorld`
            
            `UNITY_MATRIX_M`
            
            â€Œ**è§†å›¾çŸ©é˜µ (V)** â€Œ
            
            æ‘„åƒæœºç»„ä»¶ (CPUè®¡ç®—)
            
            `unity_MatrixV`
            
            `UNITY_MATRIX_V`
            
            â€Œ**æŠ•å½±çŸ©é˜µ (P)** â€Œ
            
            æ‘„åƒæœºæŠ•å½±å‚æ•° (CPUè®¡ç®—)
            
            `unity_MatrixP`
            
            `UNITY_MATRIX_P`
            
            â€Œ**MVPçŸ©é˜µ** â€Œ
            
            Shaderè¿è¡Œæ—¶ç»„åˆ
            
            æ— ç‹¬ç«‹å­˜å‚¨
            
            `mul(UNITY_MATRIX_VP, mul(UNITY_MATRIX_M, pos))`
            
        *   **è®¡ç®—æ—¶æœº**
            *   CPUç«¯ï¼šæ¯å¸§æ¸²æŸ“å‰æ›´æ–°ï¼ˆç‰©ä½“Transformæˆ–æ‘„åƒæœºç§»åŠ¨æ—¶ï¼‰ã€‚
            *   GPUç«¯ï¼šé€šè¿‡`UNITY_MATRIX_VP`ï¼ˆè§†å›¾æŠ•å½±çŸ©é˜µï¼‰ä¸`UNITY_MATRIX_M`ï¼ˆæ¨¡å‹çŸ©é˜µï¼‰åœ¨é¡¶ç‚¹ç€è‰²å™¨åŠ¨æ€ç»„åˆ
        *   **ä¼˜åŒ–æœºåˆ¶**
            *   URPé¢„è®¡ç®—`VPçŸ©é˜µ`ï¼ˆè§†å›¾æŠ•å½±è”åˆçŸ©é˜µï¼‰ï¼Œå‡å°‘GPUè®¡ç®—é‡ã€‚
                
            *   ä½¿ç”¨`UnityObjectToClipPos`å†…ç½®å‡½æ•°ç›´æ¥å®ŒæˆMVPå˜æ¢ï¼š
                
                    hlsl
                    float4 clipPos = UnityObjectToClipPos(v.vertex); // å†…éƒ¨å®ç°ï¼šmul(UNITY_MATRIX_VP, mul(UNITY_MATRIX_M, v.vertex))
                    
                

**ç¯å…‰ã€æè´¨å‚æ•°**
-----------

*   **ç¯å…‰å‚æ•°**â€Œ
    *   â€Œ**å…‰æºå±æ€§**â€Œï¼šä½ç½®ã€é¢œè‰²ã€å¼ºåº¦ã€è¡°å‡ç­‰ï¼Œæºè‡ªåœºæ™¯ä¸­çš„`Light`ç»„ä»¶ã€‚
    *   â€Œ**é˜´å½±å‚æ•°**â€Œï¼šé˜´å½±å¼ºåº¦ã€åˆ†è¾¨ç‡ï¼Œé€šè¿‡URPå…‰æºè®¾ç½®ï¼ˆå¦‚`UniversalAdditionalLightData`ï¼‰é…ç½®ã€‚
*   â€Œ**æè´¨æ•°æ®**â€Œ
    *   â€Œ**Shaderä¸æè´¨å±æ€§**â€Œï¼šæ¼«åå°„é¢œè‰²ã€é«˜å…‰å¼ºåº¦ç­‰ï¼Œç”±`Material`å®ä¾‹å®šä¹‰ã€‚
    *   â€Œ**çº¹ç†è´´å›¾**â€Œï¼šé€šè¿‡æè´¨ç»‘å®šï¼ˆå¦‚`_MainTex`ï¼‰ï¼Œä»çº¹ç†èµ„æºåŠ è½½ã€‚

â€Œ**æ•°æ®ä¼ é€’æµç¨‹**â€Œï¼š
-------------

åº”ç”¨é˜¶æ®µé€šè¿‡`SetPassCall`è®¾ç½®æ¸²æŸ“çŠ¶æ€ï¼ˆShader/æè´¨ï¼‰ï¼Œå¹¶é€šè¿‡`DrawCall`æäº¤å›¾å…ƒåˆ—è¡¨

**Batch**ï¼š
==========

*   æŠŠæ•°æ®åŠ è½½åˆ°æ˜¾å­˜ï¼Œè®¾ç½®æ¸²æŸ“çŠ¶æ€ï¼ŒCPUè°ƒç”¨GPUæ¸²æŸ“çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ªBatchã€‚

**Unity URPæ¸²æŸ“ç®¡çº¿ä¸­çš„æ¸²æŸ“çŠ¶æ€å’Œæ¸²æŸ“å‘½ä»¤çš„å®ç°**
===============================

**ä¸€ã€â€Œæ¸²æŸ“çŠ¶æ€è®¾ç½®ï¼ˆSetPassCallï¼‰â€Œ**
---------------------------

*   â€Œ**ScriptableRendererç±»**
    
    *   ä½äº`UniversalRenderer.cs`ä¸­ï¼Œè´Ÿè´£ç®¡ç†URPçš„é»˜è®¤æ¸²æŸ“æµç¨‹ã€‚
    *   è°ƒç”¨`EnqueuePass`æ–¹æ³•å°†æ¸²æŸ“Passï¼ˆå¦‚`DrawObjectsPass`ï¼‰åŠ å…¥é˜Ÿåˆ—ã€‚
*   â€Œ**CommandBufferç±»**â€Œ
    
    *   é€šè¿‡`CommandBufferPool.Get`è·å–å®ä¾‹ï¼Œå½•åˆ¶æ¸²æŸ“æŒ‡ä»¤ã€‚
    *   å…³é”®æ–¹æ³•ï¼š
        
            csharp
            cmd.SetRenderTarget()// ç»‘å®šæ¸²æŸ“ç›®æ ‡
            cmd.SetGlobalTexture()// è®¾ç½®å…¨å±€çº¹ç†
            cmd.SetViewProjectionMatrices()// è®¾ç½®VPçŸ©é˜µ
            
        
*   â€Œ**Materialä¸Shader**â€Œ
    
    *   æè´¨çŠ¶æ€é€šè¿‡`Material.SetPass`æ–¹æ³•è®¾ç½®ï¼Œè§¦å‘åº•å±‚`SetPassCall`ã€‚
    *   URPé€šè¿‡`ShaderData`ç±»ç®¡ç†ç€è‰²å™¨å˜ä½“ï¼ˆVariantï¼‰çš„åˆ‡æ¢ã€‚

* * *

**äºŒã€â€Œå›¾å…ƒæäº¤ï¼ˆDrawCallï¼‰â€Œ**
----------------------

*   â€Œ**ScriptableRenderContextç±»**â€Œ
    
    *   æ ¸å¿ƒæ–¹æ³•`Submit`æäº¤æ‰€æœ‰å½•åˆ¶çš„`CommandBuffer`åˆ°GPUã€‚
        
    *   è°ƒç”¨é“¾ï¼š
        
            csharp
            context.ExecuteCommandBuffer(cmd);// æ‰§è¡ŒæŒ‡ä»¤
            context.DrawRenderers()// è§¦å‘DrawCall
            
        
*   â€Œ**DrawingSettingsä¸FilteringSettings**â€Œ
    
    *   åœ¨`DrawObjectsPass.Execute`ä¸­é…ç½®ï¼š
        
            csharp
            var drawSettings = new DrawingSettings(...);// æŒ‡å®šShader Passå’Œæ’åºvar filterSettings = new FilteringSettings(...);// è®¾ç½®æ¸²æŸ“é˜Ÿåˆ—å’Œå±‚çº§
            context.DrawRenderers(...);// æœ€ç»ˆæäº¤
            
        
*   â€Œ**Graphics.DrawMesh**â€Œ
    
    *   ç›´æ¥æäº¤ç½‘æ ¼æ•°æ®çš„å¤‡é€‰APIï¼Œç»•è¿‡URPæµç¨‹ä½†æ•ˆç‡è¾ƒä½ã€‚

* * *

**ä¸‰ã€å…³é”®è„šæœ¬ä½ç½®**
------------

åŠŸèƒ½

è„šæœ¬æ–‡ä»¶

æ ¸å¿ƒæ–¹æ³•

â€Œ**æ¸²æŸ“æµç¨‹æ§åˆ¶**â€Œ

`UniversalRenderer.cs`

`AddRenderPasses`,Â `Execute`

â€Œ**æŒ‡ä»¤å½•åˆ¶**â€Œ

`CommandBuffer.cs`

`Clear`,Â `DrawMesh`,Â `Blit`

â€Œ**æè´¨çŠ¶æ€ç®¡ç†**â€Œ

`Material.cs`

`SetPass`,Â `SetShaderPassEnabled`

â€Œ**æ•°æ®æäº¤**â€Œ

`ScriptableRenderContext.cs`

`Submit`,Â `DrawRenderers`

* * *

**å››ã€æ‰§è¡Œæµç¨‹ç¤ºä¾‹**
------------

    csharp
    // åœ¨ScriptableRenderPassä¸­å®ç°
    public override void Execute(ScriptableRenderContext context, ref RenderingData data) {
        CommandBuffer cmd = CommandBufferPool.Get("CustomPass");
        cmd.SetRenderTarget(...);// SetPassCall
        cmd.DrawMesh(...);// DrawCall
        context.ExecuteCommandBuffer(cmd);
        CommandBufferPool.Release(cmd);
    }
    

**Unity URPæ¸²æŸ“ç®¡çº¿ä¸­çš„åº”ç”¨é˜¶æ®µæ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—åŠæ¸²æŸ“é˜Ÿåˆ—å®ç°**
====================================

åœ¨Unity URPæ¸²æŸ“ç®¡çº¿çš„åº”ç”¨é˜¶æ®µï¼Œæ¸²æŸ“å‘½ä»¤é˜Ÿåˆ—åŒ…å«ä¸€ç³»åˆ—å›¾å½¢å‘½ä»¤ï¼Œä¸»è¦ç”¨äºè°ƒåº¦å’Œæ‰§â¾æ¸²æŸ“æ“ä½œï¼Œä¾‹å¦‚æ¸…é™¤ç¼“å†²åŒºã€ç»˜åˆ¶å‡ ä½•ä½“ã€è®¾ç½®æè´¨å’Œç€è‰²å™¨å‚æ•°ã€å¤„ç†å…‰æºé˜´å½±ï¼Œä»¥åŠæ‰§è¡Œåå¤„ç†æ•ˆæœã€‚

è¿™äº›å‘½ä»¤é€šè¿‡`ScriptableRenderContext`æ¥å£è¿›è¡Œç®¡ç†ï¼Œè¯¥æ¥å£ä½œä¸ºC#ä»£ç ä¸Unityåº•å±‚å›¾å½¢å¼•æ“çš„æ¡¥æ¢ï¼Œç¡®ä¿å‘½ä»¤æŒ‰åºåˆ—åŒ–é¡ºåºæäº¤GPUå¤„ç†ã€‚é˜Ÿåˆ—å†…å®¹åŒ…æ‹¬ï¼š

*   ç¼“å†²åŒºæ¸…é™¤å‘½ä»¤ï¼ˆå¦‚é¢œè‰²ç¼“å†²å’Œæ·±åº¦ç¼“å†²ï¼‰ã€‚
*   å‡ ä½•ä½“ç»˜åˆ¶å‘½ä»¤ï¼ˆè°ƒç”¨`DrawMesh`æˆ–`DrawProcedural`ï¼‰ã€‚
*   çŠ¶æ€è®¾ç½®å‘½ä»¤ï¼ˆå¦‚è®¾ç½®è§†å£ã€æ··åˆæ¨¡å¼ï¼‰ã€‚
*   é˜´å½±è´´å›¾ç”Ÿæˆå‘½ä»¤ï¼ˆé’ˆå¯¹åŠ¨æ€å…‰æºï¼‰ã€‚
*   åå¤„ç†Passï¼ˆå¦‚æŠ—é”¯é½¿æˆ–æ™¯æ·±åº”ç”¨ï¼‰ã€‚è¿™äº›å‘½ä»¤åœ¨æ¯å¸§çš„æ¸²æŸ“å¾ªç¯ä¸­è¢«åŠ¨æ€ç”Ÿæˆå’Œæ‰§è¡Œï¼Œä»¥æ”¯æŒå‰å‘æ¸²æŸ“ç­–ç•¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚

URPä¸­çš„æ¸²æŸ“é˜Ÿåˆ—å®ç°ä¸»è¦ç”±`ScriptableRenderPass`ç±»å®Œæˆï¼Œå®ƒå®šä¹‰äº†Passçš„æ‰§è¡Œé¡ºåºå’Œå…·ä½“æ¸²æŸ“é€»è¾‘ã€‚å…·ä½“è„šæœ¬æµç¨‹å¦‚ä¸‹ï¼š

â€Œ**æ¸²æŸ“é˜Ÿåˆ—ç®¡ç†**â€Œï¼š
-------------

*   **æ¸²æŸ“é˜Ÿåˆ—**ï¼ˆå¦‚`RenderQueueRange.opaque`æˆ–`RenderQueueRange.transparent`ï¼‰åœ¨`ScriptableRenderPass`çš„æ„é€ å‡½æ•°ä¸­æŒ‡å®šï¼Œé€šè¿‡å­—æ®µå¦‚`renderPassEvent`æ§åˆ¶Passçš„æ‰§è¡Œæ—¶æœºï¼ˆä¾‹å¦‚åœ¨ç›¸æœºæ¸²æŸ“å‰æˆ–åï¼‰ã€‚
    
*   **ä¾‹å¦‚**ï¼Œä¸€ä¸ªåŸºæœ¬çš„Passè„šæœ¬ä¼šç»§æ‰¿è‡ª`ScriptableRenderPass`ï¼Œå¹¶åœ¨å…¶Configureæ–¹æ³•ä¸­è®¾ç½®é˜Ÿåˆ—ä¼˜å…ˆçº§ï¼šè¿™é‡Œï¼Œ`Execute`æ–¹æ³•åŒ…å«å…·ä½“å‘½ä»¤é˜Ÿåˆ—çš„å®ç°ï¼Œä½¿ç”¨`CommandBuffer`æ¥å½•åˆ¶å‘½ä»¤ï¼ˆå¦‚`cmd.ClearRenderTarget`ï¼‰ï¼Œå¹¶é€šè¿‡`ScriptableRenderContext`æäº¤ã€‚
    
        csharp
        public class CustomRenderPass : ScriptableRenderPass
        {
            public override void Configure(CommandBuffer cmd, RenderTextureDescriptor cameraTextureDescriptor)
            {
        // è®¾ç½®é˜Ÿåˆ—èŒƒå›´ä¸ºä¸é€æ˜å¯¹è±¡
                renderPassEvent = RenderPassEvent.BeforeRenderingOpaques;
            }
            public override void Execute(ScriptableRenderContext context, ref RenderingData renderingData)
            {
        // æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚ç»˜åˆ¶æˆ–æ¸…é™¤
                CommandBuffer cmd = CommandBufferPool.Get();
                context.ExecuteCommandBuffer(cmd);
                CommandBufferPool.Release(cmd);
            }
        }
        
    

â€Œ**è„šæœ¬é›†æˆ**â€Œï¼š
-----------

*   åœ¨`ScriptableRenderer`ï¼ˆå¦‚`UniversalRenderer`ï¼‰ä¸­ï¼Œæ¸²æŸ“é˜Ÿåˆ—é€šè¿‡`m_ActiveRenderPassQueue`åˆ—è¡¨ç®¡ç†ã€‚
*   Setupé˜¶æ®µè°ƒç”¨`AddRenderPasses`æ–¹æ³•æ”¶é›†æ‰€æœ‰å…³è”çš„`ScriptableRenderPass`å®ä¾‹ï¼ˆæ¥è‡ª`RendererFeature`ï¼‰ï¼Œå¹¶æŒ‰äº‹ä»¶é¡ºåºæ’åºï¼›`Execute`é˜¶æ®µéå†åˆ—è¡¨æ‰§è¡Œæ¯ä¸ªPassçš„`Execute`æ–¹æ³•ã€‚
*   ä¾‹å¦‚ï¼Œ`UniversalRenderPipeline.Render`æ–¹æ³•é©±åŠ¨æ•´ä¸ªæµç¨‹ï¼šæ­¤è„šæœ¬ä½äºURPæ ¸å¿ƒç¨‹åºé›†ï¼ˆå¦‚`UniversalRenderPipeline.cs`ï¼‰ï¼Œä¾èµ–äº`UniversalRenderPipelineAsset`æä¾›é…ç½®

    csharp
    protected override void Render(ScriptableRenderContext context, List<Camera> cameras)
    {
    // æ’åºç›¸æœºå¹¶é€ä¸ªå¤„ç†foreach (var camera in cameras)
        {
            var renderer = cameraData.renderer;
            renderer.Execute(context, ref renderingData);// æ‰§è¡ŒPassé˜Ÿåˆ—
        }
    }
    

**åœ¨Unity URPä¸­ï¼ŒShaderLabé…ç½®çš„æ¸²æŸ“çŠ¶æ€ï¼ˆå¦‚å‰”é™¤ã€æ·±åº¦æµ‹è¯•ã€æ··åˆæ¨¡å¼ç­‰ï¼‰çš„å¤„ç†æµç¨‹**
=====================================================

**ä¸€ã€çŠ¶æ€è¯»å–ä¸å­˜å‚¨æœºåˆ¶**
---------------

### â€Œ**ShaderLabè§£æé˜¶æ®µ**â€Œ

*   URPé€šè¿‡`ShaderCompiler`è§£æShaderLabä»£ç ï¼Œå°†`Cull`ã€`ZTest`ã€`Blend`ç­‰æŒ‡ä»¤è½¬æ¢ä¸ºåº•å±‚æ¸²æŸ“çŠ¶æ€æ ‡è¯†ç¬¦ã€‚
*   è§£æç»“æœå­˜å‚¨åœ¨`ShaderData`ç»“æ„ä¸­ï¼ŒåŒ…å«æ¸²æŸ“çŠ¶æ€å˜ä½“ï¼ˆVariantï¼‰å’Œæè´¨å±æ€§ã€‚

### â€Œ**GPUçŠ¶æ€è®¾ç½®é˜¶æ®µ**â€Œ

*   è¿è¡Œæ—¶ç”±`CommandBuffer`å½•åˆ¶æŒ‡ä»¤ï¼ˆå¦‚`cmd.SetRenderTarget`ã€`cmd.SetGlobalDepthBias`ï¼‰ï¼Œé€šè¿‡`ScriptableRenderContext.Submit`æäº¤åˆ°GPUã€‚
*   å…³é”®å­˜å‚¨ä½ç½®ï¼š
    *   â€Œ**å‰”é™¤æ¨¡å¼**â€Œï¼šå­˜äº`RenderStateBlock.cullMode`ï¼Œé€šè¿‡`DrawingSettings`ä¼ é€’ç»™`DrawRenderers`è°ƒç”¨ã€‚
    *   â€Œ**æ·±åº¦æµ‹è¯•/å†™å…¥**â€Œï¼šé€šè¿‡`DepthState`ç»“æ„ï¼ˆå«`ZWrite`ã€`ZTest`ï¼‰é…ç½®ï¼Œæœ€ç»ˆå†™å…¥GPUæ·±åº¦ç¼“å†²åŒºã€‚
    *   â€Œ**æ··åˆæ¨¡å¼**â€Œï¼šç”±`BlendState`ç®¡ç†ï¼ˆå«`BlendOp`ã€`SrcFactor`ç­‰å‚æ•°ï¼‰ï¼Œç»‘å®šåˆ°æ¸²æŸ“ç®¡çº¿çŠ¶æ€ã€‚

### â€Œ**URPè¿è¡Œæ—¶ç®¡ç†**â€Œ

*   `UniversalRenderer`åœ¨`AddRenderPasses`é˜¶æ®µæ”¶é›†æ‰€æœ‰Passçš„æ¸²æŸ“çŠ¶æ€ï¼Œåˆå¹¶åˆ°`RenderStateBlock`ã€‚
*   é€šè¿‡`MaterialPropertyBlock`åŠ¨æ€è¦†ç›–æè´¨å±æ€§ï¼ˆå¦‚è¿è¡Œæ—¶ä¿®æ”¹`_ZWrite`ï¼‰ã€‚

* * *

**äºŒã€å…³é”®è„šæœ¬ä¸è°ƒç”¨é“¾**
--------------

â€Œ**åŠŸèƒ½**â€Œ

â€Œ**è„šæœ¬/ç±»**â€Œ

â€Œ**æ ¸å¿ƒæ–¹æ³•**â€Œ

â€Œ**æ•°æ®æµå‘**â€Œ

â€Œ**Shaderè§£æ**â€Œ

`ShaderCompiler`

`CompileShader`

ShaderLab â†’Â `ShaderData`

â€Œ**çŠ¶æ€å½•åˆ¶**â€Œ

`CommandBuffer`

`SetRenderState`

CPU â†’ GPUæŒ‡ä»¤é˜Ÿåˆ—

â€Œ**Passæ‰§è¡Œ**â€Œ

`DrawObjectsPass`

`Execute`

é€šè¿‡`DrawingSettings`ä¼ é€’çŠ¶æ€

â€Œ**åŠ¨æ€ä¿®æ”¹**â€Œ

`MaterialPropertyBlock`

`SetFloat`/`SetInt`

è¿è¡Œæ—¶è¦†ç›–Shaderå‚æ•°

* * *

**ä¸‰ã€ä½¿ç”¨ç¤ºä¾‹ï¼ˆURPä¸­åŠ¨æ€ä¿®æ”¹æ·±åº¦æµ‹è¯•ï¼‰**
------------------------

    hlsl
    // ShaderLabä¸­å£°æ˜æ·±åº¦æµ‹è¯•
    SubShader {
        Pass {
            ZWrite On
            ZTest LEqual
        }
    }
    

*   â€Œ**è¿è¡Œæ—¶è¯»å–**â€Œï¼šé€šè¿‡`Material.GetInt("_ZWrite")`è·å–çŠ¶æ€ã€‚
    
*   â€Œ**åŠ¨æ€ä¿®æ”¹**â€Œï¼š
    
        csharp
        var block = new MaterialPropertyBlock();
        block.SetInt("_ZWrite", 0);// ç¦ç”¨æ·±åº¦å†™å…¥
        renderer.SetPropertyBlock(block);
        
    

* * *

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

ï¼ˆæ¬¢è¿ç‚¹èµç•™è¨€æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰