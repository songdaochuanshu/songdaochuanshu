---
layout: post
title: 'æ€§èƒ½æå‡4å€ï¼ä½¿ç”¨Granianä½œä¸ºDjangoé¡¹ç›®çš„ASGIæœåŠ¡å™¨'
date: "2025-11-29T00:40:51Z"
---
æ€§èƒ½æå‡4å€ï¼ä½¿ç”¨Granianä½œä¸ºDjangoé¡¹ç›®çš„ASGIæœåŠ¡å™¨
==================================

å‰è¨€
--

æœ€è¿‘æˆ‘åˆç»§ç»­åœ¨å¼€å‘ DjangoStarter çš„æ–°ç‰ˆæœ¬äº†ã€‚

ä¹‹å‰ä¸ºäº†å®ç° docker éƒ¨ç½²ï¼Œæˆ‘æŠŠ Nginx æ‰“åŒ…è¿›äº† DjangoStarter çš„ compose é…ç½®é‡Œäº†ï¼Œä¸è¿‡è¿™å¸¦æ¥äº†é…ç½®çš„å¤æ‚åº¦ï¼Œç‰¹åˆ«æ˜¯è¿˜è¦æ­é…æ¡†æ¶å®ç° URL prefix ä¹‹ç±»çš„åŠŸèƒ½ã€‚

ä» v3.2.x ç‰ˆæœ¬å¼€å§‹ï¼Œæˆ‘å°±å¯åŠ¨äº†å‡æ³•è®¡åˆ’ï¼Œç®€åŒ–ä»£ç å’ŒåŠŸèƒ½ï¼Œå‡å°‘å¿ƒæ™ºè´Ÿæ‹…ï¼Œè¿™ä¸ª Nginx å®¹å™¨ä¹Ÿæ˜¯æˆ‘ä¸€ç›´æƒ³å»æ‰çš„ã€‚

æœ€è¿‘å‘ç° Granian è¿™ä¸ª Rust å¼€å‘çš„ ASGI æœåŠ¡å™¨ï¼Œæ€§èƒ½é«˜ï¼Œè€Œä¸”è¿˜å¯ä»¥æ”¯æŒé™æ€æ–‡ä»¶ï¼Œæ­£å¥½å®Œç¾ç¬¦åˆæˆ‘çš„éœ€æ±‚ï¼Œäºæ˜¯è¿™æ¬¡æ­£å¥½æ‹¿æ¥æ›¿æ¢åŸæœ¬ä½¿ç”¨çš„ Daphne

Granian
-------

é¡¹ç›®ä¸»é¡µ: [https://github.com/emmett-framework/granian](https://github.com/emmett-framework/granian)

Granian æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ Python Web Serverï¼Œæ”¯æŒ ASGIã€WSGIã€RSGIï¼ŒåŸºäº Rust ç¼–å†™ï¼Œå¯åŠ¨é€Ÿåº¦å¿«ã€å¹¶å‘èƒ½åŠ›å¼ºï¼Œéå¸¸é€‚åˆ Django / FastAPI / Starletteã€‚

å®˜æ–¹æè¿°ä¸º â€œA Rust HTTP server for Python applications built on top of Hyper/Tokioâ€ã€‚

ç‰¹ç‚¹ï¼š

*   æ”¯æŒ **ASGI 3**ã€**RSGI**ï¼ˆRust-Server-Gateway Interfaceï¼‰å’Œ **WSGI** æ¥å£ã€‚
*   æ”¯æŒ HTTP/1 å’Œ HTTP/2ï¼ˆæœªæ¥è®¡åˆ’ HTTP/3ï¼‰åè®®ã€‚
*   æ”¯æŒé™æ€æ–‡ä»¶ç›´å‡º (â€œDirect static files servingâ€)ã€‚

ä½¿ç”¨æ–¹å¼
----

å¾ˆç®€å•ï¼Œä¸éœ€è¦ä¿®æ”¹ä»£ç ï¼Œåªéœ€è¦ä¿®æ”¹å¯åŠ¨å‘½ä»¤ã€‚

ç›®å‰æ­é… DjangoStarter ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤æ˜¯è¿™æ ·çš„ï¼š

    granian --interface asgi --host 0.0.0.0 --port 8000 --static-path-route /static --static-path-mount ./static-dist config.asgi:application
    

ç±»ä¼¼ uvicornï¼Œè¿™ä¸ª granian ä¹Ÿæ”¯æŒçƒ­é‡è½½ï¼ŒåŠ ä¸ª `--reload` å‚æ•°å°±è¡Œäº†

æ€§èƒ½æµ‹è¯•
----

æœ¬æ¬¡ç”¨ wrk è¿›è¡Œæ€§èƒ½æµ‹è¯•

### æµ‹è¯•æ•°æ®

ä»¥ä¸‹æ•°æ®åœ¨è…¾è®¯äº‘ 2 cores CPU + 2G å†…å­˜çš„æœåŠ¡å™¨ä¸Šæµ‹å¾—ã€‚

django 5.x + ninja + daphne

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9876/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9876/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.97s     0.00us   1.97s   100.00%
        Req/Sec    38.55     55.33   343.00     90.23%
      1343 requests in 30.04s, 760.03KB read
      Socket errors: connect 0, read 0, write 0, timeout 1342
    Requests/sec:     44.70
    Transfer/sec:     25.30KB
    

django 5.x + ninja + granian

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/hea
    lth
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.20s    93.05ms   1.72s    82.69%
        Req/Sec    83.13    105.81   460.00     83.72%
      4980 requests in 30.04s, 2.85MB read
    Requests/sec:    165.76
    Transfer/sec:     97.31KB
    

å› ä¸ºå¥½å¥‡ï¼Œæˆ‘è¿˜æ‰¾åˆ°ä¹‹å‰ä¸€ä¸ªå¾ˆè€çš„é¡¹ç›®ï¼Œä½¿ç”¨WSGIéƒ¨ç½²çš„è¿›è¡Œå¯¹æ¯”ã€‚

ä»¥ä¸‹æ•°æ®åœ¨ç§æœ‰äº‘çš„ 4 cores CPU + 2G å†…å­˜æœåŠ¡å™¨ä¸Šæµ‹å¾—ã€‚

å› ä¸ºæ˜¯å®Œå…¨ä¸åŒçš„æœåŠ¡å™¨ç¡¬ä»¶ï¼Œæ•°æ®ä»…ä¾›å‚è€ƒã€‚

Django 3.x + drf + uwsgi + nginx

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9001/api/health/
    Running 30s test @ http://127.0.0.1:9001/api/health/
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   295.30ms  373.95ms   1.96s    85.14%
        Req/Sec   205.54     68.42   380.00     73.73%
      19583 requests in 30.09s, 5.83MB read
      Socket errors: connect 0, read 0, write 0, timeout 474
      Non-2xx or 3xx responses: 12
    Requests/sec:    650.89
    Transfer/sec:    198.32KB
    

Django 3.x + ninja + uwsgi + nginx

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9001/api2/health
    Running 30s test @ http://127.0.0.1:9001/api2/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   203.75ms  280.30ms   1.95s    88.44%
        Req/Sec   250.81    108.59   500.00     61.21%
      22542 requests in 30.06s, 5.68MB read
      Socket errors: connect 0, read 0, write 0, timeout 420
      Non-2xx or 3xx responses: 12
    Requests/sec:    749.88
    Transfer/sec:    193.35KB
    

### ç»“è®º

ä»¥ä¸‹æ˜¯ä½¿ç”¨ AI å¯¹ä¸Šé¢çš„æµ‹è¯•æ•°æ®è¿›è¡Œåˆ†æçš„ç»“è®ºï¼Œä¸è¿‡ ASGI å’Œ uWSGI ä¸åœ¨åŒä¸€å°æœåŠ¡å™¨è¿›è¡Œæµ‹è¯•ï¼Œå…¶å®å¾ˆéš¾ç›´æ¥å¯¹æ¯”ã€‚ç›®å‰çœ‹æ¥åˆ‡æ¢åˆ° Granian ç¡®å®å¯ä»¥æé«˜4å€çš„æ€§èƒ½ã€‚

â‘  Daphne åœ¨ Django + ASGI ä¸‹çš„æ€§èƒ½è¡¨ç°éå¸¸å·®

*   å»¶è¿Ÿç›´æ¥é£™åˆ° **1.9 ç§’çº§åˆ«**ï¼Œ
*   wrk 200 å¹¶å‘å‡ ä¹æŠŠå®ƒå‹æ‰ï¼Œ
*   **1343 è¯·æ±‚é‡Œ 1342 è¶…æ—¶**ï¼Œç­‰äºå®Œå…¨é¡¶ä¸ä½ã€‚

è¯´ç™½äº†ï¼š**Daphne æ›´åƒæ˜¯å¼€å‘ç¯å¢ƒæœåŠ¡å™¨ï¼Œä¸æ¨èä¸Šç”Ÿäº§é«˜å¹¶å‘ã€‚**

â‘¡ Granian æ€§èƒ½æ¯” Daphne å¥½ 3â€“4 å€ï¼Œä½†ä»ç„¶æœ‰é™

*   æ¯ç§’å¤„ç† **165 req/s**ï¼ˆåŒæœºæˆ¿ã€åŒä»£ç ï¼‰ã€‚
*   å»¶è¿Ÿä»ç„¶åœ¨ **1.2s** å·¦å³ï¼Œè¿œä¸ç®—ç†æƒ³ï¼ˆåœ¨é«˜å¹¶å‘ä¸‹ä»åƒåŠ›ï¼‰ã€‚
*   ä¼˜ç‚¹æ˜¯ ASGI åŸç”Ÿ + Rust å®ç°ï¼Œæ¯” Daphne å¼ºå¤ªå¤šã€‚

ç›´è§‚æ„Ÿå—ï¼š**Granian èƒ½ç”¨ï¼Œä½†ä½ åˆ«æŒ‡æœ›å®ƒåƒ uWSGI é‚£æ ·æ‰›æµé‡ã€‚**

â‘¢ uWSGIï¼ˆWSGIï¼‰è¡¨ç°ç¢¾å‹ï¼šå•æœºå¯è¾¾ 650â€“750 req/s çº§åˆ«

*   æ€§èƒ½ç›´æ¥æ˜¯ granian çš„ **4ï½5 å€**ã€‚
*   è™½ç„¶æ˜¯è€æ¶æ„ï¼ˆWSGIï¼‰ï¼Œä½†è°ƒä¼˜æˆç†Ÿã€ç¨³å®šã€åˆ†é…æœºåˆ¶å¼ºï¼ŒæŠ—å‹èƒ½åŠ›è¿œå¼ºäºåŒç±» ASGI æœåŠ¡ã€‚

ç®€è€Œè¨€ä¹‹ï¼š**å¦‚æœä¸ç”¨å¼‚æ­¥ï¼ŒWSGI ä¾æ—§æ˜¯ Django çš„æœ€å¼ºéƒ¨ç½²æ–¹å¼ï¼ˆæ€§èƒ½å±‚é¢ï¼‰ã€‚**

docker-compose
--------------

è¿™æ˜¯ç²¾ç®€åçš„ compose é…ç½®

    services:
      app:
        image: ${APP_IMAGE_NAME}:${APP_IMAGE_TAG}
        container_name: $APP_NAME-app
        command:
          - granian
          - --interface
          - asgi
          - --host
          - 0.0.0.0
          - --port
          - "${APP_INTERNAL_PORT:-8000}"
          - --static-path-route
          - /static
          - --static-path-mount
          - /project/static-dist
          - config.asgi:application
    

å‘½ä»¤è¡Œå‚æ•°
-----

å®ƒçš„å‘½ä»¤è¡Œç»“æ„å¾ˆç®€å•ï¼š

    granian [OPTIONS] APP
    

å…¶ä¸­ï¼š

*   **APP** æ˜¯å…¥å£ï¼Œä¾‹å¦‚ï¼š`config.asgi:application`
*   **OPTIONS** æ˜¯å„ç§é…ç½®å‚æ•°

ä¸‹é¢æŒ‰åˆ†ç±»æ•´ç†æ‰€æœ‰å‚æ•°ï¼ˆé™„å¸¦è¯´æ˜ä¸å»ºè®®ï¼‰ã€‚

### ğŸ§© åŸºç¡€å‚æ•°ï¼ˆå¯åŠ¨å¿…è¦é¡¹ï¼‰

å‚æ•°

è¯´æ˜

é»˜è®¤å€¼

`APP`

**è¦å¯åŠ¨çš„åº”ç”¨å…¥å£**ï¼ˆå¦‚ `mysite.asgi:application`ï¼‰

å¿…å¡«

`--interface`

æ¥å£ç±»å‹ï¼š`asgi` / `asginl` / `rsgi` / `wsgi`

rsgi

`--host`

ç›‘å¬åœ°å€

127.0.0.1

`--port`

ç«¯å£

8000

`--uds`

ä½¿ç”¨ Unix Domain Socket

æ— 

`--http`

HTTP ç‰ˆæœ¬ï¼š`1`ã€`2`ã€`auto`

auto

`--workers`

Worker è¿›ç¨‹æ•°

1

ğŸ‘‰ Djangoã€FastAPI ç”¨æˆ·ä¸€èˆ¬å†™ï¼š

    --interface asgi
    

### ğŸ—‚ï¸ é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆDjango ä¸“ç”¨é…ç½®ï¼‰

Granian å†…ç½®é™æ€æ–‡ä»¶æœåŠ¡ï¼š

å‚æ•°

è¯´æ˜

é»˜è®¤å€¼

`--static-path-route`

URL è·¯ç”±å‰ç¼€ï¼Œä¾‹å¦‚ `/static`

/static

`--static-path-mount`

æ–‡ä»¶ç›®å½•ï¼Œä¾‹å¦‚ `/project/static-dist`

æ— 

`--static-path-expires`

ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰

86400

ç¤ºä¾‹ï¼š

    --static-path-route /static --static-path-mount /project/static-dist
    

### âš™ï¸ å¤šè¿›ç¨‹ã€çº¿ç¨‹ã€äº‹ä»¶å¾ªç¯é€‰é¡¹

Worker / Thread

å‚æ•°

è¯´æ˜

`--workers`

Worker æ•°é‡

`--blocking-threads`

é˜»å¡çº¿ç¨‹æ•°

`--runtime-threads`

Runtime çº¿ç¨‹æ•°

`--runtime-blocking-threads`

Runtime I/O é˜»å¡çº¿ç¨‹

å»ºè®®ï¼š

*   **CPU Ã— 2** å·¦å³çš„ worker å®¹é‡é€šå¸¸å¤Ÿç”¨
*   å¤§éƒ¨åˆ† ASGI é¡¹ç›®ä¸éœ€è¦è°ƒ thread å‚æ•°

### ğŸ” äº‹ä»¶å¾ªç¯ & Runtime

å‚æ•°

è¯´æ˜

`--loop`

äº‹ä»¶å¾ªç¯ï¼š`auto`ã€`asyncio`ã€`rloop`ã€`uvloop`

`--task-impl`

task æ‰§è¡Œå™¨ï¼š`asyncio` / `rust`

`--runtime-mode`

å•çº¿ç¨‹ `st` / å¤šçº¿ç¨‹ `mt`

é€‚ç”¨å»ºè®®ï¼š

*   æ™®é€šé¡¹ç›®ï¼šç”¨é»˜è®¤å³å¯
*   é«˜å¹¶å‘ï¼š`--task-impl rust` æ€§èƒ½æ›´å¼º

### ğŸ”’ HTTP/1 ä¸ HTTP/2 ç›¸å…³å‚æ•°

ç±»åˆ«

å¸¸ç”¨é…ç½®

HTTP/1

`--http1-buffer-size`ã€`--http1-keep-alive`

HTTP/2

`--http2-*` ä¸€ç³»åˆ—å‚æ•°æ§åˆ¶ flow controlã€çª—å£ã€keepaliveã€stream æ•°é‡ç­‰

å¤§éƒ¨åˆ†é¡¹ç›®æ— éœ€è°ƒæ•´ï¼Œé»˜è®¤å³å¯ã€‚

### ğŸ“œ æ—¥å¿—ï¼ˆLoggingï¼‰

å‚æ•°

è¯´æ˜

é»˜è®¤

`--log / --no-log`

å¯ç”¨æ—¥å¿—

enabled

`--log-level`

æ—¥å¿—ç­‰çº§

info

`--log-config`

ä½¿ç”¨ JSON é…ç½®æ–‡ä»¶

æ— 

`--access-log`

å¼€å¯ access log

disabled

`--access-log-fmt`

Access log æ ¼å¼

æ— 

å¦‚æœä½ å¸Œæœ›ç”Ÿäº§ç¯å¢ƒæœ‰ Nginx æ ·å¼çš„ access logï¼š

    --access-log --access-log-fmt "%a %r %s %b"
    

### ğŸ” çƒ­é‡è½½ï¼ˆå¼€å‘ç¯å¢ƒç”¨ï¼‰

å‚æ•°

è¯´æ˜

`--reload`

å¼€å¯è‡ªåŠ¨é‡è½½

`--reload-paths`

æŒ‡å®šç›‘æ§ç›®å½•

`--reload-ignore-*`

å¿½ç•¥ç›®å½•ã€è·¯å¾„ã€pattern

ä¾‹å¦‚ï¼š

    --reload --reload-paths src/
    

### ğŸ” HTTPS

å‚æ•°

è¯´æ˜

`--ssl-certificate`

è¯ä¹¦æ–‡ä»¶

`--ssl-keyfile`

å¯†é’¥æ–‡ä»¶

`--ssl-ca`

CA

`--ssl-client-verify`

å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯

ï¼ˆä¸€èˆ¬åå‘ä»£ç†äº¤ç»™ Nginx åš HTTPSï¼‰

### ğŸ§° å…¶ä»–æœ‰ç”¨ä½†ä¸å¸¸æ”¹çš„å‚æ•°

å‚æ•°

è¯´æ˜

`--working-dir`

åˆ‡æ¢ WorkDir

`--env-files`

åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶

`--factory`

APP æ˜¯ factory function æ—¶ä½¿ç”¨

`--url-path-prefix`

åº”ç”¨æŒ‚è½½å‰ç¼€

`--process-name`

è‡ªå®šä¹‰è¿›ç¨‹å

`--pid-file`

å†™å…¥ PID æ–‡ä»¶

`--version`

æ˜¾ç¤ºç‰ˆæœ¬

`--help`

æ˜¾ç¤ºå¸®åŠ©

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚