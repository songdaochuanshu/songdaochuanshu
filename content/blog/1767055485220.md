---
layout: post
title: 'MAFå¿«é€Ÿå…¥é—¨ï¼ˆ9ï¼‰å¤šè·¯åˆ†æ”¯è·¯ç”±å·¥ä½œæµ'
date: "2025-12-30T00:44:45Z"
---
MAFå¿«é€Ÿå…¥é—¨ï¼ˆ9ï¼‰å¤šè·¯åˆ†æ”¯è·¯ç”±å·¥ä½œæµ
===================

![MAFå¿«é€Ÿå…¥é—¨ï¼ˆ9ï¼‰å¤šè·¯åˆ†æ”¯è·¯ç”±å·¥ä½œæµ](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224203108188-1569801702.png) ä¸Šä¸€ç¯‡ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­å¦‚ä½•è¿›è¡Œif-elseç±»å‹çš„æ¡ä»¶è·¯ç”±ï¼Œä½†æ˜¯å®é™…å·¥ä½œä¸­å¯èƒ½ä¼šæ‘ä¸­å¤šä¸ªåˆ†æ”¯è·¯ç”±çš„åœºæ™¯ã€‚åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾ˆå¤šçš„ä¸šåŠ¡é€»è¾‘æ¶‰åŠåˆ°ä¸æ­¢ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œè€Œæ˜¯å¤šä¸ªã€‚åœ¨MAFä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Switch-Case æ¥å®ç°è¿™ç§å·¥ä½œæµå†…éƒ¨å¤šç±»å†³ç­–æ¡ä»¶çš„ å·¥ä½œæµéœ€æ±‚ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Edisonã€‚

æœ€è¿‘æˆ‘ä¸€ç›´åœ¨è·Ÿç€åœ£æ°çš„ã€Š[.NET+AIæ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹è¯¾ç¨‹å­¦ä¹ MAFçš„å¼€å‘æŠ€å·§ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ ä¹Ÿä¸Šè½¦è·Ÿæˆ‘ä¸€èµ·å‡ºå‘ï¼

[ä¸Šä¸€ç¯‡](https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper08)ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­å¦‚ä½•è¿›è¡Œif-elseç±»å‹çš„æ¡ä»¶è·¯ç”±ï¼Œä½†æ˜¯å®é™…å·¥ä½œä¸­å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ªåˆ†æ”¯è·¯ç”±çš„åœºæ™¯ã€‚æœ¬ç¯‡ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹MAFä¸­çš„switch-caseè·¯ç”±å®ç°å¤šåˆ†æ”¯è·¯ç”±å·¥ä½œæµã€‚

**Why switch-case?**
====================

åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾ˆå¤šçš„ä¸šåŠ¡é€»è¾‘æ¶‰åŠåˆ°ä¸æ­¢ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œè€Œæ˜¯å¤šä¸ªã€‚

ä¾‹å¦‚ï¼Œåœ¨ä¸Šä¸€ç¯‡çš„ä¼ä¸šå†…éƒ¨é‚®ä»¶æ£€æµ‹æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„æ£€æµ‹ç»“æœåªæœ‰ä¸¤ä¸ªï¼ˆåƒåœ¾é‚®ä»¶ æˆ– æ­£å¸¸é‚®ä»¶ï¼‰ï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³å¢åŠ ä¸€ä¸ªç»“æœï¼ˆä¸ç¡®å®šï¼‰å°±æ— æ³•é€‚ç”¨äº†ã€‚

åœ¨MAFä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Switch-Case æ¥å®ç°è¿™ç§å·¥ä½œæµå†…éƒ¨å¤šç±»å†³ç­–æ¡ä»¶çš„ å·¥ä½œæµéœ€æ±‚ã€‚

**å®éªŒæ¡ˆä¾‹**
========

ä»Šå¤©æ¥æ™šä¸Šä¸Šä¸€ç¯‡è¿™ä¸ªä¼ä¸šå†…éƒ¨é‚®ä»¶æ£€æµ‹çš„å·¥ä½œæµæ¡ˆä¾‹ï¼Œä¸Šä¸€ç¯‡çš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202006911-1817307092.png)

ä»Šå¤©å‡è®¾æˆ‘ä»¬éœ€è¦æœ‰æ›´ä¸ºç²¾ç»†çš„åˆ†ç±»ï¼š

Â  âœ…Â \*\*æ­£å¸¸é‚®ä»¶\*\*ï¼ˆNotSpamï¼‰ï¼šå®¢æˆ·å’¨è¯¢ã€ä¸šåŠ¡å¾€æ¥

Â  âŒÂ \*\*åƒåœ¾é‚®ä»¶\*\*ï¼ˆSpamï¼‰ï¼šæ˜æ˜¾çš„è¯ˆéª—ã€å¹¿å‘Š

Â Â âš ï¸Â \*\*ä¸ç¡®å®šé‚®ä»¶\*\*ï¼ˆUncertainï¼‰ï¼šå¯èƒ½æ˜¯é’“é±¼é‚®ä»¶ï¼Œéœ€è¦äººå·¥å®¡æ ¸

é‚£ä¹ˆè¿™å°±æ˜¯ä¸€ä¸ªä¸‰å…ƒåˆ†ç±»çš„ï¼Œåœ¨ä¸šåŠ¡å¼€å‘ä¸­æˆ‘ä»¬é€šå¸¸ä¼šç”¨åˆ°switch-caseè¯­æ³•ï¼Œè€Œåœ¨MAFå·¥ä½œæµä¸­ï¼Œä¹Ÿä¸ºæˆ‘ä»¬å®šä¹‰äº†è¿™ç§switch-caseæ¥å£ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œæ¯”å¯¹äº†ä¸¤ç§æ¥å£çš„ä½¿ç”¨æ–¹å¼ï¼š

// Conditional Edge
builder
    .AddEdge(source, target1, condition: c \=> c.IsSpam == false)
    .AddEdge(source, target2, condition: c \=> c.IsSpam == true);
// Switch-Case
builder.AddSwitch(source, sb => sb
    .AddCase(c \=> c.Decision == NotSpam, target1)
    .AddCase(c \=> c.Decision == Spam, target2)
    .WithDefault(target3)
);

å¯ä»¥çœ‹åˆ°ï¼Œswitch-caseæ¨¡å¼å…¶ä»·å€¼ä¸»è¦åœ¨äºå¢å¼ºä»£ç å¯ç»´æŠ¤æ€§ï¼Œå¯¹äºåç»­å¦‚æœæœ‰æ–°å¢åˆ†ç±»ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªAddCaseæ¥å£æ–¹æ³•å®ç°æ–°å¢åˆ†ç±»çš„å¤„ç†ï¼ŒåŒæ—¶åŸºäºWithDefaultæ¥å£æ–¹æ³•å®ç°å…œåº•ç¡®ä¿æ‰€æœ‰æƒ…å†µéƒ½æœ‰å¤„ç†ã€‚

æœ€åï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬éœ€è¦é‡æ„åçš„åˆ†æ”¯è·¯ç”±å›¾ï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202047038-2027515638.png)

**å‡†å¤‡å·¥ä½œ**
========

åœ¨ä»Šå¤©çš„è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶åˆ›å»ºäº†ä¸€ä¸ª.NETæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå®‰è£…äº†ä»¥ä¸‹NuGetåŒ…ï¼š

*   Microsoft.Agents.AI.OpenAI
*   Microsoft.Agents.AI.Workflows
*   Microsoft.Extensions.AI.OpenAI

æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†LLM APIçš„ä¿¡æ¯ï¼š

{
  "OpenAI": {
    "EndPoint": "https://api.siliconflow.cn",
    "ApiKey": "\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*",
    "ModelId": "Qwen/Qwen3-30B-A3B-Instruct-2507"
  }
}

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ SiliconCloud æä¾›çš„Â Qwen/Qwen3-30B-A3B-Instruct-2507Â æ¨¡å‹ï¼Œä½ å¯ä»¥é€šè¿‡è¿™ä¸ªURLæ³¨å†Œè´¦å·ï¼š[https://cloud.siliconflow.cn/i/DomqCefW](https://cloud.siliconflow.cn/i/DomqCefW)Â è·å–å¤§é‡å…è´¹çš„Tokenæ¥è¿›è¡Œæœ¬æ¬¡å®éªŒã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†é…ç½®æ–‡ä»¶ä¸­çš„APIä¿¡æ¯è¯»å–å‡ºæ¥ï¼š

var config = new ConfigurationBuilder()
    .AddJsonFile($"appsettings.json", optional: false, reloadOnChange: true)
    .Build();
var openAIProvider = config.GetSection("OpenAI").Get<OpenAIProvider>();

å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹
--------

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹åœ¨è¿™ä¸ªå·¥ä½œæµä¸­éœ€è¦ç”Ÿæˆä¼ é€’çš„æ•°æ®æ¨¡å‹ï¼š

ï¼ˆ1ï¼‰DetectionResult ï¼šæ‹‰ä»¶é‚®ä»¶æ£€æµ‹ç»“æœ

public sealed class DetectionResult
{
    /// <summary>
    /// æ£€æµ‹å†³ç­–ï¼ˆNotSpam / Spam / Uncertainï¼‰
    /// </summary>
    \[JsonPropertyName("spam\_decision")\]
    \[JsonConverter(typeof(JsonStringEnumConverter))\]  // JSON åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
    public SpamDecision spamDecision { get; set; }
    /// <summary>
    /// åˆ¤å®šç†ç”±ï¼ˆç”¨äºå®¡è®¡å’Œè°ƒè¯•ï¼‰
    /// </summary>
    \[JsonPropertyName("reason")\]
    public string Reason { get; set; } = string.Empty;
    /// <summary>
    /// é‚®ä»¶IDï¼ˆç”¨äºå…³è” Shared State ä¸­çš„åŸå§‹å†…å®¹ï¼‰
    /// </summary>
    \[JsonIgnore\]
    public string EmailId { get; set; } = string.Empty;
}

public enum SpamDecision
{
    Spam,        // åƒåœ¾é‚®ä»¶
    NotSpam, // æ­£å¸¸é‚®ä»¶
    UnCertain // æ— æ³•ç¡®å®šï¼ˆéœ€è¦äººå·¥å®¡æ ¸ï¼‰
}

ï¼ˆ2ï¼‰EmailStateConstants ï¼šå¸¸é‡ï¼Œç±»ä¼¼äºCache Keyçš„ä½œç”¨ï¼Œå‚è€ƒä¸Šä¸€ç¯‡åšå®¢å†…å®¹ã€‚

ï¼ˆ3ï¼‰EmailMessage & EmailResponse ï¼šDTOä½œç”¨ï¼Œå‚è€ƒä¸Šä¸€ç¯‡åšå®¢å†…å®¹ã€‚

å…¥å£èŠ‚ç‚¹ï¼šåƒåœ¾é‚®ä»¶æ£€æµ‹Executor
-------------------

è¿™ä¸ªåƒåœ¾é‚®ä»¶æ£€æµ‹æ˜¯æœ¬æµç¨‹çš„æ ¸å¿ƒèŠ‚ç‚¹ï¼Œè¿™æ¬¡æˆ‘ä»¬å°†å…¶é‡æ„ä¸ºæ”¯æŒä¸‰åˆ†ç±»ï¼š

internal sealed class SpamDetectionExecutor : Executor<ChatMessage, DetectionResult>
{
    private readonly AIAgent \_agent;
    private readonly AgentThread \_thread;
    public SpamDetectionExecutor(AIAgent agent) : base("SpamDetectionExecutor")
    {
        // åˆ›å»º Agent å’Œå¯¹è¯çº¿ç¨‹
        this.\_agent = agent;
        this.\_thread = this.\_agent.GetNewThread();
    }
    public override async ValueTask<DetectionResult> HandleAsync(ChatMessage message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        // 1ï¸âƒ£ ç”Ÿæˆå”¯ä¸€é‚®ä»¶IDå¹¶ä¿å­˜å†…å®¹åˆ° Shared State
        var trackedEmail = new EmailMessage
        {
            EmailId \= Guid.NewGuid().ToString("N"),
            EmailContent \= message.Text
        };
        await context.QueueStateUpdateAsync(
            trackedEmail.EmailId,
            trackedEmail,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        );
        // 2ï¸âƒ£ è°ƒç”¨ AI Agent è¿›è¡Œä¸‰åˆ†ç±»æ£€æµ‹
        var agentResponse = await \_agent.RunAsync(
            message,
            \_thread,
            cancellationToken: cancellationToken
        );
        // 3ï¸âƒ£ è§£æç»“æ„åŒ–è¾“å‡º
        var detection = JsonSerializer.Deserialize<DetectionResult>(agentResponse.Text)
            ?? throw new InvalidOperationException("æ— æ³•è§£æ Spam Detection å“åº”");
        // 4ï¸âƒ£ å…³è” EmailIdï¼ˆä¾›ä¸‹æ¸¸ Executor æŸ¥æ‰¾åŸå§‹å†…å®¹ï¼‰
        detection.EmailId = trackedEmail.EmailId;
        return detection;
    }
}

åœ¨è¿™ä¸ªExecutorä¸­ï¼Œå®ƒæ¥æ”¶æˆ‘ä»¬å¦‚ä¸‹æ‰€ç¤ºå®šä¹‰å¥½çš„Agentæ¥å®ç°ï¼š

var spamDetectionAgent = new ChatClientAgent(
    chatClient,
    new ChatClientAgentOptions(
        instructions: @"ä½ æ˜¯ä¸€ä¸ªåƒåœ¾é‚®ä»¶æ£€æµ‹åŠ©æ‰‹ã€‚åˆ¤å®šè§„åˆ™ï¼š
- NotSpam: æ˜æ˜¾çš„æ­£å¸¸ä¸šåŠ¡é‚®ä»¶ï¼ˆè®¢å•æŸ¥è¯¢ã€å”®åå’¨è¯¢ç­‰ï¼‰
- Spam: æ˜æ˜¾çš„åƒåœ¾é‚®ä»¶ï¼ˆè¯ˆéª—ã€å¹¿å‘Šã€é’“é±¼ï¼‰
- Uncertain: æ— æ³•æ˜ç¡®åˆ¤æ–­ï¼ŒåŒ…å«å¯ç–‘å…ƒç´ ä½†ä¸ç¡®å®šï¼ˆå¦‚å«å¯ç–‘é“¾æ¥ä½†å†…å®¹æ¨¡ç³Šï¼‰
å¯¹äºæ¨¡æ£±ä¸¤å¯çš„æƒ…å†µï¼Œå€¾å‘äºæ ‡è®°ä¸º Uncertain ä»¥ä¿è¯å®‰å…¨ã€‚"
    )
    {
        ChatOptions \= new ChatOptions
        {
            ResponseFormat \= ChatResponseFormat.ForJsonSchema<DetectionResult>()
        }
    }
);

åœ¨ChatOptionsä¸­æŒ‡å®šäº†è¯¥Agentè¿”å›çš„æ¶ˆæ¯éœ€è¦è¿›è¡Œåºåˆ—åŒ–åˆ°å¼ºç±»å‹ï¼Œä¾¿äºåç»­é€šè¿‡å¼ºç±»å‹æ•°æ®è¿›è¡Œå†³ç­–è·¯ç”±ã€‚

ä¸‹æ¸¸èŠ‚ç‚¹Aï¼šæ­£å¸¸é‚®ä»¶å¤„ç†+å‘é€
---------------

è¿™é‡Œæˆ‘ä»¬é’ˆå¯¹è¯†åˆ«åˆ°çš„æ­£å¸¸é‚®ä»¶å¼€å‘ä¸¤ä¸ªæ‰§è¡Œå™¨ï¼Œå‡è®¾å…¶ç”¨äºé‚®ä»¶å¤„å’Œè½¬å‘ï¼š

### é‚®ä»¶å¤„ç†ï¼šè¯»å–å…±äº«çŠ¶æ€åŒºçš„åŸæ–‡ï¼Œç„¶åè°ƒç”¨Agentè¾“å‡ºJSONå›å¤ã€‚

internal sealed class EmailAssistantExecutor : Executor<DetectionResult, EmailResponse>
{
    private readonly AIAgent \_agent;
    private readonly AgentThread \_thread;

    public EmailAssistantExecutor(AIAgent agent) : base("EmailAssistantExecutor")
    {
        // åˆ›å»º Agent å’Œå¯¹è¯çº¿ç¨‹
        this.\_agent = agent;
        this.\_thread = this.\_agent.GetNewThread();
    }

    public override async ValueTask<EmailResponse> HandleAsync(DetectionResult message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        // ğŸ›¡ï¸ é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿åªå¤„ç†æ­£å¸¸é‚®ä»¶
        if (message.spamDecision == SpamDecision.Spam)
            throw new InvalidOperationException(
                "EmailAssistantExecutor ä¸åº”å¤„ç†åƒåœ¾é‚®ä»¶ï¼Œè¯·æ£€æŸ¥è·¯ç”±é…ç½®ã€‚"
            );

        // 1ï¸âƒ£ ä» Shared State è¯»å–åŸå§‹é‚®ä»¶å†…å®¹
        var email = await context.ReadStateAsync<EmailMessage>(
            message.EmailId,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        ) ?? throw new InvalidOperationException($"æ‰¾ä¸åˆ° EmailId={message.EmailId} çš„é‚®ä»¶å†…å®¹");

        // 2ï¸âƒ£ è°ƒç”¨ AI Agent ç”Ÿæˆå›å¤
        var agentResponse = await \_agent.RunAsync(
            email.EmailContent,
            \_thread,
            cancellationToken: cancellationToken
        );

        // 3ï¸âƒ£ è§£æç»“æ„åŒ–è¾“å‡º
        var emailResponse = JsonSerializer.Deserialize<EmailResponse>(agentResponse.Text)
            ?? throw new InvalidOperationException("æ— æ³•è§£æ Email Assistant å“åº”");

        return emailResponse;
    }
}

è¿™é‡Œçš„Agentå®šä¹‰å¦‚ä¸‹ï¼š

var emailAssistantAgent = new ChatClientAgent(
    chatClient,
    new ChatClientAgentOptions(
        instructions: "ä½ æ˜¯ä¸€ä¸ªä¼ä¸šé‚®ä»¶åŠ©æ‰‹ï¼Œä¸ºå®¢æˆ·é‚®ä»¶ç”Ÿæˆä¸“ä¸šã€å‹å¥½çš„ä¸­æ–‡å›å¤ã€‚"
    )
    {
        ChatOptions \= new ChatOptions
        {
            ResponseFormat \= ChatResponseFormat.ForJsonSchema<EmailResponse>()
        }
    }
);

### é‚®ä»¶è½¬å‘ï¼šæ¨¡æ‹Ÿé‚®ä»¶è½¬å‘åˆ°å…·ä½“çš„å®¢æœï¼Œè¿™é‡Œä»…ä»…ä½¿ç”¨YieldOutputAsyncå®Œæˆå·¥ä½œæµè¾“å‡ºæ¶ˆæ¯å†…å®¹ã€‚

internal sealed class EmailSendingExecutor() : Executor<EmailResponse>("EmailSendingExecutor")
{
    public override async ValueTask HandleAsync(EmailResponse message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        // æ¨¡æ‹Ÿé‚®ä»¶å‘é€ï¼ˆå®é™…é¡¹ç›®ä¸­å¯è°ƒç”¨ SMTPã€SendGrid ç­‰æœåŠ¡ï¼‰
        await context.YieldOutputAsync(
            $"ğŸ“¤ é‚®ä»¶å·²å‘é€: {message.Response}",
            cancellationToken
        );
    }
}

ä¸‹æ¸¸èŠ‚ç‚¹Bï¼šåƒåœ¾é‚®ä»¶å¤„ç†
------------

å½“åˆ¤æ–­åˆ°æ˜¯åƒåœ¾é‚®ä»¶æ—¶ï¼Œè½¬äº¤ç»™è¯¥æ‰§è¡Œå™¨å¤„ç†ï¼Œè¿™é‡Œæ¨¡æ‹Ÿè¾“å‡ºäº†ä¸€æ®µé£é™©æç¤ºï¼Œå®é™…ä¸­å¯èƒ½æ˜¯ä¸ŠæŠ¥äººå·¥è·Ÿè¿›ç­‰ç­‰æ“ä½œï¼š

internal sealed class SpamHandlingExecutor() : Executor<DetectionResult>("SpamHandlingExecutor")
{
    public override async ValueTask HandleAsync(DetectionResult message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        // ğŸ›¡ï¸ é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿åªå¤„ç†åƒåœ¾é‚®ä»¶
        if (message.spamDecision != SpamDecision.Spam)
            throw new InvalidOperationException(
                "SpamHandlingExecutor åªåº”å¤„ç† Spam ç±»å‹çš„é‚®ä»¶ï¼Œè¯·æ£€æŸ¥è·¯ç”±é…ç½®ã€‚"
            );

        // è®°å½•åƒåœ¾é‚®ä»¶ï¼ˆå®é™…é¡¹ç›®ä¸­å¯å†™å…¥æ•°æ®åº“æˆ–æ—¥å¿—ç³»ç»Ÿï¼‰
        await context.YieldOutputAsync(
            $"ğŸš« åƒåœ¾é‚®ä»¶å·²æ‹¦æˆª: {message.Reason}",
            cancellationToken
        );
    }
}

ä¸‹æ¸¸èŠ‚ç‚¹Cï¼šä¸ç¡®å®šé‚®ä»¶å¤„ç†æ‰§è¡Œå™¨ï¼ˆå…œåº•å¤„ç†ï¼‰
----------------------

å½“åˆ¤æ–­åˆ°å±äºä¸ç¡®å®šçš„é‚®ä»¶åˆ†ç±»æ—¶ï¼Œè½¬äº¤ç»™è¯¥æ‰§è¡Œå™¨åšå…œåº•å¤„ç† æˆ– é»˜è®¤å¤„ç†ï¼š

internal class UncertainHandlingExecutor() : Executor<DetectionResult>("UncertainHandlingExecutor")
{
    public override async ValueTask HandleAsync(
        DetectionResult message,
        IWorkflowContext context,
        CancellationToken cancellationToken \= default)
    {
        // ğŸ›¡ï¸ é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿åªå¤„ç†ä¸ç¡®å®šé‚®ä»¶
        if (message.spamDecision != SpamDecision.UnCertain)
            throw new InvalidOperationException(
                "UncertainHandlingExecutor åªåº”å¤„ç† Uncertain ç±»å‹çš„é‚®ä»¶ï¼ˆæˆ–ä½œä¸º Default Caseï¼‰ã€‚"
            );

        // 1ï¸âƒ£ ä» Shared State è¯»å–åŸå§‹é‚®ä»¶å†…å®¹ï¼ˆç”¨äºäººå·¥å®¡æ ¸ï¼‰
        var email = await context.ReadStateAsync<EmailMessage>(
            message.EmailId,
            scopeName: EmailStateConstants.EmailStateScope,
            cancellationToken
        );

        // 2ï¸âƒ£ è¾“å‡ºå¾…å®¡æ ¸ä¿¡æ¯
        await context.YieldOutputAsync(
            $"âš ï¸ ä¸ç¡®å®šé‚®ä»¶éœ€äººå·¥å®¡æ ¸:\\n" +
            $"åŸå› : {message.Reason}\\n" +
            $"å†…å®¹é¢„è§ˆ: {email?.EmailContent?.Substring(0, Math.Min(100, email.EmailContent.Length))}...",
            cancellationToken
        );
    }
}

æ„å»ºå·¥ä½œæµ
-----

ç°åœ¨ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸€ä¸ªWorkflowï¼Œç°åœ¨Let's do it!

**Step1:** è·å–ChatClient

var chatClient = new OpenAIClient(
        new ApiKeyCredential(openAIProvider.ApiKey),
        new OpenAIClientOptions { Endpoint = new Uri(openAIProvider.Endpoint) })
    .GetChatClient(openAIProvider.ModelId)
    .AsIChatClient();

**Step2:** å®ä¾‹åŒ–è‡ªå®šä¹‰Agent & Executors

var spamDetectionExecutor = new SpamDetectionExecutor(spamDetectionAgent);
var emailAssistantExecutor = new EmailAssistantExecutor(emailAssistantAgent);
var sendEmailExecutor = new EmailSendingExecutor();
var handleSpamExecutor = new SpamHandlingExecutor();
var handleUncertainExecutor = new UncertainHandlingExecutor();

**Step3:** åˆ›å»ºswitch-caseå¤šè·¯ç”±å†³ç­–å·¥ä½œæµ

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ”§ æ¡ä»¶å‡½æ•°å·¥å‚æ–¹æ³•
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Func<object?, bool\> GetCondition(SpamDecision expectedDecision) =>
    detectionResult \=>
        detectionResult is DetectionResult result &&
        result.spamDecision \== expectedDecision;

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ”€ ä½¿ç”¨ AddSwitch æ„å»º Switch-Case å·¥ä½œæµ
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
var builder = new WorkflowBuilder(spamDetectionExecutor);
builder.AddSwitch(spamDetectionExecutor, sb \=>
        sb
            // Case 1: NotSpam â†’ EmailAssistant 
            .AddCase(GetCondition(expectedDecision: SpamDecision.NotSpam), new\[\] { (ExecutorBinding)emailAssistantExecutor })
            // Case 2: Spam â†’ HandleSpam
            .AddCase(GetCondition(expectedDecision: SpamDecision.Spam), new\[\] { (ExecutorBinding)handleSpamExecutor })
            // Default: Uncertain (æˆ–ä»»ä½•æœªåŒ¹é…çš„æƒ…å†µ) â†’ HandleUncertain
            .WithDefault(new\[\] { (ExecutorBinding)handleUncertainExecutor })
    )
    // EmailAssistant ä¹‹åè‡ªåŠ¨å‘é€é‚®ä»¶
    .AddEdge(emailAssistantExecutor, sendEmailExecutor)
    // é…ç½®è¾“å‡ºèŠ‚ç‚¹ï¼ˆä¸‰ä¸ªç»ˆç‚¹æ‰§è¡Œå™¨éƒ½ä¼šäº§ç”Ÿè¾“å‡ºï¼‰
    .WithOutputFrom(handleSpamExecutor, sendEmailExecutor, handleUncertainExecutor);
var workflow = builder.Build();

Console.OutputEncoding \= Encoding.UTF8;
Console.WriteLine("âœ… Conditional Workflow æ„å»ºå®Œæˆ");

æµ‹è¯•å·¥ä½œæµ
-----

é¦–å…ˆï¼Œä¸ºäº†ä¾¿äºåç»­æµ‹è¯•æˆ‘ä»¬å°†æ‰§è¡Œå·¥ä½œæµå°è£…ä¸ºä¸€ä¸ªé™æ€æ–¹æ³•ï¼š

static async Task RunWorkflowAsync(
    Workflow workflow,
    string scenarioName,
    string emailContent)
{
    Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    Console.WriteLine($"ğŸ“¬ æµ‹è¯•åœºæ™¯ï¼š{scenarioName}");
    Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    Console.WriteLine($"ğŸ“§ é‚®ä»¶å†…å®¹ï¼š{emailContent.Substring(0, Math.Min(80, emailContent.Length))}...\\n");
    await using var run = await InProcessExecution.StreamAsync(
        workflow,
        new ChatMessage(ChatRole.User, emailContent)
    );
    // å‘é€ Turn Tokenï¼Œå¯ç”¨äº‹ä»¶æ¨é€
    await run.TrySendMessageAsync(new TurnToken(emitEvents: true));
    // è®¢é˜…äº‹ä»¶æµ
    await foreach (WorkflowEvent evt in run.WatchStreamAsync())
    {
        switch (evt)
        {
            case ExecutorCompletedEvent completedEvent:
                Console.WriteLine($"âœ… {completedEvent.ExecutorId} å®Œæˆ");
                break;
            case WorkflowOutputEvent outputEvent:
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                Console.WriteLine("ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ");
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n");
                Console.WriteLine($"{outputEvent.Data}");
                break;
            case WorkflowErrorEvent errorEvent:
                Console.WriteLine("âœ¨ æ”¶åˆ° Workflow Error Eventï¼š");
                Console.WriteLine($"{errorEvent.Data}");
                break;
            default:
                break;
        }
    }
    Console.WriteLine();
}

**æµ‹è¯•ç”¨ä¾‹1ï¼š**æ­£å¸¸å’¨è¯¢é‚®ä»¶è¾“å…¥

var scenarioName1 = "æ­£å¸¸é‚®ä»¶ â†’ EmailAssistant â†’ SendEmail";
var emailContent1 = @"
å°Šæ•¬çš„å®¢æœå›¢é˜Ÿï¼š
æ‚¨å¥½ï¼æˆ‘æ˜¯è´µå…¬å¸çš„é•¿æœŸå®¢æˆ·ï¼Œè®¢å•å·ä¸º 
#2025
-001ã€‚
æˆ‘æƒ³ç¡®è®¤ä¸€ä¸‹ä¸Šå‘¨æäº¤çš„é‡‡è´­è®¢å•æ˜¯å¦å·²ç»å®‰æ’å‘è´§ã€‚
å¦‚æœéœ€è¦è¡¥å……ä»»ä½•ä¿¡æ¯ï¼Œè¯·éšæ—¶å‘ŠçŸ¥ã€‚
æœŸå¾…æ‚¨çš„å›å¤ï¼Œè°¢è°¢ï¼
å®¢æˆ·ï¼šå¼ å…ˆç”Ÿ
";
await RunWorkflowAsync(workflow, scenarioName1, emailContent1);
Console.WriteLine("âœ… æ­£å¸¸é‚®ä»¶è·¯å¾„éªŒè¯å®Œæˆ");

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202754097-83329301.png)

å¯ä»¥çœ‹è§ï¼Œå¯¹äºæ­£å¸¸å’¨è¯¢é‚®ä»¶ï¼Œè¿›è¡Œæ­£å¸¸çš„é‚®ä»¶å¤„ç†å’Œè½¬å‘ã€‚

**æµ‹è¯•ç”¨ä¾‹2ï¼š**åƒåœ¾é‚®ä»¶è¾“å…¥

var scenarioName2 = "åƒåœ¾é‚®ä»¶ â†’ HandleSpam";
var emailContent2 = @"
ğŸ‰ğŸ‰ğŸ‰ æ­å–œæ‚¨ä¸­å¥–å•¦ï¼ğŸ‰ğŸ‰ğŸ‰

æ‚¨å·²è¢«é€‰ä¸­è·å¾— 100 ä¸‡ç°é‡‘å¤§å¥–ï¼

ç«‹å³ç‚¹å‡»ä»¥ä¸‹é“¾æ¥é¢†å–ï¼š
http://suspicious-site.com/claim-prize

ä»…é™ä»Šæ—¥æœ‰æ•ˆï¼Œè¿‡æœŸä½œåºŸï¼
ä¸éœ€è¦ä»»ä½•æ‰‹ç»­è´¹ï¼Œå®Œå…¨å…è´¹ï¼

å¿«é€Ÿè¡ŒåŠ¨ï¼Œæœºä¸å¯å¤±ï¼
";
await RunWorkflowAsync(workflow, scenarioName2, emailContent2);
Console.WriteLine("âœ… åƒåœ¾é‚®ä»¶è·¯å¾„éªŒè¯å®Œæˆ");

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202904798-37631196.png)

å¯ä»¥çœ‹è§ï¼Œå¯¹äºåƒåœ¾é‚®ä»¶ï¼Œè¿›è¡Œæœ‰æ•ˆçš„æ‹¦æˆªï¼Œåç»­è¿˜å¯ä»¥è¿›è¡Œä¸ŠæŠ¥äººå·¥è·Ÿè¸ªç­‰ç­‰ã€‚

**æµ‹è¯•ç”¨ä¾‹3ï¼š**æ— æ³•ç¡®è®¤ç±»å‹çš„é‚®ä»¶è¾“å…¥

var uncertainEmail = @"
ä¸»é¢˜ï¼šéœ€è¦éªŒè¯æ‚¨çš„è´¦æˆ·
å°Šæ•¬çš„å®¢æˆ·ï¼š
æˆ‘ä»¬æ£€æµ‹åˆ°æ‚¨çš„è´¦æˆ·å­˜åœ¨å¼‚å¸¸æ´»åŠ¨ï¼Œéœ€è¦éªŒè¯æ‚¨çš„èº«ä»½ä»¥ç¡®ä¿è´¦æˆ·å®‰å…¨ã€‚
è¯·ç™»å½•æ‚¨çš„è´¦æˆ·å¹¶å®ŒæˆéªŒè¯æµç¨‹ï¼Œä»¥ç»§ç»­ä½¿ç”¨æœåŠ¡ã€‚
è´¦æˆ·è¯¦æƒ…ï¼š
- ç”¨æˆ·åï¼šjohndoe@contoso.com
- æœ€åç™»å½•ï¼š08/15/2025
- ç™»å½•åœ°ç‚¹ï¼šè¥¿é›…å›¾ï¼Œåç››é¡¿å·
- ç™»å½•è®¾å¤‡ï¼šç§»åŠ¨è®¾å¤‡
è¿™æ˜¯ä¸€é¡¹è‡ªåŠ¨å®‰å…¨æªæ–½ã€‚å¦‚æœæ‚¨è®¤ä¸ºæ­¤é‚®ä»¶æ˜¯é”™è¯¯å‘é€çš„ï¼Œè¯·ç«‹å³è”ç³»æˆ‘ä»¬çš„æ”¯æŒå›¢é˜Ÿã€‚
æ­¤è‡´
å®‰å…¨å›¢é˜Ÿ
å®¢æˆ·æœåŠ¡éƒ¨é—¨
";
await RunWorkflowAsync(
    workflow,
    "ä¸ç¡®å®šé‚®ä»¶ â†’ HandleUncertain (Default)",
    uncertainEmail
);
Console.WriteLine("âœ… ä¸ç¡®å®šé‚®ä»¶è·¯å¾„éªŒè¯å®Œæˆ");

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251224202940842-749043447.png)

å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºLLMæ— æ³•ç¡®è®¤çš„ç±»å‹ï¼Œè¿›å…¥äº†è¯¥æ‰§è¡Œå™¨ï¼Œè¿™æ—¶å¯èƒ½éœ€è¦äººå·¥ä»‹å…¥å®¡æ ¸ã€‚åŒæ—¶ï¼Œè¿™ä¹Ÿæ˜¯å®é™…ä¸­å¸¸è§çš„ä¸€ç§å…œåº•æœºåˆ¶çš„å±•ç°ï¼Œè¯å¥è¯è¯´ï¼š**å³ä½¿AIæ— æ³•æ˜ç¡®åˆ¤æ–­ï¼Œä¹Ÿåº”è¯¥æœ‰å¯¹åº”çš„å¤„ç†æµç¨‹**ã€‚

**å°ç»“**
======

æœ¬æ–‡ä»‹ç»äº†MAFä¸­çš„switch-caseè·¯ç”±ä»¥åŠå¦‚ä½•å®ç°å¤šæ¡ä»¶è·¯ç”±ï¼Œæœ€åä¼˜åŒ–äº†ä¸Šä¸€ç¯‡çš„ä¼ä¸šå†…éƒ¨é‚®ä»¶æ£€æµ‹å·¥ä½œæµæ¡ˆä¾‹ï¼Œç‰¹åˆ«é€‚åˆäºå¤§äº3ä¸ªåˆ†æ”¯çš„å¤æ‚è·¯ç”±åœºæ™¯ã€‚

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ MAFä¸­å·¥ä½œæµçš„å¾ªç¯å·¥ä½œæµã€‚

å‚è€ƒèµ„æ–™
====

åœ£æ°ï¼Œã€Š[.NET + AI æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹ï¼ˆæ¨èæŒ‡æ•°ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼‰

Microsoft Learnï¼Œã€Š[Agent Framework Tutorials](https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview?wt.mc_id=MVP_397012)ã€‹

![](https://images.cnblogs.com/cnblogs_com/edisonchou/1647700/o_200902144330EdisonTalk-Footer.jpg)

ä½œè€…ï¼šçˆ±è¿ªç”Ÿ

å‡ºå¤„ï¼š[https://edisontalk.cnblogs.com](https://edisontalk.cnblogs.com "from")

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ã€‚

[![](http://service.t.sina.com.cn/widget/qmd/2068032061/d643d182/10.png)](https://weibo.com/u/2068032061?s=6uyXnP)