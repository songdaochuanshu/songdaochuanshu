---
layout: post
title: 'Rsync + Sersync 实时数据同步方案'
date: "2025-08-11T00:47:55Z"
---
Rsync + Sersync 实时数据同步方案
========================

**方案架构**

*   **源服务器**：部署 Sersync（监控文件变化） + Rsync（推送数据）
*   **目标服务器**：部署 Rsync Daemon（接收数据）
*   **同步逻辑**：源服务器文件变动 → Sersync 实时触发 → Rsync 增量同步至目标服务器

* * *

**详细实施步骤**

**一、目标服务器配置（数据接收端）**

1.  **安装 Rsync**

bash

yum install rsync -y  _\# CentOS_

apt install rsync -y  _\# Ubuntu_

2.  **创建 Rsync 配置文件**

bash

vim /etc/rsyncd.conf

ini

uid = root

gid = root

use chroot = no

max connections = 2000

pid file = /var/run/rsyncd.pid

lock file = /var/run/rsync.lock

log file = /var/log/rsyncd.log

\[data\_backup\]  # 模块名称（客户端同步时指定）

path = /data/backup  # 同步目录

comment = Backup Directory

read only = no  # 允许写入

auth users = rsync\_user  # 认证用户

secrets file = /etc/rsync.password  # 密码文件

3.  **创建认证文件**

bash

echo "rsync\_user:your\_password" > /etc/rsync.password

chmod 600 /etc/rsync.password

4.  **创建同步目录**

bash

mkdir -p /data/backup

chown -R rsync\_user:rsync\_user /data/backup

5.  **启动 Rsync 守护进程**

bash

systemctl start rsyncd

systemctl enable rsyncd

6.  **开放防火墙端口**

bash

firewall-cmd --add-port=873/tcp --permanent

firewall-cmd --reload

* * *

**二、源服务器配置（数据发送端）**

1.  **安装 Rsync**

bash

yum install rsync -y  _\# CentOS_

apt install rsync -y  _\# Ubuntu_

2.  **创建 Rsync 密码文件**

bash

echo "your\_password" > /etc/rsync.password

chmod 600 /etc/rsync.password

3.  **测试手动同步**

bash

rsync -avz /source/data/ rsync\_user@目标服务器IP::data\_backup --password-file=/etc/rsync.password

*   **作用**：验证配置正确性，确保网络和权限正常。

4.  **安装 Sersync**

bash

wget https://github.com/wsgzao/sersync/raw/master/sersync2.5.4\_64bit\_binary\_stable\_final.tar.gz

tar -zxvf sersync2.5.4\_64bit\_binary\_stable\_final.tar.gz -C /opt/

mv /opt/GNU-Linux-x86/ /opt/sersync

5.  **修改 Sersync 配置文件**

bash

vim /opt/sersync/confxml.xml

xml

_<!-- 监控目录设置 -->_

<localpath watch="/source/data">  _<!--_ _源服务器需同步的目录 -->_

    <remote ip="目标服务器IP" name="data\_backup"/>  _<!--_ _目标服务器模块名 -->_

</localpath>

_<!-- Rsync 参数 -->_

<rsync>

    <commonParams params="-artuz"/>  # 归档模式（保留属性）

    <auth start="true" users="rsync\_user" passwordfile="/etc/rsync.password"/>

    <timeout start="false" time="100"/>  _<!--_ _超时设置 -->_

</rsync>

6.  **启动 Sersync**

bash

/opt/sersync/sersync2 -d -r -o /opt/sersync/confxml.xml

*   **参数说明**：

*   **\-d**：守护进程模式
*   **\-r**：启动时先全量同步
*   **\-o**：指定配置文件

7.  **设置开机自启**

bash

echo "/opt/sersync/sersync2 -d -r -o /opt/sersync/confxml.xml" >> /etc/rc.local

chmod +x /etc/rc.local

* * *

**三、验证实时同步**

1.  **在源服务器创建测试文件**

bash

touch /source/data/testfile.txt

2.  **检查目标服务器同步结果**

bash

ls /data/backup  _\#_ _应出现 testfile.txt_

3.  **查看 Sersync 日志**

bash

tail -f /opt/sersync/rsync\_fail\_log.sh  _\#_ _同步失败日志_

* * *

**四、多维优化与监控**

**1\. 性能优化**

*   **调整 inotify 限制**（解决监控文件数不足问题）：

bash

echo "fs.inotify.max\_user\_watches=1000000" >> /etc/sysctl.conf

sysctl -p

*   **Rsync 带宽限制**（避免影响业务）：

xml

_<!-- 在 confxml.xml 中增加 -->_

<commonParams params="--bwlimit=10240 -artuz"/>  _<!--_ _限速 10MB/s -->_

**2\. 高可用方案**

*   **双活监控**：部署多个 Sersync 进程监控不同目录。
*   **异常重启**：添加 crontab 监控进程：

bash

\*/5 \* \* \* \* pgrep sersync2 || /opt/sersync/sersync2 -d -o /opt/sersync/confxml.xml

**3\. 安全加固**

*   **Rsync 最小权限**：

*   目标服务器使用非 root 用户运行 Rsync。
*   配置文件设置 **uid = rsync\_user**, **gid = rsync\_user**。

*   **SSH 隧道加密**：

xml

_<!-- 修改 confxml.xml -->_

<rsync>

    <ssh start="true" port="22" user="rsync\_user"/>

</rsync>

**4\. 故障排查工具**

*   **手动触发同步**：

bash

/opt/sersync/sersync2 -r -o /opt/sersync/confxml.xml

*   **查看 inotify 事件**：

bash

tail -f /proc/sys/fs/inotify/\*  _\#_ _监控事件队列_

* * *

**方案优势**

1.  **秒级延迟**：Sersync 基于 inotify 内核事件触发，响应速度 <1s。
2.  **增量高效**：Rsync 只同步变化部分，节省带宽。
3.  **低资源占用**：Sersync 单进程设计，CPU/内存消耗极低。
4.  **断点续传**：Rsync 支持传输中断后续传。

**注意**：大规模集群建议使用 **Lsyncd** 或 **DRBD**，单服务器场景本方案为最优解。