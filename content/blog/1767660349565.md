---
layout: post
title: '.NET ä¼ ç»Ÿä¿¡æ¯ç³»ç»Ÿæ— ç¼é›†æˆé£ä¹¦å®¡æ‰¹æµ'
date: "2026-01-06T00:45:49Z"
---
.NET ä¼ ç»Ÿä¿¡æ¯ç³»ç»Ÿæ— ç¼é›†æˆé£ä¹¦å®¡æ‰¹æµ
====================

> å‘¨æœ«æ·±å¤œï¼Œä½ æ”¶åˆ°ç´§æ€¥å®¡æ‰¹é€šçŸ¥â€”â€”å´å‘ç°åªèƒ½åœ¨ PC ç«¯å¤„ç†ï¼Œåªèƒ½æ‘¸é»‘èµ·åºŠå¼€ç”µè„‘â€¦â€¦

è¿™æ ·çš„åœºæ™¯ï¼Œä½ æ˜¯å¦ä¹Ÿç»å†è¿‡ï¼Ÿ

**ä¼ ç»Ÿ .NET ç³»ç»Ÿä¸ç°ä»£ç§»åŠ¨ååŒä¹‹é—´çš„é¸¿æ²Ÿï¼Œæ­£åœ¨æ‚„æ‚„åå™¬ç€ä¼ä¸šçš„æ•ˆç‡**ã€‚å®¡æ‰¹å¡åœ¨æ¡Œé¢ç«¯ã€é€šçŸ¥æ»åã€æ•°æ®å­¤å²›â€”â€”è¿™äº›é—®é¢˜è®©å·¥ä½œä½“éªŒå¤§æ‰“æŠ˜æ‰£ã€‚

æ¨å€’é‡æ¥ï¼Ÿæˆæœ¬å¤ªé«˜ï¼Œé£é™©å¤ªå¤§ã€‚

**æœ¬æ–‡å°†å¸¦ä½ èµ°ä¸€æ¡æ¸è¿›å¼æ”¹é€ ä¹‹è·¯**ï¼šä¿æŒ .NET ç³»ç»Ÿä½œä¸ºä¸šåŠ¡æ ¸å¿ƒï¼Œå°†é£ä¹¦å®¡æ‰¹ä½œä¸ºç§»åŠ¨é—¨æˆ·ï¼Œé€šè¿‡ API å®ç°æ— ç¼ååŒã€‚ä»åŸç†ã€è®¾è®¡åˆ°ç¼–ç ï¼Œå®Œæ•´å‘ˆç°å¦‚ä½•è®©ä¼ ç»Ÿç³»ç»Ÿç„•å‘æ–°ç”Ÿï¼Œå®ç°ç§»åŠ¨åŒ–ã€å®æ—¶åŒ–çš„ç°ä»£åŒ–å‡çº§ã€‚

æ— è®ºä½ æ˜¯å¼€å‘è€…ã€æ¶æ„å¸ˆè¿˜æ˜¯æŠ€æœ¯ç®¡ç†è€…ï¼Œéƒ½èƒ½æ”¶è·ä¸€å¥—å¯è½åœ°ã€å¯æ‰©å±•çš„é›†æˆæ–¹æ¡ˆå’Œç›´æ¥å¤ç”¨çš„ä»£ç å®è·µã€‚

å½“ä¼ ç»Ÿä¸šåŠ¡é‡ä¸Šç°ä»£ååŒï¼Œä¸ºä½•å¿…é¡»"ç ´å£"ï¼Ÿ
---------------------

### æˆ‘ä»¬æ­£åœ¨è§£å†³ä»€ä¹ˆï¼Ÿ

**ä¼ ç»Ÿ .NET ç³»ç»Ÿçš„å±€é™**

è®¸å¤šä¼ä¸šæ‹¥æœ‰å¤šå¹´ç´¯ç§¯çš„ .NET ä¸šåŠ¡ç³»ç»Ÿï¼Œè¿™äº›ç³»ç»Ÿåœ¨ä¼ä¸šè¿è¥ä¸­æ‰®æ¼”ç€æ ¸å¿ƒè§’è‰²ã€‚ç„¶è€Œï¼Œéšç€ç§»åŠ¨åŠå…¬å’Œç°ä»£ååŒå·¥å…·çš„æ™®åŠï¼Œè¿™äº›ä¼ ç»Ÿç³»ç»Ÿæ­£é¢ä¸´ç€ä¸¥å³»çš„æŒ‘æˆ˜ï¼š

ç—›ç‚¹

å…·ä½“è¡¨ç°

ä¸šåŠ¡å½±å“

**å®¡æ‰¹æµç¨‹å°é—­**

å®¡æ‰¹åªèƒ½åœ¨æ¡Œé¢ç«¯å®Œæˆï¼Œæ— æ³•éšæ—¶éšåœ°å¤„ç†

ç§»åŠ¨åŠå…¬å—é˜»ï¼Œå“åº”è¿Ÿç¼“

**é€šçŸ¥æ–¹å¼æ»å**

ä¾èµ–é‚®ä»¶æˆ–ç«™å†…æ¶ˆæ¯æ¨é€

å®¡æ‰¹äººåŠæ—¶æ€§å·®ï¼Œæµç¨‹å»¶è¯¯

**æ•°æ®å­¤å²›ä¸¥é‡**

å®¡æ‰¹æ•°æ®ä¸ä¸šåŠ¡æ•°æ®åˆ†ç¦»

æ— æ³•å½¢æˆå®Œæ•´çš„ä¸šåŠ¡é—­ç¯

**ç”¨æˆ·ä½“éªŒé™ˆæ—§**

ç•Œé¢é£æ ¼é™ˆæ—§ï¼Œäº¤äº’ä½“éªŒå·®

ç”¨æˆ·æ»¡æ„åº¦ä½ï¼Œä½¿ç”¨æ„æ„¿ä¸‹é™

**é£ä¹¦å®¡æ‰¹çš„èµ‹èƒ½ä»·å€¼**

é£ä¹¦å®¡æ‰¹ä½œä¸ºä¼ä¸šçº§çš„å®¡æ‰¹åä½œå¹³å°ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç†æƒ³çš„"æµç¨‹åä½œä¸­å¿ƒ"ï¼š

graph LR A\[é£ä¹¦å®¡æ‰¹å¹³å°\] --> B\[ç§»åŠ¨ä¼˜å…ˆ\] A --> C\[å³æ—¶å¼ºé€šçŸ¥\] A --> D\[æµç¨‹å¯è§†åŒ–\] A --> E\[å®Œå–„å®¡è®¡æ—¥å¿—\] B --> B1\[éšæ—¶éšåœ°å¤„ç†å®¡æ‰¹\] C --> C1\[Appæ¨é€/çŸ­ä¿¡æé†’\] D --> D1\[æ‹–æ‹½å¼æµç¨‹é…ç½®\] E --> E1\[å®Œæ•´æ“ä½œç—•è¿¹è¿½æº¯\]

**æˆ‘ä»¬çš„æ ¸å¿ƒç›®æ ‡**

é€šè¿‡æœ¬æ–‡çš„å®è·µï¼Œæˆ‘ä»¬å°†å»ºç«‹ **".NET ç³»ç»Ÿä¸ºä¸šåŠ¡æ ¸å¿ƒï¼Œé£ä¹¦å®¡æ‰¹ä¸ºæµç¨‹é—¨æˆ·"** çš„ç°ä»£åŒ–æ··åˆæ¶æ„ï¼š

> **æ¶æ„æ„¿æ™¯**ï¼šå°†é£ä¹¦å®¡æ‰¹ä½œä¸ºç»Ÿä¸€çš„ç§»åŠ¨å®¡æ‰¹é—¨æˆ·ï¼Œä¿æŒ .NET ç³»ç»Ÿä½œä¸ºä¸šåŠ¡é€»è¾‘å’Œæ•°æ®å­˜å‚¨çš„æ ¸å¿ƒï¼Œé€šè¿‡ API å®æ—¶åŒæ­¥ï¼Œå½¢æˆä¼˜åŠ¿äº’è¡¥çš„ååŒä½“ç³»ã€‚

### ä½ å°†æ”¶è·ä»€ä¹ˆï¼Ÿ

*   âœ… **ä¸€å¥—ç«¯åˆ°ç«¯çš„é›†æˆæ–¹æ³•è®º**ï¼Œè¦†ç›–ä»åŸç†ã€è®¾è®¡åˆ°éƒ¨ç½²çš„å…¨æµç¨‹
*   âœ… **æ¸…æ™°çš„ .NET ä¾§æ¶æ„è“å›¾**ï¼ŒåŒ…å«å…³é”®çš„æŠ€æœ¯é€‰å‹ä¸è®¾è®¡å†³ç­–
*   âœ… **å¯ç›´æ¥å¤ç”¨çš„ C# æ ¸å¿ƒä»£ç **ä¸å®è·µä¸­æ€»ç»“çš„"é¿å‘æŒ‡å—"
*   âœ… **ä¸€ä¸ªå®Œæ•´çš„"è¯·å‡å®¡æ‰¹"å®æˆ˜æ¡ˆä¾‹**ï¼ŒåŠ©ä½ ä»é›¶åˆ°ä¸€å®ŒæˆéªŒè¯

* * *

é£ä¹¦å®¡æ‰¹å¼€æ”¾å¹³å°å¦‚ä½•ä¸æˆ‘ä»¬"å¯¹è¯"ï¼Ÿ
------------------

### åŒå‘é›†æˆçš„å…³é”®æµç¨‹

é£ä¹¦å®¡æ‰¹ä¸ .NET ç³»ç»Ÿçš„é›†æˆæ˜¯ä¸€ä¸ª**åŒå‘æ•°æ®æµ**çš„è¿‡ç¨‹ï¼š

sequenceDiagram participant User as ç”¨æˆ· participant NET as .NETç³»ç»Ÿ participant API as é£ä¹¦API participant FS as é£ä¹¦App Note over User,FS: æµç¨‹è¾“å‡ºï¼šå‘èµ·å®¡æ‰¹ User->>NET: 1. æäº¤è¯·å‡ç”³è¯· NET->>NET: 2. ä¿å­˜ä¸šåŠ¡æ•°æ®ï¼ˆçŠ¶æ€ï¼šå®¡æ‰¹ä¸­ï¼‰ NET->>API: 3. è°ƒç”¨ CreateInstanceAsync API-->>NET: 4. è¿”å› instance\_code NET->>NET: 5. å…³è”ä¸šåŠ¡IDä¸instance\_code Note over User,FS: æµç¨‹è¾“å…¥ï¼šå›è°ƒé€šçŸ¥ User->>FS: 6. åœ¨é£ä¹¦Appä¸­å®¡æ‰¹ FS->>API: 7. å®¡æ‰¹å®Œæˆ API->>NET: 8. Webhookå›è°ƒäº‹ä»¶ NET->>NET: 9. æ ¹æ®instance\_codeæ›´æ–°ä¸šåŠ¡çŠ¶æ€

#### æµç¨‹è¾“å‡ºï¼ˆå‘èµ·é˜¶æ®µï¼‰

å½“ç”¨æˆ·åœ¨ .NET ç³»ç»Ÿå‘èµ·å®¡æ‰¹æ—¶ï¼Œç³»ç»Ÿä¼šï¼š

1.  ä¿å­˜ä¸šåŠ¡æ•°æ®ï¼ŒçŠ¶æ€æ ‡è®°ä¸º"å®¡æ‰¹ä¸­"
2.  è°ƒç”¨é£ä¹¦ API `CreateInstanceAsync` åˆ›å»ºå®¡æ‰¹å®ä¾‹
3.  æ¥æ”¶è¿”å›çš„ `instance_code`ï¼ŒæŒä¹…åŒ–åˆ°å…³è”è¡¨

#### æµç¨‹è¾“å…¥ï¼ˆå›è°ƒé˜¶æ®µï¼‰

å½“å®¡æ‰¹äººåœ¨é£ä¹¦ App å®Œæˆå®¡æ‰¹åï¼š

1.  é£ä¹¦æœåŠ¡å™¨ä¸»åŠ¨å›è°ƒ .NET ç³»ç»Ÿçš„ Webhook æ¥å£
2.  .NET ç³»ç»Ÿè§£æäº‹ä»¶ï¼Œæå– `instance_code` å’Œ `status`
3.  æ ¹æ®å…³è”è¡¨æŸ¥è¯¢å¯¹åº”çš„ä¸šåŠ¡è®°å½•
4.  æ›´æ–°ä¸šåŠ¡çŠ¶æ€ï¼Œå®Œæˆé—­ç¯

### å¿…é¡»ç†è§£çš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

#### å®¡æ‰¹å®šä¹‰ï¼ˆapproval\_codeï¼‰

**å®¡æ‰¹å®šä¹‰**æ˜¯å®¡æ‰¹æµç¨‹çš„"è“å›¾"ï¼Œåœ¨é£ä¹¦ç®¡ç†åå°é…ç½®ï¼š

    // ç¤ºä¾‹ï¼šè¯·å‡å®¡æ‰¹çš„å®¡æ‰¹å®šä¹‰
    var approvalCode = "7C468A54-8745-2245-9675-08B7C63E7A85";
    

**å®šä¹‰åŒ…å«**ï¼š

*   è¡¨å•ç»“æ„ï¼ˆè¯·å‡ç±»å‹ã€å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€è¯·å‡äº‹ç”±ç­‰ï¼‰
*   å®¡æ‰¹æµç¨‹ï¼ˆç›´å±ä¸»ç®¡å®¡æ‰¹ â†’ äººäº‹å®¡æ‰¹ï¼‰
*   æƒé™è®¾ç½®ï¼ˆè°å¯ä»¥å‘èµ·ã€è°å¯ä»¥å®¡æ‰¹ï¼‰

#### å®¡æ‰¹å®ä¾‹ï¼ˆinstance\_codeï¼‰

**å®¡æ‰¹å®ä¾‹**æ˜¯ä¾æ®å®¡æ‰¹å®šä¹‰å‘èµ·çš„ä¸€æ¬¡å…·ä½“å®¡æ‰¹ä»»åŠ¡ï¼š

    // åˆ›å»ºå®¡æ‰¹å®ä¾‹æ—¶è¿”å›
    public record CreateInstancesResult
    {
        /// <summary>
        /// å®¡æ‰¹å®ä¾‹ Code
        /// </summary>
        [JsonPropertyName("instance_code")]
        public string InstanceCode { get; set; } = string.Empty;
    }
    

**å…³é”®å±æ€§**ï¼š

*   å”¯ä¸€æ ‡è¯†ä¸€æ¬¡å®¡æ‰¹æµç¨‹
*   åŒ…å«è¯¥æ¬¡å®¡æ‰¹çš„æ‰€æœ‰è¡¨å•æ•°æ®
*   æ‹¥æœ‰ç‹¬ç«‹çš„çŠ¶æ€ï¼ˆå®¡æ‰¹ä¸­ã€é€šè¿‡ã€æ‹’ç»ã€æ’¤å›ç­‰ï¼‰

#### èº«ä»½æ˜ å°„ï¼ˆå…ç™»ï¼‰

å®ç° .NET ç³»ç»Ÿç”¨æˆ·ä¸é£ä¹¦ç”¨æˆ·çš„å…³è”ï¼š

graph LR A\[.NETç³»ç»Ÿç”¨æˆ·<br/>UserId: 1001\] -->|æ˜ å°„å…³ç³»| B\[é£ä¹¦ç”¨æˆ·<br/>OpenId: ou\_3cda9c...\] B -->|é€šè¿‡é£ä¹¦Appå®¡æ‰¹| C\[å®¡æ‰¹å®Œæˆ\] C -->|å›è°ƒinstance\_code| A

**å®ç°æ–¹å¼**ï¼š

1.  åœ¨ .NET ç³»ç»Ÿçš„ç”¨æˆ·è¡¨ä¸­æ·»åŠ  `FeishuOpenId` å­—æ®µ
2.  ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶è¿›è¡Œé£ä¹¦å…ç™»å½•è®¤è¯ï¼Œè·å–å¹¶å­˜å‚¨ `open_id`
3.  å‘èµ·å®¡æ‰¹æ—¶ï¼Œä½¿ç”¨ `open_id` æŒ‡å®šå®¡æ‰¹å‘èµ·äºº

* * *

æ„å»ºç¨³å¥ã€å¯æ‰©å±•çš„ .NET ä¾§é›†æˆå±‚
-------------------

### æŠ€æœ¯æ ˆæ¨è

å±‚æ¬¡

æŠ€æœ¯é€‰å‹

è¯´æ˜

**åº”ç”¨æ¡†æ¶**

.NET 6/8/10

é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜å¼‚

**é£ä¹¦ SDK**

Mud.Feishu

é«˜åº¦å°è£…çš„é£ä¹¦ API å®¢æˆ·ç«¯

**Webhook å¤„ç†**

Mud.Feishu.Webhook

é£ä¹¦äº‹ä»¶å›è°ƒå¤„ç†ç»„ä»¶

**è®¤è¯æˆæƒ**

ASP.NET Core Identity / JWT

å†…éƒ¨ç³»ç»Ÿèº«ä»½ç®¡ç†

**å¼‚æ­¥è§£è€¦**

RabbitMQ / Hangfire

å›è°ƒæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ï¼Œæå‡å¯é æ€§

**æ•°æ®å­˜å‚¨**

SQL Server / PostgreSQL

ä¸šåŠ¡æ•°æ® + å®¡æ‰¹å…³è”è¡¨

### åˆ†å±‚æ¶æ„å›¾

graph TB subgraph "è¡¨ç¤ºå±‚ (UI)" A\[Web å‰ç«¯ / ç§»åŠ¨ç«¯\] end subgraph "åº”ç”¨å±‚ (API)" B\[LeaveController\] C\[FeishuWebhookController\] end subgraph "é¢†åŸŸå±‚ (ä¸šåŠ¡é€»è¾‘)" D\[ILeaveService\] E\[ApprovalIntegrationService\] F\[IApprovalService\] end subgraph "åŸºç¡€è®¾æ–½å±‚" G\[Mud.Feishu HTTPå®¢æˆ·ç«¯\] H\[Mud.Feishu.Webhookå¤„ç†å™¨\] I\[æ•°æ®ä»“å‚¨<br/>EF Core\] end A --> B A --> C B --> D C --> E D --> F E --> F F --> G F --> H F --> I

#### å…³é”®è®¾è®¡ï¼šé¢†åŸŸå±‚æŠ½è±¡

åœ¨é¢†åŸŸå±‚å¼•å…¥ `IApprovalService` æ¥å£ï¼Œå°†é£ä¹¦é›†æˆç»†èŠ‚ä¸æ ¸å¿ƒä¸šåŠ¡é€»è¾‘è§£è€¦ï¼š

    /// <summary>
    /// å®¡æ‰¹æœåŠ¡æŠ½è±¡æ¥å£ - è§£è€¦é£ä¹¦å®ç°ç»†èŠ‚
    /// </summary>
    public interface IApprovalService
    {
        /// <summary>
        /// å‘èµ·å®¡æ‰¹
        /// </summary>
        Task<string> CreateApprovalAsync(ApprovalRequest request);
    
        /// <summary>
        /// å¤„ç†å®¡æ‰¹ç»“æœå›è°ƒ
        /// </summary>
        Task HandleApprovalCallbackAsync(ApprovalCallbackEvent callbackEvent);
    }
    
    /// <summary>
    /// é£ä¹¦å®¡æ‰¹æœåŠ¡å®ç°
    /// </summary>
    public class FeishuApprovalService : IApprovalService
    {
        private readonly IFeishuTenantV4Approval _approvalApi;
        private readonly IApprovalRecordRepository _repository;
    
        public FeishuApprovalService(
            IFeishuTenantV4Approval approvalApi,
            IApprovalRecordRepository repository)
        {
            _approvalApi = approvalApi;
            _repository = repository;
        }
    
        public async Task<string> CreateApprovalAsync(ApprovalRequest request)
        {
            // è°ƒç”¨é£ä¹¦ API
            var result = await _approvalApi.CreateInstanceAsync(...);
            return result.Data?.InstanceCode ?? string.Empty;
        }
    }
    

**ä¼˜åŠ¿**ï¼š

*   ä¸šåŠ¡é€»è¾‘ä¸ä¾èµ–å…·ä½“é£ä¹¦å®ç°
*   ä¾¿äºå•å…ƒæµ‹è¯•ï¼ˆå¯ Mock æ¥å£ï¼‰
*   æœªæ¥å¯è½»æ¾åˆ‡æ¢åˆ°å…¶ä»–å®¡æ‰¹å¹³å°

* * *

å®æˆ˜ï¼šæ‰‹æŠŠæ‰‹å®Œæˆ"è¯·å‡å®¡æ‰¹"é›†æˆ
----------------

### ç¬¬ä¸€æ­¥ï¼šé£ä¹¦å¹³å°ä¾§é…ç½®ï¼ˆå®¡æ‰¹æµå‡ºå£ï¼‰

#### åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨

ç™»å½•é£ä¹¦å¼€æ”¾å¹³å°ï¼ˆ[https://open.feishu.cn](https://open.feishu.cn)ï¼‰ï¼Œè¿›å…¥åº”ç”¨ç®¡ç†ï¼š

graph LR A\[åˆ›å»ºè‡ªå»ºåº”ç”¨\] --> B\[è·å–App ID\] A --> C\[è·å–App Secret\] B --> D\[é…ç½®åˆ°.NETç³»ç»Ÿ\] C --> D

**å…³é”®é…ç½®**ï¼š

*   è®°å½• `App ID` å’Œ `App Secret`
*   é…ç½®åº”ç”¨æƒé™ï¼šå®¡æ‰¹ç›¸å…³æƒé™ï¼ˆ`approval:approval:read`, `approval:instance:read`, `approval:instance:create`ï¼‰

#### é…ç½®å®¡æ‰¹å®šä¹‰

åœ¨é£ä¹¦ç®¡ç†åå°åˆ›å»º"è¯·å‡å®¡æ‰¹"æ¨¡æ¿ï¼š

graph LR A\[å®¡æ‰¹å®šä¹‰é…ç½®\] --> B\[è¡¨å•è®¾ç½®\] A --> C\[æµç¨‹è®¾ç½®\] A --> D\[æƒé™è®¾ç½®\] B --> B1\[è¯·å‡ç±»å‹<br/>å¼€å§‹æ—¶é—´<br/>ç»“æŸæ—¶é—´<br/>è¯·å‡å¤©æ•°<br/>è¯·å‡äº‹ç”±\] C --> C1\[ç›´å±ä¸»ç®¡å®¡æ‰¹<br/>â†’ äººäº‹å®¡æ‰¹\] D --> D1\[å…¨å‘˜å¯å‘èµ·\]

**è®°å½•å…³é”®ä¿¡æ¯**ï¼š

*   `approval_code`ï¼šå®¡æ‰¹å®šä¹‰çš„å”¯ä¸€æ ‡è¯†
*   è¡¨å•æ§ä»¶çš„ `id`ï¼šç”¨äºç¨‹åºå¡«å……è¡¨å•æ•°æ®

#### é…ç½®äº‹ä»¶è®¢é˜…

åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½® Webhookï¼š

é…ç½®é¡¹

å€¼

è¯·æ±‚ç½‘å€

`https://your-domain.com/api/feishu/webhook`

éªŒè¯ Token

`your_verification_token`ï¼ˆè‡ªå®šä¹‰ï¼‰

åŠ å¯† Key

`your_encrypt_key`ï¼ˆè‡ªå®šä¹‰ï¼‰

è®¢é˜…äº‹ä»¶

`approval_instance`ï¼ˆå®¡æ‰¹å®ä¾‹çŠ¶æ€å˜æ›´ï¼‰

* * *

### ç¬¬äºŒæ­¥ï¼š.NET ä¾§åŸºç¡€æ­å»ºï¼ˆé›†æˆåŸºçŸ³ï¼‰

#### å°è£…é£ä¹¦ API å®¢æˆ·ç«¯

åŸºäº `MudFeishu SDK` å°è£…å®¡æ‰¹æœåŠ¡ï¼š

    /// <summary>
    /// é£ä¹¦å®¡æ‰¹æœåŠ¡å°è£…
    /// </summary>
    public class FeishuApprovalClient
    {
        private readonly IFeishuTenantV4Approval _approvalApi;
        private readonly ILogger<FeishuApprovalClient> _logger;
    
        public FeishuApprovalClient(
            IFeishuTenantV4Approval approvalApi,
            ILogger<FeishuApprovalClient> logger)
        {
            _approvalApi = approvalApi;
            _logger = logger;
        }
    
        /// <summary>
        /// åˆ›å»ºå®¡æ‰¹å®ä¾‹
        /// </summary>
        public async Task<string> CreateInstanceAsync(CreateInstanceRequest request)
        {
            var result = await _approvalApi.CreateInstanceAsync(request);
    
            if (result == null || result.Code != 0)
            {
                _logger.LogError("åˆ›å»ºå®¡æ‰¹å®ä¾‹å¤±è´¥: {Msg}", result?.Msg);
                throw new InvalidOperationException($"åˆ›å»ºå®¡æ‰¹å®ä¾‹å¤±è´¥: {result?.Msg}");
            }
    
            _logger.LogInformation("åˆ›å»ºå®¡æ‰¹å®ä¾‹æˆåŠŸ: {InstanceCode}", result.Data?.InstanceCode);
            return result.Data?.InstanceCode ?? string.Empty;
        }
    
        /// <summary>
        /// è·å–å®¡æ‰¹å®ä¾‹è¯¦æƒ…
        /// </summary>
        public async Task<GetApprovalInstanceResult?> GetInstanceAsync(string instanceCode)
        {
            var result = await _approvalApi.GetInstanceByIdAsync(instanceCode);
    
            if (result == null || result.Code != 0)
            {
                _logger.LogError("è·å–å®¡æ‰¹å®ä¾‹å¤±è´¥: {Msg}", result?.Msg);
                return null;
            }
    
            return result.Data;
        }
    }
    

#### è®¾è®¡æ•°æ®å…³è”è¡¨

åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­æ·»åŠ å®¡æ‰¹å…³è”è¡¨ï¼š

    -- å®¡æ‰¹å…³è”è¡¨
    CREATE TABLE ApprovalRecords (
        Id BIGINT PRIMARY KEY IDENTITY(1,1),
        BusinessType NVARCHAR(50) NOT NULL,          -- ä¸šåŠ¡ç±»å‹ï¼šLeaveRequest, PurchaseRequest...
        BusinessId BIGINT NOT NULL,                   -- ä¸šåŠ¡ID
        InstanceCode NVARCHAR(64) NOT NULL,           -- é£ä¹¦å®¡æ‰¹å®ä¾‹Code
        ApprovalCode NVARCHAR(64) NOT NULL,            -- å®¡æ‰¹å®šä¹‰Code
        Status NVARCHAR(20) NOT NULL,                  -- çŠ¶æ€ï¼šPENDING, APPROVED, REJECTED...
        CallbackData NVARCHAR(MAX),                   -- å›è°ƒæ•°æ®ï¼ˆJSONï¼‰
        CreatedTime DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
        UpdatedTime DATETIME2 NOT NULL DEFAULT GETUTCDATE(),
    
        CONSTRAINT UK_ApprovalRecords_Business UNIQUE(BusinessType, BusinessId)
    );
    
    CREATE INDEX IX_ApprovalRecords_InstanceCode ON ApprovalRecords(InstanceCode);
    CREATE INDEX IX_ApprovalRecords_Status ON ApprovalRecords(Status);
    

å¯¹åº”çš„å®ä½“ç±»ï¼š

    /// <summary>
    /// å®¡æ‰¹å…³è”è®°å½•
    /// </summary>
    public class ApprovalRecord
    {
        public long Id { get; set; }
        public string BusinessType { get; set; } = string.Empty;  // "LeaveRequest"
        public long BusinessId { get; set; }                       // è¯·å‡ç”³è¯·ID
        public string InstanceCode { get; set; } = string.Empty;   // é£ä¹¦å®ä¾‹Code
        public string ApprovalCode { get; set; } = string.Empty;    // å®¡æ‰¹å®šä¹‰Code
        public string Status { get; set; } = string.Empty;         // PENDING/APPROVED/REJECTED
        public string? CallbackData { get; set; }                  // JSONæ ¼å¼
        public DateTime CreatedTime { get; set; }
        public DateTime UpdatedTime { get; set; }
    }
    

* * *

### ç¬¬ä¸‰æ­¥ï¼šæ ¸å¿ƒä¸šåŠ¡æµç¨‹ç¼–ç ï¼ˆåŒå‘è”é€šï¼‰

#### åœºæ™¯ï¼šç”¨æˆ·æäº¤è¯·å‡å•ï¼Œå‘èµ·å®¡æ‰¹

**æµç¨‹å›¾**ï¼š

sequenceDiagram participant User as ç”¨æˆ· participant Controller as LeaveController participant Service as LeaveService participant DB as æ•°æ®åº“ participant FeishuAPI as é£ä¹¦API User->>Controller: æäº¤è¯·å‡ç”³è¯· Controller->>Service: SubmitLeaveRequest(request) Service->>DB: ä¿å­˜è¯·å‡è®°å½•ï¼ˆçŠ¶æ€ï¼šå®¡æ‰¹ä¸­ï¼‰ Service->>Service: æ„é€ è¡¨å•æ•°æ® Service->>FeishuAPI: CreateInstanceAsync(approvalCode, form) FeishuAPI-->>Service: instance\_code Service->>DB: ä¿å­˜ApprovalRecordå…³è” Service-->>Controller: æäº¤æˆåŠŸ Controller-->>User: ç­‰å¾…å®¡æ‰¹

**ä»£ç å®ç°**ï¼š

    /// <summary>
    /// è¯·å‡æœåŠ¡
    /// </summary>
    public class LeaveService
    {
        private readonly ILeaveRequestRepository _leaveRepo;
        private readonly IApprovalRecordRepository _approvalRepo;
        private readonly FeishuApprovalClient _feishuClient;
        private readonly ILogger<LeaveService> _logger;
    
        public LeaveService(
            ILeaveRequestRepository leaveRepo,
            IApprovalRecordRepository approvalRepo,
            FeishuApprovalClient feishuClient,
            ILogger<LeaveService> logger)
        {
            _leaveRepo = leaveRepo;
            _approvalRepo = approvalRepo;
            _feishuClient = feishuClient;
            _logger = logger;
        }
    
        /// <summary>
        /// æäº¤è¯·å‡ç”³è¯·å¹¶å‘èµ·å®¡æ‰¹
        /// </summary>
        public async Task<long> SubmitLeaveRequestAsync(SubmitLeaveRequestDto dto)
        {
            // 1. ä¿å­˜è¯·å‡ä¸šåŠ¡æ•°æ®
            var leaveRequest = new LeaveRequest
            {
                UserId = dto.UserId,
                LeaveType = dto.LeaveType,
                StartTime = dto.StartTime,
                EndTime = dto.EndTime,
                Days = dto.Days,
                Reason = dto.Reason,
                Status = LeaveStatus.Pending,  // å®¡æ‰¹ä¸­
                CreatedTime = DateTime.UtcNow
            };
    
            await _leaveRepo.AddAsync(leaveRequest);
            await _leaveRepo.SaveChangesAsync();
    
            // 2. æ„é€ é£ä¹¦å®¡æ‰¹è¡¨å•æ•°æ®
            var form = new List<object>
            {
                new { id = "leave_type", type = "select", value = dto.LeaveType },
                new { id = "start_time", type = "date", value = dto.StartTime.ToString("yyyy-MM-dd") },
                new { id = "end_time", type = "date", value = dto.EndTime.ToString("yyyy-MM-dd") },
                new { id = "days", type = "number", value = dto.Days.ToString() },
                new { id = "reason", type = "textarea", value = dto.Reason }
            };
    
            // 3. è°ƒç”¨é£ä¹¦APIåˆ›å»ºå®¡æ‰¹å®ä¾‹
            var request = new CreateInstanceRequest
            {
                ApprovalCode = "7C468A54-8745-2245-9675-08B7C63E7A85",  // è¯·å‡å®¡æ‰¹å®šä¹‰Code
                UserId = dto.FeishuUserId,  // é£ä¹¦ç”¨æˆ·ID
                Form = JsonSerializer.Serialize(form),
                Uuid = Guid.NewGuid().ToString()  // å¹‚ç­‰ID
            };
    
            string instanceCode;
            try
            {
                instanceCode = await _feishuClient.CreateInstanceAsync(request);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ›å»ºé£ä¹¦å®¡æ‰¹å®ä¾‹å¤±è´¥");
                // å›æ»šä¸šåŠ¡æ•°æ®
                leaveRequest.Status = LeaveStatus.Failed;
                await _leaveRepo.SaveChangesAsync();
                throw;
            }
    
            // 4. ä¿å­˜å®¡æ‰¹å…³è”è®°å½•
            var approvalRecord = new ApprovalRecord
            {
                BusinessType = "LeaveRequest",
                BusinessId = leaveRequest.Id,
                InstanceCode = instanceCode,
                ApprovalCode = request.ApprovalCode,
                Status = "PENDING",
                CreatedTime = DateTime.UtcNow,
                UpdatedTime = DateTime.UtcNow
            };
    
            await _approvalRepo.AddAsync(approvalRecord);
            await _approvalRepo.SaveChangesAsync();
    
            _logger.LogInformation("è¯·å‡ç”³è¯·å·²æäº¤å¹¶åˆ›å»ºå®¡æ‰¹: LeaveId={LeaveId}, InstanceCode={InstanceCode}",
                leaveRequest.Id, instanceCode);
    
            return leaveRequest.Id;
        }
    }
    

#### åœºæ™¯ï¼šå®¡æ‰¹å®Œç»“ï¼Œé£ä¹¦å›è°ƒé€šçŸ¥ç»“æœ

**åŸºäº Mud.Feishu.Webhook å®ç°å®‰å…¨çš„å›è°ƒå¤„ç†å™¨**

    using Mud.Feishu.Abstractions;
    using Mud.Feishu.Abstractions.DataModels.Approval;
    using Mud.Feishu.Abstractions.EventHandlers;
    
    /// <summary>
    /// å®¡æ‰¹å®ä¾‹äº‹ä»¶å¤„ç†å™¨
    /// </summary>
    public class ApprovalInstanceEventHandler : ApprovalInstanceEventHandler
    {
        private readonly IApprovalRecordRepository _approvalRepo;
        private readonly ILeaveRequestRepository _leaveRepo;
    
        public ApprovalInstanceEventHandler(
            ILogger<ApprovalInstanceEventHandler> logger,
            IApprovalRecordRepository approvalRepo,
            ILeaveRequestRepository leaveRepo)
            : base(logger)
        {
            _approvalRepo = approvalRepo;
            _leaveRepo = leaveRepo;
        }
    
        /// <summary>
        /// å¤„ç†å®¡æ‰¹å®ä¾‹äº‹ä»¶ä¸šåŠ¡é€»è¾‘
        /// </summary>
        protected override async Task ProcessBusinessLogicAsync(
            EventData eventData,
            ObjectEventResult<ApprovalInstanceResult>? eventEntity,
            CancellationToken cancellationToken = default)
        {
            if (eventEntity?.Object == null)
            {
                _logger.LogWarning("å®¡æ‰¹å®ä¾‹äº‹ä»¶æ•°æ®æ— æ•ˆ");
                return;
            }
    
            var approvalEvent = eventEntity.Object;
    
            _logger.LogInformation("æ”¶åˆ°å®¡æ‰¹å®ä¾‹äº‹ä»¶: InstanceCode={InstanceCode}, Status={Status}",
                approvalEvent.InstanceCode, approvalEvent.Status);
    
            // å¹‚ç­‰æ€§å¤„ç†ï¼šæ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¯¥äº‹ä»¶
            var existingRecord = await _approvalRepo.GetByInstanceCodeAsync(approvalEvent.InstanceCode ?? string.Empty);
            if (existingRecord != null && existingRecord.Status == approvalEvent.Status)
            {
                _logger.LogInformation("è¯¥äº‹ä»¶å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: EventId={EventId}", eventData.EventId);
                return;
            }
    
            // æ ¹æ®ä¸šåŠ¡ç±»å‹å¤„ç†å®¡æ‰¹ç»“æœ
            await ProcessApprovalResultAsync(eventData, approvalEvent, cancellationToken);
        }
    
        /// <summary>
        /// å¤„ç†å®¡æ‰¹ç»“æœ
        /// </summary>
        private async Task ProcessApprovalResultAsync(
            EventData eventData,
            ApprovalInstanceResult approvalEvent,
            CancellationToken cancellationToken)
        {
            if (string.IsNullOrEmpty(approvalEvent.InstanceCode))
            {
                _logger.LogWarning("å®¡æ‰¹å®ä¾‹Codeä¸ºç©ºï¼Œè·³è¿‡å¤„ç†");
                return;
            }
    
            // æŸ¥è¯¢å®¡æ‰¹å…³è”è®°å½•
            var approvalRecord = await _approvalRepo.GetByInstanceCodeAsync(approvalEvent.InstanceCode);
            if (approvalRecord == null)
            {
                _logger.LogWarning("æœªæ‰¾åˆ°å®¡æ‰¹å…³è”è®°å½•: InstanceCode={InstanceCode}",
                    approvalEvent.InstanceCode);
                return;
            }
    
            // æ›´æ–°å®¡æ‰¹è®°å½•çŠ¶æ€
            approvalRecord.Status = approvalEvent.Status ?? string.Empty;
            approvalRecord.CallbackData = JsonSerializer.Serialize(approvalEvent);
            approvalRecord.UpdatedTime = DateTime.UtcNow;
            await _approvalRepo.SaveChangesAsync();
    
            // æ ¹æ®ä¸šåŠ¡ç±»å‹å¤„ç†
            switch (approvalRecord.BusinessType)
            {
                case "LeaveRequest":
                    await ProcessLeaveApprovalAsync(approvalRecord, approvalEvent.Status ?? string.Empty);
                    break;
    
                // å¯æ‰©å±•å…¶ä»–ä¸šåŠ¡ç±»å‹
                default:
                    _logger.LogWarning("æœªçŸ¥çš„ä¸šåŠ¡ç±»å‹: {BusinessType}", approvalRecord.BusinessType);
                    break;
            }
        }
    
        /// <summary>
        /// å¤„ç†è¯·å‡å®¡æ‰¹ç»“æœ
        /// </summary>
        private async Task ProcessLeaveApprovalAsync(ApprovalRecord approvalRecord, string status)
        {
            var leaveRequest = await _leaveRepo.GetByIdAsync(approvalRecord.BusinessId);
            if (leaveRequest == null)
            {
                _logger.LogWarning("æœªæ‰¾åˆ°è¯·å‡ç”³è¯·: BusinessId={BusinessId}", approvalRecord.BusinessId);
                return;
            }
    
            // æ ¹æ®å®¡æ‰¹çŠ¶æ€æ›´æ–°è¯·å‡è®°å½•
            leaveRequest.Status = status switch
            {
                "APPROVED" => LeaveStatus.Approved,
                "REJECTED" => LeaveStatus.Rejected,
                "CANCELED" => LeaveStatus.Canceled,
                "DELETED" => LeaveStatus.Deleted,
                _ => LeaveStatus.Pending
            };
    
            leaveRequest.UpdatedTime = DateTime.UtcNow;
            await _leaveRepo.SaveChangesAsync();
    
            _logger.LogInformation("è¯·å‡ç”³è¯·çŠ¶æ€å·²æ›´æ–°: LeaveId={LeaveId}, Status={Status}",
                leaveRequest.Id, leaveRequest.Status);
    
            // TODO: å‘é€é€šçŸ¥ç»™ç”³è¯·äºº
            // TODO: åŒæ­¥åˆ°è€ƒå‹¤ç³»ç»Ÿ
        }
    }
    

**æ³¨å†Œ Webhook æœåŠ¡ï¼ˆProgram.csï¼‰**ï¼š

    using Mud.Feishu.Webhook;
    using Mud.Feishu;
    using YourApp.Handlers;
    
    var builder = WebApplication.CreateBuilder(args);
    
    // æ³¨å†Œé£ä¹¦ API æœåŠ¡
    builder.Services.AddFeishuServices()
        .ConfigureFrom(builder.Configuration)  // ä» "Feishu" é…ç½®èŠ‚è¯»å–
        .Build();
    
    // æ³¨å†Œé£ä¹¦ Webhook äº‹ä»¶è®¢é˜…æœåŠ¡
    builder.Services.AddFeishuWebhookServiceBuilder()
        .ConfigureFrom(builder.Configuration)  // ä» "FeishuWebhook" é…ç½®èŠ‚è¯»å–
        .AddHandler<ApprovalInstanceEventHandler>()  // æ·»åŠ å®¡æ‰¹äº‹ä»¶å¤„ç†å™¨
        .Build();
    
    // æ³¨å†Œä¸šåŠ¡æœåŠ¡
    builder.Services.AddScoped<ILeaveRequestRepository, LeaveRequestRepository>();
    builder.Services.AddScoped<IApprovalRecordRepository, ApprovalRecordRepository>();
    
    var app = builder.Build();
    
    app.UseFeishuWebhook();  // æ·»åŠ  Webhook ä¸­é—´ä»¶
    
    app.Run();
    

**è¯´æ˜**ï¼š

*   `ApprovalInstanceEventHandler` ç»§æ‰¿è‡ª `ApprovalInstanceEventHandler` åŸºç±»
*   åŸºç±»å·²ç»å®ç°äº† `HandleAsync` æ–¹æ³•ï¼Œä¼šè‡ªåŠ¨ååºåˆ—åŒ– `ApprovalInstanceResult` ç±»å‹çš„äº‹ä»¶æ•°æ®
*   åªéœ€é‡å†™ `ProcessBusinessLogicAsync` æ–¹æ³•å®ç°å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å³å¯
*   SDK ä¼šæ ¹æ® `SupportedEventType` å±æ€§è‡ªåŠ¨è·¯ç”±å¯¹åº”çš„äº‹ä»¶åˆ°è¿™ä¸ªå¤„ç†å™¨
*   `AddFeishuServices()` æ³¨å†Œé£ä¹¦ API å®¢æˆ·ç«¯æœåŠ¡ï¼Œä½¿ç”¨ `Feishu` é…ç½®èŠ‚
*   `AddFeishuWebhookServiceBuilder()` æ³¨å†Œ Webhook äº‹ä»¶è®¢é˜…æœåŠ¡ï¼Œä½¿ç”¨ `FeishuWebhook` é…ç½®èŠ‚

**é…ç½®æ–‡ä»¶ï¼ˆappsettings.jsonï¼‰**ï¼š

    {
      // é£ä¹¦ Webhook äº‹ä»¶è®¢é˜…é…ç½®
      "FeishuWebhook": {
        "VerificationToken": "your_verification_token",
        "EncryptKey": "your_encrypt_key",
        "RoutePrefix": "api/feishu/webhook",
        "AutoRegisterEndpoint": true,
        "EnableRequestLogging": true,
        "EnableExceptionHandling": true,
        "EventHandlingTimeoutMs": 30000,
        "MaxConcurrentEvents": 10
      },
    
      // é£ä¹¦ API å®¢æˆ·ç«¯é…ç½®
      "Feishu": {
        "AppId": "your_app_id",
        "AppSecret": "your_app_secret",
        "BaseUrl": "https://open.feishu.cn",
        "TimeOut": "30",
        "RetryCount": 3,
        "EnableLogging": true
      }
    }
    

* * *

### ç¬¬å››æ­¥ï¼šåŠŸèƒ½å®Œå–„ä¸è”è°ƒæµ‹è¯•

#### çŠ¶æ€åŒæ­¥å±•ç¤º

åœ¨è¯·å‡åˆ—è¡¨é¡µå±•ç¤ºå®¡æ‰¹çŠ¶æ€ï¼š

    /// <summary>
    /// è¯·å‡åˆ—è¡¨å“åº”DTO
    /// </summary>
    public class LeaveRequestDto
    {
        public long Id { get; set; }
        public DateTime StartTime { get; set; }
        public DateTime EndTime { get; set; }
        public int Days { get; set; }
        public string Status { get; set; } = string.Empty;      // ä¸šåŠ¡çŠ¶æ€ï¼šApproved, Rejected
        public string ApprovalStatus { get; set; } = string.Empty; // é£ä¹¦å®¡æ‰¹çŠ¶æ€ï¼šAPPROVED, REJECTED, PENDING
        public string? FeishuInstanceUrl { get; set; }          // é£ä¹¦å®¡æ‰¹è¯¦æƒ…é“¾æ¥
        public DateTime CreatedTime { get; set; }
    }
    
    /// <summary>
    /// æŸ¥è¯¢è¯·å‡åˆ—è¡¨
    /// </summary>
    public async Task<List<LeaveRequestDto>> GetLeaveListAsync(long userId)
    {
        var leaves = await _leaveRepo.GetByUserIdAsync(userId);
        var instanceCodes = leaves.Select(l => l.InstanceCode).ToList();
    
        // æ‰¹é‡æŸ¥è¯¢å®¡æ‰¹è®°å½•
        var approvals = await _approvalRepo.GetByInstanceCodesAsync(instanceCodes);
    
        var result = leaves.Select(leave =>
        {
            var approval = approvals.FirstOrDefault(a => a.InstanceCode == leave.InstanceCode);
    
            return new LeaveRequestDto
            {
                Id = leave.Id,
                StartTime = leave.StartTime,
                EndTime = leave.EndTime,
                Days = leave.Days,
                Status = leave.Status.ToString(),
                ApprovalStatus = approval?.Status ?? "UNKNOWN",
                FeishuInstanceUrl = !string.IsNullOrEmpty(approval?.InstanceCode)
                    ? $"https://www.feishu.cn/approval/approval/view/{approval.InstanceCode}"
                    : null,
                CreatedTime = leave.CreatedTime
            };
        }).ToList();
    
        return result;
    }
    

#### æ·»åŠ "åœ¨é£ä¹¦ä¸­æŸ¥çœ‹"é“¾æ¥

åœ¨åˆ—è¡¨é¡µæ·»åŠ æ“ä½œæŒ‰é’®ï¼š

    <!-- å‰ç«¯é¡µé¢ç¤ºä¾‹ -->
    <table class="leave-list">
        <thead>
            <tr>
                <th>å¼€å§‹æ—¶é—´</th>
                <th>ç»“æŸæ—¶é—´</th>
                <th>å¤©æ•°</th>
                <th>å®¡æ‰¹çŠ¶æ€</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var leave in Model.Leaves)
            {
                <tr>
                    <td>@leave.StartTime.ToString("yyyy-MM-dd")</td>
                    <td>@leave.EndTime.ToString("yyyy-MM-dd")</td>
                    <td>@leave.Days</td>
                    <td>
                        <span class="status @leave.ApprovalStatus">
                            @GetStatusText(leave.ApprovalStatus)
                        </span>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(leave.FeishuInstanceUrl))
                        {
                            <a href="@leave.FeishuInstanceUrl" target="_blank" class="btn">
                                åœ¨é£ä¹¦ä¸­æŸ¥çœ‹
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    

#### è”è°ƒæµ‹è¯•

æµ‹è¯•åœºæ™¯

éªŒè¯è¦ç‚¹

æµ‹è¯•å·¥å…·

**å‘èµ·å®¡æ‰¹**

é£ä¹¦æ˜¯å¦æ”¶åˆ°å®¡æ‰¹é€šçŸ¥ã€è¡¨å•æ•°æ®æ˜¯å¦æ­£ç¡®

ç›´æ¥åœ¨ç³»ç»Ÿå‘èµ·

**å®¡æ‰¹æµç¨‹**

å„å®¡æ‰¹èŠ‚ç‚¹æ˜¯å¦æ­£ç¡®æµè½¬

é£ä¹¦ç®¡ç†åå°

**å›è°ƒæ¥æ”¶**

Webhookæ˜¯å¦æ­£ç¡®æ¥æ”¶äº‹ä»¶ã€æ•°æ®æ˜¯å¦å®Œæ•´

é£ä¹¦"æ¨¡æ‹Ÿäº‹ä»¶æ¨é€"å·¥å…·

**çŠ¶æ€åŒæ­¥**

ä¸šåŠ¡çŠ¶æ€æ˜¯å¦æ­£ç¡®æ›´æ–°ã€é€šçŸ¥æ˜¯å¦å‘é€

æ•°æ®åº“æŸ¥è¯¢ã€æ—¥å¿—æŸ¥çœ‹

**å¼‚å¸¸å¤„ç†**

ç½‘ç»œå¼‚å¸¸ã€ç­¾åéªŒè¯å¤±è´¥ç­‰è¾¹ç•Œæƒ…å†µ

æ¨¡æ‹Ÿå¼‚å¸¸åœºæ™¯

**é£ä¹¦æ¨¡æ‹Ÿäº‹ä»¶æ¨é€å·¥å…·**ï¼š

åœ¨é£ä¹¦å¼€æ”¾å¹³å°çš„"äº‹ä»¶è®¢é˜…"é¡µé¢ï¼Œå¯ä»¥ä½¿ç”¨"æ¨¡æ‹Ÿäº‹ä»¶æ¨é€"åŠŸèƒ½æµ‹è¯• Webhook æ¥å£ï¼š

graph LR A\[é£ä¹¦ç®¡ç†åå°\] -->|æ¨¡æ‹Ÿäº‹ä»¶æ¨é€| B\[Webhookæ¥å£\] B -->|æ—¥å¿—è¾“å‡º| C\[æ£€æŸ¥å¤„ç†ç»“æœ\] C -->|æˆåŠŸ| D\[éªŒè¯å®Œæˆ\] C -->|å¤±è´¥| E\[æŸ¥çœ‹é”™è¯¯æ—¥å¿—\]

* * *

ç”Ÿäº§çº§æ³¨æ„äº‹é¡¹
-------

### å®‰å…¨ä¸å¯é æ€§

#### æœºå¯†ç®¡ç†

**åˆ‡å‹¿å°†æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼**

    // âŒ é”™è¯¯ç¤ºä¾‹
    var appSecret = "cli_xxxxxxxxxxxxxxx";  // å±é™©ï¼
    
    // âœ… æ­£ç¡®ç¤ºä¾‹
    builder.Configuration.AddAzureKeyVault(
        new Uri($"https://{vaultName}.vault.azure.net/"),
        new DefaultAzureCredential());
    
    var appSecret = builder.Configuration["Feishu:AppSecret"];
    

**æ¨èæ–¹æ¡ˆ**ï¼š

*   Azure Key Vault / AWS Secrets Manager
*   HashiCorp Vault
*   Docker Secretsï¼ˆå®¹å™¨åŒ–éƒ¨ç½²ï¼‰

#### å¹‚ç­‰æ€§å¤„ç†

é£ä¹¦å¯èƒ½ä¼šé‡å¤æ¨é€åŒä¸€ä¸ªäº‹ä»¶ï¼ˆç½‘ç»œé‡è¯•ç­‰ï¼‰ï¼Œå¿…é¡»ä¿è¯ä¸šåŠ¡é€»è¾‘çš„å¹‚ç­‰æ€§ï¼š

    public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
    {
        // ä½¿ç”¨ EventId æˆ– instance_code + status ç»„åˆä½œä¸ºå¹‚ç­‰é”®
        var idempotencyKey = $"{approvalEvent.InstanceCode}_{approvalEvent.Status}";
    
        // æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡
        if (await _cache.ExistsAsync(idempotencyKey))
        {
            _logger.LogInformation("äº‹ä»¶å·²å¤„ç†è¿‡ï¼Œè·³è¿‡: Key={IdempotencyKey}", idempotencyKey);
            return;
        }
    
        // æ ‡è®°ä¸ºå·²å¤„ç†ï¼ˆè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚24å°æ—¶ï¼‰
        await _cache.SetAsync(idempotencyKey, "1", TimeSpan.FromHours(24));
    
        // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
        await ProcessEventAsync(approvalEvent, cancellationToken);
    }
    

#### API å®¹é”™

ä½¿ç”¨ Polly ä¸ºé£ä¹¦ API è°ƒç”¨æ·»åŠ é‡è¯•å’Œç†”æ–­æœºåˆ¶ï¼š

    // æ³¨å†Œ HttpClient æ—¶æ·»åŠ  Polly ç­–ç•¥
    builder.Services.AddHttpClient("Feishu")
        .AddTransientHttpErrorPolicy(p =>
            p.WaitAndRetryAsync(3, retryAttempt =>
                TimeSpan.FromSeconds(Math.Pow(2, retryAttempt))))
        .AddPolicyHandler(Policy<HttpResponseMessage>
            .Handle<HttpRequestException>()
            .CircuitBreakerAsync(5, TimeSpan.FromSeconds(30)));
    

### è¾¹ç•Œæƒ…å†µä¸ä¼˜é›…é™çº§

#### å®¡æ‰¹äººå¤±æ•ˆå¤„ç†

    // é£ä¹¦å®¡æ‰¹å®šä¹‰ä¸­é…ç½®é»˜è®¤å®¡æ‰¹äºº
    var request = new CreateInstanceRequest
    {
        ApprovalCode = "xxxx",
        // å¦‚æœè‡ªé€‰å®¡æ‰¹äººä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å®¡æ‰¹äºº
        NodeApproverUserIdLists = dto.ApproverUserId.HasValue
            ? new[] { new NodeApprover { NodeId = "node1", ApproverUserIds = new[] { dto.ApproverUserId.Value } } }
            : null  // èµ°é»˜è®¤å®¡æ‰¹äººæµç¨‹
    };
    

#### ç½‘ç»œè¶…æ—¶ä¸å¼‚æ­¥å¤„ç†

å›è°ƒå¤„ç†åº”å¿«é€Ÿå“åº”é£ä¹¦ï¼ˆå»ºè®®åœ¨ 3 ç§’å†…ï¼‰ï¼Œå¤æ‚é€»è¾‘ç§»è‡³åå°ä½œä¸šï¼š

    public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
    {
        // 1. å¿«é€Ÿä¿å­˜äº‹ä»¶åˆ°é˜Ÿåˆ—
        await _eventQueue.EnqueueAsync(eventData);
    
        // 2. ç«‹å³è¿”å›ï¼Œç”±åå°ä½œä¸šå¤„ç†
        // Hangfireã€RabbitMQ ç­‰ä¼šå¼‚æ­¥æ¶ˆè´¹é˜Ÿåˆ—
        await Task.CompletedTask;
    }
    
    // åå°ä½œä¸šå¤„ç†
    [Queue("approval-callback")]
    public async Task ProcessApprovalEventAsync(EventData eventData)
    {
        // å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†
        await _approvalService.ProcessCallbackAsync(eventData);
    }
    

#### ç›‘æ§ä¸å‘Šè­¦

å»ºç«‹å…³é”®èŠ‚ç‚¹çš„ç›‘æ§ï¼š

    // ç›‘æ§æŒ‡æ ‡
    public class ApprovalMetrics
    {
        private readonly Counter _approvalCreatedCounter;
        private readonly Counter _callbackReceivedCounter;
        private readonly Histogram _processingTimeHistogram;
    
        public void RecordApprovalCreated(string approvalType)
        {
            _approvalCreatedCounter.WithLabels(approvalType).Inc();
        }
    
        public void RecordCallbackReceived(string status)
        {
            _callbackReceivedCounter.WithLabels(status).Inc();
        }
    
        public void RecordProcessingTime(TimeSpan duration)
        {
            _processingTimeHistogram.Observe(duration.TotalSeconds);
        }
    }
    
    // å‘Šè­¦è§„åˆ™ï¼ˆPrometheus ç¤ºä¾‹ï¼‰
    # å®¡æ‰¹å‘èµ·å¤±è´¥ç‡è¶…è¿‡ 5% è§¦å‘å‘Šè­¦
    alert: ApprovalCreationFailureRate
    expr: rate(approval_creation_failed_total[5m]) / rate(approval_creation_total[5m]) > 0.05
    for: 5m
    annotations:
      summary: "å®¡æ‰¹åˆ›å»ºå¤±è´¥ç‡è¿‡é«˜"
    

### æ‰©å±•æ€§ä¸ç»´æŠ¤æ€§

#### ç­–ç•¥æ¨¡å¼æ”¯æŒå¤šå¹³å°

    /// <summary>
    /// å®¡æ‰¹å¹³å°ç­–ç•¥æ¥å£
    /// </summary>
    public interface IApprovalPlatformStrategy
    {
        string PlatformName { get; }
        Task<string> CreateInstanceAsync(ApprovalRequest request);
    }
    
    /// <summary>
    /// é£ä¹¦å®¡æ‰¹ç­–ç•¥
    /// </summary>
    public class FeishuApprovalStrategy : IApprovalPlatformStrategy
    {
        public string PlatformName => "Feishu";
        // ... å®ç°
    }
    
    /// <summary>
    /// é’‰é’‰å®¡æ‰¹ç­–ç•¥
    /// </summary>
    public class DingTalkApprovalStrategy : IApprovalPlatformStrategy
    {
        public string PlatformName => "DingTalk";
        // ... å®ç°
    }
    
    /// <summary>
    /// å®¡æ‰¹ç­–ç•¥å·¥å‚
    /// </summary>
    public class ApprovalStrategyFactory
    {
        private readonly IEnumerable<IApprovalPlatformStrategy> _strategies;
    
        public IApprovalPlatformStrategy GetStrategy(string platformName)
        {
            return _strategies.FirstOrDefault(s => s.PlatformName == platformName)
                ?? throw new NotSupportedException($"ä¸æ”¯æŒçš„å®¡æ‰¹å¹³å°: {platformName}");
        }
    }
    

#### å®¡è®¡æ—¥å¿—

è¯¦ç»†è®°å½•å®¡æ‰¹æµè½¬æ¢çš„å…³é”®æ—¥å¿—ï¼š

    public class ApprovalAuditService
    {
        private readonly IApprovalAuditRepository _auditRepo;
    
        public async Task LogAsync(ApprovalAuditLog log)
        {
            log.Timestamp = DateTime.UtcNow;
            await _auditRepo.AddAsync(log);
            await _auditRepo.SaveChangesAsync();
    
            // ç»“æ„åŒ–æ—¥å¿—è¾“å‡º
            _logger.LogInformation("å®¡æ‰¹å®¡è®¡: {AuditType}, InstanceCode={InstanceCode}, BusinessId={BusinessId}",
                log.AuditType, log.InstanceCode, log.BusinessId);
        }
    }
    
    // ä½¿ç”¨ç¤ºä¾‹
    await _auditService.LogAsync(new ApprovalAuditLog
    {
        AuditType = "ApprovalStarted",
        InstanceCode = instanceCode,
        BusinessId = leaveRequest.Id,
        OperatorId = userId,
        Details = new { leaveType, days, reason }
    });
    

* * *

æœ€åä¸€ç‚¹å†…å®¹
------

### æ ¸å¿ƒä»·å€¼

é€šè¿‡æœ¬æ–‡çš„å®è·µï¼Œæˆ‘ä»¬æˆåŠŸå®ç°äº†ï¼š

ä»·å€¼ç‚¹

å®ç°æ–¹å¼

æ”¶ç›Š

**ç§»åŠ¨åŒ–å®¡æ‰¹**

é£ä¹¦ App ä½œä¸ºå®¡æ‰¹é—¨æˆ·

éšæ—¶éšåœ°å¤„ç†å®¡æ‰¹

**å³æ—¶é€šçŸ¥**

é£ä¹¦å¼ºé€šçŸ¥æœºåˆ¶

å®¡æ‰¹äººåŠæ—¶å“åº”

**æ•°æ®é—­ç¯**

.NET ä¸šåŠ¡åº“ + å®¡æ‰¹å…³è”è¡¨

å®Œæ•´çš„ä¸šåŠ¡æµç¨‹è¿½è¸ª

**è§£è€¦è®¾è®¡**

é¢†åŸŸå±‚æŠ½è±¡ + ç­–ç•¥æ¨¡å¼

ä¾¿äºæ‰©å±•å’Œç»´æŠ¤

### å…¨æ–‡æ€»ç»“

æœ¬æ–‡æä¾›äº†ä¸€ä¸ªä»ç†å¿µã€è®¾è®¡åˆ°ç¼–ç è½åœ°çš„å®Œæ•´é—­ç¯ï¼š

mindmap root((é£ä¹¦å®¡æ‰¹é›†æˆ)) ç†å¿µ åŒå‘é›†æˆ .NETä¸ºä¸šåŠ¡æ ¸å¿ƒ é£ä¹¦ä¸ºæµç¨‹é—¨æˆ· è®¾è®¡ åˆ†å±‚æ¶æ„ é¢†åŸŸæŠ½è±¡ å®‰å…¨æœºåˆ¶ å®ç° å‘èµ·å®¡æ‰¹ å›è°ƒå¤„ç† çŠ¶æ€åŒæ­¥ æœ€ä½³å®è·µ æœºå¯†ç®¡ç† å¹‚ç­‰æ€§ å¼‚æ­¥å¤„ç† ç›‘æ§å‘Šè­¦

### æ‰©å±•

#### åœºæ™¯æ‰©å±•

å°†æ­¤æ¨¡å¼å¿«é€Ÿå¤ç”¨äºå…¶ä»–ä¸šåŠ¡åœºæ™¯ï¼š

ä¸šåŠ¡åœºæ™¯

å®¡æ‰¹æµç¨‹

å¤æ‚åº¦

**æŠ¥é”€å®¡æ‰¹**

å‘èµ· â†’ ç›´å±ä¸»ç®¡ â†’ è´¢åŠ¡å®¡æ ¸

ä¸­

**é‡‡è´­ç”³è¯·**

å‘èµ· â†’ éƒ¨é—¨ä¸»ç®¡ â†’ é‡‡è´­éƒ¨ â†’ æ€»ç»ç†

é«˜

**åˆåŒå®¡æ‰¹**

æ³•åŠ¡å®¡æ ¸ â†’ è´¢åŠ¡å®¡æ ¸ â†’ æ€»ç»ç†

é«˜

**åŠ ç­ç”³è¯·**

ç›´å±ä¸»ç®¡å®¡æ‰¹

ä½

#### æ·±åº¦é›†æˆ

åˆ©ç”¨é£ä¹¦æ›´å¤šèƒ½åŠ›ï¼Œæ‰“é€ æ›´ä¸°å¯Œçš„ååŒä½“éªŒï¼š

graph TB A\[é£ä¹¦å®¡æ‰¹\] --> B\[æ¶ˆæ¯å¡ç‰‡\] A --> C\[æ™ºèƒ½æœºå™¨äºº\] A --> D\[çŸ¥è¯†åº“\] B --> B1\[å®¡æ‰¹è¯¦æƒ…å±•ç¤º\] B --> B2\[æ“ä½œæŒ‰é’®\] C --> C1\[æ™ºèƒ½æé†’\] C --> C2\[è‡ªåŠ¨è¡¥å…¨\] D --> D1\[å†å²è®°å½•æŸ¥è¯¢\] D --> D2\[å®¡æ‰¹è§„èŒƒ\] E\[.NETç³»ç»Ÿ\] --> A B --> E C --> E D --> E

**åŠŸèƒ½æ‰©å±•ç¤ºä¾‹**ï¼š

*   åœ¨é£ä¹¦ç¾¤èŠä¸­é€šè¿‡æ¶ˆæ¯å¡ç‰‡ç›´æ¥æŸ¥çœ‹å®¡æ‰¹è¯¦æƒ…
*   é€šè¿‡æœºå™¨äººæ™ºèƒ½å›å¤ï¼Œå¼•å¯¼ç”¨æˆ·å¡«å†™å®¡æ‰¹è¡¨å•
*   å°†å®¡æ‰¹è®°å½•åŒæ­¥åˆ°é£ä¹¦çŸ¥è¯†åº“ï¼Œæ–¹ä¾¿æŸ¥é˜…

#### å¹³å°åŒ–

å°†å®¡æ‰¹é›†æˆèƒ½åŠ›æŠ½è±¡ä¸ºä¸­å°æœåŠ¡ï¼Œä¾›ä¼ä¸šå†…éƒ¨æ‰€æœ‰ç³»ç»Ÿç»Ÿä¸€è°ƒç”¨ï¼š

    /// <summary>
    /// ç»Ÿä¸€å®¡æ‰¹æœåŠ¡ä¸­å°
    /// </summary>
    public interface IApprovalCenterService
    {
        /// <summary>
        /// ç»Ÿä¸€å‘èµ·å®¡æ‰¹ï¼ˆæ”¯æŒå¤šå¹³å°ï¼‰
        /// </summary>
        Task<string> CreateApprovalAsync(UnifiedApprovalRequest request);
    
        /// <summary>
        /// æŸ¥è¯¢å®¡æ‰¹çŠ¶æ€
        /// </summary>
        Task<ApprovalStatus> GetStatusAsync(string instanceId);
    
        /// <summary>
        /// å®¡æ‰¹ç»Ÿè®¡æŠ¥è¡¨
        /// </summary>
        Task<ApprovalStatistics> GetStatisticsAsync(DateTime from, DateTime to);
    }
    
    // å¤šä¸ªç³»ç»Ÿç»Ÿä¸€è°ƒç”¨
    await _approvalCenter.CreateApprovalAsync(new UnifiedApprovalRequest
    {
        BusinessSystem = "HR",
        BusinessType = "LeaveRequest",
        BusinessId = leaveId,
        Platform = "Feishu"  // å¯åˆ‡æ¢åˆ°å…¶ä»–å¹³å°
    });
    

* * *

**ç»“è¯­**

ä¼ ç»Ÿ .NET ç³»ç»Ÿæ— éœ€æ¨å€’é‡æ¥ï¼Œé€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡ä¸é£ä¹¦å®¡æ‰¹çš„æ·±åº¦é›†æˆï¼ŒåŒæ ·å¯ä»¥ç„•å‘æ–°çš„æ´»åŠ›ã€‚å¸Œæœ›æœ¬æ–‡çš„å®è·µèƒ½å¤Ÿä¸ºä½ çš„æ•°å­—åŒ–è½¬å‹ä¹‹è·¯æä¾›æœ‰ä»·å€¼çš„å‚è€ƒã€‚

è®©æˆ‘ä»¬ä¸€èµ·å‘Šåˆ«ä¿¡æ¯å­¤å²›ï¼Œæ‹¥æŠ±ç°ä»£åŒ–çš„ååŒåŠå…¬ä½“éªŒï¼ğŸš€

* * *

ç›¸å…³èµ„æº
----

### é¡¹ç›®åœ°å€

*   **Gitee ä»“åº“**ï¼š[https://gitee.com/mudtools/MudFeishu](https://gitee.com/mudtools/MudFeishu)
    
*   **GitHub ä»“åº“**ï¼š[https://github.com/mudtools/MudFeishu](https://github.com/mudtools/MudFeishu)
    
*   **NuGet åŒ…**ï¼š
    
    *   [Mud.Feishu.Abstractions](https://www.nuget.org/packages/Mud.Feishu.Abstractions/)
        
    *   [Mud.Feishu](https://www.nuget.org/packages/Mud.Feishu/)
        
    *   [Mud.Feishu.WebSocket](https://www.nuget.org/packages/Mud.Feishu.WebSocket/)
        
    *   [Mud.Feishu.Webhook](https://www.nuget.org/packages/Mud.Feishu.Webhook/)