---
layout: post
title: 'ç»™æ—§ç‰ˆ .NET ä¹Ÿå¼€ä¸€æ‰‡â€œç§æœ‰ä¹‹é—¨â€â€”â€”ILAccess.Fody å®ç°åŸç†ä¸è®¾è®¡'
date: "2025-11-01T00:44:18Z"
---
ç»™æ—§ç‰ˆ .NET ä¹Ÿå¼€ä¸€æ‰‡â€œç§æœ‰ä¹‹é—¨â€â€”â€”ILAccess.Fody å®ç°åŸç†ä¸è®¾è®¡
==========================================

ç»™æ—§ç‰ˆ .NET ä¹Ÿå¼€ä¸€æ‰‡"ç§æœ‰ä¹‹é—¨" â€”â€” ILAccess.Fody å®ç°åŸç†ä¸è®¾è®¡
============================================

ä½œè€…ï¼š**huoshan12345**  
é¡¹ç›®åœ°å€ï¼š[ILAccess.Fody](https://github.com/huoshan12345/ILAccess.Fody)

* * *

å‰è¨€ï¼šä» UnsafeAccessor è¯´èµ·
----------------------

åœ¨ .NET 8 ä¸­, å¾®è½¯å¼•å…¥äº†ä¸€ä¸ªè®©åº•å±‚å¼€å‘è€…éå¸¸å¿ƒåŠ¨çš„æ–°ç‰¹æ€§ â€”â€” [`UnsafeAccessor`](https://learn.microsoft.com/en-us/dotnet/api/system.runtime.compilerservices.unsafeaccessorattribute)  
å®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸ä½¿ç”¨åå°„çš„æƒ…å†µä¸‹è®¿é—®ç±»çš„ç§æœ‰å­—æ®µã€æ–¹æ³•æˆ–æ„é€ å‡½æ•°, è€Œä¸”æ˜¯**å¼ºç±»å‹**ã€**é›¶å¼€é”€**çš„.

ä¸¾ä¸ªä¾‹å­ï¼š

    class Dog
    {
        private string _name = "Puppy";
    }
    
    static class DogAccessors
    {
        [UnsafeAccessor(UnsafeAccessorKind.Field, Name = "_name")]
        public static extern ref string GetName(Dog d);
    }
    
    var dog = new Dog();
    ref var name = ref DogAccessors.GetName(dog);
    Console.WriteLine(name); // Puppy
    

CLR ä¼šåœ¨è¿è¡Œæ—¶å°† `GetName` ç»‘å®šåˆ° `_name` å­—æ®µ, ç”Ÿæˆç›´æ¥è®¿é—®çš„ IL æŒ‡ä»¤.æ€§èƒ½å‡ ä¹å’Œç›´æ¥è®¿é—®å…¬æœ‰å­—æ®µç›¸å½“.

> ğŸ§© Benchmarkï¼ˆæ¥è‡ª [Sharmila Malar çš„ Medium æ–‡ç« ](https://medium.com/@malarsharmila/introduction-to-the-unsafeaccessorattribute-class-in-net-8-0-d3a55ec15762)ï¼‰
> 
> *   Reflection: ~10.9 ns
> *   UnsafeAccessor: ~1.99 ns
> *   Direct Access: ~1.81 ns

ä½†æ˜¯, è¿™ä¸ªç‰¹æ€§**åªåœ¨ .NET 8+ å¯ç”¨**.

* * *

ILAccess.Fody è¯ç”Ÿ
----------------

æˆ‘å¸Œæœ›æ—§ç‰ˆ .NET å¹³å°ï¼ˆä¾‹å¦‚ .NET Frameworkã€.NET Standardã€.NET 6ï¼‰ä¹Ÿèƒ½äº«å—è¿™ç§â€œåå°„çº§çµæ´» + åŸç”Ÿçº§æ€§èƒ½â€çš„èƒ½åŠ›.äºæ˜¯æˆ‘ç¼–å†™äº† **[ILAccess.Fody](https://github.com/huoshan12345/ILAccess.Fody)**. å®ƒå®ç°äº†å’Œ `UnsafeAccessor` å‡ ä¹ä¸€è‡´çš„è¯­æ³•å’Œä½“éªŒ, ä½†é€šè¿‡ [Fody](https://github.com/Fody/Fody) + [Mono.Cecil](https://github.com/jbevain/cecil) åœ¨ç¼–è¯‘æœŸä¿®æ”¹ IL æ¥å®ç°.

*   `Mono.Cecil` æ˜¯ä¸€ä¸ªç”¨äºåˆ†æå’Œä¿®æ”¹ .NET ç¨‹åºé›†çš„åº“, å®ƒæä¾›äº†å¼ºå¤§çš„å¯¹è±¡æ¨¡å‹, è®©æˆ‘ä»¬èƒ½åœ¨ä¸åŠ è½½ç¨‹åºé›†çš„æƒ…å†µä¸‹è¯»å–ã€ç¼–è¾‘ã€ç”šè‡³ç”Ÿæˆæ–°çš„ IL ä»£ç .
*   `Fody` æ˜¯ä¸€ä¸ªåŸºäº `Mono.Cecil` å¯æ‰©å±•çš„ç¼–è¯‘æœŸç»‡å…¥å·¥å…·, å®ƒè®©å¼€å‘è€…èƒ½åœ¨æ„å»ºè¿‡ç¨‹ä¸­ç›´æ¥ä¿®æ”¹ç¨‹åºé›†çš„ IL, è€Œæ— éœ€æ‰‹åŠ¨å¤„ç† MSBuild æˆ– Visual Studio çš„å¤æ‚ç®¡çº¿.

* * *

ä½¿ç”¨æ–¹æ³• (å’ŒUnsafeAccessorå‡ ä¹ä¸€æ ·)
--------------------------

    static class DogILAccessors
    {
        // UnsafeAccessorAttribute -> ILAccessorAttribute
        // UnsafeAccessorKind -> ILAccessorKind
        [ILAccessor(ILAccessorKind.Field, Name = "_name")]
        public static extern ref string GetName(Dog d);
    }
    
    var dog = new Dog();
    ref var name = ref DogILAccessors.GetName(dog);
    Console.WriteLine(name); // Puppy
    

ç¼–è¯‘å, `ILAccess.Fody` ä¼šå°†è¿™äº›æ ‡è®°äº† `ILAccessor` çš„æ¡©æ–¹æ³•ä½“æ›¿æ¢ä¸ºç›´æ¥è®¿é—®ç§æœ‰æˆå‘˜çš„ IL :

    .method public hidebysig static string& GetName(class ILAccess.Dog d) cil managed
    {
        IL_0000: ldarg.0      // d
        IL_0001: ldflda       string ILAccess.Dog::_name
        IL_0006: ret
    }
    

æ²¡æœ‰åå°„ã€æ²¡æœ‰å§”æ‰˜ã€æ²¡æœ‰è¿è¡Œæ—¶æŸ¥æ‰¾.

* * *

æ ¸å¿ƒå®ç°: ç¼–è¯‘æœŸæ³¨å…¥ IL
--------------

*   éå†æ‰€æœ‰æ–¹æ³•, æ‰¾åˆ°å¸¦ `[ILAccessor]` çš„æ¡©æ–¹æ³•.
*   æ ¹æ®ä¸åŒçš„ `ILAccessorKind` ç”Ÿæˆå¯¹åº”çš„ IL æŒ‡ä»¤.
*   ç¡®å®šç›®æ ‡ç±»å‹, å¯¹äºæ„é€ å‡½æ•°ç›®æ ‡ç±»å‹å°±æ˜¯æ¡©æ–¹æ³•çš„è¿”å›ç±»å‹, å…¶ä½™çš„å°±æ˜¯æ¡©æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹.
*   å¯¹äºå­—æ®µ, æ ¹æ®å­—æ®µååŒ¹é…, åœ¨ç›®æ ‡ç±»å‹çš„å£°æ˜å­—æ®µé‡Œæ‰¾åˆ°ç›®æ ‡å­—æ®µ, ç„¶åæ ¹æ®æ˜¯å¦ä¸ºé™æ€é€‰æ‹© `Ldsfld` æˆ– `Ldfld` æŒ‡ä»¤, å¦‚æœæ˜¯ `ref`è®¿é—®, åˆ™éœ€é€‰æ‹© `Ldsflda` æˆ– `Ldfld`
*   å¯¹äºæ–¹æ³•, åˆ™éœ€è¦æ ¹æ®æ–¹æ³•å+æ³›å‹å‚æ•°ä¸ªæ•°+å‚æ•°ç±»å‹åˆ—è¡¨æ¥åŒ¹é…, åœ¨ç›®æ ‡ç±»å‹çš„å£°æ˜æ–¹æ³•é‡Œæ‰¾åˆ°ç›®æ ‡æ–¹æ³•, ç„¶åé€‰æ‹© `callvirt` æˆ– `call` æŒ‡ä»¤
*   å¯¹äºæ„é€ å‡½æ•°, å…¶å®å°±æ˜¯ä¸€ä¸ªåä¸º `.ctor` çš„æ–¹æ³•, å¤„ç†æ–¹å¼å’Œæ™®é€šæ–¹æ³•ç±»ä¼¼, ä¸è¿‡æŒ‡ä»¤æ˜¯ `newobj`

* * *

é¢å¤–å¤„ç†
----

*   å½“æƒ³è®¿é—®çš„ç§æœ‰æˆå‘˜çš„ç±»å‹æ˜¯å®šä¹‰åœ¨ä¸€ä¸ª [å¼•ç”¨ç¨‹åºé›†(Reference Assemblies)](https://learn.microsoft.com/en-us/dotnet/standard/assembly/reference-assemblies) ä¸­

æ¯”å¦‚æƒ³è®¿é—®åŸºç¡€åº“ä¸­çš„ `List<T>` çš„ `_items`, è€ŒåŸºç¡€åº“åœ¨ç¼–è¯‘æ—¶é€šå¸¸ä¼šä»¥ `å¼•ç”¨ç¨‹åºé›†` çš„å½¢å¼è¿›è¡Œå¼•ç”¨, æ­¤æ—¶è¿™ä¸ªç¨‹åºé›†åªåŒ…å«è¿™ä¸ªç±»å‹çš„å…¬å…±æˆå‘˜çš„å®šä¹‰, ä¸åŒ…æ‹¬å…¶å®ç°å·²ç»æ‰€Aæœ‰çš„ç§æœ‰æˆå‘˜. é‚£ä¹ˆå°±æ— æ³•æ ¹æ®åç§°æ‰¾åˆ°ç§æœ‰æˆå‘˜çš„ç”¨äºç”Ÿæˆ IL çš„å…ƒæ•°æ®.  
è§£å†³æ–¹æ³•: å…ˆé€šè¿‡å¼•ç”¨ç¨‹åºé›†çš„è·¯å¾„æ‰¾åˆ°å…¶å¯¹åº”çš„ `å®ç°ç¨‹åºé›†(Implementation Assemblies)` çš„è·¯å¾„, å¹¶ä»å…¶ä¸­è¯»å–æ‰€éœ€çš„å…ƒæ•°æ®.

*   å½“æƒ³è®¿é—®çš„ç§æœ‰æˆå‘˜çš„ç±»å‹å¹¶ä¸å®šä¹‰åœ¨å½“å‰è¢«ç¼–è¯‘çš„ç¨‹åºé›†ä¸­

è¿™ç§æƒ…å†µå¦‚æœç›´æ¥ä½¿ç”¨ IL æŒ‡ä»¤è®¿é—®å…¶ç§æœ‰æˆå‘˜ä¼šè§¦å‘ `MethodAccessException` æˆ–è€… `FieldAccessException` ä¹‹ç±»çš„å¼‚å¸¸.  
è§£å†³æ–¹æ³•: ä½¿ç”¨ `IgnoresAccessChecksToAttribute` è·³è¿‡å¯¹æƒ³è®¿é—®çš„ç¨‹åºé›†çš„æƒé™æ£€æŸ¥. ä¾‹å¦‚

    [assembly: IgnoresAccessChecksTo("System.Private.CoreLib")] // è·³è¿‡å¯¹åŸºç¡€åº“çš„è®¿é—®æ£€æŸ¥
    

ä¸è¿‡åœ¨ä½¿ç”¨ `ILAccess.Fody` çš„æ—¶å€™æ— éœ€æ‰‹åŠ¨æ·»åŠ è¿™äº›ä»£ç , å®ƒä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ³¨å…¥åˆ°è¢«ç¼–è¯‘çš„ç¨‹åºé›†ä¸­.

* * *

è®¿é—®ç§æœ‰æˆå‘˜æ–¹æ³•çš„å¯¹æ¯”
-----------

ç‰¹æ€§

åå°„

UnsafeAccessor

ILAccess.Fody

æ”¯æŒå¹³å°

æ‰€æœ‰ .NET å¹³å°

ä»… .NET 8+

å…¨éƒ¨ .NET å¹³å°

å®ç°æ–¹å¼

è¿è¡Œæ—¶æŸ¥æ‰¾

CLR è¿è¡Œæ—¶æ³¨å…¥

Fody ç¼–è¯‘æœŸæ³¨å…¥

æ€§èƒ½

æ…¢

å‡ ä¹æ¥è¿‘ç›´æ¥è®¿é—®

å‡ ä¹æ¥è¿‘ç›´æ¥è®¿é—®

ç¼–è¯‘æœŸéªŒè¯

âŒ

âŒ

âœ…

AOTæ”¯æŒ

âš ï¸ å—é™æ”¯æŒ

âœ…

âœ…

* * *

ç»“è¯­
--

ILAccess.Fody çš„ç›®æ ‡å¾ˆçº¯ç²¹:

> è®©æ—§ç‰ˆ .NET ä¹Ÿèƒ½æ‹¥æœ‰ UnsafeAccessor çš„åŠ›é‡.

å®ƒç”¨ç¼–è¯‘æœŸ IL æ³¨å…¥çš„æ–¹å¼, è®©ç§æœ‰è®¿é—®å˜å¾—å¼ºå¤§è€Œå®‰å…¨.  
å¦‚æœä½ æƒ³äº†è§£æ›´å¤š, æ¬¢è¿è®¿é—®: ğŸ‘‰ [ILAccess.Fody](https://github.com/huoshan12345/ILAccess.Fody)