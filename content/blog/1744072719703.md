---
layout: post
title: 'åŸºäºASTå®ç°å›½é™…åŒ–æ–‡æœ¬æå–'
date: "2025-04-08T00:38:39Z"
---
åŸºäºASTå®ç°å›½é™…åŒ–æ–‡æœ¬æå–
==============

> æˆ‘ä»¬æ˜¯[è¢‹é¼ äº‘æ•°æ ˆ UED å›¢é˜Ÿ](http://ued.dtstack.cn/)ï¼Œè‡´åŠ›äºæ‰“é€ ä¼˜ç§€çš„ä¸€ç«™å¼æ•°æ®ä¸­å°äº§å“ã€‚æˆ‘ä»¬å§‹ç»ˆä¿æŒå·¥åŒ ç²¾ç¥ï¼Œæ¢ç´¢å‰ç«¯é“è·¯ï¼Œä¸ºç¤¾åŒºç§¯ç´¯å¹¶ä¼ æ’­ç»éªŒä»·å€¼ã€‚

> æœ¬æ–‡ä½œè€…ï¼š[éœœåº](https://luckyfbb.github.io/blog)

### å‰è¨€

åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œéœ€è¦è¯»è€…æœ‰ä¸€äº› babel çš„åŸºç¡€çŸ¥è¯†ï¼Œbabel çš„æ¶æ„å›¾å¦‚ä¸‹:

![file](https://img2024.cnblogs.com/other/2332333/202504/2332333-20250407112922995-809143616.png)

### ç¡®å®šä¸­æ–‡èŒƒå›´

å…ˆéœ€è¦æ˜ç¡®é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨ä¸­æ–‡çš„æƒ…å†µæœ‰å“ªäº›?

    const a = 'éœœåº';
    const b = `éœœåº`;
    const c = `${isBoolean} ? "éœœåº" : "FBB"`;
    const obj = { a: 'éœœåº' };
    // enum Status {
    //     Todo = "æœªå®Œæˆ",
    //     Complete = "å®Œæˆ"
    // }
    // enum Status {
    //     "æœªå®Œæˆ",
    //     "å®Œæˆ"
    // }
    const dom = <div>éœœåº</div>;
    const dom1 = <Customer name="éœœåº" />;
    

è™½ç„¶æœ‰å¾ˆå¤šæƒ…å†µä¸‹ä¼šå‡ºç°ä¸­æ–‡ï¼Œåœ¨ä»£ç ä¸­å­˜åœ¨çš„æ—¶å€™å¤§éƒ¨åˆ†æ˜¯`string`æˆ–è€…æ¨¡ç‰ˆå­—ç¬¦ä¸²ï¼Œåœ¨`react`ä¸­çš„æ—¶å€™ä¸€ä¸ªæ˜¯`dom`çš„å­èŠ‚ç‚¹è¿˜æ˜¯ä¸€ç§æ˜¯`props`ä¸Šçš„å±æ€§åŒ…å«ä¸­æ–‡ã€‚

    // const a = 'éœœåº';
    {
      "type": "StringLiteral",
      "start": 10,
      "end": 14,
      "extra": {
        "rawValue": "éœœåº",
        "raw": "'éœœåº'"
      },
      "value": "éœœåº"
    }
    

#### StringLiteral

å¯¹åº”çš„`AST`èŠ‚ç‚¹ä¸º`StringLiteral`ï¼Œéœ€è¦å»éå†æ‰€æœ‰çš„`StringLiteral`èŠ‚ç‚¹ï¼Œå°†å½“å‰çš„èŠ‚ç‚¹æ›¿æ¢ä¸ºæˆ‘ä»¬éœ€è¦çš„`I18N.key`è¿™ç§èŠ‚ç‚¹ã€‚

    // const b = `${finalRoles}(è´¨é‡é¡¹ç›®ï¼š${projects})`
    {
      "type": "TemplateLiteral",
      "start": 10,
      "end": 43,
      "expressions": [
        {
          "type": "Identifier",
          "start": 13,
          "end": 23,
          "name": "finalRoles"
        },
        {
          "type": "Identifier",
          "start": 32,
          "end": 40,
          "name": "projects"
        }
      ],
      "quasis": [
        {
          "type": "TemplateElement",
          "start": 11,
          "end": 11,
          "value": {
            "raw": "",
            "cooked": ""
          }
        },
        {
          "type": "TemplateElement",
          "start": 24,
          "end": 30,
          "value": {
            "raw": "(è´¨é‡é¡¹ç›®ï¼š",
            "cooked": "(è´¨é‡é¡¹ç›®ï¼š"
          }
        },
        {
          "type": "TemplateElement",
          "start": 41,
          "end": 42,
          "value": {
            "raw": ")",
            "cooked": ")"
          }
        }
      ]
    }
    

#### TemplateLiteral

ç›¸å¯¹äºå­—ç¬¦ä¸²æƒ…å†µä¼šå¤æ‚ä¸€äº›ï¼Œ`TemplateLiteral`ä¸­ä¼šå‡ºç°å˜é‡çš„æƒ…å†µï¼Œèƒ½å¤Ÿçœ‹åˆ°åœ¨`TemplateLiteral`èŠ‚ç‚¹ä¸­å­˜åœ¨`expressions`å’Œ`quasis`ä¸¤ä¸ªå­—æ®µåˆ†åˆ«è¡¨ç¤ºå˜é‡å’Œå­—ç¬¦ä¸²

å…¶å®å¯ä»¥å‘ç°å¯¹äºå­—ç¬¦ä¸²æ¥è¯´å…¨éƒ¨éƒ½åœ¨`TemplateElement`èŠ‚ç‚¹ä¸Šï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥ç›´æ¥éå†æ‰€æœ‰çš„`TemplateElement`èŠ‚ç‚¹ï¼Œå’Œ`StringLiteral`ä¸€æ ·ã€‚

ç›´æ¥éå†`TemplateElement`çš„æ—¶å€™ï¼Œå¤„ç†ä¹‹åçš„æ•ˆæœå¦‚ä¸‹:

    const b = `${finalRoles}(è´¨é‡é¡¹ç›®ï¼š${projects})`;
    
    const b = `${finalRoles}${I18N.K}${projects})`;
    
    // I18N.K = "(è´¨é‡é¡¹ç›®ï¼š"
    

é‚£ä¹ˆè¿™ç§åªæå–ä¸­æ–‡ä¸ç®¡å˜é‡çš„æƒ…å†µï¼Œä¼šå¯¼è‡´ç¿»è¯‘ä¸åˆ°çš„é—®é¢˜ï¼Œä¸Šä¸‹æ–‡å¾ˆç¼ºå¤±ã€‚

æœ€åæˆ‘ä»¬ä¼šå¤„ç†æˆ`{val1}(è´¨é‡é¡¹ç›®ï¼š{val2})`çš„æƒ…å†µï¼Œå°†å¯¹åº”`val1`å’Œ`val2`ä¼ å…¥

    I18N.get(I18N.K, {
      val1: finalRoles,
      val2: projects,
    });
    

#### JSXText

å¯¹åº”çš„`AST`èŠ‚ç‚¹ä¸º`JSXText`ï¼Œå»éå†`JSXElement`èŠ‚ç‚¹ï¼Œåœ¨éå†å¯¹åº”çš„`children`ä¸­çš„`JSXText`å¤„ç†ä¸­æ–‡æ–‡æœ¬

    {
      "type": "JSXElement",
      "start": 12,
      "end": 25,
      "children": [
        {
          "type": "JSXText",
          "start": 17,
          "end": 19,
          "extra": {
            "rawValue": "éœœåº",
            "raw": "éœœåº"
          },
          "value": "éœœåº"
        }
      ]
    }
    

#### JSXAttribute

å¯¹åº”çš„`AST`èŠ‚ç‚¹ä¸º`JSXAttribute`ï¼Œä¸­æ–‡å­˜åœ¨çš„èŠ‚ç‚¹è¿˜æ˜¯`StringLiteral`ï¼Œä½†æ˜¯åœ¨å¤„ç†çš„æ—¶å€™è¿˜æ˜¯ç‰¹æ®Šå¤„ç†`JSXAttribute`ä¸­çš„`StringLiteral`ï¼Œå› ä¸ºå¯¹äºè¿™ç§`JSX`ä¸­çš„æ•°æ®æ¥è¯´æˆ‘ä»¬éœ€è¦åŒ…è£¹`{}`ï¼Œä¸æ˜¯ç›´æ¥åšæ–‡æœ¬æ›¿æ¢çš„

    {
      "type": "JSXOpeningElement",
      "start": 13,
      "end": 35,
      "name": {
        "type": "JSXIdentifier",
        "start": 14,
        "end": 22,
        "name": "Customer"
      },
      "attributes": [
        {
          "type": "JSXAttribute",
          "start": 23,
          "end": 32,
          "name": {
            "type": "JSXIdentifier",
            "start": 23,
            "end": 27,
            "name": "name"
          },
          "value": {
            "type": "StringLiteral",
            "start": 28,
            "end": 32,
            "extra": {
              "rawValue": "éœœåº",
              "raw": "\"éœœåº\""
            },
            "value": "éœœåº"
          }
        }
      ],
      "selfClosing": true
    }
    

### ä½¿ç”¨ Babel å¤„ç†

![file](https://img2024.cnblogs.com/other/2332333/202504/2332333-20250407112923553-1334622772.png)

#### ä½¿ç”¨ @babel/parser å°†æºä»£ç è½¬è¯‘ä¸º AST

    const plugins: ParserOptions['plugins'] = ['decorators-legacy', 'typescript'];
    if (fileName.endsWith('text') || fileName.endsWith('text')) {
      plugins.push('text');
    }
    const ast = parse(sourceCode, {
      sourceType: 'module',
      plugins,
    });
    

#### @babel/traverse ç‰¹æ®Šå¤„ç†ä¸Šè¿°çš„èŠ‚ç‚¹ï¼Œè½¬åŒ– AST

    babelTraverse(ast, {
      StringLiteral(path) {
        const { node } = path;
        const { value } = node;
        if (
          !value.match(DOUBLE_BYTE_REGEX) ||
          (path.parentPath.node.type === 'CallExpression' &&
            path.parentPath.toString().includes('console'))
        ) {
          return;
        }
        path.replaceWithMultiple(template.ast(`I18N.${key}`));
      },
      TemplateLiteral(path) {
        const { node } = path;
        const { start, end } = node;
        if (!start || !end) return;
        let templateContent = sourceCode.slice(start + 1, end - 1);
        if (
          !templateContent.match(DOUBLE_BYTE_REGEX) ||
          (path.parentPath.node.type === 'CallExpression' &&
            path.parentPath.toString().includes('console')) ||
          path.parentPath.node.type === 'TaggedTemplateExpression'
        ) {
          return;
        }
        if (!node.expressions.length) {
          path.replaceWithMultiple(template.ast(`I18N.${key}`));
          path.skip();
          return;
        }
        const expressions = node.expressions.map((expression) => {
          const { start, end } = expression;
          if (!start || !end) return;
          return sourceCode.slice(start, end);
        });
        const kvPair = expressions.map((expression, index) => {
          templateContent = templateContent.replace(
            `\${${expression}}`,
            `{val${index + 1}}`,
          );
          return `val${index + 1}: ${expression}`;
        });
        path.replaceWithMultiple(
          template.ast(`I18N.get(I18N.${key},{${kvPair.join(',\n')}})`),
        );
      },
      JSXElement(path) {
        const children = path.node.children;
        const newChild = children.map((child) => {
          if (babelTypes.isJSXText(child)) {
            const { value } = child;
            if (value.match(DOUBLE_BYTE_REGEX)) {
              const newExpression = babelTypes.jsxExpressionContainer(
                babelTypes.identifier(`I18N.${key}`),
              );
              return newExpression;
            }
          }
          return child;
        });
        path.node.children = newChild;
      },
      JSXAttribute(path) {
        const { node } = path;
        if (
          babelTypes.isStringLiteral(node.value) &&
          node.value.value.match(DOUBLE_BYTE_REGEX)
        ) {
          const expression = babelTypes.jsxExpressionContainer(
            babelTypes.memberExpression(
              babelTypes.identifier('I18N'),
              babelTypes.identifier(`${key}`),
            ),
          );
          node.value = expression;
        }
      },
    });
    

å¯¹äº`TemplateLiteral`æ¥è¯´éœ€è¦å¤„ç†`expression`ï¼Œé€šè¿‡æˆªå–çš„æ–¹å¼è·å–åˆ°å¯¹åº”çš„æ¨¡ç‰ˆå­—ç¬¦ä¸² `templateContent`ï¼Œå¦‚æœä¸å­˜åœ¨`expressions`ï¼Œç›´æ¥ç±»ä¼¼`StringLiteral`å¤„ç†ï¼›å­˜åœ¨`expressions`çš„æƒ…å†µä¸‹ï¼Œéå†`expressions`é€šè¿‡`${val(index)}`æ›¿æ¢æ‰`templateContent`ä¸­çš„`expression`ï¼Œæœ€åä½¿ç”¨`I18N.get`çš„æ–¹å¼è·å–å¯¹åº”çš„å€¼

    const name = `${a}éœœåº`;
    // const name = I18N.get(I18N.test.A, { val1: a });
    
    const name1 = `${a ? 'éœœ' : 'åº'}éœœåº`;
    // const name1 = I18N.get(I18N.test.B, { val1: a ? I18N.test.C : I18N.test.D });
    

å¯¹äº`TemplateLiteral`èŠ‚ç‚¹æ¥è¯´ï¼Œå¦‚æœæ˜¯åµŒå¥—çš„æƒ…å†µï¼Œä¼šå‡ºç°é—®é¢˜ã€‚

    const name1 = `${a ? `éœœ` : `åº`}éœœåº`;
    // const name1 = I18N.get(I18N.test.B, { val1: a ? `éœœ` : `åº` });
    

> ğŸ¤”Â  ä¸ºä½•å¯¹äº`TemplateLiteral`ä¸­åµŒå¥—çš„`StringLiteral`ä¼šå¤„ç†ï¼Œè€Œ`TemplateLiteral`å°±ä¸å¤„ç†å‘¢ï¼Ÿ  
> ğŸ’¡Â  å¯¼è‡´åŸå› ä¸º`babel`ä¸ä¼šè‡ªåŠ¨é€’å½’å¤„ç†`TemplateLiteral`çš„å­çº§åµŒå¥—æ¨¡æ¿ã€‚  
> ä¸Šè¿°çš„ä»£ç ä¸­é€šè¿‡éå†ä¸€äº›`AST`å¤„ç†å®Œäº†ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿä¸€å¼•å…¥å½“å‰`I18N`è¿™ä¸ªå˜é‡ã€‚é‚£ä¹ˆæ²¡æˆ‘ä»¬éœ€è¦åœ¨å½“å‰æ–‡ä»¶çš„`AST`é¡¶éƒ¨çš„`import`è¯­å¥åæ’å…¥å½“å‰çš„`importStatement`

    Program: {
        exit(path) {
            const importStatement = projectConfig.importStatement;
            const result = importStatement
                .replace(/^import\s+|\s+from\s+/g, ',')
                .split(',')
                .filter(Boolean);
            // åˆ¤æ–­å½“å‰çš„æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨ importStatement è¯­å¥
            const existingImport = path.node.body.find((node) => {
                return (
                    babelTypes.isImportDeclaration(node) &&
                    node.source.value === result[1]
                );
            });
            if (!existingImport) {
                const importDeclaration = babelTypes.importDeclaration(
                    [
                        babelTypes.importDefaultSpecifier(
                            babelTypes.identifier(result[0]),
                        ),
                    ],
                    babelTypes.stringLiteral(result[1]),
                );
                path.node.body.unshift(importDeclaration);
            }
        },
    }
    

#### è½¬ä¸ºä»£ç 

    const { code } = generate(ast, {
      retainLines: true,
      comments: true,
    });
    

å› ä¸ºæˆ‘ä»¬çš„åœºæ™¯ä¸é€‚åˆå°†è¯¥åŠŸèƒ½å°è£…æˆ`plugin`ï¼Œä½†æ˜¯æ•´ä½“å’Œå†™`plugin`çš„æ€è·¯å·®ä¸å¤šã€‚åœ¨`.babelrc`ä¸­é…ç½®å¯¹åº”çš„`plugin`å³å¯

    const i18nPlugin = () => {
      return {
        visitor: {
          StringLiteral(path) {},
          TemplateLiteral(path) {},
          JSXElement(path) {},
          JSXAttribute(path) {},
          Program: {},
        },
      };
    };
    

### å…¶ä»–å¤„ç†

**åŠ¨æ€ç”Ÿæˆ key**

æ¯ä¸€ä¸ªä¸­æ–‡ç”Ÿæˆ`key`çš„æ–¹å¼éƒ½æ˜¯å›ºå®šçš„ï¼Œç±»ä¼¼`excel`åˆ—å

    export const getSortKey = (n: number, extractMap = {}): string => {
      let label = '';
      let num = n;
      while (num > 0) {
        num--;
        label = String.fromCharCode((num % 26) + 65) + label;
        num = Math.floor(num / 26);
      }
      const key = `${label}`;
      if (_.get(extractMap, key)) {
        return getSortKey(n + 1, extractMap);
      }
      return key;
    };
    

æ¯ä¸€ä¸ªæ–‡ä»¶çš„å‰ç¼€éƒ½æ˜¯ä¸€å®šçš„ï¼ŒæŒ‰ç€è·¯å¾„ç”Ÿæˆçš„ï¼Œä¸ä¼šåŒ…å«`extractDir`ä¹‹å‰çš„å†…å®¹

    export const getFileKey = (filePath: string) => {
        const extractDir = getProjectConfig().extractDir;
    
        const basePath = path.resolve(process.cwd(), extractDir);
    
        const relativePath = path.relative(basePath, filePath);
    
        const names = slash(relativePath).split('/');
        const fileName = _.last(names) as any;
        let fileKey = fileName.split('.').slice(0, -1).join('.');
        const dir = names.slice(0, -1).join('.');
        if (dir) fileKey = names.slice(0, -1).concat(fileKey).join('.');
        return fileKey.replace(/-/g, '_');
    };
    

### è„šæ‰‹æ¶å‘½ä»¤

[i18n-extract-cli](https://github.com/LuckyFBB/i18n-extract)

ç›®å‰æ”¯æŒå‘½ä»¤å¦‚ä¸‹ï¼š

    - init: ç”¨äºåˆå§‹åŒ–é…ç½®åŒ–æ–‡ä»¶
    - extract: æ ¹æ®é…ç½®æ–‡ä»¶æå– extractDir çš„ä¸­æ–‡å†™å…¥åˆ°å¯¹åº”çš„æ–‡ä»¶
    - extract:check: æ£€æŸ¥ extractDir æ–‡ä»¶å¤¹ä¸­çš„ä¸­æ–‡æ˜¯å¦æå–å®Œå…¨
    - extract:clear: æ¸…ç† extractDir å°šæœªä½¿ç”¨çš„å›½é™…åŒ–æ–‡æ¡ˆ
    

    npx i18n-extract-cli init
    

ä¼šåˆå§‹åŒ–ä¸€ä»½`i18n.config.json`

    {
      "localeDir": "locales",
      "extractDir": "./",
      "importStatement": "import I18N from @/utils/i18n",
      "excludeFile": [],
      "excludeDir": []
    }
    

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå¼€å§‹æå–`extractDir`ç›®å½•ä¸‹çš„ä¸­æ–‡æ–‡æœ¬åˆ°`localeDir/zh-CN`

    npx i18n-extract-cli extract
    

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ£€æŸ¥ extractDir æ–‡ä»¶å¤¹ä¸­çš„ä¸­æ–‡æ˜¯å¦æå–å®Œå…¨ï¼Œéœ€è¦æ³¨æ„ console ä¸­çš„ä¸­æ–‡ä¹Ÿä¼šè¢«æ£€æŸ¥

    npx i18n-extract-cli extract:check
    

æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œæ¸…ç† extractDir å°šæœªä½¿ç”¨çš„å›½é™…åŒ–æ–‡æ¡ˆ

> å€¼å¾—æ³¨æ„ï¼Œæ˜¯æŒ‰ç€æ¯ä¸ªæ–‡ä»¶è·¯å¾„ä½œä¸ºkeyæ¥åˆ¤æ–­å½“å‰æ–‡ä»¶ä¸­çš„ sortKey æ˜¯å¦ä½¿ç”¨ï¼Œå› æ­¤å¿…é¡»ä¿è¯æ¯ä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨çš„ key ä¸ºfileKey + sortKeyï¼Œå¦åˆ™ä¼šå¯¼è‡´å½“å‰è„šæœ¬å¤±æ•ˆ

    npx i18n-extract-cli extract:clear
    

### æœ€å

æ¬¢è¿å…³æ³¨ã€è¢‹é¼ äº‘æ•°æ ˆUEDå›¢é˜Ÿã€‘~  
è¢‹é¼ äº‘æ•°æ ˆ UED å›¢é˜ŸæŒç»­ä¸ºå¹¿å¤§å¼€å‘è€…åˆ†äº«æŠ€æœ¯æˆæœï¼Œç›¸ç»§å‚ä¸å¼€æºäº†æ¬¢è¿ star

*   **[å¤§æ•°æ®åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿâ€”â€”Taier](https://dtstack.github.io/Taier/)**
*   **[è½»é‡çº§çš„ Web IDE UI æ¡†æ¶â€”â€”Molecule](https://dtstack.github.io/molecule/)**
*   **[é’ˆå¯¹å¤§æ•°æ®é¢†åŸŸçš„ SQL Parser é¡¹ç›®â€”â€”dt-sql-parser](https://dtstack.github.io/monaco-sql-languages/)**
*   **[è¢‹é¼ äº‘æ•°æ ˆå‰ç«¯å›¢é˜Ÿä»£ç è¯„å®¡å·¥ç¨‹å®è·µæ–‡æ¡£â€”â€”code-review-practices](https://github.com/DTStack/code-review-practices)**
*   **[ä¸€ä¸ªé€Ÿåº¦æ›´å¿«ã€é…ç½®æ›´çµæ´»ã€ä½¿ç”¨æ›´ç®€å•çš„æ¨¡å—æ‰“åŒ…å™¨â€”â€”ko](https://github.com/DTStack/ko)**
*   **[ä¸€ä¸ªé’ˆå¯¹ antd çš„ç»„ä»¶æµ‹è¯•å·¥å…·åº“â€”â€”ant-design-testing](https://github.com/DTStack/ant-design-testing)**