---
layout: post
title: 'HarmonyOS å®æˆ˜ï¼šç»™ç¬”è®°åº”ç”¨åŠ é˜²æˆªå›¾æ°´å°'
date: "2025-06-05T00:42:10Z"
---
HarmonyOS å®æˆ˜ï¼šç»™ç¬”è®°åº”ç”¨åŠ é˜²æˆªå›¾æ°´å°
========================

æœ€è¿‘åœ¨åšç¬”è®°ç±»åº”ç”¨æ—¶ï¼Œé‡åˆ°ä¸€ä¸ªå¤´ç–¼çš„éœ€æ±‚ï¼šé˜²æ­¢ç”¨æˆ·å†…å®¹è¢«éæ³•æˆªå›¾ä¼ æ’­ã€‚æ€æ¥æƒ³å»ï¼ŒåŠ æ°´å°æ˜¯ä¸ªç›´æ¥æœ‰æ•ˆçš„æ–¹æ¡ˆã€‚ç ”ç©¶äº† HarmonyOS çš„å¼€å‘æ–‡æ¡£åï¼Œå‘ç°ç”¨ Canvas é…åˆå¸ƒå±€ç»„ä»¶èƒ½è½»æ¾å®ç°åŠ¨æ€æ°´å°æ•ˆæœã€‚ä»Šå¤©å°±æ¥èŠèŠå¦‚ä½•ç»™ç¬”è®°é¡µé¢åŠ ä¸Šã€Œä¼šå‘¼å¸ã€çš„ç”¨æˆ·ä¸“å±æ°´å°ï¼Œé¡ºä¾¿åˆ†äº«å‡ ä¸ªå¼€å‘æ—¶è¸©è¿‡çš„å‘ã€‚

ä¸€ã€éœ€æ±‚æ‹†è§£ï¼šä»€ä¹ˆæ ·çš„æ°´å°é˜²æˆªå›¾æœ€æœ‰æ•ˆï¼Ÿ
--------------------

æˆ‘ä»¬çš„ç›®æ ‡å¾ˆæ˜ç¡®ï¼šåœ¨ç¬”è®°æµè§ˆé¡µé¢è¦†ç›–ä¸€å±‚åŠé€æ˜æ°´å°ï¼Œå†…å®¹åŒ…å«**ç”¨æˆ· ID+å®æ—¶æ—¶é—´æˆ³**ï¼Œä¸”æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

*   **æ–œå‘æ’åˆ—**ï¼šé˜²æ­¢æˆªå›¾åé€šè¿‡ç®€å•è£å‰ªå»é™¤
*   **åŠ¨æ€æ›´æ–°**ï¼šæ¯åˆ†é’Ÿåˆ·æ–°æ—¶é—´æˆ³ï¼Œå¢åŠ è¿½è¸ªéš¾åº¦
*   **æ€§èƒ½æ— æ„Ÿ**ï¼šä¸å½±å“é¡µé¢æ»‘åŠ¨å’Œäº¤äº’
*   **å…¨å±€è¦†ç›–**ï¼šé€‚é…ä¸åŒå±å¹•å°ºå¯¸å’Œæ—‹è½¬æ–¹å‘

äºŒã€æ ¸å¿ƒå®ç°ï¼šç”¨canvaså®ç°åŠ¨æ€æ°´å°
--------------------

### 1\. æ­å»ºæ°´å°ç»„ä»¶éª¨æ¶

é¦–å…ˆå°è£…ä¸€ä¸ª `UserWatermark` ç»„ä»¶ï¼ŒåŸºäº HarmonyOS çš„ Canvas å®ç°è‡ªç»˜ã€‚è¿™é‡Œæœ‰ä¸ªå…³é”®ç»†èŠ‚ï¼šé€šè¿‡ `hitTestBehavior` è®¾ç½®æ°´å°å±‚é€æ˜ï¼Œé¿å…é˜»æŒ¡ç”¨æˆ·ç‚¹å‡»ç¬”è®°å†…å®¹ã€‚

    // components/Watermark.ets
    @Component
    export struct UserWatermark {
      @State userId = 'user001' // ä»è´¦å·æœåŠ¡è·å–çš„åŠ¨æ€ç”¨æˆ·ID
      private context = new CanvasRenderingContext2D(new RenderingContextSettings(true))
      private timestamp = new Date().toLocaleString() // å®æ—¶æ—¶é—´æˆ³
    
      build() {
        Canvas(this.context)
          .width('100%')
          .height('100%')
          .hitTestBehavior(HitTestMode.Transparent) // é‡ç‚¹ï¼ä¸å½±å“è§¦æ‘¸äº‹ä»¶
          .onReady(() => this.drawWatermark())
      }
    
      // åˆå§‹åŒ–ç»˜åˆ¶
      private drawWatermark() {
        this.updateTimestamp() // å…ˆæ›´æ–°æ—¶é—´
        this.context.clearRect(0, 0, this.context.width, this.context.height)
        this.setWatermarkStyle()
        this.drawWatermarkGrid()
      }
    }
    

### 2\. åŠ¨æ€æ—¶é—´æˆ³å®ç°ï¼šæ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡

ä¸ºäº†é¿å…é«˜é¢‘é‡ç»˜å½±å“æ€§èƒ½ï¼Œé€‰æ‹©æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´æˆ³ã€‚è¿™é‡Œç”¨ `setInterval` é…åˆçŠ¶æ€å˜é‡è§¦å‘é‡ç»˜ï¼š

    // ç»„ä»¶ç”Ÿå‘½å‘¨æœŸé’©å­
    aboutToAppear() {
      this.updateTimestamp() // åˆå§‹åŒ–æ—¶é—´
      setInterval(() => {
        this.timestamp = new Date().toLocaleString() // æ›´æ–°æ—¶é—´
        this.drawWatermark() // è§¦å‘ç”»å¸ƒé‡ç»˜
      }, 60 * 1000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    }
    
    // æ—¶é—´æ ¼å¼åŒ–æ–¹æ³•ï¼ˆå¯æ ¹æ®éœ€æ±‚è°ƒæ•´ï¼‰
    private updateTimestamp() {
      const now = new Date()
      this.timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`
    }
    

### 3\. æ–œå‘æ°´å°çš„åæ ‡è®¡ç®—ã€Œç„å­¦ã€

å®ç°æ–œå‘æ’åˆ—çš„å…³é”®æ˜¯**åæ ‡ç³»æ—‹è½¬å’Œå¹³ç§»**ã€‚è¿™é‡Œè¸©è¿‡æœ€å¤§çš„å‘æ˜¯æ—‹è½¬ååŸç‚¹ä½ç½®çš„å˜åŒ–ï¼Œè°ƒè¯•äº†åŠå°æ—¶æ‰å‘ç°éœ€è¦å°†åŸç‚¹ç§»åˆ°å·¦ä¸‹è§’ï¼š

    private drawWatermarkGrid() {
      const text = `ç”¨æˆ·ID:${this.userId} ${this.timestamp}`
      const font = '14vp sans-serif'
      const angle = -25 * Math.PI / 180 // å€¾æ–œ25åº¦
    
      // è®¡ç®—æ–‡æœ¬å°ºå¯¸
      this.context.font = font
      const { width: textWidth, height: textHeight } = this.context.measureText(text)
    
      // åæ ‡ç³»å˜æ¢ï¼šå…ˆå¹³ç§»åˆ°å·¦ä¸‹è§’ï¼Œå†æ—‹è½¬
      this.context.save()
      this.context.translate(0, this.context.height) // åŸç‚¹ç§»è‡³å·¦ä¸‹è§’
      this.context.rotate(angle) // é€†æ—¶é’ˆæ—‹è½¬25åº¦
    
      // è®¡ç®—è¡Œåˆ—é—´éš”ï¼ˆ1.5å€æ–‡æœ¬å°ºå¯¸é¿å…é‡å ï¼‰
      const colGap = textWidth * 1.5
      const rowGap = textHeight * 1.5
      const cols = Math.ceil(this.context.width / colGap)
      const rows = Math.ceil(this.context.height / rowGap)
    
      // ç»˜åˆ¶ç½‘æ ¼
      for (let i = 0; i < cols; i++) {
        for (let j = 0; j < rows; j++) {
          const x = i * colGap
          const y = j * rowGap
          this.context.fillText(text, x, -y) // yè½´åè½¬ï¼ˆå› ä¸ºåŸç‚¹åœ¨å·¦ä¸‹è§’ï¼‰
        }
      }
    
      this.context.restore() // æ¢å¤åŸå§‹åæ ‡ç³»
    }
    

### 4\. é¡µé¢é›†æˆï¼šç”¨ Stack å®ç°æ°´å°å±‚è¦†ç›–

å°†æ°´å°ç»„ä»¶ä¸ç¬”è®°å†…å®¹å±‚å åŠ ï¼Œæ¨èä½¿ç”¨ `Stack` å¸ƒå±€ï¼Œæ¸…æ™°ä¸”æ€§èƒ½ç¨³å®šï¼š

    // pages/NoteDetail.ets
    @Entry
    @Component
    struct NoteDetail {
      private noteContent = 'è¿™é‡Œæ˜¯ç”¨æˆ·çš„ç¬”è®°æ­£æ–‡...'
    
      build() {
        Stack() {
          // ç¬”è®°å†…å®¹å±‚
          Column()
            .padding(24)
            .spacing(16)
            .text(this.noteContent)
            .fontSize(16)
            .lineHeight(24)
    
          // æ°´å°å±‚ï¼ˆè¦†ç›–åœ¨å†…å®¹ä¸Šæ–¹ï¼‰
          UserWatermark()
        }
        .backgroundColor(Color.White)
        .width('100%')
        .height('100%')
      }
    }
    

ä¸‰ã€æ€§èƒ½ä¼˜åŒ–
------

1.  **ç¦»å±æ¸²æŸ“ä¼˜åŒ–**  
    å¦‚æœé‡åˆ°é¡µé¢å¡é¡¿ï¼Œå¯ä»¥å°è¯•å°† `Canvas` æ›¿æ¢ä¸º `OffscreenCanvas` è¿›è¡Œç¦»å±ç»˜åˆ¶ï¼Œå‡å°‘ä¸»çº¿ç¨‹å‹åŠ›ï¼š
    
        // ç¦»å±ç”»å¸ƒç‰ˆæœ¬ï¼ˆé€‚ç”¨äºå¤æ‚åœºæ™¯ï¼‰
        private offscreenCanvas = new OffscreenCanvas()
        private offscreenContext = this.offscreenCanvas.getContext('2d')!
        
        // åœ¨drawæ–¹æ³•ä¸­ä½¿ç”¨offscreenContextç»˜åˆ¶ï¼Œæœ€ååŒæ­¥åˆ°ä¸»ç”»å¸ƒ
        this.context.drawImage(this.offscreenCanvas, 0, 0)
        
    
2.  **æ–‡æœ¬æµ‹é‡ç¼“å­˜**  
    é‡å¤è®¡ç®—æ–‡æœ¬å®½åº¦ä¼šå½±å“æ€§èƒ½ï¼Œå› æ­¤å°† `measureText` çš„ç»“æœç¼“å­˜ï¼š
    
        private textMetrics: TextMetrics | null = null
        
        private getTextSize(text: string) {
          if (!this.textMetrics || this.textMetrics.text !== text) {
            this.textMetrics = this.context.measureText(text)
          }
          return this.textMetrics
        }
        
    
3.  **è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–**  
    é€šè¿‡ `hitTestBehavior: HitTestMode.Transparent` è®©æ°´å°å±‚å®Œå…¨é€æ˜ï¼Œè§¦æ‘¸äº‹ä»¶ç›´æ¥ç©¿é€åˆ°ä¸‹å±‚å†…å®¹ï¼Œä¸å½±å“ç”¨æˆ·æ“ä½œã€‚
    

å››ã€ä»é¡µé¢åˆ°å…¨åœºæ™¯çš„æ°´å°æ–¹æ¡ˆ
--------------

å¦‚æœä½ çš„åº”ç”¨éœ€è¦æ”¯æŒæ›´å¤šåœºæ™¯ï¼Œè¿˜å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ä¸­çš„å…¶ä»–èƒ½åŠ›ï¼š

*   **å›¾ç‰‡æ°´å°**ï¼šç”¨ `OffscreenCanvas` å®ç°æœ¬åœ°å›¾ç‰‡åŠ æ°´å°ï¼ˆé€‚åˆç”¨æˆ·ä¿å­˜ç¬”è®°æˆªå›¾æ—¶è‡ªåŠ¨åŠ æ°´å°ï¼‰
*   **PDF æ°´å°**ï¼šé€šè¿‡ `pdfService` æ¨¡å—ç»™å¯¼å‡ºçš„ PDF æ–‡æ¡£æ·»åŠ æ°´å°ï¼ˆä¼ä¸šéœ€æ±‚å¿…å¤‡ï¼‰
*   **åŠ¨æ€å˜è‰²**ï¼šæ ¹æ®é¡µé¢ä¸»é¢˜åˆ‡æ¢æ°´å°é¢œè‰²ï¼ˆæµ…è‰²/æ·±è‰²æ¨¡å¼é€‚é…ï¼‰

äº”ã€é‚£äº›è®©æˆ‘åŠå¤œç¡ä¸ç€çš„ç»†èŠ‚
--------------

1.  **æ—‹è½¬æ–¹å‘çš„å‘**  
    åæ ‡ç³»é»˜è®¤é¡ºæ—¶é’ˆæ—‹è½¬ï¼Œæƒ³å®ç°ã€Œå‘å·¦å€¾æ–œã€éœ€è¦ç”¨è´Ÿæ•°è§’åº¦ï¼ˆå¦‚ `-25åº¦`ï¼‰ï¼Œåˆšå¼€å§‹ç”¨æ­£æ•°å¯¼è‡´æ°´å°æ–¹å‘æåã€‚
    
2.  **è®¾å¤‡é€‚é…é—®é¢˜**  
    ä¸åŒè®¾å¤‡çš„ `vp` å•ä½æ¢ç®—æœ‰å·®å¼‚ï¼Œå»ºè®®ç»Ÿä¸€å¤„ç†å°ºå¯¸é—®é¢˜ã€‚
    
3.  **æ€§èƒ½ç›‘æ§**  
    ç”¨ DevEco Studio çš„ã€Œæ€§èƒ½è°ƒä¼˜ã€å·¥å…·ç›‘æ§ `onReady` å’Œ `draw` æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œç¡®ä¿å•æ¬¡ç»˜åˆ¶ä¸è¶…è¿‡ 16msï¼ˆ60fpsæ ‡å‡†ï¼‰ã€‚
    

å…­ã€æ€»ç»“ï¼šæ°´å°èƒŒåçš„å®‰å…¨å“²å­¦
--------------

åŠ æ°´å°æœ¬è´¨æ˜¯ä¸€ç§ã€Œå¨æ…‘æ€§é˜²æŠ¤ã€ï¼Œå®ƒä¸èƒ½å®Œå…¨é˜»æ­¢æˆªå›¾ï¼Œä½†èƒ½å¤§å¤§å¢åŠ å†…å®¹æ³„éœ²åçš„è¿½æº¯æˆæœ¬ã€‚åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ç»“åˆä»¥ä¸‹ç­–ç•¥ï¼š

*   **å‰ç«¯æ°´å°**ï¼šé˜²æ­¢éæˆæƒæˆªå›¾ä¼ æ’­
*   **åç«¯æ—¥å¿—**ï¼šè®°å½•ç”¨æˆ·æ“ä½œæ—¶é—´çº¿
*   **æ•°æ®åŠ å¯†**ï¼šæ•æ„Ÿå†…å®¹æœ¬åœ°åŠ å¯†å­˜å‚¨

æŠ€æœ¯ä¹‹å¤–ï¼Œæ›´é‡è¦çš„æ˜¯å¹³è¡¡ç”¨æˆ·ä½“éªŒä¸å®‰å…¨éœ€æ±‚â€”â€”æ¯•ç«Ÿï¼Œæ²¡æœ‰äººå–œæ¬¢è¢«å¯†å¯†éº»éº»çš„æ°´å°ã€ŒåŒ…å›´ã€ã€‚é€šè¿‡é€æ˜åº¦è°ƒæ•´ï¼ˆå»ºè®® `opacity: 0.15-0.2`ï¼‰å’Œåˆç†çš„æ’åˆ—é—´éš”ï¼Œå®Œå…¨å¯ä»¥åšåˆ°ã€Œæ°´å°å¯è§ä½†ä¸å¹²æ‰°é˜…è¯»ã€ã€‚

å¦‚æœä½ åœ¨å¼€å‘ä¸­é‡åˆ°å…¶ä»–æœ‰è¶£çš„åœºæ™¯ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºäº¤æµï½ ä¸€èµ·ç”¨æŠ€æœ¯è®©å†…å®¹å®‰å…¨æ›´ä¼˜é›…ä¸€ç‚¹ï½ ğŸ’»âœ¨

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[çº¯çˆ±æŒé—¨äºº](https://www.cnblogs.com/abinzhao/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/abinzhao/p/18910353](https://www.cnblogs.com/abinzhao/p/18910353)