---
layout: post
title: 'è¶…è¯¦ç»†ï¼OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹éƒ¨ç½²æ•™å­¦ï¼ˆé¿å‘å®Œæ•´ç‰ˆï¼‰'
date: "2026-01-27T00:49:27Z"
---
è¶…è¯¦ç»†ï¼OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹éƒ¨ç½²æ•™å­¦ï¼ˆé¿å‘å®Œæ•´ç‰ˆï¼‰
==============================

æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åœ¨Linuxç³»ç»Ÿä¸‹éƒ¨ç½²OFAè§†è§‰é—®ç­”(VQA)æ¨¡åž‹çš„å…¨è¿‡ç¨‹ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼šåˆ›å»ºPythonè™šæ‹ŸçŽ¯å¢ƒã€é…ç½®æ¸…åŽPyPIæºã€å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„æ ¸å¿ƒä¾èµ–(transformers 4.48.3ç­‰)ã€ç¦ç”¨ModelScopeè‡ªåŠ¨ä¾èµ–å®‰è£…ä»¥é¿å…ç‰ˆæœ¬å†²çªã€å‡†å¤‡æµ‹è¯•å›¾ç‰‡å’Œè¿è¡Œè„šæœ¬ã€‚æ–‡ç« ç‰¹åˆ«å¼ºè°ƒäº†ä¾èµ–ç‰ˆæœ¬åŒ¹é…çš„é‡è¦æ€§ï¼Œå¹¶æä¾›äº†ç»è¿‡éªŒè¯çš„ç‰ˆæœ¬ç»„åˆæ–¹æ¡ˆã€‚åŒæ—¶é’ˆå¯¹è¾“å…¥æ ¼å¼é€‚é…å’Œå›¾ç‰‡åŠ è½½æƒé™ç­‰å¸¸è§é—®é¢˜ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆï¼Œé™„å¸¦å¯ç›´æŽ¥è¿è¡Œçš„æµ‹è¯•è„šæœ¬ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹éƒ¨ç½²è¿™ä¸€å¤šæ¨¡æ€é¢„è®­ç»ƒæ¨¡åž‹ã€‚

å‰è¨€
==

å¤§å®¶å¥½ï½ž æœ€è¿‘å°è¯•éƒ¨ç½² OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹ï¼Œè¿‡ç¨‹ä¸­è¸©äº†æ— æ•°ä¸ªä¾èµ–ç‰ˆæœ¬ã€è¾“å…¥æ ¼å¼ã€æƒé™ç›¸å…³çš„å‘ï¼Œè€—æ—¶å¾ˆä¹…æ‰æˆåŠŸè¿è¡Œå¹¶è¾“å‡ºæ­£ç¡®ç»“æžœã€‚ä¸ºäº†é¿å…å¤§å®¶é‡å¤è¸©å‘ï¼Œä»Šå¤©æ•´ç†äº†ä¸€ä»½å®Œæ•´ã€å¯å¤çŽ°çš„éƒ¨ç½²æ•™å­¦ï¼Œä»ŽçŽ¯å¢ƒå‡†å¤‡åˆ°è„šæœ¬è¿è¡Œï¼Œæ¯ä¸€æ­¥éƒ½æ ‡æ¸…ç»†èŠ‚ï¼Œè¿žé‡åˆ°çš„å‘éƒ½é™„å¸¦ã€Œ**çŽ°è±¡+åŽŸå› +è§£å†³æ–¹æ¡ˆ**ã€ï¼Œæ–°æ‰‹ä¹Ÿèƒ½è½»æ¾ä¸Šæ‰‹ï¼

ä¸€ã€å‰è¨€ï¼šä»€ä¹ˆæ˜¯ OFA VQA æ¨¡åž‹ï¼Ÿ
====================

OFAï¼ˆOne For Allï¼‰æ˜¯å­—èŠ‚è·³åŠ¨æå‡ºçš„å¤šæ¨¡æ€é¢„è®­ç»ƒæ¨¡åž‹ï¼Œæ”¯æŒè§†è§‰é—®ç­”ã€å›¾åƒæè¿°ã€å›¾åƒç¼–è¾‘ç­‰å¤šç§ä»»åŠ¡ï¼Œå…¶ä¸­è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ˜¯æœ€å¸¸ç”¨çš„åŠŸèƒ½ä¹‹ä¸€â€”â€”è¾“å…¥ä¸€å¼ å›¾ç‰‡å’Œä¸€ä¸ªè‹±æ–‡é—®é¢˜ï¼ˆè¯¥æ¨¡åž‹ä»…æ”¯æŒè‹±æ–‡ï¼‰ï¼Œæ¨¡åž‹å°±èƒ½è¾“å‡ºå¯¹åº”çš„ç­”æ¡ˆï¼ˆæ¯”å¦‚è¾“å…¥â€œç“¶å­â€å›¾ç‰‡+é—®é¢˜â€œWhat is the main subject?â€ï¼Œè¾“å‡ºâ€œa water bottleâ€ï¼‰ã€‚

æœ¬æ¬¡éƒ¨ç½²ä½¿ç”¨ ModelScope å¹³å°çš„ `iic/ofa_visual-question-answering_pretrain_large_en` æ¨¡åž‹ï¼ŒåŸºäºŽ Python è™šæ‹ŸçŽ¯å¢ƒï¼ˆMinicondaï¼‰éƒ¨ç½²ï¼Œå…¨ç¨‹åœ¨ Linux çŽ¯å¢ƒä¸‹æ“ä½œï¼ˆWindows å¯å‚è€ƒï¼Œå‘½ä»¤ç•¥æœ‰å·®å¼‚ï¼‰ã€‚

äºŒã€å‰ç½®å‡†å¤‡
======

1\. çŽ¯å¢ƒåŸºç¡€
--------

*   ç³»ç»Ÿï¼šLinuxï¼ˆUbuntu/CentOS å‡å¯ï¼Œæœ¬æ¬¡ç”¨ Ubuntuï¼‰
    
*   å·¥å…·ï¼šMinicondaï¼ˆç”¨äºŽåˆ›å»ºç‹¬ç«‹è™šæ‹ŸçŽ¯å¢ƒï¼Œé¿å…çŽ¯å¢ƒæ±¡æŸ“ï¼‰
    
*   Python ç‰ˆæœ¬ï¼š3.11ï¼ˆäº²æµ‹å…¼å®¹ï¼Œ3.9-3.11 å‡å¯ï¼Œä¸å»ºè®® 3.12+ï¼Œéƒ¨åˆ†ä¾èµ–ä¸æ”¯æŒï¼‰
    
*   ç½‘ç»œï¼šèƒ½è®¿é—® ModelScopeã€PyPI æºï¼ˆå»ºè®®æ¢æ¸…åŽæºï¼Œæé€Ÿï¼‰
    

2\. æå‰è¯´æ˜Ž
--------

æœ¬æ¬¡éƒ¨ç½²çš„æ ¸å¿ƒéš¾ç‚¹çš„æ˜¯ã€Œä¾èµ–ç‰ˆæœ¬åŒ¹é…ã€â€”â€”ModelScope å¹³å°çš„ OFA æ¨¡åž‹ä¼šç¡¬ç¼–ç ä¾èµ–ç‰ˆæœ¬ï¼Œè¿è¡Œæ—¶ä¼šè‡ªåŠ¨å¸è½½ä½ å®‰è£…çš„ç‰ˆæœ¬å¹¶å¼ºåˆ¶å®‰è£…æŒ‡å®šç‰ˆæœ¬ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ç‰ˆæœ¬å†²çªï¼›å…¶æ¬¡æ˜¯ã€Œè¾“å…¥æ ¼å¼é€‚é…ã€å’Œã€Œå›¾ç‰‡åŠ è½½æƒé™ã€é—®é¢˜ï¼Œè¿™ä¸¤ä¸ªå‘ä¹Ÿå¾ˆå®¹æ˜“å¡å£³ï¼ŒåŽé¢ä¼šè¯¦ç»†è¯´æ˜Žã€‚

ä¸‰ã€å®Œæ•´éƒ¨ç½²æ­¥éª¤ï¼ˆä¸€æ­¥éƒ½ä¸èƒ½å°‘ï¼‰
================

æ­¥éª¤ 1ï¼šåˆ›å»ºå¹¶æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒï¼ˆå…³é”®ï¼é¿å…çŽ¯å¢ƒæ±¡æŸ“ï¼‰
-------------------------

ä¸ºä»€ä¹ˆè¦åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒï¼Ÿå› ä¸ºä¸åŒæ¨¡åž‹çš„ä¾èµ–ç‰ˆæœ¬å·®å¼‚å¾ˆå¤§ï¼Œæ¯”å¦‚æœ¬æ¬¡ OFA æ¨¡åž‹å¯¹ transformersã€tokenizers çš„ç‰ˆæœ¬è¦æ±‚å¾ˆä¸¥æ ¼ï¼Œå’Œå…¶ä»–æ¨¡åž‹å¯èƒ½å†²çªï¼Œç‹¬ç«‹è™šæ‹ŸçŽ¯å¢ƒèƒ½éš”ç¦»è¿™äº›å·®å¼‚ã€‚

æ‰“å¼€ç»ˆç«¯ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆå…¨ç¨‹å¤åˆ¶å³å¯ï¼‰ï¼š

    
    # 1. æ¿€æ´» Minicondaï¼ˆå¦‚æžœæ²¡é…ç½®çŽ¯å¢ƒå˜é‡ï¼Œå…ˆæ‰§è¡Œè¿™ä¸ªï¼Œå…·ä½“è·¯å¾„æ ¹æ®è‡ªå·±çš„ Miniconda å®‰è£…ä½ç½®ä¿®æ”¹ï¼‰
    source /opt/miniconda3/bin/activate
    
    # 2. åˆ›å»ºè™šæ‹ŸçŽ¯å¢ƒï¼ˆçŽ¯å¢ƒåï¼štorch27ï¼ŒPython ç‰ˆæœ¬ 3.11ï¼Œå¯è‡ªå®šä¹‰çŽ¯å¢ƒåï¼‰
    conda create -n torch27 python=3.11 -y
    
    # 3. æ¿€æ´»åˆ›å»ºå¥½çš„è™šæ‹ŸçŽ¯å¢ƒï¼ˆåŽç»­æ‰€æœ‰æ“ä½œéƒ½è¦åœ¨è¿™ä¸ªçŽ¯å¢ƒé‡Œæ‰§è¡Œï¼‰
    conda activate torch27
    

æ‰§è¡ŒæˆåŠŸåŽï¼Œç»ˆç«¯å‰ç¼€ä¼šæ˜¾ç¤º `(torch27)`ï¼Œè¯´æ˜Žå·²ç»è¿›å…¥è™šæ‹ŸçŽ¯å¢ƒã€‚

æ­¥éª¤ 2ï¼šé…ç½®æ¸…åŽ PyPI æºï¼ˆæé€Ÿï¼Œé¿å…ä¸‹è½½ä¾èµ–è¶…æ—¶ï¼‰
-----------------------------

é»˜è®¤ PyPI æºåœ¨å›½å¤–ï¼Œä¸‹è½½ä¾èµ–å¾ˆæ…¢ï¼Œç”šè‡³ä¼šè¶…æ—¶ï¼Œå»ºè®®é…ç½®æ¸…åŽæºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    
    pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
    

é…ç½®æˆåŠŸåŽï¼ŒåŽç»­ç”¨ pip å®‰è£…ä¾èµ–ä¼šè‡ªåŠ¨èµ°æ¸…åŽæºï¼Œé€Ÿåº¦ç¿»å€ã€‚

æ­¥éª¤ 3ï¼šåˆ›å»ºå·¥ä½œç›®å½•ï¼Œä¸‹è½½æ¨¡åž‹ç›¸å…³æ–‡ä»¶
--------------------

åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å·¥ä½œç›®å½•ï¼Œç”¨äºŽå­˜æ”¾è„šæœ¬ã€å›¾ç‰‡ç­‰æ–‡ä»¶ï¼Œé¿å…æ–‡ä»¶æ··ä¹±ï¼š

    
    # 1. åˆ›å»ºå·¥ä½œç›®å½•ï¼ˆè·¯å¾„å¯è‡ªå®šä¹‰ï¼Œæœ¬æ¬¡ç”¨ /root/workspace/ofa_visual-question-answeringï¼‰
    mkdir -p /root/workspace/ofa_visual-question-answering
    
    # 2. è¿›å…¥å·¥ä½œç›®å½•ï¼ˆåŽç»­æ‰€æœ‰æ“ä½œéƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼‰
    cd /root/workspace/ofa_visual-question-answering
    

æ­¥éª¤ 4ï¼šå®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆé‡ç‚¹ï¼ç‰ˆæœ¬å¿…é¡»å®Œå…¨åŒ¹é…ï¼‰
------------------------

è¿™æ˜¯éƒ¨ç½²è¿‡ç¨‹ä¸­æœ€å®¹æ˜“è¸©å‘çš„ä¸€æ­¥ï¼OFA æ¨¡åž‹å¯¹ä¾èµ–ç‰ˆæœ¬è¦æ±‚æžé«˜ï¼Œå°¤å…¶æ˜¯ transformersã€tokenizersã€huggingface-hub è¿™ä¸‰ä¸ªåº“ï¼Œç‰ˆæœ¬ä¸åŒ¹é…ä¼šç›´æŽ¥å¯¼è‡´æ¨¡åž‹æ— æ³•åˆå§‹åŒ–ï¼Œç”šè‡³æŠ¥é”™ã€‚

å…ˆç»™å¤§å®¶ä¸Šã€Œæœ€ç»ˆå¯ç”¨çš„ä¾èµ–ç‰ˆæœ¬ç»„åˆã€ï¼ˆäº²æµ‹å¯å¤çŽ°ï¼Œé¿å…è¸©å‘ï¼‰ï¼š

*   tensorboardX==2.6.4ï¼ˆæ¨¡åž‹æ—¥å¿—ç›¸å…³ï¼Œç‰ˆæœ¬å¯å…¼å®¹ï¼‰
    
*   huggingface-hub==0.25.2ï¼ˆModelScope ç¡¬ç¼–ç è¦æ±‚ï¼Œä¸èƒ½é«˜ä¹Ÿä¸èƒ½ä½Žï¼‰
    
*   transformers==4.48.3ï¼ˆModelScope ç¡¬ç¼–ç è¦æ±‚ï¼Œå¯¹åº” tokenizers 0.21.4ï¼‰
    
*   tokenizers==0.21.4ï¼ˆå¿…é¡»å’Œ transformers 4.48.3 åŒ¹é…ï¼Œå¦åˆ™æŠ¥é”™ï¼‰
    
*   modelscopeï¼ˆæ¨¡åž‹åŠ è½½å¹³å°ï¼Œç›´æŽ¥å®‰è£…æœ€æ–°ç‰ˆå³å¯ï¼‰
    
*   Pillowã€requestsï¼ˆå›¾ç‰‡åŠ è½½ç›¸å…³ï¼Œå¿…å¤‡ï¼‰
    

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸€æ¬¡æ€§å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆé¡ºåºä¸è¦ä¹±ï¼Œé¿å…ç‰ˆæœ¬å†²çªï¼‰ï¼š

    
    # 1. å…ˆå®‰è£… tensorboardXï¼ˆæ— ç‰ˆæœ¬å†²çªï¼Œæ”¾å¿ƒè£…ï¼‰
    pip install tensorboardX==2.6.4
    
    # 2. å®‰è£… ModelScope ç¡¬ç¼–ç è¦æ±‚çš„æ ¸å¿ƒä¾èµ–ï¼ˆé‡ç‚¹ï¼ç‰ˆæœ¬ä¸èƒ½æ”¹ï¼‰
    pip install huggingface-hub==0.25.2 tokenizers==0.21.4 transformers==4.48.3
    
    # 3. å®‰è£… modelscopeï¼ˆæœ€æ–°ç‰ˆå³å¯ï¼Œè´Ÿè´£åŠ è½½ OFA æ¨¡åž‹ï¼‰
    pip install modelscope
    
    # 4. å®‰è£…å›¾ç‰‡åŠ è½½ç›¸å…³ä¾èµ–ï¼ˆPillow å¤„ç†æœ¬åœ°å›¾ç‰‡ï¼Œrequests å¤„ç†åœ¨çº¿å›¾ç‰‡ï¼‰
    pip install Pillow requests
    

å®‰è£…è¿‡ç¨‹ä¸­å¦‚æžœå‡ºçŽ°ã€ŒWARNING: Running pip as the 'root' userã€è­¦å‘Šï¼Œå¯å¿½ç•¥ï¼Œä¸å½±å“åŠŸèƒ½ï¼ˆè¿™æ˜¯æç¤ºç”¨ root ç”¨æˆ·è¿è¡Œ pip å¯èƒ½æœ‰æƒé™é—®é¢˜ï¼Œä½†ä¸å½±å“æ¨¡åž‹éƒ¨ç½²ï¼‰ã€‚

å®‰è£…å®ŒæˆåŽï¼ŒéªŒè¯ä¸€ä¸‹ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®ï¼ˆé¿å…å®‰è£…å‡ºé”™ï¼‰ï¼š

    
    python -c "import transformers, tokenizers, huggingface_hub; print(f'transformers: {transformers.__version__}'); print(f'tokenizers: {tokenizers.__version__}'); print(f'huggingface-hub: {huggingface_hub.__version__}')"
    

æ­£å¸¸è¾“å‡ºå¦‚ä¸‹ï¼ˆç‰ˆæœ¬å¿…é¡»å®Œå…¨ä¸€è‡´ï¼‰ï¼š

    
    transformers: 4.48.3
    tokenizers: 0.21.4
    huggingface-hub: 0.25.2
    

å¦‚æžœè¾“å‡ºçš„ç‰ˆæœ¬ä¸ä¸€è‡´ï¼Œé‡æ–°æ‰§è¡Œæ­¥éª¤ 4 çš„å®‰è£…å‘½ä»¤ï¼Œç¡®ä¿ç‰ˆæœ¬æ­£ç¡®ã€‚

æ­¥éª¤ 5ï¼šç¦ç”¨ ModelScope è‡ªåŠ¨ä¾èµ–å®‰è£…ï¼ˆæ ¸å¿ƒé¿å‘æ“ä½œï¼‰
---------------------------------

è¿™æ˜¯æœ€å…³é”®çš„é¿å‘æ­¥éª¤ï¼ModelScope åŠ è½½ OFA æ¨¡åž‹æ—¶ï¼Œä¼šè‡ªåŠ¨æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ï¼Œå¦‚æžœå‘çŽ°ç‰ˆæœ¬å’Œå®ƒç¡¬ç¼–ç çš„è¦æ±‚ä¸ä¸€è‡´ï¼Œä¼šç›´æŽ¥å¸è½½ä½ çš„ç‰ˆæœ¬å¹¶å¼ºåˆ¶å®‰è£…æŒ‡å®šç‰ˆæœ¬â€”â€”å“ªæ€•ä½ å·²ç»å®‰è£…äº†æ­£ç¡®çš„ç‰ˆæœ¬ï¼Œä¹Ÿä¼šè¢«è¦†ç›–ï¼Œå¯¼è‡´ä¹‹å‰çš„åŠªåŠ›ç™½è´¹ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œç¦ç”¨ ModelScope è‡ªåŠ¨å®‰è£…/å‡çº§ä¾èµ–ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

    
    # ç¦ç”¨ ModelScope è‡ªåŠ¨å®‰è£…ä¾èµ–ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼Œä»…å½“å‰ç»ˆç«¯ä¼šè¯ï¼‰
    export MODELSCOPE_AUTO_INSTALL_DEPENDENCY='False'
    export PIP_NO_INSTALL_UPGRADE=1
    export PIP_NO_DEPENDENCIES=1
    

âš ï¸ æ³¨æ„ï¼šå¦‚æžœåŽç»­æ–°å¼€ç»ˆç«¯ã€é‡æ–°æ¿€æ´»è™šæ‹ŸçŽ¯å¢ƒï¼Œéœ€è¦é‡æ–°æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ï¼ˆä¸´æ—¶ç”Ÿæ•ˆï¼‰ï¼›å¦‚æžœæƒ³æ°¸ä¹…ç”Ÿæ•ˆï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ˆå†™å…¥ bash é…ç½®æ–‡ä»¶ï¼‰ï¼š

    
    # æ°¸ä¹…ç¦ç”¨è‡ªåŠ¨ä¾èµ–å®‰è£…ï¼ˆé‡å¯ç»ˆç«¯ã€é‡æ–°æ¿€æ´»çŽ¯å¢ƒä¹Ÿç”Ÿæ•ˆï¼‰
    echo "export MODELSCOPE_AUTO_INSTALL_DEPENDENCY='False'" >> ~/.bashrc
    echo "export PIP_NO_INSTALL_UPGRADE=1" >> ~/.bashrc
    echo "export PIP_NO_DEPENDENCIES=1" >> ~/.bashrc
    
    # ä½¿é…ç½®ç”Ÿæ•ˆ
    source ~/.bashrc
    

æ­¥éª¤ 6ï¼šå‡†å¤‡æµ‹è¯•å›¾ç‰‡å’Œè¿è¡Œè„šæœ¬ï¼ˆç›´è§‚ç‰ˆï¼Œæ–°æ‰‹å‹å¥½ï¼‰
--------------------------

è„šæœ¬æ˜¯æ ¸å¿ƒï¼Œä¹‹å‰è¸©è¿‡ã€Œè¾“å…¥æ ¼å¼é”™è¯¯ã€çš„å‘ï¼Œæ‰€ä»¥è¿™é‡Œç›´æŽ¥ç»™å¤§å®¶æ•´ç†å¥½ã€Œå¯ç›´æŽ¥è¿è¡Œã€è¾“å‡ºç®€æ´ã€å®¹é”™æ€§å¼ºã€çš„è„šæœ¬ï¼Œåªéœ€ä¿®æ”¹å›¾ç‰‡è·¯å¾„å’Œé—®é¢˜å³å¯ã€‚

### 6.1 å‡†å¤‡æµ‹è¯•å›¾ç‰‡

å°†ä»»æ„ä¸€å¼ æµ‹è¯•å›¾ç‰‡ï¼ˆjpg/png æ ¼å¼å‡å¯ï¼‰æ”¾åˆ°å·¥ä½œç›®å½•ä¸‹ï¼Œå‘½åä¸º `test_image.jpg`ï¼ˆæ¯”å¦‚ä¸€å¼ ç“¶å­ã€çŒ«ã€é£Žæ™¯çš„å›¾ç‰‡ï¼‰ï¼›å¦‚æžœæ²¡æœ‰æœ¬åœ°å›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨çº¿å…¬å¼€å›¾ç‰‡ URLï¼ˆè„šæœ¬å·²å…¼å®¹ï¼‰ã€‚

### 6.2 åˆ›å»ºè¿è¡Œè„šæœ¬ï¼ˆtest.pyï¼‰

åœ¨å·¥ä½œç›®å½•ä¸‹åˆ›å»º `test.py` è„šæœ¬ï¼Œå¤åˆ¶ä»¥ä¸‹ä»£ç ï¼ˆæ³¨é‡Šæ¸…æ™°ï¼Œå¯ç›´æŽ¥ä¿®æ”¹ï¼‰ï¼š

    
    #!/usr/bin/env python3
    # -*- coding: utf-8 -*-
    """
    OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹ è¿è¡Œè„šæœ¬ï¼ˆç›´è§‚ç‰ˆï¼Œæ–°æ‰‹å‹å¥½ï¼‰
    åŠŸèƒ½ï¼šè¾“å…¥æœ¬åœ°å›¾ç‰‡/åœ¨çº¿å›¾ç‰‡ + è‹±æ–‡é—®é¢˜ï¼Œè¾“å‡ºæ¨¡åž‹æŽ¨ç†ç»“æžœ
    ä½¿ç”¨è¯´æ˜Žï¼šåªéœ€ä¿®æ”¹ã€æ ¸å¿ƒé…ç½®åŒºã€‘çš„å›¾ç‰‡è·¯å¾„å’Œé—®é¢˜ï¼Œæ— éœ€ä¿®æ”¹å…¶ä»–ä»£ç 
    """
    import os
    import sys
    from PIL import Image
    import requests
    from io import BytesIO
    from modelscope.pipelines import pipeline
    from modelscope.utils.constant import Tasks
    
    # ======================== æ ¸å¿ƒé…ç½®åŒºï¼ˆåªéœ€æ”¹è¿™é‡Œï¼Œæ–°æ‰‹é‡ç‚¹å…³æ³¨ï¼‰========================
    # 1. å›¾ç‰‡æ¥æºï¼šäºŒé€‰ä¸€ï¼ˆæœ¬åœ°è·¯å¾„ä¼˜å…ˆçº§æ›´é«˜ï¼ŒæŽ¨èç”¨æœ¬åœ°å›¾ç‰‡ï¼‰
    LOCAL_IMAGE_PATH = "./test_image.jpg"  # æœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼ˆå·¥ä½œç›®å½•ä¸‹çš„å›¾ç‰‡ï¼Œå¦‚ï¼š./cat.jpgã€./bottle.pngï¼‰
    # ONLINE_IMAGE_URL = "https://picsum.photos/600/400"  # å¤‡ç”¨ï¼šå…¬å¼€æµ‹è¯•å›¾ç‰‡URLï¼ˆæ— éœ€ä¸‹è½½ï¼Œç›´æŽ¥åŠ è½½ï¼‰
    
    # 2. é—®ç­”é—®é¢˜ï¼ˆâš ï¸ æ³¨æ„ï¼šè¯¥æ¨¡åž‹ä»…æ”¯æŒè‹±æ–‡æé—®ï¼Œä¸­æ–‡é—®é¢˜ä¼šè¾“å‡ºæ— æ„ä¹‰ç»“æžœï¼‰
    VQA_QUESTION = "What is the main subject in the picture?"  # ç¤ºä¾‹1ï¼šå›¾ç‰‡çš„ä¸»è¦ç‰©ä½“æ˜¯ä»€ä¹ˆï¼Ÿ
    # VQA_QUESTION = "What color is the object?"  # ç¤ºä¾‹2ï¼šç‰©ä½“æ˜¯ä»€ä¹ˆé¢œè‰²ï¼Ÿ
    # VQA_QUESTION = "How many objects are there in the picture?"  # ç¤ºä¾‹3ï¼šå›¾ç‰‡ä¸­æœ‰å¤šå°‘ä¸ªç‰©ä½“ï¼Ÿ
    
    # ======================== å·¥å…·å‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œå°è£…å¥½çš„åŠŸèƒ½ï¼‰========================
    def check_image_exists(path):
        """æ£€æŸ¥æœ¬åœ°å›¾ç‰‡æ˜¯å¦å­˜åœ¨ï¼Œé¿å…è·¯å¾„é”™è¯¯å¯¼è‡´åŠ è½½å¤±è´¥"""
        if not os.path.exists(path):
            print(f"âŒ é”™è¯¯ï¼šæœ¬åœ°å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨ â†’ {path}")
            print("è¯·æ£€æŸ¥å›¾ç‰‡è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ›¿æ¢ä¸ºæœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼")
            sys.exit(1)
    
    def load_image(image_source):
        """åŠ è½½å›¾ç‰‡ï¼ˆå…¼å®¹æœ¬åœ°è·¯å¾„å’Œåœ¨çº¿URLï¼‰ï¼Œè¿”å›žPIL.Imageå¯¹è±¡ï¼ˆæ¨¡åž‹è¦æ±‚çš„è¾“å…¥æ ¼å¼ï¼‰"""
        try:
            # ä¼˜å…ˆåŠ è½½æœ¬åœ°å›¾ç‰‡
            if os.path.exists(image_source):
                check_image_exists(image_source)
                img = Image.open(image_source).convert('RGB')  # è½¬ä¸ºRGBæ ¼å¼ï¼Œé¿å…ç°åº¦å›¾æŠ¥é”™
                print(f"âœ… æˆåŠŸåŠ è½½æœ¬åœ°å›¾ç‰‡ â†’ {image_source}")
            # åŠ è½½åœ¨çº¿å›¾ç‰‡ï¼ˆå¤‡ç”¨ï¼Œé¿å…æœ¬åœ°å›¾ç‰‡ç¼ºå¤±ï¼‰
            elif image_source.startswith(('http://', 'https://')):
                response = requests.get(image_source, timeout=10)  # è¶…æ—¶æ—¶é—´10ç§’
                response.raise_for_status()  # æ£€æŸ¥URLæ˜¯å¦å¯è®¿é—®ï¼ˆé¿å…403/404é”™è¯¯ï¼‰
                img = Image.open(BytesIO(response.content)).convert('RGB')
                print(f"âœ… æˆåŠŸåŠ è½½åœ¨çº¿å›¾ç‰‡ â†’ {image_source}")
            else:
                raise ValueError("âŒ å›¾ç‰‡æ¥æºé”™è¯¯ï¼šå¿…é¡»æ˜¯æœ¬åœ°è·¯å¾„æˆ–åˆæ³•çš„HTTP/HTTPS URLï¼")
            return img
        except Exception as e:
            print(f"âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼š{str(e)}")
            sys.exit(1)
    
    def init_vqa_model():
        """åˆå§‹åŒ–OFA VQAæ¨¡åž‹ç®¡é“ï¼Œæ ¸å¿ƒå‡½æ•°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰"""
        try:
            # å†æ¬¡ç¡®è®¤ç¦ç”¨è‡ªåŠ¨ä¾èµ–å®‰è£…ï¼ˆåŒé‡ä¿é™©ï¼Œé¿å…çŽ¯å¢ƒå˜é‡å¤±æ•ˆï¼‰
            os.environ['MODELSCOPE_AUTO_INSTALL_DEPENDENCY'] = 'False'
            os.environ['PIP_NO_INSTALL_UPGRADE'] = '1'
            
            # åˆ›å»ºVQAæ¨¡åž‹ç®¡é“ï¼ˆâš ï¸ trust_remote_code=Trueå¿…é¡»åŠ ï¼Œé€‚é…OFAæ¨¡åž‹çš„è‡ªå®šä¹‰é€»è¾‘ï¼‰
            vqa_pipe = pipeline(
                task=Tasks.visual_question_answering,  # ä»»åŠ¡ç±»åž‹ï¼šè§†è§‰é—®ç­”
                model='iic/ofa_visual-question-answering_pretrain_large_en',  # æ¨¡åž‹åç§°
                model_revision='v1.0.0',  # æ¨¡åž‹ç‰ˆæœ¬ï¼ˆå›ºå®šv1.0.0ï¼Œé¿å…ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼‰
                trust_remote_code=True  # å…³é”®å‚æ•°ï¼šå…è®¸åŠ è½½æ¨¡åž‹çš„è‡ªå®šä¹‰ä»£ç 
            )
            print("âœ… OFA VQAæ¨¡åž‹åˆå§‹åŒ–æˆåŠŸï¼ï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡åž‹ï¼Œè€—æ—¶ç¨é•¿ï¼Œè€å¿ƒç­‰å¾…ï¼‰")
            return vqa_pipe
        except Exception as e:
            print(f"âŒ æ¨¡åž‹åˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}")
            sys.exit(1)
    
    # ======================== ä¸»é€»è¾‘ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œæ‰§è¡ŒæŽ¨ç†ï¼‰========================
    if __name__ == "__main__":
        # æ‰“å°æ ‡é¢˜ï¼Œç›´è§‚åŒºåˆ†è¾“å‡º
        print("="*60)
        print("ðŸ“¸ OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹ - è¿è¡Œå·¥å…·")
        print("="*60)
        
        # 1. åˆå§‹åŒ–OFA VQAæ¨¡åž‹ï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡åž‹ï¼Œçº¦å‡ ç™¾MBï¼Œè€å¿ƒç­‰å¾…ï¼‰
        vqa_model = init_vqa_model()
        
        # 2. ç¡®å®šå›¾ç‰‡æ¥æºï¼ˆä¼˜å…ˆæœ¬åœ°ï¼Œæœ¬åœ°ä¸å­˜åœ¨åˆ™ç”¨åœ¨çº¿URLï¼‰
        image_source = LOCAL_IMAGE_PATH if os.path.exists(LOCAL_IMAGE_PATH) else globals().get("ONLINE_IMAGE_URL", "")
        if not image_source:
            print("âŒ é”™è¯¯ï¼šæœªé…ç½®æœ‰æ•ˆçš„å›¾ç‰‡æ¥æºï¼è¯·ä¿®æ”¹ã€æ ¸å¿ƒé…ç½®åŒºã€‘çš„å›¾ç‰‡è·¯å¾„/URL")
            sys.exit(1)
        
        # 3. åŠ è½½å›¾ç‰‡ï¼ˆè½¬ä¸ºæ¨¡åž‹è¦æ±‚çš„PIL.Imageå¯¹è±¡ï¼‰
        img = load_image(image_source)
        
        # 4. æ‰§è¡Œæ¨¡åž‹æŽ¨ç†ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        print(f"\nðŸ¤” æé—®ï¼š{VQA_QUESTION}")
        print("ðŸ” æ¨¡åž‹æŽ¨ç†ä¸­...ï¼ˆæŽ¨ç†é€Ÿåº¦å–å†³äºŽç”µè„‘é…ç½®ï¼Œçº¦1-5ç§’ï¼‰")
        try:
            # æ¨¡åž‹è¾“å…¥æ ¼å¼ï¼š(PIL.Imageå¯¹è±¡, è‹±æ–‡é—®é¢˜æ–‡æœ¬) â†’ å…ƒç»„æ ¼å¼ï¼ˆé‡ç‚¹ï¼ä¸èƒ½ç”¨å­—å…¸ï¼‰
            result = vqa_model((img, VQA_QUESTION))
            
            # ç®€åŒ–è¾“å‡ºï¼ˆåªæå–æ ¸å¿ƒç­”æ¡ˆï¼ŒåŽ»æŽ‰å†—ä½™ä¿¡æ¯ï¼Œæ–°æ‰‹æ›´ç›´è§‚ï¼‰
            answer = result.get("text", ["No answer found"])[0]  # æå–æœ€ç½®ä¿¡çš„ç¬¬ä¸€ä¸ªç­”æ¡ˆ
            print("\n" + "="*60)
            print(f"âœ… æŽ¨ç†æˆåŠŸï¼")
            print(f"ðŸ“· å›¾ç‰‡ï¼š{image_source}")
            print(f"ðŸ¤” é—®é¢˜ï¼š{VQA_QUESTION}")
            print(f"âœ… ç­”æ¡ˆï¼š{answer}")
            print("="*60)
            
        except Exception as e:
            print(f"\nâŒ æŽ¨ç†å¤±è´¥ï¼š{type(e).__name__} - {str(e)}")
            sys.exit(1)
    

æ­¥éª¤ 7ï¼šè¿è¡Œè„šæœ¬ï¼ŒæŸ¥çœ‹æŽ¨ç†ç»“æžœ
----------------

æ‰€æœ‰å‡†å¤‡å·¥ä½œå®ŒæˆåŽï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œè„šæœ¬ï¼š

    
    python test.py
    

âš ï¸ æ³¨æ„ï¼šé¦–æ¬¡è¿è¡Œè„šæœ¬æ—¶ï¼Œæ¨¡åž‹ä¼šè‡ªåŠ¨ä»Ž ModelScope ä¸‹è½½ï¼ˆçº¦å‡ ç™¾MBï¼‰ï¼Œè€—æ—¶ç¨é•¿ï¼Œè€å¿ƒç­‰å¾…å³å¯ï¼›åŽç»­è¿è¡Œä¼šå¤ç”¨å·²ä¸‹è½½çš„æ¨¡åž‹ï¼Œé€Ÿåº¦ä¼šå¾ˆå¿«ã€‚

è¿è¡ŒæˆåŠŸåŽï¼Œè¾“å‡ºå¦‚ä¸‹ï¼ˆç›´è§‚ç®€æ´ï¼Œæ–°æ‰‹èƒ½å¿«é€Ÿçœ‹åˆ°ç»“æžœï¼‰ï¼š

    
    ============================================================
    ðŸ“¸ OFA è§†è§‰é—®ç­”ï¼ˆVQAï¼‰æ¨¡åž‹ - è¿è¡Œå·¥å…·
    ============================================================
    âœ… OFA VQAæ¨¡åž‹åˆå§‹åŒ–æˆåŠŸï¼ï¼ˆé¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡åž‹ï¼Œè€—æ—¶ç¨é•¿ï¼Œè€å¿ƒç­‰å¾…ï¼‰
    âœ… æˆåŠŸåŠ è½½æœ¬åœ°å›¾ç‰‡ â†’ ./test_image.jpg
    
    ðŸ¤” æé—®ï¼šWhat is the main subject in the picture?
    ðŸ” æ¨¡åž‹æŽ¨ç†ä¸­...ï¼ˆæŽ¨ç†é€Ÿåº¦å–å†³äºŽç”µè„‘é…ç½®ï¼Œçº¦1-5ç§’ï¼‰
    
    ============================================================
    âœ… æŽ¨ç†æˆåŠŸï¼
    ðŸ“· å›¾ç‰‡ï¼š./test_image.jpg
    ðŸ¤” é—®é¢˜ï¼šWhat is the main subject in the picture?
    âœ… ç­”æ¡ˆï¼ša water bottle
    ============================================================
    

åˆ°è¿™é‡Œï¼ŒOFA è§†è§‰é—®ç­”æ¨¡åž‹å°±éƒ¨ç½²æˆåŠŸå¹¶è¿è¡Œå•¦ï¼

å››ã€éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°çš„æ‰€æœ‰å‘ï¼ˆçŽ°è±¡+åŽŸå› +è§£å†³æ–¹æ¡ˆï¼‰
=========================

è¿™éƒ¨åˆ†æ˜¯é‡ç‚¹ï¼æˆ‘æŠŠéƒ¨ç½²è¿‡ç¨‹ä¸­è¸©è¿‡çš„æ‰€æœ‰å‘éƒ½æ•´ç†å‡ºæ¥ï¼Œæ¯ä¸ªå‘éƒ½å¯¹åº”ã€ŒçŽ°è±¡+åŽŸå› +è§£å†³æ–¹æ¡ˆã€ï¼Œå¤§å®¶é‡åˆ°ç›¸åŒé—®é¢˜æ—¶ï¼Œç›´æŽ¥å¯¹ç…§è§£å†³å³å¯ï¼ŒèŠ‚çœæ—¶é—´ã€‚

å‘1ï¼šä¾èµ–ç‰ˆæœ¬å†²çªï¼ˆæœ€å¸¸è§ï¼Œè¸©äº†3æ¬¡ï¼‰
-------------------

### çŽ°è±¡1ï¼šImportError: tokenizers>=0.20,<0.21 is required...

    
    ImportError: tokenizers>=0.20,<0.21 is required for a normal functioning of this module, but found tokenizers==0.19.1.
    

åŽŸå› ï¼štransformers ç‰ˆæœ¬å’Œ tokenizers ç‰ˆæœ¬ä¸åŒ¹é…ï¼ˆæ¯”å¦‚ transformers 4.46.1 è¦æ±‚ tokenizers 0.20.xï¼Œè€Œå®‰è£…äº† 0.19.1ï¼‰ã€‚

è§£å†³æ–¹æ¡ˆï¼šå¸è½½å½“å‰ tokenizersï¼Œå®‰è£…å¯¹åº”ç‰ˆæœ¬ï¼ˆæ¯”å¦‚ transformers 4.46.1 â†’ tokenizers 0.20.1ï¼›transformers 4.48.3 â†’ tokenizers 0.21.4ï¼‰ï¼Œå‘½ä»¤ï¼š

    
    pip uninstall -y tokenizers
    pip install tokenizers==0.21.4  # å¯¹åº”transformers 4.48.3
    

### çŽ°è±¡2ï¼šImportError: cannot import name 'GGUF\_CONFIG\_MAPPING' from 'transformers.integrations'

    
    ImportError: OfaForAllTasks: cannot import name 'GGUF_CONFIG_MAPPING' from 'transformers.integrations'
    

åŽŸå› ï¼štransformers ç‰ˆæœ¬è¿‡ä½Žï¼ˆæ¯”å¦‚ 4.38.2ï¼‰ï¼Œè¯¥ç‰ˆæœ¬çš„ integrations æ¨¡å—ä¸­æ²¡æœ‰å¯¼å‡º GGUF\_CONFIG\_MAPPINGï¼Œè€Œæ¨¡åž‹ä»£ç å¼•ç”¨äº†è¿™ä¸ªå˜é‡ã€‚

è§£å†³æ–¹æ¡ˆï¼šå®‰è£… transformers 4.48.3ï¼ˆModelScope ç¡¬ç¼–ç è¦æ±‚ï¼Œå…¼å®¹ GGUF\_CONFIG\_MAPPINGï¼‰ï¼Œå‘½ä»¤ï¼š

    
    pip uninstall -y transformers
    pip install transformers==4.48.3
    

### çŽ°è±¡3ï¼šè¿è¡Œè„šæœ¬æ—¶ï¼Œä¾èµ–è¢«è‡ªåŠ¨å¸è½½å¹¶é‡æ–°å®‰è£…

åŽŸå› ï¼šæ²¡æœ‰ç¦ç”¨ ModelScope è‡ªåŠ¨ä¾èµ–å®‰è£…ï¼ŒModelScope æ£€æµ‹åˆ°ä¾èµ–ç‰ˆæœ¬å’Œå®ƒç¡¬ç¼–ç çš„è¦æ±‚ä¸ä¸€è‡´ï¼Œä¼šè‡ªåŠ¨å¸è½½ä½ çš„ç‰ˆæœ¬å¹¶å¼ºåˆ¶å®‰è£…æŒ‡å®šç‰ˆæœ¬ã€‚

è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œç¦ç”¨è‡ªåŠ¨ä¾èµ–å®‰è£…ï¼ˆå‚è€ƒæ­¥éª¤ 5ï¼‰ï¼Œä¸´æ—¶ç”Ÿæ•ˆæˆ–æ°¸ä¹…ç”Ÿæ•ˆå‡å¯ã€‚

å‘2ï¼šå›¾ç‰‡åŠ è½½å¤±è´¥ï¼ˆ403 Forbidden é”™è¯¯ï¼‰
---------------------------

### çŽ°è±¡ï¼šrequests.exceptions.HTTPError: 403 Client Error: Forbidden for url: ...

    
    requests.exceptions.HTTPError: 403 Client Error: Forbidden for url: http://modelscope-open.oss-cn-hangzhou.aliyuncs.com/test/images/visual_question_answering.png
    

åŽŸå› ï¼šä½¿ç”¨äº† ModelScope å®˜æ–¹çš„æµ‹è¯•å›¾ç‰‡ URLï¼Œè¯¥ URL æƒé™å˜æ›´æˆ–å¤±æ•ˆï¼Œæ— æ³•è®¿é—®ï¼ˆ403 æƒé™æ‹’ç»ï¼‰ã€‚

è§£å†³æ–¹æ¡ˆï¼šæ›¿æ¢ä¸ºæœ¬åœ°å›¾ç‰‡æˆ–å…¬å¼€å¯è®¿é—®çš„åœ¨çº¿å›¾ç‰‡ URLï¼Œè„šæœ¬å·²å…¼å®¹ä¸¤ç§å›¾ç‰‡æ¥æºï¼ˆå‚è€ƒæ­¥éª¤ 6.1 å’Œ 6.2ï¼‰ã€‚

å‘3ï¼šè¾“å…¥æ ¼å¼é”™è¯¯ï¼ˆ'text' ç›¸å…³é”™è¯¯ï¼‰
----------------------

### çŽ°è±¡ï¼šè¿è¡Œå‡ºé”™ï¼š'text' æˆ– KeyError: 'text'

åŽŸå› ï¼šæ¨¡åž‹è¾“å…¥æ ¼å¼ä¸ç¬¦åˆè¦æ±‚ï¼ŒOFA VQA æ¨¡åž‹è¦æ±‚è¾“å…¥ä¸ºã€Œ(PIL.Imageå¯¹è±¡, è‹±æ–‡é—®é¢˜æ–‡æœ¬)ã€çš„å…ƒç»„æ ¼å¼ï¼Œè€Œä¸æ˜¯å­—å…¸ï¼ˆæ¯”å¦‚ {'image': ..., 'question': ...}ï¼‰ã€‚

è§£å†³æ–¹æ¡ˆï¼šæŒ‰ç…§è„šæœ¬ä¸­çš„æ ¼å¼ï¼Œå°†è¾“å…¥æ”¹ä¸ºå…ƒç»„ï¼ˆPIL.Imageå¯¹è±¡ + é—®é¢˜æ–‡æœ¬ï¼‰ï¼Œè„šæœ¬å·²å°è£…å¥½è¯¥é€»è¾‘ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ï¼ˆå‚è€ƒæ­¥éª¤ 6.2 ä¸­çš„ä¸»é€»è¾‘éƒ¨åˆ†ï¼‰ã€‚

å‘4ï¼šæ¨¡åž‹åˆå§‹åŒ–å¤±è´¥ï¼ˆç¼ºå°‘ trust\_remote\_code=Trueï¼‰
---------------------------------------

### çŽ°è±¡ï¼šæ¨¡åž‹åˆå§‹åŒ–æ—¶ï¼ŒæŠ¥é”™â€œæ— æ³•åŠ è½½è‡ªå®šä¹‰ä»£ç â€æˆ–â€œæ¨¡åž‹ç»“æž„ä¸åŒ¹é…â€

åŽŸå› ï¼šOFA æ¨¡åž‹æœ‰è‡ªå®šä¹‰çš„é¢„å¤„ç†å’ŒæŽ¨ç†é€»è¾‘ï¼Œåˆ›å»º pipeline æ—¶æ²¡æœ‰æ·»åŠ  trust\_remote\_code=True å‚æ•°ï¼Œæ— æ³•åŠ è½½è¿™äº›è‡ªå®šä¹‰ä»£ç ã€‚

è§£å†³æ–¹æ¡ˆï¼šåˆ›å»º pipeline æ—¶ï¼Œæ·»åŠ  trust\_remote\_code=True å‚æ•°ï¼ˆå‚è€ƒæ­¥éª¤ 6.2 ä¸­çš„ init\_vqa\_model å‡½æ•°ï¼‰ã€‚

å‘5ï¼šè­¦å‘Šä¿¡æ¯å¹²æ‰°ï¼ˆéžé”™è¯¯ï¼Œå¯å¿½ç•¥ï¼‰
------------------

### çŽ°è±¡ï¼šè¿è¡Œè„šæœ¬æ—¶ï¼Œå‡ºçŽ°ä»¥ä¸‹è­¦å‘Šä¿¡æ¯

    
    # è­¦å‘Š1ï¼špkg_resources å¼ƒç”¨è­¦å‘Š
    UserWarning: pkg_resources is deprecated as an API. See ...
    
    # è­¦å‘Š2ï¼šTRANSFORMERS_CACHE å¼ƒç”¨è­¦å‘Š
    FutureWarning: Using `TRANSFORMERS_CACHE` is deprecated and will be removed in v5 of Transformers.
    
    # è­¦å‘Š3ï¼šTensorFlow ç›¸å…³è­¦å‘Šï¼ˆcuDNNã€cuFFT ç­‰ï¼‰
    E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: ...
    

åŽŸå› ï¼šè¿™äº›éƒ½æ˜¯éžåŠŸèƒ½æ€§è­¦å‘Šï¼Œä¸å½±å“æ¨¡åž‹è¿è¡Œâ€”â€”pkg\_resources å¼ƒç”¨æ˜¯ ModelScope çš„ä¾èµ–é—®é¢˜ï¼ŒTRANSFORMERS\_CACHE å¼ƒç”¨æ˜¯ transformers çš„ç‰ˆæœ¬æç¤ºï¼ŒTensorFlow è­¦å‘Šæ˜¯ç¼ºå°‘ç›¸å…³æ’ä»¶ï¼ˆä¸å½±å“ CPU æŽ¨ç†ï¼‰ã€‚

è§£å†³æ–¹æ¡ˆï¼šç›´æŽ¥å¿½ç•¥ï¼Œæ— éœ€å¤„ç†ï¼Œä¸å½±å“æ¨¡åž‹çš„æŽ¨ç†åŠŸèƒ½ã€‚

äº”ã€æ€»ç»“ä¸ŽåŽç»­ä¼˜åŒ–å»ºè®®
===========

1\. éƒ¨ç½²æ€»ç»“
--------

æœ¬æ¬¡ OFA è§†è§‰é—®ç­”æ¨¡åž‹éƒ¨ç½²çš„æ ¸å¿ƒè¦ç‚¹ï¼š

*   çŽ¯å¢ƒéš”ç¦»ï¼šå¿…é¡»ç”¨è™šæ‹ŸçŽ¯å¢ƒï¼Œé¿å…ä¾èµ–å†²çªï¼›
    
*   ç‰ˆæœ¬åŒ¹é…ï¼štransformers4.48.3 + tokenizers0.21.4 + huggingface-hub==0.25.2ï¼Œç‰ˆæœ¬ä¸èƒ½æ”¹ï¼›
    
*   ç¦ç”¨è‡ªåŠ¨ä¾èµ–ï¼šè®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œé¿å… ModelScope è‡ªåŠ¨è¦†ç›–ä¾èµ–ç‰ˆæœ¬ï¼›
    
*   è¾“å…¥æ ¼å¼ï¼šå¿…é¡»æ˜¯ï¼ˆPIL.Imageå¯¹è±¡, è‹±æ–‡é—®é¢˜ï¼‰çš„å…ƒç»„æ ¼å¼ï¼›
    
*   å›¾ç‰‡æ¥æºï¼šé¿å…ä½¿ç”¨å¤±æ•ˆçš„ URLï¼Œä¼˜å…ˆç”¨æœ¬åœ°å›¾ç‰‡ã€‚
    

æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ“ä½œï¼Œå°±èƒ½æˆåŠŸéƒ¨ç½²å¹¶è¿è¡Œæ¨¡åž‹ï¼Œè¾“å‡ºæ­£ç¡®çš„è§†è§‰é—®ç­”ç»“æžœã€‚

2\. åŽç»­ä¼˜åŒ–å»ºè®®
----------

*   æ°¸ä¹…è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼šå°†ç¦ç”¨è‡ªåŠ¨ä¾èµ–çš„å‘½ä»¤å†™å…¥ ~/.bashrcï¼Œé¿å…æ¯æ¬¡æ–°å¼€ç»ˆç«¯éƒ½è¦é‡æ–°æ‰§è¡Œï¼›
    
*   æ”¯æŒä¸­æ–‡é—®ç­”ï¼šæœ¬æ¬¡ä½¿ç”¨çš„æ˜¯è‹±æ–‡æ¨¡åž‹ï¼Œå¯æ›¿æ¢ä¸ºä¸­æ–‡ OFA æ¨¡åž‹ï¼ˆå¦‚ `iic/ofa_visual-question-answering_pretrain_large_zh`ï¼‰ï¼Œé—®é¢˜å¯æ”¹ä¸ºä¸­æ–‡ï¼›
    
*   ä¼˜åŒ–æŽ¨ç†é€Ÿåº¦ï¼šå¦‚æžœç”µè„‘æœ‰ GPUï¼Œå¯å®‰è£… CUDAã€PyTorch GPU ç‰ˆæœ¬ï¼ŒæŽ¨ç†é€Ÿåº¦ä¼šæ¯” CPU å¿« 5-10 å€ï¼›
    
*   æ‰¹é‡æŽ¨ç†ï¼šä¿®æ”¹è„šæœ¬ï¼Œæ”¯æŒæ‰¹é‡è¾“å…¥å›¾ç‰‡å’Œé—®é¢˜ï¼Œæ‰¹é‡è¾“å‡ºç»“æžœï¼Œæé«˜æ•ˆçŽ‡ã€‚
    

å…­ã€æœ€åŽ
====

ä»¥ä¸Šå°±æ˜¯ OFA è§†è§‰é—®ç­”æ¨¡åž‹éƒ¨ç½²çš„å®Œæ•´æ•™å­¦ï¼Œä»ŽçŽ¯å¢ƒå‡†å¤‡åˆ°è„šæœ¬è¿è¡Œï¼Œå†åˆ°é¿å‘æŒ‡å—ï¼Œæ¯ä¸€æ­¥éƒ½è¯¦ç»†æ ‡æ³¨ï¼Œæ–°æ‰‹ä¹Ÿèƒ½è½»æ¾å¤çŽ°ã€‚å¦‚æžœå¤§å®¶åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿Žåœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘ä¼šåŠæ—¶å›žå¤ï½ž

ç¥å¤§å®¶éƒ¨ç½²é¡ºåˆ©ï¼Œæ—©æ—¥ç”¨ä¸Š OFA æ¨¡åž‹å®žçŽ°è§†è§‰é—®ç­”åŠŸèƒ½ï¼ðŸš€