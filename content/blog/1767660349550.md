---
layout: post
title: '[python] é…ç½®ç®¡ç†æ¡†æ¶Hydraä½¿ç”¨æŒ‡åŒ—'
date: "2026-01-06T00:45:49Z"
---
\[python\] é…ç½®ç®¡ç†æ¡†æ¶Hydraä½¿ç”¨æŒ‡åŒ—
==========================

Hydraæ˜¯Facebook Researchå¼€å‘çš„å¼€æºPythoné…ç½®ç®¡ç†æ¡†æ¶ï¼Œæ—¨åœ¨è§£å†³å¤æ‚é¡¹ç›®ä¸­é…ç½®æ··ä¹±ã€å¤šç¯å¢ƒä¸å¤šå‚æ•°ç»„åˆç®¡ç†çš„éš¾é¢˜ã€‚è¯¥æ¡†æ¶é‡‡ç”¨åˆ†å±‚é…ç½®ä¸åŠ¨æ€ç»„åˆè®¾è®¡ï¼Œæ”¯æŒä»¥YAMLæ–‡ä»¶å®ç°ç»“æ„åŒ–é…ç½®ã€‚Hydraå°¤å…¶é€‚ç”¨äºç®€åŒ–æœºå™¨å­¦ä¹ å®éªŒã€è½¯ä»¶å¼€å‘åŠå…¶ä»–å¤æ‚åº”ç”¨çš„é…ç½®ç®¡ç†ã€‚å®ƒçš„åå­—æ¥æºäºå¸Œè…Šç¥è¯ä¸­çš„ä¹å¤´è›‡ï¼Œå¯“æ„å…¶èƒ½å¤Ÿçµæ´»ç®¡ç†å¤šç§é…ç½®ç»„åˆã€‚Hydraçš„æ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬æ”¯æŒå¤šæºåˆ†å±‚é…ç½®ç»„åˆã€å¯é€šè¿‡å‘½ä»¤è¡Œç›´æ¥è¦†ç›–é…ç½®ã€æä¾›åŠ¨æ€å‘½ä»¤è¡¥å…¨åŠŸèƒ½ï¼ŒåŒæ—¶æ”¯æŒæœ¬åœ°ä¸è¿œç¨‹è¿è¡Œï¼Œå¹¶èƒ½é€šè¿‡å•å‘½ä»¤æ‰§è¡Œæ‰¹é‡å‚æ•°ä½œä¸šã€‚

![https://github.com/facebookresearch/hydra/blob/main/website/static/img/Hydra-Readme-logo2.svg](https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img1.svg)

Hydraçš„å®˜æ–¹ä»“åº“åœ°å€ä¸ºï¼š[hydra](https://github.com/facebookresearch/hydra)ï¼Œè¯¦ç»†æ–‡æ¡£å¯å‚é˜…ï¼š[hydra-doc](https://hydra.cc/docs/intro/)ã€‚HydraåŠŸèƒ½å…¨é¢ï¼Œæœ¬æ–‡ä¸»è¦ä»‹ç»å…¶åŸºæœ¬ä½¿ç”¨æ–¹æ³•ï¼Œæ›´å¤šé«˜çº§åŠŸèƒ½è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚æˆªè‡³æœ¬æ–‡æ’°å†™æ—¶ï¼ŒHydraçš„ç¨³å®šç‰ˆæœ¬ä¸º1.3ï¼Œè¯¥ç‰ˆæœ¬å…¼å®¹Python 3.6è‡³3.11ï¼Œå¹¶å…¨é¢æ”¯æŒLinuxã€macOSå’ŒWindowsæ“ä½œç³»ç»Ÿã€‚å®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š

> pip install hydra-core --upgrade

ç›®å½•

*   [1 åŸºç¡€æ•™ç¨‹](#1-åŸºç¡€æ•™ç¨‹)
    *   [1.1 å¿«é€Ÿå…¥é—¨](#11-å¿«é€Ÿå…¥é—¨)
    *   [1.2 æ•´åˆåº”ç”¨](#12-æ•´åˆåº”ç”¨)
    *   [1.3 ä¿¡æ¯ç®¡ç†](#13-ä¿¡æ¯ç®¡ç†)
*   [2 ç»“æ„åŒ–é…ç½®](#2-ç»“æ„åŒ–é…ç½®)
    *   [2.1 Hydraä»£ç é…ç½®](#21-hydraä»£ç é…ç½®)
    *   [2.2 é…ç½®æ¨¡å¼](#22-é…ç½®æ¨¡å¼)
*   [3 å‚è€ƒ](#3-å‚è€ƒ)

1 åŸºç¡€æ•™ç¨‹
======

1.1 å¿«é€Ÿå…¥é—¨
--------

**ç®€å•ç¤ºä¾‹**

ä»¥ä¸‹ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„Hydraåº”ç”¨ç¤ºä¾‹ï¼Œå®ƒä¼šæ‰“å°å‡ºé…ç½®ä¿¡æ¯ï¼Œå…¶ä¸­my\_appå‡½æ•°æ˜¯ç¼–å†™ä¸šåŠ¡é€»è¾‘çš„å…¥å£ã€‚

    from omegaconf import DictConfig, OmegaConf
    import hydra
    
    @hydra.main(version_base=None)
    def my_app(cfg: DictConfig) -> None:
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        my_app()
    

å¦‚æœä½ ç›´æ¥æ‰§è¡Œè¿™æ®µä»£ç ï¼ˆæ²¡æœ‰ä»»ä½•å‘½ä»¤è¡Œå‚æ•°ï¼‰ï¼Œç¨‹åºä¼šè¾“å‡ºä¸€ä¸ªç©ºçš„é…ç½®å¯¹è±¡ï¼š

    {}
    

è¿™æ˜¯å› ä¸ºï¼Œå½“è¿è¡Œ`my_app.py`æ—¶ï¼Œ`@hydra.main`è£…é¥°å™¨ä¼šè‡ªåŠ¨æ‹¦æˆªå¯¹ `my_app()`çš„è°ƒç”¨ã€‚æ­¤æ—¶Hydraä¼šåˆå§‹åŒ–ä¸€ä¸ªç©ºçš„`DictConfig`å¯¹è±¡ï¼ˆç±»ä¼¼äºPythonå­—å…¸ï¼‰ï¼Œå¹¶å°†å…¶ä½œä¸ºå‚æ•°`cfg` ä¼ é€’ç»™å‡½æ•°ã€‚ç”±äºå½“å‰é…ç½®ä¸ºç©ºï¼Œ`OmegaConf.to_yaml(cfg)`å°†å…¶è½¬æ¢ä¸ºYAMLæ ¼å¼åï¼Œä»…è¾“å‡ºä¸€ä¸ªç©ºå¯¹è±¡ã€‚OmegaConfæ˜¯Hydraçš„åº•å±‚é…ç½®å¼•æ“ï¼ŒHydraåŸºäºOmegaConfå®ç°ä¸Šå±‚çš„å¤æ‚åº”ç”¨é…ç½®ä¸è¿è¡Œç®¡ç†ï¼Œä¸”OmegaConfå¯ç‹¬ç«‹ä½¿ç”¨ã€‚

æ­¤å¤–é»˜è®¤æƒ…å†µä¸‹ï¼ŒHydraä¼šåˆ›å»ºä»¥ä¸‹ç›®å½•ç»“æ„ä»¥è¿½è¸ªå’Œç®¡ç†ç¨‹åºçš„è¿è¡Œç»“æœï¼š

    outputs/
    â”œâ”€â”€ yyyy-mm-dd/          # æŒ‰æ—¥æœŸåˆ†ç»„
    â”‚   â””â”€â”€ hh-mm-ss/        # æŒ‰æ—¶é—´ç²¾ç¡®åˆ°ç§’
    â”‚       â””â”€â”€ .hydra/      # ä¿å­˜æœ¬æ¬¡è¿è¡Œçš„é…ç½®
    â”‚           â”œâ”€â”€ config.yaml    # å®Œæ•´çš„é…ç½®
    â”‚           â”œâ”€â”€ hydra.yaml     # Hydra è‡ªèº«çš„é…ç½®
    â”‚           â””â”€â”€ overrides.yaml # å‘½ä»¤è¡Œè¦†ç›–çš„å‚æ•°
    â”‚       â””â”€â”€ my_app.log   # æ—¥å¿—æ–‡ä»¶ï¼ˆå¦‚æœé…ç½®äº†æ—¥å¿—ï¼‰
    â”‚       â””â”€â”€ å…¶ä»–è¾“å‡ºæ–‡ä»¶     # ä½ çš„ç¨‹åºç”Ÿæˆçš„æ–‡ä»¶
    

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸ºé…ç½®æ·»åŠ å†…å®¹ï¼š

1.  é€šè¿‡å‘½ä»¤è¡Œæ·»åŠ ï¼š
    
        # ä¸æ”¯æŒç›´æ¥åœ¨ +key=value è¯­æ³•ä¸­ä¼ å…¥é ASCII å­—ç¬¦
        python my_app.py +name="zhangsan" +age=25
        
    
    è¾“å‡ºï¼š
    
        name: zhangsan
        age: 25
        
    
2.  åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š  
    åˆ›å»ºä¸€ä¸ª`config.yaml`æ–‡ä»¶ï¼Œç„¶åè¿è¡Œï¼š
    
        python my_app.py --config-path=. --config-name=config
        
    
3.  åœ¨ä»£ç ä¸­è®¾ç½®é»˜è®¤é…ç½®ï¼š  
    å¯ä»¥ä¿®æ”¹ä»£ç ï¼Œä¸º`@hydra.main`è£…é¥°å™¨æ·»åŠ é…ç½®å‚æ•°ï¼š
    
        from omegaconf import DictConfig, OmegaConf
        import hydra
        
        @hydra.main(version_base=None, config_path=".", config_name="config")
        def my_app(cfg):
            print(OmegaConf.to_yaml(cfg))
        
        if __name__ == "__main__":
            my_app()
        
    
    å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè¦†ç›–å·²åŠ è½½é…ç½®ä¸­çš„å€¼ï¼Œä½†æ˜¯æ³¨æ„æ— éœ€æ·»åŠ +å‰ç¼€ï¼š
    
        python my_app.py name="lisi"
        
    
    ä½¿ç”¨++å‰ç¼€å¯å®ç°è‹¥é…ç½®ä¸­å·²å­˜åœ¨è¯¥å‚æ•°åˆ™è¦†ç›–ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æ–°å¢ï¼š
    
        python my_app.py ++name="wangwu" ++password=1234
        
    
    è¦æ³¨æ„ğŸ¤–ï¼šHydraé€šè¿‡å‘½ä»¤è¡Œä¿®æ”¹é…ç½®æ—¶ï¼Œä»…ä¼šè¦†ç›–æˆ–æ–°å¢ç¨‹åºè¿è¡Œæ—¶å†…å­˜ä¸­çš„é…ç½®æ•°æ®ï¼Œä¸ä¼šæ”¹åŠ¨ç£ç›˜ä¸Šçš„åŸå§‹é…ç½®æ–‡ä»¶ï¼Œé‡å¯ç¨‹åºåä»ä¼šé…ç½®åŠ è½½æ–‡ä»¶çš„åŸå§‹é…ç½®ã€‚
    

**é…ç½®å¯¹è±¡ä½¿ç”¨**

é€šè¿‡HydraåŠ è½½é…ç½®åï¼Œå¯é€šè¿‡å±æ€§æˆ–å­—å…¸å¼è®¿é—®æˆ–ä¿®æ”¹å·²æœ‰çš„é…ç½®é¡¹ï¼Œè®¿é—®ä¸å­˜åœ¨çš„é…ç½®é¡¹æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š

    from omegaconf import DictConfig, OmegaConf
    import hydra
    
    @hydra.main(version_base=None, config_path=".", config_name="config")
    def my_app(cfg: DictConfig):
        # å±æ€§å¼è®¿é—®é…ç½®å€¼
        assert cfg.name == "å¼ ä¸‰"
        # å­—å…¸å¼è®¿é—®é…ç½®å€¼
        assert cfg["age"] == 25
        
        # ä¿®æ”¹å·²æœ‰é…ç½®å€¼
        cfg.name = "æå››"          
        cfg["age"] = 30            
        assert cfg.name == "æå››"
        assert cfg["age"] == 30
    
        # è®¿é—®ç¼ºå¤±å€¼ä¼šæŠ›å‡ºå¼‚å¸¸
        try:
            cfg.birth_year
        except Exception as e:
            print("error !!")
            print(e)
    
    if __name__ == "__main__":
        my_app()
    

ä¹‹æ‰€ä»¥ä¸å…è®¸è®¿é—®ä¸å­˜åœ¨çš„é…ç½®é”®ï¼Œä»…èƒ½æ“ä½œå·²æœ‰é…ç½®é”®ï¼Œæ˜¯å› ä¸ºHydraé»˜è®¤å¯ç”¨äº†structæ¨¡å¼ä»¥ä¸¥æ ¼ç»“æ„åŒ–é…ç½®ã€‚å¦‚éœ€æ–°å¢æˆ–ä¿®æ”¹é…ç½®ï¼Œå¯å…ˆå…³é—­ä¸¥æ ¼æ¨¡å¼ï¼Œå…è®¸åŠ¨æ€æ–°å¢é”®ã€‚ä½†å¦‚æœåµŒå¥—å±‚çº§ä¹Ÿæœªæå‰å£°æ˜ï¼Œåˆ™éœ€è¦å…ˆåˆ›å»ºç©ºåµŒå¥—ï¼Œå†ä¸ºå…¶æ·»åŠ å­é¡¹ï¼š

    from omegaconf import DictConfig, OmegaConf
    import hydra
    import os
    
    @hydra.main(version_base=None, config_path=".", config_name="config")
    def my_app(cfg: DictConfig):
        # å…³é—­structæ¨¡å¼ï¼Œå…è®¸æ–°å¢é…ç½®é”®
        OmegaConf.set_struct(cfg, False)
    
        # åŒä¸€çº§æ–°å¢é…ç½®
        cfg.birth_year = 1995      
        cfg["hobby"] = ["ç¯®çƒ", "ç¼–ç¨‹"]
    
        # æ— æ³•ç›´æ¥ç»™ä¸å­˜åœ¨çš„åµŒå¥—å±‚çº§é“¾å¼èµ‹å€¼
        # cfg.address.city = "åŒ—äº¬"          
        # éœ€è¦å…ˆåˆ›å»ºåµŒå¥—å±‚çº§ï¼Œå†èµ‹å€¼å­é”®
        cfg.address = OmegaConf.create({})  # æ˜¾å¼åˆ›å»ºç©ºçš„åµŒå¥—
        cfg.address.city = "åŒ—äº¬"         
        cfg.address["district"] = "æœé˜³åŒº"
    
        # éªŒè¯å†™å…¥ç»“æœ
        assert cfg.birth_year == 1995  
        assert cfg.address.district == "æœé˜³åŒº"
        print("é…ç½®å†™å…¥éªŒè¯é€šè¿‡ï¼")
    
    if __name__ == "__main__":
        my_app()
    

**å¯¹é…ç½®æ–‡ä»¶è¿›è¡Œåˆ†ç»„**

è‹¥å¸Œæœ›åˆ†åˆ«ä½¿ç”¨CNNå’ŒTransformeræ¨¡å‹å¯¹æ•°æ®é›†è¿›è¡Œè®­ç»ƒåŸºå‡†æµ‹è¯•ï¼Œå¯é€šè¿‡é…ç½®ç»„ï¼ˆConfig Groupï¼‰å®ç°è¿™ä¸€éœ€æ±‚ã€‚é…ç½®ç»„æ˜¯ä¸€ä¸ªå¸¦æœ‰åç§°çš„åˆ†ç»„ï¼ŒåŒ…å«ä¸€ç»„æœ‰æ•ˆçš„é…ç½®é¡¹ã€‚è‹¥é€‰æ‹©ä¸å­˜åœ¨çš„é…ç½®é¡¹ï¼Œç³»ç»Ÿä¼šç”Ÿæˆé”™è¯¯æç¤ºï¼Œå¹¶åˆ—å‡ºæ‰€æœ‰æœ‰æ•ˆçš„é…ç½®é¡¹ã€‚

åˆ›å»ºé…ç½®ç»„æ—¶ï¼Œéœ€å…ˆæ–°å»ºä¸€ä¸ªç›®å½•ï¼ˆä¾‹å¦‚modelï¼‰ï¼Œç”¨äºå­˜æ”¾å„æ¨¡å‹é…ç½®é¡¹å¯¹åº”çš„æ–‡ä»¶ã€‚ç”±äºé¢„è®¡ä¼šåˆ›å»ºå¤šä¸ªé…ç½®ç»„ï¼Œå»ºè®®æå‰å°†æ‰€æœ‰é…ç½®æ–‡ä»¶ç»Ÿä¸€ç§»è‡³confç›®å½•ä¸‹ç®¡ç†ã€‚

ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

    â”œâ”€ conf
    â”‚  â””â”€ model
    â”‚      â”œâ”€ cnn.yaml
    â”‚      â””â”€ transformer.yaml
    â””â”€â”€ my_app.py
    

model/cnn.yamlï¼š

    backbone: resnet50
    learning_rate: 0.001
    batch_size: 32
    epochs: 20
    dropout: 0.2
    

model/transformer.yamlï¼š

    backbone: vit_base
    learning_rate: 0.0001
    batch_size: 16
    epochs: 30
    attention_heads: 12
    

æ‰€æœ‰é…ç½®æ–‡ä»¶å·²ç»Ÿä¸€å­˜æ”¾è‡³confç›®å½•ï¼Œéœ€é€šè¿‡config\_pathå‚æ•°å‘ŠçŸ¥Hydraè¯¥ç›®å½•ä½ç½®ï¼Œå¹¶åœ¨ä»£ç ä¸­æŒ‡å®šå¾…åŠ è½½çš„é…ç½®æ–‡ä»¶åconfig\_nameã€‚è‹¥æœªæ˜ç¡®æŒ‡å®šå…·ä½“é…ç½®æ–‡ä»¶åï¼ŒHydraæ— æ³•è‡ªåŠ¨æ¨æ–­åŠ è½½ç›®æ ‡ï¼Œæœ€ç»ˆä¼šè¾“å‡ºç©ºé…ç½®:

    from omegaconf import DictConfig, OmegaConf
    import hydra
    
    @hydra.main(version_base=None, config_path="conf", config_name="model/cnn")
    def my_app(cfg: DictConfig) -> None:
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        my_app()
    

ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä»é…ç½®ç»„ä¸­é€‰æ‹©ç‰¹å®šé…ç½®é¡¹ï¼Œå‘½ä»¤è¡Œä½¿ç”¨`+åˆ†ç»„å=é…ç½®é¡¹`çš„æ ¼å¼ï¼Œä¾‹å¦‚ï¼š

    python my_app.py +model=transformer
    

ä¸å¸¸è§„ç”¨æ³•ä¸€è‡´ï¼Œä»å¯è¦†ç›–æœ€ç»ˆé…ç½®ä¸­çš„å•ä¸ªå‚æ•°å€¼ï¼š

    python my_app.py +model=transformer model.epochs=40
    

**å¤šæ–‡ä»¶å¤„ç†**

å¯ä»¥ç”Ÿæˆä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­ç”¨`defaults`å‚æ•°æ·»åŠ é»˜è®¤é…ç½®åˆ—è¡¨ã€‚è¯¥åˆ—è¡¨ç”¨äºæŒ‡å®šHydraç»„åˆæœ€ç»ˆé…ç½®å¯¹è±¡çš„è§„åˆ™ï¼ŒæŒ‰ç…§çº¦å®šï¼Œå®ƒéœ€ä½œä¸ºé…ç½®æ–‡ä»¶çš„é¦–ä¸ªé…ç½®é¡¹ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

    defaults:
      - model: cnn
    

ç„¶åè¿™ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥å‘½åä¸ºä»»æ„åå­—ï¼Œå¦‚confæ–‡ä»¶å¤¹ä¸‹çš„config.yamlï¼Œè¿™æ ·è¿è¡Œä¼šé»˜è®¤åŠ è½½modelå¯¹åº”çš„æ–‡ä»¶é…ç½®ï¼š

    from omegaconf import DictConfig, OmegaConf
    import hydra
    
    @hydra.main(version_base=None, config_path="conf", config_name="config")
    def my_app(cfg: DictConfig) -> None:
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        my_app()
    

é»˜è®¤é…ç½®åˆ—è¡¨æ”¯æŒå åŠ å¤šä¸ªæ·±åº¦å­¦ä¹ ç›¸å…³é…ç½®é¡¹ã€‚è‹¥åŒä¸€é…ç½®ç»„å­˜åœ¨ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œç³»ç»Ÿä¼šå°†è¿™ä¸¤ä¸ªé…ç½®æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªæ–°å­—å…¸ï¼›å½“é…ç½®ä¸­å‡ºç°ç›¸åŒé”®åæ—¶ï¼ŒååŠ è½½çš„é…ç½®é¡¹ä¼šè¦†ç›–å…ˆåŠ è½½çš„é…ç½®é¡¹ã€‚ç¤ºä¾‹é»˜è®¤é…ç½®å¦‚ä¸‹ï¼š

    defaults:
      - model: 
        - cnn
        - transformer
    

è‹¥åœ¨é…ç½®æ–‡ä»¶å¤¹confä¸‹çš„datasetç›®å½•ä¸­ï¼Œå­˜åœ¨å¦‚ä¸‹é…ç½®æ–‡ä»¶model/cifar10.yamlï¼š

    name: CIFAR-10
    path: ./data/cifar10
    num_classes: 10
    learning_rate: 0.0001
    augmentation: true  # æ˜¯å¦å¼€å¯æ•°æ®å¢å¼º
    

å½“é»˜è®¤é…ç½®æ–‡ä»¶conf/config.yamlä¸­é»˜è®¤é…ç½®åˆ—è¡¨çš„å†…å®¹å¦‚ä¸‹ï¼š

    defaults:
      - model: cnn
      - dataset: cifar10 
    

ç”±äºmodelå’Œdatasetåˆ†å±ä¸åŒçš„é…ç½®ç»„ï¼ŒHydraä¼šå°†è¿™ä¸¤ä¸ªé…ç½®ç»„çš„é»˜è®¤é…ç½®è¿›è¡Œç‹¬ç«‹åˆå¹¶ã€‚æœ€ç»ˆç”Ÿæˆçš„å®Œæ•´é…ç½®ç»“æ„ä¸­ï¼Œä¼šåŒ…å«modelå’Œdatasetä¸¤ä¸ªä¸€çº§é…ç½®é¡¹ï¼Œå„è‡ªä¿ç•™å¯¹åº”é…ç½®ç»„çš„å®Œæ•´å‚æ•°ï¼š

    model:
      # æ­¤å¤„ä¸ºconf/model/cnn.yamlä¸­çš„é…ç½®å†…å®¹
    dataset:
      # æ­¤å¤„ä¸ºconf/dataset/cifar10.yamlä¸­çš„é…ç½®å†…å®¹
    

å³ä½¿è®¾ç½®äº†é»˜è®¤é…ç½®ï¼Œä»å¯æ‰‹åŠ¨ç¡®å®šå‚æ•°å¹¶è¦†ç›–éƒ¨åˆ†é…ç½®å‚æ•°ï¼š

    python my_app.py model=cnn model.epochs=30
    

åœ¨é…ç½®é¡¹å‰æ·»åŠ ~å‰ç¼€ï¼Œå¯ä»é»˜è®¤é…ç½®åˆ—è¡¨ä¸­ç§»é™¤è¯¥é»˜è®¤é¡¹ï¼š

    python my_app.py ~model
    

**ä¸»é…ç½®çš„ç»„åˆé¡ºåº**

ä¸»é…ç½®æ–‡ä»¶ä¸­å¯åŒæ—¶åŒ…å«é…ç½®å‚æ•°å’Œé»˜è®¤é…ç½®åˆ—è¡¨ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œè‹¥éœ€è°ƒæ•´é»˜è®¤é…ç½®åˆ—è¡¨ä¸ä¸»é…ç½®ä¹‹é—´çš„è¦†ç›–å…³ç³»ï¼Œå¯é€šè¿‡æ·»åŠ `_self_`å…³é”®å­—å®ç°ï¼šå°†`_self_`ç½®äºé»˜è®¤é…ç½®åˆ—è¡¨æœ«å°¾ï¼Œåˆ™ä¸»é…ç½®å‚æ•°å°†è¦†ç›–é»˜è®¤é…ç½®åˆ—è¡¨ä¸­çš„å¯¹åº”é¡¹ï¼›è‹¥å°†å…¶ç½®äºåˆ—è¡¨å¼€å¤´ï¼Œåˆ™é»˜è®¤é…ç½®åˆ—è¡¨ä¸­çš„å‚æ•°å°†è¦†ç›–ä¸»é…ç½®ä¸­çš„å†…å®¹ã€‚

éœ€æ³¨æ„çš„æ˜¯ï¼Œä»Hydra 1.1ç‰ˆæœ¬å¼€å§‹ï¼Œé»˜è®¤è¡Œä¸ºä¸ºä¸»é…ç½®è¦†ç›–é»˜è®¤é…ç½®åˆ—è¡¨ä¸­çš„é…ç½®ï¼›è€Œåœ¨æ­¤ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œé»˜è®¤é…ç½®åˆ—è¡¨ä¼šè¦†ç›–ä¸»é…ç½®çš„å‚æ•°ã€‚

ä¾‹å¦‚é»˜è®¤é…ç½®æ–‡ä»¶config.yamlå†…å®¹å¦‚ä¸‹ï¼Œä¼šè¿›è¡Œæ•°æ®è¦†ç›–ï¼Œä¹Ÿå°±æ˜¯è¯´é…ç½®æ–‡ä»¶é‡Œdatasetéƒ¨åˆ†ä¼šè¦†ç›–é»˜è®¤é…ç½®ä¸­çš„åŒåéƒ¨åˆ†ï¼š

    defaults:
      - model: cnn
      - dataset: cifar10 
      - _self_
    
    dataset: 
      name: my_dataset
    version: 1.0
    

1.2 æ•´åˆåº”ç”¨
--------

éšç€è½¯ä»¶å¤æ‚åº¦çš„ä¸æ–­æå‡ï¼Œæˆ‘ä»¬ä¼šé‡‡ç”¨æ¨¡å—åŒ–ä¸ç»„åˆåŒ–çš„è®¾è®¡æ€è·¯æ¥ä¿è¯å…¶å¯ç»´æŠ¤æ€§ã€‚è¿™ç§æ€è·¯åŒæ ·é€‚ç”¨äºé…ç½®æ–‡ä»¶çš„ç®¡ç†ã€‚å‡è®¾æˆ‘ä»¬éœ€è¦ä¸ºç¤ºä¾‹ç¨‹åºé…ç½®å¤šç±»æ·±åº¦å­¦ä¹ æ¨¡å‹æ”¯æŒï¼Œä¸”æ¯ä¸ªæ¨¡å‹å¯¹åº”å¤šç§è®­ç»ƒç­–ç•¥ã€æ­é…ä¸åŒçš„æ•°æ®é¢„å¤„ç†æµç¨‹ã€‚ä½¿ç”¨Hydraæ—¶ï¼Œæ—¢ä¸å¿…ä¸ºæ¨¡å‹ã€ç­–ç•¥ã€é¢„å¤„ç†æµç¨‹çš„å„ç±»ç»„åˆç¼–å†™ç‹¬ç«‹ç±»ï¼Œä¹Ÿæ— éœ€ä¸ºå…¶å•ç‹¬ç¼–å†™é…ç½®æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥å€Ÿé‰´åº•å±‚è½¯ä»¶å¼€å‘çš„æ ¸å¿ƒæ€è·¯ï¼šé€šè¿‡ç»„åˆåŒ–é…ç½®æ¥è§£å†³è¿™ä¸€é—®é¢˜ã€‚

![https://github.com/facebookresearch/hydra/blob/main/website/static/img/Hydra-plugins2.svg](https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img2.svg)

**å¤šè½®è¿è¡Œï¼ˆMulti-runï¼‰**

å¯¹äºä½¿ç”¨å¤šå¥—é…ç½®è¿è¡ŒåŒä¸€åº”ç”¨ç¨‹åºçš„åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæˆ–é…ç½®æ–‡ä»¶ä¸¤ç§æ–¹å¼ä¸ºHydraåº”ç”¨å¯ç”¨å¤šè½®è¿è¡ŒåŠŸèƒ½ã€‚è¯¥åŠŸèƒ½è‡ªHydra 1.2ç‰ˆæœ¬èµ·å¼•å…¥ï¼Œé€šè¿‡è®¾ç½®hydra.modeé…ç½®é¡¹å®ç°ã€‚hydra.modeçš„åˆæ³•å–å€¼åŒ…æ‹¬RUNï¼ˆå•æ¬¡è¿è¡Œï¼‰å’ŒMULTIRUNï¼ˆå¤šè½®è¿è¡Œï¼‰ã€‚è‹¥åœ¨è¾“å…¥é…ç½®ä¸­å°†hydra.modeè®¾ä¸ºMULTIRUNï¼Œåº”ç”¨ç¨‹åºå°†é»˜è®¤ä»¥å¤šè½®è¿è¡Œæ¨¡å¼å¯åŠ¨ã€‚

ä¾‹å¦‚é»˜è®¤é…ç½®æ–‡ä»¶ä¸ºï¼š

    defaults:
      - model: cnn
      - dataset: cifar10 
    

å¤šè½®è¿è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š

    python my_app.py hydra.mode=MULTIRUN model=cnn,transformer dataset=cifar10
    

åªè¦å‚æ•°å€¼ç”¨é€—å·åˆ†éš”ï¼Œå°±ä¼šè¢«Hydraè¯†åˆ«ä¸ºå¤šå–å€¼å‚æ•°ï¼ŒHydraä¼šæŠŠæ‰€æœ‰å¸¦å¤šä¸ªå–å€¼çš„å‚æ•°åšç¬›å¡å°”ç§¯ï¼ˆå…¨ç»„åˆï¼‰ï¼ŒHydraä¼šæŠŠæ¯ä¸ªå‚æ•°çš„å–å€¼ä¸¤ä¸¤é…å¯¹ï¼Œç”Ÿæˆä»¥ä¸‹å¤šä¸ªä»»åŠ¡ï¼Œä¾æ¬¡è¿è¡Œï¼š

    python my_app.py hydra.mode=MULTIRUN model=cnn,transformer dataset=cifar10
    # æœ¬åœ°å¯åŠ¨2ä¸ªä»»åŠ¡
    #0 : model=cnn dataset=cifar10
    #1 : model=transformer dataset=cifar10
    

è¯¥å‘½ä»¤å¯ä»¥ç”¨å‘½ä»¤è¡Œå‚æ•°ç®€åŒ–ï¼š

    python my_app.py --multirun model=cnn,transformer dataset=cifar10
    # æˆ–
    python my_app.py -m model=cnn,transformer dataset=cifar10
    

æ³¨æ„Hydraä¼šåœ¨ä»»åŠ¡å¯åŠ¨æ—¶å»¶è¿Ÿç»„åˆé…ç½®ã€‚è‹¥åœ¨å¯åŠ¨ä»»åŠ¡å‚æ•°éå†åä¿®æ”¹ä»£ç æˆ–é…ç½®æ–‡ä»¶ï¼Œæœ€ç»ˆç»„åˆç”Ÿæˆçš„é…ç½®å¯èƒ½ä¼šå—å½±å“ã€‚

ä¹Ÿå¯ä»¥åœ¨è¾“å…¥é…ç½®ä¸­é€šè¿‡è¦†ç›–hydra.sweeper.paramsæ¥å®šä¹‰å‚æ•°éå†è§„åˆ™å¹¶é€šè¿‡modeè®¾ç½®è¿è¡Œæ¨¡å¼ã€‚æ²¿ç”¨ä¸Šè¿°ç¤ºä¾‹ï¼Œä»¥ä¸‹é…ç½®å¯å®ç°å®Œå…¨ç›¸åŒçš„å¤šè½®è¿è¡Œæ•ˆæœï¼š

    defaults:
      - model: cnn
      - dataset: cifar10 
    
    hydra:
      mode: MULTIRUN # è®¾ç½®è¿è¡Œæ¨¡å¼
      sweeper:
        params:
          dataset: cifar10
          model: transformer, cnn
    

ç›´æ¥è¿è¡Œç¨‹åºä¸ä½¿ç”¨ä»»ä½•é™„åŠ å‚æ•°ï¼Œç»“æœå¦‚ä¸‹ï¼š

    $ python my_app.py
    # æœ¬åœ°å¯åŠ¨2ä¸ªä»»åŠ¡
    #0 : model=transformer dataset=cifar10
    #1 : model=cnn dataset=cifar10
    

1.3 ä¿¡æ¯ç®¡ç†
--------

**è¾“å‡ºç›®å½•**

Hydraèƒ½å¤Ÿè§£å†³æ¯æ¬¡è¿è¡Œç¨‹åºæ—¶éœ€è¦æ‰‹åŠ¨æŒ‡å®šæ–°è¾“å‡ºç›®å½•çš„é—®é¢˜ï¼Œå®ƒä¼šä¸ºæ¯æ¬¡è¿è¡Œè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªä¸“å±ç›®å½•ï¼Œå¹¶åœ¨è¯¥è¾“å‡ºç›®å½•ä¸­æ‰§è¡Œä»£ç ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¬¡è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„è¾“å‡ºç›®å½•ã€‚å¯ä»¥é€šè¿‡è¯»å–Hydraé…ç½®æ¥è·å–æœ¬æ¬¡è¿è¡Œè¯¥è¾“å‡ºç›®å½•çš„è·¯å¾„ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

    from omegaconf import DictConfig, OmegaConf
    import hydra
    import os
    
    @hydra.main(version_base=None, config_path="conf", config_name="config")
    def my_app(_cfg: DictConfig) -> None:
        print(f"å·¥ä½œç›®å½•ï¼š{os.getcwd()}")
        print(f"è¾“å‡ºç›®å½•ï¼š{hydra.core.hydra_config.HydraConfig.get().runtime.output_dir}")
    
    if __name__ == "__main__":
        my_app()
    

é€šè¿‡è®¾ç½®hydra.job.chdir=Trueï¼Œå¯ä»¥è®©Hydraçš„`@hydra.main`è£…é¥°å™¨åœ¨æ‰§è¡Œç”¨æˆ·çš„ä¸»å‡½æ•°å‰ï¼Œè°ƒç”¨os.chdirå°†Pythonå·¥ä½œç›®å½•åˆ‡æ¢åˆ°è¾“å‡ºç›®å½•ï¼š

    python my_app.py hydra.job.chdir=True
    

å¯ä»¥é€šè¿‡è¦†ç›–é…ç½®é¡¹hydra.output\_subdirå°†è®¾ä¸ºnullï¼Œåˆ™ä¼šå®Œå…¨ç¦ç”¨è¯¥å­ç›®å½•çš„åˆ›å»ºã€‚

**æ—¥å¿—**

ç”±äºæ ‡å‡†loggingæ¨¡å—é…ç½®è¾ƒä¸ºå¤æ‚ï¼Œä¸ºå®ç°å¸¸è§„çš„æ—¥å¿—åŠŸèƒ½é€šå¸¸éœ€è¦ç¼–å†™è¾ƒå¤šä»£ç ï¼Œä¸”é…ç½®è¿‡ç¨‹ä¸å¤Ÿç®€ä¾¿ã€‚Hydraèƒ½å¤Ÿè‡ªåŠ¨å®ŒæˆPython loggingçš„é…ç½®ï¼Œä»è€Œæœ‰æ•ˆè§£å†³è¿™ä¸€é—®é¢˜ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒHydraä¼šä»¥INFOçº§åˆ«å‘æ§åˆ¶å°è¾“å‡ºæ—¥å¿—ï¼ŒåŒæ—¶åœ¨å½“å‰å·¥ä½œç›®å½•è‡ªåŠ¨ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ç•™å­˜è®°å½•ã€‚ä»¥ä¸‹ä¸ºä½¿ç”¨Hydraè¿›è¡Œæ—¥å¿—è®°å½•çš„ç¤ºä¾‹ï¼š

    # hydra_log_demo.py
    import logging
    from omegaconf import DictConfig
    import hydra
    # ä¸ºæœ¬æ–‡ä»¶åˆ›å»ºæ—¥å¿—å™¨
    log = logging.getLogger(__name__)
    @hydra.main(version_base=None)
    def my_app(_cfg: DictConfig) -> None:
        log.info("Info çº§åˆ«æ—¥å¿—æ¶ˆæ¯")
        log.debug("Debug çº§åˆ«æ—¥å¿—æ¶ˆæ¯")
    if __name__ == "__main__":
        my_app()
    

å¯é€šè¿‡åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®š`hydra.verbose`é…ç½®é¡¹æ¥å¯ç”¨DEBUGçº§åˆ«çš„æ—¥å¿—è¾“å‡ºã€‚è¯¥é…ç½®é¡¹æ”¯æŒå¸ƒå°”å€¼ã€å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ç±»å‹çš„å–å€¼ï¼Œå¼€å¯å…¨éƒ¨æˆ–æŒ‡å®šæ—¥å¿—å™¨çš„DEBUGçº§åˆ«è¾“å‡ºå¦‚ä¸‹ï¼š

    python hydra_log_demo.py hydra.verbose=true
    

è‹¥è¦å°†ç‰¹å®šå‡½æ•°å¯¹åº”æ—¥å¿—å™¨çš„çº§åˆ«è®¾ä¸ºDEBUGï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

    python hydra_log_demo.py hydra.verbose="[__main__,my_custom_logger]"
    

å…¶æ•ˆæœç­‰åŒäºä»£ç ï¼š

    import logging
    logging.getLogger(NAME).setLevel(logging.DEBUG)
    

å¦‚æœä¸å¸Œæœ›Hydraè‡ªåŠ¨é…ç½®æ—¥å¿—ç³»ç»Ÿï¼Œå¯ä»¥å°†hydra/job\_loggingï¼ˆå¯¹åº”ç¨‹åºçš„æ—¥å¿—ï¼‰å’Œhydra/hydra\_loggingï¼ˆå¯¹åº”Hydraæ¡†æ¶è‡ªèº«çš„æ—¥å¿—ï¼‰å‡è®¾ä¸ºnoneï¼š

    python my_app.py hydra/job_logging=None hydra/hydra_logging=None
    

**è°ƒè¯•åŠŸèƒ½**

Hydraæä¾›å¤šç§é…ç½®é€‰é¡¹ï¼Œå¯æœ‰æ•ˆæå‡ç¨‹åºçš„å¯è°ƒè¯•æ€§ã€‚åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨`--cfg`æˆ–`-c`å‚æ•°ï¼Œå³å¯åœ¨ä¸è¿è¡Œç›®æ ‡å‡½æ•°çš„æƒ…å†µä¸‹æ‰“å°åº”ç”¨ç¨‹åºçš„é…ç½®ä¿¡æ¯ã€‚è¯¥å‚æ•°éœ€é…åˆä¸€ä¸ªé€‰é¡¹æ¥æŒ‡å®šæ‰“å°çš„é…ç½®èŒƒå›´ï¼š

*   jobï¼šæ‰“å°ä¸šåŠ¡ä»£ç çš„é…ç½®
*   hydraï¼šæ‰“å°hydraæ¡†æ¶è‡ªèº«çš„é…ç½®
*   allï¼šæ‰“å°å®Œæ•´é…ç½®å†…å®¹ï¼Œå³ä¸šåŠ¡é…ç½®ä¸hydraé…ç½®çš„åˆé›†

ä»…æ‰“å°ä¸šåŠ¡é…ç½®æŒ‡ä»¤å¦‚ä¸‹ï¼š

    $ python my_app.py --cfg job
    

è‹¥åªå±•ç¤ºé…ç½®ä¸­çš„æŸä¸€å­é›†ï¼Œå¯æ­é…å‚æ•°`--package`æˆ–ç®€å†™`-p`ä½¿ç”¨ï¼š

    python my_app.py --cfg hydra --package hydra.job
    

é»˜è®¤æƒ…å†µä¸‹ï¼Œé…ç½®ä¸­çš„æ’å€¼è¡¨è¾¾å¼ä¸ä¼šè¢«è§£æã€‚è‹¥éœ€æ‰“å°è§£æåçš„æœ€ç»ˆé…ç½®ï¼Œå¯åœ¨`--cfg`å‚æ•°åŸºç¡€ä¸Šï¼Œé¢å¤–æ·»åŠ `--resolve`å‚æ•°ã€‚

**ä¿¡æ¯æŸ¥è¯¢åŠŸèƒ½**

ä½¿ç”¨`--info`å‚æ•°å¯æŸ¥è¯¢Hydraæ¡†æ¶åŠåº”ç”¨ç¨‹åºçš„å„ç±»ç›¸å…³ä¿¡æ¯ï¼š

*   \--info allï¼šé»˜è®¤æ¨¡å¼ï¼Œæ‰“å°æ‰€æœ‰å¯ç”¨ä¿¡æ¯
*   \--info configï¼šæ‰“å°é…ç½®ç»„åˆç›¸å…³çš„è¾…åŠ©ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šé…ç½®æœç´¢è·¯å¾„ã€é»˜è®¤é…ç½®æ ‘ã€é»˜è®¤é…ç½®åˆ—è¡¨åŠæœ€ç»ˆç”Ÿæ•ˆçš„é…ç½®å†…å®¹
*   \--info defaultsï¼šæ‰“å°æœ€ç»ˆçš„é»˜è®¤é…ç½®åˆ—è¡¨
*   \--info defaults-treeï¼šæ‰“å°é»˜è®¤é…ç½®æ ‘ç»“æ„
*   \--info pluginsï¼šæ‰“å°å·²å®‰è£…çš„æ’ä»¶ä¿¡æ¯

2 ç»“æ„åŒ–é…ç½®
=======

åœ¨å¤æ‚é¡¹ç›®ä¸­ï¼Œé…ç½®æ–‡ä»¶å¸¸é¢ä¸´ç±»å‹æ¨¡ç³Šã€é…ç½®é”™è¯¯éš¾æ’æŸ¥ã€ç¼ºå°‘é™æ€æ ¡éªŒç­‰é—®é¢˜ã€‚ä¾‹å¦‚ï¼šå­—æ®µç±»å‹ä¸æ˜ç¡®æ˜“å¼•å‘è¿è¡Œæ—¶å¼‚å¸¸ã€å¤šå±‚çº§é…ç½®çš„ç»“æ„ä¸€è‡´æ€§éš¾ä»¥ä¿éšœã€åä½œæ—¶éš¾ä»¥é€šè¿‡å·¥å…·æå‰å‘ç°é…ç½®å†²çªã€‚

![https://github.com/facebookresearch/hydra/blob/main/website/static/img/undraw_product_teardown_hydra_plain.svg](https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/CSDN/%5Bpython%5D%20%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86%E6%A1%86%E6%9E%B6Hydra%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8C%97/imgs/img3.svg)

ä¸ºæ­¤ï¼ŒHydraåŸºäºPythonæ•°æ®ç±»ï¼ˆdataclassesï¼‰å®šä¹‰äº†é…ç½®ç»“æ„ä¸ç±»å‹ï¼Œå…¶æ ¸å¿ƒä»·å€¼åœ¨äºæä¾›è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ä¸é™æ€ç±»å‹æ£€æŸ¥åŒé‡ä¿éšœã€‚å®ƒæ”¯æŒåŸºç¡€ç±»å‹ï¼ˆintã€strã€boolã€floatã€Enum ç­‰ï¼‰ã€åµŒå¥—ç»“æ„ã€å®¹å™¨ç±»å‹ï¼ˆListã€Dictï¼‰ä»¥åŠå¯é€‰å­—æ®µï¼Œä½†ä¹Ÿå­˜åœ¨éƒ¨åˆ†é™åˆ¶ï¼Œä¾‹å¦‚ä»…éƒ¨åˆ†æ”¯æŒè”åˆç±»å‹ï¼Œä¸”ä¸æ”¯æŒè‡ªå®šä¹‰æ–¹æ³•ã€‚

Hydraä¸­ç»“æ„åŒ–é…ç½®ä¸»è¦æœ‰ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼Œå‡å®Œæ•´ä¿ç•™å…¶æ ¸å¿ƒåŠŸèƒ½ï¼š

1.  ç›´æ¥ä½œä¸ºé…ç½®ä½¿ç”¨ï¼ˆæ›¿ä»£é…ç½®æ–‡ä»¶ï¼‰ï¼Œé€‚åˆå¿«é€Ÿå…¥é—¨ï¼›
2.  ä½œä¸ºé…ç½®æ¨¡å¼ï¼ˆschemaï¼‰ä½¿ç”¨ï¼Œç”¨äºæ ¡éªŒç°æœ‰é…ç½®æ–‡ä»¶ï¼Œé€‚åˆå¤§å‹æˆ–åä½œé¡¹ç›®ã€‚

æœ¬æ•™ç¨‹å°†æŒ‰æ­¤é¡ºåºä¾æ¬¡è¯¦è§£ä¸¤ç§æ¨¡å¼ã€‚

2.1 Hydraä»£ç é…ç½®
-------------

åœ¨åç»­çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ConfigStoreç±»æŠŠæ•°æ®ç±»ï¼ˆdataclassesï¼‰æ³¨å†Œä¸ºHydraä¸­çš„è¾“å…¥é…ç½®ã€‚ConfigStoreæ˜¯ä¸€ä¸ªåœ¨å†…å­˜ä¸­å­˜å‚¨é…ç½®çš„å•ä¾‹ï¼ˆsingletonï¼‰å¯¹è±¡ï¼Œä¸å®ƒäº¤äº’çš„æ ¸å¿ƒAPIæ˜¯ä¸‹æ–‡å°†è¦ä»‹ç»çš„storeæ–¹æ³•ã€‚

    class ConfigStore(metaclass=Singleton):
        def store(
            self,
            name: str,
            node: Any,
            group: Optional[str] = None,
            package: Optional[str] = "_group_",
            provider: Optional[str] = None,
        ) -> None:
            """
            å°†é…ç½®èŠ‚ç‚¹å­˜å‚¨è‡³é…ç½®ä»“åº“ä¸­
            :param name: é…ç½®åç§°
            :param node: é…ç½®èŠ‚ç‚¹ï¼Œæ”¯æŒ DictConfigã€ListConfigã€
                ç»“æ„åŒ–é…ç½®ï¼ˆStructured configsï¼‰ï¼Œç”šè‡³æ™®é€šçš„ dict å’Œ list ç±»å‹
            :param group: é…ç½®åˆ†ç»„ï¼Œå­åˆ†ç»„åˆ†éš”ç¬¦ä¸º '/'ï¼Œ
                ä¾‹å¦‚ hydra/launcher
            :param package: é…ç½®èŠ‚ç‚¹çš„çˆ¶çº§å±‚çº§ç»“æ„ã€‚
                å­èŠ‚ç‚¹åˆ†éš”ç¬¦ä¸º '.'ï¼Œä¾‹å¦‚ foo.bar.baz
            :param provider: æä¾›è¯¥é…ç½®çš„æ¨¡å—/åº”ç”¨åç§°ï¼Œ
                æœ‰åŠ©äºè°ƒè¯•æ’æŸ¥é—®é¢˜ã€‚
            """
        ...
    

ConfigStoreå…·å¤‡ä¸YAMLè¾“å…¥é…ç½®å®Œå…¨ä¸€è‡´çš„åŠŸèƒ½ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æä¾›ç±»å‹æ ¡éªŒèƒ½åŠ›ã€‚å®ƒæ—¢å¯å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä¸YAMLé…åˆä½¿ç”¨ã€‚

**åŸºç¡€ç”¨ä¾‹**

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä¸”å­˜åœ¨ä¸€ä¸ªåŒ…å«cnné€‰é¡¹çš„modelé…ç½®åˆ†ç»„ï¼š

    from omegaconf import DictConfig, OmegaConf
    import hydra
    
    @hydra.main(version_base=None, config_path="conf", config_name="model/cnn")
    def my_app(cfg: DictConfig) -> None:
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        my_app()
    

ç›®å½•ç»“æ„ï¼š

    â”œâ”€ conf
    â”‚  â””â”€ model
    â”‚      â””â”€ cnn.yaml
    â””â”€â”€ my_app.py
    

model/cnn.yamlï¼š

    backbone: resnet50
    learning_rate: 0.001
    batch_size: 32
    epochs: 20
    dropout: 0.2
    

å¦‚æœç°åœ¨æƒ³è¦æ–°å¢ä¸€ä¸ªtransformeré€‰é¡¹è¯¥æ€ä¹ˆåšï¼Ÿæˆ‘ä»¬å¯ä»¥ç›´æ¥æ–°å¢`model/transformer.yaml`é…ç½®åˆ†ç»„æ–‡ä»¶ï¼Œä½†è¿™å¹¶éå”¯ä¸€æ–¹å¼ï¼ä¹Ÿå¯ä»¥é€šè¿‡ConfigStoreä¸ºHydraæ–°å¢modelé…ç½®åˆ†ç»„çš„transformeré€‰é¡¹ã€‚

è¦å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œåªéœ€åœ¨ä¸Šè¿°ä»£ç æ–‡ä»¶ä¸­æ·»åŠ å‡ è¡Œä»£ç ï¼š

    from dataclasses import dataclass
    import hydra
    from omegaconf import DictConfig, OmegaConf
    from hydra.core.config_store import ConfigStore
    @dataclass
    class TransformerConfig:
        optimizer: str = "sgd"
        lr: float = 0.0005
        hidden_dim: int = 256
    
    cs = ConfigStore.instance()
    # å°†åä¸ºtransformerçš„é…ç½®ç±»æ³¨å†Œè‡³modelé…ç½®åˆ†ç»„
    # æ³¨æ„å‡ºç°å®ä½“æ–‡ä»¶ä¼šæŠ¥é”™
    cs.store(name="transformer", group="model", node=TransformerConfig)
    
    @hydra.main(version_base=None, config_path="conf")
    def my_app(cfg: DictConfig) -> None:
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        my_app()
    

ä¸Šè¿°ä»£ç ä¸ä¼šç”Ÿæˆå®é™…çš„ç‰©ç†é…ç½®æ–‡ä»¶ï¼Œå®ƒä»…ç”¨äºåœ¨å†…å­˜ä¸­æ³¨å†Œé…ç½®ç±»ã€‚ç°åœ¨åº”ç”¨ç¨‹åºå·²ç»èƒ½å¤Ÿè¯†åˆ«modelé…ç½®ç»„ä¸­çš„ä¸¤ä¸ªé€‰é¡¹ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿è¡Œç¨‹åºæ¥éªŒè¯æ•ˆæœï¼š

    python my_app.py +model=cnn
    

æˆ–

    python my_app.py +model=transformer
    

åœ¨æ·±åº¦å­¦ä¹ å®éªŒä¸­ç®¡ç†å¤šä¸ªæ¨¡å‹é…ç½®æ—¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å€ŸåŠ©ConfigStoreæ”¯æŒçš„ä¸‰ç§æ³¨å†Œæ–¹å¼çµæ´»æ§åˆ¶é…ç½®èŠ‚ç‚¹ï¼Œå®ç°ä¸åŒæ–¹æ¡ˆé—´çš„å¿«é€Ÿåˆ‡æ¢ï¼š

    from dataclasses import dataclass
    import hydra
    from omegaconf import DictConfig, OmegaConf
    from hydra.core.config_store import ConfigStore
    
    @dataclass
    class TransformerConfig:
        optimizer: str = "sgd"
        lr: float = 0.0005
        hidden_dim: int = 256
    
    cs = ConfigStore.instance()
    
    # ç›´æ¥ä½¿ç”¨ç±»ç±»å‹
    cs.store(name="config1", node=TransformerConfig)
    # ä½¿ç”¨ç±»å®ä¾‹ï¼ˆè¦†ç›–éƒ¨åˆ†é»˜è®¤å€¼ï¼‰
    cs.store(name="config2", node=TransformerConfig(optimizer="rmsprop", lr=0.002))
    # ä½¿ç”¨å­—å…¸ï¼ˆä¼šå¤±å»è¿è¡Œæ—¶ç±»å‹å®‰å…¨ä¿éšœï¼‰
    cs.store(name="config3", node={"optimizer": "adam", "lr": 0.003, "hidden_dim": 256})
    
    # 3. Hydraä¸»å‡½æ•°ï¼šåŠ è½½å¹¶æ‰“å°é…ç½®
    @hydra.main(version_base=None, config_name="config1")  # é»˜è®¤åŠ è½½config1
    def main(cfg: DictConfig) -> None:
        print("å½“å‰åŠ è½½çš„é…ç½®å†…å®¹ï¼š")
        print(cfg)  
    
    if __name__ == "__main__":
        main()
    

**é…ç½®ç»„**

åœ¨Hydraæ¡†æ¶ä¸­ï¼Œé…ç½®ç»„æ˜¯ä¸€ç§ç”¨äºç»„ç»‡äº’æ–¥ä½†ç›¸å…³é…ç½®é¡¹çš„æœºåˆ¶ã€‚ä»¥æ·±åº¦å­¦ä¹ åœºæ™¯ä¸ºä¾‹ï¼Œè®­ç»ƒCNNä¸Transformerå±äºä¸åŒçš„æ¨¡å‹é…ç½®ï¼Œå®ƒä»¬éƒ½å±äºæ¨¡å‹é…ç½®è¿™ä¸€å¤§ç±»ï¼Œä½†ä¸€æ¬¡è®­ç»ƒåªèƒ½é€‰æ‹©å…¶ä¸­ä¸€ç§ï¼Œè¿™å°±æ˜¯é…ç½®ç»„çš„å…¸å‹åº”ç”¨ã€‚

    # å¯¼å…¥å¿…è¦çš„åº“
    from dataclasses import dataclass 
    from typing import Any           
    import hydra                   
    from hydra.core.config_store import ConfigStore 
    from omegaconf import OmegaConf  
    
    # 1. å®šä¹‰CNNæ¨¡å‹çš„é…ç½®
    @dataclass  # è£…é¥°å™¨ï¼šå°†æ™®é€šç±»è½¬ä¸ºç»“æ„åŒ–é…ç½®ç±»ï¼ˆè‡ªåŠ¨ç”Ÿæˆåˆå§‹åŒ–ã€æ¯”è¾ƒç­‰æ–¹æ³•ï¼‰
    class CNNConfig:
        """CNNæ¨¡å‹çš„è®­ç»ƒé…ç½®ï¼ˆåŒ…å«è¯¥æ¨¡å‹ç‰¹æœ‰çš„æ‰€æœ‰å‚æ•°ï¼‰"""
        model_type: str = "cnn"      
        batch_size: int = 32          
        learning_rate: float = 0.001  
    
    # 2. å®šä¹‰Transformeræ¨¡å‹çš„é…ç½®
    @dataclass
    class TransformerConfig:
        """Transformeræ¨¡å‹çš„è®­ç»ƒé…ç½®ï¼ˆåŒ…å«è¯¥æ¨¡å‹ç‰¹æœ‰çš„æ‰€æœ‰å‚æ•°ï¼‰"""
        model_type: str = "transformer" 
        batch_size: int = 16            
        learning_rate: float = 0.0001  
        num_heads: int = 8         
     
    @dataclass
    class Config:
        """æ•´ä¸ªè®­ç»ƒç¨‹åºçš„ä¸»é…ç½®ç±»"""
        # modelå­—æ®µï¼šç”¨äºæ¥æ”¶é…ç½®ç»„ä¸­é€‰æ‹©çš„æ¨¡å‹é…ç½®ï¼ˆæš‚æ—¶æ ‡æ³¨ä¸ºAnyç±»å‹ï¼‰
        model: Any
    
    # 1. è·å–é…ç½®å­˜å‚¨åº“çš„å•ä¾‹å®ä¾‹ï¼ˆæ•´ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªConfigStoreï¼‰
    cs = ConfigStore.instance()
    
    # 2. æ³¨å†Œä¸»é…ç½®ï¼ˆåç§°ä¸º"config"ï¼Œå¯¹åº”åç»­hydra.mainçš„config_nameï¼‰
    cs.store(name="config", node=Config)
    
    # 3. æ³¨å†Œé…ç½®ç»„ï¼šç»„åæ˜¯"model"ï¼ŒåŒ…å«ä¸¤ä¸ªé€‰é¡¹ï¼š
    cs.store(group="model", name="cnn", node=CNNConfig)
    cs.store(group="model", name="transformer", node=TransformerConfig)
    
    # hydra.mainè£…é¥°å™¨ï¼šæ ‡è®°ç¨‹åºå…¥å£ï¼ŒæŒ‡å®šé…ç½®åç§°ä¸º"config"
    @hydra.main(version_base=None, config_name="config")
    def train_model(cfg: Config) -> None:
        """æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„ä¸»å‡½æ•°"""
        print("===== å½“å‰ä½¿ç”¨çš„è®­ç»ƒé…ç½® =====")
        print(OmegaConf.to_yaml(cfg))
    
    # ç¨‹åºå¯åŠ¨å…¥å£
    if __name__ == "__main__":
        train_model()
    

ä»£ç è¿è¡Œç›´æ¥è¾“å‡ºä¸ºï¼š

    model: ???
    

??? è¡¨ç¤ºï¼šè¯¥å­—æ®µæœ¬åº”æœ‰å€¼ï¼Œä½†ç›®å‰å¤„äºç¼ºå¤±çŠ¶æ€ã€‚ç”±äºæˆ‘ä»¬æœªç»™æ¨¡å‹é…ç½®ç»„è®¾ç½®é»˜è®¤å€¼ï¼Œå› æ­¤å¿…é¡»é€šè¿‡å‘½ä»¤è¡Œæ˜¾å¼æŒ‡å®šè¦ä½¿ç”¨çš„æ¨¡å‹é…ç½®ã€‚æ³¨æ„å‘½ä»¤ä¸­çš„+æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºæ¨¡å‹é…ç½®ç»„æ²¡æœ‰é»˜è®¤å€¼ï¼Œ+åœ¨è¿™é‡Œè¡¨ç¤ºæ·»åŠ å¹¶è¦†ç›–è¯¥é…ç½®å­—æ®µï¼š

    python my_app.py +model=cnn
    

åœ¨ä¸Šé¢å®ç°ä¸­ï¼Œmodelå­—æ®µè¢«æ ‡æ³¨ä¸ºAnyç±»å‹ï¼Œè¿™è™½ç„¶ä¸ä¼šé˜»ç¢ç¨‹åºè¿è¡Œï¼Œä½†å´æŠŠé…ç½®å¯¹è±¡å½“ä½œä¸€ä¸ªç¼ºä¹ç±»å‹ä¿¡æ¯çš„é»‘ç®±å­—å…¸ï¼Œä½¿å¾—IDEæ— æ³•æä¾›æ™ºèƒ½æç¤ºï¼Œé™æ€ç±»å‹æ£€æŸ¥ä¹Ÿå®Œå…¨å¤±æ•ˆï¼Œä»è€Œé™ä½äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œé•¿æœŸå¯é æ€§ã€‚è¦è§£å†³è¿™ä¸€é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æ˜¯å°†ä¸åŒæ¨¡å‹é…ç½®ä¹‹é—´çš„å…¬å…±å­—æ®µè¿›è¡ŒæŠ½è±¡ï¼Œåˆ›å»ºä¸€ä¸ªBaseModelConfigåŸºç¡€é…ç½®ç±»ï¼š

    from dataclasses import dataclass
    from typing import Any
    import hydra
    from omegaconf import MISSING  # æ ‡è®°å­—æ®µâ€œæ— é»˜è®¤å€¼â€
    from hydra.core.config_store import ConfigStore 
    from omegaconf import OmegaConf  
    
    @dataclass
    class BaseModelConfig:
        """æ‰€æœ‰æ·±åº¦å­¦ä¹ æ¨¡å‹çš„åŸºç¡€é…ç½®ï¼ˆæŠ½ç¦»å…¬å…±å­—æ®µï¼‰"""
        model_type: str = MISSING       # æ¨¡å‹ç±»å‹ï¼šæ— é»˜è®¤å€¼ï¼ˆå¿…é¡»ç”±å­ç±»æŒ‡å®šï¼‰
        batch_size: int = 32            # å…¬å…±å­—æ®µï¼šé»˜è®¤æ‰¹æ¬¡å¤§å°ï¼ˆå­ç±»å¯é‡å†™ï¼‰
        learning_rate: float = 0.001    # å…¬å…±å­—æ®µï¼šé»˜è®¤å­¦ä¹ ç‡ï¼ˆå­ç±»å¯é‡å†™ï¼‰
    
    # 1. å®šä¹‰CNNæ¨¡å‹çš„é…ç½®
    @dataclass  # è£…é¥°å™¨ï¼šå°†æ™®é€šç±»è½¬ä¸ºç»“æ„åŒ–é…ç½®ç±»ï¼ˆè‡ªåŠ¨ç”Ÿæˆåˆå§‹åŒ–ã€æ¯”è¾ƒç­‰æ–¹æ³•ï¼‰
    class CNNConfig(BaseModelConfig):
        """CNNæ¨¡å‹çš„è®­ç»ƒé…ç½®ï¼ˆåŒ…å«è¯¥æ¨¡å‹ç‰¹æœ‰çš„æ‰€æœ‰å‚æ•°ï¼‰"""
        model_type: str = "cnn"      
        batch_size: int = 32          
        learning_rate: float = 0.001  
    
    # 2. å®šä¹‰Transformeræ¨¡å‹çš„é…ç½®
    @dataclass
    class TransformerConfig(BaseModelConfig):
        """Transformeræ¨¡å‹çš„è®­ç»ƒé…ç½®ï¼ˆåŒ…å«è¯¥æ¨¡å‹ç‰¹æœ‰çš„æ‰€æœ‰å‚æ•°ï¼‰"""
        model_type: str = "transformer" 
        batch_size: int = 16            
        learning_rate: float = 0.0001   
        num_heads: int = 8         
    
    @dataclass
    class Config:
        """æ•´ä¸ªè®­ç»ƒç¨‹åºçš„ä¸»é…ç½®ç±»"""
        # ä¸å†æ˜¯Anyï¼Œè€Œæ˜¯BaseModelConfig
        model: BaseModelConfig
    
    # 1. è·å–é…ç½®å­˜å‚¨åº“çš„å•ä¾‹å®ä¾‹ï¼ˆæ•´ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ªConfigStoreï¼‰
    cs = ConfigStore.instance()
    
    # 2. æ³¨å†Œä¸»é…ç½®ï¼ˆåç§°ä¸º"config"ï¼Œå¯¹åº”åç»­hydra.mainçš„config_nameï¼‰
    cs.store(name="config", node=Config)
    
    # 3. æ³¨å†Œé…ç½®ç»„ï¼šç»„åæ˜¯"model"ï¼ŒåŒ…å«ä¸¤ä¸ªé€‰é¡¹ï¼š
    cs.store(group="model", name="cnn", node=CNNConfig)
    cs.store(group="model", name="transformer", node=TransformerConfig)
    
    # hydra.mainè£…é¥°å™¨ï¼šæ ‡è®°ç¨‹åºå…¥å£ï¼ŒæŒ‡å®šé…ç½®åç§°ä¸º"config"
    @hydra.main(version_base=None, config_name="config")
    def train_model(cfg: Config) -> None:
        """æ·±åº¦å­¦ä¹ æ¨¡å‹è®­ç»ƒçš„ä¸»å‡½æ•°"""
        print("===== å½“å‰ä½¿ç”¨çš„è®­ç»ƒé…ç½® =====")
        print(OmegaConf.to_yaml(cfg))
    
    # ç¨‹åºå¯åŠ¨å…¥å£
    if __name__ == "__main__":
        train_model()
    

å¯ä»¥åœ¨ä¸»ç»“æ„åŒ–é…ç½®ä¸­è®¾ç½®é»˜è®¤å€¼ï¼Œæ–¹æ³•ä¸åœ¨config.yamlé…ç½®æ–‡ä»¶ä¸­å®šä¹‰ç›¸ä¼¼ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªæ·±åº¦å­¦ä¹ æ¨¡å‹é…ç½®çš„ç¤ºä¾‹ï¼Œæ–°å¢äº†é»˜è®¤é…ç½®åˆ—è¡¨ï¼Œä½¿å…¶é»˜è®¤åŠ è½½model=cnnã€‚åªéœ€åœ¨ä»£ç ä¸­æ·»åŠ é»˜è®¤åˆ—è¡¨ï¼Œå¹¶ç›¸åº”ä¿®æ”¹é…ç½®ç±»å³å¯ï¼š

    from dataclasses import dataclass, field
    from typing import Any, List       
    
    # å®šä¹‰é»˜è®¤é…ç½®åˆ—è¡¨ï¼šä»é…ç½®ç»„"model"ä¸­åŠ è½½åä¸º"cnn"çš„é…ç½®
    defaults = [
        {"model": "cnn"}
        # è®¾ä¸º MISSINGï¼Œåˆ™å¯å¼ºåˆ¶ç”¨æˆ·åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šè¯¥å‚æ•°çš„å€¼ã€‚
        # {"model": MISSING}
    ]
    
    @dataclass
    class Config:
        """æ•´ä¸ªè®­ç»ƒç¨‹åºçš„ä¸»é…ç½®ç±»"""
        # å—@dataclassé™åˆ¶ï¼Œæ­¤å¤„éœ€é€šè¿‡fieldå®šä¹‰é»˜è®¤é…ç½®åˆ—è¡¨ï¼ˆé»˜è®¤åŠ è½½cnné…ç½®ï¼‰
        defaults: List[Any] = field(default_factory=lambda: defaults)
        # Hydraä¼šæ ¹æ®é»˜è®¤é…ç½®åˆ—è¡¨è‡ªåŠ¨å¡«å……è¯¥å­—æ®µï¼Œç±»å‹ä¸ºBaseModelConfig
        model: BaseModelConfig = MISSING
    

ä½ ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œè¦†ç›–é»˜è®¤é…ç½®ï¼ŒæŒ‡å®šä½¿ç”¨Transformeræ¨¡å‹ï¼Œæ³¨æ„ä¸è¦+å·ï¼Œå› ä¸ºè¿™æ˜¯è¦†ç›–æ“ä½œï¼š

    python my_app.py model=transformer
    

2.2 é…ç½®æ¨¡å¼
--------

Hydraçš„ç»“æ„åŒ–é…ç½®æœ¬è´¨æ˜¯ç”¨ä»£ç å®šä¹‰çš„ç»“æ„åŒ–è§„åˆ™æ¥ç®¡ç†é…ç½®ã€‚å®ƒé™¤äº†å¯ä»¥ç”¨ä»£ç å®šä¹‰çš„ç»“æ„åŒ–é…ç½®æ›¿ä»£ä¼ ç»Ÿçš„YAMLé…ç½®æ–‡ä»¶å¤–ï¼Œè¿˜èƒ½å°†ç»“æ„åŒ–é…ç½®ä½œä¸ºé…ç½®è§„åˆ™æ¨¡æ¿ï¼ˆSchemaï¼‰ï¼Œç”¨äºæ ¡éªŒå·²æœ‰YAMLé…ç½®æ–‡ä»¶æ˜¯å¦ç¬¦åˆè§„èŒƒã€‚Schemaèƒ½å¤Ÿåœ¨ç¨‹åºå¯åŠ¨æ—¶æ ¡éªŒé…ç½®çš„åˆæ³•æ€§ï¼Œæå‰æ‹¦æˆªæ‰€æœ‰é…ç½®é”™è¯¯ã€‚è¿™å¯¹äºä¿éšœå¤§å‹é¡¹ç›®çš„ç¨³å®šæ€§è‡³å…³é‡è¦ï¼Œå°¤å…¶é€‚åˆå¤šäººåä½œçš„åœºæ™¯ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…é…ç½®é”™å†™ã€æ¼å†™å­—æ®µç­‰é—®é¢˜ã€‚

**åŒä¸€é…ç½®ç»„å†…çš„Schemaæ ¡éªŒ**

ä»¥æ·±åº¦å­¦ä¹ è®­ç»ƒåœºæ™¯çš„æ¨¡å‹é…ç½®ä¸ºä¾‹ï¼Œä¸‹æ–‡å°†æ‹†è§£å¦‚ä½•é€šè¿‡é¢„è®¾çš„Schemaæ¨¡æ¿ï¼Œæ ¡éªŒåŒä¸€é…ç½®åˆ†ç»„ä¸‹å„é…ç½®æ–‡ä»¶çš„å­—æ®µã€ç±»å‹ç­‰æ˜¯å¦ç¬¦åˆè§„èŒƒè¦æ±‚ã€‚

ç»™å®šå¦‚ä¸‹é…ç½®ç›®å½•ç»“æ„ï¼š

    conf/
    â”œâ”€â”€ config.yaml          # ä¸»é…ç½®ï¼ˆåŒ…å«è®­ç»ƒã€æ¨¡å‹ã€æ•°æ®ç­‰ï¼‰
    â””â”€â”€ model                # æ¨¡å‹é…ç½®ç»„
        â”œâ”€â”€ resnet.yaml      # ResNetæ¨¡å‹é…ç½®
        â””â”€â”€ transformer.yaml # Transformeræ¨¡å‹é…ç½®
    

éœ€ä¸ºä¸Šè¿°æ¯ä¸ªé…ç½®æ–‡ä»¶æ·»åŠ ç»“æ„åŒ–é…ç½®Schemaï¼Œæ ¸å¿ƒæ–¹å¼æ˜¯åœ¨YAMLæ–‡ä»¶çš„defaultsåˆ—è¡¨ä¸­å£°æ˜è¦ç»§æ‰¿çš„Schemaæ¨¡æ¿ï¼Œå¹¶å°†è¿™äº›Schemaä»¥base\_configã€model/resnet.yamlã€model/transformer.yamlä¸ºåæ³¨å†Œè‡³Hydraé…ç½®ä»“åº“ã€‚å„é…ç½®æ–‡ä»¶çš„defaultsåˆ—è¡¨é…ç½®å¦‚ä¸‹ï¼š

config.yamlï¼š

    defaults:
      - base_config          # ç»§æ‰¿åŸºç¡€é…ç½®Schema
      - model: resnet        # é»˜è®¤ä½¿ç”¨ResNetæ¨¡å‹é…ç½®
      - _self_               # è‡ªèº«é…ç½®è¦†ç›–é»˜è®¤å€¼
    
    # è‡ªå®šä¹‰è®­ç»ƒå‚æ•°
    train:
      batch_size: 32
      lr: 0.001
    debug: true
    

model/resnet.yamlï¼š

    defaults:
      - base_resnet  # ç»§æ‰¿ResNetåŸºç¡€Schema
    
    # ResNetä¸“å±å‚æ•°
    layers: 50
    pretrained: true
    num_classes: 1000
    

model/transformer.yamlï¼š

    defaults:
      - base_transformer  # ç»§æ‰¿TransformeråŸºç¡€Schema
    
    # Transformerä¸“å±å‚æ•°
    num_heads: 8
    num_layers: 6
    hidden_dim: 512
    max_seq_len: 512
    

é€šè¿‡Python dataclasså®šä¹‰å„ç§Schemaè§„åˆ™ï¼Œå¹¶æ³¨å†Œåˆ°Hydraé…ç½®ä»“åº“ï¼Œä½¿YAMLé…ç½®æ–‡ä»¶å¯å…³è”åˆ°å¯¹åº”çš„æ ¡éªŒè§„åˆ™ï¼š

    from dataclasses import dataclass
    from omegaconf import OmegaConf, MISSING
    import hydra
    from hydra.core.config_store import ConfigStore
    
    # -------------------------- åŸºç¡€Schemaå®šä¹‰ --------------------------
    @dataclass
    class BaseModelConfig:
        """æ‰€æœ‰æ¨¡å‹çš„åŸºç¡€é…ç½®Schema"""
        model_type: str = MISSING  # å¿…é€‰å­—æ®µï¼Œæ— é»˜è®¤å€¼
        device: str = "cuda"       # å¯é€‰å­—æ®µï¼Œé»˜è®¤å€¼cuda
        dropout: float = MISSING   # å¿…é€‰å­—æ®µï¼Œæ— é»˜è®¤å€¼
    
    @dataclass
    class ResNetConfig(BaseModelConfig):
        """ResNetæ¨¡å‹ä¸“å±Schemaï¼ˆç»§æ‰¿åŸºç¡€æ¨¡å‹é…ç½®ï¼‰"""
        model_type: str = "resnet"  # å›ºå®šå€¼ï¼Œæ ‡è¯†æ¨¡å‹ç±»å‹
        dropout: float = 0.1        # è¦†ç›–é»˜è®¤å€¼
        layers: int = MISSING       # ResNetä¸“å±å¿…é€‰å­—æ®µ
        pretrained: bool = MISSING
        num_classes: int = MISSING
    
    @dataclass
    class TransformerConfig(BaseModelConfig):
        """Transformeræ¨¡å‹ä¸“å±Schemaï¼ˆç»§æ‰¿åŸºç¡€æ¨¡å‹é…ç½®ï¼‰"""
        model_type: str = "transformer"  # å›ºå®šå€¼
        dropout: float = 0.1             # è¦†ç›–é»˜è®¤å€¼
        num_heads: int = MISSING         # Transformerä¸“å±å¿…é€‰å­—æ®µ
        num_layers: int = MISSING
        hidden_dim: int = MISSING
        max_seq_len: int = MISSING
    
    @dataclass
    class TrainConfig:
        """è®­ç»ƒé…ç½®Schema"""
        batch_size: int = MISSING
        lr: float = MISSING
        epochs: int = 10  # é»˜è®¤è®­ç»ƒ10è½®
    
    @dataclass
    class Config:
        """æ•´ä½“é…ç½®Schema"""
        model: BaseModelConfig = MISSING  # æ¨¡å‹é…ç½®ï¼ˆå¿…é€‰ï¼‰
        train: TrainConfig = MISSING     # è®­ç»ƒé…ç½®ï¼ˆå¿…é€‰ï¼‰
        debug: bool = False              # è°ƒè¯•æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
    
    # -------------------------- æ³¨å†ŒSchemaåˆ°é…ç½®ä»“åº“ --------------------------
    cs = ConfigStore.instance()
    cs.store(name="base_config", node=Config)  # æ³¨å†Œä¸»é…ç½®Schema
    cs.store(group="model", name="base_resnet", node=ResNetConfig)  # æ³¨å†ŒResNet Schema
    cs.store(group="model", name="base_transformer", node=TransformerConfig)  # æ³¨å†ŒTransformer Schema
    
    # -------------------------- ä¸»å‡½æ•° --------------------------
    @hydra.main(version_base=None, config_path="conf", config_name="config")
    def train_app(cfg: Config) -> None:
        """æ·±åº¦å­¦ä¹ è®­ç»ƒå…¥å£ï¼Œæ‰“å°æœ€ç»ˆé…ç½®"""
        print("æœ€ç»ˆè®­ç»ƒé…ç½®ï¼š")
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        train_app()
    

è¿è¡Œä»£ç æ—¶ï¼ŒHydraä¼šå…ˆåŠ è½½YAMLé…ç½®æ–‡ä»¶ï¼Œå†é€šè¿‡å…³è”çš„Schemaå®Œæˆåˆæ³•æ€§æ ¡éªŒï¼Œè‹¥é…ç½®å­˜åœ¨é”™è¯¯ä¼šç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼š

    # æ­£å¸¸è¿è¡Œï¼ˆä½¿ç”¨é»˜è®¤ResNeté…ç½®ï¼‰
    python my_app.py
    
    # æ¨¡æ‹Ÿé…ç½®é”™è¯¯ï¼ˆlayerså­—æ®µåº”ä¸ºintç±»å‹ï¼Œä¼ å…¥å­—ç¬¦ä¸²è§¦å‘æ ¡éªŒå¤±è´¥ï¼‰
    python my_app.py model.layers='attention' 
    

**è·¨é…ç½®ç»„çš„Schemaæ ¡éªŒ**

åœ¨å‰æ–‡çš„æ¨¡å‹è®­ç»ƒåœºæ™¯ä¸­ï¼ŒSchemaéƒ½å®šä¹‰åœ¨ä¸»ç¨‹åºé‡Œã€‚ä½†å®é™…å¼€å‘ä¸­ï¼Œå¸¸ä¼šé‡åˆ°ç¬¬ä¸‰æ–¹åº“æä¾›æ ‡å‡†åŒ–çš„Schemaï¼Œæˆ‘ä»¬éœ€è¦è·¨é…ç½®ç»„å¼•ç”¨è¿™äº›Schemaæ¥æ ¡éªŒè‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œè€ŒéæŠŠæ‰€æœ‰Schemaéƒ½å†™åœ¨ä¸»ç¨‹åºä¸­ã€‚

å‡è®¾å­˜åœ¨ä¸€ä¸ªå…¬å…±çš„optimizer\_libåº“ï¼Œè¯¥åº“é¢„å…ˆå®šä¹‰äº†æ‰€æœ‰æ¨¡å‹çš„æ ‡å‡†Schemaå¹¶æ³¨å†Œåœ¨ç‹¬ç«‹é…ç½®ç»„ä¸­ï¼›æœ¬åœ°conf/optimizeré…ç½®ç»„ä¸‹çš„YAMLæ–‡ä»¶ï¼ˆå¦‚sgd.yamlã€adam.yamlï¼‰ä»…éœ€ç¼–å†™YAMLé…ç½®æ–‡ä»¶ï¼Œå¹¶å…³è”è¿™ä¸ªå¤–éƒ¨åº“çš„Schemaå®Œæˆæ ¡éªŒï¼Œæ— éœ€é‡å¤å®šä¹‰æ¨¡å‹è§„åˆ™ï¼Œé…ç½®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

    # é¡¹ç›®æ•´ä½“ç›®å½•
    â”œâ”€â”€ my_app.py               # ä¸»ç¨‹åº
    â”œâ”€â”€ optimizer_lib.py        # ç‹¬ç«‹çš„ä¼˜åŒ–å™¨Schemaåº“
    â””â”€â”€ conf/
        â”œâ”€â”€ config.yaml         # ä¸»é…ç½®
        â””â”€â”€ optimizer/          # æœ¬åœ°ä¼˜åŒ–å™¨é…ç½®ç»„
            â”œâ”€â”€ sgd.yaml        
            â””â”€â”€ adam.yaml       
    

optimizer\_lib.pyä»£ç å¦‚ä¸‹ï¼š

    from dataclasses import dataclass
    from omegaconf import MISSING
    from hydra.core.config_store import ConfigStore
    
    # -------------------------- ä¼˜åŒ–å™¨åŸºç¡€Schema --------------------------
    @dataclass
    class BaseOptimizerConfig:
        """æ‰€æœ‰ä¼˜åŒ–å™¨çš„åŸºç¡€Schemaï¼ˆç‹¬ç«‹åº“å®šä¹‰ï¼‰"""
        opt_type: str = MISSING    # å¿…é€‰å­—æ®µï¼šä¼˜åŒ–å™¨ç±»å‹
        lr: float = MISSING        # å¿…é€‰å­—æ®µï¼šå­¦ä¹ ç‡
        weight_decay: float = 0.0  # å¯é€‰å­—æ®µï¼šæƒé‡è¡°å‡ï¼Œé»˜è®¤0
    
    # -------------------------- å…·ä½“ä¼˜åŒ–å™¨Schema --------------------------
    @dataclass
    class SGDConfig(BaseOptimizerConfig):
        """SGDä¼˜åŒ–å™¨ä¸“å±Schema"""
        opt_type: str = "sgd"      # å›ºå®šæ ‡è¯†
        momentum: float = MISSING  # SGDä¸“å±å¿…é€‰å­—æ®µ
        nesterov: bool = False     # å¯é€‰å­—æ®µï¼šæ˜¯å¦ä½¿ç”¨NesterovåŠ¨é‡
    
    @dataclass
    class AdamConfig(BaseOptimizerConfig):
        """Adamä¼˜åŒ–å™¨ä¸“å±Schema"""
        opt_type: str = "adam"     # å›ºå®šæ ‡è¯†
        betas: tuple[float, float] = (0.9, 0.999)  # å¯é€‰å­—æ®µï¼šbetaå‚æ•°
        eps: float = MISSING                       # Adamä¸“å±å¿…é€‰å­—æ®µ
    
    # -------------------------- æ³¨å†Œè·¨é…ç½®ç»„çš„Schema --------------------------
    def register_optimizer_configs() -> None:
        cs = ConfigStore.instance()
        # æ³¨å†Œåˆ°ç‹¬ç«‹åˆ†ç»„ï¼šoptimizer_lib/optimizer
        cs.store(
            group="optimizer_lib/optimizer",
            name="sgd",
            node=SGDConfig
        )
        cs.store(
            group="optimizer_lib/optimizer",
            name="adam",
            node=AdamConfig
        )
    

ä¸»ç¨‹åºmy\_app.pyä¸­å®šä¹‰æ•´ä½“é…ç½®Schemaï¼Œå¹¶è°ƒç”¨optimizer\_libçš„æ³¨å†Œå‡½æ•°ï¼Œå°†è·¨é…ç½®ç»„çš„Schemaçº³å…¥Hydraé…ç½®ä»“åº“ï¼š

    from dataclasses import dataclass
    from omegaconf import MISSING, OmegaConf
    import hydra
    from hydra.core.config_store import ConfigStore
    import optimizer_lib  # å¯¼å…¥ç‹¬ç«‹çš„ä¼˜åŒ–å™¨åº“
    
    # -------------------------- æ•´ä½“é…ç½®Schema --------------------------
    @dataclass
    class TrainConfig:
        """è®­ç»ƒé…ç½®Schema"""
        batch_size: int = 32
        epochs: int = 10
    
    @dataclass
    class Config:
        """ä¸»é…ç½®Schema"""
        optimizer: optimizer_lib.BaseOptimizerConfig = MISSING  # å¼•ç”¨ç‹¬ç«‹åº“çš„Schema
        train: TrainConfig = MISSING
        debug: bool = False
    
    # -------------------------- æ³¨å†Œæœ¬åœ°Schemaå¹¶åŠ è½½è·¨ç»„Schema --------------------------
    cs = ConfigStore.instance()
    cs.store(name="base_config", node=Config)  # æ³¨å†Œä¸»é…ç½®Schema
    optimizer_lib.register_optimizer_configs()  # æ³¨å†Œè·¨é…ç½®ç»„çš„ä¼˜åŒ–å™¨Schema
    
    # -------------------------- ä¸»å‡½æ•° --------------------------
    @hydra.main(version_base=None, config_path="conf", config_name="config")
    def train_app(cfg: Config) -> None:
        """è®­ç»ƒå…¥å£ï¼Œæ‰“å°æœ€ç»ˆé…ç½®å¹¶è§¦å‘Schemaæ ¡éªŒ"""
        print("æœ€ç»ˆè®­ç»ƒé…ç½®ï¼ˆå«è·¨ç»„ä¼˜åŒ–å™¨é…ç½®ï¼‰ï¼š")
        print(OmegaConf.to_yaml(cfg))
    
    if __name__ == "__main__":
        train_app()
    

æœ¬åœ°conf/optimizerä¸‹çš„YAMLæ–‡ä»¶éœ€è¦é€šè¿‡ç»å¯¹è·¯å¾„å¼•ç”¨optimizer\_libä¸­çš„Schemaï¼Œå¹¶é€šè¿‡`@_here_`æŒ‡å®šåŒ…è·¯å¾„ï¼Œç¡®ä¿Schemaçš„æ ¡éªŒä½œç”¨åŸŸä¸å½“å‰é…ç½®ä¸€è‡´ã€‚

conf/optimizer/sgd.yamlï¼š

    defaults:
      - /optimizer_lib/optimizer/sgd@_here_  # ç»å¯¹è·¯å¾„å¼•ç”¨è·¨ç»„Schemaï¼Œ@_here_ç»Ÿä¸€åŒ…ä½œç”¨åŸŸ
    
    # SGDä¸“å±é…ç½®ï¼ˆéœ€ç¬¦åˆSGDConfigçš„Schemaè§„åˆ™ï¼‰
    lr: 0.01
    momentum: 0.9
    weight_decay: 0.0001
    

conf/optimizer/adam.yamlï¼š

    defaults:
      - /optimizer_lib/optimizer/adam@_here_  # ç»å¯¹è·¯å¾„å¼•ç”¨è·¨ç»„Schema
      - _self_  # è‡ªèº«é…ç½®è¦†ç›–Schemaé»˜è®¤å€¼ï¼ˆç»„åˆé¡ºåºï¼šSchemaå…ˆåŠ è½½ï¼Œè‡ªèº«é…ç½®åè¦†ç›–ï¼‰
    
    # Adamä¸“å±é…ç½®ï¼ˆéœ€ç¬¦åˆAdamConfigçš„Schemaè§„åˆ™ï¼‰
    lr: 0.001
    betas: (0.9, 0.999)
    eps: 1e-08
    weight_decay: 0.0005
    

ä¸»é…ç½®conf/config.yamlï¼š

    defaults:
      - base_config          # ä¸»é…ç½®Schema
      - optimizer: sgd      # é»˜è®¤ä½¿ç”¨SGDä¼˜åŒ–å™¨é…ç½®
      - _self_
    
    # è‡ªå®šä¹‰è®­ç»ƒå‚æ•°
    train:
      batch_size: 64
      epochs: 20
    debug: true
    

è¿è¡Œä»£ç æ—¶ï¼ŒHydraä¼šå…ˆåŠ è½½ç¬¬ä¸‰æ–¹åº“çš„Schemaï¼Œå†æ ¡éªŒæœ¬åœ°YAMLé…ç½®ï¼š

    # æ­£å¸¸è¿è¡Œï¼ˆSGDé…ç½®ç¬¦åˆSchemaè§„åˆ™ï¼‰
    python my_app.py
    
    # é…ç½®é”™è¯¯ï¼ˆmomentumåº”ä¸ºfloatï¼Œä¼ å…¥å­—ç¬¦ä¸²è§¦å‘æ ¡éªŒå¤±è´¥ï¼‰
    python my_app.py optimizer.momentum='high'
    
    # é…ç½®é”™è¯¯ï¼ˆAdamå¿…é€‰å­—æ®µepsç¼ºå¤±ï¼Œå¯åŠ¨æ—¶ç›´æ¥æŠ¥é”™ï¼‰
    python my_app.py optimizer=adam optimizer.eps=none
    

3 å‚è€ƒ
====

*   [hydra](https://github.com/facebookresearch/hydra)
*   [Hydra-doc](https://hydra.cc/docs/intro/)

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[è½ç—•çš„å¯’å‡](https://www.cnblogs.com/luohenyueji/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/luohenyueji/p/19444783](https://www.cnblogs.com/luohenyueji/p/19444783)

![](https://gitlab.com/luohenyueji/article_picture_warehouse/-/raw/main/wechat/content/%E5%8A%A0%E6%B2%B9%E9%B8%AD.gif)