---
layout: post
title: 'ä»é›¶æ„å»ºé«˜å¯ç”¨ API ç½‘å…³ï¼šé‰´æƒã€è·¯ç”±ã€æ€§èƒ½ä¼˜åŒ–å…¨è§£æ'
date: "2025-08-21T00:39:25Z"
---
ğŸŒ ä»é›¶æ„å»ºé«˜å¯ç”¨ API ç½‘å…³ï¼šé‰´æƒã€è·¯ç”±ã€æ€§èƒ½ä¼˜åŒ–å…¨è§£æ
===============================

ğŸŒ ä»é›¶æ„å»ºé«˜å¯ç”¨ API ç½‘å…³ï¼šé‰´æƒã€è·¯ç”±ã€æ€§èƒ½ä¼˜åŒ–å…¨è§£æ
===============================

> **ä½œè€…**ï¼šå¤æ¸¡è“æŒ‰  
> **æŠ€æœ¯æ ˆ**ï¼šSpring Cloud Gateway + redis + Nacos + è‡ªå®šä¹‰é‰´æƒ  
> **æŠ€æœ¯æ ˆ**ï¼šå¾®ä¿¡å…¬ä¼—å·ï¼ˆæ·±å…¥æµ…å‡ºè°ˆjavaï¼‰  
> æ„Ÿè§‰æœ¬ç¯‡å¯¹ä½ æœ‰å¸®åŠ©å¯ä»¥å…³æ³¨ä¸€ä¸‹ï¼Œä¼šä¸å®šæœŸæ›´æ–°çŸ¥è¯†å’Œé¢è¯•èµ„æ–™ã€æŠ€å·§ï¼ï¼ï¼

* * *

ä¸€ã€å¼•è¨€ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ API ç½‘å…³ï¼Ÿ
--------------------

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œéšç€æœåŠ¡æ•°é‡çš„å¢åŠ ï¼Œç›´æ¥æš´éœ²åç«¯æœåŠ¡ç»™å®¢æˆ·ç«¯ä¼šå¸¦æ¥è¯¸å¤šé—®é¢˜ï¼š

*   âŒ **å®‰å…¨éšæ‚£**ï¼šæ¯ä¸ªæœåŠ¡éƒ½è¦é‡å¤å®ç°é‰´æƒé€»è¾‘
*   âŒ **è·¯å¾„æ··ä¹±**ï¼šå®¢æˆ·ç«¯éœ€è¦ç»´æŠ¤å¤šä¸ªæœåŠ¡åœ°å€
*   âŒ **é‡å¤ä»£ç **ï¼šæ—¥å¿—ã€ç›‘æ§ã€é™æµç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹é‡å¤å¼€å‘
*   âŒ **å‡çº§å›°éš¾**ï¼šæœåŠ¡å˜æ›´å¯¹å®¢æˆ·ç«¯å½±å“å¤§

> **API ç½‘å…³ï¼ˆAPI Gatewayï¼‰** åº”è¿è€Œç”Ÿï¼Œå®ƒä½œä¸ºç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œæ‰¿æ‹…äº† **è·¯ç”±è½¬å‘ã€å®‰å…¨æ§åˆ¶ã€åè®®è½¬æ¢ã€æµé‡æ²»ç†** ç­‰æ ¸å¿ƒèŒè´£ã€‚

æœ¬æ–‡å°†å¸¦ä½ ä»é›¶å¼€å§‹ï¼Œæ­å»ºä¸€ä¸ª **æ”¯æŒåŠ¨æ€è·¯ç”±ã€å…¨å±€é‰´æƒã€è·¯å¾„é‡å†™ã€é«˜å¹¶å‘** çš„ç”Ÿäº§çº§ç½‘å…³æœåŠ¡ï¼Œå¹¶æ·±å…¥å‰–æå…¶è®¾è®¡æ€è·¯ã€è°ƒç”¨é“¾è·¯ä¸æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚

* * *

äºŒã€ç½‘å…³çš„æ ¸å¿ƒä½œç”¨ä¸å…¸å‹åœºæ™¯
--------------

### 1\. ç½‘å…³çš„äº”å¤§æ ¸å¿ƒèƒ½åŠ›

èƒ½åŠ›

è¯´æ˜

âœ… è·¯ç”±è½¬å‘

å°†è¯·æ±‚æŒ‰è§„åˆ™è½¬å‘åˆ°å¯¹åº”å¾®æœåŠ¡

âœ… åè®®è½¬æ¢

HTTP â†’ gRPCã€WebSocket ç­‰

âœ… å®‰å…¨æ§åˆ¶

é‰´æƒã€é˜²é‡æ”¾ã€é˜²ç¯¡æ”¹

âœ… æµé‡æ²»ç†

é™æµã€ç†”æ–­ã€é™çº§

âœ… ç›‘æ§å®¡è®¡

è¯·æ±‚æ—¥å¿—ã€è°ƒç”¨é“¾è¿½è¸ªã€QPS ç›‘æ§

### 2\. å…¸å‹åº”ç”¨åœºæ™¯

*   **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰è¯·æ±‚èµ° `/api/**` ç»Ÿä¸€å…¥å£
*   **å®‰å…¨åŠ å›º**ï¼šé˜²æ­¢æœªæˆæƒè®¿é—®ã€ç­¾åéªŒè¯ã€é˜²åˆ·
*   **ç°åº¦å‘å¸ƒ**ï¼šæ ¹æ® Header è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬æœåŠ¡
*   **å‰åç«¯åˆ†ç¦»**ï¼šè§£å†³è·¨åŸŸã€è·¯å¾„ä»£ç†
*   **API èšåˆ**ï¼šåˆå¹¶å¤šä¸ªæ¥å£è¿”å›ï¼ˆBFF æ¨¡å¼ï¼‰

* * *

ä¸‰ã€æŠ€æœ¯é€‰å‹ï¼šä¸ºä»€ä¹ˆé€‰æ‹© Spring Cloud Gatewayï¼Ÿ
----------------------------------

å¯¹æ¯”é¡¹

Nginx

Zuul 1.x

**Spring Cloud Gateway**

æ€§èƒ½

â­â­â­â­â­

â­â­

â­â­â­â­

ç¼–ç¨‹æ¨¡å‹

é…ç½®åŒ–

åŒæ­¥é˜»å¡

**å¼‚æ­¥éé˜»å¡ï¼ˆNettyï¼‰**

åŠ¨æ€è·¯ç”±

éœ€ reload

æ”¯æŒ

**æ”¯æŒï¼ˆå¯å¯¹æ¥ Nacosï¼‰**

æ‰©å±•æ€§

æœ‰é™

ä¸€èˆ¬

**é«˜ï¼ˆFilter æœºåˆ¶ï¼‰**

å¼€å‘æˆæœ¬

ä½

ä½

**ä¸­ï¼ˆJava ç¼–å†™ï¼‰**

é€‚ç”¨åœºæ™¯

é™æ€ä»£ç†

æ—§é¡¹ç›®

**å¾®æœåŠ¡ç½‘å…³é¦–é€‰**

> âœ… **ç»“è®º**ï¼šSCG åŸºäº Reactor å’Œ Nettyï¼Œæ€§èƒ½é«˜ã€æ‰©å±•æ€§å¼ºï¼Œæ˜¯å¾®æœåŠ¡ç½‘å…³çš„ç†æƒ³é€‰æ‹©ã€‚

* * *

å››ã€æ¶æ„è®¾è®¡ï¼šæ•´ä½“æ¶æ„ä¸æ¨¡å—åˆ’åˆ†
----------------

graph TD A\[Client\] --> B\[API Gateway\] B --> C\[Route: /pass/\*\*\] B --> D\[Route: /auth/\*\*\] B --> E\[Route: /file/\*\*\] C --> F\[AuthGlobalFilter\] F --> G\[é‰´æƒé€»è¾‘\] G --> H{é‰´æƒæˆåŠŸ?} H -->|æ˜¯| I\[StripPrefix â†’ è½¬å‘\] H -->|å¦| J\[è¿”å› 401\] I --> K\[Service A\] I --> L\[Service B\]

### æ ¸å¿ƒæ¨¡å—

1.  **åŠ¨æ€è·¯ç”±æ¨¡å—**ï¼šåŸºäº `RouteLocator` å®ç°è·¯å¾„åŒ¹é…
2.  **å…¨å±€è¿‡æ»¤å™¨**ï¼š`GlobalFilter` å®ç°é‰´æƒã€æ—¥å¿—ç­‰
3.  **å®‰å…¨æ¨¡å—**ï¼šè‡ªå®šä¹‰ç­¾åéªŒè¯ï¼ˆHMAC-SHA256ï¼‰
4.  **æ€§èƒ½ä¼˜åŒ–**ï¼šGZIPã€ç¼“å­˜ã€JVM è°ƒä¼˜

äº”ã€æ ¸å¿ƒå®ç°ï¼šå…¨å±€é‰´æƒè¿‡æ»¤å™¨æ·±åº¦è§£æ
------------------

### 1\. éœ€æ±‚åˆ†æ

*   âœ… æ”¯æŒ `POST` è¯·æ±‚ä½“å‚ä¸ç­¾å
*   âœ… æ”¯æŒ `GET` è¯·æ±‚å‚æ•°é€ä¼ 
*   âœ… é˜²é‡æ”¾æ”»å‡»ï¼ˆtimestamp + nonceï¼‰
*   âœ… ç­¾åéªŒè¯å¤±è´¥è¿”å› `401`

### 2\. å…³é”®ä»£ç ï¼š`AuthGlobalFilter`

    @Component
    public class AuthGlobalFilter implements GlobalFilter, Ordered {
    
        private final Map<String, String> appSecrets = Map.of("APP_A_001", "your-secret-key-123");
    
        @Override
        public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
            ServerHttpRequest request = exchange.getRequest();
            String path = request.getURI().getPath();
    
            // ä»…æ‹¦æˆª /pass/** è¯·æ±‚
            if (!path.startsWith("/pass/")) {
                return chain.filter(exchange);
            }
    
            // è¯»å–å¹¶ç¼“å­˜è¯·æ±‚ä½“ï¼ˆå…³é”®ï¼ä¿è¯ body å¯é‡å¤è¯»ï¼‰
            return DataBufferUtils.join(request.getBody())
                    .flatMap(dataBuffer -> {
                        byte[] bodyBytes = new byte[dataBuffer.readableByteCount()];
                        dataBuffer.read(bodyBytes);
                        DataBufferUtils.release(dataBuffer);
    
                        String body = new String(bodyBytes, StandardCharsets.UTF_8);
                        exchange.getAttributes().put("cachedRequestBody", body);
    
                        // é‡æ–°åŒ…è£… requestï¼Œä¿è¯ body èƒ½è½¬å‘åˆ°ä¸‹æ¸¸
                        Flux<DataBuffer> cachedBodyFlux = Flux.defer(() -> 
                            Mono.just(exchange.getResponse().bufferFactory().wrap(bodyBytes))
                        );
    
                        ServerHttpRequest mutatedRequest = new ServerHttpRequestDecorator(request) {
                            @Override
                            public Flux<DataBuffer> getBody() {
                                return cachedBodyFlux;
                            }
                        };
    
                        ServerWebExchange newExchange = exchange.mutate().request(mutatedRequest).build();
    
                        // æ‰§è¡Œé‰´æƒ
                        return performAuthentication(newExchange, body)
                                .then(Mono.defer(() -> chain.filter(newExchange)))
                                .onErrorResume(ex -> {
                                    if (ex instanceof AuthenticationException) {
                                        return onError(exchange.getResponse(), ex.getMessage(), HttpStatus.UNAUTHORIZED);
                                    }
                                    return onError(exchange.getResponse(), "Internal error", HttpStatus.INTERNAL_SERVER_ERROR);
                                });
                    })
                    .switchIfEmpty(chain.filter(exchange)); // GET è¯·æ±‚ç›´æ¥æ”¾è¡Œ
        }
    
        private Mono<Void> performAuthentication(ServerWebExchange exchange, String body) {
            ServerHttpRequest request = exchange.getRequest();
    
            String appId = request.getHeaders().getFirst("X-Pass-AppId");
            String timestampStr = request.getHeaders().getFirst("X-Pass-Timestamp");
            String nonce = request.getHeaders().getFirst("X-Pass-Nonce");
            String sign = request.getHeaders().getFirst("X-Pass-Sign");
    
            // çœç•¥å‚æ•°æ ¡éªŒ...
    
            String secret = appSecrets.get(appId);
            if (secret == null) {
                return onError(exchange.getResponse(), "Invalid AppId", HttpStatus.UNAUTHORIZED);
            }
    
            // éªŒè¯æ—¶é—´æˆ³ï¼ˆ5åˆ†é’Ÿå†…ï¼‰
            try {
                long timestamp = Long.parseLong(timestampStr);
                long now = Instant.now().getEpochSecond();
                if (Math.abs(now - timestamp) > 300) {
                    return onError(exchange.getResponse(), "Timestamp expired", HttpStatus.UNAUTHORIZED);
                }
            } catch (NumberFormatException e) {
                return onError(exchange.getResponse(), "Invalid timestamp", HttpStatus.UNAUTHORIZED);
            }
    
            // âœ… ä½¿ç”¨ path + body + timestamp + nonce ç”Ÿæˆç­¾å
            String contentToSign = request.getURI().getPath() + body + timestampStr + nonce;
            String expectedSign = SignUtil.sign(contentToSign, secret);
    
            if (!expectedSign.equalsIgnoreCase(sign)) {
                return onError(exchange.getResponse(), "Invalid signature", HttpStatus.UNAUTHORIZED);
            }
    
            return Mono.empty();
        }
    
        private Mono<Void> onError(ServerHttpResponse response, String msg, HttpStatus status) {
            response.setStatusCode(status);
            response.getHeaders().add("Content-Type", "application/json");
            String body = String.format("{\"code\": %d, \"message\": \"%s\"}", status.value(), msg);
            return response.writeWith(Mono.just(response.bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8))));
        }
    
        @Override
        public int getOrder() {
            return -1; // ä¼˜å…ˆæ‰§è¡Œ
        }
    }
    

### 3\. å…³é”®è®¾è®¡ç‚¹

é—®é¢˜

è§£å†³æ–¹æ¡ˆ

â“ `POST` è¯·æ±‚ä½“åªèƒ½è¯»ä¸€æ¬¡

`DataBufferUtils.join()` ç¼“å­˜ body

â“ ç¼“å­˜åå¦‚ä½•è½¬å‘åˆ°ä¸‹æ¸¸

`ServerHttpRequestDecorator` åŒ…è£… request

â“ `GET` è¯·æ±‚å¦‚ä½•å¤„ç†

`switchIfEmpty(chain.filter(exchange))` ç›´æ¥æ”¾è¡Œ

â“ é‰´æƒå¤±è´¥å¦‚ä½•ä¸­æ–­

`onErrorResume` è¿”å›é”™è¯¯å“åº”

* * *

å…­ã€è°ƒç”¨é“¾è·¯ï¼šä¸€æ¬¡è¯·æ±‚çš„å®Œæ•´æ—…ç¨‹
----------------

ä»¥ `POST /pass/test/create` ä¸ºä¾‹ï¼š

![image-20250814154631800](https://img2024.cnblogs.com/blog/2719585/202508/2719585-20250820164745858-1692593289.png)

### è¯¦ç»†è¯·æ±‚è·¯å¾„åˆ†æ

1.  è¯·æ±‚è¿›å…¥ç½‘å…³  
    â†“
2.  RoutePredicateHandlerMappingï¼šåŒ¹é…è·¯ç”±  
    â†“
3.  FilteringWebHandlerï¼šæ‰§è¡Œ GlobalFilter å’Œ GatewayFilter  
    â†“
4.  è·¯ç”±è½¬å‘åˆ°ç›®æ ‡åœ°å€ï¼ˆå¦‚ [http://www.baidu.com/order/16ï¼‰](http://www.baidu.com/order/16%EF%BC%89)

æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹ï¼š

### ğŸ”¹ æ­¥éª¤ 1ï¼šè·¯ç”±åŒ¹é…ï¼ˆRoute Matchingï¼‰

*   ç½‘å…³ä¼šä»æ‰€æœ‰å¯ç”¨çš„ `RouteDefinition` ä¸­æŸ¥æ‰¾åŒ¹é…çš„è·¯ç”±ã€‚
    
*   ä½ çš„ä¸¤ä¸ªè·¯ç”±æºéƒ½ä¼šè¢«åŠ è½½ï¼š
    
*   æ¥è‡ª `CustomRouteConfig`ï¼š`Path=/pass/order/**` â†’ `http://www.baidu.com`
    
    *   æ¥è‡ª `application.yml`ï¼š`Path=/pass/**` â†’ `http://localhost:8080`
*   ç”±äº `/pass/order/**` æ˜¯æ›´å…·ä½“çš„è·¯å¾„ï¼Œå®ƒä¼šä¼˜å…ˆåŒ¹é…ï¼ˆå‰ææ˜¯ `order` è®¾ç½®åˆç†ï¼‰ã€‚
    
*   åŒ¹é…æˆåŠŸåï¼Œç”Ÿæˆä¸€ä¸ªRouteå¯¹è±¡ï¼ŒåŒ…å«ï¼š
    

      ID: `order_route`
      URI: `http://www.baidu.com`
      Predicates: `Path=/pass/order/**`
      Filters: ï¼ˆå¦‚æœæœ‰ï¼‰
    

### ğŸ”¹ æ­¥éª¤ 2ï¼šæ‰§è¡Œ `GlobalFilter`ï¼ˆAuthGlobalFilterï¼‰

*   åŒ¹é…è·¯ç”±åï¼Œç½‘å…³è¿›å…¥è¿‡æ»¤å™¨é“¾ã€‚
    
*   `AuthGlobalFilter` æ˜¯ `GlobalFilter`ï¼Œå®ƒçš„ `filter()` æ–¹æ³•ä¼šè¢«è°ƒç”¨
    
*   > âœ… æ­¤æ—¶ï¼Œ**è¯·æ±‚è·¯å¾„ `/pass/order/16` è¢«ç”¨äºè·¯ç”±åŒ¹é…**ï¼Œä½† `CustomRouteConfig` æœ¬èº« **ä¸ä¼šä¸»åŠ¨æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ä¿¡æ¯**ã€‚
    
    * * *
    

    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        String path = request.getURI().getPath(); // â†’ "/pass/order/16"
        ...
    }
    

âœ… åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥è·å–åˆ°å®Œæ•´çš„è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š

*   è·¯å¾„ï¼š`/pass/order/16`
*   Headerï¼š`X-Pass-AppId`, `X-Pass-Sign` ç­‰
*   æ–¹æ³•ï¼šGET/POST
*   æŸ¥è¯¢å‚æ•°ç­‰

ğŸ‘‰ **è¿™æ˜¯ä½ åšé‰´æƒçš„æ­£ç¡®ä½ç½®ã€‚**

* * *

### ğŸ”¹ æ­¥éª¤ 3ï¼šè·¯ç”±è½¬å‘

*   é‰´æƒé€šè¿‡åï¼Œ`chain.filter(exchange)` ç»§ç»­æ‰§è¡Œã€‚
    
*   ç½‘å…³æ ¹æ® `Route` ä¸­çš„ `uri`ï¼ˆ`http://www.baidu.com`ï¼‰å’Œ `predicates` è¿›è¡Œè½¬å‘ã€‚
    
*   æœ€ç»ˆè¯·æ±‚è¢«è½¬å‘ä¸ºï¼š
    
        GET http://www.baidu.com/order/16
        
    

ä¸ƒã€è¯·æ±‚è°ƒè¯•
------

![image-20250820151406974](https://img2024.cnblogs.com/blog/2719585/202508/2719585-20250820164921932-1609838604.png)

ç½‘å…³æ—¥å¿—æ‰“å°æ—¥å¿—

![image-20250820151040396](https://img2024.cnblogs.com/blog/2719585/202508/2719585-20250820165014232-1502786568.png)

ä¸‹æ¸¸ç³»ç»Ÿ

![image-20250820151336602](https://img2024.cnblogs.com/blog/2719585/202508/2719585-20250820165035203-120572745.png)

å…«ã€æ€»ç»“
----

æœ¬æ–‡ä»é›¶æ­å»ºäº†ä¸€ä¸ªç”Ÿäº§çº§ API ç½‘å…³ï¼Œå®ç°äº†ï¼š

*   âœ… åŸºäºè·¯å¾„çš„åŠ¨æ€è·¯ç”±
*   âœ… æ”¯æŒ Body å‚ä¸ç­¾åçš„å…¨å±€é‰´æƒ
*   âœ… GET/POST è¯·æ±‚å…¼å®¹å¤„ç†
*   âœ… é«˜å¹¶å‘æ€§èƒ½ä¼˜åŒ–

> **ç½‘å…³ä¸æ˜¯ç®€å•çš„â€œè½¬å‘å™¨â€ï¼Œè€Œæ˜¯å¾®æœåŠ¡æ¶æ„çš„â€œå®‰å…¨é—¨â€ä¸â€œæµé‡è°ƒåº¦ä¸­å¿ƒâ€**ã€‚

é€šè¿‡åˆç†è®¾è®¡ä¸ä¼˜åŒ–ï¼Œå³ä½¿æ˜¯ 2æ ¸4G çš„æœºå™¨ï¼Œä¹Ÿèƒ½æ‰›ä½ä¸Šåƒ QPSï¼Œä¸ºä¸šåŠ¡ä¿é©¾æŠ¤èˆªã€‚