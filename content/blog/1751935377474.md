---
layout: post
title: 'ä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿåˆ«è¢«éª—äº†ï¼Œä¸€çº§ç¼“å­˜å°±å¤Ÿäº†ï¼'
date: "2025-07-08T00:42:57Z"
---
ä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿåˆ«è¢«éª—äº†ï¼Œä¸€çº§ç¼“å­˜å°±å¤Ÿäº†ï¼

æ–¹æ¡ˆå¯¼å…¥
----

### å¾ªç¯ä¾èµ–æ˜¯ä»€ä¹ˆ

æ„é€ å‡ºä¸¤ä¸ªå¯¹è±¡Aå’ŒBï¼ŒAä¸­æœ‰æˆå‘˜Bï¼ŒBä¸­æœ‰æˆå‘˜Aï¼Œæ¢æˆä»£ç å°±æ˜¯è¿™æ ·å­ã€‚

    @Component
    public class A {
        @Autowired
        private B b;
    }
    
    @Component
    public class B {
        @Autowired
        private A a;
    }
    

### å¾ªç¯ä¾èµ–ä¼šå¸¦æ¥ä»€ä¹ˆé—®é¢˜

å¦‚æœåˆ›å»ºAå¯¹è±¡ï¼Œé‚£å¿…é¡»æ³¨å…¥Bå¯¹è±¡ï¼Œæ³¨å…¥Bå¯¹è±¡åˆéœ€è¦åˆ›å»ºAå¯¹è±¡ï¼Œå¦‚æ­¤åå¤ï¼Œç›´åˆ°OOM

### å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜

æˆ‘ä»¬æƒ³è±¡æœ‰è¿™æ ·ä¸€å¹…æœ‰å‘å›¾ï¼Œæˆ‘ä»¬ä»Aå¼€å§‹ï¼Œåˆ°Dç»“æŸï¼Œå½“æ‰§è¡Œåˆ°Dçš„æ—¶å€™ï¼ŒDè¿˜æ˜¯ä¼šç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºDä¸çŸ¥é“Aæ˜¯å¦è¢«ç»è¿‡ã€‚

ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ç»è¿‡çš„è·¯å¾„ç‚¹`æŸ“è‰²`å°±å¥½äº†ã€‚

Då‘ç°Aå·²ç»æ˜¯çº¢è‰²ï¼ŒçŸ¥é“å·²ç»è¢«é€”å¾„è¿‡ï¼Œä¸»åŠ¨ç»“æŸå¾ªç¯ã€‚

æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½å‘ç°ï¼Œå¾ªç¯ä¾èµ–é—®é¢˜å’Œå›¾è·¯å¾„ä¸­æ˜¯å¦æœ‰ç¯é—®é¢˜æ˜¯ä¸€æ ·çš„ï¼Œå°±èƒ½ä¿è¯Beanï¼ˆå®ä¾‹ï¼‰ä¸è¢«é‡å¤åˆ›å»ºã€‚

è”ç³»Spring
--------

éƒ½è¯´Springä¸‰çº§ç¼“å­˜è§£å†³äº†å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å°±ä½¿ç”¨äº†ä¸€çº§ç¼“å­˜å°±è§£å†³äº†ç¼“å­˜ä¾èµ–é—®é¢˜ï¼Œspringçš„å¼€å‘å›¢é˜Ÿæ€ä¹ˆä¼šå‚»åˆ°ç”¨ä¸‰çº§ç¼“å­˜è§£å†³é—®é¢˜ï¼Œå½“ç„¶è¿™å¥è¯å¯èƒ½è¿˜æœ‰ä¸€ä¸ªæ­§ä¹‰ï¼Œç¬¬ä¸‰å±‚ç¼“å­˜åŒºè§£å†³äº†ç¼“å­˜ä¾èµ–é—®é¢˜ï¼Œè¿™åŒæ ·ä¹Ÿæ˜¯é”™çš„ï¼Œä¸”å¬ä¸‹æ–‡åˆ†æã€‚

### ä¸‰çº§ç¼“å­˜æ˜¯ä»€ä¹ˆ

    //  å­˜å‚¨å•ä¾‹çš„Beanå¯¹è±¡
    private final Map<String, Object> singletonObjects = new ConcurrentHashMap<>(256);
    //  å­˜å‚¨æ—©æœŸæ›å…‰çš„å•ä¾‹Beanå¯¹è±¡ï¼Œåªæ˜¯ä¸€ä¸ªBeançš„å¼•ç”¨ï¼Œæœªåˆå§‹åŒ–
    private final Map<String, Object> earlySingletonObjects = new ConcurrentHashMap<>(16);
    //  å­˜å‚¨å•ä¾‹Beanå¯¹è±¡çš„å·¥å‚
    private final Map<String, ObjectFactory<?>> singletonFactories = new ConcurrentHashMap<>(16);
    

### ä¸‰çº§ç¼“å­˜å¦‚ä½•å·¥ä½œ - æºç éƒ¨åˆ†

> æˆ‘ä¼šå¯¹å…³é”®ä»£ç æ‰“æ³¨é‡Šï¼Œä½ è¿™ä¹ˆèªæ˜è‚¯å®šä¸€ä¸‹å°±çœ‹æ‡‚äº†

å½“æˆ‘ä»¬è·å–æƒ³è¦æ³¨å…¥çš„å•ä¾‹æ—¶ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼Œåˆ å»äº† try - catchçš„å¼‚å¸¸å¤„ç†å’Œè§£å†³å¹¶å‘é—®é¢˜çš„ä»£ç å—ï¼Œä¾¿äºæ¸…æ™°çš„é˜…è¯»

    public Object getSingleton(String beanName) {
    	return getSingleton(beanName, true);
    }
    	
    protected Object getSingleton(String beanName, boolean allowEarlyReference) {
        //ä»ä¸€çº§ç¼“å­˜ä¸­è·å–Bean
        Object singletonObject = this.singletonObjects.get(beanName);
        if (singletonObject == null && isSingletonCurrentlyInCreation(beanName)) {
    		//ä»äºŒçº§ç¼“å­˜ä¸­è·å–Bean
            singletonObject = this.earlySingletonObjects.get(beanName);
            if (singletonObject == null && allowEarlyReference) {
    		    //ä»ä¸‰çº§ç¼“å­˜ï¼ˆå·¥å‚ï¼‰ä¸­è·å–Bean
                ObjectFactory<?> singletonFactory = this.singletonFactories.get(beanName);
                if (singletonFactory != null) {
                    singletonObject = singletonFactory.getObject();
                    //ä»å·¥å‚ä¸­è·å–åˆ° singletonObject æ—¶ï¼Œä»å·¥å‚ç¼“å­˜ä¸­åˆ å»å·¥å‚ï¼Œå·¥å‚åˆ›å»ºçš„å¯¹è±¡åŠ å…¥äºŒçº§ç¼“å­˜
                    if (this.singletonFactories.remove(beanName) != null) {
                        this.earlySingletonObjects.put(beanName, singletonObject);
                    }
                }
            }
        }
        return singletonObject;
    }
    

å¯è§ `getSingleton` çš„è·¯å¾„æ˜¯ ä¸€çº§ç¼“å­˜ â†’ äºŒçº§ç¼“å­˜ â†’ ä¸‰çº§ç¼“å­˜ï¼ŒåŒæ—¶å½“ä»ä¸‰çº§ç¼“å­˜ä¸­è·å–åˆ°æ—©æœŸå¯¹è±¡æ—¶ï¼Œç›´æ¥æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œåˆ é™¤ä¸‰çº§ç¼“å­˜ï¼ˆåç»­çš„å¤šæ¬¡å¼•ç”¨ä¹Ÿæ˜¯äºŒçº§ç¼“å­˜ï¼‰ï¼Œå¯è§äºŒçº§ç¼“å­˜+çŸ­æš‚çš„ä¸‰çº§ç¼“å­˜ç›¸å½“äºæ ‡è®°beanä¸ºå·²å®ä¾‹åŒ–ï¼Œæ‰€ä»¥ä¾èµ–ä¸‰çº§ç¼“å­˜è§£å†³å¾ªç¯ä¾èµ–æ˜¾ç„¶æ˜¯é”™çš„

é‚£ä¸‰çº§ç¼“å­˜ï¼ˆå·¥å‚ï¼‰åˆ°åº•å­˜å‚¨ç€ä»€ä¹ˆï¼Œä¸æ˜¯äºŒçº§ç¼“å­˜å°±èƒ½è§£å†³é—®é¢˜äº†å—ï¼Ÿæˆ‘ä»¬åœ¨ `doCreateBean` ä¸­å¯ä»¥çœ‹åˆ°ä»¥ä¸‹ä»£ç ã€‚

    		// å½“å‰ Beanï¼ˆä¾‹å¦‚ Aï¼‰åœ¨å®ä¾‹åŒ–åã€ä¾èµ–æ³¨å…¥å’Œåˆå§‹åŒ–å®Œæˆå‰ï¼Œæ˜¯å¦éœ€è¦å°†å…¶ä½œä¸ºâ€œæ—©å¼•ç”¨â€æš´éœ²ç»™å…¶ä»– Bean
    		boolean earlySingletonExposure = (mbd.isSingleton() && this.allowCircularReferences &&
    				isSingletonCurrentlyInCreation(beanName));
    		// å…è®¸è¢«æ—©å¼•ç”¨ï¼ˆæ—©æœŸæ›å…‰ï¼‰
    		if (earlySingletonExposure) {
    			// æ·»åŠ åˆ°å•ä¾‹å·¥å‚ï¼ˆä¸‰çº§ç¼“å­˜ï¼‰
    			addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    		}
    		
    		// è¢«ä¸‰çº§ç¼“å­˜æ·»åŠ åå†è¿›è¡Œåˆå§‹åŒ–
    		Object exposedObject = bean;
    		populateBean(beanName, mbd, instanceWrapper);
    		exposedObject = initializeBean(beanName, exposedObject, mbd);
    
    

è¯æ˜äº†ä¸‰çº§ç¼“å­˜ä»¥åŠäºŒçº§ç¼“å­˜ä¸­çš„å¯¹è±¡æ˜¯å¼•ç”¨å¯¹è±¡ï¼Œæœªè¢«çœŸæ­£åˆå§‹åŒ–ï¼Œç­‰äºæ˜¯ä¸€ä¸ªæ‡’åŠ è½½ï¼ŒåŒæ ·ä¹Ÿä¸ä¼šé€ æˆå¾ªç¯ä¾èµ–ï¼Œå› ä¸ºå…¶å†…éƒ¨çš„å¯¹è±¡æ²¡æœ‰åªå¼•ç”¨äº†å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œæœªè¢«åˆå§‹åŒ–ã€‚

`getEarlyBeanReference` åº”è¯¥æœ‰å…³äºFactoryä¸­çš„ä¸€äº›ä¿¡æ¯

    	protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
    		Object exposedObject = bean;
    		// æ˜¯å¦è¢«ä»£ç†ï¼ˆAOPï¼Œå­—èŠ‚ç å¢å¼ºï¼‰
    		if (!mbd.isSynthetic() && hasInstantiationAwareBeanPostProcessors()) {
    			for (SmartInstantiationAwareBeanPostProcessor bp : getBeanPostProcessorCache().smartInstantiationAware) {
    				exposedObject = bp.getEarlyBeanReference(exposedObject, beanName);
    			}
    		}
    		return exposedObject;
    	}
    

å€˜è‹¥æ²¡æœ‰ç»è¿‡å­—èŠ‚ç å¢å¼ºä»£ç å¯ä»¥ç¼©ç•¥æˆä¸¤è¡Œ

    	protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
    		Object exposedObject = bean;
    		return exposedObject;
    	}
    

è¯¶å§æ§½ï¼Œè¿™ä¸æ˜¯å•¥ä¹Ÿæ²¡å¹²ï¼

ä¸‰çº§ç¼“å­˜åªå‚ä¸äº†AOPå¯¹è±¡çš„è¿”å›ï¼Œè§£å†³beançš„AOPä»£ç†é—®é¢˜

ä¸‹å›¾å±•ç¤ºäº†beançš„åˆå§‹åŒ–è¿‡ç¨‹

é‚£æˆ‘ä»¬ç°åœ¨å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºäº†ï¼š

1.  ç¬¬ä¸€çº§ç¼“å­˜ç”¨æ¥ç®€å•è¿”å›ç¼“å­˜åçš„beanå¯¹è±¡ã€‚
2.  ç¬¬äºŒçº§ç¼“å­˜å°±å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ã€‚
3.  äºŒä¸‰çº§ç¼“å­˜åªä¿ç•™äº†å®ä¾‹åŒ–çš„beanï¼Œæœªåˆå§‹åŒ–ï¼Œä¸ä¼šå¯¼è‡´å¾ªç¯ä¾èµ–ã€‚
4.  ç¬¬ä¸‰çº§ç¼“å­˜ç”¨æ¥è§£å†³Beançš„ä»£ç†ç±»çš„å®ä¾‹åŒ–é—®é¢˜ã€‚

* * *

å¦‚æœè¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œè¯·ç»™æˆ‘ç‚¹ä¸ªèµã€‚ä½ çš„è‚¯å®šä¼šè®©æˆ‘éå¸¸å¼€å¿ƒã€‚ğŸ¥°ğŸ¥°ğŸ¥°

æ±‚ç‚¹èµ orz OTZ ï¼ï¼