---
layout: post
title: 'DotMemoryç³»åˆ—ï¼š5. å¦‚ä½•å®ç°è‡ªåŠ¨åŒ–æŠ“å–å’Œåº”ç”¨è‡ªæ‰˜ç®¡'
date: "2025-11-19T00:42:42Z"
---
DotMemoryç³»åˆ—ï¼š5. å¦‚ä½•å®ç°è‡ªåŠ¨åŒ–æŠ“å–å’Œåº”ç”¨è‡ªæ‰˜ç®¡
==============================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰é¢å‡ ç¯‡æˆ‘ä»¬éƒ½æ˜¯æ‰‹å·¥å®‰è£… dotmemory è½¯ä»¶ï¼Œç„¶ååœ¨ç¨‹åºçš„åˆé€‚æ—¶æœºæŠ“å–snapshotï¼Œè¿™ç§æ–¹å¼åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½æ²¡æœ‰é—®é¢˜ï¼Œä½†åœ¨ä¸€äº›ç²¾ç»†åŒ–çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœèƒ½å¤Ÿå®ç°è‡ªåŠ¨åŒ–æŠ“å–ï¼Œé‚£å°±æ¯”è¾ƒğŸ‚ğŸ‘ƒäº†ï¼Œè¿™ç¯‡æˆ‘ä»¬å°±æ¥èŠä¸€èŠè¿™ç©æ„ã€‚

äºŒï¼šå¦‚ä½•å®ç°è‡ªåŠ¨åŒ–æŠ“å–
-----------

### 1\. æµ‹è¯•ä»£ç 

æ‰€è°“çš„è‡ªåŠ¨åŒ–æŠ“å–ï¼Œæ„æ€å°±æ˜¯ç”¨ä»£ç æ¥æ§åˆ¶ snapshot çš„æŠ“å–æ—¶æœºï¼Œè€Œä¸æ˜¯ä½ åœ¨ UI ä¸Šç‚¹æ¥ç‚¹å»ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå…ˆä¸Šä¸€æ®µæµ‹è¯•ä»£ç ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

    
        internal class Program
        {
            static void Main()
            {
                var analyzer = new MemoryAnalyzer();
                analyzer.ProcessData();
    
                Console.ReadLine();
            }
        }
    
        public class MemoryAnalyzer
        {
            private readonly List<string> _data = new();
    
            public void ProcessData()
            {
                // æ¨¡æ‹Ÿå†…å­˜å¯†é›†å‹æ“ä½œ
                for (int i = 0; i < 10000; i++)
                {
                    _data.Add(new string('x', 1000));
                }
    
                Console.WriteLine("æ•°æ®å¤„ç†å®Œæˆï¼Œ3ç§’åç”Ÿæˆå¿«ç…§...");
                Thread.Sleep(3000);
    
                MemoryProfiler.GetSnapshot("ProcessDataSnapshot");
                Console.WriteLine("å¿«ç…§å·²ç”Ÿæˆ");
            }
        }
    
    

ä¸Šé¢çš„ä»£ç éå¸¸ç®€å•ï¼Œæˆ‘æƒ³åœ¨ `ProcessData()` æ–¹æ³•å†…çš„æŸä¸€ä¸ªæ—¶ç‚¹é€šè¿‡ `MemoryProfiler.GetSnapshot` æ–¹æ³•è‡ªåŠ¨åŒ–æŠ“å–snapshotï¼Œè¿™ä¸ªè®©ä½ åœ¨UIä¸Šç‚¹å‡»ï¼Œä½ æ ¹æœ¬æ— æ³•åšåˆ°ã€‚

### 2\. dotmemory é›†æˆäº¤äº’

ä»£ç é‡ŒåŸ‹å¥½ç‚¹ä¹‹åï¼Œæ¥ä¸‹æ¥æ‰“å¼€ dotmemoryï¼Œä½¿ç”¨ `Using API` æ¨¡å¼ï¼Œè¿™æ ·å°±ç›¸å½“äºç»™ç¨‹åºå¼€äº†ä¸€ä¸ªå£å­ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251118110511851-91471306.png)

æ¥ä¸‹æ¥ç‚¹å‡» `Start` æŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºè‡ªåŠ¨çš„å¸®æˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªå« `ProcessDataSnapshot` çš„snapshotï¼Œæ˜¯ä¸æ˜¯æŒºæœ‰æ„æ€çš„ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251118110511887-1167319627.png)

ä¸‰ï¼šå¦‚ä½•å®ç°è‡ªæ‰˜ç®¡
---------

### 1\. æµ‹è¯•ä»£ç 

æ‰€è°“çš„è‡ªæ‰˜ç®¡å°±æ˜¯è®©ä»£ç è‡ªå·±å»ä¸‹è½½ `Console of DotMemory`ï¼Œå…¨ç¨‹ä¸éœ€è¦äººä¸ºå¹²é¢„ï¼Œæœ€ç»ˆä¼šäº§ç”Ÿä¸€ä¸ªåç¼€ä¸º `*.dmw` çš„è·Ÿè¸ªæ–‡ä»¶ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
        internal class Program
        {
            static void Main(string[] args)
            {
                DotMemory.Init();
                var config = new DotMemory.Config();
                config.SaveToDir(@"E:\testdump");
    
                DotMemory.Attach(config);
    
                Console.WriteLine("=== å†…å­˜åˆ†æå¼€å§‹ ===\n");
    
                var memoryDemo = new MemoryDemo();
    
                DotMemory.GetSnapshot("Initial");
                Console.WriteLine("åˆå§‹å¿«ç…§å·²ç”Ÿæˆ");
    
                memoryDemo.CreateObjects();
                DotMemory.GetSnapshot("AfterCreation");
                Console.WriteLine("å¯¹è±¡åˆ›å»ºåå¿«ç…§å·²ç”Ÿæˆ");
    
                memoryDemo.Cleanup();
                DotMemory.GetSnapshot("AfterCleanup");
                Console.WriteLine("æ¸…ç†åå¿«ç…§å·²ç”Ÿæˆ");
    
                Console.WriteLine("\n=== åˆ†æå®Œæˆ ===");
    
                DotMemory.Detach();
            }
        }
    
        public class MemoryDemo
        {
            private List<string> _strings = new();
            private List<byte[]> _buffers = new();
            private List<char[]> _charArrays = new();
    
            public void CreateObjects()
            {
                Console.WriteLine("åˆ›å»ºå¯¹è±¡ä¸­...");
    
                for (int i = 0; i < 500000; i++)
                {
                    _strings.Add($"Data_{i}_{Guid.NewGuid()}_AdditionalPaddingDataToMakeStringLarger");
                }
    
                for (int i = 0; i < 5000; i++)
                {
                    _buffers.Add(new byte[1024 * 200]);
                }
    
                for (int i = 0; i < 100; i++)
                {
                    _buffers.Add(new byte[1024 * 1024 * 5]);
                }
    
                for (int i = 0; i < 10000; i++)
                {
                    _charArrays.Add(new char[1024 * 50]);
                }
    
                Console.WriteLine($"å·²åˆ›å»º: {_strings.Count} ä¸ªå­—ç¬¦ä¸², {_buffers.Count} ä¸ªç¼“å†²åŒº, {_charArrays.Count} ä¸ªå­—ç¬¦æ•°ç»„");
            }
    
            public void Cleanup()
            {
                Console.WriteLine("æ¸…ç†å¯¹è±¡ä¸­...");
    
                _strings.Clear();
                _buffers.Clear();
                _charArrays.Clear();
    
                GCSettings.LargeObjectHeapCompactionMode = GCLargeObjectHeapCompactionMode.CompactOnce;
                GC.Collect(2, GCCollectionMode.Forced, true, true);
                GC.WaitForPendingFinalizers();
    
                Console.WriteLine("æ¸…ç†å®Œæˆ");
            }
        }
    
    

ä¸Šé¢çš„ä»£ç ä¼šåœ¨ç¨‹åºè¿è¡Œçš„ä¸‰ä¸ªé˜¶æ®µæŠ“å–snapshotï¼Œå°†ç¨‹åºè¿è¡Œèµ·æ¥ä¹‹åï¼Œä»ä¸‹å›¾å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°å·²ç”Ÿæˆä¸‰ä¸ª snapshot å¿«ç…§ï¼Œæ˜¯ä¸æ˜¯æŒºæœ‰æ„æ€ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251118110511871-83667221.png)

### 2\. Console ç‰ˆ DotMemory åˆ†æ

è‡ªæ‰˜ç®¡å€ŸåŠ©çš„æ˜¯ `Console ç‰ˆ DotMemory`ï¼Œä¸è¦å°çœ‹è¿™ä¸ª Consoleï¼Œå®ƒå¯ä»¥è·¨å¹³å°ï¼Œä¹Ÿå¯ä»¥é›†æˆåˆ°å„ç§ è‡ªåŠ¨åŒ–å‘å¸ƒå·¥å…· é‡Œé¢å»ï¼Œè¿™é‡Œæˆ‘å°±ç®€å•æ¼”ç¤ºä¸‹åœ¨ ubuntu ä¸Šå¦‚ä½•ç”¨ console ç‰ˆæŠ“ .net ç¨‹åºçš„ snapshot åˆ° windows ä¸Šåˆ†æã€‚

é¦–å…ˆåˆ° [https://www.jetbrains.com/dotmemory/download/?section=commandline](https://www.jetbrains.com/dotmemory/download/?section=commandline) ä¸Šä¸‹è½½å®‰è£…åŒ…ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251118110511859-1945546220.png)

    
    root@ubuntu2404:/data# tar -xzvf JetBrains.dotMemory.Console.linux-x64.2025.3.0.1.tar.gz
    
    root@ubuntu2404:/data# ps -ef | grep dotnet
    root        3007    2962  0 12:13 pts/1    00:00:00 dotnet Example_6_6.dll
    root        3018    1938  0 12:13 pts/0    00:00:00 grep --color=auto dotnet
    root@ubuntu2404:/data# ./dotMemory.sh get-snapshot 3007 --save-to-dir=./         
    dotMemory.sh is deprecated and will soon be removed: Use the dotmemory command instead.
    Performs memory profiling of .NET applications
    
    Found 1 process(es):
      [3007] dotnet
    
    Attaching to [3007] dotnet runtime...
    Profiler connected. PID:3007, Core CLR runtime v8.0.15.0
      ATTACHED. Getting snapshot...
      [PID:3007] Saving snapshot... ~5.6 K objects
      [PID:3007] SNAPSHOT #1 SAVED.
      [PID:3007] Processing snapshot #1...
      [PID:3007] SNAPSHOT #1 READY.
    Profiler disconnected. PID:3007
    
    Saving workspace...
    WORKSPACE SAVED
    file:///data/[3007]-dotnet.2025-11-17T12-14-10.141.dmw
    
    

ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹åˆ° dmw æ–‡ä»¶å·²ç”Ÿæˆï¼Œæ¥ä¸‹æ¥å°†æ–‡ä»¶å¯¼å…¥åˆ° windows å¹³å°ä¸Šï¼ŒåŒå‡»æ‰“å¼€ã€‚

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251118110511897-2015931471.png)

å“ˆå“ˆï¼Œæ˜¯ä¸æ˜¯å¾ˆå®Œç¾ã€‚ã€‚ã€‚

å››ï¼šæ€»ç»“
----

è¿™ä¸ªç³»åˆ—å°±å…ˆè®²åˆ°è¿™é‡Œå§ï¼Œå¸¸è§çš„åŠŸèƒ½åº”è¯¥éƒ½è®²åˆ°äº†ï¼Œæ€»çš„æ¥è¯´ dotmemory è¿™æ¬¾å·¥å…·è¿˜æœ‰å¾ˆå¤šçš„ç¼ºç‚¹å’Œä¸å¦‚æ„ï¼Œä½†åœ¨ä¸“ä¸šçš„windbgä»‹å…¥ä¹‹å‰ï¼Œå®ƒèµ·æ¥äº†ä¸€ä¸ªå¾ˆå¥½çš„æ‹¦æˆªç­›é€‰ä½œç”¨ã€‚

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)