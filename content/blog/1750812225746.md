---
layout: post
title: 'ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢å¼•å‘çš„æ€§èƒ½è¡€æ¡ˆï¼šæ­£åˆ™å›æº¯ä¸æ•‘èµä¹‹è·¯'
date: "2025-06-25T00:43:45Z"
---
ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢å¼•å‘çš„æ€§èƒ½è¡€æ¡ˆï¼šæ­£åˆ™å›æº¯ä¸æ•‘èµä¹‹è·¯
========================

ä¸€ä¸ªå­—ç¬¦ä¸²æ›¿æ¢å¼•å‘çš„æ€§èƒ½è¡€æ¡ˆï¼šæ­£åˆ™å›æº¯ä¸æ•‘èµä¹‹è·¯
========================

> å‡Œæ™¨2:15ï¼Œé’‰é’‰ç›‘æ§å‘Šè­¦ç¾¤ç–¯ç‹‚å¼¹çª—â€”â€”æ–‡æ¡£å¯¼å…¥æœåŠ¡å…¨é¢å´©æºƒã€‚

> IDEA Profiler ç«ç„°å›¾ç›´æŒ‡çœŸå‡¶ï¼š  
>   

> **`replaceFirst("\\?", ...)` æ­£åœ¨ä»¥ O(nÂ²) çš„å¤æ‚åº¦åå™¬ CPUï¼**

æ¡ˆå‘ç°åœºï¼šMyBatis æ‹¦æˆªå™¨çš„ä¸‰é‡ç½ª
--------------------

é—®é¢˜ä»£ç åŸå‹ï¼ˆå·²ç®€åŒ–ï¼‰ï¼š

    //å»é™¤æ¢è¡Œç¬¦å·
    sql = sql.replaceAll("[\\s\n]"+",", " ")
    for (Object param : params) {
    	// å‚æ•°å¤„ç†
        String value = processParam(param); 
        // ä¸‰é‡æ€§èƒ½ç‚¸å¼¹ï¼š
        sql = sql.replaceFirst("\\?", value.replace("$", "\\$"))
                 .replace("?", "%3F"); 
    }
    

**ç½ªè¯åˆ†æ**ï¼ˆåŸºäº Profiler æ•°æ®ï¼‰ï¼š

1.  `replaceFirst("\\?")`ï¼š89% CPU æ—¶é—´
2.  `value.replace("$", "\\$")`ï¼š7% CPU æ—¶é—´
3.  `.replace("?", "%3F")`ï¼š4% CPU æ—¶é—´

* * *

çœŸå‡¶è§£å‰–ï¼šæ­£åˆ™å›æº¯çš„æ­»äº¡èºæ—‹ï¼ŒreplaceFirst() çš„ Java æºç è§£æ
-----------------------------------------

### å›æº¯åŸç†ï¼šæ­£åˆ™å¼•æ“çš„"ç©·ä¸¾å¼è‡ªæ€"

æŸ¥çœ‹ OpenJDK æºç åï¼Œ`replaceFirst()` çš„æœ¬è´¨å¦‚ä¸‹ï¼š

    // java.lang.String æºç ç®€åŒ–ç‰ˆ
    public String replaceFirst(String regex, String replacement) {
        return Pattern.compile(regex).matcher(this).replaceFirst(replacement);
    }
    
    // java.util.regex.Matcher æ ¸å¿ƒé€»è¾‘
    public String replaceFirst(String replacement) {
        reset();  // é‡ç½®åŒ¹é…ä½ç½®
        if (!find())  // å…³é”®ï¼šæ¯æ¬¡ä»å¤´å¼€å§‹æŸ¥æ‰¾
            return text.toString();
        
        StringBuffer sb = new StringBuffer();
        appendReplacement(sb, replacement);  // æ›¿æ¢åŒ¹é…éƒ¨åˆ†
        appendTail(sb);         // è¿½åŠ å‰©ä½™éƒ¨åˆ†
        return sb.toString();
    }
    
    // è‡´å‘½æ€§èƒ½çš„ find() ä¼ªä»£ç 
    public boolean find() {
        int nextSearchIndex = 0;  // æ¯æ¬¡ä»å¤´å¼€å§‹
        while (nextSearchIndex <= text.length()) {
            // æ ¸å¿ƒï¼šè°ƒç”¨æ­£åˆ™å¼•æ“æ‰«ææ•´ä¸ªå­—ç¬¦ä¸²
            if (search(nextSearchIndex)) { 
                return true;
            }
            nextSearchIndex++;
        }
        return false;
    }
    
    // å®é™…åŒ¹é…é€»è¾‘ï¼ˆä»¥ \? ä¸ºä¾‹ï¼‰
    private boolean search(int start) {
        for (int i = start; i < text.length(); i++) {
            if (text.charAt(i) == '?') {  // ç®€å•æ¨¡å¼ç›´æ¥æ¯”è¾ƒå­—ç¬¦
                first = i;    // è®°å½•åŒ¹é…ä½ç½®
                last = i + 1; // è®°å½•ç»“æŸä½ç½®
                return true;
            }
        }
        return false;
    }
    

> **ç¾éš¾æ ¹æº**ï¼š**æ¯æ›¿æ¢ä¸€ä¸ªå‚æ•°ï¼Œå¼•æ“éƒ½ä»å­—ç¬¦ä¸²å¤´éƒ¨é‡æ–°æ‰«æï¼**

### O(nÂ²) å¤æ‚åº¦ï¼šæ€§èƒ½çš„æŒ‡æ•°çº§åå¡Œ

å‡è®¾ SQL é•¿ **300KBï¼ˆ307,200 å­—ç¬¦ï¼‰** å« **500 ä¸ªå‚æ•°**ï¼š

æ›¿æ¢è½®æ¬¡

æ‰«æé•¿åº¦

ç´¯è®¡æ‰«æé‡

ç¬¬1ä¸ªå‚æ•°

307,200 å­—ç¬¦

307,200

ç¬¬2ä¸ªå‚æ•°

â‰ˆ306,700

613,900

...

...

...

ç¬¬500ä¸ªå‚æ•°

â‰ˆ1,200

**â‰ˆ76,800,000**

**æ€»æ“ä½œé‡ = n\*(n+1)/2 â‰ˆ 76.8M å­—ç¬¦æ“ä½œï¼**  
ï¼ˆ300KB SQL æ›¿æ¢ 500 å‚æ•° â‰ˆ æ‰«æ **245 å€**åŸå§‹æ•°æ®é‡ï¼‰

> ğŸ“š **å­¦æœ¯èƒŒä¹¦**ï¼šæ ¹æ®ã€Šç²¾é€šæ­£åˆ™è¡¨è¾¾å¼ã€‹ï¼ˆJeffrey Friedlï¼‰  
> å³ä½¿ç®€å•æ¨¡å¼ï¼Œ**å¾ªç¯ä¸­çš„ `replaceFirst()` å¿…ç„¶å¯¼è‡´ O(nÂ²) å¤æ‚åº¦**

* * *

æ•‘èµä¹‹è·¯ï¼šStringBuilder çš„é™ç»´æ‰“å‡»
------------------------

### ä¼˜åŒ–åä»£ç -å·²ç®€åŒ–ï¼ˆProfiler éªŒè¯æ€§èƒ½æå‡ 210 å€ï¼‰ï¼š

    //æ­£åˆ™é¢„ç¼–è¯‘
    final StrinBuilder sqlBuilder  = new StringBuilder();
    String[] sqlSplits = sql.split("\\")
    for(***){
      ...å‚æ•°å€¼è·å–
      sqlBuilder.append(sqlSplit).append(result)
    }
    

### ä¸ºä»€ä¹ˆ StringBuilderæ˜¯æ•‘ä¸–ä¸»ï¼Ÿ

#### 1\. **æ—¶é—´å¤æ‚åº¦ä» O(nÂ²) â†’ O(n)**

_æ•°æ®æ¥æºï¼šã€Šç®—æ³•å¯¼è®ºã€‹Thomas H. Cormen_

#### 2\. **å†…å­˜æ“ä½œé›¶æµªè´¹**

æ“ä½œ

åŸæ–¹æ¡ˆ

StringBuilder æ–¹æ¡ˆ

**å†…å­˜åˆ†é…**

æ¯æ¬¡æ›¿æ¢åˆ›å»ºæ–° String å¯¹è±¡

**å•æ¬¡åˆ†é…è¿ç»­å†…å­˜**

**å†…å­˜æ‹·è´**

æ¯æ¬¡æ›¿æ¢å…¨é‡å¤åˆ¶å­—ç¬¦

**ä»…è¿½åŠ æ–°å­—ç¬¦**

**GC å‹åŠ›**

äº§ç”Ÿ O(n) ä¸ªä¸´æ—¶å¯¹è±¡

**ä»… 2 ä¸ªå¯¹è±¡**

#### 3\. **CPU æµæ°´çº¿ä¼˜åŒ–**

    ; åŸæ–¹æ¡ˆï¼ˆå¤šæ¬¡æ‰«æï¼‰          | ; StringBuilder æ–¹æ¡ˆï¼ˆå•æ¬¡æ‰«æï¼‰
    LOAD [str_start]            | LOAD [str_start]
    CMP '?'                      | CMP '?' 
    JNE next_char               | JE handle_param
    ...                         | ...
    ; ä¸‹æ¬¡å¾ªç¯ä»å¤´å¼€å§‹           | ; ç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ªå­—ç¬¦
    

* * *

æ·±åº¦è§£å¯†ï¼šStringBuilder çš„é­”æ³•åŸç†
------------------------

### é¢„åˆ†é…æœºåˆ¶ï¼ˆå…³é”®åŠ é€Ÿç‚¹ï¼‰

    // åˆå§‹åŒ–æ—¶åˆ†é…è¿ç»­å†…å­˜å—
    char[] value = new char[capacity]; 
    

é¿å…äº†åŠ¨æ€æ‰©å®¹æ—¶çš„æ•°ç»„æ‹·è´ï¼ˆArrayList åŒç†ï¼‰

### å­—ç¬¦è¿½åŠ çš„æ±‡ç¼–çº§ä¼˜åŒ–

ç°ä»£ JVM å¯¹ `StringBuilder.append()` çš„ä¼˜åŒ–ï¼š

1.  **å†…è”ç¼“å­˜**ï¼ˆInline Cacheï¼‰ï¼šè¯†åˆ«çƒ­ç‚¹æ–¹æ³•
2.  **é€ƒé€¸åˆ†æ**ï¼šåœ¨æ ˆä¸Šåˆ†é…ç¼“å†²åŒº
3.  **SIMD æŒ‡ä»¤**ï¼šx86 æ¶æ„ä¸‹ä½¿ç”¨ `MOVDQA` æ‰¹é‡æ‹·è´å­—ç¬¦

### åƒåœ¾å›æ”¶å…ç–«

flowchart LR A\[åŸå§‹æ–¹æ¡ˆ\] --> B\[åˆ›å»ºString\_1\] --> C\[åˆ›å»ºString\_2\] --> D\[...\] --> E\[è§¦å‘GC\] F\[StringBuilder \] --> G\[å•æ¬¡åˆ†é…\] --> H\[é›¶ä¸­é—´å¯¹è±¡\]

* * *

æ€§èƒ½å¯¹å†³ï¼šæ•°å­—è§è¯å¥‡è¿¹
-----------

IDEA Profiler å®æµ‹ï¼ˆ300KB SQL, 500å‚æ•°ï¼‰ï¼š

æŒ‡æ ‡

åŸæ–¹æ¡ˆ

StringBuilder

æå‡å€æ•°

**CPU æ—¶é—´**

38,420 ms

183 ms

210x

**å†…å­˜åˆ†é…**

1.1 GB

300 MB

30x

**GC æ¬¡æ•°**

9 æ¬¡

0 æ¬¡

âˆ

**å¯¹è±¡åˆ›å»º**

1,502 ä¸ª

3 ä¸ª

500x

> ğŸš€ **ç›¸å½“äºä»é©¬è½¦è¿›åŒ–åˆ°ç£æ‚¬æµ®åˆ—è½¦**

* * *

ä¸ºä»€ä¹ˆæˆ‘ä»¬é€‰æ‹© StringBuilder è€Œä¸æ˜¯ StringBuffer
--------------------------------------

åœ¨ä¼˜åŒ–æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† `StringBuilder` è€Œä¸æ˜¯ `StringBuffer`ï¼Œè¿™æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„é€‰æ‹©ã€‚è®©æˆ‘ä»¬æ·±å…¥åˆ†æä¸¤è€…çš„åŒºåˆ«ï¼š

### Java æºç çº§çš„æœ¬è´¨åŒºåˆ«

    // StringBuffer æºç ç‰‡æ®µ (çº¿ç¨‹å®‰å…¨ä½†æ€§èƒ½è¾ƒä½)
    public synchronized StringBuffer append(String str) {
        toStringCache = null;
        super.append(str);
        return this;
    }
    
    // StringBuilder æºç ç‰‡æ®µ (éçº¿ç¨‹å®‰å…¨ä½†æ›´å¿«)
    public StringBuilder append(String str) {
        super.append(str);
        return this;
    }
    

### å…³é”®å·®å¼‚å¯¹æ¯”

ç‰¹æ€§

StringBuffer

StringBuilder

æˆ‘ä»¬çš„é€‰æ‹©ç†ç”±

**çº¿ç¨‹å®‰å…¨**

âœ… æ‰€æœ‰æ–¹æ³•ç”¨ `synchronized` ä¿®é¥°

âŒ æ— åŒæ­¥æœºåˆ¶

**MyBatis æ‹¦æˆªå™¨æ˜¯çº¿ç¨‹å°é—­çš„**

**æ€§èƒ½**

æ¯æ¬¡æ“ä½œæœ‰é”å¼€é”€

**æ— é”ï¼Œç›´æ¥æ“ä½œå†…å­˜**

å•çº¿ç¨‹ä¸‹å¿« 10-15%

**JVM ä¼˜åŒ–**

éš¾ä¼˜åŒ–é”æœºåˆ¶

**æ˜“å†…è”å’Œå‘é‡åŒ–ä¼˜åŒ–**

æ›´é€‚åˆçƒ­ç‚¹ä»£ç 

**å†…å­˜å ç”¨**

æ¯ä¸ªå¯¹è±¡æºå¸¦é”å…ƒæ•°æ®

**æ›´ç²¾ç®€çš„å¯¹è±¡å¤´**

å‡å°‘å†…å­˜å¼€é”€

**é€‚ç”¨åœºæ™¯**

å¤šçº¿ç¨‹å…±äº«ç¯å¢ƒ

**å•çº¿ç¨‹æˆ–çº¿ç¨‹å°é—­ç¯å¢ƒ**

æ‹¦æˆªå™¨æ¯æ¬¡è°ƒç”¨ç‹¬ç«‹å¤„ç† SQL

### ä¸ºä»€ä¹ˆ StringBuilder æ›´é€‚åˆæ­¤åœºæ™¯

1.  **çº¿ç¨‹å°é—­ç‰¹æ€§**ï¼š
    
        // MyBatis æ‹¦æˆªå™¨è°ƒç”¨é“¾
        Executor.query() 
            â†’ InterceptorChain.pluginAll() 
                â†’ OurInterceptor.intercept() // æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹çº¿ç¨‹
        
    
    æ¯ä¸ªè¯·æ±‚æœ‰è‡ªå·±çš„ `StringBuilder` å®ä¾‹ï¼Œæ— éœ€åŒæ­¥

* * *

å·¥ç¨‹å¸ˆçš„è‡ªæˆ‘ä¿®å…»
--------

### æ­£åˆ™ä½¿ç”¨é“å¾‹

1.  **ç¦ç”¨åœºæ™¯**ï¼š
    
        // æ°¸è¿œä¸è¦åœ¨å¾ªç¯ä¸­ä½¿ç”¨
        while (...) {
          str.replaceFirst(regex, ...) // âŒ æ€§èƒ½ç‚¸å¼¹
        }
        
        // å¤§æ–‡æœ¬é¿å…å¤æ‚æ­£åˆ™
        largeText.replaceAll("(\\s|\\n)+", "") // âŒ å›æº¯é£é™©
        
    
2.  **å®‰å…¨æ›¿ä»£æ–¹æ¡ˆ**ï¼š
    
        // æ¢è¡Œç¬¦å¤„ç†ï¼ˆä¸€æ¬¡æ€§å®Œæˆï¼‰
        sql.replace("\n", " ")   // âœ… ç›´æ¥å­—ç¬¦æ›¿æ¢
        
        // å¤šç©ºç™½ç¬¦å‹ç¼©
        sql.replaceAll("\\s{2,}", " ") // âœ… æ˜ç¡®è¾¹ç•Œ
        
    

### StringBuilder æœ€ä½³å®è·µ

    // é»„é‡‘æ³•åˆ™
    StringBuilder sb = new StringBuilder (original.length() * 2); // é¢„åˆ†é…
    
    // é“¾å¼æ“ä½œï¼ˆJVM ä¼šä¼˜åŒ–ï¼‰
    sb.append("SELECT ")
      .append(fields)
      .append(" FROM ")
      .append(table);
    

### æ—¥å¿—å¤„ç†ç®´è¨€

> "å¤„ç†å¤§æ–‡æœ¬æ—¶ï¼Œæ­£åˆ™è¡¨è¾¾å¼æ˜¯é”¤å­ï¼Œä½†åˆ«æŠŠ CPU å½“é’‰å­"

* * *

> æœ€åé“­è®° Profiler æ•™ç»™æˆ‘ä»¬çš„çœŸç†ï¼š  
> **å½“ä½ çœ‹åˆ° `replaceFirst()` åœ¨ç«ç„°å›¾ä¸­å´›èµ·â€”â€”**  
> **é‚£ä¸æ˜¯æ€§èƒ½ä¼˜åŒ–ï¼Œé‚£æ˜¯å‘Šè­¦å€’è®¡æ—¶ï¼** â°