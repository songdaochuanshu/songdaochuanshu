---
layout: post
title: 'ã€ŒC++é»‘é­”æ³•ã€futureä¸promiseï¼šä¸åŠ é”çš„å¼‚æ­¥ç¼–ç¨‹ï¼ŒåŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•ï¼'
date: "2025-05-25T00:45:53Z"
---
ã€ŒC++é»‘é­”æ³•ã€futureä¸promiseï¼šä¸åŠ é”çš„å¼‚æ­¥ç¼–ç¨‹ï¼ŒåŸæ¥å¯ä»¥è¿™ä¹ˆç®€å•ï¼
=========================================

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚

ä½ æ˜¯å¦æ›¾ç»ä¸ºäº†è®©ç¨‹åºåŒæ—¶åšå¤šä»¶äº‹è€Œç»å°½è„‘æ±ï¼Ÿæ˜¯å¦è¢«å¤šçº¿ç¨‹ç¼–ç¨‹çš„å„ç§é”ã€æ¡ä»¶å˜é‡æå¾—å¤´æ˜è„‘èƒ€ï¼Ÿä»Šå¤©ï¼Œæˆ‘è¦å‘Šè¯‰ä½ ä¸€ä¸ªç§˜å¯†æ­¦å™¨ï¼Œè®©ä½ è½»æ¾é©¾é©­å¼‚æ­¥ç¼–ç¨‹çš„æµ·æ´‹ï¼

å‰è¨€ï¼šä¸ºä»€ä¹ˆè¦å­¦futureå’Œpromiseï¼Ÿ
-----------------------

æœ‹å‹ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼šä½ åœ¨é¤å…ç‚¹äº†ä¸€ä»½éœ€è¦20åˆ†é’Ÿæ‰èƒ½åšå¥½çš„å¤æ‚èœå“ã€‚ä½ æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š

1.  ååœ¨é‚£é‡Œç›¯ç€å¨æˆ¿é—¨å£ï¼Œç­‰å¾…20åˆ†é’Ÿï¼ˆåŒæ­¥ç­‰å¾…ï¼‰
2.  æœåŠ¡å‘˜ç»™äº†ä½ ä¸ªå–é¤ç ï¼Œèœå“å¥½äº†ä¼šé€šçŸ¥ä½ ï¼ŒåŒæ—¶ä½ å¯ä»¥åˆ·åˆ·æ‰‹æœºæˆ–èŠèŠå¤©ï¼ˆå¼‚æ­¥ç­‰å¾…ï¼‰

æ˜¾ç„¶ï¼Œç¬¬äºŒç§æ–¹å¼æ›´é«˜æ•ˆï¼Œå¯¹å§ï¼Ÿ

åœ¨C++ç¼–ç¨‹ä¸­ï¼Œ`future`å’Œ`promise`å°±åƒæ˜¯è¿™ä¸ª"å–é¤ç +é€šçŸ¥"ç³»ç»Ÿï¼Œè®©ä½ çš„ç¨‹åºèƒ½å¤Ÿä¼˜é›…åœ°å¤„ç†å¼‚æ­¥ä»»åŠ¡ã€‚å®ƒä»¬æ˜¯C++11å¼•å…¥çš„ç°ä»£å¹¶å‘ç¼–ç¨‹å·¥å…·ï¼Œæ¯”ä¼ ç»Ÿçš„çº¿ç¨‹ã€äº’æ–¥é”å’Œæ¡ä»¶å˜é‡æ›´åŠ ç®€å•æ˜“ç”¨ã€‚

ä¸€ã€å¼‚æ­¥ä»»åŠ¡æ˜¯ä¸ªå•¥ï¼Ÿé€šä¿—åœ°è¯´å°±æ˜¯"åå°è¿è¡Œ"
----------------------

åœ¨è§£é‡Š`future`å’Œ`promise`ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠä»€ä¹ˆæ˜¯å¼‚æ­¥ä»»åŠ¡ã€‚

**å¼‚æ­¥ä»»åŠ¡**å°±æ˜¯æŒ‡é‚£äº›å¯ä»¥åœ¨"åå°"æ‰§è¡Œï¼Œä¸éœ€è¦ä¸»çº¿ç¨‹ç­‰å¾…çš„ä»»åŠ¡ã€‚æ¯”å¦‚ï¼š

*   ä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶
*   å¤æ‚è®¡ç®—ï¼ˆå¦‚å›¾åƒå¤„ç†ï¼‰
*   è®¿é—®è¿œç¨‹æœåŠ¡å™¨

æƒ³è±¡ä¸€ä¸‹ä½ çš„ç”µè„‘åœ¨ä¸‹è½½æ¸¸æˆçš„åŒæ—¶ï¼Œä½ è¿˜èƒ½ç»§ç»­åˆ·è§†é¢‘ã€èŠå¤©ï¼Œè¿™å°±æ˜¯å¼‚æ­¥çš„é­…åŠ›ï¼

äºŒã€futureï¼šæœªæ¥ä¼šå¾—åˆ°çš„ç»“æœ
-----------------

`future`å¯ä»¥ç†è§£ä¸º"æœªæ¥çš„ç»“æœ"ï¼Œå®ƒå°±åƒä¸€å¼ ç”µå½±ç¥¨æ ¹ï¼š

*   ä½ ç°åœ¨æ‹¿ç€ç¥¨æ ¹ï¼ˆfutureï¼‰
*   ç”µå½±ï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰æ­£åœ¨åå°å‡†å¤‡ä¸­
*   å½“ç”µå½±å‡†å¤‡å¥½äº†ï¼Œä½ å¯ä»¥ç”¨ç¥¨æ ¹è¿›åœºï¼ˆè·å–ç»“æœï¼‰

ç”¨ä»£ç è¯´è¯ï¼š

    #include <iostream>
    #include <future>
    #include <thread>
    #include <chrono>
    
    int compute_answer() {
        // å‡è£…è¿™æ˜¯ä¸ªå¤æ‚è®¡ç®—
        std::cout << "å¼€å§‹è®¡ç®—ç»ˆæé—®é¢˜çš„ç­”æ¡ˆ..." << std::endl;
        std::this_thread::sleep_for(std::chrono::seconds(2)); // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
        std::cout << "è®¡ç®—å®Œæˆï¼" << std::endl;
        return 42; // è¿”å›ç»“æœ
    }
    
    int main() {
        // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡ï¼Œç«‹å³è¿”å›ä¸€ä¸ªfuture
        std::cout << "ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ä¸€ä¸ªè€—æ—¶ä»»åŠ¡" << std::endl;
        std::future<int> answer_future = std::async(compute_answer);
    
        std::cout << "ä¸»çº¿ç¨‹ï¼šå“‡ï¼Œä¸ç”¨ç­‰å¾…ï¼Œæˆ‘å¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…ï¼" << std::endl;
    
        // åšä¸€äº›å…¶ä»–å·¥ä½œ...
        std::this_thread::sleep_for(std::chrono::seconds(1));
        std::cout << "ä¸»çº¿ç¨‹ï¼šæˆ‘åœ¨å¼‚æ­¥ä»»åŠ¡è®¡ç®—çš„åŒæ—¶åšäº†äº›å…¶ä»–äº‹" << std::endl;
    
        // å½“éœ€è¦ç»“æœæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è·å–å®ƒ
        // å¦‚æœç»“æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œè¿™ä¼šé˜»å¡ç›´åˆ°ç»“æœå¯ç”¨
        std::cout << "ä¸»çº¿ç¨‹ï¼šå¥½äº†ï¼Œç°åœ¨æˆ‘éœ€è¦çŸ¥é“ç­”æ¡ˆäº†ï¼Œç­‰å¾…ç»“æœ..." << std::endl;
        int answer = answer_future.get();
    
        std::cout << "ç»ˆæç­”æ¡ˆæ˜¯ï¼š" << answer << std::endl;
    
        return 0;
    }
    

**è¾“å‡ºç»“æœ**ï¼š

    ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ä¸€ä¸ªè€—æ—¶ä»»åŠ¡
    å¼€å§‹è®¡ç®—ç»ˆæé—®é¢˜çš„ç­”æ¡ˆ...
    ä¸»çº¿ç¨‹ï¼šå“‡ï¼Œä¸ç”¨ç­‰å¾…ï¼Œæˆ‘å¯ä»¥ç»§ç»­åšå…¶ä»–äº‹æƒ…ï¼
    ä¸»çº¿ç¨‹ï¼šæˆ‘åœ¨å¼‚æ­¥ä»»åŠ¡è®¡ç®—çš„åŒæ—¶åšäº†äº›å…¶ä»–äº‹
    è®¡ç®—å®Œæˆï¼
    ä¸»çº¿ç¨‹ï¼šå¥½äº†ï¼Œç°åœ¨æˆ‘éœ€è¦çŸ¥é“ç­”æ¡ˆäº†ï¼Œç­‰å¾…ç»“æœ...
    ç»ˆæç­”æ¡ˆæ˜¯ï¼š42
    

çœ‹åˆ°äº†å—ï¼Ÿä¸»çº¿ç¨‹å¯åŠ¨äº†è®¡ç®—ï¼Œä½†å¹¶ä¸ç«‹å³ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå…¶ä»–ä»£ç ã€‚åªæœ‰å½“çœŸæ­£éœ€è¦ç»“æœæ—¶ï¼ˆè°ƒç”¨`get()`ï¼‰ï¼Œæ‰ä¼šç­‰å¾…å¼‚æ­¥ä»»åŠ¡å®Œæˆã€‚

ä¸‰ã€promiseï¼šæˆ‘ä¿è¯ä¼šç»™ä½ ç»“æœ
------------------

å¦‚æœè¯´`future`æ˜¯é¢†å–ç»“æœçš„å‡­è¯ï¼Œé‚£ä¹ˆ`promise`å°±æ˜¯ä¸€ä¸ªæ‰¿è¯ºï¼š"æˆ‘ä¿è¯ä¼šåœ¨æŸä¸ªæ—¶åˆ»è®¾ç½®ä¸€ä¸ªå€¼"ã€‚å®ƒä»¬æ˜¯ä¸€å¯¹å¥½æ­æ¡£ï¼š

*   `promise`è´Ÿè´£åœ¨æŸä¸ªæ—¶åˆ»è®¾ç½®ç»“æœ
*   `future`è´Ÿè´£åœ¨éœ€è¦æ—¶è·å–ç»“æœ

è¿™å°±åƒä½ å’Œæœ‹å‹çš„çº¦å®šï¼š

*   ä½ ï¼šæˆ‘æ‰¿è¯ºä¼šå‘Šè¯‰ä½ è€ƒè¯•æˆç»©ï¼ˆpromiseï¼‰
*   æœ‹å‹ï¼šæˆ‘ä¼šç­‰ä½ å‘Šè¯‰æˆ‘ï¼ˆfutureï¼‰

æ¥çœ‹ä¸ªä¾‹å­ï¼š

    #include <iostream>
    #include <future>
    #include <thread>
    #include <chrono>
    
    void producer(std::promise<int> my_promise) {
        std::cout << "ç”Ÿäº§è€…ï¼šæˆ‘è¦å¼€å§‹ç”Ÿäº§ä¸€ä¸ªé‡è¦çš„å€¼äº†..." << std::endl;
    
        // å‡è£…æˆ‘ä»¬åœ¨åšä¸€äº›å¤æ‚çš„è®¡ç®—
        std::this_thread::sleep_for(std::chrono::seconds(2));
    
        int result = 42;
        std::cout << "ç”Ÿäº§è€…ï¼šè®¡ç®—å®Œæˆï¼Œè®¾ç½®ç»“æœåˆ°promise" << std::endl;
    
        // è®¾ç½®promiseçš„å€¼ï¼Œè¿™ä¼šé€šçŸ¥ç›¸å…³çš„future
        my_promise.set_value(result);
    }
    
    int main() {
        // åˆ›å»ºä¸€ä¸ªpromise
        std::promise<int> answer_promise;
    
        // ä»promiseè·å–ä¸€ä¸ªfuture
        std::future<int> answer_future = answer_promise.get_future();
    
        // å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä¼ å…¥promise
        std::cout << "ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹" << std::endl;
        std::thread producer_thread(producer, std::move(answer_promise));
    
        // ä¸»çº¿ç¨‹ç»§ç»­åšå…¶ä»–äº‹æƒ…
        std::cout << "ä¸»çº¿ç¨‹ï¼šæˆ‘å¯ä»¥åšè‡ªå·±çš„äº‹ï¼Œä¸ç”¨ç­‰å¾…..." << std::endl;
        std::this_thread::sleep_for(std::chrono::seconds(1));
    
        // å½“éœ€è¦ç»“æœæ—¶
        std::cout << "ä¸»çº¿ç¨‹ï¼šç°åœ¨æˆ‘éœ€è¦ç»“æœäº†ï¼Œç­‰å¾…future..." << std::endl;
        int answer = answer_future.get();
        std::cout << "ä¸»çº¿ç¨‹ï¼šæ”¶åˆ°ç»“æœï¼š" << answer << std::endl;
    
        // åˆ«å¿˜äº†ç­‰å¾…çº¿ç¨‹ç»“æŸ
        producer_thread.join();
    
        return 0;
    }
    

**è¾“å‡ºç»“æœ**ï¼š

    ä¸»çº¿ç¨‹ï¼šå¯åŠ¨ç”Ÿäº§è€…çº¿ç¨‹
    ç”Ÿäº§è€…ï¼šæˆ‘è¦å¼€å§‹ç”Ÿäº§ä¸€ä¸ªé‡è¦çš„å€¼äº†...
    ä¸»çº¿ç¨‹ï¼šæˆ‘å¯ä»¥åšè‡ªå·±çš„äº‹ï¼Œä¸ç”¨ç­‰å¾…...
    ä¸»çº¿ç¨‹ï¼šç°åœ¨æˆ‘éœ€è¦ç»“æœäº†ï¼Œç­‰å¾…future...
    ç”Ÿäº§è€…ï¼šè®¡ç®—å®Œæˆï¼Œè®¾ç½®ç»“æœåˆ°promise
    ä¸»çº¿ç¨‹ï¼šæ”¶åˆ°ç»“æœï¼š42
    

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨`promise`å’Œ`future`åœ¨çº¿ç¨‹é—´ä¼ é€’ç»“æœã€‚ç”Ÿäº§è€…çº¿ç¨‹é€šè¿‡`promise`è®¾ç½®å€¼ï¼Œä¸»çº¿ç¨‹é€šè¿‡`future`è·å–å€¼ã€‚

å››ã€futureçš„å‡ ç§è·å–æ–¹å¼
---------------

é™¤äº†é€šè¿‡`promise`è·å–`future`ï¼ŒC++11è¿˜æä¾›äº†å…¶ä»–ä¾¿æ·æ–¹å¼ï¼š

### 1\. é€šè¿‡asyncè·å–future

`std::async`æ˜¯æœ€ç®€å•çš„æ–¹å¼ï¼Œå®ƒè‡ªåŠ¨åˆ›å»ºçº¿ç¨‹å¹¶è¿”å›`future`ï¼š

    std::future<int> result = std::async([]() {
        return 42;
    });
    

### 2\. é€šè¿‡packaged\_taskè·å–future

`std::packaged_task`åŒ…è£…äº†ä¸€ä¸ªå¯è°ƒç”¨å¯¹è±¡ï¼Œå¹¶å…è®¸ä½ è·å–å…¶`future`ï¼š

    #include <iostream>
    #include <future>
    #include <thread>
    
    int main() {
        // åˆ›å»ºä¸€ä¸ªpackaged_taskï¼ŒåŒ…è£…ä¸€ä¸ªlambdaå‡½æ•°
        std::packaged_task<int(int, int)> task([](int a, int b) {
            std::cout << "è®¡ç®— " << a << " + " << b << std::endl;
            std::this_thread::sleep_for(std::chrono::seconds(1)); // æ¨¡æ‹Ÿè€—æ—¶è®¡ç®—
            return a + b;
        });
    
        // è·å–future
        std::future<int> result = task.get_future();
    
        // åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡
        std::thread task_thread(std::move(task), 10, 32);
    
        // ä¸»çº¿ç¨‹åšå…¶ä»–äº‹æƒ…...
        std::cout << "ä¸»çº¿ç¨‹ï¼šç­‰å¾…è®¡ç®—ç»“æœ..." << std::endl;
    
        // è·å–ç»“æœ
        int sum = result.get();
        std::cout << "ç»“æœæ˜¯ï¼š" << sum << std::endl;
    
        task_thread.join();
        return 0;
    }
    

**è¾“å‡ºç»“æœ**ï¼š

    ä¸»çº¿ç¨‹ï¼šç­‰å¾…è®¡ç®—ç»“æœ...
    è®¡ç®— 10 + 32
    ç»“æœæ˜¯ï¼š42
    

äº”ã€å®ç”¨åŠŸèƒ½ï¼šfutureçš„è¶…æ—¶ç­‰å¾…
------------------

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸æƒ³æ— é™æœŸåœ°ç­‰å¾…å¼‚æ­¥ä»»åŠ¡ã€‚`future`æä¾›äº†å¸¦è¶…æ—¶çš„ç­‰å¾…åŠŸèƒ½ï¼š

    #include <iostream>
    #include <future>
    #include <chrono>
    
    int long_calculation() {
        std::this_thread::sleep_for(std::chrono::seconds(3));
        return 42;
    }
    
    int main() {
        auto future = std::async(std::launch::async, long_calculation);
    
        // è®¾ç½®1ç§’è¶…æ—¶
        auto status = future.wait_for(std::chrono::seconds(1));
    
        if (status == std::future_status::ready) {
            std::cout << "ä»»åŠ¡å·²å®Œæˆï¼Œç»“æœæ˜¯ï¼š" << future.get() << std::endl;
        } else if (status == std::future_status::timeout) {
            std::cout << "ç­‰å¾…è¶…æ—¶ï¼ä»»åŠ¡è¿˜æ²¡å®Œæˆ" << std::endl;
    
            // æˆ‘ä»¬ä»ç„¶å¯ä»¥ç»§ç»­ç­‰å¾…å®Œæˆ
            std::cout << "ç»§ç»­ç­‰å¾…..." << std::endl;
            std::cout << "æœ€ç»ˆç»“æœï¼š" << future.get() << std::endl;
        }
    
        return 0;
    }
    

**è¾“å‡ºç»“æœ**ï¼š

    ç­‰å¾…è¶…æ—¶ï¼ä»»åŠ¡è¿˜æ²¡å®Œæˆ
    ç»§ç»­ç­‰å¾…...
    æœ€ç»ˆç»“æœï¼š42
    

å…­ã€å¼‚å¸¸å¤„ç†ï¼šå½“å¼‚æ­¥ä»»åŠ¡å‡ºé”™æ—¶
---------------

å¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼šè¢«æ•è·å¹¶å­˜å‚¨åœ¨`future`ä¸­ï¼Œå½“ä½ è°ƒç”¨`get()`æ—¶ä¼šé‡æ–°æŠ›å‡ºï¼š

    #include <iostream>
    #include <future>
    #include <stdexcept>
    
    int may_throw() {
        std::this_thread::sleep_for(std::chrono::seconds(1));
        throw std::runtime_error("å“å‘€ï¼Œå‡ºé”™äº†ï¼");
        return 42;
    }
    
    int main() {
        auto future = std::async(may_throw);
    
        try {
            int result = future.get();
            std::cout << "ç»“æœï¼š" << result << std::endl;
        } catch (const std::exception& e) {
            std::cout << "æ•è·åˆ°å¼‚å¸¸ï¼š" << e.what() << std::endl;
        }
    
        return 0;
    }
    

**è¾“å‡ºç»“æœ**ï¼š

    æ•è·åˆ°å¼‚å¸¸ï¼šå“å‘€ï¼Œå‡ºé”™äº†ï¼
    

è¿™ç§è®¾è®¡éå¸¸ä¼˜é›…â€”â€”æ— è®ºå¼‚æ­¥ä»»åŠ¡æ˜¯æˆåŠŸè¿”å›å€¼è¿˜æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼Œéƒ½èƒ½é€šè¿‡åŒä¸€ä¸ª`future`æ¥å£å¤„ç†ã€‚

ä¸ƒã€å®é™…åº”ç”¨æ¡ˆä¾‹ï¼šå¹¶è¡Œè®¡ç®—æ±‚å’Œ
---------------

è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªæ›´å®ç”¨çš„ä¾‹å­æ¥å·©å›ºç†è§£ï¼šå¹¶è¡Œè®¡ç®—å¤§æ•°ç»„çš„å’Œã€‚

    #include <iostream>
    #include <vector>
    #include <numeric>
    #include <future>
    #include <chrono>
    
    // è®¡ç®—æ•°ç»„éƒ¨åˆ†å’Œçš„å‡½æ•°
    long long partial_sum(const std::vector<int>& data, size_t start, size_t end) {
        return std::accumulate(data.begin() + start, data.begin() + end, 0LL);
    }
    
    int main() {
        // åˆ›å»ºä¸€ä¸ªå¤§æ•°ç»„
        const size_t size = 100000000; // 1äº¿ä¸ªå…ƒç´ 
        std::vector<int> data(size, 1); // å…¨æ˜¯1çš„æ•°ç»„
    
        auto start_time = std::chrono::high_resolution_clock::now();
    
        // å•çº¿ç¨‹è®¡ç®—
        long long single_result = std::accumulate(data.begin(), data.end(), 0LL);
    
        auto single_end = std::chrono::high_resolution_clock::now();
        auto single_duration = std::chrono::duration_cast<std::chrono::milliseconds>(single_end - start_time);
    
        std::cout << "å•çº¿ç¨‹ç»“æœ: " << single_result << " (è€—æ—¶: " 
            << single_duration.count() << "ms)" << std::endl;
    
        // ä½¿ç”¨4ä¸ªçº¿ç¨‹å¹¶è¡Œè®¡ç®—
        auto multi_start = std::chrono::high_resolution_clock::now();
    
        const size_t num_threads = 4;
        const size_t block_size = size / num_threads;
    
        std::vector<std::future<long long>> futures;
    
        for (size_t i = 0; i < num_threads; ++i) {
            size_t start = i * block_size;
            size_t end = (i == num_threads - 1) ? size : (i + 1) * block_size;
    
            // å¯åŠ¨å¼‚æ­¥ä»»åŠ¡
            futures.push_back(std::async(std::launch::async, 
                partial_sum, std::ref(data), start, end));
        }
    
        // æ”¶é›†ç»“æœ
        long long multi_result = 0;
        for (auto& f : futures) {
            multi_result += f.get();
        }
    
        auto multi_end = std::chrono::high_resolution_clock::now();
        auto multi_duration = std::chrono::duration_cast<std::chrono::milliseconds>(multi_end - multi_start);
    
        std::cout << "å¤šçº¿ç¨‹ç»“æœ: " << multi_result << " (è€—æ—¶: " 
            << multi_duration.count() << "ms)" << std::endl;
    
        std::cout << "åŠ é€Ÿæ¯”: " << static_cast<double>(single_duration.count()) / multi_duration.count() << "x" << std::endl;
    
        return 0;
    }
    

**å¯èƒ½çš„è¾“å‡ºç»“æœ**ï¼ˆå–å†³äºä½ çš„ç¡¬ä»¶ï¼‰ï¼š

    å•çº¿ç¨‹ç»“æœ: 100000000 (è€—æ—¶: 570ms)
    å¤šçº¿ç¨‹ç»“æœ: 100000000 (è€—æ—¶: 171ms)
    åŠ é€Ÿæ¯”: 3.33333x
    

çœ‹åˆ°æ²¡ï¼Ÿå¤šçº¿ç¨‹ç‰ˆæœ¬æ˜æ˜¾æ›´å¿«ï¼è¿™æ­£æ˜¯`future`çš„ä»·å€¼æ‰€åœ¨â€”â€”è®©å¹¶è¡Œç¼–ç¨‹å˜å¾—ç®€å•è€Œé«˜æ•ˆã€‚

å…«ã€æ€»ç»“ï¼šä¸ºä»€ä¹ˆfutureå’Œpromiseè¿™ä¹ˆé¦™ï¼Ÿ
--------------------------

ç°åœ¨ï¼Œä½ å·²ç»äº†è§£äº†C++11ä¸­`future`å’Œ`promise`çš„åŸºæœ¬ç”¨æ³•ã€‚å®ƒä»¬çš„ä¼˜åŠ¿åœ¨äºï¼š

1.  **ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹**ï¼šæ¯”ç›´æ¥ç®¡ç†çº¿ç¨‹ã€äº’æ–¥é”å’Œæ¡ä»¶å˜é‡ç®€å•å¾—å¤š
2.  **æ¸…æ™°çš„æ‰€æœ‰æƒæ¨¡å‹**ï¼š`promise`è´Ÿè´£ç”Ÿäº§å€¼ï¼Œ`future`è´Ÿè´£æ¶ˆè´¹å€¼
3.  **å¼‚å¸¸ä¼ é€’**ï¼šå¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼šè‡ªåŠ¨ä¼ é€’ç»™ç­‰å¾…çš„`future`
4.  **è¶…æ—¶æ§åˆ¶**ï¼šå¯ä»¥è®¾ç½®ç­‰å¾…è¶…æ—¶ï¼Œé¿å…æ— é™é˜»å¡
5.  **ä¸ç°ä»£C++å®Œç¾èåˆ**ï¼šé…åˆlambdaã€æ™ºèƒ½æŒ‡é’ˆç­‰ç°ä»£ç‰¹æ€§ä½¿ç”¨æ›´åŠ ä¼˜é›…

è®°ä½è¿™ä¸ªç±»æ¯”å°±è¡Œï¼š`promise`å°±åƒä¸€ä¸ª"æ‰¿è¯ºç»™ä½ ç»“æœçš„äºº"ï¼Œ`future`å°±åƒ"ç­‰å¾…ç»“æœçš„å‡­è¯"ã€‚

ä¸‹æ¬¡å½“ä½ éœ€è¦åœ¨ç¨‹åºä¸­æ‰§è¡Œè€—æ—¶æ“ä½œåˆä¸æƒ³é˜»å¡ä¸»çº¿ç¨‹æ—¶ï¼Œå°±æƒ³åˆ°`future`å’Œ`promise`å§ï¼å®ƒä»¬ä¼šè®©ä½ çš„ä»£ç æ›´åŠ ç°ä»£ã€é«˜æ•ˆï¼Œè¿˜èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„å¨åŠ›ã€‚

æœ€åä¸€ä¸ªå°æç¤ºï¼šè™½ç„¶C++11çš„`future`å’Œ`promise`å·²ç»å¾ˆå¼ºå¤§ï¼Œä½†å¦‚æœä½ è¿½æ±‚æ›´é«˜çº§çš„å¼‚æ­¥ç¼–ç¨‹ï¼Œå¯ä»¥è€ƒè™‘çœ‹çœ‹C++20çš„åç¨‹(coroutine)ç‰¹æ€§ï¼Œé‚£åˆæ˜¯å¦ä¸€ä¸ªè®©äººå…´å¥‹çš„è¯é¢˜äº†ï½

* * *

å†™åœ¨æœ€åï¼šè¿™åªæ˜¯å¼‚æ­¥ç¼–ç¨‹æ—…ç¨‹çš„å¼€å§‹...
--------------------

å˜¿ï¼Œæœ‹å‹ï¼çœ‹åˆ°è¿™é‡Œï¼Œä½ å·²ç»æŒæ¡äº†C++å¼‚æ­¥ç¼–ç¨‹çš„ä¸€æŠŠåˆ©å™¨äº†ï¼ä½†ç¼–ç¨‹ä¸–ç•Œå°±åƒå®‡å®™ä¸€æ ·æµ©ç€šæ— è¾¹ï¼Œæˆ‘ä»¬çš„æ¢ç´¢æ‰åˆšåˆšå¼€å§‹ï½

**å­¦åˆ°äº†æ–°çŸ¥è¯†ï¼Ÿæœ‰ç–‘é—®ï¼Ÿæœ‰å¿ƒå¾—ï¼Ÿ**  
ğŸ‘‰ å¿«åˆ°è¯„è®ºåŒºå’Œå¤§å®¶åˆ†äº«å§ï¼æˆ‘ä¼šäº²è‡ªè§£ç­”ä½ çš„æ¯ä¸€ä¸ªé—®é¢˜ã€‚

**å¦‚æœè¿™ç¯‡æ–‡ç« è®©ä½ æœ‰æ‰€æ”¶è·...**  
è¯·ç‚¹èµã€æ”¶è—ã€å…³æ³¨å“¦ï¼Œè¿™å¯¹æˆ‘æ¥è¯´ï¼Œå°±åƒå¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶æ”¶åˆ°çš„ä¸€ä¸ª`promise.set_value()`ä¸€æ ·çè´µï¼è½¬å‘ç»™ä½ çš„ç¨‹åºçŒ¿/åª›æœ‹å‹ï¼Œä»–ä»¬ä¸€å®šä¹Ÿä¼šæ„Ÿè°¢ä½ åˆ†äº«è¿™ä¸ªç¼–ç¨‹"é»‘é­”æ³•"ï¼

**æƒ³è¦æ›´å¤šç¼–ç¨‹"ç¥å™¨"å—ï¼Ÿ**

å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œè·Ÿç€å°åº·å­¦ç¼–ç¨‹ã€ï¼Œè¿™é‡Œæœ‰ï¼š

ğŸš€ **å¤šçº¿ç¨‹ç¼–ç¨‹å®æˆ˜ç§˜ç±** â€”â€” è®©ä½ çš„ç¨‹åºé£èµ·æ¥ï¼ŒCPUæ ¸å¿ƒå…¨åˆ©ç”¨ï¼  
ğŸ” **C++é¢è¯•é¢˜æ·±åº¦è§£æ** â€”â€” é¢è¯•å®˜ï¼šè¿™æ°´å¹³ï¼Œå¿…é¡»ç»™offerï¼  
ğŸ› ï¸ **ç°ä»£C++é«˜çº§æŠ€å·§** â€”â€” C++11/14/17/20æ–°ç‰¹æ€§å…¨è§£æï¼Œä»£ç ç«‹å‡50%ï¼  
ğŸ§© **STLæºç æ¢ç§˜** â€”â€” çœ‹å¤§ç¥æ˜¯æ€ä¹ˆå†™ä»£ç çš„ï¼Œå­¦å°±è¦å­¦æœ€å¥½çš„ï¼  
ğŸ’» **å®æˆ˜é¡¹ç›®åˆ†äº«** â€”â€” çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œå®æˆ˜å‡ºçœŸçŸ¥ï¼

ğŸ‘‡ **æ‰«ç å³å¯å…³æ³¨**ã€‚

![](https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png)

**å“ˆï¼Œæƒ³ä¸æƒ³å’Œä¸€ç¾¤å¿—åŒé“åˆçš„C++çˆ±å¥½è€…ä¸€èµ·äº¤æµï¼Ÿ**

æ‰«æä¸‹æ–¹äºŒç»´ç ï¼ŒåŠ å…¥æˆ‘ä»¬çš„æŠ€æœ¯äº¤æµç¾¤ï¼

ç¾¤é‡Œæœ‰ä»€ä¹ˆï¼Ÿæœ‰å¤§å‚C++å¼€å‘å·¥ç¨‹å¸ˆåé•‡ï¼Œæœ‰çƒ­å¿ƒçš„åŒè¡Œäº’å¸®äº’åŠ©...

é‡åˆ° bug å¡ä½äº†ï¼Ÿä»£ç æ€§èƒ½ä¼˜åŒ–ä¸ä¸Šå»ï¼Ÿé¢è¯•å‡†å¤‡æ²¡æ–¹å‘ï¼Ÿ

åˆ«ç€æ€¥ï¼Œä¸€ä¸ªæ¶ˆæ¯å‘å‡ºå»ï¼Œç¾¤é‡Œçš„å¤§ä½¬ä»¬ç«‹é©¬å¸®ä½ è§£å†³ï¼

![](https://files.mdnice.com/user/48364/971ccaa3-8f57-4e33-8bc9-d0863eeade81.png)

è®°ä½ï¼Œåœ¨ç¼–ç¨‹çš„ä¸–ç•Œé‡Œï¼Œä½ ä»ä¸å­¤å•ã€‚æˆ‘ä»¬çš„`future`å·²ç»è¿æ¥ï¼Œå°±ç­‰ä½ çš„`get()`æ¥è·å–çŸ¥è¯†çš„æœå®äº†ï¼