---
layout: post
title: '物理Data Guard技术深度解析：配置、原理与运维实践'
date: "2025-12-12T00:44:44Z"
---
物理Data Guard技术深度解析：配置、原理与运维实践
-----------------------------

racle物理Data Guard作为成熟可靠的容灾解决方案，凭借其免费、稳定、数据一致性强的特性，成为多数企业数据库容灾的首选。它通过主备库日志传输与应用机制，实现数据实时同步，在主库故障时可快速切换，最大限度降低业务中断风险。本文基于Oracle数据库技术规范，从原理架构、保护模式、配置流程及运维要点四大维度，进行技术性深度拆解。

一、Data Guard核心原理与架构
-------------------

### 1.1 核心工作机制

物理Data Guard的本质是"异机备份+日志实时恢复"的闭环体系，核心依赖主备库间的日志传输与应用流程，关键进程交互如下：

*   主库（Primary Database）：LGWR进程负责将在线日志同步/异步传输至备库，ARCH进程则处理归档日志传输，确保日志完整性；需开启FORCE LOGGING模式，保证所有操作（含NOLOGGING操作）均写入日志。
*   备库（Standby Database）：RFS（Remote File Server）进程接收主库日志，写入Standby Logfile；MRP（Media Recovery Process）进程自动应用归档日志，保持与主库数据一致；若配置实时应用，可实现秒级数据同步。
*   日志校验：FAL（Fetch Archive Log Process）进程检测备库归档日志连续性，避免日志断档导致同步中断，Oracle 10g后该机制已大幅优化。

### 1.2 正常运行的技术前提

*   操作系统兼容性：主备库需采用相同字节序（ENDIAN FORMAT）的操作系统，Oracle 11g后支持Windows与Linux跨平台部署（参考MOS文章413484.1）。
*   网络带宽要求：需满足归档日志传输需求，考虑30%网络损耗，计算公式为：Required bandwidth = ((Redo rate bytes per sec./0.7)\*8)/1000000（单位：Mbps）。
*   存储性能：备库存储需支撑日志快速应用，避免日志应用延迟过大影响容灾可用性；主备库数据文件、日志文件存储路径需通过参数配置映射。
*   版本一致性：主备库数据库软件版本、PSU补丁需保持一致，避免日志应用时因版本差异导致兼容性错误。

二、三种保护模式的技术对比与配置
----------------

Data Guard提供三种保护模式，需根据业务对数据一致性和性能的需求选择，核心配置与特性如下：

### 2.1 最大保护模式（MAXIMUM PROTECTION）

*   核心目标：零数据丢失，事务提交需双重确认。
*   技术配置：日志传输进程为LGWR，网络模式为SYNC（同步），写磁盘模式为AFFIRM（确认）；备库必须配置Standby Logfile。
*   运行特性：主库事务提交前，需等待日志写入本地在线日志和备库Standby Logfile，任一环节失败将导致主库不可用。
*   适用场景：对数据零丢失要求极高的核心业务，需确保备库主机稳定性、网络低延迟及存储高性能。

### 2.2 最大可用模式（MAXIMUM AVAILABILITY）

*   核心目标：兼顾零数据丢失与主库高可用。
*   技术配置：与最大保护模式一致（LGWR+SYNC+AFFIRM+Standby Logfile），建议配置REOPEN参数避免网络故障导致主库挂起。
*   运行特性：正常状态下保持零数据丢失；当备库故障或网络中断时，自动切换至最大性能模式，主库继续运行；故障恢复后自动同步并恢复最大可用模式。
*   注意事项：主备网络不稳定时，可能出现主库短暂等待，需提前测试网络容错能力。

### 2.3 最大性能模式（MAXIMUM PERFORMANCE）

*   核心目标：优先保障主库性能，默认配置模式。
*   技术配置：日志传输进程可为LGWR（ASYNC模式）或ARCH，写磁盘模式为NOAFFIRM（非确认）；备库建议配置Standby Logfile提升同步效率。
*   运行特性：主库事务提交无需等待备库日志写入，仅需确保日志写入本地在线日志，存在极小数据丢失风险（异步传输场景）。
*   适用场景：对性能要求高于数据零丢失的业务，如非核心交易系统、报表系统。

### 2.4 保护模式切换流程

1.  配置LOG\_ARCHIVE\_DEST\_N参数，指定对应保护模式的传输属性（如SYNC/AFFIRM）。
2.  若为Oracle 9.2版本或升级保护模式，需执行`shutdown immediate`后重启至mount状态。
3.  执行切换命令：`alter database set standby database to maximize (AVAILABILITY | PERFORMANCE | PROTECTION);`。
4.  验证切换结果：`select protection_mode, protection_level from v$database;`。

三、物理Data Guard部署核心配置步骤
----------------------

### 3.1 前置准备

1.  主库检查：确认主库处于归档模式，开启FORCE LOGGING（`alter database force logging;`）；检查归档日志生成速率，评估网络与备库存储承载能力。
2.  备库环境：安装与主库一致的数据库软件及补丁；复制主库密码文件至备库对应目录（RAC环境需所有节点密码文件一致）。
3.  网络配置：主备库配置监听文件（listener.ora、tnsnames.ora），确保以SYSDBA权限互访，为角色切换奠定基础。

### 3.2 关键参数配置

*   日志传输参数：主库配置`log_archive_dest_1`为本地归档路径，`log_archive_dest_2`指定备库连接串及传输属性（如`service=STBY LGWR SYNC AFFIRM`）。
*   路径转换参数：若主备库文件路径不同，配置`db_file_name_convert`（数据文件路径映射）和`log_file_name_convert`（日志文件路径映射）。
*   自动管理参数：设置`standby_file_management='AUTO'`，实现备库自动同步主库新增数据文件。

### 3.3 主备数据同步与备库配置

1.  生成Standby控制文件：主库执行`alter database create standby controlfile as '/path/standby.ctl';`，传输至备库并更新备库`control_files`参数。
2.  数据文件同步：主库开启热备份模式（`alter database begin backup;`），通过FTP或RMAN镜像复制数据文件至备库；复制完成后执行`alter database end backup;`。
3.  配置Standby Logfile：备库日志组数需不少于主库，每组大小与主库在线日志一致（RAC环境每个THREAD需配置两组以上），命令示例：`alter database add standby logfile group 4 '/path/standby_redo04.log' size 500M;`。
4.  启动同步：备库启动至mount状态，执行`recover standby database`手动应用归档日志；日志同步正常后，开启MRP进程自动应用（`alter database recover managed standby database disconnect from session;`）。

### 3.4 角色切换配置

支持三种切换方式：

*   SWITCHOVER：正常切换，主备库角色互换，无数据丢失，需备库应用完所有主库日志。
*   GRACEFUL FAILOVER：主库故障时的优雅切换，需备库日志完整，无数据丢失。
*   FORCED FAILOVER：强制切换，备库通过RESETLOGS打开，可能丢失数据，仅主库完全不可用时使用。

四、运维关键技术要点与故障处理
---------------

### 4.1 日常运维核心监控项

1.  日志同步状态：通过`v$archive_dest`查看日志传输状态，`v$managed_standby`监控MRP进程运行情况；避免备库归档日志积压，定期清理过期归档（开启闪回时需监控闪回空间）。
2.  数据一致性检查：定期使用DBV工具扫描备库数据文件（`dbv file=/path/datafile.dbf logfile=/path/dbv.log`）；或备库只读打开后，通过EXP/EXPDP导出业务表验证数据完整性。
3.  参数一致性：主库修改数据库参数、操作系统参数或sys用户密码后，需同步更新备库，避免角色切换时失败。

### 4.2 常见故障处理

1.  归档日志断档：检查主库归档日志是否被误删，备库通过FAL进程自动获取缺失日志；若自动获取失败，手动复制主库缺失归档至备库并注册（`alter database register logfile '/path/archivelog.dbf';`）。
2.  备库日志应用延迟：排查备库存储I/O性能，调整MRP进程并行度（`alter database recover managed standby database parallel 4 disconnect;`）；优化主库日志传输参数，避免网络瓶颈。
3.  新增数据文件同步失败：检查备库`db_file_name_convert`参数配置，确保主库新路径已映射至备库对应路径；手动复制数据文件至备库并执行`alter database rename file`映射。

### 4.3 角色切换前准备

1.  检查备库状态：确认备库日志应用完成，无延迟；检查备库SGA、PGA等参数是否满足业务运行需求。
2.  网络与连接测试：主备库互访测试（`sqlplus sys/xxx@db_link as sysdba`）；重启主库优化切换速度。
3.  切换后验证：切换完成后，检查备库（原主库）在线日志配置、归档路径是否正常，执行业务操作验证数据可用性。

五、物理Data Guard核心配置参数对照表
=======================

参数类别

参数名

参数说明

配置示例

注意事项

核心标识参数

DB\_UNIQUE\_NAME

主备库唯一标识，主备库需不同

主库：`*.db_unique_name='PRIMARY_DB'`  
备库：`*.db_unique_name='STANDBY_DB'`

必须确保主备库标识唯一，避免冲突

核心标识参数

LOG\_ARCHIVE\_CONFIG

控制归档日志传输的主备库列表

`*.log_archive_config='DG_CONFIG=(PRIMARY_DB,STANDBY_DB)'`

需包含所有主备库的DB\_UNIQUE\_NAME

日志传输参数

LOG\_ARCHIVE\_DEST\_N（N≥2）

配置备库日志接收地址及传输属性

最大保护模式：  
`*.log_archive_dest_2='service=STBY LGWR SYNC AFFIRM valid_for=(online_logfiles,primary_role)'`  
最大性能模式：  
`*.log_archive_dest_2='service=STBY LGWR ASYNC NOAFFIRM valid_for=(online_logfiles,primary_role)'`

1\. `service`指定备库TNS连接串  
2\. 不同保护模式对应不同传输属性（SYNC/ASYNC、AFFIRM/NOAFFIRM）  
3\. `valid_for`限定参数作用场景

日志传输参数

LOG\_ARCHIVE\_DEST\_STATE\_N

启用/禁用对应LOG\_ARCHIVE\_DEST\_N的传输功能

`*.log_archive_dest_state_2='ENABLE'`

主库需启用，备库可设为`DEFER`

日志传输参数

LOG\_ARCHIVE\_DEST\_1

本地归档日志存放路径

`*.log_archive_dest_1='location=/arch/orcl valid_for=(all_logfiles,all_roles)'`

主备库均需配置，存放本地归档日志

路径转换参数

DB\_FILE\_NAME\_CONVERT

主备库数据文件路径映射

备库：`*.db_file_name_convert='/primary/oradata','/standby/oradata'`

1\. 格式为“主库路径,备库路径”  
2\. 多路径映射需依次列出（如`'/path1','/path1_standby','/path2','/path2_standby'`）

路径转换参数

LOG\_FILE\_NAME\_CONVERT

主备库在线日志文件路径映射

备库：`*.log_file_name_convert='/primary/redo','/standby/redo'`

与数据文件路径转换规则一致，需匹配主备库日志文件存放路径

自动管理参数

STANDBY\_FILE\_MANAGEMENT

备库自动同步主库新增数据文件

`*.standby_file_management='AUTO'`

设为AUTO时，备库会自动创建主库新增的数据文件；此时备库禁止执行ALTER DATABASE RENAME、ADD/DROP LOGFILE等操作

保护模式相关

\-（模式切换命令）

切换Data Guard保护模式

最大可用模式：  
`alter database set standby database to maximize availability;`

1\. 切换前需确保LOG\_ARCHIVE\_DEST\_N参数匹配对应模式要求  
2\. Oracle 9.2及以下版本需重启至MOUNT状态切换

归档日志管理

STANDBY\_ARCHIVE\_DEST（Oracle 10g前）

备库归档日志存放路径

`*.standby_archive_dest='/arch/standby'`

Oracle 11g及以上版本建议使用LOG\_ARCHIVE\_DEST\_N替代

日志完整性参数

FORCE LOGGING

强制主库所有操作写入在线日志

主库执行：`alter database force logging;`

1\. 配置Data Guard的前提，确保备库能同步所有数据变更  
2\. 主库NOLOGGING操作较多时会影响性能

归档检测参数

FAL\_SERVER

备库获取缺失归档日志的主库地址

备库：`*.fal_server='PRIMARY_DB'`

可选配置，Oracle 10g后已优化归档检测机制，非必需

归档检测参数

FAL\_CLIENT

标识备库，供主库识别归档请求来源

备库：`*.fal_client='STANDBY_DB'`

需与FAL\_SERVER配合使用，仅在归档断档时生效

静态参数

REMOTE\_LOGIN\_PASSWORDFILE

启用密码文件认证（主备库互访必需）

主备库：`*.remote_login_passwordfile='EXCLUSIVE'`

1\. 主备库需使用相同的密码文件  
2\. RAC环境需确保所有节点密码文件一致

六、物理Data Guard配置步骤与参数对应清单
=========================

配置阶段

序号

操作步骤

对应参数/命令

注意事项

一、前置准备

1

检查主备操作系统兼容性

\-

主备需相同字节序（ENDIAN FORMAT），Oracle 11g后支持Windows与Linux跨平台（参考MOS 413484.1）

2

主库开启归档模式

`alter database archivelog;`

确保主库归档日志正常生成，避免日志丢失

3

主库启用FORCE LOGGING模式

`alter database force logging;`

保证所有操作写入在线日志，避免备库数据丢失

4

备库安装数据库软件

\-

软件版本、PSU补丁需与主库一致

5

复制主库密码文件至备库

\-

RAC环境需所有节点密码文件相同；Oracle 10g后主备sys用户密码需一致

6

配置主备库监听与TNS

listener.ora、tnsnames.ora

确保主备库以SYSDBA权限互访（如`sqlplus sys/xxx@tns_name as sysdba`）

二、核心参数配置（主库）

7

设置数据库唯一标识

`*.db_unique_name='PRIMARY_DB'`

主备库标识必须不同

8

配置归档日志传输范围

`*.log_archive_config='DG_CONFIG=(PRIMARY_DB,STANDBY_DB)'`

包含所有主备库的DB\_UNIQUE\_NAME

9

配置本地归档路径

`*.log_archive_dest_1='location=/arch/orcl valid_for=(all_logfiles,all_roles)'`

主备库均需配置本地归档路径

10

配置备库日志传输参数（按保护模式）

最大可用模式：  
`*.log_archive_dest_2='service=STBY LGWR SYNC AFFIRM valid_for=(online_logfiles,primary_role)'`  
最大性能模式：  
`*.log_archive_dest_2='service=STBY LGWR ASYNC NOAFFIRM valid_for=(online_logfiles,primary_role)'`

`service`指定备库TNS连接串；最大保护/可用模式需备库配置Standby Logfile

11

启用日志传输

`*.log_archive_dest_state_2='ENABLE'`

主库启用，备库可设为`DEFER`

二、核心参数配置（备库）

12

设置数据库唯一标识

`*.db_unique_name='STANDBY_DB'`

与主库不同，需在`log_archive_config`中包含

13

配置数据文件路径转换

`*.db_file_name_convert='/primary/oradata','/standby/oradata'`

格式为“主库路径,备库路径”，多路径需依次列出

14

配置日志文件路径转换

`*.log_file_name_convert='/primary/redo','/standby/redo'`

与数据文件路径转换规则一致，匹配主备日志存放路径

15

启用备库自动同步数据文件

`*.standby_file_management='AUTO'`

设为AUTO时，备库禁止执行ALTER DATABASE RENAME等操作

16

可选：配置归档日志检测（FAL）

`*.fal_server='PRIMARY_DB'`  
`*.fal_client='STANDBY_DB'`

Oracle 10g后非必需，归档检测机制已优化

三、主备数据同步

17

主库创建Standby控制文件

`alter database create standby controlfile as '/path/standby.ctl';`

传输至备库，更新备库`control_files`参数

18

主库复制数据文件至备库

主库：`alter database begin backup;`  
复制完成：`alter database end backup;`

业务低峰期操作，避免占用生产资源；ASM环境用RMAN镜像复制

19

备库添加Standby Logfile

`alter database add standby logfile group 4 '/standby/redo04.log' size 500M;`

日志大小与主库一致，组数≥主库组数+1（RAC每个THREAD≥2组）

四、备库启动与日志应用

20

备库启动至MOUNT状态

`startup mount;`

确保控制文件、数据文件路径正确

21

手动应用归档日志（初始化）

`recover standby database;`

同步至主备SCN一致

22

启用MRP进程自动应用日志

`alter database recover managed standby database disconnect from session;`

Oracle 11g+ Active Data Guard：`alter database recover managed standby database using current logfile disconnect from session;`

23

可选：备库开启闪回功能

`alter database flashback on;`

需配置闪回日志存放路径，便于故障回退

五、测试与验证

24

验证日志传输状态

`select status, error from v$archive_dest where dest_id=2;`

状态为VALID表示传输正常

25

验证备库日志应用

`select process, status from v$managed_standby;`

MRP进程状态为APPLYING\_LOG表示正常

26

测试角色切换（SWITCHOVER）

主库：`alter database commit to switchover to physical standby;`  
备库：`alter database commit to switchover to physical primary;`

切换前确保备库应用完所有主库日志

27

数据一致性检查

主备库执行相同查询，对比结果；或用exp/expdp导出验证

确保备库数据与主库一致

posted on 2025-12-11 17:30  [刘子毅](https://www.cnblogs.com/liuziyi1)  阅读(39)  评论(0)    [收藏](javascript:void\(0\))  [举报](javascript:void\(0\))