---
layout: post
title: '.NET+AI | MEAI | ChatOptions è¯¦è§£ï¼ˆ5ï¼‰'
date: "2025-11-25T00:41:27Z"
---
.NET+AI | MEAI | ChatOptions è¯¦è§£ï¼ˆ5ï¼‰
==================================

ChatOptions è¯¦è§£ï¼šç²¾å‡†æ§åˆ¶ AI å¯¹è¯çš„é…ç½®åˆ©å™¨
==============================

ä¸€å¥è¯ç®€ä»‹
-----

`ChatOptions` æ˜¯ Microsoft.Extensions.AI ä¸­ä¼ é€’ç»™ `IChatClient` çš„ç»Ÿä¸€é…ç½®å®¹å™¨ï¼Œç”¨äºåœ¨å•æ¬¡è¯·æ±‚ä¸­ç²¾å‡†æ§åˆ¶ç”Ÿæˆç­–ç•¥ã€å·¥å…·è°ƒç”¨å’Œæ‰©å±•ç‰¹æ€§ã€‚

* * *

ğŸ¯ æ ¸å¿ƒä»·å€¼
-------

*   âœ… **ç»Ÿä¸€é…ç½®æ¥å£**ï¼šè·¨æä¾›å•†çš„ä¸€è‡´é…ç½®ä½“éªŒ
*   âœ… **ç»†ç²’åº¦æ§åˆ¶**ï¼šä»å¯¹è¯ä¸Šä¸‹æ–‡åˆ°é‡‡æ ·ç­–ç•¥ï¼Œå…¨æ–¹ä½è°ƒæ•´
*   âœ… **çµæ´»æ‰©å±•**ï¼šé€šè¿‡ `AdditionalProperties` å’Œ `RawRepresentationFactory` æ”¯æŒæä¾›å•†ç‰¹å®šåŠŸèƒ½

* * *

ğŸ“ æ ¸å¿ƒå±æ€§æ¦‚è§ˆ
---------

`ChatOptions` çš„å±æ€§æŒ‰èƒ½åŠ›ç»´åº¦å¯åˆ†ä¸ºäº”å¤§ç±»ï¼š

### 1\. å¯¹è¯ä¸Šä¸‹æ–‡

å±æ€§

è¯´æ˜

ä½¿ç”¨åœºæ™¯

`ConversationId`

ç»‘å®šä¼šè¯æ ‡è¯†

æ— çŠ¶æ€å®¢æˆ·ç«¯çš„çŠ¶æ€æ¢å¤

`Instructions`

é™„åŠ ç³»ç»Ÿæç¤ºè¯

è¡¥å……åœºæ™¯é™å®šæˆ–é¢å¤–è¦æ±‚

### 2\. ç”Ÿæˆç­–ç•¥

å±æ€§

è¯´æ˜

å…¸å‹å€¼

`ModelId`

è¦†ç›–é»˜è®¤æ¨¡å‹

`"gpt-4o-mini"`

`ResponseFormat`

å¼ºåˆ¶è¾“å‡ºæ ¼å¼

`Text` / `Json` / JSON Schema

`Temperature`

æ§åˆ¶å¤šæ ·æ€§

0.0-2.0ï¼ˆè¶Šé«˜è¶Šéšæœºï¼‰

`TopP`

æ ¸é‡‡æ ·å‚æ•°

0.0-1.0

`TopK`

Top-K é‡‡æ ·

æ•´æ•°å€¼

`MaxOutputTokens`

æœ€å¤§ç”Ÿæˆé•¿åº¦

å¦‚ `512`

`FrequencyPenalty`

æŠ‘åˆ¶é‡å¤è¯é¢‘

\-2.0 åˆ° 2.0

`PresencePenalty`

æŠ‘åˆ¶é‡å¤ä¸»é¢˜

\-2.0 åˆ° 2.0

`Seed`

å›ºå®šéšæœºç§å­

ç”¨äºç»“æœå¤ç°

`StopSequences`

æˆªæ–­åºåˆ—

å¦‚ `["[DONE]"]`

### 3\. å·¥å…·è°ƒç”¨

å±æ€§

è¯´æ˜

`ToolMode`

å·¥å…·è°ƒç”¨ç­–ç•¥ï¼ˆç¦ç”¨/è‡ªåŠ¨/å¿…é¡»ï¼‰

`Tools`

å½“å‰è¯·æ±‚å¯ç”¨çš„å·¥å…·é›†åˆ

`AllowMultipleToolCalls`

å…è®¸æ¨¡å‹ä¸²è”å¤šä¸ªå·¥å…·è°ƒç”¨

### 4\. èƒŒæ™¯æ‰§è¡Œä¸æ¢å¤

å±æ€§

è¯´æ˜

`AllowBackgroundResponses`

æ”¯æŒåå°é•¿ä»»åŠ¡ï¼ˆå®éªŒæ€§ï¼‰

`ContinuationToken`

ç”¨äºè½®è¯¢æˆ–æ¢å¤æµå¼å“åº”

### 5\. æ‰©å±•ç‚¹

å±æ€§

è¯´æ˜

`AdditionalProperties`

é€ä¼ è‡ªå®šä¹‰é”®å€¼å¯¹

`RawRepresentationFactory`

è¿”å›æä¾›å•†ä¸“å±é€‰é¡¹å¯¹è±¡

* * *

ğŸ’» æ ¸å¿ƒä½¿ç”¨ç¤ºä¾‹
---------

### ç¤ºä¾‹ 1ï¼šå¯¹è¯ä¸Šä¸‹æ–‡é…ç½®

ä½¿ç”¨ `ConversationId` å’Œ `Instructions` ç»‘å®šä¼šè¯å¹¶è¿½åŠ ç³»ç»Ÿæç¤ºè¯ï¼š

    var contextMessages = new List<ChatMessage>
    {
        new(ChatRole.System, "ä½ æ˜¯è´´å¿ƒçš„è¡Œç¨‹è§„åˆ’åŠ©æ‰‹ã€‚"),
        new(ChatRole.User, "å¸®æˆ‘å®‰æ’ä¸€ä¸ªäº”ä¸€åŒ—äº¬ä¸¤æ—¥æ¸¸çš„è¡Œç¨‹è®¡åˆ’ã€‚")
    };
    
    ChatOptions contextOptions = new()
    {
        ConversationId = "planner-2024-05-01",
        Instructions = "å›ç­”è¯·ä¿æŒä¸­æ–‡ï¼Œå¹¶æŒ‰æ—¶é—´é¡ºåºç»™å‡ºæ´»åŠ¨å®‰æ’ã€‚"
    };
    
    var response = await chatClient.GetResponseAsync(contextMessages, contextOptions);
    

* * *

### ç¤ºä¾‹ 2ï¼šç”Ÿæˆç­–ç•¥è°ƒæ•´

è¦†ç›–æ¨¡å‹å¹¶å¾®è°ƒé‡‡æ ·å‚æ•°ï¼Œç²¾å‡†æ§åˆ¶å›ç­”é£æ ¼ï¼š

    ChatOptions generationOptions = new()
    {
        ModelId = "gpt-4o-mini",
        Temperature = 0.7f,
        TopP = 0.9f,
        MaxOutputTokens = 512,
        StopSequences = new[] { "[DONE]" }
    };
    
    var response = await chatClient.GetResponseAsync(messages, generationOptions);
    

* * *

### ç¤ºä¾‹ 3ï¼šå·¥å…·è°ƒç”¨é…ç½®

ç»“åˆ `UseFunctionInvocation` ä¸­é—´ä»¶ï¼ŒåŠ¨æ€æ§åˆ¶å·¥å…·åˆ—è¡¨ï¼š

    AITool weatherTool = AIFunctionFactory.Create(
        (string city) => GetCurrentWeather(city),
        name: "get_current_weather",
        description: "æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”");
    
    ChatOptions toolOptions = new()
    {
        ToolMode = ChatToolMode.Auto,
        AllowMultipleToolCalls = true,
        Tools = new[] { weatherTool }
    };
    
    var toolEnabledClient = chatClient.AsBuilder()
        .UseFunctionInvocation()
        .Build();
    
    var response = await toolEnabledClient.GetResponseAsync(messages, toolOptions);
    

**ğŸ’¡ æç¤º**ï¼š

*   `ChatOptions.Tools` é€‚åˆå•æ¬¡è¯·æ±‚çš„å®šåˆ¶é…ç½®
*   `FunctionInvocationOptions.AdditionalTools` é€‚åˆè·¨è¯·æ±‚å…±äº«çš„å·¥å…·

* * *

ğŸ”§ æ‰©å±•ç‚¹è¯¦è§£
--------

### 1\. AdditionalPropertiesï¼šé€ä¼ æä¾›å•†ç‰¹å®šå‚æ•°

å½“æ ‡å‡† `ChatOptions` å±æ€§æ— æ³•è¦†ç›–æä¾›å•†ç‰¹æ®ŠåŠŸèƒ½æ—¶ï¼Œä½¿ç”¨ `AdditionalProperties`ï¼š

#### åœºæ™¯ 1ï¼šä¼ é€’ OpenAI ç‰¹å®šå‚æ•°

    var options = new ChatOptions
    {
        ResponseFormat = ChatResponseFormat.Json,
        AdditionalProperties = new()
        {
            ["strictJsonSchema"] = true  // OpenAI çš„ä¸¥æ ¼ JSON Schema æ¨¡å¼
        }
    };
    

#### åœºæ™¯ 2ï¼šå­˜å‚¨å¯¹è¯æ‘˜è¦

åœ¨ `SummarizingChatReducer` ä¸­ï¼Œé€šè¿‡ `AdditionalProperties` å­˜å‚¨å’Œä¼ é€’æ‘˜è¦å†…å®¹ï¼š

    // è¯»å–æ‘˜è¦
    if (message.AdditionalProperties?.TryGetValue<string>(SummaryKey, out var summaryValue) == true)
    {
        summary = summaryValue;
    }
    
    // å†™å…¥æ‘˜è¦
    var additionalProperties = lastSummarizedMessage.AdditionalProperties ??= [];
    additionalProperties[SummaryKey] = newSummary;
    

#### åœºæ™¯ 3ï¼šAzure AI Inference çš„é¢å¤–å±æ€§

åœ¨ `Microsoft.Extensions.AI.AzureAIInference` åŒ…ä¸­ï¼Œ`AdditionalProperties` è¢«è½¬æ¢ä¸º `BinaryData` ç±»å‹ï¼š

    if (options.AdditionalProperties is { } props)
    {
        foreach (var prop in props)
        {
            byte[] data = JsonSerializer.SerializeToUtf8Bytes(prop.Value);
            result.AdditionalProperties[prop.Key] = new BinaryData(data);
        }
    }
    

* * *

### 2\. RawRepresentationFactoryï¼šé€ƒç”Ÿèˆ±æœºåˆ¶

`RawRepresentationFactory` æ˜¯æ¡†æ¶æä¾›çš„**é€ƒç”Ÿèˆ±ï¼ˆEscape Hatchï¼‰**ï¼Œç”¨äºåœ¨ç»Ÿä¸€æŠ½è±¡ä¸åº•å±‚å®ç°ä¹‹é—´å»ºç«‹æ¡¥æ¢ã€‚

#### æ ¸å¿ƒè®¾è®¡ç†å¿µ

**ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªå±æ€§ï¼Ÿ**

1.  **æŠ½è±¡ä¸å®ç°çš„çŸ›ç›¾**
    
    *   `ChatOptions` æä¾›ç»Ÿä¸€é…ç½®ï¼Œä½†å„æä¾›å•†æœ‰ç‰¹æœ‰é€‰é¡¹
    *   ä¾‹å¦‚ OpenAI çš„ `IncludeUsage`ã€Azure AI çš„è‡ªå®šä¹‰é…ç½®
2.  **é¿å…æŠ½è±¡å±‚è†¨èƒ€**
    
    *   ä¸ä¸ºæ¯ä¸ªæä¾›å•†åœ¨ `ChatOptions` ä¸­æ·»åŠ ä¸“å±å±æ€§
    *   ä¿æŒæ¡†æ¶ç®€æ´æ€§
3.  **æä¾›æœ€å¤§çµæ´»æ€§**
    
    *   é«˜çº§ç”¨æˆ·å¯å®Œå…¨æ§åˆ¶åº•å±‚ SDK é…ç½®

#### å·¥ä½œåŸç†

**ç±»å‹ç­¾å**ï¼š

    public Func<IChatClient, object?>? RawRepresentationFactory { get; set; }
    

*   **è¾“å…¥**ï¼š`IChatClient` - å½“å‰å®¢æˆ·ç«¯å®ä¾‹
*   **è¾“å‡º**ï¼š`object?` - åº•å±‚å®ç°ç‰¹å®šçš„é€‰é¡¹å¯¹è±¡

**æ ¸å¿ƒæœºåˆ¶ - ç©ºå€¼åˆå¹¶ä¼˜å…ˆçº§**ï¼š

*   `RawRepresentationFactory` è¿”å›çš„**é null å±æ€§**å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§
*   `ChatOptions` çš„å±æ€§ä»…å¡«å…… raw representation ä¸­çš„ **null å±æ€§**

#### ä½¿ç”¨åœºæ™¯

**åœºæ™¯ 1ï¼šè®¾ç½® OpenAI ç‰¹æœ‰é…ç½®**

    var chatOptions = new ChatOptions
    {
        Temperature = 0.7f,
        MaxOutputTokens = 1000,
        
        RawRepresentationFactory = (client) => new ChatCompletionOptions
        {
            IncludeUsage = true,  // OpenAI ç‰¹æœ‰ï¼šåœ¨æµå¼å“åº”ä¸­åŒ…å«ä½¿ç”¨ç»Ÿè®¡
            TopP = 0.95f          // é¢„è®¾å€¼ï¼Œä¸ä¼šè¢« ChatOptions è¦†ç›–
        }
    };
    
    // æœ€ç»ˆç»“æœï¼š
    // - Temperature: 0.7 (æ¥è‡ª ChatOptions)
    // - MaxOutputTokens: 1000 (æ¥è‡ª ChatOptions)
    // - TopP: 0.95 (æ¥è‡ª RawRepresentationFactoryï¼Œä¼˜å…ˆçº§æ›´é«˜)
    // - IncludeUsage: true (OpenAI ç‰¹æœ‰)
    

**åœºæ™¯ 2ï¼šåŠ¨æ€é€‚é…ä¸åŒæä¾›å•†**

    var options = new ChatOptions
    {
        Temperature = 0.7f,
        
        RawRepresentationFactory = (client) => client switch
        {
            OpenAIChatClient => new ChatCompletionOptions
            {
                IncludeUsage = true,
                Store = true  // OpenAI æŒä¹…åŒ–é€‰é¡¹
            },
            
            AzureAIInferenceChatClient => new ChatCompletionsOptions
            {
                AdditionalProperties = 
                {
                    ["custom_azure_setting"] = new BinaryData("value")
                }
            },
            
            _ => null  // å…¶ä»–å®¢æˆ·ç«¯ä½¿ç”¨é»˜è®¤è½¬æ¢
        }
    };
    

#### ä¼˜å…ˆçº§æ€»ç»“

é…ç½®å±æ€§çš„æœ€ç»ˆå€¼ç”±ä»¥ä¸‹ä¼˜å…ˆçº§å†³å®šï¼š

    é«˜ä¼˜å…ˆçº§ â†â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â†’ ä½ä¼˜å…ˆçº§
    
    1. RawRepresentationFactory ä¸­çš„é null å€¼
    2. ChatOptions ä¸­çš„å€¼ï¼ˆä»…å¡«å…… raw ä¸­çš„ null å±æ€§ï¼‰
    3. å®¢æˆ·ç«¯çš„é»˜è®¤å€¼
    

**ç¤ºä¾‹å¯è§†åŒ–**ï¼š

    RawRepresentation: { Temperature = 0.8, MaxTokens = null, TopP = 0.9 }
    ChatOptions:       { Temperature = 0.5, MaxTokens = 100,  TopP = 0.7, Seed = 42 }
    
    æœ€ç»ˆç»“æœ:          { Temperature = 0.8, MaxTokens = 100,  TopP = 0.9, Seed = 42 }
                        â†‘ æ¥è‡ª Raw      â†‘ æ¥è‡ª ChatOptions â†‘ æ¥è‡ª Raw  â†‘ æ¥è‡ª ChatOptions
    

#### é‡è¦æ³¨æ„äº‹é¡¹

æ³¨æ„ç‚¹

è¯´æ˜

**å¿…é¡»è¿”å›æ–°å®ä¾‹**

é¿å…å…±äº«å®ä¾‹å¯¼è‡´çŠ¶æ€æ±¡æŸ“

**ç±»å‹å¿…é¡»åŒ¹é…**

è¿”å›é”™è¯¯ç±»å‹ä¼šè¢«å¿½ç•¥ï¼Œæ¡†æ¶åˆ›å»ºé»˜è®¤å®ä¾‹

**ä¸ä¼šè¢«åºåˆ—åŒ–**

å§”æ‰˜ä¸èƒ½åºåˆ—åŒ–ï¼Œåºåˆ—åŒ–æ—¶ä¼šä¸¢å¤±æ­¤å±æ€§

    // âŒ é”™è¯¯ï¼šè¿”å›å…±äº«å®ä¾‹
    private static ChatCompletionOptions _sharedOptions = new();
    RawRepresentationFactory = (c) => _sharedOptions;
    
    // âœ… æ­£ç¡®ï¼šæ¯æ¬¡è¿”å›æ–°å®ä¾‹
    RawRepresentationFactory = (c) => new ChatCompletionOptions { IncludeUsage = true };
    

* * *

ğŸ¢ æœ€ä½³å®è·µ
-------

### 1\. é…ç½®é€‰æ‹©ç­–ç•¥

åœºæ™¯

æ¨èæ–¹å¼

æ ‡å‡†åŠŸèƒ½

ä½¿ç”¨ `ChatOptions` æ ‡å‡†å±æ€§

æä¾›å•†ç‰¹å®šå‚æ•°

ä½¿ç”¨ `AdditionalProperties`

åº•å±‚ SDK å®Œå…¨æ§åˆ¶

ä½¿ç”¨ `RawRepresentationFactory`

### 2\. å·¥å…·é…ç½®ç­–ç•¥

åœºæ™¯

ä½¿ç”¨å±æ€§

å•æ¬¡è¯·æ±‚çš„å·¥å…·

`ChatOptions.Tools`

è·¨è¯·æ±‚å…±äº«çš„å·¥å…·

`FunctionInvocationOptions.AdditionalTools`

### 3\. RawRepresentationFactory ä½¿ç”¨å»ºè®®

*   âœ… **ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨**ï¼šä¼˜å…ˆä½¿ç”¨æ ‡å‡† `ChatOptions` å±æ€§
*   âœ… **å§‹ç»ˆè¿”å›æ–°å®ä¾‹**ï¼šé¿å…çŠ¶æ€æ±¡æŸ“
*   âœ… **ä½¿ç”¨ç±»å‹æ£€æŸ¥**ï¼šæ ¹æ®å®¢æˆ·ç«¯ç±»å‹è¿”å›ä¸åŒé…ç½®
*   âœ… **æ–‡æ¡£åŒ–ç‰¹æ®Šé…ç½®**ï¼šæ·»åŠ æ³¨é‡Šè¯´æ˜ä½¿ç”¨åŸå› 

* * *

ğŸ¯ æ€»ç»“
-----

*   âœ… **ç»Ÿä¸€é…ç½®å®¹å™¨**ï¼š`ChatOptions` æä¾›è·¨æä¾›å•†çš„ä¸€è‡´é…ç½®æ¥å£
*   âœ… **äº”å¤§èƒ½åŠ›ç»´åº¦**ï¼šå¯¹è¯ä¸Šä¸‹æ–‡ã€ç”Ÿæˆç­–ç•¥ã€å·¥å…·è°ƒç”¨ã€èƒŒæ™¯æ‰§è¡Œã€æ‰©å±•ç‚¹
*   âœ… **çµæ´»æ‰©å±•æœºåˆ¶**ï¼š`AdditionalProperties` é€ä¼ è‡ªå®šä¹‰å‚æ•°ï¼Œ`RawRepresentationFactory` æä¾›åº•å±‚æ§åˆ¶
*   âœ… **æ¸…æ™°çš„ä¼˜å…ˆçº§**ï¼šRaw representation ä¸­çš„é null å€¼å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§
*   âœ… **æœ€ä½³å®è·µ**ï¼šæ ‡å‡†åŠŸèƒ½ç”¨æ ‡å‡†å±æ€§ï¼Œç‰¹æ®ŠåŠŸèƒ½ç”¨æ‰©å±•ç‚¹ï¼Œå§‹ç»ˆè¿”å›æ–°å®ä¾‹

**ä¸‹ä¸€æ­¥**ï¼šæ¢ç´¢ Microsoft.Extensions.AI çš„ç¼“å­˜æœºåˆ¶ï¼Œæ•¬è¯·æœŸå¾…ã€‚

![](https://files.cnblogs.com/files/sheng-jie/maf-course-card-scan.bmp)

> **ğŸ‘†é¢å‘.NETå¼€å‘è€…çš„AI Agent å¼€å‘è¯¾ç¨‹ã€.NET+AI | æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶ã€‘å·²ä¸Šçº¿ï¼Œæ¬¢è¿æ‰«ç åŠ å…¥å­¦ä¹ ã€‚ğŸ‘†**

![](https://files.cnblogs.com/files/sheng-jie/scan-follow.bmp)

> **å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€å‘ AI è€Œè¡Œã€ï¼Œæˆ‘ä»¬å¾®ä¿¡ä¸è§ä¸æ•£ã€‚  
> é˜…ç½¢æ­¤æ–‡ï¼Œå¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡ä¸é”™å¹¶æœ‰æ‰€æ”¶è·ï¼Œè¯·ã€æ‰“èµã€‘æˆ–ã€æ¨èã€‘ï¼Œä¹Ÿå¯ã€è¯„è®ºã€‘ç•™ä¸‹æ‚¨çš„é—®é¢˜æˆ–å»ºè®®ä¸æˆ‘äº¤æµã€‚ ä½ çš„æ”¯æŒæ˜¯æˆ‘ä¸æ–­åˆ›ä½œå’Œåˆ†äº«çš„ä¸ç«­åŠ¨åŠ›ï¼**

ä½œè€…ï¼š[ã€åœ£æ°ã€](http://www.jianshu.com/u/39ec0e6b1844)

å‡ºå¤„ï¼š[http://www.cnblogs.com/sheng-jie/](http://www.cnblogs.com/sheng-jie/)

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚