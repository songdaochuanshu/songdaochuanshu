---
layout: post
title: 'ä»Monoè„šæœ¬ç”ŸæˆEntityï¼šæ·±å…¥ç†è§£Unity DOTSä¸­çš„Archetypeã€Chunkä¸Entityç»“æ„è®¾è®¡'
date: "2025-07-25T00:45:27Z"
---
ä»Monoè„šæœ¬ç”ŸæˆEntityï¼šæ·±å…¥ç†è§£Unity DOTSä¸­çš„Archetypeã€Chunkä¸Entityç»“æ„è®¾è®¡
==========================================================

Unity çš„ DOTSï¼ˆData-Oriented Technology Stackï¼‰æ˜¯é¢å‘æ€§èƒ½æè‡´ä¼˜åŒ–çš„ä¸€ç§æ¶æ„èŒƒå¼ï¼Œå…¶åº•å±‚ç»“æ„è®¾è®¡å¹¶éå¶ç„¶ï¼Œè€Œæ˜¯æ·±æ€ç†Ÿè™‘çš„ç»“æœã€‚æœ¬ç¯‡æ–‡ç« å°†ä»å¼€å‘è€…æœ€ç†Ÿæ‚‰çš„å…¥å£â€”â€”MonoBehaviour è„šæœ¬ + Baker å…¥æ‰‹ï¼Œé€æ­¥å‰–æ DOTS ä¸­ Entity æ˜¯å¦‚ä½•ç”Ÿæˆä¸ç»„ç»‡çš„ï¼Œå¹¶æ·±å…¥ç†è§£å…¶åº•å±‚æ¶æ„ï¼šArchetypeã€Chunkã€Entity çš„è®¾è®¡é€»è¾‘å’ŒåŠ¨æœºã€‚

* * *

ä¸€ã€ä» MonoBehaviour + Baker ç”Ÿæˆ Entity è¯´èµ·
--------------------------------------

åœ¨ Unity DOTS ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ Authoring + Baker çš„æ–¹å¼å°†ä¼ ç»Ÿçš„ GameObject è½¬æ¢ä¸º Entityã€‚ä¸€ä¸ªå¸¸è§çš„å†™æ³•å¦‚ä¸‹ï¼š

    public class MonsterAuthoring : MonoBehaviour
    {
        public int MonsterType;
    
        class Baker : Baker<MonsterAuthoring>
        {
            public override void Bake(MonsterAuthoring authoring)
            {
                var entity = GetEntity(TransformUsageFlags.Dynamic);
                AddComponent(entity, new Health { Value = 100 });
                AddComponent(entity, new Translation { Value = float3.zero });
                AddSharedComponent(entity, new MonsterType { TypeId = authoring.MonsterType });
            }
        }
    }

è¡¨é¢ä¸Šçœ‹ï¼Œæˆ‘ä»¬åªæ˜¯åœ¨æ·»åŠ ç»„ä»¶ã€‚ç„¶è€Œåœ¨èƒŒåï¼ŒUnity DOTS ä¼šæ ¹æ®è¿™äº›ç»„ä»¶è‡ªåŠ¨ä¸ºè¿™ä¸ª Entity åˆ›å»ºå½’å±ç»“æ„â€”â€”Archetypeï¼Œå¹¶ä¸ºå…¶åˆ†é…å†…å­˜ç©ºé—´â€”â€”Chunkã€‚

* * *

äºŒã€Entity æ˜¯ä»€ä¹ˆï¼Ÿ
-------------

Entity æ˜¯ DOTS ä¸­æœ€åŸºæœ¬çš„å•ä½ï¼Œä½†æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå¼•ç”¨å¥æŸ„ï¼š

    public struct Entity
    {
        public int Index;     // åœ¨å†…éƒ¨æ•°ç»„ä¸­çš„ä½ç½®
        public int Version;   // ç”Ÿå‘½å‘¨æœŸå®‰å…¨æ£€æµ‹ç”¨
    }

Entity ä»£è¡¨çš„æ˜¯ä¸€ä¸ªâ€œIDâ€ï¼Œå®ƒçš„æ•°æ®å­˜åœ¨ Chunk ä¸­ï¼Œå®ƒçš„ç»„ä»¶å®šä¹‰äº†å®ƒçš„â€œèƒ½åŠ›å’ŒçŠ¶æ€â€ã€‚

* * *

ä¸‰ã€Archetypeï¼šç»„ä»¶ç»„åˆå®šä¹‰å®ä½“ç»“æ„
----------------------

å½“ä½ ç»™ä¸€ä¸ª Entity æ·»åŠ äº†å¤šä¸ªç»„ä»¶æ—¶ï¼ŒUnity ä¼šè‡ªåŠ¨æ ¹æ®è¿™äº›ç»„ä»¶çš„é›†åˆå®šä¹‰ä¸€ä¸ª Archetypeã€‚å®ƒå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªâ€œç»“æ„ç­¾åâ€ï¼š

ä¾‹å¦‚ï¼š

    Archetype A = [Translation, Health, MonsterType]
    Archetype B = [Translation, Velocity]

æ‰€æœ‰å…·æœ‰ç›¸åŒç»„ä»¶ç»„åˆçš„ Entity éƒ½å±äºåŒä¸€ä¸ª Archetypeã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š

*   å¯ä»¥å¿«é€Ÿå®šä½æ‹¥æœ‰æŸäº›ç»„ä»¶çš„æ‰€æœ‰å®ä½“
    
*   æ–¹ä¾¿æ•°æ®æ‰¹å¤„ç†
    
*   æ”¯æŒç»“æ„åŒ–å­˜å‚¨ï¼ˆæ–¹ä¾¿å†…å­˜å¸ƒå±€ï¼‰
    

* * *

å››ã€Chunkï¼šç»“æ„åŒ–å†…å­˜å—
--------------

æ¯ä¸ª Archetype æ‹¥æœ‰è‹¥å¹²ä¸ª Chunkã€‚Chunk æ˜¯ DOTS ä¸­ç”¨äºå­˜å‚¨å®ä½“æ•°æ®çš„æœ€å°å•ä½ã€‚

### âœ… Chunk ç‰¹ç‚¹ï¼š

*   å¤§å°å›ºå®šä¸º **16KB**ï¼ˆUnity å†…éƒ¨å›ºå®šï¼‰
    
*   æ‰€æœ‰ Entity çš„ç»„ä»¶æ•°æ®æŒ‰åˆ—å¼å­˜å‚¨
    
*   æ¯ä¸ª Chunk åªå®¹çº³ä¸€ç§ Archetype çš„å®ä½“
    
*   åŒä¸€ä¸ª Chunk ä¸­æ‰€æœ‰ Entity çš„ SharedComponent å€¼å¿…é¡»ä¸€è‡´
    

### ğŸ§® ä¸€ä¸ª Chunk å®¹çº³å¤šå°‘ä¸ª Entityï¼Ÿ

å–å†³äºæ¯ä¸ª Entity æ‹¥æœ‰ç»„ä»¶æ•°æ®çš„æ€»å¤§å°ã€‚

ä¾‹å¦‚ï¼š

*   Entity æ¯ä¸ªæ•°æ® 32Bï¼Œåˆ™ Chunk å®¹çº³ 16KB / 32 â‰ˆ 512 ä¸ª
    
*   è‹¥æ•°æ®å˜å¤§ï¼ˆå¦‚åŒ…å« float4x4ï¼‰ï¼ŒEntity å˜å°‘
    

* * *

äº”ã€SharedComponentï¼šæ§åˆ¶ Chunk åˆ†ç±»çš„å…³é”®
--------------------------------

SharedComponent æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„ä»¶ï¼Œå®ç°äº† `ISharedComponentData` æ¥å£ã€‚å®ƒçš„å€¼ä¸èƒ½åœ¨ Entity çº§åˆ«å­˜å‚¨ï¼Œè€Œæ˜¯å­˜å‚¨åœ¨ Chunk çš„ header åŒºåŸŸã€‚

### ç‰¹æ€§ï¼š

*   æ‰€æœ‰ Chunk å†…çš„ Entity å¿…é¡»æ‹¥æœ‰ç›¸åŒçš„ SharedComponent å€¼
    
*   å€¼ä¸åŒçš„ Entity ä¸èƒ½æ”¾åœ¨åŒä¸€ä¸ª Chunk ä¸­
    
*   æ›´æ”¹ SharedComponent å€¼ä¼šå¯¼è‡´ Entity æ¬å®¶ï¼ˆChunk ç§»åŠ¨ï¼‰
    

### ä½¿ç”¨åœºæ™¯ï¼š

*   æ€ªç‰©ç±»å‹åˆ†ç±»ï¼ˆå¦‚ MonsterTypeï¼‰
    
*   LOD åˆ†ç»„ã€åŒºåŸŸåˆ†ç»„ã€æ¸²æŸ“æè´¨åˆ†ç»„ï¼ˆRenderMeshArrayï¼‰
    

### æ³¨æ„ï¼šé¢‘ç¹æ›´æ”¹ SharedComponent ä¼šå¼•èµ·æ€§èƒ½æŠ–åŠ¨

* * *

å…­ã€ä¸ºä»€ä¹ˆ Chunk æ˜¯ 16KBï¼Ÿ
-------------------

è¿™ä¸ªæ•°å­—æ˜¯æ·±æ€ç†Ÿè™‘åçš„ç¡¬ä»¶é€‚é…å€¼ï¼š

*   L1 Cache ä¸€èˆ¬ä¸º 32KBï¼Œæ¯ä¸ª Chunk 16KB å¯ä»¥ä¿è¯é«˜ç¼“å­˜å‘½ä¸­ç‡
    
*   L2 Cache è¾ƒå¤§ï¼Œä¹Ÿèƒ½å®¹çº³å¤šä¸ª Chunk
    
*   16KB æ˜¯å†…å­˜å¯¹é½ã€æ‰¹å¤„ç†ã€é¡µç®¡ç†çš„é»„é‡‘æŠ˜ä¸­å€¼
    

å¤ªå°ï¼šEntity å¤ªå°‘ã€æ•ˆç‡ä½ å¤ªå¤§ï¼šCache æº¢å‡ºã€å¤„ç†æ…¢

å› æ­¤ Unity é»˜è®¤è®¾å®šä¸º 16KBï¼Œä¸å¯ä¿®æ”¹ã€‚

* * *

ä¸ƒã€Archetypeã€Chunkã€Entity çš„ç»„ç»‡ç»“æ„å›¾ï¼ˆæ–‡å­—ç‰ˆï¼‰
------------------------------------

    Archetype A: [Translation, Health, MonsterType]
    â”‚
    â”œâ”€ Chunk A1 (MonsterType = 1)
    â”‚   â”œâ”€ Entity 1
    â”‚   â”œâ”€ Entity 2
    â”‚   â””â”€ ...
    â”‚
    â”œâ”€ Chunk A2 (MonsterType = 2)
    â”‚   â”œâ”€ Entity 1001
    â”‚   â””â”€ ...
    â””â”€ ...

* * *

å…«ã€æ€»ç»“ï¼šè®¾è®¡èƒŒåçš„å“²å­¦
------------

Unity DOTS çš„ Archetype-Chuck-Entity ç»“æ„ï¼Œèåˆäº†ä»¥ä¸‹é¢†åŸŸçš„ç²¾é«“ï¼š

çµæ„Ÿæ¥æº

åº”ç”¨ç‚¹

æ•°æ®å¯¼å‘è®¾è®¡ DoD

æ„å»º Archetype ä»¥ä¼˜åŒ–è®¿é—®ç»“æ„

åˆ—å¼æ•°æ®åº“

Chunk å†…ç»„ä»¶æŒ‰åˆ—æ’åˆ—

ç¨€ç–é›†åˆï¼ˆIndex+Versionï¼‰

å®‰å…¨åœ°ç®¡ç† Entity ç”Ÿå‘½å‘¨æœŸ

GPU æ¸²æŸ“ç®¡çº¿

SharedComponent æ§åˆ¶åˆ†ç»„æ¸²æŸ“

å…¶æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**åˆ©ç”¨ç°ä»£ç¡¬ä»¶ç¼“å­˜ç‰¹æ€§ï¼Œè®©å¤§è§„æ¨¡æ•°æ®æ›´æ–°ä¸å¤„ç†é«˜æ•ˆè€Œå¯æ§ã€‚**

* * *

ä¹ã€é™„ï¼šå¦‚ä½•æŸ¥çœ‹å®é™… Chunk/Archetype
--------------------------

*   é€šè¿‡ `Entities Hierarchy`ï¼ˆWindow â†’ Entitiesï¼‰å¯è§†åŒ–å·¥å…·æŸ¥çœ‹ Chunk åˆ†å¸ƒ
    
*   é€šè¿‡ä»£ç ï¼š
    

    EntityQuery query = GetEntityQuery(typeof(Health), typeof(MonsterType));
    var chunks = query.ToArchetypeChunkArray(Allocator.Temp);
    Debug.Log($"Archetype has {chunks.Length} chunks");

* * *

ç»“è¯­
--

ä½ åªæ˜¯åœ¨ Mono è„šæœ¬é‡Œå†™äº†å‡ è¡Œ AddComponentï¼ŒUnity åœ¨èƒŒåå·²ç»å¸®ä½ æ„å»ºå¥½äº†å¤æ‚è€Œé«˜æ•ˆçš„æ•°æ®å¤„ç†æ¶æ„ã€‚è¿™å°±æ˜¯ DOTS çš„é­…åŠ›æ‰€åœ¨â€”â€”å¼€å‘è€…ä¸“æ³¨é€»è¾‘ï¼Œç³»ç»Ÿä¿éšœæ€§èƒ½ã€‚

ç†è§£ Archetypeã€Chunkã€Entity çš„å†…åœ¨åŸç†ï¼Œæ˜¯èµ°å‘ DOTS é«˜æ•ˆæ¶æ„è®¾è®¡çš„ç¬¬ä¸€æ­¥ã€‚