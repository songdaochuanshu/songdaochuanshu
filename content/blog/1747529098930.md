---
layout: post
title: 'uni-appå°ç¨‹åºç™»å½•åâ€¦'
date: "2025-05-18T00:44:58Z"
---
uni-appå°ç¨‹åºç™»å½•åâ€¦
==============

æœ€è¿‘æ–°æ¥äº†ä¸€ä¸ªå…¨æ–°å°ç¨‹åºé¡¹ç›®ï¼Œæˆ‘è´Ÿè´£ä»0å¼€å§‹æ­å»ºå°ç¨‹åºï¼Œæˆ‘é€‰ç”¨çš„æŠ€æœ¯æ ˆæ˜¯uni-appæŠ€æœ¯æ ˆï¼Œå°ç¨‹åºéƒ¨åˆ†é¡µé¢æ˜¯éœ€è¦ç™»å½•æ‰å¯ä»¥æŸ¥çœ‹çš„ï¼Œå¯¹äºæœªç™»å½•çš„ç”¨æˆ·éœ€è·³è½¬ç™»å½•é¡µç™»å½•æ‰å¯æ­£å¸¸è®¿é—®ï¼Œè¿™ç§åœºæ™¯ä½ ä¼šæ€ä¹ˆè§£å†³ï¼Ÿ

**å‰æƒ…**
------

æœ€è¿‘æ–°æ¥äº†ä¸€ä¸ªå…¨æ–°é¡¹ç›®ï¼Œæ˜¯ç±»ä¼¼å•†åŸçš„å°ç¨‹åºé¡¹ç›®ï¼Œæˆ‘è´Ÿè´£ä»0å¼€å§‹æ­å»ºå°ç¨‹åºï¼Œæˆ‘é€‰ç”¨çš„æŠ€æœ¯æ ˆæ˜¯uni-appæŠ€æœ¯æ ˆï¼Œå…¶ä¸­å°±æœ‰ä¸€ä¸ªç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œå°ç¨‹åºéƒ¨åˆ†é¡µé¢æ˜¯éœ€è¦ç™»å½•æ‰å¯ä»¥æŸ¥çœ‹çš„ï¼Œå¯¹äºæœªç™»å½•çš„ç”¨æˆ·éœ€è¦å¼•å¯¼ç”¨æˆ·å»ç™»å½•é¡µé¢ï¼Œå†backå›æ¥é‡æ–°æ¸²æŸ“å½“å‰é¡µé¢ï¼Œä»¥è®©ç”¨æˆ·æ­£å¸¸ä½¿ç”¨

æ€è€ƒ
--

é—®é¢˜ä¹Ÿä¸å¤æ‚ï¼Œå°±æ˜¯åˆ¤æ–­ç™»å½•çŠ¶æ€è€Œå·²ï¼Œéœ€è¦ç™»å½•çš„é¡µé¢æ²¡ç™»å½•å°±å¼•å¯¼å»ç™»å½•å†å›æ¥ï¼Œå›æ¥åå†é‡æ–°æ¸²æŸ“é¡µé¢æ•°æ®å³å¯

è¿™é‡Œæœ‰äºŒä¸ªåŠ¨ä½œï¼šä¸€ä¸ªæ˜¯åˆ¤æ–­ç™»å½•æ€ï¼Œä¸€ä¸ªæ˜¯é‡æ–°æ¸²æŸ“é¡µé¢æ•°æ®ï¼Œæœ‰åŠ¨ä½œå°±æœ‰è§¦å‘æ—¶æœºï¼Œå¯¹äºåˆ¤æ–­ç™»å½•æ€ï¼Œæˆ‘ä»¬æ˜¯åœ¨è·³è½¬å‰åˆ¤æ–­ï¼Œè¿˜æ˜¯åœ¨è·³è½¬è¿›éœ€è¦ç™»å½•çš„é¡µé¢å†åˆ¤æ–­ï¼Œå¯¹äºé‡æ–°æ¸²æŸ“æ•°æ®å½“ç„¶æ˜¯è¿›å…¥é¡µé¢çš„æ—¶å€™å†é‡æ–°æ¸²æŸ“ï¼Œä½†æ˜¯æ€ä¹ˆå»å®ç°é‡æ–°æ¸²æŸ“äº†ï¼Œå¯¹äºå°ç¨‹åºæˆ‘ä»¬ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯é€šè¿‡ç”Ÿå‘½é’©å­æ¥åšï¼Œé‚£å½“ç„¶å°±æ˜¯onShowäº†

### è§£å†³æ–¹æ¡ˆ

åŸºäºä¸Šè¿°çš„æ€è€ƒï¼Œæˆ‘æƒ³åˆ°å¦‚ä¸‹äºŒç§è§£å†³æ–¹æ¡ˆï¼š

![](https://img2024.cnblogs.com/blog/685637/202505/685637-20250517191924677-1766453809.png)

åº”è¯¥èƒ½è§£å†³çš„æ–¹æ¡ˆåº”è¯¥æœ‰å¾ˆå¤šï¼Œè¿™åªæ˜¯æˆ‘åœ¨å®ç°è¿™ä¸ªéœ€æ±‚çš„æ—¶å€™æƒ³åˆ°çš„äºŒç§æ–¹æ¡ˆ

**åœºæ™¯æ–¹æ¡ˆ1ï¼šè·³è½¬è¿›éœ€è¦ç™»å½•çš„é¡µé¢å†åˆ¤æ–­æ˜¯å¦æ˜¯ç™»å½•æ€ï¼ŒåŒæ—¶ç™»å½•å›æ¥åé€šè¿‡onShowç”Ÿå‘½é’©å­é‡æ–°æ¸²æŸ“é¡µé¢**

æ­¤æ–¹æ¡ˆä¼˜ç‚¹ï¼šå°±æ˜¯åˆ¤æ–­ç™»å½•æ€ä½ ä¸éœ€è¦ç‰¹å®šä»£ç å»åˆ¤æ–­ï¼Œåœ¨æœåŠ¡ç«¯æ¥å£è¿™ä¸€å—åšä¸‹å¤„ç†å³å¯ï¼Œå¦‚æœè¿”å›çŠ¶æ€ç æ˜¯401æˆ–è€…æ˜¯ä½ å’ŒæœåŠ¡ç«¯æ²Ÿé€šå¥½çš„é”™è¯¯ç æ—¶å†å¼•å¯¼å»ç™»å½•é¡µï¼Œè¿™æ ·å…¨å±€åšè¯·æ±‚æ‹¦æˆªå°±è¡Œï¼Œé¡¹ç›®ä¸­æˆ‘å°±æ˜¯æœ‰åšè¿™ä¸€å—çš„å¤„ç†ï¼Œä½¿ç”¨çš„æ˜¯æˆ‘å°è£…å¥½çš„å·¥å…·æ–¹æ³•ï¼š[å¸¸ç”¨å·¥å…·æ–¹æ³• - DCloud æ’ä»¶å¸‚åœº](https://ext.dcloud.net.cn/plugin?id=18675)å·²åˆ†äº«åˆ°æ’ä»¶å¸‚åœºï¼Œæ¬¢è¿ä½¿ç”¨

æ­¤æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼šåœ¨æœªç™»å½•çš„çŠ¶æ€ä¸‹ï¼Œç”¨æˆ·ä¼šçœ‹åˆ°æ˜æ˜¾çš„é¡µé¢è·³è½¬ï¼Œè·³è½¬åˆ°ä¸€ä¸ªç©ºç™½é¡µé¢ï¼Œçªç„¶åˆè·³è½¬åˆ°ç™»å½•é¡µï¼Œç”¨æˆ·ä½“éªŒä¸æ˜¯ç‰¹åˆ«å¥½ï¼ŒåŒæ—¶åœ¨onShowç”Ÿå‘½å‘¨æœŸé’©å­é‡Œåšæ•°æ®é‡æ–°æ¸²æŸ“ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™æ ·ä¼šé€ æˆè¿‡å¤šçš„ç½‘ç»œè¯·æ±‚ï¼Œå¦‚æœç”¨æˆ·é‡ä¸å°çš„è¯ä¼šå¯¹äºæœåŠ¡å™¨é€ æˆä¸€äº›å‹åŠ›

**åœºæ™¯æ–¹æ¡ˆ2ï¼šè·³è½¬è¿›éœ€è¦ç™»å½•çš„é¡µé¢å‰åˆ¤æ–­ç™»å½•æ€ï¼Œå¹¶è®°å½•æ­£åœ¨è·³è½¬çš„é¡µé¢ï¼Œç™»å½•åé‡å®šå‘åˆ°å‰é¢å·²ç»è®°å½•çš„è·³è½¬é¡µé¢**

æ­¤æ–¹æ¡ˆä¼˜ç‚¹ï¼šé¿å…äº†onShowé¢‘ç¹è§¦å‘å¯¼è‡´æœåŠ¡å™¨æ¸²æŸ“æµªè´¹çš„é—®é¢˜ï¼Œç¼ºç‚¹å°±æ˜¯ä½ éœ€è¦åœ¨æ¯ä¸€ä¸ªè·³è½¬éœ€è¦ç™»å½•çš„é¡µé¢å‰åšç™»å½•æ€åˆ¤æ–­ï¼Œä¼šå¯¼è‡´ä»£ç å†—ä½™å·¥ä½œé‡å¢åŠ ï¼ŒåæœŸç»´æŠ¤ä¸æ˜¯ç‰¹åˆ«å¥½

æ–¹æ¡ˆé€‰æ‹©
----

æˆ‘é€‰æ‹©çš„æ˜¯åœºæ™¯æ–¹æ¡ˆ2

äºŒç§æ–¹æ¡ˆéƒ½æœ‰ä¼˜ç¼ºç‚¹ï¼Œæ–¹æ¡ˆ1æœ‰ä¸€ç‚¹æ˜¯ç”¨æˆ·æ„Ÿå—æœ€ç›´æ¥çš„ï¼Œå°±æ˜¯é—ªè·³çš„ç”¨æˆ·ä½“éªŒé‚£ä¸€ç‚¹ï¼Œè‡³äºonShowä¼šå¯¼è‡´æ¥å£é¢‘ç¹è¯·æ±‚é—®é¢˜æ˜¯æœ‰æ–¹æ³•è§£å†³çš„ï¼Œåé¢ä¼šæåˆ°ï¼›æ–¹æ¡ˆ2åªè¦æƒ³åŠæ³•è§£å†³ä»£ç å†—ä½™çš„é—®é¢˜å³å¯

æ–¹æ¡ˆå®ç°ç»†èŠ‚
------

è§£å†³ä»£ç å†—ä½™é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨uni-appçš„æ‹¦æˆªapiæ¥åšä¸‹è·¯ç”±æ‹¦æˆªå³å¯ï¼Œæ ¹æ®è·³è½¬çš„URLå’Œå½“å‰ç™»å½•æ€åˆ¤æ–­è¦ä¸è¦å…ˆè·³ç™»å½•é¡µåšç™»å½•ï¼Œåœ¨main.jsä¸­å¢åŠ è·¯ç”±æ‹¦æˆªï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š

    ...
    
    /**
     * éœ€è¦ç™»å½•æ‰èƒ½è·³è½¬çš„é¡µé¢
     */
    const needLoginPages = [
      '/orders/detail/detail',
      '/orders/orderList/orderList',
      ...
    ]
    
    // è¦æ‹¦æˆªçš„è·¯ç”±æ–¹æ³•
    const interceptors = ['navigateTo', 'reLaunch', 'redirectTo']
    const globalStoreInstance = globalStore(pinia);
    
    // è·¯ç”±æ‹¦æˆª
    interceptors.forEach(interceptor => {
      uni.addInterceptor(interceptor, {
        invoke(e) {
            // åˆ¤æ–­å½“å‰é¡µé¢æ˜¯å¦æ˜¯è¦éœ€è¦ç™»å½•æ‰èƒ½è·³è½¬çš„é¡µé¢é‡Œ
          const needLogin = needLoginPages.findIndex(item => e.url.includes(item)) !== -1;
          if (needLogin && !storage.get(TOKEN)) {
              // è®°å½•è¦è·³è½¬çš„é¡µé¢
            globalStoreInstance.setNeedLoginBackPage(e.url);
            uni.navigateTo({
              url: '/other/login/login'
            })
            return false
          }
          return true
        }
      })
    })
    
    ...
    

æˆ‘åœ¨å†™è¿™ç¯‡åšå®¢çš„æ—¶å€™ï¼Œæˆ‘å‘ç°è¿™é‡Œä»£ç å…¶å®æœ‰ä¸€ä¸ªå¯ä¼˜åŒ–ç‚¹ï¼Œä½ å‘ç°äº†å—ï¼Ÿæ¬¢è¿ç•™è¨€ğŸ‘€è®¨è®º

åŒæ—¶åœ¨ç™»å½•é¡µç™»å½•æˆåŠŸåéœ€è¦åšä¸€ä¸‹è·³è½¬é€»è¾‘ï¼Œå…³é”®ä»£ç å¦‚ä¸‹ï¼š

    ...
    // è§£å†³ç™»å½•åè·³è½¬çš„é—®é¢˜
    if (globalStoreInstance.needLoginBackPage) {
        uni.redirectTo({
            url: globalStoreInstance.needLoginBackPage,
            complete: () => {
                globalStoreInstance.setNeedLoginBackPage('');
            }
        })
    } else {
        // è§£å†³ç™»å½•å›å»é¡µé¢æ•°æ®ä¸¢å¤±çš„é—®é¢˜
        const pages = getCurrentPages();
        if (pages.length >= 2) {
            // è·å–å‰ä¸€ä¸ªé¡µé¢å®ä¾‹
            const prevPage = pages[pages.length - 2];
            // è°ƒç”¨å‰ä¸€ä¸ªé¡µé¢çš„onLoadæ–¹æ³•
            if (prevPage?.onLoad) {
                prevPage.onLoad(prevPage.options || {}); // ä¼ é€’åŸå§‹å‚æ•°
            }
        }
    
        uni.navigateBack();
    }
    
    ...
    

çœ‹ä»£ç é™¤äº†è·³è½¬è¿˜å¤„ç†äº†backï¼Œè¿™ä¸€æ®µbacké€»è¾‘ä¹Ÿæ˜¯æˆ‘åœ¨å®ç°çš„æ—¶å€™å‘ç°å®ƒå¯ä»¥è§£å†³æ–¹æ¡ˆ1çš„onShowé—®é¢˜ï¼Œä¹Ÿå°±æ˜¯è¯´æ–¹æ¡ˆ1ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªä½“éªŒé—®é¢˜ï¼Œæ‰€ä»¥äºŒç§æ–¹æ¡ˆæˆ‘è§‰å¾—éƒ½æ˜¯å¯è¡Œçš„ï¼ŒåŒæ—¶æˆ‘æä¾›æ–¹æ¡ˆ1æ¥å£æ‹¦æˆªçš„ä»£ç ï¼š

    import { Request, storage } from '@/uni_modules/hbxw-utils/js_sdk/hbxw-utils.js';
    import { BASE_URL } from '@/config/http';
    import { TOKEN } from '@/config/common';
    
    const request = new Request({
        isLogin: true,
    });
    
    request.baseUrl = BASE_URL;
    
    /**
     * è¯·æ±‚æ‹¦æˆªï¼Œå¯ä»¥é€šè¿‡addæ–¹æ³•æ·»åŠ å¤šä¸ª
     * å‚æ•°ä¸ºè¯·æ±‚é…ç½®ï¼Œå¯ä»¥å¯¹è¯·æ±‚å‚æ•°åšä¸€äº›ç‰¹æ®Šå¤„ç†
     */
    request.requestIntercept.add((requestConfig) => {
        // å¦‚æœæœ‰ä¼ å°±ç”¨ä¼ çš„ï¼Œæ²¡æœ‰å°±å»å–ï¼Œä¸ºäº†è§£å†³ç™»å½•é»˜è®¤token
        console.log('---- requestConfig ----:', requestConfig)
        if (!requestConfig.header) {
            requestConfig.header = {}
        }
        // å¦‚æœheaderä¸­æ²¡æœ‰Acceptï¼Œåˆ™è®¾ç½®ä¸ºapplication/json
        if (!requestConfig.header?.Accept) {
            requestConfig.header.Accept = 'application/json';
        }
        if (!requestConfig.header?.Authorization) {
            let Authorization = ''
            try {
                Authorization  = storage.get(TOKEN) || '';
            } catch (err) {
                console.log(err)
            }
            // æ·»åŠ Authorizationåˆ°headerä¸­ç”¨äºæœåŠ¡ç«¯ç™»å½•åˆ¤æ–­
            if (Authorization) {
                if (!requestConfig.header) {
                    requestConfig.header = {}
                }
                requestConfig.header.Authorization = Authorization;
            }
        }
        // å¦‚æœè¿”å›trueåˆ™è¯·æ±‚ä¼šä¸­æ–­
        // return true;
    });
    
    /**
     * å“åº”æ‹¦æˆªï¼Œå¯ä»¥é€šè¿‡addæ–¹æ³•æ·»åŠ å¤šä¸ª
     * ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºè¯·æ±‚å“åº”ä½“
     * ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯·æ±‚é…ç½®ä¿¡æ¯
     */
    request.responIntercept.add((response, requestConfig) => {
        console.log('---- response ----:', response)
        // å¦‚æœæ¥çŠ¶æ€ç ä¸º401ï¼Œè€Œä¸”å½“å‰æ¥å£æ˜¯éœ€è¦åˆ¤æ–­ç™»å½•çŠ¶æ€çš„
        if (response.statusCode == 401 && requestConfig.isLogin) {
            uni.navigateTo({
                url: '/other/login/login'
            })
            // è¿”å›true ä¸­æ–­åé¢å¤„ç†
            return true;
        }
        // é€šç”¨é”™è¯¯å¤„ç†
        if (response.statusCode !== 200 || response.data.code !== 200) {
            uni.showToast({
                title: response.data.message || 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•',
                icon: 'none'
            })
            return true;
        }
    });
    
    export default request;
    

### æœŸæœ›

è§£å†³é—®é¢˜çš„æ–¹æ³•åƒåƒä¸‡ï¼Œä¸Šè¿°æ˜¯æˆ‘æ˜¯è§£å†³ç™»å½•è·³è½¬é€»è¾‘çš„å¤„ç†æ–¹æ¡ˆï¼Œå¦‚æœåœ¨ä¸Šé¢äºŒç§æ–¹æ¡ˆä¸­ï¼Œä½ ä¼šé€‰æ‹©å“ªä¸€ç§äº†ï¼Ÿèªæ˜çš„ä½ ä¹Ÿä¸€å®šæœ‰åˆ«çš„æ›´å¥½çš„æ–¹æ¡ˆï¼ŒæœŸå¾…ä½ çš„åˆ†äº«å’Œç•™è¨€ğŸ‘€ï¼Œå…±åŒè¿›æ­¥ã€‚

å¥½å¥½å­¦ä¹ ï¼å¤©å¤©å‘ä¸Šï¼