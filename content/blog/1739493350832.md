---
layout: post
title: 'C++ ä½¿ç”¨MIDIåº“æ¼”å¥ã€Šæ™´å¤©ã€‹'
date: "2025-02-14T00:35:50Z"
---
C++ ä½¿ç”¨MIDIåº“æ¼”å¥ã€Šæ™´å¤©ã€‹
=================

é‚£äº›åœ¨MIDIåº“é‡Œå¾˜å¾Šçš„åå…­åˆ†éŸ³ç¬¦

ç»ˆç©¶æ²¡èƒ½æ‹¼æˆå‘Šç™½çš„ä¸»æ­Œ

æˆ‘æŠŠå‘¨æ°ä¼¦çš„ã€Šæ™´å¤©ã€‹å†™æˆC++çš„ç±»  
åœ¨æ¯ä¸ªmidiEventé‡ŒåŸ‹è—æ•…äº‹çš„å°é»„èŠ±

è°ƒè¯•å™¨çš„æ–­ç‚¹æ¯”åˆæ‹æ›´æ¼«é•¿  
è€Œé’æ˜¥ä¸è¿‡æ˜¯ä¸€ä¸²æœªå¯¼å‡ºçš„cmakeå·¥ç¨‹æ–‡ä»¶

åœ¨å †æ ˆæº¢å‡ºçš„å¤œæ™š  
ç»ˆå°†æ˜ç™½  
æœ‰äº›æ—‹å¾‹æ°¸è¿œåœåœ¨#pragma onceçš„æ³¨é‡Šé‡Œ  
æœ‰äº›äººæ°¸è¿œåœåœ¨æœªå®šä¹‰çš„å¼•ç”¨é‡Œ

æˆ–è®¸ä½ æˆ‘çš„å¿ƒè·³ç»ˆå½’è¿è¡Œåœ¨ä¸åŒçš„æ—¶é’Ÿé¢‘ç‡  
å´æ„¿å§‹ç»ˆè®°å¾—å¦‚ä½•ç¼–è¯‘å‡ºä¸€åœºæ°¸ä¸è½å¹•çš„æ™´å¤©

ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€--é¢˜è®°

* * *

å°±åƒåœ¨é¢˜è®°é‡Œè¯´çš„ä¸€æ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªä»æœªå¯¼å‡ºæˆåŠŸçš„å·¥ç¨‹æ–‡ä»¶ã€‚  
æ‰€ä»¥å¦‚æœä½ ä¹Ÿæƒ³å¬å¬ï¼Œå¯ä»¥åœ¨PowerShellé‡Œè¿è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

git clone https://github.com/TwilightLemon/SunnyDays
cd SunnyDays
mkdir build
cd build
cmake .. \-G "MinGW Makefiles"
mingw32\-make
./SunnyDays.exe

æ²¡ç¯å¢ƒï¼Ÿå·§äº†ï¼Œå¥¹ä¹Ÿå¦‚æ˜¯è¯´ã€‚

å¹¸è¿çš„è¯èƒ½å¾—åˆ°ä»¥ä¸‹æ•ˆæœï¼š

![](https://img2024.cnblogs.com/blog/1188749/202502/1188749-20250213224018232-1965791702.png)

ä¸‹é¢æ¥ç®€å•è®²è®²å¦‚ä½•ä½¿ç”¨C++å’ŒMIDIåº“ä½œæ›²å§ã€‚

ä¸€ã€å¼€å§‹å·¥ä½œ[  
](https://blog.twlmgatito.cn/posts/cpp-midi-sunnydays/#%E4%B8%80%E5%BC%80%E5%A7%8B%E5%B7%A5%E4%BD%9C)
---------------------------------------------------------------------------------------------------------------

### 1\. å¼•å…¥MIDIåº“å’Œç›¸å…³æ§åˆ¶ç±»

åœ¨`CMakeLists.txt`ä¸­ï¼š

target\_link\_libraries(SunnyDays winmm)

åœ¨`MIDIHelper.h`ä¸­ï¼š

#include <windows.h>
#pragma comment(lib,"winmm.lib")

å®šä¹‰Scale(éŸ³é˜¶), Instrument(ä¹å™¨, ä»…åŒ…æ‹¬éƒ¨åˆ†)ç­‰æšä¸¾ã€‚æˆ‘æŠŠDrumå•ç‹¬æäº†å‡ºæ¥ã€‚

enum Scale
{
    X1 \= 36, X2 = 38, X3 = 40, X4 = 41, X5 = 43, X6 = 45, X7 = 47,
    L1 \= 48, L2 = 50, L3 = 52, L4 = 53, L5 = 55, L6 = 57, L7 = 59,
    M1 \= 60, M2 = 62, M3 = 64, M4 = 65, M5 = 67, M6 = 69, M7 = 71,
    H1 \= 72, H2 = 74, H3 = 76, H4 = 77, H5 = 79, H6 = 81, H7 = 83,
    LOW\_SPEED \= 500, MIDDLE\_SPEED = 400, HIGH\_SPEED = 300,
    \_ \= 0XFF
};
enum Drum{
    BassDrum \= 36, SnareDrum = 38, ClosedHiHat = 42, OpenHiHat = 46
};
enum Instrument{
    AcousticGrandPiano \= 0, BrightAcousticPiano = 1,
    ElectricGrandPiano \= 2, HonkyTonkPiano = 3,
    ElectricPiano1 \= 4, ElectricPiano2 = 5
};

ä¸€äº›åŸºç¡€æ–¹æ³•ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–/å…³é—­è®¾å¤‡ã€è®¾ç½®å‚æ•°ã€æ’­æ”¾å•ä¸ªéŸ³ç¬¦å’Œæ’­æ”¾å’Œå¼¦ç­‰ã€‚

void initDevice();
void closeDevice();
void setInstrument(int channel, int instrument);
void setVolume(int channel, int volume);

void PlayNote(HMIDIOUT handle, UINT channel, UINT note, UINT velocity);

void playChord(HMIDIOUT handle, UINT channel, UINT note1, UINT note2, UINT note3, UINT note4, UINT velocity);

void playChord(HMIDIOUT handle, UINT channel, UINT note1, UINT note2, UINT note3, UINT velocity);

åœ¨`MIDIHelper.cpp`ä¸­ï¼š

void initDevice(){
    midiOutOpen(&hMidiOut, 0, 0, 0, CALLBACK\_NULL);
}

void closeDevice(){
    midiOutClose(hMidiOut);
}

void setInstrument(int channel,int instrument){
    if (channel > 15 || instrument > 127) return;
    DWORD message \= 0xC0 | channel | (instrument << 8);
    midiOutShortMsg(hMidiOut, message);
}

void setVolume(int channel,int volume){
    if (channel > 15 || volume > 127) return;
    DWORD message \= 0xB0 | channel | (7 << 8) | (volume << 16);
    midiOutShortMsg(hMidiOut, message);
}

//æ’­æ”¾å•ä¸ªéŸ³ç¬¦ï¼Œnoteæ˜¯éŸ³ç¬¦ï¼Œvelocityæ˜¯åŠ›åº¦
void PlayNote(HMIDIOUT handle, UINT channel, UINT note, UINT velocity) {
    if (channel > 15 || note > 127 || velocity > 127) return;
    DWORD message \= 0x90 | channel | (note << 8) | (velocity << 16);
    midiOutShortMsg(handle, message);
}

//å››æŒ‡å’Œå¼¦
void playChord(HMIDIOUT handle, UINT channel, UINT note1, UINT note2, UINT note3, UINT note4, UINT velocity){
    if (channel > 15 || note1 > 127 || note2 > 127 || note3 > 127 || note4 > 127 || velocity > 127) return;
    DWORD message1 \= 0x90 | channel | (note1 << 8) | (velocity << 16);
    DWORD message2 \= 0x90 | channel | (note2 << 8) | (velocity << 16);
    DWORD message3 \= 0x90 | channel | (note3 << 8) | (velocity << 16);
    DWORD message4 \= 0x90 | channel | (note4 << 8) | (velocity << 16);
    midiOutShortMsg(handle, message1);
    midiOutShortMsg(handle, message2);
    midiOutShortMsg(handle, message3);
    midiOutShortMsg(handle, message4);
}

//ä¸‰æŒ‡å’Œå¼¦
void playChord(HMIDIOUT handle, UINT channel, UINT note1, UINT note2, UINT note3, UINT velocity) {
    if (channel > 15 || note1 > 127 || note2 > 127 || note3 > 127 || velocity > 127) return;
    DWORD message1 \= 0x90 | channel | (note1 << 8) | (velocity << 16);
    DWORD message2 \= 0x90 | channel | (note2 << 8) | (velocity << 16);
    DWORD message3 \= 0x90 | channel | (note3 << 8) | (velocity << 16);
    midiOutShortMsg(handle, message1);
    midiOutShortMsg(handle, message2);
    midiOutShortMsg(handle, message3);
}

### 2\. åˆå§‹åŒ–å’Œç»“æŸ[  
](https://blog.twlmgatito.cn/posts/cpp-midi-sunnydays/#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E7%BB%93%E6%9D%9F)

å…ˆåœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªå…¨å±€MIDIå¥æŸ„:

extern HMIDIOUT hMidiOut;

åœ¨å…¥å£å¤„åˆå§‹åŒ–MIDIè®¾å¤‡å¹¶åœ¨ç»“æŸæ—¶å…³é—­ï¼š

HMIDIOUT hMidiOut;
int main() {
    initDevice();
    //...
    closeDevice();
    return 0;
}

åˆå§‹åŒ–MIDIè®¾å¤‡ä¹‹åï¼Œä¸ºæ¯ä¸€ä¸ªä¹å™¨åˆ†é…ä¸€ä¸ªé€šé“`channel`ï¼ˆ0~15ï¼Œé€šå¸¸9åˆ†é…ç»™æ‰“å‡»ç±»ä¹å™¨,ä¾‹å¦‚é¼“ç»„ï¼‰ï¼Œæ§åˆ¶éŸ³é‡`volume`ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹æ¼”å¥äº†ã€‚

äºŒã€è‡ªåˆ¶ç®€æ˜“ä¹è°±[  
](https://blog.twlmgatito.cn/posts/cpp-midi-sunnydays/#%E4%BA%8C%E8%87%AA%E5%88%B6%E7%AE%80%E6%98%93%E4%B9%90%E8%B0%B1)
-----------------------------------------------------------------------------------------------------------------------------------

ä»¥`Voice.cpp`ä¸ºä¾‹,å®šä¹‰ä¸€ä¸ªæ•°ç»„ä¸ºé¢‘è°±ï¼Œæ§åˆ¶åœé¡¿å’ŒéŸ³ç¬¦ï¼Œéå†æ•°ç»„æ’­æ”¾ï¼š

 1 namespace SunnyDays{ 2     int channelVoice=1;
 3     void playVoice(int note, int velocity){ 4         PlayNote(hMidiOut, channelVoice, note, velocity);
 5     }
 6     void voice(){ 7         Sleep(13100);//ç­‰å¾…å‰å¥
 8         int sleep = 390;
 9         int data\[\] =
10 {
11                     //æ•…äº‹çš„å°é»„èŠ±
12                     -90,
13                     300,M5,M5,M1,M1,\_,M2,M3,\_,
14                     //ä»å‡ºç”Ÿé‚£å¹´å°±é£˜ç€
15                     -90,
16                     M5,M5,M1,M1,0,M2,M3,300,M2,M1,\_,
17                     //ç«¥å¹´çš„è¡ç§‹åƒ
18                     -90,
19                     300,M5,M5,M1,M1,\_,M2,M3,\_,
20                     //éšè®°å¿†ä¸€ç›´æ™ƒåˆ°ç°åœ¨
21                     -90,  
22                     M3,\_,500,M2,M3,M4,M3,M2,M4,M3,700,M2,700,\_,
23                     //...
24 }
25         for (auto i : data) {
26             if(i==-30){logTime("Enter chorus");continue;}//è°ƒè¯•ç”¨
27             if(i==-90){NextLyric(); continue;}
28             if (i == 0) { sleep = 180; continue; }
29             //...
30             if (i == \_) {
31                 Sleep(390);
32                 continue;
33 }
34 
35             playVoice(i, 80);
36 Sleep(sleep);
37 }
38 }
39 }

æ‰“ä¸ªé¼“ï¼š

 1 namespace SunnyDays{ 2     int channelBassDrum=9;
 3 
 4     void playDrum(int note, int velocity, int duration){ 5         PlayNote(hMidiOut, channelBassDrum, note, velocity);
 6         if(duration>0) {
 7             Sleep(duration);
 8             PlayNote(hMidiOut, channelBassDrum, note, 0);
 9 }
10 }
11 
12     void bassDrum(){
13         Sleep(11260);
14         cout<<"Drum Bass Start!"<<endl;
15         playDrum(SnareDrum,100,180);
16         playDrum(SnareDrum,100,210);
17         playDrum(BassDrum, 100, 210);
18         playDrum(SnareDrum,100,190);
19         playDrum(BassDrum, 100, 210);
20         playDrum(SnareDrum,100,200);
21         playDrum(SnareDrum,100,200);
22         playDrum(OpenHiHat,100,-1);
23         Sleep(200);
24         //...
25 }
26 }

ç®€æ˜“å‰¯æ­Œå’Œå¼¦ï¼Œæ˜¯ä»Bç«™ä¸€ä½upä¸»é‚£é‡Œå­¦çš„ï¼ˆå·²ç»å¿˜è®°æ˜¯å“ªä½äº†qwqï¼‰ï¼š

 1 namespace SunnyDays { 2     int channelChord=2;
 3     void chordLevel(int level,int sleep,int repeat=2,int vel=70){
 4         repeat--;
 5         int down=8;
 6         if(level==1){
 7             //ä¸€çº§å’Œå¼¦ åŠ å³æŒ‡
 8             playChord(hMidiOut, channelChord, M1, M3, M5, L1, vel);
 9             while(repeat--) {
10 Sleep(sleep);
11                 playChord(hMidiOut, channelChord, M1, M3, M5, vel - down);
12 }
13         }else if(level==3){
14             //ä¸‰çº§å’Œå¼¦ åŠ å³æŒ‡
15 playChord(hMidiOut, channelChord, M3, M5, M7, L3, vel);
16             while(repeat--) {
17 Sleep(sleep);
18                 playChord(hMidiOut, channelChord, M3, M5, M7, vel - down);
19 }
20 }
21         //...
22 }
23     void chord(){
24         Sleep(63724);
25         int sleep=740;
26         int data\[\]={
27                 //åˆ®é£è¿™å¤© æˆ‘è¯•è¿‡æ¡ç€ä½ æ‰‹
28                 1,4,
29                 6,4,
30                 //ä½†åå é›¨æ¸æ¸
31                 4,2,
32                 5,2,
33                 //å¤§åˆ°æˆ‘çœ‹ä½ ä¸è§
34                 1,4,
35                 //è¿˜æœ‰å¤šä¹… æˆ‘æ‰èƒ½
36                 3,4,
37                 //â†‘ åœ¨ä½ èº«è¾¹
38                 6,4,
39                 //â†“ ç­‰åˆ°æ”¾æ™´çš„é‚£å¤©
40                 4,4,
41                 //â†‘ ä¹Ÿè®¸æˆ‘ä¼šæ¯”è¾ƒå¥½ä¸€ç‚¹
42                 5,4,
43                 //..
44 }
45         int count=sizeof(data)/sizeof(int);
46         for(int i=0;i<count;i+=2){
47             cout<<"chord "<<data\[i\]<<"  x"<<data\[i+1\]<<endl;
48             chordLevel(data\[i\],sleep,data\[i+1\]);
49 Sleep(sleep);
50 }
51         //...
52 }
53 }

ä¸‰ã€åˆæˆæ¼”å¥[  
](https://blog.twlmgatito.cn/posts/cpp-midi-sunnydays/#%E4%B8%89%E5%90%88%E6%88%90%E6%BC%94%E5%A5%8F)
---------------------------------------------------------------------------------------------------------------

æˆ‘ç”¨äº†ä¸€ä¸ªç¬¨è›‹æ–¹æ³•ï¼Œç”¨å¤šçº¿ç¨‹å•ç‹¬æ§åˆ¶æ¯ä¸€ä¸ªé€šé“ï¼Œç„¶ååœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ï¼š

 1 int main(){ 2     //...
 3     initDevice();
 4     //è®¾ç½®éŸ³é‡
 5     setVolume(channelChord,80);
 6     setVolume(channelMainLine,80);
 7     setVolume(channelVoice,120);
 8     setVolume(channelBassDrum,80);
 9 
10     //è®¾ç½®ä¹å™¨ï¼ˆç‰¹å®šéŸ³è‰²ï¼‰
11 setInstrument(channelChord,ElectricPiano1);
12 setInstrument(channelMainLine,ElectricPiano1);
13 
14 
15     system("pause");//æŒ‰ä¸‹å›è½¦ï¼Œå°±å¼€å§‹å•¦
16 beginLogger();
17 
18 
19 thread t0(voice);
20 thread t1(mainLine);
21 thread t2(bassDrum);
22 thread t3(chord);
23 t0.join();
24 t1.join();
25 t2.join();
26 t3.join();
27 
28 closeDevice();
29     //...
30 }

ï¼ˆæœ€åå ä¸ªç”²ï¼Œä¿ºä¸æ‡‚éŸ³ä¹åˆ¶ä½œï¼Œæ›´ä¸ä¼šä»€ä¹ˆC++ğŸ˜¿ï¼‰

![](https://img2024.cnblogs.com/blog/1188749/202407/1188749-20240702112134529-1920703459.png)

Â  æœ¬ä½œå“é‡‡ç”¨Â [çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-sa/4.0/)Â è¿›è¡Œè®¸å¯ã€‚æ¬¢è¿è½¬è½½ã€ä½¿ç”¨ã€é‡æ–°å‘å¸ƒï¼Œä½†åŠ¡å¿…ä¿ç•™æ–‡ç« ç½²åTwilightLemonï¼Œä¸å¾—ç”¨äºå•†ä¸šç›®çš„ï¼ŒåŸºäºæœ¬æ–‡ä¿®æ”¹åçš„ä½œå“åŠ¡å¿…ä»¥ç›¸åŒçš„è®¸å¯å‘å¸ƒã€‚