---
layout: post
title: 'é£ä¹¦ .NET SDK äº‹ä»¶å¤„ç†çš„å¹‚ç­‰æ€§ä¸å»é‡æœºåˆ¶'
date: "2026-01-12T00:48:50Z"
---
é£ä¹¦ .NET SDK äº‹ä»¶å¤„ç†çš„å¹‚ç­‰æ€§ä¸å»é‡æœºåˆ¶
=========================

> é£ä¹¦äº‹ä»¶å¤„ç†è¿‡ç¨‹ä¸­å¦‚ä½•è®©ä½ çš„åº”ç”¨ä¸å†"é‡å¤åŠ³åŠ¨"ï¼Œå¦‚ä½•ç”¨ä¸‰å±‚é˜²æŠ¤ç­‘èµ·å®‰å…¨å¢™ï¼Œç»“åˆå†…å­˜ä¸ Redis åŒé‡ä¿éšœï¼Œè®©ä½ çš„é£ä¹¦åº”ç”¨ç¨³å¦‚ç£çŸ³â€”â€”ä¸å†é‡å¤å¤„ç†ï¼Œå‘Šåˆ«æ··ä¹±çŠ¶æ€ã€‚

* * *

ä¸ºä»€ä¹ˆéœ€è¦"å»é‡"ï¼Ÿ
----------

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼š

ä½ åœ¨é£ä¹¦é‡Œæ”¶åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œåº”ç”¨æ”¶åˆ°é€šçŸ¥ååˆ›å»ºäº†å¾…åŠäº‹é¡¹ã€‚ä½†å› ä¸ºç½‘ç»œä¸ç¨³å®šï¼Œé£ä¹¦ä»¥ä¸ºä½ æ²¡æ”¶åˆ°ï¼Œåˆå‘äº†ä¸€éåŒæ ·çš„é€šçŸ¥â€”â€”ç»“æœå‘¢ï¼Ÿä½ çš„åº”ç”¨åˆåˆ›å»ºäº†ä¸€æ¬¡å¾…åŠï¼ŒåŒä¸€ä¸ªä»»åŠ¡å‡ºç°äº†ä¸¤æ¬¡ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„"é‡å¤å¤„ç†"é—®é¢˜ã€‚

* * *

### ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Ÿ

åœ¨é£ä¹¦äº‹ä»¶é©±åŠ¨çš„ä¸–ç•Œé‡Œï¼Œä»¥ä¸‹æƒ…å†µéƒ½å¯èƒ½å¯¼è‡´**åŒä¸€äº‹ä»¶è¢«å¤šæ¬¡é€è¾¾**ï¼š

*   ğŸ“¡ **ç½‘ç»œæ³¢åŠ¨**ï¼šé£ä¹¦æœåŠ¡å™¨æ²¡æ”¶åˆ°ä½ çš„ç¡®è®¤ï¼Œäºæ˜¯é‡å‘
*   ğŸ”„ **æœåŠ¡é‡å¯**ï¼šå†…å­˜æ¸…ç©ºï¼Œä¹‹å‰çš„äº‹ä»¶åˆæ¥äº†
*   ğŸ‘¥ **å¤šå®ä¾‹è¿è¡Œ**ï¼šå¤šä¸ªå®ä¾‹åŒæ—¶æ”¶åˆ°åŒä¸€äº‹ä»¶
*   ğŸ”Œ **æ–­çº¿é‡è¿**ï¼šWebSocket é‡è¿åå¯èƒ½é‡å¤æ¶ˆæ¯

### çœŸå®æ¡ˆä¾‹ï¼šä¸€åˆ†é’Ÿå†…çš„æ··ä¹±

    æ—¶é—´çº¿ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    09:00:00  é£ä¹¦æ¨é€ï¼šæ”¶åˆ°ä¸€æ¡æ–°æ¶ˆæ¯
    09:00:01  å®ä¾‹A æ¥æ”¶å¹¶å¤„ç† â†’ åˆ›å»ºå¾…åŠ âœ…
    09:00:05  é£ä¹¦æ²¡æ”¶åˆ°ç¡®è®¤ï¼Œå†æ¬¡æ¨é€
    09:00:06  å®ä¾‹B æ¥æ”¶å¹¶å¤„ç† â†’ åˆåˆ›å»ºå¾…åŠ âŒ
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    

**åæœæœ‰å¤šä¸¥é‡ï¼Ÿ**

é—®é¢˜

å®é™…å½±å“

ğŸ“‰ æ•°æ®é‡å¤

ç”¨æˆ·æ”¶åˆ°ä¸¤æ¡ç›¸åŒçš„å¾…åŠ

ğŸ’° èµ„é‡‘æŸå¤±

è®¢å•é‡å¤æ‰£æ¬¾ï¼Œé€€é’±éƒ½é€€ä¸å®Œ

ğŸ“§ éªšæ‰°ç”¨æˆ·

åŒä¸€æ¡é€šçŸ¥å‘åæ¬¡

ğŸ”„ çŠ¶æ€æ··ä¹±

æ•°æ®åº“é‡Œè¯´"å·²å¤„ç†"ï¼Œå®é™…åªåšäº†ä¸€åŠ

* * *

ä¸‰å±‚é˜²æŠ¤ï¼šåƒä¿å®‰ä¸€æ ·å±‚å±‚æŠŠå…³
--------------

Mud.Feishu SDK è®¾è®¡äº†ä¸€å¥—**ä¸‰å±‚é€’è¿›å¼é˜²æŠ¤æœºåˆ¶**ï¼Œå°±åƒå°åŒºçš„ä¸‰é“å²—å“¨ï¼Œä»å¤–åˆ°å†…å±‚å±‚æŠŠå…³ï¼Œç¡®ä¿ä¸ä¼šæœ‰"åäºº"ï¼ˆé‡å¤äº‹ä»¶ï¼‰æ··è¿›æ¥ã€‚

graph TB subgraph AppLayer\["åº”ç”¨å±‚å»é‡ï¼ˆä¸šåŠ¡é”®ï¼‰"\] AppHandler\["IdempotentFeishuEventHandler<T>"\] AppDesc\["åŸºäºä¸šåŠ¡ä¸»é”®ï¼ˆæ¶ˆæ¯IDã€è®¢å•IDç­‰ï¼‰å»é‡"\] end subgraph DispatchLayer\["åˆ†å‘å±‚å»é‡ï¼ˆEventIdï¼‰"\] EventDedup\["IFeishuEventDeduplicator / IFeishuEventDistributedDeduplicator"\] EventDesc\["åŸºäºé£ä¹¦äº‹ä»¶IDå»é‡ï¼Œ24å°æ—¶çª—å£æœŸ"\] end subgraph ProtocolLayer\["åè®®å±‚å»é‡ï¼ˆSeqID/Nonceï¼‰"\] WS\_Dedup\["WebSocket: IFeishuSeqIDDeduplicator"\] Webhook\_Dedup\["Webhook: IFeishuNonceDistributedDeduplicator"\] ProtoDesc\["åŸºäºæ¶ˆæ¯åºåˆ—å·å»é‡ï¼Œè¿‡æ»¤é‡å¤æ¶ˆæ¯"\] end AppHandler -->|å¤„ç†å™¨å†…éƒ¨ä¸šåŠ¡é€»è¾‘| EventDedup EventDedup -->|äº‹ä»¶è·¯ç”±ä¸åˆ†å‘| WS\_Dedup EventDedup -->|äº‹ä»¶è·¯ç”±ä¸åˆ†å‘| Webhook\_Dedup style AppLayer fill:#e1f5ff style DispatchLayer fill:#fff4e1 style ProtocolLayer fill:#ffe1e1

### è¿™ä¸‰å±‚åˆ†åˆ«è´Ÿè´£ä»€ä¹ˆï¼Ÿ

å¯ä»¥æŠŠè¿™ä¸‰å±‚æƒ³è±¡æˆå·¥å‚æµæ°´çº¿ä¸Šçš„ä¸‰ä¸ªè´¨æ£€å‘˜ï¼š

è´¨æ£€å‘˜

æ£€æŸ¥ä»€ä¹ˆï¼Ÿ

åœ¨å“ªæ£€æŸ¥ï¼Ÿ

è¿‡æ»¤èŒƒå›´

é€‚åˆä»€ä¹ˆæ—¶å€™ç”¨ï¼Ÿ

**åè®®å±‚**

æ¶ˆæ¯ç¼–å·ï¼ˆSeqIDï¼‰

æ¶ˆæ¯åˆšåˆ°è¾¾æ—¶

æ¯æ¡æ¶ˆæ¯

è¿‡æ»¤ç½‘ç»œé‡å¤ï¼Œæœ€å¤–å±‚é˜²æŠ¤

**åˆ†å‘å±‚**

äº‹ä»¶IDï¼ˆEventIdï¼‰

äº‹ä»¶åˆ†å‘å‰

æ¯ä¸ªäº‹ä»¶

è¿‡æ»¤é£ä¹¦é‡å‘ï¼Œä¸­é—´å±‚é˜²æŠ¤

**åº”ç”¨å±‚**

ä¸šåŠ¡é”®ï¼ˆTaskIdï¼‰

ä¸šåŠ¡å¤„ç†æ—¶

æ¯æ¬¡ä¸šåŠ¡æ“ä½œ

é˜²æ­¢é€»è¾‘é‡å¤ï¼Œæœ€åä¸€é“é˜²çº¿

* * *

åˆ†å‘å±‚ï¼šäº‹ä»¶çš„"èº«ä»½è¯æ£€æŸ¥"
--------------

è¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¸€å±‚ï¼Œå°±åƒé—¨å£çš„ä¿å®‰ï¼Œæ¯ä¸ªè¿›æ¥çš„äº‹ä»¶éƒ½è¦å…ˆå‡ºç¤ºèº«ä»½è¯ï¼ˆEventIdï¼‰ï¼Œä¿å®‰æŸ¥è¿‡è®°å½•åæ‰èƒ½æ”¾è¡Œã€‚

    public interface IFeishuEventDeduplicator
    {
        /// <summary>
        /// å°è¯•æ ‡è®°äº‹ä»¶ä¸ºå¤„ç†ä¸­
        /// </summary>
        /// <returns>
        /// true: å·²å¤„ç†æˆ–æ­£åœ¨å¤„ç†ä¸­ï¼ˆè·³è¿‡ï¼‰
        /// false: æ–°äº‹ä»¶ï¼ˆç»§ç»­å¤„ç†ï¼‰
        /// </returns>
        bool TryMarkAsProcessing(string eventId);
    
        /// <summary>
        /// æ ‡è®°äº‹ä»¶ä¸ºå·²å®Œæˆ
        /// </summary>
        void MarkAsCompleted(string eventId);
    
        /// <summary>
        /// å›æ»šå¤„ç†ä¸­çŠ¶æ€ï¼ˆå¼‚å¸¸æ—¶è°ƒç”¨ï¼‰
        /// </summary>
        void RollbackProcessing(string eventId);
    
        /// <summary>
        /// æ£€æŸ¥äº‹ä»¶æ˜¯å¦å·²å¤„ç†
        /// </summary>
        bool IsProcessed(string eventId);
    }
    

### äº‹ä»¶çš„ä¸€ç”Ÿï¼šä¸‰ç§çŠ¶æ€æµè½¬

æ¯ä¸ªäº‹ä»¶åœ¨å»é‡ç³»ç»Ÿé‡Œéƒ½åƒè¿‡å®‰æ£€ä¸€æ ·ï¼Œç»å†ä¸‰ç§çŠ¶æ€çš„å˜åŒ–ï¼š

stateDiagram-v2 \[\*\] --> Pending: æ”¶åˆ°æ–°äº‹ä»¶ Pending --> Processing: TryMarkAsProcessing() Processing --> Completed: å¤„ç†æˆåŠŸ Processing --> Pending: è¶…æ—¶/å¼‚å¸¸ï¼ˆRollbackï¼‰ Completed --> Pending: ç¼“å­˜è¿‡æœŸï¼ˆ24å°æ—¶åï¼‰ note right of Processing å¤„ç†ä¸­è¶…æ—¶ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰ å…è®¸é‡æ–°å¤„ç† end note note right of Completed 24å°æ—¶åè‡ªåŠ¨æ¸…ç† æ”¯æŒTTLé…ç½® end note

### çœŸå®åœºæ™¯ï¼šWebSocket æ˜¯æ€ä¹ˆå»é‡çš„ï¼Ÿ

æ¥çœ‹çœ‹ WebSocket æ”¶åˆ°äº‹ä»¶ååšäº†ä»€ä¹ˆï¼ˆ`FeishuEventMessageHandler.cs#104-147`ï¼‰ï¼š

    // 1. å»é‡æ£€æŸ¥
    bool isProcessing = false;
    
    if (_options.EnableDistributedDeduplication && _distributedDeduplicator != null)
    {
        // ä¼˜å…ˆä½¿ç”¨åˆ†å¸ƒå¼å»é‡ï¼ˆRedisï¼‰
        isProcessing = await _distributedDeduplicator.TryMarkAsProcessedAsync(
            eventData.EventId, 
            cancellationToken: cancellationToken);
    }
    else if (_options.EnableEventDeduplication && _deduplicator != null)
    {
        // ä½¿ç”¨å†…å­˜å»é‡
        isProcessing = _deduplicator.TryMarkAsProcessing(eventData.EventId);
    }
    
    // 2. è·³è¿‡å·²å¤„ç†äº‹ä»¶
    if (isProcessing)
    {
        _logger.LogDebug("äº‹ä»¶ {EventId} å·²åœ¨å¤„ç†ä¸­æˆ–å·²å¤„ç†ï¼Œè·³è¿‡", eventData.EventId);
        return;
    }
    
    // 3. å¤„ç†äº‹ä»¶
    try
    {
        await _eventHandlerFactory.HandleEventParallelAsync(
            eventData.EventType, 
            eventData, 
            cancellationToken);
    
        // 4. å¤„ç†æˆåŠŸï¼Œæ ‡è®°ä¸ºå·²å®Œæˆ
        if (_options.EnableEventDeduplication && _deduplicator != null)
        {
            _deduplicator.MarkAsCompleted(eventData.EventId);
        }
    }
    catch (Exception ex)
    {
        // 5. å¤„ç†å¤±è´¥ï¼Œå›æ»šçŠ¶æ€
        if (_options.EnableEventDeduplication && _deduplicator != null)
        {
            _deduplicator.RollbackProcessing(eventData.EventId);
        }
        throw;
    }
    

### æ–¹æ¡ˆä¸€ï¼šå†…å­˜å»é‡ï¼ˆé€‚åˆå¼€å‘å’Œå°è§„æ¨¡åº”ç”¨ï¼‰

**å°±åƒåœ¨å¤§è„‘é‡Œè®°ç¬”è®°**ï¼šæŠŠæ¯ä¸ªäº‹ä»¶IDè®°åœ¨å†…å­˜é‡Œï¼Œæ”¶åˆ°æ–°äº‹ä»¶æ—¶å…ˆæŸ¥æŸ¥ç¬”è®°ï¼Œå¦‚æœæœ‰å°±è·³è¿‡ã€‚

**ç‰¹ç‚¹**ï¼š

*   ğŸ§  **å…¨é è„‘å­è®°**ï¼šæ‰€æœ‰æ•°æ®å­˜åœ¨å†…å­˜é‡Œ
*   â° **è®°24å°æ—¶**ï¼šè¶…è¿‡æ—¶é—´å°±è‡ªåŠ¨å¿˜æ‰
*   ğŸ§¹ **å®šæœŸæ‰“æ‰«**ï¼šæ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸçš„è®°å½•
*   â±ï¸ **è¶…æ—¶ä¿æŠ¤**ï¼šå¤„ç†è¶…è¿‡5åˆ†é’Ÿè¿˜æ²¡å®Œæˆï¼Œå°±å…è®¸é‡è¯•

**æ ¸å¿ƒä»£ç **ï¼ˆ`FeishuEventDeduplicator.cs#86-135`ï¼‰ï¼š

    public bool TryMarkAsProcessing(string eventId)
    {
        lock (_lock)
        {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (_eventCache.TryGetValue(eventId, out var entry))
            {
                // å¦‚æœå·²å¤„ç†ï¼Œè¿”å› trueï¼ˆè·³è¿‡ï¼‰
                if (entry.Status == DeduplicationStatus.Completed)
                    return true;
    
                // å¦‚æœå·²åœ¨å¤„ç†ä¸­ï¼Œæ£€æŸ¥æ˜¯å¦è¶…æ—¶
                if (entry.Status == DeduplicationStatus.Processing)
                {
                    if (DateTimeOffset.UtcNow - entry.ProcessedAt > _processingTimeout)
                    {
                        // å¤„ç†ä¸­è¶…æ—¶ï¼Œå…è®¸é‡æ–°å¤„ç†
                        _logger?.LogWarning("äº‹ä»¶ {EventId} å¤„ç†ä¸­è¶…æ—¶ï¼Œå…è®¸é‡æ–°å¤„ç†", eventId);
                        _eventCache.Remove(eventId);
                        // ç»§ç»­å¤„ç†
                    }
                    else
                    {
                        // ä»åœ¨å¤„ç†ä¸­ï¼Œè·³è¿‡
                        return true;
                    }
                }
            }
    
            // æ ‡è®°ä¸ºå¤„ç†ä¸­
            _eventCache[eventId] = new EventCacheEntry
            {
                ProcessedAt = DateTimeOffset.UtcNow,
                EventId = eventId,
                Status = DeduplicationStatus.Processing
            };
    
            return false; // æœªå¤„ç†ï¼Œæ–°äº‹ä»¶
        }
    }
    

### æ–¹æ¡ˆäºŒï¼šRedis åˆ†å¸ƒå¼å»é‡ï¼ˆç”Ÿäº§ç¯å¢ƒé¦–é€‰ï¼‰

**å°±åƒå…±äº«ç¬”è®°æœ¬**ï¼šç”¨ Redis æŠŠå»é‡è®°å½•è®°åœ¨å¤–éƒ¨ï¼Œæ‰€æœ‰å®ä¾‹éƒ½èƒ½æŸ¥åˆ°ã€‚å°±ç®—é‡å¯æœåŠ¡ï¼Œç¬”è®°æœ¬è¿˜åœ¨ï¼Œä¸ä¼šå¿˜è®°ã€‚

**ç‰¹ç‚¹**ï¼š

*   ğŸ“’ **å†™åœ¨å…±äº«ç¬”è®°æœ¬ä¸Š**ï¼šæ‰€æœ‰å®ä¾‹ä¸€èµ·çœ‹
*   ğŸ”„ **è‡ªåŠ¨ç¿»é¡µ**ï¼šåˆ°æœŸè‡ªåŠ¨æ¸…ç†ï¼Œä¸ç”¨ç®¡
*   ğŸ¤ **å¤§å®¶ä¸€èµ·ç”¨**ï¼šå¤šå®ä¾‹éƒ¨ç½²æ²¡é—®é¢˜
*   âš¡ **åŸå­æ“ä½œ**ï¼šSETNX + EXPIRE ç¡®ä¿ä¸ä¼šå†™é”™

**æ ¸å¿ƒä»£ç **ï¼ˆ`RedisFeishuEventDistributedDeduplicator.cs#53-89`ï¼‰ï¼š

    public async Task<bool> TryMarkAsProcessedAsync(
        string eventId, 
        TimeSpan? ttl = null, 
        CancellationToken cancellationToken = default)
    {
        var actualTtl = ttl ?? _defaultCacheExpiration;
        var redisKey = $"{_keyPrefix}{eventId}";
    
        // ä½¿ç”¨ SETNX + EXPIRE å®ç°åŸå­æ€§å»é‡
        // ä»…å½“é”®ä¸å­˜åœ¨æ—¶è®¾ç½®ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´
        var setResult = await _database.StringSetAsync(
            redisKey,
            "1",
            actualTtl,
            When.NotExists);
    
        if (!setResult)
        {
            _logger?.LogDebug("äº‹ä»¶ {EventId} å·²å¤„ç†è¿‡ï¼Œè·³è¿‡", eventId);
            return true; // å·²å¤„ç†
        }
    
        _logger?.LogDebug("äº‹ä»¶ {EventId} æ ‡è®°ä¸ºå·²å¤„ç†ï¼ŒTTL: {Ttl}", eventId, actualTtl);
        return false; // æœªå¤„ç†ï¼Œæ–°äº‹ä»¶
    }
    

### ä¸¤ç§æ–¹æ¡ˆæ€ä¹ˆé€‰ï¼Ÿ

å¯¹æ¯”é¡¹

å†…å­˜å»é‡ï¼ˆè‡ªå·±è®°ï¼‰

Redis å»é‡ï¼ˆå…±äº«ç¬”è®°æœ¬ï¼‰

**é€Ÿåº¦**

âš¡ åƒé—ªç”µä¸€æ ·å¿«ï¼ˆç›´æ¥è¯»å†…å­˜ï¼‰

ğŸš€ å¾ˆå¿«ï¼ˆä½†éœ€è¦ç½‘ç»œï¼‰

**å¯é æ€§**

âš ï¸ é‡å¯å°±å¿˜å…‰

âœ… æ°¸è¿œè®°ç€ï¼Œé‡å¯ä¹Ÿè¿˜åœ¨

**å¤šå®ä¾‹**

âŒ æ¯ä¸ªäººå„è®°å„çš„

âœ… å¤§å®¶ä¸€èµ·çœ‹åŒä¸€æœ¬ç¬”è®°

**éº»çƒ¦ç¨‹åº¦**

ğŸŸ¢ é›¶ä¾èµ–ï¼Œå¼€ç®±å³ç”¨

ğŸŸ¡ éœ€è¦éƒ¨ç½² Redis

**é€‚åˆè°**

ğŸ  å¼€å‘ç¯å¢ƒã€å•æœºè¿è¡Œ

ğŸ¢ ç”Ÿäº§ç¯å¢ƒã€å¤šå®ä¾‹éƒ¨ç½²

* * *

åè®®å±‚ï¼šæ¶ˆæ¯çš„"æ’é˜Ÿå·æ£€æŸ¥"
--------------

### WebSocket çš„ SeqID æ˜¯ä»€ä¹ˆï¼Ÿ

é£ä¹¦ WebSocket ç”¨çš„æ˜¯ ProtoBuf äºŒè¿›åˆ¶åè®®ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½å¸¦ç€ä¸€ä¸ª**é€’å¢çš„åºå·**ï¼Œå°±åƒå»é“¶è¡ŒåŠäº‹æ‹¿çš„æ’é˜Ÿå·ã€‚é€šè¿‡è®°ä½å·²ç»å¤„ç†è¿‡çš„æ’é˜Ÿå·ï¼Œå°±èƒ½åœ¨æ¶ˆæ¯å±‚é¢å°±æŠŠé‡å¤çš„æŒ¡åœ¨å¤–é¢ã€‚

#### SeqID å»é‡æ€ä¹ˆå·¥ä½œï¼Ÿ

    public interface IFeishuSeqIDDeduplicator
    {
        /// <summary>
        /// å°è¯•æ ‡è®° SeqID ä¸ºå·²å¤„ç†
        /// </summary>
        /// <returns>
        /// true: å·²å¤„ç†è¿‡ï¼ˆè·³è¿‡ï¼‰
        /// false: æ–°æ¶ˆæ¯ï¼ˆç»§ç»­å¤„ç†ï¼‰
        /// </returns>
        bool TryMarkAsProcessed(ulong seqId);
    
        /// <summary>
        /// æ£€æŸ¥ SeqID æ˜¯å¦å·²å¤„ç†
        /// </summary>
        bool IsProcessed(ulong seqId);
    
        /// <summary>
        /// å¼‚æ­¥æ£€æŸ¥ SeqID æ˜¯å¦å·²å¤„ç†
        /// </summary>
        Task<bool> IsProcessedAsync(ulong seqId);
    
        /// <summary>
        /// æ¸…ç©ºç¼“å­˜
        /// </summary>
        void ClearCache();
    
        /// <summary>
        /// è·å–ç¼“å­˜ä¸­çš„ SeqID æ•°é‡
        /// </summary>
        int GetCacheCount();
    
        /// <summary>
        /// è·å–å·²å¤„ç†çš„æœ€å¤§ SeqID
        /// </summary>
        ulong GetMaxProcessedSeqId();
    }
    

#### å®ç°æœºåˆ¶

graph LR A\[æ”¶åˆ°ProtoBufæ¶ˆæ¯\] --> B{SeqIDæ£€æŸ¥} B -->|å·²å¤„ç†| C\[è·³è¿‡æ¶ˆæ¯\] B -->|æœªå¤„ç†| D\[è®°å½•SeqID\] D --> E\[å¤„ç†æ¶ˆæ¯\] E --> F\[å‘é€ACKç¡®è®¤\] D --> G\[æ›´æ–°æœ€å¤§SeqID\] G --> H\[å®šæ—¶æ¸…ç†è¿‡æœŸSeqID\]

#### æ ¸å¿ƒå®ç°

**å†…å­˜å®ç°**ï¼ˆ`FeishuSeqIDDeduplicator.cs`ï¼‰ï¼š

    public bool TryMarkAsProcessed(ulong seqId)
    {
        lock (_lock)
        {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (_processedSeqIds.Contains(seqId))
            {
                _logger?.LogDebug("SeqID {SeqId} å·²å¤„ç†è¿‡ï¼Œè·³è¿‡", seqId);
                return true; // å·²å¤„ç†
            }
    
            // è®°å½•æ–° SeqID
            _processedSeqIds.Add(seqId);
            _seqIdTimestamps[seqId] = DateTimeOffset.UtcNow;
    
            // æ›´æ–°æœ€å¤§ SeqID
            if (seqId > _maxProcessedSeqId)
            {
                _maxProcessedSeqId = seqId;
            }
    
            return false; // æœªå¤„ç†ï¼Œæ–°æ¶ˆæ¯
        }
    }
    

**ä½¿ç”¨ä½ç½®**ï¼ˆ`BinaryMessageProcessor.cs#186-194`ï¼‰ï¼š

    // SeqID å»é‡æ£€æŸ¥
    if (_seqIdDeduplicator != null && _seqIdDeduplicator.TryMarkAsProcessed(frame.SeqID))
    {
        _logger.LogDebug("SeqID {SeqID} å·²å¤„ç†è¿‡ï¼Œè·³è¿‡", frame.SeqID);
        eventArgs.SkipReason = $"SeqID {frame.SeqID} å·²å¤„ç†è¿‡";
        BinaryMessageReceived?.Invoke(this, eventArgs);
        
        // ä»ç„¶å‘é€ACKç¡®è®¤
        await SendAckMessageAsync(frame, true, cancellationToken);
        return;
    }
    

#### ç‰¹æ€§æ€»ç»“

*   âœ… **åŸºäº HashSet é«˜æ•ˆæŸ¥æ‰¾**ï¼šO(1) æŸ¥è¯¢å¤æ‚åº¦
*   âœ… **è‡ªåŠ¨è·Ÿè¸ªæœ€å¤§ SeqID**ï¼šæ”¯æŒé¡ºåºæ€§éªŒè¯
*   âœ… **24å°æ—¶è¿‡æœŸæœºåˆ¶**ï¼šå®šæœŸæ¸…ç†å†å²æ•°æ®
*   âœ… **å†…å­˜å‹å¥½**ï¼šä»…å­˜å‚¨ SeqIDï¼Œä¸å­˜å‚¨å®Œæ•´æ¶ˆæ¯

### Webhook çš„ Nonceï¼šé˜²é‡æ”¾æ”»å‡»çš„ç§˜å¯†æ­¦å™¨

é£ä¹¦ Webhook çš„è¯·æ±‚é‡Œå¸¦æœ‰ä¸€ä¸ª `nonce`ï¼ˆéšæœºæ•°ï¼‰ï¼Œè¿™å°±åƒä¸€æ¬¡æ€§å¯†ç â€”â€”ç”¨è¿‡çš„å¯†ç å°±ä¸èƒ½å†ç”¨äº†ï¼Œè¿™æ ·å°±èƒ½é˜²æ­¢"é‡æ”¾æ”»å‡»"ï¼ˆåäººæ‹¿åŒä¸€ä¸ªè¯·æ±‚é‡å¤å‘é€ï¼‰ã€‚

#### é˜²é‡æ”¾æ”»å‡»æµç¨‹

    æ”»å‡»è€…å°è¯•é‡æ”¾è¯·æ±‚ï¼š
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    åŸå§‹è¯·æ±‚ï¼šNonce="abc123", Timestamp="1234567890"
    âœ… æ­£å¸¸å¤„ç†ï¼ˆé¦–æ¬¡æ¥æ”¶ï¼‰
    
    é‡æ”¾è¯·æ±‚ï¼šNonce="abc123", Timestamp="1234567890"
    âŒ æ‹’ç»å¤„ç†ï¼ˆNonce å·²è®°å½•ï¼‰
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    

#### Redis å®ç°

    public class RedisFeishuNonceDistributedDeduplicator : IFeishuNonceDistributedDeduplicator
    {
        private readonly IDatabase _database;
        private readonly TimeSpan _defaultTtl = TimeSpan.FromMinutes(5); // 5åˆ†é’Ÿè¿‡æœŸ
    
        public async Task<bool> TryMarkAsProcessedAsync(string nonce, CancellationToken cancellationToken = default)
        {
            var redisKey = $"{_keyPrefix}{nonce}";
    
            // SETNX + EXPIREï¼š5åˆ†é’Ÿå†…é‡å¤ nonce ä¼šè¢«æ‹’ç»
            var setResult = await _database.StringSetAsync(
                redisKey,
                "1",
                _defaultTtl,
                When.NotExists);
    
            if (!setResult)
            {
                _logger?.LogWarning("æ£€æµ‹åˆ°é‡å¤çš„ Nonce: {Nonce}ï¼Œå¯èƒ½ä¸ºé‡æ”¾æ”»å‡»", nonce);
                return true; // å·²å¤„ç†ï¼Œæ‹’ç»
            }
    
            return false; // é¦–æ¬¡å¤„ç†
        }
    }
    

* * *

åº”ç”¨å±‚ï¼šç»™æ¯ä¸ªä¸šåŠ¡æ“ä½œå‘"èº«ä»½è¯"
-----------------

### ä¸ºä»€ä¹ˆè¿˜éœ€è¦è¿™ä¸€å±‚ï¼Ÿ

å°±ç®—å‰é¢ä¸¤å±‚éƒ½æŒ¡ä½äº†ï¼Œä¸šåŠ¡é€»è¾‘è¿˜æ˜¯æœ‰å¯èƒ½é‡å¤æ‰§è¡Œï¼Œæ¯”å¦‚ï¼š

*   ğŸ”€ åŒä¸€äº‹ä»¶è§¦å‘äº†å¤šä¸ªå¤„ç†å™¨ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰
*   ğŸ”„ å¤„ç†å™¨å†…éƒ¨å¤šæ¬¡è®¿é—®åŒä¸€ä¸ªèµ„æº
*   ğŸ“¡ ç¬¬ä¸‰æ–¹æ¥å£é‡è¯•å¯¼è‡´é‡å¤è°ƒç”¨

### å®é™…çš„å¹‚ç­‰æ€§å®ç°æ–¹å¼

åœ¨å®é™…çš„ Mud.Feishu SDK ä¸­ï¼Œä¸šåŠ¡å±‚å¹‚ç­‰æ€§ä¸»è¦é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å®ç°ï¼š

**æ–¹å¼1ï¼šä½¿ç”¨ `DefaultFeishuObjectEventHandler<T>`ï¼ˆæ¨èï¼‰**  
SDK æä¾›äº† `DefaultFeishuObjectEventHandler<T>` åŸºç±»ï¼Œä¸“é—¨ç”¨äºå¤„ç†å¯¹è±¡ç±»å‹çš„äº‹ä»¶ã€‚ä½ åªéœ€è¦ç»§æ‰¿è¿™ä¸ªåŸºç±»ï¼Œå¹¶åœ¨ä¸šåŠ¡é€»è¾‘ä¸­æ£€æŸ¥æ•°æ®æ˜¯å¦å·²å­˜åœ¨å³å¯ã€‚

**æ–¹å¼2ï¼šä½¿ç”¨ `IdempotentFeishuEventHandler<T>`**  
SDK è¿˜æä¾›äº†ä¸€ä¸ª `IdempotentFeishuEventHandler<T>` åŸºç±»ï¼Œæä¾›äº†åŸºäºä¸šåŠ¡é”®çš„è‡ªåŠ¨å»é‡èƒ½åŠ›ã€‚ä½ éœ€è¦é‡å†™ `GetBusinessKey()` æ–¹æ³•å’Œ `HandleEventInternalAsync()` æ–¹æ³•ï¼ŒåŸºç±»ä¼šè‡ªåŠ¨å¤„ç†ä¸šåŠ¡å»é‡ã€‚

* * *

### æ‰‹æŠŠæ‰‹æ•™ä½ ç”¨ï¼šä¸‰ä¸ªå®é™…æ¡ˆä¾‹

#### æ¡ˆä¾‹ 1ï¼šæ¶ˆæ¯å¤„ç†â€”â€”é˜²æ­¢é‡å¤åˆ›å»ºå¾…åŠ

    public class MessageEventHandler : DefaultFeishuObjectEventHandler<MessageReceiveResult>
    {
        private readonly IMessageService _messageService;
    
        public MessageEventHandler(
            ILogger<MessageEventHandler> logger,
            IMessageService messageService)
            : base(logger)
        {
            _messageService = messageService;
        }
    
        protected override async Task ProcessBusinessLogicAsync(
            EventData eventData,
            ObjectEventResult<MessageReceiveResult>? messageData,
            CancellationToken cancellationToken = default)
        {
            if (eventData == null)
                throw new ArgumentNullException(nameof(eventData));
    
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†ï¼ˆä¸šåŠ¡å±‚å¹‚ç­‰æ€§ï¼‰
            var messageId = messageData?.Object.MessageId;
            if (string.IsNullOrEmpty(messageId))
            {
                _logger.LogWarning("æ¶ˆæ¯IDä¸ºç©ºï¼Œè·³è¿‡å¤„ç†");
                return;
            }
    
            var alreadyProcessed = await _messageService.IsMessageProcessedAsync(messageId, cancellationToken);
            if (alreadyProcessed)
            {
                _logger.LogInformation("æ¶ˆæ¯ {MessageId} å·²å¤„ç†ï¼Œè·³è¿‡", messageId);
                return;
            }
    
            // å¤„ç†æ¶ˆæ¯
            await _messageService.ProcessMessageAsync(messageData!.Object, cancellationToken);
        }
    }
    

#### æ¡ˆä¾‹ 2ï¼šéƒ¨é—¨å¤„ç†â€”â€”é¿å…é‡å¤åˆ›å»º

    public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler<DepartmentCreatedResult>
    {
        private readonly IDepartmentService _departmentService;
    
        public DepartmentCreatedEventHandler(
            ILogger<DepartmentCreatedEventHandler> logger,
            IDepartmentService departmentService)
            : base(logger)
        {
            _departmentService = departmentService;
        }
    
        protected override async Task ProcessBusinessLogicAsync(
            EventData eventData,
            ObjectEventResult<DepartmentCreatedResult>? departmentData,
            CancellationToken cancellationToken = default)
        {
            if (eventData == null)
                throw new ArgumentNullException(nameof(eventData));
    
            if (departmentData?.Object == null)
            {
                _logger.LogWarning("éƒ¨é—¨æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†");
                return;
            }
    
            // æ£€æŸ¥éƒ¨é—¨æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸šåŠ¡å±‚å¹‚ç­‰æ€§ï¼‰
            var departmentId = departmentData.Object.DepartmentId;
            var exists = await _departmentService.ExistsAsync(departmentId, cancellationToken);
    
            if (exists)
            {
                _logger.LogInformation("éƒ¨é—¨ {DepartmentId} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º", departmentId);
                return;
            }
    
            // åˆ›å»ºéƒ¨é—¨
            await _departmentService.CreateAsync(departmentData.Object, cancellationToken);
        }
    }
    

#### æ¡ˆä¾‹ 3ï¼šç”¨æˆ·åˆ›å»ºâ€”â€”é¿å…é‡å¤æ³¨å†Œ

    public class UserCreatedEventHandler : DefaultFeishuObjectEventHandler<UserCreatedResult>
    {
        private readonly IUserService _userService;
    
        public UserCreatedEventHandler(
            ILogger<UserCreatedEventHandler> logger,
            IUserService userService)
            : base(logger)
        {
            _userService = userService;
        }
    
        protected override async Task ProcessBusinessLogicAsync(
            EventData eventData,
            ObjectEventResult<UserCreatedResult>? userData,
            CancellationToken cancellationToken = default)
        {
            if (eventData == null)
                throw new ArgumentNullException(nameof(eventData));
    
            if (userData?.Object == null)
            {
                _logger.LogWarning("ç”¨æˆ·æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†");
                return;
            }
    
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨ï¼ˆä¸šåŠ¡å±‚å¹‚ç­‰æ€§ï¼‰
            var userId = userData.Object.UserId;
            var exists = await _userService.ExistsAsync(userId, cancellationToken);
    
            if (exists)
            {
                _logger.LogInformation("ç”¨æˆ· {UserId} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º", userId);
                return;
            }
    
            // åˆ›å»ºç”¨æˆ·
            await _userService.CreateAsync(userData.Object, cancellationToken);
        }
    }
    

### æ€ä¹ˆè®¾è®¡ä¸šåŠ¡é”®ï¼Ÿæœ‰å¥—è·¯å—ï¼Ÿ

ä¸šåŠ¡åœºæ™¯

ä¸šåŠ¡é”®é•¿ä»€ä¹ˆæ ·ï¼Ÿ

ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ï¼Ÿ

æ”¶åˆ°æ¶ˆæ¯

`im.message.receive_v1:om_xxxxxxxxxx`

äº‹ä»¶ç±»å‹ + æ¶ˆæ¯IDï¼Œä¸€çœ¼çœ‹å‡ºæ˜¯å“ªæ¡æ¶ˆæ¯

åˆ›å»ºéƒ¨é—¨

`contact.department.created_v3:od_xxxxxxxxxx`

äº‹ä»¶ç±»å‹ + éƒ¨é—¨IDï¼Œé¿å…å’Œå…¶ä»–IDå†²çª

åˆ›å»ºç”¨æˆ·

`contact.user.created_v3:ou_xxxxxxxxxx`

äº‹ä»¶ç±»å‹ + ç”¨æˆ·IDï¼Œå”¯ä¸€æ ‡è¯†ç”¨æˆ·

åˆ é™¤éƒ¨é—¨

`contact.department.deleted_v3:od_xxxxxxxxxx`

äº‹ä»¶ç±»å‹ + éƒ¨é—¨IDï¼Œå¤„ç†åˆ é™¤äº‹ä»¶

æ¶ˆæ¯å·²è¯»

`im.message.message_read_v1:ou_xxxxxxxxxx:om_xxxxxxxxxx`

äº‹ä»¶ç±»å‹ + ç”¨æˆ·ID + æ¶ˆæ¯ID

**å››æ¡é»„é‡‘æ³•åˆ™**ï¼š

1.  ğŸ”‘ **å”¯ä¸€æ€§**ï¼šä¸€ä¸ªæ“ä½œå¯¹åº”ä¸€ä¸ªé”®ï¼Œä¸èƒ½æœ‰ä¸¤ä¸ªæ“ä½œæ’è½¦
2.  ğŸ‘€ **å¯è¯»æ€§**ï¼šçœ‹æ—¥å¿—æ—¶èƒ½å¿«é€ŸçŸ¥é“è¿™æ˜¯ä»€ä¹ˆ
3.  ğŸ§± **ç¨³å®šæ€§**ï¼šåˆ«ç”¨æ—¶é—´æˆ³è¿™ç§ä¼šå˜çš„å­—æ®µåšé”®
4.  âœ‚ï¸ **ç®€æ´æ€§**ï¼šåˆ«å†™å¤ªé•¿ï¼Œçœå†…å­˜ã€å¥½æŸ¥è¯¢

* * *

é…ç½®å®æˆ˜ï¼šå¼€å‘ vs ç”Ÿäº§ç¯å¢ƒ
---------------

### WebSocket æ€ä¹ˆé…ç½®ï¼Ÿ

    // ä½¿ç”¨å»ºé€ è€…æ¨¡å¼é…ç½® WebSocket
    builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            // äº‹ä»¶å»é‡é…ç½®
            options.EnableEventDeduplication = true;           // å¯ç”¨äº‹ä»¶å»é‡
            options.EnableDistributedDeduplication = false;    // å•æœºåœºæ™¯ä½¿ç”¨å†…å­˜å»é‡
            options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ—¶è¿‡æœŸ
            options.EventDeduplicationCleanupIntervalMs = 300000;    // 5åˆ†é’Ÿæ¸…ç†é—´éš”
        });
    

#### ç”Ÿäº§ç¯å¢ƒå¿…å¤‡é…ç½®ï¼ˆä¸€å®šè¦çœ‹ï¼ï¼‰

    // 1. é…ç½® Redisï¼ˆåœ¨ appsettings.json ä¸­ï¼‰
    // {
    //   "Feishu": {
    //     "Redis": {
    //       "ConnectionString": "your-redis-server"
    //     }
    //   }
    // }
    
    // 2. æ³¨å†Œ Redis æœåŠ¡å’Œå»é‡æœåŠ¡
    builder.Services
        .AddFeishuRedis()
        .AddFeishuRedisDeduplicators();
    
    // 3. å¯ç”¨åˆ†å¸ƒå¼å»é‡
    builder.Services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            options.EnableDistributedDeduplication = true;   // å¯ç”¨åˆ†å¸ƒå¼å»é‡
            options.EventDeduplicationCacheExpirationMs = 86400000;  // 24å°æ—¶
        });
    

### Webhook é…ç½®

    // æ³¨å†Œ Webhook æœåŠ¡
    builder.Services.AddFeishuWebhookServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            options.VerificationToken = "your_verification_token";
            options.EncryptKey = "your_encrypt_key";
            options.EventHandlingTimeoutMs = 30000;          // 30ç§’è¶…æ—¶
            options.MaxConcurrentEvents = 10;                // æœ€å¤§å¹¶å‘æ•°
        });
    
    // æ³¨å†Œ Redis å»é‡
    builder.Services
        .AddFeishuRedis()
        .AddFeishuRedisEventDeduplicator();
    

### ä¸€å¼ è¡¨çœ‹æ‡‚å¼€å‘ä¸ç”Ÿäº§çš„åŒºåˆ«

é…ç½®é¡¹

å¼€å‘ç¯å¢ƒ

ç”Ÿäº§ç¯å¢ƒ

è¯´æ˜

`EnableEventDeduplication`

`true`

`true`

å§‹ç»ˆå¯ç”¨å†…å­˜å»é‡

`EnableDistributedDeduplication`

`false`

`true`

ç”Ÿäº§ç¯å¢ƒå¯ç”¨Rediså»é‡

`EventDeduplicationCacheExpirationMs`

`3600000` (1å°æ—¶)

`86400000` (24å°æ—¶)

ç”Ÿäº§ç¯å¢ƒå»¶é•¿çª—å£æœŸ

`EventDeduplicationCleanupIntervalMs`

`60000` (1åˆ†é’Ÿ)

`300000` (5åˆ†é’Ÿ)

ç”Ÿäº§ç¯å¢ƒé™ä½æ¸…ç†é¢‘ç‡

### å®Œæ•´é…ç½®ï¼šä»é›¶åˆ°ä¸Šçº¿ä¸€æ¬¡æå®š

    public void ConfigureServices(IServiceCollection services)
    {
        // é…ç½® Redisï¼ˆappsettings.json ä¸­é…ç½®ï¼‰
        services
            .AddFeishuRedis()
            .AddFeishuRedisDeduplicators();
    
        // æ³¨å†Œ WebSocket æœåŠ¡
        services.AddFeishuWebSocketServiceBuilder(configuration)
            .ConfigureOptions(wsOptions =>
            {
                wsOptions.EnableEventDeduplication = true;
                wsOptions.EnableDistributedDeduplication = true;
                wsOptions.EventDeduplicationCacheExpirationMs = 86400000;
                wsOptions.AutoReconnect = true;
                wsOptions.MaxReconnectAttempts = 5;
                wsOptions.HeartbeatIntervalMs = 30000;
            })
            .AddHandler<MessageEventHandler>()
            .AddHandler<DepartmentCreatedEventHandler>()
            .Build();
    
        // æ³¨å†Œ Webhook æœåŠ¡
        services.AddFeishuWebhookServiceBuilder(configuration)
            .ConfigureOptions(webhookOptions =>
            {
                webhookOptions.VerificationToken = "your_token";
                webhookOptions.EncryptKey = "your_key";
                webhookOptions.EventHandlingTimeoutMs = 30000;
                webhookOptions.MaxConcurrentEvents = 20;
            })
            .AddHandler<UserCreatedEventHandler>()
            .Build();
    }
    

### è¿˜æœ‰ä¸ªè´´å¿ƒåŠŸèƒ½ï¼šé…ç½®é”™è¯¯è‡ªåŠ¨æé†’

SDK ä¼šè‡ªåŠ¨æ£€æŸ¥é…ç½®ï¼Œå¦‚æœä½ æŠŠå»é‡åŠŸèƒ½å…¨å…³äº†ï¼Œå®ƒä¼šç›´æ¥æŠ¥é”™æé†’ä½ ï¼š

    // FeishuWebSocketOptions.Validate() è‡ªåŠ¨æ‰§è¡Œ
    // SDK ä¼šåœ¨æœåŠ¡å¯åŠ¨æ—¶æ£€æŸ¥é…ç½®ï¼Œå¦‚æœå»é‡åŠŸèƒ½å…¨å…³é—­ä¼šæŠ›å‡ºè­¦å‘Š
    

* * *

è¸©å‘æŒ‡å—ï¼šäº”ä¸ªå¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
----------------

### é—®é¢˜ 1ï¼šæœåŠ¡é‡å¯ï¼Œé‡å¤äº‹ä»¶åˆæ¥äº†

**ç°åœºæ˜¯è¿™æ ·çš„**ï¼š

**ç°è±¡**ï¼š

    09:00 æœåŠ¡æ¥æ”¶ EventId="evt_123" âœ… å¤„ç†æˆåŠŸ
    09:05 æœåŠ¡é‡å¯ï¼ˆå†…å­˜ç¼“å­˜æ¸…ç©ºï¼‰
    09:06 é£ä¹¦é‡å‘ EventId="evt_123" âŒ é‡å¤å¤„ç†
    

**ä¸ºä»€ä¹ˆï¼Ÿ**

*   ğŸ§  å†…å­˜å»é‡å°±åƒçŸ­æœŸè®°å¿†ï¼Œé‡å¯å°±å¿˜å…‰äº†
*   ğŸ“¡ é£ä¹¦æ²¡æ”¶åˆ°ä½ çš„ç¡®è®¤ï¼Œä»¥ä¸ºä½ æ²¡æ”¶åˆ°ï¼Œç»§ç»­å‘

**æ€ä¹ˆè§£å†³ï¼Ÿ**

âœ… **æ–¹æ¡ˆ1ï¼šå¯ç”¨ Redis åˆ†å¸ƒå¼å»é‡ï¼ˆæ¨èï¼‰**

    // é…ç½® Redisï¼ˆappsettings.json ä¸­é…ç½®è¿æ¥ä¿¡æ¯ï¼‰
    services
        .AddFeishuRedis()
        .AddFeishuRedisDeduplicators();
    
    services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            options.EnableDistributedDeduplication = true; // ä½¿ç”¨Redis
            options.EnableEventDeduplication = false;    // ç¦ç”¨å†…å­˜å»é‡
        });
    

âœ… **æ–¹æ¡ˆ2ï¼šå®ç°å»é‡çŠ¶æ€æŒä¹…åŒ–**

    public class PersistentEventDeduplicator : IFeishuEventDeduplicator
    {
        private readonly IDatabase _database;
    
        public bool TryMarkAsProcessing(string eventId)
        {
            // å°è¯•å†™å…¥æ•°æ®åº“
            var exists = _database.EventExists(eventId);
            if (!exists)
            {
                _database.MarkProcessing(eventId);
                return false;
            }
            return true;
        }
    }
    

* * *

### é—®é¢˜ 2ï¼šå¤šå®ä¾‹ä¸€èµ·è·‘ï¼Œé‡å¤å¤„ç†æŒ¡ä¸ä½

**ç°åœºæ˜¯è¿™æ ·çš„**ï¼š

    å®ä¾‹A å’Œ å®ä¾‹B åŒæ—¶å¯åŠ¨
    é£ä¹¦æ¨é€ EventId="evt_123"
    å®ä¾‹A æ”¶åˆ° â†’ å¤„ç† âœ…
    å®ä¾‹B æ”¶åˆ° â†’ å¤„ç† âŒ (é‡å¤ï¼)
    

**ä¸ºä»€ä¹ˆï¼Ÿ**

*   ğŸ§  æ¯ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„"å°æœ¬æœ¬"
*   ğŸš« å®ä¾‹ä¹‹é—´äº’ç›¸çœ‹ä¸åˆ°å¯¹æ–¹çš„è®°å½•

**æ€ä¹ˆè§£å†³ï¼Ÿ**

âœ… **å¿…é¡»ä½¿ç”¨ Redis åˆ†å¸ƒå¼å»é‡**

    // æ‰€æœ‰å®ä¾‹è¿æ¥åˆ°åŒä¸€ä¸ª Redisï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼‰
    services
        .AddFeishuRedis()
        .AddFeishuRedisDeduplicators();
    
    services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            options.EnableDistributedDeduplication = true;
        });
    

**ä¸€å¼ å›¾çœ‹æ‡‚åŒºåˆ«**ï¼š

graph TB subgraph Wrong\["âŒ é”™è¯¯æ¶æ„ï¼ˆå†…å­˜å»é‡ï¼‰"\] A1\["å®ä¾‹A<br/>å†…å­˜ç¼“å­˜A<br/>evt\_123 âœ…"\] A2\["å®ä¾‹B<br/>å†…å­˜ç¼“å­˜B<br/>evt\_123 âŒ"\] end subgraph Right\["âœ… æ­£ç¡®æ¶æ„ï¼ˆRediså»é‡ï¼‰"\] B1\["å®ä¾‹A"\] B2\["å®ä¾‹B"\] Redis\["Redis å»é‡<br/>evt\_123 âœ…"\] end B1 --> Redis B2 --> Redis style Wrong fill:#ffebee style Right fill:#e8f5e9 style Redis fill:#e3f2fd

* * *

### é—®é¢˜ 3ï¼šå¤„ç†è¶…æ—¶ï¼Œé‡å¤äº‹ä»¶è¶è™šè€Œå…¥

**ç°åœºæ˜¯è¿™æ ·çš„**ï¼š

    09:00 å¼€å§‹å¤„ç† EventId="evt_123"
    09:01 å¤„ç†è¶…æ—¶ï¼ˆè¶…æ—¶30ç§’ï¼‰
    09:01 å›æ»š Processing çŠ¶æ€
    09:02 é£ä¹¦é‡å‘ EventId="evt_123"
    09:02 é‡å¤å¤„ç† âŒ (å®é™…å·²æˆåŠŸï¼)
    

**ä¸ºä»€ä¹ˆï¼Ÿ**

*   â±ï¸ è¶…æ—¶åç³»ç»Ÿä»¥ä¸ºæ²¡å®Œæˆï¼ŒæŠŠ"å¤„ç†ä¸­"æ ‡è®°æ’¤å›äº†
*   âœ… ä½†ä¸šåŠ¡å¯èƒ½å·²ç»åšå®Œäº†ï¼Œåªæ˜¯å“åº”æ…¢äº†ä¸€ç‚¹ç‚¹

**æ€ä¹ˆè§£å†³ï¼Ÿ**

âœ… **æ–¹æ¡ˆ1ï¼šå¢åŠ æœ€ç»ˆä¸€è‡´æ€§æ£€æŸ¥**

    public class DepartmentCreatedEventHandler : DefaultFeishuObjectEventHandler<DepartmentCreatedResult>
    {
        private readonly IDepartmentService _departmentService;
    
        protected override async Task ProcessBusinessLogicAsync(
            EventData eventData,
            ObjectEventResult<DepartmentCreatedResult>? departmentData,
            CancellationToken ct)
        {
            if (departmentData?.Object == null)
                return;
    
            var departmentId = departmentData.Object.DepartmentId;
    
            // å…ˆæ£€æŸ¥éƒ¨é—¨æ˜¯å¦å·²å­˜åœ¨ï¼ˆå¹‚ç­‰æ€§ï¼‰
            var existingDepartment = await _departmentService.GetAsync(departmentId, ct);
            if (existingDepartment != null)
            {
                _logger.LogInformation("éƒ¨é—¨ {DepartmentId} å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º", departmentId);
                return;
            }
    
            // åˆ›å»ºéƒ¨é—¨
            await _departmentService.CreateAsync(departmentData.Object, ct);
        }
    }
    

âœ… **æ–¹æ¡ˆ2ï¼šå®ç°å¤„ç†ç»­æœŸæœºåˆ¶**

    public class LongRunningTaskHandler : DefaultFeishuEventHandler
    {
        private readonly IFeishuEventDeduplicator _deduplicator;
    
        protected override async Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
        {
            var eventId = eventData.EventId;
    
            // å®šæœŸç»­æœŸå¤„ç†æ—¶é—´ï¼ˆæ¯30ç§’ï¼‰
            var renewalTask = Task.Run(async () =>
            {
                while (!ct.IsCancellationRequested)
                {
                    await Task.Delay(30000, ct);
                    _deduplicator.RenewProcessing(eventId);
                }
            }, ct);
    
            try
            {
                await ProcessLongRunningTask(eventData, ct);
            }
            finally
            {
                await renewalTask;
            }
        }
    }
    

* * *

### é—®é¢˜ 4ï¼šRedis å®•æœºï¼Œå»é‡é˜²æŠ¤å…¨å¤±æ•ˆ

**ç°åœºæ˜¯è¿™æ ·çš„**ï¼š

    Redis å®•æœº
    æœåŠ¡æ— æ³•è°ƒç”¨ TryMarkAsProcessedAsync()
    è¿”å› falseï¼ˆå…è®¸å¤„ç†ï¼‰
    å¤šä¸ªå®ä¾‹é‡å¤å¤„ç†åŒä¸€äº‹ä»¶ âŒ
    

**ä¸ºä»€ä¹ˆï¼Ÿ**

*   ğŸš« Redis æŒ‚äº†ï¼Œä»£ç ä¸ºäº†ä¸é˜»å¡é€‰æ‹©"å…è®¸å¤„ç†"
*   âŒ ç»“æœé‡å¤äº‹ä»¶å…¨æ¶Œè¿›æ¥

**æ€ä¹ˆè§£å†³ï¼Ÿ**

âœ… **æ–¹æ¡ˆ1ï¼šå®ç°é™çº§åˆ°å†…å­˜å»é‡**

    public class HybridEventDeduplicator : IFeishuEventDeduplicator
    {
        private readonly IFeishuEventDistributedDeduplicator _redis;
        private readonly IFeishuEventDeduplicator _memory;
    
        public bool TryMarkAsProcessing(string eventId)
        {
            try
            {
                // ä¼˜å…ˆä½¿ç”¨ Redis
                return _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Rediså»é‡å¤±è´¥ï¼Œé™çº§åˆ°å†…å­˜å»é‡");
                // é™çº§åˆ°å†…å­˜å»é‡
                return _memory.TryMarkAsProcessing(eventId);
            }
        }
    }
    

âœ… **æ–¹æ¡ˆ2ï¼šé…ç½®ç†”æ–­æœºåˆ¶**

    public class CircuitBreakerEventDeduplicator : IFeishuEventDeduplicator
    {
        private readonly CircuitBreaker _circuitBreaker;
        private int _failureCount;
        private DateTime _lastFailureTime;
    
        public bool TryMarkAsProcessing(string eventId)
        {
            if (_circuitBreaker.IsOpen())
            {
                _logger.LogWarning("Rediså»é‡ç†”æ–­ï¼Œæ‹’ç»å¤„ç†");
                return true; // æ‹’ç»å¤„ç†ï¼Œä¿æŠ¤ä¸‹æ¸¸
            }
    
            try
            {
                var result = _redis.TryMarkAsProcessedAsync(eventId).GetAwaiter().GetResult();
                _circuitBreaker.RecordSuccess();
                return result;
            }
            catch (Exception ex)
            {
                _circuitBreaker.RecordFailure();
                throw;
            }
        }
    }
    

* * *

### é—®é¢˜ 5ï¼šç¼“å­˜è¶Šç§¯è¶Šå¤šï¼Œå†…å­˜å¿«çˆ†äº†

**ç°åœºæ˜¯è¿™æ ·çš„**ï¼š

    æœåŠ¡è¿è¡Œ24å°æ—¶
    å»é‡ç¼“å­˜æ¡ç›®ï¼š100ä¸‡+
    å†…å­˜å ç”¨ï¼šè¶…è¿‡500MB
    GCå‹åŠ›å¢å¤§ï¼Œæ€§èƒ½ä¸‹é™
    

**ä¸ºä»€ä¹ˆï¼Ÿ**

*   ğŸ“ˆ é«˜é¢‘äº‹ä»¶ï¼ˆæ¯”å¦‚æ¥æ”¶æ¶ˆæ¯ï¼‰ä¸€å¤©èƒ½äº§ç”Ÿå‡ åä¸‡æ¡è®°å½•
*   ğŸ• æ¸…ç†é—´éš”å¤ªé•¿ï¼Œæ—§è®°å½•å †ç§¯å¦‚å±±

**æ€ä¹ˆè§£å†³ï¼Ÿ**

âœ… **æ–¹æ¡ˆ1ï¼šç¼©çŸ­ç¼“å­˜è¿‡æœŸæ—¶é—´**

    services.AddFeishuWebSocketServiceBuilder(configuration)
        .ConfigureOptions(options =>
        {
            // æ ¹æ®å®é™…ä¸šåŠ¡è°ƒæ•´
            options.EventDeduplicationCacheExpirationMs = 3600000;  // ç¼©çŸ­ä¸º1å°æ—¶
            options.EventDeduplicationCleanupIntervalMs = 60000;    // æé«˜æ¸…ç†é¢‘ç‡ä¸º1åˆ†é’Ÿ
        });
    

âœ… **æ–¹æ¡ˆ2ï¼šä½¿ç”¨ LRU ç¼“å­˜**

    public class LRUEventDeduplicator : IFeishuEventDeduplicator
    {
        private readonly LRUCache<string, EventCacheEntry> _cache;
        private const int MaxCacheSize = 10000; // æœ€å¤šä¿ç•™1ä¸‡æ¡
    
        public LRUEventDeduplicator()
        {
            _cache = new LRUCache<string, EventCacheEntry>(MaxCacheSize);
        }
    
        public bool TryMarkAsProcessing(string eventId)
        {
            if (_cache.TryGetValue(eventId, out var entry))
                return true;
    
            _cache.Add(eventId, new EventCacheEntry { /* ... */ });
            return false;
        }
    }
    

âœ… **æ–¹æ¡ˆ3ï¼šä¸šåŠ¡å±‚ä¼˜åŒ–**

    // æŸäº›é«˜é¢‘äº‹ä»¶ä¸éœ€è¦å»é‡
    public class SystemEventHandler : DefaultFeishuEventHandler
    {
        // ä¸ç»§æ‰¿ IdempotentFeishuEventHandler
        // ç›´æ¥å¤„ç†ï¼Œå‡å°‘ä¸šåŠ¡å±‚å»é‡å‹åŠ›
    
        protected override Task ProcessBusinessLogicAsync(EventData eventData, CancellationToken ct)
        {
            // ä»…è®°å½•æ—¥å¿—ï¼Œä¸è¿›è¡Œä¸šåŠ¡æ“ä½œ
            _logger.LogInformation("ç³»ç»Ÿäº‹ä»¶ï¼š{EventType}", eventData.EventType);
            return Task.CompletedTask;
        }
    }
    

* * *

ç»™ç³»ç»Ÿåšä½“æ£€ï¼šç›‘æ§ä¸è°ƒè¯•
------------

### é‡‡é›†ä»€ä¹ˆæ•°æ®æœ€æœ‰æ•ˆï¼Ÿ

    public class DeduplicatorMetrics
    {
        public long TotalProcessed { get; set; }
        public long DuplicateSkipped { get; set; }
        public long ProcessingTimeout { get; set; }
        public long CacheHitCount { get; set; }
        public long CacheMissCount { get; set; }
    
        public double DuplicateRate => 
            TotalProcessed > 0 ? (double)DuplicateSkipped / TotalProcessed : 0;
    
        public double CacheHitRate =>
            (CacheHitCount + CacheMissCount) > 0 
                ? (double)CacheHitCount / (CacheHitCount + CacheMissCount) 
                : 0;
    }
    

### æš´éœ²ä¸€ä¸ªæ¥å£ï¼Œéšæ—¶æŸ¥çœ‹å¥åº·çŠ¶æ€

    [ApiController]
    [Route("api/[controller]")]
    public class DeduplicatorController : ControllerBase
    {
        private readonly IFeishuEventDeduplicator _deduplicator;
    
        [HttpGet("stats")]
        public ActionResult<DeduplicatorStats> GetStats()
        {
            return Ok(new DeduplicatorStats
            {
                CacheCount = _deduplicator.GetCacheCount(),
                MaxProcessedSeqId = _seqIdDeduplicator?.GetMaxProcessedSeqId(),
                DuplicateRate = _metrics.DuplicateRate,
                CacheHitRate = _metrics.CacheHitRate
            });
        }
    
        [HttpGet("check/{eventId}")]
        public ActionResult<bool> CheckEventId(string eventId)
        {
            var isProcessed = _deduplicator.IsProcessed(eventId);
            return Ok(new { eventId, isProcessed });
        }
    }
    

### æ—¥å¿—æ€ä¹ˆå†™æ‰å®¹æ˜“æ’æŸ¥é—®é¢˜ï¼Ÿ

    public class EnhancedEventDeduplicator : IFeishuEventDeduplicator
    {
        private readonly ILogger<EnhancedEventDeduplicator> _logger;
    
        public bool TryMarkAsProcessing(string eventId)
        {
            lock (_lock)
            {
                if (_eventCache.TryGetValue(eventId, out var entry))
                {
                    // è¯¦ç»†è®°å½•å»é‡å‘½ä¸­åŸå› 
                    _logger.LogInformation(
                        "[Deduplication] EventId={EventId} å·²å¤„ç†ï¼Œ" +
                        "Status={Status}, ProcessedAt={ProcessedAt}",
                        eventId,
                        entry.Status,
                        entry.ProcessedAt);
    
                    return true;
                }
    
                _logger.LogDebug("[Deduplication] EventId={EventId} æ–°äº‹ä»¶", eventId);
                // ...
                return false;
            }
        }
    }
    

* * *

å¿«é€Ÿå›é¡¾ä¸è¡ŒåŠ¨æ¸…å•
---------

### ä¸‰å±‚é˜²æŠ¤ä¸€è¡¨è§ˆ

å»é‡å±‚çº§

å»é‡ä¾æ®

å®ç°æ–¹å¼

æ¨èé…ç½®

**åè®®å±‚**

SeqID / Nonce

`IFeishuSeqIDDeduplicator` / `IFeishuNonceDistributedDeduplicator`

å§‹ç»ˆå¯ç”¨

**åˆ†å‘å±‚**

EventId

`IFeishuEventDeduplicator` / `IFeishuEventDistributedDeduplicator`

ç”Ÿäº§ç¯å¢ƒå¯ç”¨ Redis

**åº”ç”¨å±‚**

æ•°æ®å­˜åœ¨æ€§æ£€æŸ¥

`DefaultFeishuObjectEventHandler<T>` ä¸­çš„ä¸šåŠ¡é€»è¾‘

æŒ‰éœ€å®ç°

### è¿˜æƒ³äº†è§£æ›´å¤šï¼Ÿ

*   ğŸ“– [é£ä¹¦å®˜æ–¹æ–‡æ¡£ï¼šäº‹ä»¶è®¢é˜…](https://open.feishu.cn/document/server-docs/event-subscription-guide/overview)
*   ğŸ’» [MudFeishu GitHub ä»“åº“](https://github.com/mudtools/MudFeishu)
*   ğŸ’» [MudFeishu Gitee ä»“åº“](https://gitee.com/mudtools/MudFeishu)
*   ğŸ”’ [Redis åˆ†å¸ƒå¼é”æœ€ä½³å®è·µ](https://redis.io/topics/distlock)