---
layout: post
title: 'Rediså®æˆ˜ç»ˆææŒ‡å—ï¼šä»å®¢æˆ·ç«¯é›†æˆåˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ é¿å‘ã€ç¬¬å››éƒ¨åˆ†ã€‘'
date: "2025-11-09T00:45:38Z"
---
Rediså®æˆ˜ç»ˆææŒ‡å—ï¼šä»å®¢æˆ·ç«¯é›†æˆåˆ°æ€§èƒ½ä¼˜åŒ–ï¼Œæ‰‹æŠŠæ‰‹æ•™ä½ é¿å‘ã€ç¬¬å››éƒ¨åˆ†ã€‘
=====================================

ä¹¦æ¥ä¸Šç¯‡ï¼Œå·²ç»é™åˆ°äº†Redisä¸»ä»ã€å“¨å…µã€é›†ç¾¤ã€‚æœ¬ç¯‡ç»§ç»­æ·±å…¥Redisçš„æ ¸å¿ƒé‡ç‚¹åŠŸèƒ½çš„è®²è§£.è®©ä½ å¯¹Redisçš„ç†è§£ä¸æ­¢äºç¼“å­˜æ•°æ®...

å¼€ç¯‡ï¼šé‚£äº›å¹´è¸©è¿‡çš„Redisçº¿ä¸Šå‘
-----------------

å»å¹´åŒ11ï¼Œæœ‹å‹çš„å…¬å¸åšç§’æ€æ´»åŠ¨ï¼šåº“å­˜1000ä»¶å•†å“ï¼Œç»“æœå–å‡ºäº†5000å•â€”â€”**ç¼“å­˜é›ªå´©**å¯¼è‡´æ•°æ®åº“è¢«å‹å®ï¼Œåº“å­˜æ ¡éªŒå½¢åŒè™šè®¾ï¼›  
è¿˜æœ‰ä¸€æ¬¡ï¼Œç”¨æˆ·æŸ¥â€œä¸å­˜åœ¨çš„å•†å“è¯¦æƒ…â€ï¼Œæ¯ç§’1ä¸‡æ¬¡è¯·æ±‚ç›´æ¥æ‰“ç©¿æ•°æ®åº“ï¼ŒDB CPUé£™åˆ°100%ï¼Œç³»ç»Ÿå®•æœºåŠå°æ—¶â€¦â€¦

è¿™äº›é—®é¢˜ï¼Œ**ä¸æ˜¯ä¸æ‡‚Redisç†è®ºï¼Œè€Œæ˜¯ä¸ä¼šâ€œè½åœ°â€**ï¼š

*   è¿æ¥æ± é…ç½®é”™äº†ï¼Œå¯¼è‡´è¿æ¥æ³„æ¼ï¼›
*   ç¼“å­˜æ²¡åšé˜²ç©¿é€ï¼Œè¢«æ¶æ„è¯·æ±‚æå®DBï¼›
*   ç§’æ€ç”¨äº†æ™®é€šæ‰£åº“å­˜ï¼Œæ²¡ä¿è¯åŸå­æ€§ï¼Œè¶…å–ä¸¥é‡ã€‚

æœ¬æ–‡ç”¨ã€Œ**ä»£ç +å›¾+çœŸå®å‘ç‚¹**ã€ï¼ŒæŠŠRedisä»â€œç©å…·â€å˜æˆâ€œæ­¦å™¨â€â€”â€”**å­¦å®Œå°±èƒ½ç›´æ¥ç”¨åˆ°é¡¹ç›®é‡Œ**ï¼

ä¸€ã€ç¬¬10ç« ï¼šJavaä¸Rediså®¢æˆ·ç«¯é›†æˆ
----------------------

Redisæ˜¯Cå†™çš„ï¼ŒJavaè¦è¿å®ƒå¾—é å®¢æˆ·ç«¯ã€‚ä¸»æµé€‰æ‰‹æ˜¯**Lettuce**ï¼ˆSpring Boot 2.xé»˜è®¤ï¼Œå¼‚æ­¥éé˜»å¡ï¼‰å’Œ**Jedis**ï¼ˆç»å…¸åŒæ­¥ï¼Œé€‚åˆç®€å•åœºæ™¯ï¼‰ã€‚

### 1.1 å…ˆææ‡‚ï¼šRedisçš„3ç§éƒ¨ç½²æ¨¡å¼

è¿å®¢æˆ·ç«¯å‰ï¼Œå¿…é¡»æ˜ç¡®Redisçš„æ¶æ„â€”â€”è¿™å†³å®šäº†è¿æ¥æ–¹å¼ï¼š

*   **å•æœº**ï¼šå•èŠ‚ç‚¹ï¼Œé€‚åˆå¼€å‘/æµ‹è¯•ï¼›
*   **å“¨å…µï¼ˆSentinelï¼‰**ï¼šä¸»ä»+ç›‘æ§ï¼Œè‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆä¸»æŒ‚äº†ä»é¡¶ä¸Šï¼‰ï¼›
*   **é›†ç¾¤ï¼ˆClusterï¼‰**ï¼šåˆ†ç‰‡å­˜å‚¨ï¼Œé«˜å¯ç”¨+æ¨ªå‘æ‰©å®¹ï¼ˆæ•°æ®åˆ†æ•£åˆ°å¤šä¸ªèŠ‚ç‚¹ï¼‰ã€‚

### 1.2 Spring Booté›†æˆï¼šLettuce vs Jedis

#### ï¼ˆ1ï¼‰Lettuceï¼šå¼‚æ­¥éé˜»å¡ï¼ŒSpring Booté»˜è®¤

**ä¾èµ–**ï¼šä¸ç”¨é¢å¤–åŠ ï¼Œ`spring-boot-starter-data-redis`å·²åŒ…å«ã€‚

**é…ç½®æ–‡ä»¶ï¼ˆapplication.ymlï¼‰**ï¼š

    spring:
      redis:
        # å•æœºæ¨¡å¼ï¼ˆæ³¨é‡Šæ‰sentinel/clusterï¼‰
        host: localhost
        port: 6379
        password: "" # æ— å¯†ç ç•™ç©º
        
        # å“¨å…µæ¨¡å¼ï¼ˆç”¨è¿™ä¸ªè¦å»æ‰host/portï¼‰
        sentinel:
          master: mymaster # ä¸»èŠ‚ç‚¹åç§°
          nodes: 192.168.1.100:26379,192.168.1.101:26379 # Sentinelåœ°å€
        
        # é›†ç¾¤æ¨¡å¼ï¼ˆç”¨è¿™ä¸ªè¦å»æ‰host/port/sentinelï¼‰
        cluster:
          nodes: 192.168.1.103:6379,192.168.1.104:6379 # é›†ç¾¤èŠ‚ç‚¹
          max-redirects: 3 # æœ€å¤§é‡å®šå‘æ¬¡æ•°ï¼ˆæ‰¾ä¸åˆ°èŠ‚ç‚¹æ—¶é‡è¯•ï¼‰
        
        lettuce:
          pool:
            max-active: 8 # æœ€å¤§è¿æ¥æ•°ï¼ˆæ ¹æ®QPSè°ƒï¼Œæ¯”å¦‚1000QPSè®¾10~20ï¼‰
            max-idle: 8 # æœ€å¤§ç©ºé—²è¿æ¥ï¼ˆé¿å…é¢‘ç¹åˆ›å»ºï¼‰
            min-idle: 0 # æœ€å°ç©ºé—²è¿æ¥
            max-wait: -1ms # è¿æ¥ä¸è¶³æ—¶æ— é™ç­‰ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾1sï¼‰
    

**é…ç½®ç±»**ï¼ˆSpring Bootè‡ªåŠ¨é…ç½®å¥½äº†ï¼Œå¦‚éœ€è‡ªå®šä¹‰åºåˆ—åŒ–ï¼‰ï¼š

    @Configuration
    public class RedisConfig {
        @Bean
        public RedisTemplate<String, Object> redisTemplate(LettuceConnectionFactory factory) {
            RedisTemplate<String, Object> template = new RedisTemplate<>();
            template.setConnectionFactory(factory);
            // Keyç”¨Stringåºåˆ—åŒ–ï¼ŒValueç”¨JSONï¼ˆé¿å…ä¹±ç ï¼‰
            template.setKeySerializer(RedisSerializer.string());
            template.setValueSerializer(RedisSerializer.json());
            return template;
        }
    }
    

#### ï¼ˆ2ï¼‰Jedisï¼šåŒæ­¥é˜»å¡ï¼Œé€‚åˆç®€å•åœºæ™¯

**ä¾èµ–**ï¼šéœ€åŠ `jedis`å’Œ`spring-boot-starter-data-redis`ï¼š

    <dependency>
        <groupId>redis.clients</groupId>
        <artifactId>jedis</artifactId>
    </dependency>
    

**é…ç½®ç±»**ï¼ˆæ‰‹åŠ¨ç®¡ç†è¿æ¥æ± ï¼‰ï¼š

    @Configuration
    public class JedisConfig {
        @Bean
        public JedisPool jedisPool() {
            JedisPoolConfig poolConfig = new JedisPoolConfig();
            poolConfig.setMaxTotal(8); // æœ€å¤§è¿æ¥æ•°
            poolConfig.setMaxIdle(8); // æœ€å¤§ç©ºé—²
            poolConfig.setMinIdle(0); // æœ€å°ç©ºé—²
            poolConfig.setMaxWait(Duration.ofMillis(3000)); // è¿æ¥è¶…æ—¶3ç§’
            return new JedisPool(poolConfig, "localhost", 6379);
        }
    }
    

**å‘ç‚¹é¢„è­¦**ï¼š

*   **Jediså¿…é¡»close()**ï¼šç”¨`try-with-resources`æˆ–æ‰‹åŠ¨`close()`ï¼Œå¦åˆ™è¿æ¥æ³„æ¼ï¼Œæœ€ç»ˆOOMï¼  
    æ­£ç¡®ç”¨æ³•ï¼š
    
        try (Jedis jedis = jedisPool.getResource()) {
            jedis.set("key", "value");
        } // è‡ªåŠ¨å½’è¿˜è¿æ¥
        
    

### 1.3 è¿æ¥æ± æœ€ä½³å®è·µï¼ˆé¿å‘ï¼ï¼‰

1.  **å‚æ•°åˆ«ä¹±è®¾**ï¼š`max-active`å¤ªå°ä¼šæŠ¥â€œæ— æ³•è·å–è¿æ¥â€ï¼›å¤ªå¤§æµªè´¹èµ„æºï¼ˆå»ºè®®è®¾ä¸ºQPSçš„10%~20%ï¼‰ï¼›
2.  **Lettuceçº¿ç¨‹å®‰å…¨**ï¼š`RedisConnection`æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†è‡ªå®šä¹‰`Connection`è¦æ³¨æ„éš”ç¦»ï¼›
3.  **å“¨å…µ/é›†ç¾¤é…ç½®**ï¼šç¡®ä¿`nodes`åœ°å€æ­£ç¡®ï¼ŒSentinelè¦è¿å¯¹ä¸»èŠ‚ç‚¹åç§°ã€‚

äºŒã€ç¬¬11ç« ï¼šRediså…¸å‹åº”ç”¨åœºæ™¯ä¸å®æˆ˜
---------------------

è¿™éƒ¨åˆ†æ˜¯**Redisçš„â€œçµé­‚â€**â€”â€”è§£å†³çœŸå®ä¸šåŠ¡é—®é¢˜ã€‚

### 2.1 ç¼“å­˜é—®é¢˜ï¼šç©¿é€ã€å‡»ç©¿ã€é›ªå´©ï¼Œä¸€æ¬¡æ€§æ ¹æ²»

ç¼“å­˜çš„æ ¸å¿ƒçŸ›ç›¾ï¼š**ç¼“å­˜ä¸æ•°æ®åº“çš„ä¸€è‡´æ€§**ï¼Œä½†è¿™ä¸‰ä¸ªé—®é¢˜æ˜¯â€œç¼“å­˜å¤±æ•ˆå¯¼è‡´DBå‹åŠ›çˆ†ç‚¸â€ã€‚

å…ˆçœ‹**ç¼“å­˜ä¸‰å¤§é—®é¢˜å…¨æ™¯å›¾**ï¼š

#### ï¼ˆ1ï¼‰ç¼“å­˜ç©¿é€ï¼šæŸ¥ä¸å­˜åœ¨çš„keyï¼Œæ‰“ç©¿DB

*   **æˆå› **ï¼šè¯·æ±‚æŸ¥â€œæ•°æ®åº“å’Œç¼“å­˜éƒ½æ²¡æœ‰çš„keyâ€ï¼ˆæ¯”å¦‚æ¶æ„æ”»å‡»æŸ¥`user:-1`ï¼‰ï¼Œæ¯æ¬¡éƒ½æ‰“DBã€‚
*   **è§£å†³æ–¹æ¡ˆ**ï¼š
    1.  **ç©ºå€¼ç¼“å­˜**ï¼šæŠŠâ€œä¸å­˜åœ¨â€çš„ç»“æœä¹Ÿç¼“å­˜ï¼ˆæ¯”å¦‚`set user:-1 "null"`ï¼Œè¿‡æœŸ5åˆ†é’Ÿï¼‰ï¼›
    2.  **å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰**ï¼šæå‰æŠŠæ‰€æœ‰å­˜åœ¨çš„keyå­˜åˆ°è¿‡æ»¤å™¨ï¼ŒæŸ¥è¯¢å‰å…ˆæŸ¥ï¼Œä¸å­˜åœ¨ç›´æ¥è¿”å›ã€‚

**å¸ƒéš†è¿‡æ»¤å™¨ä»£ç ç¤ºä¾‹**ï¼š

    // åˆå§‹åŒ–ï¼šé¢„è®¡100ä¸‡å…ƒç´ ï¼Œè¯¯åˆ¤ç‡0.01%
    BloomFilter<Long> bloomFilter = BloomFilter.create(
        Funnels.longFunnel(), 
        1000000, 
        0.0001
    );
    
    // å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰å­˜åœ¨çš„keyï¼ˆæ¯”å¦‚ä»æ•°æ®åº“æŸ¥æ‰€æœ‰ç”¨æˆ·IDï¼‰
    List<Long> userIds = userRepository.findAllIds();
    userIds.forEach(bloomFilter::put);
    
    // æŸ¥è¯¢æ—¶å…ˆè¿‡è¿‡æ»¤å™¨
    public User getUserById(Long userId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­ï¼šè‚¯å®šä¸å­˜åœ¨â†’ç›´æ¥è¿”å›
        if (!bloomFilter.mightContain(userId)) return null;
        // 2. æŸ¥ç¼“å­˜
        String key = "user:" + userId;
        User user = redisTemplate.opsForValue().get(key);
        if (user != null) return user;
        // 3. æŸ¥æ•°æ®åº“
        user = userRepository.findById(userId).orElse(null);
        if (user == null) {
            // ç©ºå€¼ç¼“å­˜ï¼Œé˜²æ­¢ä¸‹æ¬¡å†æŸ¥
            redisTemplate.opsForValue().set(key, "null", 5, TimeUnit.MINUTES);
            return null;
        }
        // 4. å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, user, 10, TimeUnit.MINUTES);
        return user;
    }
    

#### ï¼ˆ2ï¼‰ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹keyè¿‡æœŸï¼Œç¬é—´æ‰“ç©¿DB

*   **æˆå› **ï¼šæŸä¸ª**è¶…çº§çƒ­ç‚¹key**ï¼ˆæ¯”å¦‚çˆ†æ¬¾å•†å“åº“å­˜ï¼‰è¿‡æœŸç¬é—´ï¼Œå¤§é‡è¯·æ±‚åŒæ—¶æ‰“DBã€‚
*   **è§£å†³æ–¹æ¡ˆ**ï¼š
    1.  **é€»è¾‘è¿‡æœŸ**ï¼šä¸è®¾ç‰©ç†è¿‡æœŸæ—¶é—´ï¼ŒæŠŠè¿‡æœŸæ—¶é—´å­˜åˆ°valueé‡Œï¼ˆæ¯”å¦‚`{"value":"åº“å­˜100","expire":1620000000}`ï¼‰ï¼ŒæŸ¥è¯¢æ—¶æ£€æŸ¥è¿‡æœŸï¼Œè¿‡æœŸåˆ™å¼‚æ­¥æ›´æ–°ï¼›
    2.  **äº’æ–¥é”**ï¼šè·å–keyæ—¶åŠ é”ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æŸ¥DBï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ã€‚

**äº’æ–¥é”ä»£ç ç¤ºä¾‹ï¼ˆSET NX PXï¼‰**ï¼š

    public Integer getStock(String productId) {
        String key = "stock:" + productId;
        // 1. æŸ¥ç¼“å­˜
        Integer stock = redisTemplate.opsForValue().get(key);
        if (stock != null) return stock;
        // 2. åŠ äº’æ–¥é”ï¼ˆé”key=lock:stock:productIdï¼Œè¿‡æœŸ30ç§’ï¼‰
        String lockKey = "lock:stock:" + productId;
        Boolean lockResult = redisTemplate.opsForValue().setIfAbsent(
            lockKey, "1", 30, TimeUnit.SECONDS
        );
        if (lockResult) {
            try {
                // 3. å†æ¬¡æŸ¥ç¼“å­˜ï¼ˆé˜²æ­¢ç­‰å¾…æ—¶å…¶ä»–çº¿ç¨‹å·²æ›´æ–°ï¼‰
                stock = redisTemplate.opsForValue().get(key);
                if (stock != null) return stock;
                // 4. æŸ¥æ•°æ®åº“
                stock = productRepository.getStockById(productId);
                // 5. å†™å…¥ç¼“å­˜ï¼ˆé€»è¾‘è¿‡æœŸï¼š1å°æ—¶+éšæœº0~30åˆ†é’Ÿï¼‰
                int baseExpire = 3600;
                int randomExpire = new Random().nextInt(1800);
                redisTemplate.opsForValue().set(key, stock, baseExpire + randomExpire, TimeUnit.SECONDS);
                return stock;
            } finally {
                // 6. é‡Šæ”¾é”ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼ˆé¿å…åˆ é”™åˆ«äººçš„é”ï¼‰
                String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) end";
                redisTemplate.execute(
                    new DefaultRedisScript<>(script, Long.class), 
                    Collections.singletonList(lockKey), "1"
                );
            }
        } else {
            // æ‹¿ä¸åˆ°é”ï¼Œé‡è¯•æˆ–è¿”å›é™çº§
            return -1;
        }
    }
    

#### ï¼ˆ3ï¼‰ç¼“å­˜é›ªå´©ï¼šå¤§é‡keyåŒæ—¶è¿‡æœŸï¼ŒDBå´©æºƒ

*   **æˆå› **ï¼šä¸€æ‰¹keyçš„**ç‰©ç†è¿‡æœŸæ—¶é—´ç›¸åŒ**ï¼ˆæ¯”å¦‚éƒ½è®¾ä¸º1å°æ—¶ï¼‰ï¼Œåˆ°æœŸç¬é—´å¤§é‡è¯·æ±‚æ‰“DBã€‚
*   **è§£å†³æ–¹æ¡ˆ**ï¼š
    1.  **éšæœºè¿‡æœŸæ—¶é—´**ï¼šåŸºç¡€è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼ï¼ˆæ¯”å¦‚`1å°æ—¶+0~30åˆ†é’Ÿ`ï¼‰ï¼›
    2.  **åˆ†çº§ç¼“å­˜**ï¼šæœ¬åœ°Caffeine+Redisï¼Œç¬¬ä¸€å±‚è¿‡æœŸæ—¶é—´é•¿ï¼Œç¬¬äºŒå±‚çŸ­ï¼›
    3.  **ç†”æ–­é™çº§**ï¼šç”¨Sentinel/Hystrixï¼ŒDBå‹åŠ›å¤§æ—¶ç›´æ¥è¿”å›é™çº§æ•°æ®ã€‚

**éšæœºè¿‡æœŸæ—¶é—´ä»£ç **ï¼š

    // è®¾ç½®åº“å­˜ç¼“å­˜ï¼š1å°æ—¶+éšæœº0~30åˆ†é’Ÿ
    int baseExpire = 3600;
    int randomExpire = new Random().nextInt(1800);
    redisTemplate.opsForValue().set("stock:123", 100, baseExpire + randomExpire, TimeUnit.SECONDS);
    

### 2.2 åˆ†å¸ƒå¼é”ï¼šåˆ«å†ç”¨SETNXä¹±æäº†ï¼

åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒï¼š**äº’æ–¥ã€é˜²æ­»é”ã€å®¹é”™**ã€‚å¾ˆå¤šäººç”¨SETNXè¸©å‘ï¼š

#### ï¼ˆ1ï¼‰SETNXçš„è‡´å‘½ç¼ºé™·ï¼šæ­»é”+è¯¯åˆ 

**é”™è¯¯ç¤ºä¾‹**ï¼š

    // 1. åŠ é”ï¼ˆæ²¡è®¾è¿‡æœŸæ—¶é—´â†’çº¿ç¨‹æŒ‚äº†ï¼Œé”æ°¸è¿œåœ¨ï¼‰
    Boolean lock = redisTemplate.opsForValue().setIfAbsent("lock:order", "1");
    if (lock) {
        try {
            // æ‰§è¡Œä¸šåŠ¡
        } finally {
            // 2. ç›´æ¥åˆ é”â†’å¦‚æœä¸šåŠ¡è¶…æ—¶ï¼Œé”è¿‡æœŸäº†ï¼Œåˆ çš„æ˜¯åˆ«äººçš„é”ï¼
            redisTemplate.delete("lock:order");
        }
    }
    

**é—®é¢˜**ï¼š

*   æ²¡è®¾è¿‡æœŸæ—¶é—´â†’æ­»é”ï¼›
*   ä¸šåŠ¡è¶…æ—¶â†’è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”ã€‚

#### ï¼ˆ2ï¼‰æ­£ç¡®å§¿åŠ¿ï¼šSET ... NX PX + Luaè„šæœ¬

Redis 2.6+æ”¯æŒ`SET key value NX PX milliseconds`ï¼ˆäº’æ–¥+è‡ªåŠ¨è¿‡æœŸï¼‰ï¼Œé‡Šæ”¾é”ç”¨**Luaè„šæœ¬**ä¿è¯åŸå­æ€§ï¼ˆæ£€æŸ¥é”çš„ownerå†åˆ é™¤ï¼‰ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    public void createOrder(String orderId) {
        String lockKey = "lock:order:" + orderId;
        String owner = UUID.randomUUID().toString(); // å”¯ä¸€ownerï¼Œé¿å…è¯¯åˆ 
        long expireTime = 30000; // 30ç§’è¿‡æœŸ
        
        // 1. åŠ é”
        Boolean lockResult = redisTemplate.opsForValue().setIfAbsent(
            lockKey, owner, expireTime, TimeUnit.MILLISECONDS
        );
        if (lockResult) {
            try {
                // æ‰§è¡Œä¸šåŠ¡ï¼ˆæ¯”å¦‚åˆ›å»ºè®¢å•ï¼‰
                orderService.create(orderId);
            } finally {
                // 2. é‡Šæ”¾é”ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§
                String script = "if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) end";
                redisTemplate.execute(
                    new DefaultRedisScript<>(script, Long.class), 
                    Collections.singletonList(lockKey), owner
                );
            }
        } else {
            throw new RuntimeException("é‡å¤è¯·æ±‚ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
    

**å…³é”®ç‚¹**ï¼š

*   `owner`ç”¨UUIDï¼šé¿å…ä¸åŒçº¿ç¨‹çš„é”äº’ç›¸è¯¯åˆ ï¼›
*   Luaè„šæœ¬ï¼šä¿è¯â€œæ£€æŸ¥ownerâ€å’Œâ€œåˆ é”â€æ˜¯åŸå­æ“ä½œã€‚

#### ï¼ˆ3ï¼‰Redlockç®—æ³•ï¼šäº‰è®®ä¸é€‚ç”¨åœºæ™¯

Redlockæ˜¯**å¤šRediså®ä¾‹çš„åˆ†å¸ƒå¼é”**ï¼Œéœ€è¦è·å–å¤šæ•°å®ä¾‹çš„é”æ‰ç®—æˆåŠŸã€‚

*   **äº‰è®®**ï¼šè‹¥Rediså®ä¾‹æ—¶é’Ÿæ¼‚ç§»ï¼Œå¯èƒ½å¯¼è‡´é”å¤±æ•ˆï¼›
*   **é€‚ç”¨åœºæ™¯**ï¼šå¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜çš„åœºæ™¯ï¼ˆæ¯”å¦‚é‡‘èäº¤æ˜“ï¼‰ï¼Œå¦åˆ™å•å®ä¾‹é”è¶³å¤Ÿã€‚

### 2.3 ç§’æ€ç³»ç»Ÿï¼šRedisåŸå­æ“ä½œæ˜¯æ ¸å¿ƒ

ç§’æ€çš„æœ¬è´¨ï¼š**é«˜å¹¶å‘ä¸‹çš„åº“å­˜æ‰£å‡**ï¼Œå¿…é¡»ç”¨åŸå­æ“ä½œé¿å…è¶…å–ã€‚

#### ï¼ˆ1ï¼‰åŸå­æ‰£å‡ï¼šDECRå‘½ä»¤

Redisçš„`DECR`æ˜¯åŸå­æ“ä½œï¼Œæ‰£å‡åè¿”å›å‰©ä½™åº“å­˜ï¼Œç›´æ¥åˆ¤æ–­æ˜¯å¦â‰¥0ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    public boolean seckill(String productId, int quantity) {
        String stockKey = "stock:seckill:" + productId;
        // 1. åŸå­æ‰£å‡åº“å­˜
        Long remaining = redisTemplate.opsForValue().decrement(stockKey, quantity);
        if (remaining != null) {
            if (remaining >= 0) {
                // æ‰£å‡æˆåŠŸï¼Œå¼‚æ­¥å‘MQå¤„ç†è®¢å•
                sendOrderMessage(productId, quantity);
                return true;
            } else {
                // è¶…å–å›æ»š
                redisTemplate.opsForValue().increment(stockKey, quantity);
                return false;
            }
        }
        return false;
    }
    

#### ï¼ˆ2ï¼‰ä¼˜åŒ–ï¼šLuaè„šæœ¬å°è£…â€œæ‰£åº“å­˜+å†™æ—¥å¿—â€

åˆ†ä¸¤æ¬¡æ“ä½œä¼šä¸ä¸€è‡´ï¼ˆæ‰£äº†åº“å­˜ä½†æ—¥å¿—æ²¡å†™ï¼‰ï¼Œ**Luaè„šæœ¬ä¿è¯åŸå­æ€§**ï¼š

**å®Œæ•´ç§’æ€Luaè„šæœ¬ï¼ˆå¸¦é›†ç¾¤å…¼å®¹ï¼‰**ï¼š

    -- å‚æ•°è¯´æ˜ï¼ˆä¸¥æ ¼åŒºåˆ† KEYS å’Œ ARGVï¼ï¼‰
    -- KEYS[1]: åº“å­˜é”®ï¼ˆå¦‚ stock:{seckill}:123 â†’ é›†ç¾¤ä¸‹ç”¨å“ˆå¸Œæ ‡ç­¾ä¿è¯åŒä¸€Slotï¼‰
    -- KEYS[2]: ç§’æ€æ—¥å¿—é”®ï¼ˆå¦‚ seckill:log:{seckill}:123ï¼‰
    -- ARGV[1]: æ‰£å‡æ•°é‡ï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚"2"ï¼‰
    -- ARGV[2]: å•†å“IDï¼ˆå­—ç¬¦ä¸²ï¼Œå¦‚"123"ï¼‰
    
    -- 1. åŸå­æ‰£å‡åº“å­˜
    local remaining = redis.call('DECRBY', KEYS[1], ARGV[1])
    -- 2. åº“å­˜ä¸è¶³â†’å›æ»š+è¿”å›å¤±è´¥
    if remaining < 0 then
        redis.call('INCRBY', KEYS[1], ARGV[1])
        return 0
    end
    
    -- 3. åº“å­˜å……è¶³â†’è®°å½•æ—¥å¿—ï¼ˆZSETå­˜è®¢å•ï¼Œåˆ†æ•°=æ—¶é—´æˆ³ï¼‰
    local orderId = string.format("order:%s:%d", ARGV[2], redis.call('TIME')[1])
    local score = tonumber(redis.call('TIME')[1])
    redis.call('ZADD', KEYS[2], score, orderId)
    -- 4. æ—¥å¿—è®¾è¿‡æœŸæ—¶é—´ï¼ˆä¿ç•™1å°æ—¶ï¼‰
    redis.call('EXPIRE', KEYS[2], 3600)
    
    -- 5. è¿”å›æˆåŠŸ
    return 1
    

**å…³é”®è¯´æ˜ï¼šKEYSä¸ARGVçš„åŒºåˆ«**

*   **KEYSæ•°ç»„**ï¼šä¼ é€’**è¦æ“ä½œçš„Redisé”®**ï¼Œé›†ç¾¤ä¸‹å¿…é¡»åŒä¸€Slotï¼ˆç”¨å“ˆå¸Œæ ‡ç­¾ï¼Œæ¯”å¦‚`{seckill}:123`ï¼‰ï¼›
*   **ARGVæ•°ç»„**ï¼šä¼ é€’**éé”®çš„ä¸šåŠ¡å‚æ•°**ï¼Œæ— éœ€é›†ç¾¤æ£€æŸ¥ï¼Œä½†éœ€æ‰‹åŠ¨è½¬æ¢ç±»å‹ï¼ˆæ¯”å¦‚`tonumber(ARGV[1])`ï¼‰ã€‚

**Javaè°ƒç”¨è„šæœ¬ç¤ºä¾‹**ï¼š

    // 1. å®šä¹‰Luaè„šæœ¬
    String seckillScript = "..."; // ä¸Šé¢çš„è„šæœ¬å†…å®¹
    DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>(seckillScript, Long.class);
    
    // 2. å‡†å¤‡å‚æ•°ï¼šKEYSï¼ˆå¸¦å“ˆå¸Œæ ‡ç­¾ï¼‰ + ARGVï¼ˆæ‰£å‡æ•°é‡+å•†å“IDï¼‰
    List<String> keys = Arrays.asList("stock:{seckill}:123", "seckill:log:{seckill}:123");
    Object[] args = new Object[]{"2", "123"};
    
    // 3. æ‰§è¡Œè„šæœ¬
    Long result = redisTemplate.execute(redisScript, keys, args);
    
    // 4. å¤„ç†ç»“æœ
    if (result == 1) {
        sendOrderMessage("123", 2); // å¼‚æ­¥å‘è®¢å•æ¶ˆæ¯
        return "ç§’æ€æˆåŠŸï¼";
    } else {
        return "åº“å­˜ä¸è¶³ï¼";
    }
    

### 2.4 é™æµï¼šæ»‘åŠ¨çª—å£æ¯”å›ºå®šçª—å£æ›´å‡†

é™æµçš„æ ¸å¿ƒï¼š**æ§åˆ¶å•ä½æ—¶é—´å†…çš„è¯·æ±‚é‡**ï¼Œæ»‘åŠ¨çª—å£æ›´å‡†ç¡®ï¼ˆé¿å…å›ºå®šçª—å£çš„â€œè¾¹ç•Œçªåˆºâ€ï¼‰ã€‚

**æ»‘åŠ¨çª—å£Luaè„šæœ¬ï¼ˆZSETå®ç°ï¼‰**ï¼š

    -- å‚æ•°ï¼š
    -- KEYS[1]: é™æµkeyï¼ˆå¦‚ rate_limit:user:123ï¼‰
    -- ARGV[1]: å½“å‰æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
    -- ARGV[2]: çª—å£å¤§å°ï¼ˆæ¯«ç§’ï¼Œå¦‚60000=1åˆ†é’Ÿï¼‰
    -- ARGV[3]: é˜ˆå€¼ï¼ˆå¦‚100=1åˆ†é’Ÿæœ€å¤š100æ¬¡ï¼‰
    
    -- 1. åˆ é™¤çª—å£å¤–çš„æ—§è¯·æ±‚
    redis.call('ZREMRANGEBYSCORE', KEYS[1], 0, tonumber(ARGV[1]) - tonumber(ARGV[2]))
    -- 2. è®¡ç®—çª—å£å†…è¯·æ±‚æ•°
    local count = redis.call('ZCARD', KEYS[1])
    -- 3. æœªè¶…é˜ˆå€¼â†’æ·»åŠ è¯·æ±‚+è®¾ç½®è¿‡æœŸæ—¶é—´
    if count < tonumber(ARGV[3]) then
        redis.call('ZADD', KEYS[1], tonumber(ARGV[1]), tonumber(ARGV[1]))
        redis.call('EXPIRE', KEYS[1], (tonumber(ARGV[2])/1000)+1)
        return 1 -- å…è®¸
    else
        return 0 -- æ‹’ç»
    end
    

**Javaè°ƒç”¨**ï¼š

    public boolean rateLimit(String userId) {
        String key = "rate_limit:user:" + userId;
        long now = System.currentTimeMillis();
        long window = 60000; // 1åˆ†é’Ÿ
        long limit = 100; // 1åˆ†é’Ÿæœ€å¤š100æ¬¡
        return redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            now, window, limit
        ) == 1;
    }
    

ä¸‰ã€ç¬¬12ç« ï¼šRedisè¿ç»´ä¸æ€§èƒ½ä¼˜åŒ–
-------------------

Redisçš„è¿ç»´é‡ç‚¹æ˜¯**â€œç›‘æ§+è°ƒä¼˜â€**ï¼Œé¿å…çº¿ä¸Šæ•…éšœã€‚

### 3.1 å¸¸ç”¨è¿ç»´å‘½ä»¤ï¼šæŸ¥çŠ¶æ€ã€æ‰¾é—®é¢˜

è®°ä¸‰ä¸ªæ ¸å¿ƒå‘½ä»¤ï¼š`INFO`ã€`MONITOR`ã€`SLOWLOG`ã€‚

#### ï¼ˆ1ï¼‰INFOï¼šæŸ¥Redisæ•´ä½“çŠ¶æ€

`INFO`æ˜¯æœ€å¸¸ç”¨çš„ç›‘æ§å‘½ä»¤ï¼Œé‡ç‚¹çœ‹è¿™å‡ ä¸ªæŒ‡æ ‡ï¼š

*   `INFO MEMORY`ï¼šå†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆ`used_memory_rss`ç‰©ç†å†…å­˜ã€`mem_fragmentation_ratio`ç¢ç‰‡ç‡ï¼‰ï¼›
*   `INFO STATS`ï¼šè¯·æ±‚é‡ã€è¿æ¥æ•°ï¼ˆ`instantaneous_ops_per_sec`æ¯ç§’è¯·æ±‚æ•°ã€`rejected_connections`æ‹’ç»è¿æ¥æ•°ï¼‰ï¼›
*   `INFO PERSISTENCE`ï¼šæŒä¹…åŒ–çŠ¶æ€ï¼ˆ`rdb_last_save_time`ä¸Šæ¬¡RDBä¿å­˜æ—¶é—´ï¼‰ã€‚

**ç¤ºä¾‹è¾“å‡º**ï¼š

    # Memory
    used_memory: 1024000
    used_memory_rss: 1200000
    mem_fragmentation_ratio: 1.17 # ç¢ç‰‡ç‡>1.5éœ€æ•´ç†
    maxmemory_policy: volatile-lru # æ·˜æ±°ç­–ç•¥ï¼ˆå»ºè®®è®¾è¿™ä¸ªï¼‰
    

#### ï¼ˆ2ï¼‰MONITORï¼šçœ‹å®æ—¶å‘½ä»¤ï¼ˆæ…ç”¨ï¼ï¼‰

`MONITOR`ä¼šæ‰“å°æ‰€æœ‰å®æ—¶å‘½ä»¤ï¼Œ**å½±å“æ€§èƒ½**ï¼Œä½†èƒ½å¿«é€Ÿå®šä½æ…¢æŸ¥è¯¢æˆ–å¼‚å¸¸è¯·æ±‚ã€‚

**ç¤ºä¾‹è¾“å‡º**ï¼š

    1620000000.123456 [0 127.0.0.1:12345] "GET" "user:123"
    1620000000.234567 [0 127.0.0.1:12346] "KEYS" "*" # å±é™©å‘½ä»¤ï¼
    

#### ï¼ˆ3ï¼‰SLOWLOGï¼šæ‰¾æ…¢æŸ¥è¯¢

`SLOWLOG`è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡`slowlog-log-slower-than`ï¼ˆé»˜è®¤10msï¼‰çš„å‘½ä»¤ã€‚

**æŸ¥çœ‹æ…¢æŸ¥è¯¢**ï¼š

    SLOWLOG GET # æŸ¥çœ‹æ‰€æœ‰æ…¢æŸ¥è¯¢
    SLOWLOG GET 1 # æŸ¥çœ‹æœ€è¿‘1æ¡
    

**ç¤ºä¾‹è¾“å‡º**ï¼š

    1) 1) (integer) 14 # æ…¢æŸ¥è¯¢ID
       2) (integer) 1700000000 # æ—¶é—´æˆ³
       3) (integer) 100 # æ‰§è¡Œæ—¶é—´ï¼ˆå¾®ç§’ï¼‰
       4) 1) "KEYS" # å±é™©å‘½ä»¤
          2) "*"
    

**ä¼˜åŒ–æ…¢æŸ¥è¯¢**ï¼š

*   ç¦æ­¢`KEYS *`â†’æ”¹ç”¨`SCAN`ï¼›
*   é¿å…`HGETALL`â†’æ”¹ç”¨`HMGET`å–æŒ‡å®šå­—æ®µï¼›
*   ç”¨ç´¢å¼•ä»£æ›¿`LIKE`â†’æ¯”å¦‚ZSETå­˜ç”¨æˆ·åï¼Œç”¨`ZRANGEBYLEX`æœç´¢ã€‚

### 3.2 å†…å­˜ä¼˜åŒ–ï¼šçœå†…å­˜=çœé’±

Rediså†…å­˜ä¼˜åŒ–çš„æ ¸å¿ƒï¼š**ç”¨å¯¹æ•°æ®ç»“æ„+å‡å°‘ç¢ç‰‡**ã€‚

#### ï¼ˆ1ï¼‰é€‰å¯¹æ•°æ®ç»“æ„ï¼šå°‘ç”¨Stringå­˜å¤æ‚æ•°æ®

æ¯”å¦‚å­˜ç”¨æˆ·å±æ€§ï¼š

*   **é”™è¯¯**ï¼š`set user:123 "{\"name\":\"å¼ ä¸‰\",\"age\":18}"`ï¼ˆStringå­˜JSONï¼Œå 100å­—èŠ‚ï¼‰ï¼›
*   **æ­£ç¡®**ï¼š`hset user:123 name å¼ ä¸‰ age 18`ï¼ˆHashï¼Œå 50å­—èŠ‚ï¼Œå‹ç¼©å­˜å‚¨ï¼‰ã€‚

#### ï¼ˆ2ï¼‰ç¢ç‰‡æ•´ç†ï¼šè§£å†³ç¢ç‰‡ç‡é«˜çš„é—®é¢˜

ç¢ç‰‡ç‡é«˜ï¼ˆ`mem_fragmentation_ratio > 1.5`ï¼‰çš„åŸå› æ˜¯é¢‘ç¹ä¿®æ”¹keyå¯¼è‡´å†…å­˜åˆ†é…/é‡Šæ”¾ã€‚

**è§£å†³æ–¹æ³•**ï¼š

*   Redis 4.0+ï¼š`MEMORY PURGE`ï¼ˆéœ€å¼€`activedefrag yes`ï¼‰ï¼›
*   ä½äº4.0ï¼šé‡å¯Redisï¼ˆå…ˆå¤‡ä»½ï¼‰ï¼›
*   è°ƒæ•´`maxmemory-policy`ä¸º`volatile-lru`ï¼Œè‡ªåŠ¨æ·˜æ±°è¿‡æœŸkeyã€‚

#### ï¼ˆ3ï¼‰é¿å…å†…å­˜æ³„æ¼ï¼šåŠæ—¶åˆ æ— ç”¨key

ç”¨`EXPIRE`è®¾è¿‡æœŸæ—¶é—´ï¼Œæˆ–å®šæœŸæ¸…ç†ï¼ˆæ¯”å¦‚`SCAN`éå†`user:*`ï¼Œåˆ é™¤30å¤©æœªç™»å½•çš„ç”¨æˆ·ï¼‰ã€‚

### 3.3 æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼šç”¨redis-benchmarkæµ‹QPS

`redis-benchmark`æ˜¯Redisè‡ªå¸¦çš„æ€§èƒ½æµ‹è¯•å·¥å…·ï¼Œæµ‹QPSã€å»¶è¿Ÿç­‰ã€‚

**å¸¸ç”¨å‚æ•°**ï¼š

*   `-h`ï¼šRedisåœ°å€ï¼›
*   `-p`ï¼šç«¯å£ï¼›
*   `-c`ï¼šå¹¶å‘æ•°ï¼›
*   `-n`ï¼šæ€»è¯·æ±‚æ•°ï¼›
*   `-t`ï¼šæµ‹è¯•å‘½ä»¤ï¼ˆå¦‚`-t set,get`ï¼‰ã€‚

**ç¤ºä¾‹ï¼šæµ‹å•èŠ‚ç‚¹SET QPS**ï¼š

    redis-benchmark -h localhost -p 6379 -c 100 -n 100000 -t set
    

**ç¤ºä¾‹è¾“å‡º**ï¼š

    ====== SET ======
      100000 requests completed in 0.1 seconds
      throughput: 1000000 requests per second # QPS 100ä¸‡
    

### 3.4 å¸¸è§é—®é¢˜æ’æŸ¥ï¼šæŒ‰å›¾ç´¢éª¥

é‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼ŒæŒ‰ä¸‹é¢çš„æ­¥éª¤æŸ¥ï¼š

é—®é¢˜

æ’æŸ¥æ­¥éª¤

å»¶è¿Ÿé«˜

1\. ç”¨`SLOWLOG`æ‰¾æ…¢æŸ¥è¯¢ï¼›2. çœ‹`INFO STATS`çš„`instantaneous_ops_per_sec`ï¼›3. æ£€æŸ¥ç½‘ç»œå»¶è¿Ÿ

å†…å­˜ä¸è¶³

1\. çœ‹`INFO MEMORY`çš„`used_memory_rss`ï¼›2. æ£€æŸ¥ç¢ç‰‡ç‡ï¼›3. æ¸…ç†æ— ç”¨key

CPUè¿‡é«˜

1\. ç”¨`TOP`çœ‹Redisè¿›ç¨‹CPUï¼›2. æ£€æŸ¥æ˜¯å¦æœ‰å¤§é‡è®¡ç®—ï¼ˆæ¯”å¦‚Luaè„šæœ¬ï¼‰ï¼›3. çœ‹`MONITOR`çš„å¼‚å¸¸è¯·æ±‚

è¿æ¥å¤±è´¥

1\. çœ‹`INFO STATS`çš„`rejected_connections`ï¼›2. æ£€æŸ¥è¿æ¥æ± å‚æ•°ï¼›3. çœ‹Sentinel/é›†ç¾¤çŠ¶æ€

ç»“å°¾ï¼šRediså®æˆ˜çš„æ ¸å¿ƒé€»è¾‘
---------------

Redisä¸æ˜¯â€œç¼“å­˜æ•°æ®åº“â€é‚£ä¹ˆç®€å•ï¼Œå®ƒæ˜¯**è§£å†³é«˜å¹¶å‘ã€æ•°æ®ä¸€è‡´æ€§çš„åˆ©å™¨**ï¼š

*   å®¢æˆ·ç«¯é›†æˆï¼šæ‡‚è¿æ¥æ± ï¼Œé¿å…æ³„æ¼ï¼›
*   å…¸å‹åœºæ™¯ï¼šç¼“å­˜é˜²ç©¿é€/å‡»ç©¿/é›ªå´©ï¼Œåˆ†å¸ƒå¼é”ç”¨SET NX PXï¼Œç§’æ€ç”¨Luaè„šæœ¬ï¼›
*   è¿ç»´ä¼˜åŒ–ï¼šä¼šç›‘æ§ï¼ˆINFO/MONITOR/SLOWLOGï¼‰ï¼Œä¼šè°ƒä¼˜ï¼ˆå†…å­˜/ç¢ç‰‡/QPSï¼‰ã€‚

æœ€åé€ä½ ä¸€å¥è¯ï¼š**Redisçš„å‘ï¼Œéƒ½æ˜¯â€œæƒ³å½“ç„¶â€åŸ‹çš„**â€”â€”æ¯”å¦‚å¿˜äº†close Jedisï¼Œæ¯”å¦‚æ²¡ç»™KEYSåŠ å“ˆå¸Œæ ‡ç­¾ï¼Œæ¯”å¦‚ç”¨KEYS \*æŸ¥æ•°æ®ã€‚

å¤šåŠ¨æ‰‹ï¼Œå¤šè¸©å‘ï¼Œæ‰èƒ½æŠŠRediså˜æˆä½ çš„â€œæ­¦å™¨â€ï¼

ï¼ˆå…¨æ–‡å®Œï¼Œè§‰å¾—æœ‰ç”¨å°±ç‚¹ä¸ªèµå§ï½ï¼‰

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19200223](https://www.cnblogs.com/sun-10387834/p/19200223)