---
layout: post
title: 'ã€Uber é¢è¯•çœŸé¢˜ã€‘SQL ï¼šæ¯ä¸ªæ˜ŸæœŸè¿ç»­5æ˜Ÿè¯„ä»·æœ€å¤šçš„å¸æœº'
date: "2025-05-10T00:39:06Z"
---
ã€Uber é¢è¯•çœŸé¢˜ã€‘SQL ï¼šæ¯ä¸ªæ˜ŸæœŸè¿ç»­5æ˜Ÿè¯„ä»·æœ€å¤šçš„å¸æœº
===============================

![ã€Uber é¢è¯•çœŸé¢˜ã€‘SQL ï¼šæ¯ä¸ªæ˜ŸæœŸè¿ç»­5æ˜Ÿè¯„ä»·æœ€å¤šçš„å¸æœº](https://img2024.cnblogs.com/blog/3640949/202505/3640949-20250509144218853-117268176.png) è¿™æ˜¯ä¸€é“æ¥è‡ªäº Uber é¢è¯•çš„é¢˜ç›®ï¼Œåˆ©ç”¨ SQL ç»™å‡ºæ¯å‘¨è·å¾—è¿ç»­ 5 æ˜Ÿæ•°é‡æœ€å¤šçš„å¸æœºã€‚å¦‚æœä¸­é—´è·å¾—å…¶ä»–è¯„ä»·ï¼Œåˆ™â€œè¿ç»­ 5 æ˜Ÿâ€çš„æ¬¡æ•°ä¸­æ–­æ¸…é›¶ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯â€œè’‹ç‚¹æ•°åˆ†â€ï¼Œå¤šå¹´ä»¥æ¥ä¸€ç›´ä»äº‹æ•°æ®åˆ†æå·¥ä½œã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œä¸å¤§å®¶æŒç»­åˆ†äº«å…³äºæ•°æ®åˆ†æçš„å­¦ä¹ å†…å®¹ã€‚

æœ¬æ–‡æ˜¯ç¬¬ä¸€ç¯‡ï¼Œä¹Ÿæ˜¯ã€SQL å‘¨å‘¨ç»ƒã€‘ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ã€‚è¯¥ç³»åˆ—æ˜¯æŒ‘é€‰æˆ–è‡ªç¼–å…·æœ‰ä¸€äº›éš¾åº¦çš„ SQL é¢˜ç›®ï¼Œä¸€å‘¨è‡³å°‘æ›´æ–°ä¸€ç¯‡ã€‚åç»­åˆ›ä½œçš„å†…å®¹ï¼Œåˆæ­¥è§„åˆ’çš„æ–¹å‘åŒ…æ‹¬ï¼š

åç»­å†…å®¹è§„åˆ’
------

1.åˆ©ç”¨Â **Streamlit**Â å®ç°Â `Hive å…ƒæ•°æ®å±•ç¤º`ã€`SQL ç¼–è¾‘å™¨`ã€ ç»“åˆ`Docker æ²™ç®±å®ç°æ•°æ®åˆ†æ Agent`  
2.æ—¶é—´åºåˆ—å¼‚å¸¸è¯†åˆ«ã€å¼‚åŠ¨å½’å› ç®—æ³•  
3.ç•™å­˜ç‡æ‹Ÿåˆã€é¢„æµ‹ã€å»ºæ¨¡  
4.å­¦ä¹ Â `AB å®éªŒ`ã€å¤æ‚å®éªŒè®¾è®¡ç­‰  
5.`è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ `ã€è‡ªåŠ¨åŒ–ç‰¹å¾å·¥ç¨‹  
6.`å› æœæ¨æ–­`å­¦ä¹   
7\. .â€¦â€¦

**æ¬¢è¿å…³æ³¨**ï¼Œä¸€èµ·å­¦ä¹ ã€‚

ç¬¬ 1 æœŸé¢˜ç›®
-------

é¢˜ç›®æ¥æºï¼šUber é¢è¯•çœŸé¢˜

### ä¸€ã€é¢˜ç›®ä»‹ç»

æœ‰ä¸€å¼ è¡¨ï¼Œè®°å½•äº†ä¹˜å®¢å¯¹äºå¸æœºçš„è¯„ä»·ï¼Œè¯·æ‰¾å‡ºæ¯ä¸ªæ˜ŸæœŸå½“ä¸­**è¿ç»­**è·å¾— 5 æ˜Ÿå¥½è¯„æœ€å¤šçš„ driver\_idã€‚åˆ—åï¼š`driver_id`ã€`rating_time`ã€`ratings`Â ï¼ˆåŸé¢˜ä¹˜å®¢ id å¯¹è§£ç­”é¢˜ç›®æ˜¯å†—ä½™çš„ï¼Œæ•…æ­¤æˆ‘åœ¨æ–‡ä¸­çœç•¥æ‰...ï¼‰è¿ç»­ 5 æ˜Ÿï¼Œä¸­é—´å‡ºç°ä»»æ„ä¸€æ¬¡é 5 æ˜Ÿï¼Œåˆ™ä¸­æ–­ã€‚

### äºŒã€é¢˜ç›®æ€è·¯

æƒ³è¦ç­”é¢˜çš„åŒå­¦ï¼Œå¯ä»¥å…ˆæ€è€ƒç­”æ¡ˆğŸ¤”ã€‚  
â€¦â€¦

â€¦â€¦

â€¦â€¦

æˆ‘æ¥è°ˆè°ˆæˆ‘çš„æ€è·¯ï¼Œâ€œè¿ç»­â€é—®é¢˜æ˜¯æ•°æ®åˆ†æå¸ˆåœ¨ SQL ç¬”è¯•ä¸­çš„â€œè€æœ‹å‹â€äº†ã€‚æœ€å¸¸è§çš„å°±æ˜¯â€œè¿ç»­ç™»å½•â€é—®é¢˜ï¼Œå…¶å¤§æ¦‚æ€è·¯æ˜¯åˆ©ç”¨æ—¥æœŸå‡å»æ’åº`row_number()`å¾—åˆ°ä¸€ä¸ªâ€œåŸºå‡†æ—¥æœŸâ€ç”¨æ¥ä½œä¸ºåˆ†ç»„æ ‡è¯†ã€‚è¿™é‡Œæ²¡æœ‰æ—¥æœŸï¼Œä¸èƒ½ç”Ÿæ¬ç¡¬å¥—ã€‚

æˆ‘ä»¬æ€ç»´å˜é€šä¸€ä¸‹ï¼Œå¦‚æœæƒ³å°†è¿ç»­è®¡æ•°çš„è®°å½•èƒ½å¤Ÿæ”¾åœ¨åŒä¸€ä¸ªç»„é‡Œï¼Œé‚£ä¹ˆè¿™ä¸ªåˆ†ç»„æ ‡è¯†æ˜¯å…³é”®ã€‚å¯¹äºè¿ç»­ 5 æ˜Ÿï¼Œå®ƒä»¬çš„æœ‰ä»€ä¹ˆå…±åŒç‚¹ï¼Ÿæ˜¯æ¯ä¸€ä¸ª 5 æ˜Ÿè¯„ä»·å‰é¢æœ‰å¤šå°‘ä¸ªé 5 æ˜Ÿï¼ˆ1ï½4 æ˜Ÿï¼‰çš„è¯„ä»·ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ç»˜åˆ¶ä¸€ä¸ªç®€æ˜“çš„è¯´æ˜å›¾ï¼š

![](https://img2024.cnblogs.com/blog/3640949/202504/3640949-20250427173453441-1320230306.png)

åªéœ€è¦æ³¨æ„å‰”é™¤æ¯ç»„å¼€å¤´å¯èƒ½å¤šå‡ºæ¥çš„é 5 æ˜Ÿè¯„ä»·ï¼Œå³å¯å®Œæˆç»Ÿè®¡ã€‚ä¸‹é¢ï¼Œæˆ‘ç”¨Â `NumPy`Â ç»“åˆä¸€äº›å‡è®¾æ¥ç”Ÿæˆæ¨¡æ‹Ÿçš„æ•°æ®é›†ï¼š

### ä¸‰ã€ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®

åªå…³å¿ƒ SQL ä»£ç çš„åŒå­¦ï¼Œå¯ä»¥è·³è½¬åˆ°ç¬¬å››èŠ‚ï¼ˆæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨Â `Hive`Â è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨Â `Hive`Â çš„è¯­æ³•ï¼‰

ä¸ºäº†ç®€åŒ–æ¨¡æ‹Ÿæ•°æ®çš„éš¾åº¦ï¼Œåšå¦‚ä¸‹å‡è®¾ï¼š

    1.å‡è®¾ç”¨æˆ·ä¸‹è½¦ä¹‹åç«‹å³è¯„ä»·ï¼Œè¯„ä»·æ—¶é—´å–ä¸‹è½¦æ—¶é—´
    2.å¸æœºç­‰å¾…è®¢å•ã€æ¥å®¢é€å®¢åŠ åœ¨ä¸€èµ·çš„æ—¶é—´é—´éš”ï¼Œé€šè¿‡æŒ‡æ•°åˆ†å¸ƒæ¨¡æ‹Ÿ
    3.è®¢å•çš„æ—¶é—´é—´éš”ï¼Œä¸å¼•å…¥æ—©æ™šé«˜å³°å› ç´ ï¼Œä¸å¼•å…¥å·®å¼‚åŒ–å› ç´  => å¯¹æ¯åå¸æœºçš„å‚æ•°æ˜¯ä¸€æ ·çš„
    4.å¸æœºå›å®¶å’Œç¡è§‰çš„æ—¶é—´ï¼Œç®—åœ¨ä¸€èµ·ï¼Œç”¨æ­£æ€åˆ†å¸ƒæ¨¡æ‹Ÿ
    5.ä¸å¼•å…¥å¸æœºåƒé¥­ã€å‡ºè½¦å‰ä¼‘æ¯ç­‰ä¸ªäººäº‹åŠ¡çš„æ—¶é—´ï¼Œå¦åˆ™æ¨¡æ‹Ÿèµ·æ¥å¤ªå¤æ‚
    6.å¯¹äºå¸æœºï¼Œåªé™åˆ¶æ¯æ—¥æœ€å¤šåœ¨çº¿æ—¶é•¿ï¼Œä¸åšå‘¨ã€æœˆçº§åˆ«çš„é™åˆ¶
    7.å‡è®¾å­˜åœ¨ä¸¤ç±»å¸æœºï¼š
        a.è¿½æ±‚æ¯å¤©è¾¾åˆ°ä¸€ä¸ªç›®æ ‡æ”¶å…¥ï¼Œè¾¾åˆ°ååˆ™ä¸»åŠ¨æ”¶è½¦ => ç”¨å•é‡ä»£æ›¿æ”¶å…¥
        b.è¿½æ±‚æ¯å¤©è¾¾åˆ°æŸä¸ªåœ¨çº¿æ—¶é•¿ï¼Œè¾¾åˆ°ååˆ™ä¸»åŠ¨æ”¶è½¦
     8.æ¨¡æ‹Ÿæ•°æ®ç´¯è®¡åï¼Œå¯èƒ½å¯¼è‡´çš„å¸æœºæ—¥å¤œè§„å¾‹é¢ å€’ => è¿èƒŒç°å®æƒ…å†µï¼Œä¸ä½œè°ƒæ•´

æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹ï¼š

1\. å®šä¹‰æ¨¡æ‹Ÿé€»è¾‘éœ€è¦çš„`å¸¸é‡`ï¼š

    import datetime
    import numpy as np
    import pandas as pd
    
    # è®¾ç½®éšæœºæ•°ç§å­
    np.random.seed(2025)
    # æ¨¡æ‹Ÿçš„å¸æœºæ•°é‡
    DRIVER_NUM = 100
    # è¿½æ±‚å•é‡çš„å¸æœºæ•°é‡ï¼ˆä¸è®ºè¿½æ±‚å•é‡è¿˜æ˜¯è¿½æ±‚åœ¨çº¿æ—¶é•¿ï¼Œéƒ½è¦é¢å¤–å—å¹³å°åœ¨çº¿æ—¶é•¿é™åˆ¶ï¼‰
    PURSUING_ORDER_DRIVER_NUM = 55
    # è¿½æ±‚è®¢å•çš„æ•°é‡å–å€¼ (10 ~ 20 å•ï¼Œå€¼å¤ªé«˜åœ¨å…¶ä»–å‚æ•°å½±å“ä¸‹ï¼Œä¹Ÿå–ä¸åˆ°)
    # ç¦»æ•£å‡åŒ€åˆ†å¸ƒ
    pursuing_order_volume = np.random.choice(
        np.arange(10, 21), size=PURSUING_ORDER_DRIVER_NUM
    )
    # è¿½æ±‚åœ¨çº¿æ—¶é•¿çš„å¸æœºæ•°é‡
    PURSUING_ONLINE_DRIVER_NUM = DRIVER_NUM - PURSUING_ORDER_DRIVER_NUM
    # è¿½æ±‚åœ¨çº¿æ—¶é•¿çš„å–å€¼ ï¼ˆ8å°æ—¶ã€8.5å°æ—¶......12å°æ—¶ï¼‰
    pursuing_online_duration = np.random.choice(
        np.arange(8, 12.5, 0.5), size=PURSUING_ONLINE_DRIVER_NUM
    )
    # æ¨¡æ‹Ÿæ•°æ®çš„æ—¥æœŸèŒƒå›´
    START_DATETIME = datetime.datetime(2025, 1, 1, 8, 0, 0)
    END_DATETIME = datetime.datetime(2025, 5, 1, 23, 59, 59)
    # å¹³å‡è®¢å•æ—¶é—´é—´éš”ï¼ˆå•ä½ç§’ï¼ŒåŒ…å«ç­‰å•+æ¥å®¢+é€å®¢ï¼Œç­‰äºè¯„ä»·æ—¶é—´é—´éš”ï¼‰
    ORDER_INTERVAL_AVG = 40 * 60
    # å¸æœºå¹³å‡ä¼‘æ¯æ—¶é•¿ï¼ˆå•ä½ç§’ï¼ŒåŒ…å«æ”¶è½¦æ—¶é—´ï¼‰
    DRIVER_REST_DURATION_AVG = 8 * 3600
    # å¸æœºå¹³å‡ä¼‘æ¯æ—¶é•¿æ ‡å‡†å·®ï¼ˆå•ä½ç§’ï¼‰
    DRIVER_REST_DURATION_STD = 30 * 60
    # æ¯æ—¥åœ¨çº¿æ—¶é•¿ä¸Šé™ï¼ˆç§’ï¼‰
    ONLINE_DURATION_UPPER_LIMIT = 12 * 3600

2\. æ¨¡æ‹Ÿè®¢å•é—´éš”ã€ä¹˜å®¢è¯„åˆ†ã€ä¼‘æ¯é—´éš”ã€‚ä¸ºäº†æé«˜ç”Ÿæˆé€Ÿåº¦ï¼Œå°½é‡ä¸€æ¬¡è®©Â `NumPy`Â ç”Ÿæˆè¶³å¤Ÿå¤šçš„æ•°æ®ï¼›ç”¨å‡½æ•°å°è£…èµ·æ¥ï¼Œå¦‚æœè¶…å‡ºäº†é¢„å…ˆç”Ÿæˆçš„æ•°æ®é•¿åº¦ï¼Œåˆ™å¼€å¯å•æ¬¡ç”Ÿæˆï¼š

    # ä¸ºäº†ä¸€æ¬¡å°½å¯èƒ½å°†æ•°æ®æ¨¡æ‹Ÿå…¨
    # æ ¹æ®å‚æ•°å¹³å‡å€¼ï¼Œæ¥è®¡ç®—å‡ºå¤§æ¦‚éœ€è¦æ¨¡æ‹Ÿå‡ºå¤šå°‘ä¸ªè®¢å•é—´éš”ï¼Œå†å¢åŠ  10% æµ®åŠ¨
    # round å‡½æ•°è¾“å‡º float ç±»å‹ï¼Œéœ€è¦è½¬ä¸º int ç±»å‹ï¼Œä¸ç„¶åç»­ numpy çš„ size ä¼šæŠ¥é”™
    ORDER_NUM_NEED_SIMULATION = int(
        round(
            (END_DATETIME - START_DATETIME).days
            * (ONLINE_DURATION_UPPER_LIMIT / ORDER_INTERVAL_AVG)
            * (1 + 0.1),
            0,
        )
    )
    
    # ç”Ÿæˆæ¨¡æ‹Ÿçš„è®¢å•é—´éš”
    order_interval_simulation = np.random.exponential(
        scale=ORDER_INTERVAL_AVG, size=(DRIVER_NUM, ORDER_NUM_NEED_SIMULATION)
    )
    
    # ä¹˜å®¢çš„è¯„ä»·ä¹Ÿä¸€å¹¶éšæœºç”Ÿæˆ
    rating_simulation = np.random.choice(
        np.arange(1, 6),
        size=(DRIVER_NUM, ORDER_NUM_NEED_SIMULATION),
        p=[0.01, 0.01, 0.02, 0.06, 0.9],
    )
    
    
    defget_order_interval_and_rating_simulation(driver_id, cnt):
        """
        è·å–è®¢å•é—´éš”æ—¶é•¿å’Œè®¢å•è¯„åˆ†ï¼Œå¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œ
        æ˜¯ä¸ºäº†å¦‚æœæ‰¹é‡éšæœºç”Ÿæˆçš„æ•°æ®ä¸å¤Ÿç”¨ï¼Œå†å•æ¬¡ç”Ÿæˆ
        """
        if cnt >= ORDER_NUM_NEED_SIMULATION:
            return (
                np.random.exponential(scale=ORDER_INTERVAL_AVG),
                np.random.choice(np.arange(1, 6), p=[0.01, 0.01, 0.02, 0.06, 0.9]),
            )
        else:
            return (
                order_interval_simulation[driver_id][cnt],
                rating_simulation[driver_id][cnt],
            )
    
    
    # æ¨¡æ‹Ÿä¼‘æ¯çš„æ•°æ®( åœ¨çº¿åŠ ä¼‘æ¯çš„å’Œæœ‰å¯èƒ½å°äº 24 å°æ—¶ )
    REST_NUM_NEED_SIMULATION = int(
        round((END_DATETIME - START_DATETIME).days * (1 + 0.1), 0)
    )
    
    rest_interval_simulation = (
        np.clip(
            np.random.normal(loc=8, scale=0.5, size=(DRIVER_NUM, REST_NUM_NEED_SIMULATION)),
            a_min=6,
            a_max=12,
        )
        * 3600
    )
    
    
    defget_rest_interval_simulation(driver_id, cnt):
        """
        è·å–ä¼‘æ¯é—´éš”æ—¶é•¿ï¼Œå¢åŠ ä¸€ä¸ªå‡½æ•°ï¼Œæ˜¯ä¸ºäº†å¦‚æœæ‰¹é‡éšæœºç”Ÿæˆçš„
        æ•°æ®ä¸å¤Ÿç”¨ï¼Œå†å•æ¬¡ç”Ÿæˆ
        """
        if cnt >= REST_NUM_NEED_SIMULATION:
            return np.clip(np.random.normal(loc=8, scale=0.5), a_min=6, a_max=12) * 3600
        else:
            return rest_interval_simulation[driver_id][cnt]

3\. æ ¹æ®å‡è®¾çš„é€»è¾‘ï¼Œç”Ÿæˆå¸æœºçš„å…¨éƒ¨æ•°æ®ã€‚æ³¨æ„å¸æœºä¼‘æ¯çš„åˆ¤æ–­æ¡ä»¶ï¼Œä»¥åŠä¸­é—´å˜é‡æ¸…é›¶çš„å¤„ç†ï¼š

    table_data = {"driver_id": [], "rating_time": [], "ratings": []}
    
    for driver_id inrange(DRIVER_NUM):
        order_cnt = 0# ç¬¬å‡ ä¸ªè®¢å•
        rest_cnt = 0# ç¬¬å‡ æ¬¡ä¼‘æ¯
        last_time = START_DATETIME
        # å½“å‰ç´¯è®¡åœ¨çº¿æ—¶é—´ï¼Œæ³¨æ„å•ä½æ˜¯ç§’
        current_online_time = 0
        # å½“å¤©çš„è®¢å•ï¼Œè¿½æ±‚è®¢å•çš„å¸æœºéœ€è¦è¿™ä¸ªå˜é‡
        current_order_cnt = 0
        whileTrue:
            table_data["driver_id"].append(driver_id)
            order_interval, rating = get_order_interval_and_rating_simulation(
                driver_id, order_cnt
            )
            last_time = last_time + datetime.timedelta(seconds=int(order_interval))
            table_data["rating_time"].append(last_time)
            table_data["ratings"].append(rating)
    
            # å½“å¤©ç´¯è®¡åœ¨çº¿æ—¶é—´å¢åŠ 
            current_online_time += order_interval
            # è®¢å•åºå·åŠ ä¸€
            order_cnt += 1
            # å½“å¤©è®¢å•æ•°é‡åŠ ä¸€
            current_order_cnt += 1
    
            # å½“å¤©ç´¯è®¡æ—¶é—´è¶…è¿‡å¹³å°é™åˆ¶ï¼Œéœ€è¦å»ä¼‘æ¯
            rest_flag_1 = current_online_time >= ONLINE_DURATION_UPPER_LIMIT
            # å‰é¢çš„å¸æœºè¿½æ±‚è®¢å•æ•°
            rest_flag_2 = (
                driver_id < PURSUING_ORDER_DRIVER_NUM
                and current_order_cnt >= pursuing_order_volume[driver_id]
            )
            # åé¢çš„å¸æœºè¿½æ±‚åœ¨çº¿æ—¶é•¿
            rest_flag_3 = (
                driver_id >= PURSUING_ORDER_DRIVER_NUM
                and current_online_time
                >= pursuing_online_duration[driver_id - PURSUING_ORDER_DRIVER_NUM]
            )
    
            if rest_flag_1 or rest_flag_2 or rest_flag_3:
                # å¢åŠ ä¼‘æ¯æ—¶é—´
                reset_interval = int(get_rest_interval_simulation(driver_id, rest_cnt))
                last_time = last_time + datetime.timedelta(seconds=reset_interval)
                # å½“å¤©ç´¯è®¡åœ¨çº¿æ—¶é•¿æ¸…é›¶
                current_online_time = 0
                # å½“å¤©ç´¯è®¡è®¢å•æ•°æ¸…é›¶
                current_order_cnt = 0
                # ä¼‘æ¯æ¬¡æ•°åŠ ä¸€
                rest_cnt += 1
    
            # è¾¾åˆ°é¡¹ç›®æ€»ä½“æ¨¡æ‹Ÿç»“æŸæ—¶é—´ï¼Œè·³å‡º
            if last_time > END_DATETIME:
                break

4\. å°†æ¨¡æ‹Ÿçš„æ•°æ®è½¬ä¸ºÂ `pd.DataFrame`Â å¹¶è¾“å‡ºä¸ºÂ `csv`Â æ–‡ä»¶ï¼›åˆ›å»ºÂ `Hive`Â è¡¨ï¼Œå¹¶å°†æ•°æ®Â `load`Â åˆ°è¡¨ä¸­ï¼š

    df = pd.DataFrame(table_data)
    df["driver_id"] = "driver_" + df["driver_id"].astype("str").str.zfill(2)
    df.to_csv(
        "./dwd_uber_simulation_rating_detail.csv",
        sep=",",
        encoding="utf-8-sig",
        index=False,
        header=False,
    )
    
    from pyhive import hive
    
    # é…ç½®è¿æ¥å‚æ•°
    host_ip = "127.0.0.1"
    port = 10000
    username = "è’‹ç‚¹æ•°åˆ†"
    
    with hive.Connection(host=host_ip, port=port) as conn:
        cursor = conn.cursor()
    
        create_table_sql = """
        CREATE TABLE IF NOT EXISTS data_exercise.dwd_uber_simulation_rating_detail (
            driver_id STRING COMMENT 'å¸æœºid',
            rating_time TIMESTAMP COMMENT 'è¯„ä»·æ—¶é—´',
            ratings TINYINT COMMENT 'è¯„åˆ†ç­‰çº§ï¼Œ1ï½5 æ˜Ÿ'
        )
        COMMENT 'Uber ä¹˜å®¢å¯¹å¸æœºè¯„åˆ†è¡¨ï¼Œæ¨¡æ‹Ÿæ•°æ® | æ–‡ç« ç¼–å· 7c98d8ef'
        ROW FORMAT DELIMITED
        FIELDS TERMINATED BY ','
        STORED AS TEXTFILE
        """
    
        cursor.execute(create_table_sql)
    
        import os
    
        load_data_sql = f"""
        LOAD DATA LOCAL INPATH "{os.getcwd() + '/dwd_uber_simulation_rating_detail.csv'}" 
        OVERWRITE INTO TABLE data_exercise.dwd_uber_simulation_rating_detail
        """
    
        cursor.execute(load_data_sql)

5\. å°†æŸ¥è¯¢çš„ SQLï¼Œåˆ©ç”¨Â `pd.read_sql_query`Â è¯»å–æŸ¥è¯¢ç»“æœã€‚æ³¨æ„æ­¤æ®µä»£ç ï¼Œä»ç„¶ä½äºÂ `with`Â ä¸Šä¸‹æ–‡ä¸­ï¼š

        select_data_sql = '''
            with calc_table as (
                select
                  driver_id, date_format(rating_time, 'yyyyå¹´wwå‘¨') as year_week -- ä»å‘¨æ—¥å¼€å§‹ç®—æ–°çš„ä¸€å‘¨
                , sum(if(ratings <> 5, 1, 0)) over(partition by driver_id, date_format(rating_time, 'yyyyå¹´wwå‘¨') order by rating_time asc) as cnt_tag
                , ratings
                from data_exercise.dwd_uber_simulation_rating_detail
            ) 
            
            , calc_continuous_five_table as (
                select
                  driver_id, year_week, cnt_tag
                , sum(1) as continuous_five -- sum(if(raings=5,1,0))
                , rank() over(partition by year_week order by sum(1) desc) as rk
                from calc_table
                where ratings = 5
                group by driver_id, year_week, cnt_tag
            )
            
            select
              year_week
            -- å¯èƒ½æœ‰å¸æœºå¹¶åˆ—ï¼Œä½¿ç”¨ collect
            -- å¦‚æœä¸€åå¸æœºè¿ç»­ 5 æ˜Ÿçš„æ¬¡æ•°æœ€é«˜ï¼Œä¸”å‡ºç°äº†ä¸¤æ¬¡ï¼Œé‚£ä¹ˆä¼šé‡å¤
            -- å› æ­¤ä½¿ç”¨ set
            , collect_set(driver_id) as most_continuous_five_start_drivers
            from calc_continuous_five_table
            where rk = 1
            group by year_week
        '''
    
        df_outcome = pd.read_sql_query(select_data_sql, conn)
    
    # åœ¨ Jupter ç¯å¢ƒä¸‹ï¼Œæ˜¾ç¤ºç»“æœ
    display(df_outcome)

> æˆ‘ä½¿ç”¨Â `PyHive`Â åŒ…å®ç° Python æ“ä½œÂ `Hive`ã€‚æˆ‘ä¸ªäººç”µè„‘éƒ¨ç½²äº†Â `Hadoop`Â åŠÂ `Hive`ï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯è®¤è¯ï¼Œä¼ä¸šé‡Œä¸€èˆ¬å¸¸ç”¨Â `Kerberos`Â æ¥è¿›è¡Œå¤§æ•°æ®é›†ç¾¤çš„è®¤è¯ã€‚

### å››ã€SQL è§£ç­”

æˆ‘é‡‡ç”¨Â `CTE`Â çš„å†™æ³•æ¥åµŒå¥—é€»è¾‘è½¬ä¸ºä¸²è¡Œï¼Œè¿™æ ·å†™å¯¹äºå¤æ‚ SQL çš„é€»è¾‘æ¢³ç†å…·æœ‰ä¸€å®šå¸®åŠ©ã€‚ä½¿ç”¨çª—å£å‡½æ•°Â `count(if(rating<>5,rating,null))`Â æˆ–Â `sum(if(rating<>5,1,0))`Â æ¥ç»Ÿè®¡ 1~4 æ˜Ÿè¯„ä»·çš„æ•°é‡ã€‚

â€œæ¯å‘¨â€å› æ­¤éœ€è¦ä½¿ç”¨Â `date_format`Â æ¥æå–å¹´ä»½å’Œå‘¨ =>Â `partition by driver_id, date_format(rating_time, 'yyyyå¹´wwå‘¨')`ï¼›ä½¿ç”¨Â `order by rating_time asc`Â æ—¶ï¼Œç»Ÿè®¡çš„çª—å£èŒƒå›´é»˜è®¤æ˜¯Â `rows between preceding unbounded and current row`ï¼Œå†™æ¸…æ¥šæ›´å¥½ã€‚

æ³¨æ„å› ä¸ºç»Ÿè®¡çš„é€»è¾‘æ˜¯æˆªè‡³å½“å‰è¡Œï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ª 5 æ˜Ÿè¯„ä»·å‰çš„é‚£ä¸ª 1ï½4 æ˜Ÿï¼Œå®ƒçš„è®¡æ•°æ ‡è¯†è·Ÿ 5 æ˜Ÿæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥éœ€è¦Â `where`Â è¿‡æ»¤ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨åç»­èšåˆç»Ÿè®¡æ—¶ï¼Œä½¿ç”¨æ¡ä»¶å¤„ç†Â `sum(if(raings=5,1,0))`ã€‚

æœ€ç»ˆç»“æœä½¿ç”¨Â `collect_set`Â å°† driver\_id å½¢æˆå»é‡æ•°ç»„ï¼šä¸€æ–¹é¢å¯èƒ½æ¯ä¸ªæ˜ŸæœŸæœ‰å¸æœºè¿ç»­ 5 æ˜Ÿå¥½è¯„æ•°å¹¶åˆ—ç¬¬ä¸€ï¼›å¦ä¸€æ–¹é¢æç«¯æƒ…å†µä¸‹ï¼Œè¿ç»­ 5 æ˜Ÿå¥½è¯„æœ€å¤šçš„é‚£ä¸ªå¸æœºå¦‚æœæœ€å¤šçš„è¿ç»­ 5 æ˜Ÿå¥½è¯„æ•°ä¸€å‘¨å†…å‡ºç°äº†å¤šæ¬¡ï¼Œåˆ™è¿™ä¸ª driver\_id ä¼šå‡ºç°å¤šæ¬¡ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆä¸ç”¨Â `collect_list`Â çš„åŸå› ã€‚

    with calc_table as (
        select
          driver_id, date_format(rating_time, 'yyyyå¹´wwå‘¨') as year_week -- ä»å‘¨æ—¥å¼€å§‹ç®—æ–°çš„ä¸€å‘¨
        , sum(if(ratings <>5, 1, 0)) over(partitionby driver_id, date_format(rating_time, 'yyyyå¹´wwå‘¨') orderby rating_time asc) as cnt_tag
        , ratings
        from data_exercise.dwd_uber_simulation_rating_detail
    ) 
    
    , calc_continuous_five_table as (
        select
          driver_id, year_week, cnt_tag
        , sum(1) as continuous_five -- sum(if(raings=5,1,0))
        , rank() over(partitionby year_week orderbysum(1) desc) as rk
        from calc_table
        where ratings =5
        groupby driver_id, year_week, cnt_tag
    )
    
    select
      year_week
    -- å¯èƒ½æœ‰å¸æœºå¹¶åˆ—ï¼Œä½¿ç”¨ collect
    -- å¦‚æœä¸€åå¸æœºè¿ç»­ 5 æ˜Ÿçš„æ¬¡æ•°æœ€é«˜ï¼Œä¸”å‡ºç°äº†ä¸¤æ¬¡ï¼Œé‚£ä¹ˆä¼šé‡å¤
    -- å› æ­¤ä½¿ç”¨ set
    , collect_set(driver_id) as most_continuous_five_start_drivers
    , max(continuous_five) as continuous_five
    from calc_continuous_five_table
    where rk =1
    groupby year_week

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`date_format`Â çš„Â `w`Â å‚æ•°æ˜¯ä»å‘¨æ—¥å¼€å§‹ç®—æ–°çš„ä¸€å‘¨ã€‚æˆ‘è¿™é‡Œå·æ‡’å°±ä¸æ”¹æˆæŒ‰ç…§å‘¨ä¸€ä¸ºæ–°çš„ä¸€å‘¨æ¥è®¡ç®—ã€‚

æœ€ç®€å•çš„æ€è·¯æ˜¯å°†å®é™…æ—¥æœŸå¾€å‰æŒªä¸€å¤©ï¼Œä½†æ˜¯å‘¨æ•°ä¸è·¨å¹´é—®é¢˜ï¼Œå¾€å¾€å®¹æ˜“å¼•èµ·æ··æ·†ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å°å¿ƒå¤„ç†ã€‚ä¸¥è°¨èµ·è§ï¼Œåº”æŸ¥è¯¢Â **ISO 8601**Â çš„è§„å®šã€‚

**ğŸ˜ƒğŸ˜ƒğŸ˜ƒ æˆ‘ç°åœ¨æ­£åœ¨æ±‚èŒæ•°æ®ç±»å·¥ä½œ**ï¼ˆä¸»è¦æ˜¯æ•°æ®åˆ†ææˆ–æ•°æ®ç§‘å­¦ï¼‰ï¼›å¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼Œæ³è¯·æ‚¨ä¸æˆ‘è”ç³»ï¼Œå³æ—¶åˆ°å²—ï¼Œä¸é™åŸå¸‚ã€‚æ‚¨å¯ä»¥å‘é€ç§ä¿¡æˆ–è”ç³»æˆ‘ï¼ˆå…¨ç½‘åŒåï¼šè’‹ç‚¹æ•°åˆ†ï¼‰ã€‚