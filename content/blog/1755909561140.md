---
layout: post
title: 'ä¸ºworkflow-coreæ‰©å±•å¤–æŠ›äº‹ä»¶'
date: "2025-08-23T00:39:21Z"
---
ä¸ºworkflow-coreæ‰©å±•å¤–æŠ›äº‹ä»¶
====================

workflow-coreè‡ªå¸¦äº‹ä»¶çš„å±€é™æ€§
=====================

ä¼—æ‰€å‘¨çŸ¥ï¼Œworkflow-coreåªèƒ½ä»å¤–å‘å†…æŠ›äº‹ä»¶  
æ¯”å¦‚åœ¨apiæ¥å£ä¸­å¼•å‘äº‹ä»¶ï¼Œåœ¨å·¥ä½œæµä¸­ç­‰å¾…äº‹ä»¶å®Œæˆ

    //ç¬¬ä¸€æ­¥ï¼Œå¼€å¯æµç¨‹
    public async Task<IActionResult> Add([FromBody] Dto parm)
    {
        //å¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œæµ
        //ç”± Workflow-Core è‡ªåŠ¨ç”Ÿæˆï¼ˆé»˜è®¤æ˜¯ GUID æ ¼å¼,å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµå®ä¾‹
        //é€šè¿‡è¯¥IDå¯ä»¥æ§åˆ¶å·¥ä½œæµç”Ÿå‘½å‘¨æœŸ
        var workflowId = await _workflowHost.StartWorkflow("xxxFlow", 1, parm);
        return SUCCESS(1);
    }
    
    //ç¬¬äºŒæ­¥ï¼Œå®¡æ‰¹,å¼•å‘äº‹ä»¶
    public async Task<IActionResult> Audit([FromBody] Dto parm)
    {
        var modal = parm.Adapt<Dto>().ToUpdate(HttpContext);
        //é€šçŸ¥å·¥ä½œæµç»§ç»­æ‰§è¡Œ
        await _workflowHost.PublishEvent(
            "audit",  // å¿…é¡»ä¸WaitForEventçš„äº‹ä»¶åç§°åŒ¹é…
            parm.WorkflowId,  // å¿…é¡»ä¸WaitForEventçš„äº‹ä»¶KeyåŒ¹é…
            parm//æä¾›çš„æ•°æ®
        );
        return SUCCESS(1);
    }
    

ä½†æ˜¯é€šå¸¸æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨å‰ç«¯è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼Œè¦è·å¾—è¿”å›æ•°æ®ã€‚æ¯”å¦‚`Add`åè¦åˆ·æ–°ç•Œé¢ï¼Œçœ‹åˆ°è¡¨æ ¼ä¸­æ–°æ·»åŠ çš„ä¸€è¡Œè®°å½•ã€‚  
ç„¶è€Œç”±äºæˆ‘ä»¬ç¼ºä¹è¿™ç§æ‰‹æ®µæ¥ä»æµç¨‹ä¸­è·å¾—åé¦ˆï¼Œè€Œä¸”æ˜¯ç­‰å¾…å¼`await`çš„åé¦ˆã€‚æ‰€ä»¥`Add`å°±ç›´æ¥ä¿„è¿”å›äº†ï¼Œç•Œé¢ä¸Šåˆ·æ–°æ—¶ï¼Œæµç¨‹å¯èƒ½è¿˜æ²¡è·‘åˆ°æ’å…¥æ•°æ®åº“é‚£ä¸€æ­¥ï¼Œäºæ˜¯ç•Œé¢ä¸Šä¹Ÿçœ‹ä¸åˆ°æ–°æ•°æ®ã€‚

äº‹ä»¶æ‰©å±•
====

æˆ‘ç ”ç©¶äº†ä¸€å¤©åï¼Œåˆ©ç”¨`C#`çš„æ‰©å±•æ–¹æ³•è¯­æ³•ï¼Œç»™`workflow-core`æ‰©å±•äº†å¤–æŠ›äº‹ä»¶ï¼Œè¿™æ ·å¯ä»¥åœ¨æ¥å£ä¸­ç­‰å¾…æµç¨‹ä¸­æŸä¸ªæ­¥éª¤å®Œæˆã€‚

è®¾æƒ³
--

è®¾æƒ³è°ƒç”¨æ–¹æ³•åº”è¯¥è¿™æ ·

    //ç¬¬ä¸€æ­¥ï¼Œå¼€å¯æµç¨‹
    public async Task<IActionResult> Add([FromBody] Dto parm)
    {
        //å¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œæµ
        //ç”± Workflow-Core è‡ªåŠ¨ç”Ÿæˆï¼ˆé»˜è®¤æ˜¯ GUID æ ¼å¼,å”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å·¥ä½œæµå®ä¾‹
        //é€šè¿‡è¯¥IDå¯ä»¥æ§åˆ¶å·¥ä½œæµç”Ÿå‘½å‘¨æœŸ
        var workflowId = await _workflowHost.StartWorkflow("xxxFlow", 1, parm);
        //ç­‰å¾…ç¬æ—¶äº‹ä»¶ï¼ŒSubmitProblemStepæ­¥éª¤æ‰§è¡Œå®Œæˆ
        var response = await _workflowHost.WaitEvent<Dto>("SubmitStep", workflowId);
        return SUCCESS(response);
    }
    

è€Œæµç¨‹ä¸­è¿™æ ·å¼•å‘äº‹ä»¶æ¯”è¾ƒä¼˜é›…

    Action<WaitFor, Dto> outputAction = (edata, data) => {
        (edata.EventData as Dto).Adapt(data);//ä¿è¯å¼•ç”¨å¯¹è±¡dataä¸ä¸¢å¤±çš„æƒ…å†µä¸‹æ›´æ–°å¯¹è±¡data
    };
    //è¿™æ ·å¼•å‘äº‹ä»¶
    builder
        // æäº¤è®°å½•
        .StartWith<SubmitStep>()
            .Input(step=>step.Entity, data=>data)
            .Output((step,data)=> data=step.Entity)//å°†WorkflowIdèµ‹å€¼ç»™æµç¨‹ï¼Œä¾¿äºWaitForç›‘å¬äº‹ä»¶
        //RaiseEventæ‰©å±•çš„å‘å¤–æŠ›äº‹ä»¶ï¼ŒåµŒå…¥åŸæ¥fluentApiä¸­å¼•å‘äº‹ä»¶
        //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¡¨ç¤ºè®°å½•å·²åœ¨SubmitStepä¸­æ’å…¥åˆ°æ•°æ®åº“äº†
        .RaiseEvent("SubmitStep", data=>data.WorkflowId)
        //workflow-coreè‡ªå¸¦çš„å‘å†…æŠ›äº‹ä»¶
        .WaitFor("AuditStep", data => data.WorkflowId, date => DateTime.Now)
    

å®ç°
--

æˆ‘è§‚å¯Ÿäº†å·²æœ‰çš„`.Then`,`.Input`è¿™äº›æ–¹æ³•ï¼Œç»ˆäºææ¸…æ¥šå®ç°å“ªä¸ªæ¥å£ï¼Œæ‰©å±•æˆ‘ä»¬çš„æ–¹æ³•ã€‚æŒ‰ç…§è®¾æƒ³ï¼Œéœ€è¦æš´éœ²ä¸¤ä¸ªæ–¹æ³•

*   **`RaiseEvent` ç»™å†…éƒ¨æµç¨‹ç”¨**
*   **`WaitEvent` ç»™å¤–éƒ¨æ¥å£ç”¨**

    /// <summary>
    /// å·¥ä½œæµä»å†…->å¤–æŠ›å‡ºäº‹ä»¶æ‰©å±•
    /// </summary>
    public static class WorkFlowEventExtensions
    {
    
        /// <summary>
        /// ç¬æ—¶äº‹ä»¶é›†åˆ
        /// </summary>
        public static List<EventSource> events = new List<EventSource>();
    
        /// <summary>
        /// æŠ›å‡ºäº‹ä»¶æ‰©å±•
        /// </summary>
        /// <typeparam name="TData"></typeparam>
        /// <typeparam name="TStepBody"></typeparam>
        /// <param name="builder"></param>
        /// <param name="eventName"></param>
        /// <param name="eventKey"></param>
        /// <returns></returns>
        public static IStepBuilder<TData, ActionStepBody> RaiseEvent<TData, TStepBody>(this IWorkflowModifier<TData, TStepBody> builder,
            string eventName, Func<TData, string> eventKey) where TStepBody : IStepBody
        {
            return builder
                .Delay(d => TimeSpan.FromMilliseconds(100))//å»¶è¿Ÿæµç¨‹å°ä¼šå„¿ï¼Œç­‰å¾…äº‹ä»¶eventså…ˆæ·»åŠ æˆåŠŸ
                .Then(ctx =>
                {
                    var key = eventKey.Invoke((TData)ctx.Workflow.Data);
                    //é‡Šæ”¾äº’æ–¥é”ï¼Œè®©WaitEventç»§ç»­æ‰§è¡Œä¸‹å»
                    var mu = events.FirstOrDefault(x => x.EventName == eventName && x.EventKey == key);
                    if (mu != null)
                    {
                        mu.Data = ctx.Workflow.Data;
                        //å®Œæˆä»»åŠ¡
                        mu.Cts.TrySetResult(true);
                    }
                });
        }
    
        /// <summary>
        /// ç­‰å¾…å†…éƒ¨äº‹ä»¶æ‰©å±•
        /// </summary>
        /// <typeparam name="TData">å¯ä»¥æ˜¯workflowçš„å®ä½“ç±»ï¼Œæ¯”å¦‚IWorkflow&lt;TData&gt;ä¸­çš„TDataç±»</typeparam>
        /// <param name="host"></param>
        /// <param name="eventName">äº‹ä»¶å</param>
        /// <param name="eventKey">äº‹ä»¶keyï¼Œä¸€èˆ¬æ˜¯WorkflowId,æµç¨‹å®ä¾‹Id</param>
        /// <returns></returns>
        public static async Task<TData> WaitEvent<TData>(this IWorkflowHost host, string eventName, string eventKey)
        {
            TData data = default(TData);
            //ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œè¯´æ˜æ­¥éª¤å·²æ‰§è¡Œï¼Œå¯ä»¥å¾—åˆ°éœ€è¦çš„æ•°æ®
            await Task.Run(async () =>
            {
                //å‘ä»»åŠ¡é›†åˆæ·»åŠ ä¸€ä¸ªä»»åŠ¡
                EventSource eventCts = new EventSource
                {
                    EventName = eventName,
                    EventKey = eventKey,
                    Cts = new TaskCompletionSource<bool>(),
                };
                events.Add(eventCts);
                //ç­‰å¾…ä»»åŠ¡å®Œæˆ
                await eventCts.Cts.Task;
                //é€€å‡ºç­‰å¾…
                if (eventCts.Data != null && eventCts.Data is TData)
                {
                    //å–å¾—æ•°æ®
                    data = (TData)eventCts.Data;
                }
                events.Remove(eventCts);
            });
            return data;
        }
    }
    
    /// <summary>
    /// äº‹ä»¶æº
    /// </summary>
    public class EventSource
    {
        public string EventName { get; set; }
        public string EventKey { get; set; }
    
        /// <summary>
        /// ä»»åŠ¡å®Œæˆæº
        /// </summary>
        public TaskCompletionSource<bool> Cts { get; set; }
    
        public object Data { get; set; }
    }
    

ç»“æœ
--

curdäº†ä¸€ä¸‹ï¼Œå‘ç°å½“ç„¶æ˜¯è¾¾åˆ°äº†æƒ³è¦çš„ç»“æœğŸ˜ã€‚  
å…¶ä¸­çš„å…³é”®æ–­ç‚¹å‘½ä¸­å¦‚ä¸‹

*   ç¬¬ä¸€æ­¥  
    ![image](https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822111952988-593993786.png)
*   ç¬¬äºŒæ­¥  
    ![image](https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822112043336-894782252.png)
*   ç¬¬ä¸‰æ­¥  
    ![image](https://img2024.cnblogs.com/blog/1494271/202508/1494271-20250822112103047-1638813539.png)