---
layout: post
title: 'VMware NSX 4.2 - 主机传输节点配置'
date: "2026-01-02T00:45:29Z"
---
VMware NSX 4.2 - 主机传输节点配置
=========================

简介
==

在 VMware NSX 中，**主机传输节点（Host Transport Node）就是把 ESXi 主机转化为 NSX 的数据平面节点**，它负责承载虚拟网络的流量转发、防火墙和安全策略执行，是 NSX 架构里“数据平面”的核心组成部分。

🧩 什么是 NSX 主机传输节点
-----------------

*   **定义**：主机传输节点是安装了 NSX 内核模块（VIB）的 ESXi 主机，使其能够参与 NSX 的虚拟网络和安全功能
*   **作用**：它在数据平面中运行，负责逻辑交换机、路由、防火墙等功能的实际流量处理。
*   **组成**：通过 NSX Manager 下发配置，结合 vCenter 集群和传输区域（Transport Zone），主机被准备为传输节点。

🔑 核心特性
-------

*   **数据平面角色**：所有虚拟机的东西向流量（East-West）和南北向流量（North-South）都通过传输节点进行处理。
*   **自动化配置**：在 vCenter 集群中应用传输节点配置文件后，集群内的 ESXi 主机会自动安装 NSX 组件并成为传输节点

⚠️ 部署注意事项
---------

*   需要 **vCenter 集群**，且有VDS 。
*   必须配置 **传输区域** 和 **上行链路配置文件**
*   主机必须有 **IP 池或 DHCP** 用于分配隧道端点（TEP）地址
*   独立 ESXi 主机不能直接应用传输节点配置文件，只能通过集群方式准备。

VMware NSX系列文章：[https://songxwn.com/tags/NSX/](https://songxwn.com/tags/NSX/ "https://songxwn.com/tags/NSX/")

NSX4+逻辑图
--------

全图在线：[https://songxwn.com/VMware-NSX4-mindmap/](https://songxwn.com/VMware-NSX4-mindmap/ "https://songxwn.com/VMware-NSX4-mindmap/")

高清PDF下载：关注公众号发送nsx下载。

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165017783-590653949.png)

环境介绍
----

*   NSX 4.2.3.1
*   VMware vCenter Server 8.0.3 + ESXi 8.0.3
*   创建ESXi集群
*   创建vDS分布式交换机，关联集群的主机，并配置vmnic1 为上行链路1。

MTU 和 巨型帧
---------

Geneve 协议是基于IP/UDP封装二层的，所以会增加报文开销。

### 物理交换机/路由器

ESXi 主机物理网卡连接的二层物理交换机接口需要开启巨型帧，如果要跨三层通信，所经过的三层接口也要调整MTU。

### vDS分布式交换机

可以修改为最大MTU9000

### NSX全局MTU

默认MTU为1700，默认应用到上行链路配置文件。

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165015348-606097031.png)

### 全局网关MTU

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165017275-1180393468.png)

添加计算管理器 - VMware vCenter Server
-------------------------------

打开NSX 管理界面 > 系统 > Fabric > 计算管理器 > 添加计算管理器

*   输入VCSA名称
*   输入VCSA访问域名或IP
*   输入VCSA管理账号和密码

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165018901-110279815.png)

PS：点击添加后需要确认指纹，确认即可。

创建NSX 传输TEP 用IP地址池
------------------

打开NSX 管理界面 > 网络 > IP管理-IP地址池 > 添加IP地址池

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165017493-447998777.png)

### 点击设置-子网 > 添加子网 > 添加IP块

*   配置IP范围，排除第一个IP 192.168.149.2-192.168.149.254
*   配置CIDR 子网，192.168.149.0/24

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165018540-117242768.png)

上行链路配置文件
========

上行链路定义
------

*   上行链路是从 **NSX Edge 节点**或 **Hypervisor 节点**到 **架顶式交换机**或 **NSX 逻辑交换机**的链路。
*   链路由 **NSX Edge 节点或 Hypervisor 节点上的物理网络接口**连接到交换机。

上行链路配置文件要求
----------

*   每个上行链路必须对应于 **已连接且可用的物理链路**。
    
*   示例：
    
    *   Hypervisor 主机有两个物理链路：`vmnic0` 和 `vmnic1`。
    *   如果 `vmnic0` 用于管理和存储网络，而 `vmnic1` 未使用，则 `vmnic1` 可作为 NSX 上行链路。
    *   若要进行链路绑定，需要两个未使用的物理链路，例如 `vmnic1` 和 `vmnic2`。
*   对于 NSX Edge，**隧道端点和 VLAN 上行链路**可以使用同一物理链路。
    
    *   示例：`vmnic0/eth0/em0` 用于管理网络，`vmnic1/eth1/em1` 用于 `fp-ethX` 链路。

上行链路配置文件可定义的策略
--------------

*   绑定策略
*   活动链路及备用链路
*   传输 VLAN ID
*   MTU 设置

故障切换绑定策略
--------

### 注意事项

*   同一传输节点的不同上行链路配置文件中，**不能使用相同的上行链路**。
*   不支持备用上行链路，不能在“故障切换”绑定策略中配置备用链路。
*   如果绑定策略使用多个上行链路（活动/备用列表），则不能重复使用相同的上行链路。

### 支持的方案

*   **裸机 NSX Edge**
    
    *   支持单个活动上行链路 + 一个备用上行链路
    *   不支持多个备用上行链路
*   **NSX Edge 虚拟机**
    
    *   不支持任何备用上行链路（单个或多个）

负载均衡源绑定策略
---------

### NSX Edge 虚拟机

*   支持多个活动上行链路
*   不支持 LAG 配置绑定策略
*   在 **活动上行链路** 字段中输入上行链路标签（如 `uplink1`, `uplink2`），并与物理网卡关联
*   必须使用 **负载均衡源** 绑定策略进行流量负载均衡

### 裸机 NSX Edge

*   支持多个活动上行链路
*   在 **活动上行链路** 字段中可使用 LAG 或单个上行链路标签（如 `LAG1`, `uplink1`, `uplink2`）
*   LAG 必须在同一 N-VDS 上包含两个物理网卡
*   LAG 数量取决于物理交换机的 LACP 支持能力（如最多 4 个端口）
*   LACP 支持：源/目标 MAC 地址、IP 地址、TCP/UDP 端口
*   多个 LAG 上行链路需配置唯一的 LAG 名称
*   多 VTEP 上行链路配置文件仅支持 **负载均衡源** 策略
*   必须使用 **负载均衡源** 策略进行流量负载均衡

配置步骤
----

1.  使用 **admin 权限**登录 NSX Manager：
    
    *   `https://<nsx-manager-ip-address>` 或
    *   `https://<nsx-manager-fqdn>`
2.  进入：
    
    *   **系统 → Fabric → 配置文件 → 上行链路配置文件 → 添加配置文件**

这样排版后，逻辑层次更清晰，便于快速查阅和理解。要不要我帮你做一个 **对比表格**（虚拟机 NSX Edge vs 裸机 NSX Edge）来更直观地展示差异？

创建上行链路配置文件
----------

打开NSX 管理界面 > 系统 > Fabric > 配置文件 > 添加上行链路配置文件

*   上行链路绑定 - 对应分布式交换机的uplink，可配置故障主备切换、负载均衡。uplink再对应每个主机的物理网卡。
*   传输VLAN - 建立Overlay网络的三层互通用VLAN。
*   MTU - 为空可使用全局。
*   LAG - 对应分布式交换机的LACP组

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165018295-457006001.png)

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165016306-855906483.png)

使用现有的hostswitch上行链路配置文件
-----------------------

### nsx-default-uplink-hostswitch-profile

默认uplink1 为主，uplink2为备。

### nsx-default-loadbalance-uplink-hostswitch-profile

将uplink1-4 作为负载均衡使用。

创建Overlay 传输区域
==============

什么是传输区域
-------

传输区域确定哪些主机传输节点可以参与使用特定的网络，进而确定哪些虚拟机可以参与使用该网络。传输区域通过限制可看到分段的主机（从而限制可连接到该分段的虚拟机）来实现该目的。传输区域可以跨一个或多个主机集群。此外，主机传输节点可以关联到多个传输区域。

根据您的要求， NSX 环境可能包含一个或多个传输区域。一个主机可以属于多个传输区域。一个分段只能属于一个传输区域。NSX 不允许连接位于第 2 层网络中的不同传输区域的虚拟机。分段的跨度限制为传输区域。主机传输节点和 NSX Edge 节点都使用覆盖网络和 VLAN 传输区域。在 NSX Edge 传输节点上配置 N-VDS 交换机时，主机传输节点将连接到 VDS 交换机。NSX Edge 和主机传输节点将 VLAN 传输区域用于其 VLAN 上行链路。在将 NSX Edge 添加到 VLAN 传输区域时，将在 NSX Edge 上安装 VLAN N-VDS。默认情况下存在以下系统生成的传输区域：

*   名为 nsx-vlan-transportzone 的 VLAN 传输区域。
*   名为 nsx-overlay-transportzone 的Overlay网络传输区域。

除了系统生成的默认传输区域外，还可以创建自定义 VLAN 和Overlay网络传输区域。

PS：Overlay（覆盖网络）传输区域可以理解一组建立VXLAN全互联的虚拟交换机，VLAN传输区域可以理解为分布式端口组。

系统 > Fabric > 传输区域 > 添加区域

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165016568-2058950703.png)

传输节点配置文件 TNP - 主机交换机hostswitch
==============================

主机交换机管理的对象是为网络中的各个主机提供网络连接服务的虚拟网络交换机。该对象会在加入 NSX 网络的每个主机上进行实例化。  
主机交换机是在各种 ESXi 主机上实施网络数据平面的虚拟交换机。NSX 主机交换机基于由 VMware vCenter 集中管理的 vSphere Distributed Switch (VDS)。VDS 交换机增强了一些 NSX 功能，并由 NSX Manager 集中管理。

创建TNP - 主机交换机hostswitch
-----------------------

### 打开NSX 管理界面 > 系统 > Fabric > 主机 > 传输节点配置文件 > 添加

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165018212-624957352.png)

### 点击设置添加主机交换机

*   选择vCenter，然后VDS
*   选择传输区域
*   选择上行链路配置文件
*   选择TEP分配使用IP池，然后选择已创建的IP池
*   上行链路映射：将上行链路配置文件的上行链路名称与VDS的上行链路名称做映射。

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165016709-2058044422.png)

将TNP关联到ESXi集群并安装NSX内核
---------------------

### 打开NSX 管理界面 > 系统 > Fabric > 主机 > 集群 > 勾选所需集群 > 配置NSX > 选择TNP文件

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165015970-1272389589.png)

### 查看NSX 配置状态状态 - 正常如下

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165017885-1048128438.png)

创建 Overlay 覆盖网络分段 - 虚拟机东西方向网络通信使用
=================================

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165016960-143740728.png)

当ESXi 主机上的虚拟机有连接Overlay网络，会互相建立隧道实现二层通信
---------------------------------------

![](https://img2024.cnblogs.com/blog/3352536/202512/3352536-20251231165018087-1966558142.png)