---
layout: post
title: 'Redisæ•°æ®æŒä¹…åŒ–ã€é«˜é˜¶æ•°æ®ç»“æ„ä¸äº‹åŠ¡è„šæœ¬ã€ç¬¬äºŒéƒ¨åˆ†ã€‘'
date: "2025-11-07T00:42:09Z"
---
Redisæ•°æ®æŒä¹…åŒ–ã€é«˜é˜¶æ•°æ®ç»“æ„ä¸äº‹åŠ¡è„šæœ¬ã€ç¬¬äºŒéƒ¨åˆ†ã€‘
============================

å¯ä»¥ç»“åˆä¹‹å‰çš„æ–‡ç« é…åˆå­¦ä¹ ï¼š[ã€ğŸ”¥RDBè¿˜æ˜¯AOF ? ã€‘RedisæŒä¹…åŒ–åŸç†å…¨æ™¯è§£è¯»ä¸ç”Ÿäº§çº§å†³ç­–æ‰‹å†Œ](https://www.cnblogs.com/sun-10387834/p/16479786.html)ã€[Redis](https://www.cnblogs.com/sun-10387834/p/19000717)

å¼•å­ï¼šRediså•†åŸçš„æ¶æ„æ¼”è¿›ä¹‹è·¯
-----------------

> åœ¨"Rediså•†åŸ"çš„æŠ€æœ¯å›¢é˜Ÿä¸­ï¼Œæ¶æ„å¸ˆå°æ˜æ­£é¢ä¸´ç€ä¸€ç³»åˆ—æŠ€æœ¯æŒ‘æˆ˜ã€‚è®©æˆ‘ä»¬è·Ÿéšä»–çš„è§†è§’ï¼Œæ·±å…¥æ¢ç´¢Redisçš„æŒä¹…åŒ–æœºåˆ¶ã€æ•°æ®ç»“æ„å®ç°åŸç†å’Œäº‹åŠ¡è„šæœ¬ï¼Œçœ‹çœ‹ä»–å¦‚ä½•ç”¨è¿™äº›è¿›é˜¶ç‰¹æ€§æ„å»ºç¨³å®šå¯é çš„ç”µå•†ç³»ç»Ÿã€‚

ç¬¬4ç« ï¼šRedisæŒä¹…åŒ–æœºåˆ¶ - æ•°æ®çš„"ç”Ÿæ­»ç°¿"
-------------------------

### 4.1 æƒŠé­‚ä¸€åˆ»ï¼šæœåŠ¡å™¨çªç„¶æ–­ç”µ

"å°æ˜ï¼Œä¸å¥½äº†ï¼æ˜¨æ™šæœºæˆ¿æ–­ç”µï¼ŒRedisæ•°æ®å¥½åƒä¸¢äº†ï¼"å‘¨ä¸€ä¸€æ—©ï¼Œè¿ç»´åŒäº‹å°ææ…Œå¼ åœ°è·‘è¿›åŠå…¬å®¤ã€‚

å°æ˜å´å¼‚å¸¸é•‡å®šï¼š"åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬çš„æ•°æ®æœ‰'ç”Ÿæ­»ç°¿'ä¿æŠ¤ã€‚è®©æˆ‘ç»™ä½ è®²è®²Redisçš„æŒä¹…åŒ–æœºåˆ¶..."

**ä»€ä¹ˆæ˜¯æŒä¹…åŒ–ï¼Ÿ** ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œé˜²æ­¢æœåŠ¡å™¨é‡å¯æˆ–æ•…éšœæ—¶æ•°æ®ä¸¢å¤±ã€‚Redisæä¾›äº†ä¸¤ç§ä¸»è¦çš„æŒä¹…åŒ–æ–¹å¼ï¼šRDBå’ŒAOFã€‚

### 4.2 RDBï¼šæ•°æ®çš„"æ—¶å…‰å¿«ç…§" - æ·±å…¥åŸç†

æƒ³è±¡ä¸€ä¸‹ï¼ŒRDBå°±åƒç»™æ•°æ®åº“æ‹ç…§ç‰‡ã€‚åœ¨ç‰¹å®šæ—¶åˆ»ï¼ŒRedisä¼šæŠŠæ‰€æœ‰æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªå‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚

**æ ¸å¿ƒåŸç†è¯¦è§£ï¼š**

**1\. Forkå†™æ—¶å¤åˆ¶æœºåˆ¶**

    # æŸ¥çœ‹è¿›ç¨‹å…³ç³»ï¼Œç†è§£forkåŸç†
    ps -ef | grep redis
    # çˆ¶è¿›ç¨‹ID(PPID)å’Œå­è¿›ç¨‹ID(PID)çš„å…³ç³»å±•ç¤ºäº†forkè¿‡ç¨‹
    

å½“æ‰§è¡Œ`BGSAVE`æ—¶ï¼ŒRedisä¸»è¿›ç¨‹ä¼šforkä¸€ä¸ªå­è¿›ç¨‹ã€‚è¿™ä¸ªå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹å…±äº«å†…å­˜æ•°æ®é¡µã€‚åªæœ‰å½“çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹è¦ä¿®æ”¹æŸä¸ªæ•°æ®é¡µæ—¶ï¼Œæ‰ä¼šå¤åˆ¶è¯¥é¡µï¼Œè¿™å°±æ˜¯"å†™æ—¶å¤åˆ¶"ã€‚

**2\. å¿«ç…§ç”Ÿæˆæµç¨‹**

*   ä¸»è¿›ç¨‹æ¥æ”¶`BGSAVE`å‘½ä»¤
*   ä¸»è¿›ç¨‹forkå­è¿›ç¨‹ï¼ˆæ­¤æ—¶å†…å­˜æ•°æ®è¢«å†»ç»“ï¼‰
*   å­è¿›ç¨‹å°†å†…å­˜æ•°æ®åºåˆ—åŒ–åˆ°ä¸´æ—¶RDBæ–‡ä»¶
*   å­è¿›ç¨‹ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢æ—§RDBæ–‡ä»¶
*   å­è¿›ç¨‹é€€å‡ºï¼Œä¸»è¿›ç¨‹ç»§ç»­æœåŠ¡

**3\. RDBæ–‡ä»¶ç»“æ„åˆ†æ**

    +----------------+----------+------------+-----------+-----------+
    | REDISé­”æ•°(5å­—èŠ‚) | RDBç‰ˆæœ¬(4å­—èŠ‚) | æ•°æ®åº“æ•°æ® | ...æ›´å¤šDB | ç»“æŸç¬¦(1å­—èŠ‚) |
    +----------------+----------+------------+-----------+-----------+
    

**Linux Rediså‘½ä»¤å®æˆ˜ï¼š**

    # æŸ¥çœ‹RDBé…ç½®
    redis-cli config get save
    # è¾“å‡ºï¼š1) "save" 2) "900 1 300 10 60 10000"
    
    # æŸ¥çœ‹RDBæ–‡ä»¶ä¿¡æ¯
    redis-cli info persistence | grep -A 10 rdb
    # ä¼šæ˜¾ç¤ºæœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´ã€æ˜¯å¦åœ¨æ‰§è¡Œç­‰çŠ¶æ€
    
    # æ‰‹åŠ¨ç«‹å³ç”ŸæˆRDBå¿«ç…§ï¼ˆåŒæ­¥ï¼Œä¼šé˜»å¡ï¼‰
    redis-cli save
    
    # åå°ç”ŸæˆRDBå¿«ç…§ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
    redis-cli bgsave
    
    # æ£€æŸ¥RDBæ–‡ä»¶
    ls -lh /var/lib/redis/dump.rdb
    file dump.rdb  # æŸ¥çœ‹æ–‡ä»¶ç±»å‹
    

**Spring Bootä»£ç ç¤ºä¾‹ï¼šRDBå¤‡ä»½ç›‘æ§ç³»ç»Ÿ**

    @Service
    public class RDBMonitorService {
        
        private final RedisTemplate<String, Object> redisTemplate;
        
        public RDBMonitorService(RedisTemplate<String, Object> redisTemplate) {
            this.redisTemplate = redisTemplate;
        }
        
        /**
         * è·å–RDBæŒä¹…åŒ–çŠ¶æ€è¯¦æƒ…
         * å¸®åŠ©ç†è§£RDBçš„æ‰§è¡Œè¿‡ç¨‹å’ŒçŠ¶æ€
         */
        public Map<String, Object> getRDBStatus() {
            Map<String, Object> status = new HashMap<>();
            
            try {
                // è·å–æŒä¹…åŒ–ä¿¡æ¯
                Properties info = redisTemplate.getRequiredConnectionFactory()
                    .getConnection().info("persistence");
                
                // RDBç›¸å…³çŠ¶æ€
                status.put("rdb_bgsave_in_progress", info.getProperty("rdb_bgsave_in_progress"));
                status.put("rdb_last_save_time", info.getProperty("rdb_last_save_time"));
                status.put("rdb_last_bgsave_status", info.getProperty("rdb_last_bgsave_status"));
                status.put("rdb_last_bgsave_time_sec", info.getProperty("rdb_last_bgsave_time_sec"));
                status.put("rdb_current_bgsave_time_sec", info.getProperty("rdb_current_bgsave_time_sec"));
                
                // è§£é‡ŠçŠ¶æ€å«ä¹‰
                String explanation = explainRDBStatus(info);
                status.put("status_explanation", explanation);
                
            } catch (Exception e) {
                status.put("error", e.getMessage());
            }
            
            return status;
        }
        
        private String explainRDBStatus(Properties info) {
            StringBuilder explanation = new StringBuilder();
            
            String inProgress = info.getProperty("rdb_bgsave_in_progress");
            if ("1".equals(inProgress)) {
                explanation.append("ğŸ”µ RDBå¿«ç…§æ­£åœ¨åå°æ‰§è¡Œä¸­...\n");
                String currentTime = info.getProperty("rdb_current_bgsave_time_sec");
                explanation.append("   å·²æ‰§è¡Œæ—¶é—´: ").append(currentTime).append("ç§’\n");
            } else {
                explanation.append("ğŸŸ¢ RDBå¿«ç…§å½“å‰æœªæ‰§è¡Œ\n");
            }
            
            String lastStatus = info.getProperty("rdb_last_bgsave_status");
            if ("ok".equals(lastStatus)) {
                explanation.append("âœ… æœ€åä¸€æ¬¡RDBä¿å­˜æˆåŠŸ\n");
            } else {
                explanation.append("âŒ æœ€åä¸€æ¬¡RDBä¿å­˜å¤±è´¥\n");
            }
            
            String lastSaveTime = info.getProperty("rdb_last_save_time");
            if (lastSaveTime != null) {
                Date saveTime = new Date(Long.parseLong(lastSaveTime) * 1000);
                explanation.append("ğŸ“… æœ€åä¸€æ¬¡ä¿å­˜æ—¶é—´: ").append(saveTime).append("\n");
            }
            
            return explanation.toString();
        }
        
        /**
         * æ¨¡æ‹ŸRDBä¿å­˜è¿‡ç¨‹çš„èµ„æºç›‘æ§
         */
        public void monitorBGSaveProcess() {
            System.out.println("=== RDB BGSAVE è¿‡ç¨‹ç›‘æ§ ===");
            
            // è§¦å‘BGSAVE
            redisTemplate.getConnectionFactory().getConnection().bgSave();
            
            // ç›‘æ§è¿‡ç¨‹
            for (int i = 0; i < 10; i++) {
                Map<String, Object> status = getRDBStatus();
                System.out.println("ç›‘æ§ç‚¹ " + i + ": " + status.get("status_explanation"));
                
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    break;
                }
            }
        }
    }
    

### 4.3 AOFï¼šæ•°æ®çš„"æ“ä½œæ—¥è®°" - æ·±å…¥åŸç†

å¦‚æœè¯´RDBæ˜¯æ‹ç…§ï¼Œé‚£ä¹ˆAOFå°±æ˜¯å†™æ—¥è®°ã€‚å®ƒè®°å½•æ¯ä¸€ä¸ªå†™æ“ä½œå‘½ä»¤ï¼Œé€šè¿‡é‡æ–°æ‰§è¡Œè¿™äº›å‘½ä»¤æ¥æ¢å¤æ•°æ®ã€‚

**AOFå·¥ä½œåŸç†æ·±åº¦è§£æï¼š**

**1\. å‘½ä»¤ä¼ æ’­æµç¨‹**

    å®¢æˆ·ç«¯å‘½ä»¤ â†’ RedisæœåŠ¡å™¨ â†’ AOFç¼“å†²åŒº â†’ æ“ä½œç³»ç»Ÿç¼“å†²åŒº â†’ ç£ç›˜æ–‡ä»¶
    

**2\. ä¸‰ç§åŒæ­¥ç­–ç•¥çš„åº•å±‚å®ç°**

*   **always**ï¼šæ¯ä¸ªå‘½ä»¤éƒ½è°ƒç”¨`fsync()`åˆ·ç›˜
*   **everysec**ï¼šåå°çº¿ç¨‹æ¯ç§’è°ƒç”¨ä¸€æ¬¡`fsync()`
*   **no**ï¼šç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œé€šå¸¸30ç§’åˆ·ç›˜ä¸€æ¬¡

**3\. AOFé‡å†™æœºåˆ¶è¯¦è§£**

**ä¸ºä»€ä¹ˆéœ€è¦é‡å†™ï¼Ÿ**

    # æŸ¥çœ‹AOFæ–‡ä»¶å†…å®¹ï¼Œç†è§£é‡å†™çš„å¿…è¦æ€§
    redis-cli set counter 1
    redis-cli incr counter
    redis-cli incr counter
    # ...æ‰§è¡Œ100æ¬¡incr
    # AOFæ–‡ä»¶ä¼šè®°å½•100æ¡å‘½ä»¤ï¼Œä½†å…¶å®åªéœ€è¦1æ¡setå‘½ä»¤
    

**é‡å†™è¿‡ç¨‹ï¼š**

*   ä¸»è¿›ç¨‹forkå­è¿›ç¨‹
*   å­è¿›ç¨‹éå†æ•°æ®åº“ï¼Œç”Ÿæˆæ–°çš„AOFæ–‡ä»¶
*   ä¸»è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤ï¼ŒåŒæ—¶å°†æ–°å‘½ä»¤å†™å…¥AOFç¼“å†²åŒºå’Œé‡å†™ç¼“å†²åŒº
*   å­è¿›ç¨‹å®Œæˆé‡å†™åï¼Œä¸»è¿›ç¨‹å°†é‡å†™ç¼“å†²åŒºçš„å‘½ä»¤è¿½åŠ åˆ°æ–°AOFæ–‡ä»¶
*   åŸå­æ›¿æ¢æ—§AOFæ–‡ä»¶

**Linux Rediså‘½ä»¤å®æˆ˜ï¼š**

    # æŸ¥çœ‹AOFé…ç½®
    redis-cli config get appendonly
    redis-cli config get appendfsync
    
    # æŸ¥çœ‹AOFæ–‡ä»¶çŠ¶æ€
    redis-cli info persistence | grep -A 15 aof
    
    # æ‰‹åŠ¨è§¦å‘AOFé‡å†™
    redis-cli bgrewriteaof
    
    # æŸ¥çœ‹AOFæ–‡ä»¶å†…å®¹ï¼ˆå°å¿ƒï¼Œæ–‡ä»¶å¯èƒ½å¾ˆå¤§ï¼‰
    head -n 100 appendonly.aof
    # ä½ ä¼šçœ‹åˆ°Redisåè®®æ ¼å¼çš„å‘½ä»¤è®°å½•
    
    # ç›‘æ§AOFé‡å†™è¿‡ç¨‹
    while true; do
        redis-cli info persistence | grep aof_rewrite_in_progress
        sleep 1
    done
    

**Spring Bootä»£ç ç¤ºä¾‹ï¼šAOFçŠ¶æ€ç›‘æ§ä¸åˆ†æ**

    @Service
    public class AOFMonitorService {
        
        private final RedisTemplate<String, Object> redisTemplate;
        
        public AOFMonitorService(RedisTemplate<String, Object> redisTemplate) {
            this.redisTemplate = redisTemplate;
        }
        
        /**
         * æ·±åº¦åˆ†æAOFçŠ¶æ€å’Œæ€§èƒ½å½±å“
         */
        public Map<String, Object> getAOFDeepAnalysis() {
            Map<String, Object> analysis = new HashMap<>();
            
            try {
                Properties info = redisTemplate.getRequiredConnectionFactory()
                    .getConnection().info("persistence");
                
                // AOFåŸºç¡€çŠ¶æ€
                analysis.put("aof_enabled", info.getProperty("aof_enabled"));
                analysis.put("aof_rewrite_in_progress", info.getProperty("aof_rewrite_in_progress"));
                analysis.put("aof_rewrite_scheduled", info.getProperty("aof_rewrite_scheduled"));
                
                // AOFæ–‡ä»¶å¤§å°ä¿¡æ¯
                analysis.put("aof_current_size", formatBytes(info.getProperty("aof_current_size")));
                analysis.put("aof_base_size", formatBytes(info.getProperty("aof_base_size")));
                analysis.put("aof_buffer_length", formatBytes(info.getProperty("aof_buffer_length")));
                
                // æ€§èƒ½æŒ‡æ ‡
                analysis.put("aof_last_rewrite_time_sec", info.getProperty("aof_last_rewrite_time_sec"));
                analysis.put("aof_current_rewrite_time_sec", info.getProperty("aof_current_rewrite_time_sec"));
                
                // ç”Ÿæˆåˆ†ææŠ¥å‘Š
                analysis.put("analysis_report", generateAOFReport(info));
                
            } catch (Exception e) {
                analysis.put("error", e.getMessage());
            }
            
            return analysis;
        }
        
        private String generateAOFReport(Properties info) {
            StringBuilder report = new StringBuilder();
            
            // AOFçŠ¶æ€åˆ†æ
            if ("1".equals(info.getProperty("aof_rewrite_in_progress"))) {
                report.append("ğŸ”„ AOFé‡å†™æ­£åœ¨è¿›è¡Œä¸­\n");
                report.append("   å½“å‰å·²æ‰§è¡Œ: ").append(info.getProperty("aof_current_rewrite_time_sec")).append("ç§’\n");
            }
            
            // æ–‡ä»¶å¤§å°åˆ†æ
            long currentSize = Long.parseLong(info.getProperty("aof_current_size", "0"));
            long baseSize = Long.parseLong(info.getProperty("aof_base_size", "0"));
            
            if (baseSize > 0) {
                double growthRate = (double) (currentSize - baseSize) / baseSize * 100;
                report.append(String.format("ï¿½ AOFæ–‡ä»¶å¢é•¿: %.2f%%\n", growthRate));
                
                if (growthRate > 100) {
                    report.append("ğŸ’¡ å»ºè®®ï¼šAOFæ–‡ä»¶å¢é•¿è¾ƒå¿«ï¼Œè€ƒè™‘è°ƒæ•´é‡å†™é…ç½®\n");
                }
            }
            
            // æ€§èƒ½åˆ†æ
            String lastRewriteTime = info.getProperty("aof_last_rewrite_time_sec");
            if (lastRewriteTime != null) {
                int rewriteSeconds = Integer.parseInt(lastRewriteTime);
                if (rewriteSeconds > 10) {
                    report.append("âš ï¸  æœ€åä¸€æ¬¡é‡å†™è€—æ—¶").append(rewriteSeconds).append("ç§’ï¼Œè€ƒè™‘åœ¨ä½å³°æœŸæ‰§è¡Œ\n");
                }
            }
            
            return report.toString();
        }
        
        private String formatBytes(String bytesStr) {
            if (bytesStr == null) return "0 B";
            long bytes = Long.parseLong(bytesStr);
            
            if (bytes < 1024) return bytes + " B";
            if (bytes < 1024 * 1024) return String.format("%.2f KB", bytes / 1024.0);
            if (bytes < 1024 * 1024 * 1024) return String.format("%.2f MB", bytes / (1024.0 * 1024));
            return String.format("%.2f GB", bytes / (1024.0 * 1024 * 1024));
        }
        
        /**
         * æ¨¡æ‹ŸAOFé‡å†™è§¦å‘çš„æ¡ä»¶
         */
        public void demonstrateAOFRewriteTrigger() {
            System.out.println("=== AOFé‡å†™è§¦å‘æ¡ä»¶æ¼”ç¤º ===");
            
            // æ¨¡æ‹Ÿå¤§é‡å°å‘½ä»¤ï¼Œè§¦å‘AOFé‡å†™æ¡ä»¶
            for (int i = 0; i < 1000; i++) {
                redisTemplate.opsForValue().set("test:key:" + i, "value:" + i);
                redisTemplate.delete("test:key:" + i); // åˆ›å»ºå†—ä½™å‘½ä»¤
            }
            
            System.out.println("å·²åˆ›å»ºå¤§é‡å†—ä½™å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ˜¾è‘—å¢é•¿");
            System.out.println("å½“aof-current-size > aof-base-size * å¢é•¿ç‡æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘é‡å†™");
        }
    }
    

### 4.4 æ··åˆæŒä¹…åŒ–ï¼šé±¼ä¸ç†ŠæŒå…¼å¾—

Redis 4.0å¼•å…¥äº†æ··åˆæŒä¹…åŒ–ï¼Œå®Œç¾ç»“åˆäº†RDBå’ŒAOFçš„ä¼˜åŠ¿ã€‚

**æ··åˆæŒä¹…åŒ–æ·±åº¦åŸç†ï¼š**

**æ–‡ä»¶æ ¼å¼ï¼š**

    [RDBæ•°æ®éƒ¨åˆ†] + [AOFå‘½ä»¤éƒ¨åˆ†]
    

**æ¢å¤è¿‡ç¨‹ï¼š**

1.  åŠ è½½RDBéƒ¨åˆ†ï¼šå¿«é€Ÿæ¢å¤åŸºç¡€æ•°æ®å¿«ç…§
2.  é‡æ”¾AOFéƒ¨åˆ†ï¼šåº”ç”¨å¢é‡å˜æ›´ï¼Œä¿è¯æ•°æ®æœ€æ–°

**é…ç½®éªŒè¯ï¼š**

    # æ£€æŸ¥æ··åˆæŒä¹…åŒ–é…ç½®
    redis-cli config get aof-use-rdb-preamble
    
    # æŸ¥çœ‹AOFæ–‡ä»¶å¼€å¤´ï¼Œç¡®è®¤æ··åˆæ ¼å¼
    head -c 100 appendonly.aof | file -
    # å¦‚æœæ˜¾ç¤ºRedis RDBï¼Œè¯´æ˜æ˜¯æ··åˆæ ¼å¼
    

ç¬¬5ç« ï¼šRedisæ ¸å¿ƒæ•°æ®ç»“æ„(ä¸‹) - æ·±å…¥å®ç°åŸç†
---------------------------

### 5.1 æ•°æ®ç»“æ„å®ç°åŸç†æ·±åº¦è§£æ

#### 5.1.1 Stringï¼šç®€å•ä¸ç®€å•çš„åŠ¨æ€å­—ç¬¦ä¸²

**åº•å±‚å®ç°ï¼šSDSï¼ˆSimple Dynamic Stringï¼‰**

    struct sdshdr {
        int len;        // å·²ä½¿ç”¨é•¿åº¦
        int free;       // å‰©ä½™ç©ºé—´
        char buf[];     // å­—ç¬¦æ•°ç»„
    };
    

**è®¾è®¡ä¼˜åŠ¿ï¼š**

*   O(1)æ—¶é—´å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦
*   æœç»ç¼“å†²åŒºæº¢å‡º
*   å‡å°‘å†…å­˜é‡åˆ†é…æ¬¡æ•°
*   äºŒè¿›åˆ¶å®‰å…¨

#### 5.1.2 Hashï¼šä¸¤ç§ç¼–ç çš„æ™ºèƒ½åˆ‡æ¢

**ç¼–ç æ–¹å¼ï¼š**

*   **ziplistï¼ˆå‹ç¼©åˆ—è¡¨ï¼‰**ï¼šå…ƒç´ æ•°é‡ < 512 ä¸” æ‰€æœ‰å€¼ < 64å­—èŠ‚
*   **hashtableï¼ˆå“ˆå¸Œè¡¨ï¼‰**ï¼šé»˜è®¤ä½¿ç”¨dictå®ç°

**ziplistç»“æ„ï¼š**

    +--------+--------+--------+--------+--------+--------+
    | zlbytes | zltail | zllen | entry1 | entry2 | zlend  |
    +--------+--------+--------+--------+--------+--------+
    

#### 5.1.3 Listï¼šquicklistçš„å¹³è¡¡è‰ºæœ¯

**æ¼”è¿›å†å²ï¼š**

*   Redis 3.2å‰ï¼šziplist æˆ– linkedlist
*   Redis 3.2åï¼šquicklistï¼ˆziplist + linkedlistï¼‰

**quicklistèŠ‚ç‚¹ï¼š**

    +----------+----------+----------+
    | prevæŒ‡é’ˆ | ziplist  | nextæŒ‡é’ˆ |
    +----------+----------+----------+
    

#### 5.1.4 Setï¼šæ•´æ•°é›†ä¸å“ˆå¸Œè¡¨çš„æŠ‰æ‹©

**ç¼–ç åˆ‡æ¢æ¡ä»¶ï¼š**

*   intsetï¼šæ‰€æœ‰å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ æ•°é‡ â‰¤ 512
*   hashtableï¼šå…¶ä»–æƒ…å†µ

#### 5.1.5 ZSetï¼šè·³è·ƒè¡¨ä¸å­—å…¸çš„åå¥æ›²

**åº•å±‚ç»“æ„ï¼š**

    typedef struct zset {
        dict *dict;              // å­—å…¸ï¼šmember -> score
        zskiplist *zsl;          // è·³è·ƒè¡¨ï¼šæŒ‰scoreæ’åº
    } zset;
    

**è·³è·ƒè¡¨åŸç†ï¼š**

*   å¤šå±‚é“¾è¡¨ç»“æ„ï¼Œä¸Šå±‚æ˜¯ä¸‹å±‚çš„"å¿«é€Ÿé€šé“"
*   æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ï¼šå¹³å‡O(logN)ï¼Œæœ€åO(N)

### 5.2 HyperLogLogï¼šæ¦‚ç‡ç®—æ³•çš„é­”æ³•

**æ ¸å¿ƒåŸç†ï¼šä¼¯åŠªåˆ©è¯•éªŒ**

æƒ³è±¡ä¸€ä¸‹æŠ›ç¡¬å¸ï¼Œç›´åˆ°å‡ºç°æ­£é¢ä¸ºæ­¢çš„æ¬¡æ•°kã€‚HyperLogLogç”¨åŒæ ·çš„åŸç†ä¼°ç®—åŸºæ•°ã€‚

**ç®—æ³•æ­¥éª¤ï¼š**

1.  å“ˆå¸Œå‡½æ•°å°†å…ƒç´ æ˜ å°„ä¸º64ä½æ•´æ•°
2.  ç»Ÿè®¡å‰å¯¼0çš„æ•°é‡
3.  ä½¿ç”¨è°ƒå’Œå¹³å‡æ•°å‡å°‘è¯¯å·®

**å†…å­˜ä½¿ç”¨ï¼š** å›ºå®š16384ä¸ªå¯„å­˜å™¨ Ã— 6bit = 12KB

### 5.3 Bitmapï¼šä½æ“ä½œçš„æè‡´åˆ©ç”¨

**åº•å±‚å®ç°ï¼š** åŸºäºStringç±»å‹ï¼Œæ¯ä¸ªbitä½ä»£è¡¨ä¸€ä¸ªçŠ¶æ€

**å†…å­˜è®¡ç®—ï¼š**

    // è®¡ç®—100ä¸‡ç”¨æˆ·ç­¾åˆ°æ‰€éœ€å†…å­˜
    int totalUsers = 1000000;
    int bitsPerUser = 31; // æ¯æœˆ31å¤©
    int totalBits = totalUsers * bitsPerUser;
    int totalBytes = totalBits / 8;
    System.out.println("æ‰€éœ€å†…å­˜: " + totalBytes + " bytes"); // çº¦3.7MB
    

### 5.4 Streamï¼šæ¶ˆæ¯é˜Ÿåˆ—çš„å®Œå–„å®ç°

**åº•å±‚ç»“æ„ï¼š** raxï¼ˆåŸºæ•°æ ‘ï¼‰ + listpack

**æ¶ˆæ¯IDç»“æ„ï¼š**

    æ¯«ç§’æ—¶é—´æˆ³-åºåˆ—å·
    

**æ¶ˆè´¹è€…ç»„åŸç†ï¼š**

*   pending\_idsï¼šå·²å‘é€ä½†æœªç¡®è®¤çš„æ¶ˆæ¯
*   last\_delivered\_idï¼šæœ€åæŠ•é€’çš„æ¶ˆæ¯ID

ç¬¬6ç« ï¼šRedisäº‹åŠ¡ä¸Luaè„šæœ¬ - æ·±åº¦æ¢ç´¢
------------------------

### 6.1 äº‹åŠ¡åŸç†æ·±åº¦è§£æ

**Redisäº‹åŠ¡ç‰¹æ€§ï¼š**

*   **åŸå­æ€§**ï¼šäº‹åŠ¡ä¸­çš„å‘½ä»¤åºåˆ—åŒ–é¡ºåºæ‰§è¡Œ
*   **éš”ç¦»æ€§**ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­
*   **ä¸æ”¯æŒå›æ»š**ï¼šä¸æ•°æ®åº“äº‹åŠ¡ä¸åŒï¼ŒRedisäº‹åŠ¡æ²¡æœ‰å›æ»šæœºåˆ¶

**äº‹åŠ¡æ‰§è¡Œæµç¨‹ï¼š**

    MULTI â†’ å‘½ä»¤å…¥é˜Ÿ â†’ EXEC/DISCARD
    

**WATCHåŸç†ï¼š**

*   ä½¿ç”¨ä¹è§‚é”æœºåˆ¶
*   ç›‘æ§çš„keyè¢«ä¿®æ”¹æ—¶ï¼ŒEXECè¿”å›null
*   åŸºäºCASï¼ˆCompare and Swapï¼‰æ€æƒ³

### 6.2 Luaè„šæœ¬ï¼šåŸå­æ“ä½œçš„ç»ˆææ–¹æ¡ˆ

#### 6.2.1 Luaè„šæœ¬ç¼–å†™è¯¦è§£

**åŸºæœ¬ç»“æ„ï¼š**

    -- è„šæœ¬å¼€å§‹
    local key1 = KEYS[1]    -- è·å–ç¬¬ä¸€ä¸ªé”®
    local arg1 = ARGV[1]    -- è·å–ç¬¬ä¸€ä¸ªå‚æ•°
    local arg2 = ARGV[2]    -- è·å–ç¬¬äºŒä¸ªå‚æ•°
    
    -- ä¸šåŠ¡é€»è¾‘
    local current = redis.call('GET', key1)
    if not current then
        current = 0
    else
        current = tonumber(current)
    end
    
    -- æ¡ä»¶åˆ¤æ–­
    if current < tonumber(arg1) then
        redis.call('SET', key1, arg2)
        return "SUCCESS"
    else
        return "FAILED"
    end
    

**å˜é‡å¡«å……è§„åˆ™ï¼š**

*   `KEYS`æ•°ç»„ï¼šæ‰€æœ‰é”®åå‚æ•°
*   `ARGV`æ•°ç»„ï¼šæ‰€æœ‰éé”®åå‚æ•°
*   æ•°é‡å¿…é¡»ä¸¥æ ¼åŒ¹é…

#### 6.2.2 Luaè„šæœ¬æœ€ä½³å®è·µ

**1\. å‚æ•°éªŒè¯**

    -- æ£€æŸ¥å‚æ•°æ•°é‡
    if #KEYS ~= 1 then
        return redis.error_reply("Wrong number of keys")
    end
    
    if #ARGV ~= 2 then
        return redis.error_reply("Wrong number of arguments")
    end
    
    -- æ£€æŸ¥å‚æ•°ç±»å‹
    local limit = tonumber(ARGV[1])
    if not limit then
        return redis.error_reply("Limit must be a number")
    end
    

**2\. é”™è¯¯å¤„ç†**

    -- ä½¿ç”¨pcallè€Œä¸æ˜¯callè¿›è¡Œé”™è¯¯æ•è·
    local success, result = pcall(redis.call, 'GET', key)
    if not success then
        -- å¤„ç†é”™è¯¯
        return redis.error_reply("Error: " .. result)
    end
    

**3\. æ€§èƒ½ä¼˜åŒ–**

    -- ä½¿ç”¨å±€éƒ¨å˜é‡
    local get_cmd = redis.call
    local value = get_cmd('GET', key)
    
    -- é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨Rediså‘½ä»¤
    local results = {}
    for i = 1, #KEYS do
        results[i] = get_cmd('GET', KEYS[i])
    end
    

**Spring Bootä»£ç ç¤ºä¾‹ï¼šé«˜çº§Luaè„šæœ¬ç®¡ç†**

    @Service
    public class AdvancedLuaScriptService {
        
        private final RedisTemplate<String, Object> redisTemplate;
        private final Map<String, String> scriptCache = new ConcurrentHashMap<>();
        
        public AdvancedLuaScriptService(RedisTemplate<String, Object> redisTemplate) {
            this.redisTemplate = redisTemplate;
            preloadCommonScripts();
        }
        
        /**
         * é¢„åŠ è½½å¸¸ç”¨Luaè„šæœ¬
         */
        private void preloadCommonScripts() {
            // 1. é™æµè„šæœ¬
            String rateLimitScript = 
                "local key = KEYS[1] " +
                "local limit = tonumber(ARGV[1]) " +
                "local window = tonumber(ARGV[2]) " +
                " " +
                "local current = redis.call('GET', key) " +
                "if current == false then " +
                "    redis.call('SETEX', key, window, 1) " +
                "    return 1 " +
                "elseif tonumber(current) < limit then " +
                "    redis.call('INCR', key) " +
                "    return 1 " +
                "else " +
                "    return 0 " +
                "end";
            
            scriptCache.put("RATE_LIMIT", rateLimitScript);
            
            // 2. åº“å­˜æ‰£å‡è„šæœ¬
            String inventoryScript =
                "local product_key = KEYS[1] " +
                "local order_key = KEYS[2] " +
                "local user_id = ARGV[1] " +
                "local quantity = tonumber(ARGV[2]) " +
                " " +
                "-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²è´­ä¹° " +
                "if redis.call('SISMEMBER', order_key, user_id) == 1 then " +
                "    return 'ALREADY_PURCHASED' " +
                "end " +
                " " +
                "-- æ£€æŸ¥åº“å­˜ " +
                "local stock = tonumber(redis.call('GET', product_key)) " +
                "if not stock or stock < quantity then " +
                "    return 'OUT_OF_STOCK' " +
                "end " +
                " " +
                "-- æ‰£å‡åº“å­˜å¹¶è®°å½•è®¢å• " +
                "redis.call('DECRBY', product_key, quantity) " +
                "redis.call('SADD', order_key, user_id) " +
                " " +
                "return 'SUCCESS'";
            
            scriptCache.put("INVENTORY_DEDUCT", inventoryScript);
        }
        
        /**
         * æ‰§è¡ŒLuaè„šæœ¬çš„é€šç”¨æ–¹æ³•
         */
        public Object executeScript(String scriptName, List<String> keys, Object... args) {
            String scriptContent = scriptCache.get(scriptName);
            if (scriptContent == null) {
                throw new IllegalArgumentException("Script not found: " + scriptName);
            }
            
            DefaultRedisScript<String> script = new DefaultRedisScript<>();
            script.setScriptText(scriptContent);
            script.setResultType(String.class);
            
            return redisTemplate.execute(script, keys, args);
        }
        
        /**
         * åŠ¨æ€åŠ è½½å’Œç®¡ç†Luaè„šæœ¬
         */
        public String manageScript(String scriptName, String scriptContent) {
            try {
                // éªŒè¯è„šæœ¬è¯­æ³•
                String sha = redisTemplate.execute(
                    (RedisCallback<String>) connection -> 
                        connection.scriptLoad(scriptContent.getBytes())
                );
                
                // ç¼“å­˜è„šæœ¬
                scriptCache.put(scriptName, scriptContent);
                
                return "Script loaded successfully. SHA: " + sha;
                
            } catch (Exception e) {
                return "Script load failed: " + e.getMessage();
            }
        }
        
        /**
         * Luaè„šæœ¬è°ƒè¯•å·¥å…·
         */
        public String debugScript(String scriptContent, List<String> keys, Object... args) {
            StringBuilder debugInfo = new StringBuilder();
            debugInfo.append("=== Luaè„šæœ¬è°ƒè¯•ä¿¡æ¯ ===\n");
            
            debugInfo.append("KEYS: ").append(keys).append("\n");
            debugInfo.append("ARGV: ").append(Arrays.toString(args)).append("\n");
            
            // æ·»åŠ è¯­æ³•æ£€æŸ¥
            try {
                String sha = redisTemplate.execute(
                    (RedisCallback<String>) connection -> 
                        connection.scriptLoad(scriptContent.getBytes())
                );
                debugInfo.append("âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡\n");
                debugInfo.append("SHA1: ").append(sha).append("\n");
                
                // æ‰§è¡Œè„šæœ¬
                DefaultRedisScript<String> script = new DefaultRedisScript<>();
                script.setScriptText(scriptContent);
                script.setResultType(String.class);
                
                Object result = redisTemplate.execute(script, keys, args);
                debugInfo.append("æ‰§è¡Œç»“æœ: ").append(result).append("\n");
                
            } catch (Exception e) {
                debugInfo.append("âŒ è„šæœ¬é”™è¯¯: ").append(e.getMessage()).append("\n");
            }
            
            return debugInfo.toString();
        }
    }
    

#### 6.2.3 Luaè„šæœ¬å®æˆ˜ï¼šåˆ†å¸ƒå¼é”é«˜çº§å®ç°

    @Service
    public class DistributedLockService {
        
        private final RedisTemplate<String, Object> redisTemplate;
        
        public DistributedLockService(RedisTemplate<String, Object> redisTemplate) {
            this.redisTemplate = redisTemplate;
        }
        
        /**
         * é«˜çº§åˆ†å¸ƒå¼é”å®ç°
         * æ”¯æŒé‡å…¥ã€è‡ªåŠ¨ç»­æœŸã€è¶…æ—¶æ§åˆ¶
         */
        public boolean tryAcquireLock(String lockKey, String clientId, long expireSeconds) {
            String lockScript =
                "local key = KEYS[1] " +
                "local client = ARGV[1] " +
                "local expire = ARGV[2] " +
                " " +
                "-- æ£€æŸ¥æ˜¯å¦å·²è¢«é”å®š " +
                "local current = redis.call('GET', key) " +
                "if current == false then " +
                "    -- æœªé”å®šï¼Œè·å–é” " +
                "    redis.call('SETEX', key, expire, client) " +
                "    return 1 " +
                "elseif current == client then " +
                "    -- é‡å…¥é”ï¼Œæ›´æ–°è¿‡æœŸæ—¶é—´ " +
                "    redis.call('EXPIRE', key, expire) " +
                "    return 1 " +
                "else " +
                "    -- å·²è¢«å…¶ä»–å®¢æˆ·ç«¯é”å®š " +
                "    return 0 " +
                "end";
            
            DefaultRedisScript<Long> script = new DefaultRedisScript<>();
            script.setScriptText(lockScript);
            script.setResultType(Long.class);
            
            Long result = redisTemplate.execute(script, 
                Collections.singletonList(lockKey), clientId, String.valueOf(expireSeconds));
            
            return result != null && result == 1;
        }
        
        /**
         * é‡Šæ”¾åˆ†å¸ƒå¼é”
         */
        public boolean releaseLock(String lockKey, String clientId) {
            String unlockScript =
                "local key = KEYS[1] " +
                "local client = ARGV[1] " +
                " " +
                "-- æ£€æŸ¥é”çš„æŒæœ‰è€… " +
                "local current = redis.call('GET', key) " +
                "if current == client then " +
                "    redis.call('DEL', key) " +
                "    return 1 " +
                "else " +
                "    return 0 " +
                "end";
            
            DefaultRedisScript<Long> script = new DefaultRedisScript<>();
            script.setScriptText(unlockScript);
            script.setResultType(Long.class);
            
            Long result = redisTemplate.execute(script, 
                Collections.singletonList(lockKey), clientId);
            
            return result != null && result == 1;
        }
    }
    

æ€»ç»“ï¼šRedisè¿›é˜¶ç‰¹æ€§æ·±åº¦è§£æ
----------------

### æŠ€æœ¯åŸç†æ·±åº¦æ€»ç»“

**1\. æŒä¹…åŒ–æœºåˆ¶å¯¹æ¯”**

ç‰¹æ€§

RDB

AOF

æ··åˆæŒä¹…åŒ–

åŸç†

å†…å­˜å¿«ç…§

æ“ä½œæ—¥å¿—

RDB+AOFå¢é‡

æ¢å¤é€Ÿåº¦

å¿«

æ…¢

ä¸­ç­‰

æ•°æ®å®‰å…¨

å¯èƒ½ä¸¢æ•°æ®

é«˜

é«˜

æ–‡ä»¶å¤§å°

å°

å¤§

ä¸­ç­‰

**2\. æ•°æ®ç»“æ„å®ç°æ™ºæ…§**

*   **String**: SDSåŠ¨æ€å­—ç¬¦ä¸²ï¼Œç©ºé—´é¢„åˆ†é…
*   **Hash**: ziplistä¸hashtableæ™ºèƒ½åˆ‡æ¢
*   **List**: quicklistå¹³è¡¡å†…å­˜ä¸æ€§èƒ½
*   **Set**: intsetä¼˜åŒ–æ•´æ•°å­˜å‚¨
*   **ZSet**: è·³è·ƒè¡¨+å­—å…¸åŒç´¢å¼•

**3\. Luaè„šæœ¬è®¾è®¡å“²å­¦**

*   **åŸå­æ€§**: æ•´ä¸ªè„šæœ¬ä½œä¸ºä¸€ä¸ªå‘½ä»¤æ‰§è¡Œ
*   **æ€§èƒ½**: å‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæ‰¹é‡æ“ä½œ
*   **çµæ´»æ€§**: æ”¯æŒå¤æ‚ä¸šåŠ¡é€»è¾‘
*   **å®‰å…¨æ€§**: æ²™ç®±ç¯å¢ƒï¼Œå—é™åŠŸèƒ½

### æœ€ä½³å®è·µä¸æ€§èƒ½ä¼˜åŒ–

**æŒä¹…åŒ–é…ç½®å»ºè®®ï¼š**

    # ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
    save 900 1
    save 300 10
    save 60 10000
    appendonly yes
    aof-use-rdb-preamble yes
    aof-rewrite-incremental-fsync yes
    

**æ•°æ®ç»“æ„é€‰æ‹©æŒ‡å—ï¼š**

*   é¢‘ç¹æ›´æ–°çš„è®¡æ•°å™¨ï¼šString
*   å¯¹è±¡å±æ€§å­˜å‚¨ï¼šHash
*   æ—¶é—´çº¿æ•°æ®ï¼šList/Stream
*   å»é‡ç»Ÿè®¡ï¼šSet/HyperLogLog
*   æ’è¡Œæ¦œï¼šZSet
*   æ ‡ç­¾ç³»ç»Ÿï¼šSet/Bitmap

**Luaè„šæœ¬ç¼–å†™åŸåˆ™ï¼š**

1.  å‚æ•°éªŒè¯æ”¾åœ¨è„šæœ¬å¼€å¤´
2.  ä½¿ç”¨å±€éƒ¨å˜é‡æå‡æ€§èƒ½
3.  é¿å…åœ¨å¾ªç¯ä¸­è°ƒç”¨Rediså‘½ä»¤
4.  åˆç†ä½¿ç”¨KEYSå’ŒARGVå‚æ•°

> **æ¶æ„å¸ˆçš„æ€è€ƒ**ï¼šRedisçš„ä¼˜é›…ä¹‹å¤„åœ¨äºå®ƒçš„"ç®€å•ä¸­çš„å¤æ‚"ã€‚è¡¨é¢ç®€å•çš„APIèƒŒåï¼Œæ˜¯ç²¾å¦™çš„æ•°æ®ç»“æ„å’Œç®—æ³•è®¾è®¡ã€‚ç†è§£è¿™äº›åº•å±‚åŸç†ï¼Œæ‰èƒ½åœ¨å®é™…é¡¹ç›®ä¸­åšå‡ºæœ€åˆé€‚çš„æŠ€æœ¯é€‰å‹å’Œä¼˜åŒ–å†³ç­–ã€‚

* * *

**å®è·µæŒ‘æˆ˜**ï¼šåœ¨ä½ çš„é¡¹ç›®ä¸­å°è¯•å®ç°ä¸€ä¸ªåŸºäºLuaè„šæœ¬çš„å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚åˆ†å¸ƒå¼ç§’æ€æˆ–è€…å¤æ‚çš„çŠ¶æ€æœºï¼Œå¹¶åˆ†äº«ä½ çš„å®è·µç»éªŒï¼

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19196272](https://www.cnblogs.com/sun-10387834/p/19196272)