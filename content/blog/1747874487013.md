---
layout: post
title: 'ç©è½¬C++11å¤šçº¿ç¨‹ï¼šè®©ä½ çš„ç¨‹åºé£èµ·æ¥çš„std::threadç»ˆææŒ‡å—'
date: "2025-05-22T00:41:27Z"
---
ç©è½¬C++11å¤šçº¿ç¨‹ï¼šè®©ä½ çš„ç¨‹åºé£èµ·æ¥çš„std::threadç»ˆææŒ‡å—
===================================

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°åº·ã€‚

ä½ è¿˜åœ¨ä¸º C++ å¤šçº¿ç¨‹ç¼–ç¨‹å‘æ„å—ï¼Ÿåˆ«æ‹…å¿ƒï¼Œä»Šå¤©å’±ä»¬å°±ç”¨å¤§ç™½è¯å½»åº•æå®šstd::threadï¼çœ‹å®Œè¿™ç¯‡ï¼Œä¿è¯ä½ å¯¹C++11å¤šçº¿ç¨‹çš„ç†è§£ä»"ä¸€è„¸æ‡µé€¼"å˜æˆ"åŸæ¥å¦‚æ­¤"ï¼

å‰è¨€ï¼šä¸ºå•¥è¦å­¦å¤šçº¿ç¨‹ï¼Ÿ
-----------

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨å¨æˆ¿åšé¥­ã€‚å¦‚æœä½ æ˜¯å•çº¿ç¨‹å·¥ä½œï¼Œé‚£å°±åªèƒ½å…ˆåˆ‡èœï¼Œåˆ‡å®Œå†ç‚’èœï¼Œç‚’å®Œå†ç…®æ±¤...ä¸€é¡¹ä¸€é¡¹æŒ‰é¡ºåºæ¥ã€‚ä½†ç°å®ä¸­çš„ä½ è‚¯å®šæ˜¯å¤šçº¿ç¨‹æ“ä½œå•Šï¼šé”…é‡Œç‚’ç€èœï¼ŒåŒæ—¶æ—è¾¹çš„ç”µé¥­ç…²åœ¨ç…®é¥­ï¼Œçƒ­æ°´å£¶åœ¨çƒ§æ°´ï¼Œä¹Ÿè®¸ä½ è¿˜èƒ½åŒæ—¶çœ‹çœ‹æ‰‹æœº...è¿™å°±æ˜¯å¤šçº¿ç¨‹çš„å¨åŠ›ï¼

åœ¨ç¨‹åºä¸–ç•Œé‡Œï¼Œå¤šçº¿ç¨‹å°±åƒå¤šäº†å‡ ä¸ª"åˆ†èº«"ï¼Œå¯ä»¥åŒæ—¶å¤„ç†ä¸åŒçš„ä»»åŠ¡ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„æ€§èƒ½ï¼Œè®©ç¨‹åºè·‘å¾—é£å¿«ã€‚ç‰¹åˆ«æ˜¯ç°åœ¨è°çš„ç”µè„‘ä¸æ˜¯å¤šæ ¸å•Šï¼Œä¸ç”¨å¤šçº¿ç¨‹ç®€ç›´æ˜¯æµªè´¹èµ„æºï¼

C++11æ ‡å‡†ç»ˆäºç»™æˆ‘ä»¬å¸¦æ¥äº†å®˜æ–¹çš„å¤šçº¿ç¨‹æ”¯æŒâ€”â€”std::threadï¼Œä»æ­¤ä¸ç”¨å†ä¾èµ–æ“ä½œç³»ç»Ÿç‰¹å®šçš„APIæˆ–ç¬¬ä¸‰æ–¹åº“ï¼Œå†™å¤šçº¿ç¨‹ç¨‹åºæ–¹ä¾¿å¤šäº†ï¼

> å¾®ä¿¡æœç´¢ ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œå…³æ³¨æˆ‘ï¼Œåç»­è¿˜æœ‰æ›´å¤šç¡¬æ ¸æŠ€æœ¯æ–‡ç« åˆ†äº«ï¼Œå¸¦ä½ ç©è½¬ Linux C/C++ ç¼–ç¨‹ï¼ğŸ˜†

ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹
-------------

å¥½ï¼Œé—²è¯å°‘è¯´ï¼Œç›´æ¥ä¸Šä»£ç çœ‹çœ‹æ€ä¹ˆåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼š

    #include <iostream>
    #include <thread>
    
    // è¿™æ˜¯æˆ‘ä»¬è¦åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œçš„å‡½æ•°
    void hello_thread() {
        std::cout << "å“ˆå–½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼" << std::endl;
    }
    
    int main() {
        // åˆ›å»ºä¸€ä¸ªæ‰§è¡Œhello_threadå‡½æ•°çš„çº¿ç¨‹
        std::thread t(hello_thread);
    
        // ä¸»çº¿ç¨‹æ‰“ä¸ªæ‹›å‘¼
        std::cout << "ä¸»çº¿ç¨‹ï¼šæˆ‘æ­£åœ¨ç­‰ä¸€ä¸ªçº¿ç¨‹å¹²æ´»..." << std::endl;
    
        // ç­‰å¾…çº¿ç¨‹å®Œæˆ
        t.join();
    
        std::cout << "æ‰€æœ‰çº¿ç¨‹éƒ½ç»“æŸäº†ï¼Œç¨‹åºé€€å‡ºï¼" << std::endl;
        return 0;
    }
    

è¾“å‡ºç»“æœå¯èƒ½æ˜¯ï¼š

    ä¸»çº¿ç¨‹ï¼šæˆ‘æ­£åœ¨ç­‰ä¸€ä¸ªçº¿ç¨‹å¹²æ´»...
    å“ˆå–½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼
    æ‰€æœ‰çº¿ç¨‹éƒ½ç»“æŸäº†ï¼Œç¨‹åºé€€å‡ºï¼
    

æˆ–è€…æ˜¯ï¼š

    å“ˆå–½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹ï¼
    ä¸»çº¿ç¨‹ï¼šæˆ‘æ­£åœ¨ç­‰ä¸€ä¸ªçº¿ç¨‹å¹²æ´»...
    æ‰€æœ‰çº¿ç¨‹éƒ½ç»“æŸäº†ï¼Œç¨‹åºé€€å‡ºï¼
    

å’¦ï¼Ÿä¸ºå•¥è¾“å‡ºé¡ºåºä¸å›ºå®šï¼Ÿå› ä¸ºä¸¤ä¸ªçº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè°å…ˆæ‰“å°å®Œå…¨çœ‹ CPU çš„å¿ƒæƒ…ï¼è¿™å°±æ˜¯å¤šçº¿ç¨‹çš„ç‰¹ç‚¹â€”â€”ä¸ç¡®å®šæ€§ã€‚

### ä»£ç è§£æï¼š

åˆ›å»ºçº¿ç¨‹è¶…ç®€å•ï¼Œå°±ä¸€è¡Œä»£ç ï¼š`std::thread t(hello_thread);`ã€‚çº¿ç¨‹ä¸€åˆ›å»ºå°±ç«‹åˆ»å¼€å§‹æ‰§è¡Œäº†ï¼Œå°±åƒæ”¾å‡ºå»çš„ç‚®å¼¹ï¼Œå‘å°„äº†å°±æ”¶ä¸å›æ¥äº†ã€‚

`t.join()` æ˜¯å•¥æ„æ€å‘¢ï¼Ÿå®ƒç›¸å½“äºè¯´ï¼š"ä¸»çº¿ç¨‹ï¼Œä½ ç­‰ç­‰è¿™ä¸ªæ–°çº¿ç¨‹ï¼Œç­‰å®ƒå¹²å®Œæ´»å†ç»§ç»­"ã€‚å¦‚æœæ²¡æœ‰è¿™è¡Œï¼Œä¸»çº¿ç¨‹å¯èƒ½æå‰ç»“æŸï¼Œç¨‹åºå°±å´©æºƒäº†ï¼

ç»™çº¿ç¨‹ä¼ å‚æ•°
------

çº¿ç¨‹ä¸èƒ½åªä¼šå–Š"å“ˆå–½"å§ï¼Ÿæˆ‘ä»¬å¾—ç»™å®ƒç‚¹å®é™…ä»»åŠ¡ï¼Œè¿˜å¾—å‘Šè¯‰å®ƒä¸€äº›å‚æ•°ã€‚ä¼ å‚æ•°è¶…ç®€å•ï¼š

    #include <iostream>
    #include <thread>
    #include <string>
    
    void greeting(std::string name, int times) {
        for (int i = 0; i < times; i++) {
            std::cout << "ä½ å¥½ï¼Œ" << name << "ï¼è¿™æ˜¯ç¬¬ " << (i+1) << " æ¬¡é—®å€™ï¼" << std::endl;
        }
    }
    
    int main() {
        // åˆ›å»ºçº¿ç¨‹å¹¶ä¼ é€’å‚æ•°
        std::thread t(greeting, "å¼ ä¸‰", 3);
    
        std::cout << "ä¸»çº¿ç¨‹ï¼šæˆ‘è®©çº¿ç¨‹å»é—®å€™å¼ ä¸‰äº†..." << std::endl;
    
        // ç­‰å¾…çº¿ç¨‹å®Œæˆ
        t.join();
    
        std::cout << "é—®å€™å®Œæ¯•ï¼" << std::endl;
        return 0;
    }
    

è¾“å‡ºç»“æœï¼š

    ä¸»çº¿ç¨‹ï¼šæˆ‘è®©çº¿ç¨‹å»é—®å€™å¼ ä¸‰äº†...
    ä½ å¥½ï¼Œå¼ ä¸‰ï¼è¿™æ˜¯ç¬¬ 1 æ¬¡é—®å€™ï¼
    ä½ å¥½ï¼Œå¼ ä¸‰ï¼è¿™æ˜¯ç¬¬ 2 æ¬¡é—®å€™ï¼
    ä½ å¥½ï¼Œå¼ ä¸‰ï¼è¿™æ˜¯ç¬¬ 3 æ¬¡é—®å€™ï¼
    é—®å€™å®Œæ¯•ï¼
    

ä¼ å‚å°±åƒæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œç›´æ¥åœ¨çº¿ç¨‹æ„é€ å‡½æ•°åé¢åŠ å‚æ•°å°±è¡Œã€‚ä½†æ˜¯æœ‰ä¸ªå‘ï¼šå‚æ•°æ˜¯"æ‹·è´"åˆ°çº¿ç¨‹ä¸­çš„ï¼Œæ‰€ä»¥å°å¿ƒå¯¹è±¡çš„å¤åˆ¶å¼€é”€ï¼

ç”¨Lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹
--------------

æ¯æ¬¡éƒ½è¦å•ç‹¬å†™ä¸ªå‡½æ•°å¤ªéº»çƒ¦äº†ï¼Œæœ‰æ²¡æœ‰ç®€å•æ–¹æ³•ï¼Ÿæœ‰å•Šï¼Œç”¨Lambdaè¡¨è¾¾å¼ï¼

    #include <iostream>
    #include <thread>
    
    int main() {
        // ä½¿ç”¨Lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹
        std::thread t([]() {
            std::cout << "æˆ‘æ˜¯Lambdaåˆ›å»ºçš„çº¿ç¨‹ï¼Œå¸…ä¸å¸…ï¼Ÿ" << std::endl;
            for (int i = 5; i > 0; i--) {
                std::cout << "å€’è®¡æ—¶: " << i << std::endl;
            }
        });
    
        std::cout << "ä¸»çº¿ç¨‹ï¼šLambdaçº¿ç¨‹æ­£åœ¨å€’è®¡æ—¶..." << std::endl;
    
        t.join();
    
        std::cout << "å€’è®¡æ—¶ç»“æŸï¼" << std::endl;
        return 0;
    }
    

Lambdaè¡¨è¾¾å¼å°±åƒä¸€ä¸ªä¸´æ—¶å°å‡½æ•°ï¼Œç”¨å®Œå°±æ‰”ï¼Œæ–¹ä¾¿å¾—å¾ˆï¼ç‰¹åˆ«é€‚åˆé‚£ç§åªç”¨ä¸€æ¬¡çš„ç®€å•é€»è¾‘ã€‚

å¤šçº¿ç¨‹é€šä¿¡çš„å‘ï¼šæ•°æ®ç«äº‰
------------

å¤šçº¿ç¨‹ç¼–ç¨‹æœ€å¤§çš„å‘å°±æ˜¯å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ•°æ®æ—¶ä¼šå‡ºç°"æ•°æ®ç«äº‰"ã€‚æ¥çœ‹ä¸ªä¾‹å­ï¼š

    #include <iostream>
    #include <thread>
    #include <vector>
    
    int counter = 0; // å…±äº«çš„è®¡æ•°å™¨
    
    void increment_counter(int times) {
        for (int i = 0; i < times; i++) {
            counter++; // å±é™©æ“ä½œï¼å¤šçº¿ç¨‹åŒæ—¶ä¿®æ”¹
        }
    }
    
    int main() {
        std::vector<std::thread> threads;
    
        // åˆ›å»º5ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å°†counterå¢åŠ 10000æ¬¡
        for (int i = 0; i < 5; i++) {
            threads.push_back(std::thread(increment_counter, 10000));
        }
    
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for (auto& t : threads) {
            t.join();
        }
    
        std::cout << "ç†è®ºä¸Šcounteråº”è¯¥ç­‰äºï¼š" << 5 * 10000 << std::endl;
        std::cout << "å®é™…ä¸Šcounterç­‰äºï¼š" << counter << std::endl;
    
        return 0;
    }
    

è¾“å‡ºå¯èƒ½æ˜¯ï¼š

    ç†è®ºä¸Šcounteråº”è¯¥ç­‰äºï¼š50000
    å®é™…ä¸Šcounterç­‰äºï¼š42568
    

å’¦ï¼Ÿæ€ä¹ˆå°‘äº†é‚£ä¹ˆå¤šï¼Ÿå› ä¸º `counter++` çœ‹èµ·æ¥æ˜¯ä¸€æ¡è¯­å¥ï¼Œä½†å®é™…ä¸Šåˆ†ä¸‰æ­¥ï¼šè¯»å–counterçš„å€¼ã€åŠ 1ã€å†™å›counterã€‚å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œå°±ä¼šäº’ç›¸"è¸©è¸"ï¼Œå¯¼è‡´æœ€ç»ˆç»“æœå°äºé¢„æœŸã€‚

è¿™å°±æ˜¯è‡­åæ˜­è‘—çš„**æ•°æ®ç«äº‰**é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æœ‰äº’æ–¥é”ã€åŸå­æ“ä½œç­‰ï¼Œåé¢ä¼šè®²ã€‚

> å¾®ä¿¡æœç´¢ ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œå…³æ³¨æˆ‘ï¼Œåç»­è¿˜æœ‰æ›´å¤šç¡¬æ ¸æŠ€æœ¯æ–‡ç« åˆ†äº«ï¼Œå¸¦ä½ ç©è½¬ Linux C/C++ ç¼–ç¨‹ï¼ğŸ˜†

çº¿ç¨‹ç®¡ç†çš„åŸºæœ¬æ“ä½œ
---------

### 1\. join() - ç­‰å¾…çº¿ç¨‹å®Œæˆ

æˆ‘ä»¬å·²ç»è§è¿‡ `join()` äº†ï¼Œå®ƒä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ç›®æ ‡çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€‚

    std::thread t(some_function);
    t.join(); // ç­‰å¾…tå®Œæˆ
    

### 2\. detach() - è®©çº¿ç¨‹"è‡ªç”Ÿè‡ªç­"

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹åä¸æƒ³ç­‰å®ƒäº†ï¼Œå¯ä»¥ç”¨ `detach()` è®©å®ƒç‹¬ç«‹è¿è¡Œï¼š

    std::thread t(background_task);
    t.detach(); // çº¿ç¨‹åœ¨åå°ç‹¬ç«‹è¿è¡Œ
    std::cout << "ä¸»çº¿ç¨‹ä¸ç®¡å­çº¿ç¨‹äº†ï¼Œç»§ç»­è‡ªå·±çš„äº‹" << std::endl;
    

detachåçš„çº¿ç¨‹ç§°ä¸º"åˆ†ç¦»çº¿ç¨‹"æˆ–"å®ˆæŠ¤çº¿ç¨‹"ï¼Œå®ƒä¼šåœ¨åå°é»˜é»˜è¿è¡Œï¼Œç›´åˆ°è‡ªå·±çš„ä»»åŠ¡å®Œæˆã€‚ä½†è¦å°å¿ƒï¼šå¦‚æœä¸»ç¨‹åºç»“æŸäº†ï¼Œè¿™äº›åˆ†ç¦»çº¿ç¨‹ä¼šè¢«å¼ºåˆ¶ç»ˆæ­¢ï¼

### 3\. joinable() - æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å¯ç­‰å¾…

åœ¨joinä¹‹å‰ï¼Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«ç­‰å¾…ï¼š

    std::thread t(some_function);
    // ... ä¸€äº›ä»£ç  ...
    if (t.joinable()) {
        t.join();
    }
    

è¿™é¿å…äº†å¯¹å·²ç» join æˆ– detach è¿‡çš„çº¿ç¨‹å†æ¬¡æ“ä½œï¼Œå¦åˆ™ä¼šå´©æºƒã€‚

é˜²æ­¢å¿˜è®°joinï¼šRAIIé£æ ¼çš„çº¿ç¨‹åŒ…è£…å™¨
---------------------

C++çš„ç»å…¸æ¨¡å¼ï¼šç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†èµ„æºã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹åŒ…è£…å™¨ï¼Œåœ¨ææ„æ—¶è‡ªåŠ¨joinï¼š

    #include <iostream>
    #include <thread>
    
    class thread_guard {
    private:
    std::thread& t;
    
    public:
    // æ„é€ å‡½æ•°ï¼Œæ¥æ”¶çº¿ç¨‹å¼•ç”¨
    explicit thread_guard(std::thread& t_) : t(t_) {}
    
    // ææ„å‡½æ•°ï¼Œè‡ªåŠ¨joinçº¿ç¨‹
    ~thread_guard() {
        if (t.joinable()) {
            t.join();
        }
    }
    
    // ç¦æ­¢å¤åˆ¶
    thread_guard(const thread_guard&) = delete;
    thread_guard& operator=(const thread_guard&) = delete;
    };
    
    void some_function() {
        std::cout << "çº¿ç¨‹å·¥ä½œä¸­..." << std::endl;
    }
    
    int main() {
        std::thread t(some_function);
        thread_guard g(t); // åˆ›å»ºå®ˆå«å¯¹è±¡
    
        // å³ä½¿è¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œthread_guardçš„ææ„å‡½æ•°ä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œç¡®ä¿tè¢«join
        std::cout << "ä¸»çº¿ç¨‹ç»§ç»­å·¥ä½œ..." << std::endl;
    
        return 0; // å‡½æ•°ç»“æŸï¼Œgè¢«é”€æ¯ï¼Œè‡ªåŠ¨è°ƒç”¨t.join()
    }
    

è¿™æ ·å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼Œæˆ–è€…å¼€å‘è€…å¿˜è®°æ‰‹åŠ¨joinï¼Œçº¿ç¨‹ä¹Ÿä¼šè¢«æ­£ç¡®ç­‰å¾…ï¼Œé¿å…ç¨‹åºå´©æºƒã€‚

çº¿ç¨‹é—´çš„äº’æ–¥ï¼šmutex
------------

å‰é¢è¯´åˆ°æ•°æ®ç«äº‰é—®é¢˜ï¼Œæœ€å¸¸ç”¨çš„è§£å†³æ–¹æ¡ˆæ˜¯äº’æ–¥é”ï¼ˆmutexï¼‰ï¼š

    #include <iostream>
    #include <thread>
    #include <mutex>
    #include <vector>
    
    int counter = 0;
    std::mutex counter_mutex; // ä¿æŠ¤counterçš„äº’æ–¥é”
    
    void safe_increment(int times) {
        for (int i = 0; i < times; i++) {
            counter_mutex.lock(); // é”å®šäº’æ–¥é”
            counter++; // å®‰å…¨æ“ä½œ
            counter_mutex.unlock(); // è§£é”
        }
    }
    
    int main() {
        std::vector<std::thread> threads;
    
        // åˆ›å»º5ä¸ªçº¿ç¨‹
        for (int i = 0; i < 5; i++) {
            threads.push_back(std::thread(safe_increment, 10000));
        }
    
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹
        for (auto& t : threads) {
            t.join();
        }
    
        std::cout << "ç°åœ¨counteræ­£ç¡®ç­‰äºï¼š" << counter << std::endl;
        return 0;
    }
    

è¾“å‡ºï¼š

    ç°åœ¨counteræ­£ç¡®ç­‰äºï¼š50000
    

å¤ªå¥½äº†ï¼ç»“æœæ­£ç¡®äº†ã€‚ä½†è¿™æ ·æ‰‹åŠ¨lock/unlockå¾ˆå®¹æ˜“å‡ºé”™ï¼Œå¦‚æœå¿˜è®°unlockæˆ–è€…å‘ç”Ÿå¼‚å¸¸ï¼Œå°±ä¼šæ­»é”ã€‚æ‰€ä»¥æ›´æ¨èä½¿ç”¨RAIIé£æ ¼çš„`std::lock_guard`ï¼š

    void better_safe_increment(int times) {
        for (int i = 0; i < times; i++) {
            std::lock_guard<std::mutex> lock(counter_mutex); // è‡ªåŠ¨é”å®šå’Œè§£é”
            counter++;
        }
    }
    

`lock_guard`åœ¨æ„é€ æ—¶é”å®šäº’æ–¥é”ï¼Œåœ¨ææ„æ—¶è‡ªåŠ¨è§£é”ï¼Œæ— è®ºæ˜¯æ­£å¸¸é€€å‡ºè¿˜æ˜¯å¼‚å¸¸é€€å‡ºéƒ½èƒ½ä¿è¯äº’æ–¥é”è¢«é‡Šæ”¾ã€‚

é«˜çº§è¯é¢˜ï¼šæ¡ä»¶å˜é‡
---------

çº¿ç¨‹é—´çš„åŒæ­¥ä¸åªæœ‰äº’æ–¥ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…æŸä¸ªæ¡ä»¶æ»¡è¶³ã€‚æ¡ä»¶å˜é‡å°±æ˜¯å¹²è¿™ä¸ªçš„ï¼š

    #include <iostream>
    #include <thread>
    #include <mutex>
    #include <condition_variable>
    #include <queue>
    
    std::queue<int> data_queue; // å…±äº«çš„æ•°æ®é˜Ÿåˆ—
    std::mutex queue_mutex;
    std::condition_variable data_cond;
    
    // ç”Ÿäº§è€…çº¿ç¨‹
    void producer() {
        for (int i = 0; i < 5; i++) {
            {
                std::lock_guard<std::mutex> lock(queue_mutex);
                data_queue.push(i); // æ·»åŠ æ•°æ®
                std::cout << "ç”Ÿäº§äº†æ•°æ®: " << i << std::endl;
            } // é”åœ¨è¿™é‡Œé‡Šæ”¾
    
            data_cond.notify_one(); // é€šçŸ¥ä¸€ä¸ªç­‰å¾…çš„æ¶ˆè´¹è€…
            std::this_thread::sleep_for(std::chrono::milliseconds(100)); // ç¨å¾®ç­‰ä¸€ä¸‹
        }
    }
    
    // æ¶ˆè´¹è€…çº¿ç¨‹
    void consumer() {
        while (true) {
            std::unique_lock<std::mutex> lock(queue_mutex);
            // ç­‰å¾…é˜Ÿåˆ—æœ‰æ•°æ®ï¼ˆé¿å…è™šå‡å”¤é†’ï¼‰
            data_cond.wait(lock, [] { return !data_queue.empty(); });
    
            // å–å‡ºå¹¶å¤„ç†æ•°æ®
            int value = data_queue.front();
            data_queue.pop();
    
            std::cout << "æ¶ˆè´¹äº†æ•°æ®: " << value << std::endl;
    
            if (value == 4) break; // æ”¶åˆ°æœ€åä¸€ä¸ªæ•°æ®åé€€å‡º
        }
    }
    
    int main() {
        std::thread prod(producer);
        std::thread cons(consumer);
    
        prod.join();
        cons.join();
    
        std::cout << "æ‰€æœ‰æ•°æ®éƒ½ç”Ÿäº§å’Œæ¶ˆè´¹å®Œæ¯•ï¼" << std::endl;
        return 0;
    }
    

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ç»å…¸çš„"ç”Ÿäº§è€…-æ¶ˆè´¹è€…"æ¨¡å¼ï¼šç”Ÿäº§è€…å¾€é˜Ÿåˆ—é‡Œæ”¾æ•°æ®ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—é‡Œå–æ•°æ®ã€‚æ¡ä»¶å˜é‡ç¡®ä¿æ¶ˆè´¹è€…ä¸ä¼šåœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶å°è¯•å–æ•°æ®ã€‚

çº¿ç¨‹ä¸å¼‚å¸¸å®‰å…¨
-------

åœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­å¤„ç†å¼‚å¸¸å°¤ä¸ºé‡è¦ã€‚å¦‚æœçº¿ç¨‹æ‰§è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸ï¼Œä¸”æ²¡è¢«æ•è·ï¼Œæ•´ä¸ªç¨‹åºä¼šç›´æ¥å´©æºƒï¼ä»¥ä¸‹æ˜¯å®‰å…¨å¤„ç†æ–¹å¼ï¼š

    #include <iostream>
    #include <thread>
    #include <exception>
    
    void function_that_throws() {
        throw std::runtime_error("æ•…æ„æŠ›å‡ºçš„å¼‚å¸¸ï¼");
    }
    
    void thread_function() {
        try {
            function_that_throws();
        } catch (const std::exception& e) {
            std::cout << "çº¿ç¨‹æ•è·åˆ°å¼‚å¸¸: " << e.what() << std::endl;
        }
    }
    
    int main() {
        std::thread t(thread_function);
        t.join();
    
        std::cout << "ç¨‹åºæ­£å¸¸ç»“æŸ" << std::endl;
        return 0;
    }
    

è¾“å‡ºï¼š

    çº¿ç¨‹æ•è·åˆ°å¼‚å¸¸: æ•…æ„æŠ›å‡ºçš„å¼‚å¸¸ï¼
    ç¨‹åºæ­£å¸¸ç»“æŸ
    

è®°ä½ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„è°ƒç”¨æ ˆï¼Œå¼‚å¸¸ä¸ä¼šè·¨çº¿ç¨‹ä¼ æ’­ï¼åœ¨å“ªä¸ªçº¿ç¨‹æŠ›å‡ºï¼Œå°±å¿…é¡»åœ¨å“ªä¸ªçº¿ç¨‹æ•è·ã€‚

å®ç”¨æŠ€å·§
----

### 1\. è·å–çº¿ç¨‹ID

æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„IDï¼Œç”¨äºæ ‡è¯†ï¼š

    #include <iostream>
    #include <thread>
    
    void print_id() {
        std::cout << "çº¿ç¨‹ID: " << std::this_thread::get_id() << std::endl;
    }
    
    int main() {
        std::thread t1(print_id);
        std::thread t2(print_id);
    
        std::cout << "ä¸»çº¿ç¨‹ID: " << std::this_thread::get_id() << std::endl;
        std::cout << "t1çš„ID: " << t1.get_id() << std::endl;
        std::cout << "t2çš„ID: " << t2.get_id() << std::endl;
    
        t1.join();
        t2.join();
    
        return 0;
    }
    

### 2\. çº¿ç¨‹ä¼‘çœ 

æœ‰æ—¶éœ€è¦è®©çº¿ç¨‹æš‚åœä¸€ä¼šå„¿ï¼š

    #include <iostream>
    #include <thread>
    #include <chrono>
    
    void sleepy_thread() {
        std::cout << "æˆ‘è¦ç¡è§‰äº†..." << std::endl;
        std::this_thread::sleep_for(std::chrono::seconds(2));
        std::cout << "ç¡é†’äº†ï¼" << std::endl;
    }
    
    int main() {
        std::thread t(sleepy_thread);
        t.join();
        return 0;
    }
    

### 3\. è·å–CPUæ ¸å¿ƒæ•°

ä¸ºäº†æ ¹æ®CPUæ ¸å¿ƒä¼˜åŒ–çº¿ç¨‹æ•°é‡ï¼š

    #include <iostream>
    #include <thread>
    
    int main() {
        unsigned int num_cores = std::thread::hardware_concurrency();
        std::cout << "ä½ çš„CPUæœ‰ " << num_cores << " ä¸ªç¡¬ä»¶çº¿ç¨‹ï¼ˆæ ¸å¿ƒï¼‰" << std::endl;
    
        // æ ¹æ®æ ¸å¿ƒæ•°åˆ›å»ºçº¿ç¨‹
        unsigned int num_threads = num_cores;
        std::cout << "å°†åˆ›å»º " << num_threads << " ä¸ªçº¿ç¨‹ä»¥å……åˆ†åˆ©ç”¨CPU" << std::endl;
    
        return 0;
    }
    

å®é™…æ¡ˆä¾‹ï¼šå¹¶è¡Œå›¾åƒå¤„ç†
-----------

æ¥ä¸ªå®é™…åº”ç”¨æ¡ˆä¾‹ï¼šç”¨å¤šçº¿ç¨‹åŠ é€Ÿå›¾åƒå¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ä¸ºæ“ä½œä¸€ä¸ªäºŒç»´æ•°ç»„ï¼š

    #include <iostream>
    #include <thread>
    #include <vector>
    #include <algorithm>
    #include <chrono>
    
    // æ¨¡æ‹Ÿå›¾åƒå¤„ç†å‡½æ•°
    void process_image_part(std::vector<std::vector<int>>& image, int start_row, int end_row) {
        for (int i = start_row; i < end_row; i++) {
            for (int j = 0; j < image[i].size(); j++) {
                // æ¨¡æ‹Ÿå¤æ‚å¤„ç†ï¼Œä¾‹å¦‚å›¾åƒæ¨¡ç³Š
                image[i][j] = (image[i][j] + 10) * 2;
                // æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
                std::this_thread::sleep_for(std::chrono::microseconds(1));
            }
        }
    }
    
    int main() {
        // åˆ›å»ºæ¨¡æ‹Ÿå›¾åƒ (1000x1000)
        std::vector<std::vector<int>> image(1000, std::vector<int>(1000, 5));
    
        // è·å–CPUæ ¸å¿ƒæ•°
        unsigned int num_cores = std::thread::hardware_concurrency();
        unsigned int num_threads = num_cores; // ä½¿ç”¨å’Œæ ¸å¿ƒæ•°ä¸€æ ·å¤šçš„çº¿ç¨‹
    
        std::cout << "ä½¿ç”¨ " << num_threads << " ä¸ªçº¿ç¨‹å¤„ç†å›¾åƒ..." << std::endl;
    
        // å¼€å§‹è®¡æ—¶
        auto start_time = std::chrono::high_resolution_clock::now();
    
        // åˆ›å»ºçº¿ç¨‹å¹¶åˆ†é…å·¥ä½œ
        std::vector<std::thread> threads;
        int rows_per_thread = image.size() / num_threads;
    
        for (unsigned int i = 0; i < num_threads; i++) {
            int start_row = i * rows_per_thread;
            int end_row = (i == num_threads - 1) ? image.size() : (i + 1) * rows_per_thread;
    
            threads.push_back(std::thread(process_image_part, std::ref(image), start_row, end_row));
        }
    
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        for (auto& t : threads) {
            t.join();
        }
    
        // ç»“æŸè®¡æ—¶
        auto end_time = std::chrono::high_resolution_clock::now();
        auto duration = std::chrono::duration_cast<std::chrono::milliseconds>(end_time - start_time);
    
        std::cout << "å›¾åƒå¤„ç†å®Œæˆï¼è€—æ—¶: " << duration.count() << " æ¯«ç§’" << std::endl;
    
        // éªŒè¯ç»“æœï¼ˆåªæ˜¾ç¤ºéƒ¨åˆ†ï¼‰
        std::cout << "å¤„ç†åçš„å›¾åƒæ ·æœ¬ï¼ˆå·¦ä¸Šè§’ï¼‰: " << std::endl;
        for (int i = 0; i < 3; i++) {
            for (int j = 0; j < 3; j++) {
                std::cout << image[i][j] << " ";
            }
            std::cout << std::endl;
        }
    
        return 0;
    }
    

è¿™ä¸ªä¾‹å­å±•ç¤ºäº†å¦‚ä½•å°†å¤§å‹ä»»åŠ¡åˆ†è§£æˆå¤šä¸ªå°å—ï¼Œåˆ†é…ç»™å¤šä¸ªçº¿ç¨‹å¹¶è¡Œå¤„ç†ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸CPUçš„ä¼˜åŠ¿ã€‚

å¤šçº¿ç¨‹çš„æœ€ä½³å®è·µ
--------

1.  **ä¿æŒç®€å•**ï¼šå¤šçº¿ç¨‹ä»£ç éš¾ä»¥è°ƒè¯•ï¼Œå°½é‡ç®€åŒ–æ¯ä¸ªçº¿ç¨‹çš„å·¥ä½œã€‚
2.  **é¿å…å…±äº«çŠ¶æ€**ï¼šå°½å¯èƒ½å‡å°‘çº¿ç¨‹é—´å…±äº«çš„æ•°æ®ï¼Œä»¥é™ä½åŒæ­¥å¤æ‚åº¦ã€‚
3.  **é€‚å½“çš„çº¿ç¨‹æ•°é‡**ï¼šé€šå¸¸ç­‰äºæˆ–ç•¥å¤šäºCPUæ ¸å¿ƒæ•°ï¼Œå¤ªå¤šåè€Œä¼šå› ä¸ºé¢‘ç¹åˆ‡æ¢å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚
4.  **ä½¿ç”¨é«˜çº§æŠ½è±¡**ï¼šè€ƒè™‘ä½¿ç”¨`std::async`ã€`std::future`æˆ–çº¿ç¨‹æ± ï¼Œè€Œä¸æ˜¯ç›´æ¥ç®¡ç†çº¿ç¨‹ã€‚
5.  **æµ‹è¯•å’Œè°ƒè¯•**ï¼šåœ¨å„ç§æ¡ä»¶ä¸‹æµ‹è¯•å¤šçº¿ç¨‹ä»£ç ï¼ŒåŒ…æ‹¬é«˜è´Ÿè½½å’Œè¾¹ç¼˜æƒ…å†µã€‚

ç»“è¯­
--

ä»æ­¤ï¼Œä½ å·²ç»æŒæ¡äº†C++11å¤šçº¿ç¨‹ç¼–ç¨‹çš„åŸºç¡€çŸ¥è¯†ï¼ä»åˆ›å»ºçº¿ç¨‹åˆ°ä¼ é€’å‚æ•°ï¼Œä»äº’æ–¥é”åˆ°æ¡ä»¶å˜é‡ï¼Œä»ç®€å•ç¤ºä¾‹åˆ°å®é™…åº”ç”¨ã€‚å¤šçº¿ç¨‹ç¼–ç¨‹ç¡®å®æ¯”å•çº¿ç¨‹å¤æ‚ï¼Œä½†æŒæ¡äº†è¿™äº›æŠ€èƒ½ï¼Œä½ å°±èƒ½å†™å‡ºæ›´é«˜æ•ˆã€å“åº”æ›´å¿«çš„ç¨‹åºã€‚

è®°ä½ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹éœ€è¦å®è·µå’Œè€å¿ƒã€‚å¼€å§‹æ—¶å¯èƒ½ä¼šé‡åˆ°å„ç§è«åå…¶å¦™çš„é—®é¢˜ï¼Œä½†éšç€ç»éªŒç§¯ç´¯ï¼Œä½ ä¼šè¶Šæ¥è¶Šç†Ÿç»ƒã€‚ä¸å¦¨ä»ç®€å•çš„å¤šçº¿ç¨‹ç¨‹åºå¼€å§‹ï¼Œé€æ­¥æŒ‘æˆ˜æ›´å¤æ‚çš„åœºæ™¯ã€‚

æœ€åçš„å»ºè®®ï¼šå†™å¤šçº¿ç¨‹ç¨‹åºæ—¶ï¼Œæ—¶åˆ»ä¿æŒæ¸…é†’å’Œè­¦æƒ•ï¼Œå› ä¸ºå¤šçº¿ç¨‹bugå¯èƒ½æ˜¯æœ€éš¾è°ƒè¯•çš„bugä¹‹ä¸€ï¼

æ„¿ä½ çš„å¤šçº¿ç¨‹ä¹‹æ—…æ„‰å¿«ä¸”å……æ»¡æˆå°±æ„Ÿï¼

* * *

ğŸ® å½©è›‹æ—¶é—´ï¼
--------

å“ˆå–½ï¼Œå¼€å‘è€…æœ‹å‹ä»¬ï¼çœ‹åˆ°è¿™é‡Œï¼Œä½ å·²ç»æˆåŠŸå°†å¤šçº¿ç¨‹è¿™ä¸ª"é­”æ³•"æ”¶å…¥å›Šä¸­äº†ï¼æ˜¯ä¸æ˜¯æ„Ÿè§‰è‡ªå·±çš„ä»£ç çªç„¶æœ‰äº†å¼€æŒ‚çš„èƒ½åŠ›ï¼Ÿ

**å¦‚æœè¿™ç¯‡æ–‡ç« å¸®åˆ°äº†ä½ ï¼Œä¸å¦¨ç‚¹èµã€æ”¶è—å’Œå…³æ³¨ã€‚ä½ çš„æ¯æ¬¡äº’åŠ¨ï¼Œéƒ½æ˜¯æˆ‘ç†¬å¤œç å­—çš„åŠ¨åŠ›æºæ³‰å•Šï¼âš¡**

### ğŸš€ æƒ³ç»§ç»­æå‡ä½ çš„C++æ­¦å™¨åº“ï¼Ÿ

å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œ**è·Ÿç€å°åº·å­¦ç¼–ç¨‹**ã€ï¼Œè¿˜æœ‰æ›´å¤šå¹²è´§ç­‰ç€ä½ ï¼š

*   **æŒ‡é’ˆè®©ä½ å¤´ç§ƒï¼Ÿ** æ™ºèƒ½æŒ‡é’ˆè¯¦è§£ï¼Œä»æ­¤å‘Šåˆ«æ®µé”™è¯¯å™©æ¢¦
*   **STLå®¹å™¨å‚»å‚»åˆ†ä¸æ¸…ï¼Ÿ** ä¸€æ–‡å¸¦ä½ å½»åº•ææ‡‚å®ƒä»¬çš„é€‚ç”¨åœºæ™¯
*   **è®¾è®¡æ¨¡å¼å¤ªæŠ½è±¡ï¼Ÿ** ç”¨ç”Ÿæ´»æ¡ˆä¾‹ç§’æ‡‚ï¼Œä»£ç ç«‹é©¬é«˜å¤§ä¸Š
*   **Linuxç³»ç»Ÿç¼–ç¨‹ï¼Ÿ** ä»é›¶å¸¦ä½ ç©è½¬æ–‡ä»¶ã€è¿›ç¨‹ã€ç½‘ç»œç¼–ç¨‹

**æ¯å‘¨æ›´æ–°ï¼Œæ‹’ç»ç©ºè°ˆï¼Œå…¨æ˜¯èƒ½ç«‹é©¬ç”¨ä¸Šçš„å®æˆ˜æŠ€å·§ï¼**

### ğŸ“± ä¸€é”®å…³æ³¨ä¸è¿·è·¯

![](https://files.mdnice.com/user/71186/0dde803d-d52f-4ed8-b74b-b7f3da5817b9.png)

æ‰«ç å³å¯å…³æ³¨ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æŠŠ C++ å­¦å¾—æ˜æ˜ç™½ç™½ï¼Œç”¨å¾—èˆ’èˆ’æœæœï¼

**è®°ä½ï¼šç¼–ç¨‹éš¾ï¼Ÿåªæ˜¯ä½ è¿˜æ²¡é‡åˆ°å¯¹çš„è€å¸ˆï¼è·Ÿç€å°åº·å­¦ï¼ŒC++æ²¡é‚£ä¹ˆéš¾ï¼**

### ğŸ’¬ åŠ å…¥æˆ‘ä»¬çš„C++ä¿®ä»™ç¾¤

![](https://files.mdnice.com/user/48364/971ccaa3-8f57-4e33-8bc9-d0863eeade81.png)

é‡åˆ° Bug å¡ä½äº†ï¼Ÿé¡¹ç›®æ€è·¯ä¸æ¸…æ™°ï¼Ÿåœ¨æˆ‘ä»¬çš„äº¤æµç¾¤é‡Œï¼Œä¸ä»…æœ‰æˆ‘è¿™ä¸ªåšä¸»åœ¨çº¿ç­”ç–‘ï¼Œè¿˜æœ‰ä¸€ç¾¤åŒæ ·çƒ­çˆ±ä»£ç çš„å°ä¼™ä¼´éšæ—¶å¸®ä½ è§£æƒ‘ï¼