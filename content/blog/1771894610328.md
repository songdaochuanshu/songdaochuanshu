---
layout: post
title: 'æ•°æ®åº“è¡Œå­˜å‚¨ä¸åˆ—å­˜å‚¨'
date: "2026-02-24T00:56:50Z"
---
æ•°æ®åº“è¡Œå­˜å‚¨ä¸åˆ—å­˜å‚¨
==========

æ•°æ®åº“åˆ—å­˜å‚¨å’Œè¡Œå­˜å‚¨çš„åŒºåˆ«
=============

### ä»€ä¹ˆæ˜¯åˆ—å­˜å‚¨ï¼ˆColumn-oriented Storageï¼‰ï¼Ÿ

åœ¨ä¼ ç»Ÿçš„æ•°æ®åº“ä¸­ï¼Œæ•°æ®æ˜¯ä¸€è¡Œä¸€è¡Œå†™å…¥å’Œè¯»å–çš„ã€‚è€Œ**åˆ—å­˜å‚¨**ï¼ˆColumnar Storageï¼‰é¡¾åæ€ä¹‰ï¼Œæ˜¯å°†æ•°æ®è¡¨ä¸­çš„**æ¯ä¸€åˆ—æ•°æ®å•ç‹¬é›†ä¸­å­˜å‚¨**åœ¨ç‰©ç†ç£ç›˜ä¸Šã€‚

è¿™æ„å‘³ç€ï¼Œè¡¨ä¸­åŒä¸€åˆ—çš„æ‰€æœ‰æ•°å€¼ä¼šè¢«è¿ç»­åœ°å­˜æ”¾åœ¨ä¸€èµ·ã€‚æ¯”å¦‚ä¸€ä¸ªåŒ…å«â€œå§“åã€å¹´é¾„ã€èŒä¸šâ€çš„è¡¨ï¼Œåœ¨åˆ—å­˜å‚¨ä¸­ï¼Œâ€œæ‰€æœ‰çš„å§“åâ€å­˜åœ¨ä¸€ä¸ªæ•°æ®å—ï¼Œâ€œæ‰€æœ‰çš„å¹´é¾„â€å­˜åœ¨å¦ä¸€ä¸ªæ•°æ®å—ã€‚

### ä»€ä¹ˆæ˜¯è¡Œå­˜å‚¨ï¼ˆRow-oriented Storageï¼‰ï¼Ÿ

ä¸ºäº†æ›´å¥½åœ°ç†è§£åˆ—å­˜å‚¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ¯”ä¼ ç»Ÿçš„**è¡Œå­˜å‚¨**ã€‚è¡Œå­˜å‚¨æ˜¯å°†ä¸€æ¡è®°å½•ï¼ˆRowï¼‰çš„æ‰€æœ‰å­—æ®µï¼ˆColumnsï¼‰è¿ç»­å­˜å‚¨åœ¨ä¸€èµ·ã€‚å½“ä½ å†™å…¥ä¸€æ¡æ–°æ•°æ®æ—¶ï¼Œå®ƒçš„æ‰€æœ‰ä¿¡æ¯æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“è¢«å†™å…¥ç£ç›˜çš„ã€‚

> **ğŸ’¡ ç”Ÿæ´»åŒ–çš„æ¯”å–»ï¼š**
> 
> *   **è¡Œå­˜å‚¨ï¼š** å°±åƒæ˜¯ä¸€æœ¬**ä¸ªäººæ¡£æ¡ˆå†Œ**ã€‚æ¯ä¸€é¡µæ˜¯ä¸€ä¸ªäººçš„æ‰€æœ‰ä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€è–ªæ°´ï¼‰ã€‚å¦‚æœä½ æƒ³æŸ¥æŸä¸€ä¸ªäººçš„å…¨éƒ¨ä¿¡æ¯ï¼Œç¿»åˆ°é‚£ä¸€é¡µå°±èƒ½å…¨çœ‹å®Œï¼›ä½†å¦‚æœä½ æƒ³ç®—å‡ºæ‰€æœ‰äººçš„â€œå¹³å‡è–ªæ°´â€ï¼Œä½ å°±å¿…é¡»æŠŠæ¯ä¸€é¡µéƒ½ç¿»ä¸€éã€‚
> *   **åˆ—å­˜å‚¨ï¼š** å°±åƒæ˜¯**åˆ†ç±»è´¦æœ¬**ã€‚ç¬¬ä¸€æœ¬å…¨å†™åå­—ï¼Œç¬¬äºŒæœ¬å…¨å†™å¹´é¾„ï¼Œç¬¬ä¸‰æœ¬å…¨å†™è–ªæ°´ã€‚å¦‚æœä½ æƒ³ç®—â€œå¹³å‡è–ªæ°´â€ï¼Œåªéœ€è¦æ‹¿è¿‡ç¬¬ä¸‰æœ¬è´¦æœ¬ï¼Œé‡Œé¢å…¨éƒ½æ˜¯æ•°å­—ï¼Œä¸€çœ¼å°±èƒ½åŠ èµ·æ¥ï¼Œå®Œå…¨ä¸éœ€è¦ç†ä¼šåå­—å’Œå¹´é¾„ã€‚

* * *

### è¡Œå­˜å‚¨ vs åˆ—å­˜å‚¨ï¼šæ ¸å¿ƒåŒºåˆ«

è¿™ä¸¤ç§å­˜å‚¨æ–¹å¼æ²¡æœ‰ç»å¯¹çš„ä¼˜åŠ£ï¼Œåªæœ‰â€œæ˜¯å¦é€‚åˆç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯â€ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬çš„è¯¦ç»†å¯¹æ¯”ï¼š

**ç‰¹æ€§**

**è¡Œå­˜å‚¨ (Row Storage)**

**åˆ—å­˜å‚¨ (Column Storage)**

**æ•°æ®ç‰©ç†åˆ†å¸ƒ**

æŒ‰è¡Œè¿ç»­å­˜å‚¨åœ¨ä¸€å—

æŒ‰åˆ—å•ç‹¬è¿ç»­å­˜å‚¨

**é€‚ç”¨æ ¸å¿ƒåœºæ™¯**

**OLTP** (è”æœºäº‹åŠ¡å¤„ç†)ï¼Œå¦‚ç”µå•†äº¤æ˜“ã€ç”¨æˆ·æ³¨å†Œ

**OLAP** (è”æœºåˆ†æå¤„ç†)ï¼Œå¦‚æ•°æ®æŠ¥è¡¨ã€å•†ä¸šæ™ºèƒ½åˆ†æ

**æŸ¥è¯¢ä¼˜åŠ¿**

æå¿«åœ°è·å–ä¸€æ¡è®°å½•çš„**æ‰€æœ‰å­—æ®µ**

æå¿«åœ°å¯¹**æŸå‡ åˆ—**è¿›è¡Œèšåˆè®¡ç®—ï¼ˆå¦‚ SUM, COUNT, AVGï¼‰

**I/O æ•ˆç‡**

å¦‚æœåªæŸ¥æŸä¸€åˆ—ï¼Œä»éœ€å°†æ•´è¡Œæ•°æ®è¯»å…¥å†…å­˜ï¼Œäº§ç”Ÿå¤§é‡æ— æ•ˆ I/O

åªè¯»å–éœ€è¦çš„åˆ—æ•°æ®ï¼Œæå¤§å‡å°‘ç£ç›˜ I/O

**æ•°æ®å‹ç¼©ç‡**

è¾ƒä½ã€‚å› ä¸ºä¸€è¡Œä¸­åŒ…å«å­—ç¬¦ä¸²ã€æ•°å­—ã€æ—¥æœŸç­‰ä¸åŒç±»å‹çš„æ•°æ®ï¼Œéš¾ä»¥é«˜æ•ˆå‹ç¼©ã€‚

**æé«˜**ã€‚å› ä¸ºåŒä¸€åˆ—çš„æ•°æ®ç±»å‹å®Œå…¨ä¸€è‡´ï¼ˆä¾‹å¦‚å…¨æ˜¯æ•°å­—ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨æ¸¸ç¨‹ç¼–ç ç­‰é«˜çº§å‹ç¼©ç®—æ³•ï¼Œé€šå¸¸èƒ½å‹ç¼©åˆ°åŸæ¥çš„ 1/10ã€‚

**å¢åˆ æ”¹æ€§èƒ½ (Insert/Update)**

**éå¸¸å¿«**ã€‚ç›´æ¥åœ¨æœ«å°¾è¿½åŠ æˆ–å®šä½ä¿®æ”¹å³å¯ã€‚

**è¾ƒæ…¢**ã€‚æ’å…¥ä¸€æ¡è®°å½•éœ€è¦æ‹†åˆ†åˆ°ä¸åŒçš„åˆ—æ–‡ä»¶ä¸­ï¼Œé€šå¸¸é‡‡ç”¨â€œæ‰¹é‡å†™å…¥â€ç­–ç•¥æ¥ä¼˜åŒ–ã€‚

**ä»£è¡¨æ€§æŠ€æœ¯/æ•°æ®åº“**

MySQL, PostgreSQL, Oracle, SQL Server

ClickHouse, HBase, Snowflake, Parquet (æ–‡ä»¶æ ¼å¼)

### ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å“ªä¸€ä¸ªï¼Ÿ

*   **é€‰æ‹©è¡Œå­˜å‚¨ï¼š** å¦‚æœä½ çš„ç³»ç»Ÿæ˜¯ç”¨æ¥å¤„ç†æ—¥å¸¸ä¸šåŠ¡çš„ï¼ˆæ¯”å¦‚æ·˜å®çš„è´­ç‰©è½¦ã€é“¶è¡Œçš„è½¬è´¦ï¼‰ï¼Œæ“ä½œç‰¹ç‚¹æ˜¯**é«˜é¢‘åœ°æ’å…¥ã€ä¿®æ”¹å•æ¡è®°å½•**ï¼Œå¹¶ä¸”æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦ç”¨åˆ°è¿™æ¡è®°å½•çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œé‚£ä¹ˆè¡Œå­˜å‚¨æ˜¯ä½ çš„ä¸äºŒä¹‹é€‰ã€‚
*   **é€‰æ‹©åˆ—å­˜å‚¨ï¼š** å¦‚æœä½ çš„ç³»ç»Ÿæ˜¯ç”¨æ¥åšæ•°æ®åˆ†æçš„ï¼ˆæ¯”å¦‚åˆ†æè¿‡å»ä¸€å¹´æ·˜å®æŸä¸ªå“ç±»çš„æ€»é”€å”®é¢ã€ç”¨æˆ·çš„å¹³å‡å¹´é¾„ï¼‰ï¼Œæ“ä½œç‰¹ç‚¹æ˜¯**æµ·é‡æ•°æ®æŸ¥è¯¢ã€å¾ˆå°‘ä¿®æ”¹æ•°æ®ã€é€šå¸¸åªå…³æ³¨è¡¨ä¸­çš„æŸå‡ åˆ—è¿›è¡Œç»Ÿè®¡**ï¼Œé‚£ä¹ˆåˆ—å­˜å‚¨èƒ½è®©ä½ çš„æŸ¥è¯¢é€Ÿåº¦æå‡æˆç™¾ä¸Šåƒå€ã€‚

è¡Œå­˜å‚¨ vs åˆ—å­˜å‚¨ ç£ç›˜å­˜å‚¨åŒºåˆ«
=================

æ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç‰©ç†è¿ç»­æ€§ï¼Œç›´æ¥å†³å®šäº†åº•å±‚æ“ä½œç³»ç»Ÿè¯»å–æ•°æ®æ—¶çš„ **I/O (è¾“å…¥/è¾“å‡º) æ¶ˆè€—**ï¼Œè¿™ä¹Ÿæ˜¯ä¸¤è€…æ€§èƒ½å·®å¼‚çš„æ ¹æœ¬æ¥æºã€‚

ä¸ºäº†æœ€ç›´è§‚åœ°è¯´æ˜ï¼Œæˆ‘ä»¬å…ˆå‡è®¾æœ‰ä¸€å¼ éå¸¸ç®€å•çš„â€œå‘˜å·¥è¡¨â€ï¼ˆEmployeeï¼‰ï¼ŒåŒ…å«ä¸‰è¡Œæ•°æ®å’Œå››ä¸ªå­—æ®µï¼ˆåˆ—ï¼‰ï¼š

**ID (ç¼–å·)**

**Name (å§“å)**

**Age (å¹´é¾„)**

**Salary (è–ªèµ„)**

1

Alice

25

5000

2

Bob

30

6000

3

Carol

28

5500

ç£ç›˜çš„åŸºæœ¬è¯»å–å•ä½é€šå¸¸æ˜¯â€œå—ï¼ˆBlockï¼‰â€æˆ–â€œé¡µï¼ˆPageï¼‰â€ï¼ˆæ¯”å¦‚ 4KB æˆ– 8KBï¼‰ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸‰è¡Œæ•°æ®æ˜¯å¦‚ä½•è¢«å¡è¿›è¿™äº›æ•°æ®å—é‡Œçš„ã€‚

### 1\. è¡Œå­˜å‚¨çš„ç£ç›˜ç»“æ„ï¼šæ‰“åŒ…æ”¾å…¥

åœ¨è¡Œå­˜å‚¨ï¼ˆå¦‚ MySQL çš„ InnoDB å¼•æ“ï¼‰ä¸­ï¼Œä¸€æ¡è®°å½•çš„æ‰€æœ‰å­—èŠ‚æ˜¯**ç´§å¯†æŒ¨åœ¨ä¸€èµ·**çš„ã€‚

**ç£ç›˜ä¸Šçš„ç‰©ç†æ’åˆ—å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š**

>     [å— 1]: 1, Alice, 25, 5000, 2, Bob, 30, 6000, 3, Carol, 28, 5500 ...
>     

*   **å†™å…¥é€»è¾‘ï¼š** å½“æ–°å‘˜å·¥ Dave å…¥èŒæ—¶ï¼Œæ•°æ®åº“ç›´æ¥åœ¨è¿™ä¸ªæ–‡ä»¶çš„æœ«å°¾ï¼ˆæˆ–è€…æ‰¾ä¸€ä¸ªæœ‰ç©ºéš™çš„æ•°æ®å—ï¼‰è¿½åŠ  `4, Dave, 35, 7000`ã€‚è¿™è¢«ç§°ä¸º**é¡ºåºå†™**ï¼Œé€Ÿåº¦éå¸¸å¿«ã€‚
    
*   **è¯»å–ç¾éš¾ï¼ˆé’ˆå¯¹åˆ†æåœºæ™¯ï¼‰ï¼š** å‡è®¾è€æ¿é—®ï¼šâ€œå…¬å¸çš„**å¹³å‡è–ªèµ„**æ˜¯å¤šå°‘ï¼Ÿâ€
    
    æ•°æ®åº“å¿…é¡»æŠŠåŒ…å«è¿™ä¸‰è¡Œæ•°æ®çš„æ•´ä¸ªæ•°æ®å—ä»ç£ç›˜è¯»åˆ°å†…å­˜ä¸­ã€‚ä¸ºäº†æ‹¿åˆ° `5000`, `6000`, `5500` è¿™ä¸‰ä¸ªæ•°å­—ï¼Œæ•°æ®åº“ä¸å¾—ä¸æŠŠæ— å…³çš„ `Alice`, `Bob`, `Carol` ç­‰æ•°æ®ä¹Ÿä¸€èµ·è¯»å‡ºæ¥ã€‚è¿™äº§ç”Ÿäº†å¤§é‡**æ— æ•ˆçš„ç£ç›˜ I/O**ã€‚
    

* * *

### 2\. åˆ—å­˜å‚¨çš„ç£ç›˜ç»“æ„ï¼šåˆ†é—¨åˆ«ç±»

åœ¨åˆ—å­˜å‚¨ï¼ˆå¦‚ ClickHouseã€æ•°æ®æ¹–é‡Œçš„ Parquet æ–‡ä»¶ï¼‰ä¸­ï¼Œè¡¨ä¼šè¢«å‚ç›´åˆ‡åˆ†ã€‚**æ¯ä¸€åˆ—ä¼šè¢«å•ç‹¬å†™å…¥ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œæˆ–è€…åœ¨åŒä¸€ä¸ªå¤§æ–‡ä»¶é‡Œåˆ†å—è¿ç»­å­˜å‚¨**ã€‚

**ç£ç›˜ä¸Šçš„ç‰©ç†æ’åˆ—å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š**

>     [æ–‡ä»¶ A / å— 1 - IDåˆ—]: 1, 2, 3 ...
>     [æ–‡ä»¶ B / å— 2 - Nameåˆ—]: Alice, Bob, Carol ...
>     [æ–‡ä»¶ C / å— 3 - Ageåˆ—]: 25, 30, 28 ...
>     [æ–‡ä»¶ D / å— 4 - Salaryåˆ—]: 5000, 6000, 5500 ...
>     

*   **è¯»å–ç¦éŸ³ï¼ˆé’ˆå¯¹åˆ†æåœºæ™¯ï¼‰ï¼š** å½“è€æ¿åŒæ ·é—®â€œå…¬å¸çš„**å¹³å‡è–ªèµ„**â€æ—¶ï¼Œæ•°æ®åº“åªéœ€è¦å»ç£ç›˜ä¸Šè¯»å– `[æ–‡ä»¶ D]`ã€‚ç”±äºå…¨æ˜¯è¿ç»­çš„è–ªèµ„æ•°å­—ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è¿›è¡Œé«˜æ•ˆçš„**é¡ºåºè¯»**ï¼Œç›´æ¥è·³è¿‡äº†æ‰€æœ‰çš„å§“åå’Œå¹´é¾„ã€‚è¯»å–çš„æ•°æ®é‡å¯èƒ½åªæœ‰è¡Œå­˜å‚¨çš„ 1/4 ç”šè‡³æ›´å°‘ã€‚
*   **å†™å…¥ç¾éš¾ï¼ˆé’ˆå¯¹äº‹åŠ¡åœºæ™¯ï¼‰ï¼š** å½“æ–°å‘˜å·¥ Dave å…¥èŒæ—¶ï¼Œæ•°æ®åº“ä¸èƒ½åƒè¡Œå­˜å‚¨é‚£æ ·åªä¿®æ”¹ä¸€ä¸ªåœ°æ–¹ï¼Œå®ƒå¿…é¡»åˆ†åˆ«æ‰“å¼€æ–‡ä»¶ Aã€Bã€Cã€Dï¼Œåœ¨å››ä¸ªä¸åŒçš„åœ°æ–¹è¿½åŠ æ•°æ®ã€‚è¿™å¯¼è‡´äº†å¤šæ¬¡**éšæœºå†™**ï¼Œæ‰€ä»¥åˆ—å¼æ•°æ®åº“é€šå¸¸æåº¦åæ„Ÿå•æ¡ `INSERT`ï¼Œè€Œæ˜¯è¦æ±‚ä½ æ”’å¤Ÿä¸€ä¸‡æ¡æ•°æ®å†è¿›è¡Œâ€œæ‰¹é‡å†™å…¥â€ã€‚

* * *

### 3\. ä¸ºä»€ä¹ˆè¯´åˆ—å­˜å‚¨æ˜¯â€œå‹ç¼©ä¹‹ç‹â€ï¼Ÿ

ç£ç›˜ç»“æ„çš„æ”¹å˜ä¸ä»…é™ä½äº†è¯»å– I/Oï¼Œè¿˜å¸¦æ¥äº†åˆ—å­˜å‚¨æœ€å¼ºå¤§çš„æ€æ‰‹é”ï¼š**æé™æ•°æ®å‹ç¼©**ã€‚

åœ¨è¡Œå­˜å‚¨çš„å—é‡Œï¼Œå­—æ¯ï¼ˆNameï¼‰ã€çŸ­æ•´æ•°ï¼ˆAgeï¼‰ã€é•¿æ•´æ•°ï¼ˆSalaryï¼‰æ··æ‚åœ¨ä¸€èµ·ï¼Œå¾ˆéš¾æ‰¾åˆ°è§„å¾‹ï¼Œä¸€èˆ¬åªèƒ½ç”¨é€šç”¨çš„å‹ç¼©ç®—æ³•ï¼ˆå¦‚ Gzipï¼‰ï¼Œå‹ç¼©æ¯”æœ‰é™ã€‚

ä½†åœ¨åˆ—å­˜å‚¨çš„å—é‡Œï¼Œæ¯”å¦‚â€œæ€§åˆ«â€è¿™ä¸€åˆ—ï¼Œåœ¨ç£ç›˜ä¸Šçœ‹èµ·æ¥å°±æ˜¯è¿ç»­çš„ï¼š

>     ç”·, ç”·, å¥³, ç”·, å¥³, å¥³, å¥³, ç”·...
>     

å› ä¸ºæ•°æ®ç±»å‹ç»å¯¹å•ä¸€ï¼Œåˆ—å­˜å‚¨å¯ä»¥ä½¿ç”¨éå¸¸æç«¯çš„ç‰©ç†å‹ç¼©ç®—æ³•ï¼Œæ¯”å¦‚ï¼š

*   **å­—å…¸ç¼–ç ï¼ˆDictionary Encodingï¼‰ï¼š** æŠŠâ€œç”·â€å­˜ä¸º `0`ï¼Œâ€œå¥³â€å­˜ä¸º `1`ã€‚
*   **æ¸¸ç¨‹ç¼–ç ï¼ˆRun-Length Encodingï¼‰ï¼š** å¦‚æœæœ‰è¿ç»­ 100 ä¸ªç”·ï¼Œä¸ç”¨å­˜ 100 æ¬¡â€œç”·â€ï¼Œç›´æ¥åœ¨ç£ç›˜ä¸Šå­˜ `(ç”·, 100)`ã€‚

è¿™ç§åŸºäºç£ç›˜ç‰©ç†ç»“æ„çš„ç‰¹æ€§ï¼Œä½¿å¾—åˆ—å­˜å‚¨çš„ä½“ç§¯é€šå¸¸åªæœ‰è¡Œå­˜å‚¨çš„ **ååˆ†ä¹‹ä¸€**ã€‚

è¡Œå­˜å‚¨å­˜å‚¨ç¢ç‰‡
=======

**æ•°æ®é¡µï¼ˆPage/Blockï¼‰é€šå¸¸ç»å¯¹ä¸ä¼š100%å­˜æ»¡ï¼Œæ•°æ®åº“ä¼šåˆ»æ„ç•™å‡ºç©ºç™½ï¼Œè€Œè¿™ç¡®å®ç›´æ¥å¼•å‘äº†æ•°æ®åº“çš„ç¢ç‰‡åŒ–ï¼ˆFragmentationï¼‰é—®é¢˜ã€‚**

è®©æˆ‘ä»¬æŠŠè¿™å±‚çª—æˆ·çº¸æ…ç ´ï¼Œçœ‹çœ‹æ•°æ®åº“å¼•æ“åœ¨åº•å±‚åˆ°åº•æ˜¯æ€ä¹ˆæƒè¡¡çš„ã€‚

### 1\. åˆ»æ„çš„ç•™ç™½ï¼šå¡«å……å› å­ï¼ˆFill Factorï¼‰

åœ¨è¡Œå­˜å‚¨æ•°æ®åº“ï¼ˆå¦‚ SQL Server, MySQL, PostgreSQLï¼‰ä¸­ï¼Œå½“ä½ åˆ›å»ºä¸€ä¸ªè¡¨æˆ–ç´¢å¼•æ—¶ï¼Œåº•å±‚æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å‚æ•°å«åš **å¡«å……å› å­ï¼ˆFill Factorï¼‰**ã€‚

å¦‚æœä½ æŠŠå¡«å……å› å­è®¾ç½®ä¸º **80%**ï¼Œè¿™æ„å‘³ç€æ•°æ®åº“åœ¨å‘ä¸€ä¸ªæ–°çš„æ•°æ®é¡µå†™å…¥æ•°æ®æ—¶ï¼Œåªè¦æ•°æ®å åˆ°äº†è¿™ä¸ªé¡µæ€»å®¹é‡çš„ 80%ï¼ˆæ¯”å¦‚ 8KB çš„é¡µå†™äº† 6.4KBï¼‰ï¼Œå®ƒå°±ä¼šè®¤ä¸ºè¿™ä¸ªé¡µâ€œå·²ç»æ»¡äº†â€ï¼Œç„¶åå»å¼€å¯ä¸‹ä¸€ä¸ªå…¨æ–°çš„é¡µã€‚å‰©ä¸‹çš„ **20%** ç©ºé—´ï¼Œå°±æ˜¯åˆ»æ„ç•™å‡ºçš„ç©ºç™½ã€‚

### 2\. ä¸ºä»€ä¹ˆè¦ç•™ç™½ï¼Ÿä¸ºäº†åº”å¯¹â€œå˜èƒ–â€çš„æ•°æ®

ä¸ºä»€ä¹ˆæ”¾ç€å¥½å¥½çš„ç£ç›˜ç©ºé—´ä¸ç”¨ï¼Œéè¦ç•™ç™½ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†åº”ä»˜ **UPDATEï¼ˆä¿®æ”¹ï¼‰** æ“ä½œå¸¦æ¥çš„ä¸å¯é¢„çŸ¥æ€§ã€‚

å‡è®¾æœ‰ä¸€è¡Œè®°å½•ï¼š`ID=1, Name='Tom', Bio='Hi'`ã€‚è¿™è¡Œæ•°æ®éå¸¸çŸ­ï¼Œè¢«ç´§ç´§åœ°å¡åœ¨ä¸€ä¸ªæ•°æ®é¡µé‡Œã€‚

æ˜å¤©ï¼ŒTom æŠŠä»–çš„ä¸ªäººç®€ä»‹ï¼ˆBioï¼‰æ”¹æˆäº†é•¿è¾¾ 1000 å­—çš„å°ä½œæ–‡ã€‚

*   **å¦‚æœé¡µå·²ç» 100% æ»¡äº†ï¼š** è¿™ä¸ªé¡µé‡Œæ ¹æœ¬æ²¡æœ‰å¤šä½™çš„ç©ºé—´æ”¾ä¸‹ Tom å˜é•¿çš„æ•°æ®ã€‚æ•°æ®åº“åªèƒ½æŠŠ Tom çš„æ–°æ•°æ®ç¡¬ç”Ÿç”Ÿâ€œæ‹†â€å¼€ï¼Œæˆ–è€…æŠŠæ•´è¡Œæ•°æ®æ¬è¿åˆ°ä¸€ä¸ªæ–°çš„é¡µé‡Œï¼Œå¹¶åœ¨åŸæ¥çš„ä½ç½®ç•™ä¸ªâ€œæŒ‡é’ˆâ€ï¼ˆè¿™å«**è¡Œè¿ç§»/Row Migration**ï¼‰ã€‚è¿™ä¼šå¯¼è‡´ä»¥åæ¯æ¬¡æŸ¥ Tom çš„æ•°æ®ï¼Œç¡¬ç›˜ç£å¤´éƒ½è¦è·³è·ƒä¸¤æ¬¡ï¼Œæ€§èƒ½æš´è·Œã€‚
*   **å¦‚æœé¡µç•™äº† 20% çš„ç©ºç™½ï¼š** æ•°æ®åº“å°±å¯ä»¥ä»å®¹åœ°æŠŠ Tom å˜é•¿çš„æ•°æ®ç›´æ¥å†™åœ¨è¿™ä¸ªé¡µçš„é¢„ç•™ç©ºé—´é‡Œã€‚æ•°æ®ä¾ç„¶åœ¨ç‰©ç†ä¸Šæ˜¯åœ¨ä¸€èµ·çš„ã€‚

è¿™ç§æœºåˆ¶ä»¥åŠåç»­çš„æ•°æ®å¢åˆ æ”¹ï¼Œå°±æ˜¯å¯¼è‡´æ•°æ®åº“ç¢ç‰‡çš„ç½ªé­ç¥¸é¦–ã€‚ç¢ç‰‡åŒ–ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼Œéƒ½å’Œè¿™äº›â€œç©ºç™½â€æ¯æ¯ç›¸å…³ï¼š

*   \*\*å†…éƒ¨ç¢ç‰‡ (Internal Fragmentation) \*\*
    
    å¦‚æœä½ çš„ä¸šåŠ¡ç»å¤§éƒ¨åˆ†æ˜¯ `INSERT`ï¼ˆåªæ–°å¢ï¼‰ï¼Œå¾ˆå°‘ `UPDATE`ï¼Œé‚£ä¹ˆä½ é¢„ç•™çš„é‚£ 20% ç©ºé—´å¯èƒ½æ°¸è¿œç”¨ä¸ä¸Šã€‚è¿™å°±å½¢æˆäº†â€œå†…éƒ¨ç¢ç‰‡â€ã€‚ä¸€ä¸ª 100GB çš„æ•°æ®åº“æ–‡ä»¶ï¼Œå¯èƒ½é‡Œé¢æœ‰ 20GB éƒ½æ˜¯è¿™äº›ç©ºç©ºå¦‚ä¹Ÿçš„é¢„ç•™ç¼éš™ã€‚æ­¤å¤–ï¼Œå½“ä½  `DELETE`ï¼ˆåˆ é™¤ï¼‰ä¸€æ¡è®°å½•æ—¶ï¼Œå®ƒåŸæœ¬å ç”¨çš„ç©ºé—´å¹¶ä¸ä¼šé©¬ä¸Šè¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯å˜æˆäº†ä¸€ä¸ªâ€œç©ºæ´â€ï¼Œè¿™ä¹Ÿå±äºå†…éƒ¨ç¢ç‰‡ã€‚
    
*   **å¤–éƒ¨ç¢ç‰‡ (External Fragmentation) / é¡µåˆ†è£‚ (Page Split) â€”â€” â€œç©ºé—´è¢«æ‰“ç¢äº†â€**
    
    å“ªæ€•ä½ ç•™äº† 20% çš„ç©ºç™½ï¼Œæœ‰æ—¶å€™æ•°æ®æ›´æ–°å®åœ¨å¤ªå¤§ï¼Œæˆ–è€…æ’å…¥çš„æ–°æ•°æ®ç¡¬è¦æŒ¤è¿›ä¸¤ä¸ªæ—§æ•°æ®ä¹‹é—´ï¼Œç©ºç™½è¿˜æ˜¯ä¸å¤Ÿç”¨äº†ã€‚è¿™æ—¶å€™æ•°æ®åº“è¢«è¿«æ‰§è¡Œ**é¡µåˆ†è£‚ï¼ˆPage Splitï¼‰**ï¼šå®ƒä¼šç”³è¯·ä¸€ä¸ªæ–°çš„é¡µï¼ŒæŠŠåŸæ¥é¡µé‡Œçš„ä¸€åŠæ•°æ®æ¬è¿‡å»ï¼Œè…¾å‡ºä½ç½®ã€‚è¿™ä¸ªæ–°ç”³è¯·çš„é¡µåœ¨ç‰©ç†ç£ç›˜ä¸Šï¼Œé€šå¸¸å’ŒåŸæ¥çš„é¡µç›¸éš”åä¸‡å…«åƒé‡Œã€‚åŸæœ¬å¯ä»¥â€œé¡ºåºè¯»å–â€çš„æ•°æ®ï¼Œç°åœ¨å˜æˆäº†ç–¯ç‹‚çš„â€œéšæœºè¯»å–â€ã€‚
    

æ²¡æœ‰å¯å˜é•¿åº¦åˆ—ä¹Ÿéœ€è¦é¢„ç•™
------------

å¦‚æœè¡¨é‡Œå…¨éƒ½æ˜¯**å®šé•¿åˆ—**ï¼ˆFixed-length columnsï¼Œæ¯”å¦‚ `INT`, `BIGINT`, `CHAR(50)`, `DATE`ï¼‰ï¼Œé‚£ä¹ˆæŠŠ `Age=20` æ”¹æˆ `Age=99`ï¼Œæˆ–è€…æŠŠ `Status='A'` æ”¹æˆ `Status='B'`ï¼Œåœ¨ç‰©ç†ç£ç›˜ä¸Šéƒ½æ˜¯çº¯ç²¹çš„â€œç­‰é•¿å­—èŠ‚æ›¿æ¢â€ã€‚**è¡Œæ ¹æœ¬ä¸ä¼šå˜èƒ–ã€‚**

æ—¢ç„¶è¡Œä¸ä¼šå˜èƒ–ï¼Œé‚£è¿˜éœ€è¦é¢„ç•™ç©ºç™½ï¼ˆè®¾ç½®ä½äº 100% çš„å¡«å……å› å­ï¼‰å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š**é€šå¸¸ä»ç„¶éœ€è¦é¢„ç•™ï¼** å› ä¸ºå“ªæ€• `UPDATE` ä¸æƒ¹éº»çƒ¦äº†ï¼Œ**`INSERT`ï¼ˆæ’å…¥ï¼‰** ä¾ç„¶å¯èƒ½ä¼šæŠŠå®Œç¾æ’åˆ—çš„æ•°æ®é¡µæŒ¤çˆ†ã€‚

è¿™èƒŒåçš„æ ¹æœ¬åŸå› ï¼Œåœ¨äºå…³ç³»å‹æ•°æ®åº“çš„**èšç°‡ç´¢å¼•ï¼ˆClustered Indexï¼Œå³ B+ æ ‘ï¼‰ç»“æ„**ã€‚

### 1\. æ ¸å¿ƒåŸå› ï¼šä¸ºäº†åº”å¯¹â€œä¹±åºæ’å…¥ï¼ˆOut-of-order Insertï¼‰â€

åœ¨ MySQL (InnoDBå¼•æ“) ç­‰ç»å¤§å¤šæ•°å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œè¡¨é‡Œçš„æ•°æ®å¹¶ä¸æ˜¯åƒå¾€ç®±å­é‡Œæ‰”çƒä¸€æ ·éšä¾¿ä¹±ä¸¢çš„ï¼Œè€Œæ˜¯**ä¸¥æ ¼æŒ‰ç…§ä¸»é”®ï¼ˆPrimary Keyï¼‰çš„å¤§å°é¡ºåºæ’åˆ—çš„**ã€‚

å‡è®¾ä½ çš„æ•°æ®é¡µ 100% å­˜æ»¡äº†ï¼Œå¹¶ä¸”æ²¡æœ‰å¯å˜é•¿åº¦åˆ—ï¼š

>     [æ•°æ®é¡µ 1]: ID=1, ID=3, ID=5, ID=7
>     

è¿™æ—¶å€™ï¼Œä¸šåŠ¡ç³»ç»Ÿçªç„¶è¦**æ’å…¥ä¸€æ¡ `ID=4` çš„æ–°è®°å½•**ã€‚

*   **å¼ºåˆ¶æ’é˜Ÿï¼š** å› ä¸º B+ æ ‘çš„ç»å¯¹ç§©åºï¼Œæ•°æ®åº“**ä¸èƒ½**æŠŠ `ID=4` å†™åˆ°æ–‡ä»¶æœ«å°¾çš„æ–°é¡µé‡Œï¼Œå®ƒ**å¿…é¡»**æŠŠ `ID=4` å¡è¿›ä¸Šé¢çš„ `[æ•°æ®é¡µ 1]` ä¸­ï¼Œæ”¾åœ¨ 3 å’Œ 5 ä¹‹é—´ã€‚
*   **é¡µåˆ†è£‚çˆ†å‘ï¼š** ä½†æ˜¯ `[æ•°æ®é¡µ 1]` å·²ç» 100% æ»¡äº†ï¼æ²¡æœ‰ä»»ä½•ç¼éš™èƒ½å¡ä¸‹å“ªæ€•æ˜¯å®šé•¿çš„ `ID=4`ã€‚æ­¤æ—¶ï¼Œæ•°æ®åº“åˆ«æ— é€‰æ‹©ï¼Œåªèƒ½å½“åœºæ‰§è¡Œ**é¡µåˆ†è£‚ï¼ˆPage Splitï¼‰**ï¼šç”³è¯·ä¸€ä¸ªæ–°é¡µï¼ŒæŠŠ 5 å’Œ 7 æ¬è¿‡å»ï¼Œå†æŠŠ 4 å¡è¿›å»ã€‚

**ç»“è®ºï¼š** åªè¦ä½ çš„æ’å…¥æ“ä½œä¸æ˜¯ç»å¯¹çš„â€œä»å°åˆ°å¤§ä¾æ¬¡é€’å¢â€ï¼ˆä¾‹å¦‚ä½ ä½¿ç”¨äº† UUID ä½œä¸ºä¸»é”®ï¼Œæˆ–è€…ä¸šåŠ¡å…è®¸æ’å…¥å†å²æ—¶é—´çš„æ•°æ®ï¼‰ï¼Œä½ å°±**å¿…é¡»**ç»™é¡µç•™å‡ºç©ºç™½ï¼ˆæ¯”å¦‚ 80% å¡«å……å› å­ï¼‰ï¼Œè®©è¿™äº›â€œåŠè·¯æ€å‡ºæ¥çš„ç¨‹å’¬é‡‘â€æœ‰åœ°æ–¹å¯ä»¥æ’é˜Ÿã€‚

### 2\. å¦ä¸€ä¸ªéšè—çš„å¹½çµï¼šMVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰

å¦‚æœä½ ç”¨çš„æ˜¯ PostgreSQL ç­‰æ•°æ®åº“ï¼Œè¿˜ä¼šé‡åˆ°ä¸€ä¸ªæ›´ç‰¹åˆ«çš„æœºåˆ¶ã€‚

åœ¨ PostgreSQL çš„åº•å±‚å“²å­¦é‡Œï¼Œ**æ ¹æœ¬æ²¡æœ‰çœŸæ­£çš„â€œåŸåœ° UPDATEâ€**ã€‚å½“ä½ æ‰§è¡Œä¿®æ”¹æ—¶ï¼š

1.  å®ƒä¼šæŠŠä½ åŸæ¥çš„é‚£è¡Œæ•°æ®æ ‡è®°ä¸ºâ€œå·²åºŸå¼ƒï¼ˆDead Tupleï¼‰â€ã€‚
2.  ç„¶åï¼Œå®ƒä¼šæŠŠä¿®æ”¹åçš„æ–°æ•°æ®**å½“æˆä¸€æ¡å…¨æ–°çš„è®°å½•ï¼ˆINSERTï¼‰**ï¼Œå†™å…¥åˆ°ç£ç›˜é‡Œã€‚

å³ä½¿ä½ å…¨æ˜¯å®šé•¿åˆ—ï¼Œå“ªæ€•åªæ˜¯æŠŠ `ID=1, Status=0` æ”¹æˆ `ID=1, Status=1`ï¼Œæ•°æ®åº“ä¹Ÿéœ€è¦é¢å¤–çš„ç©ºé—´æ¥å­˜æ”¾è¿™æ¡â€œæ–°è®°å½•â€ã€‚å¦‚æœä½ æŠŠé¡µ 100% å¡«æ»¡äº†ï¼Œæ–°è®°å½•å°±åªèƒ½è¢«è¿«å†™åˆ°åˆ«çš„é¡µå»ï¼Œè¿™ä¼šä¸¥é‡é™ä½æŸ¥è¯¢æ€§èƒ½ï¼ˆç ´åäº† PostgreSQL å¼•ä»¥ä¸ºå‚²çš„ HOT ä¼˜åŒ–æœºåˆ¶ï¼‰ã€‚æ‰€ä»¥å®ƒä¹Ÿå¿…é¡»ç•™ç™½ã€‚

* * *

### é‚£ä¹ˆï¼Œä»€ä¹ˆæ—¶å€™å¯ä»¥å¤§èƒ†åœ° 100% å¡«æ»¡ï¼ˆFill Factor = 100ï¼‰ï¼Ÿ

å¦‚æœä½ æƒ³æŠŠç£ç›˜åˆ©ç”¨ç‡å‹æ¦¨åˆ°æé™ï¼Œä¸€æ»´ç©ºç™½éƒ½ä¸ç•™ï¼Œä½ å¿…é¡»**åŒæ—¶æ»¡è¶³**ä»¥ä¸‹ä¸‰ä¸ªè‹›åˆ»çš„æ¡ä»¶ï¼š

1.  **æ²¡æœ‰å˜é•¿åˆ—ï¼š** ä¹Ÿå°±æ˜¯ä½ æåˆ°çš„ï¼Œæ²¡æœ‰ `VARCHAR`, `TEXT`, `BLOB` ç­‰ï¼Œä¿è¯ UPDATE ä¸ä¼šæ’‘çˆ†è¡Œã€‚
2.  **ä¸»é”®ä¸¥æ ¼é€’å¢ï¼š** ä½¿ç”¨è‡ªå¢ IDï¼ˆAuto-Incrementï¼‰æˆ–é›ªèŠ±ç®—æ³• IDã€‚æ–°æ•°æ®æ°¸è¿œæ¯”è€æ•°æ®çš„ä¸»é”®å¤§ï¼Œæ°¸è¿œåœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ ï¼Œ**ç»å¯¹ä¸ä¼šå‘ç”Ÿâ€œä¸­é—´æ’é˜Ÿâ€**ã€‚
3.  **æå°‘æˆ–æ²¡æœ‰ UPDATE/DELETEï¼š** æ•°æ®å†™è¿›å»å°±æ˜¯ç”¨æ¥æŸ¥çš„ï¼ˆæ¯”å¦‚æ—¥å¿—æµæ°´è¡¨ã€å½’æ¡£è¡¨ï¼‰ã€‚

å¦‚æœæ˜¯è¿™ç§åœºæ™¯ï¼ŒæŠŠå¡«å……å› å­è®¾ä¸º 100% æ˜¯éå¸¸æ˜æ™ºçš„ï¼Œå¯ä»¥è®©ç£ç›˜ I/O æ•ˆç‡è¾¾åˆ°æœ€é«˜ã€‚

åˆ—å­˜å‚¨æœ‰æ²¡æœ‰å­˜å‚¨ç¢ç‰‡
==========

åˆ—å¼å­˜å‚¨å¼•æ“ï¼šæ•°æ®å˜æ›´ï¼ˆMutationï¼‰ä¸åº•å±‚åˆå¹¶æœºåˆ¶è¯´æ˜
------------------------------

ä¼ ç»Ÿè¡Œå¼å…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚ InnoDBï¼‰é€šè¿‡é¢„ç•™ç©ºé—´ï¼ˆFill Factorï¼‰å’Œé¡µåˆ†è£‚ï¼ˆPage Splitï¼‰æ¥æ”¯æŒæ•°æ®çš„åŸåœ°ä¿®æ”¹ï¼ˆIn-place Updateï¼‰ã€‚åˆ—å¼å­˜å‚¨å¼•æ“ï¼ˆå¦‚ ClickHouse, HBase, ç°ä»£æ•°æ®æ¹–æ ¼å¼ Parquet/Icebergï¼‰ä¸ºè¿½æ±‚æè‡´çš„ I/O é¡ºåºè¯»å–æ€§èƒ½ä¸æé™æ•°æ®å‹ç¼©ç‡ï¼Œé€šå¸¸å°†æ•°æ®æ–‡ä»¶è®¾è®¡ä¸º**ä¸å¯å˜ï¼ˆImmutableï¼‰** ä¸” 100% ç´§å‡‘å¡«å……ã€‚

åœ¨æ­¤æ¶æ„ä¸‹ï¼Œåˆ—å¼å­˜å‚¨å½»åº•æ‘’å¼ƒäº†åŸåœ°ä¿®æ”¹ï¼Œé‡‡ç”¨ **è¿½åŠ å†™å…¥ï¼ˆAppend-Onlyï¼‰** ç»“åˆ **LSM-Treeï¼ˆLog-Structured Merge-Treeï¼Œæ—¥å¿—ç»“æ„åˆå¹¶æ ‘ï¼‰** æˆ–ç±»ä¼¼çš„æ•°æ®å˜å¼‚æ¶æ„æ¥å¤„ç†å¢ï¼ˆInsertï¼‰ã€åˆ ï¼ˆDeleteï¼‰ã€æ”¹ï¼ˆUpdateï¼‰æ“ä½œã€‚

* * *

### 1\. æ ¸å¿ƒæ¶æ„åŸåˆ™ï¼šä¸å¯å˜æ€§ï¼ˆImmutabilityï¼‰

åœ¨åˆ—å­˜å‚¨çš„ç‰©ç†å±‚é¢ä¸Šï¼Œä¸€æ—¦æ•°æ®å—ï¼ˆBlock/Segmentï¼‰è¢«å‹ç¼©å¹¶è½ç›˜ï¼Œè¯¥æ–‡ä»¶å³è¿›å…¥åªè¯»çŠ¶æ€ï¼Œ**ç¦æ­¢ä»»ä½•å½¢å¼çš„å†…éƒ¨å­—èŠ‚æ›¿æ¢æˆ–ä½ç§»**ã€‚

æ­¤è®¾è®¡çš„ä¼˜åŠ¿åœ¨äºï¼š

*   **æ¶ˆé™¤é”ç«äº‰ï¼š** è¯»å†™æ“ä½œäº’ä¸å¹²æ‰°ï¼Œæå¤§åœ°æå‡äº†å¹¶å‘è¯»å–æ€§èƒ½ã€‚
*   **æè‡´å‹ç¼©ï¼š** æ•°æ®å—å®Œå…¨è¿ç»­ä¸”æ— ç¢ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨æ¿€è¿›çš„å­—å…¸ç¼–ç å’Œæ¸¸ç¨‹ç¼–ç ã€‚
*   **é¡ºåº I/Oï¼š** é¿å…äº†ç£å¤´éšæœºå¯»é“å¼€é”€ã€‚

* * *

### 2\. å†™å…¥è·¯å¾„ï¼ˆWrite Pathï¼‰ï¼šå¢åˆ æ”¹çš„ç»Ÿä¸€åŒ–å¤„ç†

ç”±äºæ–‡ä»¶ä¸å¯å˜ï¼Œåˆ—å­˜å‚¨å°†æ‰€æœ‰çš„ `INSERT`ã€`UPDATE` å’Œ `DELETE` æ“ä½œç»Ÿä¸€è½¬åŒ–ä¸º**è¿½åŠ å†™å…¥ï¼ˆAppendï¼‰**è¡Œä¸ºã€‚

*   **INSERTï¼ˆæ–°å¢ï¼‰ï¼š**
    
    1.  æ•°æ®é¦–å…ˆå†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆMemTableï¼‰ï¼Œå¹¶è®°å½•é¢„å†™æ—¥å¿—ï¼ˆWALï¼‰ä»¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±ã€‚
    2.  å½“ç¼“å†²åŒºè¾¾åˆ°é˜ˆå€¼ï¼Œæ•°æ®åœ¨å†…å­˜ä¸­æŒ‰åˆ—è½¬æ¢ä¸ºåˆ—å¼ç»“æ„å¹¶å‹ç¼©ã€‚
    3.  ä½œä¸ºä¸€ä¸ªå…¨æ–°çš„ã€å¾®å‹çš„ã€100% å¡«æ»¡çš„ä¸å¯å˜æ•°æ®æ®µï¼ˆData Part / SSTableï¼‰åˆ·å†™ï¼ˆFlushï¼‰åˆ°ç£ç›˜ã€‚
*   **UPDATEï¼ˆæ›´æ–°ï¼‰ï¼š**
    
    å¼•æ“ä¸ä¼šå®šä½å¹¶ä¿®æ”¹æ—§æ–‡ä»¶ä¸­çš„è®°å½•ã€‚ç›¸åï¼Œå®ƒä¼šç”Ÿæˆä¸€æ¡å…·æœ‰**ç›¸åŒä¸»é”®ï¼ˆPrimary Keyï¼‰ä½†å…·æœ‰æ›´é«˜ç‰ˆæœ¬å·æˆ–æœ€æ–°æ—¶é—´æˆ³**çš„å…¨æ–°è®°å½•ï¼Œå¹¶å°†å…¶è¿½åŠ å†™å…¥åˆ°æ–°çš„æ•°æ®æ®µä¸­ã€‚æ­¤è®°å½•ç§°ä¸ºâ€œå¢é‡ï¼ˆDeltaï¼‰â€æ•°æ®ã€‚
    
*   **DELETEï¼ˆåˆ é™¤ï¼‰ï¼š**
    
    å¼•æ“åŒæ ·ä¸ä¼šå»æ—§æ–‡ä»¶ä¸­æ“¦é™¤æ•°æ®ã€‚å®ƒä¼šç”Ÿæˆä¸€æ¡ç‰¹æ®Šçš„è¿½åŠ è®°å½•ï¼Œè¯¥è®°å½•åŒ…å«è¢«åˆ é™¤æ•°æ®çš„ä¸»é”®ï¼Œä»¥åŠä¸€ä¸ªç‰¹å®šçš„åˆ é™¤æ ‡è®°ï¼Œé€šå¸¸ç§°ä¸º**å¢“ç¢‘æ ‡è®°ï¼ˆTombstoneï¼‰**ã€‚
    

* * *

### 3\. è¯»å–è·¯å¾„ï¼ˆRead Pathï¼‰ï¼šè¯»æ—¶åˆå¹¶ï¼ˆMerge-on-Readï¼‰

ç”±äºæ•°æ®çš„å†å²ç‰ˆæœ¬ã€æ›´æ–°å¢é‡å’Œåˆ é™¤æ ‡è®°åˆ†æ•£åœ¨å¤šä¸ªä¸åŒçš„åªè¯»æ–‡ä»¶ä¸­ï¼ŒæŸ¥è¯¢æ—¶å¿…é¡»è¿›è¡ŒåŠ¨æ€æ•´åˆï¼Œä»¥ä¿è¯æ•°æ®çš„ **ACID éš”ç¦»æ€§ä¸ä¸€è‡´æ€§**ã€‚

å½“å‘èµ· `SELECT` æŸ¥è¯¢æ—¶ï¼Œæ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **å¤šè·¯è¯»å–ï¼š** å¼•æ“åŒæ—¶æ‰«ææ¶‰åŠè¯¥æŸ¥è¯¢çš„æ‰€æœ‰æ—§æ•°æ®æ®µä»¥åŠåŒ…å«æœ€æ–°å˜æ›´çš„æ–°æ•°æ®æ®µã€‚
2.  **å†…å­˜åˆå¹¶ï¼ˆMergeï¼‰ï¼š** æ•°æ®åœ¨å†…å­˜ä¸­æ ¹æ®ä¸»é”®ï¼ˆPrimary Keyï¼‰è¿›è¡Œå¯¹é½ã€‚
3.  **ç‰ˆæœ¬ä»²è£ï¼š**
    *   è‹¥å‘ç°å¤šä¸ªç›¸åŒä¸»é”®çš„è®°å½•ï¼Œå¼•æ“æ¯”è¾ƒå…¶ç‰ˆæœ¬å·/æ—¶é—´æˆ³ï¼Œ**ä»…ä¿ç•™ç‰ˆæœ¬å·æœ€é«˜çš„ä¸€æ¡**ã€‚
    *   è‹¥æœ€é«˜ç‰ˆæœ¬çš„è®°å½•æºå¸¦**å¢“ç¢‘æ ‡è®°ï¼ˆTombstoneï¼‰**ï¼Œåˆ™åœ¨ç»“æœé›†ä¸­ä¸¢å¼ƒè¯¥ä¸»é”®çš„æ‰€æœ‰è®°å½•ã€‚
4.  **è¿”å›ç»“æœï¼š** å°†æœ€ç»ˆæ­£ç¡®çš„å¿«ç…§æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

_(æ³¨ï¼šæ­¤è¿‡ç¨‹ä¼šå¼•å‘è¯»æ”¾å¤§ / Read Amplificationï¼Œå› ä¸ºæŸ¥è¯¢éœ€è¦æ‰«æå¹¶ä¸¢å¼ƒå¤§é‡è¿‡æœŸæˆ–å·²åˆ é™¤çš„æ•°æ®ã€‚)_

* * *

### 4\. åå°å›æ”¶æœºåˆ¶ï¼šCompactionï¼ˆæ•°æ®åˆå¹¶ï¼‰

ä¸ºäº†è§£å†³ä¸æ–­è¿½åŠ äº§ç”Ÿçš„å°æ–‡ä»¶è¿‡å¤šä»¥åŠæŸ¥è¯¢æ—¶çš„â€œè¯»æ”¾å¤§â€é—®é¢˜ï¼Œåˆ—å¼å­˜å‚¨ä¾èµ–åå°å¼‚æ­¥çš„ **Compactionï¼ˆåˆå¹¶ï¼‰** çº¿ç¨‹æ¥ç»´æŠ¤ç³»ç»Ÿçš„å¥åº·è¿è½¬ã€‚

**Compaction æ ¸å¿ƒé€»è¾‘ï¼š**

1.  **æ–‡ä»¶é€‰å–ï¼š** å¼•æ“æ ¹æ®ç‰¹å®šçš„åˆå¹¶ç­–ç•¥ï¼ˆå¦‚ Size-Tiered æˆ– Leveledï¼‰åœ¨åå°é€‰ä¸­è‹¥å¹²ä¸ªå…·æœ‰é‡å æ•°æ®çš„æ—§æ•°æ®æ®µã€‚
2.  **ç‰©ç†åˆå¹¶ï¼š** å°†è¿™äº›æ–‡ä»¶è¯»å…¥å†…å­˜ï¼Œæ‰§è¡Œä¸â€œè¯»å–è·¯å¾„â€ç›¸åŒçš„ç‰ˆæœ¬ä»²è£å’Œå¢“ç¢‘æ¸…ç†ã€‚
3.  **é‡å†™è½ç›˜ï¼š** å°†æ¸…ç†æ‰è¿‡æœŸæ•°æ®ï¼ˆDead Tuplesï¼‰åå‰©ä¸‹çš„æœ‰æ•ˆæ•°æ®ï¼Œé‡æ–°æŒ‰åˆ—é«˜æ¯”ä¾‹å‹ç¼©ï¼Œ**ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ã€ä½“ç§¯æ›´å¤§çš„ä¸å¯å˜æ•°æ®æ–‡ä»¶**ã€‚
4.  **åŸå­æ›¿æ¢ï¼š** æ›´æ–°å…ƒæ•°æ®æŒ‡é’ˆï¼Œå°†è¯»è¯·æ±‚æŒ‡å‘æ–°æ–‡ä»¶ï¼Œå¹¶ç‰©ç†åˆ é™¤ï¼ˆPurgeï¼‰åŸæœ‰çš„æ—§æ–‡ä»¶ã€‚

é€šè¿‡ Compaction æœºåˆ¶ï¼Œç³»ç»Ÿæœ€ç»ˆå›æ”¶äº†è¢« `UPDATE` å’Œ `DELETE` å ç”¨çš„æ— æ•ˆå­˜å‚¨ç©ºé—´ï¼ˆæ¶ˆé™¤äº†é€»è¾‘ç¢ç‰‡ï¼‰ï¼Œå¹¶ç»´æŒäº†æ–‡ä»¶æ•°é‡çš„ç›¸å¯¹ç¨³å®šã€‚

åˆ—å¼å­˜å‚¨ç‰©ç†ç»“æ„ï¼šChunk (æ•°æ®å—) ä¸è½»é‡çº§ç´¢å¼•æœºåˆ¶
=============================

åœ¨åˆ—å¼å­˜å‚¨çš„ç‰©ç†å®ç°ä¸­ï¼Œæ•°æ®å¹¶éå°†ä¸€æ•´åˆ—æ— é™åˆ¶åœ°å­˜æ”¾åœ¨å•ä¸€æ–‡ä»¶ä¸­ã€‚ä¸ºäº†æ»¡è¶³åˆ†å¸ƒå¼å¤„ç†ã€å†…å­˜é™åˆ¶ä»¥åŠé«˜æ•ˆè¿‡æ»¤çš„éœ€æ±‚ï¼Œåˆ—å­˜å‚¨å¼•å…¥äº† **Chunkï¼ˆæ•°æ®å—/åˆ†å—ï¼‰** çš„æ¦‚å¿µã€‚å¹¶ä¸”ï¼Œä¸ºäº†å®ç°æè‡´çš„ I/O è£å‰ªï¼ˆI/O Pruningï¼‰ï¼ŒChunk çº§åˆ«æˆ–æ›´ç»†ç²’åº¦çš„å±‚é¢ç¡®å®**å¹¿æ³›ä¸”å¿…ç„¶åœ°ä¿å­˜äº†æœ€å¤§å€¼ï¼ˆMaxï¼‰ã€æœ€å°å€¼ï¼ˆMinï¼‰ä»¥åŠå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰** ç­‰å…ƒæ•°æ®ã€‚

* * *

### 1\. æ¦‚å¿µå®šä¹‰ï¼šä»€ä¹ˆæ˜¯ Chunkï¼Ÿ

**Chunkï¼ˆé€šå¸¸åœ¨ä¸åŒæŠ€æœ¯æ ˆä¸­æœ‰ä¸åŒçš„ç§°å‘¼ï¼Œå¦‚ Parquet ä¸­çš„ Row Groupï¼ŒClickHouse ä¸­çš„ Granuleï¼ŒSnowflake ä¸­çš„ Micro-partitionï¼‰** æ˜¯åˆ—å¼æ•°æ®åº“ä¸­æ•°æ®æ°´å¹³åˆ’åˆ†çš„åŸºæœ¬ç‰©ç†å•å…ƒã€‚

è™½ç„¶åˆ—å­˜å‚¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯â€œæŒ‰åˆ—å­˜å‚¨â€ï¼Œä½†åœ¨ç‰©ç†å±‚é¢ä¸Šï¼Œå®ƒå®é™…ä¸Šé‡‡å–çš„æ˜¯**â€œå…ˆæŒ‰è¡Œåˆ†å—ï¼Œå†æŒ‰åˆ—å­˜å‚¨â€**çš„æ··åˆæ¶æ„ï¼ˆPAX æ¶æ„ï¼ŒPartition Attributes Acrossï¼‰ã€‚

**ç‰©ç†å¸ƒå±€ç¤ºä¾‹ï¼š**

å‡è®¾ä¸€å¼ è¡¨æœ‰ 10 äº¿è¡Œè®°å½•ã€‚å­˜å‚¨å¼•æ“ä¸ä¼šåˆ›å»ºä¸€ä¸ªåŒ…å« 10 äº¿ä¸ªåå­—çš„å•ä¸ªå¤§æ–‡ä»¶ã€‚ç›¸åï¼Œå®ƒä¼šå°†è¿™ 10 äº¿è¡Œåˆ‡åˆ†æˆå¤šä¸ª Chunkï¼ˆä¾‹å¦‚ï¼Œæ¯ 64,000 è¡Œä½œä¸ºä¸€ä¸ª Chunkï¼‰ã€‚

*   **å†…éƒ¨ç»“æ„ï¼š** åœ¨è¿™ä¸ªåŒ…å« 64,000 è¡Œçš„ **Chunk A** å†…éƒ¨ï¼Œæ•°æ®æ‰ä¼šè¢«çœŸæ­£æŒ‰åˆ—ï¼ˆColumn 1, Column 2...ï¼‰è¿ç»­å­˜å‚¨å¹¶è¿›è¡Œé«˜æ¯”ä¾‹å‹ç¼©ã€‚
*   **ç›®çš„ï¼š** å½“ç³»ç»Ÿåªéœ€è¯»å–ç‰¹å®šèŒƒå›´å†…çš„æ•°æ®æ—¶ï¼Œå¯ä»¥å°†å†…å­˜çš„ä½¿ç”¨é‡æ§åˆ¶åœ¨ä¸€ä¸ª Chunk çš„å¤§å°ï¼ŒåŒæ—¶æ–¹ä¾¿åˆ†å¸ƒå¼é›†ç¾¤å°†ä¸åŒçš„ Chunk åˆ†é…ç»™ä¸åŒçš„è®¡ç®—èŠ‚ç‚¹å¹¶è¡Œå¤„ç†ã€‚

* * *

### 2\. Chunk çº§åˆ«çš„å…ƒæ•°æ®ï¼šZone Maps (åŒºåŸŸæ˜ å°„)

æ‚¨æåˆ°çš„**æœ€å¤§å€¼ï¼ˆMaxï¼‰å’Œæœ€å°å€¼ï¼ˆMinï¼‰**ï¼Œåœ¨æ•°æ®åº“æœ¯è¯­ä¸­é€šå¸¸è¢«ç§°ä¸º **Zone Maps**ã€**Data Skipping Indexesï¼ˆæ•°æ®è·³è¿‡ç´¢å¼•ï¼‰** æˆ– **ç¨€ç–ç´¢å¼•ï¼ˆSparse Indexï¼‰**ã€‚

åœ¨å†™å…¥ä¸€ä¸ª Chunk æ—¶ï¼Œå­˜å‚¨å¼•æ“ä¼šåœ¨è¯¥ Chunk çš„æ–‡ä»¶å¤´éƒ¨ï¼ˆHeaderï¼‰æˆ–å•ç‹¬çš„å…ƒæ•°æ®æ–‡ä»¶ä¸­ï¼Œè®°å½•è¯¥ Chunk å†…**æ¯ä¸€åˆ—**çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

*   **åŒ…å«çš„ç»Ÿè®¡é‡ï¼š** `Min`ï¼ˆæœ€å°å€¼ï¼‰ã€`Max`ï¼ˆæœ€å¤§å€¼ï¼‰ã€`Count`ï¼ˆéç©ºè¡Œæ•°ï¼‰ã€`Sum`ï¼ˆæ€»å’Œï¼‰ã€`Null Count`ï¼ˆç©ºå€¼æ•°é‡ï¼‰ã€‚
*   **æ ¸å¿ƒä½œç”¨ï¼šè°“è¯ä¸‹æ¨ï¼ˆPredicate Pushdownï¼‰ä¸æ•°æ®è·³è¿‡ã€‚**
    *   **åœºæ™¯ï¼š** æ‰§è¡ŒæŸ¥è¯¢ `SELECT * FROM sales WHERE date >= '2023-10-01' AND date <= '2023-10-31'`ã€‚
    *   **æ‰§è¡Œé€»è¾‘ï¼š** å¼•æ“åœ¨è¯»å–çœŸå®æ•°æ®å‰ï¼Œä¼šå…ˆæ‰«ææ‰€æœ‰ Chunk çš„å…ƒæ•°æ®ã€‚å¦‚æœ Chunk 1 çš„ `date` åˆ—è®°å½•ä¸º `Min='2023-01-01', Max='2023-01-31'`ï¼Œå¼•æ“é€šè¿‡ç®€å•çš„èŒƒå›´æ¯”å¯¹å³å¯æ–­å®šè¯¥ Chunk **ç»å¯¹ä¸å¯èƒ½**åŒ…å«ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚
    *   **ç»“æœï¼š** æ•´ä¸ª Chunk 1 è¢«ç›´æ¥è·³è¿‡ï¼ˆSkippedï¼‰ï¼Œå®Œå…¨ä¸å‘ç”Ÿç£ç›˜ I/O è¯»å–ï¼Œä¹Ÿä¸æ¶ˆè€— CPU è¿›è¡Œè§£å‹ã€‚

* * *

### 3\. å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter) çš„åº”ç”¨

Min/Max å¯¹äº**èŒƒå›´æŸ¥è¯¢ï¼ˆRange Queryï¼‰**ï¼ˆå¦‚æ—¶é—´ã€è‡ªå¢ IDï¼‰æå…¶é«˜æ•ˆï¼Œä½†å¯¹äº**ç­‰å€¼æŸ¥è¯¢ï¼ˆPoint Lookupï¼‰**ï¼ˆå¦‚ `WHERE user_id = 'A1B2C3D4'`ï¼‰åˆ™å¯èƒ½å¤±æ•ˆï¼ˆå¦‚æœè¯¥ Chunk çš„ ID æå…¶åˆ†æ•£ï¼ŒMin å’Œ Max çš„è·¨åº¦ä¼šå¾ˆå¤§ï¼Œå¯¼è‡´æ— æ³•è·³è¿‡ï¼‰ã€‚

æ­¤æ—¶ï¼Œ**å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom Filterï¼‰** è¡¥è¶³äº†è¿™ä¸€çŸ­æ¿ã€‚

*   **åŸç†ï¼š** å¸ƒéš†è¿‡æ»¤å™¨æ˜¯ä¸€ç§æ¦‚ç‡å‹æ•°æ®ç»“æ„ã€‚åœ¨å†™å…¥ Chunk æ—¶ï¼Œå¼•æ“ä¼šå°†è¯¥åˆ—çš„æ‰€æœ‰å€¼é€šè¿‡å¤šä¸ªå“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ä¸€ä¸ªä½å›¾ï¼ˆBitsetï¼‰ä¸­ã€‚æ­¤ä½å›¾åŒæ ·ä½œä¸ºå…ƒæ•°æ®ä¿å­˜åœ¨ Chunk å¤´éƒ¨ã€‚
*   **ç‰¹æ€§ï¼š**
    *   å®ƒåªèƒ½å›ç­”ä¸¤ä¸ªç»“è®ºï¼š**â€œç»å¯¹ä¸å­˜åœ¨â€** æˆ– **â€œå¯èƒ½å­˜åœ¨â€**ã€‚
    *   **æ— å‡é˜´æ€§ï¼ˆNo False Negativesï¼‰ï¼š** å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è¯´æŸä¸ªå€¼ä¸å­˜åœ¨ï¼Œé‚£å®ƒå°±ç»å¯¹ä¸åœ¨è¿™ä¸ª Chunk é‡Œã€‚
*   **æ‰§è¡Œé€»è¾‘ï¼š** å½“æŸ¥è¯¢ `WHERE user_id = 'A1B2C3D4'` æ—¶ï¼Œå¼•æ“å°†è¯¥ ID ä¼ å…¥å¯¹åº” Chunk çš„å¸ƒéš†è¿‡æ»¤å™¨ï¼š
    *   å¦‚æœè¿”å› `0`ï¼ˆç»å¯¹ä¸å­˜åœ¨ï¼‰ï¼Œç›´æ¥è·³è¿‡æ•´ä¸ª Chunk çš„ I/O è¯»å–ã€‚
    *   å¦‚æœè¿”å› `1`ï¼ˆå¯èƒ½å­˜åœ¨ï¼‰ï¼Œå¼•æ“æ‰ä¼šå°†è¯¥ Chunk ä»ç£ç›˜è¯»å…¥å†…å­˜å¹¶è§£å‹ï¼Œè¿›è¡Œç²¾ç¡®çš„æ‰«æè¿‡æ»¤ã€‚

* * *

### 4\. ç»¼åˆæ‰§è¡Œæµæ°´çº¿ï¼šæŸ¥è¯¢å¦‚ä½•è¢«åŠ é€Ÿ

å½“ä¸€æ¡å¸¦æœ‰è¿‡æ»¤æ¡ä»¶çš„ SQL ä¸‹å‘åˆ°åˆ—å¼å­˜å‚¨å¼•æ“æ—¶ï¼Œåº•å±‚çš„å¤„ç†æµæ°´çº¿ï¼ˆPipelineï¼‰æ˜¯ä¸€å±‚å±‚é€’è¿›çš„ï¼š

1.  **ç¬¬ä¸€å±‚è£å‰ªï¼ˆå®è§‚ï¼‰ï¼šåˆ†åŒºè£å‰ªï¼ˆPartition Pruningï¼‰ã€‚** æ ¹æ®ç›®å½•åæˆ–æ—¶é—´åˆ†åŒºï¼Œç›´æ¥æ’é™¤æ— å…³çš„ç›®å½•ã€‚
2.  **ç¬¬äºŒå±‚è£å‰ªï¼ˆChunk çº§ / Min-Maxï¼‰ï¼š** è¯»å– Chunk å…ƒæ•°æ®ï¼Œåˆ©ç”¨ Max/Min/Null Count è¿›è¡ŒèŒƒå›´æ ¡éªŒï¼Œè·³è¿‡ä¸åœ¨èŒƒå›´å†…çš„ Chunkã€‚
3.  **ç¬¬ä¸‰å±‚è£å‰ªï¼ˆChunk çº§ / Bloom Filterï¼‰ï¼š** å¯¹äºç­‰å€¼æŸ¥è¯¢ï¼Œåˆ©ç”¨å¸ƒéš†è¿‡æ»¤å™¨å†æ¬¡è¿‡æ»¤ï¼Œå°†å‰©ä¸‹çš„å¾…è¯»å– Chunk æ•°é‡é™åˆ°æœ€ä½ã€‚
4.  **ç¬¬å››å±‚æ“ä½œï¼ˆè§£å‹ä¸æ‰«æï¼‰ï¼š** åªæœ‰ç»è¿‡ä¸Šè¿°ä¸‰å±‚ç­›é€‰åâ€œå¹¸å­˜â€çš„æå°‘æ•° Chunk çš„ç‰¹å®šåˆ—ï¼Œæ‰ä¼šè¢«çœŸæ­£ä»ç£ç›˜è¯»å–åˆ°å†…å­˜ï¼Œè¿›è¡Œè§£å‹ç¼©ã€‚

* * *

**é€šè¿‡åœ¨ Chunk çº§åˆ«å¼•å…¥ Min/Max å’Œå¸ƒéš†è¿‡æ»¤å™¨ï¼Œåˆ—å¼å­˜å‚¨å°†æ˜‚è´µçš„â€œç£ç›˜æ‰«æâ€è½¬æ¢æˆäº†æå…¶å»‰ä»·çš„â€œå†…å­˜å…ƒæ•°æ®æ¯”å¯¹â€ã€‚**

åˆ—å¼å­˜å‚¨è®¡ç®—å±‚ï¼šå‘é‡åŒ–æ‰§è¡Œä¸ CPU SIMD æŒ‡ä»¤é›†åŠ é€Ÿ
=============================

å½“åº•å±‚å­˜å‚¨å¼•æ“é€šè¿‡ Min/Max å’Œå¸ƒéš†è¿‡æ»¤å™¨å®Œæˆ I/O è£å‰ªï¼Œå°†â€œå¹¸å­˜â€çš„ Chunk è¯»å…¥å†…å­˜å¹¶è§£å‹åï¼Œæ•°æ®åº“çš„æ€§èƒ½ç“¶é¢ˆä¾¿ä»**ç£ç›˜ I/O** è½¬ç§»åˆ°äº† **CPU è®¡ç®—ä¸å†…å­˜å¸¦å®½**ã€‚

ä¸ºäº†æé€Ÿå¤„ç†è¿™äº›å†…å­˜ä¸­çš„åºå¤§æ•°æ®ï¼Œç°ä»£åˆ—å¼æ•°æ®åº“ï¼ˆå¦‚ ClickHouse, DuckDB, Apache Arrow ä½“ç³»ï¼‰å½»åº•æŠ›å¼ƒäº†ä¼ ç»Ÿçš„é€è¡Œå¤„ç†æ¨¡å¼ï¼Œè½¬è€Œé‡‡ç”¨ **å‘é‡åŒ–æ‰§è¡Œï¼ˆVectorized Executionï¼‰**ï¼Œå¹¶æ·±åº¦å‹æ¦¨ç°ä»£ CPU çš„ **SIMDï¼ˆå•æŒ‡ä»¤æµå¤šæ•°æ®æµï¼‰** ç¡¬ä»¶æŒ‡ä»¤é›†ï¼Œå®ç°äº†è®¡ç®—æ€§èƒ½çš„æŒ‡æ•°çº§é£è·ƒã€‚

* * *

### 1\. ç—›ç‚¹ï¼šä¼ ç»Ÿâ€œç«å±±æ¨¡å‹â€ä¸ºä»€ä¹ˆåœ¨åˆ†æåœºæ™¯ä¸‹å¤±æ•ˆï¼Ÿ

åœ¨æ¢è®¨å‘é‡åŒ–ä¹‹å‰ï¼Œå¿…é¡»å…ˆç†è§£ä¼ ç»Ÿè¡Œå¼æ•°æ®åº“ï¼ˆå¦‚æ—©æœŸçš„ MySQLã€PostgreSQLï¼‰çš„æ‰§è¡Œå¼•æ“â€”â€”**ç«å±±æ¨¡å‹ï¼ˆVolcano Model / Tuple-at-a-timeï¼‰**ã€‚

åœ¨ç«å±±æ¨¡å‹ä¸­ï¼ŒæŸ¥è¯¢æ‰§è¡Œæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚ Filter, Aggregateï¼‰éƒ½ä¼šè°ƒç”¨ä¸€ä¸ª `next()` å‡½æ•°ã€‚

*   **æ‰§è¡Œé€»è¾‘ï¼š** å¼•æ“å‘ä¸Šå±‚æ‹‰å–**ä¸€è¡Œ**æ•°æ® -> è§£æè¿™è¡Œçš„å„ä¸ªå­—æ®µ -> æ‰§è¡Œ `WHERE` åˆ¤æ–­ -> æ‰§è¡Œç´¯åŠ  -> å†å»æ‹‰å–**ä¸‹ä¸€è¡Œ**ã€‚
*   **è‡´å‘½ç¼ºé™·ï¼š**
    *   **å‡½æ•°è°ƒç”¨å¼€é”€æå¤§ï¼š** å¤„ç† 10 äº¿è¡Œæ•°æ®ï¼Œå°±è¦è°ƒç”¨ 10 äº¿æ¬¡ `next()` å‡½æ•°ï¼Œè™šå‡½æ•°è°ƒç”¨çš„å¼€é”€ç”šè‡³è¶…è¿‡äº†è®¡ç®—æœ¬èº«ã€‚
    *   **CPU ç¼“å­˜å‘½ä¸­ç‡æä½ï¼ˆCache Missï¼‰ï¼š** ä¸€è¡Œæ•°æ®åŒ…å«å¤šç§ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ï¼‰ï¼ŒCPU æ— æ³•æœ‰æ•ˆé¢„å–ï¼ˆPrefetchï¼‰æ•°æ®åˆ° L1/L2 ç¼“å­˜ä¸­ã€‚
    *   **åˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼ˆBranch Mispredictionï¼‰ï¼š** å¤æ‚çš„é€è¡Œ `if-else` åˆ¤æ–­ä¼šè®© CPU çš„æµæ°´çº¿é¢‘ç¹æ¸…ç©ºé‡æ’ã€‚

* * *

### 2\. èŒƒå¼è½¬æ¢ï¼šå‘é‡åŒ–æ‰§è¡Œ (Vectorized Execution)

ä¸ºäº†æ‰“ç ´ä¸Šè¿°ç“¶é¢ˆï¼Œåˆ—å¼æ•°æ®åº“å¼•å…¥äº†**å‘é‡åŒ–æ‰§è¡Œ**ã€‚å®ƒä¸å†ä¸€æ¬¡å¤„ç†â€œä¸€è¡Œï¼ˆTupleï¼‰â€ï¼Œè€Œæ˜¯**ä¸€æ¬¡å¤„ç†ä¸€æ•´æ‰¹ã€åŒä¸€åˆ—çš„è¿ç»­æ•°ç»„ï¼ˆVector/Batchï¼‰**ã€‚

*   å†…å­˜ä¸­çš„ä¸€ä¸ª Chunk è¢«è§£å‹åï¼Œå…¶ä¸­çš„ä¸€åˆ—ï¼ˆä¾‹å¦‚ `Age`ï¼‰ä¼šä»¥ç´§å‡‘çš„ã€çº¯ç²¹çš„æ•°ç»„å½¢å¼å­˜åœ¨ï¼š`[25, 30, 17, 42, 19, ...]`ã€‚
*   æ‰§è¡Œå¼•æ“çš„ `next()` è°ƒç”¨ä¸å†è¿”å›ä¸€è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªåŒ…å«ä¾‹å¦‚ **1024 ä¸ªå…ƒç´ çš„å‘é‡æ•°ç»„**ã€‚
*   æ•°æ®åº“å°†è¿™ä¸ªæ•°ç»„ç›´æ¥æ‰”ç»™ä¸€ä¸ªæå…¶ç´§å‡‘çš„ `for` å¾ªç¯è¿›è¡Œå¤„ç†ã€‚æ²¡æœ‰å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ç©¿æ’ï¼Œåªæœ‰çº¯ç²¹çš„æ•°å­¦è¿ç®—ã€‚è¿™æå¤§åœ°ä¼˜åŒ–äº† CPU çš„æŒ‡ä»¤ç¼“å­˜å’Œæ•°æ®ç¼“å­˜ã€‚

* * *

### 3\. ç¡¬ä»¶æš´å‡»ï¼šSIMD (å•æŒ‡ä»¤æµå¤šæ•°æ®æµ) æ·±åº¦è§£æ

å‘é‡åŒ–æ‰§è¡Œåªæ˜¯è½¯ä»¶å±‚é¢çš„æ•°ç»„æ‰¹å¤„ç†ã€‚çœŸæ­£è®©å®ƒèµ·é£çš„ï¼Œæ˜¯ç°ä»£ CPU çš„åº•å±‚ç¡¬ä»¶ç‰¹æ€§ï¼š**SIMDï¼ˆSingle Instruction, Multiple Dataï¼‰**ã€‚

å¸¸è§çš„ SIMD æŒ‡ä»¤é›†åŒ…æ‹¬ Intel çš„ **SSE** (128ä½)ã€**AVX2** (256ä½) å’Œ **AVX-512** (512ä½)ï¼Œä»¥åŠ ARM æ¶æ„çš„ **NEON**ã€‚

**æ ‡é‡æ‰§è¡Œ (SISD) vs å‘é‡æ‰§è¡Œ (SIMD)ï¼š**

*   **ä¼ ç»Ÿ SISDï¼ˆå•æŒ‡ä»¤å•æ•°æ®ï¼‰ï¼š** å¦‚æœè¦æŠŠæ•°ç»„ A å’Œæ•°ç»„ B å¯¹åº”çš„å…ƒç´ ç›¸åŠ ï¼ŒCPU éœ€è¦æ‰§è¡Œï¼šå– A1 -> å– B1 -> ç›¸åŠ å¾—åˆ° C1ï¼›å– A2 -> å– B2 -> ç›¸åŠ å¾—åˆ° C2ã€‚å¾ªç¯å¾€å¤ã€‚
*   **SIMDï¼ˆå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰ï¼š** CPU å†…éƒ¨æœ‰è¶…å®½çš„å¯„å­˜å™¨ï¼ˆå¦‚ 256-bitï¼‰ã€‚å¦‚æœä¸€ä¸ª 32 ä½çš„æ•´æ•°ï¼ˆ`INT`ï¼‰å  4 ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¸€ä¸ª 256 ä½çš„ AVX2 å¯„å­˜å™¨å¯ä»¥**åŒæ—¶å¡å…¥ 8 ä¸ªæ•´æ•°**ã€‚
    *   CPU åªéœ€è¦å‘å°„**ä¸€æ¡** SIMD åŠ æ³•æŒ‡ä»¤ã€‚
    *   ç¡¬ä»¶ç”µè·¯ä¼šåœ¨**ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…**ï¼ŒåŒæ—¶å®Œæˆ 8 å¯¹æ•°å­—çš„åŠ æ³•è¿ç®—ï¼š`[A1~A8] + [B1~B8] = [C1~C8]`ã€‚
    *   **ç†è®ºç®—åŠ›ç›´æ¥ç¿»äº† 8 å€ï¼ˆå¦‚æœæ˜¯ AVX-512 åˆ™æ˜¯ 16 å€ï¼‰ï¼**

* * *

### 4\. å¤©ä½œä¹‹åˆï¼šä¸ºä»€ä¹ˆ SIMD æ˜¯åˆ—å­˜å‚¨çš„ä¸“å±æ­¦å™¨ï¼Ÿ

SIMD æ‹¥æœ‰ææ€–çš„ç®—åŠ›ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæå…¶è‹›åˆ»çš„ç‰©ç†è¦æ±‚ï¼š**è¢«åŠ è½½åˆ° SIMD å¯„å­˜å™¨ä¸­çš„æ•°æ®ï¼Œå¿…é¡»åœ¨ç‰©ç†å†…å­˜ä¸­æ˜¯ç»å¯¹è¿ç»­çš„ï¼Œä¸”æ•°æ®ç±»å‹å®Œå…¨ä¸€è‡´ã€‚**

*   **è¡Œå­˜å‚¨çš„ç»æœ›ï¼š** åœ¨è¡Œå­˜å‚¨çš„å†…å­˜ä¸­ï¼Œæ•°æ®æ˜¯ `[Age, Name, Salary, Age, Name, Salary]`ã€‚ä¸ºäº†æŠŠ 8 ä¸ª `Age` å¡è¿› SIMD å¯„å­˜å™¨ï¼ŒCPU å¿…é¡»è·¨è¶Šæ— ç”¨çš„ `Name` å’Œ `Salary` å»â€œä¸œæ‹¼è¥¿å‡‘ï¼ˆGatherï¼‰â€ï¼Œè¿™æå…¶è€—æ—¶ï¼Œç›´æ¥æŠµæ¶ˆäº† SIMD çš„æ€§èƒ½æ”¶ç›Šã€‚
*   **åˆ—å­˜å‚¨çš„ç‹‚æ¬¢ï¼š** åˆ—å­˜å‚¨è§£å‹åï¼Œå†…å­˜é‡Œå°±æ˜¯çº¯ç²¹çš„ `[Age, Age, Age, Age...]`ã€‚CPU å¯ä»¥ä½¿ç”¨ä¸€æ¡ç®€å•çš„å¯¹å…¶åŠ è½½æŒ‡ä»¤ï¼ˆAligned Loadï¼‰ï¼Œç¬é—´å°†è¿ç»­çš„ 8 ä¸ªï¼ˆæˆ– 16 ä¸ªï¼‰`Age` å¡«æ»¡ SIMD å¯„å­˜å™¨ã€‚åˆ—å­˜å‚¨çš„ç‰©ç†å½¢æ€ï¼Œä»¿ä½›å°±æ˜¯ä¸º SIMD é‡èº«å®šåˆ¶çš„ã€‚

* * *

### 5\. æ‰§è¡Œæ¨æ¼”ï¼šåˆ©ç”¨ SIMD å¤„ç† `WHERE Age >= 18`

è®©æˆ‘ä»¬çœ‹çœ‹åœ¨ ClickHouse æˆ– DuckDB åº•å±‚ï¼Œè¿™æ®µçœ‹ä¼¼ç®€å•çš„è¿‡æ»¤æ¡ä»¶æ˜¯å¦‚ä½•è¢« SIMD å¤„ç†çš„ï¼š

1.  **åŠ è½½æ•°æ®ï¼š** CPU ä½¿ç”¨ä¸€æ¡ SIMD æŒ‡ä»¤ï¼Œå°† 8 ä¸ªè¿ç»­çš„å¹´é¾„ `[15, 22, 17, 19, 30, 12, 45, 18]` åŠ è½½åˆ°ä¸€ä¸ª 256 ä½å¯„å­˜å™¨ `R1` ä¸­ã€‚
2.  **åŠ è½½æ¡ä»¶ï¼š** å°†å¸¸é‡ `18` å¤åˆ¶ 8 ä»½ï¼Œå³ `[18, 18, 18, 18, 18, 18, 18, 18]`ï¼ŒåŠ è½½åˆ°å¯„å­˜å™¨ `R2` ä¸­ã€‚
3.  **å‘é‡åŒ–æ¯”è¾ƒï¼š** æ‰§è¡Œä¸€æ¡ SIMD å¹¶è¡Œæ¯”è¾ƒæŒ‡ä»¤ï¼ˆå¦‚ `_mm256_cmpge_epi32`ï¼‰ã€‚
4.  **ç”Ÿæˆä½å›¾æ©ç  (Bitmask)ï¼š** CPU åœ¨ä¸€ä¸ªå‘¨æœŸå†…å®Œæˆ 8 æ¬¡æ¯”è¾ƒï¼Œå¹¶ç›´æ¥è¾“å‡ºä¸€ä¸ªæ©ç å‘é‡ï¼š`[0, 1, 0, 1, 1, 0, 1, 1]`ï¼ˆ0 ä»£è¡¨ä¸æ»¡è¶³ï¼Œ1 ä»£è¡¨æ»¡è¶³ï¼‰ã€‚
5.  **é«˜æ•ˆè¿‡æ»¤ï¼š** å¼•æ“æ‹¿ç€è¿™ä¸ªæ©ç ï¼Œç›´æ¥å»å†…å­˜ä¸­æå–å¯¹åº”ä½ç½®ä¸º 1 çš„å…¶ä»–åˆ—æ•°æ®ï¼Œå®Œå…¨é¿å…äº†ä¼ ç»Ÿ `if (age >= 18)` å¸¦æ¥çš„æ˜‚è´µçš„ CPU åˆ†æ”¯è·³è½¬æƒ©ç½šã€‚

æœªç»ä½œè€…åŒæ„è¯·å‹¿è½¬è½½

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ä½œè€…ï¼š[aixueforever](https://www.cnblogs.com/aslanvon/)ï¼ŒåŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/aslanvon/p/19631154](https://www.cnblogs.com/aslanvon/p/19631154)