---
layout: post
title: 'å°æ˜çš„Spring Securityå…¥é—¨åˆ°æ·±å…¥å®æˆ˜'
date: "2025-11-25T00:41:27Z"
---
å°æ˜çš„Spring Securityå…¥é—¨åˆ°æ·±å…¥å®æˆ˜
=========================

å° æ˜ çš„ æ‘„ å½± ç½‘ ç«™ å·² ç» ç”¨ Spring Boot æ­ å»º å®Œ æˆ ï¼Œ è®¿ å®¢ è¶Š æ¥ è¶Š å¤š ã€‚ ä»– å†³ å®š ç»™ ç½‘ ç«™ åŠ  ä¸Š å®Œ æ•´ çš„ ç™» å½• è®¤ è¯ é‰´ æƒ åŠŸ èƒ½ ï¼Œ è®© ä¸ åŒ è§’ è‰² çš„ ç”¨ æˆ· ï¼ˆ æ¸¸ å®¢ ã€ ç¼– è¾‘ ã€ ç®¡ ç† å‘˜ ï¼‰ æœ‰ ä¸ åŒ çš„ æ“ ä½œ æƒ é™ ã€‚ ä»Š å¤© ï¼Œ ä»– å°± å¸¦ ç€ è¿™ ä¸ª éœ€ æ±‚ ï¼Œ å¼€ å¯ Spring Security çš„ å­¦ ä¹  ä¹‹ æ—… ã€‚

### \*\* ç¬¬ ä¸€ æ­¥ ï¼š æ­ å»º Spring Boot é¡¹ ç›® ï¼Œ å¼• å…¥ Spring Security \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ å…ˆ è®© ç½‘ ç«™ æœ‰ ä¸ª æœ€ åŸº ç¡€ çš„ ç™» å½• åŠŸ èƒ½ ï¼Œ èƒ½ æ‹¦ ä½ æœª ç™» å½• çš„ ç”¨ æˆ· ã€‚ â€

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* åˆ› å»º Spring Boot é¡¹ ç›® \*\* ï¼š ç”¨ [https://start.spring.io/](https://start.spring.io/) ï¼Œ é€‰ `Spring Web` ï¼ˆ æ­ Web æœ åŠ¡ ï¼‰ ã€ `Spring Security` ï¼ˆ å®‰ å…¨ æ¡† æ¶ ï¼‰ ã€ `Spring Data JPA` ï¼ˆ æ“ ä½œ æ•° æ® åº“ ï¼‰ ã€ `MySQL Driver` ï¼ˆ æ•° æ® åº“ é©± åŠ¨ ï¼‰ ã€‚
2.  \*\* æ·» åŠ  ä¾ èµ– \*\* ï¼ˆ pom.xml æ ¸ å¿ƒ éƒ¨ åˆ† ï¼‰ ï¼š
    
        <dependencies>  
            <dependency>  
                <groupId>org.springframework.boot</groupId>  
                <artifactId>spring-boot-starter-web</artifactId>  
            </dependency>  
            <dependency>  
                <groupId>org.springframework.boot</groupId>  
                <artifactId>spring-boot-starter-security</artifactId>  <!--  Spring Security  ä¾  èµ–  -->  
            </dependency>  
            <dependency>  
                <groupId>org.springframework.boot</groupId>  
                <artifactId>spring-boot-starter-data-jpa</artifactId>  
            </dependency>  
            <dependency>  
                <groupId>com.mysql</groupId>  
                <artifactId>mysql-connector-j</artifactId>  
            </dependency>  
        </dependencies>  
        
    
3.  \*\* è¿ è¡Œ é¡¹ ç›® \*\* ï¼š å¯ åŠ¨ Spring Boot ï¼Œ è®¿ é—® `http://localhost:8080` ï¼Œ ä¼š è‡ª åŠ¨ è·³ è½¬ åˆ° Spring Security çš„ é»˜ è®¤ ç™» å½• é¡µ ã€‚

#### \*\* ç° è±¡ ä¸ åŸ ç† \*\*

*   \*\* é»˜ è®¤ ç”¨ æˆ· \*\* ï¼š æ§ åˆ¶ å° ä¼š æ‰“ å° ä¸€ è¡Œ å¯† ç  ï¼Œ æ ¼ å¼ å¦‚ `Using generated security password: abcdef12-3456-7890-abcd-ef1234567890` ï¼Œ ç”¨ æˆ· å å›º å®š ä¸º `user` ã€‚
*   \*\* åŸ ç† \*\* ï¼š Spring Security è‡ª åŠ¨ é… ç½® äº† é»˜ è®¤ çš„ `InMemoryUserDetailsManager` ï¼ˆ å†… å­˜ ç”¨ æˆ· å­˜ å‚¨ ï¼‰ ï¼Œ ç”Ÿ æˆ éš æœº å¯† ç  ã€‚ æ‰€ æœ‰ æ¥ å£ é»˜ è®¤ éœ€ è¦ `USER` è§’ è‰² æ‰ èƒ½ è®¿ é—® ã€‚

> ğŸ’¡ å° æ˜ çš„ ç–‘ é—® ï¼š â€œ è¿™ å¯† ç  æ¯ æ¬¡ å¯ åŠ¨ éƒ½ å˜ ï¼Œ è€Œ ä¸” ç”¨ æˆ· ä¸ èƒ½ è‡ª å·± æ³¨ å†Œ ï¼Œ å¾— æ”¹ ï¼ â€

### \*\* ç¬¬ äºŒ æ­¥ ï¼š è‡ª å®š ä¹‰ ç”¨ æˆ· å­˜ å‚¨ â€”â€” ä» å†… å­˜ åˆ° æ•° æ® åº“ \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ ç”¨ æˆ· ä¿¡ æ¯ å­˜ åœ¨ è‡ª å·± çš„ æ•° æ® åº“ é‡Œ ï¼Œ æ”¯ æŒ æ³¨ å†Œ ã€ ç™» å½• ï¼Œ å¯† ç  ç”¨ BCrypt åŠ  å¯† ã€‚ â€

#### \*\* æ ¸ å¿ƒ æ¦‚ å¿µ \*\*

*   \*\* UserDetailsService \*\* ï¼š Spring Security çš„ â€œ ç”¨ æˆ· æŸ¥ è¯¢ æ¥ å£ â€ ï¼Œ å¼€ å‘ è€… å® ç° å®ƒ ï¼Œ å‘Š è¯‰ æ¡† æ¶ â€œ æ€ ä¹ˆ ä» æ•° æ® åº“ æŸ¥ ç”¨ æˆ· â€ ã€‚
*   \*\* UserDetails \*\* ï¼š â€œ ç”¨ æˆ· ä¿¡ æ¯ å° è£… ç±» â€ ï¼Œ åŒ… å« ç”¨ æˆ· å ã€ å¯† ç  ã€ è§’ è‰² ã€ è´¦ æˆ· æ˜¯ å¦ è¿‡ æœŸ ç­‰ ä¿¡ æ¯ ã€‚
*   \*\* PasswordEncoder \*\* ï¼š â€œ å¯† ç  åŠ  å¯† å™¨ â€ ï¼Œ ç”¨ BCrypt ç®— æ³• æŠŠ æ˜ æ–‡ å¯† ç  å˜ æˆ å“ˆ å¸Œ å€¼ å­˜ å‚¨ ã€‚

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* å»º ç”¨ æˆ· è¡¨ \*\* ï¼ˆ MySQL ï¼‰ ï¼š
    
        CREATE TABLE users (  
            id BIGINT AUTO_INCREMENT PRIMARY KEY,  
            username VARCHAR(50) UNIQUE NOT NULL,  --  ç”¨  æˆ·  å  
            password VARCHAR(100) NOT NULL,         --  BCrypt  å“ˆ  å¸Œ  å  çš„  å¯†  ç   
            role VARCHAR(20) NOT NULL               --  è§’  è‰²  ï¼š  ROLE_VISITOR  /  ROLE_EDITOR  /  ROLE_ADMIN  
        );  
        
    
2.  \*\* å® ç° UserDetailsService \*\* ï¼ˆ æŸ¥ æ•° æ® åº“ ç”¨ æˆ· ï¼‰ ï¼š
    
        @Service  
        public class CustomUserDetailsService implements UserDetailsService {  
            @Autowired private UserRepository userRepo;  //  JPA  æ“  ä½œ  users  è¡¨  
        
            @Override  
            public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {  
                //  1.  æŸ¥  æ•°  æ®  åº“  ç”¨  æˆ·  
                User user = userRepo.findByUsername(username)  
                    .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));  
        
                //  2.  å°  è£…  æˆ  UserDetails  å¯¹  è±¡  ï¼ˆ  Spring Security  è®¤  è¯†  çš„  æ ¼  å¼  ï¼‰  
                return org.springframework.security.core.userdetails.User.builder()  
                    .username(user.getUsername())  
                    .password(user.getPassword())  //  å­˜  çš„  æ˜¯  BCrypt  å“ˆ  å¸Œ  å€¼  
                    .roles(user.getRole().replace("ROLE_", ""))  //  è§’  è‰²  å»  æ‰  ROLE_  å‰  ç¼€  
                    .build();  
            }  
        }  
        
    
3.  \*\* é… ç½® PasswordEncoder \*\* ï¼ˆ ç”¨ BCrypt åŠ  å¯† ï¼‰ ï¼š
    
        @Configuration  
        public class SecurityConfig {  
            @Bean  
            public PasswordEncoder passwordEncoder() {  
                return new BCryptPasswordEncoder();  //  BCrypt  åŠ   å¯†  å™¨  ï¼Œ  è‡ª  å¸¦  éš  æœº  ç›  
            }  
        }  
        
    
4.  \*\* æ³¨ å†Œ ç”¨ æˆ· \*\* ï¼ˆ æ¯” å¦‚ å° æ˜ è‡ª å·± æ³¨ å†Œ ä¸º ç®¡ ç† å‘˜ ï¼‰ ï¼š
    
        @RestController  
        public class RegisterController {  
            @Autowired private UserRepository userRepo;  
            @Autowired private PasswordEncoder passwordEncoder;  
        
            @PostMapping("/register")  
            public String register(String username, String rawPassword, String role) {  
                User user = new User();  
                user.setUsername(username);  
                user.setPassword(passwordEncoder.encode(rawPassword));  //  æ˜  æ–‡  å¯†  ç   â†’  BCrypt  å“ˆ  å¸Œ  
                user.setRole("ROLE_" + role.toUpperCase());  //  è§’  è‰²  åŠ   ROLE_  å‰  ç¼€  ï¼ˆ  Spring Security  çº¦  å®š  ï¼‰  
                userRepo.save(user);  
                return "æ³¨å†ŒæˆåŠŸï¼";  
            }  
        }  
        
    

#### \*\* æ•ˆ æœ \*\*

å° æ˜ ç”¨ `POST /register?username=xiaoming&rawPassword=123456&role=admin` æ³¨ å†Œ å ï¼Œ æ•° æ® åº“ `users` è¡¨ ä¼š å­˜ ä¸€ æ¡ è®° å½• ï¼Œ `password` å­— æ®µ æ˜¯ BCrypt å“ˆ å¸Œ å€¼ ï¼ˆ å¦‚ `$2a$10$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx` ï¼‰ã€‚ ç™» å½• æ—¶ ï¼Œ æ¡† æ¶ ä¼š ç”¨ BCrypt éªŒ è¯ è¾“ å…¥ å¯† ç  æ˜¯ å¦ åŒ¹ é… ã€‚

> ğŸ’¡ å° æ˜ çš„ ä½“ ä¼š ï¼š â€œ UserDetailsService å°± åƒ å›¾ ä¹¦ é¦† çš„ â€˜ æŸ¥ é˜… å‘˜ â€™ ï¼Œ æ¡† æ¶ å‘Š è¯‰ ä»– â€˜ æ‰¾ å° æ˜ â€™ ï¼Œ ä»– å°± å» æ•° æ® åº“ æŠŠ å° æ˜ çš„ ä¹¦ ï¼ˆ ç”¨ æˆ· ä¿¡ æ¯ ï¼‰ æ‹¿ å› æ¥ ã€‚ â€

### \*\* ç¬¬ ä¸‰ æ­¥ ï¼š é… ç½® æƒ é™ æ§ åˆ¶ â€”â€” è° èƒ½ å¹² å•¥ ï¼Ÿ \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ æ¸¸ å®¢ åª èƒ½ çœ‹ ç…§ ç‰‡ ï¼Œ ç¼– è¾‘ èƒ½ ä¸Š ä¼  ï¼Œ ç®¡ ç† å‘˜ èƒ½ åˆ  é™¤ ã€‚ â€

#### \*\* æ ¸ å¿ƒ æ¦‚ å¿µ \*\*

*   \*\* HttpSecurity \*\* ï¼š Spring Security çš„ â€œ Web å®‰ å…¨ é… ç½® ç±» â€ ï¼Œ ç”¨ æ¥ è®¾ ç½® URL è®¿ é—® æƒ é™ ã€ ç™» å½• / æ³¨ é”€ é¡µ ã€ CSRF ç­‰ ã€‚
*   \*\* @PreAuthorize \*\* ï¼š â€œ æ–¹ æ³• çº§ æƒ é™ æ³¨ è§£ â€ ï¼Œ ç›´ æ¥ åœ¨ Controller æ–¹ æ³• ä¸Š æ ‡ æ³¨ éœ€ è¦ çš„ è§’ è‰² ã€‚

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* é… ç½® URL è®¿ é—® æƒ é™ \*\* ï¼ˆ åœ¨ SecurityConfig ä¸­ ï¼‰ ï¼š
    
        @Configuration  
        @EnableWebSecurity  //  å¼€  å¯  Web  å®‰  å…¨  é…  ç½®  
        public class SecurityConfig {  
            @Autowired private CustomUserDetailsService userDetailsService;  
            @Autowired private PasswordEncoder passwordEncoder;  
        
            @Bean  
            public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {  
                http  
                    .authorizeHttpRequests(auth -> auth  
                        .requestMatchers("/photos/**").permitAll()  //  å…¬  å¼€  ï¼š  æ‰€  æœ‰  äºº  èƒ½  çœ‹  ç…§  ç‰‡  
                        .requestMatchers("/upload/**").hasRole("EDITOR")  //  ä¸Š  ä¼   ï¼š  éœ€  EDITOR  è§’  è‰²  
                        .requestMatchers("/delete/**").hasRole("ADMIN")  //  åˆ   é™¤  ï¼š  éœ€  ADMIN  è§’  è‰²  
                        .anyRequest().authenticated()  //  å…¶  ä»–  æ¥  å£  éœ€  ç™»  å½•  
                    )  
                    .formLogin(form -> form  //  é…  ç½®  ç™»  å½•  é¡µ  
                        .loginPage("/my-login")  //  è‡ª  å®š  ä¹‰  ç™»  å½•  é¡µ  ï¼ˆ  ä¸‹  èŠ‚  è®²  ï¼‰  
                        .defaultSuccessUrl("/home")  //  ç™»  å½•  æˆ  åŠŸ  è·³  è½¬  
                    )  
                    .logout(logout -> logout  //  é…  ç½®  æ³¨  é”€  
                        .logoutUrl("/logout")  
                        .logoutSuccessUrl("/photos")  
                    );  
                return http.build();  
            }  
        
            //  é…  ç½®  è®¤  è¯  ç®¡  ç†  å™¨  ï¼ˆ  ç”¨  è‡ª  å®š  ä¹‰  UserDetailsService  å’Œ  PasswordEncoder  ï¼‰  
            @Bean  
            public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {  
                return config.getAuthenticationManager();  
            }  
        }  
        
    
2.  \*\* ç”¨ @PreAuthorize åš æ–¹ æ³• çº§ æƒ é™ \*\* ï¼ˆ æ›´ ç²¾ ç»† æ§ åˆ¶ ï¼‰ ï¼š
    
        @RestController  
        public class PhotoController {  
            //  æ¸¸  å®¢  èƒ½  çœ‹  
            @GetMapping("/photos")  
            public List<Photo> listPhotos() { ... }  
        
            //  ç¼–  è¾‘  èƒ½  ä¸Š  ä¼   ï¼ˆ  @PreAuthorize  éœ€  å¼€  å¯  @EnableMethodSecurity  ï¼‰  
            @PostMapping("/upload")  
            @PreAuthorize("hasRole('EDITOR')")  //  ç›´  æ¥  æ ‡  æ³¨  éœ€  EDITOR  è§’  è‰²  
            public String uploadPhoto(MultipartFile file) { ... }  
        
            //  ç®¡  ç†  å‘˜  èƒ½  åˆ   é™¤  
            @DeleteMapping("/delete/{id}")  
            @PreAuthorize("hasRole('ADMIN') or hasRole('EDITOR')")  //  ç®¡  ç†  å‘˜  æˆ–  ç¼–  è¾‘  éƒ½  èƒ½  åˆ   
            public String deletePhoto(@PathVariable Long id) { ... }  
        }  
        
    
3.  \*\* å¼€ å¯ @PreAuthorize æ”¯ æŒ \*\* ï¼š åœ¨ SecurityConfig ä¸Š åŠ  `@EnableMethodSecurity` ã€‚

#### \*\* æ•ˆ æœ \*\*

*   è®¿ é—® `/upload` æ—¶ ï¼Œ è‹¥ ç”¨ æˆ· æ˜¯ `ROLE_VISITOR` ï¼Œ ä¼š è¢« æ‹¦ æˆª å¹¶ è¿” å› 403 é”™ è¯¯ ï¼ˆ æƒ é™ ä¸ è¶³ ï¼‰ ï¼›
*   ç”¨ `@PreAuthorize` çš„ æ–¹ æ³• ï¼Œ æ¡† æ¶ ä¼š åœ¨ æ‰§ è¡Œ å‰ æ£€ æŸ¥ ç”¨ æˆ· è§’ è‰² ï¼Œ ä¸ ç¬¦ åˆ åˆ™ æŠ› å¼‚ å¸¸ ã€‚

> ğŸ’¡ å° æ˜ çš„ ä½“ ä¼š ï¼š â€œ HttpSecurity åƒ â€˜ é—¨ å« â€™ ï¼Œ ç®¡ URL çº§ çš„ å¤§ é—¨ ï¼› @PreAuthorize åƒ â€˜ æˆ¿ é—´ é” â€™ ï¼Œ ç®¡ æ–¹ æ³• çº§ çš„ å° é—¨ ï¼Œ åŒ ä¿ é™© ï¼ â€

### \*\* ç¬¬ å›› æ­¥ ï¼š è‡ª å®š ä¹‰ ç™» å½• é¡µ ã€ æ³¨ é”€ ä¸ è®° ä½ æˆ‘ \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ é»˜ è®¤ ç™» å½• é¡µ å¤ª ä¸‘ ï¼Œ æƒ³ ç”¨ è‡ª å·± çš„ ï¼› åŠ  ä¸ª â€˜ è®° ä½ æˆ‘ â€™ åŠŸ èƒ½ ï¼Œ å…³ é—­ æµ è§ˆ å™¨ å† æ‰“ å¼€ è¿˜ æ˜¯ ç™» å½• çŠ¶ æ€ ã€‚ â€

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* è‡ª å®š ä¹‰ ç™» å½• é¡µ \*\* ï¼š
    
    *   å†™ ä¸€ ä¸ª HTML é¡µ é¢ `my-login.html` ï¼ˆ æ”¾ `resources/templates` ç›® å½• ï¼‰ ï¼Œ åŒ… å« `username` ã€ `password` è¾“ å…¥ æ¡† å’Œ `remember-me` å¤ é€‰ æ¡† ï¼›
    *   åœ¨ SecurityConfig ä¸­ é… ç½® `.loginPage("/my-login")` ï¼Œ å¹¶ æŒ‡ å®š å¤„ ç† ç™» å½• çš„ URL ï¼š
    
        .formLogin(form -> form  
            .loginPage("/my-login")  //  è‡ª  å®š  ä¹‰  ç™»  å½•  é¡µ  è·¯  å¾„  
            .loginProcessingUrl("/do-login")  //  å¤„  ç†  ç™»  å½•  çš„  URL  ï¼ˆ  æ¡†  æ¶  è‡ª  åŠ¨  å¤„  ç†  ï¼‰  
            .defaultSuccessUrl("/home")  
            .failureUrl("/my-login?error")  //  ç™»  å½•  å¤±  è´¥  è·³  è½¬  
        )  
        
    
2.  \*\* å¼€ å¯ â€œ è®° ä½ æˆ‘ â€ åŠŸ èƒ½ \*\* ï¼š
    
    *   åœ¨ SecurityConfig ä¸­ é… ç½® `.rememberMe()` ï¼š
    
        .rememberMe(remember -> remember  
            .key("xiaoming-secret-key")  //  è‡ª  å®š  ä¹‰  å¯†  é’¥  ï¼ˆ  é˜²  ç¯¡  æ”¹  ï¼‰  
            .tokenValiditySeconds(7 * 24 * 3600)  //  è®°  ä½  æˆ‘  æœ‰  æ•ˆ  æœŸ  ï¼š  7  å¤©  
        )  
        
    
    *   åœ¨ è‡ª å®š ä¹‰ ç™» å½• é¡µ åŠ  â€œ è®° ä½ æˆ‘ â€ å¤ é€‰ æ¡† ï¼š
    
        <input type="checkbox" name="remember-me"> è®°ä½æˆ‘  
        
    
3.  \*\* è‡ª å®š ä¹‰ æ³¨ é”€ é¡µ \*\* ï¼š
    
    *   åœ¨ SecurityConfig ä¸­ é… ç½® `.logout()` ï¼Œ é»˜ è®¤ æ³¨ é”€ URL æ˜¯ `/logout` ï¼Œ å¯ è‡ª å®š ä¹‰ ï¼š
    
        .logout(logout -> logout  
            .logoutUrl("/my-logout")  //  è‡ª  å®š  ä¹‰  æ³¨  é”€  URL  
            .logoutSuccessUrl("/photos")  //  æ³¨  é”€  æˆ  åŠŸ  è·³  è½¬  
            .invalidateHttpSession(true)  //  æ³¨  é”€  æ—¶  æ¸…  ç©º  Session  
            .deleteCookies("JSESSIONID")  //  åˆ   é™¤  Cookie  
        )  
        
    

#### \*\* æ•ˆ æœ \*\*

*   è®¿ é—® éœ€ ç™» å½• çš„ é¡µ é¢ æ—¶ ï¼Œ è·³ è½¬ åˆ° å° æ˜ è‡ª å·± å†™ çš„ `my-login.html` ï¼›
*   å‹¾ é€‰ â€œ è®° ä½ æˆ‘ â€ å ï¼Œ å…³ é—­ æµ è§ˆ å™¨ ï¼Œ 7 å¤© å†… å† è®¿ é—® ç½‘ ç«™ ä» æ˜¯ ç™» å½• çŠ¶ æ€ ï¼›
*   ç‚¹ å‡» æ³¨ é”€ é“¾ æ¥ ï¼Œ æ¸… ç©º Session å’Œ Cookie ï¼Œ è·³ å› å…¬ å¼€ ç…§ ç‰‡ é¡µ ã€‚

> ğŸ’¡ å° æ˜ çš„ ä½“ ä¼š ï¼š â€œ è‡ª å®š ä¹‰ ç™» å½• é¡µ è®© ç½‘ ç«™ æ›´ å¥½ çœ‹ ï¼Œ â€˜ è®° ä½ æˆ‘ â€™ åƒ â€˜ é•¿ æœŸ é¥­ å¡ â€™ ï¼Œ ä¸ ç”¨ æ¯ æ¬¡ éƒ½ åˆ· ä¸´ æ—¶ å¡ ã€‚ â€

### \*\* ç¬¬ äº” æ­¥ ï¼š é›† æˆ JWT â€”â€” æ”¯ æŒ APP ä¸ å¾® æœ åŠ¡ \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ æˆ‘ åš äº† ä¸ª æ‰‹ æœº APP ï¼Œ ç”¨ Session - Cookie ä¸ æ–¹ ä¾¿ ï¼Œ æƒ³ ç”¨ JWT Token åš è®¤ è¯ ã€‚ â€

#### \*\* æ ¸ å¿ƒ æ¦‚ å¿µ \*\*

*   \*\* JWT \*\* ï¼š â€œ è‡ª å¸¦ ä¿¡ æ¯ çš„ èº« ä»½ è¯ â€ ï¼Œ æœ åŠ¡ å™¨ ä¸ å­˜ Session ï¼Œ ç”¨ æˆ· ç™» å½• å æ‹¿ Token ï¼Œ å ç»­ è¯· æ±‚ å¸¦ Token å³ å¯ ã€‚
*   \*\* JwtAuthenticationFilter \*\* ï¼š è‡ª å®š ä¹‰ è¿‡ æ»¤ å™¨ ï¼Œ ä» `Authorization` å¤´ å– JWT ï¼Œ éªŒ è¯ å è®¾ ç½® Security Context ã€‚

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* æ·» åŠ  JWT ä¾ èµ– \*\* ï¼š
    
        <dependency>  
            <groupId>io.jsonwebtoken</groupId>  
            <artifactId>jjwt-api</artifactId>  
            <version>0.11.5</version>  
        </dependency>  
        <dependency>  
            <groupId>io.jsonwebtoken</groupId>  
            <artifactId>jjwt-impl</artifactId>  
            <version>0.11.5</version>  
            <scope>runtime</scope>  
        </dependency>  
        <dependency>  
            <groupId>io.jsonwebtoken</groupId>  
            <artifactId>jjwt-jackson</artifactId>  
            <version>0.11.5</version>  
            <scope>runtime</scope>  
        </dependency>  
        
    
2.  \*\* å†™ JWT å·¥ å…· ç±» \*\* ï¼ˆ ç”Ÿ æˆ / éªŒ è¯ Token ï¼‰ ï¼š
    
        @Component  
        public class JwtUtil {  
            @Value("${jwt.secret}") private String secret;  //  é…  ç½®  åœ¨  application.properties  ä¸­  
            @Value("${jwt.expiration}") private long expiration;  //  Token  æœ‰  æ•ˆ  æœŸ  ï¼ˆ  å¦‚  3600000  æ¯«  ç§’  ï¼‰  
        
            //  ç”Ÿ  æˆ  Token  
            public String generateToken(UserDetails userDetails) {  
                Map<String, Object> claims = new HashMap<>();  
                claims.put("roles", userDetails.getAuthorities().stream()  
                    .map(GrantedAuthority::getAuthority).collect(Collectors.toList()));  
                return Jwts.builder()  
                    .setClaims(claims)  
                    .setSubject(userDetails.getUsername())  
                    .setIssuedAt(new Date())  
                    .setExpiration(new Date(System.currentTimeMillis() + expiration))  
                    .signWith(SignatureAlgorithm.HS512, secret)  //  ç”¨  HS512  ç®—  æ³•  ç­¾  å  
                    .compact();  
            }  
        
            //  éªŒ  è¯  Token  å¹¶  å–  ç”¨  æˆ·  å  
            public String getUsernameFromToken(String token) {  
                return Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody().getSubject();  
            }  
        }  
        
    
3.  \*\* å†™ JWT è®¤ è¯ è¿‡ æ»¤ å™¨ \*\* ï¼š
    
        public class JwtAuthenticationFilter extends OncePerRequestFilter {  
            @Autowired private JwtUtil jwtUtil;  
            @Autowired private CustomUserDetailsService userDetailsService;  
        
            @Override  
            protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {  
                //  1.  ä»  Header  å–  Token  
                String token = request.getHeader("Authorization");  
                if (token != null && token.startsWith("Bearer ")) {  
                    token = token.substring(7);  
                    //  2.  éªŒ  è¯  Token  ï¼Œ  å–  ç”¨  æˆ·  å  
                    String username = jwtUtil.getUsernameFromToken(token);  
                    if (username != null && SecurityContextHolder.getContext().getAuthentication() == null) {  
                        //  3.  æŸ¥  ç”¨  æˆ·  ä¿¡  æ¯  ï¼Œ  è®¾  ç½®  Security Context  
                        UserDetails userDetails = userDetailsService.loadUserByUsername(username);  
                        UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(  
                            userDetails, null, userDetails.getAuthorities());  
                        SecurityContextHolder.getContext().setAuthentication(auth);  
                    }  
                }  
                chain.doFilter(request, response);  //  ç»§  ç»­  å¤„  ç†  è¯·  æ±‚  
            }  
        }  
        
    
4.  \*\* ä¿® æ”¹ SecurityConfig ï¼Œ ç”¨ JWT æ›¿ æ¢ Session \*\* ï¼š
    
        @Bean  
        public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {  
            http  
                .csrf(csrf -> csrf.disable())  //  JWT  æ—   çŠ¶  æ€  ï¼Œ  å…³  é—­  CSRF  
                .sessionManagement(session -> session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))  //  æ—   Session  
                .authorizeHttpRequests(auth -> auth  
                    .requestMatchers("/api/photos/**").permitAll()  
                    .requestMatchers("/api/upload/**").hasRole("EDITOR")  
                    .anyRequest().authenticated()  
                )  
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)  //  åŠ   JWT  è¿‡  æ»¤  å™¨  
                .formLogin(form -> form.disable())  //  ç¦  ç”¨  é»˜  è®¤  è¡¨  å•  ç™»  å½•  ï¼ˆ  APP  ç”¨  JWT  ï¼‰  
                .logout(logout -> logout.disable());  //  ç¦  ç”¨  é»˜  è®¤  æ³¨  é”€  
            return http.build();  
        }  
        
    

#### \*\* æ•ˆ æœ \*\*

*   APP ç”¨ æˆ· ç™» å½• æ—¶ ï¼Œ è°ƒ `POST /api/login` ï¼ˆ è‡ª å®š ä¹‰ æ¥ å£ ï¼Œ éªŒ è¯ ç”¨ æˆ· å å¯† ç  å è¿” JWT ï¼‰ ï¼›
*   å ç»­ APP è¯· æ±‚ API æ—¶ ï¼Œ åœ¨ `Authorization` å¤´ å¸¦ `Bearer <JWT>` ï¼Œ æ¡† æ¶ è‡ª åŠ¨ è®¤ è¯ ã€‚

> ğŸ’¡ å° æ˜ çš„ ä½“ ä¼š ï¼š â€œ JWT åƒ â€˜ ç”µ å­ é€š è¡Œ è¯ â€™ ï¼Œ APP æ‹¿ ç€ å®ƒ å°± èƒ½ ç•… é€š æ—  é˜» ï¼Œ æœ åŠ¡ å™¨ ä¸ ç”¨ è®° ä½ è° æ¥ è¿‡ ï¼Œ è½» æ¾ æ”¯ æŒ å¤š ç«¯ ï¼ â€

### \*\* ç¬¬ å…­ æ­¥ ï¼š æ·± å…¥ ï¼š OAuth2 ç¬¬ ä¸‰ æ–¹ ç™» å½• ä¸ å®‰ å…¨ é˜² æŠ¤ \*\*

#### \*\* å° æ˜ çš„ éœ€ æ±‚ \*\*

â€œ æƒ³ è®© ç”¨ æˆ· ç”¨ GitHub è´¦ å· ç›´ æ¥ ç™» å½• ï¼Œ è¿˜ è¦ é˜² CSRF ã€ XSS æ”» å‡» ã€‚ â€

#### \*\* æ ¸ å¿ƒ æ¦‚ å¿µ \*\*

*   \*\* OAuth2 \*\* ï¼š â€œ ç¬¬ ä¸‰ æ–¹ ç™» å½• å è®® â€ ï¼Œ ç”¨ æˆ· æˆ æƒ GitHub å‘Š è¯‰ å° æ˜ çš„ ç½‘ ç«™ â€œ è¿™ æ˜¯ æˆ‘ â€ ï¼Œ æ—  éœ€ æ³¨ å†Œ ã€‚
*   \*\* Spring Security OAuth2 Client \*\* ï¼š æ¡† æ¶ å†… ç½® OAuth2 å®¢ æˆ· ç«¯ ï¼Œ æ”¯ æŒ GitHub ã€ Google ç­‰ ç™» å½• ã€‚

#### \*\* å® æ“ æ­¥ éª¤ \*\*

1.  \*\* é… ç½® GitHub OAuth2 ç™» å½• \*\* ï¼š
    
    *   åœ¨ GitHub å¼€ å‘ è€… è®¾ ç½® ä¸­ åˆ› å»º OAuth App ï¼Œ è· å– `client-id` å’Œ `client-secret` ï¼›
    *   åœ¨ `application.properties` ä¸­ é… ç½® ï¼š
    
        spring.security.oauth2.client.registration.github.client-id=ä½ çš„client-id  
        spring.security.oauth2.client.registration.github.client-secret=ä½ çš„client-secret  
        spring.security.oauth2.client.registration.github.scope=user:email  #  ç”³  è¯·  é‚®  ç®±  æƒ  é™  
        
    
    *   åœ¨ SecurityConfig ä¸­ å¼€ å¯ OAuth2 ç™» å½• ï¼š
    
        .oauth2Login(oauth2 -> oauth2  
            .loginPage("/my-login")  //  è‡ª  å®š  ä¹‰  ç™»  å½•  é¡µ  åŠ   â€œ  GitHub  ç™»  å½•  â€  æŒ‰  é’®  
            .defaultSuccessUrl("/home")  
        )  
        
    
2.  \*\* å®‰ å…¨ é˜² æŠ¤ \*\* ï¼ˆ æ¡† æ¶ é»˜ è®¤ å¼€ å¯ ï¼Œ æ—  éœ€ é¢ å¤– é… ç½® ï¼‰ ï¼š
    *   \*\* CSRF é˜² æŠ¤ \*\* ï¼š é»˜ è®¤ å¼€ å¯ ï¼Œ æ¡† æ¶ è‡ª åŠ¨ ç”Ÿ æˆ CSRF ä»¤ ç‰Œ ï¼Œ è¡¨ å• æ äº¤ æ—¶ éªŒ è¯ ï¼›
    *   \*\* XSS é˜² æŠ¤ \*\* ï¼š Spring Boot é»˜ è®¤ å¼€ å¯ HTML è½¬ ä¹‰ ï¼Œ é˜² æ³¨ å…¥ è„š æœ¬ ï¼›
    *   \*\* ä¼š è¯ å›º å®š æ”» å‡» é˜² æŠ¤ \*\* ï¼š ç™» å½• å è‡ª åŠ¨ æ›´ æ¢ SessionID ã€‚

#### \*\* æ•ˆ æœ \*\*

*   å° æ˜ çš„ ç™» å½• é¡µ å¤š äº† ä¸ª â€œ ç”¨ GitHub ç™» å½• â€ æŒ‰ é’® ï¼Œ ç‚¹ å‡» å è·³ è½¬ GitHub æˆ æƒ ï¼Œ æˆ æƒ æˆ åŠŸ å è‡ª åŠ¨ ç™» å½• ç½‘ ç«™ ï¼›
*   æ¡† æ¶ è‡ª åŠ¨ æŒ¡ ä½ CSRF æ”» å‡» ï¼Œ å³ ä½¿ é»‘ å®¢ è¯± éª— å° æ˜ ç‚¹ é“¾ æ¥ ï¼Œ ä¹Ÿ æ—  æ³• æ“ ä½œ ã€‚

> ğŸ’¡ å° æ˜ çš„ ä½“ ä¼š ï¼š â€œ OAuth2 åƒ â€˜ æ‰¾ æœ‹ å‹ ä½œ è¯ â€™ ï¼Œ è®© GitHub å¸® å¿™ è¯ æ˜ â€˜ è¿™ æ˜¯ å° æ˜ â€™ ï¼› æ¡† æ¶ çš„ å®‰ å…¨ é˜² æŠ¤ åƒ â€˜ éš å½¢ é“  ç”² â€™ ï¼Œ å¹³ æ—¶ æ„Ÿ è§‰ ä¸ åˆ° ï¼Œ å…³ é”® æ—¶ åˆ» èƒ½ æŒ¡ åˆ€ ã€‚ â€

### \*\* å° æ˜ çš„ å­¦ ä¹  æ€» ç»“ \*\*

é€š è¿‡ è¿™ å‡  æ­¥ ï¼Œ å° æ˜ å½» åº• æŒ æ¡ äº† Spring Security é… Spring Boot çš„ æ ¸ å¿ƒ ç”¨ æ³• ï¼š

1.  \*\* ä» é»˜ è®¤ é… ç½® å…¥ é—¨ \*\* ï¼Œ è§‚ å¯Ÿ æ¡† æ¶ è‡ª åŠ¨ ç”Ÿ æˆ çš„ ç™» å½• / æƒ é™ é€» è¾‘ ï¼›
2.  \*\* è‡ª å®š ä¹‰ UserDetailsService å’Œ PasswordEncoder \*\* ï¼Œ è¿ æ¥ è‡ª å·± çš„ æ•° æ® åº“ ï¼Œ ç”¨ BCrypt åŠ  å¯† å¯† ç  ï¼›
3.  \*\* ç”¨ HttpSecurity å’Œ @PreAuthorize é… ç½® æƒ é™ \*\* ï¼Œ å® ç° URL çº§ å’Œ æ–¹ æ³• çº§ æ§ åˆ¶ ï¼›
4.  \*\* è‡ª å®š ä¹‰ ç™» å½• / æ³¨ é”€ é¡µ ã€ åŠ  â€œ è®° ä½ æˆ‘ â€ \*\* ï¼Œ ä¼˜ åŒ– ç”¨ æˆ· ä½“ éªŒ ï¼›
5.  \*\* é›† æˆ JWT \*\* ï¼Œ æ”¯ æŒ APP å’Œ å¾® æœ åŠ¡ æ—  çŠ¶ æ€ è®¤ è¯ ï¼›
6.  \*\* ç”¨ OAuth2 å® ç° ç¬¬ ä¸‰ æ–¹ ç™» å½• \*\* ï¼Œ å¼€ å¯ æ¡† æ¶ é»˜ è®¤ å®‰ å…¨ é˜² æŠ¤ ã€‚

> âœ¨ å° æ˜ çš„ æœ€ ç»ˆ æ„Ÿ æ‚Ÿ ï¼š  
> Spring Security ä¸ æ˜¯ ä¸€ å † å¤ æ‚ çš„ é… ç½® ï¼Œ è€Œ æ˜¯ ä¸€ ä¸ª â€œ å®‰ å…¨ ç§¯ æœ¨ ç›’ â€ ã€‚ å° æ˜ ç”¨ å®ƒ æ­ å»º äº† æ‘„ å½± ç½‘ ç«™ çš„ å®‰ å…¨ å ¡ å’ ï¼Œ ä» é»˜ è®¤ é… ç½® åˆ° è‡ª å®š ä¹‰ æ‰© å±• ï¼Œ ä» Web åˆ° APP ï¼Œ ä» è´¦ å· å¯† ç  åˆ° ç¬¬ ä¸‰ æ–¹ ç™» å½• ï¼Œ æ¯ ä¸€ æ­¥ éƒ½ è¸© åœ¨ â€œ éœ€ æ±‚ â€ å’Œ â€œ æŠ€ æœ¯ â€ çš„ ç»“ åˆ ç‚¹ ä¸Š ã€‚ ç° åœ¨ ï¼Œ ä»– å¯ ä»¥ ä¸“ å¿ƒ æ‹ æ‘„ æ›´ ç¾ çš„ ç…§ ç‰‡ ï¼Œ è€Œ ç½‘ ç«™ çš„ å®‰ å…¨ ï¼Œ äº¤ ç»™ Spring Security å°± å¤Ÿ äº† ï¼

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19256676](https://www.cnblogs.com/sun-10387834/p/19256676)