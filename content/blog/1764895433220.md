---
layout: post
title: 'MAFå¿«é€Ÿå…¥é—¨ï¼ˆ5ï¼‰å¼€å‘è‡ªå®šä¹‰Executor'
date: "2025-12-05T00:43:53Z"
---
MAFå¿«é€Ÿå…¥é—¨ï¼ˆ5ï¼‰å¼€å‘è‡ªå®šä¹‰Executor
=======================

![MAFå¿«é€Ÿå…¥é—¨ï¼ˆ5ï¼‰å¼€å‘è‡ªå®šä¹‰Executor](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214259190-896036614.png) ä¸Šä¸€ç¯‡ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­è¿›è¡Œå¤šAgentæ™ºèƒ½ä½“çš„é¡ºåºå’Œç§»äº¤ç¼–æ’ã€‚ä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æƒ³è¦åµŒå…¥ä¸€äº›ä¸šåŠ¡é€»è¾‘å’Œç»“æ„åŒ–è¾“å‡ºï¼Œäº¦æˆ–è€…æ˜¯éœ€è¦ä¿æŒå†å²å¯¹è¯ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å¼€å‘ä¸€äº›è‡ªå®šä¹‰Executoræ¥ç»„æˆå·¥ä½œæµã€‚æœ¬æ–‡ä»‹ç»äº†Executorçš„åŸºæœ¬æ¦‚å¿µ ä»¥åŠ å¦‚ä½•å¼€å‘è‡ªå®šä¹‰Executorï¼Œç„¶åç»™å‡ºäº†ä¸€ä¸ªè¥é”€æ–‡æ¡ˆç”Ÿæˆå®¡æ ¸çš„å·¥ä½œæµæ¡ˆä¾‹è¯¦ç»†ä»‹ç»äº†è‡ªå®šä¹‰Executorçš„åº”ç”¨ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Edisonã€‚

[ä¸Šä¸€ç¯‡](https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper04)ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­è¿›è¡Œå¤šAgentæ™ºèƒ½ä½“çš„é¡ºåºå’Œç§»äº¤ç¼–æ’ã€‚ä½†æ˜¯ï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æƒ³è¦åµŒå…¥ä¸€äº›ä¸šåŠ¡é€»è¾‘å’Œç»“æ„åŒ–è¾“å‡ºï¼Œäº¦æˆ–è€…æ˜¯éœ€è¦ä¿æŒå†å²å¯¹è¯ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å¼€å‘ä¸€äº›è‡ªå®šä¹‰Executoræ¥ç»„æˆå·¥ä½œæµã€‚

**ä»€ä¹ˆæ˜¯Executorï¼Ÿ**
================

Executoråˆç§°ä¸ºæ‰§è¡Œå™¨ï¼Œå®ƒæ˜¯MAFä¸­å¤„ç†å·¥ä½œæµæ¶ˆæ¯çš„åŸºæœ¬æ„å»ºæ¨¡å—ï¼Œæ˜¯æ¥å—ç»“æ„åŒ–æ¶ˆæ¯ã€æ‰§è¡Œå¹¶ç”Ÿæˆè¾“å‡ºç»“æœæ¶ˆæ¯æˆ–äº‹ä»¶çš„ç‹¬ç«‹å•å…ƒã€‚

**å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬æƒ³è¦å°è£…ä¸€äº›å¤æ‚çš„ä¸šåŠ¡æµç¨‹åˆ°Agentçš„å·¥ä½œæµä¸­ï¼Œåˆæˆ–è€…æƒ³è¦å®Œå…¨æ§åˆ¶Agentçš„ç”Ÿå‘½å‘¨æœŸå’Œå¯¹è¯å†å²ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦å¼€å‘ä¸€äº›è‡ªå®šä¹‰çš„Executorã€‚**

**ä¾‹å¦‚ï¼Œæˆ‘ä»¬æƒ³è¦åšä¸€äº›ä¸¥æ ¼çš„è¯„åˆ†åˆ¤æ–­ã€å¾ªç¯æ§åˆ¶ã€æ¡ä»¶ç»ˆæ­¢çš„ä¸šåŠ¡é€»è¾‘ï¼Œå°±éœ€è¦è‡ªå®šä¹‰Executoräº†ã€‚**

è¿™é‡Œä»¥ä¸€ä¸ªæ™ºèƒ½è¥é”€æ–‡æ¡ˆçš„åœºæ™¯ä¸ºä¾‹ï¼Œå‡è®¾ä¸€ä¸ªä¼ä¸šæœ‰ä¸¤ä¸ªä¸“å®¶ï¼Œä¸€ä¸ªä¸“é—¨è´Ÿè´£ç¼–å†™æ–‡æ¡ˆï¼Œå¦ä¸€ä¸ªåˆ™è´Ÿè´£å¯¹æ–‡æ¡ˆè¿›è¡Œå®¡æ ¸è¯„åˆ†ã€‚åªæœ‰å½“æ’°å†™çš„æ–‡æ¡ˆé€šè¿‡å®¡æ ¸è´Ÿè´£äººçš„å®¡æ ¸ï¼ˆå‡è®¾é‡åŒ–æŒ‡æ ‡ï¼šè¯„åˆ†>=8ï¼‰æ‰èƒ½è¿›è¡Œå‘å¸ƒï¼Œå¦åˆ™æ–‡æ¡ˆç¼–å†™è€…éœ€è¦æ ¹æ®å®¡æ ¸äººæä¾›çš„åé¦ˆæ”¹è¿›å»ºè®®è¿›è¡Œåå¤ä¿®æ”¹ã€‚

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203213516715-548024236.png)

æ¡ˆä¾‹æ¥è‡ªåœ£æ°ã€Š[.NET + AI æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://mp.weixin.qq.com/s?__biz=MzA4NzQzNTg4Ng==&mid=2651744458&idx=1&sn=139f7584e81aeecd0945133bdc2b4791&scene=21#wechat_redirect)ã€‹

ç”±ä¸Šå›¾å¯çŸ¥ï¼Œè¿™é‡Œä¸ä»…éœ€è¦æ–‡æ¡ˆä¸“å®¶ å’Œ å®¡æ ¸ä¸“å®¶ åµŒå…¥ä¸€äº›è¯„åˆ†å’Œåé¦ˆçš„é€»è¾‘ï¼Œè¿˜è¦è®¾ç½®å¾ªç¯å’Œç»ˆæ­¢çš„æ¡ä»¶ï¼Œæ‰èƒ½è®©è¿™ä¸ªå·¥ä½œæµèƒ½å¤Ÿæ¯”è¾ƒå‡†ç¡®çš„æ»¡è¶³ä¼ä¸šçš„éœ€æ±‚ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°±éœ€è¦å¼€å‘ä¸¤ä¸ªè‡ªå®šä¹‰çš„Executoræ¥å°è£…æ–‡æ¡ˆæ’°å†™ å’Œ æ–‡æ¡ˆå®¡æ ¸çš„Agentã€‚

é‚£ä¹ˆï¼Œå“ªäº›åœºæ™¯ä¸éœ€è¦è‡ªå®šä¹‰Executorå‘¢ï¼Ÿ

æ¯”å¦‚ï¼Œå°±åªéœ€è¦ä¸€æ¬¡æ€§Agentçš„è°ƒç”¨è¾“å‡ºå›ç­”ï¼Œåˆæˆ–è€…ä¸éœ€è¦åµŒå…¥ä¸¥æ ¼çš„ä¸šåŠ¡é€»è¾‘çš„åœºæ™¯ã€‚

ä¸‹é¢ï¼Œå°±è®©æˆ‘ä»¬æ¥ä¸€ä¸€å®ç°è¿™ä¸ªæ¡ˆä¾‹ã€‚

**å‡†å¤‡å·¥ä½œ**
========

åœ¨ä»Šå¤©çš„è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª.NETæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå®‰è£…äº†ä»¥ä¸‹NuGetåŒ…ï¼š

*   Microsoft.Agents.AI.OpenAI
*   Microsoft.Agents.AI.Workflows
*   Microsoft.Extensions.AI.OpenAI

æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†LLM APIçš„ä¿¡æ¯ï¼š

{
  "OpenAI": {
    "EndPoint": "https://api.siliconflow.cn",
    "ApiKey": "\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*",
    "ModelId": "Qwen/Qwen3-30B-A3B-Instruct-2507"
  }
}

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ SiliconCloud æä¾›çš„Â Qwen/Qwen3-30B-A3B-Instruct-2507Â æ¨¡å‹ï¼Œä¹‹å‰çš„ Qwen2.5 æ¨¡å‹åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ä¸é€‚ç”¨ã€‚ä½ å¯ä»¥é€šè¿‡è¿™ä¸ªURLæ³¨å†Œè´¦å·ï¼š[https://cloud.siliconflow.cn/i/DomqCefW](https://cloud.siliconflow.cn/i/DomqCefW)Â è·å–å¤§é‡å…è´¹çš„Tokenæ¥è¿›è¡Œæœ¬æ¬¡å®éªŒã€‚

ç„¶åï¼Œæˆ‘ä»¬å°†é…ç½®æ–‡ä»¶ä¸­çš„APIä¿¡æ¯è¯»å–å‡ºæ¥ï¼š

var config = new ConfigurationBuilder()
    .AddJsonFile($"appsettings.json", optional: false, reloadOnChange: true)
    .Build();
var openAIProvider = config.GetSection("OpenAI").Get<OpenAIProvider>();

å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹
========

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹åœ¨è¿™ä¸ªå·¥ä½œæµä¸­éœ€è¦ç”Ÿæˆä¼ é€’çš„æ•°æ®æ¨¡å‹ï¼š

ï¼ˆ1ï¼‰SloganResult ï¼šæ–‡æ¡ˆç”Ÿæˆç»“æœ

/// <summary>
/// æ–‡æ¡ˆç”Ÿæˆç»“æœ
/// </summary>
public sealed class SloganResult
{
    /// <summary>
    /// äº§å“ä»»åŠ¡æè¿°
    /// </summary>
    \[JsonPropertyName("task")\]
    public required string Task { get; set; }
    /// <summary>
    /// ç”Ÿæˆçš„æ ‡è¯­
    /// </summary>
    \[JsonPropertyName("slogan")\]
    public required string Slogan { get; set; }
}

ï¼ˆ2ï¼‰FeedbackResultï¼šå®¡æ ¸åé¦ˆç»“æœ

/// <summary>
/// å®¡æ ¸åé¦ˆç»“æœ
/// </summary>
public sealed class FeedbackResult
{
    /// <summary>
    /// å®¡æ ¸è¯„è®º
    /// </summary>
    \[JsonPropertyName("comments")\]
    public string Comments { get; set; } = string.Empty;
    /// <summary>
    /// è´¨é‡è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰
    /// </summary>
    \[JsonPropertyName("rating")\]
    public int Rating { get; set; }
    /// <summary>
    /// æ”¹è¿›å»ºè®®
    /// </summary>
    \[JsonPropertyName("actions")\]
    public string Actions { get; set; } = string.Empty;
}

å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶
=======

MAFä¸­å®šä¹‰äº†ä¸€ä¸ªWorkflowEventçš„åŸºç±»ï¼Œæ‰€æœ‰è‡ªå®šä¹‰Eventéƒ½éœ€è¦ç»§æ‰¿äºå®ƒã€‚

ï¼ˆ1ï¼‰SloganGeneratedEvent ï¼šæ–‡æ¡ˆå·²ç”Ÿæˆäº‹ä»¶

public sealed class SloganGeneratedEvent : WorkflowEvent
{
    private readonly SloganResult \_sloganResult;
    public SloganGeneratedEvent(SloganResult sloganResult) 
        : base(sloganResult)
    {
        this.\_sloganResult = sloganResult;
    }
    public override string ToString() =>
        $"ğŸ“ \[æ ‡è¯­ç”Ÿæˆ\] {\_sloganResult.Slogan}";
}

ï¼ˆ2ï¼‰FeedbackFinishedEvent : åé¦ˆå·²å®Œæˆäº‹ä»¶

/// <summary>
/// è‡ªå®šä¹‰äº‹ä»¶:å®¡æ ¸åé¦ˆå®Œæˆ
/// </summary>
public sealed class FeedbackFinishedEvent : WorkflowEvent
{
    private readonly FeedbackResult \_feedbackResult;
    public FeedbackFinishedEvent(FeedbackResult feedbackResult) 
        : base(feedbackResult)
    {
        this.\_feedbackResult = feedbackResult;
    }
    public override string ToString() =>
        $"""
        ğŸ“Š \[å®¡æ ¸åé¦ˆ\]
        è¯„åˆ†: {\_feedbackResult.Rating}/10
        è¯„è®º: {\_feedbackResult.Comments}
        å»ºè®®: {\_feedbackResult.Actions}
        """;
}

å¼€å‘æ–‡æ¡ˆç”ŸæˆExecutor
==============

MAFä¸­å®šä¹‰äº†ä¸€ä¸ªExecutorçš„åŸºç±»ï¼Œæ‰€æœ‰è‡ªå®šä¹‰Exectuoréƒ½éœ€è¦ç»§æ‰¿äºå®ƒã€‚

/// <summary>
/// æ–‡æ¡ˆç”Ÿæˆ Executor - æ ¹æ®ä»»åŠ¡æˆ–åé¦ˆç”Ÿæˆæ ‡è¯­
/// </summary>
public class SloganWriterExecutor : Executor
{
    private readonly AIAgent \_agent;
    private readonly AgentThread \_thread;
    /// <summary>
    /// åˆå§‹åŒ–æ–‡æ¡ˆç”Ÿæˆ Executor
    /// </summary>
    /// <param name="id">Executor å”¯ä¸€æ ‡è¯†</param>
    /// <param name="chatClient">AI èŠå¤©å®¢æˆ·ç«¯</param>
    public SloganWriterExecutor(string id, IChatClient chatClient) : base(id)
    {
        // é…ç½® Agent é€‰é¡¹
        ChatClientAgentOptions agentOptions = new(
            instructions: "ä½ æ˜¯ä¸€åä¸“ä¸šçš„æ–‡æ¡ˆæ’°å†™ä¸“å®¶ã€‚ä½ å°†æ ¹æ®äº§å“ç‰¹æ€§åˆ›ä½œç®€æ´æœ‰åŠ›çš„å®£ä¼ æ ‡è¯­ã€‚"
        )
        {
            ChatOptions \= new()
            {
                // é…ç½®ç»“æ„åŒ–è¾“å‡ºï¼šè¦æ±‚è¿”å› SloganResult JSON æ ¼å¼
                ResponseFormat = ChatResponseFormat.ForJsonSchema<SloganResult>()
            }
        };
        // åˆ›å»º Agent å’Œå¯¹è¯çº¿ç¨‹
        this.\_agent = new ChatClientAgent(chatClient, agentOptions);
        this.\_thread = this.\_agent.GetNewThread();
    }
    /// <summary>
    /// é…ç½®æ¶ˆæ¯è·¯ç”±ï¼šæ”¯æŒä¸¤ç§è¾“å…¥ç±»å‹
    /// </summary>
    protected override RouteBuilder ConfigureRoutes(RouteBuilder routeBuilder) =>
        routeBuilder
            .AddHandler<string, SloganResult>(this.HandleInitialTaskAsync)      // å¤„ç†åˆå§‹ä»»åŠ¡
            .AddHandler<FeedbackResult, SloganResult>(this.HandleFeedbackAsync);  // å¤„ç†åé¦ˆ
    /// <summary>
    /// å¤„ç†åˆå§‹ä»»åŠ¡ï¼ˆé¦–æ¬¡ç”Ÿæˆï¼‰
    /// </summary>
    private async ValueTask<SloganResult> HandleInitialTaskAsync(
        string message,
        IWorkflowContext context,
        CancellationToken cancellationToken \= default)
    {
        Console.WriteLine($"âœï¸ \[æ–‡æ¡ˆç”Ÿæˆ\] æ¥æ”¶åˆ°ä»»åŠ¡: {message}");
        // è°ƒç”¨ Agent ç”Ÿæˆæ ‡è¯­
        var result = await this.\_agent.RunAsync(message, this.\_thread, cancellationToken: cancellationToken);
        // ååºåˆ—åŒ–ç»“æ„åŒ–è¾“å‡º
        var sloganResult = JsonSerializer.Deserialize<SloganResult>(result.Text)
            ?? throw new InvalidOperationException("âŒ ååºåˆ—åŒ–æ ‡è¯­ç»“æœå¤±è´¥");
        Console.WriteLine($"ğŸ“ \[æ–‡æ¡ˆç”Ÿæˆ\] ç”Ÿæˆæ ‡è¯­: {sloganResult.Slogan}");
        // å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶ï¼ˆå°†åœ¨åç»­å®šä¹‰ï¼‰
        await context.AddEventAsync(new SloganGeneratedEvent(sloganResult), cancellationToken);
        return sloganResult;
    }
    /// <summary>
    /// å¤„ç†å®¡æ ¸åé¦ˆï¼ˆæ”¹è¿›ä¼˜åŒ–ï¼‰
    /// </summary>
    private async ValueTask<SloganResult> HandleFeedbackAsync(
        FeedbackResult feedback,
        IWorkflowContext context,
        CancellationToken cancellationToken \= default)
    {
        // æ„é€ åé¦ˆæ¶ˆæ¯
        var feedbackMessage = $"""
            ä»¥ä¸‹æ˜¯å¯¹ä½ ä¹‹å‰æ ‡è¯­çš„å®¡æ ¸åé¦ˆï¼š
            è¯„è®º: {feedback.Comments}
            è¯„åˆ†: {feedback.Rating} / 10
            æ”¹è¿›å»ºè®®: {feedback.Actions}
            è¯·æ ¹æ®åé¦ˆæ”¹è¿›ä½ çš„æ ‡è¯­ï¼Œä½¿å…¶æ›´åŠ ç²¾å‡†æœ‰åŠ›ã€‚
            """;
        Console.WriteLine($"ğŸ”„ \[æ–‡æ¡ˆç”Ÿæˆ\] æ¥æ”¶åˆ°åé¦ˆï¼Œè¯„åˆ†: {feedback.Rating}/10");
        // è°ƒç”¨ Agent æ”¹è¿›æ ‡è¯­ï¼ˆä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡ï¼‰
        var result = await this.\_agent.RunAsync(feedbackMessage, this.\_thread, cancellationToken: cancellationToken);
        var sloganResult = JsonSerializer.Deserialize<SloganResult>(result.Text)
            ?? throw new InvalidOperationException("âŒ ååºåˆ—åŒ–æ ‡è¯­ç»“æœå¤±è´¥");
        Console.WriteLine($"ğŸ“ \[æ–‡æ¡ˆç”Ÿæˆ\] æ”¹è¿›åæ ‡è¯­: {sloganResult.Slogan}");
        // å‘å¸ƒäº‹ä»¶
        await context.AddEventAsync(new SloganGeneratedEvent(sloganResult), cancellationToken);
        return sloganResult;
    }
}

åœ¨è¿™ä¸ªExecutorä¸­ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

ï¼ˆ1ï¼‰åœ¨å®ä¾‹åŒ–Agentæ—¶é…ç½®ç»“æ„åŒ–è¾“å‡ºï¼Œ**ä¸¥æ ¼è¾“å‡ºå¼ºç±»å‹çš„JSONæ ¼å¼æ•°æ®**ï¼›

ï¼ˆ2ï¼‰éœ€è¦**é‡å†™ConfigureRoutesæ–¹æ³•é…ç½®æ¶ˆæ¯è·¯ç”±**ï¼Œå³ä»å¤„ç†åˆå§‹ä»»åŠ¡å¼€å§‹ï¼Œå¹¶è®¾ç½®å¤„ç†åé¦ˆé—­ç¯ï¼›

å…¶å·¥ä½œæœºåˆ¶å¦‚ä¸‹ï¼š

*   å½“æ¥æ”¶åˆ°stringæ¶ˆæ¯ï¼ˆå³ç”¨æˆ·çš„ä»»åŠ¡ä¿¡æ¯ï¼‰æ—¶ï¼Œè°ƒç”¨ HandleInitialTaskAsync æ–¹æ³•è¿›è¡Œé¦–æ¬¡ç”Ÿæˆï¼›
    
*   å½“æ¥æ”¶åˆ°FeedbackResultç±»å‹æ¶ˆæ¯ï¼ˆå³è´¨é‡å®¡æ ¸åé¦ˆçš„æ¶ˆæ¯ï¼‰æ—¶ï¼Œè°ƒç”¨ HandleFeedbackAsync æ–¹æ³•è¿›è¡Œæ”¹è¿›ç”Ÿæˆã€‚
    

ï¼ˆ3ï¼‰åœ¨è°ƒç”¨å®ŒAgentè·å–å“åº”ä¹‹åï¼Œéœ€è¦å°†å…¶**è¿›è¡Œå¼ºç±»å‹çš„ååºåˆ—åŒ–è¾“å‡º**ï¼›

ï¼ˆ4ï¼‰æœ€åé€šè¿‡**å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶è¿›è¡Œå·¥ä½œæµä¼ é€’**ï¼Œè¿™é‡Œæ˜¯ SloganGeneratedEventï¼›

ï¼ˆ5ï¼‰**é€šè¿‡AgentThreadå®ç°å¯¹è¯å†å²ä¿æŒ**ï¼Œè€Œä¸æ˜¯æ¯æ¬¡ä»å¤´å¼€å§‹ã€‚

å¼€å‘è´¨é‡å®¡æ ¸Executor
==============

åœ¨è´¨é‡å®¡æ ¸ä¸­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„å®¡æ ¸é€»è¾‘ï¼šè¯„åˆ†>=8ä»£è¡¨é€šè¿‡å®¡æ ¸å¯ä»¥å‘å¸ƒï¼Œè¯„åˆ†<8åˆ™å‘é€åé¦ˆç»§ç»­å¾ªç¯ï¼Œå¦‚æœç¼–è¾‘æ¬¡æ•°>=3æ¬¡åˆ™éœ€è¦ç»ˆæ­¢å¾ªç¯è¾“å‡ºå½“å‰ç‰ˆæœ¬æ–‡æ¡ˆã€‚

/// <summary>
/// å®¡æ ¸åé¦ˆ Executor - è¯„ä¼°æ ‡è¯­è´¨é‡å¹¶æä¾›åé¦ˆ
/// </summary>
public sealed class FeedbackExecutor : Executor<SloganResult>
{
    private readonly AIAgent \_agent;
    private readonly AgentThread \_thread;
    private int \_attempts = 0;
    /// <summary>
    /// æœ€ä½è¯„åˆ†è¦æ±‚ï¼ˆ1-10åˆ†ï¼‰
    /// </summary>
    public int MinimumRating { get; init; } = 8;
    /// <summary>
    /// æœ€å¤§å°è¯•æ¬¡æ•°
    /// </summary>
    public int MaxAttempts { get; init; } = 3;
    /// <summary>
    /// åˆå§‹åŒ–å®¡æ ¸åé¦ˆ Executor
    /// </summary>
    /// <param name="id">Executor å”¯ä¸€æ ‡è¯†</param>
    /// <param name="chatClient">AI èŠå¤©å®¢æˆ·ç«¯</param>
    public FeedbackExecutor(string id, IChatClient chatClient) 
        : base(id)
    {
        // é…ç½® Agent é€‰é¡¹
        ChatClientAgentOptions agentOptions = new(
            instructions: "ä½ æ˜¯ä¸€åä¸“ä¸šçš„æ–‡æ¡ˆå®¡æ ¸ä¸“å®¶ã€‚ä½ å°†è¯„ä¼°æ ‡è¯­çš„è´¨é‡ï¼Œå¹¶æä¾›æ”¹è¿›å»ºè®®ã€‚"
        )
        {
            ChatOptions \= new()
            {
                // é…ç½®ç»“æ„åŒ–è¾“å‡ºï¼šè¦æ±‚è¿”å› FeedbackResult JSON æ ¼å¼
                ResponseFormat = ChatResponseFormat.ForJsonSchema<FeedbackResult>()
            }
        };
        this.\_agent = new ChatClientAgent(chatClient, agentOptions);
        this.\_thread = this.\_agent.GetNewThread();
    }
    /// <summary>
    /// å¤„ç†æ ‡è¯­å®¡æ ¸
    /// </summary>
    public override async ValueTask HandleAsync(
        SloganResult slogan,
        IWorkflowContext context,
        CancellationToken cancellationToken \= default)
    {
        // æ„é€ å®¡æ ¸æ¶ˆæ¯
        var reviewMessage = $"""
            è¯·å®¡æ ¸ä»¥ä¸‹æ ‡è¯­ï¼š
            ä»»åŠ¡: {slogan.Task}
            æ ‡è¯­: {slogan.Slogan}
            è¯·æä¾›ï¼š
            1. è¯¦ç»†çš„è¯„è®ºï¼ˆcommentsï¼‰
            2. è´¨é‡è¯„åˆ†ï¼ˆratingï¼Œ1\-10åˆ†ï¼‰
            3. æ”¹è¿›å»ºè®®ï¼ˆactionsï¼‰
            """;
        Console.WriteLine($"ğŸ” \[è´¨é‡å®¡æ ¸\] å¼€å§‹å®¡æ ¸æ ‡è¯­: {slogan.Slogan}");
        // è°ƒç”¨ Agent è¿›è¡Œå®¡æ ¸
        var response = await this.\_agent.RunAsync(reviewMessage, this.\_thread, cancellationToken: cancellationToken);
        // ååºåˆ—åŒ–åé¦ˆç»“æœ
        var feedback = JsonSerializer.Deserialize<FeedbackResult>(response.Text)
            ?? throw new InvalidOperationException("âŒ ååºåˆ—åŒ–åé¦ˆç»“æœå¤±è´¥");
        Console.WriteLine($"ğŸ“Š \[è´¨é‡å®¡æ ¸\] è¯„åˆ†: {feedback.Rating}/10");
        // å‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶ï¼ˆå°†åœ¨åç»­å®šä¹‰ï¼‰
        await context.AddEventAsync(new FeedbackFinishedEvent(feedback), cancellationToken);
        // ä¸šåŠ¡é€»è¾‘ï¼šåˆ¤æ–­æ˜¯å¦é€šè¿‡å®¡æ ¸
        if (feedback.Rating >= this.MinimumRating)
        {
            // âœ… é€šè¿‡å®¡æ ¸
            await context.YieldOutputAsync(
                $"""
                âœ… æ ‡è¯­å·²é€šè¿‡å®¡æ ¸ï¼
                ä»»åŠ¡: {slogan.Task}
                æ ‡è¯­: {slogan.Slogan}
                è¯„åˆ†: {feedback.Rating}/10
                è¯„è®º: {feedback.Comments}
                """,
                cancellationToken
            );
            Console.WriteLine($"âœ… \[è´¨é‡å®¡æ ¸\] æ ‡è¯­é€šè¿‡å®¡æ ¸");
            return;
        }
        // âŒ æœªé€šè¿‡å®¡æ ¸ï¼Œæ£€æŸ¥å°è¯•æ¬¡æ•°
        if (this.\_attempts >= this.MaxAttempts)
        {
            // è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œè¾“å‡ºæœ€ç»ˆç‰ˆæœ¬
            await context.YieldOutputAsync(
                $"""
                âš ï¸ æ ‡è¯­åœ¨ {this.MaxAttempts} æ¬¡å°è¯•åæœªè¾¾åˆ°æœ€ä½è¯„åˆ†è¦æ±‚ã€‚
                æœ€ç»ˆæ ‡è¯­: {slogan.Slogan}
                æœ€ç»ˆè¯„åˆ†: {feedback.Rating}/10
                è¯„è®º: {feedback.Comments}
                """,
                cancellationToken
            );
            Console.WriteLine($"âš ï¸ \[è´¨é‡å®¡æ ¸\] è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ï¼Œç»ˆæ­¢æµç¨‹");
            return;
        }
        // ğŸ”„ ç»§ç»­å¾ªç¯ï¼šå‘é€åé¦ˆæ¶ˆæ¯å›åˆ° SloganWriterExecutor
        await context.SendMessageAsync(feedback, cancellationToken: cancellationToken);
        this.\_attempts++;
        Console.WriteLine($"ğŸ”„ \[è´¨é‡å®¡æ ¸\] å‘é€åé¦ˆï¼Œç¬¬ {this.\_attempts} æ¬¡å°è¯•");
    }
}

åœ¨è¿™ä¸ªExecutorä¸­ï¼Œé™¤äº†ä¹‹å‰æåˆ°çš„å‡ ç‚¹ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ï¼š

*   åœ¨ååºåˆ—åŒ–åé¦ˆç»“æœåŠå‘å¸ƒè‡ªå®šä¹‰äº‹ä»¶ä¹‹åï¼Œéœ€è¦åµŒå…¥è¯„åˆ†é€»è¾‘ï¼Œå³åˆ¤æ–­æ˜¯å¦é€šè¿‡å®¡æ ¸ï¼›å¦‚æœé€šè¿‡å®¡æ ¸ï¼Œå°±åŠæ—¶ç»“æŸå¾ªç¯ï¼›å¦‚æœä¸é€šè¿‡ï¼Œåˆ™å‘é€åé¦ˆæ¶ˆæ¯ç»§ç»­å¾ªç¯ï¼›
    
*   è®°å½•å®¡æ ¸æ¬¡æ•°ï¼Œå¦‚æœè¾¾åˆ°è®¾å®šçš„æœ€å¤§å€¼ï¼Œä¹ŸåŠæ—¶ç»“æŸå¾ªç¯ä¸æ‹æˆ˜ï¼
    
*   é€šè¿‡ IWorkflowContext çš„Â SendMessageAsync æ–¹æ³•å°†åé¦ˆæ¶ˆæ¯ä¼ é€’ç»™å…¶ä»–å‚ä¸è€…ï¼Œè¿™é‡Œæ˜¯ SloganWriterExecutorã€‚
    

**æ„å»ºå·¥ä½œæµ**
=========

ç°åœ¨ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸€ä¸ªWorkflowï¼Œç°åœ¨Let's do it!

Step1: è·å–ChatClient

var chatClient = new OpenAIClient(
        new ApiKeyCredential(openAIProvider.ApiKey),
        new OpenAIClientOptions { Endpoint = new Uri(openAIProvider.Endpoint) })
    .GetChatClient(openAIProvider.ModelId)
    .AsIChatClient();

Step2: å®ä¾‹åŒ–è‡ªå®šä¹‰Executors

var solganWriter = new SloganWriterExecutor(id: "SloganWriter", chatClient);
var feebackHandler = new FeedbackExecutor(id: "FeedbackHandler", chatClient);
Console.WriteLine("âœ… Executor å®ä¾‹åˆ›å»ºå®Œæˆ");

Step3: åˆ›å»ºå·¥ä½œæµ

var workflow = new WorkflowBuilder(solganWriter)
    .AddEdge(source: solganWriter, target: feebackHandler) // ç”Ÿæˆ â†’ å®¡æ ¸
    .AddEdge(source: feebackHandler, target: solganWriter) // å®¡æ ¸ä¸é€šè¿‡ â†’ é‡æ–°ç”Ÿæˆ
    .WithOutputFrom(feebackHandler)                                      // æŒ‡å®šè¾“å‡ºæ¥æº
    .Build();
Console.WriteLine("âœ… å·¥ä½œæµæ„å»ºå®Œæˆ");

Step4: æµ‹è¯•å·¥ä½œæµ

// å®šä¹‰äº§å“ä»»åŠ¡
var productTask = "è¯·ä¸ºé©¬è‡ªè¾¾ä¸€æ¬¾ç»æµå®æƒ ä¸”é©¾é©¶ä¹è¶£åè¶³çš„ç”µåŠ¨SUVåˆ›ä½œæ ‡è¯­ï¼Œè¦æ±‚ç»“åˆé©¬è‡ªè¾¾ç”µè½¦çš„ç‰¹æ€§æ¥åˆ›ä½œ";
Console.WriteLine($"ğŸ“‹ äº§å“éœ€æ±‚: {productTask}\\n");
Console.WriteLine($"ğŸ“Š å®¡æ ¸æ ‡å‡†: è¯„åˆ† >= 8åˆ†");
Console.WriteLine($"ğŸ”„ æœ€å¤§å°è¯•: 3æ¬¡\\n");
Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
Console.WriteLine("â±ï¸ å¼€å§‹æ‰§è¡Œå·¥ä½œæµ...");
Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n");
// æ‰§è¡Œå·¥ä½œæµ
await using (var run = await InProcessExecution.StreamAsync(workflow, input: productTask))
{
    // ç›‘å¬å·¥ä½œæµäº‹ä»¶
    await foreach (WorkflowEvent evt in run.WatchStreamAsync())
    {
        // ä½¿ç”¨æ¨¡å¼åŒ¹é…è¯†åˆ«ä¸åŒç±»å‹çš„äº‹ä»¶
        switch (evt)
        {
            case SloganGeneratedEvent sloganEvent:
                // å¤„ç†æ ‡è¯­ç”Ÿæˆäº‹ä»¶
                Console.WriteLine($"âœ¨ {sloganEvent}");
                Console.WriteLine();
                break;
            case FeedbackFinishedEvent feedbackEvent:
                // å¤„ç†å®¡æ ¸åé¦ˆäº‹ä»¶
                Console.WriteLine($"{feedbackEvent}");
                Console.WriteLine();
                break;
            case WorkflowOutputEvent outputEvent:
                // å¤„ç†æœ€ç»ˆè¾“å‡ºäº‹ä»¶
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                Console.WriteLine("ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ");
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n");
                Console.WriteLine($"{outputEvent.Data}");
                break;
        }
    }
    Console.WriteLine("\\nâœ… æ‰€æœ‰æµç¨‹å·²å®Œæˆ");
}

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

é¦–å…ˆï¼Œè·å¾—äº†é¦–æ¬¡çš„æ–‡æ¡ˆæ’°å†™å†…å®¹ï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214043905-396691260.png)

ç„¶åï¼Œç¬¬ä¸€è½®å®¡æ ¸è¯„åˆ†6åˆ†å¹¶ç»™å‡ºåé¦ˆï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214051623-1845699567.png)

ç„¶åï¼Œæ–‡æ¡ˆæ’°å†™å¼€å§‹ä¿®æ”¹å½¢æˆç¬¬äºŒç‰ˆæ–‡æ¡ˆï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214102552-1316284554.png)

ç„¶åï¼Œå†æ¬¡è¯„åˆ†ä¸º6åˆ†åˆç»™å‡ºåé¦ˆï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214112756-1945522991.png)

ç„¶åï¼Œç»ˆäºè·å¾—å®¡æ ¸é€šè¿‡ï¼ˆæœ¬æ¬¡è¯„åˆ†9åˆ†>=8åˆ†ï¼‰ï¼Œå¯ä»¥å‘å¸ƒï¼š

![image](https://img2024.cnblogs.com/blog/381412/202512/381412-20251203214125654-1981686785.png)

è‡³æ­¤ï¼Œå·¥ä½œæµå·²ç»ç»“æŸï¼Œå¯ä»¥çœ‹è§ï¼Œç¬¬ä¸‰æ¬¡ç”Ÿæˆçš„æ–‡æ¡ˆå†…å®¹æ¯”å‰ä¸¤æ¬¡è¦å¥½ä¸€äº›ã€‚

**å°ç»“**
======

æœ¬æ–‡ä»‹ç»äº†Executorçš„åŸºæœ¬æ¦‚å¿µ ä»¥åŠ å¦‚ä½•å¼€å‘è‡ªå®šä¹‰Executorï¼Œç„¶åç»™å‡ºäº†ä¸€ä¸ªè¥é”€æ–‡æ¡ˆç”Ÿæˆå®¡æ ¸çš„å·¥ä½œæµæ¡ˆä¾‹è¯¦ç»†ä»‹ç»äº†è‡ªå®šä¹‰Executorçš„åº”ç”¨ã€‚

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ MAFä¸­å¦‚ä½•è¿›è¡Œæ··åˆç¼–æ’ Agent å’Œ Executorï¼Œè¦†ç›–å®é™…åœºæ™¯ä¸­ ç¡®å®šæ€§çš„ä¸šåŠ¡é€»è¾‘ å’Œ AIæ™ºèƒ½å†³ç­– çš„ç»“åˆåº”ç”¨ã€‚

ç¤ºä¾‹æºç 
====

GitHub:Â [https://github.com/EdisonTalk/MAFD](https://github.com/EdisonTalk/MAFD)

å‚è€ƒèµ„æ–™
====

Microsoft Learnï¼Œã€Š[Agent Framework Tutorials](https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview?wt.mc_id=MVP_397012)ã€‹

æ¨èå­¦ä¹ 
====

åœ£æ°ï¼Œã€Š[.NET + AI æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹

![](https://images.cnblogs.com/cnblogs_com/edisonchou/1647700/o_200902144330EdisonTalk-Footer.jpg)

ä½œè€…ï¼šçˆ±è¿ªç”Ÿ

å‡ºå¤„ï¼š[https://edisontalk.cnblogs.com](https://edisontalk.cnblogs.com "from")

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ã€‚

[![](http://service.t.sina.com.cn/widget/qmd/2068032061/d643d182/10.png)](https://weibo.com/u/2068032061?s=6uyXnP)