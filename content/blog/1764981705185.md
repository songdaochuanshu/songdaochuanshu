---
layout: post
title: 'SQLä¸­çš„CTEç”¨æ³•åˆæ­¥ï¼ˆCommon Table Expressionå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰'
date: "2025-12-06T00:41:45Z"
---
SQLä¸­çš„CTEç”¨æ³•åˆæ­¥ï¼ˆCommon Table Expressionå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰
===========================================

åˆšç”¨ä¸Š CTEï¼Œæˆ‘æ•´ä¸ªäººéƒ½å‚»äº†ï¼ åŸæ¥å†™æŠ¥è¡¨è¦åµŒä¸‰å››å±‚å­æŸ¥è¯¢ï¼Œæ‹¬å·å¯¹åˆ°æƒ³å“­ï¼Œæ”¹ä¸ªå­—æ®µå¾—ç¿»åŠå¤©ï¼›ç°åœ¨ä¸€ä¸ª WITH æŠŠæ‰€æœ‰è„æ´»å¹²å®Œï¼Œåé¢ SELECT å¹²å¹²å‡€å‡€ï¼Œåƒå†™ä»£ç ä¸€æ ·çˆ½ã€‚ çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿæˆ‘è¶Šç”¨è¶Šè§‰å¾—ğŸ¤”

CTEï¼Œå…¨ç§° Common Table Expressionï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰ï¼Œæ˜¯ SQL çš„ä¸€ä¸ªå¼ºå¤§ç‰¹æ€§ã€‚

æ¦‚å¿µ
==

CTEæ˜¯åœ¨å†™ SQL æ—¶ä¸´æ—¶å®šä¹‰çš„å¯å¤ç”¨â€œè™šæ‹Ÿè¡¨â€ï¼Œç”¨ `WITH` å¼€å¤´ã€‚  
å¯ä»¥è®©å¤æ‚ SQL å˜å¾—æ›´ç®€æ´ã€å¯è¯»ã€å¯å¤ç”¨ï¼Œè¿˜èƒ½å®ç°é€’å½’æŸ¥è¯¢ï¼ˆæ ‘ç»“æ„ï¼‰ã€‚

åŸºæœ¬å½¢å¼
----

    WITH temp AS (
        SELECT id, price FROM product WHERE price > 100
    )
    SELECT * FROM temp WHERE id < 1000;
    

å…¶ä¸­ï¼Œ`temp` æ˜¯ä¸´æ—¶è¡¨ï¼Œé€šè¿‡CTEè®©SQL æ›´æ¸…æ™°ï¼Œé¿å…é‡å¤å­æŸ¥è¯¢ã€‚

ä»·å€¼
--

### 1\. æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§

è¿™æ˜¯ CTE **æœ€ç›´æ¥**çš„å¥½å¤„ã€‚å½“ä½ çš„ SQL é€»è¾‘éå¸¸å¤æ‚ï¼ŒåŒ…å«å¤šå±‚åµŒå¥—çš„å­æŸ¥è¯¢ï¼ˆSubqueryï¼‰æ—¶ï¼Œä»£ç ä¼šå˜å¾—åƒâ€œæ´‹è‘±â€ä¸€æ ·éš¾ä»¥é˜…è¯»ã€‚CTE å…è®¸ä½ å°†é€»è¾‘æ‰å¹³åŒ–ï¼ŒæŒ‰é¡ºåºå®šä¹‰æ•°æ®å¤„ç†æ­¥éª¤ï¼š

    SELECT * FROM (
        SELECT * FROM (
            SELECT UserID, SUM(Amount) as Total FROM Orders GROUP BY UserID
        ) AS UserTotals WHERE Total > 1000
    ) AS HighValueUsers
    JOIN Users ON HighValueUsers.UserID = Users.ID;
    

è¿™ç§å†™æ³•éœ€è¦ä»æœ€é‡Œé¢å¾€å¤–è¯»ï¼Œé€»è¾‘ä¸ä»…è´¹åŠ²ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚  
å¦‚æœç”¨CTEï¼š

    WITH UserTotals AS (
        -- ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ¯ä¸ªç”¨æˆ·çš„æ€»é‡‘é¢
        SELECT UserID, SUM(Amount) as Total 
        FROM Orders 
        GROUP BY UserID
    ),
    HighValueUsers AS (
        -- ç¬¬äºŒæ­¥ï¼šç­›é€‰é«˜ä»·å€¼ç”¨æˆ·
        SELECT * 
        FROM UserTotals 
        WHERE Total > 1000
    )
    -- ç¬¬ä¸‰æ­¥ï¼šæœ€ç»ˆæŸ¥è¯¢
    SELECT * 
    FROM HighValueUsers
    JOIN Users ON HighValueUsers.UserID = Users.ID;
    

### 2\. å®ç°é€’å½’æŸ¥è¯¢ (Recursive CTE)

è¿™æ˜¯ CTE çš„**æ€æ‰‹çº§**åŠŸèƒ½ã€‚æ™®é€šçš„å­æŸ¥è¯¢æ— æ³•å¼•ç”¨è‡ªèº«ï¼Œè€Œ CTE å¯ä»¥ã€‚è¿™åœ¨å¤„ç†å±‚çº§æ•°æ®ï¼ˆHierarchical Dataï¼‰æ—¶éå¸¸æœ‰ç”¨ï¼Œä¾‹å¦‚ï¼š  
å…¬å¸ç»„ç»‡æ¶æ„ï¼ˆæŸ¥æ‰¾æŸäººçš„æ‰€æœ‰ä¸‹å±ï¼Œæˆ–è€…æŸ¥æ‰¾æŸäººçš„æ‰€æœ‰ä¸Šçº§ï¼‰ã€‚  
èœå•/åˆ†ç±»æ ‘ï¼ˆæ— é™çº§åˆ†ç±»ï¼‰ã€‚  
å›¾ç»“æ„æ•°æ®ï¼ˆè·¯å¾„æŸ¥æ‰¾ï¼‰ã€‚

    -- ç”Ÿæˆ 1 åˆ° 10 çš„åºåˆ—
    WITH RECURSIVE NumberSequence AS (
        -- åˆå§‹æˆå‘˜ (Anchor Member)
        SELECT 1 AS n
        UNION ALL
        -- é€’å½’æˆå‘˜ (Recursive Member)
        SELECT n + 1 
        FROM NumberSequence 
        WHERE n < 10
    )
    SELECT * FROM NumberSequence;
    

æ™šç‚¹æˆ‘ä»¬å†çœ‹æ›´å®é™…çš„ä¾‹å­ã€‚

### 3\. åœ¨åŒä¸€æŸ¥è¯¢ä¸­å¤šæ¬¡å¤ç”¨

å¦‚æœä½ åœ¨ä¸€ä¸ªå¤æ‚çš„æŸ¥è¯¢ä¸­éœ€è¦å¤šæ¬¡ç”¨åˆ°åŒä¸€ä¸ªä¸­é—´ç»“æœé›†ï¼š

*   ä½¿ç”¨å­æŸ¥è¯¢ï¼š ä½ å¿…é¡»æŠŠé‚£æ®µ SQL ä»£ç å¤åˆ¶ç²˜è´´ä¸¤éï¼ˆæˆ–è€…æ•°æ®åº“å¼•æ“éœ€è¦è®¡ç®—ä¸¤éï¼‰ã€‚
*   ä½¿ç”¨ CTEï¼š ä½ åªéœ€è¦å®šä¹‰ä¸€æ¬¡ï¼Œç„¶ååœ¨åé¢çš„ä¸»æŸ¥è¯¢ä¸­å¯ä»¥å¤šæ¬¡å¼•ç”¨å®ƒï¼ˆä¾‹å¦‚ JOIN å®ƒè‡ªå·±ï¼‰ã€‚

    WITH MonthlySales AS (
        SELECT Month, SUM(Sales) as TotalSales 
        FROM Orders 
        GROUP BY Month
    )
    SELECT 
        CurrentMonth.Month, 
        CurrentMonth.TotalSales, 
        CurrentMonth.TotalSales - LastMonth.TotalSales AS Growth
    FROM MonthlySales AS CurrentMonth
    LEFT JOIN MonthlySales AS LastMonth 
        ON CurrentMonth.Month = LastMonth.Month + 1;
    

### 4\. é…åˆçª—å£å‡½æ•°è¿›è¡Œæ•°æ®æ¸…æ´—

å¸¸ç”¨äºå»é‡æˆ–åˆ†é¡µåœºæ™¯ã€‚ä¾‹å¦‚ï¼Œåˆ é™¤è¡¨ä¸­çš„é‡å¤è®°å½•ï¼ˆä¿ç•™ ID æœ€å¤§çš„é‚£æ¡ï¼‰ï¼š

    WITH DuplicateRows AS (
        SELECT *, 
               ROW_NUMBER() OVER (PARTITION BY Email ORDER BY ID DESC) as rn
        FROM Users
    )
    DELETE FROM DuplicateRows WHERE rn > 1;
    

è™½ç„¶è¿™çœ‹èµ·æ¥åƒæ˜¯ä» CTE åˆ é™¤ï¼Œä½†å®é™…ä¸Šæ˜¯åˆ é™¤äº†åº•å±‚è¡¨ Users å¯¹åº”çš„æ•°æ®ã€‚

> å–å†³äºæ•°æ®åº“æ”¯æŒæƒ…å†µï¼ŒSQL Server å’Œ PostgreSQL æ”¯æŒè¾ƒå¥½

æ€§èƒ½
==

çœ‹äº†ä¸Šé¢è¯´çš„ä¼˜ç‚¹ï¼Œä½ å¯èƒ½ä¼šä»¥ä¸ºCTEæ€»æ˜¯ä¸€æ¬¡è®¡ç®—ï¼Œå¤šæ¬¡å¤ç”¨ã€‚ä½†æ˜¯å®é™…æ•ˆæœå¯èƒ½è®©ä½ å¤±æœ›ã€‚  
CTEæ›´åƒæ˜¯è¯­æ³•ç³–ï¼Œè€Œéæ€§èƒ½ä¼˜åŒ–å™¨ã€‚å’Œæ™®é€šSQLä¸€æ ·ï¼Œä½¿ç”¨ä¸å½“ä¹Ÿä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ã€‚

### å¯¹äºéé€’å½’ CTE (Non-Recursive CTEs)ï¼š

å®ƒä»¬é€šå¸¸ä¸ä½¿ç”¨å­æŸ¥è¯¢æˆ–æ´¾ç”Ÿè¡¨åœ¨æ€§èƒ½ä¸Šç›¸åŒã€‚è™½ç„¶æœ‰ä¼˜ç‚¹ï¼Œä½†æ˜¯ä¸æ˜¯æ€§èƒ½ä¸Šçš„ï¼š

*   å¯è¯»æ€§ï¼š å¤æ‚çš„é€»è¾‘å¯ä»¥åˆ†è§£æˆå¤šä¸ªå‘½åæ­¥éª¤ï¼Œä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ã€‚
    
*   æ¨¡å—åŒ–ï¼š åŒä¸€ä¸ª CTE å¯ä»¥åœ¨ä¸»æŸ¥è¯¢ä¸­å¤šæ¬¡å¼•ç”¨ï¼ˆå°½ç®¡å®ƒé€šå¸¸åªæ‰§è¡Œä¸€æ¬¡ï¼Œé™¤éä¼˜åŒ–å™¨é€‰æ‹©é‡æ–°è®¡ç®—ï¼‰ã€‚
    

### å¯¹äºé€’å½’ CTE (Recursive CTEs)ï¼š

é€’å½’ CTE æ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†åœ¨æ€§èƒ½ä¸Šéœ€è¦æ³¨æ„ã€‚ä¸å½“çš„é€’å½’æ¡ä»¶æˆ–å¤§é‡æ•°æ®å¯èƒ½å¯¼è‡´æŸ¥è¯¢æ—¶é—´è¿‡é•¿ï¼Œç”šè‡³è€—å°½èµ„æºã€‚å®ƒä»¬é€šå¸¸æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„å”¯ä¸€ SQL æ–¹å¼ï¼Œé™¤éä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ä¸­çš„å¾ªç¯ã€‚

### æœ€å¤§çš„è¯¯è§£ï¼šè‡ªåŠ¨ç‰©åŒ–

å¾ˆå¤šäººè®¤ä¸º CTE ä¼šåƒä¸´æ—¶è¡¨ä¸€æ ·å°†ç»“æœé›†å­˜å‚¨èµ·æ¥ï¼Œå¹¶åœ¨åç»­å¤šæ¬¡å¼•ç”¨æ—¶ç›´æ¥ä½¿ç”¨è¿™ä¸ªå­˜å‚¨çš„ç»“æœã€‚  
è¿™ç§æ–¹å¼æœ‰ä¸ªä¸“ä¸šåè¯å«â€œ**ç‰©åŒ–**â€ï¼ˆmaterializationï¼‰ï¼ŒæŒ‡æ•°æ®åº“å…ˆè¿è¡Œ CTEã€å°†ç»“æœå­˜åˆ°ä¸´æ—¶å­˜å‚¨ï¼ˆå†…å­˜æˆ–ç£ç›˜ï¼‰ï¼Œç„¶åé‡ç”¨ã€‚  
ç›¸åï¼Œä¼šæ‰§è¡Œå¤šæ¬¡çš„æ–¹å¼åœ¨CTE åœºæ™¯ä¸­å«åšâ€œå†…è”â€ï¼ˆinlineï¼‰ï¼›

äº‹å®æ˜¯åœ¨å¤§å¤šæ•°ä¸»æµæ•°æ®åº“ä¸­ï¼Œ**éé€’å½’ CTE** é€šå¸¸ä¸ä¼šè‡ªåŠ¨å®ç°ã€‚ä¼˜åŒ–å™¨ä¼šå°† CTE çš„å®šä¹‰åˆå¹¶åˆ°ä¸»æŸ¥è¯¢ä¸­ã€‚è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ª CTE è¢«å¼•ç”¨äº†å¤šæ¬¡ï¼Œä¼˜åŒ–å™¨å¯èƒ½ä¼šé€‰æ‹©ï¼š

*   é‡æ–°è®¡ç®—ï¼š  
    å¦‚æœ CTE è¢«å¼•ç”¨å¤šæ¬¡ï¼Œæ•°æ®åº“å¯èƒ½å¤šæ¬¡æ‰§è¡Œå…¶å†…éƒ¨é€»è¾‘ï¼Œå¯¼è‡´æ€§èƒ½æµªè´¹ï¼ˆå°¤å…¶å¤§æ•°æ®é‡æ—¶ï¼‰ã€‚è¿™åœ¨ SQL Server å’Œæ—©æœŸ MySQL ä¸­ç‰¹åˆ«æ˜æ˜¾ã€‚å‚è€ƒå³å°†æ­»äº¡çš„stackoverflow: [https://stackoverflow.com/questions/62312318/cte-executed-multiple-times](https://stackoverflow.com/questions/62312318/cte-executed-multiple-times)
    
*   è®¡ç®—ä¸€æ¬¡å¹¶é‡ç”¨ï¼š  
    ç°ä»£ä¼˜åŒ–å™¨ï¼ˆå¦‚ PostgreSQL 12+ æˆ– Oracleï¼‰æœ‰æ—¶ä¼šè‡ªåŠ¨ç‰©åŒ–ä»¥é¿å…é‡å¤è®¡ç®—ï¼Œä½†è¿™ä¾èµ–æŸ¥è¯¢ç»Ÿè®¡ã€æ•°æ®åˆ†å¸ƒå’Œé…ç½®ï¼Œä¸æ˜¯ 100% å¯é ã€‚MySQL å’Œ SQL Server æ›´ä¿å®ˆï¼Œä¸ä¼šé»˜è®¤ç¼“å­˜ã€‚
    

> PostgreSQL (12+) å¯ä»¥ç”¨ `WITH ... AS MATERIALIZED` å¼ºåˆ¶ç‰©åŒ–ï¼›`NOT MATERIALIZED` å¼ºåˆ¶å†…è”ã€‚  
> Oracle (19c+)ç”¨ `/*+ MATERIALIZE */` æˆ– `/*+ INLINE */` è¿›è¡Œæç¤ºã€‚

è™½ç„¶ CTE æé«˜äº†å¯è¯»æ€§ï¼Œä½†å®ƒåªæ˜¯å°†é€»è¾‘å‰ç§»äº†ã€‚å¦‚æœ CTE å†…éƒ¨åŒ…å«äº†éå¸¸è€—æ—¶çš„æ“ä½œï¼ˆå¦‚å…¨è¡¨æ‰«æã€å¤æ‚çš„è¿æ¥ã€å¤§é‡è®¡ç®—ï¼‰ï¼Œé‚£ä¹ˆä¸»æŸ¥è¯¢çš„æ€§èƒ½ä¾ç„¶ä¼šå¾ˆå·®ã€‚  
è¦ç¡®ä¿ CTE çš„å®šä¹‰å°½å¯èƒ½é«˜æ•ˆåœ°è¿”å›æ‰€éœ€çš„æ•°æ®ã€‚å¦‚æœå¯èƒ½ï¼Œé€šè¿‡ WHERE å­å¥æˆ– JOIN æ¡ä»¶å°½æ—©è¿‡æ»¤æ•°æ®ã€‚

#### æ‰€ä»¥ï¼ŒæŸ¥ EXPLAIN éªŒè¯æ‰§è¡Œè®¡åˆ’ â€”â€” è¿™æ˜¯ CTE æ€§èƒ½çš„å”¯ä¸€çœŸç›¸ã€‚

é€’å½’CTEä¾‹å­
=======

ä¸‹é¢æˆ‘ä»¬è·‘ä¸€éåœ¨ PostgreSQL é‡Œæ‰§è¡Œçš„ç¤ºä¾‹ï¼š  
åŒ…æ‹¬ï¼š

*   åˆ›å»ºå±‚çº§è¡¨ï¼ˆæ ‘ç»“æ„ï¼‰
*   æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆæ¨¡æ‹Ÿç±»ç›®æ ‘ / éƒ¨é—¨æ ‘ï¼‰
*   ä½¿ç”¨ é€’å½’ CTE æŸ¥è¯¢æ‰€æœ‰å­èŠ‚ç‚¹ã€æ‰€æœ‰çˆ¶èŠ‚ç‚¹

åˆ›å»ºå±‚çº§è¡¨
-----

    CREATE TABLE category (
        id          SERIAL PRIMARY KEY,
        name        TEXT NOT NULL,
        parent_id   INT REFERENCES category(id)
    );
    

æ’å…¥å±‚çº§æ•°æ®ï¼ˆæ¨¡æ‹Ÿ 3 å±‚æ ‘ï¼‰
---------------

    INSERT INTO category (id, name, parent_id) VALUES
        (1, 'ç”µå­äº§å“', NULL),
        (2, 'æ‰‹æœº', 1),
        (3, 'å®‰å“æ‰‹æœº', 2),
        (4, 'è‹¹æœæ‰‹æœº', 2),
        (5, 'ç”µè„‘', 1),
        (6, 'ç¬”è®°æœ¬ç”µè„‘', 5),
        (7, 'å°å¼æœº', 5);
    

ä½¿ç”¨CTE
-----

å’±ä»¬çœ‹çœ‹æ’å…¥çš„æ•°æ®æ˜¯å•¥æ ·çš„ï¼ˆå¸¦ç¼©è¿›ï¼‰

    WITH RECURSIVE tree AS (
        SELECT id, name, parent_id, 1 AS level, name AS path
        FROM category
        WHERE parent_id IS NULL
    
        UNION ALL
    
        SELECT c.id, c.name, c.parent_id,
               t.level + 1 AS level,
               t.path || ' > ' || c.name
        FROM category c
        JOIN tree t ON c.parent_id = t.id
    )
    SELECT id,
           repeat('  ', level - 1) || name AS display_name,
           path
    FROM tree
    ORDER BY path;
    

![image](https://img2024.cnblogs.com/blog/2157887/202512/2157887-20251205110032100-1045138322.png)

æŸ¥è¯¢ æ‰‹æœº(id=2) ä¸‹çš„æ‰€æœ‰å­ç±»ç›®ï¼šå®‰å“ã€è‹¹æœ

    WITH RECURSIVE sub_tree AS (
        -- èµ·ç‚¹
        SELECT id, name, parent_id
        FROM category
        WHERE id = 2
        
        UNION ALL
    
        -- å‘ä¸‹é€’å½’
        SELECT c.id, c.name, c.parent_id
        FROM category c
        JOIN sub_tree st ON c.parent_id = st.id
    )
    SELECT * FROM sub_tree;
    

æŸ¥è¯¢ ç¬”è®°æœ¬ç”µè„‘(id=6) çš„æ‰€æœ‰ä¸Šçº§ï¼š

    WITH RECURSIVE parents AS (
        -- èµ·ç‚¹
        SELECT id, name, parent_id
        FROM category
        WHERE id = 6
        
        UNION ALL
        
        -- å‘ä¸Šé€’å½’åˆ°æ ¹èŠ‚ç‚¹
        SELECT c.id, c.name, c.parent_id
        FROM category c
        JOIN parents p ON c.id = p.parent_id
    )
    SELECT * FROM parents;
    

æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶é™„å¸¦å±‚çº§æ·±åº¦ï¼ˆlevelï¼‰

    WITH RECURSIVE tree AS (
        SELECT id, name, parent_id, 1 AS level
        FROM category
        WHERE parent_id IS NULL  -- ä»æ ¹èŠ‚ç‚¹å¼€å§‹
        
        UNION ALL
        
        SELECT c.id, c.name, c.parent_id, t.level + 1
        FROM category c
        JOIN tree t ON c.parent_id = t.id
    )
    SELECT *
    FROM tree
    ORDER BY level, id;
    

![image](https://img2024.cnblogs.com/blog/2157887/202512/2157887-20251205110354084-1172161435.png)