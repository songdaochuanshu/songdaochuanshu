---
layout: post
title: 'åŸºäºdockerçš„AI-Codereview-Gitlabéƒ¨ç½²å®æˆ˜'
date: "2025-05-07T00:41:09Z"
---
åŸºäºdockerçš„AI-Codereview-Gitlabéƒ¨ç½²å®æˆ˜
=================================

**AI-Codereview-Gitlabæ˜¯ä¸€ä¸ªåŸºäºå¤§æ¨¡å‹çš„è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å·¥å…·ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿåœ¨ä»£ç åˆå¹¶æˆ–æäº¤æ—¶ï¼Œå¿«é€Ÿè¿›è¡Œæ™ºèƒ½åŒ–çš„å®¡æŸ¥(Code Review)ï¼Œæå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚**

ä¸»è¦åŠŸèƒ½
====

*   ğŸš€ å¤šæ¨¡å‹æ”¯æŒ
    *   å…¼å®¹ DeepSeekã€ZhipuAIã€OpenAIã€é€šä¹‰åƒé—® å’Œ Ollamaï¼Œæƒ³ç”¨å“ªä¸ªå°±ç”¨å“ªä¸ªã€‚
*   ğŸ“¢ æ¶ˆæ¯å³æ—¶æ¨é€
    *   å®¡æŸ¥ç»“æœä¸€é”®ç›´è¾¾ é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ æˆ– é£ä¹¦ï¼Œä»£ç é—®é¢˜æ— å¤„å¯è—ï¼
*   ğŸ“… è‡ªåŠ¨åŒ–æ—¥æŠ¥ç”Ÿæˆ
    *   åŸºäº GitLab & GitHub Commit è®°å½•ï¼Œè‡ªåŠ¨æ•´ç†æ¯æ—¥å¼€å‘è¿›å±•ï¼Œè°åœ¨æ‘¸é±¼ã€è°åœ¨å·ï¼Œä¸€ç›®äº†ç„¶ ğŸ˜¼ã€‚
*   ğŸ“Š å¯è§†åŒ– Dashboard
    *   é›†ä¸­å±•ç¤ºæ‰€æœ‰ Code Review è®°å½•ï¼Œé¡¹ç›®ç»Ÿè®¡ã€å¼€å‘è€…ç»Ÿè®¡ï¼Œæ•°æ®è¯´è¯ï¼Œç”©é”…æ— é—¨ï¼
*   ğŸ­ Review Style ä»»ä½ é€‰
    *   ä¸“ä¸šå‹ ğŸ¤µï¼šä¸¥è°¨ç»†è‡´ï¼Œæ­£å¼ä¸“ä¸šã€‚
    *   è®½åˆºå‹ ğŸ˜ˆï¼šæ¯’èˆŒåæ§½ï¼Œä¸“æ²»ä¸æœï¼ˆ"è¿™ä»£ç æ˜¯ç”¨è„šå†™çš„å—ï¼Ÿ"ï¼‰
    *   ç»…å£«å‹ ğŸŒ¸ï¼šæ¸©æŸ”å»ºè®®ï¼Œå¦‚æ²æ˜¥é£ï¼ˆ"æˆ–è®¸è¿™é‡Œå¯ä»¥å†ä¼˜åŒ–ä¸€ä¸‹å‘¢~"ï¼‰
    *   å¹½é»˜å‹ ğŸ¤ªï¼šæç¬‘ç‚¹è¯„ï¼Œå¿«ä¹æ”¹ç ï¼ˆ"è¿™æ®µ if-else æ¯”æˆ‘çš„ç›¸äº²ç»å†è¿˜æ›²æŠ˜ï¼"ï¼‰

å·¥ä½œåŸç†
====

å½“ç”¨æˆ·åœ¨ GitLab ä¸Šæäº¤ä»£ç ï¼ˆå¦‚ Merge Request æˆ– Push æ“ä½œï¼‰æ—¶ï¼ŒGitLab å°†è‡ªåŠ¨è§¦å‘ webhookäº‹ä»¶ï¼Œè°ƒç”¨æœ¬ç³»ç»Ÿçš„æ¥å£ã€‚ç³»ç»Ÿéšåé€šè¿‡ç¬¬ä¸‰æ–¹å¤§æ¨¡å‹å¯¹ä»£ç è¿›è¡Œå®¡æŸ¥ï¼Œå¹¶å°†å®¡æŸ¥ç»“æœç›´æ¥åé¦ˆåˆ°å¯¹åº”çš„ Merge Request æˆ– Commit çš„Note ä¸­ï¼Œä¾¿äºå›¢é˜ŸæŸ¥çœ‹å’Œå¤„ç†ã€‚

![](https://img2024.cnblogs.com/blog/954348/202505/954348-20250506170754179-1500883582.png)

ä»¥ä¸Šå‡ä¸ºå®˜æ–¹æè¿°ï¼Œä¸‹é¢è¿›è¡Œå®æˆ˜éƒ¨ç½²æ“ä½œã€‚

éƒ¨ç½²å®æˆ˜
====

å®˜æ–¹ç»™äº†ä¸¤ç§éƒ¨ç½²æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯Dockeréƒ¨ç½²å’Œæœ¬åœ°Pythonç¯å¢ƒéƒ¨ç½²ï¼Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ç¬¬ä¸€ç§ï¼Œå¹¶ä¸”æ ¹æ®å®æˆ˜æ“ä½œå¯¹éƒ¨åˆ†å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ã€‚

1\. å‰æœŸç¯å¢ƒå‡†å¤‡
----------

> æ“ä½œç³»ç»Ÿï¼šcentos7
> 
> Dockerç‰ˆæœ¬ï¼š24.0.0
> 
> Docker-Composeç‰ˆæœ¬ï¼šv2.28.0
> 
> gitç‰ˆæœ¬ï¼š1.8.3.1

*   Dockerå›½å†…é•œåƒæºè®¾ç½®ï¼š
    
        vim /etc/docker/daemon.json
        
    
    å°†daemon.jsonæ”¹ä¸ºå¦‚ä¸‹å†…å®¹ï¼š
    
        { 
             "registry-mirrors": ["https://registry.docker-cn.com","https://pee6w651.mirror.aliyuncs.com"],
             "live-restore": true
        }
        
    
    ä¿å­˜æˆåŠŸåï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œé‡æ–°åŠ è½½ï¼š
    
        systemctl daemon-reload
        systemctl restart docker
        
    

2.è·å–æºç 
------

å®æˆ˜å‘½ä»¤(ç”±äºè®¿é—®GitHubç»å¸¸è¶…æ—¶æˆ–è€…æ—¶é—´è¾ƒé•¿)ï¼š

    cd /opt
    git clone https://gitcode.com/gh_mirrors/ai/AI-Codereview-Gitlab.git
    cd AI-Codereview-Gitlab
    

å®˜æ–¹å‘½ä»¤ï¼š

    cd /opt
    git clone https://github.com/sunmh207/AI-Codereview-Gitlab.git
    cd AI-Codereview-Gitlab
    

3\. é…ç½®æ–‡ä»¶
--------

è·å–æºç åï¼Œåœ¨AI-Codereview-Gitlabç›®å½•ä¸‹ï¼Œåˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š

    cp conf/.env.dist conf/.env
    vim conf/.env
    

ç¼–è¾‘ conf/.env æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å…³é”®å‚æ•°ï¼š

*   å¤§æ¨¡å‹ä¾›åº”å•†é…ç½®å‚æ•°ï¼Œæ­¤å¤„é‡‡ç”¨æœ¬åœ°ollamaéƒ¨ç½²çš„Deepseek:32Bçš„å¤§æ¨¡å‹ï¼Œå› æ­¤ä¿®æ”¹å¦‚ä¸‹å‚æ•°éƒ¨åˆ†ï¼š
    
        #å¤§æ¨¡å‹ä¾›åº”å•†é…ç½®,æ”¯æŒ deepseek, openai,zhipuai,qwen å’Œ ollama
        LLM_PROVIDER=ollama
        ...
        #OllaMA settings; æ³¨æ„: å¦‚æœä½¿ç”¨ Docker éƒ¨ç½²ï¼Œ127.0.0.1 æŒ‡å‘çš„æ˜¯å®¹å™¨å†…éƒ¨çš„åœ°å€ã€‚è¯·å°†å…¶æ›¿æ¢ä¸ºå®é™…çš„ OllamaæœåŠ¡å™¨IPåœ°å€ã€‚
        OLLAMA_API_BASE_URL=http://127.0.0.1:11434
        OLLAMA_API_MODEL=deepseek-r1:32b
        ...
        
    
*   Gitlabé…ç½®ï¼Œç”±äºæœ¬åœ°GitLabç«¯å£ä¸æ˜¯é»˜è®¤80ï¼Œå› æ­¤ä¿®æ”¹å¦‚ä¸‹å‚æ•°éƒ¨åˆ†ï¼š
    
        #Gitlabé…ç½®
        GITLAB_URL=http://192.168.1.111:9080/ #éƒ¨åˆ†è€ç‰ˆæœ¬Gitlab webhookä¸ä¼ é€’URLï¼Œéœ€è¦å¼€å¯æ­¤é…ç½®ï¼Œç¤ºä¾‹ï¼šhttps://gitlab.example.com
        #GITLAB_ACCESS_TOKEN={YOUR_GITLAB_ACCESS_TOKEN} #ç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨æ­¤GITLAB_ACCESS_TOKENï¼Œå¦‚æœæœªé…ç½®ï¼Œåˆ™ä½¿ç”¨Webhook ä¼ é€’çš„Secret Token
        
    
    åŒæ—¶è¿˜éœ€è¦ä¿®æ”¹api.pyæ–‡ä»¶å†…å®¹ï¼Œä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š
    
        å°†
        def handle_github_webhook(event_type, data):
            # è·å–GitHubé…ç½®
            github_token = os.getenv('GITHUB_ACCESS_TOKEN') or request.headers.get('X-GitHub-Token')
        ...
        æ”¹ä¸ºï¼š
        def handle_github_webhook(event_type, data):
            # è·å–GitHubé…ç½®
            github_token = os.getenv('GITHUB_ACCESS_TOKEN')
        ...
        
    
*   æ¨é€é…ç½®ï¼Œç”±äºæœ¬æ¬¡æ²¡æœ‰è®¾ç½®ä¼å¾®æˆ–é’‰é’‰æ¨é€ï¼Œå› æ­¤æœªè¿›è¡Œç›¸å…³é…ç½®ï¼Œæœ‰éœ€æ±‚æ ¹æ®envä¸­çš„æç¤ºè¿›è¡Œé…ç½®ã€‚
    

4\. é•œåƒä¿®æ”¹
--------

å®˜æ–¹é…ç½®çš„é•œåƒæºéƒ¨åˆ†ä½äºå¢ƒå¤–ï¼Œå¯¼è‡´éƒ¨ç½²è¿‡ç¨‹ä¸­ä¸‹è½½è¾ƒæ…¢æˆ–è€…ç½‘ç»œå¼‚å¸¸ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹docker-compose.ymlå’ŒDockerfileä¸­çš„éƒ¨åˆ†å‚æ•°ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

*   ä¿®æ”¹docker-compose.ymlä¸­çš„imageå‚æ•°ï¼š
    
*   ä¿®æ”¹Dockerfileä¸­Python åŸºç¡€é•œåƒå’Œä¾èµ–æºå‚æ•°ï¼š
    
        # ä½¿ç”¨å®˜æ–¹çš„ Python åŸºç¡€é•œåƒæ”¹ä¸ºswr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/python:3.10-slimå›½å†…
        FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/python:3.10-slim AS base
        ...
        # å®‰è£…ä¾èµ–åŠ ä¸Šå›½å†…æº
        RUN pip install --no-cache-dir -r requirements.txt -i https://pypi.mirrors.ustc.edu.cn/simple/
        
    
    ä¿®æ”¹å®Œæˆåè¿›è¡Œä¿å­˜ã€‚
    

5\. å¯åŠ¨æœåŠ¡
--------

    docker-compose up -d
    

6\. éªŒè¯éƒ¨ç½²
--------

*   ä¸»æœåŠ¡éªŒè¯ï¼š
    *   è®¿é—® [http://your-server-ip:5001](http://your-server-ip:5001)
    *   æ˜¾ç¤º "The code review server is running." è¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸã€‚
*   Dashboard éªŒè¯ï¼š
    *   è®¿é—® [http://your-server-ip:5002](http://your-server-ip:5002)
    *   çœ‹åˆ°ä¸€ä¸ªå®¡æŸ¥æ—¥å¿—é¡µé¢ï¼Œè¯´æ˜ Dashboard å¯åŠ¨æˆåŠŸã€‚

7\. é…ç½® GitLab Webhook
---------------------

### åˆ›å»ºAccess Token

æ–¹æ³•ä¸€ï¼šåœ¨ GitLab ä¸ªäººè®¾ç½®ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª Personal Access Tokenã€‚

æ–¹æ³•äºŒï¼šåœ¨ GitLab é¡¹ç›®è®¾ç½®ä¸­ï¼Œåˆ›å»ºProject Access Tokenã€‚

æ³¨ï¼šåˆ›å»ºçš„Access Tokenéœ€è¦å¤åˆ¶åå•ç‹¬ä¿å­˜ï¼Œå¦åˆ™æ— æ³•å†æ¬¡è·å–ã€‚

### é…ç½® Webhook

åœ¨ GitLab é¡¹ç›®è®¾ç½®ä¸­ï¼Œé…ç½® Webhookï¼š

*   URLï¼š[http://your-server-ip:5001/review/webhook](http://your-server-ip:5001/review/webhook)
*   Trigger Eventsï¼šå‹¾é€‰ Push Events å’Œ Merge Request Events (ä¸è¦å‹¾é€‰å…¶å®ƒEvent)
*   Secret Tokenï¼šä¸Šé¢é…ç½®çš„ Access Token(å¯é€‰)

### **å¤‡æ³¨**

1.  Tokenä½¿ç”¨ä¼˜å…ˆçº§  
    \- ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ .env æ–‡ä»¶ä¸­çš„ GITLAB\_ACCESS\_TOKENã€‚  
    \- å¦‚æœ .env æ–‡ä»¶ä¸­æ²¡æœ‰é…ç½® GITLAB\_ACCESS\_TOKENï¼Œåˆ™ä½¿ç”¨ Webhook ä¼ é€’çš„Secret Tokenã€‚
2.  ç½‘ç»œè®¿é—®è¦æ±‚  
    \- è¯·ç¡®ä¿ GitLab èƒ½å¤Ÿè®¿é—®æœ¬ç³»ç»Ÿã€‚  
    \- è‹¥å†…ç½‘ç¯å¢ƒå—é™ï¼Œå»ºè®®å°†ç³»ç»Ÿéƒ¨ç½²åœ¨å¤–ç½‘æœåŠ¡å™¨ä¸Šã€‚

8\. é…ç½®æ¶ˆæ¯æ¨é€
----------

é…ç½®é’‰é’‰æ¨é€

*   åœ¨é’‰é’‰ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰æœºå™¨äººï¼Œè·å– Webhook URLã€‚
    
*   æ›´æ–° .env ä¸­çš„é…ç½®ï¼š
    
        #é’‰é’‰é…ç½®
        DINGTALK_ENABLED=1  #0ä¸å‘é€é’‰é’‰æ¶ˆæ¯ï¼Œ1å‘é€é’‰é’‰æ¶ˆæ¯
        DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=xxx #æ›¿æ¢ä¸ºä½ çš„Webhook URL
        
    

ä¼ä¸šå¾®ä¿¡å’Œé£ä¹¦æ¨é€é…ç½®ç±»ä¼¼ã€‚

æœ€ç»ˆæ•ˆæœ
====

![](https://img2024.cnblogs.com/blog/954348/202505/954348-20250506170419073-1656590464.png)

åŸåˆ›å¸–ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„åŠä½œè€…ï¼Œæ ‡æ³¨ä¸¥ç¦è½¬è½½å¸–è¯·å‹¿è½¬è½½ï¼Œè°¢è°¢ï¼