---
layout: post
title: 'ã€æ¸²æŸ“æµæ°´çº¿ã€‘[é€ç‰‡å…ƒé˜¶æ®µ]-[æ·±åº¦æµ‹è¯•]ä»¥UnityURPä¸ºä¾‹'
date: "2025-08-25T00:42:49Z"
---
ã€æ¸²æŸ“æµæ°´çº¿ã€‘\[é€ç‰‡å…ƒé˜¶æ®µ\]-\[æ·±åº¦æµ‹è¯•\]ä»¥UnityURPä¸ºä¾‹
====================================

![ã€æ¸²æŸ“æµæ°´çº¿ã€‘[é€ç‰‡å…ƒé˜¶æ®µ]-[æ·±åº¦æµ‹è¯•]ä»¥UnityURPä¸ºä¾‹](https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250824205418856-2035852705.png) æœ¬æ–‡æ·±å…¥è§£æUnity URPç®¡çº¿ä¸­çš„æ·±åº¦æµ‹è¯•æœºåˆ¶ï¼Œé‡ç‚¹ä»‹ç»å…¶æŠ€æœ¯æ¼”è¿›å†ç¨‹å’Œç°ä»£URPä½“ç³»ä¸‹çš„æ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆã€‚æ–‡ç« è¯¦ç»†å¯¹æ¯”äº†ä¼ ç»Ÿæ·±åº¦æµ‹è¯•ã€URPåˆæœŸç‰ˆæœ¬å’Œç°ä»£URPä½“ç³»åœ¨æ·±åº¦å¤„ç†ä¸Šçš„å·®å¼‚ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„Shaderä»£ç ç¤ºä¾‹ï¼ˆåŒ…æ‹¬URP\_ZTestExample.shaderã€WaterDepth.shaderç­‰ï¼‰ï¼Œå±•ç¤ºå¦‚ä½•å®ç°æ°´ä½“äº¤äº’ã€æ™¯æ·±ç‰¹æ•ˆç­‰æ ¸å¿ƒåº”ç”¨åœºæ™¯ã€‚åŒæ—¶ï¼Œæ–‡ç« è¿˜ç»™å‡ºäº†æ·±åº¦æµ‹è¯•çš„ä¼˜åŒ–å»ºè®®ï¼ŒåŒ…æ‹¬æ ¼å¼é€‰æ‹©ã€æ¸²æŸ“ç­–ç•¥ã€é™æ€åˆæ‰¹ç­‰æ€§èƒ½ä¼˜åŒ–æŠ€å·§ï¼Œå¹¶å¼ºè°ƒé€šè¿‡FrameDebuggerç­‰å·¥å…·è¿›è¡ŒéªŒè¯è°ƒè¯•çš„é‡è¦æ€§ã€‚æœ€

*   æ·±åº¦æµ‹è¯•æ˜¯é€šè¿‡æ¯”è¾ƒå½“å‰ç‰‡å…ƒæ·±åº¦å€¼ä¸æ·±åº¦ç¼“å†²åŒºå€¼å†³å®šæ˜¯å¦ä¸¢å¼ƒè¯¥ç‰‡å…ƒã€‚URPè‡ª2018å¹´éšUnity 2019.1æ¨å‡ºåï¼Œé€æ­¥æ›¿ä»£äº†ä¼ ç»Ÿå†…ç½®ç®¡çº¿ï¼Œå…¶æ·±åº¦æµ‹è¯•æœºåˆ¶åœ¨ç§»åŠ¨ç«¯å’ŒPCå¹³å°å‡é‡‡ç”¨æ›´é«˜æ•ˆçš„GPUæŒ‡ä»¤ä¼˜åŒ–ã€‚

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

æŠ€æœ¯æ¼”è¿›å†ç¨‹
======

**ä¼ ç»Ÿæ·±åº¦æµ‹è¯•é˜¶æ®µ**ï¼ˆ2017å¹´å‰ï¼‰
--------------------

*   åŸºäºBuilt-in RPçš„æ·±åº¦ç¼“å†²æœºåˆ¶
*   ç¡¬ç¼–ç å®ç°Z-bufferç®—æ³•
*   ç¼ºä¹è·¨å¹³å°ç»Ÿä¸€ç®¡ç†

**URPåˆæœŸç‰ˆæœ¬**ï¼ˆ2017-2020ï¼‰
----------------------

*   å¼•å…¥å¯ç¼–ç¨‹æ¸²æŸ“ç®¡çº¿æ¶æ„
*   å®ç°è½»é‡çº§æ·±åº¦é¢„é€šé“(DepthPrepass)
*   æ”¯æŒ\_CameraDepthTextureè‡ªåŠ¨ç”Ÿæˆ

**ç°ä»£URPä½“ç³»**ï¼ˆ2021è‡³ä»Šï¼‰
-------------------

*   æ·±åº¦ä¸æ³•çº¿å›¾è”åˆæ¸²æŸ“(DepthNormalsPass)
*   å¤šå¹³å°æ·±åº¦æ ¼å¼ä¼˜åŒ–(k\_DepthStencilFormat)
*   æ¨¡æ¿æµ‹è¯•æ·±åº¦é›†æˆ(Stencil Opæšä¸¾)

æ·±åº¦æµ‹è¯•å‘½ä»¤ä½¿ç”¨æ ·ä¾‹
==========

â€Œ**ç°ä»£URPä¼˜åŒ–**â€Œ
-------------

*   ç»“åˆSRP Batcherå‡å°‘SetPass Callsï¼Œæ·±åº¦æµ‹è¯•ä¸æ¨¡æ¿æµ‹è¯•å¹¶è¡Œå¤„ç†æå‡æ€§èƒ½
*   é€šè¿‡Zå€¼æ¯”è¾ƒå®ç°ä¸‰ç»´ç©ºé—´é®æŒ¡å…³ç³»
*   å¯é…ç½®Less/Equal/Greaterç­‰æ¯”è¾ƒæ¨¡å¼â€Œ

**URP\_ZTestExample.shader**
----------------------------

*   é€šè¿‡Propertiesé¢æ¿å¯åŠ¨æ€é…ç½®8ç§ZTestæ¨¡å¼
*   æ”¯æŒæ·±åº¦å†™å…¥(ZWrite)å¼€å…³æ§åˆ¶
*   å®Œæ•´åŒ…å«URPæ ‡å‡†HLSLè¯­æ³•ç»“æ„
*   ä½¿ç”¨CBUFFERå®ç°æè´¨å‚æ•°åºåˆ—åŒ–
*   é»˜è®¤æ¸²æŸ“é˜Ÿåˆ—è®¾ç½®ä¸ºGeometry(2000)

å…³é”®å‚æ•°è¯´æ˜
------

*   `_ZTestMode`å¯¹åº”æ·±åº¦æµ‹è¯•æšä¸¾å€¼ï¼š
    *   1Â 2Â 3
    *   4(é»˜è®¤) 5
    *   6Â 7Â 8:Always
*   `_ZWrite`æ§åˆ¶æ·±åº¦ç¼“å†²å†™å…¥(0=Off,1=On)
*   åŒ…å«åŸºç¡€çº¹ç†é‡‡æ ·å’Œé¢œè‰²æ··åˆåŠŸèƒ½

URP\_ZTestExample.shader
------------------------

    Shader "Custom/URP_ZTestExample"
    {
        Properties
        {
            _MainTex("Base Texture", 2D) = "white" {}
            _Color("Tint Color", Color) = (1,1,1,1)
            [Enum(UnityEngine.Rendering.CompareFunction)]
            _ZTestMode("ZTest Mode", Int) = 4 // é»˜è®¤LEqual
            [Toggle]_ZWrite("ZWrite", Float) = 1
        }
    
        SubShader
        {
            Tags {
                "RenderType"="Opaque"
                "RenderPipeline"="UniversalRenderPipeline"
                "Queue"="Geometry"
            }
    
            Pass
            {
                // ShaderLabå‘½ä»¤é…ç½®
                ZTest [_ZTestMode]
                ZWrite [_ZWrite]
                Cull Back
                Blend Off
                
                HLSLPROGRAM
                #pragma vertex vert
                #pragma fragment frag
                
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
    
                CBUFFER_START(UnityPerMaterial)
                    float4 _Color;
                    int _ZTestMode;
                    float _ZWrite;
                CBUFFER_END
    
                TEXTURE2D(_MainTex);
                SAMPLER(sampler_MainTex);
    
                struct Attributes
                {
                    float4 positionOS : POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                struct Varyings
                {
                    float4 positionHCS : SV_POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                Varyings vert(Attributes IN)
                {
                    Varyings OUT;
                    OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                    OUT.uv = IN.uv;
                    return OUT;
                }
    
                half4 frag(Varyings IN) : SV_Target
                {
                    half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv) * _Color;
                    return col;
                }
                ENDHLSL
            }
        }
    }
    
    

å‘½ä»¤é€‰é¡¹
----

é€šè¿‡ShaderLabå‘½ä»¤`ZTest`å¯è®¾ç½®æ·±åº¦æµ‹è¯•æ¯”è¾ƒè§„åˆ™ï¼Œæ”¯æŒä»¥ä¸‹é€‰é¡¹ï¼š

*   `Less`ï¼šæ·±åº¦å°äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡ï¼ˆé»˜è®¤å€¼ï¼‰â€Œ
*   `Greater`ï¼šæ·±åº¦å¤§äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡
*   `LEqual`ï¼šæ·±åº¦å°äºç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡
*   `GEqual`ï¼šæ·±åº¦å¤§äºç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡
*   `Equal`ï¼šæ·±åº¦ç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡
*   `NotEqual`ï¼šæ·±åº¦ä¸ç­‰äºå½“å‰ç¼“å­˜åˆ™é€šè¿‡
*   `Always`ï¼šå§‹ç»ˆé€šè¿‡ï¼ˆç­‰åŒäºå…³é—­æ·±åº¦æµ‹è¯•ï¼‰â€Œ

URPæ·±åº¦æµ‹è¯•æ¸²æŸ“ç®¡çº¿æ·±åº¦ç›¸å…³å˜é‡
=================

**æ ¸å¿ƒæ·±åº¦çº¹ç†å˜é‡**
------------

### â€Œ\_CameraDepthTexture

*   åœºæ™¯æ·±åº¦çº¹ç†ï¼Œå­˜å‚¨éçº¿æ€§æ·±åº¦å€¼ï¼ˆ0-1èŒƒå›´ï¼‰
    
*   å¯ç”¨è¦æ±‚ï¼šURP Assetä¸­å‹¾é€‰ â€Œ**Depth Texture**â€Œ é€‰é¡¹
    
*   ç€è‰²å™¨å£°æ˜ï¼š
    
        hlsl
        #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"
        
    

### `_CameraOpaqueTexture`

*   ä¸é€æ˜é€šé“åçš„å±å¹•å›¾åƒï¼ˆå«æ·±åº¦ä¿¡æ¯ï¼‰
*   å¯ç”¨è¦æ±‚ï¼šURP Assetä¸­å‹¾é€‰ â€Œ**Opaque Texture**â€Œ é€‰é¡¹
*   å…¸å‹åº”ç”¨ï¼šé€æ˜ç‰©ä½“æŠ˜å°„/æ¯›ç»ç’ƒæ•ˆæœ

**è¾…åŠ©æ·±åº¦ç›¸å…³åŠŸèƒ½**
------------

### æ·±åº¦é‡å»ºå‡½æ•°ï¼ˆéœ€åŒ…å«Â `Core.hlsl`ï¼‰

    hlsl
    float linearDepth = LinearEyeDepth(depthSample, _ZBufferParams); // è½¬æ¢ä¸ºçº¿æ€§æ·±åº¦
    float normalizedDepth = Linear01Depth(depthSample, _ZBufferParams); // [0,1]å½’ä¸€åŒ–
    

### æ·±åº¦é™é‡‡æ ·æ§åˆ¶ï¼ˆURP Assetè®¾ç½®ï¼‰

*   `Opaque Downsampling`ï¼šè°ƒæ•´ä¸é€æ˜çº¹ç†åˆ†è¾¨ç‡ï¼ˆNone/2x/4xï¼‰

**æ³¨æ„äº‹é¡¹**
--------

*   é»˜è®¤ä¸ç”ŸæˆÂ `_CameraDepthNormalsTexture`ï¼Œéœ€é€šè¿‡ â€Œ**Renderer Feature**â€Œ æ‰‹åŠ¨å®ç°
*   ç§»åŠ¨å¹³å°éœ€è°¨æ…ä½¿ç”¨æ·±åº¦çº¹ç†ï¼Œå¯èƒ½å½±å“æ€§èƒ½
*   æ·±åº¦æµ‹è¯•æ¨¡å¼é€šè¿‡Â `ZTest`Â æŒ‡ä»¤åŠ¨æ€è°ƒæ•´ï¼ˆå¦‚Â `ZTest Greater`ï¼‰

æ ¸å¿ƒåº”ç”¨åœºæ™¯
======

**æ°´ä½“äº¤äº’æ•ˆæœ**
----------

### å®ç°åŸç†

*   é€šè¿‡æ·±åº¦å·®è®¡ç®—æ°´é¢æ·¹æ²¡åŒºåŸŸ

### å…³é”®æŠ€æœ¯

*   è§‚å¯Ÿç©ºé—´åæ ‡è½¬æ¢

### æ€§èƒ½ä¼˜åŒ–

*   åŠé€æ˜é˜Ÿåˆ—+æ·±åº¦å†™å…¥å…³é—­

### ä»£ç ä¸¾ä¾‹ WaterDepth.shader

*   å®ç°é€æ˜æ°´ä½“çš„æ·±åº¦æ•ˆæœï¼ŒåŒ…å«æ·±åº¦çº¹ç†é‡‡æ ·å’Œé€æ˜åº¦è®¡ç®—ã€‚
*   åŒ…å«æ·±åº¦çº¹ç†å£°æ˜å’Œé‡‡æ ·
*   æ”¯æŒUVå˜æ¢å’Œæè´¨å‚æ•°åºåˆ—åŒ–
*   ä¿æŒåŸShaderçš„é€æ˜æ··åˆæ•ˆæœ

    Shader "Custom/WaterDepth"
    {
        Properties
        {
            [MainTexture] _MainTex("Base (RGB)", 2D) = "white" {}
            _DepthFactor("Depth Factor", Range(0,1)) = 0.5
        }
    
        SubShader
        {
            Tags 
            {
                "Queue"="Transparent"
                "RenderType"="Transparent"
                "RenderPipeline"="UniversalRenderPipeline"
            }
    
            Pass
            {
                ZWrite Off
                Blend SrcAlpha OneMinusSrcAlpha
    
                HLSLPROGRAM
                #pragma vertex vert
                #pragma fragment frag
    
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"
    
                TEXTURE2D(_MainTex);
                SAMPLER(sampler_MainTex);
    
                CBUFFER_START(UnityPerMaterial)
                    float4 _MainTex_ST;
                    float _DepthFactor;
                CBUFFER_END
    
                struct Attributes
                {
                    float4 positionOS : POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                struct Varyings
                {
                    float4 positionHCS : SV_POSITION;
                    float4 screenPos : TEXCOORD0;
                    float2 uv : TEXCOORD1;
                };
    
                Varyings vert(Attributes IN)
                {
                    Varyings OUT;
                    OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                    OUT.screenPos = ComputeScreenPos(OUT.positionHCS);
                    OUT.uv = TRANSFORM_TEX(IN.uv, _MainTex);
                    return OUT;
                }
    
                half4 frag(Varyings IN) : SV_Target
                {
                    float2 screenUV = IN.screenPos.xy / IN.screenPos.w;
                    float depth = SampleSceneDepth(screenUV);
                    depth = LinearEyeDepth(depth, _ZBufferParams);
                    float sceneZ = depth - IN.screenPos.w;
                    float waterDepth = saturate(sceneZ * _DepthFactor);
    
                    half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
                    col.a = waterDepth;
                    return col;
                }
                ENDHLSL
            }
        }
    }
    

**é®æŒ¡å‰”é™¤ä¼˜åŒ–**
----------

### å®ç°åŸç†

*   Early-ZæŠ€æœ¯é¢„åˆ¤

### å…³é”®æŠ€æœ¯

*   DepthPrepassä¼˜å…ˆæœºåˆ¶

### æ€§èƒ½ä¼˜åŒ–

*   å®ä¾‹åŒ–æ‰¹å¤„ç†

### ä»£ç ä¸¾ä¾‹ **DepthOfField.shader**

*   å®ç°URPåå¤„ç†æ™¯æ·±æ•ˆæœ
*   åŒ…å«æ·±åº¦çº¹ç†é‡‡æ ·
*   æ”¯æŒç„¦ç‚¹è·ç¦»å’Œæ¨¡ç³Šå¼ºåº¦è°ƒèŠ‚
*   ä¿æŒåŸShaderçš„æ™¯æ·±è®¡ç®—é€»è¾‘
*   é‡‡ç”¨URPçš„æ·±åº¦é‡‡æ ·API

    Shader "Hidden/DepthOfField"
    {
        SubShader
        {
            Tags { "RenderType"="Opaque" "RenderPipeline"="UniversalRenderPipeline" }
            
            Cull Off 
            ZWrite Off 
            ZTest Always
    
            Pass
            {
                HLSLPROGRAM
                #pragma vertex vert
                #pragma fragment frag
    
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/DeclareDepthTexture.hlsl"
    
                TEXTURE2D(_MainTex);
                SAMPLER(sampler_MainTex);
    
                CBUFFER_START(UnityPerMaterial)
                    float _FocusDistance;
                    float _BlurSize;
                CBUFFER_END
    
                struct Attributes
                {
                    float4 positionOS : POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                struct Varyings
                {
                    float4 positionHCS : SV_POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                Varyings vert(Attributes IN)
                {
                    Varyings OUT;
                    OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                    OUT.uv = IN.uv;
                    return OUT;
                }
    
                half4 frag(Varyings IN) : SV_Target
                {
                    float depth = SampleSceneDepth(IN.uv);
                    depth = Linear01Depth(depth, _ZBufferParams);
                    
                    float blur = saturate(abs(depth - _FocusDistance) * _BlurSize);
                    half4 col = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
                    col.rgb = lerp(col.rgb, col.rgb * 0.5, blur);
                    return col;
                }
                ENDHLSL
            }
        }
    }
    
    

**æ™¯æ·±ç‰¹æ•ˆç³»ç»Ÿ**
----------

### å®ç°åŸç†

*   çº¿æ€§æ·±åº¦å€¼æ’å€¼è®¡ç®—

### å…³é”®æŠ€æœ¯

*   SAMPLE\_DEPTH\_TEXTUREå®

### æ€§èƒ½ä¼˜åŒ–

*   é™é‡‡æ ·+é«˜æ–¯æ¨¡ç³Šè¿­ä»£

### ä»£ç ä¸¾ä¾‹ **StencilDepth.shader**

*   å®ç°URPæ¨¡æ¿æµ‹è¯•åŠŸèƒ½
*   æ”¯æŒæ¨¡æ¿ç¼“å†²æµ‹è¯•
*   ä¿ç•™åŸShaderçš„çº¹ç†é‡‡æ ·åŠŸèƒ½
*   é‡‡ç”¨CBUFFERç®¡ç†æè´¨å‚æ•°

    Shader "Custom/StencilDepth"
    {
        Properties
        {
            [MainTexture] _MainTex("Texture", 2D) = "white" {}
            _StencilRef("Stencil Ref", Int) = 1
        }
    
        SubShader
        {
            Tags 
            {
                "Queue"="Geometry"
                "RenderPipeline"="UniversalRenderPipeline"
            }
    
            Stencil
            {
                Ref [_StencilRef]
                Comp Less
                Pass Replace
            }
    
            Pass
            {
                HLSLPROGRAM
                #pragma vertex vert
                #pragma fragment frag
    
                #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
    
                TEXTURE2D(_MainTex);
                SAMPLER(sampler_MainTex);
    
                CBUFFER_START(UnityPerMaterial)
                    float4 _MainTex_ST;
                    int _StencilRef;
                CBUFFER_END
    
                struct Attributes
                {
                    float4 positionOS : POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                struct Varyings
                {
                    float4 positionHCS : SV_POSITION;
                    float2 uv : TEXCOORD0;
                };
    
                Varyings vert(Attributes IN)
                {
                    Varyings OUT;
                    OUT.positionHCS = TransformObjectToHClip(IN.positionOS.xyz);
                    OUT.uv = TRANSFORM_TEX(IN.uv, _MainTex);
                    return OUT;
                }
    
                half4 frag(Varyings IN) : SV_Target
                {
                    return SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, IN.uv);
                }
                ENDHLSL
            }
        }
    }
    
    

**æ·±åº¦æµ‹è¯•ä¼˜åŒ–å»ºè®®**
============

**æ ¼å¼é€‰æ‹©**
--------

*   ç§»åŠ¨ç«¯ä½¿ç”¨16-bitæ·±åº¦(k\_DepthBufferBits)
*   PCç«¯æ¨è32-bitç²¾åº¦

**æ¸²æŸ“ç­–ç•¥**
--------

### é™æ€åœºæ™¯å¯ç”¨DepthPrepass

*   â€Œ**URP Asseté…ç½®**â€Œ
    
    å¯ç”¨æ·±åº¦çº¹ç†ç”Ÿæˆï¼š
    
    `Project Settings > Graphics > URP Global Settings`Â â†’ å‹¾é€‰â€Œ**Depth Texture**â€Œé€‰é¡¹ã€‚
    
*   â€Œ**Renderer Dataè®¾ç½®**â€Œ
    
    åœ¨ä½¿ç”¨çš„Renderer Assetï¼ˆå¦‚`UniversalRenderer_Forward`)ä¸­ï¼š
    
    â†’ æ·»åŠ â€Œ**SSAOæ•ˆæœ**â€Œï¼ˆScreen Space Ambient Occlusionï¼‰
    
    â†’ å°†SSAOçš„â€Œ**Sourceå±æ€§è®¾ä¸ºDepth**â€Œ
    
    æ­¤æ“ä½œå¼ºåˆ¶URPå¯ç”¨DepthPrepassé€šé“æ¸²æŸ“é™æ€ç‰©ä½“æ·±åº¦åˆ°`_CameraDepthTexture`ã€‚
    
    *   â€Œ**æ€§èƒ½å½±å“**â€ŒDepthPrepasså¢åŠ Draw Callï¼Œå»ºè®®é™æ€ç‰©ä½“ä½¿ç”¨â€Œ**Batchingé™æ€åˆæ‰¹**
    *   **å¯ç”¨é™æ€åˆæ‰¹å…¨å±€è®¾ç½®â€Œ**
        *   â€Œ**è·¯å¾„**â€Œï¼š`Edit > Project Settings > Player`
        *   â€Œ**æ“ä½œ**â€Œï¼šåœ¨`Other Settings`é¢æ¿ä¸­å‹¾é€‰â€Œ**Static Batching**â€Œé€‰é¡¹
        *   â€Œ**ä½œç”¨**â€Œï¼šå…è®¸Unityåœ¨æ„å»ºæ—¶åˆå¹¶é™æ€ç‰©ä½“çš„ç½‘æ ¼æ•°æ®ï¼Œå‡å°‘è¿è¡Œæ—¶Draw Callæ•°é‡
    *   **æ ‡è®°é™æ€ç‰©ä½“â€Œ**
        *   é€‰ä¸­åœºæ™¯ä¸­çš„é™æ€ç‰©ä½“
        *   åœ¨Inspectorçª—å£å³ä¸Šè§’ç‚¹å‡»â€Œ**Static**â€Œä¸‹æ‹‰èœå•
        *   å‹¾é€‰â€Œ**Batching Static**â€Œé€‰é¡¹ï¼ˆè‹¥ä»…éœ€åˆæ‰¹å¯ä¸å‹¾é€‰å…¶ä»–Staticé€‰é¡¹ï¼‰
        *   â€Œ**æ³¨æ„**â€Œï¼šæ ‡è®°ä¸ºé™æ€çš„ç‰©ä½“å°†æ— æ³•åœ¨è¿è¡Œæ—¶ç§»åŠ¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´åˆæ‰¹å¤±æ•ˆ
    *   **Shaderå…¼å®¹æ€§æ£€æŸ¥â€Œ**
        *   â€Œ**è¦æ±‚**â€Œï¼šé™æ€ç‰©ä½“éœ€ä½¿ç”¨â€Œ**ç›¸åŒShaderå˜ä½“**â€Œï¼Œä¸”æè´¨å±æ€§ç»“æ„ä¸€è‡´
        *   â€Œ**éªŒè¯**â€Œï¼šé€šè¿‡`Frame Debugger`æ£€æŸ¥åˆæ‰¹æ•ˆæœï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨â€Œ**SRP Batch**â€Œæˆ–â€Œ**Static Batch**â€Œæ¡ç›®
        *   **SRP Batcherä¼˜å…ˆçº§**â€Œï¼šè‹¥åŒæ—¶å¯ç”¨SRP Batcherï¼Œå…¶ä¼˜å…ˆçº§é«˜äºé™æ€åˆæ‰¹ï¼Œéœ€ç¡®ä¿Shaderä»£ç å…¼å®¹SRP Batcherï¼ˆå¦‚é¿å…ä½¿ç”¨MaterialPropertyBlockï¼‰
        *   â€Œ**GPU Instancing**â€Œï¼šå¯¹é‡å¤é™æ€ç‰©ä½“ï¼ˆå¦‚æ¤è¢«ï¼‰å¯å¯ç”¨GPU Instancingï¼Œè¿›ä¸€æ­¥å‡å°‘Draw Call
    *   **æ€§èƒ½éªŒè¯ä¸è°ƒè¯•â€Œ**
        *   â€Œ**å·¥å…·**â€Œï¼šä½¿ç”¨`Window > Analysis > Frame Debugger`
            *   æ£€æŸ¥â€Œ**DepthPrepass**â€Œé€šé“çš„Draw Callæ•°é‡
            *   ç¡®è®¤é™æ€ç‰©ä½“æ˜¯å¦åˆå¹¶ä¸ºâ€Œ**StaticBatch**â€Œæ¡ç›®
        *   â€Œ**æŒ‡æ ‡**â€Œï¼šé‡ç‚¹å…³æ³¨â€Œ**SetPass Call**â€Œçš„å‡å°‘æƒ…å†µï¼Œè€Œéä»…Draw Callæ•°é‡
    *   **æ³¨æ„äº‹é¡¹**
        *   â€Œ**å¹³å°å·®å¼‚**â€Œï¼šOpenGLç­‰å¹³å°éœ€å¤„ç†æ·±åº¦å€¼èŒƒå›´ï¼ˆ`UNITY_REVERSED_Z`ï¼‰
        *   â€Œ**åŠ¨æ€ç‰©ä½“**â€Œï¼šè‹¥åœºæ™¯å«åŠ¨æ€ç‰©ä½“ï¼Œéœ€é€šè¿‡CopyDepthæ¨¡å¼å•ç‹¬å¤„ç†å…¶æ·±åº¦ï¼Œé¿å…ä¸é™æ€åˆæ‰¹å†²çª

### åŠ¨æ€ç‰©ä½“ä½¿ç”¨CopyDepthæ¨¡å¼

*   â€Œ**Shaderé˜Ÿåˆ—è¦æ±‚**â€Œ
    
    åŠ¨æ€ç‰©ä½“Shaderéœ€ä½¿ç”¨â€Œ**ä¸é€æ˜æ¸²æŸ“é˜Ÿåˆ—**â€Œï¼š
    
        Tags {
          "Queue"="Geometry"  // åŠé€æ˜é˜Ÿåˆ—æ— æ³•ä½¿ç”¨æ·±åº¦å›¾
          "RenderType"="Opaque"
        }
        
    
*   â€Œ**æ·±åº¦é‡‡æ ·å£°æ˜**â€Œ
    
    åœ¨åŠ¨æ€ç‰©ä½“çš„Shaderä¸­æ˜¾å¼å£°æ˜æ·±åº¦çº¹ç†ï¼š
    
        hlsl
        TEXTURE2D(_CameraDepthTexture);
        SAMPLER(sampler_CameraDepthTexture);
        
    
*   â€Œ**æ‘„åƒæœºè®¾ç½®**â€Œ
    
    ç¡®ä¿åŠ¨æ€ç‰©ä½“æ‰€åœ¨æ‘„åƒæœºçš„æ¸²æŸ“è·¯å¾„ï¼š
    
        csharpCopy Code
        var cameraData = camera.GetUniversalAdditionalCameraData();
        cameraData.requiresDepthTexture = true;// å¼ºåˆ¶æ·±åº¦çº¹ç†å¯ç”¨
        
    
*   â€Œ**RenderPassä¼˜å…ˆçº§**â€Œ
    
    DepthPrepassé»˜è®¤åœ¨â€Œ**é˜´å½±æ¸²æŸ“åæ‰§è¡Œ**â€Œï¼Œä¼˜å…ˆäºCopyDepth Passã€‚åŠ¨æ€ç‰©ä½“æ·±åº¦é€šè¿‡åç»­çš„CopyDepth Passå¤åˆ¶åˆ°åŒä¸€`_CameraDepthTexture`ã€‚
    

### **éªŒè¯ä¸è°ƒè¯•â€Œ**

*   â€Œ**Frame Debuggeræ£€æŸ¥**â€Œ
    
    å¼€å¯`Window > Analysis > Frame Debugger`ï¼š
    
    â†’ ç¡®è®¤å­˜åœ¨â€Œ**DepthPrepass**â€Œé€šé“ï¼ˆé™æ€ç‰©ä½“æ·±åº¦ï¼‰
    
    â†’ æ£€æŸ¥â€Œ**CopyDepth**â€Œé€šé“æ˜¯å¦å¤„ç†åŠ¨æ€ç‰©ä½“æ·±åº¦
    
*   â€Œ**æ·±åº¦å€¼æµ‹è¯•**â€Œ
    
    åœ¨Shaderä¸­è¾“å‡ºçº¿æ€§æ·±åº¦éªŒè¯ï¼š
    
        hlsl
        float depth = SampleSceneDepth(uv);
        depth = Linear01Depth(depth, _ZBufferParams);
        return float4(depth.xxx, 1); // ç°åº¦å›¾æ˜¾ç¤ºæ·±åº¦
        
    

### **æ³¨æ„äº‹é¡¹**

*   â€Œ**å¹³å°å…¼å®¹æ€§**â€ŒOpenGLå¹³å°éœ€ç‰¹æ®Šå¤„ç†æ·±åº¦å€¼èŒƒå›´ï¼ˆ`UNITY_REVERSED_Z`å®åˆ¤æ–­ï¼‰ã€‚â€Œ

**å†…å­˜æ§åˆ¶**
--------

*   æŒ‰éœ€å¼€å¯\_CameraDepthTexture
*   é¿å…å¤šPassé‡å¤é‡‡æ ·

* * *

> [ã€ä»UnityURPå¼€å§‹æ¢ç´¢æ¸¸æˆæ¸²æŸ“ã€‘](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**ä¸“æ -ç›´è¾¾**

ï¼ˆæ¬¢è¿_ç‚¹èµç•™è¨€_æ¢è®¨ï¼Œæ›´å¤šäººåŠ å…¥è¿›æ¥èƒ½æ›´åŠ å®Œå–„è¿™ä¸ªæ¢ç´¢çš„è¿‡ç¨‹ï¼ŒğŸ™ï¼‰