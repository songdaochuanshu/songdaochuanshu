---
layout: post
title: 'Unity å°„çº¿æ£€æµ‹ä¼˜åŒ–ï¼šä½¿ç”¨ Job System å®ç°é«˜æ€§èƒ½å°„çº¿æ‰¹å¤„ç†'
date: "2025-07-29T00:51:13Z"
---
Unity å°„çº¿æ£€æµ‹ä¼˜åŒ–ï¼šä½¿ç”¨ Job System å®ç°é«˜æ€§èƒ½å°„çº¿æ‰¹å¤„ç†
=====================================

âœ¨ å‰è¨€
----

åœ¨ Unity ä¸­ï¼Œå°„çº¿æ£€æµ‹ï¼ˆRaycastï¼‰æ˜¯æ¸¸æˆå¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„ä¸€ç¯ï¼Œè¢«å¹¿æ³›ç”¨äºï¼š

*   ç©å®¶å°„å‡»å‘½ä¸­åˆ¤æ–­
    
*   AI æ„ŸçŸ¥ï¼ˆè§†é‡/åœ°å½¢æ¢æµ‹ï¼‰
    
*   ç¯å¢ƒäº¤äº’
    
*   é¼ æ ‡ç‚¹å‡»é€‰ä¸­
    
*   åœ°å½¢è´´åˆ
    

ç„¶è€Œï¼Œ**ä¼ ç»Ÿçš„ `Physics.Raycast()` æ˜¯ä¸€ä¸ªåŒæ­¥é˜»å¡çš„ä¸»çº¿ç¨‹æ“ä½œ**ï¼Œå½“å°„çº¿æ•°é‡å˜å¤šæ—¶ï¼ˆ>å‡ åæ¡/å¸§ï¼‰ï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œé€ æˆå¸§ç‡æŠ–åŠ¨ç”šè‡³å¡é¡¿ã€‚

* * *

ğŸš« é—®é¢˜ï¼šä¼ ç»Ÿå°„çº¿æ£€æµ‹åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„ç“¶é¢ˆ
----------------------

csharp

å¤åˆ¶ç¼–è¾‘

`for (int i = 0; i < 100; i++) { Physics.Raycast(...); // æ¯æ¬¡è°ƒç”¨éƒ½é˜»å¡ä¸»çº¿ç¨‹ }`

### â— ç»“æœï¼š

*   æ¯æ¡å°„çº¿éƒ½åœ¨ä¸»çº¿ç¨‹é€æ¡æ‰§è¡Œ
    
*   æ¯æ¬¡ `Physics.Raycast` éƒ½ä» C# è·³åˆ° C++ï¼ˆè·¨è¯­è¨€è°ƒç”¨ï¼‰
    
*   æ²¡æœ‰å¹¶è¡Œï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸
    
*   100~1000 æ¡å°„çº¿ â†’ ä¸»çº¿ç¨‹çˆ†ç‚¸ â†’ ä¸¥é‡æ‰å¸§
    

* * *

âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Unity çš„ `RaycastCommand` + Job System å®ç°â€œå°„çº¿æ‰¹å¤„ç†â€
---------------------------------------------------------

Unity æä¾›äº†ä¸€ä¸ªä¸“ä¸ºæ­¤ç±»åœºæ™¯è®¾è®¡çš„ç»“æ„ä½“ï¼š

csharp

å¤åˆ¶ç¼–è¾‘

`RaycastCommand`

å®ƒå…è®¸æˆ‘ä»¬å°†å¤šä¸ªå°„çº¿æ‰“åŒ…ï¼Œ**ä¸€æ¬¡æ€§å‘ç»™ Unity Job Systemï¼Œå¹¶è¡Œåœ¨å¤šçº¿ç¨‹ä¸­æ‰§è¡Œ**ã€‚

* * *

ğŸ§  åŸç†æ¦‚è§ˆ
-------

text

å¤åˆ¶ç¼–è¾‘

`å¤šä¸ªè¯·æ±‚è€…ï¼ˆè„šæœ¬ï¼‰ â†“ RaycastBatchManagerï¼ˆæ”¶é›†è¯·æ±‚ï¼‰ â†“ NativeArray<RaycastCommand>ï¼ˆæ‰¹å¤„ç†ï¼‰ â†“ Job System ScheduleBatch å¹¶è¡Œè°ƒåº¦ â†“ NativeArray<RaycastHit>ï¼ˆç»“æœï¼‰ â†“ ä¸»çº¿ç¨‹æ´¾å‘å›è°ƒ`

* * *

âš¡ æ€§èƒ½å¯¹æ¯”ï¼ˆå®æµ‹ç»“æœï¼‰
------------

å°„çº¿æ•°é‡

`Physics.Raycast()` ä¸»çº¿ç¨‹

`RaycastCommand` å¹¶è¡Œ Job

10

çº¦ 0.2 ms

çº¦ 0.1 ms

100

çº¦ 2~5 msï¼ˆæ‰å¸§ï¼‰

çº¦ 0.3~1 ms âœ…

500

10+ msï¼ˆæ˜æ˜¾å¡é¡¿ï¼‰

çº¦ 2~3 ms âœ…âœ…

ï¼ˆæ³¨ï¼šæ•°æ®è§†ç¡¬ä»¶å’Œåœºæ™¯å¤æ‚åº¦ä¸åŒç•¥æœ‰æµ®åŠ¨ï¼‰

* * *

ğŸ§± æˆ‘ä»¬æ„å»ºçš„è§£å†³æ–¹æ¡ˆï¼š`RaycastBatchManager`
----------------------------------

ä¸ºäº†è§£è€¦ç»“æ„ã€é›†ä¸­ç®¡ç†ï¼Œæˆ‘ä»¬å°è£…äº†ä¸€ä¸ª **Raycast æ‰¹å¤„ç†è°ƒåº¦å™¨**ï¼Œå…·å¤‡ï¼š

*   âœ… **æ¯å¸§æ”¶é›†å°„çº¿è¯·æ±‚**
    
*   âœ… **ä½¿ç”¨ `RaycastCommand.ScheduleBatch()` å¹¶è¡Œå¤„ç†**
    
*   âœ… **ç»“æœè‡ªåŠ¨å›è°ƒç»™è¯·æ±‚è€…**
    
*   âœ… **å¯é…ç½®æ¯å¸§æœ€å¤§å¤„ç†é‡ï¼ˆé™æµï¼‰**
    
*   âœ… **å¯è§†åŒ–è°ƒè¯•ï¼šDebug.DrawRay**
    

### ğŸ§© ä½¿ç”¨æ–¹å¼

csharp

å¤åˆ¶ç¼–è¾‘

`RaycastBatchManager.Instance.RequestRaycast( transform.position, transform.forward, 100f, LayerMask.GetMask("Enemy"), hit => { if (hit.collider != null) Debug.Log("Hit " + hit.collider.name); });`

* * *

ğŸ›  æŠ€æœ¯ä¼˜åŠ¿æ€»ç»“
---------

ä¼˜ç‚¹

è¯´æ˜

âœ… ä¸»çº¿ç¨‹è½»è´Ÿè½½

æ‰€æœ‰æ£€æµ‹åœ¨ Job ä¸­å®Œæˆï¼Œé¿å…å¡é¡¿

âœ… æ”¯æŒæˆç™¾ä¸Šåƒå°„çº¿å¹¶å‘

æé«˜æ‰©å±•æ€§ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡ AI æ„ŸçŸ¥ã€æŠ€èƒ½åˆ¤å®šç­‰

âœ… å›è°ƒè§£è€¦

ä¸šåŠ¡å±‚æ— éœ€å…³å¿ƒå¤„ç†æµç¨‹ï¼Œåªç®¡å‘å‡ºè¯·æ±‚ + æ”¶åˆ°å‘½ä¸­

âœ… LayerMask è¿‡æ»¤

æ”¯æŒæ¯æ¡å°„çº¿ç‹¬ç«‹è®¾ç½®è¿‡æ»¤å±‚çº§

âœ… é™æµ/èŠ‚æµä¿æŠ¤

æ¯å¸§å¯è®¾ç½®æœ€å¤§å°„çº¿æ•°ï¼Œé˜²æ­¢çˆ†é‡è¯·æ±‚æ‹–æ…¢æ•´å¸§

âœ… Debug å¯è§†åŒ–

æ¯æ¡å°„çº¿å¯è§†åŒ–è°ƒè¯•ï¼Œä¾¿äºå¼€å‘å®šä½é—®é¢˜

* * *

ğŸ’¡ åœºæ™¯é€‚ç”¨å»ºè®®
---------

ä½¿ç”¨åœºæ™¯

æ˜¯å¦æ¨èä½¿ç”¨å°„çº¿æ‰¹å¤„ç†

æªæ¢°å°„å‡»ç³»ç»Ÿï¼ˆå­å¼¹å¤šå‘ï¼‰

âœ…âœ…âœ…

AI æ„ŸçŸ¥ç³»ç»Ÿï¼ˆè§†é‡ã€åœ°å½¢ï¼‰

âœ…âœ…âœ…

æŠ€èƒ½åˆ¤å®šï¼ˆæ‰‡å½¢å°„çº¿ã€èŒƒå›´ç¢°æ’ï¼‰

âœ…âœ…

é¼ æ ‡ç‚¹å‡»ï¼ˆå•æ¡ï¼‰

âŒï¼ˆå•å‘ç”¨ Physics.Raycast å°±è¡Œï¼‰

ECS é¡¹ç›®ï¼ˆå…¨ç”¨ Unity.Physicsï¼‰

âŒï¼ˆä½¿ç”¨ `CollisionWorld.CastRay`ï¼‰

* * *

âœ… æ€»ç»“ä¸€å¥è¯
-------

> **RaycastCommand + Job System æ˜¯ Unity é ECS é¡¹ç›®ä¸­è¿›è¡Œå¤§é‡å°„çº¿æ£€æµ‹çš„æœ€ä¼˜è§£ã€‚**
> 
> è‹¥ä½ ä»ç„¶åœ¨ä¸»çº¿ç¨‹ç”¨ `Physics.Raycast()` åšå¤§é‡æ£€æµ‹ï¼Œè¯·ç«‹å³åˆ‡æ¢ï¼Œ**æ€§èƒ½æ”¶ç›Šå·¨å¤§ã€æ¶æ„æ›´åˆç†ã€ä½¿ç”¨éš¾åº¦æä½**ã€‚

ã€æ ¸å¿ƒä»£ç ã€‘

using System;
using System.Collections.Generic;
using System.Diagnostics;
using Unity.Collections;
using Unity.Jobs;
using UnityEngine;
using Debug = UnityEngine.Debug;

/// <summary>
/// å°„çº¿æ‰¹å¤„ç†è°ƒåº¦å™¨ï¼šæ”¶é›†å°„çº¿è¯·æ±‚ï¼Œæ‰¹é‡æ‰§è¡Œï¼Œä¸»çº¿ç¨‹å›è°ƒ
/// </summary>
public class RaycastBatchManager : MonoBehaviour
{
    public static RaycastBatchManager Instance { get; private set; }

    \[Header("æ€§èƒ½è®¾ç½®")\]
    \[Tooltip("æ¯å¸§æœ€å¤šå¤„ç†å¤šå°‘æ¡å°„çº¿ï¼ˆé™æµé˜²å¡é¡¿ï¼‰")\]
    public int maxRaysPerFrame = 100;

    /// <summary>
    /// å°„çº¿è¯·æ±‚ç»“æ„
    /// </summary>
    private struct RaycastRequest
    {
        public Vector3 origin;
        public Vector3 direction;
        public float distance;
        public int layerMask;
        public Action<RaycastHit> callback;
    }

    private readonly List<RaycastRequest> requestQueue = new();

    private NativeArray<RaycastCommand> commands;
    private NativeArray<RaycastHit> results;

    void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(this);
            return;
        }
        Instance \= this;
    }

    /// <summary>
    /// ç”±å¤–éƒ¨è°ƒç”¨ï¼šå‘èµ·ä¸€æ¡å°„çº¿è¯·æ±‚ï¼ˆå»¶è¿Ÿåˆ°æœ¬å¸§ LateUpdate æ‰§è¡Œï¼‰
    /// </summary>
    public void RequestRaycast(Vector3 origin, Vector3 direction, float distance, int layerMask, Action<RaycastHit> callback)
    {
        requestQueue.Add(new RaycastRequest
        {
            origin \= origin,
            direction \= direction,
            distance \= distance,
            layerMask \= layerMask,
            callback \= callback
        });
    }

    void LateUpdate()
    {
        int totalRequests = requestQueue.Count;
        if (totalRequests == 0) return;

        int count = Mathf.Min(maxRaysPerFrame, totalRequests);
        Debug.Log("å½“å‰æ‰¹å¤„ç†å°„çº¿æ•°é‡" + count);
        
        //æ€§èƒ½ç›‘æµ‹
        Stopwatch stopwatch = Stopwatch.StartNew();
        
        // åˆ†é… NativeArrayï¼ˆä¸´æ—¶ Job ç”¨ï¼‰
        commands = new NativeArray<RaycastCommand>(count, Allocator.TempJob);
        results \= new NativeArray<RaycastHit>(count, Allocator.TempJob);

        for (int i = 0; i < count; i++)
        {
            var req = requestQueue\[i\];
            commands\[i\] \= new RaycastCommand(req.origin, req.direction, req.distance, req.layerMask);

            // ğŸ‘‡ å¯è§†åŒ–ï¼ˆè°ƒè¯•ç”¨ï¼‰
            //Debug.DrawRay(req.origin, req.direction \* req.distance, Color.green, 0.1f);
        }

        // å¹¶è¡Œè°ƒåº¦
        JobHandle handle = RaycastCommand.ScheduleBatch(commands, results, 32);
        handle.Complete(); // é˜»å¡ç›´åˆ° Job å®Œæˆï¼ˆç¡®ä¿ç»“æœå¯ç”¨ï¼‰

        // å›è°ƒç»“æœ
        for (int i = 0; i < count; i++)
        {
            requestQueue\[i\].callback?.Invoke(results\[i\]);
        }

        // åˆ†å¸§å¤„ç†ï¼Œä¿ç•™æœªå¤„ç†çš„è¯·æ±‚
        requestQueue.RemoveRange(0, count);

        // å®‰å…¨é‡Šæ”¾ NativeArray
        if (commands.IsCreated) commands.Dispose();
        if (results.IsCreated) results.Dispose();
        
        // æ€§èƒ½ç»Ÿè®¡è¾“å‡º
        stopwatch.Stop();
        UnityEngine.Debug.Log($"\[RaycastBatchManager\] {count} å°„çº¿è€—æ—¶: {stopwatch.ElapsedMilliseconds} ms");
    }
}

ã€æµ‹è¯•ç”¨ä¾‹ã€‘

            RaycastBatchManager.Instance.RequestRaycast(
                transform.position,
                transform.forward,
                100f,
                LayerMask.GetMask("Default"),
                hit \=>
                {
                    if (hit.collider != null)
                        Debug.Log("å‘½ä¸­: " + hit.collider.name);
                    else
                        Debug.Log("æœªå‘½ä¸­");
                });