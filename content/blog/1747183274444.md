---
layout: post
title: 'å¥½å“¥å“¥å› ä¸ºæ²¡æœ‰ææ¸…æ¥šåŒæ­¥å®Œæˆå’Œå¼‚æ­¥å®Œæˆå¯¼è‡´ä»£ç æ­»å¾ªç¯äº†è¿™æ¡£äº‹'
date: "2025-05-14T00:41:14Z"
---
å¥½å“¥å“¥å› ä¸ºæ²¡æœ‰ææ¸…æ¥šåŒæ­¥å®Œæˆå’Œå¼‚æ­¥å®Œæˆå¯¼è‡´ä»£ç æ­»å¾ªç¯äº†è¿™æ¡£äº‹
==============================

æœ‰ä¸ªå¥½å“¥å“¥è¯´ä»–é‡åˆ°å¾ªç¯ä»£ç æ­»å¾ªç¯çš„é—®é¢˜ï¼Œæ‰€ä»¥ä»”ç»†çš„ç ”ç©¶äº†ä¸€ä¸‹ï¼Œäºæ˜¯å‘ç°äº†å…³äºåŒæ­¥å®Œæˆå’Œå¼‚æ­¥å®Œæˆçš„åŒºåˆ«ã€‚

æœ‰ä¸ªå¥½å“¥å“¥è¯´ä»–é‡åˆ°å¾ªç¯ä»£ç æ­»å¾ªç¯çš„é—®é¢˜ï¼Œæ‰€ä»¥ä»”ç»†çš„ç ”ç©¶äº†ä¸€ä¸‹ï¼Œäºæ˜¯å‘ç°äº†å…³äºåŒæ­¥å®Œæˆå’Œå¼‚æ­¥å®Œæˆçš„åŒºåˆ«ã€‚

ä»€ä¹ˆæ˜¯æ­»å¾ªç¯
------

æ¯”å¦‚ï¼Œé•¿è¿™ä¸ªæ ·å­

    [Test]
    public void EndlessLoop()
    {
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will never reach here
        return;
    
        void Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(100); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (GetBool());
    
            return;
    
            bool GetBool()
            {
                return true;
            }
        }
    }
    

âŒ è¿™æ®µä»£ç ä¸€ä½†å¼€å§‹è¿è¡Œï¼Œå°†ä¸ä¼šç»“æŸï¼Œä¹Ÿä¸ä¼šæ‰“å° `nice end`ã€‚ å› ä¸º `Yanjia_foRever_niCE` è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œæ°¸è¿œä¸ä¼šç»“æŸã€‚

é‚£å¦‚æœ `GetBool()` è¿”å› `Task<bool>` å‘¢
---------------------------------

æ¯”å¦‚ï¼Œé•¿è¿™ä¸ªæ ·å­

    [Test]
    public void EndlessLoopWithSyncCompletion()
    {
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will never reach here
        return;
    
        async Task Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(100); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (await GetBoolAsync());
    
            return;
    
            Task<bool> GetBoolAsync()
            {
                return Task.FromResult(true);
            }
        }
    }
    

âŒ è¿™ä¸ªä»£ç ï¼Œçœ‹èµ·æ¥ç”¨äº† Task ä½†æ˜¯ä¾ç„¶æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ã€‚å› ä¸º `GetBoolAsync` è¿”å›çš„æ˜¯ä¸€ä¸ª Taskï¼Œä½†å®ƒæ˜¯ä¸€ä¸ªåŒæ­¥å®Œæˆçš„ Taskã€‚æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåœ¨å½“å‰çº¿ç¨‹å®Œæˆï¼Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚

èªæ˜çš„å®å®å·²ç»æƒ³åˆ°äº†å¯ä»¥åŠ ä¸Š async await
--------------------------

æ¯”å¦‚ï¼Œé•¿è¿™ä¸ªæ ·å­

    [Test]
    public void EndlessLoopWithSyncCompletion2()
    {
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will never reach here
        return;
    
        async Task Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(100); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (await GetBoolAsync());
    
            return;
    
            async Task<bool> GetBoolAsync()
            {
                return true;
            }
        }
    }
    

âŒ ä½†å®é™…ä¸Šï¼Œæ²¡æœ‰ä»»ä½•åµç”¨ï¼Œå› ä¸º `GetBoolAsync` æœ¬è´¨ä¾ç„¶æ˜¯ä¸€ä¸ªåŒæ­¥å®Œæˆçš„ Taskã€‚æ‰€æœ‰çš„æ“ä½œéƒ½ä¼šåœ¨å½“å‰çº¿ç¨‹å®Œæˆï¼Œä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚ å¹¶ä¸”å®é™…ä¸Šä¼šè§¦å‘ç¼–è¯‘å™¨è­¦å‘Šï¼Œä¹–å®å®å¯ä¸è¦è¿™æ ·å†™å“Ÿã€‚

ä½†æ˜¯æˆ‘ç”¨ await Task.FromResult(true) å¾ˆå¼€å¿ƒ
------------------------------------

æ¯”å¦‚ï¼Œé•¿è¿™ä¸ªæ ·å­

    [Test]
    public void EndlessLoopWithSyncCompletion3()
    {
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will never reach here
        return;
    
        async Task Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(100); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (await GetBoolAsync());
    
            return;
    
            async Task<bool> GetBoolAsync()
            {
                return await Task.FromResult(true);
            }
        }
    }
    

âŒ ç¡®å®æ›¾ç»æœ‰å¥½å“¥å“¥è¿™ä¹ˆå†™è¿‡ä»£ç ï¼Œä½†æ˜¯å®é™…ä¸Š `await Task.FromResult(true)` ä¾ç„¶æ˜¯ä¸€ä¸ªåŒæ­¥å®Œæˆçš„ Taskã€‚ `async` å’Œ `await` æ˜¯ä¸ä¼šæ”¹å˜ Task çš„å®Œæˆæ–¹å¼çš„ã€‚ å®ƒæ˜¯åŒæ­¥å®Œæˆï¼Œå°±ä¸€ç›´éƒ½æ˜¯åŒæ­¥å®Œæˆã€‚å½“ç„¶è¿™æ ·å†™è¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥ç•¥å¾®å¢åŠ ä»£ç é‡ XDã€‚

çœŸçš„å¼‚æ­¥æ‰è¡Œ
------

æ¯”å¦‚ï¼Œé•¿è¿™ä¸ªæ ·å­

    [Test]
    public void EndlessLoopWithAsyncCompletion()
    {
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will reach here
        return;
    
        async Task Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(100); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (await GetBoolAsync());
    
            return;
    
            async Task<bool> GetBoolAsync()
            {
                await Task.Delay(100);
                return true;
            }
        }
    }
    

âœ… è¿™æ®µä»£ç å°±å¯ä»¥æ­£å¸¸ç»“æŸäº†ï¼Œå› ä¸º `GetBoolAsync` è¿”å›çš„æ˜¯ä¸€ä¸ªå¼‚æ­¥å®Œæˆçš„ Taskã€‚å…¶ä¸­çš„ `await Task.Delay(100)` ä¼šçœŸçš„è§¦å‘å¼‚æ­¥å®Œæˆã€‚ä»è€Œå¯¼è‡´ `Yanjia_foRever_niCE` ç”±äºæ²¡æœ‰ await è€Œç›´æ¥æ¨è¿›åˆ° `nice end` è¿™è¡Œä»£ç ã€‚

æœ‰äººå¥½å¥‡ ValueTask ä¼šæ€ä¹ˆæ ·
-------------------

å®é™…ä¸Šä¸Šé¢æ‰€æœ‰çš„ Task æ¢æˆ ValueTask éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚

    ValueTask<bool> GetBoolAsync() // âŒ
    {
        return ValueTask.FromResult(true);
    }
    
    async ValueTask<bool> GetBoolAsync() // âŒ
    {
        return true;
    }
    
    async ValueTask<bool> GetBoolAsync() // âŒ
    {
        return await ValueTask.FromResult(true);
    }
    
    async ValueTask<bool> GetBoolAsync() // âœ…
    {
        await Task.Delay(100);
        return true;
    }
    

è¿™äº›ä»£ç äº§ç”Ÿçš„æ•ˆæœå’Œä¸Šé¢æ‰€æœ‰çš„ Task ä»£ç æ˜¯ä¸€æ ·çš„ã€‚

ä¹Ÿå°±æ˜¯ ValueTask ä¹Ÿä¸ä¼šå½±å“è¿™æ®µä»£ç æ˜¯åŒæ­¥å®Œæˆè¿˜æ˜¯å¼‚æ­¥å®Œæˆã€‚

å…¶å®ä¸€å¼€å§‹æ˜¯å› ä¸ºä¸€ä¸ª Timer
----------------

.NET6 ä¸­çš„ `PeriodicTimer` æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå®ƒçš„ `WaitForNextTickAsync` æ–¹æ³•æ˜¯ä¸€ä¸ªè¿”å› `ValueTask<bool>` çš„æ–¹æ³•ã€‚

å®ƒæœ‰ä¸€ä¸ªå¾ˆåˆç†ä½†æ˜¯å¯èƒ½æœ‰æ—¶å€™æ³¨æ„ä¸åˆ°çš„åœ°æ–¹ï¼Œå°±æ˜¯è®¡æ—¶æ˜¯ä»åˆ›å»ºå®ä¾‹å¼€å§‹çš„ï¼Œè€Œä¸æ˜¯ä»è°ƒç”¨ `WaitForNextTickAsync` å¼€å§‹çš„ã€‚

æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š

    [Test]
    public void EndlessLoopWithSyncCompletion()
    {
        var timer = new PeriodicTimer(TimeSpan.FromSeconds(0.01));
        Yanjia_foRever_niCE();
        Console.WriteLine("nice end"); // it will never reach here
        return;
    
        async Task Yanjia_foRever_niCE()
        {
            do
            {
                Thread.Sleep(TimeSpan.FromSeconds(0.5)); // some code running synchronously
                Console.WriteLine("ä¸¥æ¶ nice");
            } while (await GetBoolAsync());
    
            return;
    
            ValueTask<bool> GetBoolAsync()
            {
                return timer.WaitForNextTickAsync();
            }
        }
    }
    

è¿™æ®µä»£ç ä¸­ï¼Œ timer çš„åˆ›å»ºæ—¶é—´æ˜¯ 0.01 ç§’ï¼Œè€Œ `Thread.Sleep` çš„æ—¶é—´æ˜¯ 0.5 ç§’ã€‚è¿™ä¹Ÿå°±æ„å‘³è€…ï¼Œåœ¨æ¯æ¬¡è¿›å…¥ `GetBoolAsync` æ–¹æ³•æ—¶ï¼Œ timer æ—©å°±å·²ç»åˆ°äº†ä¸‹ä¸€ä¸ª tick çš„æ—¶é—´äº†ã€‚

æ‰€ä»¥è¿™ä¸ªæ—¶å€™ `timer.WaitForNextTickAsync()` è¿”å›çš„å°±æ˜¯ä¸€ä¸ªåŒæ­¥å®Œæˆçš„ ValueTaskã€‚

å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªåŒæ­¥å®Œæˆçš„ ValueTaskï¼Œæ‰€ä»¥ `await` ä¹Ÿä¸ä¼šåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ã€‚ä»è€Œå°±å¯¼è‡´äº†æ­»å¾ªç¯ã€‚

è€Œï¼Œå¦‚æœå°† timer çš„åˆ›å»ºæ—¶é—´æ”¹æˆ 1 ç§’ï¼Œé‚£ä¹ˆå½“ `Thread.Sleep` ç»“æŸæ—¶ï¼Œ timer çš„ tick è¿˜æ²¡æœ‰åˆ°è¾¾ï¼Œæ‰€ä»¥ `timer.WaitForNextTickAsync()` è¿”å›çš„å°±æ˜¯ä¸€ä¸ªå¼‚æ­¥å®Œæˆçš„ ValueTaskã€‚

è¿™æ—¶å€™ `await GetBoolAsync()` å°±ä¼šåˆ‡æ¢åˆ°è°ƒåº¦å™¨ä¸Šï¼Œä»è€Œå¯¼è‡´ `Yanjia_foRever_niCE` ç»“æŸï¼Œæ‰“å° `nice end`ã€‚

è¿™å°±æ˜¯ä¸€å¼€å§‹å¥½å“¥å“¥é‡åˆ°çš„é—®é¢˜ã€‚

æ€»ç»“
--

ä»£ç æ˜¯åŒæ­¥å®Œæˆè¿˜æ˜¯å¼‚æ­¥å®Œæˆï¼Œå’Œè¿”å›å€¼æ˜¯ Task è¿˜æ˜¯ ValueTask æ²¡æœ‰å…³ç³»ï¼Œå’Œæœ‰æ²¡æœ‰ async/await ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚

å®ƒåªä¸å®ç°çš„ä»£ç ç©¶ç«Ÿæœ‰æ²¡æœ‰çœŸå¼‚æ­¥æ“ä½œæœ‰å…³ã€‚

æµ‹è¯•ä»£ç åœ¨ï¼š[GitHub](https://github.com/newbe36524/Newbe.Demo/tree/main/src/BlogDemos/Newbe.NiceValueTasks)

æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœè§‰å¾—æœ¬æ–‡æœ‰ç”¨ï¼Œä¸å¦¨ç‚¹å‡»æ¨èğŸ‘æˆ–è€…åœ¨è¯„è®ºåŒºç•™ä¸‹ Markï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°ã€‚

> æ¬¢è¿å…³æ³¨ä½œè€…çš„å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€ï¼Œè·å–æ›´å¤šæŠ€æœ¯å†…å®¹ã€‚ ![å…³æ³¨å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€](https://www.newbe.pro/images/weixin_public_qrcode.png)

*   æœ¬æ–‡ä½œè€…ï¼š [newbe36524](https://www.newbe.pro/)
*   æœ¬æ–‡é“¾æ¥ï¼š [https://www.newbe.pro/Others/0049-Dive-into-async-and-sync-completion/](https://www.newbe.pro/Others/0049-Dive-into-async-and-sync-completion/)
*   ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼