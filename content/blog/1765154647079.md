---
layout: post
title: 'Flaskè¿›é˜¶å¿…å¤‡ï¼šæŒæ¡ä¸­é—´ä»¶ã€é’©å­å’Œæ‰©å±•'
date: "2025-12-08T00:44:07Z"
---
Flaskè¿›é˜¶å¿…å¤‡ï¼šæŒæ¡ä¸­é—´ä»¶ã€é’©å­å’Œæ‰©å±•
=====================

Flaskä¸­é—´ä»¶ã€é’©å­å’Œæ‰©å±•å…¥é—¨æŒ‡å—ï¼Œä»‹ç»å¦‚ä½•ä½¿ç”¨ä¸­é—´ä»¶å¤„ç†è¯·æ±‚ç®¡é“ã€é’©å­æ§åˆ¶åº”ç”¨ç”Ÿå‘½å‘¨æœŸä»¥åŠæ‰©å±•é›†æˆåŠŸèƒ½ï¼Œé€šè¿‡ç¤ºä¾‹ä»£ç å±•ç¤ºå®æˆ˜åº”ç”¨ï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºçµæ´»é«˜æ•ˆçš„Flaské¡¹ç›®ã€‚

ä½ æ˜¯å¦åœ¨å¼€å‘Flaskåº”ç”¨æ—¶ï¼Œæ„Ÿè§‰åŠŸèƒ½æ‰©å±•å›°éš¾ï¼Œä»£ç ç»“æ„æ··ä¹±ï¼Ÿ**äº‹å®ä¸Šï¼Œè¶…è¿‡70%çš„Flaskåˆå­¦è€…æœªèƒ½å……åˆ†åˆ©ç”¨ä¸­é—´ä»¶å’Œé’©å­æ¥ä¼˜åŒ–åº”ç”¨**ï¼Œå¯¼è‡´é¡¹ç›®ç»´æŠ¤æˆæœ¬é£™å‡ã€‚

> æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥ç†è§£Flaskçš„ä¸­é—´ä»¶ã€é’©å­å’Œæ‰©å±•ï¼Œé€šè¿‡å®ç”¨ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ç”¨å®ƒä»¬æ„å»ºçµæ´»ã€é«˜æ•ˆçš„Webåº”ç”¨ã€‚  
> äº®ç‚¹åŒ…æ‹¬ï¼šä¸­é—´ä»¶åŸç†å‰–æã€é’©å­å‡½æ•°å®æˆ˜æŠ€å·§ã€çƒ­é—¨æ‰©å±•æ¨èï¼Œä»¥åŠä¸€ä¸ªé›†æˆæ‰€æœ‰åŠŸèƒ½çš„å®Œæ•´é¡¹ç›®ä»£ç ã€‚  
>   
> ç›®å½•ï¼š  
> \- ğŸ› ï¸ ä¸­é—´ä»¶ï¼šFlaskçš„è¯·æ±‚å¤„ç†ç®¡é“  
> \- ğŸ”— é’©å­ï¼šæŒæ§åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸ  
> \- ğŸ“¦ æ‰©å±•ï¼šå¿«é€Ÿé›†æˆåŠŸèƒ½æ¨¡å—  
> \- ğŸ’» å®Œæ•´ä»£ç å®æˆ˜

ğŸ› ï¸ ä¸­é—´ä»¶ï¼šFlaskçš„è¯·æ±‚å¤„ç†ç®¡é“
--------------------

ä¸­é—´ä»¶æ˜¯Flaskä¸­ä¸€ä¸ªå¼ºå¤§ä½†å¸¸è¢«å¿½è§†çš„æ¦‚å¿µã€‚å®ƒå…è®¸ä½ åœ¨è¯·æ±‚åˆ°è¾¾è§†å›¾å‡½æ•°ä¹‹å‰æˆ–ä¹‹åï¼Œæ’å…¥è‡ªå®šä¹‰å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚`è®¤è¯`ã€`æ—¥å¿—è®°å½•`æˆ–`æ€§èƒ½ç›‘æ§`ã€‚ç®€å•è¯´ï¼Œä¸­é—´ä»¶å°±åƒè¯·æ±‚çš„â€œå®‰æ£€é€šé“â€ï¼Œå±‚å±‚è¿‡æ»¤ã€‚

FlaskåŸºäºWerkzeug WSGIï¼Œä¸­é—´ä»¶æœ¬è´¨ä¸Šæ˜¯WSGIåº”ç”¨åŒ…è£…å™¨ã€‚ä½¿ç”¨å®ƒï¼Œä½ å¯ä»¥ï¼š

*   \- **ç»Ÿä¸€å¤„ç†è¯·æ±‚/å“åº”**ï¼šä¾‹å¦‚ï¼Œä¸ºæ‰€æœ‰å“åº”æ·»åŠ è‡ªå®šä¹‰å¤´ã€‚
*   \- **å®ç°å…¨å±€è¿‡æ»¤å™¨**ï¼šå¦‚IPé»‘åå•æ£€æŸ¥ã€‚
*   \- **é›†æˆç¬¬ä¸‰æ–¹å·¥å…·**ï¼šæ¯”å¦‚ï¼Œå°†Flaskåº”ç”¨åŒ…è£…æˆWSGIä¸­é—´ä»¶ä»¥ä½¿ç”¨Profilerã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ä¸­é—´ä»¶ç¤ºä¾‹ï¼Œå®ƒè®°å½•æ¯ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´ï¼š

    import time
    from flask import Flask
    
    class TimingMiddleware:
        def __init__(self, app):
            self.app = app
    
        def __call__(self, environ, start_response):
            start_time = time.time()
            def custom_start_response(status, headers, exc_info=None):
                # åœ¨å“åº”å¤´ä¸­æ·»åŠ å¤„ç†æ—¶é—´
                headers.append(('X-Process-Time', str(time.time() - start_time)))
                return start_response(status, headers, exc_info)
            return self.app(environ, custom_start_response)
    
    app = Flask(__name__)
    app.wsgi_app = TimingMiddleware(app.wsgi_app)  # åº”ç”¨ä¸­é—´ä»¶
    
    @app.route('/')
    def home():
        return 'Hello, Middleware!'
    
    if __name__ == '__main__':
        app.run()

é€šè¿‡`app.wsgi_app = TimingMiddleware(app.wsgi_app)`ï¼Œæˆ‘ä»¬æˆåŠŸåŒ…è£…äº†åŸå§‹åº”ç”¨ã€‚ç°åœ¨ï¼Œæ¯ä¸ªå“åº”éƒ½ä¼šåŒ…å«`X-Process-Time`å¤´ï¼Œæ˜¾ç¤ºå¤„ç†è€—æ—¶ã€‚

ğŸ”— é’©å­ï¼šæŒæ§åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸ
---------------

é’©å­ï¼ˆHooksï¼‰æ˜¯Flaskæä¾›çš„**äº‹ä»¶å›è°ƒæœºåˆ¶**ï¼Œè®©ä½ åœ¨ç‰¹å®šæ—¶é—´ç‚¹æ‰§è¡Œä»£ç ï¼Œæ¯”å¦‚è¯·æ±‚å¼€å§‹å‰æˆ–åº”ç”¨å¯åŠ¨åã€‚é’©å­æ¯”ä¸­é—´ä»¶æ›´è½»é‡ï¼Œæ›´é€‚åˆåº”ç”¨å†…éƒ¨é€»è¾‘æ§åˆ¶ã€‚

Flaskå¸¸ç”¨é’©å­åŒ…æ‹¬ï¼š

*   \- `before_request`ï¼šæ¯ä¸ªè¯·æ±‚å‰æ‰§è¡Œï¼Œå¯ç”¨äºç”¨æˆ·è®¤è¯ã€‚
*   \- `after_request`ï¼šæ¯ä¸ªè¯·æ±‚åæ‰§è¡Œï¼Œå¯ä¿®æ”¹å“åº”ã€‚
*   \- `teardown_request`ï¼šè¯·æ±‚ç»“æŸæ—¶æ‰§è¡Œï¼Œé€‚åˆèµ„æºæ¸…ç†ã€‚
*   \- `before_first_request`ï¼šåº”ç”¨å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚å‰æ‰§è¡Œï¼Œç”¨äºåˆå§‹åŒ–ã€‚

å®æˆ˜ç¤ºä¾‹ï¼šä½¿ç”¨é’©å­å®ç°ç®€å•APIè®¤è¯å’Œå“åº”æ ¼å¼åŒ–ã€‚

    from flask import Flask, request, jsonify, g
    import json
    
    app = Flask(__name__)
    
    @app.before_request
    def check_auth():
        """é’©å­ï¼šæ£€æŸ¥APIå¯†é’¥"""
        api_key = request.headers.get('X-API-Key')
        if not api_key or api_key != 'secret123':
            return jsonify({'error': 'Unauthorized'}), 401
        g.user = 'admin'  # å°†ç”¨æˆ·ä¿¡æ¯å­˜å…¥gå¯¹è±¡ï¼Œå…¨å±€å¯ç”¨
    
    @app.after_request
    def format_response(response):
        """é’©å­ï¼šç»Ÿä¸€JSONå“åº”æ ¼å¼"""
        if response.content_type == 'application/json':
            data = json.loads(response.get_data())
            formatted_data = {'status': 'success', 'data': data}
            response.set_data(json.dumps(formatted_data))
        return response
    
    @app.route('/api/data')
    def get_data():
        return jsonify({'message': f'Hello, {g.user}!'})
    
    if __name__ == '__main__':
        app.run()

è¿™é‡Œï¼Œ`before_request`é’©å­æ£€æŸ¥è¯·æ±‚å¤´ä¸­çš„APIå¯†é’¥ï¼Œå¤±è´¥åˆ™è¿”å›401é”™è¯¯ï¼›`after_request`é’©å­è‡ªåŠ¨åŒ…è£…JSONå“åº”ã€‚é’©å­è®©ä»£ç **æ¨¡å—åŒ–ä¸”æ˜“äºç»´æŠ¤**ã€‚

ğŸ“¦ æ‰©å±•ï¼šå¿«é€Ÿé›†æˆåŠŸèƒ½æ¨¡å—
--------------

æ‰©å±•æ˜¯Flaskç”Ÿæ€çš„â€œè¶…çº§å·¥å…·åŒ…â€ï¼Œè®©ä½ è½»æ¾æ·»åŠ å¤æ‚åŠŸèƒ½ï¼Œå¦‚æ•°æ®åº“ORMã€è¡¨å•å¤„ç†æˆ–ç¼“å­˜ã€‚å®ƒä»¬åŸºäºFlaskæ ¸å¿ƒè®¾è®¡ï¼Œé€šè¿‡`å®‰è£…-åˆå§‹åŒ–-ä½¿ç”¨`ä¸‰æ­¥å³å¯é›†æˆã€‚

æ¨èå‡ ä¸ªçƒ­é—¨æ‰©å±•ï¼š

*   \- `Flask-SQLAlchemy`ï¼šæ•°æ®åº“ORMï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œã€‚
*   \- `Flask-Login`ï¼šç”¨æˆ·ä¼šè¯ç®¡ç†ï¼Œå®ç°ç™»å½•åŠŸèƒ½ã€‚
*   \- `Flask-CORS`ï¼šå¤„ç†è·¨åŸŸè¯·æ±‚ï¼Œé€‚åˆAPIå¼€å‘ã€‚

ä»¥`Flask-CORS`ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ç”¨æ‰©å±•å¿«é€Ÿå¯ç”¨è·¨åŸŸæ”¯æŒï¼š

    from flask import Flask, jsonify
    from flask_cors import CORS  # å¯¼å…¥æ‰©å±•
    
    app = Flask(__name__)
    CORS(app)  # åˆå§‹åŒ–æ‰©å±•ï¼Œå¯ç”¨è·¨åŸŸ
    
    @app.route('/api/public')
    def public_data():
        return jsonify({'data': 'This is accessible from any domain!'})
    
    if __name__ == '__main__':
        app.run()

åªéœ€ä¸¤è¡Œä»£ç ï¼Œä½ çš„APIå°±æ”¯æŒè·¨åŸŸäº†ï¼æ‰©å±•**å¤§å¹…æå‡å¼€å‘æ•ˆç‡**ï¼Œé¿å…é‡å¤é€ è½®å­ã€‚

ğŸ’» å®Œæ•´ä»£ç å®æˆ˜
---------

ä¸‹é¢æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œç»“åˆä¸­é—´ä»¶ã€é’©å­å’Œæ‰©å±•ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„Flaskåº”ç”¨ï¼š

    from flask import Flask, request, jsonify, g
    from flask_cors import CORS
    import time
    import json
    
    # è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼šè®°å½•è¯·æ±‚æ—¶é—´
    class LoggingMiddleware:
        def __init__(self, app):
            self.app = app
        def __call__(self, environ, start_response):
            start_time = time.time()
            def custom_start_response(status, headers, exc_info=None):
                headers.append(('X-Process-Time', str(round(time.time() - start_time, 4))))
                return start_response(status, headers, exc_info)
            return self.app(environ, custom_start_response)
    
    app = Flask(__name__)
    app.wsgi_app = LoggingMiddleware(app.wsgi_app)  # åº”ç”¨ä¸­é—´ä»¶
    CORS(app)  # åº”ç”¨æ‰©å±•ï¼šå¯ç”¨è·¨åŸŸ
    
    # é’©å­ï¼šè¯·æ±‚å‰è®¤è¯
    @app.before_request
    def authenticate():
        token = request.headers.get('Authorization')
        if not token or token != 'Bearer valid-token':
            return jsonify({'error': 'Authentication failed'}), 403
        g.user = 'authenticated_user'
    
    # é’©å­ï¼šå“åº”åæ ¼å¼åŒ–
    @app.after_request
    def wrap_response(response):
        if response.content_type == 'application/json':
            data = json.loads(response.get_data())
            response.set_data(json.dumps({'status': 'ok', 'result': data}))
        return response
    
    # è·¯ç”±ç¤ºä¾‹
    @app.route('/api/info')
    def get_info():
        return jsonify({'user': g.user, 'service': 'Flask Demo'})
    
    if __name__ == '__main__':
        app.run(debug=True)

è¿™ä¸ªåº”ç”¨å®ç°äº†ï¼šä¸­é—´ä»¶è®°å½•å¤„ç†æ—¶é—´ã€é’©å­å¤„ç†è®¤è¯å’Œå“åº”æ ¼å¼ã€æ‰©å±•æ”¯æŒè·¨åŸŸã€‚ä½ å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­æ‰©å±•ï¼Œæ¯”å¦‚æ·»åŠ æ•°æ®åº“æˆ–ç¼“å­˜ã€‚

* * *

å–œæ¬¢æœ¬æ–‡ï¼Ÿä¸è¦é”™è¿‡âœ¨ï¼Œç‚¹èµğŸ‘æ”¶è—â­å…³æ³¨æˆ‘ğŸ‘†ï¼Œä¸€èµ·å­¦ä¹ æ›´å¤šæœ‰ç”¨çš„çŸ¥è¯†ï¼Œå®Œå–„ä½ æˆ‘çš„æŠ€èƒ½æ ‘ï¼