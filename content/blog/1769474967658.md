---
layout: post
title: 'wso2~é€šè¿‡ä¸‰æ–¹IDPçš„tokenç½®æ¢wso2çš„token'
date: "2026-01-27T00:49:27Z"
---
wso2~é€šè¿‡ä¸‰æ–¹IDPçš„tokenç½®æ¢wso2çš„token
==============================

å‚æ•°ï¼š[https://datatracker.ietf.org/doc/html/rfc7523](https://datatracker.ietf.org/doc/html/rfc7523)

oauth2.0ä¸­çš„ä¸‰æ–¹å¦ç±»æˆæƒ
================

äº†è§£OAuth 2.0ä¸­ç‰¹å®šçš„æˆæƒç±»å‹ï¼ˆGrant Typeï¼‰å¯¹äºæ„å»ºå®‰å…¨çš„è®¤è¯æµç¨‹è‡³å…³é‡è¦ã€‚ä¸‹é¢ä¸ºä½ è¯¦ç»†ä»‹ç»è¿™ä¸‰ç§åŸºäºURNå£°æ˜çš„æ‰©å±•æˆæƒç±»å‹ã€‚

### ğŸ” è®¾å¤‡ä»£ç æˆæƒ (`urn:ietf:params:oauth:grant-type:device_code`)

è¿™ç§æˆæƒæ¨¡å¼ä¸“ä¸ºè¾“å…¥èƒ½åŠ›å—é™æˆ–æ²¡æœ‰æµè§ˆå™¨çš„è®¾å¤‡è®¾è®¡ï¼Œæ¯”å¦‚æ™ºèƒ½ç”µè§†ã€æ¸¸æˆæœºã€IoTè®¾å¤‡æˆ–å‘½ä»¤è¡Œå·¥å…·ï¼ˆCLIï¼‰ã€‚

*   **å·¥ä½œåŸç†**ï¼šå…¶æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸¤æ­¥è¿‡ç¨‹ã€‚
    
    1.  **è®¾å¤‡è·å–ä»£ç **ï¼šè®¾å¤‡ä¸Šçš„åº”ç”¨é¦–å…ˆå‘æˆæƒæœåŠ¡å™¨ï¼ˆå¦‚ Microsoft Entra IDï¼‰çš„ `/devicecode` ç«¯ç‚¹å‘èµ·è¯·æ±‚ã€‚æœåŠ¡å™¨ä¼šè¿”å›ä¸€ç»„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸€ä¸ªç®€çŸ­çš„ `user_code`ï¼ˆç”¨æˆ·ä»£ç ï¼‰å’Œä¸€ä¸ª `verification_uri`ï¼ˆéªŒè¯ç½‘å€ï¼‰ã€‚
    2.  **ç”¨æˆ·æˆæƒ**ï¼šè®¾å¤‡å°† `user_code` å’Œ `verification_uri` æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œå¹¶æç¤ºç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ï¼ˆå¦‚ä¸ªäººæ‰‹æœºæˆ–ç”µè„‘ï¼‰ä¸Šæ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®è¯¥ç½‘å€å¹¶è¾“å…¥ä»£ç ã€‚ç”¨æˆ·åœ¨æˆæƒæœåŠ¡å™¨çš„æ­£è§„é¡µé¢ä¸Šå®Œæˆèº«ä»½éªŒè¯ï¼ˆå¯èƒ½åŒ…æ‹¬å¤šå› ç´ è®¤è¯ï¼‰å¹¶åŒæ„æˆæƒã€‚åœ¨æ­¤æœŸé—´ï¼Œè®¾å¤‡åº”ç”¨ä¼šå®šæœŸè½®è¯¢æˆæƒæœåŠ¡å™¨çš„ä»¤ç‰Œç«¯ç‚¹ï¼Œç›´åˆ°ç”¨æˆ·å®Œæˆæ“ä½œåè·å–è®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œã€‚
*   **å®‰å…¨é£é™©ä¸é˜²å¾¡**ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ­¤æµç¨‹å¯èƒ½è¢«ç”¨äºè¿›è¡Œé«˜è¿·æƒ‘æ€§çš„ç½‘ç»œé’“é±¼æ”»å‡»ï¼ˆç§°ä¸ºâ€œè®¾å¤‡ä»£ç é’“é±¼â€ï¼‰ã€‚æ”»å‡»è€…ä¼šè¯±å¯¼ç”¨æˆ·åœ¨çœŸå®çš„å¾®è½¯ç™»å½•é¡µé¢è¾“å…¥ç”±æ”»å‡»è€…ç”Ÿæˆçš„è®¾å¤‡ä»£ç ï¼Œä»è€Œæˆæƒä¸€ä¸ªæ¶æ„åº”ç”¨ã€‚é˜²å¾¡æªæ–½åŒ…æ‹¬åœ¨æœåŠ¡å™¨ç«¯ä¸¥æ ¼é™åˆ¶åº”ç”¨åŒæ„ç­–ç•¥ã€å®æ–½æ¡ä»¶è®¿é—®ç­–ç•¥ï¼ˆå¦‚è¦æ±‚æ¥è‡ªåˆè§„è®¾å¤‡ï¼‰ï¼Œä»¥åŠå¯¹ç”¨æˆ·è¿›è¡Œå®‰å…¨æ•™è‚²ã€‚
    

### ğŸ”„ ä»¤ç‰Œäº¤æ¢æˆæƒ (`urn:ietf:params:oauth:grant-type:token-exchange`)

ä»¤ç‰Œäº¤æ¢æˆæƒæä¾›äº†å¼ºå¤§çš„ interoperabilityï¼ˆäº’æ“ä½œæ€§ï¼‰ï¼Œå…è®¸å°†ä¸€ä¸ªå‡­è¯æˆ–ä»¤ç‰Œäº¤æ¢ä¸ºå¦ä¸€ä¸ªä¸åŒçš„ä»¤ç‰Œï¼Œå¸¸ç”¨äºæœåŠ¡ä¹‹é—´çš„å®‰å…¨è°ƒç”¨æˆ–èº«ä»½æ˜ å°„ã€‚

*   **æ ¸å¿ƒæ¦‚å¿µ**ï¼šå®ƒéµå¾ª OAuth Token Exchange è§„èŒƒï¼Œä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤Ÿä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„ `subject_token`ï¼ˆä¸»ä½“ä»¤ç‰Œï¼‰æ¥æ¢å–ä¸€ä¸ªæ–°çš„ã€é’ˆå¯¹ä¸åŒå—ä¼—æˆ–èµ„æºçš„ `access_token`ï¼ˆè®¿é—®ä»¤ç‰Œï¼‰ã€‚
    
*   **å¸¸è§åœºæ™¯**ï¼š
    
    *   **æœåŠ¡é—´è°ƒç”¨**ï¼šåç«¯æœåŠ¡Aå¯ä»¥ä½¿ç”¨è‡ªå·±æŒæœ‰çš„ä»¤ç‰Œï¼Œæ¢å–ä¸€ä¸ªå…·æœ‰é€‚å½“æƒé™çš„ã€ç”¨äºè°ƒç”¨æœåŠ¡Bçš„è®¿é—®ä»¤ç‰Œã€‚
    *   **æƒé™é™çº§**ï¼šä¸€ä¸ªé«˜æƒé™çš„åº”ç”¨åœ¨éœ€è¦è°ƒç”¨ä¸€ä¸ªä½ä¿¡ä»»åº¦çš„æœåŠ¡æ—¶ï¼Œå¯ä»¥æ¢ä¸€ä¸ªæƒé™å—é™çš„ä»¤ç‰Œï¼Œä»¥æå‡å®‰å…¨æ€§ã€‚
    *   **å¤–éƒ¨èº«ä»½æä¾›å•†é›†æˆ**ï¼šå°†å¤–éƒ¨IDPï¼ˆå¦‚Googleã€Facebookï¼‰ç­¾å‘çš„ä»¤ç‰Œäº¤æ¢ä¸ºå†…éƒ¨ç³»ç»Ÿçš„ä»¤ç‰Œï¼Œä»è€Œå®ç°è·¨åŸŸèº«ä»½è”åˆã€‚
    *   **ç”¨æˆ·æ¨¡æ‹Ÿ**ï¼šåœ¨ä¸¥æ ¼ç®¡æ§ä¸‹ï¼ŒæœåŠ¡å¯ä»¥æ¢å–ä¸€ä¸ªä»£è¡¨ç‰¹å®šç”¨æˆ·èº«ä»½çš„ä»¤ç‰Œï¼ˆå³æ¨¡æ‹Ÿç”¨æˆ·ï¼‰ã€‚
*   **å®æ–½è¦ç‚¹**ï¼šä»¤ç‰Œäº¤æ¢åŠŸèƒ½é€šå¸¸é»˜è®¤ä¸å¼€å¯ï¼Œéœ€è¦åœ¨æœåŠ¡å™¨ç«¯ï¼ˆå¦‚Red Hat Single Sign-Onï¼‰ä¸ºå®¢æˆ·ç«¯æ˜¾å¼é…ç½®ç²¾ç»†çš„æƒé™ç­–ç•¥ã€‚
    

### âš™ï¸ JWTæŒæœ‰è€…æˆæƒ (`urn:ietf:params:oauth:grant-type:jwt-bearer`)

è¿™ç§æˆæƒç±»å‹å…è®¸å®¢æˆ·ç«¯ç›´æ¥ä½¿ç”¨ä¸€ä¸ªé¢„å…ˆç­¾åçš„JWTï¼ˆJSON Web Tokenï¼‰ä½œä¸ºæ–­è¨€ï¼ˆassertionï¼‰æ¥è·å–è®¿é—®ä»¤ç‰Œã€‚

*   **åŸºæœ¬æµç¨‹**ï¼šå®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨çš„ä»¤ç‰Œç«¯ç‚¹å‘èµ·POSTè¯·æ±‚ï¼Œåœ¨è¯·æ±‚ä½“ä¸­ï¼Œ`grant_type` å‚æ•°è®¾ç½®ä¸º `urn:ietf:params:oauth:grant-type:jwt-bearer`ï¼Œå¹¶åŒæ—¶æä¾›ç”¨ä½œæ–­è¨€çš„ `assertion` å‚æ•°ï¼ˆå³JWTæœ¬èº«ï¼‰ã€‚æˆæƒæœåŠ¡å™¨ä¼šéªŒè¯è¯¥JWTçš„ç­¾åã€æœ‰æ•ˆæœŸã€é¢å‘è€…ç­‰ä¿¡æ¯ï¼ŒéªŒè¯é€šè¿‡åå³é¢å‘æ‰€è¯·æ±‚çš„è®¿é—®ä»¤ç‰Œã€‚
    
*   **å…¸å‹åº”ç”¨åœºæ™¯**ï¼š
    
    *   **æœåŠ¡è´¦æˆ·è®¤è¯**ï¼šåœ¨æœºå™¨å¯¹æœºå™¨ï¼ˆM2Mï¼‰çš„é€šä¿¡ä¸­ï¼Œä¸€ä¸ªæœåŠ¡å¯ä»¥ä½¿ç”¨äº‹å…ˆé…ç½®å¥½çš„JWTï¼ˆé€šå¸¸åŸºäºç§é’¥ç­¾åï¼‰æ¥è·å–è®¿é—®ä»¤ç‰Œï¼Œæ— éœ€ç”¨æˆ·äº¤äº’ã€‚è¿™åœ¨CI/CDæµæ°´çº¿æˆ–åå°æœåŠ¡ä¸­éå¸¸å¸¸è§ã€‚
    *   **å¾®æœåŠ¡æ¶æ„**ï¼šåœ¨å¾®æœåŠ¡ç½‘ç»œä¸­ï¼Œä¸€ä¸ªæœåŠ¡åœ¨æ”¶åˆ°è®¿é—®ä»¤ç‰Œåï¼Œå¯ä»¥åˆ©ç”¨æ­¤æµç¨‹å‘è®¤è¯æœåŠ¡å™¨æ¢å–ä¸€ä¸ªèŒƒå›´ï¼ˆscopeï¼‰æ›´çª„ã€ä¸“ç”¨äºè®¿é—®å¦ä¸€ä¸ªç‰¹å®šå¾®æœåŠ¡çš„ä»¤ç‰Œã€‚

ä¸‹é¢çš„è¡¨æ ¼æ¸…æ™°åœ°å¯¹æ¯”äº†è¿™ä¸‰ç§æˆæƒç±»å‹çš„å…³é”®å·®å¼‚ã€‚

ç‰¹æ€§

è®¾å¤‡ä»£ç æˆæƒ (`device_code`)

ä»¤ç‰Œäº¤æ¢æˆæƒ (`token-exchange`)

JWTæŒæœ‰è€…æˆæƒ (`jwt-bearer`)

**ä¸»è¦ç›®çš„**

æ–¹ä¾¿è¾“å…¥å—é™è®¾å¤‡ä¸Šçš„ç”¨æˆ·æˆæƒ

å®ç°ä»¤ç‰Œä¹‹é—´çš„å®‰å…¨è½¬æ¢å’Œèº«ä»½å§”æ‰˜

å®¢æˆ·ç«¯ä½¿ç”¨å·²æœ‰çš„JWTç›´æ¥è·å–è®¿é—®ä»¤ç‰Œ

**ä»¤ç‰Œæµ**

è½®è¯¢æœºåˆ¶

ç›´æ¥äº¤æ¢

æ–­è¨€å¼è¯·æ±‚

**å…¸å‹åº”ç”¨**

æ™ºèƒ½ç”µè§†ã€IoTè®¾å¤‡ã€CLIå·¥å…·

æœåŠ¡é—´è°ƒç”¨ã€æƒé™é™çº§ã€èº«ä»½è”åˆ

æœºå™¨å¯¹æœºå™¨é€šä¿¡ã€æœåŠ¡è´¦æˆ·ã€å¾®æœåŠ¡

### å¤„ç†æµç¨‹

sequenceDiagram participant Client participant WSO2APIM (Authorization Server) participant Keycloak (External IdP) Note over Client, Keycloak: å‡†å¤‡é˜¶æ®µ Client ->> Keycloak: 1. é€šè¿‡Keycloakè®¤è¯è·å–JWT Keycloak -->> Client: è¿”å›JWTï¼ˆæ–­è¨€ï¼‰ Note over Client, WSO2APIM: JWT Bearer Grant æµç¨‹ Client ->> WSO2APIM: 2. ä»¤ç‰Œè¯·æ±‚ (grant\_type=jwt-bearer, assertion=JWT) WSO2APIM ->> WSO2APIM: 3. éªŒè¯JWTç­¾åã€æœ‰æ•ˆæœŸã€é¢å‘è€… WSO2APIM ->> WSO2APIM: 4. æå–èº«ä»½/å£°æ˜ï¼ˆå¦‚sub, audï¼‰ WSO2APIM ->> WSO2APIM: 5. æ ¹æ®JWTä¸­çš„ä¿¡æ¯åˆ›å»ºä¼šè¯å¹¶é¢å‘è‡ªèº«çš„è®¿é—®ä»¤ç‰Œ WSO2APIM -->> Client: 6. è¿”å›WSO2 APIMçš„è®¿é—®ä»¤ç‰Œ

### ğŸ’ æ€»ç»“ä¸å®‰å…¨è€ƒé‡

é€‰æ‹©å“ªç§æˆæƒç±»å‹å®Œå…¨å–å†³äºä½ çš„å…·ä½“åº”ç”¨åœºæ™¯ã€‚è®¾å¤‡ä»£ç æˆæƒä¼˜åŒ–äº†å—é™è®¾å¤‡çš„ç”¨æˆ·ä½“éªŒï¼Œä»¤ç‰Œäº¤æ¢æˆæƒä¸ºå¤æ‚çš„æœåŠ¡é—´ä¿¡ä»»é“¾æä¾›äº†çµæ´»æ€§ï¼Œè€ŒJWTæŒæœ‰è€…æˆæƒåˆ™æ˜¯æœºå™¨å¯¹æœºå™¨é€šä¿¡çš„ç®€æ´é«˜æ•ˆæ–¹æ¡ˆã€‚

åœ¨å®æ–½è¿™äº›æˆæƒæµç¨‹æ—¶ï¼ŒåŠ¡å¿…å…³æ³¨ä»¥ä¸‹å®‰å…¨æœ€ä½³å®è·µï¼š

*   **ä¸¥æ ¼æ§åˆ¶æƒé™**ï¼šéµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œåªä¸ºåº”ç”¨æˆäºˆå…¶å¿…éœ€çš„æœ€å°‘æƒé™ã€‚
*   **éªŒè¯ä¸ç›‘æ§**ï¼šæœåŠ¡å™¨ç«¯å¿…é¡»ä¸¥æ ¼éªŒè¯æ‰€æœ‰ä»¤ç‰Œå’Œæ–­è¨€ï¼ˆå¦‚JWTçš„ç­¾åå’Œæœ‰æ•ˆæœŸï¼‰ï¼Œå¹¶å»ºç«‹æ—¥å¿—å®¡è®¡å’Œå¼‚å¸¸è¡Œä¸ºç›‘æ§æœºåˆ¶ã€‚
*   **ä¿æŠ¤ä»¤ç‰Œ**ï¼šè®¿é—®ä»¤ç‰Œå’Œåˆ·æ–°ä»¤ç‰Œæ˜¯æ•æ„Ÿå‡­è¯ï¼Œåœ¨ä¼ è¾“å’Œå­˜å‚¨è¿‡ç¨‹ä¸­å¿…é¡»åŠ ä»¥ä¿æŠ¤ã€‚

wso2ä¸­çš„å®æˆ˜
========

wso2 spçš„é…ç½®
----------

é…ç½®è®¤è¯grant\_typeç±»å‹

![å›¾ç‰‡](https://img2024.cnblogs.com/blog/118538/202601/118538-20260126132653488-1051084105.png)

keycloak idpçš„é…ç½®
---------------

> keycloakä¸­ä¸ºå®¢æˆ·ç«¯å¼€å¯rolesä¹‹åï¼Œå¦‚æœæœ‰ç”¨æˆ·æœ‰å®¢æˆ·ç«¯çš„è§’è‰²ï¼Œä¼šåœ¨jwtä¸­å¤šå‡ºæ¥audæ•°ç»„å­—æ®µï¼Œä¹Ÿå¯ä»¥ä¸ºwso2å®¢æˆ·ç«¯æ·»åŠ è‡ªå®šä¹‰çš„client scopeï¼Œç„¶åä¸ºå®ƒæ·»åŠ audçš„cliams

IDPåç§°å¿…é¡»ä¸IDPä¸­tokençš„Issuerç›¸åŒ

![å›¾ç‰‡](https://img2024.cnblogs.com/blog/118538/202601/118538-20260126162025923-968169912.png)

æµ‹è¯•
--

    curl -X POST 'https://test-apim.xxx.com/oauth2/token' -H 'Content-Type: application/json' -H 'Content-Type: application/json' -u 'wso2-sp-client-id:wso2-sp-client-secret' --basic -d '{
        "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
        "assertion": "abc.abc.abc",
        "scope": "openid apim:subscribe"
    }'
    

å¦‚æœkeycloak\_tokenè¿‡æœŸï¼Œå°±è¿”å›è¿™ä¸ª400é”™è¯¯

    {
      "error_description": "JSON Web Token is expired., Expiration Time(ms) : 1769413736000, TimeStamp Skew : 0, Current Time : 1769413748585. JWT Rejected and validation terminated",
      "error": "invalid_grant"
    }
    

å¦‚æœæˆåŠŸï¼Œä¼šè¿”wso2å¹³å°çš„token

    {
      "access_token": "8b23bf56-f8d2-33fa-9962-f298a797ce94",
      "refresh_token": "aad2555-30b0-3591-8c70-b2cdc042cc41",
      "scope": "apim:subscribe openid",
      "id_token": "",
      "token_type": "Bearer",
      "expires_in": 3185
    }
    

ç”¨æˆ·ç™»å½•æˆåŠŸåï¼Œä¼šåˆå§‹åŒ–ç”¨æˆ·è¡¨ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§`urn:ietf:params:oauth:grant-type:jwt-bearer`é¦–æ¬¡ç™»å½•æ·»åŠ çš„ç”¨æˆ·ï¼Œå®ƒä½äº`wso2am_db.idn_auth_user`è¡¨ï¼Œuser\_nameåŒæ ·æ˜¯ä¸‰æ–¹ç¤¾åŒºtokenä¸­çš„`sub`å­—æ®µï¼›è€Œæ ‡å‡†oauthçš„æˆæƒç è®¤è¯åï¼Œé™¤äº†åœ¨`wso2am_db.idn_auth_user`è¡¨åˆå§‹åŒ–å¤–ï¼Œè¿˜åœ¨`wso2am_share_db.um_user`è¡¨ä¹Ÿä¼šæ·»åŠ ä¸€ä»½ç”¨æˆ·æ•°æ®ã€‚

ä½œè€…ï¼šä»“å‚¨å¤§å”ï¼Œå¼ å å²­ï¼Œ  
è£èª‰ï¼šå¾®è½¯MVP  
QQï¼š853066980

**æ”¯ä»˜å®æ‰«ä¸€æ‰«ï¼Œä¸ºå¤§å”æ‰“èµ!**  
![](https://images.cnblogs.com/cnblogs_com/lori/237884/o_IMG_7144.JPG)