---
layout: post
title: 'SQLCipheræ•°æ®è¿ç§»åˆ°PostgreSqlè¯¦ç»†æ”»ç•¥'
date: "2025-09-24T00:39:42Z"
---
SQLCipheræ•°æ®è¿ç§»åˆ°PostgreSqlè¯¦ç»†æ”»ç•¥
----------------------------

æ­¥éª¤ä¸€ã€å®‰è£…Docker
------------

*   Windows11 å®‰è£…Dockerå®¢æˆ·ç«¯æ•™ç¨‹ï¼šè‡ªå·±ç™¾åº¦ä¸€ä¸‹ã€‚

æ­¥éª¤äºŒã€SQLCipherè§£å¯†ï¼Œè½¬æ¢ä¸ºSqlite3
--------------------------

*   è®¿é—®[å®˜ç½‘](https://sqlitebrowser.org/dl/)è¿›è¡Œä¸‹è½½
*   ä½¿ç”¨DB Browser (SQLCipher) å®¢æˆ·è®¿é—®æ•°æ®åº“æ–‡ä»¶åï¼Œç‚¹å¼€èœå•æ  â€œå·¥å…·â€ --> "è®¾ç½®åŠ å¯†"ï¼Œå¯†ç ç½®ç©ºåï¼Œå³å¯è¿›è¡Œè§£å¯†ï¼Œè‡ªåŠ¨å°†SQLCipherè½¬æ¢ä¸ºSqlite3ã€‚
*   æ³¨æ„ï¼šè¿™ä¸ªè§£å¯†çš„è¿‡ç¨‹è€—æ—¶æ¯”è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼›

æ­¥éª¤ä¸‰ã€å°†Sqliteä¸­çš„æ•°æ®è¿ç§»åˆ°PostgreSqlä¸­
-----------------------------

#### 1\. Dockerå®‰è£…PostgreSql

    docker run --name my_postgres \
      -e POSTGRES_PASSWORD=mysecretpassword \  # è®¾ç½®è¶…çº§ç”¨æˆ·å¯†ç ï¼ŒåŠ¡å¿…ä¿®æ”¹
      -p 5432:5432 \                           # æ˜ å°„ä¸»æœºç«¯å£ 5432 åˆ°å®¹å™¨ç«¯å£ 5432
      -v pgdata:/var/lib/postgresql/data \     # ä½¿ç”¨å‘½åå· pgdata æŒä¹…åŒ–æ•°æ®
      -d \                                     # åå°è¿è¡Œå®¹å™¨
      postgres                                 # ä½¿ç”¨å®˜æ–¹é•œåƒ
    

*   `-e POSTGRES_PASSWORD=mysecretpassword`: â€‹**åŠ¡å¿…ä¿®æ”¹**â€‹ `mysecretpassword`ä¸ºä½ è‡ªå·±è®¾å®šçš„å¼ºå¯†ç ï¼Œè¿™æ˜¯é»˜è®¤çš„è¶…çº§ç”¨æˆ· `postgres`çš„å¯†ç ã€‚
*   `-v pgdata:/var/lib/postgresql/data`: è¿™é‡Œçš„ `pgdata`æ˜¯ Docker ç®¡ç†çš„**å‘½åå·ï¼ˆNamed Volumeï¼‰â€‹**çš„åç§°ã€‚å¦‚æœè¯¥å·ä¸å­˜åœ¨ï¼ŒDocker ä¼šè‡ªåŠ¨åˆ›å»ºå®ƒã€‚æ•°æ®ä¼šå­˜å‚¨åœ¨ Docker çš„ç®¡ç†åŒºåŸŸï¼ˆä¾‹å¦‚ `/var/lib/docker/volumes/`ï¼‰ï¼Œä¸å®¹å™¨ç”Ÿå‘½å‘¨æœŸåˆ†ç¦»ï¼Œä»è€Œå®ç°æŒä¹…åŒ–ã€‚
*   ä½¿ç”¨ `docker volume ls`å¯ä»¥æŸ¥çœ‹æ‰€æœ‰å·²åˆ›å»ºçš„å‘½åå·ã€‚
*   å¢åŠ  `--restart=unless-stopped` å¯ä»¥è‡ªåŠ¨å¯åŠ¨å®¹å™¨ï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ã€‚

#### 2\. æ‹‰å–pgloaderé•œåƒ

    docker pull ghcr.io/dimitri/pgloader:latest
    

#### 3\. å‡†å¤‡è¿ç§»è„šæœ¬ migration.load

    LOAD DATABASE
        FROM sqlite:////data/main_data.db
        INTO postgresql://postgres:123456@host.docker.internal:5432/main
    
    WITH include drop, create tables, create indexes, reset sequences, foreign keys,
         workers = 8, concurrency = 1
    
    ALTER SCHEMA 'main' RENAME TO 'public'
    
    BEFORE LOAD DO
    $$ create schema if not exists public; $$;
    

**ğŸ”” å‚æ•°è¯´æ˜**â€‹ï¼š

*   â€‹`FROM`: SQLite æºæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚è¿™é‡Œä½¿ç”¨äº† `sqlite:///`å‰ç¼€ï¼Œåæ¥æ–‡ä»¶è·¯å¾„ã€‚è¯·æ³¨æ„ï¼Œå³ä½¿SQLiteæ•°æ®åº“æœ‰å¯†ç ï¼ˆä½ è¿æ¥å­—ç¬¦ä¸²ä¸­çš„`Password=E32CE1F29B6745F984DA86FBC0159F9F`ï¼‰ï¼Œâ€‹**pgloaderå¯¹SQLiteçš„æ”¯æŒç›®å‰å¯èƒ½ä¸ç›´æ¥æ”¯æŒé€šè¿‡è¿æ¥å­—ç¬¦ä¸²ä¼ é€’å¯†ç **ã€‚ä½ å¯èƒ½éœ€è¦å…ˆä½¿ç”¨SQLiteå·¥å…·è§£å¯†æ•°æ®åº“æˆ–å¯»æ‰¾å…¶ä»–æ–¹æ³•ï¼ˆå¦‚ä¸´æ—¶ç§»é™¤å¯†ç ï¼‰å†è¿›è¡Œè¿ç§»ã€‚`/`æ˜¯è·¯å¾„åˆ†éš”ç¬¦ï¼Œ`D:/NewData/main_data.db`æ˜¯ä½ çš„æ•°æ®åº“æ–‡ä»¶è·¯å¾„ã€‚
    
*   â€‹`INTO`: PostgreSQL ç›®æ ‡æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ã€‚æ ¼å¼ä¸º `postgresql://username:password@host:port/database_name`ã€‚
    
*   â€‹`WITH` å­å¥ï¼š
    
    *   `include drop`: è¿ç§»å‰åˆ é™¤ç›®æ ‡æ•°æ®åº“ä¸­å·²å­˜åœ¨çš„åŒåè¡¨ï¼ˆ**âš ï¸è°¨æ…ä½¿ç”¨ï¼Œä¼šæ¸…é™¤ç°æœ‰æ•°æ®ï¼â€‹**â€‹ å¦‚æœ `scan_spec`æ•°æ®åº“æ˜¯æ–°åˆ›å»ºçš„æˆ–å¯æ¸…ç©ºï¼Œåˆ™ä½¿ç”¨æ­¤é€‰é¡¹ï¼›è‹¥éœ€ä¿ç•™ç°æœ‰æ•°æ®ï¼Œè¯·ç§»é™¤æ­¤é€‰é¡¹ï¼‰ã€‚
    *   `create tables`: åœ¨PostgreSQLä¸­åˆ›å»ºè¡¨ã€‚
    *   `create indexes`: åˆ›å»ºç´¢å¼•ã€‚
    *   `reset sequences`: é‡ç½®åºåˆ—ï¼ˆä¾‹å¦‚è‡ªå¢ä¸»é”®çš„åºåˆ—ï¼‰ã€‚
    *   `foreign keys`: åˆ›å»ºå¤–é”®çº¦æŸã€‚
    *   `workers = 8`: ä½¿ç”¨8ä¸ªå·¥ä½œçº¿ç¨‹åŠ é€Ÿè¿ç§»ï¼ˆå¯æ ¹æ®CPUæ ¸å¿ƒæ•°è°ƒæ•´ï¼‰ã€‚
    *   `concurrency = 1`: æ§åˆ¶å¹¶å‘åº¦ã€‚
*   â€‹`ALTER SCHEMA`: SQLite æ²¡æœ‰æ¨¡å¼æ¦‚å¿µï¼Œå…¶è¡¨é€šå¸¸å¯è§†ä¸ºåœ¨ `main`æ¨¡å¼ä¸­ã€‚æ­¤å‘½ä»¤åœ¨è¿ç§»åå°†æ¨¡å¼åæ”¹ä¸º PostgreSQL é»˜è®¤çš„ `public`ã€‚
    
*   â€‹`BEFORE LOAD DO`: è¿ç§»å‰æ‰§è¡Œçš„ SQL è¯­å¥ï¼Œè¿™é‡Œç¡®ä¿ `public`æ¨¡å¼å­˜åœ¨ã€‚
    

#### 4\. æ‰§è¡Œè¿ç§»

ä½¿ç”¨ Docker è¿è¡Œ `pgloader`å¹¶æ‰§è¡Œè¿ç§»è„šæœ¬ã€‚â€‹**æ³¨æ„å°† `/path/to/your/migration.load` æ›¿æ¢ä¸ºä½ å®é™…çš„ `migration.load`æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚`/path/to/your/data` æ›¿æ¢ä¸ºä½ å®é™…çš„ db æ–‡ä»¶çš„æ‰€åœ¨ç›®å½•ã€‚**

    docker run --rm -v /path/to/your/migration.load:/migration.load -v /path/to/your/data:/data ghcr.io/dimitri/pgloader:latest pgloader /migration.load
    

**ğŸ”” å‘½ä»¤è¯´æ˜**â€‹ï¼š

*   `--rm`: å®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤ã€‚
    
*   `-v /path/to/your/migration.load:/migration.load`: å°†å®¿ä¸»æœºä¸Šçš„åŠ è½½è„šæœ¬æŒ‚è½½åˆ°å®¹å™¨å†…ã€‚
    
*   `-v /path/to/your/data:/data`: å°†åŒ…å«ä½  SQLite æ•°æ®åº“æ–‡ä»¶çš„ç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…çš„ `/data`ç›®å½•ï¼Œç¡®ä¿å®¹å™¨å†…çš„ pgloader èƒ½è®¿é—®åˆ° `/path/to/your/data/main_data.db` æ–‡ä»¶ï¼ˆå› æ­¤åœ¨.loadæ–‡ä»¶ä¸­ï¼Œè·¯å¾„å¯ä»¥å†™ä¸º `sqlite:////data/main_data.db`ï¼Œä½†ä¸Šè¿°è„šæœ¬å·²ä½¿ç”¨å®¿ä¸»æœºç»å¯¹è·¯å¾„ï¼Œæ­¤æŒ‚è½½æ˜¯ä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼‰ã€‚
    
*   `ghcr.io/dimitri/pgloader:latest`: pgloader çš„ Docker é•œåƒã€‚
    
*   `pgloader /migration.load`: åœ¨å®¹å™¨å†…è¿è¡Œçš„å‘½ä»¤ï¼Œæ‰§è¡Œè¿ç§»è„šæœ¬ã€‚
    

æ­¥éª¤å››ã€ç‰¹åˆ«æ³¨æ„
--------

ç”±äº Pgloader åœ¨å°† SQLite çš„ `INTEGER` ç±»å‹ï¼ˆåœ¨ SQLite ä¸­é€šå¸¸ç”¨æ¥è¡¨ç¤ºå¸ƒå°”å€¼ï¼Œ0 æˆ– 1ï¼‰è¿ç§»åˆ° PostgreSQL æ—¶ï¼Œå°†å®ƒæ˜ å°„æˆäº† PostgreSQL çš„ `BIT` ç±»å‹ï¼Œè€Œä¸æ˜¯ `BOOLEAN` æˆ– `INTEGER`ã€‚PostgreSQL çš„ `BIT` ç±»å‹æ˜¯ä½å­—ç¬¦ä¸²ç±»å‹ï¼Œå®ƒå’Œ `INTEGER` ç±»å‹æ— æ³•ç›´æ¥è¿›è¡Œ `=` æ¯”è¾ƒã€‚æ‰€ä»¥å½“ä½ æ‰§è¡Œ `"isdelete" = 0` æ—¶ï¼ŒPostgreSQL å°±ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒ `BIT` å’Œ `INTEGER` çš„æ“ä½œç¬¦ã€‚æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š

    SQL é”™è¯¯ [42883]: ERROR: operator does not exist: bit = integer
    Hint: No operator matches the given name and argument types. You might need to add explicit type casts.
    

æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†æ•°æ®åº“ä¸­æ‰€æœ‰`bit(1)`ç±»å‹çš„å­—æ®µè½¬æ¢æˆ`boolean`ç±»å‹ï¼Œä½†æ˜¯PostgreSqlä¸­è¿™ä¸¤ä¸ªç±»å‹ä¸èƒ½ç›´æ¥è½¬æ¢ï¼Œæ‰€ä»¥è¦å…ˆå°†`bit(1)`å…ˆè½¬æˆ `integer` å†è½¬æˆ `boolean`ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå¯ä»¥å®Œæˆè¿™ä¸ªä»»åŠ¡çš„ PostgreSQL PL/pgSQL ä»£ç å—ã€‚ä½ å¯ä»¥å°†å…¶ä½œä¸ºä¸€ä¸ªåŒ¿åä»£ç å— (`DO` è¯­å¥) åœ¨ psql æˆ–ä»»ä½• PostgreSQL å®¢æˆ·ç«¯ä¸­è¿è¡Œã€‚

    DO $$
    
    DECLARE
    rec RECORD;
    table_name TEXT;
    column_name TEXT;
    alter_sql TEXT;
    
    BEGIN
    
    -- éå†æ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„æ¨¡å¼ï¼ˆpublicï¼‰
    FOR rec IN
    SELECT
    c.table_schema,
    c.table_name,
    c.column_name
    FROM
    information_schema.columns c
    WHERE
    c.table_schema = 'public' -- åªåœ¨ public æ¨¡å¼ä¸‹æŸ¥æ‰¾ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ›´æ”¹
    AND c.data_type = 'bit'
    AND c.character_maximum_length = 1
    LOOP
    table_name := rec.table_name;
    column_name := rec.column_name;
    RAISE NOTICE 'æ­£åœ¨å¤„ç†è¡¨: %, åˆ—: %', table_name, column_name;
    
    -- æ„é€  ALTER TABLE è¯­å¥ï¼Œå…ˆè½¬æˆ integer
    alter_sql := format('ALTER TABLE %I.%I ALTER COLUMN %I TYPE INTEGER USING %I::integer;',
    rec.table_schema, table_name, column_name, column_name);
    
    -- æ‰§è¡Œ SQL
    EXECUTE alter_sql;
    
    -- æ„é€  ALTER TABLE è¯­å¥ï¼Œå†è½¬æˆ boolean
    alter_sql := format('ALTER TABLE %I.%I ALTER COLUMN %I TYPE BOOLEAN USING %I::boolean;',
    rec.table_schema, table_name, column_name, column_name);
    
    -- æ‰§è¡Œ SQL
    EXECUTE alter_sql;
    END LOOP;
    RAISE NOTICE 'æ‰€æœ‰ bit(1) å­—æ®µè½¬æ¢å®Œæˆã€‚';
    END $$;
    

åˆ°æ­¤ï¼ŒSQLiteçš„æ•°æ®å·²ç»å…¨éƒ¨è¿ç§»åˆ°PostgreSqlå•¦~

posted on 2025-09-23 14:24Â  [Godå†™æ³¨é‡Šæ²¡æœ‰ä»£ç ](https://www.cnblogs.com/tony-god)Â  é˜…è¯»(67)Â  è¯„è®º(0)Â  Â  [æ”¶è—](javascript:void\(0\))Â  [ä¸¾æŠ¥](javascript:void\(0\))