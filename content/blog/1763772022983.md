---
layout: post
title: 'å¯¹ .NET FileSystemWatcherå¼•å‘å†…å­˜ç¢ç‰‡åŒ–çš„ åæ€'
date: "2025-11-22T00:40:22Z"
---
å¯¹ .NET FileSystemWatcherå¼•å‘å†…å­˜ç¢ç‰‡åŒ–çš„ åæ€
===================================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰äº›å¤©åˆé‡åˆ°äº†ä¸€ä¾‹ FileSystemWatcher å¼•å‘çš„å†…å­˜ç¢ç‰‡åŒ–æ•…éšœï¼Œä½†è¿™ä¸ªç¢ç‰‡åŒ–ä¸æ˜¯å› ä¸ºç»å…¸çš„ `reloadOnChange=true` å¯¼è‡´çš„ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—æœ‰å¿…è¦åšä¸€æ¬¡æ·±åº¦çš„åæ€ï¼Œä¾›ä»¥åé‡åˆ°ç±»ä¼¼é—®é¢˜æä¾›æŠ€æœ¯ä¸Šçš„è§£å†³æ–¹æ³•ï¼Œè¿™ç¯‡æˆ‘ä»¬å°±æ¥ç³»ç»Ÿçš„è®²è§£ä¸‹ ä¸¤ç§ç¢ç‰‡åŒ–æ–¹å¼çš„è°ƒæŸ¥æ–¹æ³•ã€‚

äºŒï¼šç»å…¸çš„ FileSystemWatcher ç¢ç‰‡åŒ–
---------------------------

### 1\. æµ‹è¯•ä»£ç 

è¿™ç§ç¢ç‰‡åŒ–æ˜¯ç”± `reloadOnChange=true` å¼•å‘çš„ï¼Œç¥¸æ ¹ä¸»è¦æ˜¯ç¨‹åºå‘˜å°† .netframework è¯»å–é…ç½®æ–‡ä»¶çš„æ–¹å¼å¥—åœ¨äº† .net ä¸Šï¼Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œå…ˆä¸Šä¸€æ®µæµ‹è¯•ä»£ç ã€‚

    
        internal class Program
        {
            static void Main(string[] args)
            {
                for (int i = 0; i < 100000; i++)
                {
                    IConfiguration configuration = BuildConfiguration();
                    string appName = configuration["AppName"];
                    Console.WriteLine($"i={i} åº”ç”¨åç§°: {appName}");
                }
    
                Console.ReadLine();
            }
    
            static IConfiguration BuildConfiguration()
            {
                return new ConfigurationBuilder()
                    .SetBasePath(Directory.GetCurrentDirectory())
                    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
                    .Build();
            }
        }
    
    

å¦ä¸­çš„ä»£ç éå¸¸ç®€å•ï¼Œå°±æ˜¯æ¯æ¬¡è¯»å– AppName æ—¶éƒ½è°ƒäº†ä¸€ä¸‹ BuildConfiguration æ–¹æ³•ï¼Œä»…æ­¤è€Œå·²ï¼Œä½†å°†ç¨‹åºè·‘èµ·æ¥ä¹‹åï¼Œå±…ç„¶å‘ç°ç¨‹åºåƒäº† `2.2G` çš„å†…å­˜ï¼ŒçœŸæ˜¯æ²¡è¾¹çš„äº‹ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251121111955829-393023032.png)

ä¸ºäº†æ‰¾å‡ºåŸå› ï¼Œä¸Š windbg é™„åŠ ï¼Œä½¿ç”¨ `!dumpheap -stat` è§‚å¯Ÿæ‰˜ç®¡å †ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251121111955806-5408484.png)

ä»å¦ä¸­å¯ä»¥çœ‹åˆ°ä¸¤ç‚¹ä¿¡æ¯ï¼š

1.  Free ç‹¬å  `1.39G`,è¿™æ˜¯ç»å…¸çš„å†…å­˜ç¢ç‰‡åŒ–ã€‚
2.  FileSystemWatcher é«˜è¾¾ 1290 ä¸ªï¼Œè¡¨æ˜ç¨‹åºå­˜åœ¨å¤§é‡çš„æ–‡ä»¶ç›‘æ§ã€‚

çœ‹åˆ°ä¸Šé¢ä¸¤ç‚¹ä¿¡æ¯ï¼Œä¸€å®šè¦æœ‰æ¡ä»¶åå°„ï¼Œæ˜¯ä¸æ˜¯ `reloadOnChange: true` å¯¼è‡´çš„ã€‚

### 2\. æ˜¯ reloadOnChange å¯¼è‡´çš„å—

è¦æƒ³æ‰¾åˆ°ç­”æ¡ˆï¼Œå¯ä»¥æ·±æŒ– `Microsoft.Extensions.Configuration.ConfigurationRoot` ç±»ï¼Œå³ä»£ç  `BuildConfiguration();` çš„è¿”å›ç±»å‹ï¼Œä¸ºäº†æ–¹ä¾¿å¯è§†åŒ–è§‚å¯Ÿï¼Œæˆ‘ç”¨ vs ç›´æ¥æ‰¾ä¸‹ç»™å¤§å®¶çœ‹çœ‹ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251121111955812-1604614285.png)

æœ‰äº†è¿™ä¸ªè„‰ç»œï¼Œå°±å¯ä»¥ä½¿ç”¨ windbg ä¸‹é’»è§‚å¯Ÿï¼Œæœ€ç»ˆå°±æ‰¾åˆ°äº† `<ReloadOnChange>k__BackingField = 1` çš„é“è¯ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

    
    0:008> !dumpobj /d 17dd2f41fa0
    Name:        Microsoft.Extensions.Configuration.ConfigurationRoot
    MethodTable: 00007ff9d8707a48
    EEClass:     00007ff9d86e97b0
    Tracked Type: false
    Size:        40(0x28) bytes
    File:        D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.dll
    Fields:
                  MT    Field   Offset                 Type VT     Attr            Value Name
    00007ff9d8706c48  4000016        8 ...on.Abstractions]]  0 instance 0000017dd2f3e520 _providers
    00007ff9d880ba28  4000017       10 ...Private.CoreLib]]  0 instance 0000017dd2f42018 _changeTokenRegistrations
    00007ff9d8708940  4000018       18 ...rationReloadToken  0 instance 0000017dd2f41fc8 _changeToken
    0:008> !DumpObj /d 0000017dd2f3e520
    Name:        System.Collections.Generic.List`1[[Microsoft.Extensions.Configuration.IConfigurationProvider, Microsoft.Extensions.Configuration.Abstractions]]
    MethodTable: 00007ff9d87069d0
    EEClass:     00007ff9d86a10f8
    Tracked Type: false
    Size:        32(0x20) bytes
    File:        C:\Program Files\dotnet\shared\Microsoft.NETCore.App\8.0.22\System.Private.CoreLib.dll
    Fields:
                  MT    Field   Offset                 Type VT     Attr            Value Name
    00007ff9d891d1a0  400226e        8     System.__Canon[]  0 instance 0000017dd2f41f68 _items
    00007ff9d8551188  400226f       10         System.Int32  1 instance                1 _size
    00007ff9d8551188  4002270       14         System.Int32  1 instance                1 _version
    00007ff9d891d1a0  4002271        8     System.__Canon[]  0   static dynamic statics NYI                 s_emptyArray
    0:008> !DumpArray /d 0000017dd2f41f68
    Name:        Microsoft.Extensions.Configuration.IConfigurationProvider[]
    MethodTable: 00007ff9d8707cf0
    EEClass:     00007ff9d851c440
    Size:        56(0x38) bytes
    Array:       Rank 1, Number of elements 4, Type CLASS
    Element Methodtable: 00007ff9d8706938
    [0] 0000017dd2f3e540
    [1] null
    [2] null
    [3] null
    0:008> !DumpObj /d 0000017dd2f3e540
    Name:        Microsoft.Extensions.Configuration.Json.JsonConfigurationProvider
    MethodTable: 00007ff9d8708200
    EEClass:     00007ff9d86e9ab8
    Tracked Type: false
    Size:        48(0x30) bytes
    File:        D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.Json.dll
    Fields:
                  MT    Field   Offset                 Type VT     Attr            Value Name
    00007ff9d8708940  4000012        8 ...rationReloadToken  0 instance 0000017dd2f437e0 _reloadToken
    00007ff9d8708cf0  4000013       10 ...Private.CoreLib]]  0 instance 0000017dd2f42298 <Data>k__BackingField
    00007ff9d8662820  4000005       18   System.IDisposable  0 instance 0000017dd2f3e690 _changeTokenRegistration
    00007ff9d8701b98  4000006       20 ...nfigurationSource  0 instance 0000017dd2f3e4b8 <Source>k__BackingField
    0:008> !DumpObj /d 0000017dd2f3e4b8
    Name:        Microsoft.Extensions.Configuration.Json.JsonConfigurationSource
    MethodTable: 00007ff9d8701c88
    EEClass:     00007ff9d86e7868
    Tracked Type: false
    Size:        48(0x30) bytes
    File:        D:\travels\src\Example\Example_0_1\bin\Debug\net8.0\Microsoft.Extensions.Configuration.Json.dll
    Fields:
                  MT    Field   Offset                 Type VT     Attr            Value Name
    00007ff9d86d8188  4000007        8 ...ers.IFileProvider  0 instance 0000017dd2f3e230 <FileProvider>k__BackingField
    00007ff9d85cec08  4000008       10        System.String  0 instance 0000017d00100510 <Path>k__BackingField
    00007ff9d851d070  4000009       24       System.Boolean  1 instance                0 <Optional>k__BackingField
    00007ff9d851d070  400000a       25       System.Boolean  1 instance                1 <ReloadOnChange>k__BackingField
    00007ff9d8551188  400000b       20         System.Int32  1 instance              250 <ReloadDelay>k__BackingField
    00007ff9d8708420  400000c       18 ....FileExtensions]]  0 instance 0000000000000000 <OnLoadException>k__BackingField
    
    

ä¸‰ï¼šéç»å…¸çš„ FileSystemWatcher ç¢ç‰‡åŒ–
----------------------------

### 1\. æµ‹è¯•ä»£ç 

æœ‰çš„æ—¶å€™ä¼šå‡ºç° `FileSystemWatcher` å¾ˆå°‘ï¼Œä½† overlapped å¾ˆå¤šçš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µå¾ˆå¤§æ¦‚ç‡ä¸æ˜¯ `reloadOnChange: true` å¯¼è‡´çš„ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251121111955825-1579330148.png)

åƒè¿™ç§æƒ…å†µå¯èƒ½å°±éœ€è¦å¼€å¯è¿½è¸ªäº†ï¼Œå¯ä»¥å€ŸåŠ©ğŸ‚ğŸ‘ƒçš„harmony æå®šï¼Œé‚£å¦‚ä½•åšå‘¢ï¼Ÿå¯ä»¥é’©ä½ `FileSystemWatcher` çš„æ‰€æœ‰æ„é€ å‡½æ•°ï¼Œé€šè¿‡è®°å½•è°ƒç”¨æ ˆæ¥è§‚å¯Ÿåˆ°åº•æ˜¯ä»€ä¹ˆä»£ç è°ƒç”¨çš„ï¼Œä»è€Œå¯»æ‰¾ç¥¸æ ¹ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
        internal class Program
        {
            static void Main(string[] args)
            {
                var harmony = new Harmony("com.example.fswatcher");
                harmony.PatchAll();
    
                for (int i = 0; i < 5; i++)
                {
                    IConfiguration configuration = BuildConfiguration();
                    string appName = configuration["AppName"];
                    Console.WriteLine($"i={i} åº”ç”¨åç§°: {appName}");
                }
    
                Console.ReadLine();
            }
    
            static IConfiguration BuildConfiguration()
            {
                return new ConfigurationBuilder()
                    .SetBasePath(Directory.GetCurrentDirectory())
                    .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
                    .Build();
            }
        }
    
        [HarmonyPatch]
        public class FileSystemWatcherConstructorsPatch
        {
            [HarmonyTargetMethod]
            static IEnumerable<MethodBase> TargetMethods()
            {
                // ä¸€æ¬¡æ€§è·å–æ‰€æœ‰å…¬å…±å®ä¾‹æ„é€ å‡½æ•°
                return typeof(FileSystemWatcher).GetConstructors(BindingFlags.Public | BindingFlags.Instance);
            }
    
            [HarmonyPostfix]
            public static void Postfix(FileSystemWatcher __instance)
            {
                Console.WriteLine($"[Harmony] FileSystemWatcher æ„é€ å‡½æ•°è¢«è°ƒç”¨");
                Console.WriteLine($"[Harmony] è·¯å¾„: '{__instance.Path ?? "null"}', è¿‡æ»¤å™¨: '{__instance.Filter ?? "null"}'");
                Console.WriteLine($"[Harmony] è°ƒç”¨æ ˆ:");
                Console.WriteLine(Environment.StackTrace);
            }
        }
    
    

![](https://img2024.cnblogs.com/blog/214741/202511/214741-20251121111955815-142625454.png)

ä»å¦ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒåŸæ¥è¿™ä¸ª `FileSystemWatcher` æ˜¯æˆ‘ä»¬çš„ç”¨æˆ·ä»£ç  `BuildConfiguration` æçš„å“ˆï¼Œè¿™å°±æå¤§çš„ç¼©å°çš„åŒ…å›´åœˆï¼Œä»è€Œå¿«é€Ÿå®šä½ç¥¸æ ¹ã€‚

å››ï¼šæ€»ç»“
----

å¾ˆå¤šçš„å†…å­˜ç¢ç‰‡åŒ–å¾€å¾€éƒ½èƒ½çœ‹åˆ° FileSystemWatcher çš„èº«å½±ï¼Œå¸Œæœ›è¿™ç¯‡çš„åæ€å’Œæ€»ç»“èƒ½ç»™å¤§å®¶å¸¦æ¥å¸®åŠ©ã€‚

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)