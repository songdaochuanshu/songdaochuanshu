---
layout: post
title: 'å¦‚ä½•åœ¨.NETç³»ç»Ÿä¸­å¿«é€Ÿé›†æˆé£ä¹¦ä»»åŠ¡åˆ†é…èƒ½åŠ›'
date: "2025-12-30T00:44:45Z"
---
å¦‚ä½•åœ¨.NETç³»ç»Ÿä¸­å¿«é€Ÿé›†æˆé£ä¹¦ä»»åŠ¡åˆ†é…èƒ½åŠ›
======================

> æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼šå®¢æˆ·ç„¦æ€¥åœ°ç­‰å¾…é—®é¢˜è§£å†³ï¼Œè€Œä½ çš„å›¢é˜Ÿå´åœ¨ä¸€å †é‚®ä»¶ã€Excelè¡¨æ ¼å’Œé›¶æ•£çš„IMæ¶ˆæ¯ä¸­æ‰‹å¿™è„šä¹±ã€‚è¿™æ˜¯ä¸æ˜¯å¾ˆå¤šä¼ä¸šæ¯å¤©éƒ½åœ¨ä¸Šæ¼”çš„çœŸå®å†™ç…§ï¼Ÿ

åœ¨æ•°å­—åŒ–è½¬å‹çš„æµªæ½®ä¸­ï¼Œæˆ‘ä»¬ä¸ä»…è¦è®©ç³»ç»Ÿ"èƒ½ç”¨"ï¼Œæ›´è¦è®©å›¢é˜Ÿ"å¥½ç”¨"ã€‚é£ä¹¦å°±åƒæ˜¯åä½œä¸–ç•Œçš„"è¶…çº§è‹±é›„"ï¼Œå®ƒèƒ½è®©åŸæœ¬å„è‡ªä¸ºæˆ˜çš„ä¸šåŠ¡ç³»ç»Ÿæ‰‹æ‹‰æ‰‹ï¼Œè®©ä¿¡æ¯åƒæµæ°´ä¸€æ ·é¡ºç•…æµåŠ¨ã€‚

ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·è¸ä¸Šä¸€æ®µå¥‡å¦™çš„æ—…ç¨‹â€”â€”å€ŸåŠ©Mud.Feishuè¿™ä¸ªå¼ºå¤§çš„å¼€æºå·¥å…·ï¼Œä¸ºæˆ‘ä»¬çš„.NETä¸šåŠ¡ç³»ç»Ÿè£…ä¸Š"åä½œç¿…è†€"ï¼Œå®ç°ä»ä¼ ç»Ÿçš„å·¥å•å¤„ç†åˆ°ç°ä»£åŒ–çš„å…¨é“¾è·¯ä»»åŠ¡ååŒçš„åä¸½è½¬èº«ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„ç³»ç»Ÿéœ€è¦"åä½œå‡çº§"ï¼Ÿ
-----------------

### å½“å­¤å²›é‡ä¸Šåä½œï¼šé‚£äº›å¹´æˆ‘ä»¬ä¸€èµ·è¸©è¿‡çš„å‘

è¿˜è®°å¾—é‚£ä¸ªå°´å°¬çš„ä¸‹åˆå—ï¼Ÿå®¢æˆ·åœ¨ç”µè¯é‚£å¤´ç„¦æ€¥åœ°è¯¢é—®ï¼š"æˆ‘çš„é—®é¢˜è§£å†³å¾—æ€ä¹ˆæ ·äº†ï¼Ÿ" è€Œä½ å´åœ¨ä¸‰ä¸ªä¸åŒçš„ç³»ç»Ÿä¹‹é—´æ¥å›åˆ‡æ¢ï¼Œè¯•å›¾æ‹¼å‡‘å‡ºå®Œæ•´çš„ç­”æ¡ˆã€‚

éšç€ä¼ä¸šè¶Šæ¥è¶Šå¤§ï¼Œä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚ï¼Œæˆ‘ä»¬çš„ä¼ ç»Ÿç³»ç»Ÿå°±åƒä¸€ä¸ªä¸ªç‹¬ç«‹çš„"å°å²›"ï¼Œè™½ç„¶æ¯ä¸ªå°å²›ä¸Šéƒ½æœ‰å®è—ï¼ˆæ•°æ®ï¼‰ï¼Œä½†å®ƒä»¬ä¹‹é—´å´æ²¡æœ‰æ¡¥æ¢ï¼š

1.  **ä¿¡æ¯éƒ½åœ¨å„è‡ªçš„"ä¿é™©æŸœ"é‡Œ**ï¼šå®¢æœç”¨ä¸€å¥—ç³»ç»Ÿï¼ŒæŠ€æœ¯ç”¨å¦ä¸€å¥—ï¼Œäº§å“è¿˜æœ‰è‡ªå·±çš„ç³»ç»Ÿã€‚æƒ³è¦çœ‹å…¨å±€ï¼Ÿé‚£å¯çœŸæ˜¯ä¸ªæŒ‘æˆ˜ï¼
    
2.  **æ²Ÿé€šè¿˜åœ¨"çŸ³å™¨æ—¶ä»£"**ï¼šé‚®ä»¶ä¸€æ¥ä¸€å›å¯èƒ½è¦ç­‰å‡ å°æ—¶ï¼Œé‡è¦æ¶ˆæ¯å¯èƒ½æ·¹æ²¡åœ¨æ”¶ä»¶ç®±é‡Œï¼ŒIMèŠå¤©è®°å½•åˆå®¹æ˜“è¢«åˆ·å±é—å¿˜ã€‚
    
3.  **ä»»åŠ¡è¿›å±•åƒ"ç›²äººæ‘¸è±¡"**ï¼šè°åœ¨è´Ÿè´£ä»€ä¹ˆï¼Ÿè¿›è¡Œåˆ°å“ªä¸€æ­¥äº†ï¼Ÿè¿™äº›é—®é¢˜å¾€å¾€éœ€è¦å¼€ä¼šé—®ä¸€åœˆæ‰èƒ½ææ¸…æ¥šã€‚
    
4.  **è·¨éƒ¨é—¨åä½œåƒ"è·¨è¶Šå¤§æµ·"**ï¼šæŠ€æœ¯è¯´è¿™æ˜¯äº§å“é—®é¢˜ï¼Œäº§å“è¯´è¿™æ˜¯å®¢æœé—®é¢˜ï¼Œå®¢æˆ·çš„é—®é¢˜åœ¨éƒ¨é—¨ä¹‹é—´"æ¼‚æµ"ï¼Œæœ€åä¸äº†äº†ä¹‹ã€‚
    

### é£ä¹¦APIç»™ä¼ ç»Ÿç³»ç»Ÿè£…ä¸Š"æ™ºèƒ½å¤§è„‘"

å¦‚æœè¯´ä¼ ç»Ÿç³»ç»Ÿæ˜¯"å•æœºç‰ˆ"ï¼Œé‚£ä¹ˆé£ä¹¦APIå°±æ˜¯è®©å®ƒä»¬è¿å…¥"äº’è”ç½‘"çš„é­”æ³•æ£’ã€‚é£ä¹¦ä¸ä»…ä»…æ˜¯åˆä¸€ä¸ªåŠå…¬è½¯ä»¶ï¼Œå®ƒçš„ä»»åŠ¡ç®¡ç†APIå°±åƒæ˜¯åä½œä¸–ç•Œçš„"é€šç”¨è¯­è¨€"ï¼š

*   **å¼€æ”¾çš„"ä¹é«˜ç§¯æœ¨"**ï¼šä¸°å¯Œçš„APIæ¥å£å°±åƒä¹é«˜ç§¯æœ¨ï¼Œä½ å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°æ­å»ºé€‚åˆè‡ªå·±çš„åä½œåœºæ™¯ã€‚
    
*   **å®æ—¶"å¿ƒè·³æ„Ÿåº”"**ï¼šåŸºäºWebSocketçš„æ¨é€æœºåˆ¶è®©ä»»åŠ¡çŠ¶æ€å˜åŒ–åƒå¿ƒè·³ä¸€æ ·å®æ—¶ä¼ é€’ï¼Œå‘Šåˆ«"åˆ·æ–°æŸ¥çœ‹"çš„ç­‰å¾…æ—¶ä»£ã€‚
    
*   **ç§»åŠ¨"éšèº«åŠ©æ‰‹"**ï¼šæ— è®ºä½ åœ¨å’–å•¡å…è¿˜æ˜¯åœ¨è·¯ä¸Šï¼Œæ‰‹æœºä¸Šçš„ä»»åŠ¡æé†’å’Œæ›´æ–°éƒ½ä¸ä¼šé”™è¿‡é‡è¦äº‹é¡¹ã€‚
    
*   **ä¼ä¸š"å®‰å…¨å«å£«"**ï¼šå®Œå–„çš„æƒé™ç®¡ç†å’Œæ•°æ®åŠ å¯†ï¼Œè®©æ•æ„Ÿä¿¡æ¯åœ¨å¼€æ”¾åä½œçš„åŒæ—¶ä¾ç„¶å®‰å…¨å¯é ã€‚
    

### ä¸ºä»€ä¹ˆ.NETæ˜¯æœ€ä½³é€‰æ‹©

åœ¨ä¼—å¤šæŠ€æœ¯æ ˆä¸­ï¼Œ.NETå°±åƒæ˜¯é‚£ä¸ªç¨³é‡åˆæœ‰å†…æ¶µçš„"ç†æƒ³ä¼´ä¾£"ï¼Œç‰¹åˆ«é€‚åˆæ‰¿æ‹…ä¼ä¸šçº§é›†æˆçš„é‡ä»»ï¼š

*   **ç¨³å¦‚æ³°å±±çš„"è€å¸æœº"**ï¼š.NETå¹³å°ç»è¿‡å¤šå¹´å†ç»ƒï¼Œæ€§èƒ½ç¨³å®šå¯é ï¼Œå°±åƒä¸€ä¸ªç»éªŒä¸°å¯Œçš„è€å¸æœºï¼Œèƒ½åœ¨å¤æ‚çš„ä¸šåŠ¡ç¯å¢ƒä¸­ç¨³å¥å‰è¡Œã€‚
    
*   **å¾®è½¯"é å±±"å¾ˆç»™åŠ›**ï¼šæœ‰å¾®è½¯è¿™æ ·çš„æŠ€æœ¯å·¨å¤´é•¿æœŸæ”¯æŒï¼Œä¸ç”¨æ‹…å¿ƒæŠ€æœ¯è·¯çº¿çªç„¶å˜å¦ï¼Œå¼€å‘è·¯ä¸Šæ›´æœ‰å®‰å…¨æ„Ÿã€‚
    
*   **ä¸æ—¶ä¿±è¿›"æ–°é’å¹´"**ï¼šä».NET 6.0å¼€å§‹ï¼Œæ•´ä¸ªå¹³å°ç„•ç„¶ä¸€æ–°ï¼Œå¼‚æ­¥ç¼–ç¨‹å’Œå¹¶å‘å¤„ç†èƒ½åŠ›è®©å¤æ‚åœºæ™¯çš„å¤„ç†å˜å¾—æ¸¸åˆƒæœ‰ä½™ã€‚
    
*   **å·¥å…·é“¾"è±ªåå¥—é¤"**ï¼šVisual Studioå°±åƒæ˜¯ä¸€æŠŠ"ç‘å£«å†›åˆ€"ï¼Œé…åˆNuGetè¿™ä¸ª"ç™¾å®ç®±"ï¼Œå¼€å‘æ•ˆç‡è‡ªç„¶èŠ‚èŠ‚æ”€å‡ã€‚
    

ä¸€ä¸ªçœŸå®çš„åº”ç”¨åœºæ™¯ï¼šå®¢æœå°ç‹çš„ä¸€å¤©
-----------------

### å°ç‹çš„"æ—¥å¸¸æŠ˜ç£¨"ï¼šä¼ ç»Ÿå·¥å•ç³»ç»Ÿçš„å›°å¢ƒ

è®©æˆ‘ä»¬è·Ÿéšå®¢æœå°ç‹ï¼Œçœ‹çœ‹å¥¹æ˜¯å¦‚ä½•åœ¨ä¼ ç»Ÿå·¥å•ç³»ç»Ÿä¸­"æŒ£æ‰"çš„ï¼š

æ—©ä¸Š9ç‚¹ï¼Œå°ç‹åˆšåä¸‹å°±æ”¶åˆ°äº†å®¢æˆ·çš„ç´§æ€¥æŠ•è¯‰ã€‚å¥¹è¿…é€Ÿåœ¨ç³»ç»Ÿä¸­åˆ›å»ºäº†å·¥å•ï¼Œç„¶åå‘é€é‚®ä»¶ç»™æŠ€æœ¯éƒ¨é—¨çš„è€æã€‚ä¸¤ä¸ªå°æ—¶è¿‡å»äº†ï¼Œè€ææ‰å›å¤è¯´è¿™ä¸ªé—®é¢˜éœ€è¦äº§å“éƒ¨é—¨çš„å°å¼ ç¡®è®¤...

è¿™å¬èµ·æ¥æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿä¼ ç»Ÿå·¥å•ç³»ç»Ÿå°±åƒæ˜¯ä¸€ä¸ª"ä¿¡æ¯ä¼ é€’æ¸¸æˆ"ï¼Œæ¯ä¸ªäººéƒ½åœ¨ç­‰å¾…ï¼Œå®¢æˆ·å´åœ¨ç„¦è™‘ã€‚è®©æˆ‘ä»¬çœ‹çœ‹å°ç‹çš„å·¥ä½œæµç¨‹å›¾ï¼š

graph TD A\[å®¢æˆ·æäº¤å·¥å•\] --> B\[é‚®ä»¶é€šçŸ¥å®¢æœ\] B --> C\[æ‰‹åŠ¨åˆ†é…å¤„ç†äºº\] C --> D\[IMæ²Ÿé€šåè°ƒ\] D --> E\[Excelè·Ÿè¸ªè¿›åº¦\] E --> F\[æ‰‹åŠ¨æ›´æ–°çŠ¶æ€\] F --> G\[é‚®ä»¶å›å¤å®¢æˆ·\] style B fill:#ffcccc style D fill:#ffcccc style E fill:#ffcccc style G fill:#ffcccc

çœ‹åˆ°é‚£äº›çº¢è‰²çš„æ­¥éª¤äº†å—ï¼Ÿæ¯ä¸€æ­¥éƒ½æ˜¯å°ç‹å·¥ä½œä¸­çš„"ç—›ç‚¹"ã€‚

### ä¸‰ä¸ªè®©å°ç‹"å¤´ç–¼"çš„å¤§éš¾é¢˜

#### ğŸŒ«ï¸ éš¾é¢˜ä¸€ï¼šä»»åŠ¡æ¶ˆå¤±åœ¨"ä¿¡æ¯é»‘æ´"é‡Œ

å°ç‹æ¯å¤©éƒ½åœ¨ç©"æ‰è¿·è—"æ¸¸æˆï¼š

*   **é‚®ä»¶æ£®æ—**ï¼šé‡è¦çš„ä»»åŠ¡åˆ†é…é‚®ä»¶å¯èƒ½è¢«æ·¹æ²¡åœ¨æ”¶ä»¶ç®±çš„æ•°ç™¾å°é‚®ä»¶ä¸­
*   **IMèŠå¤©åˆ·å±**ï¼šå…³é”®ä¿¡æ¯åœ¨ç¾¤èŠé‡Œè¢«å„ç§è¡¨æƒ…åŒ…å’Œé—²èŠæ·¹æ²¡
*   **ç®¡ç†å±‚çš„"æœ›è¿œé•œ"**ï¼šæƒ³è¦äº†è§£æ•´ä½“è¿›åº¦ï¼Ÿé‚£å°±å¾—ä¸€ä¸ªä¸ªå»é—®ï¼Œå°±åƒç”¨æœ›è¿œé•œçœ‹æ˜Ÿæ˜Ÿ
*   **å®¢æˆ·çš„"çŒœè°œæ¸¸æˆ"**ï¼šå®¢æˆ·æ‰“ç”µè¯é—®è¿›åº¦ï¼Œå°ç‹åªèƒ½å°´å°¬åœ°è¯´"æˆ‘å¸®æ‚¨é—®é—®"

#### ğŸ§© éš¾é¢˜äºŒï¼šè·¨éƒ¨é—¨åä½œåƒ"æ‹¼å›¾æ¸¸æˆ"

å·¥å•åœ¨ä¸åŒéƒ¨é—¨ä¹‹é—´ä¼ é€’ï¼Œå°±åƒæ˜¯åœ¨ç©æ‹¼å›¾ï¼Œä½†æ€»å°‘äº†å‡ å—ï¼š

*   **ç³»ç»Ÿ"æ–¹è¨€"ä¸åŒ**ï¼šå®¢æœç³»ç»Ÿã€æŠ€æœ¯ç³»ç»Ÿã€äº§å“ç³»ç»Ÿå„è‡ªè¯´å„è‡ªçš„"è¯­è¨€"
*   **ä¿¡æ¯"æ¥åŠ›èµ›"ä¸­çš„æ‰æ£’**ï¼šå·¥å•åœ¨ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œé‡è¦çš„èƒŒæ™¯ä¿¡æ¯"ä¸ç¿¼è€Œé£"
*   **è´£ä»»"çš®çƒæ¸¸æˆ"**ï¼šè¿™åˆ°åº•æ˜¯æŠ€æœ¯é—®é¢˜è¿˜æ˜¯äº§å“é—®é¢˜ï¼Ÿå¤§å®¶å¼€å§‹è¸¢çš®çƒ
*   **çŸ¥è¯†"å­¤å²›"**ï¼šè§£å†³æ–¹æ¡ˆå’Œä¸ªäººç»éªŒéƒ½ç•™åœ¨äº†å„è‡ªçš„å¤§è„‘é‡Œï¼Œæ— æ³•å½¢æˆå›¢é˜Ÿè´¢å¯Œ

#### â° éš¾é¢˜ä¸‰ï¼šä¼˜å…ˆçº§ç®¡ç†åƒ"æ— å¤´è‹è‡"

ä¼ ç»Ÿç³»ç»Ÿå°±åƒæ˜¯æ²¡æœ‰å¯¼èˆªçš„å¸æœºï¼š

*   **SLA"å®šæ—¶ç‚¸å¼¹"**ï¼šé‡è¦çš„å·¥å•å¿«è¦åˆ°æœŸäº†ï¼Œä½†ç³»ç»Ÿä¸ä¼šè‡ªåŠ¨æé†’
*   **è¿›åº¦"ç›²äººæ‘¸è±¡"**ï¼šå“ªä¸ªå·¥å•ä¼šè¶…æ—¶ï¼Ÿåªèƒ½å‡­æ„Ÿè§‰çŒœæµ‹
*   **ç®¡ç†å±‚"é›¾é‡Œçœ‹èŠ±"**ï¼šæƒ³è¦å…¨å±€è§†å›¾ï¼ŸæŠ±æ­‰ï¼Œç³»ç»Ÿåªæ”¯æŒå•ç‚¹æŸ¥çœ‹
*   **èµ„æºè°ƒé…"æ‹è„‘è¢‹"**ï¼šè°è¯¥å¤„ç†ä»€ä¹ˆä»»åŠ¡ï¼Ÿæ›´å¤šé ç»éªŒè€Œéæ•°æ®

### å°ç‹çš„"é€†è¢­"ï¼šå½“å·¥å•ç³»ç»Ÿé‡ä¸Šé£ä¹¦

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å½“é£ä¹¦ä»»åŠ¡ç®¡ç†ä»‹å…¥åï¼Œå°ç‹çš„å·¥ä½œå‘ç”Ÿäº†æ€æ ·çš„ç¥å¥‡å˜åŒ–ï¼š

graph TD A\[å®¢æˆ·æäº¤å·¥å•\] --> B\[âœ¨ è‡ªåŠ¨åˆ›å»ºé£ä¹¦ä»»åŠ¡\] B --> C\[ğŸ¯ æ™ºèƒ½åˆ†é…è´£ä»»äºº\] C --> D\[ğŸ“± å®æ—¶çŠ¶æ€åŒæ­¥\] D --> E\[ğŸ¤ å¤šæ–¹ååŒå¤„ç†\] E --> F\[â° è‡ªåŠ¨é¢„è­¦æé†’\] F --> G\[ğŸ‰ å®Œæˆè‡ªåŠ¨é€šçŸ¥\] style B fill:#ccffcc style C fill:#ccffcc style D fill:#ccffcc style E fill:#ccffcc style F fill:#ccffcc style G fill:#ccffcc

çœ‹åˆ°é‚£äº›ç»¿è‰²æ­¥éª¤äº†å—ï¼Ÿæ¯ä¸€ä¸ªéƒ½ä»£è¡¨ç€å°ç‹å·¥ä½œæ•ˆç‡çš„é£è·ƒæå‡ï¼

**å°ç‹çš„"å¹¸ç¦æ„Ÿæå‡æ¸…å•"**ï¼š

*   ğŸš€ **ä»æ‰‹å·¥åˆ°è‡ªåŠ¨åŒ–**ï¼šåŸæ¥è¦äººå·¥æ“ä½œçš„æ­¥éª¤ï¼Œç°åœ¨ç³»ç»Ÿè‡ªåŠ¨æå®šï¼Œå°ç‹ç»ˆäºæœ‰æ—¶é—´å–æ¯å’–å•¡äº†
    
*   ğŸ” **ä»é»‘ç›’åˆ°é€æ˜**ï¼šä»»åŠ¡è¿›å±•ä¸€ç›®äº†ç„¶ï¼Œç®¡ç†å±‚å†ä¹Ÿä¸ç”¨è¿½ç€å¥¹é—®è¿›åº¦ï¼Œå®¢æˆ·ä¹Ÿèƒ½è‡ªå·±æŸ¥çœ‹çŠ¶æ€
    
*   ğŸŒ‰ **ä»å­¤å²›åˆ°é€šé€”**ï¼šç»Ÿä¸€çš„åä½œå¹³å°è®©è·¨éƒ¨é—¨åˆä½œå˜å¾—åƒ"å·¦é‚»å³èˆ"ä¸€æ ·è‡ªç„¶
    
*   ğŸ˜Š **ä»è¢«åŠ¨åˆ°ä¸»åŠ¨**ï¼šå®¢æˆ·æ”¶åˆ°å®æ—¶æ›´æ–°é€šçŸ¥ï¼Œæ»¡æ„åº¦ç›´çº¿ä¸Šå‡ï¼Œå°ç‹çš„KPIä¹Ÿè·Ÿç€æ°´æ¶¨èˆ¹é«˜
    

æ­ç§¯æœ¨çš„è‰ºæœ¯ï¼šæ„å»ºæˆ‘ä»¬çš„åä½œæ¡¥æ¢
----------------

### å…ˆçœ‹çœ‹æˆ‘ä»¬çš„"å®¶åº•"ï¼šç°æœ‰ç³»ç»Ÿæ˜¯ä»€ä¹ˆæ ·çš„

åœ¨ä¼ä¸šçº§åº”ç”¨çš„ä¸–ç•Œé‡Œï¼Œ.NETç³»ç»Ÿå°±åƒæ˜¯ç²¾å¿ƒè®¾è®¡çš„"å»ºç­‘"ï¼Œä¸»è¦æœ‰ä¸¤ç§å¸¸è§çš„"å»ºç­‘é£æ ¼"ï¼š

#### ç»å…¸çš„å¤„ç†æµç¨‹

graph TB subgraph "è¡¨ç°å±‚ Presentation Layer" A\[ASP.NET Core Web API\] B\[å‰ç«¯åº”ç”¨ React/Vue\] end subgraph "ä¸šåŠ¡é€»è¾‘å±‚ Business Logic Layer" C\[å·¥å•ç®¡ç†æœåŠ¡\] D\[å®¢æˆ·ç®¡ç†æœåŠ¡\] E\[é€šçŸ¥æœåŠ¡\] end subgraph "æ•°æ®è®¿é—®å±‚ Data Access Layer" F\[Entity Framework Core\] G\[SQL Serveræ•°æ®åº“\] end A --> C A --> D B --> A C --> F D --> F E --> C F --> G

#### å¾®æœåŠ¡çš„ç°ä»£å¸ƒå±€

graph TB subgraph "APIç½‘å…³" A\[Ocelot/Gateway\] end subgraph "å¾®æœåŠ¡é›†ç¾¤" B\[å·¥å•æœåŠ¡\] C\[ç”¨æˆ·æœåŠ¡\] D\[é€šçŸ¥æœåŠ¡\] E\[è®¢å•æœåŠ¡\] end subgraph "åŸºç¡€è®¾æ–½" F\[Redisç¼“å­˜\] G\[RabbitMQæ¶ˆæ¯é˜Ÿåˆ—\] H\[SQL Serveré›†ç¾¤\] end A --> B A --> C A --> D A --> E B --> F B --> G C --> F D --> F E --> H

### ä½¿ç”¨é£ä¹¦åä¼˜åŒ–çš„ç³»ç»Ÿæµç¨‹

ç°åœ¨åˆ°äº†æœ€æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†ï¼æˆ‘ä»¬è¦åœ¨ç°æœ‰ç³»ç»Ÿå’Œé£ä¹¦ä¹‹é—´æ­å»ºä¸€åº§"æ™ºèƒ½æ¡¥æ¢"ã€‚è¿™ä¸ªæ¡¥ä¸æ˜¯ç”¨ç –å—ï¼Œè€Œæ˜¯ç”¨ä»£ç å’Œæ™ºæ…§æ­å»ºçš„ï¼š

graph TB subgraph "ä¸šåŠ¡åº”ç”¨å±‚" A\[å·¥å•ç®¡ç†ç³»ç»Ÿ\] B\[å®¢æˆ·æ”¯æŒç³»ç»Ÿ\] C\[é¡¹ç›®ç®¡ç†ç³»ç»Ÿ\] end subgraph "é£ä¹¦é›†æˆé€‚é…å±‚" D\[Mud.Feishu HTTP APIå®¢æˆ·ç«¯\] E\[Mud.Feishu WebSocketå®¢æˆ·ç«¯\] F\[Mud.Feishu Webhookå¤„ç†å™¨\] end subgraph "åŒæ­¥æœåŠ¡å±‚" G\[ä»»åŠ¡åŒæ­¥æœåŠ¡\] H\[äº‹ä»¶è·¯ç”±æœåŠ¡\] I\[çŠ¶æ€åŒæ­¥æœåŠ¡\] end subgraph "ç›‘æ§ä¸å›é€€æœºåˆ¶" J\[å¥åº·ç›‘æ§\] K\[é‡è¯•æœºåˆ¶\] L\[é™çº§ç­–ç•¥\] end subgraph "é£ä¹¦å¹³å°" M\[é£ä¹¦ä»»åŠ¡API\] N\[é£ä¹¦WebSocket\] O\[é£ä¹¦äº‹ä»¶è®¢é˜…\] end A --> G B --> G C --> G G --> D G --> E G --> F D --> M E --> N F --> O G --> H H --> I G --> J J --> K K --> L

#### é€‚é…å±‚ç»„ä»¶äº¤äº’æµç¨‹

sequenceDiagram participant B as ä¸šåŠ¡ç³»ç»Ÿ participant S as åŒæ­¥æœåŠ¡ participant A as é€‚é…å±‚ participant F as é£ä¹¦å¹³å° participant W as WebSocket/Webhook Note over B,W: åŒå‘æ•°æ®åŒæ­¥æµç¨‹ B->>S: åˆ›å»º/æ›´æ–°å·¥å• S->>A: è°ƒç”¨ä»»åŠ¡API A->>F: HTTP APIè°ƒç”¨ F-->>A: è¿”å›ç»“æœ A-->>S: åŒæ­¥å®Œæˆ S-->>B: æ›´æ–°å…³è”ID Note over F,W: å®æ—¶äº‹ä»¶æ¨é€ F->>W: ä»»åŠ¡çŠ¶æ€å˜æ›´ W->>A: äº‹ä»¶é€šçŸ¥ A->>S: å¤„ç†ä¸šåŠ¡é€»è¾‘ S->>B: æ›´æ–°å·¥å•çŠ¶æ€

#### é€‚é…å±‚ï¼ˆMud.Feishuå°è£…ï¼‰

Mud.Feishuæä¾›äº†å®Œæ•´çš„é£ä¹¦APIå°è£…ï¼š

*   **HTTP APIå®¢æˆ·ç«¯**ï¼šåŸºäº`IFeishuTenantV2Task`æ¥å£ï¼Œæä¾›å®Œæ•´çš„ä»»åŠ¡ç®¡ç†èƒ½åŠ›
*   **WebSocketå®¢æˆ·ç«¯**ï¼šå®æ—¶äº‹ä»¶è®¢é˜…ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¿å’Œå¿ƒè·³æ£€æµ‹
*   **Webhookå¤„ç†å™¨**ï¼šHTTPå›è°ƒäº‹ä»¶å¤„ç†ï¼Œæ”¯æŒäº‹ä»¶è·¯ç”±å’Œä¸­é—´ä»¶æ¨¡å¼

Mud.Feishuæºç ä»“åº“ï¼š[Gitee](https://gitee.com/mudtools/MudFeishu),[Github](https://github.com/mudtools/MudFeishu)

    // æ ¸å¿ƒæ¥å£å®šä¹‰ç¤ºä¾‹
    public interface IFeishuTaskAdapter
    {
        Task<string> CreateTaskAsync(CreateTaskRequest request);
        Task<TaskInfo> GetTaskAsync(string taskGuid);
        Task<bool> UpdateTaskAsync(string taskGuid, UpdateTaskRequest request);
        Task<bool> DeleteTaskAsync(string taskGuid);
    }
    

#### åŒæ­¥æœåŠ¡ï¼ˆåŒå‘/äº‹ä»¶é©±åŠ¨ï¼‰

åŒæ­¥æœåŠ¡è´Ÿè´£ä¸šåŠ¡ç³»ç»Ÿä¸é£ä¹¦ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼š

    public class TaskSyncService
    {
        private readonly IFeishuTaskAdapter _feishuAdapter;
        private readonly ITicketRepository _ticketRepository;
        private readonly ILogger<TaskSyncService> _logger;
    
        // åŒå‘åŒæ­¥é€»è¾‘
        public async Task SyncTicketToTaskAsync(string ticketId)
        {
            var ticket = await _ticketRepository.GetByIdAsync(ticketId);
            if (ticket?.FeishuTaskId == null)
            {
                var taskRequest = MapTicketToTask(ticket);
                var result = await _feishuAdapter.CreateTaskAsync(taskRequest);
                ticket.FeishuTaskId = result;
                await _ticketRepository.UpdateAsync(ticket);
            }
        }
    }
    

#### ç›‘æ§ä¸å›é€€æœºåˆ¶

ç¡®ä¿é›†æˆç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼š

*   **å¥åº·ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥APIå¯ç”¨æ€§å’Œè¿æ¥çŠ¶æ€
*   **é‡è¯•æœºåˆ¶**ï¼šç½‘ç»œå¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•ï¼Œæ”¯æŒæŒ‡æ•°é€€é¿ç­–ç•¥
*   **é™çº§ç­–ç•¥**ï¼šé£ä¹¦æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œç³»ç»Ÿå¯é™çº§åˆ°æœ¬åœ°ä»»åŠ¡ç®¡ç†

### æ•°æ®åŒæ­¥ç­–ç•¥

#### å®æ—¶åŒæ­¥ï¼ˆå…³é”®çŠ¶æ€å˜æ›´ï¼‰

é€šè¿‡WebSocketå’ŒWebhookå®ç°å…³é”®çŠ¶æ€çš„å®æ—¶åŒæ­¥ï¼š

graph LR subgraph "å®æ—¶äº‹ä»¶æµ" A\[é£ä¹¦ä»»åŠ¡çŠ¶æ€å˜æ›´\] --> B\[WebSocket/Webhook\] B --> C\[äº‹ä»¶è·¯ç”±å™¨\] C --> D\[çŠ¶æ€åŒæ­¥æœåŠ¡\] D --> E\[ä¸šåŠ¡ç³»ç»Ÿ\] end subgraph "æ‰¹é‡è¡¥å¿æµ" F\[å®šæ—¶ä»»åŠ¡è§¦å‘\] --> G\[æ•°æ®å¯¹è´¦æœåŠ¡\] G --> H\[å·®å¼‚æ£€æµ‹\] H --> I\[æ•°æ®ä¿®å¤\] I --> E end

    // WebSocketäº‹ä»¶å¤„ç†ç¤ºä¾‹
    public class TaskEventHandler : IFeishuEventHandler
    {
        public string SupportedEventType => "task.status_changed";
    
        public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
        {
            switch (eventData.EventType)
            {
                case "task.status_changed":
                    await HandleTaskStatusChanged(eventData);
                    break;
                case "task.assignee_updated":
                    await HandleAssigneeUpdated(eventData);
                    break;
            }
        }
    }
    

#### æ‰¹é‡è¡¥å¿ï¼ˆå®šæ—¶å¯¹è´¦ï¼‰

å®šæ—¶æ‰§è¡Œæ‰¹é‡å¯¹è´¦ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

    public class TaskReconciliationService : BackgroundService
    {
        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            while (!stoppingToken.IsCancellationRequested)
            {
                await ReconcileTasksAsync();
                await Task.Delay(TimeSpan.FromHours(1), stoppingToken);
            }
        }
    }
    

### å®‰å…¨æ–¹æ¡ˆ

#### OAuth 2.0æµç¨‹

åŸºäºMud.Feishuçš„ä»¤ç‰Œç®¡ç†æœºåˆ¶ï¼š

    // é…ç½®ç¤ºä¾‹
    builder.Services.AddFeishuServices()
        .ConfigureFrom(builder.Configuration)
        .AddTaskApi()
        .AddTokenManagers()
        .Build();
    

#### APIå¯†é’¥ç®¡ç†

*   åº”ç”¨å¯†é’¥å®‰å…¨å­˜å‚¨ï¼ˆç¯å¢ƒå˜é‡/å¯†é’¥ç®¡ç†æœåŠ¡ï¼‰
*   è®¿é—®ä»¤ç‰Œè‡ªåŠ¨åˆ·æ–°å’Œç¼“å­˜
*   æƒé™æœ€å°åŒ–åŸåˆ™ï¼ŒæŒ‰éœ€ç”³è¯·APIæƒé™

#### IPç™½åå•

åœ¨é£ä¹¦å¼€æ”¾å¹³å°é…ç½®æœåŠ¡ç«¯IPç™½åå•ï¼Œå¢å¼ºå®‰å…¨æ€§ã€‚

åŠ¨æ‰‹æ—¶é—´ï¼šä¸€æ­¥æ­¥æ‰“é€ ä½ çš„é£ä¹¦é›†æˆæ¨¡å—
------------------

### 1\. å‡†å¤‡å·¥ä½œï¼šè®©ä¸€åˆ‡å°±ç»ª

#### ç¬¬ä¸€æ­¥ï¼šå’Œé£ä¹¦"æ¡æ‰‹"â€”â€”åˆ›å»ºåº”ç”¨

è®©æˆ‘ä»¬å…ˆåˆ°é£ä¹¦å¼€æ”¾å¹³å°è¿™ä¸ª"æ¸¸ä¹åœº"æ³¨å†Œæˆ‘ä»¬çš„"å…¥åœºåˆ¸"ï¼š

1.  **æ‰“å¼€å¤§é—¨**ï¼šè®¿é—® [https://open.feishu.cn/ï¼Œå°±åƒèµ°è¿›ä¸€ä¸ªå……æ»¡å¯èƒ½æ€§çš„æ–°ä¸–ç•Œ](https://open.feishu.cn/%EF%BC%8C%E5%B0%B1%E5%83%8F%E8%B5%B0%E8%BF%9B%E4%B8%80%E4%B8%AA%E5%85%85%E6%BB%A1%E5%8F%AF%E8%83%BD%E6%80%A7%E7%9A%84%E6%96%B0%E4%B8%96%E7%95%8C)
    
2.  **é¢†å–èº«ä»½å¡**ï¼šåˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨
    
    *   ç»™å®ƒèµ·ä¸ªå“äº®çš„åå­—ï¼š"å®¢æˆ·æ”¯æŒå·¥å•é›†æˆåŠ©æ‰‹"
    *   å†™ä¸ªè‡ªæˆ‘ä»‹ç»ï¼š"æˆ‘æ˜¯æ¥å¸®å¤§å®¶å‘Šåˆ«å·¥å•æ··ä¹±çš„å°èƒ½æ‰‹"
3.  **ç”³è¯·é€šè¡Œè¯**ï¼šé…ç½®åº”ç”¨æƒé™
    
    *   ä»»åŠ¡ç®¡ç†å…¨æƒé™ï¼šè¯»å–ã€åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼ˆå°±åƒç»™äº†ä¸€æŠŠä¸‡èƒ½é’¥åŒ™ï¼‰
    *   ä»»åŠ¡æ¸…å•æŸ¥çœ‹æƒï¼šçŸ¥é“ä»»åŠ¡æ”¾åœ¨å“ªä¸ª"æˆ¿é—´"
    *   ç”¨æˆ·åŸºæœ¬ä¿¡æ¯æƒï¼šè®¤è¯†å›¢é˜Ÿé‡Œçš„æ¯ä¸ª"å°ä¼™ä¼´"
    *   äº‹ä»¶è®¢é˜…æƒï¼šèƒ½å¤Ÿç›‘å¬ä»»åŠ¡ä¸–ç•Œçš„"é£å¹è‰åŠ¨"
4.  **è®¾ç½®ä¸“å±çƒ­çº¿**ï¼šé…ç½®äº‹ä»¶è®¢é˜…
    
    *   æä¾›ä½ çš„"ç”µè¯å·ç "ï¼ˆè¯·æ±‚ç½‘å€ï¼‰ï¼š`https://your-domain.com/api/feishu/webhook`
    *   å‡†å¤‡"æš—å·"ï¼ˆéªŒè¯Tokenï¼‰ï¼šåªæœ‰ä½ æ‡‚çš„éªŒè¯å­—ç¬¦ä¸²
    *   é…ç½®"ä¿é™©ç®±"ï¼ˆæ•°æ®åŠ å¯†å¯†é’¥ï¼‰ï¼šç”¨AES-256ä¿æŠ¤æ•æ„Ÿä¿¡æ¯

#### ç¬¬äºŒæ­¥ï¼šæ­å»ºæˆ‘ä»¬çš„"å¼€å‘å·¥ä½œå®¤"

ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„.NETé¡¹ç›®ï¼Œå¹¶é‚€è¯·æˆ‘ä»¬çš„"å¾—åŠ›åŠ©æ‰‹"ä»¬åŠ å…¥ï¼š

    <Project Sdk="Microsoft.NET.Sdk.Web">
      <PropertyGroup>
        <TargetFramework>net10.0</TargetFramework>
        <Nullable>enable</Nullable>
      </PropertyGroup>
    
      <ItemGroup>
        <PackageReference Include="Mud.Feishu" Version="1.0.9" />
        <PackageReference Include="Mud.Feishu.WebSocket" Version="1.0.9" />
        <PackageReference Include="Mud.Feishu.Webhook" Version="1.0.9" />
        <PackageReference Include="Microsoft.EntityFrameworkCore" Version="10.0.0" />
      </ItemGroup>
    </Project>
    

#### åŸºç¡€é…ç½®æ–‡ä»¶

    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning"
        }
      },
      "Feishu": {
        "AppId": "cli_xxxxxxxxxxxxxxxx",
        "AppSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
        "BaseUrl": "https://open.feishu.cn",
        "TimeOut": "30",
        "RetryCount": 3
      },
      "Feishu:WebSocket": {
        "AutoReconnect": true,
        "MaxReconnectAttempts": 5,
        "ReconnectDelayMs": 5000,
        "HeartbeatIntervalMs": 30000,
        "EnableLogging": true
      },
      "FeishuWebhook": {
        "RoutePrefix": "api/feishu/webhook",
        "VerificationToken": "your_verification_token",
        "EncryptKey": "your_encrypt_key",
        "EnableRequestLogging": true
      },
      "ConnectionStrings": {
        "DefaultConnection": "Server=.;Database=TicketSystem;Trusted_Connection=true;"
      }
    }
    

### 2\. æ ¸å¿ƒé­”æ³•ï¼šè®©ä»£ç æ´»èµ·æ¥

#### è®¤è¯æœåŠ¡ï¼šè®©ç³»ç»Ÿ"è®°ä½"æˆ‘æ˜¯è°

æƒ³è±¡ä¸€ä¸‹ï¼Œæ¯æ¬¡è°ƒç”¨é£ä¹¦APIéƒ½è¦é‡æ–°ç™»å½•æ˜¯å¤šä¹ˆç¹çã€‚å¹¸è¿çš„æ˜¯ï¼ŒMud.Feishuå·²ç»ä¸ºæˆ‘ä»¬å‡†å¤‡äº†ä¸€ä¸ª"æ™ºèƒ½é—¨å«"ï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†è®¤è¯å’Œåˆ·æ–°tokenè¿™äº›çƒ¦äººçš„äº‹æƒ…ã€‚æˆ‘ä»¬åªéœ€è¦å‘Šè¯‰å®ƒ"å¯†ç "åœ¨å“ªé‡Œå°±è¡Œï¼š

graph TB subgraph "æœåŠ¡æ³¨å†Œæ¶æ„" A\[.NET Host Builder\] --> B\[é£ä¹¦APIæœåŠ¡\] A --> C\[WebSocketæœåŠ¡\] A --> D\[WebhookæœåŠ¡\] A --> E\[è‡ªå®šä¹‰ä¸šåŠ¡æœåŠ¡\] B --> F\[Tokenç®¡ç†å™¨\] B --> G\[ä»»åŠ¡APIå®¢æˆ·ç«¯\] C --> H\[WebSocketç®¡ç†å™¨\] C --> I\[äº‹ä»¶å¤„ç†å™¨1\] C --> J\[äº‹ä»¶å¤„ç†å™¨2\] D --> K\[Webhookè·¯ç”±\] D --> L\[äº‹ä»¶å¤„ç†å™¨\] E --> M\[ä»»åŠ¡åŒæ­¥æœåŠ¡\] E --> N\[é€šçŸ¥æœåŠ¡\] end

    // Program.cs - æœåŠ¡æ³¨å†Œ
    var builder = WebApplication.CreateBuilder(args);
    
    // æ³¨å†Œé£ä¹¦æœåŠ¡
    builder.Services.AddFeishuServices()
        .ConfigureFrom(builder.Configuration)
        .AddTaskApi()
        .AddTokenManagers()
        .Build();
    
    // æ³¨å†ŒWebSocketæœåŠ¡
    builder.Services.AddFeishuWebSocketServiceBuilder()
        .ConfigureFrom(builder.Configuration)
        .UseMultiHandler()
        .AddHandler<TaskEventHandler>()
        .AddHandler<TicketEventHandler>()
        .Build();
    
    // æ³¨å†ŒWebhookæœåŠ¡
    builder.Services.AddFeishuWebhookServiceBuilder(builder.Configuration)
        .AddHandler<TaskWebhookHandler>()
        .Build();
    
    // è‡ªå®šä¹‰æœåŠ¡æ³¨å†Œ
    builder.Services.AddScoped<IFeishuTaskService, FeishuTaskService>();
    builder.Services.AddScoped<ITicketSyncService, TicketSyncService>();
    

#### ä»»åŠ¡APIå®¢æˆ·ç«¯ï¼šå¼€ç®±å³ç”¨çš„é£ä¹¦ .net SDK

    public interface IFeishuTaskService
    {
        Task<string> CreateTaskFromTicketAsync(Ticket ticket);
        Task<bool> UpdateTaskAsync(string taskGuid, UpdateTaskRequest request);
        Task<TaskInfo?> GetTaskAsync(string taskGuid);
        Task<bool> DeleteTaskAsync(string taskGuid);
        Task<bool> AddTaskMemberAsync(string taskGuid, string userId, string role);
        Task<List<TaskInfo>> GetTasksByProjectAsync(string projectKey);
    }
    
    public class FeishuTaskService : IFeishuTaskService
    {
        private readonly IFeishuTenantV2Task _taskApi;
        private readonly ILogger<FeishuTaskService> _logger;
        private readonly IMapper _mapper;
    
        public FeishuTaskService(
            IFeishuTenantV2Task taskApi,
            ILogger<FeishuTaskService> logger,
            IMapper mapper)
        {
            _taskApi = taskApi ?? throw new ArgumentNullException(nameof(taskApi));
            _logger = logger ?? throw new ArgumentNullException(nameof(logger));
            _mapper = mapper ?? throw new ArgumentNullException(nameof(mapper));
        }
    
        public async Task<string> CreateTaskFromTicketAsync(Ticket ticket)
        {
            try
            {
                var createRequest = _mapper.Map<CreateTaskRequest>(ticket);
                
                // è®¾ç½®ä»»åŠ¡æ¸…å•
                createRequest.Tasklists = new[]
                {
                    new TaskInTaskListInfo
                    {
                        TasklistGuid = GetTaskListByPriority(ticket.Priority),
                        CustomFields = GetCustomFieldsForTicket(ticket)
                    }
                };
    
                // è®¾ç½®ä»»åŠ¡æˆå‘˜
                var assignees = await GetAssigneesForTicket(ticket);
                createRequest.Members = assignees.Select(u => new TaskMemberInfo
                {
                    UserId = u.FeishuUserId,
                    UserType = UserType.User,
                    TaskRole = TaskRole.Assignee
                }).ToArray();
    
                // è®¾ç½®æˆªæ­¢æ—¶é—´
                if (ticket.DueDate.HasValue)
                {
                    createRequest.Due = new TaskTime
                    {
                        Timestamp = ((DateTimeOffset)ticket.DueDate.Value).ToUnixTimeMilliseconds().ToString()
                    };
                }
    
                // è®¾ç½®æé†’
                if (ticket.Priority == TicketPriority.High)
                {
                    createRequest.Reminders = new[]
                    {
                        new TaskReminder
                        {
                            MinutesBefore = 60, // 1å°æ—¶å‰æé†’
                            ReminderType = ReminderType.Push
                        }
                    };
                }
    
                var result = await _taskApi.CreateTaskAsync(createRequest);
                
                if (result?.Code == 0 && result.Data != null)
                {
                    _logger.LogInformation("æˆåŠŸåˆ›å»ºé£ä¹¦ä»»åŠ¡ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                        ticket.Id, result.Data.Task.Guid);
                    return result.Data.Task.Guid;
                }
                
                _logger.LogError("åˆ›å»ºé£ä¹¦ä»»åŠ¡å¤±è´¥ï¼Œå·¥å•ID: {TicketId}, é”™è¯¯: {Error}", 
                    ticket.Id, result?.Msg);
                throw new FeishuException($"åˆ›å»ºé£ä¹¦ä»»åŠ¡å¤±è´¥: {result?.Msg}");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ›å»ºé£ä¹¦ä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå·¥å•ID: {TicketId}", ticket.Id);
                throw;
            }
        }
    
        public async Task<bool> UpdateTaskAsync(string taskGuid, UpdateTaskRequest request)
        {
            try
            {
                var result = await _taskApi.UpdateTaskAsync(taskGuid, request);
                var success = result?.Code == 0;
                
                if (success)
                {
                    _logger.LogInformation("æˆåŠŸæ›´æ–°é£ä¹¦ä»»åŠ¡ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
                }
                else
                {
                    _logger.LogWarning("æ›´æ–°é£ä¹¦ä»»åŠ¡å¤±è´¥ï¼Œä»»åŠ¡ID: {TaskGuid}, é”™è¯¯: {Error}", 
                        taskGuid, result?.Msg);
                }
                
                return success;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ›´æ–°é£ä¹¦ä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
                return false;
            }
        }
    
        public async Task<TaskInfo?> GetTaskAsync(string taskGuid)
        {
            try
            {
                var result = await _taskApi.GetTaskByIdAsync(taskGuid);
                return result?.Code == 0 ? result.Data?.Task : null;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "è·å–é£ä¹¦ä»»åŠ¡è¯¦æƒ…æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
                return null;
            }
        }
    
        public async Task<bool> DeleteTaskAsync(string taskGuid)
        {
            try
            {
                var result = await _taskApi.DeleteTaskByIdAsync(taskGuid);
                var success = result?.Code == 0;
                
                if (success)
                {
                    _logger.LogInformation("æˆåŠŸåˆ é™¤é£ä¹¦ä»»åŠ¡ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
                }
                
                return success;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ é™¤é£ä¹¦ä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
                return false;
            }
        }
    
        private string GetTaskListByPriority(TicketPriority priority)
        {
            return priority switch
            {
                TicketPriority.High => "high_priority_tasklist_guid",
                TicketPriority.Medium => "medium_priority_tasklist_guid",
                TicketPriority.Low => "low_priority_tasklist_guid",
                _ => "default_tasklist_guid"
            };
        }
    
        private CustomFieldValue[] GetCustomFieldsForTicket(Ticket ticket)
        {
            return new[]
            {
                new CustomFieldValue
                {
                    FieldId = "ticket_id_field",
                    TextValue = ticket.Id
                },
                new CustomFieldValue
                {
                    FieldId = "customer_field",
                    TextValue = ticket.CustomerName
                },
                new CustomFieldValue
                {
                    FieldId = "project_field",
                    SingleSelectValue = new EnumValue
                    {
                        Id = ticket.ProjectId.ToString()
                    }
                }
            };
        }
    }
    

#### WebSocketå¤„ç†å™¨ï¼šé£ä¹¦äº‹ä»¶"å¿«é€’å‘˜"

    public class TaskEventHandler : IFeishuEventHandler
    {
        private readonly IFeishuTaskService _taskService;
        private readonly ITicketSyncService _syncService;
        private readonly ILogger<TaskEventHandler> _logger;
    
        public TaskEventHandler(
            IFeishuTaskService taskService,
            ITicketSyncService syncService,
            ILogger<TaskEventHandler> logger)
        {
            _taskService = taskService;
            _syncService = syncService;
            _logger = logger;
        }
    
        public string SupportedEventType => "task.status_changed";
    
        public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
        {
            try
            {
                switch (eventData.EventType)
                {
                    case "task.status_changed":
                        await HandleTaskStatusChangedAsync(eventData);
                        break;
                        
                    case "task.assignee_updated":
                        await HandleAssigneeUpdatedAsync(eventData);
                        break;
                        
                    case "task.comment_added":
                        await HandleCommentAddedAsync(eventData);
                        break;
                        
                    default:
                        _logger.LogDebug("æ”¶åˆ°æœªå¤„ç†çš„ä»»åŠ¡äº‹ä»¶ç±»å‹: {EventType}", eventData.EventType);
                        break;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å¤„ç†é£ä¹¦ä»»åŠ¡äº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œäº‹ä»¶ç±»å‹: {EventType}", eventData.EventType);
            }
        }
    
        private async Task HandleTaskStatusChangedAsync(EventData eventData)
        {
            var taskEvent = JsonSerializer.Deserialize<TaskStatusChangedEvent>(eventData.Data.ToString());
            
            _logger.LogInformation("ä»»åŠ¡çŠ¶æ€å˜æ›´ï¼Œä»»åŠ¡ID: {TaskGuid}, æ–°çŠ¶æ€: {Status}", 
                taskEvent.Task.Guid, taskEvent.Task.Status);
    
            // åŒæ­¥åˆ°å·¥å•ç³»ç»Ÿ
            await _syncService.SyncTaskStatusToTicketAsync(taskEvent.Task.Guid, taskEvent.Task.Status);
            
            // å‘é€é€šçŸ¥
            if (taskEvent.Task.Status == "done")
            {
                await NotifyTaskCompletedAsync(taskEvent.Task);
            }
        }
    
        private async Task HandleAssigneeUpdatedAsync(EventData eventData)
        {
            var taskEvent = JsonSerializer.Deserialize<AssigneeUpdatedEvent>(eventData.Data.ToString());
            
            _logger.LogInformation("ä»»åŠ¡è´Ÿè´£äººæ›´æ–°ï¼Œä»»åŠ¡ID: {TaskGuid}", taskEvent.Task.Guid);
            
            // åŒæ­¥åˆ†é…äººä¿¡æ¯åˆ°å·¥å•
            await _syncService.SyncTaskAssigneeToTicketAsync(taskEvent.Task.Guid, taskEvent.Task.Members);
        }
    
        private async Task NotifyTaskCompletedAsync(TaskInfo task)
        {
            // å‘é€é£ä¹¦é€šçŸ¥åˆ°ç›¸å…³ç¾¤ç»„
            // è¿™é‡Œå¯ä»¥è°ƒç”¨é£ä¹¦æ¶ˆæ¯APIå‘é€é€šçŸ¥
        }
    }
    

### 3\. ä¸šåŠ¡é¢†åŸŸé€‚é…

#### å¯¹è±¡æ˜ å°„è®¾è®¡ï¼šå·¥å• â†” é£ä¹¦ä»»åŠ¡å­—æ®µå¯¹ç…§è¡¨

graph LR subgraph "å·¥å•ç³»ç»Ÿ" A\[Ticket\] --> B\[Id\] A --> C\[Title\] A --> D\[Description\] A --> E\[Priority\] A --> F\[Assignee\] A --> G\[DueDate\] end subgraph "æ˜ å°„è½¬æ¢" H\[AutoMapper\] I\[ä¸šåŠ¡è§„åˆ™å¼•æ“\] J\[æ•°æ®è½¬æ¢å™¨\] end subgraph "é£ä¹¦ä»»åŠ¡" K\[CreateTaskRequest\] --> L\[Summary\] K --> M\[Description\] K --> N\[IsMilestone\] K --> O\[Members\] K --> P\[Due\] K --> Q\[Tasklists\] end B --> H C --> H D --> I E --> I F --> J G --> J H --> L I --> N J --> O J --> P style H fill:#e1f5fe style I fill:#e8f5e8 style J fill:#fff3e0

ä½¿ç”¨AutoMapperè¿›è¡Œå¯¹è±¡æ˜ å°„é…ç½®ï¼š

    public class FeishuMappingProfile : Profile
    {
        public FeishuMappingProfile()
        {
            // å·¥å• -> é£ä¹¦ä»»åŠ¡åˆ›å»ºè¯·æ±‚
            CreateMap<Ticket, CreateTaskRequest>()
                .ForMember(dest => dest.Summary, opt => opt.MapFrom(src => $"[å·¥å•#{src.Id}] {src.Title}"))
                .ForMember(dest => dest.Description, opt => opt.MapFrom(src => BuildTaskDescription(src)))
                .ForMember(dest => dest.Start, opt => opt.MapFrom(src => src.CreatedDate.HasValue 
                    ? new TasksStartTime { Timestamp = ((DateTimeOffset)src.CreatedDate.Value).ToUnixTimeMilliseconds().ToString() } 
                    : null))
                .ForMember(dest => dest.Mode, opt => opt.MapFrom(src => src.AssigneeCount > 1 ? 2 : 1)) // æˆ–ç­¾/ä¼šç­¾
                .ForMember(dest => dest.IsMilestone, opt => opt.MapFrom(src => src.Priority == TicketPriority.High));
    
            // é£ä¹¦ä»»åŠ¡ -> å·¥å•çŠ¶æ€æ›´æ–°
            CreateMap<TaskInfo, TicketStatusUpdate>()
                .ForMember(dest => dest.TicketId, opt => opt.MapFrom(src => ExtractTicketId(src.Extra)))
                .ForMember(dest => dest.Status, opt => opt.MapFrom(src => MapTaskStatusToTicketStatus(src.Status)))
                .ForMember(dest => dest.CompletedAt, opt => opt.MapFrom(src => ParseCompletedAt(src.CompletedAt)));
        }
    
        private string BuildTaskDescription(Ticket ticket)
        {
            var description = new StringBuilder();
            description.AppendLine($"**å®¢æˆ·ï¼š** {ticket.CustomerName}");
            description.AppendLine($"**é¡¹ç›®ï¼š** {ticket.ProjectName}");
            description.AppendLine($"**ä¼˜å…ˆçº§ï¼š** {ticket.Priority}");
            description.AppendLine();
            description.AppendLine("**é—®é¢˜æè¿°ï¼š**");
            description.AppendLine(ticket.Description);
            
            if (!string.IsNullOrEmpty(ticket.Attachments))
            {
                description.AppendLine();
                description.AppendLine("**é™„ä»¶ï¼š**");
                description.AppendLine(ticket.Attachments);
            }
            
            return description.ToString();
        }
    
        private TicketStatus MapTaskStatusToTicketStatus(string? taskStatus)
        {
            return taskStatus switch
            {
                "todo" => TicketStatus.InProgress,
                "done" => TicketStatus.Resolved,
                _ => TicketStatus.Open
            };
        }
    }
    

#### åŒæ­¥ç­–ç•¥å®ç°

    public class TicketSyncService : ITicketSyncService
    {
        private readonly IFeishuTaskService _feishuTaskService;
        private readonly ITicketRepository _ticketRepository;
        private readonly INotificationService _notificationService;
        private readonly ILogger<TicketSyncService> _logger;
    
        // å®æ—¶äº‹ä»¶ç›‘å¬ï¼ˆå·¥å•åˆ›å»º/æ›´æ–°ï¼‰
        public async Task HandleTicketCreatedAsync(Ticket ticket)
        {
            try
            {
                // åªä¸ºé«˜ä¼˜å…ˆçº§å·¥å•åˆ›å»ºé£ä¹¦ä»»åŠ¡
                if (ticket.Priority >= TicketPriority.Medium)
                {
                    var taskGuid = await _feishuTaskService.CreateTaskFromTicketAsync(ticket);
                    ticket.FeishuTaskId = taskGuid;
                    await _ticketRepository.UpdateAsync(ticket);
                    
                    _logger.LogInformation("ä¸ºæ–°å·¥å•åˆ›å»ºé£ä¹¦ä»»åŠ¡ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                        ticket.Id, taskGuid);
                    
                    // å‘é€é€šçŸ¥
                    await _notificationService.NotifyTaskCreatedAsync(ticket, taskGuid);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å¤„ç†å·¥å•åˆ›å»ºäº‹ä»¶æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå·¥å•ID: {TicketId}", ticket.Id);
            }
        }
    
        // å®šæ—¶å…¨é‡åŒæ­¥ï¼ˆé˜²ä¸¢å¤±ï¼‰
        public async Task ReconcileTasksAsync()
        {
            _logger.LogInformation("å¼€å§‹æ‰§è¡Œä»»åŠ¡å¯¹è´¦...");
    
            try
            {
                // è·å–æ‰€æœ‰å…³è”äº†é£ä¹¦ä»»åŠ¡çš„å·¥å•
                var ticketsWithTasks = await _ticketRepository.GetTicketsWithFeishuTasksAsync();
                
                foreach (var ticket in ticketsWithTasks)
                {
                    if (string.IsNullOrEmpty(ticket.FeishuTaskId))
                        continue;
    
                    // æ£€æŸ¥é£ä¹¦ä»»åŠ¡æ˜¯å¦å­˜åœ¨ä¸”çŠ¶æ€ä¸€è‡´
                    var task = await _feishuTaskService.GetTaskAsync(ticket.FeishuTaskId);
                    
                    if (task == null)
                    {
                        _logger.LogWarning("é£ä¹¦ä»»åŠ¡ä¸å­˜åœ¨ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                            ticket.Id, ticket.FeishuTaskId);
                        
                        // é‡æ–°åˆ›å»ºä»»åŠ¡
                        var newTaskGuid = await _feishuTaskService.CreateTaskFromTicketAsync(ticket);
                        ticket.FeishuTaskId = newTaskGuid;
                        await _ticketRepository.UpdateAsync(ticket);
                    }
                    else if (MapTaskStatusToTicketStatus(task.Status) != ticket.Status)
                    {
                        // çŠ¶æ€ä¸ä¸€è‡´ï¼ŒåŒæ­¥é£ä¹¦ä»»åŠ¡çŠ¶æ€åˆ°å·¥å•
                        await SyncTaskStatusToTicketAsync(ticket.FeishuTaskId, task.Status);
                    }
                }
                
                _logger.LogInformation("ä»»åŠ¡å¯¹è´¦å®Œæˆ");
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ‰§è¡Œä»»åŠ¡å¯¹è´¦æ—¶å‘ç”Ÿå¼‚å¸¸");
            }
        }
    
        public async Task SyncTaskStatusToTicketAsync(string taskGuid, string taskStatus)
        {
            try
            {
                var ticketId = ExtractTicketIdFromTask(taskGuid);
                if (string.IsNullOrEmpty(ticketId))
                    return;
    
                var ticket = await _ticketRepository.GetByIdAsync(ticketId);
                if (ticket == null)
                    return;
    
                var newStatus = MapTaskStatusToTicketStatus(taskStatus);
                if (ticket.Status != newStatus)
                {
                    ticket.Status = newStatus;
                    ticket.StatusUpdatedBy = "FeishuSync";
                    ticket.StatusUpdatedAt = DateTime.UtcNow;
                    
                    await _ticketRepository.UpdateAsync(ticket);
                    
                    _logger.LogInformation("åŒæ­¥é£ä¹¦ä»»åŠ¡çŠ¶æ€åˆ°å·¥å•ï¼Œä»»åŠ¡ID: {TaskGuid}, å·¥å•ID: {TicketId}, æ–°çŠ¶æ€: {Status}", 
                        taskGuid, ticketId, newStatus);
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åŒæ­¥é£ä¹¦ä»»åŠ¡çŠ¶æ€åˆ°å·¥å•æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œä»»åŠ¡ID: {TaskGuid}", taskGuid);
            }
        }
    }
    

#### å®¹é”™è®¾è®¡ï¼šå¼‚å¸¸åˆ†ç±»ã€é‡è¯•ç­–ç•¥ã€æ­»ä¿¡é˜Ÿåˆ—

    public class FaultTolerantTaskService : IFeishuTaskService
    {
        private readonly IFeishuTaskService _innerService;
        private readonly IAsyncPolicy _retryPolicy;
        private readonly ILogger<FaultTolerantTaskService> _logger;
        private readonly IDeadLetterQueue _deadLetterQueue;
    
        public FaultTolerantTaskService(
            IFeishuTaskService innerService,
            ILogger<FaultTolerantTaskService> logger,
            IDeadLetterQueue deadLetterQueue)
        {
            _innerService = innerService;
            _logger = logger;
            _deadLetterQueue = deadLetterQueue;
            
            // é…ç½®é‡è¯•ç­–ç•¥
            _retryPolicy = Policy
                .Handle<FeishuApiException>(ex => ex.IsTransient)
                .Or<HttpRequestException>()
                .WaitAndRetryAsync(
                    retryCount: 3,
                    sleepDurationProvider: retryAttempt => TimeSpan.FromSeconds(Math.Pow(2, retryAttempt)),
                    onRetry: (outcome, timespan, retryAttempt, context) =>
                    {
                        _logger.LogWarning("æ“ä½œå¤±è´¥ï¼Œå‡†å¤‡ç¬¬{RetryAttempt}æ¬¡é‡è¯•ï¼Œå»¶è¿Ÿ{Delay}ms", 
                            retryAttempt, timespan.TotalMilliseconds);
                    });
        }
    
        public async Task<string> CreateTaskFromTicketAsync(Ticket ticket)
        {
            try
            {
                return await _retryPolicy.ExecuteAsync(() => _innerService.CreateTaskFromTicketAsync(ticket));
            }
            catch (Exception ex)
            {
                // éä¸´æ—¶æ€§å¼‚å¸¸æˆ–é‡è¯•æ¬¡æ•°è€—å°½ï¼ŒåŠ å…¥æ­»ä¿¡é˜Ÿåˆ—
                await _deadLetterQueue.EnqueueAsync(new DeadLetterMessage
                {
                    Operation = "CreateTask",
                    Data = ticket,
                    Exception = ex,
                    Timestamp = DateTime.UtcNow
                });
                
                _logger.LogError(ex, "åˆ›å»ºé£ä¹¦ä»»åŠ¡å¤±è´¥å¹¶åŠ å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼Œå·¥å•ID: {TicketId}", ticket.Id);
                throw;
            }
        }
    }
    

### 4\. å…³é”®ä»£ç ç‰‡æ®µ

#### OAuth 2.0æˆæƒæµç¨‹å®ç°ï¼ˆå«åˆ·æ–°é€»è¾‘ï¼‰

Mud.Feishuå·²ç»å†…ç½®äº†å®Œæ•´çš„OAuthæµç¨‹ï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®ï¼š

    // appsettings.jsonä¸­çš„é…ç½®
    {
      "Feishu": {
        "AppId": "cli_xxxxxxxxxxxxxxxx",
        "AppSecret": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
      }
    }
    
    // æœåŠ¡æ³¨å†Œ
    builder.Services.AddFeishuApiService(builder.Configuration);
    

#### åˆ›å»ºä»»åŠ¡å¹¶å…³è”å·¥å•çš„å®Œæ•´ç¤ºä¾‹

    [ApiController]
    [Route("api/[controller]")]
    public class TicketController : ControllerBase
    {
        private readonly ITicketService _ticketService;
        private readonly IFeishuTaskService _feishuTaskService;
        private readonly ITicketSyncService _syncService;
    
        [HttpPost]
        public async Task<IActionResult> CreateTicket([FromBody] CreateTicketRequest request)
        {
            try
            {
                // 1. åˆ›å»ºå·¥å•
                var ticket = await _ticketService.CreateTicketAsync(request);
                
                // 2. å¦‚æœæ˜¯é«˜ä¼˜å…ˆçº§å·¥å•ï¼Œè‡ªåŠ¨åˆ›å»ºé£ä¹¦ä»»åŠ¡
                if (ticket.Priority >= TicketPriority.Medium)
                {
                    var taskGuid = await _feishuTaskService.CreateTaskFromTicketAsync(ticket);
                    ticket.FeishuTaskId = taskGuid;
                    await _ticketService.UpdateTicketAsync(ticket);
                }
                
                return Ok(new { TicketId = ticket.Id, FeishuTaskId = ticket.FeishuTaskId });
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åˆ›å»ºå·¥å•æ—¶å‘ç”Ÿå¼‚å¸¸");
                return StatusCode(500, new { Error = "åˆ›å»ºå·¥å•å¤±è´¥" });
            }
        }
    
        [HttpPut("{id}/status")]
        public async Task<IActionResult> UpdateTicketStatus(string id, [FromBody] UpdateStatusRequest request)
        {
            try
            {
                var ticket = await _ticketService.GetTicketAsync(id);
                if (ticket == null)
                    return NotFound();
    
                // æ›´æ–°å·¥å•çŠ¶æ€
                ticket.Status = request.Status;
                await _ticketService.UpdateTicketAsync(ticket);
    
                // åŒæ­¥åˆ°é£ä¹¦ä»»åŠ¡
                if (!string.IsNullOrEmpty(ticket.FeishuTaskId))
                {
                    var updateRequest = new UpdateTaskRequest
                    {
                        Status = MapTicketStatusToTaskStatus(request.Status),
                        CompletedAt = request.Status == TicketStatus.Resolved ? 
                            DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString() : null
                    };
                    
                    await _feishuTaskService.UpdateTaskAsync(ticket.FeishuTaskId, updateRequest);
                }
    
                return Ok();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "æ›´æ–°å·¥å•çŠ¶æ€æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå·¥å•ID: {TicketId}", id);
                return StatusCode(500, new { Error = "æ›´æ–°çŠ¶æ€å¤±è´¥" });
            }
        }
    }
    

#### WebSocketå¤„ç†å™¨ä¸ä¸šåŠ¡é€»è¾‘è§£è€¦è®¾è®¡

    public class FeishuWebSocketBackgroundService : BackgroundService
    {
        private readonly IFeishuWebSocketManager _webSocketManager;
        private readonly IEnumerable<IFeishuWebSocketEventHandler> _handlers;
        private readonly ILogger<FeishuWebSocketBackgroundService> _logger;
    
        protected override async Task ExecuteAsync(CancellationToken stoppingToken)
        {
            // å¯åŠ¨WebSocketè¿æ¥
            await _webSocketManager.StartAsync(stoppingToken);
            
            // è®¢é˜…äº‹ä»¶
            _webSocketManager.MessageReceived += async (sender, e) =>
            {
                await HandleMessageAsync(e.Message);
            };
    
            _webSocketManager.Error += async (sender, e) =>
            {
                _logger.LogError(e.Exception, "WebSocketè¿æ¥å‘ç”Ÿé”™è¯¯");
                await HandleErrorAsync(e.Exception);
            };
    
            _webSocketManager.Disconnected += async (sender, e) =>
            {
                _logger.LogWarning("WebSocketè¿æ¥æ–­å¼€ï¼ŒåŸå› : {Reason}", e.CloseStatusDescription);
                await HandleDisconnectionAsync();
            };
    
            // ä¿æŒæœåŠ¡è¿è¡Œ
            while (!stoppingToken.IsCancellationRequested)
            {
                await Task.Delay(1000, stoppingToken);
            }
        }
    
        private async Task HandleMessageAsync(FeishuWebSocketMessage message)
        {
            var tasks = _handlers.Select(handler => 
                SafeHandleAsync(handler, message));
            
            await Task.WhenAll(tasks);
        }
    
        private async Task SafeHandleAsync(IFeishuWebSocketEventHandler handler, FeishuWebSocketMessage message)
        {
            try
            {
                await handler.HandleAsync(message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "äº‹ä»¶å¤„ç†å™¨å¤„ç†æ¶ˆæ¯æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œå¤„ç†å™¨ç±»å‹: {HandlerType}", 
                    handler.GetType().Name);
            }
        }
    }
    

åº”ç”¨åœºæ™¯è½åœ°è¯¦è§£
--------

### ğŸ”§ åœºæ™¯ä¸€ï¼šè®©å·¥å•"æ´»"èµ·æ¥â€”â€”è‡ªåŠ¨é£ä¹¦ä»»åŠ¡ç”Ÿæˆ

#### å·¥å•åˆ°ä»»åŠ¡çš„"å˜èº«"è¿‡ç¨‹

sequenceDiagram participant C as å®¢æˆ·/ç³»ç»Ÿ participant T as å·¥å•ç³»ç»Ÿ participant E as äº‹ä»¶æ€»çº¿ participant S as åŒæ­¥æœåŠ¡ participant F as é£ä¹¦API participant N as é€šçŸ¥æœåŠ¡ Note over C,N: å·¥å•è‡ªåŠ¨ç”Ÿæˆé£ä¹¦ä»»åŠ¡æµç¨‹ C->>T: æäº¤å·¥å• T->>T: éªŒè¯å·¥å•ä¿¡æ¯ T->>T: ä¿å­˜å·¥å•åˆ°æ•°æ®åº“ alt é«˜ä¼˜å…ˆçº§å·¥å• T->>E: å‘å¸ƒå·¥å•åˆ›å»ºäº‹ä»¶ E->>S: è®¢é˜…äº‹ä»¶å¤„ç† S->>S: æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºä»»åŠ¡ S->>F: è°ƒç”¨é£ä¹¦ä»»åŠ¡API F-->>S: è¿”å›ä»»åŠ¡ID S->>T: æ›´æ–°å·¥å•å…³è”ID S->>N: å‘é€åˆ›å»ºé€šçŸ¥ end alt å®¢æˆ·æ ‡è®°ç´§æ€¥ T->>E: å‘å¸ƒç´§æ€¥æ ‡è®°äº‹ä»¶ E->>S: å¤„ç†ç´§æ€¥äº‹ä»¶ S->>F: åˆ›å»ºæˆ–æ›´æ–°ä»»åŠ¡ä¼˜å…ˆçº§ S->>N: å‘é€ç´§æ€¥é€šçŸ¥ end alt SLAé¢„è­¦ T->>E: å‘å¸ƒSLAé¢„è­¦äº‹ä»¶ E->>S: å¤„ç†SLAé¢„è­¦ S->>F: åˆ›å»ºä»»åŠ¡å¹¶è®¾ç½®æé†’ end

#### ä»€ä¹ˆæ—¶å€™è¯¥"å˜èº«"ï¼Ÿâ€”â€”è§¦å‘æ—¶æœºæ­ç§˜

å°±åƒè¶…çº§è‹±é›„æœ‰è‡ªå·±çš„"å˜èº«"æ¡ä»¶ï¼Œæˆ‘ä»¬çš„å·¥å•ä¹Ÿéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºæ‰ç”Ÿæˆé£ä¹¦ä»»åŠ¡ï¼š

    public class TaskCreationTrigger
    {
        // 1. é«˜ä¼˜å…ˆçº§å·¥å•åˆ›å»ºæ—¶è‡ªåŠ¨è§¦å‘
        public async Task HandleTicketCreatedAsync(TicketCreatedEvent @event)
        {
            if (@event.Ticket.Priority >= TicketPriority.High)
            {
                await CreateFeishuTaskAsync(@event.Ticket);
            }
        }
    
        // 2. å®¢æˆ·æ ‡è®°ç´§æ€¥æ—¶è§¦å‘
        public async Task HandleTicketMarkedUrgentAsync(TicketMarkedUrgentEvent @event)
        {
            // å¦‚æœè¿˜æ²¡æœ‰é£ä¹¦ä»»åŠ¡ï¼Œç«‹å³åˆ›å»º
            if (string.IsNullOrEmpty(@event.Ticket.FeishuTaskId))
            {
                await CreateFeishuTaskAsync(@event.Ticket);
            }
            else
            {
                // æ›´æ–°ç°æœ‰ä»»åŠ¡ä¼˜å…ˆçº§
                await UpdateTaskPriorityAsync(@event.Ticket.FeishuTaskId, TicketPriority.High);
            }
        }
    
        // 3. SLAå³å°†è¶…æ—¶é¢„è­¦æ—¶è§¦å‘
        public async Task HandleSLAWarningAsync(SLAWarningEvent @event)
        {
            if (@event.Ticket.Priority >= TicketPriority.Medium)
            {
                await CreateFeishuTaskAsync(@event.Ticket);
            }
        }
    }
    

#### å®ç°æ­¥éª¤

**ç¬¬ä¸€æ­¥ï¼šç›‘å¬å·¥å•é¢†åŸŸäº‹ä»¶**

    [ApiController]
    [Route("api/tickets")]
    public class TicketsController : ControllerBase
    {
        private readonly ITicketService _ticketService;
        private readonly IEventBus _eventBus;
        private readonly ILogger<TicketsController> _logger;
    
        [HttpPost]
        public async Task<IActionResult> CreateTicket([FromBody] CreateTicketRequest request)
        {
            var ticket = await _ticketService.CreateTicketAsync(request);
            
            // å‘å¸ƒé¢†åŸŸäº‹ä»¶
            await _eventBus.PublishAsync(new TicketCreatedEvent { Ticket = ticket });
            
            return CreatedAtAction(nameof(GetTicket), new { id = ticket.Id }, ticket);
        }
    
        [HttpPut("{id}/urgent")]
        public async Task<IActionResult> MarkAsUrgent(string id)
        {
            var ticket = await _ticketService.MarkAsUrgentAsync(id);
            
            // å‘å¸ƒç´§æ€¥æ ‡è®°äº‹ä»¶
            await _eventBus.PublishAsync(new TicketMarkedUrgentEvent { Ticket = ticket });
            
            return Ok(ticket);
        }
    }
    

**ç¬¬äºŒæ­¥ï¼šæ„å»ºé£ä¹¦ä»»åŠ¡**

    public class FeishuTaskBuilder
    {
        private readonly IUserService _userService;
        private readonly IProjectService _projectService;
    
        public async Task<CreateTaskRequest> BuildTaskAsync(Ticket ticket)
        {
            var task = new CreateTaskRequest
            {
                Summary = $"[å·¥å•#{ticket.Id}] {ticket.Title}",
                Description = await BuildDescriptionAsync(ticket),
                Extra = JsonSerializer.Serialize(new { TicketId = ticket.Id }),
                ClientToken = Guid.NewGuid().ToString() // å¹‚ç­‰Token
            };
    
            // è®¾ç½®æˆªæ­¢æ—¶é—´
            if (ticket.SlaDeadline.HasValue)
            {
                task.Due = new TaskTime
                {
                    Timestamp = ((DateTimeOffset)ticket.SlaDeadline.Value).ToUnixTimeMilliseconds().ToString()
                };
            }
    
            // è®¾ç½®å¼€å§‹æ—¶é—´
            task.Start = new TasksStartTime
            {
                Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString()
            };
    
            // è®¾ç½®ä»»åŠ¡æ¨¡å¼
            task.Mode = ticket.Assignees?.Count > 1 ? 2 : 1; // å¤šäººæ—¶ç”¨æˆ–ç­¾
    
            // è®¾ç½®é‡Œç¨‹ç¢‘æ ‡è¯†
            task.IsMilestone = ticket.Priority == TicketPriority.High;
    
            // è®¾ç½®æé†’è§„åˆ™
            task.Reminders = BuildReminders(ticket);
    
            // è®¾ç½®ä»»åŠ¡æˆå‘˜
            task.Members = await BuildTaskMembersAsync(ticket);
    
            // è®¾ç½®æ‰€å±æ¸…å•
            task.Tasklists = new[]
            {
                new TaskInTaskListInfo
                {
                    TasklistGuid = await GetTaskListGuidAsync(ticket),
                    CustomFields = await BuildCustomFieldsAsync(ticket)
                }
            };
    
            return task;
        }
    
        private async Task<string> BuildDescriptionAsync(Ticket ticket)
        {
            var description = new StringBuilder();
            
            // åŸºæœ¬ä¿¡æ¯
            description.AppendLine($"**å®¢æˆ·ï¼š** {ticket.CustomerName}");
            description.AppendLine($"**è”ç³»ç”µè¯ï¼š** {ticket.CustomerPhone}");
            description.AppendLine($"**é¡¹ç›®ï¼š** {ticket.ProjectName}");
            description.AppendLine($"**ä¼˜å…ˆçº§ï¼š** {GetPriorityDisplay(ticket.Priority)}");
            description.AppendLine($"**åˆ›å»ºæ—¶é—´ï¼š** {ticket.CreatedAt:yyyy-MM-dd HH:mm:ss}");
            
            if (ticket.SlaDeadline.HasValue)
            {
                description.AppendLine($"**SLAæˆªæ­¢æ—¶é—´ï¼š** {ticket.SlaDeadline:yyyy-MM-dd HH:mm:ss}");
            }
            
            description.AppendLine();
    
            // é—®é¢˜æè¿°
            description.AppendLine("## é—®é¢˜æè¿°");
            description.AppendLine(ticket.Description);
    
            // é™„ä»¶ä¿¡æ¯
            if (!string.IsNullOrEmpty(ticket.Attachments))
            {
                description.AppendLine();
                description.AppendLine("## ç›¸å…³é™„ä»¶");
                description.AppendLine(ticket.Attachments);
            }
    
            // å¤„ç†å†å²
            if (ticket.History?.Any() == true)
            {
                description.AppendLine();
                description.AppendLine("## å¤„ç†å†å²");
                foreach (var history in ticket.History.Take(3))
                {
                    description.AppendLine($"- {history.CreatedAt:MM-dd HH:mm} {history.Operator}ï¼š{history.Action}");
                }
            }
    
            return description.ToString();
        }
    
        private TaskReminder[] BuildReminders(Ticket ticket)
        {
            var reminders = new List<TaskReminder>();
    
            // é«˜ä¼˜å…ˆçº§ä»»åŠ¡è®¾ç½®å¤šä¸ªæé†’
            if (ticket.Priority == TicketPriority.High)
            {
                reminders.Add(new TaskReminder
                {
                    MinutesBefore = 120, // 2å°æ—¶å‰æé†’
                    ReminderType = ReminderType.Push
                });
                
                reminders.Add(new TaskReminder
                {
                    MinutesBefore = 60, // 1å°æ—¶å‰æé†’
                    ReminderType = ReminderType.Push
                });
            }
            else if (ticket.Priority == TicketPriority.Medium)
            {
                reminders.Add(new TaskReminder
                {
                    MinutesBefore = 240, // 4å°æ—¶å‰æé†’
                    ReminderType = ReminderType.Push
                });
            }
    
            return reminders.ToArray();
        }
    
        private async Task<TaskMemberInfo[]> BuildTaskMembersAsync(Ticket ticket)
        {
            var members = new List<TaskMemberInfo>();
    
            // æ·»åŠ è´Ÿè´£äºº
            if (!string.IsNullOrEmpty(ticket.AssigneeId))
            {
                var assignee = await _userService.GetByIdAsync(ticket.AssigneeId);
                if (assignee?.FeishuUserId != null)
                {
                    members.Add(new TaskMemberInfo
                    {
                        UserId = assignee.FeishuUserId,
                        UserType = UserType.User,
                        TaskRole = TaskRole.Assignee
                    });
                }
            }
    
            // æ·»åŠ å…³æ³¨äºº
            if (ticket.Watchers?.Any() == true)
            {
                foreach (var watcherId in ticket.Watchers)
                {
                    var watcher = await _userService.GetByIdAsync(watcherId);
                    if (watcher?.FeishuUserId != null)
                    {
                        members.Add(new TaskMemberInfo
                        {
                            UserId = watcher.FeishuUserId,
                            UserType = UserType.User,
                            TaskRole = TaskRole.Follower
                        });
                    }
                }
            }
    
            // æ·»åŠ é¡¹ç›®ç»ç†ä½œä¸ºå…³æ³¨äºº
            var project = await _projectService.GetByIdAsync(ticket.ProjectId);
            if (project?.ManagerFeishuUserId != null)
            {
                members.Add(new TaskMemberInfo
                {
                    UserId = project.ManagerFeishuUserId,
                    UserType = UserType.User,
                    TaskRole = TaskRole.Follower
                });
            }
    
            return members.ToArray();
        }
    }
    

**ç¬¬ä¸‰æ­¥ï¼šè°ƒç”¨APIå¹¶ä¿å­˜å…³è”ID**

    public class TaskCreationService
    {
        private readonly IFeishuTaskService _feishuTaskService;
        private readonly ITicketRepository _ticketRepository;
        private readonly ILogger<TaskCreationService> _logger;
    
        public async Task<string> CreateFeishuTaskAsync(Ticket ticket)
        {
            try
            {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»»åŠ¡
                if (!string.IsNullOrEmpty(ticket.FeishuTaskId))
                {
                    _logger.LogWarning("å·¥å•å·²å­˜åœ¨é£ä¹¦ä»»åŠ¡ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                        ticket.Id, ticket.FeishuTaskId);
                    return ticket.FeishuTaskId;
                }
    
                // åˆ›å»ºé£ä¹¦ä»»åŠ¡
                var taskRequest = await _taskBuilder.BuildTaskAsync(ticket);
                var taskGuid = await _feishuTaskService.CreateTaskAsync(taskRequest);
    
                // ä¿å­˜å…³è”å…³ç³»
                ticket.FeishuTaskId = taskGuid;
                ticket.FeishuTaskCreatedAt = DateTime.UtcNow;
                await _ticketRepository.UpdateAsync(ticket);
    
                _logger.LogInformation("æˆåŠŸä¸ºå·¥å•åˆ›å»ºé£ä¹¦ä»»åŠ¡ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                    ticket.Id, taskGuid);
    
                return taskGuid;
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "ä¸ºå·¥å•åˆ›å»ºé£ä¹¦ä»»åŠ¡å¤±è´¥ï¼Œå·¥å•ID: {TicketId}", ticket.Id);
                throw;
            }
        }
    }
    

**ç¬¬å››æ­¥ï¼šå‘é€å†…éƒ¨é€šçŸ¥**

    public class NotificationService
    {
        private readonly IFeishuMessageService _messageService;
        private readonly IProjectService _projectService;
    
        public async Task NotifyTaskCreatedAsync(Ticket ticket, string taskGuid)
        {
            try
            {
                var project = await _projectService.GetByIdAsync(ticket.ProjectId);
                
                var message = new CardMessageRequest
                {
                    ReceiveIdType = "chat_id",
                    ReceiveId = project.FeishuGroupId,
                    Card = new InteractiveCard
                    {
                        Header = new CardHeader
                        {
                            Title = "ğŸ¯ æ–°å·¥å•è½¬é£ä¹¦ä»»åŠ¡",
                            Template = "blue"
                        },
                        Elements = new List<ICardElement>
                        {
                            new CardMarkdown
                            {
                                Content = $"**å·¥å•ç¼–å·ï¼š** #{ticket.Id}\n" +
                                         $"**å®¢æˆ·ï¼š** {ticket.CustomerName}\n" +
                                         $"**ä¼˜å…ˆçº§ï¼š** {GetPriorityEmoji(ticket.Priority)} {ticket.Priority}\n" +
                                         $"**è´Ÿè´£äººï¼š** {ticket.AssigneeName}"
                            },
                            new CardButton
                            {
                                Text = new CardText
                                {
                                    Content = "æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…",
                                    Tag = "plain_text"
                                },
                                Type = "template",
                                Url = $"https://.feishu.cn/messenger/collection/task/detail/{taskGuid}"
                            }
                        }
                    }
                };
    
                await _messageService.SendCardMessageAsync(message);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å‘é€ä»»åŠ¡åˆ›å»ºé€šçŸ¥å¤±è´¥ï¼Œå·¥å•ID: {TicketId}", ticket.Id);
            }
        }
    
        private string GetPriorityEmoji(TicketPriority priority)
        {
            return priority switch
            {
                TicketPriority.High => "ğŸ”´",
                TicketPriority.Medium => "ğŸŸ¡",
                TicketPriority.Low => "ğŸŸ¢",
                _ => "âšª"
            };
        }
    }
    

#### æ³¨æ„äº‹é¡¹

1.  **é¿å…é‡å¤åˆ›å»º**ï¼šä½¿ç”¨å¹‚ç­‰Tokenå’Œæ•°æ®åº“å”¯ä¸€æ€§çº¦æŸ
2.  **å­—æ®µé»˜è®¤å€¼å¤„ç†**ï¼šåˆç†è®¾ç½®ä»»åŠ¡çš„é»˜è®¤ä¼˜å…ˆçº§å’Œæˆªæ­¢æ—¶é—´
3.  **å¼‚å¸¸å¤„ç†**ï¼šç½‘ç»œå¼‚å¸¸æ—¶çš„é‡è¯•æœºåˆ¶å’Œæœ¬åœ°ç¼“å­˜
4.  **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡å¤„ç†å’Œå¼‚æ­¥æ“ä½œ

### ğŸ”„ åœºæ™¯äºŒï¼šä»»åŠ¡çŠ¶æ€åŒå‘åŒæ­¥

#### çŠ¶æ€åŒæ­¥æµç¨‹å›¾

graph TB subgraph "é£ä¹¦ â†’ ç³»ç»Ÿ" A\[é£ä¹¦ä»»åŠ¡çŠ¶æ€å˜æ›´\] --> B\[Webhookäº‹ä»¶\] B --> C\[äº‹ä»¶éªŒè¯å™¨\] C --> D\[çŠ¶æ€æ˜ å°„å™¨\] D --> E\[ä¸šåŠ¡è§„åˆ™æ ¡éªŒ\] E --> F\[æ›´æ–°å·¥å•çŠ¶æ€\] F --> G\[è®°å½•æ“ä½œæ—¥å¿—\] G --> H\[å‘é€é€šçŸ¥\] end subgraph "ç³»ç»Ÿ â†’ é£ä¹¦" I\[å·¥å•çŠ¶æ€å˜æ›´\] --> J\[çŠ¶æ€æ˜ å°„å™¨\] J --> K\[APIè°ƒç”¨\] K --> L\[æ›´æ–°é£ä¹¦ä»»åŠ¡\] L --> M\[å¼‚å¸¸é‡è¯•\] M --> N\[æˆåŠŸç¡®è®¤\] end subgraph "åŒå‘æ˜ å°„è§„åˆ™" O\[todo\] --> P\[InProgress\] Q\[done\] --> R\[Resolved\] S\[archived\] --> T\[Closed\] P --> O R --> Q T --> S end

#### é£ä¹¦ â†’ ç³»ç»Ÿï¼šé€šè¿‡Webhookæ¥æ”¶ä»»åŠ¡æ›´æ–°

**çŠ¶æ€æ˜ å°„é…ç½®**

    public class TaskStatusMapper
    {
        private static readonly Dictionary<string, TicketStatus> StatusMapping = new()
        {
            { "todo", TicketStatus.InProgress },
            { "done", TicketStatus.Resolved },
            { "archived", TicketStatus.Closed }
        };
    
        public TicketStatus MapTaskStatusToTicketStatus(string taskStatus)
        {
            return StatusMapping.TryGetValue(taskStatus, out var ticketStatus) 
                ? ticketStatus 
                : TicketStatus.Open;
        }
    
        public string MapTicketStatusToTaskStatus(TicketStatus ticketStatus)
        {
            return ticketStatus switch
            {
                TicketStatus.Open => "todo",
                TicketStatus.InProgress => "todo",
                TicketStatus.Resolved => "done",
                TicketStatus.Closed => "archived",
                _ => "todo"
            };
        }
    }
    

**Webhookäº‹ä»¶å¤„ç†å™¨**

    public class TaskWebhookHandler : IFeishuEventHandler
    {
        private readonly ITicketSyncService _syncService;
        private readonly IOperationLogService _logService;
        private readonly ILogger<TaskWebhookHandler> _logger;
    
        public string SupportedEventType => "task.status_changed";
    
        public async Task HandleAsync(EventData eventData, CancellationToken cancellationToken = default)
        {
            try
            {
                switch (eventData.EventType)
                {
                    case "task.status_changed":
                        await HandleStatusChangedAsync(eventData);
                        break;
                        
                    case "task.assignee_updated":
                        await HandleAssigneeUpdatedAsync(eventData);
                        break;
                        
                    case "task.deleted":
                        await HandleTaskDeletedAsync(eventData);
                        break;
                        
                    default:
                        _logger.LogDebug("æœªå¤„ç†çš„ä»»åŠ¡äº‹ä»¶ç±»å‹: {EventType}", eventData.EventType);
                        break;
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "å¤„ç†é£ä¹¦ä»»åŠ¡Webhookäº‹ä»¶å¤±è´¥");
                throw;
            }
        }
    
        private async Task HandleStatusChangedAsync(EventData eventData)
        {
            var taskEvent = JsonSerializer.Deserialize<TaskStatusChangedEvent>(eventData.Event.ToString());
            
            // æ ¡éªŒä¸šåŠ¡è§„åˆ™
            if (!await ValidateStatusTransitionAsync(taskEvent))
            {
                _logger.LogWarning("ä»»åŠ¡çŠ¶æ€è½¬æ¢ä¸ç¬¦åˆä¸šåŠ¡è§„åˆ™ï¼Œä»»åŠ¡ID: {TaskGuid}", taskEvent.Task.Guid);
                return;
            }
    
            // æ›´æ–°å·¥å•çŠ¶æ€
            await _syncService.SyncTaskStatusToTicketAsync(taskEvent.Task.Guid, taskEvent.Task.Status);
            
            // è®°å½•æ“ä½œæ—¥å¿—
            await _logService.LogAsync(new OperationLog
            {
                TicketId = ExtractTicketId(taskEvent.Task.Extra),
                Action = "StatusChanged",
                OldValue = taskEvent.OldStatus,
                NewValue = taskEvent.Task.Status,
                Operator = "FeishuSync",
                Timestamp = DateTime.UtcNow,
                Source = "FeishuTask"
            });
        }
    
        private async Task<bool> ValidateStatusTransitionAsync(TaskStatusChangedEvent taskEvent)
        {
            // ä¸šåŠ¡è§„åˆ™ï¼šä¸å…è®¸ä»"å®Œæˆ"çŠ¶æ€å›é€€åˆ°å…¶ä»–çŠ¶æ€
            if (taskEvent.OldStatus == "done" && taskEvent.Task.Status != "done")
            {
                // æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šæƒé™
                var hasSpecialPermission = await HasSpecialPermissionAsync(taskEvent.Operator.UserId);
                return hasSpecialPermission;
            }
    
            // ä¸šåŠ¡è§„åˆ™ï¼šåªæœ‰è´Ÿè´£äººå¯ä»¥ä¿®æ”¹ä»»åŠ¡çŠ¶æ€
            var isAssignee = taskEvent.Task.Members?.Any(m => 
                m.UserId == taskEvent.Operator.UserId && m.TaskRole == TaskRole.Assignee) ?? false;
            
            return isAssignee;
        }
    }
    

**ç³»ç»Ÿ â†’ é£ä¹¦ï¼šå·¥å•è§£å†³åè‡ªåŠ¨å…³é—­ä»»åŠ¡**

    public class TicketStatusHandler
    {
        private readonly IFeishuTaskService _feishuTaskService;
        private readonly IEventBus _eventBus;
    
        public async Task HandleTicketStatusChangedAsync(TicketStatusChangedEvent @event)
        {
            try
            {
                if (!string.IsNullOrEmpty(@event.Ticket.FeishuTaskId))
                {
                    var updateRequest = new UpdateTaskRequest
                    {
                        Status = _statusMapper.MapTicketStatusToTaskStatus(@event.NewStatus),
                        CompletedAt = @event.NewStatus == TicketStatus.Resolved 
                            ? DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString() 
                            : null
                    };
    
                    var success = await _feishuTaskService.UpdateTaskAsync(@event.Ticket.FeishuTaskId, updateRequest);
                    
                    if (success)
                    {
                        _logger.LogInformation("æˆåŠŸåŒæ­¥å·¥å•çŠ¶æ€åˆ°é£ä¹¦ä»»åŠ¡ï¼Œå·¥å•ID: {TicketId}, ä»»åŠ¡ID: {TaskGuid}", 
                            @event.Ticket.Id, @event.Ticket.FeishuTaskId);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "åŒæ­¥å·¥å•çŠ¶æ€åˆ°é£ä¹¦ä»»åŠ¡å¤±è´¥ï¼Œå·¥å•ID: {TicketId}", @event.Ticket.Id);
                
                // å‘é€åˆ°é‡è¯•é˜Ÿåˆ—
                await _retryQueue.EnqueueAsync(new RetryMessage
                {
                    Data = @event,
                    Timestamp = DateTime.UtcNow,
                    RetryCount = 0
                });
            }
        }
    }
    

### ğŸ‘¥ åœºæ™¯ä¸‰ï¼šæ™ºèƒ½è·¨éƒ¨é—¨ä»»åŠ¡åˆ†é…

#### æ™ºèƒ½åˆ†é…è§„åˆ™å¼•æ“

graph TD A\[å·¥å•è¾“å…¥\] --> B\[è§„åˆ™å¼•æ“\] B --> C\[å·¥å•ç±»å‹è§„åˆ™\] B --> D\[SLAè§„åˆ™\] B --> E\[å·¥ä½œè´Ÿè½½è§„åˆ™\] B --> F\[å¯ç”¨æ€§è§„åˆ™\] C --> C1{æŠ€æœ¯é—®é¢˜?} C1 -->|æ˜¯| C2\[æŠ€æœ¯æ”¯æŒå›¢é˜Ÿ\] C1 -->|å¦| C3{åŠŸèƒ½éœ€æ±‚?} C3 -->|æ˜¯| C4\[äº§å“å›¢é˜Ÿ\] C1 -->|å¦| C5{BugæŠ¥å‘Š?} C5 -->|æ˜¯| C6\[å¼€å‘å›¢é˜Ÿ\] C3 -->|å¦| C7\[å®¢æˆ·æœåŠ¡å›¢é˜Ÿ\] D --> D1\[SLAæ—¶é—´è®¡ç®—\] D1 --> D2\[ä¼˜å…ˆçº§è°ƒæ•´\] E --> E1\[å½“å‰å·¥ä½œé‡è¯„ä¼°\] E1 --> E2\[è´Ÿè½½å‡è¡¡åˆ†é…\] F --> F1\[åœ¨çº¿çŠ¶æ€æ£€æŸ¥\] F1 --> F2\[æŠ€èƒ½åŒ¹é…\] C2 --> G\[å€™é€‰äººæ± \] C4 --> G C6 --> G C7 --> G D2 --> G E2 --> G F2 --> G G --> H\[æœ€ç»ˆåˆ†é…å†³ç­–\] H --> I\[ä»»åŠ¡åˆ†é…æ‰§è¡Œ\]

#### è§„åˆ™å¼•æ“è®¾è®¡

    public class TaskAssignmentRuleEngine
    {
        private readonly IUserService _userService;
        private readonly IProjectService _projectService;
        private readonly ISLAService _slaService;
    
        public async Task<AssignmentResult> AssignTaskAsync(Ticket ticket)
        {
            var rules = new List<IAssignmentRule>
            {
                new TicketTypeAssignmentRule(_userService),
                new SLAAssignmentRule(_slaService),
                new WorkloadAssignmentRule(_userService),
                new AvailabilityAssignmentRule(_userService)
            };
    
            foreach (var rule in rules)
            {
                var result = await rule.EvaluateAsync(ticket);
                if (result.IsMatch)
                {
                    return result;
                }
            }
    
            // é»˜è®¤åˆ†é…è§„åˆ™
            return await GetDefaultAssignmentAsync(ticket);
        }
    }
    
    public class TicketTypeAssignmentRule : IAssignmentRule
    {
        public async Task<AssignmentResult> EvaluateAsync(Ticket ticket)
        {
            return ticket.Type switch
            {
                TicketType.TechnicalIssue => await AssignToTechnicalSupportAsync(ticket),
                TicketType.FeatureRequest => await AssignToProductAsync(ticket),
                TicketType.BugReport => await AssignToDevelopmentAsync(ticket),
                TicketType.CustomerComplaint => await AssignToCustomerServiceAsync(ticket),
                _ => AssignmentResult.NoMatch()
            };
        }
    
        private async Task<AssignmentResult> AssignToTechnicalSupportAsync(Ticket ticket)
        {
            var techSupportTeam = await _userService.GetUsersByRoleAsync("TechnicalSupport");
            var availableMember = techSupportTeam
                .Where(u => u.IsAvailable && u.CurrentWorkload < u.MaxWorkload)
                .OrderBy(u => u.CurrentWorkload)
                .FirstOrDefault();
    
            return availableMember != null 
                ? AssignmentResult.Success(availableMember.Id, "æŒ‰å·¥å•ç±»å‹åˆ†é…åˆ°æŠ€æœ¯æ”¯æŒ")
                : AssignmentResult.NoMatch();
        }
    }
    

**SLAæˆªæ­¢æ—¶é—´ä¸æé†’è§„åˆ™**

    public class SLAService
    {
        public async Task<DateTime?> CalculateSLADeadlineAsync(Ticket ticket)
        {
            var slaConfig = await GetSLAConfigAsync(ticket.Priority, ticket.Type);
            
            var businessHours = await GetBusinessHoursAsync(ticket.CustomerId);
            var deadline = CalculateBusinessDeadline(DateTime.UtcNow, slaConfig.ResponseHours, businessHours);
            
            return deadline;
        }
    
        public async Task SetupSLARemindersAsync(string ticketId, DateTime deadline)
        {
            var reminders = new List<SLAReminder>
            {
                new SLAReminder
                {
                    TicketId = ticketId,
                    TriggerTime = deadline.AddHours(-2), // æå‰2å°æ—¶
                    Type = ReminderType.Warning,
                    Message = "å·¥å•å³å°†è¶…è¿‡SLAæ—¶é—´ï¼Œè¯·å°½å¿«å¤„ç†"
                },
                new SLAReminder
                {
                    TicketId = ticketId,
                    TriggerTime = deadline.AddMinutes(-30), // æå‰30åˆ†é’Ÿ
                    Type = ReminderType.Urgent,
                    Message = "å·¥å•SLAå³å°†è¶…æ—¶ï¼Œç´§æ€¥å¤„ç†"
                }
            };
    
            await SaveRemindersAsync(reminders);
        }
    }
    

**å­ä»»åŠ¡ä¾èµ–æ”¯æŒ**

    public class SubTaskManager
    {
        public async Task<string> CreateSubTaskAsync(string parentTaskGuid, SubTaskRequest request)
        {
            var subTaskRequest = new CreateSubTaskRequest
            {
                Summary = request.Title,
                Description = request.Description,
                Due = request.DueDate.HasValue 
                    ? new TaskTime { Timestamp = ((DateTimeOffset)request.DueDate.Value).ToUnixTimeMilliseconds().ToString() }
                    : null,
                Members = request.AssigneeId != null 
                    ? new[] { new TaskMemberInfo { UserId = request.AssigneeId, TaskRole = TaskRole.Assignee } }
                    : null
            };
    
            var result = await _taskApi.CreateSubTaskAsync(parentTaskGuid, subTaskRequest);
            return result?.Data?.SubTask?.Guid;
        }
    
        public async Task SetupTaskDependenciesAsync(string taskGuid, List<TaskDependency> dependencies)
        {
            foreach (var dependency in dependencies)
            {
                var addRequest = new AddTaskDependenciesRequest
                {
                    Dependencies = new[]
                    {
                        new TaskDependencyInfo
                        {
                            TaskGuid = dependency.DependentTaskGuid,
                            DependencyType = dependency.Type
                        }
                    }
                };
    
                await _taskApi.AddTaskDependenciesByIdAsync(taskGuid, addRequest);
            }
        }
    }
    

é¡¹ç›®ä»“åº“
----

**Mud.Feishu Giteeæºç ä»“åº“**ï¼š[Gitee](https://gitee.com/mudtools/MudFeishu)  
**Mud.Feishu Githubæºç ä»“åº“**ï¼š[Github](https://github.com/mudtools/MudFeishu)