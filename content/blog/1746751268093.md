---
layout: post
title: '(dify)å¦‚ä½•ä½¿ç”¨difyè‡ªå®šä¹‰çŸ¥è¯†åº“ã€difyå¤–éƒ¨é“¾æ¥çŸ¥è¯†åº“ã€‘'
date: "2025-05-09T00:41:08Z"
---
(dify)å¦‚ä½•ä½¿ç”¨difyè‡ªå®šä¹‰çŸ¥è¯†åº“ã€difyå¤–éƒ¨é“¾æ¥çŸ¥è¯†åº“ã€‘
=================================

difyæ„å»ºè‡ªå®šä¹‰çŸ¥è¯†åº“

å°è¯•difyè‡ªå®šä¹‰çŸ¥è¯†åº“
------------

æ ¹æ®å®˜ç½‘æ•™ç¨‹ï¼Œå¯ä»¥ä»çŸ¥è¯†åº“çš„å³ä¸Šè§’å¤–éƒ¨çŸ¥è¯†åº“è¿›è¡Œæ·»åŠ å¤–éƒ¨çŸ¥è¯†åº“

å‰å¾€ **â€œçŸ¥è¯†åº“â€** é¡µï¼Œç‚¹å‡»å³ä¸Šè§’çš„ **â€œå¤–éƒ¨çŸ¥è¯†åº“ APIâ€**ï¼Œè½»ç‚¹ **â€œæ·»åŠ å¤–éƒ¨çŸ¥è¯†åº“ APIâ€**ã€‚

æŒ‰ç…§é¡µé¢æç¤ºï¼Œä¾æ¬¡å¡«å†™ä»¥ä¸‹å†…å®¹ï¼š

*   çŸ¥è¯†åº“çš„åç§°ï¼Œå…è®¸è‡ªå®šä¹‰åç§°ï¼Œç”¨äºåŒºåˆ†æ‰€è¿æ¥çš„ä¸åŒå¤–éƒ¨çŸ¥è¯† APIï¼›
    
*   API æ¥å£åœ°å€ï¼Œå¤–éƒ¨çŸ¥è¯†åº“çš„è¿æ¥åœ°å€ï¼Œç¤ºä¾‹ `api-endpoint/retrieval`ï¼›è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ[å¤–éƒ¨çŸ¥è¯†åº“ API](https://docs.dify.ai/zh-hans/guides/knowledge-base/external-knowledge-api-documentation)ï¼›
    
*   API Keyï¼Œå¤–éƒ¨çŸ¥è¯†åº“è¿æ¥å¯†é’¥ï¼Œè¯¦ç»†è¯´æ˜è¯·å‚è€ƒ[å¤–éƒ¨çŸ¥è¯†åº“ API](https://docs.dify.ai/zh-hans/guides/knowledge-base/external-knowledge-api-documentation)ï¼›
    
    ![image-20250326204900832](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201304543-889741016.png)
    

å› ä¸º`APIEndpoint`[éœ€è¦](https://blog.csdn.net/wo541075754/article/details/134433128)ç½‘ç»œ`url`åœ°å€ï¼Œè¿™é‡Œä½¿ç”¨æœ¬åœ°å½“ä½œæœåŠ¡å™¨è¿›è¡Œå°è¯•

### 1 ä½¿ç”¨python+flaskæ¡†æ¶æ„å»ºæœ¬åœ°åç«¯

æ•™ç¨‹ï¼š[python flaskæ¡†æ¶è¯¦è§£](https://www.cnblogs.com/feng0815/p/14488963.html)

#### 1.1ç®€å•ä¸Šæ‰‹

    from flask import Flask
    app = Flask(__name__)
    
    @app.route('/')
    def hello_world():
       return 'Hello World'
    
    if __name__ == '__main__':
       app.run()
    

åœ¨ç®€å•ä¸Šæ‰‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº†è£…é¥°å™¨ï¼š`@app.route('/')`ï¼Œè¦å…ˆäº†è§£[è£…é¥°å™¨](https://www.bilibili.com/video/BV1Ah8jeQEeV)ï¼Œç„¶åäº†è§£`falsk`è¿™ä¸ªè£…é¥°å™¨ä»¥åŠå…¶ä»–ç±»ä¼¼çš„è£…é¥°å™¨çš„ç”¨æ³•ã€‚

#### 1.2falskçš„å…¶ä»–è£…é¥°å™¨ä»¥åŠç”¨æ³•ï¼š

ã€æ‰©å±•é˜…è¯»ï¼Œå¯è·³è¿‡ã€‘

##### **`@app.route()`**

*   **ä½œç”¨**ï¼šå°†è§†å›¾å‡½æ•°ä¸æŒ‡å®šçš„ URL è·¯å¾„è¿›è¡Œç»‘å®šã€‚
    
*   **ç¤ºä¾‹**ï¼š
    

    @app.route('/') # è·¯ç”±è£…é¥°å™¨ï¼Œç»‘å®šURLè·¯å¾„
    def home():
        return 'Hello, World!'
    

##### `@app.before_request()`

*   **ä½œç”¨**ï¼šæ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚æ‰§è¡Œä¹‹å‰è°ƒç”¨ã€‚é€‚ç”¨äºä¸€äº›è¯·æ±‚å‰çš„é¢„å¤„ç†ï¼Œæ¯”å¦‚è®¤è¯æ£€æŸ¥ã€æ—¥å¿—è®°å½•ç­‰ã€‚
    
*   **ç¤ºä¾‹**ï¼š
    

    @app.before_request
    def before_request():
        print("This runs before every request.")
    

##### `@app.after_request()`

*   **ä½œç”¨**ï¼šæ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œåœ¨æ¯ä¸ªè¯·æ±‚æ‰§è¡Œä¹‹åè°ƒç”¨ã€‚é€‚ç”¨äºè¯·æ±‚å¤„ç†åçš„æ“ä½œï¼Œå¦‚ä¿®æ”¹å“åº”æ•°æ®ã€æ—¥å¿—è®°å½•ç­‰ã€‚
    
*   **ç¤ºä¾‹**ï¼š
    

    @app.after_request
    def after_request(response):
        print("This runs after each request.")
        return response  # å¿…é¡»è¿”å›å“åº”å¯¹è±¡
    

##### **`@app.errorhandler()`**

*   **ä½œç”¨**ï¼šæ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºå¤„ç†æŒ‡å®š HTTP é”™è¯¯ç çš„é”™è¯¯ã€‚ä¾‹å¦‚ï¼Œå¤„ç† 404 é¡µé¢æœªæ‰¾åˆ°æˆ– 500 æœåŠ¡å™¨é”™è¯¯ç­‰ã€‚
    
*   **ç¤ºä¾‹**ï¼š
    
        @app.errorhandler(404)
        def page_not_found(error):
            return "Page not found", 404
        
    

##### **`@app.before_first_request()`**

*   **ä½œç”¨**ï¼šåœ¨åº”ç”¨å¤„ç†ç¬¬ä¸€ä¸ªè¯·æ±‚ä¹‹å‰æ‰§è¡Œä¸€æ¬¡ã€‚é€‚ç”¨äºä¸€äº›åº”ç”¨åˆå§‹åŒ–çš„æ“ä½œï¼Œä¾‹å¦‚æ•°æ®åº“è¿æ¥æˆ–ç¼“å­˜åˆå§‹åŒ–ç­‰ã€‚
    
*   **ç¤ºä¾‹**ï¼š
    
        @app.before_first_request
        def before_first_request():
            print("This runs once before the first request.")
        
    

##### **`@app.route()` æ”¯æŒ HTTP æ–¹æ³•çš„è£…é¥°å™¨**

*   **ä½œç”¨**ï¼š`@app.route()` è£…é¥°å™¨å¯ä»¥é€šè¿‡ `methods` å‚æ•°æŒ‡å®šå“ªäº› HTTP æ–¹æ³•ï¼ˆå¦‚ GETã€POSTã€PUTã€DELETE ç­‰ï¼‰å¯ä»¥è§¦å‘è¯¥è·¯ç”±ã€‚
    
*   **ç¤ºä¾‹**ï¼š
    
        @app.route('/submit', methods=['POST'])
        def submit():
            return 'Form Submitted'
        
    

### 2 ä¿®æ”¹è·¯ç”±ä»¥åŠæœåŠ¡å™¨è®¾ç½®

#### 2.1 åŸºç¡€è®¾ç½®

ç”±äº`dify`å¯åŠ¨æ—¶ä¼šå ç”¨æœ¬åœ°é»˜è®¤çš„ `127.0.0.1:5000`ï¼Œä¸ºäº†é¿å…å†²çªï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡ä¿®æ”¹ç«¯å£çš„å½¢å¼æ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œç”¨åˆ°çš„æ¥å£æ˜¯ï¼š

>     app.run(debug=True, host='127.0.0.1', port=5001)
>     

`app.run` ä¸­æä¾›äº†ä¿®æ”¹åŸºæœ¬ä¿¡æ¯çš„æ¥å£ï¼š

1.  `host`ï¼šæœåŠ¡å™¨çš„åœ°å€ï¼Œwindowé»˜è®¤ä¸º `127.0.0.1`
2.  `debug`ï¼šè°ƒè¯•æ¨¡å¼æ˜¯å¦å¯åŠ¨
3.  `port`ï¼šç«¯å£å·ã€‚è¿™é‡Œä½¿ç”¨ä¸åŒçš„ç«¯å£å·æ¥åˆ†è¾¨difyä»¥åŠçŸ¥è¯†åº“æœåŠ¡å™¨ã€‚

#### 2.2test code

*   æ ¹æ®éœ€æ±‚ä¼špostä¸€ä¸ª`json`çš„è¯·æ±‚ä½“
    
    ![image-20250328161849930](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201307612-106602162.png)
    
    å› æ­¤æˆ‘ä»¬å‡è®¾ä»–ä¼ æ¥çš„æ˜¯`json`ã€è°ƒç”¨`get`æ–¹æ³•
    

    from flask import Flask , request, jsonify
    
    
    app = Flask(__name__)
    
    @app.route('/retrieval',methods=['POST'])
    def get_data():
        data = request.get_json()
        print(data)
        return jsonify(data)
    
    @app.route('/')
    def default():
        return 'hello'
    
    if __name__ == '__main__':
        app.run(debug=True, host='127.0.0.1', port=5001)
        get_data()
    

##### 2.2.1 æœ¬åœ°æµ‹è¯•

å…ˆè¿›è¡Œæœ¬åœ°æµ‹è¯•ä¸€ä¸‹ï¼š

![image-20250328162114712](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201303199-1330489865.png)

ä¸»é¡µæˆåŠŸï¼Œæµ‹è¯• `/retrieval`é¡µé¢ï¼š

![image-20250328162159024](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201304234-570297828.png)

![image-20250328162215346](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201306807-1071657936.png)

é—®é¢˜ä¸å¤§ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¸Šä¼ `json`æ–‡ä»¶ï¼Œå¯åŠ¨`dify`å°è¯•ä¸€ä¸‹

### 3 `dify`æ·»åŠ `api`æµ‹è¯•

å‘ç°ä¼šæŠ¥é”™ï¼Œæ²¡åŠæ³•è®¿é—®ï¼š

![image-20250328163025929](https://cdn.jsdelivr.net/gh/idk0v0/pic25@main/image-20250328163025929.png)

#### 3.1 é—®é¢˜è§£å†³ï¼š

*   é—®é¢˜æ€è€ƒ

ä»è®¡ç®—æœºç½‘ç»œçš„è§’åº¦æ¥è¯´ï¼Œdifyåœ¨`WSL`ä¸­è¿è¡Œï¼Œç”±äºè™šæ‹ŸåŒ–ï¼Œå®¹å™¨æœ¬åœ°ç¯å¢ƒä¸windowsçš„æœ¬åœ°ç¯å¢ƒå¹¶ä¸ä¸€è‡´ï¼Œå³ï¼šå½“ä½¿ç”¨`127.0.0.1`è¿›è¡Œè®¿é—®æ—¶ï¼Œè®¿é—®çš„æ˜¯å®¹å™¨å†…çš„ä¸»æœºï¼Œä½†æˆ‘ä»¬çš„`window`ç¯å¢ƒå¹¶ä¸åœ¨å®¹å™¨å†…éƒ¨ç½²ï¼Œå› æ­¤æ— æ³•è®¿é—®åˆ°windowç¯å¢ƒçš„`127.0.0.1`ã€‚ä¸­é—´éœ€è¦ä¸€äº›NATã€å•çº¯æŒ‡ç½‘ç»œåœ°å€è½¬æ¢ã€‘æ‰èƒ½è®¿é—®åˆ°ä¸»æœº

*   é—®é¢˜è§£å†³ï¼šæ‰¾åˆ°äº†ç½‘ä¸Šçš„ä¸€ç¯‡åšä¸»çš„æ¨æ–‡ï¼šã€dockerçŸ¥è¯†ã€‘[ä»å®¹å™¨ä¸­å¦‚ä½•è®¿é—®åˆ°å®¿ä¸»æœº](https://blog.csdn.net/gongdiwudu/article/details/128888497) é‡Œé¢æåŠäº†å¦‚ä½•åœ¨å®¹å™¨å†…è®¿é—®è§£é‡Šä¸ºä¸»æœºçš„`url`
    
    > å°†API ENDPOINTæ”¹ä¸ºï¼š**`host.docker.internal`**
    
    ![image-20250328170817389](https://cdn.jsdelivr.net/gh/idk0v0/pic25@main/image-20250328170817389.png)
    
*   ç»“æœï¼š
    
    ![image-20250328170628821](https://cdn.jsdelivr.net/gh/idk0v0/pic25@main/image-20250328170628821.png)
    
    æ›´æ¢ä¸º`docker`èƒ½è½¬æ¢çš„`url`å°±èƒ½è®¿é—®æˆåŠŸã€‚
    

### 4 å®Œå–„postç±»

æ ¹æ®`api`è§„èŒƒè¿›è¡Œæ„é€ ï¼š

![image-20250328173748099](https://cdn.jsdelivr.net/gh/idk0v0/pic25@main/image-20250328173748099.png)

ç†è®ºä¸Šæ˜¯ä» `Dify_class`\-> `Records`å¼€å§‹æ„å»ºçš„ï¼Œä½†æ˜¯ä¾èµ–ç±»éœ€è¦å†™åœ¨å‰é¢ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œè¿™äº›éƒ½æ˜¯åŸºæœ¬åŠŸï¼Œä¸éš¾çš„ï¼Œå°±æ˜¯å¤æ‚äº†ä¸€ç‚¹ï¼Œç†æ¸…æ¥šé€»è¾‘ä¹‹åæ…¢æ…¢å†™å°±å¥½ï¼š

**PSï¼š æ‰€æœ‰`__repr__`ä¸è¦æ±‚å†™ï¼Œæˆ‘å†™ç€æ–¹ä¾¿è°ƒè¯•ç½¢äº†**

#### 4.1 `Dify_class` ä¼ å…¥difyæ•°æ®ç±»

    class Dify_class:
        def __init__(self,posted_data:dict):
            """
            difyæœ‰4ä¸ªå±æ€§ã€‚
            ä¸‰ä¸ªå¿…å¡«ï¼šçŸ¥è¯†åº“idã€è¾“å…¥ç­›é€‰å™¨ã€æ£€ç´¢è®¾ç½®ï¼ˆç±»ï¼‰
            ä¸€ä¸ªé€‰å¡«ï¼šå…ƒæ•°æ®ä¿¡æ¯ï¼ˆç±»ï¼‰
            :param posted_data: æ”¶åˆ°çš„postï¼Œä»jsonè½¬æ¢ä¸ºå­—å…¸å½¢å¼
            """
            self.knowledge_id:str = posted_data.get('knowledge_id')
            self.query:str = posted_data.get('query')
            self.retrieval_setting = Retrieval_setting(
                posted_data.get('retrieval_setting')
            )
            self.metadata_condition = Metadata_condition(
                posted_data.get('metadata_condition')
            )
        def __repr__(self):
            res = f"knowledge_id:{self.knowledge_id} \nquery:{self.query} \n"f"{self.retrieval_setting.__repr__()}"
            if self.metadata_condition != None:
                res.join(self.metadata_condition.__repr__())
            return res
    
    

#### 4.1.1 dify\_class ä¸¤ä¸ªä¾èµ–ç±»

    class Retrieval_setting:
        def __init__(self, posted_data:dict):
            self.top_k:int = posted_data.get('top_k')
            self.score_threshold:float = posted_data.get('score_threshold')
        def __repr__(self):
            return f"\nretrieval_setting: \ntop_k:{self.top_k} \nscore_threshold:{self.score_threshold}"
    
    class Metadata_condition:
    
        def __init__(self, posted_data:dict):
            if posted_data == None:
                self.logical_operator = None
                self.conditions = None
                self.status = -1 # ç”¨äºæŸ¥çœ‹æœ‰å¤šå°‘å‚æ•°ï¼Œç”¨äºreprï¼Œ -1åˆ™ä¸ºç©ºï¼Œ2åˆ™ä¸ºéƒ½æœ‰ï¼ˆæœªå®Œå–„ï¼‰
            else:
                self.conditions = posted_data.get('conditions')
                logical_operator_:str = posted_data.get('logical_operator')
                if logical_operator_ != None:
                    self.logical_operator = logical_operator_
                    self.status = 2
                else:
                    self.logical_operator = None
                    self.status = 1
        def __repr__(self):
            if self.status == -1:
                return "None"
            else:
                return f'logical_operator:{self.logical_operator}\nconditionsï¼š{self.conditions}'
    

#### 4.2 recordç±»

    class Records:
        def __init__(self,_content:str, _score:float, _title:str, _metadata:dict=None):
            self.content = _content
            self.score = _score
            self.title = _title
            self.metadata = Metadata(_metadata)
        def to_dict(self):
            """
            å°†recordç±»è½¬æ¢ä¸ºå­—å…¸
            :return: è¿”å›å•ä¸ªå­—å…¸ç±»å‹çš„records
            """
    
            res_dict =  dict(
                {
                    "metadata":{
                        "path":self.metadata.path,
                        "description":self.metadata.description
                    },
                    "score":self.score,
                    "title":self.title,
                    "content":self.content
                }
            )
            return res_dict
    
        def __repr__(self):
            #æ²¡å†™metadataçš„
            return f'*************\nscore:{self.score} \ncontent:{self.content} \ntitle:{self.title} \n*************\n'
    

#### 4.2.1 record ä¾èµ–ç±»

    class Metadata:
        def __init__(self, record_dict:dict=None):
            if record_dict != None:
                self.path = record_dict.get("path")
                self.description = record_dict.get("description")
            else:
                self.path = None
                self.description = None
    

#### 4.3 æµ‹è¯•difyç±»

ç±»mainå‡½æ•°ã€ç”¨äºæµ‹è¯•ã€‘

> `test.json`æ–‡ä»¶ï¼š

    {
        "knowledge_id": "your-knowledge-id",
        "query": "ä½ çš„é—®é¢˜",
        "retrieval_setting":{
            "top_k": 2,
            "score_threshold": 0.5
        }
    }
    

mainï¼š

    if __name__ == '__main__':
        import json
        with open('test.json', mode='r',encoding='utf8') as fp:
            data = json.load(fp)
            dify_t = Dify_class(data)
            print(dify_t)
        test_record = Records("test_content", 1.0, "dify_test")
        print(test_record)
    

### 5 æ¥å…¥æœåŠ¡å™¨è¿æ¥

#### 5.1 å¯¼å…¥ç›¸å…³åŒ…

    from flask import Flask , request, jsonify
    import dify_class ,json
    #dify_classæ˜¯4ä¸­çš„æ–‡ä»¶åç§°
    

#### 5.2 è®¾ç½®æœåŠ¡å™¨

    app = Flask(__name__)
    
    @app.route('/retrieval',methods=['POST'])
    def get_data():
        data = request.get_json()       #è·å–è¯·æ±‚çš„jsonæ•°æ®
        dify_t = dify_class.Dify_class(data)    #åˆå§‹åŒ–difyè¯·æ±‚ç±»
        print(dify_t)                           #è°ƒè¯•è¾“å‡º
    
        res = []
        for i in range(dify_t.retrieval_setting.top_k): #æ¨¡æ‹Ÿ topk
            res.append(
                dify_class.Records("test_content", 1.0, "dify_test").to_dict()  #æµ‹è¯•å›å¤ç±»ï¼Œæ„é€ ä¸€ä¸ªè¯·æ±‚ç±»->è¿”å›ä»–çš„å­—å…¸å½¢å¼->æ”¾å…¥resåˆ—è¡¨ä¸­
            )
        res_dict = {
            "records": res
        }
    
        json_res = json.dumps(res_dict)
        return json_res, 200
    

#### 5.3 ä¸»å‡½æ•°

    #outside knowledge id_0001
    if __name__ == '__main__':
        app.run(debug=True, host='127.0.0.1', port=5001)
        get_data()
    

#### 5.4 æµ‹è¯•

1.  å¯åŠ¨æœåŠ¡å™¨
    
    ![image-20250329173751319](https://cdn.jsdelivr.net/gh/idk0v0/pic25@main/image-20250329173751319.png)
    
2.  è¿›è¡Œå¬å›æµ‹è¯•
    
    ![image-20250329173820464](https://img2024.cnblogs.com/blog/3244923/202505/3244923-20250507201303703-40397109.png)
    
    ç»ˆäºæ˜¯æ˜¾ç¤ºæµ‹è¯•æ•ˆæœå‡ºæ¥äº†ã€‚èƒ½å¤Ÿè¿”å›ä½ æµ‹è¯•çš„æ ·ä¾‹å°±_**è¯´æ˜æˆåŠŸäº†**_ ğŸ˜­ ğŸ˜­ï¼Œåç»­å°±æ˜¯æ ¹æ®ä»–`post`çš„ä¸œè¥¿æ¥è¿›è¡Œæ£€ç´¢äº†ã€‚