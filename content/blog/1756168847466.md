---
layout: post
title: 'å¼€æºå¤œèºé‡Œå¦‚ä½•å¼•ç”¨æ ‡ç­¾å’Œæ³¨è§£å˜é‡'
date: "2025-08-26T00:40:47Z"
---
å¼€æºå¤œèºé‡Œå¦‚ä½•å¼•ç”¨æ ‡ç­¾å’Œæ³¨è§£å˜é‡
================

ä»Šå¤©é‡åˆ°å¼€æºç¤¾åŒºå’¨è¯¢ï¼šå¤œèºé‡Œå¦‚ä½•å¼•ç”¨æ ‡ç­¾å’Œæ³¨è§£å˜é‡ï¼Ÿè¿™ä¸ªé—®é¢˜å¦‚æœé€šè¯»æ–‡æ¡£ï¼Œå…¶å®ä¹Ÿèƒ½æ‰¾åˆ°ç­”æ¡ˆï¼Œä¸è¿‡ç›¸å…³çŸ¥è¯†æ˜¯æ•£è½åœ¨å„å¤„çš„ï¼Œè¿™é‡Œå°±é›†ä¸­è¯´ä¸€ä¸‹ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥é˜…ã€‚

å“ªé‡Œå¯ä»¥å¼•ç”¨æ ‡ç­¾å’Œæ³¨è§£å˜é‡
-------------

ä¸»è¦æœ‰ä¸¤ä¸ªåœ°æ–¹å¼•ç”¨æ ‡ç­¾å’Œæ³¨è§£å˜é‡ï¼š

**å‘Šè­¦è§„åˆ™**

å‘Šè­¦è§„åˆ™çš„å¤‡æ³¨ã€é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥å¼•ç”¨æ ‡ç­¾å˜é‡ã€‚å¯¹äºä¸åŒçš„å‘Šè­¦è§„åˆ™ç”Ÿæˆçš„å‘Šè­¦äº‹ä»¶ï¼Œå¦‚æœæƒ³æ¸²æŸ“æˆä¸åŒçš„äº‹ä»¶å†…å®¹ï¼Œå°±å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›é…ç½®ã€‚æ¯”å¦‚ç£ç›˜å‘Šè­¦ï¼Œåªæƒ³åœ¨å‘Šè­¦æ¶ˆæ¯é‡Œå±•ç¤º `path` æ ‡ç­¾ï¼›æ¯”å¦‚è¯ä¹¦è¿‡æœŸçš„å‘Šè­¦ï¼Œåªæƒ³åœ¨å‘Šè­¦æ¶ˆæ¯é‡Œå±•ç¤º `target` æ ‡ç­¾ã€‚

å‘Šè­¦è§„åˆ™çš„æ ‡é¢˜å½“å‰ç‰ˆæœ¬ä¹Ÿå¯ä»¥å¼•ç”¨æ ‡ç­¾å˜é‡ï¼Œä¸è¿‡æä¸ºä¸å»ºè®®è¿™ä¹ˆåšï¼Œå› ä¸ºæ ‡é¢˜æ˜¯ç”¨æ¥åšå»é‡ã€å½’ç±»çš„ï¼Œå¦‚æœæ ‡é¢˜é‡ŒåŒ…å«æ ‡ç­¾å˜é‡ï¼Œå¯èƒ½ä¼šå¯¼è‡´åŒä¸€ç±»å‘Šè­¦æ— æ³•å½’å¹¶ã€‚åé¢çš„ç‰ˆæœ¬ä¹Ÿå¯èƒ½ä¼šä¸‹æ‰æ ‡é¢˜é‡Œå¼•ç”¨æ ‡ç­¾å˜é‡çš„åŠŸèƒ½ã€‚

**æ¶ˆæ¯æ¨¡æ¿**

ä¸åŒçš„é€šçŸ¥åª’ä»‹ä¼šæœ‰ä¸åŒçš„æ¶ˆæ¯æ¨¡æ¿ï¼Œæ¯”å¦‚é’‰é’‰æœºå™¨äººæœ‰ markdown æ¨¡æ¿ï¼Œé‚®ä»¶æœ‰ HTML æ¨¡æ¿ï¼ŒçŸ­ä¿¡æœ‰æ–‡æœ¬æ¨¡æ¿ã€‚æ¶ˆæ¯æ¨¡æ¿é‡Œä¹Ÿå¯ä»¥å¼•ç”¨æ ‡ç­¾ã€æ³¨è§£å˜é‡ã€‚

æ¶ˆæ¯æ¨¡æ¿æ˜¯ä¸€ä¸ªç›¸å¯¹å…¨å±€çš„ä¸œè¥¿ï¼Œå»ºè®®ä¸åŒçš„é€šçŸ¥åª’ä»‹åˆ†åˆ«åªå®šä¹‰ä¸€ä¸ªæ¶ˆæ¯æ¨¡æ¿ï¼Œæ‰€ä»¥æ¶ˆæ¯æ¨¡æ¿ä¸åº”è¯¥å¼•å…¥å®šåˆ¶åŒ–çš„æ¸²æŸ“é€»è¾‘ï¼Œå¦‚æœæœ‰ä¸€äº›å®šåˆ¶åŒ–çš„æ¸²æŸ“é€»è¾‘ï¼Œé€šå¸¸åº”è¯¥åœ¨å‘Šè­¦è§„åˆ™é‡Œåšã€‚

å‘Šè­¦è§„åˆ™å¼•ç”¨æ ‡ç­¾å˜é‡ä¸¾ä¾‹
------------

é€šè¿‡ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼Œå‡è®¾æˆ‘è¦é…ç½®ä¸€ä¸ªå†…å­˜ç›¸å…³çš„å‘Šè­¦è§„åˆ™ï¼š

    mem_free > 0
    

è¿™é‡Œçš„é˜ˆå€¼æ˜¯ 0ï¼Œæ‰€ä»¥è‚¯å®šä¼šè§¦å‘å‘Šè­¦ï¼Œæ–¹ä¾¿æˆ‘ä»¬æµ‹è¯•ã€‚é¢„è§ˆä¸€ä¸‹æ•°æ®ï¼š

è¿™ä¸ªæŸ¥è¯¢æ¡ä»¶åªè¿”å›äº†ä¸€æ¡æ•°æ®ï¼ˆå› ä¸ºæˆ‘è¿™æ˜¯ä½¿ç”¨ Docker compose å¯åŠ¨çš„æµ‹è¯•ç¯å¢ƒï¼Œé‡Œè¾¹åªæœ‰ä¸€ä¸ª Categraf åœ¨è·‘ï¼‰ã€‚é¢„è§ˆçš„æ•°æ®ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ ‡ç­¾éƒ¨åˆ†åªæœ‰ä¸€ä¸ª `ident` æ ‡ç­¾ã€‚

ä¸‹é¢æˆ‘åœ¨é™„åŠ ä¿¡æ¯ï¼ˆAnnotationsï¼‰é‡Œå¼•ç”¨è¿™ä¸ªæ ‡ç­¾å˜é‡ï¼Œä¾‹å­å¦‚ä¸‹ï¼š

å®šä¹‰äº†ä¸¤ä¸ªé™„åŠ ä¿¡æ¯ï¼Œå…¶ä¸­ Runbook æ¯”è¾ƒç®€å•ï¼Œå†™äº†ä¸€ä¸ª URL åœ°å€ï¼Œè¿™ä¸ª URL ä¸­å¼•ç”¨äº† `{{ .TagsMap.ident }}` å˜é‡ï¼Œå°±æ˜¯æå–çš„ `ident` æ ‡ç­¾çš„å€¼ï¼Œä¹Ÿå¯ä»¥å†™æˆ `{{ $labels.ident }}`ï¼Œç±»ä¼¼ Prometheus çš„æ ‡ç­¾å˜é‡å¼•ç”¨æ–¹å¼ã€‚`$labels` ç›¸å½“ä¸æ˜¯ `.TagsMap` çš„åˆ«åã€‚

å¦ä¸€ä¸ªé™„åŠ ä¿¡æ¯å°±æ¯”è¾ƒå¤æ‚äº†ï¼ŒMemAvailablePercentï¼Œæ˜¯é€šè¿‡è°ƒç”¨æ¨¡æ¿å‡½æ•° `query` åšäº†ä¸€ä¸ªäºŒæ¬¡æŸ¥è¯¢ï¼Œå³ `mem_free` å‘Šè­¦æ—¶ï¼Œé¡ºä¾¿è·å–äº†ä¸€ä¸‹ `mem_available_percent` çš„å€¼ã€‚çœŸå®ç”Ÿäº§ç¯å¢ƒé‡Œï¼Œæœºå™¨ä¼šæœ‰å¤šå°ï¼Œå‘Šè­¦çš„æœºå™¨åªæœ‰éƒ¨åˆ†ï¼Œæ‰€ä»¥æ‰§è¡Œ `query` çš„æ—¶å€™ï¼Œéœ€è¦åŠ ä¸Š `ident` æ ‡ç­¾çš„è¿‡æ»¤æ¡ä»¶ï¼Œç¡®ä¿æŸ¥è¯¢åˆ°çš„ `mem_available_percent` æ˜¯å’Œå‘Šè­¦çš„æœºå™¨ä¸€è‡´çš„ã€‚`printf` éƒ¨åˆ†ï¼Œæ˜¯åœ¨æ‹¼æ¥ä¸€ä¸ª promqlï¼Œpromql ä¸­å¼•ç”¨äº† `.TagsMap.ident` å˜é‡ã€‚`query` çš„æŸ¥è¯¢ç»“æœå¡åˆ°äº† `$memMetrics` å˜é‡ä¸­ï¼Œ`$memMetrics` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ç”¨ `range` éå†äº†ä¸€ä¸‹ï¼ŒæŠŠæ¯ä¸ªæ¡ç›®çš„ ident å’Œ value æ‰“å°äº†å‡ºæ¥ã€‚å…·ä½“å¯ä»¥å‚è€ƒ [æ¨¡æ¿å‡½æ•°æ–‡æ¡£](/docs/content/flashcat-monitor/nightingale-v7/usage/notification/tpl_func/)ã€‚

æ¶ˆæ¯æ¨¡æ¿å¼•ç”¨å˜é‡ä¸¾ä¾‹
----------

å¤œèºå·²ç»å†…ç½®äº†å¾ˆå¤šå‘Šè­¦æ¶ˆæ¯æ¨¡æ¿ï¼Œå¯ä»¥å‚è€ƒå†…ç½®æ¨¡æ¿åšè°ƒæ•´ï¼Œä»¥ Dingtalk çš„æ¨¡æ¿ä¸¾ä¾‹ï¼š

    #### {{if $event.IsRecovered}}<font color="#008800">ğŸ’š{{$event.RuleName}}</font>{{else}}<font color="#FF0000">ğŸ’”{{$event.RuleName}}</font>{{end}}
    ---
    {{$time_duration := sub now.Unix $event.FirstTriggerTime }}{{if $event.IsRecovered}}{{$time_duration = sub $event.LastEvalTime $event.FirstTriggerTime }}{{end}}
    - **å‘Šè­¦çº§åˆ«**: {{$event.Severity}}çº§
    {{- if $event.RuleNote}}
    	- **è§„åˆ™å¤‡æ³¨**: {{$event.RuleNote}}
    {{- end}}
    {{- if not $event.IsRecovered}}
    - **å½“æ¬¡è§¦å‘æ—¶å€¼**: {{$event.TriggerValue}}
    - **å½“æ¬¡è§¦å‘æ—¶é—´**: {{timeformat $event.TriggerTime}}
    - **å‘Šè­¦æŒç»­æ—¶é•¿**: {{humanizeDurationInterface $time_duration}}
    {{- else}}
    {{- if $event.AnnotationsJSON.recovery_value}}
    - **æ¢å¤æ—¶å€¼**: {{formatDecimal $event.AnnotationsJSON.recovery_value 4}}
    {{- end}}
    - **æ¢å¤æ—¶é—´**: {{timeformat $event.LastEvalTime}}
    - **å‘Šè­¦æŒç»­æ—¶é•¿**: {{humanizeDurationInterface $time_duration}}
    {{- end}}
    - **å‘Šè­¦äº‹ä»¶æ ‡ç­¾**:
    {{- range $key, $val := $event.TagsMap}}
    {{- if ne $key "rulename" }}
    	- {{$key}}: {{$val}}
    {{- end}}
    {{- end}}
    {{if $event.AnnotationsJSON}}
    - **é™„åŠ ä¿¡æ¯**:
    {{- range $key, $val := $event.AnnotationsJSON}}
    	- {{$key}}: {{$val}}
    {{- end}}
    {{end}}
    {{$domain := "http://127.0.0.1:17000" }}
    [äº‹ä»¶è¯¦æƒ…]({{$domain}}/alert-his-events/{{$event.Id}}) | [å±è”½1å°æ—¶]({{$domain}}/alert-mutes/add?__event_id={{$event.Id}}){{if eq $event.Cate "prometheus"}} | [æŸ¥çœ‹æ›²çº¿]({{$domain}}/metric/explorer?__event_id={{$event.Id}}&mode=graph}}){{end}}
    

è¿™ä¸ªæ¨¡æ¿é‡Œå¼•ç”¨äº†å¾ˆå¤šå˜é‡ï¼Œå¤§éƒ½æ˜¯ä»¥ `$event.` å¼€å¤´çš„å˜é‡ï¼Œè¿™äº›å˜é‡éƒ½æ˜¯äº‹ä»¶å¯¹è±¡çš„å±æ€§ã€‚å…¶ä¸­å‘Šè­¦äº‹ä»¶çš„æ ‡ç­¾ï¼Œæ˜¯é€šè¿‡ `range` éå† `$event.TagsMap` æ¥å®ç°çš„ï¼Œ`$event.TagsMap` æ˜¯ä¸€ä¸ª map å¯¹è±¡ï¼Œ`$key` æ˜¯æ ‡ç­¾åï¼Œ`$val` æ˜¯æ ‡ç­¾å€¼ã€‚

    {{- range $key, $val := $event.TagsMap}}
    {{- if ne $key "rulename" }}
    	- {{$key}}: {{$val}}
    {{- end}}
    {{- end}}
    

å‘Šè­¦äº‹ä»¶çš„é™„åŠ ä¿¡æ¯ï¼Œæ˜¯é€šè¿‡ `range` éå† `$event.AnnotationsJSON` æ¥å®ç°çš„ï¼Œ`$event.AnnotationsJSON` ä¹Ÿæ˜¯ä¸€ä¸ª map å¯¹è±¡ï¼Œ`$key` æ˜¯æ³¨è§£åï¼Œ`$val` æ˜¯æ³¨è§£å€¼ã€‚

    {{if $event.AnnotationsJSON}}
    - **é™„åŠ ä¿¡æ¯**:
    {{- range $key, $val := $event.AnnotationsJSON}}
    	- {{$key}}: {{$val}}
    {{- end}}
    {{end}}
    

ä¸Šé¢çš„è¯­æ³•éƒ½æ˜¯ go template è¯­æ³•ï¼Œå¦‚æœè¿˜æœ‰ç–‘é—®å¯ä»¥æŠŠä¸Šé¢çš„ Dingtalk çš„æ¨¡æ¿äº¤ç»™ gpt è¿›è¡Œè§£æï¼Œç„¶åæŠŠä¿®æ”¹éœ€æ±‚å‘Šè¯‰ gptï¼Œè®© gpt å¸®ä½ æ”¹ã€‚