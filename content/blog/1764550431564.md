---
layout: post
title: '.NET+AI | MEAI | è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼ˆ8ï¼‰'
date: "2025-12-01T00:53:51Z"
---
.NET+AI | MEAI | è‡ªå®šä¹‰ä¸­é—´ä»¶ï¼ˆ8ï¼‰
==========================

DelegatingChatClient:æ„å»ºä¼ä¸šçº§ AI ä¸­é—´ä»¶çš„åˆ©å™¨
====================================

ä¸€å¥è¯ç®€ä»‹
-----

é€šè¿‡ Microsoft.Extensions.AI çš„ DelegatingChatClient åŸºç±»,è½»æ¾åˆ›å»ºè‡ªå®šä¹‰ä¸­é—´ä»¶,å®ç°é™æµã€é‡è¯•ã€å®‰å…¨è¿‡æ»¤ç­‰ä¼ä¸šçº§åŠŸèƒ½,è®© AI åº”ç”¨æ›´å®‰å…¨ã€æ›´ç¨³å®šã€‚

* * *

ğŸ¯ æ ¸å¿ƒä»·å€¼
-------

*   âœ… **ç®€å•æ˜“ç”¨**:åªéœ€ç»§æ‰¿åŸºç±»å¹¶é‡å†™éœ€è¦çš„æ–¹æ³•
*   âœ… **çµæ´»ç»„åˆ**:å¤šä¸ªä¸­é—´ä»¶å¯ä»¥ç®¡é“å¼ä¸²è”
*   âœ… **ä¼ä¸šå°±ç»ª**:å®ç°é™æµã€å®‰å…¨ã€ç›‘æ§ç­‰ç”Ÿäº§çº§åŠŸèƒ½
*   âœ… **æ ‡å‡†åŒ–**:éµå¾ªç»Ÿä¸€çš„ `IChatClient` æ¥å£è§„èŒƒ

* * *

ğŸ“ ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ä¸­é—´ä»¶?
---------------

åœ¨å®é™…åº”ç”¨ä¸­,æˆ‘ä»¬ç»å¸¸éœ€è¦å¯¹ AI æœåŠ¡è¿›è¡Œå¢å¼ºå’Œæ§åˆ¶:

åœºæ™¯

æŒ‘æˆ˜

ä¸­é—´ä»¶æ–¹æ¡ˆ

**API é™æµ**

è¶…å‡ºè°ƒç”¨é¢‘ç‡é™åˆ¶

RateLimitingChatClient

**ç½‘ç»œæ•…éšœ**

ä¸´æ—¶æ€§é”™è¯¯å¯¼è‡´å¤±è´¥

RetryingChatClient

**å†…å®¹å®‰å…¨**

æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©

ContentFilteringChatClient

**æ€§èƒ½ç›‘æ§**

æ— æ³•è¿½è¸ªå“åº”æ—¶é—´

PerformanceMonitoringClient

**åˆè§„å®¡è®¡**

éœ€è¦è®°å½•æ‰€æœ‰äº¤äº’

AuditLoggingChatClient

* * *

ğŸ—ï¸ DelegatingChatClient æ ¸å¿ƒæ¦‚å¿µ
-----------------------------

![](https://img2024.cnblogs.com/blog/577140/202511/577140-20251122195004374-1789724515.png)

**æ ¸å¿ƒç‰¹æ€§:**

*   ğŸ”§ **é€æ˜è½¬å‘**:é»˜è®¤å°†æ‰€æœ‰è°ƒç”¨è½¬å‘åˆ°å†…éƒ¨å®¢æˆ·ç«¯
*   ğŸ”§ **å¯é€‰é‡å†™**:åªéœ€é‡å†™éœ€è¦å®šåˆ¶çš„æ–¹æ³•
*   ğŸ”§ **ç®¡é“å‹å¥½**:æ”¯æŒå¤šä¸ªä¸­é—´ä»¶ä¸²è”ç»„åˆ

**å¯é‡å†™æ–¹æ³•:**

*   `GetResponseAsync`:å¤„ç†å®Œæ•´å“åº”
*   `GetStreamingResponseAsync`:å¤„ç†æµå¼å“åº”
*   `Dispose`:æ¸…ç†èµ„æº

* * *

ğŸ’» å¿«é€Ÿå¼€å§‹
-------

### 1\. å®ç°é™æµä¸­é—´ä»¶

ä¿æŠ¤ API å…å—è¿‡è½½,æ§åˆ¶è°ƒç”¨é¢‘ç‡:

    using Microsoft.Extensions.AI;
    using System.Threading.RateLimiting;
    
    public sealed class RateLimitingChatClient : DelegatingChatClient
    {
        private readonly RateLimiter _rateLimiter;
    
        public RateLimitingChatClient(IChatClient innerClient, RateLimiter rateLimiter)
            : base(innerClient)
        {
            _rateLimiter = rateLimiter;
        }
    
        public override async Task<ChatResponse> GetResponseAsync(
            IEnumerable<ChatMessage> messages,
            ChatOptions? options = null,
            CancellationToken cancellationToken = default)
        {
            // è·å–é™æµè®¸å¯
            using var lease = await _rateLimiter.AcquireAsync(1, cancellationToken);
            
            if (!lease.IsAcquired)
                throw new InvalidOperationException("è¯·æ±‚è¢«é™æµæ‹’ç»");
    
            // è½¬å‘åˆ°å†…éƒ¨å®¢æˆ·ç«¯
            return await base.GetResponseAsync(messages, options, cancellationToken);
        }
    }
    

**ä½¿ç”¨æ–¹å¼:**

    var limiter = new ConcurrencyLimiter(new() { PermitLimit = 2 });
    var client = new RateLimitingChatClient(baseClient, limiter);
    

* * *

### 2\. å®ç°å®‰å…¨è¿‡æ»¤ä¸­é—´ä»¶

è¿‡æ»¤æ•æ„Ÿä¿¡æ¯,ä¿æŠ¤æ•°æ®å®‰å…¨:

    public sealed class ContentFilteringChatClient : DelegatingChatClient
    {
        private readonly HashSet<string> _sensitiveWords;
    
        public ContentFilteringChatClient(
            IChatClient innerClient, 
            IEnumerable<string> sensitiveWords)
            : base(innerClient)
        {
            _sensitiveWords = new HashSet<string>(
                sensitiveWords, 
                StringComparer.OrdinalIgnoreCase);
        }
    
        public override async Task<ChatResponse> GetResponseAsync(
            IEnumerable<ChatMessage> messages,
            ChatOptions? options = null,
            CancellationToken cancellationToken = default)
        {
            // è¿‡æ»¤è¾“å…¥æ¶ˆæ¯
            var filteredMessages = FilterMessages(messages);
            
            // è°ƒç”¨åº•å±‚å®¢æˆ·ç«¯
            return await base.GetResponseAsync(
                filteredMessages, 
                options, 
                cancellationToken);
        }
    
        private List<ChatMessage> FilterMessages(IEnumerable<ChatMessage> messages)
        {
            return messages.Select(m => 
            {
                if (m.Text != null && ContainsSensitiveWords(m.Text))
                {
                    return new ChatMessage(m.Role, MaskSensitiveWords(m.Text));
                }
                return m;
            }).ToList();
        }
    }
    

* * *

### 3\. ä½¿ç”¨ ChatClientBuilder.Use ç®€åŒ–å¼€å‘

é™¤äº†ç»§æ‰¿ `DelegatingChatClient`,è¿˜å¯ä»¥ä½¿ç”¨å†…è”æ–¹å¼:

    var client = baseClient.AsBuilder()
        // æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
        .Use(async (messages, options, innerClient, cancellationToken) =>
        {
            Console.WriteLine($"[æ—¥å¿—] æ”¶åˆ° {messages.Count()} æ¡æ¶ˆæ¯");
            var sw = Stopwatch.StartNew();
            
            var response = await innerClient.GetResponseAsync(
                messages, options, cancellationToken);
            
            Console.WriteLine($"[æ—¥å¿—] è€—æ—¶: {sw.ElapsedMilliseconds}ms");
            return response;
        })
        // æ·»åŠ é‡è¯•ä¸­é—´ä»¶
        .Use(async (messages, options, innerClient, cancellationToken) =>
        {
            for (int i = 0; i < 3; i++)
            {
                try
                {
                    return await innerClient.GetResponseAsync(
                        messages, options, cancellationToken);
                }
                catch (Exception ex) when (i < 2)
                {
                    Console.WriteLine($"[é‡è¯•] ç¬¬ {i + 1} æ¬¡å¤±è´¥,å‡†å¤‡é‡è¯•...");
                    await Task.Delay(1000 * (i + 1));
                }
            }
            throw new Exception("é‡è¯•å¤±è´¥");
        })
        .Build();
    

**ä¼˜åŠ¿å¯¹æ¯”:**

æ–¹å¼

é€‚ç”¨åœºæ™¯

ä¼˜åŠ¿

**ç»§æ‰¿æ–¹å¼**

å¤æ‚é€»è¾‘ã€èµ„æºç®¡ç†

å®Œå…¨æ§åˆ¶ã€å¯å¤ç”¨

**å†…è”æ–¹å¼**

ç®€å•åœºæ™¯ã€å¿«é€Ÿå¼€å‘

ä»£ç ç®€æ´ã€çµæ´»

* * *

ğŸ”§ åˆ›å»ºå¯å¤ç”¨æ‰©å±•æ–¹æ³•
------------

å°†ä¸­é—´ä»¶å°è£…ä¸ºæ‰©å±•æ–¹æ³•,æé«˜å¤ç”¨æ€§:

    public static class ChatClientExtensions
    {
        public static ChatClientBuilder UseRateLimiting(
            this ChatClientBuilder builder,
            RateLimiter rateLimiter)
        {
            return builder.Use(innerClient => 
                new RateLimitingChatClient(innerClient, rateLimiter));
        }
    
        public static ChatClientBuilder UseContentFiltering(
            this ChatClientBuilder builder,
            IEnumerable<string> sensitiveWords)
        {
            return builder.Use(innerClient => 
                new ContentFilteringChatClient(innerClient, sensitiveWords));
        }
    
        public static ChatClientBuilder UsePerformanceMonitoring(
            this ChatClientBuilder builder)
        {
            return builder.Use(async (messages, options, innerClient, ct) =>
            {
                var sw = Stopwatch.StartNew();
                var response = await innerClient.GetResponseAsync(messages, options, ct);
                Console.WriteLine($"[æ€§èƒ½] {sw.ElapsedMilliseconds}ms");
                return response;
            });
        }
    }
    

**ä½¿ç”¨æ‰©å±•æ–¹æ³•:**

    var client = baseClient.AsBuilder()
        .UsePerformanceMonitoring()
        .UseContentFiltering(new[] { "å¯†ç ", "è´¦å·" })
        .UseRateLimiting(rateLimiter)
        .Build();
    

* * *

ğŸ¢ ä¼ä¸šçº§æœ€ä½³å®è·µ
----------

### 1\. ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº(æ´‹è‘±æ¨¡å‹)

    è¯·æ±‚: å¤–å±‚ â†’ å†…å±‚ â†’ AI æ¨¡å‹
    å“åº”: AI æ¨¡å‹ â†’ å†…å±‚ â†’ å¤–å±‚
    

**æ¨èé¡ºåº:**

å±‚çº§

ä¸­é—´ä»¶ç±»å‹

åŸå› 

æœ€å¤–å±‚

æ—¥å¿—ã€ç›‘æ§

è®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”

ä¸­é—´å±‚

å®‰å…¨è¿‡æ»¤

åœ¨æ¶ˆè€—èµ„æºå‰æ‹¦æˆª

å†…å±‚

é™æµã€ç¼“å­˜

å‡å°‘ API è°ƒç”¨

**ç¤ºä¾‹é…ç½®:**

    var client = baseClient.AsBuilder()
        .UsePerformanceMonitoring()  // å¤–å±‚:ç›‘æ§
        .UseContentFiltering(words)  // ä¸­å±‚:å®‰å…¨
        .UseRateLimiting(limiter)    // å†…å±‚:é™æµ
        .Build();
    

* * *

### 2\. å¤„ç†æµå¼å’Œéæµå¼å“åº”

éœ€è¦åŒæ—¶æ”¯æŒä¸¤ç§æ¨¡å¼:

    // éæµå¼å“åº”
    public override async Task<ChatResponse> GetResponseAsync(...)
    {
        var response = await base.GetResponseAsync(...);
        ProcessFullContent(response.Text);
        return response;
    }
    
    // æµå¼å“åº”
    public override async IAsyncEnumerable<ChatResponseUpdate> 
        GetStreamingResponseAsync(...)
    {
        StringBuilder accumulated = new();
        await foreach (var update in base.GetStreamingResponseAsync(...))
        {
            accumulated.Append(update.Text);
            yield return update;
        }
        ProcessFullContent(accumulated.ToString());
    }
    

* * *

### 3\. èµ„æºç®¡ç†å’Œç”Ÿå‘½å‘¨æœŸ

æ­£ç¡®å®ç°èµ„æºé‡Šæ”¾:

    public sealed class MyCustomChatClient : DelegatingChatClient
    {
        private readonly IDisposable _resource;
        
        protected override void Dispose(bool disposing)
        {
            if (disposing)
            {
                _resource?.Dispose();
            }
            base.Dispose(disposing);
        }
    }
    

**æœ€ä½³å®è·µ:**

*   âœ… å§‹ç»ˆè°ƒç”¨ `base.Dispose(disposing)`
*   âœ… åœ¨ `disposing == true` æ—¶é‡Šæ”¾æ‰˜ç®¡èµ„æº
*   âœ… ä½¿ç”¨ `using` è¯­å¥ç¡®ä¿é‡Šæ”¾

* * *

### 4\. ä¾èµ–æ³¨å…¥é›†æˆ

åœ¨ ASP.NET Core ä¸­ä½¿ç”¨:

    // Program.cs
    builder.Services.AddSingleton<RateLimiter>(_ => 
        new ConcurrencyLimiter(new() { PermitLimit = 10 }));
    
    builder.Services.AddChatClient(services =>
    {
        var baseClient = /* åˆ›å»ºåŸºç¡€å®¢æˆ·ç«¯ */;
        
        return baseClient
            .AsBuilder()
            .UsePerformanceMonitoring()
            .UseContentFiltering(new[] { "æ•æ„Ÿè¯" })
            .UseRateLimiting(services.GetRequiredService<RateLimiter>())
            .Build();
    });
    
    // åœ¨æœåŠ¡ä¸­æ³¨å…¥ä½¿ç”¨
    public class MyService
    {
        private readonly IChatClient _chatClient;
        
        public MyService(IChatClient chatClient)
        {
            _chatClient = chatClient;
        }
    }
    

* * *

ğŸ¯ æ€»ç»“
-----

*   âœ… **ä¸‰ç§å®ç°æ–¹å¼**:ç»§æ‰¿ DelegatingChatClientã€Use å†…è”ã€æ‰©å±•æ–¹æ³•
*   âœ… **å¸¸è§åœºæ™¯**:é™æµã€å®‰å…¨ã€ç›‘æ§ã€é‡è¯•ã€å®¡è®¡
*   âœ… **æ´‹è‘±æ¨¡å‹**:å¤–å±‚ç›‘æ§ã€ä¸­å±‚å®‰å…¨ã€å†…å±‚é™æµ
*   âœ… **ç”Ÿäº§å°±ç»ª**:èµ„æºç®¡ç†ã€ä¾èµ–æ³¨å…¥ã€é”™è¯¯å¤„ç†

**é€‰æ‹©å»ºè®®:**

*   ğŸ’» å¤æ‚é€»è¾‘ã€éœ€è¦èµ„æºç®¡ç† â†’ ç»§æ‰¿ DelegatingChatClient
*   ğŸ’» ç®€å•åœºæ™¯ã€å¿«é€Ÿå¼€å‘ â†’ Use å†…è”æ–¹å¼
*   ğŸ’» å¯å¤ç”¨ç»„ä»¶ â†’ æ‰©å±•æ–¹æ³•

**ä¸‹ä¸€æ­¥:** æ¢ç´¢ MEAI ChatClientä¸­é—´ä»¶å’ŒFunction Invokerçš„åŒºåˆ«

![](https://files.cnblogs.com/files/sheng-jie/maf-course-card-scan.bmp)

> **ğŸ‘†é¢å‘.NETå¼€å‘è€…çš„AI Agent å¼€å‘è¯¾ç¨‹ã€.NET+AI | æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶ã€‘å·²ä¸Šçº¿ï¼Œæ¬¢è¿æ‰«ç åŠ å…¥å­¦ä¹ ã€‚ğŸ‘†**

![](https://files.cnblogs.com/files/sheng-jie/scan-follow.bmp)

> **å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€å‘ AI è€Œè¡Œã€ï¼Œæˆ‘ä»¬å¾®ä¿¡ä¸è§ä¸æ•£ã€‚  
> é˜…ç½¢æ­¤æ–‡ï¼Œå¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡ä¸é”™å¹¶æœ‰æ‰€æ”¶è·ï¼Œè¯·ã€æ‰“èµã€‘æˆ–ã€æ¨èã€‘ï¼Œä¹Ÿå¯ã€è¯„è®ºã€‘ç•™ä¸‹æ‚¨çš„é—®é¢˜æˆ–å»ºè®®ä¸æˆ‘äº¤æµã€‚ ä½ çš„æ”¯æŒæ˜¯æˆ‘ä¸æ–­åˆ›ä½œå’Œåˆ†äº«çš„ä¸ç«­åŠ¨åŠ›ï¼**

ä½œè€…ï¼š[ã€åœ£æ°ã€](http://www.jianshu.com/u/39ec0e6b1844)

å‡ºå¤„ï¼š[http://www.cnblogs.com/sheng-jie/](http://www.cnblogs.com/sheng-jie/)

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚