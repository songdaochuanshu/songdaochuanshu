---
layout: post
title: '另辟新径实现 Blazor/MAUI 本机交互(二)'
date: "2025-02-12T00:36:12Z"
---
另辟新径实现 Blazor/MAUI 本机交互(二)
==========================

NativeApi.cs
------------

内部部分类，该类提供了几个与文件操作相关的方法。

#### set\_config(), get\_config() 方法：

        private string PrinterNameKey = "PrinterName";
        private string printerName = "Unknown";
    
        public Task<string> set_config(string printerName)
        {
            Preferences.Set(PrinterNameKey, printerName);
            return Task.FromResult("ok");
        }
    
       public Task<string> get_config()
       {
           printerName = Preferences.Default.Get(PrinterNameKey, printerName);
           return Task.FromResult(printerName);
       }   
    

*   该方法从应用程序的首选项中设置或获取打印机名称 (printerName)。[Maui 基础 - Preferences 存储和检索应用程序的首选项](https://www.cnblogs.com/densen2014/p/18710319)
*   使用 Preferences.Default.Get 方法获取存储的打印机名称，如果没有存储，则返回默认值。
*   返回一个包含打印机名称的任务。

#### open\_file\_dialog() 方法：

       public async Task<string> open_file_dialog()
       {
           //work in ui thread
           var res =
           await MainThread.InvokeOnMainThreadAsync(async () =>
           {
               try
               {
                   var result = await FilePicker.Default.PickAsync(new PickOptions());
                   if (result == null)
                   {
                       return "";
                   }
                   using var stream = await result.OpenReadAsync();
                   StreamReader reader = new StreamReader(stream);
                   return Convert.ToBase64String(Encoding.UTF8.GetBytes(reader.ReadToEnd()));
               }
               catch (Exception e)
               {
                   var err = e.Message;
                   return err;
               }
           });
           return res;
       }   
    

*   该方法在 UI 线程上运行，打开文件选择对话框。
*   使用 FilePicker.Default.PickAsync 方法打开文件选择器。
*   如果用户没有选择文件，返回空字符串。
*   如果选择了文件，读取文件内容并将其转换为 Base64 编码的字符串。
*   如果发生异常，返回异常消息。

#### save\_file(string data, string fileName) 方法：

       public async Task<string> save_file(string data, string fileName)
       {
           try
           {
               string targetFile = System.IO.Path.Combine(FileSystem.Current.AppDataDirectory, fileName);
    
               using FileStream outputStream = File.OpenWrite(targetFile);
               using StreamWriter streamWriter = new(outputStream);
    
               await streamWriter.WriteAsync(data);
               return $"file path:{targetFile.Replace("\\","\\\\")}";
           }
           catch (Exception e)
           {
               var err = e.Message;
               return err;
           }
        }
    

*   该方法将给定的数据保存到指定文件名的文件中。
*   使用 Path.Combine 方法构建目标文件路径，该路径位于应用程序的数据目录中。
*   使用 File.OpenWrite 方法打开文件流，并使用 StreamWriter 写入数据。
*   写入完成后，返回文件路径。
*   如果发生异常，返回异常消息。

这些方法提供了基本的文件操作功能，包括获取配置、打开文件对话框和保存文件

#### 如何在 Preferences 中存储自定义对象？

[Maui 基础 - Preferences 存储和检索应用程序的首选项](https://www.cnblogs.com/densen2014/p/18710319)

### 完整代码

    using System.Text;
    using System.Text.Json;
    
    namespace MauiBridge;
    
    internal partial class NativeApi : object
    {
        private string PrinterNameKey = "PrinterName";
        private string printerName = "Unknown";
    
        /// <summary>
        /// 从应用程序的首选项中获取打印机名称 (printerName)
        /// </summary>
        /// <returns></returns>
        public Task<string> get_config()
        {
            printerName = Preferences.Default.Get(PrinterNameKey, printerName);
            return Task.FromResult(printerName);
        }
    
        /// <summary>
        /// 打开文件选择对话框,读取文件内容并将其转换为 Base64 编码的字符串返回
        /// </summary>
        /// <returns>文件内容 Base64 编码的字符串</returns>
        public async Task<string> open_file_dialog()
        {
            //work in ui thread
            var res =
            await MainThread.InvokeOnMainThreadAsync(async () =>
            {
                try
                {
                    var result = await FilePicker.Default.PickAsync(new PickOptions());
                    if (result == null)
                    {
                        return "";
                    }
                    using var stream = await result.OpenReadAsync();
                    StreamReader reader = new StreamReader(stream);
                    return Convert.ToBase64String(Encoding.UTF8.GetBytes(reader.ReadToEnd()));
                }
                catch (Exception e)
                {
                    var err = e.Message;
                    return err;
                }
            });
            return res;
        }
    
        /// <summary>
        /// 将给定的数据保存到指定文件名的文件,返回文件路径
        /// </summary>
        /// <param name="data"></param>
        /// <param name="fileName"></param>
        /// <returns>文件路径</returns>
        public async Task<string> save_file(string data, string fileName)
        {
            try
            {
                string targetFile = System.IO.Path.Combine(FileSystem.Current.AppDataDirectory, fileName);
    
                using FileStream outputStream = File.OpenWrite(targetFile);
                using StreamWriter streamWriter = new(outputStream);
    
                await streamWriter.WriteAsync(data);
                return $"file path:{targetFile.Replace("\\", "\\\\")}";
            }
            catch (Exception e)
            {
                var err = e.Message;
                return err;
            }
        }
    
        /// <summary>
        /// 存储自定义对象 User, 将自定义对象序列化为 string 类型，然后再存储
        /// </summary>
        /// <param name="user"></param>
        public void SaveUser(User user)
        {
            string jsonString = JsonSerializer.Serialize(user);
            Preferences.Set("user", jsonString);
        }
    
        /// <summary>
        /// 检索自定义对象 User, 从 Preferences 中检索字符串，然后将其反序列化为自定义对象
        /// </summary>
        /// <returns></returns>
        public User? GetUser()
        {
            string jsonString = Preferences.Get("user", string.Empty);
            if (string.IsNullOrEmpty(jsonString))
            {
                return null;
            }
            return JsonSerializer.Deserialize<User>(jsonString);
        }
    
    }
    
    /// <summary>
    /// 在 Preferences 中存储自定义对象, https://www.cnblogs.com/densen2014/p/18710319
    /// </summary>
    public class User
    {
        public string? Name { get; set; }
        public int Age { get; set; }
    }
    
    

#### 关联项目

FreeSql QQ群：4336577

BA & Blazor QQ群：795206915

Maui Blazor 中文社区 QQ群：645660665

#### 知识共享许可协议

本作品采用 [知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议](https://creativecommons.org/licenses/by-nc-sa/4.0/) 进行许可。欢迎转载、使用、重新发布，但务必保留文章署名AlexChow（包含链接： [https://github.com/densen2014](https://github.com/densen2014) ），不得用于商业目的，基于本文修改后的作品务必以相同的许可发布。如有任何疑问，请[与我联系](zhouchuanglin@gmail.com) 。

#### 转载声明

本文来自博客园，作者：周创琳 [AlexChow](https://www.cnblogs.com/densen2014/)，转载请注明原文链接：[https://www.cnblogs.com/densen2014/p/18710286](https://www.cnblogs.com/densen2014/p/18710286)

#### AlexChow

[今日头条](https://www.toutiao.com/c/user/token/MS4wLjABAAAAGMBzlmgJx0rytwH08AEEY8F0wIVXB2soJXXdUP3ohAE/?) | [博客园](https://www.cnblogs.com/densen2014) | [知乎](https://www.zhihu.com/people/alex-chow-54) | [Gitee](https://gitee.com/densen2014) | [GitHub](https://github.com/densen2014?WT.mc_id=DT-MVP-5005078)

![image](https://img2023.cnblogs.com/blog/1980213/202302/1980213-20230201233143321-1727894703.png)