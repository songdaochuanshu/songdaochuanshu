---
layout: post
title: '五分钟搞定！Linux平台上用Ansible自动化部署SQL Server AlwaysOn集群'
date: "2025-02-16T00:39:29Z"
---
五分钟搞定！Linux平台上用Ansible自动化部署SQL Server AlwaysOn集群
================================================

五分钟搞定！Linux平台上用Ansible自动化部署SQL Server AlwaysOn集群
================================================

### 前言

以下内容是由**红帽官方博客**整理而成，使用**Ansible**在Linux平台上自动化部署SQL Server AlwaysOn集群

不熟悉整个流程的朋友可以先看之前的部署文章，手动部署一遍

[从DNS配置到Pacemaker部署：一步步教你在Linux平台上实现AlwaysOn集群](https://mp.weixin.qq.com/s?__biz=MzkzODc0MzUxMw==&mid=2247485727&idx=1&sn=f961f8038d8d8e47715eea57fdb9c9bc&scene=21#wechat_redirect)
====================================================================================================================================================================================

随着RHEL 8.7和RHEL 9.1的正式发布，这些功能已由Red Hat和Microsoft共同支持，作为最新RHEL发行版的一部分，并通过Ansible Automation Hub提供。之前的博客已向您展示了我们所交付功能的范围，而本篇博客将介绍如何使用这些功能。

为了帮助设置和配置，Red Hat通过Github提供了社区支持的脚本，允许您在Azure、裸金属（也适用于在RHEL或OpenShift虚拟化平台上托管的虚拟机）和VMware VSphere部署中设置SQL Server高可用性组AlwaysOn集群。

在使用这些脚本时，整个安装过程总共分为三个步骤：

*   **第一步**：在数据库主节点上安装并配置初始SQL Server，并创建好数据库
*   **第二步**：在RHEL上安装并配置两个额外的SQL Server数据库节点，以便加入到集群，总共三个数据库节点组成AlwaysOn集群
*   **第三步**：这是平台特定的步骤，负责自动安装配置AlwaysOn高可用性组和与RHEL高可用性附加组件里面提供的Pacemaker集群服务

  
  

### 脚本内容

整套脚本提供的文件包括：

*   run.sh ：主要驱动脚本，负责调用其他脚本。
    
*   create\_example\_db.j2 ：一个示例T-SQL脚本，用于在第1步中创建的SQL Server上创建数据库。
    
*   inventory： 一个资产文件，包含我们将在AlwaysOn集群中配置的服务器名称。
    
*   step1.yml： 一个playbook脚本，使用Microsoft SQL Server集合在RHEL上配置SQL Server，并通过T-SQL脚本create\_example\_db.j2创建数据库。
    
*   step2.yml： 一个playbook脚本，使用Microsoft SQL Server集合在RHEL系统上配置另外两个SQL Server节点，用于创建三个节点的Always On高可用性组集群。
    
*   step3包含的脚本：以下列出的每个playbook脚本使用Microsoft SQL Server Ansible集合配置SQL Server Always On高可用性组，然后使用RHEL角色为高可用性为特定类型的虚拟、物理或云环境配置RHEL高可用性附加组件：
    

*   step3-rhkvm.yml - 此示例配置一个设计用于裸金属、RHEL KVM虚拟化、Red Hat虚拟化或Red Hat OpenShift虚拟化的RHEL高可用性集群。
*   step3-rhvmw.yml - 此示例配置一个设计用于VMware VSphere的RHEL高可用性集群。
*   step3-rhazure.yml - 此示例配置一个设计用于Microsoft Azure的RHEL高可用性集群。

  
  

### 开始准备

一开始需要设置三台虚拟机，每台虚拟机运行RHEL 8.7和RHEL高可用性附加组件。如果您使用的是RHEL虚拟化和OpenShift虚拟化，它们都支持i63000esb设备。例如，如果您在RHEL上使用虚拟化并通过virt-install工具安装虚拟机，您可以使用以下命令：

    # virt-install --name mssql1 --memory 4096 --vcpus 2 --disk size=20 --os-variant rhel8.7 --watchdog i6300esb,action=reset --cdrom=/mnt/isos/rhel-8.7-x86_64-dvd.iso
    

我们还需要按照博客《RHEL系统角色简介》（https://www.redhat.com/en/blog/introduction-rhel-system-roles）

中概述的过程安装和配置**ansible-core**和**rhel-system-roles**软件包。完成后，您需要安装Microsoft SQL Server角色，命令如下：

    # dnf install ansible-collection-microsoft-sql
    

接下来，修改inventory文件以满足您的环境需求。该文件包含您将要部署集群的物理主机或虚拟机的名称。inventory文件格式如下：

    all:
      hosts:
        mssql1:
          mssql_ha_replica_type: primary
        mssql2:
          mssql_ha_replica_type: synchronous
        mssql3:
          mssql_ha_replica_type: witness
    

修改每个主机，以确保名称与您集群中的主机名匹配。此示例使用了三个名为：mssql1、mssql2和mssql3的主机。首先，mssql1将是初始的主节点，而mssql2将是一个同步副本，mssql3将作为仅配置副本。如果希望使用两个同步副本，可以将第三个副本指定为同步副本。

  
  

### 开始部署

接下来，修改文件**step1.yml**和**step2.yml**。在这两个文件中，您可能需要修改以下参数：

*   **mssql\_password**： 您将在每台服务器上为sa账户配置的密码。
*   **mssql\_edition**： 您将使用的SQL Server版本，可能的选择包括Enterprise、Standard、Developer或Express（对于仅配置副本）。

在step1.yml文件中，您还需要修改**mssql\_ha\_db\_name**参数，该参数指定您要加入到AlwaysOn集群的那些数据库的名称。

接下来，修改**create\_example\_db.j2**文件。该文件是用T-SQL编写，用于加载一个数据库。您可以创建一个新的数据库，或者从备份中恢复一个数据库。无论哪种方式，确保数据库名称与您为**mssql\_ha\_db\_name**设置的名称匹配。

对于step3.yml，如上所述，根据您将运行的环境，有三种可能的选择。我们将使用RHEL虚拟机，因此我们将按如下方式修改**step3-rhkvm.yml**文件：

*   **mssql\_password**： 我们为sa账户使用的密码
    
*   **mssql\_ha\_virtual\_ip**： 用于连接SQL Server的虚拟IP地址。如果发生主机故障，该地址将转移到AlwaysOn可用性组中的其他成员。您可以在操作系统的hosts文件或DNS中为此VIP设置主机名。它将与AlwaysOn的侦听器关联。
    
*   **mssql\_ha\_ag\_name**： AlwaysOn可用性组名称，将显示在如SQL Server Management Studio中。
    
*   **mssql\_ha\_db\_names**： 需要加入到AlwaysOn可用性组的数据库列表。
    
*   **mssql\_ha\_master\_key\_password**：数据库主密钥
    
*   **mssql\_ha\_private\_key\_password**：数据加密密钥。
    
*   **mssql\_ha\_login\_password**：PacemakerLogin数据库登录用户的密码
    
*   **ha\_cluster\_hacluster\_password**：Pacemaker集群的集群用户密码
    

在所有这些设置完成后，在Ansible的工作目录（需要将脚本复制到Ansible控制节点目录）开始执行脚本，命令如下：

    $ ./run.sh
    

要验证您的配置是否正常运行，在mssql1数据库节点上使用以下命令查看Pacemaker集群状态：

    # pcs status
    

如果Pacemaker集群运行正常，这将输出如下内容：![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/4btH7yPYCW2PvBich9w659YMXVmVxDoc7VMqW9fQgnzzyBtpRQKmaENZhMvVxKenL5RkicKd3BeiatpUwF1hGHCXA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

在这里，我们可以看到有三个节点加入了集群：**mssql1**、**mssql2** 和**mssql3**。所有节点都处于在线状态。当前的虚拟IP资源与**mssql1**绑定，因为当前**mssql1**是AlwaysOn的主要副本节点。

要确定AlwaysOn的侦听器正在使用的VIP浮动虚拟地址，可以运行以下命令：

    # pcs resource config
    

输出结果将显示您为应用程序配置的VIP地址，供应用程序访问：![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/4btH7yPYCW2PvBich9w659YMXVmVxDoc7fusgoicSCd826GG6yt0R03jmFpOKq2DlaQ28aTnajDckGTRiccERgLWQ/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)这里我们看到，目标VIP地址是 192.168.200.254。

从命令行，我可以使用以下命令进行连接：

    $ /opt/mssql-tools/bin/sqlcmd -S 192.168.200.254 -U sa -P <mssql_password> 其中，mssql_password为SA账户设置的密码。
    

为了验证数据库故障转移是否正常工作，我们可以简单地通过以下命令关闭主要副本节点：

    poweroff   #直接关机
    

然后我们只需通过SSH连接到集群中的仍然处于活动状态的节点，并使用以下命令检查其状态：

    pcs status
    

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/4btH7yPYCW2PvBich9w659YMXVmVxDoc7YO4jFBJR0lYFyLUHibHEiak2ibE8zaLuDk2nbqG4CNRAHSGicqGqOyGPRQ/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

在这里我们看到，**mssql2**和**mssql3**处于在线状态。由于我们将**mssql3**配置为【仅配置副本】，因此数据库无法从**mssql3**提供服务，所以**mssql2**将成为主要副本节点。我们看到虚拟IP已经绑定到**mssql2**上，而**mssql1**已经停止。我们可以通过再次运行以下命令来验证我们的数据库服务器是否正在运行：

    $ /opt/mssql-tools/bin/sqlcmd -S 192.168.200.254 -U sa -P <mssql_password> 
    

验证连接成功！在典型的环境中，使用Ansible自动化部署SQL Server Always On可用性组的整个过程大约需要**五分钟**。Ansible的系统角色中包含了很多验证集群工作正常的最佳实践。

本次部署演示由**Red Hat**的Louis Imershein和**Microsoft**的Amit Khandelwal呈现，演示内容包括本文中概述的过程，并展示了在RHEL上与SQL Server一起提供的一些新功能。本次ansible脚本适用于SQL Server 2017到SQL Server 2022版本。

### 总结

本文介绍了如何使用Ansible在Linux平台上自动化部署SQL Server AlwaysOn集群。本文提供了社区支持的自动化ansible脚本来帮助在Azure、裸金属虚拟机、VMware VSphere等环境中设置SQL Server高可用性组。整个部署过程分为三步：安装和配置初始SQL Server、添加额外节点并配置AlwaysOn集群、配置高可用性服务。

  
  

#### 文章出处

*   https://www.redhat.com/en/blog/introduction-rhel-system-roles
*   https://www.redhat.com/en/blog/automate-microsoft-sql-server-always-availability-groups-red-hat-enterprise-linux

文中的Ansible相关playbook下载地址如下：

*   https://github.com/redhat-cop/sqlserver-coi/tree/master/ansible/playbooks/SQLclusterPlaybooks
    

*   https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux/sql-server
    

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/4btH7yPYCW2PvBich9w659YMXVmVxDoc7SfJA9neZuRJJNVCjdzxYkMUhRaktLAsiaZHEPzPBJHkX0FIhibGkfEeA/640?wx_fmt=png&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://img2024.cnblogs.com/blog/257159/202409/257159-20240908204310924-1005667056.png)

**本文版权归作者所有，未经作者同意不得转载。**