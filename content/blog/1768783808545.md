---
layout: post
title: 'ä¸€æ–‡åƒé€ Spring äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š7 ç§åœºæ™¯+ä»£ç å®æˆ˜'
date: "2026-01-19T00:50:08Z"
---
ä¸€æ–‡åƒé€ Spring äº‹åŠ¡ä¼ æ’­è¡Œä¸ºï¼š7 ç§åœºæ™¯+ä»£ç å®æˆ˜
=============================

ä½œä¸ºåç«¯å¼€å‘ï¼ŒSpring äº‹åŠ¡æ˜¯æ—¥å¸¸å·¥ä½œçš„åŸºç¡€ï¼Œä½†ä¸å°‘äººåªä¼šç”¨ `@Transactional` æ³¨è§£åŠ ä¸ª `rollbackFor`ï¼Œå¯¹åº•å±‚çš„äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä¸€çŸ¥åŠè§£ã€‚ç›´åˆ°é‡åˆ°â€œåµŒå¥—è°ƒç”¨äº‹åŠ¡ä¸å›æ»šâ€â€œé‡å¤æäº¤å¯¼è‡´æ•°æ®å¼‚å¸¸â€ç­‰é—®é¢˜ï¼Œæ‰å‘ç°å¯¹ä¼ æ’­è¡Œä¸ºçš„ç†è§£ä¸è¶³ä¼šè¸©å¤§å‘ã€‚

å…¶å®äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„æ ¸å¿ƒå¾ˆç®€å•ï¼šå½“ä¸€ä¸ªå¸¦æœ‰äº‹åŠ¡çš„æ–¹æ³•ï¼Œè°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå¦‚ä½•å†³å®šæ–°æ–¹æ³•çš„äº‹åŠ¡è¾¹ç•Œï¼ˆæ˜¯å¤ç”¨å½“å‰äº‹åŠ¡ï¼Œè¿˜æ˜¯æ–°å»ºäº‹åŠ¡ï¼Œæˆ–æ˜¯ä¸å‚ä¸äº‹åŠ¡ï¼‰ã€‚Spring å®šä¹‰äº† 7 ç§æ ‡å‡†ä¼ æ’­è¡Œä¸ºï¼Œæœ¬æ–‡ç»“åˆå®é™…ä¸šåŠ¡åœºæ™¯ï¼Œé€ä¸€æ‹†è§£æ¯ç§è¡Œä¸ºçš„ç”¨æ³•ã€ä»£ç ç¤ºä¾‹å’Œé€‚ç”¨åœºæ™¯ï¼Œå¸®ä½ å½»åº•åƒé€ã€‚

å…ˆé“ºå«ä¸¤ä¸ªåŸºç¡€å‰æï¼Œé¿å…ç†è§£åå·®ï¼š

*   æ‰€æœ‰ç¤ºä¾‹åŸºäº Spring Boot 2.x+ï¼Œä¾èµ– `spring-boot-starter-data-jpa` æˆ– `mybatis-plus`ï¼ˆæœ¬æ–‡ç”¨ JPA ç®€åŒ–æ•°æ®åº“æ“ä½œï¼‰ï¼›
    
*   äº‹åŠ¡ä¼ æ’­è¡Œä¸ºä»…å¯¹ `@Transactional` æ³¨è§£ä¿®é¥°çš„æ–¹æ³•ç”Ÿæ•ˆï¼Œä¸”å¿…é¡»é€šè¿‡ Spring ä»£ç†è°ƒç”¨ï¼ˆåŒç±»æ–¹æ³•å†…éƒ¨è°ƒç”¨éœ€æ³¨æ„ä»£ç†å¤±æ•ˆé—®é¢˜ï¼‰ã€‚
    

ä¸€ã€Spring 7 ç§äº‹åŠ¡ä¼ æ’­è¡Œä¸ºå…¨è§£æ
---------------------

Spring äº‹åŠ¡ä¼ æ’­è¡Œä¸ºé€šè¿‡ `propagation` å±æ€§é…ç½®ï¼Œé»˜è®¤å€¼ä¸º `REQUIRED`ã€‚ä¸‹é¢æŒ‰â€œæ—¥å¸¸ä½¿ç”¨ç‡â€æ’åºï¼Œé€ä¸€è®²è§£ã€‚

### 1\. REQUIREDï¼ˆé»˜è®¤ï¼‰ï¼šå¦‚æœæœ‰äº‹åŠ¡å°±å¤ç”¨ï¼Œæ²¡æœ‰å°±æ–°å»º

**æ ¸å¿ƒé€»è¾‘**ï¼šè¿™æ˜¯æœ€å¸¸ç”¨çš„ä¼ æ’­è¡Œä¸ºï¼Œéµå¾ªâ€œèƒ½å¤ç”¨åˆ™å¤ç”¨ï¼Œæ— åˆ™æ–°å»ºâ€çš„åŸåˆ™ã€‚å¦‚æœè°ƒç”¨æ–¹å·²ç»å­˜åœ¨äº‹åŠ¡ï¼Œè¢«è°ƒç”¨æ–¹å°±åŠ å…¥å½“å‰äº‹åŠ¡ï¼Œä¸¤è€…å…±ç”¨ä¸€ä¸ªäº‹åŠ¡è¾¹ç•Œï¼ˆè¦ä¹ˆä¸€èµ·æäº¤ï¼Œè¦ä¹ˆä¸€èµ·å›æ»šï¼‰ï¼›å¦‚æœè°ƒç”¨æ–¹æ²¡æœ‰äº‹åŠ¡ï¼Œè¢«è°ƒç”¨æ–¹å°±æ–°å»ºä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šç»å¤§å¤šæ•°æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œæ¯”å¦‚â€œåˆ›å»ºè®¢å•+æ‰£å‡åº“å­˜â€ï¼Œä¸¤è€…å¿…é¡»åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œè¦ä¹ˆéƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class OrderService {
    
        @Autowired
        private OrderRepository orderRepository;
        @Autowired
        private StockService stockService;
    
        // è°ƒç”¨æ–¹ï¼šå¸¦æœ‰äº‹åŠ¡
        @Transactional(rollbackFor = Exception.class)
        public void createOrder(Long productId, Integer count, Long userId) {
            // 1. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setProductId(productId);
            order.setCount(count);
            order.setUserId(userId);
            order.setStatus(1); // å¾…æ”¯ä»˜
            orderRepository.save(order);
    
            // 2. è°ƒç”¨æ‰£å‡åº“å­˜æ–¹æ³•ï¼ˆå¤ç”¨å½“å‰äº‹åŠ¡ï¼‰
            stockService.deductStock(productId, count);
        }
    }
    
    @Service
    public class StockService {
    
        @Autowired
        private StockRepository stockRepository;
    
        // è¢«è°ƒç”¨æ–¹ï¼šä¼ æ’­è¡Œä¸ºä¸º REQUIREDï¼ˆé»˜è®¤ï¼Œå¯çœç•¥ï¼‰
        @Transactional(propagation = Propagation.REQUIRED, rollbackFor = Exception.class)
        public void deductStock(Long productId, Integer count) {
            Stock stock = stockRepository.findByProductId(productId)
                    .orElseThrow(() -> new RuntimeException("åº“å­˜ä¸å­˜åœ¨"));
            
            if (stock.getCount() < count) {
                throw new RuntimeException("åº“å­˜ä¸è¶³");
            }
    
            stock.setCount(stock.getCount() - count);
            stockRepository.save(stock);
        }
    }
    

**ç»“æœè¯´æ˜**ï¼š

*   å¦‚æœ `deductStock` æŠ›å‡ºå¼‚å¸¸ï¼ˆå¦‚åº“å­˜ä¸è¶³ï¼‰ï¼Œ`createOrder` çš„è®¢å•åˆ›å»ºæ“ä½œä¼šä¸€èµ·å›æ»šï¼Œä¸ä¼šå‡ºç°â€œæœ‰è®¢å•æ— åº“å­˜æ‰£å‡â€çš„è„æ•°æ®ï¼›
    
*   å¦‚æœè°ƒç”¨æ–¹ `createOrder` æ²¡æœ‰åŠ  `@Transactional`ï¼Œ`deductStock` ä¼šæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼Œä»…åº“å­˜æ‰£å‡æ“ä½œå—äº‹åŠ¡æ§åˆ¶ã€‚
    

### 2\. SUPPORTSï¼šå¦‚æœæœ‰äº‹åŠ¡å°±å¤ç”¨ï¼Œæ²¡æœ‰å°±æ— äº‹åŠ¡

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹â€œè¢«åŠ¨â€å‚ä¸äº‹åŠ¡ï¼Œä¸ä¸»åŠ¨åˆ›å»ºäº‹åŠ¡ã€‚å¦‚æœè°ƒç”¨æ–¹æœ‰äº‹åŠ¡ï¼Œå°±åŠ å…¥å…¶ä¸­ï¼›å¦‚æœè°ƒç”¨æ–¹æ²¡æœ‰äº‹åŠ¡ï¼Œå°±ä»¥æ— äº‹åŠ¡æ–¹å¼æ‰§è¡Œã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šæŸ¥è¯¢ç±»æ–¹æ³•ï¼Œæ—¢å¯ä»¥åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œï¼ˆä¿è¯æŸ¥è¯¢åˆ°æœªæäº¤çš„äº‹åŠ¡æ•°æ®ï¼Œå¦‚åˆ†å¸ƒå¼äº‹åŠ¡ä¸­çš„ä¸€è‡´æ€§æŸ¥è¯¢ï¼‰ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹æ‰§è¡Œï¼ˆæ™®é€šæŸ¥è¯¢åœºæ™¯ï¼‰ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class OrderQueryService {
    
        @Autowired
        private OrderRepository orderRepository;
    
        // ä¼ æ’­è¡Œä¸ºä¸º SUPPORTSï¼Œä¸ä¸»åŠ¨åˆ›å»ºäº‹åŠ¡
        @Transactional(propagation = Propagation.SUPPORTS, readOnly = true)
        public Order getOrderById(Long orderId) {
            return orderRepository.findById(orderId)
                    .orElseThrow(() -> new RuntimeException("è®¢å•ä¸å­˜åœ¨"));
        }
    }
    
    // è°ƒç”¨åœºæ™¯1ï¼šè°ƒç”¨æ–¹æœ‰äº‹åŠ¡
    @Service
    public class OrderOperateService {
        @Autowired
        private OrderQueryService queryService;
    
        @Transactional(rollbackFor = Exception.class)
        public void updateOrderStatus(Long orderId, Integer status) {
            // å¤ç”¨å½“å‰äº‹åŠ¡æŸ¥è¯¢è®¢å•ï¼ˆèƒ½æŸ¥è¯¢åˆ°æœªæäº¤çš„ä¸´æ—¶æ•°æ®ï¼‰
            Order order = queryService.getOrderById(orderId);
            order.setStatus(status);
            orderRepository.save(order);
        }
    }
    
    // è°ƒç”¨åœºæ™¯2ï¼šè°ƒç”¨æ–¹æ— äº‹åŠ¡
    @Controller
    public class OrderController {
        @Autowired
        private OrderQueryService queryService;
    
        @GetMapping("/order/{id}")
        public ResponseEntity<Order> getOrder(@PathVariable Long id) {
            // æ— äº‹åŠ¡æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢
            return ResponseEntity.ok(queryService.getOrderById(id));
        }
    }
    

**æ³¨æ„ç‚¹**ï¼šSUPPORTS ä¿®é¥°çš„æ–¹æ³•å¦‚æœåœ¨æ— äº‹åŠ¡ç¯å¢ƒä¸‹æ‰§è¡Œï¼Œæ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œæ— æ³•å›æ»šã€‚

### 3\. MANDATORYï¼šå¿…é¡»åœ¨å·²æœ‰äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹å¼ºåˆ¶è¦æ±‚è°ƒç”¨æ–¹æœ‰äº‹åŠ¡ï¼Œè‡ªèº«ä¸æ–°å»ºäº‹åŠ¡ã€‚å¦‚æœè°ƒç”¨æ–¹æ²¡æœ‰äº‹åŠ¡ï¼Œç›´æ¥æŠ›å‡º `IllegalTransactionStateException` å¼‚å¸¸ï¼Œæ‹’ç»æ‰§è¡Œã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šå¿…é¡»ä¾èµ–è°ƒç”¨æ–¹äº‹åŠ¡çš„æ“ä½œï¼Œæ¯”å¦‚â€œè®¢å•çŠ¶æ€å˜æ›´æ—¥å¿—è®°å½•â€ï¼Œå¿…é¡»å’Œè®¢å•çŠ¶æ€å˜æ›´åœ¨åŒä¸€äº‹åŠ¡ä¸­ï¼Œç¡®ä¿æ—¥å¿—ä¸ä¸šåŠ¡æ“ä½œä¸€è‡´ï¼Œä¸å…è®¸ç‹¬ç«‹æ‰§è¡Œã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class OrderLogService {
    
        @Autowired
        private OrderLogRepository logRepository;
    
        // å¿…é¡»åœ¨å·²æœ‰äº‹åŠ¡ä¸­æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸
        @Transactional(propagation = Propagation.MANDATORY, rollbackFor = Exception.class)
        public void recordLog(Long orderId, Integer oldStatus, Integer newStatus) {
            OrderLog log = new OrderLog();
            log.setOrderId(orderId);
            log.setOldStatus(oldStatus);
            log.setNewStatus(newStatus);
            log.setOperateTime(LocalDateTime.now());
            logRepository.save(log);
        }
    }
    
    // æ­£ç¡®è°ƒç”¨ï¼šè°ƒç”¨æ–¹æœ‰äº‹åŠ¡
    @Service
    public class OrderService {
        @Autowired
        private OrderLogService logService;
    
        @Transactional(rollbackFor = Exception.class)
        public void updateOrderStatus(Long orderId, Integer newStatus) {
            Order order = orderRepository.findById(orderId).orElseThrow();
            Integer oldStatus = order.getStatus();
            order.setStatus(newStatus);
            orderRepository.save(order);
    
            // æ­£å¸¸æ‰§è¡Œï¼Œå¤ç”¨å½“å‰äº‹åŠ¡
            logService.recordLog(orderId, oldStatus, newStatus);
        }
    
        // é”™è¯¯è°ƒç”¨ï¼šè°ƒç”¨æ–¹æ— äº‹åŠ¡
        public void errorUpdateStatus(Long orderId, Integer newStatus) {
            // è°ƒç”¨ recordLog æ—¶ä¼šæŠ› IllegalTransactionStateException
            logService.recordLog(orderId, 1, newStatus);
        }
    }
    

### 4\. REQUIRES\_NEWï¼šæ— è®ºæ˜¯å¦æœ‰äº‹åŠ¡ï¼Œéƒ½æ–°å»ºç‹¬ç«‹äº‹åŠ¡

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹å¼ºåˆ¶æ–°å»ºä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡ï¼Œä¸è°ƒç”¨æ–¹äº‹åŠ¡å®Œå…¨éš”ç¦»ï¼ˆä¸¤ä¸ªäº‹åŠ¡äº’ä¸å½±å“ï¼Œå„è‡ªæäº¤/å›æ»šï¼‰ã€‚å¦‚æœè°ƒç”¨æ–¹å·²æœ‰äº‹åŠ¡ï¼Œä¼šå…ˆæš‚åœå½“å‰äº‹åŠ¡ï¼Œå¾…æ–°äº‹åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå†æ¢å¤åŸäº‹åŠ¡ã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šéœ€è¦ç‹¬ç«‹å­˜åœ¨çš„æ“ä½œï¼Œæ¯”å¦‚â€œè®¢å•åˆ›å»ºå¤±è´¥åè®°å½•å¼‚å¸¸æ—¥å¿—â€ï¼Œå³ä½¿è®¢å•åˆ›å»ºäº‹åŠ¡å›æ»šï¼Œæ—¥å¿—ä¹Ÿå¿…é¡»ä¿ç•™ï¼Œä¸èƒ½è¢«å›æ»šå½±å“ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class OrderErrorLogService {
    
        @Autowired
        private OrderErrorLogRepository errorLogRepository;
    
        // æ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼Œä¸è°ƒç”¨æ–¹äº‹åŠ¡éš”ç¦»
        @Transactional(propagation = Propagation.REQUIRES_NEW, rollbackFor = Exception.class)
        public void recordErrorLog(Long productId, Integer count, String errorMsg) {
            OrderErrorLog errorLog = new OrderErrorLog();
            errorLog.setProductId(productId);
            errorLog.setCount(count);
            errorLog.setErrorMsg(errorMsg);
            errorLog.setCreateTime(LocalDateTime.now());
            errorLogRepository.save(errorLog);
        }
    }
    
    @Service
    public class OrderService {
        @Autowired
        private OrderErrorLogService errorLogService;
    
        @Transactional(rollbackFor = Exception.class)
        public void createOrder(Long productId, Integer count, Long userId) {
            try {
                // æ¨¡æ‹Ÿè®¢å•åˆ›å»ºå¤±è´¥ï¼ˆå¦‚åº“å­˜ä¸è¶³ï¼‰
                throw new RuntimeException("è®¢å•åˆ›å»ºå¤±è´¥ï¼šåº“å­˜ä¸è¶³");
            } catch (Exception e) {
                // è®°å½•é”™è¯¯æ—¥å¿—ï¼Œæ–°å»ºç‹¬ç«‹äº‹åŠ¡ï¼Œå³ä½¿å½“å‰äº‹åŠ¡å›æ»šï¼Œæ—¥å¿—ä¹Ÿä¼šä¿ç•™
                errorLogService.recordErrorLog(productId, count, e.getMessage());
                // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©å½“å‰äº‹åŠ¡å›æ»š
                throw e;
            }
        }
    }
    

**ç»“æœè¯´æ˜**ï¼š`createOrder` äº‹åŠ¡å›æ»šï¼Œä½† `recordErrorLog` æ–°å»ºçš„ç‹¬ç«‹äº‹åŠ¡ä¼šæ­£å¸¸æäº¤ï¼Œé”™è¯¯æ—¥å¿—æˆåŠŸä¿å­˜ï¼Œå®ç°â€œä¸šåŠ¡å›æ»šä½†æ—¥å¿—ç•™å­˜â€çš„éœ€æ±‚ã€‚

### 5\. NOT\_SUPPORTEDï¼šæ— è®ºæ˜¯å¦æœ‰äº‹åŠ¡ï¼Œéƒ½ä»¥æ— äº‹åŠ¡æ–¹å¼æ‰§è¡Œ

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹æ‹’ç»å‚ä¸ä»»ä½•äº‹åŠ¡ã€‚å¦‚æœè°ƒç”¨æ–¹æœ‰äº‹åŠ¡ï¼Œä¼šå…ˆæš‚åœå½“å‰äº‹åŠ¡ï¼Œå¾…è¢«è°ƒç”¨æ–¹æ— äº‹åŠ¡æ‰§è¡Œå®Œæˆåï¼Œå†æ¢å¤åŸäº‹åŠ¡ï¼›å¦‚æœè°ƒç”¨æ–¹æ— äº‹åŠ¡ï¼Œç›´æ¥æ­£å¸¸æ‰§è¡Œã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šä¸éœ€è¦äº‹åŠ¡çš„è€—æ—¶æ“ä½œï¼Œæ¯”å¦‚â€œè®¢å•åˆ›å»ºåå‘é€çŸ­ä¿¡é€šçŸ¥â€ï¼Œå³ä½¿é€šçŸ¥å¤±è´¥ï¼Œä¹Ÿä¸èƒ½å½±å“è®¢å•åˆ›å»ºäº‹åŠ¡çš„æäº¤ï¼›æˆ–è€…ä¸å…è®¸åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œçš„æ“ä½œï¼ˆå¦‚æ‰¹é‡æ•°æ®åŒæ­¥ï¼Œé¿å…é•¿æ—¶é—´å ç”¨äº‹åŠ¡èµ„æºï¼‰ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class SmsService {
    
        // æ‹’ç»å‚ä¸äº‹åŠ¡ï¼Œä»¥æ— äº‹åŠ¡æ–¹å¼æ‰§è¡Œ
        @Transactional(propagation = Propagation.NOT_SUPPORTED)
        public void sendOrderSms(Long userId, Long orderId) {
            // æ¨¡æ‹ŸçŸ­ä¿¡å‘é€ï¼ˆè€—æ—¶æ“ä½œï¼Œæ— äº‹åŠ¡ï¼‰
            try {
                Thread.sleep(1000);
                System.out.println("å‘ç”¨æˆ·" + userId + "å‘é€è®¢å•" + orderId + "åˆ›å»ºæˆåŠŸçŸ­ä¿¡");
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                throw new RuntimeException("çŸ­ä¿¡å‘é€å¤±è´¥");
            }
        }
    }
    
    @Service
    public class OrderService {
        @Autowired
        private SmsService smsService;
    
        @Transactional(rollbackFor = Exception.class)
        public void createOrder(Long productId, Integer count, Long userId) {
            // 1. åˆ›å»ºè®¢å•ï¼ˆäº‹åŠ¡å†…æ“ä½œï¼‰
            Order order = new Order();
            // ... è®¢å•èµ‹å€¼é€»è¾‘
            orderRepository.save(order);
    
            // 2. å‘é€çŸ­ä¿¡ï¼ˆæ— äº‹åŠ¡ï¼Œå³ä½¿å¤±è´¥ä¹Ÿä¸å½±å“è®¢å•æäº¤ï¼‰
            try {
                smsService.sendOrderSms(userId, order.getId());
            } catch (Exception e) {
                // ä»…è®°å½•å¼‚å¸¸ï¼Œä¸å›æ»šè®¢å•äº‹åŠ¡
                System.err.println("çŸ­ä¿¡å‘é€å¤±è´¥ï¼š" + e.getMessage());
            }
        }
    }
    

### 6\. NEVERï¼šå¿…é¡»åœ¨æ— äº‹åŠ¡ç¯å¢ƒä¸‹æ‰§è¡Œï¼Œå¦åˆ™æŠ›å¼‚å¸¸

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹ä¸¥æ ¼ç¦æ­¢åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œã€‚å¦‚æœè°ƒç”¨æ–¹æœ‰äº‹åŠ¡ï¼Œç›´æ¥æŠ›å‡º `IllegalTransactionStateException` å¼‚å¸¸ï¼›å¦‚æœè°ƒç”¨æ–¹æ— äº‹åŠ¡ï¼Œæ­£å¸¸æ‰§è¡Œã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šå®Œå…¨ä¸å…è®¸äº‹åŠ¡æ§åˆ¶çš„æ“ä½œï¼Œæ¯”å¦‚â€œæ•°æ®å½’æ¡£è„šæœ¬â€â€œç¬¬ä¸‰æ–¹æ¥å£è°ƒç”¨ï¼ˆè‡ªèº«å·²ä¿è¯å¹‚ç­‰ï¼‰â€ï¼Œé¿å…äº‹åŠ¡é•¿æ—¶é—´å ç”¨èµ„æºæˆ–å¯¼è‡´æ•°æ®ä¸€è‡´æ€§é—®é¢˜ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class DataArchiveService {
    
        // å¿…é¡»æ— äº‹åŠ¡æ‰§è¡Œï¼Œæœ‰äº‹åŠ¡åˆ™æŠ›å¼‚å¸¸
        @Transactional(propagation = Propagation.NEVER)
        public void archiveOldOrder(LocalDateTime endTime) {
            // æ¨¡æ‹Ÿå½’æ¡£3ä¸ªæœˆå‰çš„è®¢å•æ•°æ®ï¼ˆæ— äº‹åŠ¡ï¼Œé¿å…é•¿æ—¶é—´é”è¡¨ï¼‰
            List<Order> oldOrders = orderRepository.findByCreateTimeBefore(endTime);
            // ... å½’æ¡£é€»è¾‘
        }
    }
    
    // é”™è¯¯è°ƒç”¨ï¼šè°ƒç”¨æ–¹æœ‰äº‹åŠ¡
    @Service
    public class OrderService {
        @Autowired
        private DataArchiveService archiveService;
    
        @Transactional(rollbackFor = Exception.class)
        public void doArchive() {
            // è°ƒç”¨ archiveOldOrder æ—¶ä¼šæŠ›å¼‚å¸¸ï¼Œå› ä¸ºå½“å‰æœ‰äº‹åŠ¡
            archiveService.archiveOldOrder(LocalDateTime.now().minusMonths(3));
        }
    }
    

### 7\. NESTEDï¼šåµŒå¥—äº‹åŠ¡ï¼Œä¾èµ–è°ƒç”¨æ–¹äº‹åŠ¡

**æ ¸å¿ƒé€»è¾‘**ï¼šè¢«è°ƒç”¨æ–¹åœ¨è°ƒç”¨æ–¹äº‹åŠ¡å†…åˆ›å»ºä¸€ä¸ªâ€œåµŒå¥—å­äº‹åŠ¡â€ï¼Œå­äº‹åŠ¡ä¾èµ–äºçˆ¶äº‹åŠ¡ï¼ˆè°ƒç”¨æ–¹äº‹åŠ¡ï¼‰ã€‚çˆ¶äº‹åŠ¡æäº¤æ—¶ï¼Œå­äº‹åŠ¡æ‰ä¼šæäº¤ï¼›çˆ¶äº‹åŠ¡å›æ»šæ—¶ï¼Œå­äº‹åŠ¡å¿…ç„¶å›æ»šï¼›ä½†å­äº‹åŠ¡å›æ»šæ—¶ï¼Œçˆ¶äº‹åŠ¡å¯ä»¥é€‰æ‹©ç»§ç»­æ‰§è¡Œï¼ˆä¸ä¼šè¢«å­äº‹åŠ¡å›æ»šå½±å“ï¼‰ã€‚

**æ³¨æ„**ï¼šåµŒå¥—äº‹åŠ¡ä¾èµ–æ•°æ®åº“æ”¯æŒï¼ˆå¦‚ MySQL çš„ SAVEPOINT ä¿å­˜ç‚¹æœºåˆ¶ï¼‰ï¼Œå¹¶éæ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒï¼›ä¸ REQUIRES\_NEW çš„åŒºåˆ«æ˜¯ï¼šNESTED æ˜¯å­äº‹åŠ¡ï¼Œä¸çˆ¶äº‹åŠ¡åŒå±ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ï¼›REQUIRES\_NEW æ˜¯å®Œå…¨ç‹¬ç«‹çš„äº‹åŠ¡ã€‚

**ä¸šåŠ¡åœºæ™¯**ï¼šçˆ¶äº‹åŠ¡ä¸­åŒ…å«å¯é€‰æ“ä½œï¼Œå­äº‹åŠ¡å¤±è´¥ä¸å½±å“çˆ¶äº‹åŠ¡æ ¸å¿ƒé€»è¾‘ï¼Œæ¯”å¦‚â€œåˆ›å»ºè®¢å•æ—¶å°è¯•æ‰£å‡ä¼˜æƒ åˆ¸â€ï¼Œä¼˜æƒ åˆ¸æ‰£å‡å¤±è´¥ï¼ˆå­äº‹åŠ¡å›æ»šï¼‰ï¼Œä½†è®¢å•åˆ›å»ºï¼ˆçˆ¶äº‹åŠ¡ï¼‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

    @Service
    public class CouponService {
    
        @Autowired
        private CouponRepository couponRepository;
    
        // åµŒå¥—äº‹åŠ¡ï¼Œä¾èµ–è°ƒç”¨æ–¹äº‹åŠ¡
        @Transactional(propagation = Propagation.NESTED, rollbackFor = Exception.class)
        public void deductCoupon(Long couponId, Long userId) {
            Coupon coupon = couponRepository.findByIdAndUserId(couponId, userId)
                    .orElseThrow(() -> new RuntimeException("ä¼˜æƒ åˆ¸ä¸å­˜åœ¨"));
    
            if (coupon.getIsUsed()) {
                throw new RuntimeException("ä¼˜æƒ åˆ¸å·²ä½¿ç”¨");
            }
    
            coupon.setIsUsed(true);
            couponRepository.save(coupon);
        }
    }
    
    @Service
    public class OrderService {
        @Autowired
        private CouponService couponService;
    
        @Transactional(rollbackFor = Exception.class)
        public void createOrder(Long productId, Integer count, Long userId, Long couponId) {
            // 1. åˆ›å»ºè®¢å•ï¼ˆçˆ¶äº‹åŠ¡æ ¸å¿ƒé€»è¾‘ï¼‰
            Order order = new Order();
            // ... è®¢å•èµ‹å€¼é€»è¾‘
            orderRepository.save(order);
    
            // 2. å°è¯•æ‰£å‡ä¼˜æƒ åˆ¸ï¼ˆå­äº‹åŠ¡ï¼Œå¤±è´¥ä¸å½±å“è®¢å•ï¼‰
            try {
                couponService.deductCoupon(couponId, userId);
            } catch (Exception e) {
                // å­äº‹åŠ¡å›æ»šï¼Œçˆ¶äº‹åŠ¡ç»§ç»­æ‰§è¡Œ
                System.err.println("ä¼˜æƒ åˆ¸æ‰£å‡å¤±è´¥ï¼š" + e.getMessage());
            }
        }
    }
    

**ç»“æœè¯´æ˜**ï¼šå¦‚æœä¼˜æƒ åˆ¸æ‰£å‡å¤±è´¥ï¼ˆå­äº‹åŠ¡å›æ»šï¼‰ï¼Œè®¢å•åˆ›å»ºæ“ä½œï¼ˆçˆ¶äº‹åŠ¡ï¼‰ä¾ç„¶ä¼šæ­£å¸¸æäº¤ï¼›å¦‚æœè®¢å•åˆ›å»ºå¤±è´¥ï¼ˆçˆ¶äº‹åŠ¡å›æ»šï¼‰ï¼Œä¼˜æƒ åˆ¸æ‰£å‡æ“ä½œï¼ˆå­äº‹åŠ¡ï¼‰ä¹Ÿä¼šè·Ÿç€å›æ»šã€‚

äºŒã€å¸¸è§è¯¯åŒºä¸å®æˆ˜å»ºè®®
-----------

### 1\. åŒç±»æ–¹æ³•å†…éƒ¨è°ƒç”¨ï¼Œä¼ æ’­è¡Œä¸ºå¤±æ•ˆ

Spring äº‹åŠ¡åŸºäºåŠ¨æ€ä»£ç†å®ç°ï¼ŒåŒç±»æ–¹æ³•å†…éƒ¨è°ƒç”¨æ—¶ï¼Œä¸ä¼šç»è¿‡ä»£ç†ï¼Œå¯¼è‡´ `@Transactional` æ³¨è§£å¤±æ•ˆï¼Œä¼ æ’­è¡Œä¸ºè‡ªç„¶ä¸ç”Ÿæ•ˆã€‚

    @Service
    public class OrderService {
        // é”™è¯¯ç¤ºä¾‹ï¼šå†…éƒ¨è°ƒç”¨ï¼Œä¼ æ’­è¡Œä¸ºå¤±æ•ˆ
        @Transactional(rollbackFor = Exception.class)
        public void createOrder() {
            // å†…éƒ¨è°ƒç”¨ deductStockï¼Œ@Transactional æ³¨è§£å¤±æ•ˆ
            this.deductStock();
        }
    
        @Transactional(propagation = Propagation.REQUIRES_NEW)
        public void deductStock() {
            // ... åº“å­˜æ‰£å‡é€»è¾‘
        }
    }
    

**è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡ Spring ä¸Šä¸‹æ–‡è·å–è‡ªèº«ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œæˆ–æ‹†åˆ†æ–¹æ³•åˆ°ä¸åŒ Service ç±»ã€‚

### 2\. ä¼ æ’­è¡Œä¸ºä¸éš”ç¦»çº§åˆ«åŒºåˆ†å¼€

ä¸å°‘äººä¼šæ··æ·†â€œä¼ æ’­è¡Œä¸ºâ€å’Œâ€œéš”ç¦»çº§åˆ«â€ï¼šä¼ æ’­è¡Œä¸ºæ§åˆ¶çš„æ˜¯â€œäº‹åŠ¡ä¹‹é—´çš„è°ƒç”¨å…³ç³»â€ï¼Œéš”ç¦»çº§åˆ«æ§åˆ¶çš„æ˜¯â€œäº‹åŠ¡å†…éƒ¨å¯¹æ•°æ®çš„å¯è§æ€§â€ï¼ˆå¦‚è„è¯»ã€ä¸å¯é‡å¤è¯»ï¼‰ï¼Œä¸¤è€…äº’ä¸å½±å“ï¼Œå¯ç‹¬ç«‹é…ç½®ã€‚

### 3\. ä¼˜å…ˆä½¿ç”¨é»˜è®¤ä¼ æ’­è¡Œä¸ºï¼ŒæŒ‰éœ€é€‰å‹

æ—¥å¸¸å¼€å‘ä¸­ï¼ŒREQUIREDï¼ˆé»˜è®¤ï¼‰èƒ½è¦†ç›– 80% ä»¥ä¸Šåœºæ™¯ï¼›éœ€è¦ç‹¬ç«‹äº‹åŠ¡ç”¨ REQUIRES\_NEWï¼›æŸ¥è¯¢æ–¹æ³•ç”¨ SUPPORTSï¼›ä¸¥æ ¼ä¾èµ–/ç¦æ­¢äº‹åŠ¡ç”¨ MANDATORY/NEVERï¼›åµŒå¥—äº‹åŠ¡è°¨æ…ä½¿ç”¨ï¼ˆä¾èµ–æ•°æ®åº“æ”¯æŒï¼‰ã€‚

ä¸‰ã€æ€»ç»“
----

Spring äº‹åŠ¡ä¼ æ’­è¡Œä¸ºçš„æœ¬è´¨æ˜¯â€œäº‹åŠ¡è¾¹ç•Œçš„æ§åˆ¶è§„åˆ™â€ï¼Œæ ¸å¿ƒæ˜¯è§£å†³â€œå¤šæ–¹æ³•è°ƒç”¨æ—¶äº‹åŠ¡å¦‚ä½•ååŒâ€çš„é—®é¢˜ã€‚æŒæ¡æ¯ç§è¡Œä¸ºçš„é€‚ç”¨åœºæ™¯ï¼Œç»“åˆå®é™…ä¸šåŠ¡é€‰æ‹©ï¼Œæ‰èƒ½é¿å…äº‹åŠ¡æ¼æ´ï¼ˆå¦‚æ•°æ®ä¸ä¸€è‡´ã€äº‹åŠ¡å¤±æ•ˆã€èµ„æºæµªè´¹ï¼‰ã€‚

å»ºè®®å®é™…å¼€å‘ä¸­ï¼Œå…ˆæ˜ç¡®â€œæ–¹æ³•é—´äº‹åŠ¡æ˜¯å¦éœ€è¦ååŒâ€ï¼Œå†é€‰æ‹©å¯¹åº”çš„ä¼ æ’­è¡Œä¸ºï¼ŒåŒæ—¶æ­é… `rollbackFor`ï¼ˆæŒ‡å®šå›æ»šå¼‚å¸¸ç±»å‹ï¼‰ã€`readOnly`ï¼ˆæŸ¥è¯¢ä¼˜åŒ–ï¼‰ç­‰å±æ€§ï¼Œè®©äº‹åŠ¡æ§åˆ¶æ›´ç²¾å‡†ã€é«˜æ•ˆã€‚

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19493742](https://www.cnblogs.com/sun-10387834/p/19493742)