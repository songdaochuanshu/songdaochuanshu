---
layout: post
title: 'ã€å°è®°ã€‘åœ¨ Google Colab ç­‰å¹³å°ä¸Šè¿è¡Œ GPU å®¹å™¨'
date: "2025-01-27T00:36:38Z"
---
ã€å°è®°ã€‘åœ¨ Google Colab ç­‰å¹³å°ä¸Šè¿è¡Œ GPU å®¹å™¨
================================

![ã€å°è®°ã€‘åœ¨ Google Colab ç­‰å¹³å°ä¸Šè¿è¡Œ GPU å®¹å™¨](https://img2024.cnblogs.com/blog/2588810/202501/2588810-20250126230148566-369689354.png) è¿™ç¯‡ç¬”è®°ä¸»è¦è®°å½•äº†å’±åœ¨ Google Colab ä»¥åŠ AutoDL å¹³å°ä¸Šæµ‹è¯•è¿è¡Œ GPU å®¹å™¨æ—¶çš„è¸©å‘å’Œçˆ¬å‡ºå‘çš„è¿‡ç¨‹ï¼Œæ¶‰åŠåˆ° apptainer å’Œ udocker è¿™ä¸¤ä¸ªå®¹å™¨ç®¡ç†å·¥å…·ã€‚

æœ€è¿‘æƒ³åˆ°äº†å¯èƒ½çš„åˆ›æ–°ç‚¹ï¼Œå‡†å¤‡å¼€å§‹åšå®éªŒäº†ã€‚å’±æƒ³å…ˆåœ¨ Colab è¿™ç§æä¾›å…è´¹ GPU ç®—åŠ›çš„å¹³å°ä¸Šè·‘ä¸€äº›å°å®éªŒï¼Œåç»­å†è½¬ç§»åˆ°å®éªŒå®¤æœºå™¨ä¸Šã€‚

å¦‚æœæ¯æ¬¡éƒ½è¦é‡å¤æ­å»ºç¯å¢ƒå¤šå°‘æœ‰äº›éº»çƒ¦äº†ã€‚

![subaru_nerd-2025-01-18](https://assets.xbottle.top/img/subaru_nerd-2025-01-18.png)

é‚£å’±ç”¨å®¹å™¨åŒ–æŠ€æœ¯ä¸å°±è¡Œå•¦ï¼ç›´æ¥æŠŠç¯å¢ƒæ‰“åŒ…æˆé•œåƒï¼Œåˆ°æ—¶å€™ç¯å¢ƒè¿ç§»å’Œå®éªŒå¤ç°éƒ½èƒ½ä¾¿æ·å¾ˆå¤šã€‚

æ¯”èµ· Dockerï¼Œè¿™å›å’±å†³å®šè¯•è¯•**æ›´ä¸ºè½»é‡çš„** Apptainerï¼ˆå‰èº«ä¸º Singularityï¼‰ï¼š

*   Apptainer é»˜è®¤ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½è¿è¡Œå®¹å™¨ï¼Œ**æ²¡æœ‰å®ˆæŠ¤è¿›ç¨‹**ï¼Œä¹Ÿæ— éœ€ç±»ä¼¼äº root ç”¨æˆ·çš„ç‰¹æƒï¼Œä¸åƒ Docker Daemon é‚£æ ·å¿…é¡»è¦è¿è¡Œåœ¨ç‰¹æƒç”¨æˆ·ä¸‹ã€‚ï¼ˆå› è€Œæ›´å®‰å…¨ï¼Œä¹Ÿæ›´å®¹æ˜“å®‰è£…éƒ¨ç½²ï¼Œä¸ä¼šæœ‰ä»€ä¹ˆæƒé™é—®é¢˜ï¼‰
    *   âœ¨ å°½ç®¡å¦‚æ­¤ï¼ŒApptainer ä»ç„¶è¦æ±‚ç³»ç»Ÿæ”¯æŒ User Namespace ç­‰ç‰¹æ€§ï¼Œå¦‚æœ**å¹³å°åœ¨å„æ–¹é¢é™åˆ¶å¾—æ¯”è¾ƒæ­»çš„è¯**å¯ä»¥çœ‹çœ‹[ç¬¬ 4 èŠ‚](#4-%E7%B3%BB%E7%BB%9F%E4%B8%8D%E6%94%AF%E6%8C%81%E7%94%A8%E6%88%B7%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4)ï¼Œæœ‰æƒŠå–œå“¦ (ï¿£â–½ï¿£) ã€‚
*   Apptainer é’ˆå¯¹é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCï¼‰è¿™ç§å¹¶è¡Œåœºæ™¯è¿›è¡Œäº†ä¼˜åŒ–ï¼ˆè™½ç„¶æˆ‘è¿˜ä¸å¤ªç”¨å¾—ä¸Šï¼‰ã€‚
*   Apptainer æ”¯æŒ Docker é•œåƒï¼Œä½“éªŒä¸Šè¿‘ä¹æ— ç¼ï¼ˆè¿™ä¸ªæ˜¯æœ€çˆ½æ»´ï¼‰ã€‚

è¿™ç¯‡ç¬”è®°ä¸»è¦è®°å½•ä¸€ä¸‹å’±åœ¨ Google Colab ä»¥åŠ AutoDL å¹³å°ä¸Šè¿è¡Œ GPU å®¹å™¨æ—¶çš„è¸©å‘å’Œçˆ¬å‡ºå‘çš„è¿‡ç¨‹ã€‚

1\. å®‰è£… Apptainer
----------------

è¿™é‡Œä¸å¤šèµ˜è¿°ï¼Œå›¾å¿«çš„è¯å’±ä¸»è¦æ¨èä»¥ä¸‹ä¸¤ç§å®‰è£…æ–¹å¼:

### 1.1. åˆ©ç”¨å®˜æ–¹è„šæœ¬å®‰è£…

*   [å®˜æ–¹æ–‡æ¡£](https://apptainer.org/docs/admin/1.3/installation.html#install-unprivileged-from-pre-built-binaries)

æ³¨ï¼šæ–‡æ¡£ä¸­æåˆ°åœ¨æ‰§è¡Œè„šæœ¬å‰å¯èƒ½éœ€è¦å®‰è£… `curl`, `cpio`, `rpm2cpio` ç­‰å¿…è¦çš„å·¥å…·ï¼š

    sudo apt-get update
    # rpm2cpio æ˜¯ rpm åŒ…çš„å·¥å…·
    sudo apt-get install -y curl cpio rpm
    

### 1.2. åˆ©ç”¨åŒ…ç®¡ç†å™¨å®‰è£…

*   [å®˜æ–¹æ–‡æ¡£](https://apptainer.org/docs/admin/1.3/installation.html#install-ubuntu-packages)

Colab é»˜è®¤æ˜¯ Ubuntu ç³»ç»Ÿï¼Œcopy å®˜æ–¹æ–‡æ¡£ä¸­çš„å‘½ä»¤å°±èƒ½é¡ºåˆ©å®‰è£…äº†~

2\. å°è¯•è·‘ä¸€ä¸‹ hello-world é•œåƒ
------------------------

### 2.1. æ„å»º .sif æ–‡ä»¶

Apptainer å¯ä»¥ç›´æ¥æ‹‰å– Docker Hub ä¸Šçš„é•œåƒå¹¶æ„å»ºæˆ `.sif` å•æ–‡ä»¶ï¼š

    apptainer build hello.sif docker://hello-world
    

![build_hello-2025-01-18](https://assets.xbottle.top/img/build_hello-2025-01-18.png)

### 2.2. å»ºç«‹æ™®é€šç”¨æˆ·

Colab é»˜è®¤åœ¨ root ç”¨æˆ·ä¸‹æ‰§è¡Œå‘½ä»¤ï¼Œè¿™é‡Œå»ºç«‹ä¸€ä¸ªæ™®é€šç”¨æˆ· `somebottle` ï¼š

    adduser --home /home/somebottle --gecos "" --shell /bin/bash --disabled-password somebottle
    

*   root ç”¨æˆ·å½“ç„¶æ˜¯å¯ä»¥è¿è¡Œ Apptainer å®¹å™¨çš„ï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå’±æ¥ä¸‹æ¥ä¼šå°è¯•ç”¨æ™®é€šç”¨æˆ·æ¥è¿è¡Œå®¹å™¨ã€‚

### 2.3. å¯åŠ¨å®¹å™¨

Colab **å¯¹ root ç”¨æˆ·çš„æƒé™æœ‰æ‰€é™åˆ¶**ï¼Œå¦‚æœç›´æ¥å°è¯•å¯åŠ¨å®¹å™¨ä¼šå‡ºç°æŒ‚è½½é—®é¢˜ï¼š

    apptainer run hello.sif
    # >> FATAL: container creation failed: mount hook function failure: mount overlay->/var/lib/apptainer/mnt/session/final error: while mounting overlay: can't mount overlay filesystem to /var/lib/apptainer/mnt/session/final: while setting effective capabilities: CAP_DAC_READ_SEARCH is not in the permitted capability set
    

*   ç›¸å…³ issueï¼š[https://github.com/apptainer/apptainer/issues/1041](https://github.com/apptainer/apptainer/issues/1041)

âœ¨ åˆ©ç”¨ `setcap` è¿›è¡Œ capabilities æƒé™è®¾å®šè¿˜æ˜¯éº»çƒ¦äº†ï¼Œè¿™é‡Œæˆ‘æ ¹æ® issue ä¸­çš„æŒ‡å¼•ï¼Œç›´æ¥åœ¨ä¸€ä¸ªæ–°çš„**å‘½åç©ºé—´**ä¸‹è¿è¡Œäº†å®¹å™¨:

    # åœ¨ root ç”¨æˆ·ä¸‹æ‰§è¡Œè¿™æ¡å‘½ä»¤ï¼Œå®¹å™¨å†…ç”¨æˆ·ä¸º root
    unshare -r apptainer run hello.sif
    

> `unshare -r` å»ºç«‹ä¸€ä¸ªæ–°çš„**ç”¨æˆ·å‘½åç©ºé—´**ï¼Œå¹¶æŠŠå½“å‰ç”¨æˆ·æ˜ å°„ä¸ºå‘½åç©ºé—´å†…çš„ root ç”¨æˆ·ï¼Œè¿™ä¸ªå‘½åç©ºé—´å†…çš„è¿›ç¨‹å°†ä¼šé»˜è®¤æ‹¥æœ‰å®Œæ•´çš„ capabilities æƒé™é›†ã€‚

*   ğŸ’¡ æ³¨ï¼šå¦‚æœåœ¨ root ç”¨æˆ·ä¸‹æ‰§è¡Œä¸Šé¢è¿™æ¡å‘½ä»¤ï¼Œå…¶å®ä»ç„¶ç›¸å½“äºåœ¨ç‰¹æƒç”¨æˆ·ä¸‹å¯åŠ¨äº†å®¹å™¨ã€‚

* * *

âœ¨ æˆ–è€…**ä»¥æ™®é€šç”¨æˆ·çš„èº«ä»½**è¿è¡Œå®¹å™¨:

    # ä»¥ somebottle èº«ä»½å¯åŠ¨å®¹å™¨ï¼Œå®¹å™¨å†…ç”¨æˆ·ä¸º somebottle
    sudo -u somebottle apptainer run hello.sif
    

> Apptainer å€ŸåŠ©ç”¨æˆ·å‘½åç©ºé—´ç‰¹æ€§æ¥è¿è¡Œå®¹å™¨ï¼Œç³»ç»Ÿåº”**æ”¯æŒä»¥éç‰¹æƒæ–¹å¼å»ºç«‹ç”¨æˆ·å‘½åç©ºé—´**ï¼Œç»æµ‹è¯• Colab å·²ç»æ»¡è¶³äº†è¿™ç‚¹ã€‚å…·ä½“è¦æ±‚å¯æŸ¥çœ‹[æ–‡æ¡£](https://apptainer.org/docs/admin/1.3/user_namespace.html)ã€‚

* * *

âœ¨ ä¸ºäº†èƒ½**è®©æ™®é€šç”¨æˆ·åœ¨å®¹å™¨å†…ä»¥ root ç”¨æˆ·çš„èº«ä»½è¿è¡Œ**ï¼Œå¯ä»¥åŠ ä¸Š `--fakeroot` é€‰é¡¹ï¼š

    # ä»¥ somebottle èº«ä»½å¯åŠ¨å®¹å™¨ï¼Œå®¹å™¨å†…ç”¨æˆ·ä¸º root
    sudo -u somebottle apptainer run --fakeroot hello.sif
    

å…·ä½“è¡Œä¸ºå¯è§[å®˜æ–¹æ–‡æ¡£](https://apptainer.org/docs/user/1.3/fakeroot.html)è¯´æ˜ã€‚

3\. å°è¯•è·‘ä¸€ä¸ª GPU å®¹å™¨
----------------

### 3.1. æ„å»º .sif æ–‡ä»¶

è¿™é‡Œæ‹‰å–äº† Docker Hub ä¸Š PyTorch å®˜æ–¹çš„ä¸€ä¸ª GPU æ”¯æŒé•œåƒï¼š

    # è½¬æ¢å¾—åˆ° pytorch-gpu.sif æ–‡ä»¶
    apptainer build pytorch-gpu.sif docker://pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime
    

### 3.2. ä½¿ç”¨ Apptainer çš„æ ‡å‡† GPU æ”¯æŒ

Apptainer é»˜è®¤æ”¯æŒ NVIDIA GPUï¼Œå‰ææ˜¯å®¿ä¸»æœºç³»ç»Ÿä¸­å·²ç»å®‰è£…äº† Nvidia é©±åŠ¨ä»¥åŠ CUDA ç›¸å…³åº“ã€‚

*   å…·ä½“è¦æ±‚ä¾æ—§è§[å®˜æ–¹æ–‡æ¡£](https://apptainer.org/docs/user/1.3/gpu.html#requirements)ã€‚

åœ¨ `apptainer` çš„ `run`, `shell`, `exec` ç­‰å‘½ä»¤ååŠ ä¸Š `--nv` é€‰é¡¹å³å¯å¯ç”¨ GPU æ”¯æŒ:

    # ä»¥ somebottle èº«ä»½å¯åŠ¨ GPU å®¹å™¨ï¼Œå®¹å™¨å†…ç”¨æˆ·ä¸º somebottle
    # å¯åŠ¨å®¹å™¨åæ‰§è¡Œ nvidia-smi æ¥æŸ¥çœ‹ GPU çŠ¶æ€
    sudo -u somebottle apptainer exec --nv pytorch-gpu.sif nvidia-smi
    

### 3.3. å•é¡Œã€è¥²æ¥

![problem_emergence-2025-01-21](https://assets.xbottle.top/img/problem_emergence-2025-01-21.png)

è¯¶ï¼ŸåŠ¨å•Šï¼ŒNVIDIAï¼Œä¸ºä»€ä¹ˆä¸åŠ¨ï¼Ÿ

![mio_solemn-2025-01-22](https://assets.xbottle.top/img/mio_solemn-2025-01-22.png)

    NVIDIA-SMI couldn't find libnvidia-ml.so library in your system. Please make sure that the NVIDIA Display Driver is properly installed and present in your system.
    Please also try adding directory that contains libnvidia-ml.so to your system PATH.
    

å®šç›ä¸€çœ‹å‘ç°æ˜¯åœ¨å®¹å™¨å†…æ‰¾ä¸åˆ°åŠ¨æ€é“¾æ¥åº“ `libnvidia-ml.so`ã€‚

### 3.4. è§£å†³é—®é¢˜

æåˆ°åŠ¨æ€é“¾æ¥åº“è·¯å¾„ï¼Œå¾ˆå¿«èƒ½æƒ³åˆ°ä¸€ä¸ªç¯å¢ƒå˜é‡ `LD_LIBRARY_PATH`ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šåœ¨å…¶åˆ—å‡ºçš„ç›®å½•ä¸‹æœç´¢åº“ã€‚åˆ†åˆ«åœ¨å®¿ä¸»æœºå’Œå®¹å™¨å†…è¾“å‡ºè¿™ä¸ªç¯å¢ƒå˜é‡çœ‹çœ‹:

    # å®¿ä¸»æœºä¸Š
    unshare -r env | grep LD_
    # >> LD_LIBRARY_PATH=/usr/lib64-nvidia
    
    # å®¹å™¨ä¸­
    unshare -r apptainer exec --nv pytorch-gpu.sif env | grep LD_
    # >> LD_LIBRARY_PATH=/usr/local/nvidia/lib:/usr/local/nvidia/lib64:/.singularity.d/libs
    

å¯è§**å®¿ä¸»æœºä¸Š NVIDIA åŠ¨æ€é“¾æ¥åº“**ä½äº `/usr/lib64-nvidia`ã€‚

å®¹å™¨å†…åˆ—å‡ºäº†ä¸‰ä¸ªè·¯å¾„ï¼Œå› ä¸ºå…¶ä¸­å‰ä¸¤ä¸ªè·¯å¾„åœ¨å®¹å™¨å†…æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥é“¾æ¥å™¨ä¼šå» `/.singularity.d/libs` è¿™ä¸ªè·¯å¾„ä¸‹æ‰¾å…±äº«åº“ã€‚

    # è¾“å‡ºçœ‹çœ‹ç›®å½•ä¸‹æœ‰ä»€ä¹ˆ
    unshare -r apptainer exec --nv pytorch-gpu.sif ls -ahl /.singularity.d/libs
    

![list_libraries-2025-01-22](https://assets.xbottle.top/img/list_libraries-2025-01-22.png)

æ¨æµ‹åœ¨ä½¿ç”¨ `--nv` é€‰é¡¹æ—¶ï¼ŒApptainer ä¼šè‡ªåŠ¨**å°†å®¿ä¸»æœºä¸Šçš„ NVIDIA åŠ¨æ€é“¾æ¥åº“ç»‘å®šæŒ‚è½½åˆ°å®¹å™¨å†…**çš„ `/.singularity.d/libs` ç›®å½•ä¸‹ã€‚

*   [ç”¨æˆ·æ–‡æ¡£ - GPU Support](https://apptainer.org/docs/user/1.3/gpu.html#requirements) \[1\]
*   [ç®¡ç†æ–‡æ¡£ - Apptainer Configuration Files](https://apptainer.org/docs/admin/1.3/configfiles.html#nvidia-gpus-cuda) \[2\]

ä»ä¸Šé¢ä¸¤ä¸ªæ–‡æ¡£å¯ä»¥å¾—çŸ¥ï¼Œä¸ºäº†å¤„ç†ç»‘å®šæŒ‚è½½ï¼ŒApptainer æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ `nvliblist.conf`ï¼Œå…¶ä¸­æŒ‡å®šäº† NVIDIA ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶å’ŒåŠ¨æ€é“¾æ¥åº“çš„**æ–‡ä»¶å**ï¼ˆæ²¡é”™ï¼Œä»…ä»…æ˜¯æ–‡ä»¶åï¼ï¼‰ã€‚

*   æ³¨: é€šè¿‡ `find / -name "nvliblist.conf"` å¯æ‰¾åˆ°é…ç½®æ–‡ä»¶è·¯å¾„ã€‚

åœ¨é»˜è®¤çš„ `nvliblist.conf` ä¸­å¯ä»¥æ‰¾åˆ°ä¸Šé¢ `NVIDIA-SMI` è¿è¡Œæ‰€ç¼ºå¤±çš„åº“:

![find_libnvidia-ml-2025-01-22](https://assets.xbottle.top/img/find_libnvidia-ml-2025-01-22.png)

å½“ç„¶ä¹Ÿå¯ä»¥æ‰¾åˆ°å®¹å™¨å†… `/.singularity.d/libs` ç›®å½•ä¸‹å·²æœ‰çš„åº“ã€‚

* * *

**äºæ˜¯ç°åœ¨é—®é¢˜å°±è½¬æ¢ä¸ºäº†**ï¼šä¸ºä»€ä¹ˆ `/.singularity.d/libs` ç›®å½•ä¸‹æ²¡æœ‰ `libnvidia-ml.so` å’Œå…¶ä»–ä¸€äº›å¿…è¦çš„åº“å‘¢ï¼Ÿ

ä»ç„¶æ˜¯çœ‹æ–‡æ¡£ï¼Œ \[2\] ä¸­æåˆ°:

> When adding new entries to `nvliblist.conf` use the bare filename of executables, and the `xxxx.so` form of libraries. Libraries are resolved via `ldconfig -p`, and exectuables are found by searching `$PATH`.

å³å…±äº«åº“ï¼ˆ`.so`ï¼‰è·¯å¾„æ˜¯é€šè¿‡ `ldconfig -p` æ¥è§£æçš„ï¼Œè€Œå¯æ‰§è¡Œæ–‡ä»¶åˆ™æ˜¯é€šè¿‡ `$PATH` æ¥æœç´¢çš„ã€‚å¾ˆæœ‰å¯èƒ½ Apptainer åœ¨æŒ‚è½½æ—¶æ²¡æœ‰æ‰¾åˆ° NVIDIA çš„åº“è·¯å¾„ã€‚

    # ldconfig å¯ä»¥ç®¡ç†åŠ¨æ€é“¾æ¥åº“çš„ç¼“å­˜
    # æŸ¥çœ‹ ldconfig -p çš„è¾“å‡ºï¼ˆè¾“å‡ºå·²ç¼“å­˜çš„åº“ï¼‰ï¼Œç­›å‡ºæœ‰ nvidia å­—æ®µçš„
    ldconfig -p | grep nvidia
    # æ²¡æœ‰è¾“å‡ºï¼Œè¯´æ˜ nvidia ç›¸å…³çš„åº“æ²¡æœ‰è¢«ç¼“å­˜
    

å“”å•µ~é—®é¢˜å·²å®šä½ã€‚æ¥ä¸‹æ¥åªéœ€è¦æŠŠå®¿ä¸»æœºä¸Šçš„ NVIDIA å…±äº«åº“ç›®å½• `/usr/lib64-nvidia` åŠ å…¥åˆ°ç¼“å­˜ä¸­å³å¯ã€‚

`ldconfig` ä¼šä» `/etc/ld.so.conf.d` ç›®å½•ä¸­çš„é…ç½®æ–‡ä»¶è¯»å–å…±äº«åº“è·¯å¾„ï¼Œå…ˆçœ‹çœ‹è¿™ä¸ªç›®å½•ä¸‹æœ‰ä»€ä¹ˆ:

    ls -hl /etc/ld.so.conf.d
    # >> total 36K
    # >> -rw-r--r-- 1 root root  41 Sep  9  2023 000_cuda.conf
    # >> -rw-r--r-- 1 root root  44 Sep  9  2023 988_cuda-12.conf
    # >> -rw-r--r-- 1 root root  15 Jan 17 14:36 colab.conf
    # >> -rw-r--r-- 1 root root  38 Mar  5  2022 fakeroot-x86_64-linux-gnu.conf
    # >> -rw-r--r-- 1 root root  46 Aug 15  2023 gds-12-2.conf
    # >> -rw-r--r-- 1 root root  44 Dec 16  2020 libc.conf
    # >> -rw-r--r-- 1 root root  46 Nov 10  2023 nvidia.conf
    # >> -rw-r--r-- 1 root root 100 Mar  4  2022 x86_64-linux-gnu.conf
    # >> -rw-r--r-- 1 root root  56 May  6  2024 zz_i386-biarch-compat.conf
    
    cat /etc/ld.so.conf.d/nvidia.conf /etc/ld.so.conf.d/*cuda*.conf
    # >> /usr/local/nvidia/lib
    # >> /usr/local/nvidia/lib64
    # >> /usr/local/cuda/targets/x86_64-linux/lib
    # >> /usr/local/cuda-12/targets/x86_64-linux/lib
    
    ls /usr/local/nvidia/lib
    # >> ls: cannot access '/usr/local/nvidia/lib': No such file or directory
    

çœ‹æ¥å¤§æ¦‚æ˜¯ Colab å®˜æ–¹çš„é…ç½®æœ‰è¯¯ã€‚

âœ¨ ä¸ºäº†ä¿®å¤è¿™ç‚¹ï¼Œå’±ä»¬**ç›´æ¥æŠŠåº“è·¯å¾„ `/usr/lib64-nvidia` å†™å…¥åˆ°è¿™é‡Œçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶**ä¸­:

    echo "/usr/lib64-nvidia" >> /etc/ld.so.conf.d/nvidia.conf
    

âœ¨ ç„¶å**åˆ·æ–°ç¼“å­˜**ï¼Œè®© `ldconfig` é‡æ–°è¯»å–é…ç½®æ–‡ä»¶å³å¯:

    ldconfig
    

å†æ¬¡æŸ¥çœ‹ `ldconfig -p` çš„è¾“å‡ºï¼Œå°±å¯ä»¥çœ‹åˆ° `libnvidia-ml.so` ç­‰å…±äº«åº“å·²ç»è¢«ç¼“å­˜äº†ã€‚

å†æ¬¡å°è¯•è¿è¡Œ GPU å®¹å™¨ï¼Œ`nvidia-smi` å°±èƒ½æ­£å¸¸æ‰“å°å‡º GPU ä¿¡æ¯äº†ï¼Œå†‡é—®é¢˜å•¦!

![nvidia-smi_success-2025-01-22](https://assets.xbottle.top/img/nvidia-smi_success-2025-01-22.png)

### 3.5. æµ‹è¯•ä¸€ä¸‹ PyTorch æ˜¯å¦èƒ½æ­£å¸¸ä½¿ç”¨ GPU

å’±å…ˆæŠŠå¦‚ä¸‹è„šæœ¬ `test.py` æ”¾åœ¨äº† Colab ä¼šè¯ç¯å¢ƒçš„ `/content/test` ç›®å½•ä¸‹:

    import torch
    if torch.cuda.is_available():
        device = torch.device("cuda")
        print(f"GPU å¯ç”¨ï¼Œè®¾å¤‡: {torch.cuda.get_device_name(0)}")
    else:
        device = torch.device("cpu")
        print("GPU ä¸å¯ç”¨ï¼Œè®¾å¤‡: CPU")
    tensor = torch.tensor([1.0, 2.0, 3.0])
    tensor = tensor.to(device)
    print(f"å¼ é‡: {tensor}")
    print(f"å¼ é‡æ‰€åœ¨è®¾å¤‡: {tensor.device}")
    # compute
    result = tensor * 2
    print(result)
    

æŠŠ Python è„šæœ¬æŒ‚è½½åˆ°å®¹å™¨å†…å¹¶æ‰§è¡Œ:

    sudo -u somebottle apptainer exec --bind /content/test:/mnt/data --nv pytorch-gpu.sif python /mnt/data/test.py
    # >> GPU å¯ç”¨ï¼Œè®¾å¤‡: Tesla T4
    # >> å¼ é‡: tensor([1., 2., 3.], device='cuda:0')
    # >> å¼ é‡æ‰€åœ¨è®¾å¤‡: cuda:0
    # >> tensor([2., 4., 6.], device='cuda:0')
    

è¿™æ ·ä¸€æ¥æˆ‘åº”è¯¥å°±èƒ½æ„‰å¿«åœ°åœ¨ Google Colab ç­‰å¹³å°ä¸Šä½¿ç”¨ Apptainer è·‘å®éªŒå•¦~

4\. ç³»ç»Ÿä¸æ”¯æŒç”¨æˆ·å‘½åç©ºé—´
---------------

äº‹æƒ…å¹¶ä¸æ€»æ˜¯ä¸€å¸†é£é¡ºã€‚å½“æˆ‘å°è¯•åœ¨ AutoDL å¹³å°ä¸Šå¤ç°ä¸Šé¢çš„æµç¨‹æ—¶ï¼Œå‘ç° AutoDL ç¦æ­¢äº†éç‰¹æƒç”¨æˆ·åˆ›å»ºç”¨æˆ·å‘½åç©ºé—´ï¼Œä¸”ç¦ç”¨äº† `unshare`ï¼ŒApptainer æ ¹æœ¬å°±è·‘ä¸èµ·æ¥:

![autodl_unprivileged_user_namespace_not_allowed_2-2025-01-23](https://assets.xbottle.top/img/autodl_unprivileged_user_namespace_not_allowed_2-2025-01-23.png)

> è€Œä¸” AutoDL ä¹Ÿç¦ç”¨äº† `setuid` æœºåˆ¶ã€‚

éš¾é“...å°±è¦åˆ°æ­¤ä¸ºæ­¢äº†å—ï¼

![kuyashii-2025-01-24](https://assets.xbottle.top/img/kuyashii-2025-01-24.jpg)

ä¸ï¼Œè¿˜æ²¡å®Œï¼æˆ‘è¿˜èƒ½æˆ˜æ–—ï¼  
å…¶å®è¿˜æœ‰ä¸ªèƒ½**å®Œå…¨åœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œ**çš„å®¹å™¨å·¥å…·å®ç°: [udocker](https://indigo-dc.github.io/udocker/)ã€‚

é»˜è®¤æƒ…å†µä¸‹ udocker åˆ©ç”¨ [PRoot](https://github.com/proot-me/proot) åœ¨ç”¨æˆ·ç©ºé—´æ‹¦æˆªå¹¶æ¨¡æ‹Ÿä¸€äº›ç³»ç»Ÿè°ƒç”¨å’Œç‰¹æƒæ“ä½œï¼Œä»¥åœ¨éç‰¹æƒç”¨æˆ·ä¸‹è¿è¡Œå®¹å™¨ã€‚

*   udocker çš„ç¯å¢ƒéš”ç¦»æ€§æ²¡æœ‰ apptainer å’Œ docker å¥½ã€‚ä½†æˆ‘æœ¬æ¥ä¹Ÿå°±åªæƒ³è¦è¿ç§»è¿è¡Œæ—¶ç¯å¢ƒï¼Œéš”ç¦»æ€§ä¹Ÿæ— æ‰€è°“äº†ï¼ˆè¯¦è§å®˜æ–¹æ–‡æ¡£ [1.3. Security](https://indigo-dc.github.io/udocker/user_manual.html#13-security)ï¼‰ã€‚
    
*   udocker å®¹å™¨ä¸­**æ— æ³•æ‰§è¡ŒçœŸæ­£éœ€è¦ç‰¹æƒçš„æ“ä½œ**ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ã€ä¿®æ”¹å—ä¿æŠ¤çš„é…ç½®ç­‰ã€‚å½“ç„¶è·‘ä¸ªæœºå™¨å­¦ä¹ å®éªŒæ˜¯æ²¡å•¥é—®é¢˜çš„ï¼ˆè¯¦è§å®˜æ–¹æ–‡æ¡£ [1.2. Limitations](https://indigo-dc.github.io/udocker/user_manual.html#12-limitations)ï¼‰ã€‚
    
*   ä»¥ä¸‹ä»£ç æš‚ä¸”ä»¥ `udocker 1.3.17` ç‰ˆæœ¬ä¸ºä¾‹ã€‚
    

### 4.1. ä»¥ root ç”¨æˆ·è¿è¡Œ udocker

ç›´æ¥åœ¨ root ç”¨æˆ·ä¸‹è¿è¡Œï¼Œå‘½ä»¤æ›´ä¸ºç®€çŸ­ï¼Œæ³¨æ„éœ€è¦åŠ ä¸Š `--allow-root` é€‰é¡¹:

ç‚¹å‡»å±•å¼€ç¤ºä¾‹ä»£ç ï¼ˆIPythonï¼‰

    # ä¸‹è½½ udocker åŒ…å¹¶è§£å‹
    !wget https://github.com/indigo-dc/udocker/releases/download/1.3.17/udocker-1.3.17.tar.gz
    !tar -xzf udocker-1.3.17.tar.gz
    
    # æŠŠ udocker æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­
    # æ–¹ä¾¿èµ·è§ï¼Œç»™ udocker --allow-root èµ·ä¸ªåˆ«å mydocker
    %alias mydocker export PATH=udocker-1.3.17/udocker:$PATH; udocker --allow-root
    
    # åˆå§‹åŒ– udockerï¼ˆå³ä½¿ä¸åˆå§‹åŒ–ï¼Œé¦–æ¬¡æ‰§è¡Œæ—¶ä¹Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
    mydocker install
    
    # æ‹‰å–é•œåƒ
    # dockerpull.cn æ˜¯ä¸€ä¸ª DockerHub é•œåƒç«™
    mydocker pull dockerpull.cn/pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime
    
    # åˆ›å»ºå®¹å™¨ï¼Œå®¹å™¨å gputest
    mydocker create --name=gputest dockerpull.cn/pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime
    
    # å¯åŠ¨ NVIDIA æ”¯æŒ
    mydocker setup --nvidia gputest
    
    # æŸ¥çœ‹ GPU ä¿¡æ¯ï¼ˆå¦‚æœæœ‰é—®é¢˜è¯·è§ä¸‹é¢çš„ 4.3 èŠ‚ï¼‰
    mydocker run gputest nvidia-smi
    
    # æŒ‚è½½æµ‹è¯•è„šæœ¬å¹¶è¿è¡Œ
    mydocker run --volume=/root/test.py:/script/test.py gputest python /script/test.py

### 4.2. ä»¥æ™®é€šç”¨æˆ·è¿è¡Œ udocker

åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç :

ç‚¹å‡»å±•å¼€ç¤ºä¾‹ä»£ç ï¼ˆIPythonï¼‰

    # é¦–å…ˆè¿˜æ˜¯æ–°å»ºæ™®é€šç”¨æˆ·
    !adduser --home /home/somebottle --gecos "" --shell /bin/bash --disabled-password somebottle
    
    # ä¸‹è½½ udocker åŒ…å¹¶è§£å‹
    !wget -P /home/somebottle https://github.com/indigo-dc/udocker/releases/download/1.3.17/udocker-1.3.17.tar.gz
    !cd /home/somebottle && tar zxvf udocker-1.3.17.tar.gz && chown somebottle udocker-1.3.17
    
    # æŠŠ udocker æ·»åŠ åˆ°ç”¨æˆ·çš„ç¯å¢ƒå˜é‡ä¸­
    !echo "export PATH=/home/somebottle/udocker-1.3.17/udocker:$PATH" >> /home/somebottle/.profile
    
    # ç»™ä»¥ somebottle èº«ä»½è¿è¡Œçš„å‘½ä»¤èµ·ä¸ªåˆ«å urun
    # åŠ ä¸Š -l é€‰é¡¹åæ‰ä¼šæ‰§è¡Œ Shell é…ç½®æ–‡ä»¶(åŒ…æ‹¬ä¸Šé¢çš„ .profile)
    %alias urun su somebottle -l -c 
    
    # AutoDL å¹³å°ä¸Š python è·¯å¾„åœ¨ /root ç›®å½•ä¸‹ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿èµ·è§ç›´æ¥æŠŠç›®å½•æ‰€æœ‰æƒç»™ somebottle
    # ğŸ’¡ åœ¨ Colab ä¸Šå¯èƒ½ä¸éœ€è¦è¿™ä¸€æ­¥
    !chown -R somebottle /root 2>/dev/null
    
    # åˆå§‹åŒ– udockerï¼ˆå³ä½¿ä¸åˆå§‹åŒ–ï¼Œé¦–æ¬¡æ‰§è¡Œæ—¶ä¹Ÿä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼‰
    urun 'udocker install'
    
    # æ¥ä¸‹æ¥å°±å¯ä»¥æ‹‰å–é•œåƒè¯•è¯•äº†
    # dockerpull.cn æ˜¯ä¸€ä¸ª DockerHub é•œåƒç«™
    urun 'udocker pull dockerpull.cn/pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime'
    
    # åˆ›å»ºå®¹å™¨ï¼Œå®¹å™¨å gputest
    # ä»å®ç°ä¸Šæ¥è®²ï¼Œè¿™ä¸€æ­¥å®é™…ä¸Šæ˜¯æŠŠé•œåƒè§£åŒ…åˆ°ä¸€ä¸ªç”¨æˆ·å¯è®¿é—®çš„ç›®å½•ä¸­ï¼Œä½œä¸º rootfs
    urun 'udocker create --name=gputest dockerpull.cn/pytorch/pytorch:2.5.1-cuda12.4-cudnn9-runtime'
    
    # å¯åŠ¨ NVIDIA æ”¯æŒ
    urun 'udocker setup --nvidia gputest'
    # æŸ¥çœ‹ GPU ä¿¡æ¯ï¼ˆå¦‚æœæœ‰é—®é¢˜è¯·è§ä¸‹é¢çš„ 4.3 èŠ‚ï¼‰
    urun 'udocker run gputest nvidia-smi'
    # æŒ‚è½½æµ‹è¯•è„šæœ¬å¹¶è¿è¡Œ
    urun 'udocker run --volume=/root/test.py:/script/test.py gputest python /script/test.py'

### 4.3. udocker å®¹å™¨ä¸­æ²¡æœ‰ nvidia-smi

udocker é€šè¿‡å°†ä¸€äº› NVIDIA ç›¸å…³çš„å¯æ‰§è¡Œæ–‡ä»¶å’Œåº“æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨çš„å¯¹åº”ç›®å½•ä¸­ï¼Œä»è€Œå®ç°äº†å¯¹ GPU çš„æ”¯æŒã€‚

ä½†æ˜¯ç›®å‰ udocker å¤åˆ¶ NVIDIA ç›¸å…³æ–‡ä»¶çš„é€»è¾‘å¯èƒ½æœ‰äº›é—®é¢˜ã€‚å·²çŸ¥åœ¨ Google Colab å¹³å°ä¸Šå¯èƒ½æ— æ³•åœ¨å®¹å™¨ä¸­è®¿é—® `nvidia-smi` è¿™ç§å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä½†æ˜¯ç›¸å…³åº“æ–‡ä»¶æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œå› æ­¤ PyTorch èƒ½æ­£å¸¸ä½¿ç”¨ GPUã€‚

ç­‰å¾…ä¿®å¤:

*   [Pull Request #438](https://github.com/indigo-dc/udocker/pull/438)

ğŸ’¡ ä½ å¯ä»¥ç›´æ¥ç”¨è¿™ä¸ª PR çš„æäº¤ä¸­çš„ `nvidia.py` æ›¿æ¢ `udocker/engine/nvidia.py` è¿™ä¸ªæ–‡ä»¶ã€‚

5\. é™„ï¼šå…³äº sudo -u
----------------

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä½¿ç”¨äº† `sudo -u somebottle <command>` æ¥ä»¥ somebottle ç”¨æˆ·çš„èº«ä»½æ‰§è¡Œå‘½ä»¤ã€‚

ç„¶è€Œ `sudo -u` å®é™…ä¸Šå¯èƒ½ä¼šé‡ç½®ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥æ‰“å°å‡ºæ¥çœ‹çœ‹:

    echo $PATH
    # >> /opt/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/tools/node/bin:/tools/google-cloud-sdk/bin
    sudo -u somebottle env | grep PATH
    # >> PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
    

å¾ˆæ˜æ˜¾è‡³å°‘ç¯å¢ƒå˜é‡ `$PATH` è¢«é‡ç½®äº†ã€‚

3.4 èŠ‚ä¸­æ–‡æ¡£ \[2\] æ›¾æåˆ°:

> ... , and exectuables are found by searching `$PATH`.

å³ Apptainer åœ¨æŒ‚è½½æ—¶ï¼Œ `nvidia-smi` è¿™ç±»å¯æ‰§è¡Œæ–‡ä»¶æ˜¯ä¾èµ–äº `$PATH` ç¯å¢ƒå˜é‡è¿›è¡Œæœç´¢çš„ã€‚

å¹¸è¿çš„æ˜¯ï¼Œå¯æ‰§è¡Œæ–‡ä»¶ `nvidia-smi` åœ¨ `/usr/bin` ç›®å½•ä¸‹æœ‰è½¯é“¾ï¼Œè€Œé»˜è®¤çš„ `$PATH` ç¯å¢ƒå˜é‡ä¸­åŒ…å«æœ‰è¿™ä¸ªç›®å½•ï¼Œå› æ­¤å¯åŠ¨å®¹å™¨æ—¶ Apptainer èƒ½æˆåŠŸæ‰¾åˆ°ã€‚

    whereis nvidia-smi
    # >> nvidia-smi: /usr/bin/nvidia-smi /opt/bin/nvidia-smi
    ls -hl /usr/bin/nvidia-smi
    # >> lrwxrwxrwx 1 root root 27 Jan 22 13:34 /usr/bin/nvidia-smi -> /opt/bin/.nvidia/nvidia-smi
    

* * *

å‡å¦‚éœ€è¦ä¿ç•™ `sudo` æ‰§è¡Œå‘½ä»¤æ—¶çš„ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ `sudo -E` é€‰é¡¹ï¼Œä½† `$PATH` ç¯å¢ƒå˜é‡å¯èƒ½ä»ç„¶ä¼šè¢«é‡ç½®ï¼Œå› ä¸ºåœ¨é…ç½®æ–‡ä»¶ `/etc/sudoers` ä¸­å¯èƒ½æœ‰ `secure_path` é…ç½®é¡¹è¿›è¡Œäº†é™åˆ¶:

    cat /etc/sudoers | grep secure_path
    # >> Defaults   secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
    

è¿™ç§æƒ…å†µä¸‹è¦ä¸ç›´æ¥ä¿®æ”¹ `/etc/sudoers` æ–‡ä»¶ï¼Œè¦ä¸å°±æ‰‹åŠ¨è®¾å®š `$PATH` ç¯å¢ƒå˜é‡:

    # env PATH=$PATH <command>ï¼Œåœ¨æŒ‡å®šç¯å¢ƒå˜é‡åæ‰§è¡Œå‘½ä»¤
    sudo -u somebottle env PATH=$PATH printenv PATH
    # >> /opt/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/tools/node/bin:/tools/google-cloud-sdk/bin
    

6\. æ€»ç»“
------

æ€»ç»“ä¸€äº›è¦ç‚¹ï¼š

1.  åœ¨ Google Colab ä¸Šä»¥ `root` ç”¨æˆ·è¿è¡Œ Apptainer å®¹å™¨æ—¶ï¼Œéœ€è¦**ä½¿ç”¨ `unshare -r` å‘½ä»¤**æ¥åœ¨æ–°çš„å‘½åç©ºé—´ä¸‹è¿è¡Œå®¹å™¨ï¼Œä»¥è·å¾—å®Œæ•´çš„ capabilities æƒé™é›†ã€‚
    
2.  å¦‚æœå®¹å™¨ä¸­éƒ¨åˆ† NVIDIA çš„åº“ `.so` æ–‡ä»¶æ‰¾ä¸åˆ°ï¼š
    
    1.  å…ˆåœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ `$LD_LIBRARY_PATH` ç¯å¢ƒå˜é‡æ‰¾åˆ° NVIDIA å…±äº«åº“è·¯å¾„ã€‚
    2.  æŠŠè¿™ä¸ªè·¯å¾„å†™å…¥åˆ° `/etc/ld.so.conf.d/` ç›®å½•ä¸‹çš„ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ã€‚
    3.  åˆ©ç”¨ `ldconfig` åˆ·æ–°å…±äº«åº“ç¼“å­˜ã€‚
3.  å¦‚æœå¹³å°ï¼ˆæ¯”å¦‚ AutoDLï¼‰ä¸æ”¯æŒç”¨æˆ·å‘½åç©ºé—´ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ udocker æ¥è¿è¡Œå®¹å™¨ã€‚
    

å¸Œæœ›è¿™ç¯‡ç¬”è®°èƒ½å¤šå¤šå°‘å°‘å¸®åŠ©åˆ°å¤§å®¶å§ï¼Œå’±ä¹Ÿè¦ç»§ç»­è‹¦é€¼åœ°åšå®éªŒå»å•¦ï¼

å’±ä»¬ä¸‹æ¬¡å†ä¼š~ (âˆ ãƒ»Ï‰< )âŒ’â˜…