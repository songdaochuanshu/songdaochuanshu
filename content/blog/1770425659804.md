---
layout: post
title: 'åŸºäº Clean Architecture + DDD çš„è½»é‡çº§å·¥ä½œæµç³»ç»Ÿå®è·µ'
date: "2026-02-07T00:54:19Z"
---
åŸºäº Clean Architecture + DDD çš„è½»é‡çº§å·¥ä½œæµç³»ç»Ÿå®è·µ
=======================================

åŸºäº Clean Architecture + DDD çš„è½»é‡çº§å·¥ä½œæµç³»ç»Ÿå®è·µ
=======================================

> æœ¬æ–‡ä»‹ç»åœ¨ä¸€ä¸ª .NET 10 + Vue 3 çš„åå°ç®¡ç†ç³»ç»Ÿï¼ˆNcp.Adminï¼‰ä¸­ï¼Œå¦‚ä½•åŸºäºç°æœ‰çš„ Clean Architecture + DDD æ¶æ„ï¼Œä»é›¶æ„å»ºä¸€å¥—è½»é‡çº§å®¡æ‰¹å·¥ä½œæµç³»ç»Ÿï¼Œæ¶µç›–åç«¯é¢†åŸŸå»ºæ¨¡ã€CQRS å‘½ä»¤æŸ¥è¯¢ã€é¢†åŸŸäº‹ä»¶é©±åŠ¨çš„ä¸šåŠ¡è‡ªåŠ¨åŒ–ï¼Œä»¥åŠå‰ç«¯å¯è§†åŒ–æµç¨‹èŠ‚ç‚¹è®¾è®¡å™¨çš„å®Œæ•´å®ç°ã€‚

ä¸€ã€é¡¹ç›®èƒŒæ™¯ä¸æŠ€æœ¯æ ˆ
----------

**Ncp.Admin** æ˜¯ä¸€å¥—é‡‡ç”¨ Clean Architecture åˆ†å±‚æ¶æ„çš„åå°ç®¡ç†ç³»ç»Ÿï¼ŒæŠ€æœ¯æ ˆå¦‚ä¸‹ï¼š

å±‚çº§

æŠ€æœ¯é€‰å‹

å‰ç«¯

Vue 3 + Vite + Ant Design Vue (Vben Admin)

API å±‚

ASP.NET Core + FastEndpoints

åº”ç”¨å±‚

MediatR (CQRS)ã€FluentValidation

é¢†åŸŸå±‚

DDD èšåˆæ ¹ã€é¢†åŸŸäº‹ä»¶ã€å¼ºç±»å‹ ID

åŸºç¡€è®¾æ–½

EF Core + Pomelo MySQLã€Redisã€CAPã€Hangfire

é¡¹ç›®å·²ç»æœ‰å®Œå–„çš„ç”¨æˆ·ã€è§’è‰²ã€éƒ¨é—¨ã€æƒé™ç®¡ç†æ¨¡å—ã€‚æœ¬æ¬¡éœ€æ±‚æ˜¯åœ¨ç°æœ‰æ¶æ„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€å¥— **å®¡æ‰¹å·¥ä½œæµç³»ç»Ÿ**ï¼Œæ”¯æŒæµç¨‹å®šä¹‰ã€æµç¨‹å‘èµ·ã€å¤šçº§å®¡æ‰¹ã€é©³å›ã€è½¬åŠç­‰èƒ½åŠ›ï¼Œå¹¶å®ç° **"æ–°å¢ç”¨æˆ·éœ€èµ°å®¡æ‰¹æµç¨‹"** çš„ä¸šåŠ¡é—­ç¯ã€‚

äºŒã€ä¸ºä»€ä¹ˆä¸ç”¨ Elsa Workflowsï¼Ÿ
-----------------------

åœ¨æŠ€æœ¯é€‰å‹é˜¶æ®µï¼Œæˆ‘ä»¬å¯¹æ¯”äº† Elsa Workflows å’Œè‡ªå»ºæ–¹æ¡ˆï¼š

ç»´åº¦

Elsa Workflows

è‡ªå»ºæ–¹æ¡ˆ

åŠŸèƒ½ä¸°å¯Œåº¦

è‡ªå¸¦å¯è§†åŒ–è®¾è®¡å™¨ã€æ¡ä»¶åˆ†æ”¯ã€å®šæ—¶è§¦å‘ç­‰

æŒ‰éœ€å®ç°ï¼ŒåŠŸèƒ½ç²¾ç®€

å­¦ä¹ æˆæœ¬

éœ€ç†è§£ Elsa æ´»åŠ¨æ¨¡å‹ã€åºåˆ—åŒ–æœºåˆ¶

å¤ç”¨ç°æœ‰ DDD æ¨¡å¼ï¼Œå›¢é˜Ÿé›¶æˆæœ¬

æ¶æ„è€¦åˆ

å¼•å…¥ç‹¬ç«‹çš„æŒä¹…åŒ–å±‚å’Œè¿è¡Œæ—¶

å®Œå…¨èå…¥ç°æœ‰åˆ†å±‚æ¶æ„

å‰ç«¯é›†æˆ

è‡ªå¸¦ Blazor/React è®¾è®¡å™¨ï¼Œä¸ Vue ç”Ÿæ€ä¸åŒ¹é…

åŸç”Ÿ Vue 3 + Ant Design Vue

æ•°æ®åº“

é»˜è®¤ SQLiteï¼ŒMySQL æ”¯æŒéœ€é¢å¤–é…ç½®

å¤ç”¨ç°æœ‰ EF Core + MySQL

.NET ç‰ˆæœ¬

Elsa 3.x å¯¹ .NET 10 çš„å…¼å®¹æ€§éœ€éªŒè¯

æ— å…¼å®¹æ€§é£é™©

æœ€ç»ˆé€‰æ‹©äº† **è‡ªå»ºæ–¹æ¡ˆ** â€”â€” å¯¹äºå®¡æ‰¹ç±»å·¥ä½œæµï¼Œæ ¸å¿ƒé€»è¾‘å¹¶ä¸å¤æ‚ï¼Œè€Œè‡ªå»ºæ–¹æ¡ˆå¯ä»¥å®Œç¾èå…¥ç°æœ‰ DDD æ¶æ„ï¼Œä»£ç é£æ ¼ç»Ÿä¸€ï¼Œç»´æŠ¤æˆæœ¬æ›´ä½ã€‚

ä¸‰ã€é¢†åŸŸæ¨¡å‹è®¾è®¡
--------

### 3.1 èšåˆæ ¹åˆ’åˆ†

å·¥ä½œæµç³»ç»Ÿåˆ’åˆ†ä¸ºä¸¤ä¸ªèšåˆï¼š

    WorkflowDefinition (æµç¨‹å®šä¹‰èšåˆ)
    â”œâ”€â”€ WorkflowDefinitionId    // å¼ºç±»å‹ ID
    â”œâ”€â”€ Name / Description / Category
    â”œâ”€â”€ Status (Draft â†’ Published â†’ Archived)
    â”œâ”€â”€ Version
    â”œâ”€â”€ Nodes: ICollection<WorkflowNode>  // æµç¨‹èŠ‚ç‚¹ï¼ˆå€¼å¯¹è±¡é›†åˆï¼‰
    â””â”€â”€ é¢†åŸŸæ–¹æ³•: Publish(), Archive(), GetFirstApprovalNode(), GetNextApprovalNode()
    
    WorkflowInstance (æµç¨‹å®ä¾‹èšåˆ)
    â”œâ”€â”€ WorkflowInstanceId      // å¼ºç±»å‹ ID
    â”œâ”€â”€ WorkflowDefinitionId    // å…³è”å®šä¹‰
    â”œâ”€â”€ BusinessKey / BusinessType
    â”œâ”€â”€ Status (Running â†’ Completed/Rejected/Cancelled)
    â”œâ”€â”€ Variables               // ä¸šåŠ¡æ•°æ® JSON
    â”œâ”€â”€ Tasks: ICollection<WorkflowTask>   // å®¡æ‰¹ä»»åŠ¡é›†åˆ
    â””â”€â”€ é¢†åŸŸæ–¹æ³•: CreateTask(), ApproveTask(), RejectTask(), TransferTask(), Complete()
    

### 3.2 å¼ºç±»å‹ ID

ä¸é¡¹ç›®ç°æœ‰æ¨¡å¼ä¸€è‡´ï¼Œæ‰€æœ‰èšåˆæ ¹ä½¿ç”¨å¼ºç±»å‹ IDï¼š

    public partial record WorkflowDefinitionId : IGuidStronglyTypedId;
    public partial record WorkflowInstanceId : IGuidStronglyTypedId;
    

### 3.3 æµç¨‹å®šä¹‰èšåˆæ ¹

`WorkflowDefinition` æ˜¯æµç¨‹æ¨¡æ¿çš„èšåˆæ ¹ï¼Œå°è£…äº†çŠ¶æ€ç®¡ç†å’Œ **æµç¨‹æµè½¬çš„é¢†åŸŸé€»è¾‘**ï¼š

    public class WorkflowDefinition : Entity<WorkflowDefinitionId>, IAggregateRoot
    {
        public WorkflowDefinitionStatus Status { get; private set; }
        public virtual ICollection<WorkflowNode> Nodes { get; init; } = [];
    
        // çŠ¶æ€å˜æ›´ + é¢†åŸŸäº‹ä»¶
        public void Publish()
        {
            if (Status == WorkflowDefinitionStatus.Published)
                throw new KnownException("æµç¨‹å®šä¹‰å·²ç»å‘å¸ƒ", ErrorCodes.WorkflowDefinitionAlreadyPublished);
    
            Status = WorkflowDefinitionStatus.Published;
            AddDomainEvent(new WorkflowDefinitionPublishedDomainEvent(this));
        }
    
        // æµç¨‹æµè½¬é€»è¾‘ä¸‹æ²‰åˆ°èšåˆæ ¹ï¼ˆè€Œé Handlerï¼‰
        public WorkflowNode? GetFirstApprovalNode()
            => GetOrderedApprovalNodes().FirstOrDefault();
    
        public WorkflowNode? GetNextApprovalNode(string currentNodeName)
        {
            var orderedNodes = GetOrderedApprovalNodes();
            var currentIndex = orderedNodes.ToList().FindIndex(n => n.NodeName == currentNodeName);
            return (currentIndex >= 0 && currentIndex < orderedNodes.Count - 1)
                ? orderedNodes[currentIndex + 1]
                : null;
        }
    }
    

> **DDD è¦ç‚¹**ï¼šæµè½¬é€»è¾‘ï¼ˆè·å–é¦–èŠ‚ç‚¹ã€ä¸‹ä¸€èŠ‚ç‚¹ï¼‰æ”¾åœ¨ `WorkflowDefinition` èšåˆæ ¹è€Œé Command Handler ä¸­ã€‚Handler åªè´Ÿè´£ç¼–æ’è°ƒåº¦ï¼Œé¢†åŸŸé€»è¾‘ç”±èšåˆæ ¹ä¿æŠ¤ã€‚

### 3.4 æµç¨‹å®ä¾‹èšåˆæ ¹

`WorkflowInstance` ç®¡ç†ä¸€æ¬¡å…·ä½“çš„å®¡æ‰¹æµç¨‹æ‰§è¡Œï¼š

    public class WorkflowInstance : Entity<WorkflowInstanceId>, IAggregateRoot
    {
        public string Variables { get; private set; } = "{}"; // ä¸šåŠ¡æ•°æ® JSON
    
        public WorkflowTask CreateTask(string nodeName, WorkflowTaskType taskType,
            UserId assigneeId, string assigneeName)
        {
            var task = new WorkflowTask(nodeName, taskType, assigneeId, assigneeName);
            Tasks.Add(task);
            CurrentNodeName = nodeName;
            AddDomainEvent(new WorkflowTaskCreatedDomainEvent(this, task));
            return task;
        }
    
        public void ApproveTask(WorkflowTaskId taskId, UserId operatorId, string comment)
        {
            var task = Tasks.FirstOrDefault(t => t.Id == taskId)
                ?? throw new KnownException("æœªæ‰¾åˆ°è¯¥ä»»åŠ¡", ErrorCodes.WorkflowTaskNotFound);
            task.Approve(comment);
            AddDomainEvent(new WorkflowTaskCompletedDomainEvent(this, task));
        }
    
        public void Complete()
        {
            Status = WorkflowInstanceStatus.Completed;
            CompletedAt = DateTimeOffset.UtcNow;
            AddDomainEvent(new WorkflowInstanceCompletedDomainEvent(this));
        }
    }
    

å››ã€CQRS å‘½ä»¤ä¸æŸ¥è¯¢
------------

### 4.1 å‘èµ·æµç¨‹å‘½ä»¤

`StartWorkflowCommand` æ¼”ç¤ºäº† Handler å¦‚ä½• **ç¼–æ’** èšåˆæ ¹äº¤äº’ï¼š

    public class StartWorkflowCommandHandler(
        IWorkflowDefinitionRepository definitionRepository,
        IWorkflowInstanceRepository instanceRepository)
        : ICommandHandler<StartWorkflowCommand, WorkflowInstanceId>
    {
        public async Task<WorkflowInstanceId> Handle(StartWorkflowCommand request, CancellationToken ct)
        {
            var definition = await definitionRepository.GetAsync(request.WorkflowDefinitionId, ct)
                ?? throw new KnownException("æœªæ‰¾åˆ°æµç¨‹å®šä¹‰");
    
            // åˆ›å»ºå®ä¾‹
            var instance = new WorkflowInstance(
                request.WorkflowDefinitionId, definition.Name,
                request.BusinessKey, request.BusinessType,
                request.Title, request.InitiatorId, request.InitiatorName,
                request.Variables, request.Remark);
    
            await instanceRepository.AddAsync(instance, ct);
    
            // é€šè¿‡èšåˆæ ¹é¢†åŸŸæ–¹æ³•è·å–ç¬¬ä¸€ä¸ªå®¡æ‰¹èŠ‚ç‚¹ï¼ˆé€»è¾‘åœ¨ Definition ä¸­ï¼‰
            var firstNode = definition.GetFirstApprovalNode();
            if (firstNode != null && long.TryParse(firstNode.AssigneeValue, out var id))
            {
                instance.CreateTask(firstNode.NodeName, WorkflowTaskType.Approval,
                    new UserId(id), string.Empty);
            }
    
            return instance.Id;
        }
    }
    

### 4.2 å®¡æ‰¹å‘½ä»¤ â€” è‡ªåŠ¨æµè½¬

    public class ApproveTaskCommandHandler(
        IWorkflowInstanceRepository instanceRepository,
        IWorkflowDefinitionRepository definitionRepository) : ICommandHandler<ApproveTaskCommand>
    {
        public async Task Handle(ApproveTaskCommand request, CancellationToken ct)
        {
            var instance = await instanceRepository.GetAsync(request.WorkflowInstanceId, ct);
            instance.ApproveTask(request.TaskId, request.OperatorId, request.Comment);
    
            var definition = await definitionRepository.GetAsync(instance.WorkflowDefinitionId, ct);
            var approvedTask = instance.Tasks.First(t => t.Id == request.TaskId);
    
            // é¢†åŸŸæ–¹æ³•ï¼šè·å–ä¸‹ä¸€èŠ‚ç‚¹
            var nextNode = definition.GetNextApprovalNode(approvedTask.NodeName);
    
            if (nextNode != null)
            {
                // åˆ›å»ºä¸‹ä¸€ä¸ªå®¡æ‰¹ä»»åŠ¡
                instance.CreateTask(nextNode.NodeName, WorkflowTaskType.Approval, ...);
            }
            else
            {
                // æ‰€æœ‰èŠ‚ç‚¹å®¡æ‰¹å®Œæ¯•ï¼Œæµç¨‹å®Œæˆ
                instance.Complete();
            }
        }
    }
    

äº”ã€é¢†åŸŸäº‹ä»¶é©±åŠ¨çš„ä¸šåŠ¡è‡ªåŠ¨åŒ–
--------------

### 5.1 é¢†åŸŸäº‹ä»¶å®šä¹‰

    public record WorkflowDefinitionPublishedDomainEvent(WorkflowDefinition WorkflowDefinition) : IDomainEvent;
    public record WorkflowInstanceStartedDomainEvent(WorkflowInstance WorkflowInstance) : IDomainEvent;
    public record WorkflowInstanceCompletedDomainEvent(WorkflowInstance WorkflowInstance) : IDomainEvent;
    public record WorkflowTaskCreatedDomainEvent(WorkflowInstance WorkflowInstance, WorkflowTask WorkflowTask) : IDomainEvent;
    public record WorkflowTaskCompletedDomainEvent(WorkflowInstance WorkflowInstance, WorkflowTask WorkflowTask) : IDomainEvent;
    

### 5.2 å®¡æ‰¹é€šè¿‡åè‡ªåŠ¨æ‰§è¡Œä¸šåŠ¡æ“ä½œ

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„äº®ç‚¹è®¾è®¡ â€”â€” é€šè¿‡é¢†åŸŸäº‹ä»¶å®ç° **æµç¨‹ä¸ä¸šåŠ¡çš„è§£è€¦**ï¼š

    public class WorkflowInstanceCompletedDomainEventHandler(IMediator mediator, RoleQuery roleQuery)
        : IDomainEventHandler<WorkflowInstanceCompletedDomainEvent>
    {
        public async Task Handle(WorkflowInstanceCompletedDomainEvent domainEvent, CancellationToken ct)
        {
            var instance = domainEvent.WorkflowInstance;
            if (instance.Status != WorkflowInstanceStatus.Completed) return;
    
            switch (instance.BusinessType)
            {
                case "CreateUser":
                    await HandleCreateUser(instance, ct);
                    break;
                // åç»­å¯æ‰©å±•ï¼šcase "PurchaseOrder": ...
            }
        }
    
        private async Task HandleCreateUser(WorkflowInstance instance, CancellationToken ct)
        {
            // ä» Variables JSON ä¸­ååºåˆ—åŒ–ç”¨æˆ·æ•°æ®
            var userData = JsonSerializer.Deserialize<CreateUserVariables>(instance.Variables);
    
            // å¤ç”¨ç°æœ‰çš„ CreateUserCommand
            var cmd = new CreateUserCommand(
                userData.Name, userData.Email, userData.Password, ...);
            await mediator.Send(cmd, ct);
        }
    }
    

> **è®¾è®¡æ€æƒ³**ï¼šå‰ç«¯æäº¤å®¡æ‰¹æ—¶ï¼Œå°†å®Œæ•´çš„ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ä¿¡æ¯ï¼‰åºåˆ—åŒ–ä¸º JSON å­˜å…¥ `Variables` å­—æ®µã€‚å®¡æ‰¹é€šè¿‡åï¼Œé¢†åŸŸäº‹ä»¶å¤„ç†å™¨ä» `Variables` ä¸­ååºåˆ—åŒ–æ•°æ®ï¼Œè°ƒç”¨å¯¹åº”çš„ä¸šåŠ¡ Command å®Œæˆæ“ä½œã€‚è¿™æ · **å·¥ä½œæµå¼•æ“æœ¬èº«ä¸éœ€è¦äº†è§£ä»»ä½•ä¸šåŠ¡ç»†èŠ‚**ï¼Œæ–°å¢ä¸šåŠ¡ç±»å‹åªéœ€åœ¨ `switch` ä¸­æ‰©å±•å³å¯ã€‚

å…­ã€å‰ç«¯å¯è§†åŒ–èŠ‚ç‚¹è®¾è®¡å™¨
------------

### 6.1 è®¾è®¡æ€è·¯

ä¼ ç»Ÿçš„åšæ³•æ˜¯è®©ç”¨æˆ·ç¼–è¾‘ JSON æ¥é…ç½®æµç¨‹èŠ‚ç‚¹ï¼Œè¿™æ˜¾ç„¶ä¸å¤Ÿå‹å¥½ã€‚æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª **åŸºäºç«–å‘æµç¨‹å›¾çš„å¯è§†åŒ–èŠ‚ç‚¹è®¾è®¡å™¨**ï¼š

        [â–¶ å¼€å§‹]
           â”‚
           â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ âœ“ ä¸»ç®¡å®¡æ‰¹     â”‚  â† å¯ç¼–è¾‘å¡ç‰‡
      â”‚ ç±»å‹: å®¡æ‰¹     â”‚
      â”‚ å¤„ç†äºº: å¼ ä¸‰   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
          (+)           â† ç‚¹å‡»æ’å…¥æ–°èŠ‚ç‚¹
           â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ âœ“ æ€»ç›‘å®¡æ‰¹     â”‚
      â”‚ ç±»å‹: å®¡æ‰¹     â”‚
      â”‚ å¤„ç†äºº: æå››   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â†“
        [â–  ç»“æŸ]
    

### 6.2 ç»„ä»¶å®ç°

`node-designer.vue` æ˜¯ä¸€ä¸ªå®Œæ•´çš„ Vue 3 ç»„ä»¶ï¼Œæ ¸å¿ƒè®¾è®¡å¦‚ä¸‹ï¼š

**äº¤äº’èƒ½åŠ›**ï¼š

*   æ·»åŠ èŠ‚ç‚¹ï¼ˆé¡¶éƒ¨ã€ä¸­é—´ã€åº•éƒ¨å‡å¯æ’å…¥ï¼‰
*   åˆ é™¤èŠ‚ç‚¹ï¼ˆå¸¦ Popconfirm äºŒæ¬¡ç¡®è®¤ï¼‰
*   ä¸Šä¸‹ç§»åŠ¨èŠ‚ç‚¹ï¼ˆè°ƒæ•´å®¡æ‰¹é¡ºåºï¼‰
*   é…ç½®èŠ‚ç‚¹å±æ€§ï¼ˆåç§°ã€ç±»å‹ã€å¤„ç†äººç±»å‹ã€å¤„ç†äººï¼‰
*   å·²å‘å¸ƒæµç¨‹åªè¯»ï¼Œä¸å¯ç¼–è¾‘

**è§†è§‰è®¾è®¡**ï¼š

*   å¼€å§‹/ç»“æŸèŠ‚ç‚¹ä½¿ç”¨æ¸å˜è‰²åœ†å½¢æ ‡è¯†
*   èŠ‚ç‚¹å¡ç‰‡é¡¶éƒ¨å½©è‰²è‰²æ¡æ ‡è¯†ç±»å‹ï¼ˆè“è‰²=å®¡æ‰¹ã€ç»¿è‰²=æŠ„é€ã€æ©™è‰²=é€šçŸ¥ï¼‰
*   è¿æ¥çº¿å¸¦æœ‰æ–¹å‘ç®­å¤´
*   æ‚¬æµ®åŠ¨æ•ˆï¼ˆå¡ç‰‡å¾®æµ®ã€æ“ä½œæŒ‰é’®æ¸æ˜¾ã€æ·»åŠ æŒ‰é’®ç¼©æ”¾é«˜äº®ï¼‰
*   è¡¨å•åŒåˆ—å¸ƒå±€èŠ‚çœç©ºé—´

**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š

    // èŠ‚ç‚¹ç±»å‹è§†è§‰é…ç½®
    const nodeTypeConfig: Record<number, { color: string; bg: string; icon: string }> = {
      1: { color: '#1677ff', bg: '#e6f4ff', icon: 'âœ“' },  // å®¡æ‰¹
      2: { color: '#52c41a', bg: '#f6ffed', icon: 'ğŸ“‹' },  // æŠ„é€
      3: { color: '#faad14', bg: '#fffbe6', icon: 'ğŸ””' },  // é€šçŸ¥
    };
    

### 6.3 åˆ†ç±»ä¸‹æ‹‰é€‰æ‹©

æµç¨‹å®šä¹‰çš„ã€Œåˆ†ç±»ã€å­—æ®µä»è‡ªç”±æ–‡æœ¬è¾“å…¥æ”¹ä¸ºä¸‹æ‹‰é€‰æ‹©ï¼Œç»Ÿä¸€ç»´æŠ¤æšä¸¾å€¼ï¼š

    export function useCategoryOptions() {
      return [
        { label: 'ç”¨æˆ·ç®¡ç†', value: 'UserManagement' },
        { label: 'è§’è‰²ç®¡ç†', value: 'RoleManagement' },
        { label: 'è¯·å‡å®¡æ‰¹', value: 'LeaveRequest' },
        { label: 'é‡‡è´­å®¡æ‰¹', value: 'PurchaseOrder' },
        { label: 'æŠ¥é”€å®¡æ‰¹', value: 'Reimbursement' },
        { label: 'é€šç”¨æµç¨‹', value: 'General' },
      ];
    }
    

å‰ç«¯æŸ¥æ‰¾å¯¹åº”æµç¨‹å®šä¹‰æ—¶ä½¿ç”¨æšä¸¾å€¼ç²¾ç¡®åŒ¹é…ï¼Œä¸å†ä¾èµ–ä¸­æ–‡å­—ç¬¦ä¸²ï¼š

    const userCreateDef = definitions.find(
      (d) => d.category === 'UserManagement',
    );
    

ä¸ƒã€æ“ä½œæŒ‡å—ï¼šå¦‚ä½•åˆ›å»ºæµç¨‹ä¸å®¡æ‰¹
----------------

ä¸‹é¢ä»ä½¿ç”¨è§’åº¦è¯´æ˜ï¼š**å¦‚ä½•åˆ›å»ºä¸€æ¡è‡ªå®šä¹‰å·¥ä½œæµç¨‹**ï¼Œä»¥åŠ **å®¡æ‰¹äººåœ¨å“ªé‡Œå¤„ç†å¾…åŠ**ã€‚

### 7.1 å¦‚ä½•åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å·¥ä½œæµç¨‹

1.  è¿›å…¥ **å·¥ä½œæµç®¡ç† â†’ æµç¨‹å®šä¹‰**ã€‚
2.  ç‚¹å‡» **æ–°å¢**ï¼Œæ‰“å¼€æµç¨‹å®šä¹‰è¡¨å•ã€‚
3.  å¡«å†™ **æµç¨‹åç§°**ã€**åˆ†ç±»**ï¼ˆä»ä¸‹æ‹‰é€‰æ‹©ï¼Œå¦‚ã€Œç”¨æˆ·ç®¡ç†ã€ã€Œè¯·å‡å®¡æ‰¹ã€ç­‰ï¼‰ã€**æè¿°**ã€‚
4.  åœ¨ **æµç¨‹èŠ‚ç‚¹è®¾è®¡** åŒºåŸŸé…ç½®å®¡æ‰¹èŠ‚ç‚¹ï¼š
    *   ç‚¹å‡»ã€Œ+ æ·»åŠ èŠ‚ç‚¹ã€æˆ–èŠ‚ç‚¹ä¹‹é—´çš„ã€Œ+ã€æ’å…¥èŠ‚ç‚¹ï¼›
    *   ä¸ºæ¯ä¸ªèŠ‚ç‚¹å¡«å†™ **èŠ‚ç‚¹åç§°**ï¼Œé€‰æ‹© **èŠ‚ç‚¹ç±»å‹**ï¼ˆå®¡æ‰¹ / æŠ„é€ / é€šçŸ¥ï¼‰ï¼›
    *   é€‰æ‹© **å¤„ç†äººç±»å‹**ï¼ˆæŒ‡å®šç”¨æˆ·ã€æŒ‡å®šè§’è‰²ã€éƒ¨é—¨ä¸»ç®¡ã€å‘èµ·äººè‡ªé€‰ï¼‰ï¼Œè‹¥ä¸ºæŒ‡å®šç”¨æˆ·æˆ–æŒ‡å®šè§’è‰²ï¼Œå†é€‰æ‹©å…·ä½“ **å¤„ç†äºº**ï¼›
    *   é€šè¿‡ **ä¸Šç§» / ä¸‹ç§»** è°ƒæ•´èŠ‚ç‚¹é¡ºåºï¼Œé€šè¿‡ **åˆ é™¤** ç§»é™¤èŠ‚ç‚¹ã€‚
5.  ä¿å­˜åï¼Œåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°è¯¥æµç¨‹ï¼Œç‚¹å‡» **å‘å¸ƒ**ã€‚åªæœ‰å·²å‘å¸ƒçš„æµç¨‹æ‰èƒ½è¢«å‘èµ·ã€‚

![æµç¨‹å®šä¹‰åˆ—è¡¨ä¸ç¼–è¾‘](https://img2024.cnblogs.com/blog/553504/202602/553504-20260206174444280-259695173.png)

_æµç¨‹å®šä¹‰åˆ—è¡¨ï¼šå¯æ–°å¢ã€ç¼–è¾‘ã€å‘å¸ƒã€å½’æ¡£ï¼›ç¼–è¾‘æ—¶åœ¨ä¸‹æ–¹è¿›è¡Œæµç¨‹èŠ‚ç‚¹è®¾è®¡ã€‚_

### 7.2 åœ¨å“ªé‡Œå®¡æ‰¹

å®¡æ‰¹äººçš„å¾…åŠä»»åŠ¡åœ¨ **å·¥ä½œæµç®¡ç† â†’ æˆ‘çš„å¾…åŠ** ä¸­å¤„ç†ï¼š

1.  ç™»å½•åè¿›å…¥ **å·¥ä½œæµç®¡ç†** èœå•ï¼Œç‚¹å‡» **æˆ‘çš„å¾…åŠ**ã€‚
2.  åˆ—è¡¨ä¸­å±•ç¤ºå½“å‰ç”¨æˆ·ä½œä¸ºå¤„ç†äººçš„æ‰€æœ‰å¾…å®¡æ‰¹ä»»åŠ¡ï¼ˆæµç¨‹æ ‡é¢˜ã€æµç¨‹åç§°ã€å‘èµ·äººã€èŠ‚ç‚¹åç§°ç­‰ï¼‰ã€‚
3.  ç‚¹å‡» **åŠç†** è¿›å…¥è¯¦æƒ…ï¼Œå¯æŸ¥çœ‹æµç¨‹ä¿¡æ¯ä¸ä¸šåŠ¡æ•°æ®ï¼ˆå¦‚ç”¨æˆ·ç”³è¯·å†…å®¹ï¼‰ï¼Œè¿›è¡Œ **é€šè¿‡**ã€**é©³å›** æˆ– **è½¬åŠ** æ“ä½œã€‚
4.  å·²å¤„ç†çš„ä»»åŠ¡å¯åœ¨ **æˆ‘çš„å·²åŠ** ä¸­æŸ¥çœ‹å†å²è®°å½•ã€‚

![æˆ‘çš„å¾…åŠ](https://img2024.cnblogs.com/blog/553504/202602/553504-20260206174503542-837619307.png)

_æˆ‘çš„å¾…åŠï¼šå®¡æ‰¹äººåœ¨æ­¤å¤„ç†å¾…å®¡æ‰¹ä»»åŠ¡ã€‚_

å…«ã€æ–°å¢ç”¨æˆ·èµ°å®¡æ‰¹æµç¨‹ â€” å®Œæ•´é“¾è·¯
------------------

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ç«¯åˆ°ç«¯ç¤ºä¾‹ï¼Œå±•ç¤ºå·¥ä½œæµå¦‚ä½•ä¸å…·ä½“ä¸šåŠ¡æ‰“é€šï¼š

### 8.1 å‰ç«¯ â€” æäº¤å®¡æ‰¹

åœ¨ **ç³»ç»Ÿç®¡ç† â†’ ç”¨æˆ·ç®¡ç†** çš„æ–°å¢ç”¨æˆ·è¡¨å•ä¸­ï¼Œæä¾›ã€Œæäº¤å®¡æ‰¹ã€æŒ‰é’®ã€‚ç”¨æˆ·å¡«å†™å®Œè´¦å·ã€å§“åã€è§’è‰²ç­‰ä¿¡æ¯åï¼Œå¯é€‰æ‹©ç›´æ¥ä¿å­˜ï¼ˆè‹¥æœ‰æƒé™ï¼‰æˆ– **æäº¤å®¡æ‰¹**ã€‚ç‚¹å‡»ã€Œæäº¤å®¡æ‰¹ã€åï¼š

1.  éªŒè¯è¡¨å•æ•°æ®
2.  æŸ¥è¯¢å·²å‘å¸ƒçš„æµç¨‹å®šä¹‰ï¼ŒåŒ¹é…åˆ†ç±»ä¸ºã€Œç”¨æˆ·ç®¡ç†ã€çš„å®šä¹‰
3.  å°†ç”¨æˆ·è¡¨å•æ•°æ® JSON åºåˆ—åŒ–ä¸º `variables`
4.  è°ƒç”¨ `startWorkflow` API å‘èµ·å®¡æ‰¹

![ç”¨æˆ·ç®¡ç†-æäº¤å®¡æ‰¹](https://img2024.cnblogs.com/blog/553504/202602/553504-20260206174554266-1617952302.png)

_æ–°å¢ç”¨æˆ·æ—¶å¯é€‰æ‹©ã€Œæäº¤å®¡æ‰¹ã€ï¼Œè¿›å…¥å·²é…ç½®çš„ç”¨æˆ·ç®¡ç†å®¡æ‰¹æµç¨‹ã€‚_

    async function onSubmitForApproval() {
      const { valid } = await formApi.validate();
      if (!valid) return;
    
      const definitions = await getPublishedDefinitions();
      const userCreateDef = definitions.find(d => d.category === 'UserManagement');
    
      const formValues = await formApi.getValues();
      const variables = JSON.stringify({
        name: formValues.name,
        email: formValues.email,
        password: formValues.password,
        realName: formValues.realName,
        roleIds: formValues.roleIds || [],
        // ... å…¶ä»–å­—æ®µ
      });
    
      await startWorkflow({
        workflowDefinitionId: userCreateDef.id,
        businessKey: `user-create-${Date.now()}`,
        businessType: 'CreateUser',
        title: `æ–°å¢ç”¨æˆ·ç”³è¯· - ${formValues.realName}`,
        variables,
      });
    }
    

### 8.2 åç«¯ â€” å®¡æ‰¹æµè½¬

    æäº¤å®¡æ‰¹ â†’ StartWorkflowCommand
             â†’ åˆ›å»º WorkflowInstance
             â†’ Definition.GetFirstApprovalNode() â†’ åˆ›å»ºç¬¬ä¸€ä¸ª Task
    
    å®¡æ‰¹é€šè¿‡ â†’ ApproveTaskCommand
             â†’ Instance.ApproveTask()
             â†’ Definition.GetNextApprovalNode()
             â†’ æœ‰ä¸‹ä¸€èŠ‚ç‚¹ â†’ åˆ›å»ºæ–° Task
             â†’ æ— ä¸‹ä¸€èŠ‚ç‚¹ â†’ Instance.Complete()
                           â†’ è§¦å‘ WorkflowInstanceCompletedDomainEvent
    
    é¢†åŸŸäº‹ä»¶ â†’ WorkflowInstanceCompletedDomainEventHandler
             â†’ BusinessType == "CreateUser"
             â†’ ååºåˆ—åŒ– Variables â†’ CreateUserCommand â†’ ç”¨æˆ·åˆ›å»ºæˆåŠŸ
    

### 8.3 æµç¨‹å›¾

    [ç”¨æˆ·å¡«å†™è¡¨å•] â†’ [æäº¤å®¡æ‰¹] â†’ [ä¸»ç®¡å®¡æ‰¹] â†’ [æ€»ç›‘å®¡æ‰¹] â†’ [å®¡æ‰¹é€šè¿‡]
                                                             â†“
                                                       [é¢†åŸŸäº‹ä»¶è§¦å‘]
                                                             â†“
                                                      [è‡ªåŠ¨åˆ›å»ºç”¨æˆ·]
    

ä¹ã€æ¶æ„äº®ç‚¹æ€»ç»“
--------

### 9.1 DDD åŸåˆ™è´¯ç©¿å§‹ç»ˆ

åŸåˆ™

å®è·µ

èšåˆæ ¹å°è£…

çŠ¶æ€å˜æ›´ã€æµè½¬é€»è¾‘ã€ä¸šåŠ¡è§„åˆ™æ ¡éªŒå‡åœ¨èšåˆæ ¹å†…

é¢†åŸŸäº‹ä»¶

æ¯ä¸ªå…³é”®çŠ¶æ€å˜æ›´éƒ½å‘å¸ƒå¯¹åº”é¢†åŸŸäº‹ä»¶

å¼ºç±»å‹ ID

`WorkflowDefinitionId`ã€`WorkflowInstanceId` é¿å… ID è¯¯ç”¨

å€¼å¯¹è±¡

`WorkflowNode` ä½œä¸º `WorkflowDefinition` çš„å­å®ä½“é›†åˆ

### 9.2 CQRS åˆ†ç¦»æ¸…æ™°

*   **Command ä¾§**ï¼š`StartWorkflowCommand`ã€`ApproveTaskCommand`ã€`RejectTaskCommand` ç­‰ï¼ŒHandler åªåšç¼–æ’
*   **Query ä¾§**ï¼š`WorkflowDefinitionQuery`ã€`WorkflowInstanceQuery`ï¼Œä½¿ç”¨ `AsNoTracking()` ä¼˜åŒ–æ€§èƒ½ï¼Œé…åˆ `IMemoryCache` ç¼“å­˜é«˜é¢‘æ•°æ®

### 9.3 ä¸šåŠ¡ä¸æµç¨‹è§£è€¦

    å·¥ä½œæµå¼•æ“ï¼ˆé€šç”¨ï¼‰          ä¸šåŠ¡å¤„ç†ï¼ˆç‰¹å®šï¼‰
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    WorkflowInstance           â†— CreateUserCommand
      .Complete()              â”‚
      â†’ DomainEvent  â”€â”€â”€â”€â”€â”€â†’  EventHandler (switch BusinessType)
                               â”‚
                               â†˜ å…¶ä»–ä¸šåŠ¡ Command
    

æ–°å¢ä¸šåŠ¡ç±»å‹æ—¶ï¼š

1.  å‰ç«¯æ–°å¢æäº¤å…¥å£ï¼Œä¼ å…¥ `businessType` å’Œ `variables`
2.  åç«¯åœ¨ `WorkflowInstanceCompletedDomainEventHandler` çš„ `switch` ä¸­å¢åŠ åˆ†æ”¯
3.  æµç¨‹å¼•æ“æœ¬èº«æ— éœ€ä»»ä½•ä¿®æ”¹

### 9.4 å‰ç«¯ä½“éªŒä¼˜åŒ–

*   å¯è§†åŒ–èŠ‚ç‚¹è®¾è®¡å™¨æ›¿ä»£ JSON ç¼–è¾‘ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
*   åˆ†ç±»æšä¸¾åŒ–ï¼Œé¿å…è‡ªç”±æ–‡æœ¬å¸¦æ¥çš„åŒ¹é…é”™è¯¯
*   i18n å›½é™…åŒ–æ”¯æŒä¸­è‹±æ–‡
*   å·²å‘å¸ƒæµç¨‹è‡ªåŠ¨é”å®šä¸ºåªè¯»æ¨¡å¼

åã€åç»­è§„åˆ’
------

1.  **æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹**ï¼šæ ¹æ®è¡¨å•å­—æ®µå€¼èµ°ä¸åŒå®¡æ‰¹è·¯å¾„
2.  **ä¼šç­¾/æˆ–ç­¾**ï¼šä¸€ä¸ªèŠ‚ç‚¹å¯é…ç½®å¤šä¸ªå®¡æ‰¹äºº
3.  **å®¡æ‰¹å‚¬åŠ**ï¼šåŸºäº Hangfire å®šæ—¶æ£€æŸ¥è¶…æ—¶ä»»åŠ¡
4.  **æµç¨‹ç»Ÿè®¡çœ‹æ¿**ï¼šå®¡æ‰¹æ•ˆç‡ã€ç“¶é¢ˆèŠ‚ç‚¹åˆ†æ
5.  **ç§»åŠ¨ç«¯é€‚é…**ï¼šå®¡æ‰¹ä»»åŠ¡æ¨é€ + ç§»åŠ¨ç«¯å¿«é€Ÿå®¡æ‰¹

åä¸€ã€ç»“è¯­
-----

ä¸€å¥—å¥½çš„å·¥ä½œæµç³»ç»Ÿï¼Œæ ¸å¿ƒä¸åœ¨äºåŠŸèƒ½æœ‰å¤šä¸°å¯Œï¼Œè€Œåœ¨äº **ä¸ç°æœ‰æ¶æ„çš„èåˆåº¦** å’Œ **ä¸šåŠ¡æ‰©å±•çš„ä¾¿æ·æ€§**ã€‚

æœ¬æ¬¡å®è·µè¯æ˜ï¼Œåœ¨ Clean Architecture + DDD çš„é¡¹ç›®ä¸­ï¼Œè‡ªå»ºè½»é‡çº§å·¥ä½œæµæ˜¯å®Œå…¨å¯è¡Œçš„ã€‚é€šè¿‡èšåˆæ ¹å°è£…æµè½¬é€»è¾‘ã€é¢†åŸŸäº‹ä»¶é©±åŠ¨ä¸šåŠ¡è‡ªåŠ¨åŒ–ã€CQRS åˆ†ç¦»è¯»å†™å…³æ³¨ç‚¹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ° 2000 è¡Œåç«¯ä»£ç å°±å®ç°äº†ä¸€å¥— **å¯ç”¨ã€å¯æ‰©å±•ã€æ¶æ„ä¸€è‡´** çš„å®¡æ‰¹ç³»ç»Ÿã€‚

å‰ç«¯æ–¹é¢ï¼Œä¸€ä¸ª 600 è¡Œçš„ Vue ç»„ä»¶å°±æ­å»ºèµ·äº†ç›´è§‚çš„å¯è§†åŒ–èŠ‚ç‚¹è®¾è®¡å™¨ï¼Œé…åˆ Ant Design Vue çš„ç»„ä»¶åº“ï¼Œç”¨æˆ·ä½“éªŒä¹Ÿåšåˆ°äº†å¼€ç®±å³ç”¨ã€‚

**ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦å¼•å…¥é‡é‡çº§çš„å·¥ä½œæµå¼•æ“ï¼Œé€‚åˆçš„æ‰æ˜¯æœ€å¥½çš„ã€‚**

* * *

é¡¹ç›®æºç åœ°å€ï¼š[https://github.com/zhouda1fu/Ncp.Admin](https://github.com/zhouda1fu/Ncp.Admin)