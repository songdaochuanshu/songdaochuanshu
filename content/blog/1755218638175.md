---
layout: post
title: '【渲染流水线】[几何阶段]-[几何着色]以UnityURP为例'
date: "2025-08-15T00:43:58Z"
---
【渲染流水线】\[几何阶段\]-\[几何着色\]以UnityURP为例
===================================

![【渲染流水线】[几何阶段]-[几何着色]以UnityURP为例](https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250814152452812-450212077.png) 《Unity URP几何着色器技术解析》摘要： 几何着色器是URP中唯一支持自定义图元生成的着色器阶段（部分平台受限）。它位于顶点/曲面细分着色器之后，可接收完整图元数据并通过流输出机制动态修改几何结构，支持顶点增删改操作。典型应用包括模型细分（如将三角形拆分为子三角形）和轮廓线生成。实现时需声明#pragma geometry，使用TriangleStream等输出流类型，并通过maxvertexcount控制顶点输出量。需注意该技术对DX11/OpenGL ES3.2及以上API的依赖，移动端兼容性问题

*   允许自定义增加和创建新图元，**唯一一个能自定义增加新图元的着色器**。（部分平台支持，移动端很多不支持、apple的metal不支持）

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

‌**作用**‌
========

*   基于图元生成新几何体（如将点扩展为粒子），位于曲面细分后、光栅化前 ‌。
*   这是一个‌**可选**‌阶段。它在曲面细分着色器之后运行（或在顶点着色器之后，如果没有曲面细分）。它接收一个完整的图元（点、线或三角形，以及其所有顶点），可以输出零个、一个或多个修改过的或全新的图元（点、线、三角带）。‌

‌**配置**‌
========

*   Shader 中声明 `#pragma geometry geom`。

**核心工作原理**
==========

*   数据处理流程：
    *   输入阶段：接收完整图元数据（点/线/三角形及其邻接变体）的顶点数组
    *   处理阶段：通过流输出对象动态修改几何数据，支持顶点增删改操作
    *   输出阶段：使用Append()方法将新顶点写入流对象，RestartStrip()重置三角带
*   图元操作机制：
    *   增删控制：通过maxvertexcount限制单次调用最大输出顶点数（建议值3-20个）
    *   修改方式：在齐次裁剪空间重新计算顶点位置
    *   分裂实现：例如将三角形拆分为多个子三角形时需重新计算法线

**URP实现步骤**
===========

*   Shader基础结构：
    
        hlsl
        Shader "Custom/URPGeoShader" {
            Properties { _Extrude("Extrude", Float) = 0.1 }
            SubShader {
                Pass {
                    HLSLPROGRAM
                    #pragma vertex vert
                    #pragma geometry geom
                    #pragma fragment frag
                    #include "Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"
        
                    struct v2g {
                        float4 posOS : TEXCOORD0;
                        float3 normalOS : NORMAL;
                    };
        
                    struct g2f {
                        float4 posCS : SV_POSITION;
                        float3 normalWS : TEXCOORD0;
                    };
        
                    [maxvertexcount(6)]
                    void geom(triangle v2g input[3], inout TriangleStream<g2f> stream) {
                        // 几何处理逻辑
                    }
                    ENDHLSL
                }
            }
        }
        
    
*   关键参数说明：
    
    *   PrimitiveType：支持point/line/triangle及其邻接类型
    *   Stream类型：PointStream/LineStream/TriangleStream三种输出流
    *   性能优化：建议输出标量总数控制在20个以内

典型应用案例
======

模型细分：
-----

    hlsl
    void geom(triangle v2g input[3], inout TriangleStream<g2f> stream) {
        float3 center = (input[0].posOS + input[1].posOS + input[2].posOS) / 3;
        for(int i=0; i<3; i++) {
            g2f o;
            o.posCS = UnityObjectToClipPos(center);
            stream.Append(o);
            o.posCS = UnityObjectToClipPos(input[i].posOS);
            stream.Append(o);
            o.posCS = UnityObjectToClipPos(input[(i+1)%3].posOS);
            stream.Append(o);
            stream.RestartStrip();
        }
    }
    

轮廓线生成：
------

    hlsl
    [maxvertexcount(6)]
    void geom(triangle v2g input[3], inout TriangleStream<g2f> stream) {
        // 原始三角形
        for(int i=0; i<3; i++) {
            g2f o;
            o.posCS = UnityObjectToClipPos(input[i].posOS);
            stream.Append(o);
        }
        stream.RestartStrip();
    
        // 外扩轮廓
        float extrude = _Extrude;
        for(int i=0; i<3; i++) {
            g2f o;
            float4 offset = float4(input[i].normalOS * extrude, 0);
            o.posCS = UnityObjectToClipPos(input[i].posOS + offset);
            stream.Append(o);
        }
    }
    

注意事项：
=====

*   平台兼容性：需DX11/OpenGL ES3.2以上API支持
*   移动端限制：部分低端设备可能不支持几何着色器
*   性能影响：建议在PC平台使用，移动端需严格测试

* * *

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

（欢迎_点赞留言_探讨，更多人加入进来能更加完善这个探索的过程，🙏）