---
layout: post
title: 'Redisé«˜å¯ç”¨ä¸é«˜å¹¶å‘æ¢é™©ä¹‹æ—…ï¼šä»å•æœºåˆ°é›†ç¾¤çš„å®Œç¾è¿›åŒ–ã€ç¬¬ä¸‰éƒ¨åˆ†ã€‘'
date: "2025-11-07T00:42:09Z"
---
Redisé«˜å¯ç”¨ä¸é«˜å¹¶å‘æ¢é™©ä¹‹æ—…ï¼šä»å•æœºåˆ°é›†ç¾¤çš„å®Œç¾è¿›åŒ–ã€ç¬¬ä¸‰éƒ¨åˆ†ã€‘
==================================

å¯ä»¥ç»“åˆä¹‹å‰çš„æ–‡ç« èåˆèµ·æ¥ä¸€èµ·ç†è§£å­¦ä¹ ï¼š[åˆ†å¸ƒå¼ç¼“å­˜-Redisé›†ç¾¤](https://www.cnblogs.com/sun-10387834/p/15749838.html)

> åœ¨ä¸€ä¸ªåä¸º"æ•°æ®å¤§é™†"çš„ä¸–ç•Œé‡Œï¼ŒRedisç‹å›½æ­£é¢ä¸´ç€å‰æ‰€æœªæœ‰çš„æŒ‘æˆ˜ã€‚éšç€ç”¨æˆ·æµé‡çš„æ¿€å¢ï¼Œå•æœºRedisæœåŠ¡å™¨å·²ç»ä¸å ªé‡è´Ÿã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬è·Ÿéšå¹´è½»çš„æ¶æ„å¸ˆå°æ˜ï¼Œä¸€èµ·è¸ä¸ŠRedisé«˜å¯ç”¨ä¸é«˜å¹¶å‘çš„æ¢é™©ä¹‹æ—…ï¼

ç¬¬ä¸€ç« ï¼šå±æœºåˆç° - å•æœºRedisçš„å›°å¢ƒ
---------------------

å°æ˜æ‰€åœ¨å…¬å¸çš„ç”µå•†å¹³å°è¿æ¥äº†çˆ†å‘å¼å¢é•¿ï¼ŒåŸæœ¬ç¨³å®šçš„Rediså•æœºæœåŠ¡å™¨å¼€å§‹å‡ºç°æ€§èƒ½ç“¶é¢ˆï¼š

*   å†…å­˜ä¸è¶³ï¼Œæ— æ³•ç¼“å­˜æ›´å¤šçƒ­é—¨å•†å“æ•°æ®
*   QPSè¾¾åˆ°ç“¶é¢ˆï¼Œç§’æ€æ´»åŠ¨æ—¶å“åº”ç¼“æ…¢
*   å•ç‚¹æ•…éšœé£é™©ï¼Œä¸€æ—¦å®•æœºæ•´ä¸ªç³»ç»Ÿå°†å´©æºƒ

"å¿…é¡»å‡çº§æˆ‘ä»¬çš„Redisæ¶æ„äº†ï¼"å°æ˜ä¸‹å®šå†³å¿ƒï¼Œå¼€å§‹äº†ä»–çš„æŠ€æœ¯æ¢ç´¢ä¹‹æ—…ã€‚

ç¬¬äºŒç« ï¼šä¸»ä»å¤åˆ¶ - å»ºç«‹Redisçš„"åå¤‡å†›å›¢"
-------------------------

### 2.1 ä¸»ä»å¤åˆ¶åŸç†æ¢ç§˜

å°æ˜é¦–å…ˆæƒ³åˆ°äº†ä¸»ä»å¤åˆ¶æ¶æ„ï¼Œè¿™å°±åƒæ˜¯ç»™Rediså›½ç‹é…å¤‡äº†ä¸€æ”¯å¿ è¯šçš„æŠ¤å«é˜Ÿã€‚

**å…¨é‡åŒæ­¥æµç¨‹ï¼š**

graph TB A\[ä»èŠ‚ç‚¹å¯åŠ¨\] --> B\[å‘é€PSYNCå‘½ä»¤\] B --> C{ä¸»èŠ‚ç‚¹åˆ¤æ–­} C -->|ç¬¬ä¸€æ¬¡åŒæ­¥| D\[æ‰§è¡ŒBGSAVE\] D --> E\[ç”ŸæˆRDBæ–‡ä»¶\] E --> F\[å‘é€RDBæ–‡ä»¶ç»™ä»èŠ‚ç‚¹\] F --> G\[ä»èŠ‚ç‚¹åŠ è½½RDB\] G --> H\[ä¸»èŠ‚ç‚¹å‘é€ç¼“å†²åŒºå‘½ä»¤\] H --> I\[ä»èŠ‚ç‚¹æ‰§è¡Œç¼“å†²å‘½ä»¤\] I --> J\[åŒæ­¥å®Œæˆ\] C -->|éç¬¬ä¸€æ¬¡åŒæ­¥| K\[å‘é€éƒ¨åˆ†åŒæ­¥å‘½ä»¤\] K --> J

**å¢é‡åŒæ­¥æœºåˆ¶ï¼š**

*   ä¸»èŠ‚ç‚¹ç»´æŠ¤å¤åˆ¶ç§¯å‹ç¼“å†²åŒº(repl\_backlog\_buffer)
*   ä»èŠ‚ç‚¹æ–­çº¿é‡è¿åå‘é€PSYNCå‘½ä»¤ï¼Œæºå¸¦å¤åˆ¶åç§»é‡
*   ä¸»èŠ‚ç‚¹åˆ¤æ–­åç§»é‡æ˜¯å¦åœ¨ç¼“å†²åŒºå†…ï¼Œå†³å®šå…¨é‡è¿˜æ˜¯å¢é‡åŒæ­¥

### 2.2 ä¿å§†çº§ä¸»ä»å¤åˆ¶æ­å»ºå®æˆ˜

#### é…ç½®æ€è·¯

**æ¶æ„è§„åˆ’ï¼š**

*   1ä¸ªä¸»èŠ‚ç‚¹ + 2ä¸ªä»èŠ‚ç‚¹
*   ä¸»èŠ‚ç‚¹è´Ÿè´£å†™æ“ä½œï¼Œä»èŠ‚ç‚¹è´Ÿè´£è¯»æ“ä½œ
*   æ•°æ®å®æ—¶åŒæ­¥ï¼Œä»èŠ‚ç‚¹ä½œä¸ºçƒ­å¤‡ä»½

**é…ç½®è¦ç‚¹ï¼š**

*   ä¸»èŠ‚ç‚¹ï¼šæ­£å¸¸Redisé…ç½®ï¼Œæ— éœ€ç‰¹æ®Šå¤åˆ¶é…ç½®
*   ä»èŠ‚ç‚¹ï¼šé…ç½®`replicaof`æŒ‡å‘ä¸»èŠ‚ç‚¹ï¼Œè®¾ç½®`replica-read-only`
*   è®¤è¯ï¼šä¸»ä»èŠ‚ç‚¹é—´é…ç½®`masterauth`å’Œ`requirepass`

#### è¯¦ç»†æ­å»ºæ­¥éª¤

**ç¯å¢ƒå‡†å¤‡ï¼š**

    # ä¸‰å°æœåŠ¡å™¨
    ä¸»èŠ‚ç‚¹ï¼š192.168.1.10:6379
    ä»èŠ‚ç‚¹1ï¼š192.168.1.11:6379
    ä»èŠ‚ç‚¹2ï¼š192.168.1.12:6379
    

**æ­¥éª¤1ï¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…Redis**

    # ä»¥Ubuntuä¸ºä¾‹ï¼Œå®‰è£…Redis 6.2.6
    sudo apt update
    sudo apt install -y redis-server
    
    # æˆ–è€…ç¼–è¯‘å®‰è£…æœ€æ–°ç‰ˆæœ¬
    wget https://download.redis.io/releases/redis-6.2.6.tar.gz
    tar xzf redis-6.2.6.tar.gz
    cd redis-6.2.6
    make
    sudo make install
    
    # åˆ›å»ºå¿…è¦çš„ç›®å½•
    sudo mkdir -p /var/lib/redis
    sudo mkdir -p /var/log/redis
    sudo chown redis:redis /var/lib/redis
    sudo chown redis:redis /var/log/redis
    

**æ­¥éª¤2ï¼šé…ç½®ä¸»èŠ‚ç‚¹(192.168.1.10)**

ç¼–è¾‘ä¸»èŠ‚ç‚¹é…ç½®æ–‡ä»¶ï¼š

    sudo vim /etc/redis/redis.conf
    

**ä¸»èŠ‚ç‚¹æ ¸å¿ƒé…ç½®ï¼š**

    # ==================== åŸºç¡€é…ç½® ====================
    bind 0.0.0.0                    # å…è®¸æ‰€æœ‰IPè¿æ¥
    port 6379                       # ç›‘å¬ç«¯å£
    protected-mode no               # å…³é—­ä¿æŠ¤æ¨¡å¼ï¼Œå…è®¸å¤–éƒ¨è¿æ¥
    daemonize yes                   # åå°è¿è¡Œ
    pidfile /var/run/redis_6379.pid
    logfile "/var/log/redis/redis.log"
    dir /var/lib/redis              # æ•°æ®ç›®å½•
    
    # ==================== æŒä¹…åŒ–é…ç½® ====================
    save 900 1                      # 15åˆ†é’Ÿå†…è‡³å°‘1ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
    save 300 10                     # 5åˆ†é’Ÿå†…è‡³å°‘10ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜  
    save 60 10000                   # 1åˆ†é’Ÿå†…è‡³å°‘10000ä¸ªkeyå˜åŒ–åˆ™ä¿å­˜
    rdbcompression yes              # å‹ç¼©RDBæ–‡ä»¶
    dbfilename dump.rdb
    
    # ==================== å®‰å…¨é…ç½® ====================
    requirepass MasterRedis123!     # ä¸»èŠ‚ç‚¹å¯†ç 
    
    # ==================== å†…å­˜é…ç½® ====================
    maxmemory 2gb                   # æœ€å¤§å†…å­˜é™åˆ¶
    maxmemory-policy allkeys-lru    # å†…å­˜æ·˜æ±°ç­–ç•¥
    
    # ==================== ä¸»ä»å¤åˆ¶é…ç½® ====================
    # ä¸»èŠ‚ç‚¹æ— éœ€ç‰¹æ®Šé…ç½®ï¼Œä½†å»ºè®®è®¾ç½®ä»¥ä¸‹å‚æ•°ä¼˜åŒ–å¤åˆ¶
    repl-backlog-size 1mb           # å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå¤§å°
    repl-backlog-ttl 3600           # å¤åˆ¶ç§¯å‹ç¼“å†²åŒºå­˜æ´»æ—¶é—´
    repl-timeout 60                 # å¤åˆ¶è¶…æ—¶æ—¶é—´
    

**æ­¥éª¤3ï¼šé…ç½®ä»èŠ‚ç‚¹1(192.168.1.11)**

ç¼–è¾‘ä»èŠ‚ç‚¹1é…ç½®æ–‡ä»¶ï¼š

    sudo vim /etc/redis/redis.conf
    

**ä»èŠ‚ç‚¹1æ ¸å¿ƒé…ç½®ï¼š**

    # ==================== åŸºç¡€é…ç½® ====================
    bind 0.0.0.0
    port 6379
    protected-mode no
    daemonize yes
    pidfile /var/run/redis_6379.pid
    logfile "/var/log/redis/redis_slave1.log"  # ä¸åŒä»èŠ‚ç‚¹ä½¿ç”¨ä¸åŒæ—¥å¿—æ–‡ä»¶
    dir /var/lib/redis
    
    # ==================== æŒä¹…åŒ–é…ç½® ====================
    # ä»èŠ‚ç‚¹ä¹Ÿéœ€è¦æŒä¹…åŒ–é…ç½®ï¼Œä¸ä¸»èŠ‚ç‚¹ä¿æŒä¸€è‡´
    save 900 1
    save 300 10
    save 60 10000
    rdbcompression yes
    dbfilename dump.rdb
    
    # ==================== å®‰å…¨é…ç½® ====================
    requirepass SlaveRedis123!      # ä»èŠ‚ç‚¹è‡ªèº«å¯†ç 
    
    # ==================== ä¸»ä»å¤åˆ¶æ ¸å¿ƒé…ç½® ====================
    replicaof 192.168.1.10 6379     # å…³é”®é…ç½®ï¼šæŒ‡å‘ä¸»èŠ‚ç‚¹
    masterauth MasterRedis123!      # ä¸»èŠ‚ç‚¹å¯†ç 
    replica-read-only yes           # ä»èŠ‚ç‚¹åªè¯»ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
    
    # ==================== å¤åˆ¶ä¼˜åŒ–é…ç½® ====================
    repl-diskless-sync no           # ä¸ä½¿ç”¨æ— ç›˜å¤åˆ¶
    repl-diskless-sync-delay 5      # æ— ç›˜å¤åˆ¶å»¶è¿Ÿ
    repl-disable-tcp-nodelay no     # å¯ç”¨TCP_NODELAY
    repl-backlog-size 1mb           # å¤åˆ¶ç§¯å‹ç¼“å†²åŒº
    repl-ping-replica-period 10     # ä»èŠ‚ç‚¹pingä¸»èŠ‚ç‚¹é—´éš”
    repl-timeout 60                 # å¤åˆ¶è¶…æ—¶æ—¶é—´
    
    # ==================== å†…å­˜é…ç½® ====================
    maxmemory 2gb
    maxmemory-policy allkeys-lru
    

**ä»èŠ‚ç‚¹2é…ç½®ä¸ä»èŠ‚ç‚¹1ç±»ä¼¼ï¼Œåªéœ€ä¿®æ”¹æ—¥å¿—æ–‡ä»¶åã€‚**

**æ­¥éª¤4ï¼šå¯åŠ¨æ‰€æœ‰Rediså®ä¾‹**

    # åœ¨ä¸»èŠ‚ç‚¹å¯åŠ¨
    sudo systemctl start redis
    # æˆ–è€…æ‰‹åŠ¨å¯åŠ¨
    sudo redis-server /etc/redis/redis.conf
    
    # åœ¨ä»èŠ‚ç‚¹1å¯åŠ¨
    sudo systemctl start redis
    
    # åœ¨ä»èŠ‚ç‚¹2å¯åŠ¨  
    sudo systemctl start redis
    

**æ­¥éª¤5ï¼šéªŒè¯ä¸»ä»å¤åˆ¶çŠ¶æ€**

    # è¿æ¥åˆ°ä¸»èŠ‚ç‚¹æŸ¥çœ‹å¤åˆ¶ä¿¡æ¯
    redis-cli -h 192.168.1.10 -a MasterRedis123! info replication
    
    # é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š
    # Replication
    # role:master
    # connected_slaves:2
    # slave0:ip=192.168.1.11,port=6379,state=online,offset=xxx,lag=0
    # slave1:ip=192.168.1.12,port=6379,state=online,offset=xxx,lag=0
    # master_replid:xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    # master_repl_offset:xxx
    
    # æµ‹è¯•æ•°æ®åŒæ­¥
    redis-cli -h 192.168.1.10 -a MasterRedis123! set test_key "hello_master"
    redis-cli -h 192.168.1.11 -a SlaveRedis123! get test_key
    # åº”è¯¥è¿”å› "hello_master"
    
    # éªŒè¯ä»èŠ‚ç‚¹åªè¯»ç‰¹æ€§
    redis-cli -h 192.168.1.11 -a SlaveRedis123! set test_key2 "hello_slave"
    # åº”è¯¥è¿”å›é”™è¯¯ï¼š(error) READONLY You can't write against a read only replica.
    

**æ­¥éª¤6ï¼šåˆ›å»ºç³»ç»ŸæœåŠ¡ï¼ˆå¯é€‰ä½†æ¨èï¼‰**

    # å¦‚æœä½¿ç”¨ç¼–è¯‘å®‰è£…ï¼Œéœ€è¦åˆ›å»ºsystemdæœåŠ¡
    sudo vim /etc/systemd/system/redis.service
    

    [Unit]
    Description=Redis persistent key-value database
    After=network.target
    
    [Service]
    ExecStart=/usr/local/bin/redis-server /etc/redis/redis.conf
    ExecReload=/bin/kill -USR2 $MAINPID
    TimeoutStopSec=0
    Restart=always
    User=redis
    Group=redis
    RuntimeDirectory=redis
    RuntimeDirectoryMode=0755
    
    [Install]
    WantedBy=multi-user.target
    

ç¬¬ä¸‰ç« ï¼šSentinelå“¨å…µ - æ™ºæ…§çš„"å®ˆæŠ¤è€…"
-------------------------

### 3.1 Sentinelå·¥ä½œåŸç†æ·±åº¦è§£æ

å°æ˜å‘ç°ä¸»ä»æ¶æ„è¿˜æœ‰ä¸ªè‡´å‘½å¼±ç‚¹ï¼šä¸»èŠ‚ç‚¹å®•æœºæ—¶éœ€è¦æ‰‹åŠ¨åˆ‡æ¢ã€‚äºæ˜¯ä»–å¼•å…¥äº†Sentinelå“¨å…µç³»ç»Ÿã€‚

**Sentinelå››å¤§æ ¸å¿ƒåŠŸèƒ½ï¼š**

1.  **ç›‘æ§**ï¼šå®šæœŸæ£€æŸ¥ä¸»ä»èŠ‚ç‚¹å¥åº·çŠ¶æ€
2.  **é€šçŸ¥**ï¼šé€šè¿‡APIå‘ç®¡ç†å‘˜å‘é€æ•…éšœæŠ¥è­¦
3.  **è‡ªåŠ¨æ•…éšœè½¬ç§»**ï¼šä¸»èŠ‚ç‚¹æ•…éšœæ—¶é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹
4.  **é…ç½®æä¾›è€…**ï¼šä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡å‘ç°åŠŸèƒ½

**Sentinelæ•…éšœè½¬ç§»æµç¨‹ï¼š**

sequenceDiagram participant S1 as Sentinel1 participant S2 as Sentinel2 participant S3 as Sentinel3 participant M as Master participant S as Slave Note over S1,S3: ç›‘æ§é˜¶æ®µ S1->>M: PING (æ¯1ç§’) S2->>M: PING S3->>M: PING Note over S1,S3: ä¸»è§‚ä¸‹çº¿ S1->>S1: æ£€æµ‹Masteræ— å“åº”<br/>æ ‡è®°ä¸º+sdown Note over S1,S3: å®¢è§‚ä¸‹çº¿ S1->>S2: SENTINEL is-master-down-by-addr S1->>S3: SENTINEL is-master-down-by-addr S2->>S1: åŒæ„ä¸‹çº¿ S3->>S1: åŒæ„ä¸‹çº¿ S1->>S1: æ”¶åˆ°è¶³å¤ŸæŠ•ç¥¨<br/>æ ‡è®°ä¸º+odown Note over S1,S3: é€‰ä¸¾é¢†å¯¼è€… S1->>S2: è¯·æ±‚æŠ•ç¥¨ S2->>S1: æŠ•ç¥¨ç»™S1 S3->>S1: æŠ•ç¥¨ç»™S1 Note over S1,S3: æ•…éšœè½¬ç§» S1->>S: å‡çº§ä¸ºæ–°çš„Master S1->>å…¶ä»–Slave: æŒ‡å‘æ–°Master

### 3.2 ä¿å§†çº§Sentinelé›†ç¾¤æ­å»ºå®æˆ˜

#### é…ç½®æ€è·¯

**æ¶æ„è§„åˆ’ï¼š**

*   3ä¸ªSentinelèŠ‚ç‚¹å½¢æˆé›†ç¾¤ï¼ˆæœ€å°‘3ä¸ªé¿å…è„‘è£‚ï¼‰
*   æ¯ä¸ªSentinelç›‘æ§åŒä¸€ä¸ªä¸»èŠ‚ç‚¹
*   æ³•å®šäººæ•°(quorum)è®¾ç½®ä¸º2ï¼Œå³éœ€è¦2ä¸ªSentinelåŒæ„æ‰èƒ½è¿›è¡Œæ•…éšœè½¬ç§»

**é…ç½®è¦ç‚¹ï¼š**

*   æ‰€æœ‰Sentinelé…ç½®ç›¸åŒçš„`monitor`è§„åˆ™
*   è®¾ç½®åˆç†çš„`down-after-milliseconds`å’Œ`failover-timeout`
*   é…ç½®è®¤è¯ä¿¡æ¯ç¡®ä¿å®‰å…¨

#### è¯¦ç»†æ­å»ºæ­¥éª¤

**ç¯å¢ƒå‡†å¤‡ï¼š**

    # ä¸‰å°æœåŠ¡å™¨éƒ¨ç½²Sentinel
    Sentinel1: 192.168.1.20:26379
    Sentinel2: 192.168.1.21:26379  
    Sentinel3: 192.168.1.22:26379
    
    # ç›‘æ§çš„ä¸»ä»æ¶æ„
    ä¸»èŠ‚ç‚¹: 192.168.1.10:6379
    ä»èŠ‚ç‚¹1: 192.168.1.11:6379
    ä»èŠ‚ç‚¹2: 192.168.1.12:6379
    

**æ­¥éª¤1ï¼šåœ¨æ‰€æœ‰SentinelèŠ‚ç‚¹åˆ›å»ºé…ç½®ç›®å½•**

    # åˆ›å»ºSentinelä¸“ç”¨ç›®å½•
    sudo mkdir -p /etc/redis/sentinel
    sudo mkdir -p /var/lib/redis/sentinel
    sudo mkdir -p /var/log/redis/sentinel
    sudo chown -R redis:redis /var/lib/redis/sentinel
    sudo chown redis:redis /var/log/redis/sentinel
    

**æ­¥éª¤2ï¼šé…ç½®SentinelèŠ‚ç‚¹**

**Sentinelæ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼š**

    sudo vim /etc/redis/sentinel/sentinel.conf
    

**Sentinelé…ç½®è¯¦è§£ï¼š**

    # ==================== åŸºç¡€é…ç½® ====================
    port 26379                              # Sentinelç›‘å¬ç«¯å£
    bind 0.0.0.0                           # ç»‘å®šæ‰€æœ‰IP
    protected-mode no                       # å…³é—­ä¿æŠ¤æ¨¡å¼
    daemonize yes                          # åå°è¿è¡Œ
    pidfile "/var/run/redis-sentinel.pid"
    logfile "/var/log/redis/sentinel/sentinel.log"
    dir "/var/lib/redis/sentinel"          # Sentinelå·¥ä½œç›®å½•
    
    # ==================== æ ¸å¿ƒç›‘æ§é…ç½® ====================
    # æ ¼å¼ï¼šsentinel monitor <master-name> <ip> <port> <quorum>
    sentinel monitor mymaster 192.168.1.10 6379 2
    
    # ==================== ä¸»èŠ‚ç‚¹è®¤è¯é…ç½® ====================
    # å¦‚æœä¸»èŠ‚ç‚¹æœ‰å¯†ç ï¼Œå¿…é¡»é…ç½®
    sentinel auth-pass mymaster MasterRedis123!
    
    # ==================== æ•…éšœæ£€æµ‹é…ç½® ====================
    # ä¸»è§‚ä¸‹çº¿æ—¶é—´ï¼š30ç§’æ— å“åº”åˆ™è®¤ä¸ºä¸»è§‚ä¸‹çº¿
    sentinel down-after-milliseconds mymaster 30000
    
    # ==================== æ•…éšœè½¬ç§»é…ç½® ====================
    # æ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´ï¼š3åˆ†é’Ÿ
    sentinel failover-timeout mymaster 180000
    
    # å¹¶è¡ŒåŒæ­¥æ•°é‡ï¼šæ•…éšœè½¬ç§»ååŒæ—¶åŒæ­¥çš„ä»èŠ‚ç‚¹æ•°
    sentinel parallel-syncs mymaster 1
    
    # ==================== å®‰å…¨é…ç½® ====================
    # Sentinelè‡ªèº«å¯†ç ï¼ˆæ‰€æœ‰Sentinelå¿…é¡»ç›¸åŒï¼‰
    requirepass "SentinelAuth123!"
    
    # ==================== é€šçŸ¥è„šæœ¬ï¼ˆå¯é€‰ï¼‰ ====================
    # æ•…éšœè½¬ç§»æ—¶æ‰§è¡Œè„šæœ¬
    # sentinel notification-script mymaster /path/to/script.sh
    
    # ==================== å®¢æˆ·ç«¯é‡é…ç½®è„šæœ¬ï¼ˆå¯é€‰ï¼‰ ====================
    # sentinel client-reconfig-script mymaster /path/to/script.sh
    
    # ==================== è¿è¡Œé…ç½® ====================
    loglevel notice                        # æ—¥å¿—çº§åˆ«
    

**æ­¥éª¤3ï¼šå¯åŠ¨æ‰€æœ‰Sentinelå®ä¾‹**

    # æ–¹å¼1ï¼šä½¿ç”¨redis-sentinelå¯åŠ¨
    redis-sentinel /etc/redis/sentinel/sentinel.conf
    
    # æ–¹å¼2ï¼šä½¿ç”¨redis-serverå¯åŠ¨
    redis-server /etc/redis/sentinel/sentinel.conf --sentinel
    
    # éªŒè¯Sentinelæ˜¯å¦å¯åŠ¨
    ps aux | grep redis-sentinel
    netstat -lnpt | grep 26379
    

**æ­¥éª¤4ï¼šéªŒè¯Sentinelé›†ç¾¤çŠ¶æ€**

    # è¿æ¥åˆ°ä»»æ„SentinelèŠ‚ç‚¹æŸ¥çœ‹çŠ¶æ€
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! info sentinel
    
    # é¢„æœŸè¾“å‡ºï¼š
    # Sentinel
    # sentinel_masters:1
    # sentinel_tilt:0
    # sentinel_running_scripts:0
    # sentinel_scripts_queue_length:0
    # sentinel_simulate_failure_flags:0
    # master0:name=mymaster,status=ok,address=192.168.1.10:6379,slaves=2,sentinels=3
    
    # æŸ¥çœ‹è¯¦ç»†çš„ä¸»èŠ‚ç‚¹ä¿¡æ¯
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! sentinel master mymaster
    
    # æŸ¥çœ‹ä»èŠ‚ç‚¹ä¿¡æ¯
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! sentinel slaves mymaster
    
    # æŸ¥çœ‹å…¶ä»–SentinelèŠ‚ç‚¹ä¿¡æ¯
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! sentinel sentinels mymaster
    

**æ­¥éª¤5ï¼šæµ‹è¯•æ•…éšœè½¬ç§»åŠŸèƒ½**

    # 1. æŸ¥çœ‹å½“å‰ä¸»èŠ‚ç‚¹
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! sentinel get-master-addr-by-name mymaster
    
    # 2. æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœï¼ˆåœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œï¼‰
    redis-cli -h 192.168.1.10 -a MasterRedis123! debug segfault
    
    # 3. è§‚å¯ŸSentinelæ—¥å¿—
    tail -f /var/log/redis/sentinel/sentinel.log
    
    # 4. ç­‰å¾…çº¦30-60ç§’ï¼ŒæŸ¥çœ‹æ–°çš„ä¸»èŠ‚ç‚¹
    redis-cli -h 192.168.1.20 -p 26379 -a SentinelAuth123! sentinel get-master-addr-by-name mymaster
    
    # 5. æ¢å¤åŸä¸»èŠ‚ç‚¹ï¼Œè§‚å¯Ÿå®ƒå¦‚ä½•é‡æ–°åŠ å…¥ä¸ºä»èŠ‚ç‚¹
    redis-server /etc/redis/redis.conf
    

**æ­¥éª¤6ï¼šåˆ›å»ºSentinelç³»ç»ŸæœåŠ¡**

    sudo vim /etc/systemd/system/redis-sentinel.service
    

    [Unit]
    Description=Redis Sentinel
    After=network.target
    
    [Service]
    Type=forking
    User=redis
    Group=redis
    ExecStart=/usr/local/bin/redis-sentinel /etc/redis/sentinel/sentinel.conf
    ExecStop=/usr/local/bin/redis-cli -p 26379 -a SentinelAuth123! shutdown
    Restart=always
    RestartSec=3
    
    [Install]
    WantedBy=multi-user.target
    

    # å¯ç”¨å¹¶å¯åŠ¨æœåŠ¡
    sudo systemctl daemon-reload
    sudo systemctl enable redis-sentinel
    sudo systemctl start redis-sentinel
    sudo systemctl status redis-sentinel
    

ç¬¬å››ç« ï¼šRedis Cluster - ç»ˆæè§£å†³æ–¹æ¡ˆ
--------------------------

### 4.1 æ•°æ®åˆ†ç‰‡ä¸å“ˆå¸Œæ§½åŸç†

éšç€æ•°æ®é‡æŒç»­å¢é•¿ï¼Œå°æ˜å‘ç°å³ä½¿æœ‰ä¸»ä»å’Œå“¨å…µï¼Œå•æœºå†…å­˜é™åˆ¶ä»ç„¶æ˜¯ç“¶é¢ˆã€‚äºæ˜¯ä»–å†³å®šé‡‡ç”¨Redis Clusterâ€”â€”åˆ†å¸ƒå¼ç»ˆææ–¹æ¡ˆã€‚

**å“ˆå¸Œæ§½åˆ†é…æœºåˆ¶ï¼š**

*   Redis Clusterå°†æ•´ä¸ªæ•°æ®é›†åˆ’åˆ†ä¸º16384ä¸ªå“ˆå¸Œæ§½
*   æ¯ä¸ªé”®é€šè¿‡CRC16æ ¡éªŒåå¯¹16384å–æ¨¡å†³å®šæ‰€å±æ§½ä½
*   é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†å“ˆå¸Œæ§½

### 4.2 ä¿å§†çº§Redis Clusteræ­å»ºå®æˆ˜

#### é…ç½®æ€è·¯

**æ¶æ„è§„åˆ’ï¼š**

*   6èŠ‚ç‚¹é›†ç¾¤ï¼š3ä¸»3ä»
*   æ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ä½œä¸ºå¤‡ä»½
*   æ•°æ®è‡ªåŠ¨åˆ†ç‰‡åˆ°ä¸åŒèŠ‚ç‚¹
*   æ”¯æŒèŠ‚ç‚¹æ•…éšœè‡ªåŠ¨è½¬ç§»

**é…ç½®è¦ç‚¹ï¼š**

*   æ‰€æœ‰èŠ‚ç‚¹å¼€å¯é›†ç¾¤æ¨¡å¼`cluster-enabled yes`
*   é…ç½®é›†ç¾¤èŠ‚ç‚¹è¶…æ—¶æ—¶é—´`cluster-node-timeout`
*   è®¾ç½®ç»Ÿä¸€çš„é›†ç¾¤å¯†ç 
*   é…ç½®é›†ç¾¤æ€»çº¿ç«¯å£

#### è¯¦ç»†æ­å»ºæ­¥éª¤

**ç¯å¢ƒå‡†å¤‡ï¼š**

    # 6å°æœåŠ¡å™¨ï¼Œ3ä¸»3ä»
    èŠ‚ç‚¹1: 192.168.1.30:7000 (ä¸»)
    èŠ‚ç‚¹2: 192.168.1.31:7001 (ä¸») 
    èŠ‚ç‚¹3: 192.168.1.32:7002 (ä¸»)
    èŠ‚ç‚¹4: 192.168.1.33:7003 (ä»ï¼Œå¤åˆ¶èŠ‚ç‚¹1)
    èŠ‚ç‚¹5: 192.168.1.34:7004 (ä»ï¼Œå¤åˆ¶èŠ‚ç‚¹2)
    èŠ‚ç‚¹6: 192.168.1.35:7005 (ä»ï¼Œå¤åˆ¶èŠ‚ç‚¹3)
    

**æ­¥éª¤1ï¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºé›†ç¾¤é…ç½®ç›®å½•**

    # ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹ç›®å½•
    sudo mkdir -p /etc/redis/cluster
    sudo mkdir -p /var/lib/redis/700{0..5}
    sudo mkdir -p /var/log/redis/cluster
    sudo chown -R redis:redis /var/lib/redis/700*
    sudo chown redis:redis /var/log/redis/cluster
    

**æ­¥éª¤2ï¼šé…ç½®é›†ç¾¤èŠ‚ç‚¹**

**èŠ‚ç‚¹1æ ¸å¿ƒé…ç½®(192.168.1.30:7000)ï¼š**

    sudo vim /etc/redis/cluster/redis-7000.conf
    

    # ==================== åŸºç¡€é…ç½® ====================
    port 7000                               # èŠ‚ç‚¹ç«¯å£
    bind 0.0.0.0                           # ç»‘å®šæ‰€æœ‰IP
    protected-mode no                       # å…³é—­ä¿æŠ¤æ¨¡å¼
    daemonize yes                          # åå°è¿è¡Œ
    pidfile "/var/run/redis-7000.pid"
    logfile "/var/log/redis/cluster/redis-7000.log"
    dir "/var/lib/redis/7000"              # æ•°æ®ç›®å½•
    
    # ==================== é›†ç¾¤æ ¸å¿ƒé…ç½® ====================
    cluster-enabled yes                     # å¼€å¯é›†ç¾¤æ¨¡å¼
    cluster-config-file nodes-7000.conf     # é›†ç¾¤èŠ‚ç‚¹é…ç½®æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
    cluster-node-timeout 15000              # èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    cluster-replica-validity-factor 10      # ä»èŠ‚ç‚¹æœ‰æ•ˆæ€§å› å­
    cluster-migration-barrier 1             # ä¸»èŠ‚ç‚¹è¿ç§»å±éšœ
    cluster-require-full-coverage yes       # è¦æ±‚æ‰€æœ‰æ§½ä½è¢«è¦†ç›–
    
    # ==================== å®‰å…¨é…ç½® ====================
    requirepass ClusterRedis123!            # èŠ‚ç‚¹è®¿é—®å¯†ç 
    masterauth ClusterRedis123!             # ä¸»èŠ‚ç‚¹é—´è®¤è¯å¯†ç 
    
    # ==================== æŒä¹…åŒ–é…ç½® ====================
    appendonly yes                          # å¼€å¯AOFæŒä¹…åŒ–
    appendfilename "appendonly-7000.aof"    # AOFæ–‡ä»¶å
    appendfsync everysec                    # æ¯ç§’åŒæ­¥
    auto-aof-rewrite-percentage 100         # AOFé‡å†™è§¦å‘æ¡ä»¶
    auto-aof-rewrite-min-size 64mb
    
    # ==================== å†…å­˜é…ç½® ====================
    maxmemory 2gb
    maxmemory-policy allkeys-lru
    
    # ==================== é›†ç¾¤ç½‘ç»œé…ç½® ====================
    cluster-announce-port 7000              # é›†ç¾¤é€šä¿¡ç«¯å£
    cluster-announce-bus-port 17000         # é›†ç¾¤æ€»çº¿ç«¯å£
    
    # ==================== æ€§èƒ½é…ç½® ====================
    tcp-keepalive 60
    timeout 0
    tcp-backlog 511
    

**ä¸ºå…¶ä»–èŠ‚ç‚¹åˆ›å»ºç±»ä¼¼é…ç½®ï¼š**

    # èŠ‚ç‚¹2 (192.168.1.31:7001)
    sudo cp /etc/redis/cluster/redis-7000.conf /etc/redis/cluster/redis-7001.conf
    sudo sed -i 's/7000/7001/g' /etc/redis/cluster/redis-7001.conf
    sudo sed -i 's/17000/17001/g' /etc/redis/cluster/redis-7001.conf
    
    # èŠ‚ç‚¹3 (192.168.1.32:7002)
    sudo cp /etc/redis/cluster/redis-7000.conf /etc/redis/cluster/redis-7002.conf
    sudo sed -i 's/7000/7002/g' /etc/redis/cluster/redis-7002.conf
    sudo sed -i 's/17000/17002/g' /etc/redis/cluster/redis-7002.conf
    
    # èŠ‚ç‚¹4-6ç±»ä¼¼ä¿®æ”¹
    

**æ­¥éª¤3ï¼šå¯åŠ¨æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹**

    # åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨å¯¹åº”çš„Rediså®ä¾‹
    
    # èŠ‚ç‚¹1
    redis-server /etc/redis/cluster/redis-7000.conf
    
    # èŠ‚ç‚¹2
    redis-server /etc/redis/cluster/redis-7001.conf
    
    # èŠ‚ç‚¹3
    redis-server /etc/redis/cluster/redis-7002.conf
    
    # èŠ‚ç‚¹4
    redis-server /etc/redis/cluster/redis-7003.conf
    
    # èŠ‚ç‚¹5
    redis-server /etc/redis/cluster/redis-7004.conf
    
    # èŠ‚ç‚¹6
    redis-server /etc/redis/cluster/redis-7005.conf
    
    # éªŒè¯èŠ‚ç‚¹æ˜¯å¦å¯åŠ¨
    ps aux | grep redis-server
    netstat -lnpt | grep 700
    

**æ­¥éª¤4ï¼šåˆ›å»ºRedisé›†ç¾¤**

    # åœ¨ä»»æ„èŠ‚ç‚¹æ‰§è¡Œé›†ç¾¤åˆ›å»ºå‘½ä»¤
    redis-cli --cluster create \
      192.168.1.30:7000 \
      192.168.1.31:7001 \
      192.168.1.32:7002 \
      192.168.1.33:7003 \
      192.168.1.34:7004 \
      192.168.1.35:7005 \
      --cluster-replicas 1 \
      -a ClusterRedis123!
    

**è¯¦ç»†äº¤äº’è¿‡ç¨‹ï¼š**

    # æ‰§è¡Œåˆ›å»ºå‘½ä»¤åï¼Œä¼šæ˜¾ç¤ºæ§½ä½åˆ†é…æ–¹æ¡ˆ
    >>> Performing hash slots allocation on 6 nodes...
    Master[0] -> Slots 0 - 5460
    Master[1] -> Slots 5461 - 10922  
    Master[2] -> Slots 10923 - 16383
    Adding replica 192.168.1.33:7003 to 192.168.1.30:7000
    Adding replica 192.168.1.34:7004 to 192.168.1.31:7001
    Adding replica 192.168.1.35:7005 to 192.168.1.32:7002
    
    # è¯¢é—®æ˜¯å¦æ¥å—è¿™ä¸ªåˆ†é…æ–¹æ¡ˆ
    Can I set the above configuration? (type 'yes' to accept): yes
    
    # å¼€å§‹é…ç½®èŠ‚ç‚¹ï¼Œç­‰å¾…é›†ç¾¤ç»„å»ºå®Œæˆ
    >>> Nodes configuration updated
    >>> Assign a different config epoch to each node
    >>> Sending CLUSTER MEET messages to join the cluster
    Waiting for the cluster to join
    ....
    >>> Performing Cluster Check (using node 192.168.1.30:7000)
    M: 3a3b... 192.168.1.30:7000
       slots:[0-5460] (5461 slots) master
       1 additional replica(s)
    S: 8c7d... 192.168.1.33:7003
       slots: (0 slots) slave
       replicates 3a3b...
    [OK] All nodes agree about slots configuration.
    >>> Check for open slots...
    >>> Check slots coverage...
    [OK] All 16384 slots covered.
    

**æ­¥éª¤5ï¼šéªŒè¯é›†ç¾¤çŠ¶æ€**

    # æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! cluster nodes
    
    # é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š
    # 3a3b... 192.168.1.30:7000@17000 myself,master - 0 0 1 connected 0-5460
    # 8c7d... 192.168.1.31:7001@17001 master - 0 1620000000000 2 connected 5461-10922
    # e9f0... 192.168.1.32:7002@17002 master - 0 1620000000000 3 connected 10923-16383
    # a1b2... 192.168.1.33:7003@17003 slave 3a3b... 0 1620000000000 1 connected
    # c3d4... 192.168.1.34:7004@17004 slave 8c7d... 0 1620000000000 2 connected  
    # e5f6... 192.168.1.35:7005@17005 slave e9f0... 0 1620000000000 3 connected
    
    # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! cluster info
    
    # æµ‹è¯•æ•°æ®åˆ†å¸ƒå’Œé‡å®šå‘
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! set user:1001 "user_data_1"
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! set user:2001 "user_data_2" 
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! set user:3001 "user_data_3"
    
    # è§‚å¯Ÿé‡å®šå‘è¿‡ç¨‹ï¼Œæ•°æ®ä¼šè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„èŠ‚ç‚¹
    

**æ­¥éª¤6ï¼šåˆ›å»ºé›†ç¾¤ç³»ç»ŸæœåŠ¡**

    # åˆ›å»ºé›†ç¾¤æœåŠ¡æ¨¡æ¿
    sudo vim /etc/systemd/system/redis-cluster@.service
    

    [Unit]
    Description=Redis Cluster Node on port %i
    After=network.target
    
    [Service]
    Type=forking
    User=redis
    Group=redis
    ExecStart=/usr/local/bin/redis-server /etc/redis/cluster/redis-%i.conf
    ExecStop=/usr/local/bin/redis-cli -p %i -a ClusterRedis123! shutdown
    Restart=always
    RestartSec=3
    
    [Install]
    WantedBy=multi-user.target
    

    # å¯ç”¨æ‰€æœ‰èŠ‚ç‚¹æœåŠ¡
    sudo systemctl daemon-reload
    sudo systemctl enable redis-cluster@7000
    sudo systemctl enable redis-cluster@7001
    sudo systemctl enable redis-cluster@7002
    sudo systemctl enable redis-cluster@7003
    sudo systemctl enable redis-cluster@7004
    sudo systemctl enable redis-cluster@7005
    
    # å¯åŠ¨æ‰€æœ‰æœåŠ¡
    sudo systemctl start redis-cluster@7000
    sudo systemctl start redis-cluster@7001
    sudo systemctl start redis-cluster@7002
    sudo systemctl start redis-cluster@7003
    sudo systemctl start redis-cluster@7004
    sudo systemctl start redis-cluster@7005
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    sudo systemctl status redis-cluster@7000
    

### 4.3 é›†ç¾¤ç®¡ç†æ“ä½œ

**æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€ï¼š**

    # æ£€æŸ¥é›†ç¾¤çŠ¶æ€
    redis-cli --cluster check 192.168.1.30:7000 -a ClusterRedis123!
    
    # æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! cluster info
    
    # æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯
    redis-cli -c -h 192.168.1.30 -p 7000 -a ClusterRedis123! cluster nodes
    

**æ·»åŠ æ–°èŠ‚ç‚¹ï¼š**

    # å‡†å¤‡æ–°èŠ‚ç‚¹é…ç½®æ–‡ä»¶ï¼ˆç«¯å£7006ï¼‰
    # æŒ‰ç…§æ­¥éª¤2åˆ›å»ºé…ç½®å¹¶å¯åŠ¨
    
    # æ·»åŠ æ–°ä¸»èŠ‚ç‚¹åˆ°é›†ç¾¤
    redis-cli --cluster add-node 192.168.1.36:7006 192.168.1.30:7000 -a ClusterRedis123!
    
    # é‡æ–°åˆ†ç‰‡ï¼ˆå°†éƒ¨åˆ†æ§½ä½è¿ç§»åˆ°æ–°èŠ‚ç‚¹ï¼‰
    redis-cli --cluster reshard 192.168.1.30:7000 -a ClusterRedis123!
    
    # äº¤äº’è¿‡ç¨‹ï¼š
    # How many slots do you want to move (from 1 to 16384)? 1000
    # What is the receiving node ID? [è¾“å…¥æ–°èŠ‚ç‚¹çš„ID]
    # Source node #1: all
    # è¾“å…¥yeså¼€å§‹è¿ç§»
    

**æ•…éšœè½¬ç§»æµ‹è¯•ï¼š**

    # æ¨¡æ‹Ÿä¸»èŠ‚ç‚¹æ•…éšœ
    redis-cli -h 192.168.1.30 -p 7000 -a ClusterRedis123! debug segfault
    
    # è§‚å¯Ÿä»èŠ‚ç‚¹è‡ªåŠ¨å‡çº§ä¸ºä¸»èŠ‚ç‚¹
    redis-cli -c -h 192.168.1.31 -p 7001 -a ClusterRedis123! cluster nodes
    
    # æ¢å¤èŠ‚ç‚¹ï¼Œè§‚å¯Ÿå®ƒå¦‚ä½•é‡æ–°åŠ å…¥é›†ç¾¤
    redis-server /etc/redis/cluster/redis-7000.conf
    

ç¬¬äº”ç« ï¼šæ¶æ„å¯¹æ¯”ä¸é€‰å‹æŒ‡å—
-------------

ç»è¿‡è¯¦ç»†å®è·µï¼Œå°æ˜æ€»ç»“äº†å„ç§æ–¹æ¡ˆçš„é€‚ç”¨åœºæ™¯ï¼š

æ¶æ„æ–¹æ¡ˆ

é€‚ç”¨åœºæ™¯

ä¼˜ç‚¹

ç¼ºç‚¹

é…ç½®å¤æ‚åº¦

**ä¸»ä»å¤åˆ¶**

è¯»å¤šå†™å°‘ã€æ•°æ®å¤‡ä»½

ç®€å•æ˜“ç”¨ã€è¯»å†™åˆ†ç¦»ã€æ•°æ®çƒ­å¤‡

æ— æ³•è‡ªåŠ¨æ•…éšœè½¬ç§»ã€å†™æ“ä½œå•ç‚¹

â˜…â˜†â˜†â˜†â˜†

**Sentinel**

é«˜å¯ç”¨éœ€æ±‚ã€è‡ªåŠ¨æ•…éšœè½¬ç§»

è‡ªåŠ¨æ•…éšœè½¬ç§»ã€é…ç½®ç›¸å¯¹ç®€å•ã€å®¢æˆ·ç«¯é€æ˜

å­˜å‚¨å—å•æœºé™åˆ¶ã€å†™æ“ä½œå•ç‚¹

â˜…â˜…â˜†â˜†â˜†

**Cluster**

å¤§æ•°æ®é‡ã€é«˜å¹¶å‘ã€çº¿æ€§æ‰©å±•

æ•°æ®åˆ†ç‰‡ã€çœŸæ­£çš„åˆ†å¸ƒå¼ã€é«˜å¯ç”¨

é…ç½®å¤æ‚ã€å®¢æˆ·ç«¯éœ€è¦æ”¯æŒã€è¿ç»´å¤æ‚

â˜…â˜…â˜…â˜…â˜…

**é€‰å‹å»ºè®®ï¼š**

*   **å¼€å‘æµ‹è¯•ç¯å¢ƒ**ï¼šä¸»ä»å¤åˆ¶
*   **æ•°æ®é‡<2GBï¼Œé«˜å¯ç”¨éœ€æ±‚**ï¼šSentinelå“¨å…µ
*   **æ•°æ®é‡>2GBï¼Œé«˜å¹¶å‘éœ€æ±‚**ï¼šRedis Cluster
*   **è¯»å†™åˆ†ç¦»åœºæ™¯**ï¼šä¸»ä»å¤åˆ¶ + è¯»å†™åˆ†ç¦»ä¸­é—´ä»¶

ç¬¬å…­ç« ï¼šç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µ
------------

### 6.1 é…ç½®ä¼˜åŒ–è¦ç‚¹

**ä¸»ä»å¤åˆ¶ä¼˜åŒ–ï¼š**

    # åœ¨ä¸»èŠ‚ç‚¹é…ç½®ä¸­å¢åŠ 
    repl-backlog-size 512mb        # å¢å¤§å¤åˆ¶ç§¯å‹ç¼“å†²åŒº
    repl-backlog-ttl 3600          # ç¼“å†²åŒºå­˜æ´»æ—¶é—´
    min-replicas-to-write 1        # è‡³å°‘1ä¸ªä»èŠ‚ç‚¹æ‰å…è®¸å†™
    min-replicas-max-lag 10        # ä»èŠ‚ç‚¹å»¶è¿Ÿä¸è¶…è¿‡10ç§’
    

**Sentinelä¼˜åŒ–ï¼š**

    # åœ¨Sentinelé…ç½®ä¸­å¢åŠ 
    sentinel parallel-syncs mymaster 1    # æ§åˆ¶å¹¶è¡ŒåŒæ­¥æ•°é‡
    sentinel failover-timeout mymaster 60000  # è°ƒæ•´æ•…éšœè½¬ç§»è¶…æ—¶
    sentinel down-after-milliseconds mymaster 5000  # æ›´æ•æ„Ÿçš„ä¸‹çº¿æ£€æµ‹
    

**Clusterä¼˜åŒ–ï¼š**

    # åœ¨é›†ç¾¤èŠ‚ç‚¹é…ç½®ä¸­å¢åŠ 
    cluster-node-timeout 15000             # èŠ‚ç‚¹è¶…æ—¶æ—¶é—´
    cluster-slave-validity-factor 10       # ä»èŠ‚ç‚¹æœ‰æ•ˆæ€§
    cluster-migration-barrier 1            # è¿ç§»å±éšœ
    cluster-require-full-coverage no       # å…è®¸éƒ¨åˆ†æ§½ä½ä¸å¯ç”¨
    

### 6.2 ç›‘æ§ä¸å‘Šè­¦

**å…³é”®ç›‘æ§æŒ‡æ ‡ï¼š**

*   å†…å­˜ä½¿ç”¨ç‡ï¼ˆ<80%ï¼‰
*   è¿æ¥æ•°ï¼ˆ<10000ï¼‰
*   å‘½ä¸­ç‡ï¼ˆ>95%ï¼‰
*   ç½‘ç»œæµé‡
*   é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€
*   æ…¢æŸ¥è¯¢æ•°é‡
*   é”®ç©ºé—´ä½¿ç”¨æƒ…å†µ

**åŸºç¡€ç›‘æ§å‘½ä»¤ï¼š**

    # å†…å­˜ä¿¡æ¯
    redis-cli info memory
    
    # è¿æ¥ä¿¡æ¯  
    redis-cli info clients
    
    # æŒä¹…åŒ–ä¿¡æ¯
    redis-cli info persistence
    
    # å¤åˆ¶ä¿¡æ¯
    redis-cli info replication
    
    # é›†ç¾¤ä¿¡æ¯
    redis-cli cluster info
    

ç»“è¯­ï¼šä»å•æœºåˆ°é›†ç¾¤çš„å®Œç¾èœ•å˜
--------------

ç»è¿‡è¿™æ¬¡è¯¦ç»†çš„æŠ€æœ¯å‡çº§å®è·µï¼Œå°æ˜çš„ç”µå•†å¹³å°Redisæ¶æ„å®Œæˆäº†å®Œç¾èœ•å˜ï¼š

*   **æ€§èƒ½**ï¼šä»å•æœºä¸‡çº§QPSæå‡åˆ°é›†ç¾¤ç™¾ä¸‡çº§QPS
*   **å¯ç”¨æ€§**ï¼šä»å•ç‚¹æ•…éšœå‡çº§åˆ°99.99%é«˜å¯ç”¨
*   **æ‰©å±•æ€§**ï¼šæ”¯æŒåœ¨çº¿æ°´å¹³æ‰©å±•ï¼Œåº”å¯¹æœªæ¥ä¸šåŠ¡å¢é•¿
*   **æ•°æ®å®‰å…¨**ï¼šå¤šé‡å¤‡ä»½å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»ä¿éšœæ•°æ®å®‰å…¨

"æŠ€æœ¯çš„é“è·¯æ°¸æ— æ­¢å¢ƒï¼Œ"å°æ˜æ„Ÿæ…¨é“ï¼Œ"ä½†åªè¦æˆ‘ä»¬æŒ‰ç…§æ¸…æ™°çš„é…ç½®æ€è·¯ï¼Œä¸€æ­¥æ­¥å®è·µï¼Œå°±èƒ½åœ¨å¤æ‚çš„ç³»ç»Ÿæ¶æ„ä¸­æ¸¸åˆƒæœ‰ä½™ã€‚"

* * *

**ç»™åˆå­¦è€…çš„å®è·µå»ºè®®ï¼š**

1.  **å¾ªåºæ¸è¿›**ï¼šæŒ‰ç…§ä¸»ä»â†’å“¨å…µâ†’é›†ç¾¤çš„é¡ºåºå®è·µ
2.  **ç†è§£åŸç†**ï¼šå…ˆç†è§£æ¯ä¸ªæ¶æ„çš„å·¥ä½œåŸç†ï¼Œå†åŠ¨æ‰‹é…ç½®
3.  **å¤šåŠ¨æ‰‹å®è·µ**ï¼šåœ¨æµ‹è¯•ç¯å¢ƒåå¤æ­å»ºï¼Œç†Ÿæ‚‰æ¯ä¸ªé…ç½®å‚æ•°
4.  **å…³æ³¨ç›‘æ§**ï¼šæ­å»ºå®ŒæˆååŠ¡å¿…é…ç½®ç›‘æ§å’Œå‘Šè­¦
5.  **å¤‡ä»½é…ç½®**ï¼šä¿å­˜å¥½æˆåŠŸçš„é…ç½®æ–‡ä»¶ä½œä¸ºæ¨¡æ¿

è®°ä½ï¼Œæ¯ä¸ªæˆåŠŸçš„æ¶æ„å¸ˆéƒ½æ˜¯ä»ç¬¬ä¸€ä¸ªé…ç½®æ–‡ä»¶å¼€å§‹çš„ã€‚ç¥ä½ åœ¨è¿™æ¡æŠ€æœ¯æ¢ç´¢ä¹‹è·¯ä¸Šæ”¶è·æ»¡æ»¡ï¼

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19197553](https://www.cnblogs.com/sun-10387834/p/19197553)