---
layout: post
title: 'æ–°æ¥çš„å¤–åŒ…ï¼Œåœ¨å¤§ç¾¤åˆ†äº«äº†å®ƒçš„é™æµç®—æ³•çš„å®ç°'
date: "2025-11-20T00:41:32Z"
---
æ–°æ¥çš„å¤–åŒ…ï¼Œåœ¨å¤§ç¾¤åˆ†äº«äº†å®ƒçš„é™æµç®—æ³•çš„å®ç°
=====================

![](https://files.mdnice.com/user/4236/8c5baa5e-df4f-43fa-8d3c-d5311801de13.png)

1\. ä»¤ç‰Œæ¡¶æŒ‰ç”¨æˆ·ç»´åº¦é™æµ
==============

å‰æ–‡`golang/x/time/rate`æ¼”ç¤ºäº†åŸºäº`æ•´ä½“`è¯·æ±‚é€Ÿç‡çš„ä»¤ç‰Œæ¡¶é™æµï¼›  
é‚£åŸºäº`ç”¨æˆ·idã€ipã€apikey`è¯·æ±‚é€Ÿç‡çš„é™æµ(æ›´è´´è¿‘ç”Ÿäº§çš„éœ€æ±‚)ï¼Œ é˜ä¸‹åˆè¯¥å¦‚ä½•åº”å¯¹ï¼Ÿ

é‚£è¿™ä¸ªé—®é¢˜å°±ä»`å…¨å±€é€Ÿç‡`å˜æˆäº†æŒ‰ç…§`ç”¨æˆ·ç»´åº¦ï¼ˆgroup by useridï¼‰`æ¥åšé™æµï¼Œé‚£ä¹ˆ

*   æ—©å…ˆçš„å…¨å±€çš„rateLimiterå°±è¦å˜æˆ userid:rateLimiterçš„é”®å€¼å¯¹ï¼Œ select count( \* ) from table ---> select userid, count(\*) from table group by userid
    
*   ä½¿ç”¨ç¼“å­˜ç»„ä»¶æ¥å­˜å‚¨ç»´åº¦é”®å€¼å¯¹: ç¼“å­˜çš„å‰”é™¤æœºåˆ¶æ¥æ¸…ç†ä¸å†è®¿é—®çš„é”®å€¼å¯¹ ï¼ˆ30minè¿‡æœŸï¼Œ10minå‘¨æœŸæ¸…ç†å†…å­˜ï¼‰ã€‚
    

    var userLimiters = cache.New(time.Minute*30, 10) // 10 items per minute
    func limiterForUser(userID string) *rate.Limiter {
    	if v, found := userLimiters.Get(userID); found {
    		return v.(*rate.Limiter)
    	}
    
    	l := rate.NewLimiter(rate.Every(time.Minute/60), 10)
    	userLimiters.Set(userID, l, cache.DefaultExpiration)
    	return l
    }
    
    // æ›´ç»†åŒ–çš„é™æµï¼š é’ˆå¯¹åŒä¸€ç”¨æˆ·çš„è¯·æ±‚æ¬¡æ•°é™é€Ÿï¼Œ å¢åŠ äº†ç»†ç²’åº¦çš„ç”¨æˆ·ç»´åº¦ï¼Œéœ€è¦ç»´æŠ¤ ç”¨æˆ·ä¸å¯¹åº”é™é€Ÿå™¨çš„æ˜ å°„å…³ç³»
    func userRatelimitMiddleware(c *gin.Context) {
    	userID := c.GetString("userID")  //  ä»æ¯ä¸ªè¯·æ±‚contextçš„keyä¸­å–å¾—ä¿¡æ¯ï¼Œ è¿™ä¸ªkeyå¯¹äºreq contextæ˜¯æ’ä»–æ€§çš„
    	if userID == "" {
    		c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{"error": "Unauthorized"})
    		return
    	}
    	if userID == "" {
    		userID = c.GetString("x-api-key")
    	}
    
    	if userID == "" {
    		userID = c.ClientIP()
    	}
    	limiter := limiterForUser(userID) // é€šè¿‡useridç»´åº¦æ‰¾åˆ°å¯¹åº”çš„é™é€Ÿå™¨
    	if !limiter.Allow() {
    		c.AbortWithStatusJSON(http.StatusTooManyRequests, gin.H{"error": "Too many requests"})
    		return
    	}
    	c.Next()
    }
    

2\. redis ä½œä¸ºé™æµå™¨ç¬¬ä¸‰æ–¹å­˜å‚¨
====================

è¿™ä¸ªæ€è·¯ä¹Ÿæ˜¯æå…¶å¸¸è§çš„è¡Œä¸ºï¼š rediså¯ä»¥æˆä¸ºç”¨æˆ·ä»¤ç‰Œæ¡¶çš„å…¨å±€ä¸­å¿ƒå­˜å‚¨ï¼š å½“å¤šä¸ªè´Ÿè½½å±‚éœ€è¦è¯»å†™ç”¨æˆ·é™æµå™¨æ—¶ï¼Œä¸redisäº¤äº’ã€‚

æœ¬æ¬¡é€šè¿‡golangçš„å®æˆ˜ï¼Œæ·±å…¥ç†è§£åŸºäºredisçš„ä»¤ç‰Œæ¡¶é™æµå™¨çš„ç®—æ³•å®ç°ã€‚

â‘  è¯·æ±‚åˆ°è¾¾è´Ÿè½½å±‚ï¼Œè¢«è´Ÿè½½å±‚è¯†åˆ«ä¸ºuserid=junio

â‘¡ è´Ÿè½½å±‚è¯·æ±‚redisè·å–è¯¥ç”¨æˆ·çš„token bucketçš„å½“å‰çŠ¶æ€:  
`hget userbucket:junio tokens last_time`

â‘¢ åŸºäºå½“å‰æ—¶é—´`now`å’Œ`last_time`ï¼Œè®¡ç®—æµé€çš„æ—¶é—´ï¼Œå†æ ¹æ®rateè®¡ç®—è¿™ä¸€é˜¶æ®µä¸‹å‘äº†å¤šå°‘tokens:`delta=(now-last_time) * r/1000`ï¼ŒåŠ ä¸ŠredisåŸå§‹è®°å½•çš„`token`,å°±æ˜¯æœ¬æ¬¡è¯·æ±‚æ—¶bucketä¸­èƒ½ç”¨çš„tokensï¼Œ æ³¨æ„ï¼šä»¤ç‰Œæ•°é‡æœ€å¤šä¸èƒ½è¶…è¿‡cap

â‘£ å¦‚æœtokens>=1, è¡¨ç¤ºæ¡¶ä¸­æœ‰ä»¤ç‰Œï¼Œå¯æ”¾è¡Œè¯·æ±‚ï¼Œtokensæ•°é‡å‡1

â‘¤ æœ€åå°†æœ¬æ¬¡å¤„ç†å®Œåçš„ tokenså’Œ`last_time=now`å†™å…¥åŸç”¨æˆ·ä»¤ç‰Œæ¡¶  
`hset userbucket:junio tokens 20 last_time 990`

![image](https://img2024.cnblogs.com/blog/587720/202511/587720-20251119220725458-1636506642.png)

ä½¿ç”¨redis ä¸­çš„hashmapå­˜å‚¨ç”¨æˆ·çš„tokenbucketçŠ¶æ€ï¼Œåº”ç”¨å­˜åœ¨`è¯»å–redis- è®¡ç®—- å›å†™redis`è¿‡ç¨‹ï¼Œä½¿ç”¨redis luaçš„è„šæœ¬æ‰§è¡Œä¸‰ä¸ªåŠ¨ä½œï¼Œä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚

> ä¸ºä»€ä¹ˆluaè„šæœ¬èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨å‘¢ï¼Ÿ  
> ä¸»è¦å¾—ç›Šäº Redis çš„å•çº¿ç¨‹æ¶æ„å’ŒåŸå­æ€§æ‰§è¡Œæœºåˆ¶ï¼š åŠ è½½å¹¶æ‰§è¡Œluaè„šæœ¬æ—¶æ‰€æœ‰çš„redisæ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“å®Œæˆï¼› æ•´ä¸ªè„šæœ¬æ‰§è¡ŒæœŸé—´æ²¡æœ‰å…¶ä»–å‘½ä»¤å¯ä»¥æ’å…¥ã€‚

    // è¯»å–- è®¡ç®— - é‡æ–°èµ‹å€¼éƒ½åœ¨ä¸€ä¸ª lua è„šæœ¬é‡Œé¢
    var redisScript = `
    	local key = KEYS[1]
    	local capacity = tonumber(ARGV[1])
    	local rate = tonumber(ARGV[2])
    	local now = tonumber(ARGV[3])
    	local tokens =  tonumber(redis.call('hget', key, 'tokens') or '-1')
    	local last_time = tonumber(redis.call('hget', key, 'last_time') or  '-1')
    
    	if tokens  == -1 or last_time == -1 then
    		tokens = capacity
    		last_time = now
    	else
    		local elapsed = now - last_time
            if elapsed < 0 
    			then elapsed = 0
    		end
    		local delta  = elapsed * rate / 1000
    		tokens = tokens + delta
    		if tokens > capacity then
    			tokens = capacity
    		end
            last_time = now
    	end
    	local allow = 0
    	if tokens >= 1 then
    		allow = 1
    		tokens= tokens - 1
    	else	
    		allow = 0
    	end
    
    	redis.call('hset', key, 'tokens', tokens)
    	redis.call('hset', key, 'last_time', last_time)
        redis.call('PEXPIRE', key,  math.max(1000, 2 * math.ceil((capacity / rate) * 5000)))
    	return allow
    `
    

æ³¨æ„

*   ä¸Šé¢è¿˜ä½¿ç”¨çš„redis expireæœºåˆ¶ï¼š redis expireä¸æ˜¯æ»‘åŠ¨è¿‡æœŸï¼Œä½†æ˜¯æ¯æ¬¡è¢«è¯·æ±‚è§¦å‘æ‰§è¡Œçš„æ—¶å€™å°±é‡æ–°è®¾ç½®TTLï¼Œ è¡¨ç°ä¸ºâ€œæ»‘åŠ¨è¿‡æœŸâ€ã€‚
*   é™¤äº†hset/hget ,è¿˜æœ‰hmgetå¯ç”¨ï¼Œå¦å¤–è¿™äº›æ“ä½œè¿˜æœ‰é…å¥—çš„TTLæŒ‡ä»¤ï¼Œegï¼š`hset key EXAT 1740470400 FIELDS 2 field1 "Hello" field2 "World"`ã€‚

golangåº”ç”¨å±‚çš„å†™æ³•å¦‚ä¸‹ï¼š

    func (r *RedisLimiter) Allow(c *gin.Context, userid string) bool {
    	key := r.keyprefix + userid // å®šä½è¿™ä¸ªç”¨æˆ·çš„token bucket
    	now := time.Now().UnixMilli()
    	// Check if the key exists in Redis
    	rCmd := r.redis.Eval(redisScript, []string{key}, r.cap, r.rate, now)
    	res, err := rCmd.Result()
    	if err != nil {
    		log.Printf("get from redis failure. ", err)
    		return false
    	}
    	if allow, ok := res.(int64); ok { // æ³¨æ„ï¼šluaè¿”å›çš„0,1 å€¼å¯¹åº”golangçš„int64
    		log.Printf("%v %v \n", allow, res)
    		return allow == 1
    	} else {
    		log.Printf("get from redis failure. ", err)
    		return false
    	}
    }
    

* * *

è‡³æ­¤é™æµç¬¬äºŒå¼¹ç»“æŸäº†ï¼Œæœ¬æ–‡ç´§æ¥æ˜é‡‘çˆ†æ–‡[ğŸ¨ æ–°æ¥çš„å¤–åŒ…ï¼Œé™æµç®—æ³•ç”¨çš„è¿™ä¹ˆ6](https://juejin.cn/post/7568124427822825512 "ğŸ¨ æ–°æ¥çš„å¤–åŒ…ï¼Œé™æµç®—æ³•ç”¨çš„è¿™ä¹ˆ6")ï¼Œè¿›ä¸€æ­¥è®²è¿°äº†  
â‘  å®ç°æ ¹æ®ç‰¹å®šä¸šåŠ¡ç»´åº¦çš„é™æµï¼š ä»å…¨å±€é™æµå™¨è½¬æ¢æˆé’ˆå¯¹ä¸šåŠ¡ç»´åº¦çš„é”®å€¼å¯¹é™æµå™¨ï¼›

â‘¡ redisä½œä¸ºé™æµè®¡æ•°å™¨çš„å¤–ç½®å­˜å‚¨ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•åœ¨redisä¸Šå®ç°åŸç†ï¼šæ ¸å¿ƒæ˜¯ä½¿ç”¨hashmapå­˜å‚¨å½“å‰è¯·æ±‚ç”¨æˆ·çš„ä»¤ç‰Œæ¡¶çŠ¶æ€ï¼ˆcurrent\_tokens, last\_timeï¼‰, è½åœ°æ—¶æ³¨æ„ä½¿ç”¨luaè„šæœ¬é¿å…ç«æ€æ¡ä»¶ã€‚

åé¢35+ç ç•œé’ˆå¯¹é™æµè®¾è®¡è¿˜ä¼šå†æ›´æ–°å‡ ä¸ªå½©è›‹ï¼Œ æœŸå¾…ä¸€é”®ä¸‰è¿ï¼Œäº¤ä¸ªæœ‹å‹ï¼Œ 35+æŠ¥å›¢ä¸è¿·è·¯ã€‚

* * *

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š{æœ‰æ€åº¦çš„é©¬ç”²}ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/JulianHuang/p/19244224](https://www.cnblogs.com/JulianHuang/p/19244224)

**æ¬¢è¿å…³æ³¨æˆ‘çš„åŸåˆ›æŠ€æœ¯ã€èŒåœºå…¬ä¼—å·ï¼Œ åŠ å¥½å‹è°ˆå¤©è¯´åœ°ï¼Œä¸€èµ·è¿›åŒ–**

![](https://blog-static.cnblogs.com/files/JulianHuang/QR.gif)