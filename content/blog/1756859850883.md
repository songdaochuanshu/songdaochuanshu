---
layout: post
title: 'é‡å†™ StarBlog çš„æœç´¢åŠŸèƒ½å’Œé¡µé¢ï¼Œæ”¯æŒæƒé‡è®¾ç½®å’Œç»“æœé«˜äº®'
date: "2025-09-03T00:37:30Z"
---
é‡å†™ StarBlog çš„æœç´¢åŠŸèƒ½å’Œé¡µé¢ï¼Œæ”¯æŒæƒé‡è®¾ç½®å’Œç»“æœé«˜äº®
================================

æœç´¢æƒé‡å’Œç»“æœé«˜äº®ï¼Ÿå†…å­˜é‡Œæ‰‹åŠ¨ç®—æƒé‡ï¼ŸRegexå®ç°é«˜äº®ï¼Ÿè¿™æ–¹æ¡ˆå¤Ÿç®€é™‹ã€‚è€æ¶æ„ä¿®è¡¥ç»ˆç©¶ä¸æ˜¯é•¿ä¹…ä¹‹è®¡ã€‚

å‰è¨€
--

æœ€è¿‘åœ¨æ•´ç†æœ¬åœ°çš„ä¸€äº›ç¬”è®°

æœ‰äº›æ—¥æœŸä¸å¤ªå¯¹çš„ï¼Œæˆ‘çš„åšå®¢ä¸Šæœ‰è®°å½•å‘å¸ƒå’Œæ›´æ–°æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘å»æœç´¢äº†ä¸€ä¸‹

è¿™æ—¶å€™å‘ç° StarBlog çš„æœç´¢åŠŸèƒ½å¤ªç®€é™‹äº†

è™½ç„¶ä¸Šæ¬¡æ›´æ–°å¢åŠ äº†ä¸€å¤§æ³¢åŠŸèƒ½ï¼Œä¹Ÿä¼˜åŒ–äº†ä¸€ä¸‹æœç´¢åŠŸèƒ½ï¼Œä¹‹å‰åªèƒ½æœç´¢æ ‡é¢˜ï¼Œç°åœ¨å¯ä»¥æœç´¢æ­£æ–‡å†…å®¹äº†ã€‚è¯¦è§: [StarBlog v1.3.0 æ–°ç‰ˆæœ¬ï¼Œä¸€å¤§æ³¢æ›´æ–°ä»¥åŠè¿ç§»æœåŠ¡å™¨éƒ¨ç½²](https://blog.deali.cn/p/starblog-v130-updates-server-migration)

ä¸è¿‡æœ‰ä¸ªé—®é¢˜æ˜¯æ²¡æœ‰æƒé‡ï¼Œæ ‡é¢˜çš„æƒé‡åº”è¯¥æ¯”æ­£æ–‡æ›´é«˜çš„

æŒ‰ç†è¯´è¿™äº›åº”è¯¥å¾—åŠ å…¥å…¨æ–‡æ£€ç´¢å¼•æ“ï¼ŒElasticsearchã€[MeiliSearch](https://www.meilisearch.com/) ä¹‹ç±»çš„æ¥å®ç°ã€‚ä½†è¿™äº›éœ€è¦é¢å¤–çš„æœåŠ¡ï¼Œå¤ªé‡äº†ã€‚

å†ä¸æµä¹Ÿè¦ç”¨ [Lucene.NET](https://lucenenet.apache.org/) è¿™ç§ï¼Œè¿™æ˜¯ Elasticsearch çš„åŸºç¡€ï¼Œä½†ä¸éœ€è¦é¢å¤–æœåŠ¡ï¼Œçº¯æœ¬åœ°åµŒå…¥å¼ï¼Œæ”¯æŒæƒé‡æ§åˆ¶ã€é«˜äº®ã€åˆ†è¯ç­‰åŠŸèƒ½ã€‚

ä½†ä¸ºäº†å¿«é€Ÿå®ç°ï¼Œè¿™äº›æˆ‘éƒ½ä¸æƒ³ç”¨ï¼Œå…ˆç”¨æœ€ç®€å•çš„æ–¹å¼æ¥æ”¹è¿›ã€‚

åŒæ—¶æˆ‘ä¹Ÿé‡å†™äº†æœç´¢ç»“æœé¡µé¢ï¼Œä¹‹å‰çš„é¡µé¢å¤ªä¸šä½™äº†ã€‚

æç®€å®ç°
----

æœ€ç»ˆæˆ‘çš„æ–¹æ¡ˆæ˜¯ï¼šåœ¨å†…å­˜é‡Œæ‰‹åŠ¨ç®—æƒé‡ + Regex å®ç°ç»“æœé«˜äº®

æˆæœ¬éå¸¸ä½ï¼Œæ•ˆæœä¹Ÿä¸é”™

å®ç°æ•ˆæœ
----

æ¥çœ‹çœ‹æ•ˆæœå§

è¿™å¥— StarBlog çš„å‰ç«¯æ˜¯ Bootstrapï¼Œæ ·å¼éƒ½å¾—é  CSSï¼Œç›¸å¯¹äºæˆ‘ç°åœ¨ç”¨çš„ Tailwind CSSã€Shadcn/uiã€Magic UI ä¹‹ç±»çš„ï¼Œå¤ªåŸå§‹äº†ï¼Œé‡å†™è¿™ä¸ªç•Œé¢å·²ç»å°½åŠ›äº†hhhğŸ˜„

![](https://img2024.cnblogs.com/blog/866942/202509/866942-20250902224918115-1150009501.png)

ä»£ç 
--

OKï¼Œæ¥ä¸‹æ¥æ˜¯å¤§å®¶ä¸æ„Ÿå…´è¶£çš„ä»£ç ç¯èŠ‚

### æ¨¡å‹

å…ˆå®šä¹‰æœç´¢ç»“æœæ¨¡å‹

    public class SearchPost {
        public Post Post { get; set; }
        public int TitleScore { get; set; }
    
        public int ContentScore { get; set; }
    
        // æ ‡é¢˜æ¯å‘½ä¸­ä¸€æ¬¡+100åˆ†
        // å†…å®¹å‘½ä¸­+1åˆ†
        public int Score => TitleScore * 100 + ContentScore;
        public string HighlightedTitle { get; set; }
        public string HighlightedSnippet { get; set; }
    }
    

### æœç´¢é€»è¾‘

æœç´¢åŠŸèƒ½é€»è¾‘éƒ½åœ¨ `src/StarBlog.Web/Controllers/SearchController.cs` æ–‡ä»¶é‡Œ

åœ¨å†…æ‘é‡Œè®¡ç®—æƒé‡ï¼Œä»æ•°æ®åº“æŸ¥è¯¢å‡ºæ¥åï¼Œç”¨ Linq è®¡ç®—æƒé‡ï¼Œå…³é”®è¯å‡ºç°ä¸€æ¬¡ä¸ºä¸€åˆ†ï¼›æ€»åˆ†æ˜¯åœ¨ `SearchPost` é‡Œè®¡ç®—çš„ï¼Œæ ‡é¢˜æ¯å‘½ä¸­ä¸€æ¬¡+100åˆ†ï¼Œå†…å®¹å‘½ä¸­+1åˆ†

    var searchPosts = _postRepo
        .Where(a => a.IsPublish)
        .Where(a =>
               a.Title!.Contains(keyword) ||
               a.Content.Contains(keyword)
              )
        .Include(a => a.Category)
        .ToList()
        .Select(p => new SearchPost {
            Post = p,
            TitleScore = p.Title.ToLower().Split(keyword).Length - 1,
            ContentScore = p.Content?.ToLower().Split(keyword).Length - 1 ?? 0,
        })
        .OrderByDescending(x => x.Score)
        .ToList();
    

### æœç´¢ç»“æœé«˜äº®

ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥å®ç°ç»“æœé«˜äº®

    var regex = new Regex(Regex.Escape(keyword), RegexOptions.IgnoreCase);
    foreach (var item in searchPosts) {
        item.HighlightedTitle = regex.Replace(item.Post.Title, m => $"<mark>{m.Value}</mark>");
        item.HighlightedSnippet = GetHighlightedSnippet(item.Post.Content, keyword);
    }
    

### ç”Ÿæˆé«˜äº®ç‰‡æ®µæ‘˜è¦

æ€è·¯å¾ˆç®€å•ï¼š

*   æ‰¾åˆ°ç¬¬ä¸€ä¸ªå‘½ä¸­çš„ä½ç½®
*   æˆªå–å‰åä¸€å®šé•¿åº¦çš„å†…å®¹ï¼ˆæ¯”å¦‚å‰åå„ 50 ä¸ªå­—ç¬¦ï¼‰
*   å†ç”¨ Regex æ›¿æ¢åŠ  `<mark>` é«˜äº®
*   æœ€åæ‹¼ä¸Š `...` ä½œä¸ºçœç•¥å·

    public static string GetHighlightedSnippet(string content, string keyword, int snippetLength = 100) {
        if (string.IsNullOrEmpty(content) || string.IsNullOrEmpty(keyword))
            return string.Empty;
    
        var regex = new Regex(Regex.Escape(keyword), RegexOptions.IgnoreCase);
        var match = regex.Match(content);
    
        if (!match.Success) {
            // æ²¡åŒ¹é…åˆ°ï¼Œç›´æ¥å–å‰ snippetLength*2 ä¸ªå­—ç¬¦ä½œä¸ºæ‘˜è¦
            return content.Length > snippetLength * 2
                ? content.Substring(0, snippetLength * 2) + "..."
                : content;
        }
    
        // è®¡ç®—æˆªå–èŒƒå›´ï¼ˆåŒ¹é…ä½ç½®å‰åå„ snippetLengthï¼‰
        int start = Math.Max(0, match.Index - snippetLength);
        int length = Math.Min(content.Length - start, match.Length + snippetLength * 2);
    
        string snippet = content.Substring(start, length);
    
        // é«˜äº®å¤„ç†
        snippet = regex.Replace(snippet, m => $"<mark>{m.Value}</mark>");
    
        // å‰åè¡¥çœç•¥å·ï¼ˆå¦‚æœä¸æ˜¯å…¨æ–‡å¼€å¤´æˆ–ç»“å°¾ï¼‰
        if (start > 0) snippet = "..." + snippet;
        if (start + length < content.Length) snippet += "...";
    
        return snippet;
    }
    

å°ç»“
--

é‡æ„ä¹‹åä½“éªŒæ›´ä¸Šä¸€å±‚

ä¸è¿‡åœ¨è€æ¶æ„ä¸Šä¿®ä¿®è¡¥è¡¥ç»ˆç©¶ä¸æ˜¯é•¿ä¹…ä¹‹è®¡

ç­‰æœ‰ç©ºå°±å¾—èµ¶ç´§å¼€å§‹ v2 æ–°ç‰ˆçš„å¼€å‘ğŸ’ª

PSï¼šæ¥ä¸‹æ¥ä¹Ÿè®¸ä¼šæ‹“å±•ä¸€ä¸‹è¿™ä¸ªæœç´¢åŠŸèƒ½ï¼ŒåŠ å…¥å¤šä¸ªå…³é”®è¯æœç´¢çš„æ”¯æŒï¼Œå†è¿›ä¸€æ­¥æ­é… Lucene.NET ä¹Ÿä¸æ— å¯èƒ½ã€‚

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚