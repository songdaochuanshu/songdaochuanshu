---
layout: post
title: 'React çŠ¶æ€ç®¡ç†çš„â€œç¢ç‰‡åŒ–â€'
date: "2025-11-04T00:41:36Z"
---
React çŠ¶æ€ç®¡ç†çš„â€œç¢ç‰‡åŒ–â€
================

å‰è¨€
--

ä¸‰å¹´å‰ï¼Œæˆ‘ä»¬è¿˜åœ¨ Reddit ä¸Šåµå¾—ä¸å¯å¼€äº¤ï¼š  
â€œRedux å¤ªå•°å—¦ï¼â€ â€œZustand å¤ªé»‘ç›’ï¼â€ â€œJotai ä¼šå†…å­˜æ³„æ¼ï¼â€

ä»Šå¤©ï¼ŒReact 19 ç›´æ¥æŠŠâ€œå¤–æŒ‚ä»“åº“â€æ‹†æˆäº†æ— æ•°é¢—**å¾®çŠ¶æ€èƒ¶å›Š**ï¼ˆMicro-State Capsulesï¼‰â€”â€”éšç”¨éšå–ï¼Œéšä¸¢éšç­ã€‚  
**çŠ¶æ€ä¸å†é›†ä¸­ï¼Œè€Œæ˜¯æ•£è½åœ¨ç»„ä»¶æ ‘çš„æœ€å°ç²’åº¦ï¼Œé æ¡†æ¶è‡ªåŠ¨åˆå¹¶ã€åŒæ­¥ã€æŒä¹…åŒ–ã€‚**

å˜åŒ–
--

åœºæ™¯

2022 ç—›ç‚¹

2025 ä½“æ„Ÿ

è¡¥å……ç¤ºä¾‹

æ•°æ®è¯·æ±‚

æ‰‹å†™ `useEffect` + `swr`ï¼Œç¼“å­˜é”®æ³›æ»¥

`use(promise)` åŒæ­¥å†™æ³•ï¼Œç¼“å­˜è‡ªåŠ¨åŒ–

è§ 3.1

å…¨å±€ä¸»é¢˜

`Context.Provider` å±‚å±‚åŒ…è£¹ï¼Œé‡æ¸²æŸ“å™©æ¢¦

`use(style)` åŸå­åŒ– CSS å˜é‡ï¼Œ0 æ¸²æŸ“æˆæœ¬

è§ 3.2

è·¯ç”±çŠ¶æ€

è·¯ç”±åº“å„è‡ªç»´æŠ¤ `location`ï¼Œè·¨é¡µåŒæ­¥é  hack

`use(navigation)` æŠŠè·¯ç”±å½“çŠ¶æ€ï¼Œé¡µé¢é—´å…±äº«åƒ `useState`

è§ 3.3

å®¢æˆ·ç«¯æŒä¹…åŒ–

`zustand-persist` æ‰‹å†™ç‰ˆæœ¬å·ã€è¿ç§»é€»è¾‘

`use(storage)` å£°æ˜å¼æ³¨å†Œï¼ŒReact åå°è‡ªåŠ¨åˆå¹¶ã€å‹ç¼©ã€è¿ç§»

è§ 3.4

å®æˆ˜
--

### 3.1 æ•°æ®è¯·æ±‚ï¼š3 è¡Œä»£ç æå®šâ€œæ‹‰å–-ç¼“å­˜-é‡è¯•â€

    // UserCard.tsx
    export default function UserCard({ id }: { id: string }) {
      // â‘  æ¥å£è¿”å› Promiseï¼ŒReact è‡ªåŠ¨å»é‡ã€ç¼“å­˜ã€è¿‡æœŸé‡éªŒè¯
      const user = use(fetchUser(id));   // â† åŒæ­¥å†™æ³•ï¼Œå´å…·å¤‡ swr å…¨éƒ¨èƒ½åŠ›
    
      return (
        <article>
          <h1>{user.name}</h1>
          <img src={user.avatar} alt={user.name} />
        </article>
      );
    }
    

**æµç¨‹å›¾ï¼šReact 19 å¦‚ä½•ç®¡ç† use(promise)**

sequenceDiagram ç»„ä»¶->>React: use(promise) React->>ç¼“å­˜: å‘½ä¸­ï¼Ÿ alt å‘½ä¸­ ç¼“å­˜-->>ç»„ä»¶: è¿”å›ç¼“å­˜æ•°æ® else æœªå‘½ä¸­ React->>æœåŠ¡ç«¯: å‘èµ·è¯·æ±‚ æœåŠ¡ç«¯-->>React: æ•°æ® React-->>ç¼“å­˜: å†™å…¥ç¼“å­˜ React-->>ç»„ä»¶: è¿”å›æ•°æ® end

### 3.2 ä¸»é¢˜åˆ‡æ¢ï¼š0 è¡Œ JavaScript æ¸²æŸ“é€»è¾‘

    // DarkModeToggle.tsx
    export default function DarkModeToggle() {
      const [theme, setTheme] = use(storage('theme', 'light'));
    
      // æ ·å¼åŸå­å®æ—¶æ³¨å…¥ï¼Œä¸è§¦å‘ React æ¸²æŸ“
      use(style`
        :root {
          --bg: ${theme === 'dark' ? '#1e1e1e' : '#ffffff'};
          --fg: ${theme === 'dark' ? '#ffffff' : '#1e1e1e'};
        }
      `);
    
      return (
        <button onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')}>
          {theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™'}
        </button>
      );
    }
    

**æ¶æ„å›¾ï¼šä¸»é¢˜èƒ¶å›Šåœ¨æµè§ˆå™¨å„çº¿ç¨‹é—´çš„æµå‘**

graph TD A\[ç»„ä»¶setTheme\] -->|åºåˆ—åŒ–| B\[Storage Worker\] B -->|BroadcastChannel| C(å…¶ä»–æ ‡ç­¾é¡µ) B -->|IDB| D(ç£ç›˜) C -->|é‡æ–°è¯»å–| E\[CSS å˜é‡\] D -->|ä¸‹æ¬¡åŠ è½½| F\[Hydrate\]

### 3.3 è·¯ç”±å³çŠ¶æ€ï¼šè¯­è¨€åˆ‡æ¢ä¸å†åˆ·æ–°æ•´é¡µ

    // LangSwitcher.tsx
    export default function LangSwitcher() {
      // æŠŠ /[lang]/blog ä¸­çš„ lang å½“æˆçŠ¶æ€
      const [lang, setLang] = use(navigation().param('lang'));
    
      return (
        <select value={lang} onChange={e => setLang(e.target.value)}>
          <option value="en">English</option>
          <option value="zh">ä¸­æ–‡</option>
        </select>
      );
    }
    

**å…³é”®ç‚¹**

*   æ”¹å˜ `lang` ç­‰ä»·äº `router.push`ï¼Œä½† Next.js 15 ä¼š**åª RSC æ¸²æŸ“å˜æ›´åŒºåŸŸ**ã€‚
*   è‹¥åŒä¸€é¡µé¢æœ‰å¤šè¯­è¨€æ®µè½ï¼ŒReact ä¼šæµå¼è¿”å› diffï¼Œ**é¦–å­—èŠ‚æ—¶é—´ < 50 ms**ã€‚

### 3.4 æŒä¹…åŒ–è¿ç§»ï¼šæŠŠ Redux Store æ¬è¿›â€œèƒ¶å›Šâ€

å‡è®¾ä½ æœ‰ä¸€ä¸ªæ—§ `userSlice` ç»“æ„ï¼š

    // legacy:userSlice
    interface UserSlice {
      id: string;
      name: string;
      vip: boolean;
    }
    

**è¿ç§» 3 æ­¥æ›²**

1.  å£°æ˜å…¼å®¹ç±»å‹

    // migrate.ts
    export const userCapsule = storage<UserSlice>('user', {
      id: '',
      name: '',
      vip: false,
      version: 1, // React ä¼šæ ¹æ® version è‡ªåŠ¨æ‰§è¡Œ migrate å‡½æ•°
    });
    

2.  åœ¨æ ¹ç»„ä»¶åšä¸€æ¬¡â€œæ¬å®¶ä¸­è½¬â€

    // App.tsx
    function Bootstrap() {
      const dispatch = useDispatch();
      const legacyUser = useSelector(state => state.user);
    
      // â‘¡ æŠŠ Redux æ•°æ®å†™å…¥èƒ¶å›Šï¼Œåªéœ€ä¸€æ¬¡
      const [, setUserCapsule] = use(userCapsule);
      useEffect(() => setUserCapsule(legacyUser), [legacyUser]);
    
      return <NextUI />;
    }
    

3.  ä¸šåŠ¡ç»„ä»¶ç›´æ¥è®¢é˜…èƒ¶å›Š

    // UserBadge.tsx
    export default function UserBadge() {
      const user = use(userCapsule);   // â† ä¸å†ç»è¿‡ Redux
      return <span>{user.vip ? 'ğŸ‘‘' : 'ğŸ‘¤'} {user.name}</span>;
    }
    

**è¿ç§»æµç¨‹å›¾**

graph LR %% èŠ‚ç‚¹å®šä¹‰ ReduxStore\["Redux Store"\] Bootstrap\["Bootstrapç»„ä»¶<br/>useSelector"\] SetCapsule\["setUserCapsule"\] StorageWorker\["Storage Worker"\] IndexedDB\[(IndexedDB)\] Broadcast\["BroadcastChannel"\] OtherTab\["å…¶ä»–æ ‡ç­¾é¡µ"\] UserBadge\["UserBadgeç»„ä»¶<br/>use(userCapsule)"\] %% è¿çº¿ ReduxStore -->|è¯»å–| Bootstrap Bootstrap -->|å†™å…¥| SetCapsule SetCapsule --> StorageWorker StorageWorker -->|æŒä¹…åŒ–| IndexedDB StorageWorker -->|åŒæ­¥| Broadcast Broadcast -->|è§¦å‘æ›´æ–°| OtherTab OtherTab -->|è¯»å–| UserBadge

è¿ç§»
--

1.  **æ¸è¿›å¼åˆ‡ç‰‡**  
    æŠŠ Redux Store æ‹†æˆé¡µé¢çº§ slice â†’ å°è£… `toCapsule()` è½¬æ¢å‡½æ•° â†’ ç°åº¦ 10 % ç”¨æˆ·ã€‚
2.  **åŒè°ƒåº¦å…±å­˜**  
    æ—§ç»„ä»¶ `createLegacyRoot()` è·‘æ—§è°ƒåº¦å™¨ï¼Œæ–°ç»„ä»¶ `createRoot()` è·‘å¾®çŠ¶æ€è°ƒåº¦å™¨ï¼Œé€šè¿‡ `useSyncExternalStore` åŒå‘åŒæ­¥ã€‚
3.  **ç±»å‹å³å¥‘çº¦**  
    ä¸€ä»½ `GlobalState.d.ts` æ˜ å°„æ—§å­—æ®µ â†’ TypeScript è‡ªåŠ¨æç¤ºâ€œæ— äººè®¢é˜…â€å­—æ®µ â†’ å®‰å…¨åˆ é™¤ã€‚

ç»“è¯­
--

å½“ç¼“å­˜ã€æŒä¹…åŒ–ã€è·¯ç”±ã€æ ·å¼éƒ½è¢«æ¡†æ¶åšæˆ**å£°æ˜å¼åŸè¯­**ï¼Œ  
æˆ‘ä»¬ç»ˆäºå¯ä»¥æŠŠ 100% çš„è„‘åŠ›æ”¾åœ¨**äº§å“é€»è¾‘**è€Œéâ€œç®¡æ•°æ®â€ä¸Šã€‚