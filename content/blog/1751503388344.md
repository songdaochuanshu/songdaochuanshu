---
layout: post
title: 'SharpIcoWebå¼€å‘è®°å½•ç¯‡'
date: "2025-07-03T00:43:08Z"
---
SharpIcoWebå¼€å‘è®°å½•ç¯‡
================

SharpIcoWebå¼€å‘è®°å½•ç¯‡
================

å‰è¨€
--

å¤§ä½¬ç”¨.NET 9.0å¼€å‘äº†[SharpIco](https://github.com/star-plan/sharp-ico)è½»é‡çº§å›¾æ ‡ç”Ÿæˆå·¥å…·ï¼Œæ˜¯ä¸€æ¬¾æ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œæ”¯æŒAOTå‘å¸ƒï¼Œéå¸¸æ–¹ä¾¿ã€‚

**âœ¨ åŠŸèƒ½ç‰¹ç‚¹**

*   ğŸ–¼ï¸ å°†PNGå›¾åƒè½¬æ¢ä¸ºå¤šå°ºå¯¸ICOå›¾æ ‡
*   ğŸ” æ”¯æŒç”ŸæˆåŒ…å«è‡ªå®šä¹‰å°ºå¯¸çš„ICOå›¾æ ‡ï¼ˆæœ€é«˜æ”¯æŒ1024Ã—1024ï¼‰
*   ğŸ§ æ£€æŸ¥ICOæ–‡ä»¶çš„å†…éƒ¨ç»“æ„å’Œä¿¡æ¯
*   ğŸ“ å‡†ç¡®è¯†åˆ«å¹¶æ˜¾ç¤ºè¶…å¤§å°ºå¯¸å›¾æ ‡ï¼ˆå¦‚512Ã—512ã€1024Ã—1024ï¼‰çš„å®é™…å°ºå¯¸

ç›´è¾¾åœ°å€ï¼š[https://github.com/star-plan/sharp-ico](https://github.com/star-plan/sharp-ico)

ç°åœ¨äº’è”ç½‘ä¸Šåº”è¯¥æœ‰å¾ˆå¤šè¿™ç±»å°å·¥å…·æˆ–è€…ç½‘ç«™ï¼Œæˆ‘ä¹Ÿæƒ³éƒ¨ç½²æŠŠè¿™ä¸ªå°å·¥å…·éƒ¨ç½²æˆç½‘ç«™ï¼Œå½“ç„¶ä¸è¦å’Œåˆ«äººç½‘ç«™ä¸€æ¨¡ä¸€æ ·ï¼Œæ‰€æœ‰åç«¯æˆ‘é‡‡ç”¨ `.NET Core Minimal API`å»å¼€å‘ã€‚

å¤§ä½¬å¼€å‘çš„è¿™æ¬¾å°å·¥å…·å¯ä»¥ç›´æ¥åœ¨é›†æˆ `.NET Core`ä¸­ï¼Œæ‰€ä»¥æˆ‘åªéœ€è¦å†™ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æ¥å£å°±è¡Œäº†ã€‚ç”¨äº† `.NET`è¿™ä¹ˆä¹…ï¼Œå†™æ¥å£ä¸€ç›´ç”¨çš„æ˜¯ `WebApi`ï¼Œè¿™æ¬¡å°è¯•ä¸‹ `Minimal Api`ã€‚

åœ¨çº¿åœ°å€ï¼š[https://ico.pljzy.top](https://ico.pljzy.top/)

Minimal Api ç®€ä»‹
--------------

> åœ¨ä½¿ç”¨ ASP.NET Core ç”Ÿæˆå¿«é€Ÿ HTTP API æ—¶ï¼Œå¯ä»¥å°†æœ€å° API ä½œä¸ºä¸€ç§ç®€åŒ–çš„æ–¹æ³•ã€‚ å¯ä»¥ä½¿ç”¨æœ€å°‘çš„ä»£ç å’Œé…ç½®ç”Ÿæˆå®Œå…¨æ­£å¸¸è¿è¡Œçš„ REST ç»ˆç»“ç‚¹ã€‚ è·³è¿‡ä¼ ç»Ÿçš„åŸºæ¶ï¼Œå¹¶é€šè¿‡æµç•…åœ°å£°æ˜ API è·¯ç”±å’Œæ“ä½œæ¥é¿å…ä¸å¿…è¦çš„æ§åˆ¶å™¨ã€‚

### ä¸»è¦ç‰¹ç‚¹

1.  **ç®€æ´çš„è¯­æ³•**ï¼šä½¿ç”¨æ›´å°‘çš„ä»£ç å®šä¹‰ API ç«¯ç‚¹
2.  **å‡å°‘æ ·æ¿ä»£ç **ï¼šä¸éœ€è¦æ§åˆ¶å™¨ç±»
3.  **å†…ç½®ä¾èµ–æ³¨å…¥**ï¼šç®€åŒ–æœåŠ¡é…ç½®
4.  **è·¯ç”±å’Œè¯·æ±‚å¤„ç†ä¸€ä½“åŒ–**ï¼šç›´æ¥åœ¨è·¯ç”±å®šä¹‰ä¸­å¤„ç†è¯·æ±‚
5.  **æ”¯æŒæ‰€æœ‰ ASP.NET Core åŠŸèƒ½**ï¼šä¸­é—´ä»¶ã€è®¤è¯ã€æˆæƒç­‰

### æ¶æ„æ¦‚è¿°

`MiniAPI`çš„æ ¸å¿ƒæ¶æ„åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„ä»¶ï¼š

1.  WebApplicationï¼šè¿™æ˜¯æ•´ä¸ªåº”ç”¨çš„å…¥å£ç‚¹å’Œå®¿ä¸»ã€‚å®ƒè´Ÿè´£é…ç½®æœåŠ¡ã€ä¸­é—´ä»¶å’Œè·¯ç”±ã€‚
2.  Endpointsï¼šè¿™äº›æ˜¯APIçš„ç»ˆç‚¹ï¼Œä¹Ÿå°±æ˜¯å¤„ç†ç‰¹å®šHTTPè¯·æ±‚çš„åœ°æ–¹ã€‚
3.  Handlersï¼šè¿™äº›æ˜¯å®é™…å¤„ç†è¯·æ±‚å¹¶ç”Ÿæˆå“åº”çš„å‡½æ•°ã€‚
4.  Middlewareï¼šè¿™äº›ç»„ä»¶åœ¨è¯·æ±‚åˆ°è¾¾handlerä¹‹å‰å’Œä¹‹åå¤„ç†è¯·æ±‚ã€‚

### å…³é”®æœ¯è¯­

åœ¨è¿›è¡Œå¼€å‘å‰ï¼Œå…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ `Endpoints`ã€`Handlers`ã€`Middleware`ã€‚

1.  Endpointsï¼ˆç«¯ç‚¹ï¼‰ï¼šEndpointsæ˜¯ä¸€ä¸ªç‰¹å®šçš„URLè·¯å¾„ï¼Œä¸ä¸€ä¸ªHTTPæ–¹æ³•ç›¸å…³è”ã€‚
    
        app.MapGet("/hello", () => "Hello, World!");
        
    
2.  Handlersï¼ˆå¤„ç†å™¨ï¼‰ï¼šHandlersæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥æ”¶httpè¯·æ±‚å¹¶è¿”å›å“åº”ã€‚åœ¨ `MiniAPIs`ä¸­handlerå¯ä»¥æ˜¯ä¸€ä¸ªç®€å•çš„lambdaè¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå•ç‹¬å®šä¹‰çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
    
        app.MapGet("/users/{id}", (int id) => $"User ID: {id}");
        
        
    
3.  Middlewareï¼ˆä¸­é—´ä»¶ï¼‰ï¼šä¸WebApiä¸€æ ·ï¼ŒMiniAPIsä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶ï¼Œå®ƒä»¬å¯ä»¥åœ¨è¯·æ±‚åˆ°è¾¾handlerä¹‹å‰æ‰§è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥åœ¨handlerå¤„ç†å®Œè¯·æ±‚åä¿®æ”¹å“åº”ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶æ¥å¤„ç†èº«ä»½éªŒè¯ã€æ—¥å¿—è®°å½•æˆ–å¼‚å¸¸å¤„ç†ã€‚
    

å¼€å‘
--

äº†è§£å®Œä¸€äº› `Minimal Api`åŸºç¡€çŸ¥è¯†åï¼Œå°±å¯ä»¥å¼€å§‹å¼€å‘äº†ã€‚é¦–å…ˆåˆ›å»º `MiniMal Api`æ¨¡ç‰ˆçš„ `.NET 9 Api`ç¨‹åºã€‚

æ¨¡ç‰ˆé»˜è®¤ä¸ºåˆ›å»ºä¸€ä¸ªç¤ºä¾‹æ¥å£ï¼Œçœ‹åˆ°è¿™ä¸ªæ¥å£ï¼Œçœ‹èµ·æ¥å’Œ `WebApi`å†™æ³•å·®åˆ«ä¸å¤§ï¼Œä½†æ˜¯ä»£ç æ˜¯ç›´æ¥å†™åœ¨ `Program.cs`æ–‡ä»¶ä¸­,æ— éœ€åˆ›å»ºæ§åˆ¶å™¨ã€‚

![image](https://img2024.cnblogs.com/blog/3091176/202507/3091176-20250702161809441-224445981.png)

æ¥ä¸‹æ¥å¼€å‘ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æ¥å£ï¼Œç„¶åè°ƒç”¨å¤§ä½¬å¼€å‘çš„å·¥å…·å°±okäº†ã€‚

åœ¨ `MiniAPI`ä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œé‚£ä¹ˆè¿™é‡Œåˆ›å»ºä¸€ä¸ªå¤„ç†æ–‡ä»¶çš„æœåŠ¡ï¼Œç„¶åå†æ³¨å…¥è¿™ä¸ªæœåŠ¡åœ¨æ¥å£ä¸­ä½¿ç”¨ã€‚

### é¡¹ç›®ç»“æ„

å¯ä»¥çœ‹åˆ°æˆ‘çš„é¡¹ç›®å¯ä»¥ç›´æ¥å¼•ç”¨ `SharpIco`å·¥å…·ï¼Œè¿™é‡Œå³é”® `SharpIco`ç¼–è¾‘csprojæ–‡ä»¶å°†é¡¹ç›®ç±»å‹æ”¹ä¸ºç±»åº“å°±å¯ä»¥ç›´æ¥è°ƒç”¨äº†ã€‚

    <PropertyGroup>
            <!-- æ”¹ä¸ºç”Ÿæˆåº“è€Œä¸æ˜¯æ§åˆ¶å°åº”ç”¨ -->
            <OutputType>Library</OutputType>
    </PropertyGroup>
    

![image](https://img2024.cnblogs.com/blog/3091176/202507/3091176-20250702161821403-1620357292.png)

### IFileServiceæ¥å£

    public interface IFileService
    {
        // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
        bool IsFileValid(IFormFile file);
        // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶
        Task<string> SaveUploadedFile(IFormFile file);
        // åˆ›å»ºä¸´æ—¶ç›®å½•
        string GetTempDirectory();
        // è¯»å–æ–‡ä»¶åˆ°å†…å­˜æµ
        Task<MemoryStream> ReadFileToMemoryAsync(string filePath);
        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        void DeleteFile(string tempFilePath);
    }
    

### FileServiceç±»

è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå˜é‡ `_tempFiles`å»è®°å½•ä¸Šä¼ çš„ä¸´æ—¶æ–‡ä»¶,ç„¶åå®ç°IDisposableæ¥å£è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼Œç¡®ä¿ä¸Šä¼ çš„å›¾ç‰‡ä¸ä¼šç•™å­˜åˆ°ç¡¬ç›˜é‡Œé¢ã€‚

ä¸€å¼€å§‹æˆ‘çš„è®¾è®¡æ€è·¯å°±æ˜¯åœ¨ `wooroot`ä¸­å»å»ºç«‹ä¸€ä¸ªå¾…è½¬æ¢å’Œè½¬æ¢åçš„ç›®å½•å–å¤„ç†å›¾ç‰‡ï¼Œä½†è½¬å¿µä¸€æƒ³ï¼Œä½œä¸ºä¸€æ¬¾å›¾ç‰‡è½¬icoçš„å·¥å…·ï¼Œè¿˜æ˜¯ä¸è¦ç•™å­˜å›¾ç‰‡å¥½ä¸€ç‚¹ï¼Œæ‰€ä»¥æ‰é‡‡ç”¨äº†ä¸´æ—¶ç›®å½•è¿™ä¸ªåŠæ³•ã€‚

    
    public class FileService : IFileService, IDisposable
    {
        private readonly List<string> _tempFiles = new();
    
        public string GetTempDirectory()
        {
            var tempDir = Path.Combine(Path.GetTempPath(), "SharpIcoTemp");
            Directory.CreateDirectory(tempDir);
            return tempDir;
        }
      
        public bool IsFileValid(IFormFile file)
        {
            var allowedExtensions = new[] { ".png", ".jpg", ".jpeg" };
            var extension = Path.GetExtension(file.FileName).ToLowerInvariant();
            return file.Length is > 0 and < 10 * 1024 * 1024 && // 10MB
                   allowedExtensions.Contains(extension);
        }
    
        // ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶
        public async Task<string> SaveUploadedFile(IFormFile file)
        {
            var tempDir = GetTempDirectory();
            var tempFilePath = Path.Combine(tempDir, $"{Guid.NewGuid()}{Path.GetExtension(file.FileName)}");
      
            await using var stream = new FileStream(tempFilePath, FileMode.Create);
            await file.CopyToAsync(stream);
      
            _tempFiles.Add(tempFilePath); // è®°å½•å¾…æ¸…ç†æ–‡ä»¶
            return tempFilePath;
        }
      
        // å®‰å…¨è¯»å–æ–‡ä»¶åˆ°å†…å­˜æµ
        public async Task<MemoryStream> ReadFileToMemoryAsync(string filePath)
        {
            var memoryStream = new MemoryStream();
            await using (var fileStream = File.OpenRead(filePath))
            {
                await fileStream.CopyToAsync(memoryStream);
            }
            memoryStream.Position = 0;
            return memoryStream;
        }
    
        public void DeleteFile(string tempFilePath)
        {
            if (File.Exists(tempFilePath))
                File.Delete(tempFilePath);
        }
    
        // å®ç°IDisposableæ¥å£è‡ªåŠ¨æ¸…ç†
        public void Dispose()
        {
            foreach (var file in _tempFiles)
            {
                try
                {
                    if (File.Exists(file))
                        File.Delete(file);
                }
                catch { /* å¿½ç•¥åˆ é™¤å¼‚å¸¸ */ }
            }
            GC.SuppressFinalize(this);
        }
    }
    

### Programç±»

æœåŠ¡å†™å®Œåï¼Œæ¥ä¸‹æ¥åœ¨é…ç½®ç±»ä¸­æ³¨å…¥æœåŠ¡å¹¶å®Œæˆæ¥å£ç¼–å†™å°±å¤§åŠŸå‘Šæˆäº†ã€‚

æ³¨å…¥æœåŠ¡ï¼š

    builder.Services.AddScoped<IFileService, FileService>();
    

æ¥å£ç¼–å†™ï¼š

    app.MapPost("/api/uploadDownload", async ([FromForm] IFormFile file,[FromForm] string? sizes,IFileService fileService, ILogger<Program> logger) =>
    {
        try
        {
            // éªŒè¯è¾“å…¥
            if (!fileService.IsFileValid(file))
            {
                return Results.BadRequest("è¯·ä¸Šä¼ æœ‰æ•ˆæ–‡ä»¶,æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB");
            }
    
            // ä¿å­˜ä¸´æ—¶æ–‡ä»¶
            var tempFilePath = await fileService.SaveUploadedFile(file);
    
            // ç”Ÿæˆè¾“å‡ºè·¯å¾„
            var outputPath = Path.Combine(fileService.GetTempDirectory(), $"{Guid.NewGuid()}.ico");
    
            // æ‰§è¡Œè½¬æ¢ å¤„ç†å¤§å°å‚æ•°
            var sizesArray = sizes?.Split(',').Select(int.Parse).ToArray();
            if (sizesArray is { Length: > 0 })
                IcoGenerator.GenerateIcon(tempFilePath, outputPath, sizesArray);
            else
                IcoGenerator.GenerateIcon(tempFilePath, outputPath);
    
            // è¯»å–åˆ°å†…å­˜
            var memoryStream = await fileService.ReadFileToMemoryAsync(outputPath);
      
            // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
            fileService.DeleteFile(outputPath);
      
            logger.LogInformation($"{DateTime.UtcNow} æ–‡ä»¶ {file.FileName} è½¬æ¢æˆåŠŸ");
      
            return Results.File(memoryStream, "image/x-icon");
        }
        catch (Exception ex)
        {
            logger.LogError(ex, $"{DateTime.UtcNow} å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯");
            return Results.Problem("å¤„ç†æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯");
        }
    }).DisableAntiforgery();
    

æ¥å£æµ‹è¯•
----

è¿™é‡Œç›´æ¥ä½¿ç”¨æ¨¡ç‰ˆè‡ªå¸¦çš„httpæ–‡ä»¶è¿›è¡Œæµ‹è¯•ï¼Œè¿™ä¸ªè¿˜æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè¿˜æŠ˜è…¾äº†æŒºä¹…ã€‚

`SharpIcoWeb.http` æ–‡ä»¶

ç®€å•ä»‹ç»ä¸‹ï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚åªä¸Šä¼ äº†å›¾ç‰‡æ–‡ä»¶ï¼ŒæœªæŒ‡å®šå°ºå¯¸å‚æ•°ï¼Œåç«¯æ¥å£ä¼šé»˜è®¤ç”Ÿæˆ16,32,48,64,128,256,512,1024 å°ºå¯¸çš„icoæ–‡ä»¶ã€‚

ç¬¬äºŒä¸ªè¯·æ±‚å°±æ˜¯æ·»åŠ äº†å°ºå¯¸å‚æ•°çš„è¯·æ±‚ã€‚

    @SharpIcoWeb_HostAddress = http://localhost:5235
    
    ### ä¸Šä¼ æ–‡ä»¶å¹¶è½¬æ¢ä¸ºICOï¼ˆä¸å¸¦å°ºå¯¸å‚æ•°ï¼‰
    POST {{SharpIcoWeb_HostAddress}}/api/uploadDownload
    Content-Type: multipart/form-data; boundary=WebAppBoundary
    
    --WebAppBoundary
    Content-Disposition: form-data; name="file"; filename="1.png"
    Content-Type: image/png
    
    < ./1.png
    --WebAppBoundary--
    
    ### ä¸Šä¼ æ–‡ä»¶å¹¶è½¬æ¢ä¸ºICOï¼ˆå¸¦å°ºå¯¸å‚æ•°ï¼‰
    POST {{SharpIcoWeb_HostAddress}}/api/uploadDownload
    Content-Type: multipart/form-data; boundary=WebAppBoundary
    
    --WebAppBoundary
    Content-Disposition: form-data; name="file"; filename="1.png"
    Content-Type: image/png
    
    < ./1.png
    --WebAppBoundary
    Content-Disposition: form-data; name="sizes"
    
    16,32,48,64,128
    

### æµ‹è¯•ç»“æœ

![image](https://img2024.cnblogs.com/blog/3091176/202507/3091176-20250702161837918-331458249.png)

### å…³é”®ä»£ç 

`IcoGenerator.GenerateIcon(tempFilePath, outputPath, sizesArray);`è¿™é‡Œæ˜¯è°ƒç”¨SharpIcoå·¥å…·æä¾›çš„æ–¹æ³•ã€‚

`app.MapPost().DisableAntiforgery()`DisableAntiforgeryä½œç”¨æ˜¯ç¦ç”¨ ASP.NET Core çš„é˜²ä¼ªé€ ä»¤ç‰ŒéªŒè¯ã€‚

ç›¸å…³é“¾æ¥
----

*   SharpIcoï¼š[https://github.com/star-plan/sharp-ico](https://github.com/star-plan/sharp-ico)
*   [SharpIcoWeb](https://github.com/ZyPLJ/SharpIcoWeb)ï¼š[https://github.com/ZyPLJ/SharpIcoWeb](https://github.com/ZyPLJ/SharpIcoWeb)
*   æœ€å°APIå®˜æ–¹æ–‡æ¡£ï¼š[https://learn.microsoft.com/zh-cn/aspnet/core/fundamentals/minimal-apis/overview?view=aspnetcore-9.0](https://learn.microsoft.com/zh-cn/aspnet/core/fundamentals/minimal-apis/overview?view=aspnetcore-9.0)
*   æœ€å°APIå­¦ä¹ æŒ‡å—ï¼š[https://blog.csdn.net/xiaohucxy/article/details/140134927](https://blog.csdn.net/xiaohucxy/article/details/140134927)