---
layout: post
title: '.NET+AI | Workflow | æ ¸å¿ƒæ¦‚å¿µé€Ÿé€šï¼ˆ1ï¼‰'
date: "2026-01-21T00:46:50Z"
---
.NET+AI | Workflow | æ ¸å¿ƒæ¦‚å¿µé€Ÿé€šï¼ˆ1ï¼‰
==============================

MAF Workflow æ ¸å¿ƒæ¦‚å¿µè¯¦è§£
===================

ğŸ“š æœ¬è¯¾æ¦‚è§ˆ
-------

**Microsoft Agent Framework (MAF)** æä¾›äº†ä¸€å¥—å¼ºå¤§çš„ **Workflowï¼ˆå·¥ä½œæµï¼‰** æ¡†æ¶ï¼Œç”¨äºç¼–æ’å’Œåè°ƒå¤šä¸ªæ™ºèƒ½ä½“ï¼ˆAgentï¼‰æˆ–å¤„ç†ç»„ä»¶çš„æ‰§è¡Œæµç¨‹ã€‚

æœ¬è¯¾å°†ä»¥**é€šä¿—æ˜“æ‡‚**çš„æ–¹å¼ï¼Œå¸®åŠ©ä½ ç†è§£ MAF Workflow çš„æ ¸å¿ƒæ¦‚å¿µï¼š

æ¦‚å¿µ

è¯´æ˜

ç±»æ¯”

**Workflow**

å·¥ä½œæµå®šä¹‰

ğŸ“‹ æµç¨‹å›¾

**Executor**

æ‰§è¡Œå™¨/å¤„ç†èŠ‚ç‚¹

ğŸ”§ å·¥äºº

**Edge**

è¿æ¥è¾¹

â¡ï¸ ä¼ é€å¸¦

**SuperStep**

è¶…æ­¥/æ‰¹é‡å¤„ç†

â±ï¸ å¤„ç†å‘¨æœŸ

**WorkflowContext**

å·¥ä½œæµä¸Šä¸‹æ–‡

ğŸ“¦ å·¥ä½œå°

**WorkflowEvent**

å·¥ä½œæµäº‹ä»¶

ğŸ“£ é€šçŸ¥

**Run**

è¿è¡Œå®ä¾‹

ğŸƒ ä¸€æ¬¡æ‰§è¡Œ

**Checkpoint**

æ£€æŸ¥ç‚¹

ğŸ’¾ å­˜æ¡£ç‚¹

![](https://files.mdnice.com/user/3327/16fe2c29-9841-49dd-b2ff-803e9abfd3f0.png)

è®©æˆ‘ä»¬é€ä¸€æ·±å…¥äº†è§£è¿™äº›æ¦‚å¿µï¼

ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦ Workflowï¼Ÿ
------------------

åœ¨æ„å»º AI æ™ºèƒ½ä½“åº”ç”¨æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ï¼š

1.  **å¤šæ­¥éª¤å¤„ç†**ï¼šç”¨æˆ·è¯·æ±‚éœ€è¦ç»è¿‡å¤šä¸ªå¤„ç†ç¯èŠ‚
2.  **å¤šæ™ºèƒ½ä½“åä½œ**ï¼šä¸åŒçš„ Agent å„å¸å…¶èŒï¼ŒååŒå®Œæˆä»»åŠ¡
3.  **æ¡ä»¶åˆ†æ”¯**ï¼šæ ¹æ®å¤„ç†ç»“æœå†³å®šä¸‹ä¸€æ­¥èµ°å‘
4.  **å¹¶è¡Œå¤„ç†**ï¼šæŸäº›ä»»åŠ¡å¯ä»¥åŒæ—¶è¿›è¡Œä»¥æé«˜æ•ˆç‡
5.  **çŠ¶æ€ç®¡ç†**ï¼šéœ€è¦åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¿å­˜å’Œæ¢å¤çŠ¶æ€

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜ï¼š**

    // âŒ ç¡¬ç¼–ç çš„æµç¨‹ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæ‰©å±•
    var result1 = await agent1.ProcessAsync(input);
    if (result1.Success)
    {
        var result2 = await agent2.ProcessAsync(result1.Data);
        // ... è¶Šæ¥è¶Šå¤æ‚
    }
    

**ä½¿ç”¨ Workflow çš„ä¼˜åŠ¿ï¼š**

    // âœ… å£°æ˜å¼å®šä¹‰ï¼Œæ¸…æ™°å¯ç»´æŠ¤
    var workflow = new WorkflowBuilder(startExecutor)
        .AddEdge(executor1, executor2)
        .AddEdge(executor2, executor3, condition: x => x.Success)
        .Build();
    

![](https://files.mdnice.com/user/3327/39f9dccf-b55a-4c3d-ac26-aaa65919d7d4.png)

* * *

ä¸€ã€æ ¸å¿ƒæ¦‚å¿µï¼šExecutorï¼ˆæ‰§è¡Œå™¨ï¼‰
====================

ğŸ”§ ä»€ä¹ˆæ˜¯ Executorï¼Ÿ
----------------

**Executorï¼ˆæ‰§è¡Œå™¨ï¼‰** æ˜¯ Workflow ä¸­çš„**æœ€å°å·¥ä½œå•å…ƒ**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ§‘â€ğŸ­ å·¥å‚é‡Œçš„å·¥äºº

æ¯ä¸ªå·¥äººè´Ÿè´£ä¸€é“å·¥åº

ğŸ§± ä¹é«˜ç§¯æœ¨å—

æ¯ä¸ªç§¯æœ¨æœ‰ç‰¹å®šåŠŸèƒ½ï¼Œç»„åˆæˆæ•´ä½“

ğŸ”Œ ç”µè·¯ä¸­çš„å…ƒä»¶

æ¥æ”¶è¾“å…¥ä¿¡å·ï¼Œè¾“å‡ºå¤„ç†ç»“æœ

![](https://files.mdnice.com/user/3327/aa65b104-e8de-4b37-aa64-aaa48d6132d5.png)

ğŸ“Œ Executor çš„æ ¸å¿ƒç‰¹å¾
-----------------

1.  **å”¯ä¸€æ ‡è¯†ï¼ˆIdï¼‰**ï¼šæ¯ä¸ª Executor æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œç”¨äºåœ¨ Workflow ä¸­å¼•ç”¨
2.  **æ¶ˆæ¯å¤„ç†**ï¼šæ¥æ”¶ç‰¹å®šç±»å‹çš„è¾“å…¥æ¶ˆæ¯ï¼Œå¤„ç†åäº§ç”Ÿè¾“å‡ºæ¶ˆæ¯
3.  **è·¯ç”±é…ç½®**ï¼šé€šè¿‡ `ConfigureRoutes` æ–¹æ³•å®šä¹‰èƒ½å¤„ç†å“ªäº›ç±»å‹çš„æ¶ˆæ¯
4.  **çŠ¶æ€æ„ŸçŸ¥**ï¼šå¯ä»¥é€šè¿‡ `IWorkflowContext` è®¿é—®å’Œä¿®æ”¹å·¥ä½œæµçŠ¶æ€

ğŸ—ï¸ Executor çš„ç±»å‹å±‚æ¬¡
------------------

MAF æä¾›äº†å¤šç§ Executor ç±»å‹ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯éœ€æ±‚ï¼š

ç±»å‹

ç”¨é€”

ç¤ºä¾‹åœºæ™¯

`Executor<TInput>`

å¤„ç†æ¶ˆæ¯ï¼Œæ— è¿”å›å€¼

æ—¥å¿—è®°å½•ã€é€šçŸ¥å‘é€

`Executor<TInput, TOutput>`

å¤„ç†æ¶ˆæ¯ï¼Œæœ‰è¿”å›å€¼

æ•°æ®è½¬æ¢ã€AI è°ƒç”¨

`FunctionExecutor<T>`

ç”¨å§”æ‰˜å‡½æ•°å¿«é€Ÿåˆ›å»º

ç®€å•å¤„ç†é€»è¾‘

`StatefulExecutor<TState>`

éœ€è¦ç»´æŠ¤çŠ¶æ€çš„æ‰§è¡Œå™¨

ä¼šè¯ç®¡ç†ã€è®¡æ•°å™¨

ğŸ’¡ Executor æºç è§£æ
----------------

ä»æºç ä¸­å¯ä»¥çœ‹åˆ° Executor çš„æ ¸å¿ƒè®¾è®¡ï¼š

    // æ¥è‡ª Executor.cs
    public abstract class Executor : IIdentified
    {
        // å”¯ä¸€æ ‡è¯†ç¬¦
        public string Id { get; }
        
        // é…ç½®æ¶ˆæ¯è·¯ç”±ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰
        protected abstract RouteBuilder ConfigureRoutes(RouteBuilder routeBuilder);
        
        // æ‰§è¡Œæ¶ˆæ¯å¤„ç†
        public async ValueTask<object?> ExecuteAsync(
            object message, 
            TypeId messageType, 
            IWorkflowContext context, 
            CancellationToken cancellationToken = default)
        {
            // è®°å½•è°ƒç”¨äº‹ä»¶
            await context.AddEventAsync(new ExecutorInvokedEvent(this.Id, message));
            
            // è·¯ç”±æ¶ˆæ¯åˆ°æ­£ç¡®çš„å¤„ç†å™¨
            CallResult? result = await this.Router.RouteMessageAsync(message, context, ...);
            
            // è®°å½•å®Œæˆæˆ–å¤±è´¥äº‹ä»¶
            ExecutorEvent executionResult = result?.IsSuccess is not false
                ? new ExecutorCompletedEvent(this.Id, result?.Result)
                : new ExecutorFailedEvent(this.Id, result.Exception);
                
            await context.AddEventAsync(executionResult);
            return result.Result;
        }
    }
    

**å…³é”®ç‚¹**ï¼š

*   âœ… æ¯ä¸ª Executor æœ‰å”¯ä¸€ ID
*   âœ… é€šè¿‡ `ConfigureRoutes` å£°æ˜èƒ½å¤„ç†çš„æ¶ˆæ¯ç±»å‹
*   âœ… æ‰§è¡Œè¿‡ç¨‹ä¼šäº§ç”Ÿäº‹ä»¶ï¼ˆ`ExecutorInvokedEvent`ã€`ExecutorCompletedEvent` ç­‰ï¼‰

* * *

äºŒã€æ ¸å¿ƒæ¦‚å¿µï¼šEdgeï¼ˆè¾¹ï¼‰
==============

â¡ï¸ ä»€ä¹ˆæ˜¯ Edgeï¼Ÿ
------------

**Edgeï¼ˆè¾¹ï¼‰** æ˜¯è¿æ¥ä¸¤ä¸ª Executor çš„**æ¶ˆæ¯é€šé“**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ­ å·¥å‚ä¼ é€å¸¦

æŠŠä¸Šä¸€é“å·¥åºçš„äº§å“ä¼ é€åˆ°ä¸‹ä¸€é“å·¥åº

ğŸ”— æ°´ç®¡

æŠŠæ°´ä»ä¸€ä¸ªå®¹å™¨å¼•å¯¼åˆ°å¦ä¸€ä¸ªå®¹å™¨

ğŸ“¨ é‚®è·¯

æŠŠä¿¡ä»¶ä»å‘ä»¶äººé€åˆ°æ”¶ä»¶äºº

![](https://files.mdnice.com/user/3327/bb96f0fb-ff6c-44d8-8186-6943c986f5ce.png)

ğŸ“Œ Edge çš„ä¸‰ç§ç±»å‹
-------------

MAF æ”¯æŒä¸‰ç§ç±»å‹çš„ Edgeï¼Œé€‚ç”¨äºä¸åŒçš„æµç¨‹æ¨¡å¼ï¼š

![](https://files.mdnice.com/user/3327/aaa31c9e-2271-4777-aba4-da9ba0e58382.png)

ç±»å‹

è¯´æ˜

ä½¿ç”¨åœºæ™¯

**Directï¼ˆç›´è¿ï¼‰**

ä¸€å¯¹ä¸€è¿æ¥

é¡ºåºå¤„ç†æµç¨‹

**FanOutï¼ˆæ‰‡å‡ºï¼‰**

ä¸€å¯¹å¤šè¿æ¥

å¹¶è¡Œåˆ†å‘ä»»åŠ¡

**FanInï¼ˆæ‰‡å…¥ï¼‰**

å¤šå¯¹ä¸€è¿æ¥

æ±‡èšå¤šä¸ªç»“æœ

ğŸ’¡ Edge æºç è§£æ
------------

ä»æºç å¯ä»¥çœ‹åˆ° Edge çš„æ ¸å¿ƒç»“æ„ï¼š

    // æ¥è‡ª Edge.cs
    public enum EdgeKind
    {
        Direct,   // ç›´è¿ï¼šä¸€å¯¹ä¸€
        FanOut,   // æ‰‡å‡ºï¼šä¸€å¯¹å¤š
        FanIn     // æ‰‡å…¥ï¼šå¤šå¯¹ä¸€
    }
    
    public sealed class Edge
    {
        public EdgeKind Kind { get; init; }    // è¾¹çš„ç±»å‹
        public EdgeData Data { get; init; }    // è¾¹çš„å…·ä½“æ•°æ®
    }
    
    // æ¥è‡ª DirectEdgeData.cs - ç›´è¿è¾¹çš„æ•°æ®
    public sealed class DirectEdgeData : EdgeData
    {
        public string SourceId { get; }        // æº Executor ID
        public string SinkId { get; }          // ç›®æ ‡ Executor ID
        public Func<object?, bool>? Condition; // å¯é€‰çš„æ¡ä»¶åˆ¤æ–­
    }
    

**Direct Edge ç¤ºæ„å›¾**ï¼š

![](https://files.mdnice.com/user/3327/aa742609-8a85-4f6c-bc63-2cf3790a3f53.png)

**å…³é”®ç‚¹**ï¼š

*   âœ… Edge å®šä¹‰äº†æ¶ˆæ¯ä»å“ªé‡Œæ¥ã€åˆ°å“ªé‡Œå»
*   âœ… Direct Edge æ”¯æŒ**æ¡ä»¶è·¯ç”±**ï¼ˆåªæœ‰æ»¡è¶³æ¡ä»¶çš„æ¶ˆæ¯æ‰ä¼ é€’ï¼‰
*   âœ… FanOut Edge å¯ä»¥å®ç°**å¹¿æ’­**æˆ–**åˆ†åŒº**é€»è¾‘

* * *

ä¸‰ã€æ ¸å¿ƒæ¦‚å¿µï¼šWorkflowï¼ˆå·¥ä½œæµï¼‰
====================

ğŸ“‹ ä»€ä¹ˆæ˜¯ Workflowï¼Ÿ
----------------

**Workflowï¼ˆå·¥ä½œæµï¼‰** æ˜¯å°†å¤šä¸ª Executor é€šè¿‡ Edge è¿æ¥èµ·æ¥çš„**å®Œæ•´æµç¨‹å®šä¹‰**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ“‹ æµç¨‹å›¾

å®šä¹‰äº†ä»å¼€å§‹åˆ°ç»“æŸçš„å®Œæ•´æµç¨‹

ğŸ­ ç”Ÿäº§çº¿

å¤šä¸ªå·¥ä½é€šè¿‡ä¼ é€å¸¦è¿æ¥æˆå®Œæ•´ç”Ÿäº§çº¿

ğŸ¼ ä¹è°±

è§„å®šäº†æ¼”å¥çš„é¡ºåºå’ŒèŠ‚å¥

![](https://files.mdnice.com/user/3327/e79021e2-7ba8-4857-8664-d670d74e7d89.png)

ğŸ“Œ Workflow çš„æ ¸å¿ƒå±æ€§
-----------------

ä»æºç ä¸­å¯ä»¥çœ‹åˆ° Workflow çš„æ ¸å¿ƒç»“æ„ï¼š

    // æ¥è‡ª Workflow.cs
    public class Workflow
    {
        // èµ·å§‹ Executor çš„ ID
        public string StartExecutorId { get; }
        
        // å·¥ä½œæµåç§°ï¼ˆå¯é€‰ï¼‰
        public string? Name { get; internal init; }
        
        // å·¥ä½œæµæè¿°ï¼ˆå¯é€‰ï¼‰
        public string? Description { get; internal init; }
        
        // Executor ç»‘å®šå­—å…¸
        internal Dictionary<string, ExecutorBinding> ExecutorBindings { get; init; }
        
        // è¾¹çš„é›†åˆï¼ˆæŒ‰æºèŠ‚ç‚¹åˆ†ç»„ï¼‰
        internal Dictionary<string, HashSet<Edge>> Edges { get; init; }
        
        // è¾“å‡º Executor é›†åˆ
        internal HashSet<string> OutputExecutors { get; init; }
    }
    

ğŸ”¨ ä½¿ç”¨ WorkflowBuilder æ„å»ºå·¥ä½œæµ
---------------------------

MAF é‡‡ç”¨ **å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼‰** æ¥æ„å»º Workflowï¼Œè¿™ä½¿å¾—å·¥ä½œæµçš„å®šä¹‰æ›´åŠ ç›´è§‚ï¼š

    // åˆ›å»ºå·¥ä½œæµç¤ºä¾‹
    var workflow = new WorkflowBuilder(startExecutor)  // æŒ‡å®šèµ·ç‚¹
        .WithName("è®¢å•å¤„ç†å·¥ä½œæµ")                      // è®¾ç½®åç§°
        .WithDescription("å¤„ç†ç”µå•†è®¢å•çš„å®Œæ•´æµç¨‹")       // è®¾ç½®æè¿°
        .AddEdge(receiveOrder, validateOrder)           // æ·»åŠ è¾¹
        .AddEdge(validateOrder, processPayment, 
                 condition: x => x.IsValid)             // æ¡ä»¶è¾¹
        .AddEdge(processPayment, sendNotification)
        .WithOutputFrom(sendNotification)               // æŒ‡å®šè¾“å‡ºèŠ‚ç‚¹
        .Build();                                       // æ„å»ºå·¥ä½œæµ
    

![](https://files.mdnice.com/user/3327/704eac82-db13-4ba4-beb5-6b9d3c8b30e9.png)

**å…³é”®æ–¹æ³•**ï¼š

æ–¹æ³•

è¯´æ˜

`AddEdge(source, sink)`

æ·»åŠ ç›´è¿è¾¹

`AddEdge(..., condition)`

æ·»åŠ æ¡ä»¶è¾¹

`AddFanOut(source, sinks)`

æ·»åŠ æ‰‡å‡ºè¾¹

`AddFanIn(sources, sink)`

æ·»åŠ æ‰‡å…¥è¾¹

`WithOutputFrom(executor)`

æŒ‡å®šè¾“å‡ºèŠ‚ç‚¹

`BindExecutor(executor)`

ç»‘å®šå ä½ç¬¦æ‰§è¡Œå™¨

`Build()`

æ„å»ºæœ€ç»ˆçš„ Workflow

* * *

å››ã€æ ¸å¿ƒæ¦‚å¿µï¼šSuperStepï¼ˆè¶…æ­¥ï¼‰
====================

â±ï¸ ä»€ä¹ˆæ˜¯ SuperStepï¼Ÿ
-----------------

**SuperStepï¼ˆè¶…æ­¥ï¼‰** æ˜¯ Workflow æ‰§è¡Œçš„**åŸºæœ¬å¤„ç†å‘¨æœŸ**ã€‚å¯ä»¥ç±»æ¯”ä¸ºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ® æ¸¸æˆä¸­çš„"å›åˆ"

æ¯ä¸ªå›åˆå†…æ‰€æœ‰ç©å®¶åŒæ—¶è¡ŒåŠ¨

â° å·¥å‚çš„"ç­æ¬¡"

æ¯ä¸ªç­æ¬¡å†…å®Œæˆä¸€æ‰¹ä»»åŠ¡

ğŸŒŠ æµ·æµªçš„"ä¸€æ³¢"

ä¸€æ³¢æ¶ˆæ¯è¢«å¤„ç†ï¼Œç„¶åäº§ç”Ÿä¸‹ä¸€æ³¢

![](https://files.mdnice.com/user/3327/a29f83ea-1584-4b2b-a7a8-f81be1dd3567.png)

ğŸ“Œ SuperStep çš„æ‰§è¡Œæµç¨‹
------------------

æ¯ä¸ª SuperStep å†…éƒ¨æ‰§è¡Œçš„æ­¥éª¤ï¼š

![](https://files.mdnice.com/user/3327/6147f4a0-86b5-48c7-9401-34ad638867e9.png)

**å…³é”®äº‹ä»¶**ï¼š

*   `SuperStepStartedEvent`ï¼šè¶…æ­¥å¼€å§‹
*   `SuperStepCompletedEvent`ï¼šè¶…æ­¥å®Œæˆ

    // SuperStep äº‹ä»¶å®šä¹‰
    public class SuperStepEvent(int stepNumber, object? data = null) : WorkflowEvent(data)
    {
        // è¶…æ­¥çš„åºå·ï¼ˆä» 0 å¼€å§‹ï¼‰
        public int StepNumber => stepNumber;
    }
    

* * *

äº”ã€æ ¸å¿ƒæ¦‚å¿µï¼šWorkflowContextï¼ˆå·¥ä½œæµä¸Šä¸‹æ–‡ï¼‰
==============================

ğŸ“¦ ä»€ä¹ˆæ˜¯ WorkflowContextï¼Ÿ
-----------------------

**WorkflowContextï¼ˆå·¥ä½œæµä¸Šä¸‹æ–‡ï¼‰** æ˜¯ Executor æ‰§è¡Œæ—¶çš„**è¿è¡Œç¯å¢ƒ**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ› ï¸ å·¥äººçš„å·¥ä½œå°

æä¾›å·¥å…·ã€ææ–™å’Œé€šä¿¡æ¸ é“

ğŸ“ é€šä¿¡æ¢çº½

å…è®¸å„ä¸ªå·¥ä½ä¹‹é—´ä¼ é€’ä¿¡æ¯

ğŸ’¾ å…±äº«å†…å­˜

å­˜å‚¨å’Œè¯»å–çŠ¶æ€æ•°æ®

![](https://files.mdnice.com/user/3327/9c0a978e-6470-4199-9bc3-78d4bacd4e8c.png)

ğŸ“Œ IWorkflowContext æ ¸å¿ƒæ¥å£
------------------------

    // æ¥è‡ª IWorkflowContext.cs
    public interface IWorkflowContext
    {
        // æ·»åŠ å·¥ä½œæµäº‹ä»¶ï¼ˆåœ¨å½“å‰ SuperStep ç»“æŸæ—¶è§¦å‘ï¼‰
        ValueTask AddEventAsync(WorkflowEvent workflowEvent, CancellationToken cancellationToken = default);
        
        // å‘é€æ¶ˆæ¯ç»™ä¸‹æ¸¸ Executorï¼ˆåœ¨ä¸‹ä¸€ä¸ª SuperStep å¤„ç†ï¼‰
        ValueTask SendMessageAsync(object message, string? targetId, CancellationToken cancellationToken = default);
        
        // è¾“å‡ºå·¥ä½œæµç»“æœ
        ValueTask YieldOutputAsync(object output, CancellationToken cancellationToken = default);
        
        // è¯·æ±‚åœ¨å½“å‰ SuperStep ç»“æŸæ—¶åœæ­¢å·¥ä½œæµ
        ValueTask RequestHaltAsync();
        
        // è¯»å–çŠ¶æ€
        ValueTask<T?> ReadStateAsync<T>(string key, string? scopeName = null, CancellationToken cancellationToken = default);
        
        // è¯»å–æˆ–åˆå§‹åŒ–çŠ¶æ€
        ValueTask<T> ReadOrInitStateAsync<T>(string key, Func<T> initialStateFactory, string? scopeName = null, CancellationToken cancellationToken = default);
        
        // æ›´æ–°çŠ¶æ€ï¼ˆæ’é˜Ÿæ›´æ–°ï¼Œåœ¨ SuperStep ç»“æŸæ—¶åº”ç”¨ï¼‰
        ValueTask QueueStateUpdateAsync<T>(string key, T value, string? scopeName = null, CancellationToken cancellationToken = default);
    }
    

**å…³é”®ç‚¹**ï¼š

*   âœ… **æ¶ˆæ¯ä¼ é€’**ï¼šé€šè¿‡ `SendMessageAsync` åœ¨ Executor ä¹‹é—´ä¼ é€’æ¶ˆæ¯
*   âœ… **çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒè¯»å–ã€åˆå§‹åŒ–å’Œæ›´æ–°çŠ¶æ€
*   âœ… **äº‹ä»¶é€šçŸ¥**ï¼šé€šè¿‡ `AddEventAsync` å‘å‡ºäº‹ä»¶
*   âœ… **æµç¨‹æ§åˆ¶**ï¼šé€šè¿‡ `RequestHaltAsync` åœæ­¢å·¥ä½œæµ

* * *

å…­ã€æ ¸å¿ƒæ¦‚å¿µï¼šWorkflowEventï¼ˆå·¥ä½œæµäº‹ä»¶ï¼‰
===========================

ğŸ“£ ä»€ä¹ˆæ˜¯ WorkflowEventï¼Ÿ
---------------------

**WorkflowEventï¼ˆå·¥ä½œæµäº‹ä»¶ï¼‰** æ˜¯å·¥ä½œæµæ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„**é€šçŸ¥æ¶ˆæ¯**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ“¢ å¹¿æ’­é€šçŸ¥

å‘æ‰€æœ‰äººå¹¿æ’­ç³»ç»ŸçŠ¶æ€å˜åŒ–

ğŸ“ æ—¥å¿—è®°å½•

è®°å½•ç³»ç»Ÿæ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…³é”®èŠ‚ç‚¹

ğŸ”” äº‹ä»¶è®¢é˜…

å…è®¸å¤–éƒ¨ç›‘å¬å¹¶å“åº”ç‰¹å®šäº‹ä»¶

![](https://files.mdnice.com/user/3327/e0cdfd71-e011-48ff-b3e2-c725c33331a9.png)

ğŸ“Œ äº‹ä»¶åˆ†ç±»
-------

äº‹ä»¶å±‚çº§

äº‹ä»¶ç±»å‹

è¯´æ˜

**å·¥ä½œæµçº§åˆ«**

`WorkflowStartedEvent`

å·¥ä½œæµå¼€å§‹æ‰§è¡Œ

`WorkflowOutputEvent`

å·¥ä½œæµäº§ç”Ÿè¾“å‡º

`WorkflowErrorEvent`

å·¥ä½œæµå‘ç”Ÿé”™è¯¯

`WorkflowWarningEvent`

å·¥ä½œæµäº§ç”Ÿè­¦å‘Š

**è¶…æ­¥çº§åˆ«**

`SuperStepStartedEvent`

è¶…æ­¥å¼€å§‹

`SuperStepCompletedEvent`

è¶…æ­¥å®Œæˆ

**æ‰§è¡Œå™¨çº§åˆ«**

`ExecutorInvokedEvent`

Executor è¢«è°ƒç”¨

`ExecutorCompletedEvent`

Executor å®Œæˆå¤„ç†

`ExecutorFailedEvent`

Executor å¤„ç†å¤±è´¥

* * *

ä¸ƒã€æ ¸å¿ƒæ¦‚å¿µï¼šRunï¼ˆè¿è¡Œå®ä¾‹ï¼‰
================

ğŸƒ ä»€ä¹ˆæ˜¯ Runï¼Ÿ
-----------

**Runï¼ˆè¿è¡Œå®ä¾‹ï¼‰** æ˜¯ Workflow çš„**ä¸€æ¬¡å…·ä½“æ‰§è¡Œ**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ¬ ç”µå½±çš„ä¸€åœºæ”¾æ˜ 

åŒä¸€éƒ¨ç”µå½±å¯ä»¥æ”¾æ˜ å¤šåœº

ğŸ­ ç”Ÿäº§çº¿çš„ä¸€ä¸ªæ‰¹æ¬¡

åŒä¸€æ¡ç”Ÿäº§çº¿å¯ä»¥ç”Ÿäº§å¤šä¸ªæ‰¹æ¬¡

ğŸ® æ¸¸æˆçš„ä¸€å±€

åŒä¸€ä¸ªæ¸¸æˆå¯ä»¥ç©å¤šå±€

![](https://files.mdnice.com/user/3327/0001c522-eed9-4bb7-8944-e9154f479dfe.png)

ğŸ“Œ Run çš„æ ¸å¿ƒç‰¹æ€§
------------

    // æ¥è‡ª Run.cs
    public sealed class Run : IAsyncDisposable
    {
        // è¿è¡Œå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
        public string RunId => this._runHandle.RunId;
        
        // è·å–å½“å‰æ‰§è¡ŒçŠ¶æ€
        public ValueTask<RunStatus> GetStatusAsync(CancellationToken cancellationToken = default);
        
        // è·å–æ‰€æœ‰äº§ç”Ÿçš„äº‹ä»¶
        public IEnumerable<WorkflowEvent> OutgoingEvents => this._eventSink;
        
        // è·å–è‡ªä¸Šæ¬¡è®¿é—®åçš„æ–°äº‹ä»¶
        public IEnumerable<WorkflowEvent> NewEvents { get; }
        
        // æ¢å¤æ‰§è¡Œï¼ˆå¸¦å¤–éƒ¨å“åº”ï¼‰
        public async ValueTask<bool> ResumeAsync(IEnumerable<ExternalResponse> responses, CancellationToken cancellationToken = default);
    }
    

ğŸ“Œ RunStatusï¼ˆè¿è¡ŒçŠ¶æ€ï¼‰
------------------

    public enum RunStatus
    {
        NotStarted,      // å°šæœªå¼€å§‹
        Idle,            // ç©ºé—²ï¼ˆå·²æš‚åœï¼Œæ— å¾…å¤„ç†è¯·æ±‚ï¼‰
        PendingRequests, // ç­‰å¾…å¤–éƒ¨å“åº”
        Ended,           // å·²ç»“æŸ
        Running          // æ­£åœ¨è¿è¡Œ
    }
    

![](https://files.mdnice.com/user/3327/9dd5573f-6e86-4d0f-93e1-01666e988f03.png)

* * *

å…«ã€æ ¸å¿ƒæ¦‚å¿µï¼šCheckpointï¼ˆæ£€æŸ¥ç‚¹ï¼‰
======================

ğŸ’¾ ä»€ä¹ˆæ˜¯ Checkpointï¼Ÿ
------------------

**Checkpointï¼ˆæ£€æŸ¥ç‚¹ï¼‰** æ˜¯å·¥ä½œæµåœ¨æŸä¸ªæ—¶åˆ»çš„**å®Œæ•´çŠ¶æ€å¿«ç…§**ï¼Œç±»ä¼¼äºï¼š

ç±»æ¯”

è¯´æ˜

ğŸ® æ¸¸æˆå­˜æ¡£

ä¿å­˜æ¸¸æˆè¿›åº¦ï¼Œéšæ—¶å¯ä»¥è¯»æ¡£ç»§ç»­

ğŸ“¸ ç…§ç‰‡

è®°å½•æŸä¸€æ—¶åˆ»çš„å®Œæ•´çŠ¶æ€

ğŸ”– ä¹¦ç­¾

æ ‡è®°é˜…è¯»è¿›åº¦ï¼Œä¸‹æ¬¡ä»è¿™é‡Œç»§ç»­

![](https://files.mdnice.com/user/3327/fe1a85bc-369c-4ab7-9817-44e56a910cb2.png)

ğŸ“Œ Checkpoint çš„æ ¸å¿ƒä¿¡æ¯
-------------------

    // æ¥è‡ª CheckpointInfo.cs
    public sealed class CheckpointInfo
    {
        // è¿è¡Œå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
        public string RunId { get; }
        
        // æ£€æŸ¥ç‚¹çš„å”¯ä¸€æ ‡è¯†ç¬¦
        public string CheckpointId { get; }
    }
    
    // æ£€æŸ¥ç‚¹çš„å®Œæ•´æ•°æ®ï¼ˆæ¥è‡ª Checkpoint.csï¼‰
    internal sealed class Checkpoint
    {
        public int StepNumber { get; }                                    // è¶…æ­¥ç¼–å·
        public WorkflowInfo Workflow { get; }                             // å·¥ä½œæµä¿¡æ¯
        public RunnerStateData RunnerData { get; }                        // è¿è¡Œå™¨çŠ¶æ€
        public Dictionary<ScopeKey, PortableValue> StateData { get; }     // çŠ¶æ€æ•°æ®
        public Dictionary<EdgeId, PortableValue> EdgeStateData { get; }   // è¾¹çŠ¶æ€æ•°æ®
        public CheckpointInfo? Parent { get; }                            // çˆ¶æ£€æŸ¥ç‚¹
    }
    

ğŸ“Œ Checkpoint çš„ä½¿ç”¨åœºæ™¯
-------------------

åœºæ™¯

è¯´æ˜

**æ•…éšœæ¢å¤**

ç³»ç»Ÿå´©æºƒåä»æœ€è¿‘çš„æ£€æŸ¥ç‚¹æ¢å¤

**é•¿æ—¶é—´è¿è¡Œ**

åˆ†æ®µæ‰§è¡Œï¼Œæ¯æ®µç»“æŸä¿å­˜è¿›åº¦

**äººæœºäº¤äº’**

ç­‰å¾…ç”¨æˆ·è¾“å…¥æ—¶ä¿å­˜çŠ¶æ€

**è°ƒè¯•å›æ”¾**

ä»ä»»æ„æ£€æŸ¥ç‚¹é‡æ–°æ‰§è¡Œ

**ç‰ˆæœ¬åˆ†æ”¯**

ä»åŒä¸€ä¸ªæ£€æŸ¥ç‚¹åˆ›å»ºå¤šä¸ªåˆ†æ”¯æ‰§è¡Œ

![](https://files.mdnice.com/user/3327/a738e6f3-a6ed-457d-ac84-5774a33963be.png)

* * *

ä¹ã€æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾
=========

ğŸ”— æ¦‚å¿µä¹‹é—´çš„å…³ç³»
----------

è®©æˆ‘ä»¬æŠŠæ‰€æœ‰æ ¸å¿ƒæ¦‚å¿µè”ç³»èµ·æ¥ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•åä½œçš„ï¼š

![](https://files.mdnice.com/user/3327/7f1a8fae-382d-46ac-b410-b4143a4b3080.png)

ğŸ“Œ ç”Ÿå‘½å‘¨æœŸè§†è§’
---------

ä»å·¥ä½œæµçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ¥çœ‹ï¼š

![](https://files.mdnice.com/user/3327/23190ea8-91bc-4424-8d4e-7831777b4c59.png)

ğŸ“Œ æ¶ˆæ¯æµè§†è§’
--------

ä»æ¶ˆæ¯åœ¨å·¥ä½œæµä¸­çš„æµåŠ¨æ¥çœ‹ï¼š

![](https://files.mdnice.com/user/3327/cb1e4135-d345-461b-bfcc-8da838c2f242.png)

**å…³é”®ç†è§£**ï¼š

1.  **æ¶ˆæ¯é©±åŠ¨**ï¼šExecutor ä¹‹é—´é€šè¿‡æ¶ˆæ¯ä¼ é€’æ•°æ®
2.  **å¼‚æ­¥æ‰¹å¤„ç†**ï¼šåŒä¸€ SuperStep å†…çš„ Executor å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
3.  **è¾¹æ§åˆ¶æµå‘**ï¼šEdge å†³å®šæ¶ˆæ¯ä»å“ªé‡Œåˆ°å“ªé‡Œ
4.  **çŠ¶æ€éš”ç¦»**ï¼šæ¯ä¸ª SuperStep ç»“æŸæ—¶åº”ç”¨çŠ¶æ€æ›´æ–°

* * *

åã€å®é™…åº”ç”¨ç¤ºä¾‹
========

ğŸ›’ åœºæ™¯ï¼šç”µå•†è®¢å•å¤„ç†å·¥ä½œæµ
---------------

è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…åœºæ™¯æ¥ç†è§£è¿™äº›æ¦‚å¿µçš„åº”ç”¨ï¼š

![](https://files.mdnice.com/user/3327/cf7cb742-6088-4658-a99e-b2dff3e886e9.png)

ğŸ“Œ æ¦‚å¿µå¯¹åº”å…³ç³»
---------

æ¦‚å¿µ

åœ¨æ­¤åœºæ™¯ä¸­çš„ä½“ç°

**Workflow**

æ•´ä¸ªè®¢å•å¤„ç†æµç¨‹

**Executor**

æ¯ä¸ªå¤„ç†æ­¥éª¤ï¼ˆæ¥æ”¶ã€éªŒè¯ã€æ”¯ä»˜ç­‰ï¼‰

**Edge**

æ­¥éª¤ä¹‹é—´çš„è¿æ¥ï¼ˆå«æ¡ä»¶åˆ¤æ–­ï¼‰

**SuperStep**

æ¯ä¸€è½®å¤„ç†ï¼ˆå¦‚ï¼šè¶…æ­¥1å¤„ç†æ¥æ”¶ï¼Œè¶…æ­¥2å¤„ç†éªŒè¯...ï¼‰

**WorkflowContext**

æä¾›è®¢å•çŠ¶æ€è¯»å†™ã€æ¶ˆæ¯å‘é€èƒ½åŠ›

**WorkflowEvent**

æ¯ä¸ªæ­¥éª¤çš„å¼€å§‹/å®Œæˆ/å¤±è´¥äº‹ä»¶

**Run**

ä¸€ä¸ªå…·ä½“è®¢å•çš„å¤„ç†è¿‡ç¨‹

**Checkpoint**

å¤„ç†ä¸­é€”ä¿å­˜çš„çŠ¶æ€ï¼ˆå¦‚æ”¯ä»˜å®Œæˆåä¿å­˜ï¼‰

ğŸ¤– åœºæ™¯ï¼šå¤šæ™ºèƒ½ä½“åä½œå·¥ä½œæµ
---------------

åœ¨ AI Agent åœºæ™¯ä¸­ï¼ŒWorkflow å¯ä»¥ç”¨æ¥ç¼–æ’å¤šä¸ª Agent çš„åä½œï¼š

![](https://files.mdnice.com/user/3327/22fb1f31-f863-44ad-97f0-69ab7fae6afc.png)

**Workflow çš„ä¼˜åŠ¿**ï¼š

ä¼˜åŠ¿

è¯´æ˜

ğŸ”„ **çµæ´»ç¼–æ’**

å¯ä»¥è½»æ¾è°ƒæ•´ Agent ä¹‹é—´çš„åä½œå…³ç³»

ğŸ’¾ **çŠ¶æ€ç®¡ç†**

è‡ªåŠ¨ç®¡ç†å„ Agent çš„çŠ¶æ€å’Œä¸Šä¸‹æ–‡

â¸ï¸ **å¯ä¸­æ–­/æ¢å¤**

æ”¯æŒäººæœºäº¤äº’ï¼Œéšæ—¶æš‚åœå’Œæ¢å¤

ğŸ” **å¯è§‚æµ‹æ€§**

é€šè¿‡äº‹ä»¶è¿½è¸ªæ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹

ğŸ›¡ï¸ **å®¹é”™èƒ½åŠ›**

é€šè¿‡æ£€æŸ¥ç‚¹æ”¯æŒæ•…éšœæ¢å¤

* * *

åä¸€ã€æ¦‚å¿µæ€»ç»“
=======

ğŸ“š æ ¸å¿ƒæ¦‚å¿µé€ŸæŸ¥è¡¨
----------

æ¦‚å¿µ

å®šä¹‰

å…³é”®ç±»

æ ¸å¿ƒèŒè´£

**Executor**

æ‰§è¡Œå™¨/å¤„ç†èŠ‚ç‚¹

`Executor`, `Executor<T>`, `FunctionExecutor<T>`

å¤„ç†æ¶ˆæ¯ï¼Œäº§ç”Ÿè¾“å‡º

**Edge**

è¿æ¥è¾¹

`Edge`, `EdgeData`, `DirectEdgeData`

å®šä¹‰æ¶ˆæ¯æµå‘å’Œæ¡ä»¶

**Workflow**

å·¥ä½œæµå®šä¹‰

`Workflow`, `WorkflowBuilder`

ç»„ç»‡ Executor å’Œ Edge

**SuperStep**

è¶…æ­¥/æ‰¹é‡å¤„ç†å‘¨æœŸ

`SuperStepEvent`, `SuperStepStartedEvent`

æ‰¹é‡å¤„ç†æ¶ˆæ¯

**WorkflowContext**

å·¥ä½œæµä¸Šä¸‹æ–‡

`IWorkflowContext`

æä¾›è¿è¡Œæ—¶æœåŠ¡

**WorkflowEvent**

å·¥ä½œæµäº‹ä»¶

`WorkflowEvent`, `ExecutorEvent`

é€šçŸ¥æ‰§è¡ŒçŠ¶æ€

**Run**

è¿è¡Œå®ä¾‹

`Run`, `RunStatus`

ç®¡ç†ä¸€æ¬¡æ‰§è¡Œ

**Checkpoint**

æ£€æŸ¥ç‚¹

`CheckpointInfo`, `ICheckpointStore`

ä¿å­˜å’Œæ¢å¤çŠ¶æ€

ğŸ“Œ è®°å¿†å£è¯€
-------

> **"å·¥ä½œæµç¨‹è¾¹è¿æ¥ï¼Œæ‰§è¡Œå™¨æ¥åšå¤„ç†"**  
> **"è¶…æ­¥æ‰¹é‡å¾€å‰èµ°ï¼Œä¸Šä¸‹æ–‡ä¸­è¯»å†™æ€"**  
> **"äº‹ä»¶é€šçŸ¥å…¨è¿‡ç¨‹ï¼Œè¿è¡Œå®ä¾‹è·‘ä¸€æ¬¡"**  
> **"æ£€æŸ¥ç‚¹æ¥å­˜è¿›åº¦ï¼Œéšæ—¶æ¢å¤ä¸æ€•æŒ‚"**

![](https://files.cnblogs.com/files/sheng-jie/maf-course-card-scan.bmp)

> **ğŸ‘†é¢å‘.NETå¼€å‘è€…çš„AI Agent å¼€å‘è¯¾ç¨‹ã€.NET+AI | æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶ã€‘å·²ä¸Šçº¿ï¼Œæ¬¢è¿æ‰«ç åŠ å…¥å­¦ä¹ ã€‚ğŸ‘†**

![](https://files.cnblogs.com/files/sheng-jie/scan-follow.bmp)

> **å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€å‘ AI è€Œè¡Œã€ï¼Œæˆ‘ä»¬å¾®ä¿¡ä¸è§ä¸æ•£ã€‚  
> é˜…ç½¢æ­¤æ–‡ï¼Œå¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡ä¸é”™å¹¶æœ‰æ‰€æ”¶è·ï¼Œè¯·ã€æ‰“èµã€‘æˆ–ã€æ¨èã€‘ï¼Œä¹Ÿå¯ã€è¯„è®ºã€‘ç•™ä¸‹æ‚¨çš„é—®é¢˜æˆ–å»ºè®®ä¸æˆ‘äº¤æµã€‚ ä½ çš„æ”¯æŒæ˜¯æˆ‘ä¸æ–­åˆ›ä½œå’Œåˆ†äº«çš„ä¸ç«­åŠ¨åŠ›ï¼**

ä½œè€…ï¼š[ã€åœ£æ°ã€](http://www.jianshu.com/u/39ec0e6b1844)

å‡ºå¤„ï¼š[http://www.cnblogs.com/sheng-jie/](http://www.cnblogs.com/sheng-jie/)

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚