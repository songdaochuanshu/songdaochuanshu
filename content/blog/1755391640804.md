---
layout: post
title: '【渲染流水线】[几何阶段]-[图元装配]以UnityURP为例'
date: "2025-08-17T00:47:20Z"
---
【渲染流水线】\[几何阶段\]-\[图元装配\]以UnityURP为例
===================================

![【渲染流水线】[几何阶段]-[图元装配]以UnityURP为例](https://img2024.cnblogs.com/blog/3685400/202508/3685400-20250815222430490-1532261579.png) 本文介绍了Unity URP渲染管线中的图元装配过程，重点解析了几何图元（三角形、线段等）的组装原理与实现方式。文章详细说明了通过MeshTopology和索引缓冲区定义图元类型的方法，包括三角形、三角形条带等五种图元及其连接规则，特别强调了顶点缠绕顺序对表面剔除的影响。同时，提供了URP中不同图元类型的代码实现示例，并指出底层实现的关键文件和调试方法。最后指出可通过继承ScriptableRendererFeature实现自定义几何处理，为开发者探索URP渲染管线提供了实践指导。

图元装配负责将离散顶点组装成完整几何图元（如点、线、三角形、三角形条带）

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

**输入数据**‌
=========

接收‌**顶点着色器输出的离散顶点数据**‌，包括：

*   变换后的空间坐标（如裁剪空间位置）
*   顶点属性（颜色、法线、纹理坐标等

**输出数据**‌
=========

生成‌**完整几何图元**‌（Primitive），例如：

*   三角形（`GL_TRIANGLES`）
*   线段（`GL_LINES`）
*   点（`GL_POINTS`）‌

在Unity中，图元装配的实现
===============

主要通过‌**网格拓扑（Mesh Topology）**‌和‌**索引缓冲区（Index Buffer）**‌完成。

**顶点分组模式‌**
-----------

1.  ‌**索引分组模式**‌通过索引数组（如`Mesh.triangles`或`Mesh.GetIndices()`）定义顶点连接顺序，每个索引指向顶点缓冲区中的位置，按预设拓扑规则分组‌。例如：
    
        text
        索引数组 [0,1,2,3,4,5]
        三角形拓扑 → 分组为△(0,1,2)和△(3,4,5)
        
    
2.  ‌**顺序分组模式**‌无索引时直接按顶点提交顺序分组（如连续3顶点构成一个三角形）‌。
    

* * *

**‌Unity支持的图元类型‌**
------------------

‌**图元类型**‌

‌**描述**‌

三角形（`Triangles`）

每3个独立顶点构成一个三角形，默认用于3D模型渲染‌。

三角形条带（`TriangleStrip`）

复用前2顶点与当前顶点生成新三角形，减少顶点重复提交‌。

四边形（`Quads`）

每4顶点构成一个四边形（实际渲染时拆分为2个三角形）。

线段（`Lines`）

每2顶点构成一条线段，用于线框渲染‌。

点（`Points`）

每个顶点独立渲染为屏幕上的点‌。

* * *

**‌拓扑连接规则‌**
------------

1.  ‌**缠绕顺序（Winding Order）**‌Unity默认使用‌**顺时针顺序**‌判定三角形正面，逆时针面会被剔除‌。例如：
    *   顶点顺序`(v1,v2,v3)`为顺时针 → 可见
    *   顺序`(v1,v3,v2)`为逆时针 → 剔除‌。
2.  ‌**共享顶点优化**‌索引数组可复用顶点（如`[0,1,2,1,2,3]`生成两个共享边`(1,2)`的三角形）。

* * *

**‌关键实现接口‌**
------------

1.  ‌**设置拓扑类型**‌通过`MeshTopology`枚举指定图元类型（如`MeshTopology.Triangles`）‌。
2.  ‌**索引缓冲区操作**‌
    *   `Mesh.SetIndices()`：自定义索引分组规则
    *   `Mesh.triangles`：直接设置三角形索引（旧API，效率较低）‌

URP中对图元装配的调用位置与示例
=================

在Unity URP (Universal Render Pipeline) 中，几何阶段的图元装配是由底层渲染管线自动处理的，主要通过`ScriptableRenderContext`和`CommandBuffer`系统完成。

**‌核心类与调用流程‌**
--------------

*   ‌**UniversalRenderPipeline.RenderSingleCamera**‌入口点，通过`ScriptableRenderContext`提交绘制命令
*   ‌**ScriptableRenderContext.DrawRenderers**‌触发几何处理，最终调用底层图形API (如OpenGL/D3D)
*   ‌**CommandBuffer.DrawProcedural**‌直接控制图元装配（手动模式）

* * *

图元装配示例代码‌
---------

以下是不同图元类型的装配方式示例：

### 三角形 (Triangles)‌

    csharp
    // 通过MeshFilter自动装配var meshFilter = GetComponent<MeshFilter>();
    Graphics.DrawMesh(meshFilter.sharedMesh, transform.position, transform.rotation, material, 0);
    

### 三角形带 (Triangle Strip)‌

    csharp
    // 手动通过CommandBuffer装配
    CommandBuffer cmd = new CommandBuffer();
    cmd.DrawProcedural(
        Matrix4x4.identity,
        material,
        0,
        MeshTopology.TriangleStrip,
        vertexCount: 4// 需要至少4个顶点形成2个三角形
    );
    context.ExecuteCommandBuffer(cmd);
    

### 四边形 (Quads)‌

    csharp
    // URP中四边形会被拆分为三角形处理
    Mesh quadMesh = new Mesh();
    quadMesh.vertices = new Vector3[] {/* 4个顶点 */ };
    quadMesh.SetIndices(new int[] {0,1,2, 0,2,3}, MeshTopology.Triangles, 0);
    Graphics.DrawMesh(quadMesh, Matrix4x4.identity, material, 0);
    

### 线段 (Lines)‌

    csharp
    // 使用GL.LINES或LineRenderer组件
    CommandBuffer cmd = new CommandBuffer();
    cmd.DrawProcedural(
        Matrix4x4.identity,
        lineMaterial,
        0,
        MeshTopology.Lines,
        vertexCount: 2
    );
    

### 点 (Points)‌

    csharp
    // 使用MeshTopology.Points
    CommandBuffer cmd = new CommandBuffer();
    cmd.DrawProcedural(
        Matrix4x4.identity,
        pointMaterial,
        0,
        MeshTopology.Points,
        vertexCount: 1
    );
    

* * *

底层实现位置‌
-------

*   ‌**URP源码关键文件**‌:`UniversalRenderPipelineCore.cs` → `ExecuteRenderPass`方法`ScriptableRenderer.cs` → `EnqueuePass`提交绘制命令
*   ‌**Shader支持**‌:在Shader中需声明正确的`#pragma target`和几何着色器（如需要）

* * *

调试
--

1.  使用`Frame Debugger`查看实际提交的图元类型
2.  在URP设置中启用`Native Rendering Debugger`
3.  检查材质的`Render Queue`和`Shader Pass`设置

更深入的管线定制，可继承`ScriptableRendererFeature`实现自定义几何处理。

* * *

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

（欢迎_点赞留言_探讨，更多人加入进来能更加完善这个探索的过程，🙏）