---
layout: post
title: 'å. Redis äº‹åŠ¡å’Œ â€œé”æœºåˆ¶â€â€”â€”> å¹¶å‘ç§’æ€å¤„ç†çš„è¯¦ç»†è¯´æ˜'
date: "2025-02-06T00:35:57Z"
---
å. Redis äº‹åŠ¡å’Œ â€œé”æœºåˆ¶â€â€”â€”> å¹¶å‘ç§’æ€å¤„ç†çš„è¯¦ç»†è¯´æ˜
=================================

å. Redis äº‹åŠ¡å’Œ â€œé”æœºåˆ¶â€â€”â€”> å¹¶å‘ç§’æ€å¤„ç†çš„è¯¦ç»†è¯´æ˜
=================================

@

ç›®å½•

*   [å. Redis äº‹åŠ¡å’Œ â€œé”æœºåˆ¶â€â€”â€”> å¹¶å‘ç§’æ€å¤„ç†çš„è¯¦ç»†è¯´æ˜](#å-redis-äº‹åŠ¡å’Œ-é”æœºåˆ¶-å¹¶å‘ç§’æ€å¤„ç†çš„è¯¦ç»†è¯´æ˜)
*   [1\. Redis çš„äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ](#1--redis-çš„äº‹åŠ¡æ˜¯ä»€ä¹ˆ)
*   [2\. Redis äº‹åŠ¡ä¸‰ç‰¹æ€§](#2-redis-äº‹åŠ¡ä¸‰ç‰¹æ€§)
*   [3\. Redis å…³äºäº‹åŠ¡ç›¸å…³æŒ‡ä»¤ Multiã€Execã€discardå’Œ â€œwatch & unwatchâ€](#3-redis-å…³äºäº‹åŠ¡ç›¸å…³æŒ‡ä»¤-multiexecdiscardå’Œ-watch-----unwatch)
    *   [3.1 å¿«é€Ÿå…¥é—¨(æ¼”ç¤º Redis äº‹åŠ¡æ§åˆ¶)](#31-å¿«é€Ÿå…¥é—¨æ¼”ç¤º-redis-äº‹åŠ¡æ§åˆ¶)
    *   [3.2 æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚](#32-æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚)
*   [4\. Redis äº‹åŠ¡å†²çªåŠè§£å†³æ–¹æ¡ˆ(æ‚²è§‚é”ï¼Œä¹è§‚é”) watch & unwatch](#4-redis-äº‹åŠ¡å†²çªåŠè§£å†³æ–¹æ¡ˆæ‚²è§‚é”ä¹è§‚é”-watch-----unwatch)
    *   [4.1 â€œæ‚²è§‚é”â€ è§£å†³](#41-æ‚²è§‚é”-è§£å†³)
    *   [4.2 â€œä¹è§‚é”â€ è§£å†³](#42-ä¹è§‚é”-è§£å†³)
    *   [4.3 watch & unwatch](#43-watch-----unwatch)
*   [5\. æ¡ˆä¾‹æ¼”ç¤ºï¼šç«è½¦ç¥¨-æŠ¢ç¥¨(è§£å†³è¶…å–ï¼Œåº“å­˜é—ç•™)é—®é¢˜](#5-æ¡ˆä¾‹æ¼”ç¤ºç«è½¦ç¥¨-æŠ¢ç¥¨è§£å†³è¶…å–åº“å­˜é—ç•™é—®é¢˜)
    *   [5.1 æ¡ˆä¾‹æ€è·¯åˆ†æï¼š](#51-æ¡ˆä¾‹æ€è·¯åˆ†æ)
    *   [5.2 å®ŒæˆåŸºæœ¬è´­ç¥¨æµç¨‹ï¼Œæš‚ä¸è€ƒè™‘äº‹åŠ¡å’Œå¹¶å‘é—®é¢˜](#52-å®ŒæˆåŸºæœ¬è´­ç¥¨æµç¨‹æš‚ä¸è€ƒè™‘äº‹åŠ¡å’Œå¹¶å‘é—®é¢˜)
    *   [5.3 æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿï¼Œå‡ºç°è¶…å–é—®é¢˜](#53-æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿå‡ºç°è¶…å–é—®é¢˜)
    *   [5.4 Redis è¿æ¥æ± æŠ€æœ¯](#54-redis-è¿æ¥æ± æŠ€æœ¯)
    *   [5.5 åˆ©ç”¨ Redis çš„äº‹åŠ¡æœºåˆ¶ï¼Œè§£å†³è¶…å–é—®é¢˜(ä½¿ç”¨ watch,multi )](#55-åˆ©ç”¨-redis-çš„äº‹åŠ¡æœºåˆ¶è§£å†³è¶…å–é—®é¢˜ä½¿ç”¨-watchmulti-)
    *   [5.6 æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿï¼Œåˆ†æå‡ºç°åº“å­˜é—ç•™é—®é¢˜](#56-æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿåˆ†æå‡ºç°åº“å­˜é—ç•™é—®é¢˜)
    *   [5.7 è¿ç”¨ LUA è„šæœ¬(è§£å†³è¶…å–ï¼Œå’Œåº“å­˜é—ç•™é—®é¢˜)](#57-è¿ç”¨-lua-è„šæœ¬è§£å†³è¶…å–å’Œåº“å­˜é—ç•™é—®é¢˜)
*   [6\. æœ€åï¼š](#6-æœ€å)

1\. Redis çš„äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ
=================

1.  Redis äº‹åŠ¡æ—¶ä¸€ä¸ª**å•ç‹¬çš„éš”ç¦»æ“ä½œ** ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ï¼ŒæŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚
2.  äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ï¼Œä¸­åœã€‚
3.  Redis äº‹åŠ¡çš„ä¸»è¦ä½œç”¨å°±æ˜¯**ä¸²è”** å¤šä¸ªå‘½ä»¤é˜²æ­¢åˆ«çš„å‘½ä»¤**æ’é˜Ÿ** ã€‚

2\. Redis äº‹åŠ¡ä¸‰ç‰¹æ€§
===============

1.  **å•ç‹¬çš„éš”ç¦»æ“ä½œï¼š**

> 1.  Redis äº‹åŠ¡æ—¶ä¸€ä¸ª**å•ç‹¬çš„éš”ç¦»æ“ä½œ** ï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ï¼ŒæŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚
> 2.  äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ï¼Œä¸­åœã€‚

2.  **æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µï¼š**

> é˜Ÿåˆ—ä¸­çš„å‘½ä»¤(æŒ‡ä»¤)ï¼Œåœ¨æ²¡æœ‰æäº¤å‰éƒ½ä¸ä¼šå®é™…è¢«æ‰§è¡Œã€‚

3.  **ä¸ä¿è¯åŸå­æ€§ï¼š**

> äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰æŒ‡ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶ä»–çš„æŒ‡ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œ**æ²¡æœ‰å›æ»š** ã€‚
> 
> **MySQLä¸­çš„äº‹åŠ¡æ˜¯æ”¯æŒå›æ»šçš„ï¼Œè€Œ Redis ä¸­çš„äº‹åŠ¡æ˜¯ä¸æ”¯æŒå›æ»šçš„ã€‚**

3\. Redis å…³äºäº‹åŠ¡ç›¸å…³æŒ‡ä»¤ Multiã€Execã€discardå’Œ â€œwatch & unwatchâ€
========================================================

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542626-198868970.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542686-1923425859.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542517-2144818928.png)
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542892-646912047.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542753-314798000.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542574-602289357.png)

**Redis äº‹åŠ¡æŒ‡ä»¤ç¤ºæ„å›¾ï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542644-383068154.png)

**ä¸Šå›¾è§£è¯»ï¼š**

> 1.  ä»è¾“å…¥ `multi` å‘½ä»¤å¼€å§‹ï¼Œè¾“å…¥çš„å‘½ä»¤éƒ½ä¼š**ä¾æ¬¡**è¿›å…¥**å‘½ä»¤é˜Ÿåˆ—** ä¸­ï¼Œä½†ä¸ä¼šæ‰§è¡Œç±»ä¼¼(MySQLçš„ start transaction å¼€å§‹äº‹åŠ¡)ã€‚
> 2.  è¾“å…¥ `Exec` å‘½ä»¤åï¼ŒRedis ä¼šå°†ä¹‹å‰çš„å‘½ä»¤é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¾æ¬¡æ‰§è¡Œ(ç±»ä¼¼äº MySQLçš„ commit æäº¤äº‹åŠ¡)ã€‚
> 3.  ç»„é˜Ÿçš„è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡ `discard` æ¥æ”¾å¼ƒç»„é˜Ÿ(ç±»ä¼¼ MySQLçš„ rollback å›æ»šäº‹åŠ¡)
> 4.  è¯´æ˜ï¼š**Redis äº‹åŠ¡å’Œ MySQL äº‹åŠ¡æœ¬è´¨æ˜¯å®Œå…¨ä¸åŒçš„ã€‚** â€”â€”> **MySQLä¸­çš„äº‹åŠ¡æ˜¯æ”¯æŒå›æ»šçš„ï¼Œè€Œ Redis ä¸­çš„äº‹åŠ¡æ˜¯ä¸æ”¯æŒå›æ»šçš„ã€‚**

3.1 å¿«é€Ÿå…¥é—¨(æ¼”ç¤º Redis äº‹åŠ¡æ§åˆ¶)
-----------------------

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542654-1974137990.png)

    127.0.0.1:6379> multi
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542684-162812350.png)

    127.0.0.1:6379(TX)> set k1 v1
    QUEUED
    127.0.0.1:6379(TX)> set k2 v2
    QUEUED
    127.0.0.1:6379(TX)> set k3 v3
    QUEUED
    127.0.0.1:6379(TX)> 
    
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542780-351805217.png)

    127.0.0.1:6379(TX)> exec
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542675-1311609932.png)

3.2 æ³¨æ„äº‹é¡¹å’Œç»†èŠ‚
-----------

1.  ç»„é˜Ÿçš„è¿‡ç¨‹ä¸­, å¯ä»¥é€šè¿‡ `discard` æ¥æ”¾å¼ƒç»„é˜Ÿã€‚æ³¨æ„æ˜¯åœ¨ `[TX]` é˜Ÿåˆ—å½“ä¸­ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œ `exce` å‘½ä»¤ä¹‹å‰ï¼Œæ‰æœ‰æ•ˆã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542761-2065470154.png)

    127.0.0.1:6379(TX)> discard
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542611-1751946793.png)

2.  **å¦‚æœåœ¨ç»„é˜Ÿé˜¶æ®µæŠ¥é”™(è¿™é‡Œçš„æŠ¥é”™ä¿¡æ¯æŒ‡çš„æ˜¯ï¼Œå‘½ä»¤è¾“å…¥é”™è¯¯ï¼Œè¯­æ³•é”™è¯¯ï¼Œç¼–è¯‘ä¸Šçš„é”™è¯¯) ä¼šå¯¼è‡´ exec å¤±è´¥ é‚£ä¹ˆäº‹åŠ¡çš„æ‰€æœ‰æŒ‡ä»¤éƒ½ä¸ä¼šè¢«æ‰§è¡Œ**ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542587-1807129262.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542715-1505610826.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543134-77587121.png)

3.  **å¦‚æœç»„é˜ŸæˆåŠŸ(`multii` ), ä½†æ˜¯æŒ‡ä»¤æœ‰ä¸èƒ½æ­£å¸¸æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆ `exec` æäº¤ï¼Œä¼šå‡ºç°æœ‰æˆåŠŸæœ‰å¤±è´¥æƒ…å†µ,ä¹Ÿå°±æ˜¯äº‹åŠ¡å¾—åˆ°éƒ¨åˆ†æ‰§è¡Œ, è¿™ç§æƒ…å†µä¸‹, Redis äº‹åŠ¡ä¸å…·å¤‡åŸå­æ€§ã€‚**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543186-1078525252.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543511-126628099.png)

    127.0.0.1:6379> multi
    OK
    127.0.0.1:6379(TX)> set k1 "v1"
    QUEUED
    127.0.0.1:6379(TX)> incr k1
    QUEUED
    127.0.0.1:6379(TX)> set k2 "v2"
    QUEUED
    127.0.0.1:6379(TX)> exec
    1) OK
    2) (error) ERR value is not an integer or out of range
    3) OK
    127.0.0.1:6379> 
    
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543367-131575721.png)

4\. Redis äº‹åŠ¡å†²çªåŠè§£å†³æ–¹æ¡ˆ(æ‚²è§‚é”ï¼Œä¹è§‚é”) watch & unwatch
============================================

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªç»å…¸çš„**æŠ¢ç¥¨** é—®é¢˜ã€‚

> 1.  ä¸€ä¸ªè¯·æ±‚(ç”¨æˆ·)æƒ³è´­ä¹° 6 å¼ ç¥¨
> 2.  ä¸€ä¸ªè¯·æ±‚(ç”¨æˆ·)æƒ³è´­ä¹° 5 å¼ ç¥¨
> 3.  ä¸€ä¸ªè¯·æ±‚(ç”¨æˆ·)æƒ³è´­ä¹° 1 å¼ ç¥¨

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543108-675525834.png)

**ä¸Šè¿°è§£å›¾ï¼š**

> ä¸€å…±åªæœ‰10å¼ ç¥¨ï¼Œä½†æ˜¯å¹¶å‘å¼€å§‹ï¼Œä¸‰ä¸ªç”¨æˆ·(ä¸‰ä¸ªè¯·æ±‚)ï¼Œä¹° 6 å¼ ï¼Œä¹° 5 å¼ ï¼Œä¹° 1 å¼ ç¥¨çš„ã€‚åŒæ—¶è¿›å…¥è´­ç¥¨ç³»ç»Ÿï¼Œå¹¶å‘åŒæ—¶åˆ»è¿›å…¥åˆ¤æ–­ï¼Œéƒ½æ˜¾ç¤ºè¿˜å‰©10å¼ ç¥¨(è¿˜æ²¡æœ‰å‡)ï¼Œæœ€åæ‰§è¡Œå‡ç¥¨ï¼Œè¶…å–äº† 2å¼ ç¥¨ã€‚

4.1 â€œæ‚²è§‚é”â€ è§£å†³
------------

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543074-694908745.png)

**ä¸Šå›¾è§£å›¾ï¼š**

> 1.  æ‚²è§‚é”(Pessimistic Lock), é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ã€‚
> 2.  è¿™æ ·åˆ«äºº/å…¶ä»–è¯·æ±‚æƒ³è¦æ‹¿åˆ°è¿™ä¸ªæ•°æ®éƒ½ä¼šè¢«(block é”ä¸Šï¼Œå› ä¸ºè¢«é”äº†å°±æ— æ³•ä¿®æ”¹/æ‹¿åˆ°æ•°æ®äº†)ï¼Œåªæœ‰ç›´åˆ°åœ¨ä»–å‰é¢çš„äººæ‹¿åˆ°æ•°æ®/ä¿®æ”¹æ•°æ®åï¼Œå°†é”é‡Šæ”¾äº†ï¼Œå®ƒæ‰èƒ½å°†æ•°æ®æ‹¿åˆ°ã€‚
> 3.  æ‚²è§‚é”æ˜¯**é”è®¾è®¡ç†å¿µ** ï¼Œä¼ ç»Ÿçš„å…³ç³»å‹æ•°æ®åº“é‡Œé¢å°±ç”¨åˆ°äº†å¾ˆå¤šè¿™ç§é”æœºåˆ¶ï¼Œæ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ï¼Œè¯»é”ï¼Œå†™é”ç­‰ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”(é˜²æ­¢è¢«å…¶ä»–çš„äºº/è¯·æ±‚æ“ä½œï¼Œä¿®æ”¹äº†æ•°æ®ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚)

4.2 â€œä¹è§‚é”â€ è§£å†³
------------

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542678-1045615241.png)

**ä¸Šå›¾è§£è¯»ï¼š**

> 1.  ä¹è§‚é”(Optimistic Lock), é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆä¹è§‚ï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ã€‚
> 2.  ä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹ï¼Œåœ¨æ­¤æœŸé—´åˆ«äºº/è¯·æ±‚æ˜¯å¦æœ‰å»æ›´æ–°äº†è¿™ä¸ªæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ç‰ˆæœ¬å·ç­‰æœºåˆ¶ã€‚ç‰ˆæœ¬å·æœºåˆ¶ï¼šå°±æ˜¯å½“è¿™ä¸ªæ•°æ®è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿä¸€ä¸ªç‰ˆæœ¬ä¿¡æ¯ï¼Œå¦‚æœè¿™ä¸ªç‰ˆæœ¬ä¿¡æ¯ï¼Œä¸ä½ ä¸€å¼€å§‹å¯¹åº”ï¼Œå¹¶åº”è¯¥è·å–çš„ç‰ˆæœ¬ä¿¡æ¯ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±ä¿®æ”¹å¤±è´¥/æ— æ³•ä¿®æ”¹æ•°æ®(æˆ–è€…è¯´è·å–çš„ç‰ˆæœ¬ä¿¡æ¯ä¸ä¸€è‡´ï¼Œæ‹¿ä¸åˆ°è¯¥æ•°æ®ä¿¡æ¯)
> 3.  ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜ååé‡ã€‚ Redis å°±æ˜¯åˆ©ç”¨è¿™ç§ `check-and-set` æœºåˆ¶å®ç°äº‹åŠ¡çš„ã€‚
> 4.  ä¹è§‚é”æ˜¯é”è®¾è®¡ç†å¿µã€‚

4.3 watch & unwatch
-------------------

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542952-1228093605.png)

1.  åŸºæœ¬è¯­æ³•: `watch key [key ...]`
2.  åœ¨æ‰§è¡Œ `multi` ä¹‹å‰ï¼Œå…ˆæ‰§è¡Œ watch key1 \[key2\]ï¼Œå¯ä»¥ç›‘è§†ä¸€ä¸ª(æˆ–å¤šä¸ª) keyï¼Œ**å¦‚æœåœ¨äº‹åŠ¡æ‰§è¡Œä¹‹å‰è¿™ä¸ª(æˆ–è¿™äº›) key è¢«å…¶ä»–å‘½ä»¤æ‰€æ”¹åŠ¨è¿‡ï¼Œé‚£ä¹ˆäº‹åŠ¡å°†è¢«æ‰“æ–­ï¼Œåœæ­¢æ‰§è¡Œ** ã€‚
3.  è¿™é‡Œå°±å¯ä»¥ç»“åˆä¹è§‚é”æœºåˆ¶è¿›è¡Œç†è§£ã€‚

**æ¼”ç¤ºå®æ“ï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543430-1848789230.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543393-319516988.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543137-1355542522.png)

>     # A è¿æ¥
>     127.0.0.1:6379> watch k1
>     OK
>     127.0.0.1:6379> multi
>     OK
>     127.0.0.1:6379(TX)> incrby k1 1
>     QUEUED
>     127.0.0.1:6379(TX)> exec
>     1) (integer) 100
>     127.0.0.1:6379> get k1
>     "100"
>     
>     
> 
>     # B è¿æ¥
>     127.0.0.1:6379> watch k1
>     OK
>     127.0.0.1:6379> multi
>     OK
>     127.0.0.1:6379(TX)> incrby k1 100
>     QUEUED
>     127.0.0.1:6379(TX)> exec
>     (nil)
>     127.0.0.1:6379> get k1
>     "100"
>     127.0.0.1:6379> 
>     

* * *

**unwatchï¼š**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543376-754491985.png)

1.  `unwatch` ï¼š å–æ¶ˆ watch å‘½ä»¤å¯¹æ‰€æœ‰ key çš„ç›‘è§†ã€‚
2.  å¦‚æœåœ¨æ‰§è¡Œ watch å‘½ä»¤åï¼Œ `exec` å‘½ä»¤å’Œ `discard` å‘½ä»¤å…ˆè¢«æ‰§è¡Œäº†çš„è¯ï¼Œé‚£ä¹ˆä¹…ä¸éœ€è¦å†æ‰§è¡Œ `unwatch` äº†ã€‚

5\. æ¡ˆä¾‹æ¼”ç¤ºï¼šç«è½¦ç¥¨-æŠ¢ç¥¨(è§£å†³è¶…å–ï¼Œåº“å­˜é—ç•™)é—®é¢˜
============================

5.1 æ¡ˆä¾‹æ€è·¯åˆ†æï¼š
-----------

**è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ WEB é¡¹ç›®æ¥æ¼”ç¤º**

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542955-1552899061.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543055-1664862787.png)

**æ€è·¯åˆ†æï¼š**

1.  ä¸€ä¸ª user åªèƒ½è´­ä¹°ä¸€å¼ ç¥¨ï¼Œå³ä¸èƒ½å¤è´­ã€‚
2.  ä¸èƒ½å‡ºç°è¶…è´­ï¼Œä¹Ÿå°±æ˜¯å¤šå–çš„æƒ…å†µã€‚
3.  ä¸èƒ½å‡ºç°ç«è½¦ç¥¨é—ç•™é—®é¢˜/åº“å­˜é—ç•™ï¼Œå³ç«è½¦ç¥¨ä¸èƒ½ç•™ä¸‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543205-1017085221.png)

5.2 å®ŒæˆåŸºæœ¬è´­ç¥¨æµç¨‹ï¼Œæš‚ä¸è€ƒè™‘äº‹åŠ¡å’Œå¹¶å‘é—®é¢˜
------------------------

1.  åˆ›å»º Java Web é¡¹ç›®, å‚ç…§ä»¥å‰è®²è¿‡æ­å»º Java Web é¡¹ç›®æµç¨‹å³å¯
2.  å¼•å…¥ç›¸å…³çš„ jar åŒ… å’Œ jquery
3.  åˆ›å»º D:sec\_kill\_ticket\\web\\index.jsp

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543030-1935397556.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542584-551231363.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542720-708848094.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542779-1730112504.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542622-1466563723.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543141-1398311143.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542883-38878093.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542693-253897196.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542745-704937860.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542784-165446251.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542889-1062929468.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542793-341307170.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542741-1895872743.png)

index.jsp ä»£ç ç¼–å†™

    <%--
      Created by IntelliJ IDEA.
      User: éŸ©é¡ºå¹³
      Version: 1.0
    --%>
    <%@ page language="java" contentType="text/html; charset=UTF-8"
             pageEncoding="UTF-8" %>
    <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
    <html>
    <head>
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <title>Insert title here</title>
      <base href="<%=request.getContextPath() + "/"%>">
    </head>
    <body>
    <h1>åŒ—äº¬-æˆéƒ½ ç«è½¦ç¥¨ ! ç§’æ€ï¼
    </h1>
    
    
    <form id="secKillform" action="secKillServlet" enctype="application/x-www-form-urlencoded">
      <input type="hidden" id="ticketNo" name="ticketNo" value="bj_cd">
      <input type="button" id="seckillBtn" name="seckillBtn" value="ç§’æ€ç«è½¦ç¥¨ã€åŒ—äº¬-æˆéƒ½ã€‘"/>
    </form>
    
    </body>
    <script type="text/javascript" src="script/jquery/jquery-3.1.0.js"></script>
    <script type="text/javascript">
      $(function () {
        $("#seckillBtn").click(function () {
          var url = $("#secKillform").attr("action");
          console.log("url->" , url)// secKillServlet,å®Œæ•´çš„url http://localhost:8080/seckill/secKillServlet
          console.log("serialize->", $("#secKillform").serialize())
          //
          $.post(url, $("#secKillform").serialize(), function (data) {
            if (data == "false") {
              alert("ç«è½¦ç¥¨ æŠ¢å…‰äº†:)");
              $("#seckillBtn").attr("disabled", true);
            }
          });
        })
      })
    </script>
    </html>
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542678-958825322.png)

    package com.rainbowsea.seckill.redis;
    
    
    import org.junit.Test;
    import redis.clients.jedis.Jedis;
    
    /**
     * ç§’æ€ç±»
     */
    public class SecKillRedis {
        /**
         * ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•-çœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè¿é€šæŒ‡å®šçš„ Redis
         */
    
        @Test
        public void testRedis() {
            Jedis jedis = new Jedis("192.168.76.146", 6379);
            jedis.auth("rainbowsea");  // è®¾ç½®äº†å¯†ç ï¼Œéœ€è¦è¿›è¡Œä¸€ä¸ªéªŒè¯
            System.out.println(jedis.ping());
            jedis.close(); // å…³é—­è¿æ¥
    
        }
    }
    
    

> å…³äºæ›´å¤šå¯¹åº”ï¼šJavaç¨‹åºè¿æ¥ Redis çš„å†…å®¹ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥è‡³ï¼šğŸŒŸğŸŒŸğŸŒŸ [https://blog.csdn.net/weixin\_61635597/article/details/145433348?spm=1001.2014.3001.5501](https://blog.csdn.net/weixin_61635597/article/details/145433348?spm=1001.2014.3001.5501)

ç¼–å†™ï¼šç§’æ€è¿‡ç¨‹

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542673-561500479.png)

    package com.rainbowsea.seckill.redis;
    
    
    import org.junit.Test;
    import redis.clients.jedis.Jedis;
    
    /**
     * ç§’æ€ç±»
     */
    public class SecKillRedis {
        /**
         * ç§’æ€è¿‡ç¨‹
         *
         * @param uid      ç”¨æˆ·ID
         * @param ticketNo ç¥¨çš„ç¼–å·ï¼Œæ¯”å¦‚ åŒ—äº¬-æˆéƒ½çš„ ticketNoä¸º bj_cd
         * @return
         */
        public static boolean doSecKill(String uid, String ticketNo) {
            // -uid å’Œ ticketNo è¿›è¡Œä¸€ä¸ªéç©ºæ ¡éªŒ
            if (uid == null || ticketNo == null) {
                return false;
            }
    
    
            // - è¿æ¥ Redis ï¼Œå¾—åˆ°ä¸€ä¸ª jedis å¯¹è±¡
            Jedis jedis = new Jedis("192.168.76.146", 6379);
            jedis.auth("rainbowsea");  // è®¾ç½®äº†å¯†ç ï¼Œéœ€è¦è¿›è¡Œä¸€ä¸ªéªŒè¯
    
            // åˆ¤æ–­ è·å–çš„jedis æ˜¯å¦ä¸ºç©º
            if (jedis == null) {
                return false;
            }
    
            // æ‹¼æ¥ç¥¨çš„åº“å­˜ key
            String stockKey = "sk:" + ticketNo + ":ticket";
    
            // æ‹¼æ¥ç§’æ€ç”¨æˆ·è¦å­˜æ”¾åˆ° set é›†åˆå¯¹åº”çš„keyï¼Œè¿™ä¸ª set é›†åˆå¯ä»¥å­˜æ”¾å¤šä¸ª userId(åŒæ—¶seté›†åˆæœ‰ç€ä¸å¯é‡å¤çš„ç‰¹æ€§ï¼Œç¬¦åˆæˆ‘ä»¬ç”¨æˆ·ä¸å¤Ÿå¤è´­çš„ç‰¹ç‚¹)
            String userKey = "sk:" + ticketNo + "user";
    
            // è·å–åˆ°å¯¹åº”çš„ç¥¨çš„åº“å­˜
            String stock = jedis.get(stockKey);
            // è·å–åˆ°å¯¹åº”çš„ç¥¨çš„åº“å­˜ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º null
            if (stock == null) {
                System.out.println("ç§’æ€è¿˜æ²¡æœ‰å¼€å§‹ï¼Œè¯·ç­‰å¾…...");
                jedis.close(); // å…³é—­è¿æ¥
                return false;
            }
    
    
            // - åˆ¤æ–­ç”¨æˆ·æ˜¯å¦é‡å¤ç§’æ€/å¤è´­
            if (jedis.sismember(userKey, uid)) {
                System.out.println(uid + "ä¸èƒ½é‡å¤ç§’æ€...");
                jedis.close();
                return false;
            }
    
            // åˆ¤æ–­ç«è½¦ç¥¨ï¼Œæ˜¯å¦è¿˜æœ‰å‰©ä½™
            if (Integer.parseInt(stock) <= 0) {
                System.out.println("ç¥¨å·²ç»å–å®Œäº†ï¼Œç§’æ€ç»“æŸ...");
                jedis.close();
                return false;
            }
    
    
            // å¯ä»¥è´­ä¹°
            // 1.å°†ç¥¨çš„åº“å­˜é‡ -1
            jedis.decr(stockKey);
            // 2. å°†è¯¥ç”¨æˆ·åŠ å…¥åˆ°æŠ¢è´­æˆåŠŸå¯¹åº” set é›†åˆä¸­
            jedis.sadd(userKey, uid);
    
            System.out.println(uid + "ç§’æ€æˆåŠŸ");
            jedis.close();
    
            return true;
    
        }
    
        /**
         * ç¼–å†™ä¸€ä¸ªæµ‹è¯•æ–¹æ³•-çœ‹çœ‹æ˜¯å¦èƒ½å¤Ÿè¿é€šæŒ‡å®šçš„ Redis
         */
    
        @Test
        public void testRedis() {
            Jedis jedis = new Jedis("192.168.76.146", 6379);
            jedis.auth("rainbowsea");  // è®¾ç½®äº†å¯†ç ï¼Œéœ€è¦è¿›è¡Œä¸€ä¸ªéªŒè¯
            System.out.println(jedis.ping());
            jedis.close(); // å…³é—­è¿æ¥
    
        }
    }
    
    

ç¼–å†™ ,Server å¯¹å¤–çš„æœåŠ¡

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542901-1153653999.png)

    package com.rainbowsea.seckill.web;
    
    import com.rainbowsea.seckill.redis.SecKillRedis;
    
    import javax.servlet.ServletException;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import java.io.IOException;
    import java.util.Random;
    
    public class SecKillServlet extends HttpServlet {
        @Override
        protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            // 1. è¯·æ±‚æ—¶ï¼Œæ¨¡æ‹Ÿç”Ÿæˆä¸€ä¸ª userId
            String userId = new Random().nextInt(10000) + "";
            // 2. è·å–ç”¨æˆ·è´­ä¹°çš„ç¥¨çš„ç¼–å·
            String ticketNo = request.getParameter("ticketNo");
    
    
            // 3. è°ƒç”¨ç§’æ€çš„æ–¹æ³•
            boolean isOk = SecKillRedis.doSecKill(userId, ticketNo);
    
            // 4. å°†ç»“æœè¿”å›ç»™å‰ç«¯ï¼Œè¿™ä¸ªåœ°æ–¹å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦è°ƒæ•´
            response.getWriter().println(isOk);
        }
    
    
        @Override
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            doPost(request, response);
        }
    }
    
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543254-87358008.png)

    <?xml version="1.0" encoding="UTF-8"?>
    <web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
             version="4.0">
    
    
        <servlet>
            <servlet-name>SecKillServlet</servlet-name>
            <servlet-class>com.rainbowsea.seckill.web.SecKillServlet</servlet-class>
        </servlet>
    
        <servlet-mapping>
            <servlet-name>SecKillServlet</servlet-name>
            <url-pattern>/secKillServlet</url-pattern>
        </servlet-mapping>
    </web-app>
    

**æµ‹è¯•ï¼š**

> å‘ Redis ä¸­, å¢åŠ æµ‹è¯•æ•°æ®ã€‚æ·»åŠ ä¸Š 6 ç¥¨
> 
>     127.0.0.1:6379> set sk:bj_cd:ticket 6
>     
>     
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542727-253862554.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543584-588234158.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543558-1688743746.png)

5.3 æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿï¼Œå‡ºç°è¶…å–é—®é¢˜
-----------------

æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿ, å‡ºç°è¶…å–é—®é¢˜ï¼š

1ã€**å®‰è£…å·¥å…· ab æ¨¡æ‹Ÿæµ‹è¯•**

> è¯´æ˜: å·¥å…· ab å¯ä»¥æ¨¡æ‹Ÿå¹¶å‘å‘å‡º Http è¯·æ±‚ï¼Œ è¯´æ˜(æ¨¡æ‹Ÿå¹¶å‘ http è¯·æ±‚å·¥å…·è¿˜æœ‰ jemeter, postmanï¼Œæˆ‘ä»¬éƒ½ä½¿ç”¨ä¸€ä¸‹, å¼€é˜”çœ¼ç•Œ, è¿™é‡Œä½¿ç”¨ ab å·¥å…·)
> 
> å®‰è£…æŒ‡ä»¤: yum install httpd-tools (æç¤º: ä¿è¯å½“å‰ linux æ˜¯å¯ä»¥è”ç½‘çš„)
> 
> å¦‚æœä½ ä¸èƒ½è”ç½‘, å¯ä»¥ä½¿ç”¨ rpm å®‰è£…, è¿™é‡Œæˆ‘ä½¿ç”¨ yum æ–¹å¼å®‰è£…

* * *

> å¦å¤–, ä½¿ç”¨ rpm æ–¹å¼å®‰è£…æˆ‘ä¹Ÿç»™å°ä¼™ä¼´è¯´æ˜ä¸€ä¸‹, å¦‚ä¸‹: -å…ˆæŒ‚è½½ centos å®‰è£…æ–‡ä»¶ ios, è¿™ä¸ªæ–‡ä»¶,
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543509-1318896373.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543886-1185284769.png)

> è¿›å…¥ `cd /run/media/root/CentOS 7 x86_64/Packages`
> 
> é¡ºåºå®‰è£…
> 
>     apr-1.4.8-3.el7.x86_64.rpm
>     apr-util-1.5.2-6.el7.x86_64.rpm
>     httpd-tools-2.4.6-67.el7.centos.x86_64.rpm
>     
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543950-882314901.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543857-1930368456.png)

> æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543834-1733847973.png)

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `yum` å®‰è£…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ï¼šå‰ææ˜¯æˆ‘ä»¬è¦æ˜¯è”ç½‘çš„çŠ¶æ€æ‰è¡Œã€‚

    yum install httpd-tools
    

    [root@localhost ~]# yum install httpd-tools
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542641-1236014852.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542802-1203138620.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543768-171820295.png)

å®‰è£…å®Œåï¼Œè¾“å…¥ `ab` å‘½ä»¤ï¼Œæµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸ

    ab
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543942-1050098720.png)

2.  åœ¨ ab æŒ‡ä»¤æ‰§è¡Œçš„å½“å‰è·¯å¾„ä¸‹ åˆ›å»ºæ–‡ä»¶ `postfile`

    vi postfile
    

    vm postfile 
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543785-511008883.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543040-1089953482.png)

    ticketNo=bj_cd&
    

3.  **æ‰§è¡ŒæŒ‡ä»¤ , æ³¨æ„ä¿è¯ linux å¯ä»¥è®¿é—®åˆ° Tomcat æ‰€åœ¨çš„æœåŠ¡å™¨.**

å…ˆæŸ¥çœ‹ Tomcat æ‰€åœ¨ Windows çš„ç½‘ç»œé…ç½®æƒ…å†µã€‚

åœ¨ Window ç³»ç»Ÿä¸­è¾“å…¥ cmd ï¼Œè¿›å…¥å‘½ä»¤è¡Œçª—å£ï¼Œè¾“å…¥ `ipconfig` å‘½ä»¤ï¼ŒæŸ¥çœ‹ VMè™šæ‹Ÿæœºçš„IPåœ°å€æƒ…å†µã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543303-256326804.png)

ç¡®è®¤ Linux å¯ä»¥ ping é€š Windows

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543234-607958667.png)

å¦‚æœ Ping ä¸é€š, ç¡®è®¤ä¸€ä¸‹ Windows é˜²ç«å¢™æ˜¯å¦å…³é—­.

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543760-283419170.png)

> **é˜²ç«å¢™å…³é—­æ˜¯ä¸€ä»¶æ¯”è¾ƒå±é™©çš„äº‹æƒ…ï¼Œè®°å¾—å­¦ä¹ æ“ä½œå®Œä¹‹åï¼Œå›æ¥å°†é˜²ç«å¢™é‡æ–°æ‰“å¼€** ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543319-40782051.png)

æŒ‡ä»¤ , æµ‹è¯•å‰æŠŠ Redis çš„æ•°æ®å…ˆé‡ç½®ä¸€ä¸‹ã€‚å› ä¸ºå‰é¢æˆ‘ä»¬æ“ä½œè¿‡æ¥ï¼Œ ç¥¨å·²ç»è¢«å–å…‰äº†ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°è®¾ç½®ç¥¨æ•°ï¼Œè¿™é‡Œè¿˜æ˜¯è®¾ç½®ä¸º 6 å¼ ç¥¨ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543519-605201153.png)

å¦‚ä¸‹æ˜¯æˆ‘ä»¬ä½¿ç”¨ `ab` å·¥å…·è¦æ‰§è¡Œçš„å‘½ä»¤ï¼š

    ab -n 1000 -c 100 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.76.1:9090/seckill/secKillServlet
    

**å‘½ä»¤è§£è¯»ï¼š**

> 1.  `ab` ï¼š æ˜¯å¹¶å‘å·¥å…·ç¨‹åº
> 2.  `-n 1000` ï¼š è¡¨ç¤ºä¸€å…±å‘å‡º 1000 æ¬¡ http è¯·æ±‚
> 3.  `-c 100`ï¼š è¡¨ç¤ºå¹¶å‘æ—¶ 100æ¬¡ï¼Œä½ å¯ä»¥ç†è§£ä¸º 1000æ¬¡è¯·æ±‚ï¼Œåˆ† 10 æ¬¡å‘é€å®Œæ¯•ï¼Œæ¯æ¬¡å‘å‡º 100æ¬¡ã€‚
> 4.  `-p ~/postfile`ï¼š è¡¨ç¤ºå‘é€è¯·æ±‚æ—¶ï¼Œæºå¸¦çš„å‚æ•°ä»å½“å‰ç›®å½•çš„ `postfile` æ–‡ä»¶è¯»å–(å°±æ˜¯ä¸Šè¿°æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ–‡ä»¶)ã€‚`~` è¡¨ç¤ºå½“å‰è·¯å¾„ä½ç½®ã€‚
> 5.  `-T application/x-www-form-urlencoded`ï¼š å°±æ˜¯å‘é€æ•°æ®çš„ç¼–ç æ—¶åŸºäºè¡¨å•çš„ url ç¼–ç çš„
> 6.  `~` çš„æ›´å¤šå«ä¹‰ï¼Œå¯ä»¥ç§»æ­¥è‡³ï¼š [https://blog.csdn.net/m0\_67401134/article/details/123973115](https://blog.csdn.net/m0_67401134/article/details/123973115)
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543820-411029129.png)

> [http://192.168.198.1:8080/seckill/secKillServlet](http://192.168.198.1:8080/seckill/secKillServlet) å°± æ˜¯ è¯· æ±‚ çš„ url, æ³¨ æ„ è¿™ é‡Œ çš„ IP:port/uri å¿…é¡»å†™æ­£ç¡®.

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543828-332680654.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543792-1323086453.png)

    127.0.0.1:6379> ab -n 1000 -c 100 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.76.1:9090/seckill/secKillServlet
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543276-372583735.png)

æ‰§è¡Œä¹‹åã€‚æŸ¥çœ‹æ‰§è¡Œç»“æœ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543059-1363949650.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543277-507083299.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543494-1788435595.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543324-1367613244.png)

5.4 Redis è¿æ¥æ± æŠ€æœ¯
---------------

**è¿æ¥æ± ä»‹ç»**

1.  èŠ‚çœæ¯æ¬¡è¿æ¥ Redis æœåŠ¡å¸¦æ¥çš„æ¶ˆè€—ï¼ŒæŠŠè¿æ¥å¥½çš„å®ä¾‹åå¤åˆ©ç”¨ã€‚

**è¿æ¥æ± å‚æ•°ï¼š**

*   **MaxTotal**ï¼šæ§åˆ¶ä¸€ä¸ª pool å¯åˆ†é…å¤šå°‘ä¸ª jedis å®ä¾‹ï¼Œé€šè¿‡ pool.getResource() æ¥è·å–ï¼Œå¦‚æœèµ‹å€¼ä¸º `-1` ï¼Œåˆ™è¡¨ç¤ºä¸é™åˆ¶ã€‚
*   **maxldle**ï¼šæ§åˆ¶ä¸€ä¸ªpoolæœ€å¤šæœ‰å¤šå°‘ä¸ªçŠ¶æ€ä¸º idle(ç©ºé—²) çš„ jedis å®ä¾‹ã€‚
*   **MaxWaitMillis**ï¼šè¡¨ç¤ºå½“è·å–ä¸€ä¸ª jedis å®ä¾‹æ—¶ï¼Œæœ€å¤§çš„ç­‰å¾…æ¯«ç±³æ•°ï¼Œå¦‚æœè¶…è¿‡ç­‰å¾…æ—¶é—´ï¼Œåˆ™ç›´æ¥æŠ› JedisConnectionException
*   **testOnBorrow**ï¼šè·å¾—ä¸€ä¸ª jedis å®ä¾‹çš„æ—¶å€™æ˜¯å¦æ£€æŸ¥è¿æ¥å¯ç”¨æ€§(ping()) ï¼›å¦‚æœä¸º true ï¼Œåˆ™å¾—åˆ°çš„ jedis å®ä¾‹å‡æ˜¯å¯ç”¨çš„ã€‚

**ä½¿ç”¨è¿æ¥æ± , ä¼˜åŒ–è¿æ¥è¶…æ—¶ï¼š**

åˆ›å»ºï¼šsec\_kill\_ticket\\src\\com\\rainbowsea\\seckill\\utils\\JedisPoolUtil. java

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543577-965570589.png)

    package com.rainbowsea.seckill.uitl;
    
    import redis.clients.jedis.Jedis;
    import redis.clients.jedis.JedisPool;
    import redis.clients.jedis.JedisPoolConfig;
    
    /**
     * ä½¿ç”¨è¿æ¥æ± çš„æ–¹å¼æ¥è·å– Redis è¿æ¥
     */
    public class JedisPoolUtil {
    
    
        // è§£è¯» volatile ä½œç”¨
        /*
        1. çº¿ç¨‹å¯è§æ€§ï¼šå½“ä¸€ä¸ªçº¿ç¨‹å»ä¿®æ”¹ä¸€ä¸ªå…±äº«å˜é‡æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¯»å–è¿™ä¸ªä¿®æ”¹çš„å€¼
        2. é¡ºåºçš„ä¸€è‡´æ€§ï¼šç¦æ­¢æŒ‡ä»¤é‡æ’
         */
        private static volatile JedisPool jedisPool = null;
    
        // ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œå°†æ„é€ æ–¹æ³•ç§æœ‰åŒ–
    
        private JedisPoolUtil() {
        }
    
    
        // å•ä¾‹ï¼šä¿è¯æ¯æ¬¡è°ƒç”¨è¿”å›çš„ jedisPoolæ˜¯å•ä¾‹çš„
        public static JedisPool getJedisPoolInstacne() {
            if (null == jedisPool) {
    
                synchronized (JedisPoolUtil.class) {
    
                    if (null == jedisPool) {
    
                        JedisPoolConfig jedisPoolConfig = new JedisPoolConfig();
                        // å¯¹è¿æ¥æ± è¿›è¡Œé…ç½®
                        jedisPoolConfig.setMaxTotal(200);
                        jedisPoolConfig.setMaxIdle(32);
                        jedisPoolConfig.setMaxWaitMillis(60 * 1000); // å•ä½æ˜¯æ¯«ç§’
                        jedisPoolConfig.setBlockWhenExhausted(true);
                        jedisPoolConfig.setTestOnBorrow(true);
                        jedisPool = new JedisPool(jedisPoolConfig, "192.168.76.146", 6379, 60000, "rainbowsea");
    
                    }
                }
            }
    
    
            return jedisPool;
        }
    
    
        /**
         * é‡Šæ”¾è¿æ¥èµ„æº
         *
         * @param jedis
         */
        public static void release(Jedis jedis) {
            if (null != jedis) {
                jedis.close(); // å¦‚æœè¿™ä¸ªjedis æ˜¯ä»è¿æ¥æ± è·å–çš„ï¼Œè¿™é‡Œ jedis.close()
                // å°±æ˜¯å°† jediså¯¹è±¡/è¿æ¥ï¼Œé‡Šæ”¾åˆ°è¿æ¥æ± ä¸­ã€‚
            }
    
        }
    }
    
    

çº¿ç¨‹å¯è§æ€§

ç®€å•è¯´ä¸€ä¸‹æŒ‡ä»¤é‡æ’

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543908-1957291042.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542987-1910233966.png)

       // é€šè¿‡è¿æ¥æ± è·å– jediså¯¹è±¡/è¿æ¥
            JedisPool jedisPoolInstacne = JedisPoolUtil.getJedisPoolInstacne();
            Jedis jedis = jedisPoolInstacne.getResource();
            System.out.println("--ä½¿ç”¨çš„è¿æ¥æ± ");
    
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543864-1216763461.png)

          JedisPoolUtil.release(jedis);
    

**ä½¿ç”¨è¿æ¥æ± ï¼šæµ‹è¯•ï¼š**  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543829-1018512817.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543808-507742918.png)

5.5 åˆ©ç”¨ Redis çš„äº‹åŠ¡æœºåˆ¶ï¼Œè§£å†³è¶…å–é—®é¢˜(ä½¿ç”¨ watch,multi )
------------------------------------------

æ§åˆ¶è¶…å–-Redis äº‹åŠ¡åº•å±‚(ä¹è§‚é”æœºåˆ¶åˆ†æ)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542906-1082106562.png)

æˆ‘ä»¬è¦å¤„ç†çš„æ§åˆ¶çš„å°±æ˜¯ï¼Œå¦‚ä¸‹è¿™éƒ¨åˆ†ä»£ç ï¼Œå› ä¸ºæ˜¯è¿™éƒ¨åˆ†ä»£ç å¯¹ Redis åº“å½“çš„æ•°æ®è¿›è¡Œæ“ä½œå’Œä¿®æ”¹çš„ï¼Œéœ€è¦è¿›è¡Œäº‹åŠ¡ä¸Šçš„æ§åˆ¶ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542782-1152972503.png)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543155-1725464255.png)

     // ç›‘æ§åº“å­˜ï¼Œå¼€å¯ watch çš„ç›‘æ§
            jedis.watch(stockKey);
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542576-1528042722.png)

    
            // ä½¿ç”¨äº‹åŠ¡ï¼Œå®Œæˆç§’æ€
            Transaction multi = jedis.multi();
    
            // ç»„æˆæ“ä½œ
            multi.decr(stockKey); // å‡å»ç¥¨çš„åº“å­˜
            multi.sadd(userKey, uid); // å°†è¯¥æŠ¢åˆ°ç¥¨çš„ç”¨æˆ·åŠ å…¥åˆ°æŠ¢è´­æˆåŠŸçš„ set é›†åˆä¸­
            // æ‰§è¡Œ
            List<Object> results = multi.exec();
    
            if (results == null || results.size() == 0) {
                System.out.println("æŠ¢ç¥¨å¤±è´¥...");
                JedisPoolUtil.release(jedis);
                return false;
            }
    
            System.out.println(uid + "ç§’æ€æˆåŠŸ");
            //jedis.close();
            JedisPoolUtil.release(jedis);
            return true;
    
    

**å®Œæˆæµ‹è¯•ï¼š**

> **é‡å¯ Tomcatï¼š**
> 
> **é‡ç½® Redis ç›¸å…³æ•°æ®ï¼š**
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542757-324640735.png)

> **æ‰§è¡ŒæŒ‡ä»¤:**
> 
>     [root@localhost ~]# ab -n 1000 -c 100 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.76.1:9090/seckill/secKillServlet
>     
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543344-1616040116.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542931-1543731866.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542998-362938357.png)

5.6 æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿï¼Œåˆ†æå‡ºç°åº“å­˜é—ç•™é—®é¢˜
---------------------

æŠ¢ç¥¨å¹¶å‘æ¨¡æ‹Ÿ,å‡ºç°åº“å­˜é—ç•™é—®é¢˜

è¿™é‡Œæˆ‘ä»¬æ¼”ç¤ºä¸€ä¸‹ï¼šå‡ºç°åº“å­˜é—ç•™é—®é¢˜

å…ˆé‡ç½®ä¸€ä¸‹ redis çš„æ•°æ®

è¿™é‡Œæˆ‘ä»¬æŠŠåº“å­˜é‡è®¾çš„è¾ƒå¤§ä¸º 600

    127.0.0.1:6379> set sk:bj_cd:ticket 600
    OK
    127.0.0.1:6379> get sk:bj_cd:ticket
    "600"
    127.0.0.1:6379> del sk:bj_cd:user
    (integer) 1
    127.0.0.1:6379> smembers sk:bj_cd:user
    (empty array)
    127.0.0.1:6379> 
    
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543146-1625065999.png)

æ‰§è¡ŒæŒ‡ä»¤

    [root@localhost ~]# ab -n 1000 -c 300 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.76.1:9090/seckill/secKillServlet
    

è¿™é‡Œæˆ‘ä»¬å°†å¹¶å‘æ•°å˜å¤§ -c 300

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543098-1835394880.png)

**è¿è¡Œç»“æœï¼š**

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543361-1099495035.png)

> ä»è¿è¡Œç»“æœä¸Šçœ‹ï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°600å¼ ç¥¨ï¼Œ1000ä¸ªäººæŠ¢ï¼Œä»…ä»…åªå–å‡ºäº† 6 å¼ ç¥¨ã€‚è¿™åº“å­˜é—®é¢˜ååˆ†ä¸¥é‡

å‡ºç°åº“å­˜é—ç•™é—®é¢˜çš„åˆ†æ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543499-776879981.png)

> ç®€å•çš„ç†è§£å°±æ˜¯ï¼šå› ä¸ºä¹è§‚é”çš„æœºåˆ¶ï¼Œè¿™é‡Œ 1000 æ¬¡è¯·æ±‚ï¼Œåˆ† 4æ¬¡ï¼Œæ¯æ¬¡ 300ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚å®Œæ¯•çš„æ—¶å€™ï¼Œå½“ 300ä¸ªè¯·æ±‚åŒæ—¶æ¶Œå…¥åˆ° Redis ï¼Œå‘ Redis è¦æ•°æ®çš„æ—¶å€™ï¼Œä½†æ˜¯åªæœ‰æœ€å‰é¢çš„ä¸€æ¬¡å¯ä»¥è¢«è¯·æ±‚åˆ°å¯¹åº”ç‰ˆæœ¬çš„ä¿¡æ¯(å‡è®¾è¿™é‡Œæ˜¯ 1.0 ç‰ˆæœ¬çš„æ•°æ®)ï¼Œå½“æœ€å‰é¢çš„ä¸€æ¬¡è¯·æ±‚è·å–åˆ° Redis å½“ä¸­çš„æ•°æ®åï¼Œå¹¶ä¿®æ”¹äº†Redis å½“ä¸­çš„æ•°æ®ï¼Œå› ä¸ºä¿®æ”¹äº†æ•°æ®ï¼Œè¿™æ—¶å€™(å®ƒä»¬æƒ³è¦è·å–çš„æ•°å€¼çš„ç‰ˆæœ¬ä¿¡æ¯å°±å˜ä¸ºäº† 1.1äº†)ã€‚å› ä¸ºå®ƒä»¬ä¸€å¼€å§‹è¯·æ±‚è·å–çš„æ˜¯ 1.0ç‰ˆæœ¬çš„æ•°æ®ï¼Œè¿™æ—¶å€™çš„ç‰ˆæœ¬çš„æ•°æ®å˜ä¸ºäº†1.1 äº†ï¼Œé‚£å®ƒä»¬è¿™äº›è¯·æ±‚å°±è¢«æ‰“æ–­äº†ã€‚æ‰€ä»¥è¿™äº›è¯·æ±‚éƒ½è¢«æ‰“æ–­æ— æ³•è·å–åˆ°æ•°æ®äº†ï¼Œå¿…é¡»é‡æ–°å‘å‡ºæ–°çš„è¯·æ±‚æ‰è¡Œ(è·å–åˆ°ä¿®æ”¹åçš„ 1.1 ç‰ˆæœ¬çš„æ•°æ®)ã€‚å°±è¿™æ ·å¯¼è‡´å¤§é‡çš„è¯·æ±‚è¢«æ‰“æ–­äº†ï¼Œæ— æ³•è·å–åˆ°Redis çš„æ•°æ®å€¼ï¼Œä¹Ÿå°±è‡ªç„¶æ— æ³•ä¿®æ”¹Redis å½“ä¸­çš„æ•°å€¼äº†ã€‚å¯¼è‡´å­˜æœ‰å¤§é‡çš„ç¥¨æ²¡æœ‰å–å‡ºã€‚

5.7 è¿ç”¨ LUA è„šæœ¬(è§£å†³è¶…å–ï¼Œå’Œåº“å­˜é—ç•™é—®é¢˜)
---------------------------

**LUA ä»‹ç»**

1.  Lua æ—¶ä¸€ä¸ªå°å·§çš„è„šæœ¬è¯­è¨€ï¼ŒLua è„šæœ¬å¯ä»¥å¾ˆå®¹æ˜“çš„è¢« C/C++ä»£ç è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥åè¿‡æ¥è°ƒç”¨C/C++çš„å‡½æ•°ï¼ŒLua å¹¶æ²¡æœ‰æä¾›å¼ºå¤§çš„åº“ï¼Œä¸€ä¸ªå®Œæ•´çš„ Lua è§£é‡Šå™¨ä¸è¿‡ 200Kï¼Œæ‰€ä»¥ Lua ä¸é€‚åˆä½œä¸ºå¼€å‘ç‹¬ç«‹åº”ç”¨ç¨‹åºçš„è¯­è¨€ï¼Œè€Œæ˜¯ä½œä¸º åµŒå…¥å¼è„šæœ¬è¯­è¨€ã€‚
2.  å¾ˆå¤šåº”ç”¨ç¨‹åºï¼Œæ¸¸æˆä½¿ç”¨ LUA ä½œä¸ºè‡ªå·±çš„åµŒå…¥å¼çš„è„šæœ¬è¯­è¨€ï¼Œä»¥æ­¤æ¥å®ç°å¯é…ç½®æ€§ï¼Œå¯æ‰©å±•æ€§ã€‚
3.  å°†å¤æ‚çš„æˆ–è€…å¤šæ­¥çš„ Redis æ“ä½œï¼Œå†™ä¸ºä¸€ä¸ªè„šæœ¬ï¼Œä¸€æ¬¡æäº¤ç»™ redis æ‰§è¡Œï¼Œå‡å°‘åå¤è¿æ¥ redis çš„æ¬¡æ•°ã€‚æå‡æ€§èƒ½ã€‚
4.  LUAè„šæœ¬æ˜¯ç±»ä¼¼ Redis äº‹åŠ¡ï¼Œ**æœ‰ä¸€å®šçš„åŸå­æ€§ï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’é˜Ÿ** ï¼Œå¯ä»¥å®Œæˆä¸€äº› Redis äº‹åŠ¡æ€§çš„æ“ä½œã€‚
5.  Redis çš„ Lua è„šæœ¬åŠŸèƒ½ï¼Œåªæœ‰åœ¨ Redis 2.6 ä»¥ä¸Šçš„ç‰ˆæœ¬æ‰å¯ä»¥ä½¿ç”¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Redis 6 å¯ä»¥ä½¿ç”¨ã€‚
6.  é€šè¿‡ lua è„šæœ¬è§£å†³äº‰æŠ¢é—®é¢˜ï¼Œå®é™…ä¸Šæ˜¯ Redis åˆ©ç”¨å…¶**å•çº¿ç¨‹çš„ç‰¹æ€§** ï¼Œç”¨**ä»»åŠ¡é˜Ÿåˆ—** çš„æ–¹å¼è§£å†³å¤šä»»åŠ¡å¹¶å‘é—®é¢˜ã€‚

LUA è„šæœ¬, è§£å†³åº“å­˜é—ç•™-æ€è·¯åˆ†æå›¾

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543339-297417256.png)

**ä¸Šå›¾è§£å›¾ï¼š**

> 1.  LUA è„šæœ¬æ˜¯ç±»ä¼¼äº Redis äº‹åŠ¡ï¼Œ**æœ‰ä¸€å®šçš„åŸå­æ€§ï¼Œä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ’é˜Ÿ** ï¼Œèƒ½å®Œæˆ Redis äº‹åŠ¡æ€§çš„æ“ä½œã€‚
> 2.  é€šè¿‡ lua è„šæœ¬è§£å†³äº‰æŠ¢é—®é¢˜ï¼ŒRedis åˆ©ç”¨å…¶å•çº¿ç¨‹çš„ç‰¹æ€§ï¼Œå°†è¯·æ±‚å½¢æˆä»»åŠ¡é˜Ÿåˆ—, ä» è€Œè§£å†³å¤šä»»åŠ¡å¹¶å‘é—®é¢˜
> 3.  **ç®€å•çš„ç†è§£ï¼š** å°±æ˜¯å°† Redis å¤šä¸ªå‘½ä»¤ç»„åˆåœ¨ä¸€èµ·ï¼Œæˆä¸ºä¸€ä¸ªå‘½ä»¤ï¼Œç„¶åï¼Œå†å°†è¿™ä¸ªç»„åˆæˆçš„å‘½ä»¤ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡çš„å­˜å…¥åˆ°æŸä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œå­˜åä¹‹åï¼Œå°±ç®—1000ä¸ªè¯·æ±‚æ¥äº†ï¼Œä¹Ÿå¾—æŒ‰ç…§ Lua ç¼–å†™çš„é¡ºåºï¼Œä¾æ¬¡æ‰§è¡Œä¸€ä¸ªä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚ã€‚ä¸ä¼šé€ æˆå¤§é‡çš„è¯·æ±‚åŒæ—¶æ¶Œå…¥ï¼Œè®©å¤§é‡çš„è¯·æ±‚å¤±æ•ˆï¼Œä¸­æ–­ã€‚

LUA è„šæœ¬, è§£å†³åº“å­˜é—ç•™-ä»£ç å®ç°ï¼š

    local userid=KEYS[1]; --  è·å–ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°
    local ticketno=KEYS[2]; --  è·å–ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•° local stockKey='sk:'..ticketno..:ticket; --  æ‹¼æ¥ stockKey local usersKey='sk:'..ticketno..:user; --  æ‹¼æ¥  usersKey
    local userExists=redis.call(sismember,usersKey,userid); --  æŸ¥ çœ‹ åœ¨ redis  çš„ usersKey set ä¸­æ˜¯å¦æœ‰è¯¥ç”¨æˆ·
    if tonumber(userExists)==1 then
    return 2; --  å¦‚æœè¯¥ç”¨æˆ·å·²ç»è´­ä¹°,  è¿”å› 2
    end
    local num= redis.call("get" ,stockKey); --  è·å–å‰©ä½™ç¥¨æ•°
    if tonumber(num)<=0 then
    return 0; --  å¦‚æœå·²ç»æ²¡æœ‰ç¥¨, è¿”å› 0
    else
    redis.call("decr",stockKey); --  å°†å‰©ä½™ç¥¨æ•°-1
    redis.call("sadd",usersKey,userid); --  å°†æŠ¢åˆ°ç¥¨çš„ç”¨æˆ·åŠ å…¥ set
    end
    return 1 --  è¿”å› 1 è¡¨ç¤ºæŠ¢ç¥¨æˆåŠŸ
    

æƒ³è¦äº†è§£æ›´å¤šå…³äº LUAè„šæœ¬çš„å†…å®¹ï¼Œå¤§å®¶å¯ä»¥ç§»æ­¥è‡³ğŸŒŸğŸŒŸğŸŒŸ [https://blog.csdn.net/qq\_41286942/article/details/124161359](https://blog.csdn.net/qq_41286942/article/details/124161359)

è¿™é‡Œï¼šæˆ‘ä»¬æ ¹æ® LUAè„šæœ¬å¯¹ Javaç¨‹åºè¿›è¡Œä¿®æ”¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543090-937586133.png)

     /**
         * è¯´æ˜
         * 1. è¿™ä¸ªè„šæœ¬å­—ç¬¦ä¸²æ˜¯åœ¨luaè„šæœ¬ä¸Šä¿®æ”¹çš„, ä½†æ˜¯è¦æ³¨æ„ä¸å®Œå…¨æ˜¯å­—ç¬¦ä¸²å¤„ç†
         * 2. æ¯”å¦‚ : è¿™é‡Œæˆ‘å°±ä½¿ç”¨äº† \" , è¿˜æœ‰æ¢è¡Œä½¿ç”¨äº† \r\n
         * 3. è¿™äº›éƒ½æ˜¯ç»†èŠ‚ï¼Œå¦‚æœä½ ç›´æ¥æŠŠluaè„šæœ¬ç²˜è´´è¿‡æ¥ï¼Œä¸å¥½ä½¿,ä¸€å®šè¦æ³¨æ„ç»†èŠ‚
         * 4. å¦‚æœå†™çš„ä¸æˆåŠŸï¼Œå°±åœ¨è¿™ä¸ªä»£ç ä¸Šä¿®æ”¹å³å¯
         */
        static String secKillScript = "local userid=KEYS[1];\r\n" +
                "local ticketno=KEYS[2];\r\n" +
                "local stockKey='sk:'..ticketno..\":ticket\";\r\n" +
                "local usersKey='sk:'..ticketno..\":user\";\r\n" +
                "local userExists=redis.call(\"sismember\",usersKey,userid);\r\n" +
                "if tonumber(userExists)==1 then \r\n" +
                "   return 2;\r\n" +
                "end\r\n" +
                "local num= redis.call(\"get\" ,stockKey);\r\n" +
                "if tonumber(num)<=0 then \r\n" +
                "   return 0;\r\n" +
                "else \r\n" +
                "   redis.call(\"decr\",stockKey);\r\n" +
                "   redis.call(\"sadd\",usersKey,userid);\r\n" +
                "end\r\n" +
                "return 1";
    

    package com.rainbowsea.seckill.redis;
    
    
    import com.rainbowsea.seckill.uitl.JedisPoolUtil;
    import redis.clients.jedis.Jedis;
    import redis.clients.jedis.JedisPool;
    
    /**
     * ä½¿ç”¨ LUAè„šæœ¬è¿›è¡Œç¼–å†™å®Œæˆç§’æ€
     */
    public class SecKillRedisByLua {
    
        /**
         * è¯´æ˜
         * 1. è¿™ä¸ªè„šæœ¬å­—ç¬¦ä¸²æ˜¯åœ¨luaè„šæœ¬ä¸Šä¿®æ”¹çš„, ä½†æ˜¯è¦æ³¨æ„ä¸å®Œå…¨æ˜¯å­—ç¬¦ä¸²å¤„ç†
         * 2. æ¯”å¦‚ : è¿™é‡Œæˆ‘å°±ä½¿ç”¨äº† \" , è¿˜æœ‰æ¢è¡Œä½¿ç”¨äº† \r\n
         * 3. è¿™äº›éƒ½æ˜¯ç»†èŠ‚ï¼Œå¦‚æœä½ ç›´æ¥æŠŠluaè„šæœ¬ç²˜è´´è¿‡æ¥ï¼Œä¸å¥½ä½¿,ä¸€å®šè¦æ³¨æ„ç»†èŠ‚
         * 4. å¦‚æœå†™çš„ä¸æˆåŠŸï¼Œå°±åœ¨è¿™ä¸ªä»£ç ä¸Šä¿®æ”¹å³å¯
         */
        static String secKillScript = "local userid=KEYS[1];\r\n" +
                "local ticketno=KEYS[2];\r\n" +
                "local stockKey='sk:'..ticketno..\":ticket\";\r\n" +
                "local usersKey='sk:'..ticketno..\":user\";\r\n" +
                "local userExists=redis.call(\"sismember\",usersKey,userid);\r\n" +
                "if tonumber(userExists)==1 then \r\n" +
                "   return 2;\r\n" +
                "end\r\n" +
                "local num= redis.call(\"get\" ,stockKey);\r\n" +
                "if tonumber(num)<=0 then \r\n" +
                "   return 0;\r\n" +
                "else \r\n" +
                "   redis.call(\"decr\",stockKey);\r\n" +
                "   redis.call(\"sadd\",usersKey,userid);\r\n" +
                "end\r\n" +
                "return 1";
    
        //ä½¿ç”¨luaè„šæœ¬å®Œæˆç§’æ€çš„æ ¸å¿ƒæ–¹æ³•
        public static boolean doSecKill(String uid, String ticketNo) {
            //å…ˆä»redisè¿æ¥æ± ï¼Œè·å–è¿æ¥
            JedisPool jedisPoolInstance = JedisPoolUtil.getJedisPoolInstacne();
            Jedis jedis = jedisPoolInstance.getResource();
            //å°±æ˜¯å°†luaè„šæœ¬è¿›è¡ŒåŠ è½½
            String sha1 = jedis.scriptLoad(secKillScript);
            //evalshaæ˜¯æ ¹æ®æŒ‡å®šçš„ sha1æ ¡éªŒç , æ‰§è¡Œç¼“å­˜åœ¨æœåŠ¡å™¨çš„è„šæœ¬
            Object result = jedis.evalsha(sha1, 2, uid, ticketNo);
            String resString = String.valueOf(result);
    
            //æ ¹æ®luaè„šæœ¬æ‰§è¡Œè¿”å›çš„ç»“æœï¼Œåšç›¸åº”çš„å¤„ç†
            if ("0".equals(resString)) {
                System.out.println("ç¥¨å·²ç»å–å…‰äº†..");
                JedisPoolUtil.release(jedis);  // å½’è¿˜è¿æ¥ç»™,redis è¿æ¥æ± 
                return false;
            }
    
            if ("2".equals(resString)) {
                System.out.println("ä¸èƒ½é‡å¤è´­ä¹°..");
                JedisPoolUtil.release(jedis);  // å½’è¿˜è¿æ¥ç»™,redis è¿æ¥æ± 
                return false;
            }
    
            if ("1".equals(resString)) {
                System.out.println("æŠ¢è´­æˆåŠŸ");
                JedisPoolUtil.release(jedis);  // å½’è¿˜è¿æ¥ç»™,redis è¿æ¥æ± 
                return true;
            } else {
                System.out.println("è´­ç¥¨å¤±è´¥..");
                JedisPoolUtil.release(jedis);  // å½’è¿˜è¿æ¥ç»™,redis è¿æ¥æ± 
                return false;
            }
    
        }
    }
    
    

ä¿®æ”¹ï¼šSecKillServlet å½“ä¸­çš„ doPost æ–¹æ³•ï¼Œä½¿ç”¨ LUAè„šæœ¬å®Œæˆç§’æ€

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543290-120590550.png)

    package com.rainbowsea.seckill.web;
    
    import com.rainbowsea.seckill.redis.SecKillRedis;
    import com.rainbowsea.seckill.redis.SecKillRedisByLua;
    
    import javax.servlet.ServletException;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import java.io.IOException;
    import java.util.Random;
    
    public class SecKillServlet extends HttpServlet {
        @Override
        protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            // 1. è¯·æ±‚æ—¶ï¼Œæ¨¡æ‹Ÿç”Ÿæˆä¸€ä¸ª userId
            String userId = new Random().nextInt(10000) + "";
            // 2. è·å–ç”¨æˆ·è´­ä¹°çš„ç¥¨çš„ç¼–å·
            String ticketNo = request.getParameter("ticketNo");
    
    
            // 3. è°ƒç”¨ç§’æ€çš„æ–¹æ³•
            //boolean isOk = SecKillRedis.doSecKill(userId, ticketNo);
            // 3.è°ƒç”¨ Lua è„šæœ¬çš„å®Œæˆç§’æ€æ–¹æ³•
            boolean isOk = SecKillRedisByLua.doSecKill(userId, ticketNo);
    
            // 4. å°†ç»“æœè¿”å›ç»™å‰ç«¯ï¼Œè¿™ä¸ªåœ°æ–¹å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€è¦è°ƒæ•´
            response.getWriter().println(isOk);
        }
    
    
        @Override
        protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
            doPost(request, response);
        }
    }
    
    

**æµ‹è¯•ï¼š**

> é‡å¯æŠ¢ç¥¨ç¨‹åº-Tomcat
> 
> é‡ç½® Redis æ•°æ®
> 
>     127.0.0.1:6379> set sk:bj_cd:ticket 600
>     OK
>     127.0.0.1:6379> get sk:bj_cd:ticket
>     "600"
>     127.0.0.1:6379> del sk:bj_cd:user
>     (integer) 1
>     127.0.0.1:6379> smembers sk:bj_cd:user
>     (empty array)
>     127.0.0.1:6379> 
>     
>     
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543065-1592665306.png)

> æ‰§è¡ŒæŒ‡ä»¤
> 
>     [root@localhost ~]# ab -n 2000 -c 200 -p ~/postfile -T application/x-www-form-urlencoded http://192.168.76.1:9090/seckill/secKillServlet
>     
>     
>     
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542601-241381484.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215542707-1995564144.png)

> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543000-1570035821.png)

6\. æœ€åï¼š
=======

> â€œåœ¨è¿™ä¸ªæœ€åçš„ç¯‡ç« ä¸­ï¼Œæˆ‘è¦è¡¨è¾¾æˆ‘å¯¹æ¯ä¸€ä½è¯»è€…çš„æ„Ÿæ¿€ä¹‹æƒ…ã€‚ä½ ä»¬çš„å…³æ³¨å’Œå›å¤æ˜¯æˆ‘åˆ›ä½œçš„åŠ¨åŠ›æºæ³‰ï¼Œæˆ‘ä»ä½ ä»¬èº«ä¸Šå¸å–äº†æ— å°½çš„çµæ„Ÿä¸å‹‡æ°”ã€‚æˆ‘ä¼šå°†ä½ ä»¬çš„é¼“åŠ±ç•™åœ¨å¿ƒåº•ï¼Œç»§ç»­åœ¨å…¶ä»–çš„é¢†åŸŸå¥‹æ–—ã€‚æ„Ÿè°¢ä½ ä»¬ï¼Œæˆ‘ä»¬æ€»ä¼šåœ¨æŸä¸ªæ—¶åˆ»å†æ¬¡ç›¸é‡ã€‚â€
> 
> ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img2024.cnblogs.com/blog/3084824/202502/3084824-20250205215543700-1732106008.gif)