---
layout: post
title: 'Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†ï¼šä»CPUåˆ°JVMçš„å…¨é¢è§£æ'
date: "2025-10-14T00:39:23Z"
---
Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°åŸç†ï¼šä»CPUåˆ°JVMçš„å…¨é¢è§£æ
=============================

> æ·±å…¥ç†è§£volatileã€synchronizedå’ŒåŸå­æ“ä½œçš„å®ç°æœºåˆ¶ï¼ŒæŒæ¡é«˜å¹¶å‘ç¼–ç¨‹çš„æ ¸å¿ƒåŸç†

å¼•è¨€ï¼šä¸ºä»€ä¹ˆéœ€è¦äº†è§£åº•å±‚åŸç†ï¼Ÿ
---------------

åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨`volatile`ã€`synchronized`å’ŒåŸå­ç±»æ¥è§£å†³å¹¶å‘é—®é¢˜ã€‚ä½†ä»…ä»…ä¼šä½¿ç”¨è¿™äº›å·¥å…·æ˜¯ä¸å¤Ÿçš„ï¼Œåªæœ‰æ·±å…¥ç†è§£å®ƒä»¬çš„åº•å±‚å®ç°åŸç†ï¼Œæ‰èƒ½åœ¨å¤æ‚çš„å¹¶å‘åœºæ™¯ä¸­åšå‡ºæ­£ç¡®çš„æŠ€æœ¯é€‰å‹ï¼Œå†™å‡ºé«˜æ€§èƒ½ã€çº¿ç¨‹å®‰å…¨çš„ä»£ç ã€‚

**æƒ³è±¡ä¸€ä¸‹**ï¼šå¦‚æœä½ åªçŸ¥é“å¼€è½¦ï¼Œå´ä¸äº†è§£å‘åŠ¨æœºåŸç†ï¼Œå½“è½¦å­å‡ºç°å¼‚å¸¸æ—¶ä½ å°±æ— ä»ä¸‹æ‰‹ã€‚åŒæ ·ï¼ŒåªçŸ¥é“ä½¿ç”¨å¹¶å‘å·¥å…·è€Œä¸äº†è§£åŸç†ï¼Œåœ¨å‡ºç°æ€§èƒ½é—®é¢˜æˆ–è¯¡å¼‚çš„å¹¶å‘bugæ—¶ï¼Œä½ å°†æŸæ‰‹æ— ç­–ã€‚

æœ¬æ–‡å°†ä»CPUå±‚é¢å¼€å§‹ï¼Œé€æ­¥æ·±å…¥åˆ°JVMå®ç°ï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„æ¯”å–»å’Œä»£ç ç¤ºä¾‹ï¼Œå®Œæ•´æ­ç¤ºJavaå¹¶å‘æœºåˆ¶çš„åº•å±‚åŸç†ã€‚

ä¸€ã€ç¡¬ä»¶åŸºç¡€ï¼šCPUä¸å†…å­˜çš„äº¤äº’
----------------

è¦ç†è§£Javaå¹¶å‘æœºåˆ¶ï¼Œé¦–å…ˆéœ€è¦äº†è§£ç°ä»£è®¡ç®—æœºæ¶æ„çš„åŸºæœ¬å·¥ä½œåŸç†ã€‚

### 1.1 è®¡ç®—æœºå­˜å‚¨å±‚æ¬¡ç»“æ„

    CPUå¯„å­˜å™¨ â†’ L1ç¼“å­˜ â†’ L2ç¼“å­˜ â†’ L3ç¼“å­˜ â†’ ä¸»å†…å­˜ â†’ ç£ç›˜
    

**é€Ÿåº¦å¯¹æ¯”**ï¼š

*   CPUå¯„å­˜å™¨ï¼š~1nsï¼ˆå…‰é€Ÿï¼‰
*   L1ç¼“å­˜ï¼š~1ns
*   L2ç¼“å­˜ï¼š~4ns
*   L3ç¼“å­˜ï¼š~10ns
*   ä¸»å†…å­˜ï¼š~100nsï¼ˆæ…¢100å€ï¼ï¼‰

**é€šä¿—æ¯”å–»**ï¼š

*   **CPUå¯„å­˜å™¨**ï¼šä½ æ‰‹å¤´ä¸Šæ­£åœ¨çœ‹çš„ä¹¦
*   **L1ç¼“å­˜**ï¼šæ¡Œé¢ä¸Šçš„å‡ æœ¬å¸¸ç”¨ä¹¦
*   **L2/L3ç¼“å­˜**ï¼šä¹¦æ¶ä¸Šçš„ä¹¦
*   **ä¸»å†…å­˜**ï¼šå›¾ä¹¦é¦†çš„ä¹¦æ¶
*   **ç£ç›˜**ï¼šè¿œå¤„çš„ä»“åº“

è®¿é—®é€Ÿåº¦å·®å¼‚å·¨å¤§ï¼Œæ‰€ä»¥CPUä¼šå°½é‡æŠŠæ•°æ®ä¿å­˜åœ¨ç¦»è‡ªå·±è¿‘çš„ç¼“å­˜ä¸­ã€‚

### 1.2 ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰

**å®šä¹‰**ï¼šCPUç¼“å­˜çš„æœ€å°æ“ä½œå•ä½ï¼Œé€šå¸¸æ˜¯64å­—èŠ‚ã€‚

**é€šä¿—æ¯”å–»**ï¼šå›¾ä¹¦ç®¡ç†å‘˜çš„å°æ¨è½¦ä¸Šçš„ä¸€ä¸ªæ ¼å­ï¼Œä¸€æ¬¡èƒ½æ”¾å›ºå®šæ•°é‡çš„ä¹¦ã€‚ç®¡ç†å‘˜ä¸ä¼šåªæ‹¿ä¸€æœ¬ä¹¦ï¼Œè€Œæ˜¯æŠŠè¿™æœ¬ä¹¦åŠå…¶æ—è¾¹çš„å‡ æœ¬ä¹¦ä¸€èµ·æ‹¿åˆ°å°æ¨è½¦ä¸Šã€‚

    // ä¼ªä»£ç æ¼”ç¤ºç¼“å­˜è¡Œçš„å½±å“
    public class CacheLineExample {
        // ä¸¤ä¸ªå˜é‡å¯èƒ½åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ - å¯èƒ½å¯¼è‡´"è™šå‡å…±äº«"
        private volatile long variableA;  // 8å­—èŠ‚
        private volatile long variableB;  // 8å­—èŠ‚
        
        // ä½¿ç”¨å¡«å……é¿å…ä¼ªå…±äº«
        private volatile long variableA;
        private long p1, p2, p3, p4, p5, p6, p7; // å¡«å……56å­—èŠ‚
        private volatile long variableB;
    }
    

**è™šå‡å…±äº«é—®é¢˜**ï¼šå¦‚æœä¸¤ä¸ªä¸ç›¸å…³çš„å˜é‡åœ¨åŒä¸€ä¸ªç¼“å­˜è¡Œä¸­ï¼Œä¸€ä¸ªCPUä¿®æ”¹variableAæ—¶ï¼Œä¼šä½¿å…¶ä»–CPUä¸­æ•´ä¸ªç¼“å­˜è¡Œå¤±æ•ˆï¼ŒåŒ…æ‹¬variableBï¼Œå³ä½¿variableBæ²¡æœ‰è¢«ä¿®æ”¹ã€‚

### 1.3 CPUæµæ°´çº¿ä¸å†…å­˜é¡ºåºå†²çª

**CPUæµæ°´çº¿**ï¼šåƒå·¥å‚æµæ°´çº¿ä¸€æ ·ï¼Œå°†æŒ‡ä»¤åˆ†è§£æˆå¤šä¸ªæ­¥éª¤å¹¶è¡Œæ‰§è¡Œï¼Œæé«˜æ•ˆç‡ã€‚

    // æ²¡æœ‰æµæ°´çº¿ï¼šå®Œæˆ3æ¡æŒ‡ä»¤éœ€è¦9ä¸ªå‘¨æœŸ
    // æŒ‡ä»¤1ï¼šå–æŒ‡â†’è¯‘ç â†’æ‰§è¡Œ
    // æŒ‡ä»¤2ï¼šå–æŒ‡â†’è¯‘ç â†’æ‰§è¡Œ  
    // æŒ‡ä»¤3ï¼šå–æŒ‡â†’è¯‘ç â†’æ‰§è¡Œ
    
    // æœ‰æµæ°´çº¿ï¼šå®Œæˆ3æ¡æŒ‡ä»¤åªéœ€è¦5ä¸ªå‘¨æœŸ
    // å‘¨æœŸ1ï¼šæŒ‡ä»¤1å–æŒ‡
    // å‘¨æœŸ2ï¼šæŒ‡ä»¤1è¯‘ç ï¼ŒæŒ‡ä»¤2å–æŒ‡
    // å‘¨æœŸ3ï¼šæŒ‡ä»¤1æ‰§è¡Œï¼ŒæŒ‡ä»¤2è¯‘ç ï¼ŒæŒ‡ä»¤3å–æŒ‡
    // å‘¨æœŸ4ï¼šæŒ‡ä»¤2æ‰§è¡Œï¼ŒæŒ‡ä»¤3è¯‘ç 
    // å‘¨æœŸ5ï¼šæŒ‡ä»¤3æ‰§è¡Œ
    

**å†…å­˜é¡ºåºå†²çª**ï¼šå¤šä¸ªCPUåŒæ—¶ä¿®æ”¹åŒä¸€ç¼“å­˜è¡Œçš„ä¸åŒéƒ¨åˆ†ï¼Œå¯¼è‡´CPUå¿…é¡»æ¸…ç©ºæµæ°´çº¿ï¼Œå°±åƒå·¥å‚æµæ°´çº¿å› ä¸ºé›¶ä»¶å†²çªè€Œæš‚åœã€‚

äºŒã€volatileå…³é”®å­—çš„åº•å±‚åŸç†
------------------

### 2.1 volatileçš„è¯­ä¹‰

*   **å¯è§æ€§**ï¼šä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹åï¼Œå…¶ä»–çº¿ç¨‹ç«‹å³èƒ½çœ‹åˆ°æœ€æ–°å€¼
*   **ç¦æ­¢æŒ‡ä»¤é‡æ’åº**ï¼šé˜²æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–æ‰“ä¹±æ‰§è¡Œé¡ºåº

**é€šä¿—æ¯”å–»**ï¼švolatileå˜é‡å°±åƒå…¬å¸å…¬å‘Šæ¿ä¸Šçš„é‡è¦é€šçŸ¥ã€‚ä»»ä½•äººä¿®æ”¹é€šçŸ¥æ—¶ï¼Œå¿…é¡»ç«‹å³æ›´æ–°å…¬å‘Šæ¿ï¼Œå¹¶ä¸”æ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°æœ€æ–°å†…å®¹ï¼Œä¸èƒ½å·å·ä¿®æ”¹ã€‚

### 2.2 å†…å­˜å±éšœï¼ˆMemory Barriersï¼‰

**æ¯”å–»**ï¼šå›¾ä¹¦é¦†é‡Œçš„"è¯·æ’é˜Ÿ"éš”ç¦»å¸¦ï¼Œç¡®ä¿æ“ä½œæŒ‰é¡ºåºæ‰§è¡Œï¼Œé˜²æ­¢ä¹±åºã€‚

    public class VolatileExample {
        private volatile boolean flag = false;
        private int value = 0;
        
        public void writer() {
            value = 42;          // æ™®é€šå†™
            // å†™å±éšœ - ä¿è¯ä¹‹å‰çš„å†™æ“ä½œå¯¹åç»­æ“ä½œå¯è§
            flag = true;         // volatileå†™ - æ’å…¥å†™å±éšœ
        }
        
        public void reader() {
            if (flag) {          // volatileè¯» - æ’å…¥è¯»å±éšœ
                // è¯»å±éšœ - ä¿è¯ä¹‹åçš„è¯»æ“ä½œèƒ½çœ‹åˆ°volatileè¯»ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ
                System.out.println(value); // ä¿è¯çœ‹åˆ°value=42ï¼Œè€Œä¸æ˜¯0
            }
        }
    }
    

### 2.3 volatileçš„ç¡¬ä»¶å®ç°

å½“å¯¹volatileå˜é‡è¿›è¡Œå†™æ“ä½œæ—¶ï¼ŒJVMä¼šå‘å¤„ç†å™¨å‘é€**Lockå‰ç¼€**çš„æŒ‡ä»¤ï¼š

    ; Javaä»£ç ï¼šinstance = new Singleton(); // instanceæ˜¯volatileå˜é‡
    ; å¯¹åº”çš„æ±‡ç¼–ä»£ç ï¼š
    movb $0Ã—0,0Ã—1104800(%esi)
    lock addl $0Ã—0,(%esp)     ; Lockå‰ç¼€æŒ‡ä»¤
    

**Lockå‰ç¼€æŒ‡ä»¤çš„ä½œç”¨**ï¼š

1.  **ç«‹å³å†™å›å†…å­˜**ï¼šå°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®å¼ºåˆ¶å†™å›ç³»ç»Ÿå†…å­˜
2.  **ä½¿å…¶ä»–ç¼“å­˜å¤±æ•ˆ**ï¼šé€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼Œä½¿å…¶ä»–CPUä¸­ç¼“å­˜è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆ

**é€šä¿—æ¯”å–»**ï¼š

*   æ™®é€šå˜é‡ï¼šä½ åœ¨è‡ªå·±çš„ç¬”è®°æœ¬ä¸Šä¿®æ”¹å†…å®¹ï¼Œåˆ«äººä¸çŸ¥é“ä½ æ”¹äº†
*   volatileå˜é‡ï¼šä½ åœ¨å…¬å‘Šæ¿ä¸Šä¿®æ”¹å†…å®¹ï¼ŒåŒæ—¶ç”¨å¤§å–‡å­å–Šï¼š"æˆ‘ä¿®æ”¹äº†ï¼Œä½ ä»¬çš„ç¬”è®°æœ¬å‰¯æœ¬éƒ½ä½œåºŸï¼"

### 2.4 ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰

MESIåè®®é€šè¿‡å››ç§çŠ¶æ€ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§ï¼Œå°±åƒå›¾ä¹¦é¦†çš„ä¹¦ç±ç®¡ç†ï¼š

*   **Mï¼ˆModifiedï¼‰**ï¼šè¿™æœ¬ä¹¦åªæœ‰æˆ‘æ‰‹ä¸Šæœ‰ï¼Œè€Œä¸”æˆ‘ä¿®æ”¹è¿‡äº†ï¼Œä¸ä¹¦æ¶ä¸Šçš„ä¸åŒ
*   **Eï¼ˆExclusiveï¼‰**ï¼šè¿™æœ¬ä¹¦åªæœ‰æˆ‘æ‰‹ä¸Šæœ‰ï¼Œä½†ä¸ä¹¦æ¶ä¸Šçš„å†…å®¹ä¸€è‡´
*   **Sï¼ˆSharedï¼‰**ï¼šè¿™æœ¬ä¹¦æˆ‘å’Œå…¶ä»–äººæ‰‹ä¸Šéƒ½æœ‰ï¼Œå†…å®¹éƒ½ä¸ä¹¦æ¶ä¸€è‡´
*   **Iï¼ˆInvalidï¼‰**ï¼šæˆ‘æ‰‹ä¸Šçš„è¿™æœ¬ä¹¦å·²ç»è¿‡æ—¶äº†ï¼Œä¸èƒ½ä½¿ç”¨

ä¸‰ã€synchronizedçš„é”å‡çº§æœºåˆ¶
--------------------

### 3.1 synchronizedçš„ä¸‰ç§åº”ç”¨å½¢å¼

    public class SynchronizedExample {
        // 1. å®ä¾‹åŒæ­¥æ–¹æ³• - é”å½“å‰å®ä¾‹å¯¹è±¡ï¼ˆè¿™æŠŠé—¨çš„é’¥åŒ™ï¼‰
        public synchronized void instanceMethod() {
            // ä¸´ç•ŒåŒº - åªæœ‰æ‹¿åˆ°é’¥åŒ™çš„çº¿ç¨‹èƒ½è¿›å…¥
        }
        
        // 2. é™æ€åŒæ­¥æ–¹æ³• - é”å½“å‰ç±»çš„Classå¯¹è±¡ï¼ˆæ•´æ ‹å¤§æ¥¼çš„æ€»é’¥åŒ™ï¼‰
        public static synchronized void staticMethod() {
            // ä¸´ç•ŒåŒº
        }
        
        // 3. åŒæ­¥ä»£ç å— - é”æŒ‡å®šå¯¹è±¡ï¼ˆç‰¹å®šæˆ¿é—´çš„é’¥åŒ™ï¼‰
        private final Object lock = new Object();
        
        public void codeBlock() {
            synchronized(lock) {
                // ä¸´ç•ŒåŒº
            }
        }
    }
    

### 3.2 Javaå¯¹è±¡å¤´ä¸Mark Word

æ¯ä¸ªJavaå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå¯¹è±¡å¤´ï¼Œå°±åƒæ¯ä¸ªäººçš„èº«ä»½è¯ã€‚å¯¹è±¡å¤´åŒ…å«é‡è¦çš„**Mark Word**ï¼Œè®°å½•å¯¹è±¡çš„é”çŠ¶æ€ä¿¡æ¯ã€‚

**32ä½JVMçš„Mark Wordç»“æ„**ï¼š

    | é”çŠ¶æ€   | 25bit         | 4bit     | 1bit(åå‘é”) | 2bit(é”æ ‡å¿—) |
    |----------|---------------|----------|--------------|--------------|
    | æ— é”     | å¯¹è±¡å“ˆå¸Œç     | åˆ†ä»£å¹´é¾„ | 0            | 01           |
    | åå‘é”   | çº¿ç¨‹ID+Epoch  | åˆ†ä»£å¹´é¾„ | 1            | 01           |
    | è½»é‡çº§é” | æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆ |        | 00           |
    | é‡é‡çº§é” | æŒ‡å‘äº’æ–¥é‡çš„æŒ‡é’ˆ   |        | 10           |
    | GCæ ‡è®°   | ç©º            |          |              | 11           |
    

**é€šä¿—æ¯”å–»**ï¼šMark Wordå°±åƒä½ çš„å·¥ä½œè¯ï¼Œå¯ä»¥æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€ï¼š"ç©ºé—²"ã€"å¼ ä¸‰ä¸“å±"ã€"æ­£åœ¨ç™»è®°ä½¿ç”¨"ã€"ä¼šè®®å®¤å ç”¨ä¸­"ã€‚

### 3.3 é”çš„å‡çº§è¿‡ç¨‹

é”çš„å‡çº§è·¯å¾„ï¼š**æ— é” â†’ åå‘é” â†’ è½»é‡çº§é” â†’ é‡é‡çº§é”**

è¿™ä¸ªè®¾è®¡å¾ˆèªæ˜ï¼šå…ˆç”¨ä½æˆæœ¬æ–¹æ¡ˆï¼Œå‘ç°ä¸è¡Œå†é€æ­¥å‡çº§ï¼Œå°±åƒå¤„ç†é—®é¢˜å…ˆå°è¯•ç®€å•æ–¹æ³•ï¼Œä¸è¡Œå†ç”¨å¤æ‚æ–¹æ³•ã€‚

#### 3.3.1 åå‘é”ï¼ˆBiased Lockingï¼‰

**åœºæ™¯**ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹é”æ€»æ˜¯è¢«åŒä¸€çº¿ç¨‹é‡å¤è·å–

**é€šä¿—æ¯”å–»**ï¼šå…¬å¸ä¼šè®®å®¤è´´ä¸Š"å¼ ä¸‰ä¸“å±"æ ‡ç­¾ã€‚å¼ ä¸‰æ¥äº†ç›´æ¥è¿›å…¥ï¼Œä¸ç”¨ç™»è®°ã€‚ä½†å¦‚æœæå››ä¹Ÿæƒ³ç”¨ï¼Œå°±è¦æ’•æ‰æ ‡ç­¾ï¼Œæ”¹ç”¨ç™»è®°åˆ¶åº¦ã€‚

    // åå‘é”çš„åˆå§‹åŒ–æµç¨‹
    public void biasedLockDemo() {
        Object lock = new Object();
        
        // ç¬¬ä¸€æ¬¡åŒæ­¥ï¼Œå¯ç”¨åå‘é”
        synchronized(lock) {
            // åœ¨å¯¹è±¡å¤´è®°å½•å½“å‰çº¿ç¨‹IDï¼Œå°±åƒè´´ä¸Š"å¼ ä¸‰ä¸“å±"
            System.out.println("ç¬¬ä¸€æ¬¡è·å–é”ï¼Œå¯ç”¨åå‘é”");
        }
        
        // åŒä¸€çº¿ç¨‹å†æ¬¡åŒæ­¥ï¼Œç›´æ¥è¿›å…¥
        synchronized(lock) {
            // æ£€æŸ¥çº¿ç¨‹IDåŒ¹é…ï¼Œæ— éœ€CASæ“ä½œï¼Œç›´æ¥è¿›å…¥
            System.out.println("åŒä¸€çº¿ç¨‹å†æ¬¡è·å–é”ï¼Œç›´æ¥è¿›å…¥");
        }
    }
    

**å·¥ä½œåŸç†**ï¼š

*   ç¬¬ä¸€æ¬¡è·å–é”æ—¶ï¼Œåœ¨å¯¹è±¡å¤´è®°å½•çº¿ç¨‹ID
*   ä»¥ååŒä¸€çº¿ç¨‹å†æ¬¡è·å–é”æ—¶ï¼Œç›´æ¥æ£€æŸ¥çº¿ç¨‹IDåŒ¹é…å³å¯
*   å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹ç«äº‰ï¼Œå°±å‡çº§ä¸ºè½»é‡çº§é”

#### 3.3.2 è½»é‡çº§é”ï¼ˆLightweight Lockingï¼‰

**åœºæ™¯**ï¼šå¤šä¸ªçº¿ç¨‹äº¤æ›¿æ‰§è¡ŒåŒæ­¥å—ï¼Œæ²¡æœ‰çœŸæ­£ç«äº‰

**é€šä¿—æ¯”å–»**ï¼šä¼šè®®å®¤é—¨å£æ”¾ä¸ªç™»è®°æœ¬ã€‚è°è¦ç”¨ä¼šè®®å®¤ï¼Œå°±åœ¨æœ¬å­ä¸Šç­¾ä¸ªåã€‚ç”¨å®Œåæ“¦æ‰ç­¾åã€‚å¦‚æœä¸¤ä¸ªäººåŒæ—¶æ¥ç™»è®°ï¼Œååˆ°çš„äººç¨ç­‰ä¸€ä¼šå†å°è¯•ã€‚

    public void lightweightLockDemo() {
        Object lock = new Object();
        
        Thread t1 = new Thread(() -> {
            synchronized(lock) {
                // çº¿ç¨‹t1é€šè¿‡CASåœ¨ç™»è®°æœ¬ä¸Šç­¾åæˆåŠŸ
                try { Thread.sleep(100); } catch (InterruptedException e) {}
                // é€€å‡ºæ—¶æ“¦æ‰ç­¾å
            }
        });
        
        Thread t2 = new Thread(() -> {
            try { Thread.sleep(10); } catch (InterruptedException e) {}
            synchronized(lock) {
                // çº¿ç¨‹t2å¼€å§‹æ—¶å‘ç°ç™»è®°æœ¬ä¸Šå·²æœ‰ç­¾åï¼ˆCASå¤±è´¥ï¼‰
                // è‡ªæ—‹ç­‰å¾…ä¸€ä¼šåå†æ¬¡å°è¯•CASï¼ŒæˆåŠŸè·å¾—é”
            }
        });
        
        t1.start();
        t2.start();
    }
    

**å·¥ä½œåŸç†**ï¼š

1.  åœ¨å½“å‰çº¿ç¨‹æ ˆå¸§ä¸­åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰
2.  å°†å¯¹è±¡å¤´çš„Mark Wordå¤åˆ¶åˆ°é”è®°å½•ä¸­
3.  ä½¿ç”¨CASå°è¯•å°†å¯¹è±¡å¤´æŒ‡å‘é”è®°å½•
4.  å¦‚æœæˆåŠŸï¼Œè·å¾—é”ï¼›å¦‚æœå¤±è´¥ï¼Œè‡ªæ—‹é‡è¯•

#### 3.3.3 é‡é‡çº§é”ï¼ˆHeavyweight Lockingï¼‰

**åœºæ™¯**ï¼šå¤šä¸ªçº¿ç¨‹æ¿€çƒˆç«äº‰åŒä¸€æŠŠé”

**é€šä¿—æ¯”å–»**ï¼šä¼šè®®å®¤å®‰æ’ä¸“é—¨çš„ç®¡ç†å‘˜ã€‚æƒ³ç”¨ä¼šè®®å®¤çš„äººè¦æ’é˜Ÿï¼Œç”¨å®Œåç®¡ç†å‘˜å«ä¸‹ä¸€ä¸ªã€‚è™½ç„¶æ•ˆç‡ä½ï¼Œä½†ä¿è¯ä¸ä¼šå†²çªã€‚

**ç”¨æˆ·æ€ä¸å†…æ ¸æ€åˆ‡æ¢çš„å¼€é”€**ï¼š

    public class HeavyweightLockCost {
        private final Object heavyLock = new Object();
        
        public void expensiveOperation() {
            synchronized(heavyLock) {  
                // è¿™é‡Œå¯èƒ½è§¦å‘ç”¨æˆ·æ€â†’å†…æ ¸æ€åˆ‡æ¢ï¼Œå°±åƒï¼š
                // 1. æ™®é€šå‘˜å·¥ï¼ˆç”¨æˆ·æ€ï¼‰éœ€è¦æ‰¾ç»ç†ï¼ˆå†…æ ¸æ€ï¼‰å®¡æ‰¹
                // 2. ä¿å­˜å½“å‰å·¥ä½œçŠ¶æ€ï¼ˆä¿å­˜å¯„å­˜å™¨ï¼‰
                // 3. èµ°åˆ°ç»ç†åŠå…¬å®¤ï¼ˆæ¨¡å¼åˆ‡æ¢ï¼‰
                // 4. ç­‰å¾…ç»ç†å¤„ç†ï¼ˆå†…æ ¸è°ƒåº¦ï¼‰
                // 5. æ‹¿ç»“æœå›åˆ°å·¥ä½ï¼ˆæ¨¡å¼åˆ‡æ¢ï¼‰
                // 6. æ¢å¤å·¥ä½œçŠ¶æ€ï¼ˆæ¢å¤å¯„å­˜å™¨ï¼‰
                // æ€»å¼€é”€ï¼šæ•°åƒCPUå‘¨æœŸï¼
            }
        }
    }
    

**é‡é‡çº§é”çš„å¼€é”€æ˜ç»†**ï¼š

*   **ä¸Šä¸‹æ–‡ä¿å­˜**ï¼šä¿å­˜æ‰€æœ‰CPUå¯„å­˜å™¨çŠ¶æ€
*   **æ¨¡å¼åˆ‡æ¢**ï¼šç”¨æˆ·æ€â†’å†…æ ¸æ€çš„æƒé™åˆ‡æ¢
*   **çº¿ç¨‹è°ƒåº¦**ï¼šå†…æ ¸æ‰§è¡Œçº¿ç¨‹é˜»å¡å’Œå”¤é†’
*   **ç¼“å­˜å¤±æ•ˆ**ï¼šç›¸å…³ç¼“å­˜è¡Œå¯èƒ½å¤±æ•ˆ

### 3.4 é”å‡çº§çš„è§¦å‘æ¡ä»¶

é”ç±»å‹

è§¦å‘æ¡ä»¶

ä¼˜ç‚¹

ç¼ºç‚¹

é€‚ç”¨åœºæ™¯

åå‘é”

åŒä¸€çº¿ç¨‹é‡å¤è·å–

æ¥è¿‘é›¶å¼€é”€

æœ‰æ’¤é”€å¼€é”€

å•çº¿ç¨‹é‡å¤è®¿é—®

è½»é‡çº§é”

çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ

é¿å…çº¿ç¨‹é˜»å¡

è‡ªæ—‹æ¶ˆè€—CPU

ä½ç«äº‰åœºæ™¯

é‡é‡çº§é”

æ¿€çƒˆç«äº‰

é¿å…CPUç©ºè½¬

ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§

é«˜ç«äº‰åœºæ™¯

å››ã€åŸå­æ“ä½œçš„å®ç°åŸç†
-----------

### 4.1 ä»€ä¹ˆæ˜¯åŸå­æ“ä½œï¼Ÿ

**åŸå­æ“ä½œ**ï¼šä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œã€‚

**é€šä¿—æ¯”å–»**ï¼šATMæœºè½¬è´¦ï¼Œè¦ä¹ˆæ‰£æ¬¾å’Œåˆ°è´¦éƒ½æˆåŠŸï¼Œè¦ä¹ˆéƒ½å¤±è´¥ï¼Œä¸ä¼šå‡ºç°åªæ‰£æ¬¾ä¸åˆ°è´¦çš„ä¸­é—´çŠ¶æ€ã€‚

**ç»å…¸é—®é¢˜**ï¼š`i++`ä¸æ˜¯åŸå­æ“ä½œ

    public class NonAtomicExample {
        private int i = 0;
        
        public void increment() {
            i++;  // å®é™…ä¸ŠåŒ…å«3ä¸ªæ­¥éª¤ï¼š
                  // 1. è¯»å–içš„å€¼ï¼ˆæ¯”å¦‚è¯»å–åˆ°5ï¼‰
                  // 2. è®¡ç®—i+1ï¼ˆå¾—åˆ°6ï¼‰
                  // 3. å°†ç»“æœå†™å›iï¼ˆå†™å…¥6ï¼‰
            // å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼Œå¯èƒ½éƒ½è¯»å–åˆ°5ï¼Œéƒ½è®¡ç®—å¾—åˆ°6ï¼Œéƒ½å†™å…¥6
            // ç»“æœåº”è¯¥æ˜¯7ï¼Œä½†å®é™…æ˜¯6ï¼Œä¸¢å¤±äº†ä¸€æ¬¡æ›´æ–°ï¼
        }
    }
    

### 4.2 CPUå±‚é¢çš„åŸå­æ“ä½œå®ç°

#### 4.2.1 æ€»çº¿é”å®š

**å·¥ä½œåŸç†**ï¼šé€šè¿‡å¤„ç†å™¨çš„LOCK#ä¿¡å·é”å®šæ€»çº¿ï¼Œé˜»æ­¢å…¶ä»–å¤„ç†å™¨è®¿é—®å†…å­˜ã€‚

**é€šä¿—æ¯”å–»**ï¼šä¸ºäº†ä¸€å®¶å°åº—è£…ä¿®ï¼Œå°é”æ•´æ¡å•†ä¸šè¡—ï¼Œæ‰€æœ‰åº—é“ºéƒ½ä¸èƒ½è¥ä¸šã€‚

**ç‰¹ç‚¹**ï¼š

*   âœ… ç»å¯¹å®‰å…¨ï¼šå…¶ä»–CPUå®Œå…¨æ— æ³•å¹²æ‰°
*   âŒ å¼€é”€å·¨å¤§ï¼šå½±å“æ‰€æœ‰å†…å­˜è®¿é—®ï¼Œæ€§èƒ½å·®

#### 4.2.2 ç¼“å­˜é”å®š

**å·¥ä½œåŸç†**ï¼šåˆ©ç”¨ç¼“å­˜ä¸€è‡´æ€§åè®®ï¼ˆMESIï¼‰ï¼Œåªé”å®šç‰¹å®šç¼“å­˜è¡Œã€‚

**é€šä¿—æ¯”å–»**ï¼šåªå°é”è¿™å®¶åº—é“ºè£…ä¿®ï¼Œå…¶ä»–åº—é“ºæ­£å¸¸è¥ä¸šã€‚

**æµç¨‹**ï¼š

    CPU1è¦ä¿®æ”¹æ•°æ®Xï¼ˆåœ¨ç¼“å­˜ä¸­ï¼‰
    â†“
    CPU1é”å®šè‡ªå·±ç¼“å­˜ä¸­çš„X
    â†“  
    CPU1é€šçŸ¥å…¶ä»–CPUï¼š"æˆ‘æ­£è¦ä¿®æ”¹Xï¼Œä½ ä»¬çš„å‰¯æœ¬éƒ½ä½œåºŸï¼"
    â†“
    å…¶ä»–CPUæ ‡è®°è‡ªå·±ç¼“å­˜ä¸­çš„Xä¸º"æ— æ•ˆ"
    â†“
    CPU1å®‰å…¨åœ°ä¿®æ”¹X
    â†“
    å…¶ä»–CPUä¸‹æ¬¡éœ€è¦Xæ—¶ï¼Œå¿…é¡»é‡æ–°ä»å†…å­˜åŠ è½½æœ€æ–°å€¼
    

### 4.3 Javaä¸­çš„åŸå­æ“ä½œå®ç°

#### 4.3.1 åŸºäºCASçš„åŸå­ç±»

    import java.util.concurrent.atomic.AtomicInteger;
    
    public class AtomicExample {
        private AtomicInteger atomicI = new AtomicInteger(0);
        private int normalI = 0;
        
        // çº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ - ä½¿ç”¨CAS
        public void safeIncrement() {
            atomicI.incrementAndGet();  // åº•å±‚ä½¿ç”¨CASï¼Œä¿è¯åŸå­æ€§
        }
        
        // éçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨ - å¯èƒ½ä¸¢å¤±æ›´æ–°
        public void unsafeIncrement() {
            normalI++;  // éåŸå­æ“ä½œï¼Œå¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œæ—¶å¯èƒ½ä¸¢å¤±æ›´æ–°
        }
        
        // æ‰‹åŠ¨å®ç°CAS - å±•ç¤ºåŸç†
        public void manualCAS() {
            int oldValue, newValue;
            do {
                oldValue = atomicI.get();      // è¯»å–å½“å‰å€¼
                newValue = oldValue + 1;       // è®¡ç®—æ–°å€¼
                // CAS: å¦‚æœå½“å‰å€¼è¿˜æ˜¯oldValueï¼Œå°±æ›´æ–°ä¸ºnewValue
                // å¦åˆ™é‡è¯•ï¼ˆè¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†å€¼ï¼‰
            } while (!atomicI.compareAndSet(oldValue, newValue));
        }
        
        public static void main(String[] args) throws InterruptedException {
            AtomicExample example = new AtomicExample();
            
            // åˆ›å»ºå¤šä¸ªçº¿ç¨‹åŒæ—¶å¢åŠ è®¡æ•°å™¨
            Thread[] threads = new Thread[10];
            for (int i = 0; i < threads.length; i++) {
                threads[i] = new Thread(() -> {
                    for (int j = 0; j < 1000; j++) {
                        example.safeIncrement();    // åŸå­æ“ä½œï¼Œç»“æœæ­£ç¡®
                        example.unsafeIncrement();  // éåŸå­æ“ä½œï¼Œç»“æœé”™è¯¯
                    }
                });
                threads[i].start();
            }
            
            for (Thread t : threads) {
                t.join();
            }
            
            System.out.println("åŸå­è®¡æ•°å™¨ç»“æœ: " + example.atomicI.get()); // ä¸€å®šæ˜¯10000
            System.out.println("æ™®é€šè®¡æ•°å™¨ç»“æœ: " + example.normalI);       // å¯èƒ½å°äº10000
        }
    }
    

#### 4.3.2 CASçš„åº•å±‚å®ç°

Javaçš„CASæ“ä½œåˆ©ç”¨å¤„ç†å™¨çš„`CMPXCHG`æŒ‡ä»¤ï¼š

    // Javaå±‚é¢çš„CASè°ƒç”¨
    boolean success = atomicI.compareAndSet(expect, update);
    
    // åº•å±‚å¯¹åº”CPUæŒ‡ä»¤
    CMPXCHG [memory], expect, update
    // æ¯”è¾ƒmemoryå¤„çš„å€¼ä¸expect
    // å¦‚æœç›¸ç­‰ï¼Œå°†updateå†™å…¥memoryï¼Œè®¾ç½®æ ‡å¿—ä½
    // å¦åˆ™ï¼Œä¸åšæ“ä½œï¼Œæ¸…é™¤æ ‡å¿—ä½
    

**é€šä¿—æ¯”å–»**ï¼šCASå°±åƒä¹è§‚çš„åˆç§Ÿå®¤å‹ï¼š

1.  å‡ºé—¨å‰çœ‹ä¸€çœ¼å†°ç®±æœ‰3ä¸ªè‹¹æœ
2.  ä¹°èœå›æ¥ï¼Œæƒ³æ”¾2ä¸ªè‹¹æœè¿›å»ï¼ˆæœŸæœ›æ€»æ•°5ä¸ªï¼‰
3.  æ”¾ä¹‹å‰å†æ£€æŸ¥ä¸€ä¸‹ï¼šå¦‚æœè¿˜æ˜¯3ä¸ªï¼Œå°±æ”¾å…¥2ä¸ªå˜æˆ5ä¸ª
4.  å¦‚æœå·²ç»è¢« roommate åŠ¨è¿‡ï¼ˆå˜æˆ2ä¸ªæˆ–4ä¸ªï¼‰ï¼Œå°±ä¸æ”¾å…¥äº†ï¼Œé‡æ–°è®¡åˆ’

### 4.4 CASçš„ä¸‰å¤§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šABAé—®é¢˜

**åœºæ™¯**ï¼šå€¼ä»Aå˜æˆBåˆå˜å›Aï¼ŒCASæ£€æŸ¥æ—¶è®¤ä¸ºæ²¡æœ‰å˜åŒ–ã€‚

    // å­˜åœ¨ABAé—®é¢˜çš„åœºæ™¯
    public class ABAProblem {
        private AtomicInteger atomicValue = new AtomicInteger(1);
        
        public void demonstrateABA() {
            // çº¿ç¨‹1ï¼šA -> B -> A
            atomicValue.set(2);  // Aâ†’B
            atomicValue.set(1);  // Bâ†’A
            
            // çº¿ç¨‹2ï¼šæ£€æŸ¥åˆ°å€¼è¿˜æ˜¯1ï¼Œè®¤ä¸ºæ²¡æœ‰è¢«ä¿®æ”¹è¿‡
            boolean success = atomicValue.compareAndSet(1, 3);
            // success = trueï¼Œä½†å®é™…ä¸Šå€¼å·²ç»å˜åŒ–è¿‡äº†ï¼
            System.out.println("CASæˆåŠŸ: " + success); // è¾“å‡ºtrue
        }
    }
    

**é€šä¿—æ¯”å–»**ï¼šä½ ç¦»å¼€æ—¶æˆ¿é—´å¾ˆä¹±ï¼ˆAï¼‰ï¼Œå®¤å‹æ‰“æ‰«å¹²å‡€ï¼ˆBï¼‰ç„¶ååˆå¼„ä¹±ï¼ˆAï¼‰ã€‚ä½ å›æ¥ä¸€çœ‹ï¼š"è¿˜æ˜¯é‚£ä¹ˆä¹±ï¼Œæ²¡äººåŠ¨è¿‡å˜›ï¼" ä½†å®é™…ä¸Šæˆ¿é—´ç»å†äº†å¾ˆå¤šå˜åŒ–ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ç‰ˆæœ¬å·

    import java.util.concurrent.atomic.AtomicStampedReference;
    
    public class ABASolution {
        private AtomicStampedReference<Integer> atomicStampedRef = 
            new AtomicStampedReference<>(1, 0); // åˆå§‹å€¼1ï¼Œç‰ˆæœ¬å·0
        
        public void safeUpdate() {
            int[] stampHolder = new int[1];
            int expectedValue = atomicStampedRef.get(stampHolder);
            int newValue = expectedValue + 1;
            int expectedStamp = stampHolder[0];  // æœŸæœ›çš„ç‰ˆæœ¬å·
            int newStamp = expectedStamp + 1;    // æ–°ç‰ˆæœ¬å·
            
            // åŒæ—¶æ£€æŸ¥å€¼å’Œç‰ˆæœ¬æˆ³
            boolean success = atomicStampedRef.compareAndSet(
                expectedValue, newValue, expectedStamp, newStamp);
            
            System.out.println("æ›´æ–°" + (success ? "æˆåŠŸ" : "å¤±è´¥"));
        }
        
        public void demonstrateSolution() {
            // çº¿ç¨‹1ï¼š1â‚€ â†’ 2â‚ â†’ 1â‚‚ ï¼ˆå€¼+ç‰ˆæœ¬å·ï¼‰
            atomicStampedRef.set(2, 1);  // 1â‚€ â†’ 2â‚
            atomicStampedRef.set(1, 2);  // 2â‚ â†’ 1â‚‚
            
            // çº¿ç¨‹2ï¼šæœŸæœ› 1â‚€ï¼Œå®é™…æ˜¯ 1â‚‚ï¼Œç‰ˆæœ¬å·ä¸åŒ¹é…ï¼Œæ›´æ–°å¤±è´¥ï¼
            safeUpdate(); // è¾“å‡º"æ›´æ–°å¤±è´¥"
        }
    }
    

#### é—®é¢˜2ï¼šå¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§

å¦‚æœç«äº‰æ¿€çƒˆï¼Œçº¿ç¨‹å¯èƒ½ä¸€ç›´å¾ªç¯é‡è¯•ï¼Œæµªè´¹CPUã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šè‡ªé€‚åº”è‡ªæ—‹ã€pauseæŒ‡ä»¤

    // JVMå†…éƒ¨çš„ä¼˜åŒ–ç­–ç•¥
    public class CASOptimization {
        // 1. è‡ªé€‚åº”è‡ªæ—‹ï¼šæ ¹æ®å†å²æˆåŠŸç‡è°ƒæ•´è‡ªæ—‹æ¬¡æ•°
        //    - å¦‚æœç»å¸¸æˆåŠŸï¼Œå¤šè‡ªæ—‹ä¸€ä¼š
        //    - å¦‚æœç»å¸¸å¤±è´¥ï¼Œå°‘è‡ªæ—‹ç”šè‡³ç›´æ¥é˜»å¡
        
        // 2. ä½¿ç”¨pauseæŒ‡ä»¤å‡å°‘CPUèƒ½è€—
        //    - è®©CPUåœ¨é‡è¯•é—´ç¨ä½œä¼‘æ¯
        //    - å‡å°‘èƒ½è€—ï¼Œé¿å…"å†…å­˜é¡ºåºå†²çª"å¯¼è‡´çš„æµæ°´çº¿æ¸…ç©º
        
        // 3. è¾¾åˆ°ä¸€å®šè‡ªæ—‹æ¬¡æ•°åå‡çº§ä¸ºé‡é‡çº§é”
    }
    

#### é—®é¢˜3ï¼šåªèƒ½æ“ä½œå•ä¸ªå˜é‡

CASä¸€æ¬¡åªèƒ½ä¿è¯ä¸€ä¸ªå˜é‡çš„åŸå­æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

    public class MultipleVariables {
        // æ–¹æ¡ˆ1ï¼šå¤šä¸ªå˜é‡ä½¿ç”¨é”
        private int x, y;
        private final Object lock = new Object();
        
        public void updateWithLock(int newX, int newY) {
            synchronized(lock) {
                x = newX;
                y = newY;
            }
        }
        
        // æ–¹æ¡ˆ2ï¼šä½¿ç”¨AtomicReferenceæ‰“åŒ…å¤šä¸ªå˜é‡
        private static class Point {
            final int x;
            final int y;
            Point(int x, int y) { this.x = x; this.y = y; }
        }
        
        private final AtomicReference<Point> values = 
            new AtomicReference<>(new Point(0, 0));
        
        public void updateWithAtomicReference(int newX, int newY) {
            Point current;
            Point newPoint;
            do {
                current = values.get();
                newPoint = new Point(newX, newY);
            } while (!values.compareAndSet(current, newPoint));
        }
    }
    

äº”ã€å®æˆ˜ï¼šé€‰æ‹©åˆé€‚çš„å¹¶å‘æ§åˆ¶æœºåˆ¶
----------------

### 5.1 æ€§èƒ½å¯¹æ¯”åŸºå‡†æµ‹è¯•

    import java.util.concurrent.atomic.AtomicInteger;
    import java.util.concurrent.atomic.LongAdder;
    
    public class ConcurrentBenchmark {
        private volatile boolean volatileFlag;
        private final Object lock = new Object();
        private int synchronizedCounter = 0;
        private AtomicInteger atomicCounter = new AtomicInteger(0);
        private LongAdder adderCounter = new LongAdder();
        
        // æµ‹è¯•ä¸åŒå®ç°æ–¹å¼çš„æ€§èƒ½
        public long benchmarkVolatile(int iterations) {
            long start = System.nanoTime();
            for (int i = 0; i < iterations; i++) {
                volatileFlag = !volatileFlag; // volatileå†™
            }
            return System.nanoTime() - start;
        }
        
        public long benchmarkSynchronized(int iterations) {
            long start = System.nanoTime();
            for (int i = 0; i < iterations; i++) {
                synchronized(lock) {
                    synchronizedCounter++;
                }
            }
            return System.nanoTime() - start;
        }
        
        public long benchmarkAtomic(int iterations) {
            long start = System.nanoTime();
            for (int i = 0; i < iterations; i++) {
                atomicCounter.incrementAndGet();
            }
            return System.nanoTime() - start;
        }
        
        public long benchmarkLongAdder(int iterations) {
            long start = System.nanoTime();
            for (int i = 0; i < iterations; i++) {
                adderCounter.increment();
            }
            return System.nanoTime() - start;
        }
    }
    

### 5.2 é€‰æ‹©æŒ‡å—

åœºæ™¯

æ¨èæ–¹æ¡ˆ

ç†ç”±

ä»£ç ç¤ºä¾‹

çŠ¶æ€æ ‡å¿—ä½

`volatile`

è½»é‡çº§ï¼Œä¿è¯å¯è§æ€§

`volatile boolean running`

ç®€å•è®¡æ•°å™¨ï¼Œä½ç«äº‰

`AtomicInteger`

åŸºäºCASï¼Œæ— é˜»å¡

`AtomicInteger counter`

é«˜å¹¶å‘è®¡æ•°å™¨

`LongAdder`

å‡å°‘CASç«äº‰

`LongAdder totalRequests`

å¤æ‚åŒæ­¥é€»è¾‘

`synchronized`

JVMè‡ªåŠ¨ä¼˜åŒ–ï¼Œå¼€å‘ç®€å•

`synchronized(lock)`

éœ€è¦è¶…æ—¶/ä¸­æ–­

`ReentrantLock`

åŠŸèƒ½æ›´ä¸°å¯Œ

`lock.tryLock(100ms)`

### 5.3 æœ€ä½³å®è·µç¤ºä¾‹

    public class ConcurrentBestPractices {
        // 1. çŠ¶æ€æ ‡å¿— - ä½¿ç”¨volatileï¼ˆä¿è¯å¯è§æ€§ï¼Œä¸ä¿è¯åŸå­æ€§ï¼‰
        private volatile boolean shutdownRequested = false;
        
        public void shutdown() {
            shutdownRequested = true;  // æ‰€æœ‰çº¿ç¨‹ç«‹å³å¯è§
        }
        
        public void workerThread() {
            while (!shutdownRequested) {
                // å¤„ç†ä»»åŠ¡...
            }
        }
        
        // 2. ç®€å•è®¡æ•°å™¨ - ä½¿ç”¨Atomicç±»ï¼ˆä¿è¯åŸå­æ€§ï¼‰
        private final AtomicInteger requestCount = new AtomicInteger(0);
        
        public void handleRequest() {
            requestCount.incrementAndGet(); // åŸå­æ“ä½œ
            // å¤„ç†è¯·æ±‚...
        }
        
        // 3. å¤æ‚å¯¹è±¡çŠ¶æ€æ›´æ–° - ä½¿ç”¨synchronized
        private final List<String> logEntries = new ArrayList<>();
        
        public void addLogEntry(String entry) {
            synchronized(logEntries) {
                logEntries.add(entry);
                // å…¶ä»–å¤æ‚é€»è¾‘...
                if (logEntries.size() > 1000) {
                    logEntries.subList(0, 500).clear(); // éœ€è¦åŸå­æ€§
                }
            }
        }
        
        // 4. é¿å…ä¼ªå…±äº« - ä½¿ç”¨å¡«å……
        private static class PaddedAtomicLong extends AtomicLong {
            // å¡«å……ç¼“å­˜è¡Œï¼Œé¿å…ä¸ç›¸é‚»å˜é‡å…±äº«ç¼“å­˜è¡Œ
            public volatile long p1, p2, p3, p4, p5, p6, p7 = 7L;
        }
        
        // 5. æ ¹æ®ç«äº‰ç¨‹åº¦é€‰æ‹©æ–¹æ¡ˆ
        public void smartIncrement() {
            // ä½ç«äº‰æ—¶ä½¿ç”¨CAS
            if (atomicCounter.get() < 1000) {
                atomicCounter.incrementAndGet();
            } else {
                // é«˜ç«äº‰æ—¶ä½¿ç”¨LongAdder
                adderCounter.increment();
            }
        }
    }
    

å…­ã€æ€»ç»“
----

Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚å®ç°æ˜¯ä¸€ä¸ªå¤šå±‚æ¬¡åä½œçš„å¤æ‚ç³»ç»Ÿï¼Œç†è§£è¿™äº›åŸç†å¯¹äºç¼–å†™é«˜æ€§èƒ½ã€çº¿ç¨‹å®‰å…¨çš„ä»£ç è‡³å…³é‡è¦ã€‚

### 6.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

1.  **volatile**ï¼š
    
    *   é€šè¿‡å†…å­˜å±éšœä¿è¯å¯è§æ€§å’Œé¡ºåºæ€§
    *   åº•å±‚ä½¿ç”¨Lockå‰ç¼€æŒ‡ä»¤å’Œç¼“å­˜ä¸€è‡´æ€§åè®®
    *   é€‚åˆçŠ¶æ€æ ‡å¿—ï¼Œä¸ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§
2.  **synchronized**ï¼š
    
    *   åŸºäºå¯¹è±¡å¤´å’ŒMonitorå®ç°
    *   æ™ºèƒ½çš„é”å‡çº§æœºåˆ¶ï¼šåå‘é”â†’è½»é‡çº§é”â†’é‡é‡çº§é”
    *   åœ¨ä¿è¯çº¿ç¨‹å®‰å…¨çš„åŒæ—¶å°½é‡é™ä½å¼€é”€
3.  **åŸå­æ“ä½œ**ï¼š
    
    *   CPUå±‚é¢é€šè¿‡æ€»çº¿é”å®šæˆ–ç¼“å­˜é”å®šå®ç°
    *   Javaå±‚é¢é€šè¿‡CASå¾ªç¯å®ç°
    *   éœ€è¦å¤„ç†ABAé—®é¢˜ã€å¾ªç¯å¼€é”€ç­‰é—®é¢˜

### 6.2 è®¾è®¡å“²å­¦

Javaå¹¶å‘æœºåˆ¶çš„è®¾è®¡ä½“ç°äº†é‡è¦çš„å·¥ç¨‹å“²å­¦ï¼š

*   **æ— ç«äº‰ä¼˜åŒ–**ï¼šé€šè¿‡åå‘é”ç­‰æœºåˆ¶ï¼Œè®©æ— ç«äº‰æƒ…å†µä¸‹çš„å¼€é”€æœ€å°
*   **æ¸è¿›å¼å‡çº§**ï¼šæ ¹æ®ç«äº‰æ¿€çƒˆç¨‹åº¦è‡ªåŠ¨é€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶
*   **å¹³å°é€‚åº”æ€§**ï¼šå……åˆ†åˆ©ç”¨ä¸åŒCPUæ¶æ„çš„ç‰¹æ€§
*   **å¼€å‘ä¾¿åˆ©æ€§**ï¼šæä¾›é«˜å±‚æŠ½è±¡ï¼Œéšè—åº•å±‚å¤æ‚æ€§

### 6.3 å­¦ä¹ å»ºè®®

è¦çœŸæ­£æŒæ¡Javaå¹¶å‘ç¼–ç¨‹ï¼Œå»ºè®®ï¼š

1.  **ç†è§£åŸç†**ï¼šä¸ä»…è¦ä¼šç”¨ï¼Œæ›´è¦æ˜ç™½ä¸ºä»€ä¹ˆè¿™æ ·ç”¨
2.  **åˆ†æåœºæ™¯**ï¼šæ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©æœ€åˆé€‚çš„å¹¶å‘æ§åˆ¶æœºåˆ¶
3.  **å…³æ³¨æ€§èƒ½**ï¼šåœ¨ä¿è¯æ­£ç¡®æ€§çš„å‰æä¸‹è€ƒè™‘æ€§èƒ½å½±å“
4.  **æŒç»­å­¦ä¹ **ï¼šJavaå¹¶å‘åº“åœ¨ä¸æ–­æ¼”è¿›ï¼Œä¿æŒå­¦ä¹ å¿ƒæ€
5.  **å®è·µéªŒè¯**ï¼šé€šè¿‡æµ‹è¯•å’Œæ€§èƒ½åˆ†æéªŒè¯ç†è§£æ˜¯å¦æ­£ç¡®

### 6.4 æ€ç»´æ¨¡å‹

å»ºç«‹æ­£ç¡®çš„å¹¶å‘æ€ç»´æ¨¡å‹ï¼š

*   **æŠŠCPUç¼“å­˜æƒ³è±¡æˆ**ï¼šæ¯ä¸ªçº¿ç¨‹çš„ç§äººå·¥ä½œç©ºé—´
*   **æŠŠå†…å­˜å±éšœæƒ³è±¡æˆ**ï¼šåŒæ­¥ç‚¹çš„"æ£€æŸ¥ç«™"
*   **æŠŠé”æƒ³è±¡æˆ**ï¼šèµ„æºçš„è®¿é—®æƒé™ä»¤ç‰Œ
*   **æŠŠCASæƒ³è±¡æˆ**ï¼šä¹è§‚çš„å¹¶å‘æ§åˆ¶ç­–ç•¥

é€šè¿‡æ·±å…¥ç†è§£è¿™äº›åº•å±‚åŸç†ï¼Œæˆ‘ä»¬ä¸ä»…èƒ½å¤Ÿå†™å‡ºæ›´å¥½çš„å¹¶å‘ä»£ç ï¼Œä¹Ÿèƒ½å¤Ÿåœ¨é‡åˆ°å¹¶å‘é—®é¢˜æ—¶å¿«é€Ÿå®šä½å’Œè§£å†³ï¼ŒçœŸæ­£æˆä¸ºå¹¶å‘ç¼–ç¨‹çš„ä¸“å®¶ã€‚

è®°ä½ï¼š**å¹¶å‘bugå¾€å¾€åœ¨æœ€æ„æƒ³ä¸åˆ°çš„æ—¶å€™å‡ºç°ï¼Œåªæœ‰æ·±å…¥ç†è§£åŸç†ï¼Œæ‰èƒ½é˜²æ‚£äºæœªç„¶ã€‚**

* * *

**è¿›ä¸€æ­¥å­¦ä¹ èµ„æº**ï¼š

*   [Java Language Specification](https://docs.oracle.com/javase/specs/)
*   [Intel 64 and IA-32 Architectures Software Developer's Manual](https://www.intel.com/content/www/us/en/developer/articles/technical/intel-sdm.html)
*   [ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹](https://book.douban.com/subject/10484692/)
*   [ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹](https://book.douban.com/subject/34907497/)

_æœ¬æ–‡é€šè¿‡é€šä¿—æ˜“æ‡‚çš„æ¯”å–»å’Œä»£ç ç¤ºä¾‹ï¼Œæ­ç¤ºäº†Javaå¹¶å‘æœºåˆ¶çš„åº•å±‚åŸç†ï¼Œå¸Œæœ›å¯¹ä½ çš„å¹¶å‘ç¼–ç¨‹ä¹‹æ—…æœ‰æ‰€å¸®åŠ©ï¼_

â¤ï¸ å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·ç‚¹èµæ”¯æŒï¼ ğŸ‘ åŒæ—¶æ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢ï¼Œè·å–æ›´å¤šç²¾å½©å†…å®¹ï¼

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ä½›ç¥–è®©æˆ‘æ¥å·¡å±±](https://www.cnblogs.com/sun-10387834/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/sun-10387834/p/19137887](https://www.cnblogs.com/sun-10387834/p/19137887)