---
layout: post
title: 'ä¸åŒDjangoæœåŠ¡å™¨å’Œéƒ¨ç½²æ–¹å¼çš„æ€§èƒ½è°ƒç ”'
date: "2026-01-14T00:47:34Z"
---
ä¸åŒDjangoæœåŠ¡å™¨å’Œéƒ¨ç½²æ–¹å¼çš„æ€§èƒ½è°ƒç ”
=====================

å‰è¨€
--

æœ€è¿‘æˆ‘èŠ±äº†å¾ˆå¤šæ—¶é—´æŠ˜è…¾ DjangoStarterã€‚

ä¸Šæ¬¡è¯´åˆ°æŠŠæœåŠ¡å™¨æ¢æˆäº† [Rust å¼€å‘çš„ Granian](https://blog.deali.cn/p/granian-django-asgi-server)

è™½ç„¶æ˜¯æŠŠ Nginx å®¹å™¨å»æ‰äº†ï¼Œæ–¹ä¾¿äº†ï¼Œä½†æ€§èƒ½è¿˜æ˜¯ä¸å¤ªæ»¡æ„ã€‚

ç´¢æ€§å¯¹å¤§éƒ¨åˆ†èƒ½ç”¨çš„æœåŠ¡å™¨æ¥æ‹¿æ¥æŒ¨ä¸ªå°è¯•ï¼ŒåŒæ—¶å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ã€‚

ç»è¿‡è¿™å‡ å¤©ï¼ŒèŠ±è´¹å¤§é‡æ—¶é—´è¿›è¡Œç¯å¢ƒé…ç½®ã€ä»£ç ä¿®æ”¹ã€æ€§èƒ½æµ‹è¯•ï¼Œæœ€åæˆ‘æ€»ç»“å‡º DjangoStarter æ¡†æ¶æ­é…ä¸åŒçš„æœåŠ¡å™¨çš„æ€§èƒ½è¡¨ç°ã€‚

> PSï¼šç°åœ¨ AI çš„æµè¡Œè®©å¤§éƒ¨åˆ†ä»‹ç»åŸºç¡€çš„æŠ€æœ¯æ–‡ç« å¤±å»äº†æ„ä¹‰ï¼Œæˆ‘ç°åœ¨å†™æ–‡ç« ä¹ŸåŸºæœ¬æ˜¯å½“æˆç¬”è®°åœ¨ç”¨äº†ï¼Œè€Œä¸”ä¹Ÿå°½é‡é¿å…å†™å¾ˆæ°´çš„åŸºç¡€ä»‹ç»ï¼Œæ„ä¹‰ä¸å¤§ğŸ˜…

å¤§å®¶ä¸çˆ±çœ‹çš„ä»£ç å’Œè¯¦ç»†æ•°æ®éƒ¨åˆ†æˆ‘æ”¾åœ¨åº•ä¸‹ã€‚

æµ‹è¯•ç¯å¢ƒ
----

æœ¬æ¬¡æµ‹è¯•çš„é¡¹ç›®éƒ¨ç½²åœ¨è…¾è®¯äº‘2C2Gçš„å°æ°´ç®¡æœåŠ¡å™¨ä¸Šï¼Œæ„Ÿè§‰æœåŠ¡å™¨æ€§èƒ½ä¸¥é‡æ‹–ç´¯äº†åº”ç”¨æ€§èƒ½å“ˆå“ˆğŸ¤£

è€Œä¸”æˆ‘è¿˜å‘ç°ä¸€ä¸ªäº‹æƒ…ï¼Œè…¾è®¯äº‘ä¼¼ä¹å·å·æ‘¸æ‘¸åœ¨é«˜å³°æœŸï¼ˆå¦‚ä¸‹åˆï¼‰æŠŠæœåŠ¡å™¨æ€§èƒ½é™ä½ï¼Œä¸‹åˆå’Œå‡Œæ™¨æµ‹è¯•çš„ç»“æœæœ‰å¾ˆå¤§å·®å¼‚ã€‚

æœ¬æ¬¡å‚ä¸æµ‹è¯•çš„wsgi/asgiæœåŠ¡å™¨æœ‰ daphne, granian, gunicorn, uwsgi, uvicorn, hypercorn åŸºæœ¬æ¶µç›–äº† python ç”Ÿæ€çš„å¤§éƒ¨åˆ†æœåŠ¡å™¨äº†~

æœ¬æ¬¡ä½¿ç”¨ wrk ä½œä¸ºæ€§èƒ½æµ‹è¯•åŠŸèƒ½ï¼Œæ‰€æœ‰æ¥å£éƒ½ä½¿ç”¨ `-t4 -c200 -d30s` çš„æµ‹è¯•å‚æ•°ã€‚

æ€§èƒ½æµ‹è¯•ç»“è®º
------

### RPS æ’å

æ’å

server

req/sec

æ¥å£

ğŸ¥‡ 1

**uWSGI + WSGI**

**1206**

WSGI

ğŸ¥ˆ 2

**Gunicorn + WSGI**

**740**

WSGI

ğŸ¥‰ 3

Granian + ASGI

220

ASGI

4

Daphne + ASGI

190

ASGI

5

Uvicorn + ASGI

181

ASGI

6

Hypercorn + ASGI

168

ASGI

**ç»“è®ºï¼š**

*   WSGI æ•´ä½“è¿œå¿«äº ASGI
    
    è¿™æ˜¯é¢„æœŸç»“æœï¼ŒDjango çš„å†…éƒ¨åŸç”Ÿå°±æ˜¯ WSGIï¼ŒåŒæ­¥è·¯ç”±ä¸éœ€è¦é¢å¤–çš„ async è½¬æ¢ã€‚
    
*   uWSGI å†æ¬¡è¯æ˜è‡ªå·±æ˜¯ WSGI æ€§èƒ½ä¹‹ç‹
    
    uWSGI çš„ C å®ç°ã€æˆç†Ÿçš„ worker ç®¡ç†ã€å†…å­˜åˆ©ç”¨ä¼˜åŒ–éƒ½è®©å®ƒåœ¨çº¯ WSGI åœºæ™¯æ— æ•Œã€‚
    

### å†…å­˜å ç”¨å¯¹æ¯”

æ’å

server

å†…å­˜

ğŸ¥‡ 1

**uWSGI**

**58M**ï¼ˆæä½ï¼‰

2

Granian

170M

3

Daphne

175M

4

Hypercorn

300M

5

Gunicorn+WSGI

430M

6

Uvicorn

500Mï¼ˆæœ€é«˜ï¼‰

**ç»“è®º**ï¼š

*   uWSGI ä¸ä»…æœ€å¿«ï¼Œè¿˜æœ€çœå†…å­˜
*   Uvicorn å†…å­˜æœ€é«˜ï¼ˆPython å• worker overhead æ˜æ˜¾ï¼‰
*   ASGI æœåŠ¡å™¨æ™®éå†…å­˜åé«˜æ˜¯æ­£å¸¸ç°è±¡

æ€§èƒ½æµ‹è¯•æ•°æ®
------

ä»¥ä¸‹æ˜¯è¯¦ç»†çš„æ€§èƒ½æµ‹è¯•æ•°æ®ã€‚

### daphne + asgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨175Må·¦å³

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.03s   134.59ms   1.99s    89.71%
        Req/Sec    69.17     64.53   313.00     80.49%
      5737 requests in 30.04s, 2.14MB read
      Socket errors: connect 0, read 0, write 0, timeout 4
    Requests/sec:    190.99
    Transfer/sec:     72.93KB
    

### granian + asgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨170Må·¦å³

    $ curl http://127.0.0wrk -t4 -c200 -d30s875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   886.48ms   79.27ms   1.26s    85.40%
        Req/Sec    86.07    112.58   490.00     84.05%
      6637 requests in 30.04s, 2.72MB read
    Requests/sec:    220.93
    Transfer/sec:     92.56KB
    

### gunicorn + wsgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨430Må·¦å³

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   268.67ms   31.82ms 425.23ms   86.13%
        Req/Sec   187.47    119.54   494.00     56.66%
      22244 requests in 30.03s, 9.52MB read
    Requests/sec:    740.60
    Transfer/sec:    324.74KB
    

### uwsgi + wsgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨58Må·¦å³

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   199.52ms  277.85ms   1.97s    87.56%
        Req/Sec   302.89     88.84   575.00     67.33%
      36210 requests in 30.02s, 12.95MB read
      Socket errors: connect 0, read 36216, write 0, timeout 96
    Requests/sec:   1206.08
    Transfer/sec:    441.68KB
    

### uvicorn + asgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨500Må·¦å³

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency     1.00s   537.23ms   2.00s    59.81%
        Req/Sec    62.04     66.05   460.00     83.03%
      5440 requests in 30.04s, 2.23MB read
      Socket errors: connect 0, read 0, write 0, timeout 369
    Requests/sec:    181.07
    Transfer/sec:     76.05KB
    

### hypercorn + asgi

æµ‹è¯•æ—¶å†…å­˜å³°å€¼å ç”¨300Må·¦å³

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/django-starter/monitoring/health
    Running 30s test @ http://127.0.0.1:9875/api/django-starter/monitoring/health
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   734.64ms  423.05ms   2.00s    51.70%
        Req/Sec    55.53     52.50   360.00     83.49%
      5064 requests in 30.06s, 2.09MB read
      Socket errors: connect 0, read 0, write 0, timeout 1124
    Requests/sec:    168.45
    Transfer/sec:     71.24KB
    

### æ›´ç»†åŒ–çš„æ€§èƒ½æµ‹è¯•

è®¿é—®ä¸€ä¸ªæœ‰æ•°æ®åº“æŸ¥è¯¢çš„æ¥å£ [http://127.0.0.1:9878/api/demo/movie/movie](http://127.0.0.1:9878/api/demo/movie/movie)

ç›´æ¥ uwsgi

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9875/api/demo/movie/movie
    Running 30s test @ http://127.0.0.1:9875/api/demo/movie/movie
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   501.93ms  260.82ms   1.99s    94.20%
        Req/Sec    61.02     39.11   191.00     62.02%
      6726 requests in 30.04s, 15.84MB read
      Socket errors: connect 0, read 6758, write 0, timeout 45
    Requests/sec:    223.89
    Transfer/sec:    539.82KB
    

ç»è¿‡ caddy åä»£

    $ wrk -t4 -c200 -d30s http://127.0.0.1:9878/api/demo/movie/movie
    Running 30s test @ http://127.0.0.1:9878/api/demo/movie/movie
      4 threads and 200 connections
      Thread Stats   Avg      Stdev     Max   +/- Stdev
        Latency   562.46ms  166.56ms   1.65s    88.77%
        Req/Sec    52.66     21.07   150.00     65.63%
      6299 requests in 30.04s, 15.06MB read
      Socket errors: connect 0, read 0, write 0, timeout 208
      Non-2xx or 3xx responses: 40
    Requests/sec:    209.69
    Transfer/sec:    513.30KB
    

ä»£ç 
--

æ¥ä»‹ç»ä¸‹ä»£ç çš„éƒ¨åˆ†ã€‚

è¿™æ¬¡æ‹¿æ¥è¿›è¡Œæ€§èƒ½æµ‹è¯•çš„ä¸»è¦æ˜¯å¥åº·æ£€æŸ¥å’Œä¸€ä¸ªç®€å•çš„æ•°æ®åº“è®¿é—®æ¥å£ã€‚æ‰€æœ‰æ¥å£éƒ½æ˜¯ç”¨ django-ninja å¼€å‘çš„ã€‚

### æ•°æ®åº“è®¿é—®æ¥å£

æ¶‰åŠåˆ°æ•°æ®åº“çš„å°±æ˜¯è¿™ä¸ªæ¥å£

æŸ¥è¯¢æ•°æ®è¿”å›+åˆ†é¡µåŠŸèƒ½ï¼Œéå¸¸ç®€å•

    @router.get('/movie', response=List[MovieOut], url_name='demo/movie/list')
    @paginate
    def list_items(request):
        qs = Movie.objects.all()
        return qs
    

### å¥åº·æ£€æŸ¥æ¥å£

å¼•å…¥è¿™äº›package

    import asyncio
    from ninja import Router
    from django.db import connections
    from django.db.utils import OperationalError
    from redis import Redis
    from redis.exceptions import RedisError
    from redis import asyncio as aioredis
    import os
    import time
    import platform
    import subprocess
    import anyio
    

åŸç‰ˆçš„æ¥å£æ˜¯çº¯åŒæ­¥çš„ï¼Œè¿˜è¦è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿè¿›ç¨‹å»è·å– uptimeï¼Œè¿™ä¸ªæ“ä½œä¸¥é‡æ‹–æ…¢äº†æ•´ä¸ªæ¥å£çš„é€Ÿåº¦ï¼Œæˆ‘è¿™æ¬¡é‡æ„æˆåŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ¥å£ã€‚

é¦–å…ˆæ˜¯æœ€ç®€å•çš„ç‰ˆæœ¬ï¼Œè¿™é‡Œé¢å°±å•¥ä¹Ÿæ²¡æœ‰ï¼Œå•çº¯è¿”å› JSONã€‚

    @router.get('health')
    def simple_health_check(request):
        """å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œç”¨äºå®¹å™¨å¥åº·æ£€æŸ¥å’Œç›‘æ§"""
        response_data = {
            'status': 'healthy',
            'status_code': 200,
        }
    
        return response_data
    

### å¼‚æ­¥æ¥å£

å…ˆæ¥å¼‚æ­¥æ¥å£ã€‚

å…¶å®æˆ‘å¾ˆå°‘ç”¨åˆ° python çš„å¼‚æ­¥åŠŸèƒ½ï¼Œå¯èƒ½è¿™ä¹Ÿå’Œ python å¯¹å¼‚æ­¥çš„æ”¯æŒæ¯”è¾ƒå·®æœ‰å…³ç³»ã€‚

å…ˆå†™ä¸¤ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œç”¨æ¥æ£€æŸ¥æ•°æ®åº“å’ŒRedisè¿æ¥ã€‚

    async def check_db_async():
        """æ•°æ®åº“æ£€æŸ¥ï¼ˆåŒæ­¥ ORM â†’ æ”¾çº¿ç¨‹æ± ï¼‰"""
        try:
            def _check():
                for conn in connections.all():
                    conn.cursor()
                return True
    
            return await anyio.to_thread.run_sync(_check)
        except OperationalError:
            return False
    
    
    async def check_redis_async():
        """Redis å¼‚æ­¥æ£€æŸ¥ï¼ˆæ³¨æ„ï¼šç¡®ä¿å…³é—­å®¢æˆ·ç«¯ä»¥é‡Šæ”¾è¿æ¥æ± ï¼‰"""
        try:
            redis_client = aioredis.Redis(
                host="redis",
                port=6379,
                socket_connect_timeout=1,
                decode_responses=True,
            )
            try:
                ok = await redis_client.ping()
                return bool(ok)
            finally:
                # å…³é—­å®¢æˆ·ç«¯å’Œè¿æ¥æ± ï¼Œé¿å…è¿æ¥æ³„éœ²ï¼ˆåœ¨çŸ­ç”Ÿå‘½å‘¨æœŸçš„å®¹å™¨/è¯·æ±‚é‡Œå¾ˆé‡è¦ï¼‰
                try:
                    await redis_client.close()
                except Exception:
                    pass
                try:
                    await redis_client.connection_pool.disconnect()
                except Exception:
                    pass
        except Exception:
            return False
    

Django ORM ä¸æ”¯æŒå¼‚æ­¥ï¼Œæ‰€ä»¥è¿™é‡Œç”¨ anyio è¿™ä¸ªåŒ…æ¥ç®€åŒ–ä¸€ä¸‹æ“ä½œï¼ŒæŠŠåŒæ­¥æ“ä½œåŒ…è£…ä¸€ä¸‹å‡è£…æˆå¼‚æ­¥è¿è¡Œã€‚å®é™…ä¸Šç”¨ asyncio è¿™ä¸ªåº“ä¹Ÿèƒ½åšï¼Œä¸è¿‡ anyio æ–¹ä¾¿ä¸€ç‚¹ã€‚

åœ¨ç”¨ aioredis æ—¶ï¼Œè¿™é‡Œæœ‰ä¸ªå‘ï¼Œæˆ‘ä¸€å¼€å§‹å®‰è£…äº† aioredis è¿™ä¸ªåŒ…ï¼Œç»“æœå‘ç°å’ŒåŸæœ‰çš„ redis åŒ…å†²çªäº†ã€‚

æŸ¥çœ‹æ–‡æ¡£æ‰å‘ç° `from redis import asyncio as aioredis` å°±å®Œäº‹å„¿äº†ï¼Œredis åŒ…é‡Œå·²ç»è‡ªå¸¦äº†å¼‚æ­¥æ”¯æŒã€‚

æ¥ç€å®ç°å¼‚æ­¥æ¥å£

    @router.get('health/async')
    async def health_check_async(request):
        """Async æ¨¡å¼å¥åº·æ£€æŸ¥ï¼ˆASGI ä¼˜åŒ–ç‰ˆï¼‰"""
        # ä½¿ç”¨ asyncio.gather å¹¶å‘è¿è¡Œ DB å’Œ Redis æ£€æŸ¥
        db_ok, redis_ok = await asyncio.gather(
            check_db_async(),
            check_redis_async(),
        )
    
        status = "healthy" if db_ok and redis_ok else "unhealthy"
        status_code = 200 if status == "healthy" else 503
    
        return {
            "status": status,
            "status_code": status_code,
            "checks": {
                "database": "ok" if db_ok else "error",
                "redis": "ok" if redis_ok else "error",
            },
            "system": get_system_info(),
        }
    

### åŒæ­¥æ¥å£

åŒæ­¥çš„å°±ç®€å•äº†

    @router.get('health/sync')
    def health_check_sync(request):
        """åŒæ­¥ç‰ˆæœ¬çš„å¥åº·æ£€æŸ¥æ¥å£"""
    
        # --- æ£€æŸ¥æ•°æ®åº“ & Redis ---
        db_ok = check_db_sync()
        redis_ok = check_redis_sync()
    
        # --- ç³»ç»Ÿä¿¡æ¯ ---
        system_info = {
            "timestamp": time.time(),
            "uptime": get_uptime(),
            "hostname": os.environ.get("HOSTNAME", ""),
            "environment": os.environ.get("ENVIRONMENT", "development"),
            "os": platform.system(),
        }
    
        # --- çŠ¶æ€ç  ---
        status = "healthy" if db_ok and redis_ok else "unhealthy"
        status_code = 200 if status == "healthy" else 503
    
        # --- è¿”å›æ•°æ® ---
        return {
            "status": status,
            "status_code": status_code,
            "checks": {
                "database": "ok" if db_ok else "error",
                "redis": "ok" if redis_ok else "error",
            },
            "system": system_info,
        }
    

å°ç»“
--

ä¼ ç»Ÿåº”ç”¨æ— è„‘é€‰ uwsgi å°±å¯¹äº†ã€‚

éœ€è¦å¼‚æ­¥çš„å¯ä»¥æŠŠå¼‚æ­¥é‚£éƒ¨åˆ†åˆ‡å‰²å‡ºæ¥ç”¨ granian æˆ–è€… daphne è·‘ã€‚

å½“ç„¶è¿™ä¹Ÿå¢åŠ äº†å¤æ‚åº¦ï¼Œä½†è¿™æ˜¯å¯¹æ€§èƒ½ä¼˜åŒ–çš„æœ€ä½³æƒè¡¡ã€‚

å…ˆè¿™æ ·å§ï¼Œå…¶å®è¿™æ¬¡æ€§èƒ½è°ƒç ”è¿˜è®©æˆ‘å­¦åˆ°å¾ˆå¤šï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ç»§ç»­åˆ†æè¿™æ¬¡çš„æ”¶è·ã€‚

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚