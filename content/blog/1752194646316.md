---
layout: post
title: 'åœ¨ django-ninja ä¸­å®ç°ç±»ä¼¼è…¾è®¯é˜¿é‡Œäº‘çš„åº”ç”¨é‰´æƒæœºåˆ¶'
date: "2025-07-11T00:44:06Z"
---
åœ¨ django-ninja ä¸­å®ç°ç±»ä¼¼è…¾è®¯é˜¿é‡Œäº‘çš„åº”ç”¨é‰´æƒæœºåˆ¶
================================

å‰è¨€
--

æœ¬æ–‡ç« ä»‹ç»å¦‚ä½•ä½¿ç”¨åŸºäº `AppClient` æ¨¡å‹çš„ Django-Ninja API é‰´æƒæœºåˆ¶ã€‚

è¿™ä¹Ÿæ˜¯ä¸Šæ¬¡è¯´çš„ä¸­å°é¡¹ç›®è¡ç”Ÿç‰©

ä¸­å°é¡¹ç›®ç›¸å…³çš„æ–‡ç« ï¼Œæˆ‘å¤§æ¦‚è¿˜ä¼šå†å†™ä¸€ç¯‡

è¿™ä¸ªç³»åˆ—çš„æ–‡ç« æ³¨å®šæ˜¯æ²¡ä»€ä¹ˆäººçœ‹çš„ï¼Œæ¯•ç«Ÿè¿˜æ˜¯å°ä¼—äº†ä¸€äº›

ä¸è¿‡æˆ‘è¿˜æ˜¯å¾—å†™ï¼Œæ²¡æœ‰è¯»è€…ä¹Ÿè¦è®°å½•ï¼Œä»¥åéœ€è¦çš„æ—¶å€™å°±èƒ½ç”¨ä¸Š

> PS: æœ¬æ–‡åŸºäºä½¿ç”¨ [DjangoStarter æ¡†æ¶](https://github.com/Deali-Axy/DjangoStarter)ï¼Œé»˜è®¤è¯»è€…å…·å¤‡ DjangoStarter 3.0 ä»¥ä¸Šç‰ˆæœ¬çš„é¡¹ç›®ç»“æ„ã€åŸºç¡€è®¾æ–½

é™äºç¯‡å¹…å…³ç³»ï¼Œæœ¬æ–‡æ— æ³•è´´å‡ºå…¨éƒ¨ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**APIé‰´æƒ**ã€è·å–å®Œæ•´ä»£ç 

æ¦‚è¿°
--

è¿™å¥—é‰´æƒæœºåˆ¶æä¾›äº†ä»¥ä¸‹åŠŸèƒ½ï¼š

*   å¤šç§è®¤è¯æ–¹å¼ï¼šæ”¯æŒæŸ¥è¯¢å‚æ•°ã€è¯·æ±‚å¤´å’Œ Bearer Token ä¸‰ç§æ–¹å¼
*   IP ç™½åå•ï¼šæ”¯æŒå•ä¸ª IP å’Œ CIDR ç½‘æ®µé™åˆ¶
*   æƒé™èŒƒå›´æ§åˆ¶ï¼šåŸºäº scopes çš„ç»†ç²’åº¦æƒé™ç®¡ç†
*   çŠ¶æ€æ£€æŸ¥ï¼šè‡ªåŠ¨éªŒè¯ AppClient çš„å¯ç”¨çŠ¶æ€
*   å®‰å…¨æ€§ï¼šåŒ…å«å®Œæ•´çš„è®¤è¯å’Œæˆæƒæµç¨‹

æ­é…å®˜æ–¹æ–‡æ¡£é£Ÿç”¨æ›´ä½³å“¦~

[https://django-ninja.dev/guides/authentication/](https://django-ninja.dev/guides/authentication/)

ä½¿ç”¨æ–¹æ³•
----

ä¸ºäº†èƒ½æœ‰ä¸ªç›´è§‚çš„ä½“éªŒ

æˆ‘å…ˆä»‹ç»ä½¿ç”¨æ–¹æ³•

åé¢å†æ¥è®²å®ç°

### 1\. åˆ›å»º AppClient

é¦–å…ˆåœ¨ Django Admin æˆ–é€šè¿‡ä»£ç åˆ›å»ºä¸€ä¸ª AppClientï¼š

    from apps.app.models import AppClient
    
    app_client = AppClient.objects.create(
        app_id="my-app",
        app_name="æˆ‘çš„åº”ç”¨",
        secret_key="your-secret-key-here",
        allowed_ips="192.168.1.0/24,10.0.0.1",  # å¯é€‰ï¼šIP é™åˆ¶
        scopes="project:read,project:write,user:read",  # å¯é€‰ï¼šæƒé™èŒƒå›´
        status=AppClient.Status.ACTIVE
    )
    

### 2\. åœ¨ API ä¸­ä½¿ç”¨è®¤è¯

    from ninja import Router
    from core.authentication import (
       api_key_auth,
       api_key_header_auth,
       api_key_bearer_auth,
       require_app_client_scopes,
       AppClientScopes,
    )
    
    router = Router()
    
    
    # ä½¿ç”¨æŸ¥è¯¢å‚æ•°è®¤è¯
    @router.get("/data", auth=api_key_auth)
    def get_data(request):
       app_client = request.auth
       return {"data": "success", "client": app_client.app_name}
    
    
    # ä½¿ç”¨è¯·æ±‚å¤´è®¤è¯
    @router.get("/info", auth=api_key_header_auth)
    def get_info(request):
       return {"info": "success"}
    
    
    # ä½¿ç”¨ Bearer Token è®¤è¯
    @router.get("/status", auth=api_key_bearer_auth)
    def get_status(request):
       return {"status": "success"}
    

### 3\. æ·»åŠ æƒé™æ§åˆ¶

    # éœ€è¦ç‰¹å®šæƒé™
    @router.get("/projects", auth=app_client_api_key)
    @require_app_client_scopes([AppClientScopes.PROJECT_READ])
    def list_projects(request):
        return {"projects": []}
    
    # éœ€è¦å¤šä¸ªæƒé™
    @router.post("/projects", auth=app_client_api_key)
    @require_app_client_scopes([AppClientScopes.PROJECT_WRITE, AppClientScopes.USER_READ])
    def create_project(request):
        return {"message": "é¡¹ç›®åˆ›å»ºæˆåŠŸ"}
    
    # æ‰‹åŠ¨æ£€æŸ¥æƒé™
    @router.get("/custom-check", auth=app_client_api_key)
    def custom_permission_check(request):
        from core.authentication import AppClientScopeChecker
        
        if AppClientScopeChecker.has_any_scope(request, [AppClientScopes.PROJECT_READ, AppClientScopes.PROJECT_WRITE]):
            return {"access": "granted"}
        else:
            return {"access": "denied"}
    

è®¤è¯æ–¹å¼
----

### 1\. æŸ¥è¯¢å‚æ•°è®¤è¯ (APIKeyQuery)

**ä½¿ç”¨æ–¹å¼ï¼š**

    GET /api/endpoint?api_key=your-secret-key
    

**ä»£ç ç¤ºä¾‹ï¼š**

    from core.authentication import api_key_auth
    
    
    @router.get("/data", auth=api_key_auth)
    def get_data(request):
       return {"data": "success"}
    

### 2\. è¯·æ±‚å¤´è®¤è¯ (APIKeyHeader)

**ä½¿ç”¨æ–¹å¼ï¼š**

    GET /api/endpoint
    X-API-Key: your-secret-key
    

**ä»£ç ç¤ºä¾‹ï¼š**

    from core.authentication import api_key_header_auth
    
    
    @router.get("/data", auth=api_key_header_auth)
    def get_data(request):
       return {"data": "success"}
    

### 3\. Bearer Token è®¤è¯ (HttpBearer)

**ä½¿ç”¨æ–¹å¼ï¼š**

    GET /api/endpoint
    Authorization: Bearer your-secret-key
    

**ä»£ç ç¤ºä¾‹ï¼š**

    from core.authentication import api_key_bearer_auth
    
    
    @router.get("/data", auth=api_key_bearer_auth)
    def get_data(request):
       return {"data": "success"}
    

æƒé™èŒƒå›´ (Scopes) ç³»ç»Ÿ
----------------

äº‹å…ˆè¯´æ˜ï¼Œscopes æ–¹å¼åªæ˜¯å®ç°èµ·æ¥æœ€ç®€å•ï¼Œä½†ä¸ä»£è¡¨æœ€åˆé€‚

æ¯•ç«Ÿåœ¨ Django æ¡†æ¶ä¸­ï¼Œæœ¬æ¥å°±æœ‰ä¸€å¥—æƒé™ä½“ç³»äº†ï¼Œæˆ‘ä¹Ÿæœ‰æƒ³è¿‡æ¥å…¥é‚£å¥—æƒé™ä½“ç³»ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨åå°ç¼–è¾‘æ¯ä¸ªåº”ç”¨çš„æƒé™

ä¸è¿‡å› ä¸ºå®ç°èµ·æ¥ä¼šç¨å¾®éº»çƒ¦ä¸€ç‚¹ç‚¹ï¼Œä¸ºäº†å¿«é€Ÿä¸Šçº¿ï¼Œæˆ‘å°±å…ˆè‡ªå·±æäº†ä¸ª scopes ç³»ç»Ÿäº†~

åç»­è‚¯å®šæ˜¯è¦è¯•è¯• æ¥å…¥ Django æƒé™ä½“ç³» çš„~ï¼

### æƒé™æ ¼å¼

æƒé™èŒƒå›´ä½¿ç”¨ `resource:action` æ ¼å¼ï¼Œä¾‹å¦‚ï¼š

*   `project:read` - é¡¹ç›®è¯»å–æƒé™
*   `project:write` - é¡¹ç›®å†™å…¥æƒé™
*   `user:*` - ç”¨æˆ·ç›¸å…³æ‰€æœ‰æƒé™
*   `*` - è¶…çº§ç®¡ç†å‘˜æƒé™

### é¢„å®šä¹‰æƒé™å¸¸é‡

    from core.authentication import AppClientScopes
    
    # é¡¹ç›®æƒé™
    AppClientScopes.PROJECT_READ     # "project:read"
    AppClientScopes.PROJECT_WRITE    # "project:write"
    AppClientScopes.PROJECT_DELETE   # "project:delete"
    AppClientScopes.PROJECT_ALL      # "project:*"
    
    # ç”¨æˆ·æƒé™
    AppClientScopes.USER_READ        # "user:read"
    AppClientScopes.USER_WRITE       # "user:write"
    AppClientScopes.USER_DELETE      # "user:delete"
    AppClientScopes.USER_ALL         # "user:*"
    
    # è¶…çº§æƒé™
    AppClientScopes.SUPER_ADMIN      # "*"
    

### æƒé™æ£€æŸ¥æ–¹æ³•

#### 1\. è£…é¥°å™¨æ–¹å¼ï¼ˆæ¨èï¼‰

    from core.authentication import require_app_client_scopes, AppClientScopes
    
    @router.get("/projects", auth=app_client_api_key)
    @require_app_client_scopes([AppClientScopes.PROJECT_READ])
    def list_projects(request):
        return {"projects": []}
    

#### 2\. æ‰‹åŠ¨æ£€æŸ¥æ–¹å¼

    from core.authentication import AppClientScopeChecker
    
    @router.get("/data", auth=app_client_api_key)
    def get_data(request):
        # æ£€æŸ¥æ˜¯å¦å…·æœ‰æ‰€æœ‰æŒ‡å®šæƒé™
        if AppClientScopeChecker.check_scopes(request, [AppClientScopes.PROJECT_READ]):
            return {"data": "success"}
        
        # æ£€æŸ¥æ˜¯å¦å…·æœ‰ä»»æ„ä¸€ä¸ªæƒé™
        if AppClientScopeChecker.has_any_scope(request, [AppClientScopes.PROJECT_READ, AppClientScopes.PROJECT_WRITE]):
            return {"data": "partial access"}
        
        # è·å–å®¢æˆ·ç«¯æ‰€æœ‰æƒé™
        scopes = AppClientScopeChecker.get_client_scopes(request)
        return {"error": "æƒé™ä¸è¶³", "your_scopes": scopes}
    

IP ç™½åå•
------

### é…ç½® IP é™åˆ¶

åœ¨ AppClient çš„ `allowed_ips` å­—æ®µä¸­é…ç½®å…è®¸çš„ IP åœ°å€ï¼š

    # å•ä¸ª IP
    app_client.allowed_ips = "192.168.1.100"
    
    # å¤šä¸ª IP
    app_client.allowed_ips = "192.168.1.100,10.0.0.1,203.0.113.5"
    
    # CIDR ç½‘æ®µ
    app_client.allowed_ips = "192.168.1.0/24,10.0.0.0/8"
    
    # æ··åˆé…ç½®
    app_client.allowed_ips = "192.168.1.100,10.0.0.0/8,203.0.113.0/24"
    
    # ä¸é™åˆ¶ IPï¼ˆç•™ç©ºæˆ– Noneï¼‰
    app_client.allowed_ips = None
    

### IP è·å–é€»è¾‘

ç³»ç»Ÿä¼šæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§è·å–å®¢æˆ·ç«¯ IPï¼š

1.  `HTTP_X_FORWARDED_FOR` å¤´éƒ¨çš„ç¬¬ä¸€ä¸ª IPï¼ˆé€‚ç”¨äºä»£ç†/è´Ÿè½½å‡è¡¡ç¯å¢ƒï¼‰
2.  `REMOTE_ADDR`ï¼ˆç›´æ¥è¿æ¥çš„ IPï¼‰

é”™è¯¯å¤„ç†
----

### è®¤è¯å¤±è´¥

å½“è®¤è¯å¤±è´¥æ—¶ï¼Œä¼šè¿”å› HTTP 401 é”™è¯¯ï¼š

    {
        "detail": "Unauthorized"
    }
    

### æƒé™ä¸è¶³

å½“æƒé™æ£€æŸ¥å¤±è´¥æ—¶ï¼Œä¼šè¿”å› HTTP 403 é”™è¯¯ï¼š

    {
        "detail": "ç¼ºå°‘æƒé™: project:write"
    }
    

### è‡ªå®šä¹‰é”™è¯¯å¤„ç†

    from core.authentication import AppClientPermissionError
    
    @router.get("/custom", auth=app_client_api_key)
    def custom_endpoint(request):
        if not some_condition:
            raise AppClientPermissionError("è‡ªå®šä¹‰æƒé™é”™è¯¯ä¿¡æ¯")
        return {"data": "success"}
    

æµ‹è¯• API
------

é¡¹ç›®æä¾›äº†å®Œæ•´çš„æµ‹è¯• APIï¼Œå¯ä»¥ç”¨æ¥éªŒè¯è®¤è¯å’Œæƒé™åŠŸèƒ½ï¼š

    # æµ‹è¯• API Key è®¤è¯
    GET /api/app/test/api-key?api_key=your-secret-key
    
    # æµ‹è¯•è¯·æ±‚å¤´è®¤è¯
    GET /api/app/test/api-key-header
    X-API-Key: your-secret-key
    
    # æµ‹è¯• Bearer Token è®¤è¯
    GET /api/app/test/bearer
    Authorization: Bearer your-secret-key
    
    # æµ‹è¯•æƒé™èŒƒå›´
    GET /api/app/test/scopes/project-read?api_key=your-secret-key
    GET /api/app/test/scopes/project-write?api_key=your-secret-key
    GET /api/app/test/scopes/multiple?api_key=your-secret-key
    

æœ€ä½³å®è·µ
----

ä»¥ä¸‹æ˜¯ä¸€äº›æœ€ä½³å®è·µçš„å»ºè®®

æ— è®ºæ˜¯ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯ã€æ¡†æ¶ï¼Œå®é™…å¼€å‘ä¸­éƒ½å¯ä»¥å‚è€ƒä¸€ä¸‹

### 1\. å¯†é’¥ç®¡ç†

*   ä½¿ç”¨å¼ºå¯†é’¥ï¼ˆå»ºè®® 32 å­—ç¬¦ä»¥ä¸Šï¼‰
*   å®šæœŸè½®æ¢å¯†é’¥
*   ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
*   ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å®‰å…¨çš„é…ç½®ç®¡ç†ç³»ç»Ÿ

### 2\. æƒé™è®¾è®¡

*   éµå¾ªæœ€å°æƒé™åŸåˆ™
*   ä½¿ç”¨ç»†ç²’åº¦çš„æƒé™èŒƒå›´
*   å®šæœŸå®¡æŸ¥å’Œæ¸…ç†ä¸å¿…è¦çš„æƒé™
*   ä¸ºä¸åŒçš„åº”ç”¨åœºæ™¯åˆ›å»ºä¸åŒçš„ AppClient

### 3\. IP é™åˆ¶

*   åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ IP ç™½åå•
*   ä½¿ç”¨ CIDR ç½‘æ®µè€Œä¸æ˜¯å•ä¸ª IPï¼ˆä¾¿äºæ‰©å±•ï¼‰
*   è€ƒè™‘ CDN å’Œä»£ç†çš„ IP è½¬å‘

### 4\. ç›‘æ§å’Œæ—¥å¿—

    import logging
    
    logger = logging.getLogger(__name__)
    
    @router.get("/sensitive-data", auth=app_client_api_key)
    @require_app_client_scopes([AppClientScopes.PROJECT_READ])
    def get_sensitive_data(request):
        app_client = request.auth
        logger.info(f"AppClient {app_client.app_id} accessed sensitive data")
        return {"data": "sensitive information"}
    

é›†æˆåˆ°ç°æœ‰ API
---------

### æ·»åŠ è·¯ç”±

åœ¨ `config/apis.py` ä¸­æ·»åŠ  app è·¯ç”±ï¼š

    from apps.app.apis import router as app_router
    
    api.add_router('app', app_router)
    

### æ··åˆè®¤è¯

è¿™æ˜¯ django-ninja æä¾›çš„æ–°åŠŸèƒ½

å¯ä»¥åœ¨åŒä¸€ä¸ª API ä¸­åŒæ—¶æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š

    from ninja.security import django_auth
    from core.authentication import api_key_auth
    
    
    # åŒæ—¶æ”¯æŒ Django ç”¨æˆ·è®¤è¯å’Œ AppClient è®¤è¯
    @router.get("/user-data", auth=[django_auth, api_key_auth])
    def get_data(request):
       return {"user": request.user.username}
    

### æ›´æ–°ä¸» API é…ç½®

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åœ¨ä¸» API é…ç½®å…¨å±€è®¤è¯å’Œå…¶ä»–åŠŸèƒ½

    from django.contrib.admin.views.decorators import staff_member_required
    
    api = NinjaAPI(
        title=f'{settings.DJANGO_STARTER["project_info"]["name"]} APIs',
        description=settings.DJANGO_STARTER["project_info"]["description"],
        renderer=JSONRespRenderer(),
        csrf=True,
        auth=[django_auth, api_key_auth, api_key_header_auth, api_key_bearer_auth],
        urls_namespace='api',
        docs=Swagger(settings={"persistAuthorization": True}),
        docs_decorator=staff_member_required,
    )
    

è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹

æˆ‘è¿™æ®µé…ç½®ï¼š

*   ä½¿ç”¨ `auth=[django_auth, api_key_auth, api_key_header_auth, api_key_bearer_auth]` æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼ˆå…¶å®è¿˜æœ‰ä¸€ä¸ªJWTçš„ï¼Œä¸è¿‡æˆ‘è¿™é‡Œæ²¡è€ƒè™‘ï¼‰
*   ä½¿ç”¨ `docs_decorator=staff_member_required,` é…ç½®äº†è®¿é—®swaggeræ–‡æ¡£å¿…é¡»æ˜¯å·²ç™»å½•çš„ `staff_member`

å®ç°
--

OKï¼Œæœ€åå†ä»‹ç»ä¸€ä¸‹å…·ä½“å®ç° ï¼ˆåº”è¯¥æ²¡äººä¼šåšæŒçœ‹åˆ°è¿™ä¹ˆåé¢å§â€¦ï¼‰

é™äºç¯‡å¹…å…³ç³»ï¼Œæœ¬æ–‡æ— æ³•è´´å‡ºå…¨éƒ¨ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**APIé‰´æƒ**ã€è·å–å®Œæ•´ä»£ç 

### æ¨¡å‹

é¦–å…ˆæ˜¯ AppClient æ¨¡å‹ï¼Œä»£ç ä½äº `src/apps/app/models.py` å†…

é™¤äº†å­—æ®µå®šä¹‰ï¼Œè¿˜æ·»åŠ äº†ä¸€äº›æ–¹æ³•ç”¨äº è·å–æƒé™èŒƒå›´åˆ—è¡¨ã€è·å–å…è®¸çš„ IP åœ°å€åˆ—è¡¨ ä¹‹ç±»çš„åŠŸèƒ½

æŒ‰ç…§DDDæ€æƒ³æ¥è®²ï¼Œè¿™ä¸ªæ¨¡å‹ç®—æ˜¯ä¸€ä¸ª å……è¡€æ¨¡å‹ ğŸ˜ƒ

    import uuid
    from django.db import models
    from django.core.validators import RegexValidator
    from django_starter.db.models import ModelExt
    
    class AppClient(ModelExt):
        """åº”ç”¨å®¢æˆ·ç«¯æ¨¡å‹ï¼Œç”¨äºç®¡ç†ç¬¬ä¸‰æ–¹åº”ç”¨çš„è®¿é—®æƒé™"""
    
        class Status(models.TextChoices):
            ACTIVE = 'active', 'å¯ç”¨'
            INACTIVE = 'inactive', 'ç¦ç”¨'
    
        id = models.BigAutoField(
            primary_key=True,
            verbose_name='ä¸»é”®ID',
            help_text='ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦',
            db_comment='ç‰©ç†ä¸»é”®ï¼Œè‡ªå¢ID'
        )
    
        guid = models.UUIDField(
            default=uuid.uuid4,
            unique=True,
            editable=False,
            verbose_name='å…¨å±€å”¯ä¸€æ ‡è¯†',
            help_text='ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„UUIDï¼Œç”¨ä½œé€»è¾‘ä¸»é”®',
            db_comment='é€»è¾‘ä¸»é”®ï¼ŒGUID'
        )
    
        app_id = models.CharField(
            max_length=100,
            unique=True,
            verbose_name='åº”ç”¨æ ‡è¯†',
            help_text='ç”¨äºæ ‡è¯†è°ƒç”¨æ–¹ç³»ç»Ÿçš„å”¯ä¸€IDï¼Œå»ºè®®ä½¿ç”¨æœ‰æ„ä¹‰çš„å‘½å',
            db_comment='åº”ç”¨æ ‡è¯†ï¼Œç”¨äºæ ‡è¯†è°ƒç”¨æ–¹ç³»ç»Ÿ',
            validators=[
                RegexValidator(
                    regex=r'^[a-zA-Z0-9_-]+$',
                    message='åº”ç”¨æ ‡è¯†åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œè¿å­—ç¬¦'
                )
            ]
        )
    
        app_name = models.CharField(
            max_length=200,
            verbose_name='åº”ç”¨åç§°',
            help_text='è°ƒç”¨æ–¹åº”ç”¨çš„æ˜¾ç¤ºåç§°æˆ–å¤‡æ³¨ä¿¡æ¯',
            db_comment='åº”ç”¨åç§°ï¼Œè°ƒç”¨æ–¹çš„åç§°æˆ–å¤‡æ³¨ä¿¡æ¯'
        )
    
        secret_key = models.CharField(
            max_length=100,
            verbose_name='å¯†é’¥',
            help_text='ç”¨äºAPIç­¾åéªŒè¯çš„å¯†é’¥ï¼Œè¯·å¦¥å–„ä¿ç®¡',
            db_comment='å¯†é’¥ï¼Œç”¨äºç­¾åéªŒè¯',
        )
    
        allowed_ips = models.TextField(
            blank=True,
            null=True,
            verbose_name='å…è®¸è®¿é—®çš„IP',
            help_text='å…è®¸è®¿é—®çš„IPåœ°å€åˆ—è¡¨ï¼Œå¤šä¸ªIPç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶',
            db_comment='å…è®¸è®¿é—®çš„ IP åˆ—è¡¨ï¼Œé€—å·åˆ†éš”'
        )
    
        scopes = models.TextField(
            blank=True,
            null=True,
            verbose_name='æƒé™èŒƒå›´',
            help_text='åº”ç”¨çš„æƒé™èŒƒå›´ï¼Œæ ¼å¼å¦‚ï¼šproject:read,project:write',
            db_comment='æƒé™èŒƒå›´ï¼Œå¦‚ project:read,project:write'
        )
    
        status = models.CharField(
            max_length=10,
            choices=Status.choices,
            default=Status.ACTIVE,
            verbose_name='çŠ¶æ€',
            help_text='åº”ç”¨çš„å¯ç”¨çŠ¶æ€',
            db_comment='å¯ç”¨/ç¦ç”¨çŠ¶æ€'
        )
    
        class Meta:
            db_table = 'app_client'
            verbose_name = 'åº”ç”¨å®¢æˆ·ç«¯'
            verbose_name_plural = 'åº”ç”¨å®¢æˆ·ç«¯'
            ordering = ['-create_time']
            indexes = [
                models.Index(fields=['app_id']),
                models.Index(fields=['status']),
                models.Index(fields=['create_time']),
            ]
    
        def __str__(self):
            return f'{self.app_name} ({self.app_id})'
    
        def is_active(self):
            """æ£€æŸ¥åº”ç”¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€"""
            # todo ä¸ºä»€ä¹ˆè¿™ä¸ª is_deleted ä¼šå˜æˆ str å•Šï¼Ÿï¼Ÿ
            # return self.status == self.Status.ACTIVE and not self.is_deleted
            return self.status == self.Status.ACTIVE
    
        def get_scopes_list(self):
            """è·å–æƒé™èŒƒå›´åˆ—è¡¨"""
            if not self.scopes:
                return []
            return [scope.strip() for scope in self.scopes.split(',') if scope.strip()]
    
        def get_allowed_ips_list(self):
            """è·å–å…è®¸çš„IPåœ°å€åˆ—è¡¨"""
            if not self.allowed_ips:
                return []
            return [ip.strip() for ip in self.allowed_ips.split(',') if ip.strip()]
    
        def save(self, *args, **kwargs):
            """é‡å†™saveæ–¹æ³•ï¼Œæ·»åŠ è‡ªå®šä¹‰é€»è¾‘"""
            # ç¡®ä¿app_nameä¸ä¸ºç©º
            if not self.app_name:
                self.app_name = self.app_id
    
            super().save(*args, **kwargs)
    

### æµ‹è¯•æ¥å£

æ·»åŠ ä¸€äº›æµ‹è¯•æ¥å£ï¼Œæ–¹ä¾¿åç»­è°ƒè¯•

ä»£ç ä½äº `src/apps/app/apis/client/apis.py`

    from typing import List
    from ninja import Router
    from django.http import HttpRequest
    from core.authentication import (
        api_key_auth,
        api_key_header_auth,
        api_key_bearer_auth,
        require_app_client_scopes,
        AppClientScopes,
        AppClientScopeChecker,
    )
    from apps.app.models import AppClient
    from .schemas import AppClientSchema, AppClientCreateSchema
    
    router = Router(tags=['AppClient API'])
    
    @router.get("/test/api-key", auth=api_key_auth)
    def test_api_key_auth(request: HttpRequest):
        """æµ‹è¯•API Keyè®¤è¯ï¼ˆæŸ¥è¯¢å‚æ•°æ–¹å¼ï¼‰
        
        ä½¿ç”¨æ–¹å¼: GET /api/app/test/api-key?api_key=your_secret_key
        """
        app_client = request.auth
        return {
            "message": "API Keyè®¤è¯æˆåŠŸ",
            "app_id": app_client.app_id,
            "app_name": app_client.app_name,
            "scopes": app_client.get_scopes_list(),
        }
    
    
    @router.get("/test/api-key-header", auth=api_key_header_auth)
    def test_api_key_header_auth(request: HttpRequest):
        """æµ‹è¯•API Keyè®¤è¯ï¼ˆè¯·æ±‚å¤´æ–¹å¼ï¼‰
        
        ä½¿ç”¨æ–¹å¼: GET /api/app/test/api-key-header
        Headers: X-API-Key: your_secret_key
        """
        app_client = request.auth
        return {
            "message": "API Key Headerè®¤è¯æˆåŠŸ",
            "app_id": app_client.app_id,
            "app_name": app_client.app_name,
            "scopes": app_client.get_scopes_list(),
        }
    
    
    @router.get("/test/bearer", auth=api_key_bearer_auth)
    def test_bearer_auth(request: HttpRequest):
        """æµ‹è¯•Bearer Tokenè®¤è¯
        
        ä½¿ç”¨æ–¹å¼: GET /api/app/test/bearer
        Headers: Authorization: Bearer your_secret_key
        """
        app_client = request.auth
        return {
            "message": "Bearer Tokenè®¤è¯æˆåŠŸ",
            "app_id": app_client.app_id,
            "app_name": app_client.app_name,
            "scopes": app_client.get_scopes_list(),
        }
    
    
    @router.get("/test/scopes/project-read", auth=api_key_auth)
    @require_app_client_scopes([AppClientScopes.PROJECT_READ])
    def test_project_read_scope(request: HttpRequest):
        """æµ‹è¯•é¡¹ç›®è¯»å–æƒé™
        
        éœ€è¦æƒé™: project:read
        """
        return {
            "message": "é¡¹ç›®è¯»å–æƒé™éªŒè¯æˆåŠŸ",
            "required_scope": AppClientScopes.PROJECT_READ,
            "client_scopes": AppClientScopeChecker.get_client_scopes(request),
        }
    
    
    @router.get("/test/scopes/project-write", auth=api_key_auth)
    @require_app_client_scopes([AppClientScopes.PROJECT_WRITE])
    def test_project_write_scope(request: HttpRequest):
        """æµ‹è¯•é¡¹ç›®å†™å…¥æƒé™
        
        éœ€è¦æƒé™: project:write
        """
        return {
            "message": "é¡¹ç›®å†™å…¥æƒé™éªŒè¯æˆåŠŸ",
            "required_scope": AppClientScopes.PROJECT_WRITE,
            "client_scopes": AppClientScopeChecker.get_client_scopes(request),
        }
    
    
    @router.get("/test/scopes/multiple", auth=api_key_auth)
    @require_app_client_scopes([AppClientScopes.PROJECT_READ, AppClientScopes.USER_READ])
    def test_multiple_scopes(request: HttpRequest):
        """æµ‹è¯•å¤šä¸ªæƒé™è¦æ±‚
        
        éœ€è¦æƒé™: project:read AND user:read
        """
        return {
            "message": "å¤šæƒé™éªŒè¯æˆåŠŸ",
            "required_scopes": [AppClientScopes.PROJECT_READ, AppClientScopes.USER_READ],
            "client_scopes": AppClientScopeChecker.get_client_scopes(request),
        }
    
    
    @router.get("/test/scopes/any", auth=api_key_auth)
    def test_any_scope(request: HttpRequest):
        """æµ‹è¯•ä»»æ„æƒé™æ£€æŸ¥
        
        æ£€æŸ¥æ˜¯å¦å…·æœ‰é¡¹ç›®æˆ–ç”¨æˆ·ç›¸å…³çš„ä»»æ„æƒé™
        """
        has_project_access = AppClientScopeChecker.has_any_scope(
            request, [AppClientScopes.PROJECT_READ, AppClientScopes.PROJECT_WRITE]
        )
        has_user_access = AppClientScopeChecker.has_any_scope(
            request, [AppClientScopes.USER_READ, AppClientScopes.USER_WRITE]
        )
        
        return {
            "message": "æƒé™æ£€æŸ¥å®Œæˆ",
            "has_project_access": has_project_access,
            "has_user_access": has_user_access,
            "client_scopes": AppClientScopeChecker.get_client_scopes(request),
        }
    
    
    @router.get("/info", auth=api_key_auth)
    def get_client_info(request: HttpRequest):
        """è·å–å½“å‰è®¤è¯çš„AppClientä¿¡æ¯"""
        app_client = request.auth
        return {
            "app_id": app_client.app_id,
            "app_name": app_client.app_name,
            "status": app_client.status,
            "scopes": app_client.get_scopes_list(),
            "allowed_ips": app_client.get_allowed_ips_list(),
            "create_time": app_client.create_time,
        }
    
    
    @router.get("/clients", auth=api_key_auth)
    @require_app_client_scopes([AppClientScopes.SUPER_ADMIN])
    def list_app_clients(request: HttpRequest) -> List[dict]:
        """åˆ—å‡ºæ‰€æœ‰AppClientï¼ˆéœ€è¦è¶…çº§ç®¡ç†å‘˜æƒé™ï¼‰
        
        éœ€è¦æƒé™: *
        """
        clients = AppClient.objects.filter(is_deleted=False)
        return [
            {
                "app_id": client.app_id,
                "app_name": client.app_name,
                "status": client.status,
                "scopes": client.get_scopes_list(),
                "create_time": client.create_time,
            }
            for client in clients
        ]
    

### ç®¡ç†å‘½ä»¤

ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œæˆ‘åˆæ·»åŠ äº†ä¿©å‘½ä»¤

é¡¾åæ€ä¹‰ï¼Œåˆ›å»ºæ–°çš„ AppClient å’Œ åˆ—å‡ºæ‰€æœ‰

*   `src/apps/app/management/commands/create_app_client.py`
*   `src/apps/app/management/commands/list_app_clients.py`

é™äºç¯‡å¹…åŸå› ï¼Œæ— æ³•è´´å‡ºå…¨éƒ¨ä»£ç ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**APIé‰´æƒ**ã€è·å–å®Œæ•´ä»£ç 

### æ ¸å¿ƒé€»è¾‘

å…³äºé‰´æƒçš„æ ¸å¿ƒé€»è¾‘ï¼Œæˆ‘å•ç‹¬åˆ›å»ºä¸€ä¸ª `core` package æ¥å­˜æ”¾

ç›®å½•ç»“æ„å¦‚ä¸‹

     core
     â”œâ”€ exceptions
     â”‚  â”œâ”€ __init__.py
     â”‚  â””â”€ permissions.py
     â”œâ”€ authentication
     â”‚  â”œâ”€ __init__.py
     â”‚  â”œâ”€ README.md
     â”‚  â”œâ”€ permissions.py
     â”‚  â”œâ”€ app.py
     â”‚  â””â”€ api_key.py
     â””â”€ __init__.py
    

æœ€å…³é”®çš„ä»£ç å°±æ˜¯ `src/core/authentication/app.py` ä¸­çš„è¿™å‡ ä¸ªè®¤è¯å®ä¾‹

ä»£ç ä¸­æœ‰è¯¦ç»†æ³¨é‡Šï¼Œä¸€çœ‹å°±èƒ½ç†è§£ã€‚

å¦‚æœè§‰å¾—è¿™ä¸ªè¿˜æ¯”è¾ƒå¤æ‚ï¼Œåç»­æˆ‘å†ä»‹ç»ä¸€ä¸ªæç®€çš„å®ç°æ–¹å¼ã€‚

    class AppClientAuthMixin:
        """AppClientè®¤è¯æ··å…¥ç±»ï¼Œæä¾›é€šç”¨çš„è®¤è¯é€»è¾‘"""
        
        def _get_client_ip(self, request: HttpRequest) -> str:
            """è·å–å®¢æˆ·ç«¯çœŸå®IPåœ°å€"""
            x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
            if x_forwarded_for:
                ip = x_forwarded_for.split(',')[0].strip()
            else:
                ip = request.META.get('REMOTE_ADDR')
            return ip
        
        def _validate_ip_access(self, app_client: AppClient, request: HttpRequest) -> bool:
            """éªŒè¯IPè®¿é—®æƒé™"""
            allowed_ips = app_client.get_allowed_ips_list()
            if not allowed_ips:  # å¦‚æœæ²¡æœ‰è®¾ç½®IPé™åˆ¶ï¼Œåˆ™å…è®¸æ‰€æœ‰IP
                return True
            
            client_ip = self._get_client_ip(request)
            
            for allowed_ip in allowed_ips:
                try:
                    # æ”¯æŒå•ä¸ªIPå’ŒCIDRç½‘æ®µ
                    if '/' in allowed_ip:
                        network = ipaddress.ip_network(allowed_ip, strict=False)
                        if ipaddress.ip_address(client_ip) in network:
                            return True
                    else:
                        if client_ip == allowed_ip:
                            return True
                except (ipaddress.AddressValueError, ValueError):
                    # å¿½ç•¥æ— æ•ˆçš„IPæ ¼å¼
                    continue
            
            return False
        
        def _authenticate_app_client(self, request: HttpRequest, key: str) -> Optional[AppClient]:
            """è®¤è¯AppClientçš„é€šç”¨é€»è¾‘"""
            try:
                app_client = AppClient.objects.get(secret_key=key)
                
                # æ£€æŸ¥åº”ç”¨æ˜¯å¦å¤„äºæ´»è·ƒçŠ¶æ€
                if not app_client.is_active():
                    return None
                
                # éªŒè¯IPè®¿é—®æƒé™
                if not self._validate_ip_access(app_client, request):
                    return None
                
                # å°†æƒé™èŒƒå›´æ·»åŠ åˆ°requestä¸­ï¼Œä¾›åç»­æƒé™æ£€æŸ¥ä½¿ç”¨
                request.app_client_scopes = app_client.get_scopes_list()
                
                return app_client
                
            except AppClient.DoesNotExist:
                return None
    
    
    class AppClientApiKey(AppClientAuthMixin, APIKeyQuery):
        """åŸºäºæŸ¥è¯¢å‚æ•°çš„AppClient API Keyè®¤è¯"""
        param_name = "api_key"
    
        def authenticate(self, request: HttpRequest, key: str) -> Optional[AppClient]:
            return self._authenticate_app_client(request, key)
    
    
    class AppClientApiKeyHeader(AppClientAuthMixin, APIKeyHeader):
        """åŸºäºè¯·æ±‚å¤´çš„AppClient API Keyè®¤è¯"""
        param_name = "X-API-Key"
    
        def authenticate(self, request: HttpRequest, key: str) -> Optional[AppClient]:
            return self._authenticate_app_client(request, key)
    
    
    class AppClientBearer(AppClientAuthMixin, HttpBearer):
        """åŸºäºBearer Tokençš„AppClientè®¤è¯"""
    
        def authenticate(self, request: HttpRequest, token: str) -> Optional[AppClient]:
            return self._authenticate_app_client(request, token)
    
    
    # åˆ›å»ºè®¤è¯å®ä¾‹ï¼Œå¯ä»¥åœ¨APIä¸­ç›´æ¥ä½¿ç”¨
    api_key_auth = AppClientApiKey()
    api_key_header_auth = AppClientApiKeyHeader()
    api_key_bearer_auth = AppClientBearer()
    

æç®€å®ç°æ–¹å¼
------

è¿™å¥—å®Œå–„çš„é‰´æƒé€»è¾‘ï¼Œå¦‚æœä½ è§‰å¾—å¤ªå¤æ‚äº†

æ²¡å…³ç³»ï¼Œæˆ‘è¿™è¿˜åšäº†ä¸ªæç®€ç‰ˆæœ¬ï¼Œå»æ‰äº†æƒé™ã€IPé™åˆ¶ç­‰ä¹±ä¸ƒå…«ç³Ÿçš„ä¸œè¥¿ï¼Œåªæ ¡éªŒ api-key æ˜¯å¦æœ‰æ•ˆ

å®ç°ä»£ç åœ¨ `src/core/authentication/api_key.py`

è‡ªå®šä¹‰çš„ `ApiKey` ç±»ç»§æ‰¿è‡ª `ninja.security.APIKeyQuery` ç±»ï¼Œè¡¨æ˜ `api_key` å‚æ•°éœ€è¦æ”¾åœ¨ **GET query params** é‡Œ

    from ninja.security import APIKeyQuery
    from apps.app.models import AppClient
    
    
    class ApiKey(APIKeyQuery):
        param_name = "api_key"
    
        def authenticate(self, request, key):
            try:
                c = AppClient.objects.get(secret_key=key)
                print(f'api key authenticated: {c.secret_key}, app id: {c.app_id}')
                return c
            except AppClient.DoesNotExist:
                pass
    

ä½¿ç”¨ä¹Ÿå¾ˆç®€å•

    from apps.app.models import AppClient
    from core.authentication.api_key import ApiKey
    
    @router.get("/data", auth=ApiKey())
    def get_data(request):
       assert isinstance(request.auth, AppClient)
       return {"data": "success"}
    

å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™éœ€è¦åœ¨ GET query params é‡Œå¸¦ä¸Š `AppClient` çš„ `secret_key`

æ ¡éªŒé€šè¿‡çš„è¯ï¼Œninja ä¼šè‡ªåŠ¨åœ¨ `request.auth` æ·»åŠ  `AppClient` å®ä¾‹ï¼Œåœ¨æ¥å£ä»£ç é‡Œå¯ä»¥ç›´æ¥è·å–è¿™ä¸ªå®ä¾‹ã€‚

å°ç»“
--

è¿™ç¯‡æ–‡ç« å±…ç„¶å†™äº†ä¸¤ä¸‡å¤šå­—ğŸ•¶

è¿™è¿˜æ˜¯åœ¨åˆ å‡äº†å¾ˆå¤šä»£ç çš„æƒ…å†µä¸‹â€¦

å†å•°å—¦ä¸€æ¬¡ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**APIé‰´æƒ**ã€è·å–å®Œæ•´ä»£ç 

è¿™ä¹ˆé•¿çš„æ–‡ç« ï¼Œå¤§æ¦‚ä¸ä¼šæœ‰äººæœ‰è€å¿ƒçœ‹åˆ°æœ€åå§~

æºœäº†ï¼Œæºœäº†~

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚