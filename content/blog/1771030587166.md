---
layout: post
title: '睡前讲一段docker编译镜像的故事'
date: "2026-02-14T00:56:27Z"
---
睡前讲一段docker编译镜像的故事
==================

最近在和团队的工程师开发一些创新项目，我需要把本地项目打包成docker镜像，并且推送得到AWS云服务上的镜像仓库（ECR）。  
我写好Dockerfile之后就开始先编译，然后再推送。命令如下所示：

    docker build -t ai-service:latest .
    docker tag ai-service:latest XXXXX.dkr.ecr.us-east-1.amazonaws.com/ai-service:latest
    docker push XXXXX.dkr.ecr.us-east-1.amazonaws.com/ai-service:latest
    

一切看似顺利，但当我使用这个容器镜像来创建EC2（我选择了t3.micro）的时候，却遇到了镜像和系统平台不兼容的报错，具体如下所示：

    latest: Pulling from smart-inventory
    no matching manifest for linux/amd64 in the manifest list entries
    

可以看出EC2的系统是linux/amd64的，而我的笔记本电脑是MacOS M1芯片，是arm64的架构。Docker默认编译出来的镜像是基于所在平台的，也就是说用MacOS M1编译出的镜像也是arm架构。  
解决这个问题十分简单，Docker提供了强大的buildx工具，可以在编译的时候指定编译出的架构。  
例如我想编译出适合linxu/amd64的镜像，可以用如下命令：

    docker buildx build --platform linux/amd64 -t ai-service:latest .
    

这样编译出来的镜像就能在linux/amd64架构的机器上运行了。

仔细再想一想，为什么之前我没有遇到这个问题呢？  
原因是因为我并不是直接在我本地电脑上编译镜像并推送到远端镜像库的，我们通常是通过持续集成系统（CI/CD）来完成的。在CI/CD流程中，我们使用的是amd64架构的虚拟机来完成镜像编译，这样编译出的镜像都是amd64的。  
所以如果我要坚持在本地编译镜像来推送，则需要先判断当前系统是否是MacOS，如果是，则使用“--platform linux/amd64”参数完成编译即可，用Python实现如下所示：

      if os.name == 'posix' and 'darwin' in os.uname().sysname.lower():
                # On macOS, build for linux/amd64 platform
                build_cmd = ["docker", "buildx", "build", "--platform", "linux/amd64", "-t", image_name, "."]
            else:
                build_cmd = ["docker", "build", "-t", image_name, "."]
    

每次遇到问题，我总是想多思考一下背后的原因，有点像挖金矿一样，收获蛮大。

王阳明说：**人须在事上磨，方立得住，方能静亦定，动亦定。**

我还需要继续磨励，继续专研，把事儿做好。走好脚下路的，才能有好未来。