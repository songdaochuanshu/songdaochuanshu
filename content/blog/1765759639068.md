---
layout: post
title: 'Iceberg Rest Catalog + OSS å®è·µè¸©å‘è®°å½•ï¼šPolaris x-amz-content-sha256 æŠ¥é”™ ä¸ Nessie é…ç½®'
date: "2025-12-15T00:47:19Z"
---
Iceberg Rest Catalog + OSS å®è·µè¸©å‘è®°å½•ï¼šPolaris x-amz-content-sha256 æŠ¥é”™ ä¸ Nessie é…ç½®
=============================================================================

æœ€è¿‘åœ¨åšæŸ¥è¯¢å¼•æ“Iceberg æ€§èƒ½æµ‹è¯•ï¼Œä¸»è¦æ˜¯ç¯å¢ƒå‡†å¤‡ã€æµ‹è¯•é›†å‡†å¤‡ã€æ€§èƒ½æµ‹è¯•å¼€å±•ã€‚  
æœ¬ç¯‡åªåŒ…æ‹¬ç¯å¢ƒå‡†å¤‡éƒ¨åˆ†ï¼Œè®°å½•ä¸‹ç¯å¢ƒå‡†å¤‡è¿‡ç¨‹ï¼Œå‡ ä¸ªæ–¹é¢ï¼š

1.  Catalogï¼šå°½é‡è´´åˆç”Ÿäº§ï¼Œéœ€è¦ä¸»æµçš„catalog typeï¼Œä¸”æ€§èƒ½æµ‹è¯•åœ¨å›½å†…ï¼Œæ‰€ä»¥Glueã€Snowflake Catalog ç­‰éƒ½ç”¨ä¸äº†ï¼Œåªèƒ½è‡ªå·±éƒ¨ç½²1å¥—catalog æœåŠ¡ã€‚
2.  Storageï¼šæ€§èƒ½æµ‹è¯•æœºå™¨åœ¨å›½å†…ï¼Œæµ·å¤–çš„å¯¹è±¡å­˜å‚¨æ˜¯ç”¨ä¸äº†äº†ï¼ˆæ¯”å¦‚S3ï¼ŒAzureï¼ŒGCSï¼‰ï¼Œåªèƒ½ç”¨å›½å†…çš„ï¼ˆæ¯”å¦‚OSSï¼ŒCOSï¼ŒOBSï¼‰ä¸”å¯èƒ½ç”±äºcatalog serveræ²¡æ”¯æŒåˆ°ä½ï¼Œåªèƒ½èµ°S3åè®®ã€‚
3.  Query Engineï¼šä¿è¯é€‰çš„catalog type å‡ ç§æŸ¥è¯¢å¼•æ“éƒ½æ”¯æŒã€‚

è¿‡æ»¤ä»¥ä¸Šå‡ ä¸ªæ¡ä»¶ï¼Œç¯å¢ƒæƒ…å†µå¦‚ä¸‹

Type

System

catalog type

Rest catalog

Polaris, Nessie

storage scheme

S3

OSS

query engine

Doris, Trino

ä»¥ä¸‹é›†æˆæƒ…å†µäºŒé€‰ä¸€

1.  Doris/Trino + Polaris + OSS
2.  Doris/Trino + Nessie + OSS

Polaris  
å…ˆè¯´ä¸‹ç»“è®ºï¼Œæœ€æ–°Polarisç‰ˆæœ¬ï¼ˆ1.2.0ï¼‰+ OSS(S3åè®®) è·‘ä¸èµ·æ¥ï¼Œä¼šæœ‰ä¸ªæŠ¥é”™

    2025-12-12 17:13:45,460 INFO  [org.apa.pol.ser.exc.IcebergExceptionMapper] [4a2120d6-8520-441d-b502-a090f890b03d_0000000000000000030,POLARIS] [,,,] (executor-thread-1) Handling runtimeException aws-chunked encoding is not supported with the specified x-amz-content-sha256 value. (Service: S3, Status Code: 400, Request ID: 693C4D496D7461373771398C) (SDK Attempt Count: 1)
    

å‚è€ƒä¸¤ä¸ªæ–‡æ¡£  
[0002-00000427](https://help.aliyun.com/zh/oss/user-guide/0002-00000427)  
[ä½¿ç”¨AWS SDKè®¿é—®OSS](https://help.aliyun.com/zh/oss/developer-reference/use-aws-sdks-to-access-oss)  
å¤§æ¦‚æ„æ€è¿™ä¸ªx-amz-content-sha256 header ä¸èƒ½ä¼ ï¼ŒPolarisä¹Ÿæ²¡é…ç½®å‚æ•°å¯ä»¥æ§åˆ¶è¿™ä¸ªã€‚

åœ¨æœ€æ–°Polarisç‰ˆæœ¬ï¼ˆ1.2.0ï¼‰åŠ äº†ä¸ªå¼€å…³stsUnavailable æ”¯æŒ Polaris é€‚é…æ‰€æœ‰æ”¯æŒS3åè®®çš„å¯¹è±¡å­˜å‚¨ã€‚åœ¨1.2.0 ä¹‹å‰ï¼Œå› ä¸ºå¿…é¡»è¦èµ°æ ‡å‡†çš„S3 STSé‰´æƒï¼Œæ‰€ä»¥è€ç‰ˆæœ¬Polaris OSSè‚¯å®šç”¨ä¸äº†ã€‚

è¿™é‡Œæœ‰ä¸ªå°æ’æ›²ï¼Œrelease noteé‡ŒstsUnavailableè¿™ä¸ªå‚æ•°æ‹¼å†™é”™äº†ï¼Œå¯¼è‡´ä¸€ç›´èµ°STSé‰´æƒï¼ŒèŠ±äº†ç‚¹æ—¶é—´æŠ˜è…¾äº†ä¸‹ã€‚æœ€ç»ˆé€šè¿‡æ—¥å¿—å‘ç°è¿™ä¸ªå‚æ•°æ²¡è®¾ç½®ä¸Šï¼Œæ–‡æ¡£ä¸Šæ‹¼å†™é”™çš„ï¼Œå¤åˆ¶é”™äº†ã€‚  
[Polaris 1.2.0 release note](https://polaris.apache.org/downloads/#120)  
![image](https://img2024.cnblogs.com/blog/1362076/202512/1362076-20251213142312972-2058823266.png)

å½“ç„¶ï¼Œé¡ºæ‰‹æä¸ªPR fixä¸‹  
[https://github.com/apache/polaris/pull/3262](https://github.com/apache/polaris/pull/3262)

é™„ä¸ŠPolaris + OSSçš„docker yaml  
å‚è€ƒquickstartå’Œceph example æ”¹çš„

    
    services:
    
      polaris:
        image: apache/polaris:latest
        ports:
          # API port
          - "8181:8181"
          # Management port (metrics and health checks)
          - "8182:8182"
          # Optional, allows attaching a debugger to the Polaris JVM
          - "5005:5005"
        environment:
          JAVA_DEBUG: true
          JAVA_DEBUG_PORT: "*:5005"
          AWS_REGION: cn-beijing
          AWS_ACCESS_KEY_ID: xxxx
          AWS_SECRET_ACCESS_KEY: xxxx
          AWS_ENDPOINT: http://oss-cn-beijing-internal.aliyuncs.com
          POLARIS_BOOTSTRAP_CREDENTIALS: POLARIS,root,s3cr3t
          polaris.realm-context.realms: POLARIS
          quarkus.otel.sdk.disabled: "true"
        healthcheck:
          test: ["CMD", "curl", "http://localhost:8182/q/health"]
          interval: 2s
          timeout: 10s
          retries: 10
          start_period: 10s
    
      polaris-setup:
        image: alpine/curl
        depends_on:
          polaris:
            condition: service_healthy
        environment:
          - CLIENT_ID=${ROOT_CLIENT_ID:-root}
          - CLIENT_SECRET=${ROOT_CLIENT_SECRET:-s3cr3t}
          - CATALOG_NAME=${CATALOG_NAME:-quickstart_catalog}
          - REALM=${POLARIS_REALM:-POLARIS}
          - BASE_LOCATION=${BASE_LOCATION:-s3://xxx/polaris_warehouse}
          - S3_ENDPOINT=${S3_ENDPOINT:-http://oss-cn-beijing-internal.aliyuncs.com}
    
        entrypoint: /bin/sh
        command:
          - -c
          - |
            set -ex
            sleep 10
            sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
            apk add --no-cache jq
            echo "Obtaining root access token..."
            TOKEN_RESPONSE=$$(curl -s -X POST http://polaris:8181/api/catalog/v1/oauth/tokens \
              -H 'Content-Type: application/x-www-form-urlencoded' \
              -d "grant_type=client_credentials&client_id=$${CLIENT_ID}&client_secret=$${CLIENT_SECRET}&scope=PRINCIPAL_ROLE:ALL")
    
            TOKEN=$$(echo $$TOKEN_RESPONSE | jq -r '.access_token')
            echo "Obtained access token"
    
            echo "Creating catalog '$$CATALOG_NAME' in realm $$REALM..."
            PAYLOAD='{
              "catalog": {
                "name": "'$$CATALOG_NAME'",
                "type": "INTERNAL",
                "readOnly": false,
                "properties": {
                  "default-base-location": "'$$BASE_LOCATION'"
                },
                "storageConfigInfo": {
                  "storageType": "S3",
                  "allowedLocations": ["'$$BASE_LOCATION'", "'$$BASE_LOCATION'/"],
                  "endpoint": "'$$S3_ENDPOINT'",
                  "region": "cn-beijing",
                  "endpointInternal": "'$$S3_ENDPOINT'",
                  "pathStyleAccess": false,
                  "stsUnavailable": true
                }
              }
            }'
    
            curl -s -X POST http://polaris:8181/api/management/v1/catalogs \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Accept: application/json" \
              -H "Content-Type: application/json" \
              -H "Polaris-Realm: $$REALM" \
              -d "$$PAYLOAD" > /dev/null
    
            echo "âœ… Catalog created"
    
            echo ""
            echo "Creating principal 'quickstart_user'..."
            PRINCIPAL_RESPONSE=$$(curl -s -X POST http://polaris:8181/api/management/v1/principals \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"principal": {"name": "quickstart_user", "properties": {}}}')
    
            USER_CLIENT_ID=$$(echo $$PRINCIPAL_RESPONSE | jq -r '.credentials.clientId')
            USER_CLIENT_SECRET=$$(echo $$PRINCIPAL_RESPONSE | jq -r '.credentials.clientSecret')
    
            echo "âœ… Principal created with clientId: $$USER_CLIENT_ID"
    
            echo "Creating principal role 'quickstart_user_role'..."
            curl -s -X POST http://polaris:8181/api/management/v1/principal-roles \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"principalRole": {"name": "quickstart_user_role", "properties": {}}}' > /dev/null
    
            echo "âœ… Principal role created"
    
            echo "Creating catalog role 'quickstart_catalog_role'..."
            curl -s -X POST http://polaris:8181/api/management/v1/catalogs/$$CATALOG_NAME/catalog-roles \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"catalogRole": {"name": "quickstart_catalog_role", "properties": {}}}' > /dev/null
    
            echo "âœ… Catalog role created"
    
            echo "Assigning principal role to principal..."
            curl -s -X PUT http://polaris:8181/api/management/v1/principals/quickstart_user/principal-roles \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"principalRole": {"name": "quickstart_user_role"}}' > /dev/null
    
            echo "âœ… Principal role assigned"
    
            echo "Assigning catalog role to principal role..."
            curl -s -X PUT http://polaris:8181/api/management/v1/principal-roles/quickstart_user_role/catalog-roles/$$CATALOG_NAME \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"catalogRole": {"name": "quickstart_catalog_role"}}' > /dev/null
    
            echo "âœ… Catalog role assigned"
    
            echo "Granting CATALOG_MANAGE_CONTENT privilege..."
            curl -s -X PUT http://polaris:8181/api/management/v1/catalogs/$$CATALOG_NAME/catalog-roles/quickstart_catalog_role/grants \
              -H "Authorization: Bearer $$TOKEN" \
              -H "Polaris-Realm: $$REALM" \
              -H "Content-Type: application/json" \
              -d '{"type": "catalog", "privilege": "CATALOG_MANAGE_CONTENT"}' > /dev/null
    
            echo "âœ… Privileges granted"
    
            echo ""
            echo "=========================================="
            echo "ğŸ‰ Polaris Quickstart Setup Complete!"
            echo "=========================================="
            echo ""
            echo "Catalog: $$CATALOG_NAME"
            echo "  Storage: S3 (MinIO)"
            echo "  Location: s3://bucket123"
            echo "  MinIO UI: http://localhost:9001"
            echo ""
            echo "Root credentials:"
            echo "  Client ID:     $$CLIENT_ID"
            echo "  Client Secret: $$CLIENT_SECRET"
            echo ""
            echo "User credentials:"
            echo "  Client ID:     $$USER_CLIENT_ID"
            echo "  Client Secret: $$USER_CLIENT_SECRET"
            echo ""
            echo "Polaris main APIs:"
            echo "  - Iceberg REST:   http://localhost:8181/api/catalog/v1"
            echo "  - Management:     http://localhost:8181/api/management/v1"
            echo "  - Generic Tables: http://localhost:8181/api/polaris/v1"
            echo ""
            echo "Polaris admin APIs:"
            echo "  - Health check:   http://localhost:8182/q/health"
            echo "  - Metrics:        http://localhost:8182/q/metrics"
            echo ""
            echo "To get started with Spark:"
            echo "  spark-sql \\"
            echo "    --packages org.apache.iceberg:iceberg-spark-runtime-3.5_2.12:1.10.0,org.apache.iceberg:iceberg-aws-bundle:1.10.0 \\"
            echo "    --conf spark.sql.extensions=org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions \\"
            echo "    --conf spark.sql.catalog.polaris=org.apache.iceberg.spark.SparkCatalog \\"
            echo "    --conf spark.sql.catalog.polaris.type=rest \\"
            echo "    --conf spark.sql.catalog.polaris.warehouse=$$CATALOG_NAME \\"
            echo "    --conf spark.sql.catalog.polaris.uri=http://localhost:8181/api/catalog \\"
            echo "    --conf spark.sql.catalog.polaris.credential=$$USER_CLIENT_ID:$$USER_CLIENT_SECRET \\"
            echo "    --conf spark.sql.catalog.polaris.scope=PRINCIPAL_ROLE:ALL \\"
            echo "    --conf spark.sql.catalog.polaris.s3.endpoint=http://localhost:9000 \\"
            echo "    --conf spark.sql.catalog.polaris.s3.path-style-access=true \\"
            echo "    --conf spark.sql.catalog.polaris.s3.access-key-id=minio_root \\"
            echo "    --conf spark.sql.catalog.polaris.s3.secret-access-key=m1n1opwd \\"
            echo "    --conf spark.sql.catalog.polaris.client.region=irrelevant \\"
            echo "    --conf spark.sql.defaultCatalog=polaris"
            echo ""
            echo "To get started with REST API:"
            echo "  # Get a token"
            echo "  export TOKEN=\$$(curl -s -X POST http://localhost:8181/api/catalog/v1/oauth/tokens \\"
            echo "    -d 'grant_type=client_credentials' \\"
            echo "    -d 'client_id=$$USER_CLIENT_ID' \\"
            echo "    -d 'client_secret=$$USER_CLIENT_SECRET' \\"
            echo "    -d 'scope=PRINCIPAL_ROLE:ALL' \\"
            echo "    | jq -r '.access_token')"
            echo ""
            echo "  # Create a namespace"
            echo "  curl -X POST http://localhost:8181/api/catalog/v1/$$CATALOG_NAME/namespaces \\"
            echo "    -H \"Authorization: Bearer \$$TOKEN\" \\"
            echo "    -H 'Content-Type: application/json' \\"
            echo "    -d '{\"namespace\": [\"my_namespace\"], \"properties\": {}}'"
            echo ""
            echo "  # List namespaces"
            echo "  curl -X GET http://localhost:8181/api/catalog/v1/$$CATALOG_NAME/namespaces \\"
            echo "    -H \"Authorization: Bearer \$$TOKEN\""
            echo ""
            echo "=========================================="
    

Nessie  
**è¿™ä¸ªä¹Ÿè¯´ä¸‹ç»“è®ºï¼Œèƒ½è·‘èµ·æ¥ã€‚**  
é¦–å…ˆå…ˆçœ‹ä¸‹sha256 è¿™ç§headeræ˜¯æ€ä¹ˆè§£å†³çš„  
Nessieæœ‰ä¸ªå¼€å…³å¯ä»¥æ§åˆ¶è¿™å—  
![image](https://img2024.cnblogs.com/blog/1362076/202512/1362076-20251213145545295-407038858.png)  
æ‰€ä»¥é—®é¢˜è¿åˆƒè€Œè§£äº†

é™„ä¸ŠNessie + OSSçš„docker yaml

    version: '3'
    
    services:
      nessie:
        image: ghcr.io/projectnessie/nessie
        container_name: nessie
        ports:
          - "19120:19120"
        environment:
          - nessie.catalog.default-warehouse=warehouse
          - nessie.catalog.warehouses.warehouse.location=s3://mybucket/my-lakehouse/
          - nessie.catalog.warehouses.zgx.location=s3://xxxxx/iceberg_warehouse/
          - nessie.catalog.service.s3.default-options.endpoint=http://oss-cn-beijing-internal.aliyuncs.com
          - nessie.catalog.service.s3.default-options.access-key=urn:nessie-secret:quarkus:nessie.catalog.secrets.access-key
          - nessie.catalog.service.s3.default-options.path-style-access=false
          - nessie.catalog.service.s3.default-options.chunked-encoding-enabled=false
          - nessie.catalog.service.s3.default-options.auth-type=STATIC
          - nessie.catalog.secrets.access-key.name=xxx
          - nessie.catalog.secrets.access-key.secret=xxx
          - nessie.catalog.service.s3.default-options.region=cn-beijing
          - nessie.server.authentication.enabled=false
          - nessie.catalog.service.s3.default-options.request-signing-enabled=false
        networks:
          nessie-rest:
    
    networks:
      nessie-rest:
    

Trino æµ‹è¯• nessie è¿é€šæ€§  
å‚è€ƒ  
[https://projectnessie.org/nessie-latest/trino/?h=client+temp#starter-configuration](https://projectnessie.org/nessie-latest/trino/?h=client+temp#starter-configuration)  
è·å–å¯¹åº”çš„é…ç½®

    NESSIE_BASE_URL="http://127.0.0.1:19120/"
    curl "${NESSIE_BASE_URL}/iceberg-ext/v1/client-template/trino?format=static"
    

è¡¥å……é…ç½® `s3.aws-access-key` `s3.aws-secret-key`

Trino å°±å¯ä»¥æ­£å¸¸è¯»Icebergè¡¨äº†

    [trino@dec7c1a34cb6 /]$ trino --catalog nessie
    trino> use zgx;
    USE
    trino:zgx> show tables;
            Table
    ----------------------
     unpartitioned_table
     unpartitioned_table1
     unpartitioned_table2
     unpartitioned_table3
    (4 rows)
    
    Query 20251214_145124_00043_v9qpy, FINISHED, 1 node
    Splits: 19 total, 19 done (100.00%)
    0.24 [4 rows, 417B] [16 rows/s, 1.72KiB/s]
    
    trino:zgx> select * from unpartitioned_table;
     col1 | col2 |        col3         |  col4  |    col5    |    col6    | col7  |    col8    |            col9
    ------+------+---------------------+--------+------------+------------+-------+------------+----------------------------
     true |  101 | 9223372036854775807 | 123.45 | 987.654321 | 12345.6789 | xxxxx | 2025-12-14 | 2025-12-14 22:30:00.123456
     true |  101 | 9223372036854775807 | 123.45 | 987.654321 | 12345.6789 | xxxxx | 2025-12-14 | 2025-12-14 22:30:00.123456
     true |  101 | 9223372036854775807 | 123.45 | 987.654321 | 12345.6789 | xxxxx | 2025-12-14 | 2025-12-14 22:30:00.123456
     true |  101 | 9223372036854775807 | 123.45 | 987.654321 | 12345.6789 | xxxxx | 2025-12-14 | 2025-12-14 22:30:00.123456
     true |  101 | 9223372036854775807 | 123.45 | 987.654321 | 12345.6789 | xxxxx | 2025-12-14 | 2025-12-14 22:30:00.123456
    (5 rows)
    
    Query 20251214_145128_00044_v9qpy, FINISHED, 1 node
    Splits: 5 total, 5 done (100.00%)
    0.26 [5 rows, 27.5KiB] [19 rows/s, 107KiB/s]
    
    trino:zgx>
    

ä½†æ˜¯Trino åšDML æ“ä½œæœ‰ç‚¹ä¸é¡ºåˆ©...

    trino:zgx> CREATE TABLE user_profiles (
            ->     id BIGINT,
            ->     name VARCHAR,
            ->     registration_date DATE
            -> )
            -> WITH (
            ->     format = 'PARQUET'
            -> );
    
    trino:zgx> insert into debug values(1,2);
    
    Query 20251214_152721_00027_jtedg, FAILED, 1 node
    Splits: 66 total, 1 done (1.52%)
    0.34 [1 rows, 0B] [2 rows/s, 0B/s]
    
    Query 20251214_152721_00027_jtedg failed: Error committing write parquet to Hive
    
    trino:zgx>
    

    Caused by: software.amazon.awssdk.services.s3.model.S3Exception: A header you provided implies functionality that is not implemented. (Service: S3, Status Code: 400, Request ID: 693EEB94153DBB3432C97FC5) (SDK Attempt Count: 1)
    
    

![image](https://img2024.cnblogs.com/blog/1362076/202512/1362076-20251215010040009-878373924.png)

å¯ä»¥çœ‹å‡ºTrino å…¼å®¹å›½å†…äº§å“æ²¡é‚£ä¹ˆå¥½ï¼ŒDoris è¯•è¿‡èƒ½æ­£å¸¸å»ºè¡¨ å†™æ•°æ®ã€‚

Doris catalog åˆ›å»ºè¯­å¥

    CREATE CATALOG `nessie` PROPERTIES (
    "warehouse" = "xxx",
    "uri" = "http://xxx:19120/iceberg",
    "type" = "iceberg",
    "s3.secret_key" = "*XXX",
    "s3.region" = "us-east-1",
    "s3.endpoint" = "http://oss-cn-beijing-internal.aliyuncs.com",
    "s3.access_key" = "*XXX",
    "iceberg.catalog.type" = "rest"
    );
    

é™„å½•  
[https://trino.io/docs/current/connector/iceberg.html](https://trino.io/docs/current/connector/iceberg.html)  
[https://projectnessie.org/nessie-latest/configuration](https://projectnessie.org/nessie-latest/configuration)  
[https://projectnessie.org/nessie-latest/trino/](https://projectnessie.org/nessie-latest/trino/)