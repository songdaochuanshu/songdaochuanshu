---
layout: post
title: 'Flutteråº”ç”¨æ¶æ„è®¾è®¡ï¼šåŸºäºRiverpodçš„çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ'
date: "2025-09-12T00:38:15Z"
---
Flutteråº”ç”¨æ¶æ„è®¾è®¡ï¼šåŸºäºRiverpodçš„çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
=================================

Flutteråº”ç”¨æ¶æ„è®¾è®¡ï¼šåŸºäºRiverpodçš„çŠ¶æ€ç®¡ç†æœ€ä½³å®è·µ
=================================

> æœ¬æ–‡åŸºäº[BeeCount(èœœèœ‚è®°è´¦)](https://github.com/TNT-Likely/BeeCount)é¡¹ç›®çš„å®é™…å¼€å‘ç»éªŒï¼Œæ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨Riverpodæ„å»ºå¯ç»´æŠ¤ã€å¯æ‰©å±•çš„Flutteråº”ç”¨æ¶æ„ã€‚

é¡¹ç›®èƒŒæ™¯
----

[BeeCount(èœœèœ‚è®°è´¦)](https://github.com/TNT-Likely/BeeCount)æ˜¯ä¸€æ¬¾å¼€æºã€ç®€æ´ã€æ— å¹¿å‘Šçš„ä¸ªäººè®°è´¦åº”ç”¨ã€‚æ‰€æœ‰è´¢åŠ¡æ•°æ®å®Œå…¨ç”±ç”¨æˆ·æŒæ§ï¼Œæ”¯æŒæœ¬åœ°å­˜å‚¨å’Œå¯é€‰çš„äº‘ç«¯åŒæ­¥ï¼Œç¡®ä¿æ•°æ®ç»å¯¹å®‰å…¨ã€‚

å¼•è¨€
--

åœ¨ç°ä»£Flutteråº”ç”¨å¼€å‘ä¸­ï¼ŒçŠ¶æ€ç®¡ç†æ˜¯å†³å®šé¡¹ç›®æˆè´¥çš„å…³é”®å› ç´ ä¹‹ä¸€ã€‚ä¼ ç»Ÿçš„setStateå·²æ— æ³•æ»¡è¶³å¤æ‚åº”ç”¨çš„éœ€æ±‚ï¼Œè€Œå„ç§çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼ˆProviderã€Blocã€GetXã€Riverpodç­‰ï¼‰éƒ½æœ‰å„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚

BeeCountä½œä¸ºä¸€ä¸ªåŠŸèƒ½å®Œæ•´çš„è´¢åŠ¡ç®¡ç†åº”ç”¨ï¼Œæ¶‰åŠæ•°æ®åº“æ“ä½œã€äº‘åŒæ­¥ã€ä¸»é¢˜åˆ‡æ¢ã€å›½é™…åŒ–ç­‰å¤šä¸ªå¤æ‚åœºæ™¯ã€‚ç»è¿‡å®é™…å¼€å‘éªŒè¯ï¼ŒRiverpodåœ¨æä¾›å¼ºç±»å‹å®‰å…¨ã€ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥ã€ä¾èµ–æ³¨å…¥ç­‰ç‰¹æ€§çš„åŒæ—¶ï¼Œè¿˜ä¿æŒäº†å‡ºè‰²çš„æ€§èƒ½å’Œå¼€å‘ä½“éªŒã€‚

Riverpodæ ¸å¿ƒæ¦‚å¿µ
------------

### Providerç±»å‹é€‰æ‹©

åœ¨BeeCountä¸­ï¼Œæˆ‘ä»¬æ ¹æ®ä¸åŒçš„ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„Providerç±»å‹ï¼š

#### 1\. StateProvider - ç®€å•çŠ¶æ€ç®¡ç†

    // ä¸»é¢˜æ¨¡å¼Provider - ç”¨äºç®€å•çš„çŠ¶æ€å€¼
    final themeModeProvider = StateProvider<ThemeMode>((ref) => ThemeMode.system);
    
    // ä¸»è‰²Provider - æ”¯æŒä¸ªæ€§åŒ–æ¢è£…
    final primaryColorProvider = StateProvider<Color>((ref) => BeeTheme.honeyGold);
    
    // æ˜¯å¦éšè—é‡‘é¢æ˜¾ç¤º
    final hideAmountsProvider = StateProvider<bool>((ref) => false);
    

**é€‚ç”¨åœºæ™¯**ï¼š

*   ç®€å•çš„çŠ¶æ€å€¼ï¼ˆboolã€intã€enumç­‰ï¼‰
*   ä¸éœ€è¦å¤æ‚é€»è¾‘çš„çŠ¶æ€
*   UIå¼€å…³ã€é…ç½®é€‰é¡¹ç­‰

#### 2\. Provider - ä¾èµ–æ³¨å…¥

    // æ•°æ®åº“Provider - å•ä¾‹æ¨¡å¼
    final databaseProvider = Provider<BeeDatabase>((ref) {
      final db = BeeDatabase();
      db.ensureSeed(); // åˆå§‹åŒ–ç§å­æ•°æ®
      ref.onDispose(() => db.close()); // è‡ªåŠ¨æ¸…ç†èµ„æº
      return db;
    });
    
    // ä»“å‚¨Provider - ä¾èµ–æ•°æ®åº“
    final repositoryProvider = Provider<BeeRepository>((ref) {
      final db = ref.watch(databaseProvider);
      return BeeRepository(db);
    });
    

**é€‚ç”¨åœºæ™¯**ï¼š

*   ä¾èµ–æ³¨å…¥
*   å•ä¾‹æœåŠ¡
*   ä¸ä¼šå˜åŒ–çš„é…ç½®å¯¹è±¡

#### 3\. FutureProvider - å¼‚æ­¥åˆå§‹åŒ–

    // ä¸»é¢˜è‰²æŒä¹…åŒ–åˆå§‹åŒ–
    final primaryColorInitProvider = FutureProvider<void>((ref) async {
      final prefs = await SharedPreferences.getInstance();
      final saved = prefs.getInt('primaryColor');
      if (saved != null) {
        ref.read(primaryColorProvider.notifier).state = Color(saved);
      }
      
      // ç›‘å¬å˜åŒ–å¹¶æŒä¹…åŒ–
      ref.listen<Color>(primaryColorProvider, (prev, next) async {
        final colorValue = (next.a * 255).toInt() << 24 | 
                          (next.r * 255).toInt() << 16 | 
                          (next.g * 255).toInt() << 8 | 
                          (next.b * 255).toInt();
        await prefs.setInt('primaryColor', colorValue);
      });
    });
    

**é€‚ç”¨åœºæ™¯**ï¼š

*   åº”ç”¨åˆå§‹åŒ–
*   å¼‚æ­¥èµ„æºåŠ è½½
*   ä¸€æ¬¡æ€§çš„å¼‚æ­¥æ“ä½œ

#### 4\. StreamProvider - å®æ—¶æ•°æ®

    // äº¤æ˜“è®°å½•æµProvider
    final transactionsStreamProvider = StreamProvider.family<List<Transaction>, TransactionQuery>((ref, query) {
      final repo = ref.watch(repositoryProvider);
      return repo.watchTransactions(query);
    });
    

**é€‚ç”¨åœºæ™¯**ï¼š

*   æ•°æ®åº“æŸ¥è¯¢ç»“æœ
*   å®æ—¶æ•°æ®æ›´æ–°
*   WebSocketè¿æ¥ç­‰

æ¨¡å—åŒ–Providerç»„ç»‡
-------------

BeeCounté‡‡ç”¨äº†æ¨¡å—åŒ–çš„Providerç»„ç»‡æ–¹å¼ï¼Œå°†ç›¸å…³çš„ProvideræŒ‰åŠŸèƒ½åˆ†ç»„ï¼š

### ç›®å½•ç»“æ„

    lib/providers/
    â”œâ”€â”€ all_providers.dart          # ç»Ÿä¸€å¯¼å‡º
    â”œâ”€â”€ theme_providers.dart        # ä¸»é¢˜ç›¸å…³
    â”œâ”€â”€ database_providers.dart     # æ•°æ®åº“ç›¸å…³
    â”œâ”€â”€ statistics_providers.dart   # ç»Ÿè®¡ç›¸å…³
    â”œâ”€â”€ sync_providers.dart         # åŒæ­¥ç›¸å…³
    â”œâ”€â”€ ui_state_providers.dart     # UIçŠ¶æ€ç›¸å…³
    â””â”€â”€ import_export_providers.dart # å¯¼å…¥å¯¼å‡ºç›¸å…³
    

### ç»Ÿä¸€å¯¼å‡ºç­–ç•¥

    // all_providers.dart
    export 'theme_providers.dart';
    export 'database_providers.dart';
    export 'statistics_providers.dart';
    export 'sync_providers.dart';
    export 'ui_state_providers.dart';
    export 'import_export_providers.dart';
    
    // providers.dart - ä¸»å¯¼å‡ºæ–‡ä»¶
    export 'providers/all_providers.dart';
    

**ä¼˜åŠ¿**ï¼š

*   æ¨¡å—åŒ–ç®¡ç†ï¼ŒèŒè´£æ¸…æ™°
*   ä¾¿äºç»´æŠ¤å’Œæ‰©å±•
*   é¿å…å¾ªç¯ä¾èµ–
*   æ”¯æŒæŒ‰éœ€å¯¼å…¥

é«˜çº§ä½¿ç”¨æ¨¡å¼
------

### 1\. Providerç»„åˆæ¨¡å¼

    // åº”ç”¨åˆå§‹åŒ–Provider - ç»„åˆå¤šä¸ªåˆå§‹åŒ–é€»è¾‘
    final appInitProvider = FutureProvider<void>((ref) async {
      // æ¿€æ´»ç›‘å¬å™¨
      ref.read(_ledgerChangeListener);
      
      // å¯ä»¥æ·»åŠ å…¶ä»–åˆå§‹åŒ–é€»è¾‘
      await ref.read(primaryColorInitProvider.future);
      // await ref.read(otherInitProvider.future);
    });
    

### 2\. ç›‘å¬å™¨æ¨¡å¼

    // å½“è´¦æœ¬åˆ‡æ¢æ—¶è§¦å‘åŒæ­¥çŠ¶æ€åˆ·æ–°
    final _ledgerChangeListener = Provider<void>((ref) {
      ref.read(_currentLedgerPersist); // æ¿€æ´»æŒä¹…åŒ–
      
      ref.listen<int>(currentLedgerIdProvider, (prev, next) {
        ref.read(syncStatusRefreshProvider.notifier).state++;
      });
    });
    

### 3\. æŒä¹…åŒ–æ¨¡å¼

    final _currentLedgerPersist = Provider<void>((ref) {
      // å¯åŠ¨æ—¶åŠ è½½
      () async {
        try {
          final prefs = await SharedPreferences.getInstance();
          final saved = prefs.getInt('current_ledger_id');
          if (saved != null) {
            ref.read(currentLedgerIdProvider.notifier).state = saved;
          }
        } catch (_) {}
      }();
      
      // å˜åŒ–æ—¶æŒä¹…åŒ–
      ref.listen<int>(currentLedgerIdProvider, (prev, next) async {
        try {
          final prefs = await SharedPreferences.getInstance();
          await prefs.setInt('current_ledger_id', next);
        } catch (_) {}
      });
    });
    

æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
------

### 1\. åˆç†ä½¿ç”¨family

    // ä¸ºä¸åŒæŸ¥è¯¢æ¡ä»¶åˆ›å»ºç‹¬ç«‹çš„Providerå®ä¾‹
    final transactionsProvider = StreamProvider.family<List<Transaction>, TransactionQuery>(
      (ref, query) {
        final repo = ref.watch(repositoryProvider);
        return repo.watchTransactions(query);
      },
    );
    

### 2\. é¿å…ä¸å¿…è¦çš„é‡å»º

    // ä½¿ç”¨selectä»…ç›‘å¬éœ€è¦çš„éƒ¨åˆ†
    Consumer(
      builder: (context, ref, child) {
        // ä»…å½“ä¸»è‰²å‘ç”Ÿå˜åŒ–æ—¶é‡å»º
        final primaryColor = ref.watch(primaryColorProvider);
        return MyWidget(color: primaryColor);
      },
    )
    

### 3\. èµ„æºç®¡ç†

    final databaseProvider = Provider<BeeDatabase>((ref) {
      final db = BeeDatabase();
      ref.onDispose(() => db.close()); // è‡ªåŠ¨æ¸…ç†
      return db;
    });
    

é”™è¯¯å¤„ç†å’Œè°ƒè¯•
-------

### 1\. å¼‚å¸¸å¤„ç†

    final safeDataProvider = FutureProvider<Data>((ref) async {
      try {
        return await fetchData();
      } catch (error, stackTrace) {
        // è®°å½•é”™è¯¯
        logger.error('Failed to fetch data', error, stackTrace);
        
        // è¿”å›é»˜è®¤å€¼æˆ–é‡æ–°æŠ›å‡º
        throw error;
      }
    });
    

### 2\. å¼€å‘è°ƒè¯•

    // åœ¨å¼€å‘ç¯å¢ƒæ·»åŠ æ—¥å¿—
    final debugProvider = Provider<Service>((ref) {
      final service = ServiceImpl();
      
      if (kDebugMode) {
        // æ·»åŠ è°ƒè¯•ç›‘å¬å™¨
        ref.listen<State>(someStateProvider, (prev, next) {
          debugPrint('State changed: $prev -> $next');
        });
      }
      
      return service;
    });
    

æœ€ä½³å®è·µæ€»ç»“
------

### 1\. å‘½åè§„èŒƒ

*   Providerå‘½åï¼š`xxxProvider`
*   å†…éƒ¨ç§æœ‰Providerï¼š`_xxxProvider`
*   åˆå§‹åŒ–Providerï¼š`xxxInitProvider`
*   æµå¼Providerï¼š`xxxStreamProvider`

### 2\. ä¾èµ–ç®¡ç†

*   ä¼˜å…ˆä½¿ç”¨`ref.watch`è¿›è¡Œä¾èµ–æ³¨å…¥
*   é¿å…ç›´æ¥åœ¨Providerå†…éƒ¨åˆ›å»ºå…¨å±€ä¾èµ–
*   ä½¿ç”¨`ref.onDispose`è¿›è¡Œèµ„æºæ¸…ç†

### 3\. çŠ¶æ€ç²’åº¦

*   ä¿æŒçŠ¶æ€çš„åŸå­æ€§ï¼Œé¿å…å¤§è€Œå…¨çš„çŠ¶æ€å¯¹è±¡
*   ç›¸å…³çŠ¶æ€å¯ä»¥åˆ†ç»„ä½†ä¿æŒç‹¬ç«‹
*   ä½¿ç”¨ç»„åˆæ¨¡å¼è€Œéç»§æ‰¿

### 4\. å¼‚æ­¥å¤„ç†

*   åˆç†ä½¿ç”¨FutureProviderå’ŒStreamProvider
*   é¿å…åœ¨Providerå†…éƒ¨ä½¿ç”¨setState
*   ä½¿ç”¨`ref.listen`è¿›è¡Œå‰¯ä½œç”¨å¤„ç†

å®é™…åº”ç”¨æ•ˆæœ
------

åœ¨BeeCounté¡¹ç›®ä¸­ï¼Œé‡‡ç”¨Riverpodæ¶æ„åè·å¾—äº†ä»¥ä¸‹æ”¶ç›Šï¼š

1.  **å¼€å‘æ•ˆç‡æå‡**ï¼šå¼ºç±»å‹æ£€æŸ¥å‡å°‘äº†è¿è¡Œæ—¶é”™è¯¯
2.  **ä»£ç å¯ç»´æŠ¤æ€§**ï¼šæ¨¡å—åŒ–ç»„ç»‡ä½¿ä»£ç ç»“æ„æ¸…æ™°
3.  **æ€§èƒ½ä¼˜åŒ–**ï¼šç²¾ç¡®çš„ä¾èµ–è¿½è¸ªå‡å°‘äº†ä¸å¿…è¦çš„é‡å»º
4.  **æµ‹è¯•å‹å¥½**ï¼šä¾èµ–æ³¨å…¥ä½¿å•å…ƒæµ‹è¯•æ›´å®¹æ˜“ç¼–å†™

ç»“è¯­
--

Riverpodä½œä¸ºFlutterç”Ÿæ€ä¸­çš„æ–°ä¸€ä»£çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å…¶å¼ºå¤§çš„ç‰¹æ€§å’Œè‰¯å¥½çš„è®¾è®¡ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°æ»¡è¶³å¤æ‚åº”ç”¨çš„éœ€æ±‚ã€‚ä½†å…³é”®åœ¨äºå¦‚ä½•åˆç†åœ°ç»„ç»‡å’Œä½¿ç”¨è¿™äº›ç‰¹æ€§ï¼Œå½¢æˆä¸€å¥—é€‚åˆå›¢é˜Ÿçš„æ¶æ„æ¨¡å¼ã€‚

BeeCountçš„å®è·µè¯æ˜ï¼Œé€šè¿‡æ¨¡å—åŒ–ç»„ç»‡ã€åˆç†çš„Providerç±»å‹é€‰æ‹©å’Œè‰¯å¥½çš„å‘½åè§„èŒƒï¼Œå¯ä»¥æ„å»ºå‡ºæ—¢æ˜“äºå¼€å‘åˆæ˜“äºç»´æŠ¤çš„åº”ç”¨æ¶æ„ã€‚å¸Œæœ›è¿™äº›ç»éªŒèƒ½å¤Ÿå¸®åŠ©åˆ°æ­£åœ¨ä½¿ç”¨æˆ–è®¡åˆ’ä½¿ç”¨Riverpodçš„å¼€å‘è€…ä»¬ã€‚

å…³äºBeeCounté¡¹ç›®
------------

### é¡¹ç›®ç‰¹è‰²

*   ğŸ¯ **ç°ä»£æ¶æ„**: åŸºäºRiverpod + Drift + Supabaseçš„ç°ä»£æŠ€æœ¯æ ˆ
*   ğŸ“± **è·¨å¹³å°æ”¯æŒ**: iOSã€AndroidåŒå¹³å°åŸç”Ÿä½“éªŒ
*   ğŸ”„ **äº‘ç«¯åŒæ­¥**: æ”¯æŒå¤šè®¾å¤‡æ•°æ®å®æ—¶åŒæ­¥
*   ğŸ¨ **ä¸ªæ€§åŒ–å®šåˆ¶**: Material Design 3ä¸»é¢˜ç³»ç»Ÿ
*   ğŸ“Š **æ•°æ®åˆ†æ**: å®Œæ•´çš„è´¢åŠ¡æ•°æ®å¯è§†åŒ–
*   ğŸŒ **å›½é™…åŒ–**: å¤šè¯­è¨€æœ¬åœ°åŒ–æ”¯æŒ

### æŠ€æœ¯æ ˆä¸€è§ˆ

*   **æ¡†æ¶**: Flutter 3.6.1+ / Dart 3.6.1+
*   **çŠ¶æ€ç®¡ç†**: Flutter Riverpod 2.5.1
*   **æ•°æ®åº“**: Drift (SQLite) 2.20.2
*   **äº‘æœåŠ¡**: Supabase 2.5.6
*   **å›¾è¡¨**: FL Chart 0.68.0
*   **CI/CD**: GitHub Actions

### å¼€æºä¿¡æ¯

BeeCountæ˜¯ä¸€ä¸ªå®Œå…¨å¼€æºçš„é¡¹ç›®ï¼Œæ¬¢è¿å¼€å‘è€…å‚ä¸è´¡çŒ®ï¼š

*   **é¡¹ç›®ä¸»é¡µ**: [https://github.com/TNT-Likely/BeeCount](https://github.com/TNT-Likely/BeeCount)
*   **å¼€å‘è€…ä¸»é¡µ**: [https://github.com/TNT-Likely](https://github.com/TNT-Likely)
*   **å‘å¸ƒä¸‹è½½**: [GitHub Releases](https://github.com/TNT-Likely/BeeCount/releases)

å‚è€ƒèµ„æº
----

### å®˜æ–¹æ–‡æ¡£

*   [Riverpodå®˜æ–¹æ–‡æ¡£](https://riverpod.dev/) - Riverpodå®Œæ•´ä½¿ç”¨æŒ‡å—
*   [FlutterçŠ¶æ€ç®¡ç†æŒ‡å—](https://flutter.dev/development/data-and-backend/state-mgmt) - Flutterå®˜æ–¹çŠ¶æ€ç®¡ç†å¯¹æ¯”

### å­¦ä¹ èµ„æº

*   [Riverpodå®æˆ˜æ•™ç¨‹](https://codewithandrea.com/articles/flutter-state-management-riverpod/) - Andrea Bizzottoçš„å®æˆ˜æŒ‡å—
*   [Flutteræ¶æ„æ¨¡å¼](https://flutter.dev/development/data-and-backend/architectural-overview) - å®˜æ–¹æ¶æ„æ¦‚è¿°

* * *

_æœ¬æ–‡æ˜¯BeeCountæŠ€æœ¯æ–‡ç« ç³»åˆ—çš„ç¬¬1ç¯‡ï¼Œåç»­å°†æ·±å…¥æ¢è®¨æ•°æ®åº“è®¾è®¡ã€äº‘åŒæ­¥æ¶æ„ç­‰è¯é¢˜ã€‚å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©ï¼Œæ¬¢è¿å…³æ³¨é¡¹ç›®å¹¶ç»™ä¸ªStarï¼_