---
layout: post
title: 'Chrony：让你的服务器时间精准到微秒级的神器！'
date: "2025-01-17T00:34:43Z"
---
Chrony：让你的服务器时间精准到微秒级的神器！
-------------------------

在现代计算机系统中，时间同步是至关重要的。无论是分布式系统、数据库集群，还是日志记录，时间不一致都可能导致严重的问题。而 **Chrony**，作为一款高性能的时间同步工具，正在成为越来越多系统管理员的首选。它不仅比传统的 `ntpd` 更快、更精准，还能在网络不稳定的情况下保持出色的表现。今天，我们就来深入探讨 Chrony 的强大功能，以及如何用它来让你的服务器时间精准到微秒级！

* * *

**为什么需要 Chrony？**
-----------------

在分布式系统中，时间同步的重要性不言而喻。如果服务器之间的时间不一致，可能会导致以下问题：

*   日志时间错乱，难以排查问题。
*   数据库事务冲突，数据一致性被破坏。
*   分布式锁失效，系统出现不可预知的错误。

而 Chrony 正是为了解决这些问题而生的。它通过以下特性脱颖而出：

*   **快速同步**：在网络条件良好的情况下，Chrony 可以在几秒内完成时间同步。
*   **高精度**：支持微秒级的时间同步，满足高精度需求。
*   **适应性强**：即使在网络波动或高延迟的环境中，Chrony 也能保持稳定同步。
*   **低资源占用**：适合资源受限的设备，如嵌入式系统或虚拟机。

* * *

**Chrony 的核心优势**
----------------

### 1\. **比 ntpd 更快、更精准**

Chrony 的设计目标之一就是比传统的 `ntpd` 更快地完成时间同步。它通过智能算法和 `iburst` 选项，在初始同步时发送多个请求，从而大幅缩短同步时间。

### 2\. **适应网络波动**

如果你的服务器位于网络不稳定的环境中（比如云服务器或移动设备），Chrony 的表现会更加出色。它能够动态调整同步策略，减少网络波动对时间同步的影响。

### 3\. **支持离线模式**

即使在没有网络连接的情况下，Chrony 也能依靠本地时钟的漂移率来保持时间的准确性。这对于需要离线运行的系统来说非常实用。

### 4\. **低资源占用**

Chrony 的资源占用非常低，适合在嵌入式设备或虚拟机中运行。它不会对系统性能造成明显影响。

* * *

**如何配置 Chrony？**
----------------

Chrony 的配置文件通常位于 `/etc/chrony.conf`，以下是一个简单的配置示例：

    # 使用阿里云的NTP服务器作为时间源
    # `iburst` 选项表示在初始同步时发送多个请求，加快同步速度
    server ntp.aliyun.com iburst
    server ntp1.aliyun.com iburst
    
    # 使用本地时钟作为备用时间源
    # `stratum 10` 表示本地时钟的层级为10（层级越高，优先级越低）
    local stratum 10
    
    # 允许192.168.1.0/24网段的主机访问chrony服务
    # 可以用于允许内网设备同步时间
    allow 192.168.1.0/24
    
    # 拒绝所有其他主机访问chrony服务
    # 这是一个安全措施，确保只有允许的网段可以访问
    deny all
    
    # 启用RTC（硬件时钟）同步
    # 这会将系统时间同步到硬件时钟，确保重启后时间仍然准确
    rtcsync
    
    # 设置时间步进调整
    # 如果时间偏差超过1.0秒，chrony会立即调整时间
    # 在前3次调整中允许步进调整
    makestep 1.0 3
    
    # 指定时钟漂移文件的路径
    # 该文件用于记录系统时钟的漂移率，帮助chrony更准确地调整时间
    driftfile /var/lib/chrony/drift
    
    # 指定日志文件的存储目录
    # chrony会将日志文件（如measurements.log、statistics.log等）存储在此目录
    logdir /var/log/chrony
    
    # 配置日志记录行为
    # `measurements`：记录时间测量的日志
    # `statistics`：记录统计信息的日志
    # `tracking`：记录时间跟踪信息的日志
    log measurements statistics tracking
    
    # 指定NTP认证密钥文件的路径
    # 如果需要使用NTP认证功能，可以在此指定密钥文件
    keyfile /etc/chrony.keys
    
    # 允许本地主机通过chronyc命令行工具管理chrony
    # 这是一个安全措施，确保只有本地用户可以管理chrony
    cmdallow 127.0.0.1
    
    # 设置NTP服务器的轮询间隔
    # `minpoll 6` 表示最小轮询间隔为2^6=64秒
    # `maxpoll 8` 表示最大轮询间隔为2^8=256秒
    server ntp2.aliyun.com minpoll 6 maxpoll 8
    
    # 设置NTP服务器的优先级
    # `prefer` 表示优先使用该服务器
    server ntp3.aliyun.com prefer
    

配置完成后，启动 Chrony 服务：

    sudo systemctl start chronyd
    sudo systemctl enable chronyd
    

* * *

**Chrony 的常用命令**
----------------

Chrony 提供了一个强大的命令行工具 `chronyc`，用于监控和管理时间同步。以下是一些常用命令：

### **1\. 查看时间服务器状态**

    chronyc sources -v
    

*   显示当前配置的时间服务器及其状态。
*   `^*` 表示当前正在使用的服务器。
*   `^+` 表示可用的备用服务器。

示例输出：

    MS Name/IP address         Stratum Poll Reach LastRx Last sample
    ===============================================================================
    ^* ntp.aliyun.com                2   6   377    46    +12us[-123us] +/-   23ms
    ^+ ntp1.aliyun.com               2   6   377    45    -10us[-145us] +/-   25ms
    

* * *

### **2\. 查看同步状态**

    chronyc tracking
    

*   显示当前系统的时钟同步状态，包括时间偏差、频率偏移等。

示例输出：

    Reference ID    : 123.456.789.101 (ntp.aliyun.com)
    Stratum         : 3
    Ref time (UTC)  : Tue Jan 16 12:34:56 2025
    System time     : 0.000123 seconds slow of NTP time
    Last offset     : +0.000045 seconds
    RMS offset      : 0.000012 seconds
    Frequency       : 1.234 ppm slow
    Residual freq   : +0.001 ppm
    Skew            : 0.012 ppm
    Root delay      : 0.023456 seconds
    Root dispersion : 0.001234 seconds
    Update interval : 64.2 seconds
    Leap status     : Normal
    

* * *

### **3\. 手动同步时间**

    chronyc makestep
    

*   强制立即同步系统时间，适用于时间偏差较大的情况。

* * *

### **4\. 检查客户端访问**

    chronyc clients
    

*   显示当前连接到 Chrony 的客户端信息。

示例输出：

    Hostname                      NTP   Drop Int IntL Last
    ===============================================================================
    192.168.1.100                 2      0   6   -    45
    192.168.1.101                 2      0   6   -    50
    

* * *

### **5\. 查看时间服务器的详细信息**

    chronyc sourcestats -v
    

*   显示时间服务器的统计信息，包括延迟、偏差等。

示例输出：

    Name/IP Address            NP  NR  Span  Frequency  Freq Skew  Offset  Std Dev
    ===============================================================================
    ntp.aliyun.com             12   7   100     +0.001      0.012    +45us    12us
    ntp1.aliyun.com            10   6   100     -0.002      0.015    -30us    15us
    

* * *

### **6\. 添加或删除时间服务器**

*   添加时间服务器：
    
        chronyc add server ntp2.aliyun.com
        
    
*   删除时间服务器：
    
        chronyc delete ntp2.aliyun.com
        
    

* * *

### **7\. 检查 Chrony 的活动状态**

    chronyc activity
    

*   显示当前 Chrony 的活动状态，包括正在使用的服务器数量。

示例输出：

    200 OK
    4 sources online
    0 sources offline
    0 sources doing burst (return to online)
    0 sources doing burst (return to offline)
    0 sources with unknown address
    

* * *

### **8\. 手动调整时间**

    chronyc settime "2025-1-16 12:34:56"
    

*   手动设置系统时间（需谨慎使用）。

* * *

### **9\. 检查 Chrony 的版本**

    chronyc -v
    

*   显示 Chrony 的版本信息。

* * *

### **10\. 重启 Chrony 服务**

    sudo systemctl restart chronyd
    

*   重启 Chrony 服务以应用配置更改。

* * *

**Chrony vs. ntpd：谁更适合你？**
--------------------------

特性

Chrony

ntpd

同步速度

更快

较慢

网络适应性

适应网络波动

对网络稳定性要求较高

资源占用

低

较高

配置复杂度

简单

较复杂

离线模式支持

支持

不支持

如果你的系统需要快速、精准的时间同步，并且可能面临网络不稳定的情况，那么 Chrony 无疑是更好的选择。

* * *

**总结**
------

Chrony 是一款强大而灵活的时间同步工具，能够为你的服务器提供高精度的时间同步服务。无论是数据中心、云服务器，还是嵌入式设备，Chrony 都能轻松应对。通过简单的配置和管理，你可以让系统时间精准到微秒级，彻底告别时间不一致带来的烦恼！

如果你还没有尝试过 Chrony，现在就动手安装吧！相信它会成为你系统管理工具箱中的又一利器。

本文来自博客园，作者：[dashery](https://www.cnblogs.com/ydswin/)，转载请注明原文链接：[https://www.cnblogs.com/ydswin/p/18675228](https://www.cnblogs.com/ydswin/p/18675228)

posted on 2025-01-16 16:25  [dashery](https://www.cnblogs.com/ydswin)  阅读(171)  评论(0)  [编辑](https://i.cnblogs.com/EditPosts.aspx?postid=18675228)  [收藏](javascript:void\(0\))  [举报](javascript:void\(0\))