---
layout: post
title: 'FreeSWITCH使用RNNoise进行实时通话降噪'
date: "2025-11-16T00:45:29Z"
---
FreeSWITCH使用RNNoise进行实时通话降噪
===========================

操作系统：Debian 12.5\_x64

FreeSWITCH版本： 1.10.11

rnnoise版本：0.2

从事FreeSWITCH相关工作，大概率会遇到静音检测和降噪的事情，之前整理过vad相关的内容：

[https://mp.weixin.qq.com/s/sxbhD20ojzQI\_LJlkla0vA](https://mp.weixin.qq.com/s/sxbhD20ojzQI_LJlkla0vA)

今天整理下FreeSWITCH使用RNNoise实现实时音频降噪的笔记，并提供示例代码（如需商业使用请参考文章自行实现)。

我将从以下几个方面展开：

*   模块整体结构介绍
*   模块使用说明及示例
*   模块编译及加载
*   具体实现
*   配套资源下载

关于如何使用RNNoise库进行音频降噪，可参考我之前的笔记：

[https://www.cnblogs.com/MikeZhang/p/19181243/rnnoise20251031](https://www.cnblogs.com/MikeZhang/p/19181243/rnnoise20251031)

本文对应的源码及资源，可从文末提供的渠道获取。

一、模块说明
======

模块名称： mod\_rnnoise

整体结构如下：

![fb068aeeadc261fc7a3056e10920aaa9](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213106027-1352420848.png)

 说明：

1）mod\_rnnoise模块获取channel的原始音频；

2）mod\_rnnoise模块将获取到的原始音频转换成RNNoise库适配的48khz的音频，然后使用RNNoise进行降噪；

3）mod\_rnnoise模块接收降噪后的音频，执行采样率转换（如有需要），回传给channel进行覆盖；

二、模块使用
======

1、API命令说明
---------

【降噪命令】

uuid\_rnnoise

【命令格式】

uuid\_rnnoise <uuid> start|stop read|write

【字段说明】

uuid ： 需要进行降噪的channel uuid

start|stop ： 开始降噪或结束降噪

read|write ： 降噪方向（相对于channel），读取（收音）或者写入（放音）

2、事件说明
------

基于自定义事件实现mod\_rnnoise的事件，关于如何实现自定义事件，可参考如下文章：

[https://www.cnblogs.com/MikeZhang/p/gen\_freeswitch\_event\_20160927.html](https://www.cnblogs.com/MikeZhang/p/gen_freeswitch_event_20160927.html)

有两个事件：

mod\_rnnoise::start 降噪开始事件

mod\_rnnoise::stop 降噪结束事件

有两个自定义字段：

channel\_uuid 执行降噪的channel uuid

nr\_direction 降噪的方向(read | write)

**1）mod\_rnnoise::start 事件**

事件示例如下：

Event-Subclass: mod\_rnnoise::start
Event\-Name: CUSTOM
Core\-UUID: 1ffa45ca-23e6-4a2c-b7aa-684160c2cd47
FreeSWITCH\-Hostname: host72
FreeSWITCH\-Switchname: fs72
FreeSWITCH\-IPv4: 192.168.137.72
FreeSWITCH\-IPv6: ::1
Event\-Date-Local: 2025\-11\-14 01:12:17
Event\-Date-GMT: Fri, 14 Nov 2025 06:12:17 GMT
Event\-Date-Timestamp: 1763100737378843
Event\-Calling-File: mod\_rnnoise.c
Event\-Calling-Function: do\_start
Event\-Calling-Line-Number: 270
Event\-Sequence: 37486
channel\_uuid: f764246a\-dacb-4fe1-ad47-fafdb9c0b4c1
nr\_direction: write

**2）mod\_rnnoise::stop事件**

事件示例如下：

Event-Subclass: mod\_rnnoise::stop
Event\-Name: CUSTOM
Core\-UUID: 1ffa45ca-23e6-4a2c-b7aa-684160c2cd47
FreeSWITCH\-Hostname: host72
FreeSWITCH\-Switchname: fs72
FreeSWITCH\-IPv4: 192.168.137.72
FreeSWITCH\-IPv6: ::1
Event\-Date-Local: 2025\-11\-14 01:12:28
Event\-Date-GMT: Fri, 14 Nov 2025 06:12:28 GMT
Event\-Date-Timestamp: 1763100748839073
Event\-Calling-File: mod\_rnnoise.c
Event\-Calling-Function: do\_stop
Event\-Calling-Line-Number: 307
Event\-Sequence: 37491
channel\_uuid: f764246a\-dacb-4fe1-ad47-fafdb9c0b4c1
nr\_direction: write

运行效果如下：

![579b467ad94f310a1c091e1c63477d66](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213251469-614815353.png)

3、使用示例
------

为了演示方便，这里使用echo呼叫进行测试，使用uuid\_record命令进行双声道录音，使用Audacity 软件查看音频波形。

关于uuid\_record录音可参考如下文章：

[https://mp.weixin.qq.com/s/9wNFyWk-sprHOCBK9O7aGA](https://mp.weixin.qq.com/s/9wNFyWk-sprHOCBK9O7aGA)

关于Audacity 软件的使用可参考如下文章：

[https://www.cnblogs.com/MikeZhang/p/audacity2022022.html](https://www.cnblogs.com/MikeZhang/p/audacity2022022.html)

**1）模拟呼叫**

命令如下：

 originate user/1010 &echo

![a39d25a681ad4c0d1f1c0425a91c2ea0](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213419566-773205351.png)

**2）执行降噪**

这里为了方便对比，使用write方向降噪。

命令如下：

uuid\_rnnoise 81d3b389-1161\-41e9-9287\-ee0ec0bacceb start write

降噪效果可通过耳机等音频播放设备实时体验。

**3）执行录音**

命令如下：

uuid\_record 81d3b389-1161\-41e9-9287\-ee0ec0bacceb start /tmp/t123.wav

**4）关闭降噪**

命令如下：

uuid\_rnnoise 81d3b389-1161\-41e9-9287\-ee0ec0bacceb stop write

此时录音仍在继续。

**5）停止录音**

命令如下：

uuid\_record 81d3b389-1161\-41e9-9287\-ee0ec0bacceb stop /tmp/t123.wav

运行效果如下：

![b2d2ece8a43b8e8b869490bd4a408a4c](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213626200-1352780623.png)

从上图可以看出，使用rnnoise进行实时降噪，背景噪音降噪明显。

配套的录音文件可从文末提供的渠道获取。

三、模块编译
======

1、依赖库说明
-------

这里使用rnnoise库，可参考我之前的文章：

[https://www.cnblogs.com/MikeZhang/p/19181243/rnnoise20251031](https://www.cnblogs.com/MikeZhang/p/19181243/rnnoise20251031)[  
](https://mp.weixin.qq.com/s?__biz=MzU4MDU1NzQ1MA==&mid=2247485811&idx=1&sn=22fb2d727e8b7e046331e42a91b410c8&scene=21#wechat_redirect)

2、复制模块代码到freeswitch目录
---------------------

复制源码到freeswitch目录：

cp mod\_rnnoise /root/src/freeswitch-1.10.11.-release/src/mod/applications/ -r

3、添加FreeSWITCH编译配置项
-------------------

1）添加模块编译项

文件：源码根目录的modules.conf文件

添加如下代码：

applications/mod\_rnnoise

![817b68b7e0cb32d9f81cee8e9607bcc7](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213815475-1180658703.png)

2）添加模块自动生成Makefile

文件：  源码根目录的configure.ac文件

添加如下代码：

src/mod/applications/mod\_rnnoise/Makefile

![5d8bfee769562ad800c7fcfda7208831](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114213919756-909897516.png)

4、重新编译FreeSWITCH
----------------

源码目录执行如下命令：

autoreconf -fiv
make clean
./devel-bootstrap.sh && ./configure && make && make install

说明：

1）会生成Makefile文件；

2）会静态编译mod\_rnnoise模块；

![c9addd8d6d61bd09de4aca90c0b9b1b2](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214034761-377202095.png)

5、加载mod\_rnnoise模块
------------------

编辑 conf/autoload\_configs/modules.conf.xml 文件，添加如下内容：

<load module="mod\_rnnoise"/>

![f348328210be4587568668ee5213af85](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214106766-1383001659.png)

 重启FreeSWITCH或执行重新load操作：

reload mod\_rnnoise

![f4558891b350e5cd47ba0f376d5eba03](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214134927-1124517810.png)

如果加载不报错，则添加mod\_rnnoise模块成功。

四、具体实现
======

说明：

**本文主要讨论技术，配套资源为示例代码，如需商业使用，请参考文章自行实现。**

这里描述下实现的部分技术关键点，更多内容可从文末提供的渠道获取。

1、采样率转换
-------

当前使用的rnnoise库所使用的音频采样率是48khz，而在FreeSWITCH中，采样率可能是8khz（比如PCMA、PCMU编码），这就涉及采样率转换的情况。

![9ee10ee7acd30f25c71122ac51174c98](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214212097-937644131.png)

这里使用简单的线性插值方式进行采样率转换。

示例代码如下：

![b04a4b792038ac147373aafb0853fbd3](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214226553-1565853609.png)

完整源码可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251114 获取。 

2、降噪功能
------

降噪功能使用RNNoise库的rnnoise\_process\_frame函数实现，具体如下（以8khz为例）：

![d5a81aea8667987a1bdbe64e9ac70d6b](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214305870-852552336.png)

完整源码可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251114 获取。 

五、资源下载
======

本文相关资源及示例代码，可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251114 获取。

![90dd27fc47fde287997e5f2e810e4ab6](https://img2024.cnblogs.com/blog/300959/202511/300959-20251114214537791-1483565182.png)

【文件说明】

mod\_rnnoise\_src.tar.gz ： mod\_rnnoise源代码

mod\_rnnoise\_srcbin.tar.gz ： mod\_rnnoise源代码（带预编译的so文件，路径为mod\_rnnoise.libs\\）

mod\_rnnoise\_bin\_debian12.tar.gz : debian12\_x64环境下预编译二进制（so文件）

t123.wav ： 带降噪效果的录音文件

如果你对该文章有疑问，可通过微信公众号（聊聊博文）向我提问：  
[![](https://files.cnblogs.com/files/MikeZhang/201804weixingongzhong1.gif)](https://files.cnblogs.com/files/MikeZhang/201804weixingongzhong1.gif)  
转载请注明出处，谢谢！