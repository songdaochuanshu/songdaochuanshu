---
layout: post
title: '在MaxKB中实现准确的Chat TO SQL（BI）'
date: "2025-04-15T00:40:28Z"
---
在MaxKB中实现准确的Chat TO SQL（BI）
===========================

主要面向考试成绩管理系统(目前支持旭日图、仪表盘柱状图、桑基图、漏斗图、河流图、数据聚合图、散点图、南丁格尔玫瑰图、饼状图、环形图、堆叠柱状图、堆叠折线图、堆叠面积图、面积图、折线图)

**主要思路：**  
第一步实现chat to sql，利用用户问题，生成准确的sql  
第二步利用第一步sql查询到的数据，配合MaxKB内置的 <echarts\_rander></echarts\_rander> 标签实现图表的生成

### 第一部分：Chat To SQL

#### 方案一：适合表不多的情况，比如5张表左右的级联查询

此方案的重点就是在提示词中加入DSL和DML的描述，如下：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105403116-1906102856.png)

此方案缺点也很明显：适合数据表量小的情况，还有利用大模型只生成了一次SQL，准确率不会太高。

#### 方案二：适合多表的情况，将DSL和DML采用知识库进行存储

为了满足大量表的查询，提前准备DSL和DML的描述，并按照合理分段存入知识库中：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105438095-1863862054.png)

同时，提前准备100个（具体可按照项目实际情况准备个数）用户经常使用的准确SQL，采用QA对方式存入知识库中：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105501532-1873163622.png)

在编排中，先利用问题相似度检索用户问题涉及到的表DSL和DML，并作为提示词给大模型

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105529981-325156637.png)

#### 方案三：最终方案，在前两个方案的基础上，引入SQL专家裁判机制，提高SQL准确率

#### 方案3.1 SQL裁判方案

方案3.1主要先利用三个大模型生成三个SQL，然后在让第四个大模型充当裁判，选出最准确的SQL进行查询

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105619466-2131479533.png)

查询效果：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105636516-1945563237.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105703910-1695006351.png)

#### 方案3.2 MCP SQL 方案

MCP SQL方案相对要简单些，主要在AI会话节点接入DB MCP，然后利用提示词控制模型进行多次查询校验。

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105754081-1458564117.png)

查询效果：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105813372-459777555.png)

### 第二部分：SQL TO BI

第二部分的图表展示，主要利用第一步已经生成的SQL查询到数据，采用图表进行展示。核心的思路为：

1.创建图表库，包含常用的echart图表，图表内容为echart官方网站的option，并创建问题关联：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105844833-226373832.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105853437-1881663469.png)

2.在编排中，基于用户的问题判断是否有图表支持，并输出图表名称

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105911386-643122542.png)

3.通过大模型输出的图表名称去知识库查询图表的option，并作为提示词给大模型

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105931438-1381815078.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414105947926-34377515.png)

整体编排如下：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110005832-1124086120.png)

查询效果：

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110032987-1955941801.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110047945-1795980940.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110058657-655496378.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110108092-734220817.png)

![](https://img2024.cnblogs.com/blog/3600464/202504/3600464-20250414110120445-1459720295.png)