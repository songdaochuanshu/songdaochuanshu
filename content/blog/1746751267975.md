---
layout: post
title: 'ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ'
date: "2025-05-09T00:41:07Z"
---
ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ
============================

![ã€SQLå‘¨å‘¨ç»ƒã€‘ç»™ä½ æ— é…¸çº¸ã€å˜è‰²æ²¹å¢¨ï¼Œä½ èƒ½ä¼ªé€ å¤šå°‘ç¾é‡‘ï¼Ÿ](https://img2024.cnblogs.com/blog/3640949/202504/3640949-20250427174046256-277631692.png) æ ¹æ®ç”µå½±ã€Šæ— åŒã€‹è‡ªåˆ›çš„ SQL é¢˜ç›®ï¼šå‡è®¾ä¼ªé’é›†å›¢æ¯æ—¥ç»™ä½ ä¾›åº”éšæœºæ•°é‡çš„å˜è‰²æ²¹å¢¨ã€æ— é…¸çº¸ã€å®‰å…¨çº¿/é˜²ä¼ªçº¿ã€‚è¯·ä½ è®¡ç®—æ¯å¤©èƒ½åˆ¶ä½œä¼ªé’å¤šå°‘å¼ ï¼Œå¹¶ä¸”æ ¹æ®å½“å¤©çš„æƒ…å†µè¾“å‡ºç¬¬äºŒå¤©æœ€ç¼ºå°‘çš„ææ–™ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯â€œè’‹ç‚¹æ•°åˆ†â€ï¼Œå¤šå¹´ä»¥æ¥ä¸€ç›´ä»äº‹æ•°æ®åˆ†æå·¥ä½œã€‚ä»ä»Šå¤©å¼€å§‹ï¼Œä¸å¤§å®¶æŒç»­åˆ†äº«å…³äºæ•°æ®åˆ†æçš„å­¦ä¹ å†…å®¹ã€‚

æœ¬æ–‡æ˜¯ç¬¬ 2 ç¯‡ï¼Œä¹Ÿæ˜¯ã€SQL å‘¨å‘¨ç»ƒã€‘ç³»åˆ—çš„ç¬¬ 2 ç¯‡ã€‚è¯¥ç³»åˆ—æ˜¯æŒ‘é€‰æˆ–è‡ªåˆ›å…·æœ‰ä¸€äº›éš¾åº¦çš„ SQL é¢˜ç›®ï¼Œä¸€å‘¨è‡³å°‘æ›´æ–°ä¸€ç¯‡ã€‚åç»­åˆ›ä½œçš„å†…å®¹ï¼Œåˆæ­¥è§„åˆ’çš„æ–¹å‘åŒ…æ‹¬ï¼š

åç»­å†…å®¹è§„åˆ’
------

1.åˆ©ç”¨Â **Streamlit**Â å®ç°Â `Hive å…ƒæ•°æ®å±•ç¤º`ã€`SQL ç¼–è¾‘å™¨`ã€ ç»“åˆ`Docker æ²™ç®±å®ç°æ•°æ®åˆ†æ Agent`  
2.æ—¶é—´åºåˆ—å¼‚å¸¸è¯†åˆ«ã€å¼‚åŠ¨å½’å› ç®—æ³•  
3.ç•™å­˜ç‡æ‹Ÿåˆã€é¢„æµ‹ã€å»ºæ¨¡  
4.å­¦ä¹ Â `AB å®éªŒ`ã€å¤æ‚å®éªŒè®¾è®¡ç­‰  
5.`è‡ªåŠ¨åŒ–æœºå™¨å­¦ä¹ `ã€è‡ªåŠ¨åŒ–ç‰¹å¾å·¥ç¨‹  
6.`å› æœæ¨æ–­`å­¦ä¹   
7\. â€¦â€¦

**æ¬¢è¿å…³æ³¨**ï¼Œä¸€èµ·å­¦ä¹ ã€‚

ç¬¬ 2 æœŸé¢˜ç›®
-------

é¢˜ç›®æ¥æºï¼šè‡ªåˆ›é¢˜ç›®ï¼Œåœºæ™¯æ¥æºäºé¦™æ¸¯ç”µå½±ã€Šæ— åŒã€‹

### ä¸€ã€é¢˜ç›®ä»‹ç»

ã€Šæ— åŒã€‹æ˜¯ä¸€éƒ¨å¾ˆä¸é”™çš„ç”µå½±ï¼Œå…¶ä¸»é¢˜æ˜¯ä¼ªé€ ç¾é’ã€‚è™½ç„¶å·²ç»ä¸Šæ˜ å¤šå¹´ï¼Œä½†å…¶ä¸­â€œæ— é…¸çº¸â€ã€â€œå˜è‰²æ²¹å¢¨â€çš„æ¢—ï¼Œè‡³ä»Šåœ¨ç½‘ä¸Šä¾æ—§å¯ä»¥çœ‹åˆ°ã€‚å…¶ä¸­çš„ä¸€ä¸ªç»å…¸ç‰‡æ®µ â€”â€” â€œç”»å®¶â€(å‘¨æ¶¦å‘)å—”æ€ªâ€œæé—®â€(éƒ­å¯ŒåŸ)è®¢è´­äº†500å¨æ— é…¸çº¸ï¼Œè¯´è®©â€œææ–‡â€æ´»ç€ç»™ä»–å°å®Œï¼ˆå½“ç„¶ç»“å°¾å±•ç¤ºäº†éƒ­å¯ŒåŸå…¶å®æ‰æ˜¯â€œç”»å®¶â€ï¼‰ã€‚é‚£ä¹ˆç”±æ­¤è€Œæ¥ï¼Œæˆ‘æƒ³å‡ºäº†ä¸€é“ SQL é¢˜ï¼š

å‡è®¾ä¼ªé’é›†å›¢æ¯æ—¥ç»™ä½ ä¾›åº”éšæœºæ•°é‡çš„`å˜è‰²æ²¹å¢¨`ã€`æ— é…¸çº¸`ã€`å®‰å…¨çº¿/é˜²ä¼ªçº¿`ï¼ˆæœªç”¨å®Œçš„ææ–™å¯ä»¥ç•™ç»™åé¢ç”¨ï¼‰ï¼Œå‡¹ç‰ˆå°åˆ·æœºç­‰å…¶ä»–ææ–™å’Œå·¥å…·ä¹Ÿå·²ç»å‡†å¤‡å¥½ã€‚

è¯·ä½ è®¡ç®—æ¯å¤©èƒ½åˆ¶ä½œä¼ªé’å¤šå°‘å¼ ï¼Œå¹¶ä¸”æ ¹æ®å½“å¤©çš„æƒ…å†µè¾“å‡ºç¬¬äºŒå¤©**æœ€ç¼º**å“ªç§ææ–™ï¼š

åˆ—å

æ•°æ®ç±»å‹

æ³¨é‡Š

date

string

æ—¥æœŸ

acid\_free\_paper\_supply

int

æ— é…¸çº¸ä¾›åº”é‡ï¼ˆå•ä½gï¼‰

optically\_variable\_ink\_supply

int

å˜è‰²æ²¹å¢¨ä¾›åº”é‡ï¼ˆå•ä½mgï¼‰

security\_thread\_supply

int

å®‰å…¨çº¿ä¾›åº”é‡

å‡è®¾ ä¸€å¼ ä¼ªé’éœ€è¦Â 1g æ— é…¸çº¸ï¼Œ0.005g çš„å˜è‰²æ²¹å¢¨ï¼Œ1 æ ¹å®‰å…¨çº¿ï¼›å°åˆ¶è¿‡ç¨‹ä¸­ä¸è€ƒè™‘æŸè€—

### äºŒã€é¢˜ç›®æ€è·¯

æƒ³è¦ç­”é¢˜çš„åŒå­¦ï¼Œå¯ä»¥å…ˆæ€è€ƒç­”æ¡ˆğŸ¤”ã€‚  
â€¦â€¦

â€¦â€¦

â€¦â€¦

æˆ‘æ¥è°ˆè°ˆæˆ‘çš„æ€è·¯ï¼šè¿™é“é¢˜ç›®çš„è®¾è®¡ï¼Œææ–™æ˜¯ä»¥å›ºå®šæ¯”ä¾‹çš„æŠ•å…¥äº§ç”Ÿä¸€å¼ ä¼ªé’ï¼Œå“ªç§ææ–™ç›¸å¯¹è¾ƒå°‘ï¼Œå“ªç§ææ–™å°±é™åˆ¶ä½äº†ä¼ªé’çš„åˆ¶é€ æ•°é‡ï¼›æ‰€ä»¥å¯ä»¥**å•ç‹¬è®¡ç®—ä¸‰ç§ææ–™èƒ½åˆ¶é€ å¤šå°‘ä¼ªé’**ï¼Œç„¶åç”¨Â `least`Â æ±‚æœ€å°å€¼ï¼Œç±»ä¼¼â€œæœ¨æ¡¶çŸ­æ¿ç†è®ºâ€ã€‚é¢˜ç›®é‡Œæåˆ°äº†å½“æ—¥æœªç”¨å®Œçš„ææ–™ï¼Œå¯ä»¥åé¢å†ç”¨ï¼›æ‰€ä»¥æ¯å¤©ä¸éœ€è¦å•ç‹¬è®¡ç®—ï¼Œç›´æ¥è®¡ç®—ä»å¼€å§‹åˆ°å½“å¤© => è¿™åˆç”¨ä¸Šäº†æ•°æ®åˆ†æå¸ˆçš„è€æœ‹å‹â€œçª—å£å‡½æ•°â€ã€‚

ä¸‹é¢ï¼Œæˆ‘ç”¨Â `NumPy`Â å’ŒÂ `Scipy`Â ç”Ÿæˆæ¨¡æ‹Ÿçš„æ•°æ®é›†ï¼š

### ä¸‰ã€ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®

åªå…³å¿ƒ SQL ä»£ç çš„åŒå­¦ï¼Œå¯ä»¥è·³è½¬åˆ°ç¬¬å››èŠ‚ï¼ˆæˆ‘åœ¨å·¥ä½œä¸­ä½¿ç”¨Â `Hive`Â è¾ƒå¤šï¼Œå› æ­¤é‡‡ç”¨Â `Hive`Â çš„è¯­æ³•ï¼‰

æ¨¡æ‹Ÿä»£ç å¦‚ä¸‹ï¼š

1\. å®šä¹‰æ¨¡æ‹Ÿé€»è¾‘éœ€è¦çš„`å¸¸é‡`ï¼Œè®¡ç®—ç›®æ ‡æ•°é‡çš„ä¼ªé’éœ€è¦å¤šå°‘ææ–™ï¼š

    import numpy as np
    import pandas as pd
    import scipy
    
    # éšæœºæ•°ç§å­
    RANDOM_SEED = 2025
    # ä¼ªé€ å¼€å§‹æ—¥æœŸ
    START_DATE = "2025-05-01"
    # ä¼ªé€ å¤©æ•°
    NUM_DAY = 10
    # éœ€è¦ä¼ªé€ çš„ä¼ªé’æ•°é‡ï¼ˆå¼ æ•°ï¼Œéé‡‘é¢ï¼‰
    NUM_TOTAL_COUNTERFEIT_CURRENCY = 1_000_000
    
    # ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘æ— é…¸çº¸ï¼Œç®€åŒ–é—®é¢˜åªè€ƒè™‘é‡é‡(å•ä½ g)
    ACID_FREE_PAPER_EACH_COUNTERFEIT_CURRENCY = 1
    # æ‰€æœ‰ä¼ªé’éœ€è¦çš„æ— é…¸çº¸(1.05 æ˜¯ä¸€ä¸ªå†—ä½™åº¦ï¼Œæ‰€æœ‰ææ–™ç±»ä¼¼)
    ACID_FREE_PAPER_ALL_NEED = (
        ACID_FREE_PAPER_EACH_COUNTERFEIT_CURRENCY 
        * NUM_TOTAL_COUNTERFEIT_CURRENCY 
        * 1.05
    )
    
    # ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘å˜è‰²æ²¹å¢¨ï¼Œé‡é‡ï¼ˆå•ä½ mgï¼‰
    OPTICALLY_VARIABLE_INK_EACH_COUNTERFEIT_CURRENCY = 5
    # æ‰€æœ‰ä¼ªé’éœ€è¦çš„å˜è‰²æ²¹å¢¨
    OPTICALLY_VARIABLE_INK_ALL_NEED = (
        OPTICALLY_VARIABLE_INK_EACH_COUNTERFEIT_CURRENCY
        * NUM_TOTAL_COUNTERFEIT_CURRENCY
        * 1.05
    )
    
    # ä¸€å¼ ä¼ªé’éœ€è¦å¤šå°‘å®‰å…¨çº¿ï¼ˆå•ä½ æ¡ï¼‰
    SECURITY_THREAD_EACH_COUNTERFEIT_CURRENCY = 1
    # æ‰€æœ‰ä¼ªé’éœ€è¦çš„é˜²ä¼ªçº¿
    SECURITY_THREAD_ALL_NEED = (
        SECURITY_THREAD_EACH_COUNTERFEIT_CURRENCY 
        * NUM_TOTAL_COUNTERFEIT_CURRENCY 
        * 1.05
    )

2\. ä¼ªé’éœ€è¦çš„ææ–™æ¯å¤©æŒ‰ç…§éšæœºçš„æƒé‡æä¾›ï¼Œæƒé‡éœ€è¦å½’ä¸€åŒ–ï¼š

    # æƒé‡èŒƒå›´ï¼Œç”¨æ¥éšæœºç”Ÿæˆæ•°æ®ï¼ˆéœ€è¦å½’ä¸€åŒ–ï¼‰
    WEIGHT_RANGE = (0.2, 2)
    
    # æ— é…¸çº¸æ¯å¤©ä¾›åº”çš„éšæœºæƒé‡
    acid_free_paper_supply_weight = scipy.stats.uniform.rvs(
        loc=WEIGHT_RANGE[0],
        scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
        size=NUM_DAY,
        random_state=RANDOM_SEED - 1,
    )
    
    # å˜è‰²æ²¹å¢¨æ¯å¤©ä¾›åº”çš„æƒé‡
    optically_variable_ink_supply_weight = scipy.stats.uniform.rvs(
        loc=WEIGHT_RANGE[0],
        scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
        size=NUM_DAY,
        random_state=RANDOM_SEED,
    )
    
    # å®‰å…¨çº¿æ¯å¤©ä¾›åº”çš„æƒé‡
    security_thread_supply_weight = scipy.stats.uniform.rvs(
        loc=WEIGHT_RANGE[0],
        scale=WEIGHT_RANGE[1] - WEIGHT_RANGE[0],
        size=NUM_DAY,
        random_state=RANDOM_SEED + 1,
    )
    
    # å°†æƒé‡å½’ä¸€åŒ–ï¼Œä½¿å¾—æ‰€æœ‰å¤©æ•°çš„ä¾›åº”æ¯”ä¾‹å’Œä¸º 1
    acid_free_paper_supply_weight /= acid_free_paper_supply_weight.sum()
    optically_variable_ink_supply_weight /= optically_variable_ink_supply_weight.sum()
    security_thread_supply_weight /= security_thread_supply_weight.sum()

3\. å°†å‰é¢ç”Ÿæˆçš„æ•°æ®è½¬ä¸º `pd.DataFrame`ï¼Œå¹¶è¾“å‡ºä¸ºÂ `csv`Â æ–‡ä»¶ï¼š

    df = pd.DataFrame(
        {
            "acid_free_paper_supply": ACID_FREE_PAPER_ALL_NEED
            * acid_free_paper_supply_weight,
            "optically_variable_ink_supply": OPTICALLY_VARIABLE_INK_ALL_NEED
            * optically_variable_ink_supply_weight,
            "security_thread_supply": SECURITY_THREAD_ALL_NEED
            * security_thread_supply_weight
        }
    )
    
    # å››èˆäº”å…¥å¹¶è½¬ä¸º int
    df = df.round().astype(int)
    df["date"] = pd.date_range(start=START_DATE, periods=NUM_DAY, freq="D")
    
    # åœ¨ Jupyter ä¸­å±•ç¤ºæ•°æ®
    display(df)
    
    out_csv_path = "./dwd_conterfeit_material_daily_supply_records.csv"
    columns = [
        "date",
        "acid_free_paper_supply",
        "optically_variable_ink_supply",
        "security_thread_supply"
    ]
    # å¯¼å‡º csv ç”¨æ¥è®© hive load æ•°æ®ï¼Œutf-8-sig ç¼–ç å¤„ç†ä¸­æ–‡ï¼Œè™½ç„¶è¡¨é‡Œæ•°æ®æ²¡æœ‰ä¸­æ–‡
    df[columns].to_csv(out_csv_path, header=False, index=False, encoding="utf-8-sig")

4\. åˆ›å»ºæ–°çš„ `Hive`Â è¡¨ï¼Œå¹¶å°†æ•°æ®Â `load`Â åˆ°è¡¨ä¸­ï¼š

    from pyhive import hive
    
    # é…ç½®è¿æ¥å‚æ•°
    host_ip = "127.0.0.1"
    port = 10000
    username = "è’‹ç‚¹æ•°åˆ†"
    
    
    with hive.Connection(host=host_ip, port=port) as conn:
        cursor = conn.cursor()
    
        drop_table_sql = """
        drop table if exists data_exercise.dwd_conterfeit_material_daily_supply_records
        """
        print(drop_table_sql)
        cursor.execute(drop_table_sql)
    
        create_table_sql = """
        create table data_exercise.dwd_conterfeit_material_daily_supply_records (
            `date` string comment "æ—¥æœŸ",
            acid_free_paper_supply int comment "æ— é…¸çº¸ä¾›åº”é‡ï¼ˆå•ä½gï¼‰",
            optically_variable_ink_supply int comment "å˜è‰²æ²¹å¢¨ä¾›åº”é‡ï¼ˆå•ä½mgï¼‰",
            security_thread_supply int comment "å®‰å…¨çº¿ä¾›åº”é‡"
        )
        comment "ä¼ªé’é›†å›¢æ¯å¤©ä¾›åº”çš„ä¼ªé’åŸææ–™æ•°é‡ | æ–‡ç« ç¼–å·ï¼š2c3d2561"
        row format delimited fields terminated by ","
        stored as textfile
        """
        
        print(create_table_sql)
        cursor.execute(create_table_sql)
    
        import os
        
        load_data_sql = f"""
        load data local inpath "{os.path.abspath(out_csv_path)}" 
        overwrite into table data_exercise.dwd_conterfeit_material_daily_supply_records
        """
        
        print(load_data_sql)
        cursor.execute(load_data_sql)
    
        cursor.close()

> æˆ‘é€šè¿‡ä½¿ç”¨Â `PyHive`Â åŒ…å®ç° Python æ“ä½œÂ `Hive`ã€‚æˆ‘ä¸ªäººç”µè„‘éƒ¨ç½²äº†Â `Hadoop`Â åŠÂ `Hive`ï¼Œä½†æ˜¯æ²¡æœ‰å¼€å¯è®¤è¯ï¼Œä¼ä¸šé‡Œä¸€èˆ¬å¸¸ç”¨Â `Kerberos`Â æ¥è¿›è¡Œå¤§æ•°æ®é›†ç¾¤çš„è®¤è¯ã€‚

### å››ã€SQL è§£ç­”

æ€è·¯åœ¨ç¬¬äºŒèŠ‚å·²ç»è¯´æ˜ï¼Œä¸‹é¢æ˜¯ä»£ç ï¼Œç»†èŠ‚å‚è§æ³¨é‡Šã€‚å…¶ä¸­Â `cumulative_conterfeit_all_restriction`Â ç­‰äºå“ªç§ææ–™çš„Â `cumulative_conterfeit_only...`Â å°±å¯ä»¥è®¤ä¸ºç¬¬äºŒå¤©æœ€ç¼ºå“ªç§ææ–™ï¼ˆä¼ªé’åˆ¶é€ é‡è¢«è¿™ç§ææ–™åˆ¶çº¦ï¼‰ã€‚æç¤ºï¼š`order by`Â æ—¶ï¼Œç»Ÿè®¡çš„çª—å£èŒƒå›´é»˜è®¤æ˜¯Â `rows between preceding unbounded and current row`ï¼Œå†™æ¸…æ¥šæ›´å¥½ã€‚ä¸‰ç§ææ–™å•ç‹¬åˆ¤æ–­ï¼Œç„¶åç”¨Â `concat_ws`Â åˆå¹¶ç»“æœï¼ˆæ³¨æ„å…¶ä»– SQL æ–¹è¨€ä¸ä¸€å®šæœ‰Â `Hive`Â çš„è¿™ä¸ªå‡½æ•°ï¼‰ã€‚

æ¯å¤©çš„ä¼ªé’åˆ¶é€ é‡Â `action_daily_production`Â ä½¿ç”¨Â `cumulative_conterfeit_all_restriction`Â ç»“åˆçª—å£å‡½æ•°Â `lag`Â å‡å»ä¸Šä¸€è¡Œå³å¯ã€‚

    with calc_single_material_restrict_production as (
        -- è®¡ç®—ä¸€ç§ææ–™é™åˆ¶èƒ½é€ å¤šå°‘ç¾å…ƒä¼ªé’
        select
          `date`
        , acid_free_paper_supply
        , optically_variable_ink_supply
        , security_thread_supply
        -- åªè€ƒè™‘æ— é…¸çº¸ï¼Œä¸è€ƒè™‘å…¶ä»–ææ–™å’Œæ¯æ—¥æœ€å¤§åˆ¶é€ é‡é™åˆ¶ï¼Œç´¯è®¡ä¼ªé’åˆ¶ä½œæ•°ï¼Œä¸‹é¢ä»¥æ­¤ç±»æ¨
        -- æœ‰äº›ææ–™æ¯”ä¾‹ä¸º 1ï¼Œå› æ­¤ä¸é¢å¤–å†™é™¤ä»¥ 1
        , sum(acid_free_paper_supply) over(orderby `date` asc) as cumulative_conterfeit_only_acid_free_paper
        -- æ³¨æ„å‘ä¸‹å–æ•´
        , floor(sum(optically_variable_ink_supply) over(orderby `date` asc) /5) as cumulative_conterfeit_only_optically_variable_ink
        , sum(security_thread_supply) over(orderby `date` asc) as cumulative_conterfeit_only_security_thread
        from data_exercise.dwd_conterfeit_material_daily_supply_records
    )
    
    , calc_all_restriction_prodection as (
        select
          `date`
        , acid_free_paper_supply
        , optically_variable_ink_supply
        , security_thread_supply
        , cumulative_conterfeit_only_acid_free_paper
        , cumulative_conterfeit_only_optically_variable_ink
        , cumulative_conterfeit_only_security_thread
        -- ä½¿ç”¨ least è®¡ç®—æœ€å°å€¼
        , least(
            cumulative_conterfeit_only_acid_free_paper, 
            cumulative_conterfeit_only_optically_variable_ink, 
            cumulative_conterfeit_only_security_thread
          ) as cumulative_conterfeit_all_restriction
        from calc_single_material_restrict_production
    
    )
    
    select
      `date`
    , cumulative_conterfeit_only_acid_free_paper
    , cumulative_conterfeit_only_optically_variable_ink
    , cumulative_conterfeit_only_security_thread
    , cumulative_conterfeit_all_restriction
    -- å‡å»ä¸Šä¸€è¡Œçš„æ•°æ®ï¼Œè·å–æ¯æ—¥ä¼ªé’åˆ¶é€ é‡
    , cumulative_conterfeit_all_restriction -lag(cumulative_conterfeit_all_restriction, 1, 0) over(orderby `date` asc) as action_daily_production
    , if( cumulative_conterfeit_all_restriction >=1000000, null, -- å·²ç»å®Œæˆç›®æ ‡é‡ï¼Œå°±ä¸å†™ç¼ºå“ªç§ææ–™äº†
        concat_ws(',', 
            if(cumulative_conterfeit_only_acid_free_paper=cumulative_conterfeit_all_restriction, 'æ— é…¸çº¸', null),
            if(cumulative_conterfeit_only_optically_variable_ink=cumulative_conterfeit_all_restriction, 'å˜è‰²æ²¹å¢¨', null),
            if(cumulative_conterfeit_only_security_thread=cumulative_conterfeit_all_restriction, 'å®‰å…¨çº¿', null)
        )
    ) as `æœ€ç¼ºçš„ææ–™`
    from calc_all_restriction_prodection

æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š

date

cumulative\_conterfeit\_only\_acid\_free\_paper

cumulative\_conterfeit\_only\_optically\_variable\_ink

cumulative\_conterfeit\_only\_security\_thread

cumulative\_conterfeit\_all\_restriction

action\_daily\_production

æœ€ç¼ºçš„ææ–™

2025-05-01

139293

36604

51579

36604

36604

å˜è‰²æ²¹å¢¨

2025-05-02

300720

184888

133386

133386

96782

å®‰å…¨çº¿

2025-05-03

360345

339815

303165

303165

169779

å®‰å…¨çº¿

2025-05-04

391211

422448

334383

334383

31218

å®‰å…¨çº¿

2025-05-05

454196

496570

426535

426535

92152

å®‰å…¨çº¿

2025-05-06

497465

551300

598018

497465

70930

æ— é…¸çº¸

2025-05-07

664497

665371

646287

646287

148822

å®‰å…¨çº¿

2025-05-08

821998

754988

805933

754988

108701

å˜è‰²æ²¹å¢¨

2025-05-09

938544

914610

910409

910409

155421

å®‰å…¨çº¿

2025-05-10

1050000

1050000

1050001

1050000

139591

null

![](https://img2024.cnblogs.com/blog/3640949/202504/3640949-20250427173852509-2026342824.png)

vchart ç»˜åˆ¶å¯è§†åŒ–ç»“æœ

ä¸Šé¢çš„å›¾ç‰‡ï¼Œæ˜¯æˆ‘åœ¨Â `Python`Â ä¸­ä½¿ç”¨Â `pyvchart`Â åº“å®ç°çš„ï¼Œå®ƒæ˜¯å­—èŠ‚è·³åŠ¨å¼€æºçš„Â `vchart`Â çš„ Python åŒ…ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Â `pyecharts`ã€‚`pd.melt`Â å‡½æ•°ç”¨äºå°†â€œå®½æ•°æ®æ¡†â€è½¬â€œé•¿æ•°æ®æ¡†â€ã€‚ä»£ç éƒ¨åˆ†å¦‚ä¸‹ï¼š

    with hive.Connection(host=host_ip, port=port) as conn:
        select_data_sql = ''' æˆ‘ç»™å‡º SQL ç­”æ¡ˆ '''
        df_outcome = pd.read_sql_query(select_data_sql, conn)
    
    from pyvchart import render_chart
    spec = {
    "type": 'area',
    "data": [
        {
          "id": 'lineData',
          "values": pd.melt(df_outcome[[
            'date','cumulative_conterfeit_only_acid_free_paper',
            'cumulative_conterfeit_only_optically_variable_ink',
            'cumulative_conterfeit_only_security_thread'
          ]], id_vars=['date']).to_dict(orient='records')
        },
        {
          "id": 'areaData',
          "values": pd.melt(df_outcome[['date','cumulative_conterfeit_all_restriction',
            'æœ€ç¼ºçš„ææ–™']], id_vars=['date']).to_dict(orient='records')
        },
      ],
    "series": [
        {
          "type": 'line',
          "dataId": 'lineData',
          "xField": 'date',
          "yField": 'value',
          "seriesField": 'variable',
        },
        {
          "type": 'area',
          "dataId": 'areaData',
          "xField": 'date',
          "yField": 'value',
          "seriesField": 'variable',
        },
     ],
    
    };
    
    display(render_chart(spec))

* * *

ğŸ˜ğŸ˜ğŸ˜  
**æˆ‘ç°åœ¨æ­£åœ¨æ±‚èŒæ•°æ®ç±»å·¥ä½œ**ï¼ˆä¸»è¦æ˜¯æ•°æ®åˆ†ææˆ–æ•°æ®ç§‘å­¦ï¼‰ï¼›å¦‚æœæ‚¨æœ‰åˆé€‚çš„æœºä¼šï¼Œæ³è¯·æ‚¨ä¸æˆ‘è”ç³»ï¼Œå³æ—¶åˆ°å²—ï¼Œä¸é™åŸå¸‚ã€‚æ‚¨å¯ä»¥å‘é€ç§ä¿¡æˆ–è€…è”ç³»æˆ‘ï¼ˆå…¨ç½‘åŒåï¼šè’‹ç‚¹æ•°åˆ†ï¼‰ã€‚