---
layout: post
title: '【光照】[各向异性]在UnityURP中的实现'
date: "2025-10-04T00:36:24Z"
---
【光照】\[各向异性\]在UnityURP中的实现
=========================

![【光照】[各向异性]在UnityURP中的实现](https://img2024.cnblogs.com/blog/3685400/202510/3685400-20251004053328602-306217918.png) 《Unity URP中实现Kajiya-Kay头发渲染模型》摘要 本文详细介绍了如何在Unity URP渲染管线中实现Kajiya-Kay各向异性光照模型。该模型专为模拟头发、毛发等纤维材质设计，通过切线空间计算替代传统法线，产生条状高光效果。文章剖析了模型的双层高光特性（主高光靠近发梢、次高光带彩色偏移）和切线偏移技术，并展示了如何将其整合到URP的Cook-Torrance BRDF框架中。实现关键包括切线空间转换、高光项替换和双层高光计算，提供了完整的Shader代码框架及纹理需求、参数设置等实用细节

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

**Kajiya-Kay模型在Unity URP中的BRDF实现**

**模型原理与特点**
===========

Kajiya-Kay模型是一种专门用于模拟头发、毛发等纤维状材质各向异性高光的光照模型，其核心特点是用切线方向替代传统法线方向计算高光反射。该模型具有以下特性：

*   ‌**切线空间计算**‌：使用切线向量(Tangent)或副切线(Bitangent)替代法线向量，通过`TdotH = dot(tangent, halfVector)`计算高光强度，再转换为`TsinH = sqrt(1 - TdotH²)`实现条状高光效果。
*   ‌**双层高光特性**‌：主高光(Primary Specular)靠近发梢，次高光(Secondary Specular)靠近发根且带有彩色偏移，模拟Marschner模型的散射特性。
*   ‌**切线偏移技术**‌：通过噪声贴图扰动切线方向(ShiftTangent函数)，增强高光的动态变化和真实感。

**URP中的BRDF结构**
===============

在Unity URP中，BRDF通常基于Cook-Torrance微表面模型，包含

### 三个核心组件：

*   ‌**D项 法线分布函数**‌：描述微表面法线的分布，常用GGX模型。
*   ‌**F项 菲涅尔项**‌：使用Schlick近似计算反射光强。
*   ‌**G项 几何遮蔽项**‌：采用Smith联合阴影函数，结合光方向和视线方向的遮蔽效果。

### URP中的BRDF数据通常包含以下字段：

    csharp
    struct BRDF {
        float3 diffuse;// 材料身颜色
        float3 specular;// 材料本身的高光颜色
        float roughness;// 粗糙度
        float perceptualRoughness;// 感知粗糙度
        float fresnel;// 材料本身菲涅尔反射颜色
    }
    

**Kajiya-Kay与BRDF的整合方法**
========================

要将Kajiya-Kay模型融入URP的BRDF框架，需要进行以下

### 关键处理：

*   ‌**切线空间转换**‌：
    *   使用TBN矩阵(切线-副切线-法线矩阵)将标准BRDF计算转换到切线空间
    *   在顶点着色器中计算并传递切线空间向量
*   ‌**高光项替换**‌：
    *   用Kajiya-Kay的`D_KajiyaKay`函数替换标准BRDF中的D项
    *   保持F项和G项不变，或根据需要进行调整
*   ‌**双层高光实现**‌：
    *   主高光使用原始切线方向计算
    *   次高光使用偏移后的切线方向计算，并赋予不同颜色

**完整实现代码**
----------

以下是Kajiya-Kay BRDF在URP Shader中的完整实现框架：

    hlsl
    // 1. 计算偏移后的切线方向
    float3 ShiftTangent(float3 T, float3 N, float shift) {
        return normalize(T + N * shift);
    }
    
    // 2. Kajiya-Kay高光计算
    float D_KajiyaKay(float3 T, float3 H, float shininess) {
        float TdotH = dot(T, H);
        float sinTH = sqrt(1.0 - TdotH * TdotH);
        return pow(sinTH, shininess);
    }
    
    // 3. BRDF整合计算
    void Lighting_KajiyaKay(
        SurfaceData surface,
        inout Light light,
        inout BRDFData brdf,
        inout float3 specular)
    {
        // 切线空间转换
        float3 T = surface.tangent;
        float3 B = cross(surface.normal, T) * surface.tangent.w;
        float3 N = surface.normal;
    
        // 计算主高光
        float3 H = normalize(light.dir + viewDir);
        float3 T_shifted = ShiftTangent(T, N, _ShiftAmount1);
        float3 H_shifted = normalize(light.dir + viewDir);
    
        // 计算次高光
        float3 T_shifted2 = ShiftTangent(T, N, _ShiftAmount2);
        float3 H_shifted2 = normalize(light.dir + viewDir);
    
        // 计算高光项
        float specular1 = D_KajiyaKay(T_shifted, H_shifted, _Shininess1);
        float specular2 = D_KajiyaKay(T_shifted2, H_shifted2, _Shininess2);
    
        // 组合结果
        specular = _SpecColor1 * specular1 + _SpecColor2 * specular2;
    
        // 标准BRDF漫反射部分
        brdf.diffuse = surface.color * (1.0 - _Metallic);
        brdf.specular = lerp(0.04, surface.color, _Metallic);
        brdf.roughness = _Roughness;
    }
    

**实现要点说明**
----------

### ‌**纹理需求**‌：

*   基础色贴图(Albedo)
*   各向异性噪声贴图(控制高光扰动)
*   半透明通道(Alpha贴图)

### ‌**优化技巧**‌：

*   利用URP内置函数`SafeNormalize`和`NormalizeNormalPerPixel`提升计算稳定性
*   副切线(Bitangent)通过`cross(N, T) * tangent.w`正确生成，避免UV方向错误

### ‌**参数设置**‌：

*   `_ShiftAmount1/2`：控制主次高光的切线偏移量
*   `_Shininess1/2`：控制主次高光的锐利程度
*   `_SpecColor1/2`：设置主次高光的颜色

该实现通过将Kajiya-Kay模型的核心计算融入URP的标准BRDF框架，既保持了PBR工作流的兼容性，又实现了纤维材质特有的各向异性高光效果

* * *

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**  
> （欢迎_点赞留言_探讨，更多人加入进来能更加完善这个探索的过程，🙏）