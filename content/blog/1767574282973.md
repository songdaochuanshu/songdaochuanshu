---
layout: post
title: 'MAFå¿«é€Ÿå…¥é—¨ï¼ˆ10ï¼‰å¾ªç¯å·¥ä½œæµ'
date: "2026-01-05T00:51:22Z"
---
MAFå¿«é€Ÿå…¥é—¨ï¼ˆ10ï¼‰å¾ªç¯å·¥ä½œæµ
================

![MAFå¿«é€Ÿå…¥é—¨ï¼ˆ10ï¼‰å¾ªç¯å·¥ä½œæµ](https://img2024.cnblogs.com/blog/381412/202601/381412-20260103192858891-1281339805.png) åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾€å¾€éœ€è¦åœ¨å·¥ä½œæµä¸­è®¾ç½®ä¸€äº›å¾ªç¯ä¸è‡ªæˆ‘ä¿®æ­£çš„æœºåˆ¶ï¼Œæ„å»ºå‡ºä¸€ä¸ªâ€œç”Ÿæˆâ†’å®¡æ ¸â†’ä¿®å¤â€çš„é—­ç¯ï¼Œæ¥ç¡®ä¿AIäº§å‡ºçš„å†…å®¹èƒ½å¤Ÿæ»¡è¶³ä¼ä¸šçº§è´¨é‡æ ‡å‡†ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Edisonã€‚

æœ€è¿‘æˆ‘ä¸€ç›´åœ¨è·Ÿç€åœ£æ°çš„ã€Š[.NET+AIæ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹è¯¾ç¨‹å­¦ä¹ MAFçš„å¼€å‘æŠ€å·§ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ ä¹Ÿä¸Šè½¦è·Ÿæˆ‘ä¸€èµ·å‡ºå‘ï¼

[ä¸Šä¸€ç¯‡](https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper09)ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­å¦‚ä½•è¿›è¡Œswitch-caseç±»å‹çš„å¤šæ¡ä»¶è·¯ç”±ã€‚æœ¬ç¯‡ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹åœ¨MAFä¸­å¦‚ä½•å®ç°å¾ªç¯ï¼ˆè‡ªæˆ‘ä¿®æ­£ï¼‰å·¥ä½œæµã€‚

**1 å¾ªç¯ä¸è‡ªæˆ‘ä¿®æ­£**
=============

åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾€å¾€éœ€è¦åœ¨å·¥ä½œæµä¸­è®¾ç½®ä¸€äº›å¾ªç¯ä¸è‡ªæˆ‘ä¿®æ­£çš„æœºåˆ¶ï¼Œæ„å»ºå‡ºä¸€ä¸ªâ€œ**ç”Ÿæˆ****â†’å®¡æ ¸****â†’ä¿®å¤**â€çš„é—­ç¯ï¼Œæ¥ç¡®ä¿AIäº§å‡ºçš„å†…å®¹èƒ½å¤Ÿæ»¡è¶³ä¼ä¸šçº§è´¨é‡æ ‡å‡†ã€‚

åœ¨MAFä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Loop Edge å³ å¾ªç¯è¾¹ æ¥å®ç°è¿™ä¸ªç›®çš„ï¼Œå¦‚ä¸‹ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼š

var workflow = new WorkflowBuilder(draftExecutor)
    .AddEdge(draftExecutor, qcExecutor)
    .AddEdge(qcExecutor, draftExecutor)
    .WithOutputFrom(qcExecutor)
    .Build();

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªè¾¹å…³è”å…³ç³»ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªå¾ªç¯ã€‚

**2 å¾ªç¯å·¥ä½œæµå®éªŒæ¡ˆä¾‹**
===============

å‡è®¾æˆ‘ä»¬æ˜¯ä¸€ä¸ªç”µå•†å¹³å°çš„å®¢æœä¸­å¿ƒï¼Œæ¯å¤©éœ€è¦å¤„ç†äº§ç”Ÿçš„å¤§é‡å®¢æœå·¥å•è¿›è¡Œå›å¤ã€‚è¿™é‡Œæˆ‘ä»¬å¸Œæœ›AIåŠ©æ‰‹å…ˆå¸®æˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå›å¤è‰ç¨¿ï¼Œç„¶åç»è¿‡å¤šç»´åº¦çš„è´¨æ£€ï¼ˆç¤¼è²Œåº¦ã€å‡†ç¡®æ€§ã€åˆè§„æ€§ï¼‰ï¼Œä¸åˆæ ¼çš„åˆ™è‡ªåŠ¨è¿›è¡Œæ”¹è¿›ï¼Œç›´åˆ°æ»¡è¶³æ ‡å‡† æˆ–è€…æ˜¯ è½¬ç»™äººå·¥å¤„ç†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šé…ç½®ä¸€ä¸ªè‡ªåŠ¨è¿­ä»£çš„å¾ªç¯â€œç”Ÿæˆâ†’å®¡æ ¸â†’ä¿®å¤â€ï¼Œè¾¾æ ‡å³å¯é€€å‡ºå¾ªç¯ï¼Œå¦åˆ™è½¬äººå·¥å¤„ç†ã€‚

### **2.1 å…³é”®ä¾èµ–åŒ…å¼•å…¥**

åœ¨ä»Šå¤©çš„è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶åˆ›å»ºäº†ä¸€ä¸ª.NETæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå®‰è£…äº†ä»¥ä¸‹NuGetåŒ…ï¼š

*   Microsoft.Agents.AI.OpenAI
*   Microsoft.Agents.AI.Workflows
*   Microsoft.Extensions.AI.OpenAI

### 2.2 å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹åœ¨è¿™ä¸ªå·¥ä½œæµä¸­éœ€è¦ç”Ÿæˆä¼ é€’çš„æ•°æ®æ¨¡å‹ï¼š

ï¼ˆ1ï¼‰QualityReportDto ï¼šè´¨æ£€ç»“æœè¾“å‡ºæ¨¡å‹DTO

// è´¨æ£€ç»“æœçš„ç»“æ„åŒ–è¾“å‡ºæ¨¡å‹
internal class QualityReportDto
{
    \[JsonPropertyName("politenessScore")\]
    public int PolitenessScore { get; set; }
    \[JsonPropertyName("accuracyScore")\]
    public int AccuracyScore { get; set; }
    \[JsonPropertyName("compliancePassed")\]
    public bool CompliancePassed { get; set; }
    \[JsonPropertyName("issues")\]
    public List<QualityIssueDto> Issues { get; set; } = new();
}
internal class QualityIssueDto
{
    \[JsonPropertyName("type")\]
    public string Type { get; set; } = string.Empty;
    \[JsonPropertyName("description")\]
    public string Description { get; set; } = string.Empty;
    \[JsonPropertyName("scoreImpact")\]
    public int ScoreImpact { get; set; }
}

ï¼ˆ2ï¼‰ä¸€äº›å€¼å¯¹è±¡ï¼Œä¸èµ˜è¿°äº†

internal record ReplyDraft(
    string TicketId, 
    string Content, 
    int Attempt);
internal record TicketRequest(
    string Id, 
    string Query, 
    string Category, 
    string Priority);
internal record TicketOutcome(
    string TicketId, 
    string Status, 
    int Attempts, 
    QualityReport FinalReport);
internal sealed record QualityScoreTimelineItem(
    int Attempt,
    int PolitenessScore,
    int AccuracyScore,
    string ComplianceStatus);
internal record QualityIssue(
    string Type, 
    string Description, 
    int ScoreImpact);
internal record QualityReport(
    string TicketId, 
    int PolitenessScore, 
    int AccuracyScore, 
    bool CompliancePassed, 
    IReadOnlyList<QualityIssue> Issues);

ï¼ˆ3ï¼‰ä¸€äº›å¸¸é‡ï¼šç”¨äºå®šä¹‰ä¸€äº›é˜ˆå€¼æ ‡å‡†

public static class QualityCheckConstants
{
    // è´¨æ£€æ ‡å‡†ï¼šç¤¼è²Œåº¦ â‰¥ 85ï¼Œå‡†ç¡®æ€§ â‰¥ 90ï¼Œåˆè§„æ€§å¿…é¡» 100%
    // æ³¨æ„ï¼šé˜ˆå€¼è®¾ç½®è¾ƒé«˜ï¼Œé…åˆç¬¬ä¸€æ¬¡ç”Ÿæˆç®€åŒ–ç‰ˆæœ¬ï¼Œç¡®ä¿èƒ½ä½“ç°å¾ªç¯æ”¹è¿›è¿‡ç¨‹
    public const int PolitenessThreshold = 85;
    public const int AccuracyThreshold = 90;
}

internal enum QualityCheckSignal
{
    Init,
    Revise
}

### 2.3 å®šä¹‰è‡ªå®šä¹‰å·¥ä½œæµäº‹ä»¶

å…¶æ¬¡ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹åœ¨è¿™ä¸ªå·¥ä½œæµä¸­éœ€è¦äº§ç”Ÿçš„è‡ªå®šä¹‰äº‹ä»¶ï¼š

ï¼ˆ1ï¼‰AdaptiveQualityScoreEvent ï¼šè´¨æ£€è¯„åˆ†å·²å®Œæˆäº‹ä»¶

internal sealed class AdaptiveQualityScoreEvent : WorkflowEvent
{
    public AdaptiveQualityScoreEvent(string ticketId, 
        int attempt, 
        int politenessScore, 
        int accuracyScore, 
        bool compliancePassed)
        : base(new { TicketId = ticketId, Attempt = attempt, PolitenessScore = politenessScore, AccuracyScore = accuracyScore, CompliancePassed = compliancePassed })
    {
    }
}

ï¼ˆ2ï¼‰AdaptiveMaxAttemptsReachedEvent ï¼šè´¨æ£€è¶…è¿‡æœ€å¤§æ¬¡æ•°äº‹ä»¶

internal sealed class AdaptiveMaxAttemptsReachedEvent : WorkflowEvent
{
    public AdaptiveMaxAttemptsReachedEvent(string ticketId, int maxAttempts)
        : base(new { TicketId = ticketId, MaxAttempts = maxAttempts })
    {
    }
}

### 2.4 å®šä¹‰Agents

ï¼ˆ1ï¼‰**å›å¤ç”Ÿæˆ**ï¼šæ¨¡è¿™é‡Œé€šè¿‡æ‰§è¡Œå™¨çš„æ–¹å¼åŒ…è£¹ä¸€ä¸ªå›å¤ç”Ÿæˆçš„Agentï¼Œå‡è®¾å…¶ç”¨äºå®¢æœå·¥å•çš„è‡ªåŠ¨å›å¤ï¼š

internal sealed class AdaptiveReplyDraftExecutor : Executor<QualityCheckSignal>
{
    private readonly TicketRequest \_ticket;
    private readonly IChatClient \_chatClient;

    public AdaptiveReplyDraftExecutor(TicketRequest ticket, IChatClient chatClient) : base("AdaptiveReplyDraft")
    {
        \_ticket \= ticket;
        \_chatClient \= chatClient;
    }

    public override async ValueTask HandleAsync(QualityCheckSignal message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        int attempt = await context.ReadOrInitStateAsync("attempt", () => 0, cancellationToken);
        attempt++;
        await context.QueueStateUpdateAsync("attempt", attempt, cancellationToken);

        // ä½¿ç”¨ AI ç”Ÿæˆå®¢æœå›å¤ï¼ˆæ¸è¿›å¼ç”Ÿæˆç­–ç•¥ï¼‰
        var prompt = attempt == 1
            ? $"""
            ä½ æ˜¯ä¸€ä½ç”µå•†å®¢æœã€‚è¯·é’ˆå¯¹ä»¥ä¸‹å®¢æˆ·é—®é¢˜ç”Ÿæˆä¸€æ¡ç®€çŸ­å›å¤ï¼ˆåˆ»æ„ä¿æŒç®€çŸ­ã€ç¼ºå°‘ç¤¼è²Œç”¨è¯­ï¼‰ï¼š

            å®¢æˆ·é—®é¢˜ï¼š{\_ticket.Query}
            äº§å“ç±»åˆ«ï¼š{\_ticket.Category}

            è¦æ±‚ï¼š
            1. åªç”¨1-2å¥è¯å›ç­”ï¼Œä¸è¦ç§°å‘¼è¯­å’Œæ„Ÿè°¢è¯­
            2. åªè¯´ç»“è®ºï¼Œä¸æä¾›å…·ä½“å¤„ç†æ—¶é—´
            3. å­—æ•°æ§åˆ¶åœ¨30å­—ä»¥å†…

            ç›´æ¥è¿”å›å›å¤å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•å‰ç¼€æˆ–è¯´æ˜ã€‚
            """
            : $"""
            ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç”µå•†å®¢æœã€‚è¯·é’ˆå¯¹ä»¥ä¸‹å®¢æˆ·é—®é¢˜ç”Ÿæˆä¸€æ¡æ”¹è¿›åçš„å›å¤ï¼š

            å®¢æˆ·é—®é¢˜ï¼š{\_ticket.Query}
            äº§å“ç±»åˆ«ï¼š{\_ticket.Category}
            ä¼˜å…ˆçº§ï¼š{\_ticket.Priority}

            è¦æ±‚ï¼š
            1. è¯­æ°”äº²å’Œã€ä¸“ä¸šï¼Œä½¿ç”¨æ°å½“çš„ç§°å‘¼å’Œæ„Ÿè°¢è¯­
            2. æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆæˆ–å¤„ç†æ—¶é—´
            3. ç¬¦åˆå®¢æœè§„èŒƒï¼Œä¸åŒ…å«æ•æ„Ÿè¯
            4. å­—æ•°æ§åˆ¶åœ¨80-100å­—

            ç›´æ¥è¿”å›å›å¤å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•å‰ç¼€æˆ–è¯´æ˜ã€‚
            """;

        var response = await \_chatClient.GetResponseAsync(prompt, cancellationToken: cancellationToken);
        var content = response.Text ?? "æŠ±æ­‰ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜ã€‚";

        Console.WriteLine($"âœï¸ ç¬¬ {attempt} æ¬¡ç”Ÿæˆå›å¤è‰ç¨¿ (ç­–ç•¥: {(attempt == 1 ? "ç®€åŒ–ç‰ˆ" : "å®Œæ•´ç‰ˆ")})");
        Console.WriteLine($"ğŸ“ å›å¤å†…å®¹ï¼š{content}");

        var draft = new ReplyDraft(\_ticket.Id, content, attempt);
        await context.SendMessageAsync(draft, targetId: "AdaptiveQualityCheck", cancellationToken);
    }
}

ï¼ˆ2ï¼‰**å†…å®¹è´¨æ£€**ï¼šæ¨¡æ‹Ÿç”Ÿæˆå†…å®¹çš„è´¨æ£€è¿‡ç¨‹ï¼Œé€šè¿‡AIå¤§æ¨¡å‹å¯¹å†…å®¹è¿›è¡Œå¤šç»´åº¦çš„è´¨æ£€è¯„åˆ†ï¼Œåªæœ‰é€šè¿‡æ ‡å‡†æ‰ç®—ç»“æŸå¾ªç¯ï¼Œå¦åˆ™ç»§ç»­åé¦ˆç»™ä¸Šä¸€ä¸ªAgentè¿›è¡Œæ”¹è¿›ã€‚

NOTEï¼šåªæœ‰è´¨æ£€Agentæ‰èƒ½å†³å®šæ˜¯å¦ç»“æŸå·¥ä½œæµï¼

internal sealed class AdaptiveQualityCheckExecutor : Executor<ReplyDraft>
{
    private readonly int \_politenessThreshold;
    private readonly int \_accuracyThreshold;
    private readonly int \_maxAttempts;
    private readonly IChatClient \_chatClient;

    // é»˜è®¤æœ€å¤§å°è¯•æ¬¡æ•°ä¸º5æ¬¡
    public AdaptiveQualityCheckExecutor(int politenessThreshold, int accuracyThreshold, IChatClient chatClient)
        : this(politenessThreshold, accuracyThreshold, 5, chatClient)
    {
    }

    public AdaptiveQualityCheckExecutor(int politenessThreshold, int accuracyThreshold, int maxAttempts, IChatClient chatClient)
        : base("AdaptiveQualityCheck")
    {
        \_politenessThreshold \= politenessThreshold;
        \_accuracyThreshold \= accuracyThreshold;
        \_maxAttempts \= maxAttempts;
        \_chatClient \= chatClient;
    }

    public override async ValueTask HandleAsync(ReplyDraft draft, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        int attempt = await context.ReadOrInitStateAsync("attempt", () => 1, cancellationToken);

        // ä½¿ç”¨ AI è¿›è¡Œå¤šç»´åº¦è´¨æ£€è¯„åˆ†ï¼ˆç»“æ„åŒ–è¾“å‡ºï¼Œä¸¥æ ¼æ ‡å‡†ï¼‰
        var prompt = $"""
        ä½ æ˜¯ä¸€ä½ä¸¥æ ¼çš„å®¢æœè´¨æ£€ä¸“å®¶ã€‚è¯·å¯¹ä»¥ä¸‹å®¢æœå›å¤è¿›è¡Œå¤šç»´åº¦è¯„åˆ†ï¼ˆ0\-100åˆ†ï¼‰ï¼š

        å›å¤å†…å®¹ï¼š{draft.Content}

        è¯„åˆ†ç»´åº¦å’Œä¸¥æ ¼æ ‡å‡†ï¼š
        1. ç¤¼è²Œåº¦ï¼ˆ0\-100ï¼‰ï¼šå¿…é¡»åŒ…å«ç§°å‘¼è¯­ï¼ˆæ‚¨ã€äº²ï¼‰ã€æ„Ÿè°¢è¯­ï¼ˆæ„Ÿè°¢ã€è°¢è°¢ï¼‰ã€ç»“æŸè¯­ï¼ˆç¥ã€æœŸå¾…ï¼‰ç­‰ï¼Œè¯­æ°”äº²å’Œæ¸©æš–
           \- ç¼ºå°‘ä»»ä½•ä¸€é¡¹æ‰£20åˆ†
           \- è¯­æ°”ç”Ÿç¡¬ã€æœºæ¢°æ‰£10-30åˆ†

        2. å‡†ç¡®æ€§ï¼ˆ0\-100ï¼‰ï¼šå¿…é¡»æä¾›å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€æ˜ç¡®çš„å¤„ç†æ—¶é—´æˆ–æœ‰æ•ˆçš„åç»­æ­¥éª¤
           \- åªè¯´"ä¼šå¤„ç†"ä½†æ— å…·ä½“æ–¹æ¡ˆæ‰£30åˆ†
           \- æ— æ˜ç¡®æ—¶é—´æ‰¿è¯ºæ‰£20åˆ†
           \- ä¿¡æ¯è¿‡äºç¬¼ç»Ÿæ‰£10-20åˆ†

        3. åˆè§„æ€§ï¼ˆé€šè¿‡/ä¸é€šè¿‡ï¼‰ï¼šä¸å¾—åŒ…å«æ•æ„Ÿè¯ã€ä¸å½“è¡¨è¿°ã€æ¨è¯¿è´£ä»»çš„è¯è¯­
           \- å‘ç°ä»»ä½•æ•æ„Ÿè¯æˆ–ä¸å½“è¡¨è¿°ç›´æ¥åˆ¤å®šä¸º"ä¸é€šè¿‡"

        è¯·å¯¹æ¯ä¸ªç»´åº¦è¿›è¡Œä¸¥æ ¼è¯„åˆ†ï¼Œå¹¶åœ¨issueså­—æ®µä¸­åˆ—å‡ºæ‰€æœ‰å‘ç°çš„é—®é¢˜ã€‚
        """;

        // â­ ä½¿ç”¨ç»“æ„åŒ–è¾“å‡ºï¼šGetResponseAsync<T> è‡ªåŠ¨ç”Ÿæˆ JSON Schema å¹¶ååºåˆ—åŒ–
        var response = await \_chatClient.GetResponseAsync<QualityReportDto>(prompt, cancellationToken: cancellationToken);
        var reportDto = response.Result;

        // è½¬æ¢ä¸ºä¸šåŠ¡æ¨¡å‹
        var issues = reportDto.Issues.Select(i => new QualityIssue(i.Type, i.Description, i.ScoreImpact)).ToList();
        var report = new QualityReport(draft.TicketId, reportDto.PolitenessScore, reportDto.AccuracyScore, reportDto.CompliancePassed, issues);

        await context.AddEventAsync(new AdaptiveQualityScoreEvent(draft.TicketId, attempt, reportDto.PolitenessScore, reportDto.AccuracyScore, reportDto.CompliancePassed), cancellationToken);

        if (reportDto.PolitenessScore >= \_politenessThreshold 
            && reportDto.AccuracyScore >= \_accuracyThreshold 
            && reportDto.CompliancePassed)
        {
            await context.YieldOutputAsync(new TicketOutcome(draft.TicketId, "Approved", attempt, report), cancellationToken);
        }
        else if (attempt >= \_maxAttempts)
        {
            await context.AddEventAsync(new AdaptiveMaxAttemptsReachedEvent(draft.TicketId, \_maxAttempts), cancellationToken);
            await context.RequestHaltAsync();//è´¨æ£€å¤±è´¥ï¼šå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°
        }
        else
        {
            await context.QueueStateUpdateAsync("attempt", attempt + 1, cancellationToken);

            // å‘é€è´¨æ£€æŠ¥å‘Šåˆ°æ”¹è¿›ç¯èŠ‚
            await context.SendMessageAsync(report, targetId: "IntelligentImprove", cancellationToken);
        }
    }
}

ï¼ˆ3ï¼‰****å†…å®¹æ”¹è¿›****ï¼šæ¨¡æ‹Ÿæ”¶åˆ°è´¨æ£€çš„è¯„åˆ†åé¦ˆåå¯¹å†…å®¹è¿›è¡Œæ”¹è¿›ã€‚

internal sealed class IntelligentImproveExecutor : Executor<QualityReport>
{
    private readonly TicketRequest \_ticket;
    private readonly IChatClient \_chatClient;

    public IntelligentImproveExecutor(TicketRequest ticket, IChatClient chatClient) : base("IntelligentImprove")
    {
        \_ticket \= ticket;
        \_chatClient \= chatClient;
    }

    public override async ValueTask HandleAsync(QualityReport report, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        int attempt = await context.ReadOrInitStateAsync("attempt", () => 1, cancellationToken);

        // æ„å»ºæ”¹è¿›æç¤ºè¯ï¼ŒåŸºäºè´¨æ£€åé¦ˆ
        var issuesSummary = string.Join("\\n", report.Issues.Select(i => $"\- {i.Type}: {i.Description}"));

        var prompt = $"""
        ä½ æ˜¯ä¸€ä½å®¢æœä¼˜åŒ–ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹è´¨æ£€åé¦ˆï¼Œæ”¹è¿›å®¢æœå›å¤å†…å®¹ï¼š

        åŸå§‹é—®é¢˜ï¼š{\_ticket.Query}
        äº§å“ç±»åˆ«ï¼š{\_ticket.Category}
        ä¼˜å…ˆçº§ï¼š{\_ticket.Priority}

        å½“å‰è¯„åˆ†ï¼š
        \- ç¤¼è²Œåº¦ï¼š{report.PolitenessScore}/100 (è¦æ±‚â‰¥{QualityCheckConstants.PolitenessThreshold})
        \- å‡†ç¡®æ€§ï¼š{report.AccuracyScore}/100 (è¦æ±‚â‰¥{QualityCheckConstants.AccuracyThreshold})
        \- åˆè§„æ€§ï¼š{(report.CompliancePassed ? "é€šè¿‡" : "ä¸é€šè¿‡")}

        å‘ç°çš„é—®é¢˜ï¼š
        {issuesSummary}

        è¯·ç”Ÿæˆä¸€æ¡æ”¹è¿›åçš„å®¢æœå›å¤ï¼Œé’ˆå¯¹æ€§è§£å†³ä¸Šè¿°é—®é¢˜ï¼š
        1. å¦‚æœç¤¼è²Œåº¦ä¸è¶³ï¼Œå¢åŠ ç§°å‘¼è¯­ã€æ„Ÿè°¢è¯­ï¼Œä½¿ç”¨æ›´äº²å’Œçš„è¡¨è¿°
        2. å¦‚æœå‡†ç¡®æ€§ä¸è¶³ï¼Œè¡¥å……å…·ä½“çš„è§£å†³æ–¹æ¡ˆã€å¤„ç†æ—¶é—´ã€åç»­æ­¥éª¤
        3. å¦‚æœåˆè§„æ€§ä¸é€šè¿‡ï¼Œç§»é™¤æ•æ„Ÿè¯ï¼Œè§„èŒƒè¡¨è¿°
        4. å­—æ•°æ§åˆ¶åœ¨80-100å­—

        ç›´æ¥è¿”å›æ”¹è¿›åçš„å›å¤å†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•å‰ç¼€æˆ–è¯´æ˜ã€‚
        """;

        var response = await \_chatClient.GetResponseAsync(prompt, cancellationToken: cancellationToken);
        var improvedContent = response.Text ?? "æŠ±æ­‰ï¼Œæˆ‘ä»¬ä¼šå°½å¿«å¤„ç†æ‚¨çš„é—®é¢˜ã€‚";

        await context.AddEventAsync(new LoopProgressEvent(\_ticket.Id, attempt, 
            report.PolitenessScore, report.AccuracyScore, 
            report.CompliancePassed, "Improve"), cancellationToken);
        Console.WriteLine($"ğŸ”§ ç¬¬ {attempt} æ¬¡æ™ºèƒ½æ”¹è¿›å®Œæˆ");
        Console.WriteLine($"ğŸ“ æ”¹è¿›åå†…å®¹ï¼š{improvedContent}");

        // è§¦å‘ä¸‹ä¸€æ¬¡ç”Ÿæˆï¼ˆä½¿ç”¨æ”¹è¿›åçš„å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡ï¼‰
        await context.SendMessageAsync(QualityCheckSignal.Revise, targetId: "AdaptiveReplyDraft", cancellationToken);
    }
}

### 2.5 æ„å»ºå·¥ä½œæµ

ç°åœ¨ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸€ä¸ªWorkflowï¼Œç°åœ¨Let's do it!

**Step1: è·å–ChatClient**

var chatClient = new OpenAIClient(
        new ApiKeyCredential(openAIProvider.ApiKey),
        new OpenAIClientOptions { Endpoint = new Uri(openAIProvider.Endpoint) })
    .GetChatClient(openAIProvider.ModelId)
    .AsIChatClient();

**Step2: å®ä¾‹åŒ–è‡ªå®šä¹‰Agent & Executors**

var ticket = new TicketRequest("TKT-2025-003", "ä¼šå‘˜ç§¯åˆ†ä¸ºä»€ä¹ˆçªç„¶æ¸…é›¶äº†ï¼Ÿ", "è´¦æˆ·é—®é¢˜", "Low")
const int maxAttempts = 5;

var adaptiveDraft = new AdaptiveReplyDraftExecutor(ticket, chatClient);
var adaptiveQC = new AdaptiveQualityCheckExecutor(QualityCheckConstants.PolitenessThreshold, QualityCheckConstants.AccuracyThreshold, chatClient);
var intelligentImprove = new IntelligentImproveExecutor(ticket, chatClient);

**Step3: åˆ›å»ºå¾ªç¯è·¯ç”±å·¥ä½œæµ**

var workflow = new WorkflowBuilder(adaptiveDraft)
    .AddEdge(adaptiveDraft, adaptiveQC)
    .AddEdge(adaptiveQC, intelligentImprove)
    .AddEdge(intelligentImprove, adaptiveDraft)
    .WithOutputFrom(adaptiveQC)
    .Build();
Console.OutputEncoding \= Encoding.UTF8;
Console.WriteLine("âœ… Loop Workflow æ„å»ºå®Œæˆ");

### 2.6 æµ‹è¯•å·¥ä½œæµ

é€šè¿‡Streamingæµå¼æ‰§è¡Œï¼š

await using (var run = await InProcessExecution.StreamAsync(workflow, QualityCheckSignal.Init))
{
    var scoreTimeline = new List<object\>();
    await foreach (var evt in run.WatchStreamAsync())
    {
        // å¼ºåˆ¶ä¸­æ–­ï¼ˆæœ€å¤š5æ¬¡å°è¯•ï¼‰
        if (scoreTimeline.Count == maxAttempts)
        {
            Console.WriteLine($"â›” å¼ºåˆ¶ä¸­æ–­å·¥ä½œæµæ‰§è¡Œï¼ˆå·²å®Œæˆ{maxAttempts}æ¬¡è¯„ä¼°ï¼‰");
            break;
        }
        switch (evt)
        {
            case AdaptiveQualityScoreEvent scoreEvent:
                dynamic payload = scoreEvent.Data!;
                scoreTimeline.Add(new QualityScoreTimelineItem(
                    Attempt: (int)payload.Attempt,
                    PolitenessScore: (int)payload.PolitenessScore,
                    AccuracyScore: (int)payload.AccuracyScore,
                    ComplianceStatus: (bool)payload.CompliancePassed ? "âœ…" : "âŒ"
                ));
                var statusMessage = payload.CompliancePassed ? "é€šè¿‡" : "ä¸é€šè¿‡";
                Console.WriteLine($"ğŸ“Š AI è´¨æ£€ç»“æœ => ç¤¼è²Œåº¦:{payload.PolitenessScore} å‡†ç¡®æ€§:{payload.AccuracyScore} åˆè§„æ€§:{statusMessage}");
                break;
            case WorkflowOutputEvent outputEvent:
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
                Console.WriteLine("ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆ");
                Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n");
                Console.WriteLine($"{outputEvent.Data}");
                break;
            case WorkflowErrorEvent errorEvent:
                Console.WriteLine("âœ¨ æ”¶åˆ° Workflow Error Eventï¼š");
                Console.WriteLine($"{errorEvent.Data}");
                break;
        }
    }
}

**æµ‹è¯•ç”¨ä¾‹1**

å·¥å•å†…å®¹ï¼šè®¢å•å·²ç»3å¤©æ²¡å‘è´§ï¼Œèƒ½é€€æ¬¾å—ï¼Ÿ

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202601/381412-20260103192559594-1628756144.png)

å¯ä»¥çœ‹è§ï¼Œç»è¿‡åˆæ¬¡ç”Ÿæˆå’Œå†…å®¹æ”¹è¿›ï¼Œè¯¥å†…å®¹å›å¤å·²ç»æ»¡è¶³äº†æ ‡å‡†å¯ä»¥ç›´æ¥å›å¤ç”¨æˆ·ã€‚

**æµ‹è¯•ç”¨ä¾‹2**

å·¥å•å†…å®¹ï¼šä¼šå‘˜ç§¯åˆ†ä¸ºä»€ä¹ˆçªç„¶æ¸…é›¶äº†ï¼Ÿ

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202601/381412-20260103192630728-832060369.png)

å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡å¾ªç¯å’Œè‡ªæˆ‘ä¿®æ­£æ¨¡å¼ï¼Œå·¥ä½œæµèƒ½å¤Ÿå®ç°â€œç”Ÿæˆâ†’å®¡æ ¸â†’ä¿®å¤â€çš„å·¥ä½œæ¨¡å¼ï¼Œ**ç‰¹åˆ«é€‚ç”¨äºå†…å®¹ç”Ÿæˆå’Œå®¡æ‰¹çš„åœºæ™¯ã€‚**

3 å°ç»“
====

æœ¬æ–‡ä»‹ç»äº†MAFä¸­å¾ªç¯å·¥ä½œæµä»¥åŠå¦‚ä½•å®ç°â€œç”Ÿæˆâ†’å®¡æ ¸â†’ä¿®å¤â€çš„å·¥ä½œæ¨¡å¼ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªä¼ä¸šå®¢æœå·¥å•å†…å®¹æ™ºèƒ½å›å¤çš„æ¡ˆä¾‹ä»‹ç»äº†è¿™ç§æ¨¡å¼çš„ä»£ç å®ç°ï¼Œç‰¹åˆ«é€‚ç”¨äºå†…å®¹ç”Ÿæˆå’Œå®¡æ‰¹çš„åœºæ™¯ã€‚

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ MAFä¸­å·¥ä½œæµçš„å¹¶è¡Œå·¥ä½œæµã€‚

ç¤ºä¾‹æºç 
====

GitHub:Â [https://github.com/EdisonTalk/MAFD](https://github.com/EdisonTalk/MAFD)

å‚è€ƒèµ„æ–™
====

åœ£æ°ï¼Œã€Š[.NET + AI æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹ï¼ˆæ¨èæŒ‡æ•°ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼‰

Microsoft Learnï¼Œã€Š[Agent Framework Tutorials](https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview?wt.mc_id=MVP_397012)ã€‹

![](https://images.cnblogs.com/cnblogs_com/edisonchou/1647700/o_200902144330EdisonTalk-Footer.jpg)

ä½œè€…ï¼šçˆ±è¿ªç”Ÿ

å‡ºå¤„ï¼š[https://edisontalk.cnblogs.com](https://edisontalk.cnblogs.com "from")

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ã€‚

[![](http://service.t.sina.com.cn/widget/qmd/2068032061/d643d182/10.png)](https://weibo.com/u/2068032061?s=6uyXnP)