---
layout: post
title: 'åœ¨Linuxç³»ç»Ÿä¸Šä¸€é”®é…ç½®DoHï¼Œè§£å†³DNSè§£æžè¢«æ±¡æŸ“'
date: "2025-10-04T00:36:25Z"
---
åœ¨Linuxç³»ç»Ÿä¸Šä¸€é”®é…ç½®DoHï¼Œè§£å†³DNSè§£æžè¢«æ±¡æŸ“
===========================

å‰è¨€
--

æœ€è¿‘æˆ‘çš„ swag æœåŠ¡çªç„¶è¯ä¹¦ renew å¤±è´¥

è¯Šæ–­äº†ä¸€ä¸‹å‘çŽ°åŽŸæ¥æ˜¯æ— æ³•è§£æž `acme-v02.api.letsencrypt.org` åŸŸå

æ¢äº†å‡ ä¸ª DNS éƒ½ä¸è¡Œï¼Œåº”è¯¥æ˜¯ DNS è¢«æ±¡æŸ“æˆ–è€…åŠ«æŒäº†

è¿™æ—¶æˆ‘æ‰æ„è¯†åˆ°ä¸ä¸Š DoH/DoT æ€•æ˜¯æ²¡åŠžæ³•äº†ðŸ¤£

æœ¬æ–‡è®°å½•ä¸€ä¸‹ç”¨ä¸€ç§ç®€å•çš„æ–¹æ³•åœ¨æœåŠ¡å™¨ä¸Šå®žçŽ° DoH/DoT

DoH/DoT
-------

ç®€å•ç§‘æ™®ä¸€ä¸‹ï¼ŒDNS æ˜¯ç”¨æ¥æŠŠç½‘ç«™è§£æžåˆ°IPåœ°å€çš„åè®®

æ­£å¸¸çš„ DNS æ˜¯æ˜Žæ–‡ä¼ è¾“ï¼Œå¾ˆå®¹æ˜“è¢«æ±¡æŸ“æˆ–è€…åŠ«æŒ

DoH æ˜¯ DNS over HTTPSï¼Œèµ°åŠ å¯†çš„ HTTPS æµé‡ï¼ˆ443 ç«¯å£ï¼‰ï¼Œçœ‹èµ·æ¥å°±åƒè®¿é—®ç½‘é¡µä¸€æ ·ï¼Œä¸å®¹æ˜“è¢«æ±¡æŸ“æˆ–è€…åŠ«æŒ

é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ DoTï¼ˆDNS over TLSï¼‰ã€ODoHï¼ˆOblivious DoHï¼Œéšç§æ›´å¼ºï¼‰ï¼Œéƒ½æ˜¯æ›´åŠ å®‰å…¨çš„åŸŸåè§£æžæ–¹å¼

cloudflared
-----------

[https://github.com/cloudflare/cloudflared](https://github.com/cloudflare/cloudflared)

è¿™æ˜¯ Cloudflare å®˜æ–¹å¼€æºçš„ä¸€ä¸ª Cloudflare Tunnel å®¢æˆ·ç«¯ï¼Œç”¨ go è¯­è¨€å¼€å‘çš„ï¼Œéžå¸¸å®¹æ˜“å®‰è£…éƒ¨ç½²ã€‚

### ç®€ä»‹

è¿™ä¸ªå®¢æˆ·ç«¯ä¸ä»…å¯ä»¥æŽ¥å…¥ Tunnel å®žçŽ°å†…ç½‘ç©¿é€ï¼Œè¿˜å¯ä»¥å®žçŽ° DoH ä»£ç†

æœ¬æ–‡ä½¿ç”¨è¿™ä¸ªå·¥å…·æ¥å®žçŽ° DoH é…ç½®

### å®‰è£…

Ubuntu Server çš„å®˜æ–¹è½¯ä»¶æºæ²¡æœ‰è¿™ä¸ªå·¥å…·

éœ€è¦æ·»åŠ  Cloudflare å®˜æ–¹ APT æº

    # 1. æ·»åŠ  GPG key
    curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg > /dev/null
    
    # 2. æ·»åŠ è½¯ä»¶æº
    echo "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared jammy main" | sudo tee /etc/apt/sources.list.d/cloudflared.list
    
    # 3. æ›´æ–°å¹¶å®‰è£…
    sudo apt update
    sudo apt install cloudflared
    

ä¹Ÿå¯ä»¥ç›´æŽ¥ä¸‹è½½ DEB åŒ…å®‰è£…

    # 1. ä¸‹è½½ cloudflared æœ€æ–° deb åŒ…
    wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
    
    # 2. å®‰è£…
    sudo dpkg -i cloudflared-linux-amd64.deb
    
    # 3. éªŒè¯
    cloudflared --version
    

### æµ‹è¯•

å®‰è£…å¥½ä»¥åŽï¼Œè¿è¡Œï¼š

    sudo cloudflared proxy-dns --address 127.0.0.1 --port 5053
    

æµ‹è¯•ä¸€ä¸‹ï¼š

    dig @127.0.0.1 -p 5053 acme-v02.api.letsencrypt.org
    

å¦‚æžœèƒ½è¿”å›žè§£æžç»“æžœï¼Œå°±è¯´æ˜ŽæˆåŠŸäº†

è¿™é‡Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ Cloudflare å®˜æ–¹çš„ DoH

å¦‚æžœä¸è¡Œçš„è¯ï¼Œå¯ä»¥æ¢æˆå›½å†…çš„ DoH æœåŠ¡

æ¯”å¦‚é˜¿é‡Œï¼š

*   [https://223.5.5.5/dns-query](https://223.5.5.5/dns-query)
*   [https://223.6.6.6/dns-query](https://223.6.6.6/dns-query)

æ¯”å¦‚è…¾è®¯ï¼š

*   [https://doh.pub/dns-query](https://doh.pub/dns-query)
*   [https://dns.pub/dns-query](https://dns.pub/dns-query)

ç¤ºä¾‹

    sudo cloudflared proxy-dns --address 127.0.0.1 --port 5053 \
      --upstream https://223.5.5.5/dns-query \
      --upstream https://223.6.6.6/dns-query
    

ç”¨ dig æˆ–è€… nslookup ä¹‹ç±»çš„å·¥å…·æµ‹è¯•æ²¡é—®é¢˜çš„è¯ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥ã€‚

æ·»åŠ æœåŠ¡
----

åˆ›å»º systemd serviceï¼Œè®© cloudflared å¸¸é©»è¿è¡Œ

    sudo nano /etc/systemd/system/cloudflared-dns.service
    

å†…å®¹ï¼š

    [Unit]
    Description=Cloudflared DNS over HTTPS proxy
    After=network.target
    
    [Service]
    ExecStart=/usr/local/bin/cloudflared proxy-dns --address 127.0.0.1 --port 5053 \
      --upstream https://223.5.5.5/dns-query \
      --upstream https://223.6.6.6/dns-query \
      --upstream https://doh.pub/dns-query \
      --upstream https://dns.pub/dns-query
    Restart=always
    User=nobody
    AmbientCapabilities=CAP_NET_BIND_SERVICE
    
    [Install]
    WantedBy=multi-user.target
    

åº”ç”¨ & å¯åŠ¨

    sudo systemctl daemon-reexec
    sudo systemctl enable --now cloudflared-dns
    

é…ç½®DNS
-----

ä½¿ç”¨ drop-in é…ç½®çš„æ–¹å¼æ¥è®¾ç½® DNS

ä¸è¦ç›´æŽ¥æ”¹ `/etc/systemd/resolved.conf`

    sudo mkdir -p /etc/systemd/resolved.conf.d
    sudo nano /etc/systemd/resolved.conf.d/dns.conf
    

å†…å®¹ï¼š

    [Resolve]
    DNS=127.0.0.1:5053
    FallbackDNS=223.5.5.5 223.6.6.6
    DNSSEC=no
    

é‡å¯æœåŠ¡

    sudo systemctl restart systemd-resolved
    

æ£€æŸ¥ç”Ÿæ•ˆæƒ…å†µ

    resolvectl status
    

å¯ä»¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡º

    $ resolvectl status
    Global
               Protocols: -LLMNR -mDNS -DNSOverTLS DNSSEC=no/unsupported
        resolv.conf mode: stub
             DNS Servers: 127.0.0.1:5053
    Fallback DNS Servers: 223.5.5.5 223.6.6.6
    

è¿™æ—¶å€™å°±æžå®šäº†ï¼Œdockerå®¹å™¨ä¹Ÿä¼šé»˜è®¤ä½¿ç”¨ç³»ç»Ÿçš„è¿™ä¸ª DNS

æ­¤æ—¶å†åŽ» swag renew è¯ä¹¦ï¼Œå°±æˆåŠŸäº†âœŒï¸

ä¸€é”®è„šæœ¬
----

è€è§„çŸ©ï¼Œæˆ‘è®©å¤§æ¨¡åž‹çˆ·çˆ·å¸®å¿™å†™äº†ä¸€ä¸ªä¸€é”®é…ç½®DoHçš„è„šæœ¬

é»˜è®¤ä½¿ç”¨ä»Žå®˜æ–¹ GitHub ä»“åº“ä¸‹è½½ deb åŒ…å®‰è£…çš„æ–¹å¼

å¯ä»¥ç›´æŽ¥æ‰§è¡Œ

    bash -c "$(curl -fsSL https://gist.github.com/Deali-Axy/8b2ad8e5a601f2c43f6e7debdfb0aa29/raw/3c57dbce7dc0e224ad4ad35606f15cbc34d4810e/install-doh.sh)"
    

è„šæœ¬æºç 
----

    #!/usr/bin/env bash
    set -e
    
    echo "[1/6] å®‰è£… cloudflared..."
    if ! command -v cloudflared >/dev/null 2>&1; then
      wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -O /tmp/cloudflared.deb
      sudo dpkg -i /tmp/cloudflared.deb || sudo apt-get install -f -y
      rm -f /tmp/cloudflared.deb
    else
      echo "cloudflared å·²å®‰è£…ï¼Œè·³è¿‡ã€‚"
    fi
    
    CLOUDFLARED_BIN=$(command -v cloudflared)
    echo "cloudflared è·¯å¾„: $CLOUDFLARED_BIN"
    
    echo "[2/6] åˆ›å»º systemd service..."
    sudo tee /etc/systemd/system/cloudflared-dns.service >/dev/null <<EOF
    [Unit]
    Description=Cloudflared DNS over HTTPS proxy
    After=network.target
    
    [Service]
    ExecStart=${CLOUDFLARED_BIN} proxy-dns --address 127.0.0.1 --port 5053 \
      --upstream https://223.5.5.5/dns-query \
      --upstream https://223.6.6.6/dns-query \
      --upstream https://doh.pub/dns-query \
      --upstream https://dns.pub/dns-query
    Restart=always
    User=nobody
    AmbientCapabilities=CAP_NET_BIND_SERVICE
    
    [Install]
    WantedBy=multi-user.target
    EOF
    
    echo "[3/6] é‡æ–°åŠ è½½ systemd å¹¶å¯ç”¨æœåŠ¡..."
    sudo systemctl daemon-reexec
    sudo systemctl enable --now cloudflared-dns
    
    echo "[4/6] é…ç½® systemd-resolved..."
    sudo mkdir -p /etc/systemd/resolved.conf.d
    sudo tee /etc/systemd/resolved.conf.d/dns.conf >/dev/null <<EOF
    [Resolve]
    DNS=127.0.0.1:5053
    FallbackDNS=223.5.5.5 223.6.6.6
    DNSSEC=no
    EOF
    
    echo "[5/6] é‡å¯ systemd-resolved..."
    sudo systemctl restart systemd-resolved
    
    echo "[6/6] æ£€æŸ¥ DNS é…ç½®..."
    resolvectl status | grep "DNS Servers"
    
    echo "âœ… å®‰è£…å®Œæˆï¼çŽ°åœ¨ç³»ç»Ÿ DNS å·²ç»èµ° DoHã€‚"
    

å°†ä»¥ä¸Šä»£ç ä¿å­˜ä¸º `install-doh.sh`

è¿è¡Œ

    chmod +x install-doh.sh
    ./install-doh.sh
    

è„šæœ¬ä¼šè‡ªåŠ¨ï¼š

1.  ä¸‹è½½å¹¶å®‰è£… `cloudflared`
2.  å†™å…¥ `systemd` æœåŠ¡æ–‡ä»¶å¹¶å¯åŠ¨
3.  é…ç½® `systemd-resolved`
4.  è‡ªåŠ¨é‡å¯ç›¸å…³æœåŠ¡å¹¶æ£€æŸ¥ç”Ÿæ•ˆ

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®žéªŒå®¤ã€ ä¸“æ³¨äºŽäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æŽ¢ç´¢ä¸Žå›¢é˜Ÿæ•æ·å¼€å‘å®žè·µï¼ŒåŒ…æ‹¬æž¶æž„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸Žæ•°æ®åˆ†æžç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åŽç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿Žä¸€èµ·æŽ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®žè·µç»éªŒã€‚