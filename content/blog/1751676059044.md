---
layout: post
title: 'ã€æ·±å…¥ç†è§£ volatileã€‘å†…å­˜å¯è§æ€§ä¸ŽåŒæ­¥æœºåˆ¶è¯¦è§£'
date: "2025-07-05T00:40:59Z"
---
ã€æ·±å…¥ç†è§£ volatileã€‘å†…å­˜å¯è§æ€§ä¸ŽåŒæ­¥æœºåˆ¶è¯¦è§£
===========================

**1\. å¼•è¨€**
----------

åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œå…±äº«å˜é‡çš„å¯è§æ€§å’ŒåŒæ­¥é—®é¢˜ä¸€ç›´æ˜¯å¼€å‘è€…é¢ä¸´çš„æŒ‘æˆ˜ã€‚Java æä¾›äº† `volatile` å…³é”®å­—æ¥ç¡®ä¿å˜é‡çš„**å¯è§æ€§**å’Œ**æœ‰åºæ€§**ï¼Œä½†å®ƒå¹¶ä¸ä¿è¯**åŽŸå­æ€§**ã€‚æœ¬æ–‡å°†æ·±å…¥æŽ¢è®¨ `volatile` çš„å·¥ä½œåŽŸç†ï¼ŒåŒ…æ‹¬ï¼š

*   **é«˜é€Ÿç¼“å­˜ï¼ˆCPU Cacheï¼‰å’Œä¸»å†…å­˜ï¼ˆMain Memoryï¼‰çš„åŒæ­¥æ—¶æœº**
*   **å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰çš„ä½œç”¨**
*   **volatile çš„é€‚ç”¨åœºæ™¯ä¸Žé™åˆ¶**
*   **åº•å±‚ç¡¬ä»¶ï¼ˆå¦‚ MESI åè®®ï¼‰å¦‚ä½•æ”¯æŒ volatile è¯­ä¹‰**

æœ€åŽï¼Œæˆ‘ä»¬ä¼šé€šè¿‡ **ç¤ºä¾‹ä»£ç ** å’Œ **å†…å­˜æ¨¡åž‹å›¾ç¤º** æ¥ç›´è§‚ç†è§£ `volatile` çš„è¡Œä¸ºã€‚

* * *

**2\. volatile çš„æ ¸å¿ƒä½œç”¨**
----------------------

`volatile` ä¸»è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

1.  **å¯è§æ€§é—®é¢˜**ï¼šç¡®ä¿ä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹èƒ½ç«‹å³è¢«å…¶ä»–çº¿ç¨‹çœ‹åˆ°ã€‚
2.  **æœ‰åºæ€§é—®é¢˜**ï¼šé˜²æ­¢ JVM å’Œ CPU å¯¹æŒ‡ä»¤è¿›è¡Œä¸åˆç†çš„é‡æŽ’åºã€‚

ä½†å®ƒ **ä¸ä¿è¯åŽŸå­æ€§**ï¼ˆå¦‚ `i++` è¿™æ ·çš„å¤åˆæ“ä½œä»ç„¶éœ€è¦é¢å¤–çš„åŒæ­¥æœºåˆ¶ï¼‰ã€‚

* * *

**3\. volatile çš„åŒæ­¥æœºåˆ¶**
----------------------

### **3.1 ä½•æ—¶åŒæ­¥ï¼Ÿ**

Java å†…å­˜æ¨¡åž‹ï¼ˆJMMï¼‰è§„å®šï¼Œ`volatile` å˜é‡çš„è¯»å†™éµå¾ªä¸¥æ ¼çš„è§„åˆ™ï¼š

*   **å†™æ“ä½œï¼ˆWriteï¼‰**ï¼š
    
    *   å½“çº¿ç¨‹å†™å…¥ `volatile` å˜é‡æ—¶ï¼ŒJVM ä¼š **ç«‹å³** å°†è¯¥å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ï¼ˆè€Œä¸æ˜¯ä»…åœç•™åœ¨ CPU ç¼“å­˜ï¼‰ã€‚
    *   ä¸ºäº†ä¿è¯ç«‹å³åˆ·æ–°ï¼ŒJVM ä¼šåœ¨å†™æ“ä½œåŽæ’å…¥ **`StoreLoad` å†…å­˜å±éšœ**ï¼ˆæˆ–ç­‰æ•ˆæŒ‡ä»¤ï¼‰ï¼Œå¼ºåˆ¶ CPU å°†æ•°æ®å†™å›žä¸»å†…å­˜ï¼Œå¹¶ç¡®ä¿åŽç»­è¯»æ“ä½œèƒ½çœ‹åˆ°æœ€æ–°å€¼ã€‚
*   **è¯»æ“ä½œï¼ˆReadï¼‰**ï¼š
    
    *   å½“çº¿ç¨‹è¯»å– `volatile` å˜é‡æ—¶ï¼ŒJVM ä¼š **å¼ºåˆ¶** ä»Žä¸»å†…å­˜åŠ è½½æœ€æ–°å€¼ï¼ˆè€Œä¸æ˜¯ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æ—§å€¼ï¼‰ã€‚
    *   ä¸ºäº†ä¿è¯è¯»å–æœ€æ–°å€¼ï¼ŒJVM ä¼šåœ¨è¯»æ“ä½œå‰æ’å…¥ **`LoadLoad` + `LoadStore` å†…å­˜å±éšœ**ï¼ˆæˆ–ç­‰æ•ˆæŒ‡ä»¤ï¼‰ï¼Œä½¿å½“å‰ CPU ç¼“å­˜å¤±æ•ˆå¹¶é‡æ–°åŠ è½½æ•°æ®ã€‚

### **3.2 åŒæ­¥æµç¨‹å›¾**

    +-------------------+       +-------------------+       +-------------------+
    |   Thread 1        |       |   Main Memory     |       |   Thread 2        |
    |   (CPU Core 1)    |       |                   |       |   (CPU Core 2)    |
    +-------------------+       +-------------------+       +-------------------+
    |                   |       |                   |       |                   |
    |  volatile x = 1;  | ----> |  x = 1 (æœ€æ–°å€¼)   | <---- |  int y = x;       |
    |                   |       |                   |       |  (è¯»å–æœ€æ–°å€¼)     |
    +-------------------+       +-------------------+       +-------------------+
    

*   **Thread 1 å†™å…¥ `volatile x = 1`**ï¼š
    *   å€¼ç«‹å³å†™å…¥ä¸»å†…å­˜ï¼Œè€Œä¸æ˜¯ä»…åœç•™åœ¨ Core 1 çš„ç¼“å­˜ã€‚
*   **Thread 2 è¯»å– `volatile x`**ï¼š
    *   å¼ºåˆ¶ä»Žä¸»å†…å­˜åŠ è½½æœ€æ–°å€¼ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Core 2 ç¼“å­˜ä¸­çš„æ—§å€¼ã€‚

* * *

**4\. å†…å­˜å±éšœï¼ˆMemory Barrierï¼‰çš„ä½œç”¨**
-------------------------------

å†…å­˜å±éšœæ˜¯ CPU æˆ– JVM æ’å…¥çš„ç‰¹æ®ŠæŒ‡ä»¤ï¼Œç”¨äºŽæŽ§åˆ¶æŒ‡ä»¤æ‰§è¡Œé¡ºåºå’Œç¼“å­˜ä¸€è‡´æ€§ã€‚`volatile` ä¾èµ–å†…å­˜å±éšœå®žçŽ°å…¶è¯­ä¹‰ï¼š

**å±éšœç±»åž‹**

**ä½œç”¨**

**`StoreStore`**

ç¡®ä¿ `volatile` å†™ä¹‹å‰çš„æ™®é€šå†™æ“ä½œå…ˆå®Œæˆ

**`StoreLoad`**

ç¡®ä¿ `volatile` å†™å®ŒæˆåŽï¼ŒåŽç»­è¯»æ“ä½œèƒ½çœ‹åˆ°æœ€æ–°å€¼

**`LoadLoad`**

ç¡®ä¿ `volatile` è¯»ä¹‹å‰çš„æ™®é€šè¯»æ“ä½œå…ˆå®Œæˆ

**`LoadStore`**

ç¡®ä¿ `volatile` è¯»å®ŒæˆåŽï¼ŒåŽç»­å†™æ“ä½œä¸ä¼šé‡æŽ’åºåˆ°è¯»ä¹‹å‰

**`volatile` å†™æ“ä½œåŽçš„ `StoreLoad` å±éšœæ˜¯æœ€ä¸¥æ ¼çš„**ï¼Œå› ä¸ºå®ƒå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç¼“å­˜æ•°æ®åˆ°ä¸»å†…å­˜ï¼Œç¡®ä¿åŽç»­è¯»æ“ä½œèƒ½èŽ·å–æœ€æ–°å€¼ã€‚

* * *

**5\. åº•å±‚ç¡¬ä»¶æ”¯æŒï¼ˆMESI åè®®ï¼‰**
-----------------------

çŽ°ä»£ CPU ä½¿ç”¨ **ç¼“å­˜ä¸€è‡´æ€§åè®®**ï¼ˆå¦‚ MESIï¼‰æ¥ç»´æŠ¤å¤šæ ¸ç¼“å­˜çš„ä¸€è‡´æ€§ã€‚`volatile` çš„å†…å­˜å±éšœä¼šè§¦å‘ CPU æ‰§è¡Œå¿…è¦çš„ç¼“å­˜åŒæ­¥æ“ä½œï¼š

*   **MESI çŠ¶æ€**ï¼š
    *   **Modified (M)**ï¼šå½“å‰ CPU ç¼“å­˜çš„æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œä¸Žä¸»å†…å­˜ä¸ä¸€è‡´ã€‚
    *   **Exclusive (E)**ï¼šå½“å‰ CPU ç‹¬å ç¼“å­˜è¡Œï¼Œæ•°æ®ä¸Žä¸»å†…å­˜ä¸€è‡´ã€‚
    *   **Shared (S)**ï¼šå¤šä¸ª CPU å…±äº«ç¼“å­˜è¡Œï¼Œæ•°æ®ä¸Žä¸»å†…å­˜ä¸€è‡´ã€‚
    *   **Invalid (I)**ï¼šç¼“å­˜è¡Œæ— æ•ˆï¼Œå¿…é¡»ä»Žä¸»å†…å­˜é‡æ–°åŠ è½½ã€‚

**`volatile` å†™æ“ä½œ**ï¼š

1.  å½“å‰ CPU å°†ç¼“å­˜è¡Œæ ‡è®°ä¸º **Modified (M)**ã€‚
2.  å…¶ä»– CPU çš„ç¼“å­˜è¡Œè¢«æ ‡è®°ä¸º **Invalid (I)**ï¼Œå¼ºåˆ¶å®ƒä»¬ä¸‹æ¬¡è¯»å–æ—¶é‡æ–°åŠ è½½ã€‚

**`volatile` è¯»æ“ä½œ**ï¼š

1.  å¦‚æžœç¼“å­˜è¡ŒçŠ¶æ€ä¸º **Invalid (I)**ï¼Œåˆ™ä»Žä¸»å†…å­˜åŠ è½½æœ€æ–°å€¼ã€‚
2.  å¦åˆ™ï¼Œç›´æŽ¥ä»Žç¼“å­˜è¯»å–ï¼ˆä½† `volatile` å¼ºåˆ¶è¯»å±éšœï¼Œé€šå¸¸ä¼šä½¿ç¼“å­˜å¤±æ•ˆï¼‰ã€‚

* * *

**6\. volatile çš„é€‚ç”¨åœºæ™¯ä¸Žé™åˆ¶**
-------------------------

### **6.1 é€‚ç”¨åœºæ™¯**

*   **çŠ¶æ€æ ‡å¿—**ï¼ˆå¦‚ `boolean running`ï¼‰
    
        volatile boolean running = true;
        
        void stop() { running = false; }
        void doWork() { while (running) { ... } }
        
    
*   **å•æ¬¡å†™å…¥ã€å¤šæ¬¡è¯»å–**ï¼ˆå¦‚é…ç½®å˜é‡ï¼‰
    
        volatile Config config = loadConfig();
        
    

### **6.2 ä¸é€‚ç”¨åœºæ™¯**

*   **å¤åˆæ“ä½œï¼ˆå¦‚ `i++`ï¼‰**ï¼š
    
        volatile int count = 0;
        count++; // éžåŽŸå­æ“ä½œï¼Œä»å¯èƒ½å‘ç”Ÿç«žæ€æ¡ä»¶
        
    
    åº”æ”¹ç”¨ `AtomicInteger` æˆ– `synchronized`ã€‚

* * *

**7\. æ€»ç»“**
----------

**ç‰¹æ€§**

**volatile**

**synchronized**

**AtomicXXX**

**å¯è§æ€§**

âœ…

âœ…

âœ…

**æœ‰åºæ€§**

âœ…

âœ…

âœ…

**åŽŸå­æ€§**

âŒ

âœ…

âœ…

**é€‚ç”¨åœºæ™¯**

çŠ¶æ€æ ‡å¿—ã€å•æ¬¡å†™å…¥

å¤æ‚åŒæ­¥

è®¡æ•°å™¨ç­‰

**å…³é”®ç»“è®ºï¼š**

1.  `volatile` ä¿è¯ **å†™æ“ä½œåŽç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜**ï¼Œ**è¯»æ“ä½œå‰å¼ºåˆ¶ä»Žä¸»å†…å­˜åŠ è½½**ã€‚
2.  é€šè¿‡ **å†…å­˜å±éšœ** å®žçŽ°ï¼Œé¿å…æŒ‡ä»¤é‡æŽ’åºã€‚
3.  **ä¸ä¿è¯åŽŸå­æ€§**ï¼Œå¤åˆæ“ä½œä»éœ€é¢å¤–åŒæ­¥ã€‚
4.  åº•å±‚ä¾èµ– **MESI åè®®** ç»´æŠ¤ç¼“å­˜ä¸€è‡´æ€§ã€‚

* * *

**8\. æ‰©å±•æ€è€ƒ**
------------

*   **`volatile` vs `final`**ï¼š`final` å˜é‡åœ¨æž„é€ å‡½æ•°å®ŒæˆåŽå¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ï¼Œä½†ä¹‹åŽä¸èƒ½ä¿®æ”¹ã€‚
*   **`volatile` åœ¨å•ä¾‹æ¨¡å¼ï¼ˆDCLï¼‰ä¸­çš„åº”ç”¨**ï¼š
    
        class Singleton {
            private static volatile Singleton instance;
            
            public static Singleton getInstance() {
                if (instance == null) {
                    synchronized (Singleton.class) {
                        if (instance == null) {
                            instance = new Singleton();
                        }
                    }
                }
                return instance;
            }
        }
        
    
    è¿™é‡Œçš„ `volatile` é˜²æ­¢æŒ‡ä»¤é‡æŽ’åºï¼Œé¿å…è¿”å›žæœªåˆå§‹åŒ–çš„å¯¹è±¡ã€‚

* * *

å¸Œæœ›è¿™ç¯‡åšå®¢èƒ½å¸®åŠ©ä½ å½»åº•ç†è§£ `volatile` çš„æœºåˆ¶ï¼å¦‚æžœæœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œæ¬¢è¿Žåœ¨è¯„è®ºåŒºè®¨è®ºã€‚ðŸš€