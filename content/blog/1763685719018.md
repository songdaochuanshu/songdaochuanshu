---
layout: post
title: 'FreeSWITCH使用mod_fail2ban模块来提升安全'
date: "2025-11-21T00:41:59Z"
---
FreeSWITCH使用mod\_fail2ban模块来提升安全
================================

操作系统：Debian 12.5\_x64

FreeSWITCH版本： 1.10.11

fail2ban版本： 1.1.0

nftables版本： 1.0.6

FreeSWITCH系统部署在公网，大概率会碰到恶意注册，今天整理下debian12环境下使用mod\_fail2ban + fail2ban + nftables来提升系统安全性的笔记，并提供使用示例及相关资源下载。

相关资源可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

一、原理说明
======

这里描述下mod\_fail2ban如何使用fail2ban软件添加防护规则，实现ip地址封禁。

原理示意图如下：

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202352924-1692226446.png)

说明：

1）话机发起注册时，防火墙程序默认放行，注册请求会到达mod\_sofia模块；

2）mod\_sofia模块处理sip注册请求的过程中，会生成注册相关事件；

3）mod\_fail2ban模块监听到注册事件后，进行过滤，根据既定规则生成fail2ban.log日志；

4）fail2ban程序解析fail2ban.log日志文件，根据配置规则添加防火墙策略；

5）防火墙程序使用新规则阻挡恶意注册；

fail2ban说明可参考GitHub描述，这里就不多说了。

[https://github.com/fail2ban/fail2ban](https://github.com/fail2ban/fail2ban)

二、模块安装及配置 
==========

1、添加模块编译项
---------

文件：源码根目录的modules.conf文件

添加（或取消注释）如下代码：

event\_handlers/mod\_fail2ban

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202516086-2143229293.png)

2、编译及安装
-------

源码目录执行如下命令：

autoreconf -fiv
make clean
./devel-bootstrap.sh && ./configure && make && make install

说明：

1）会编译mod\_fail2ban模块；

2）如果配置文件没有找到，可以从源码目录复制过去；

cp src/mod/event\_handlers/mod\_fail2ban/fail2ban.conf.xml /usr/local/freeswitch/conf/autoload\_configs/

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202607966-950336929.png)

3、加载mod\_fail2ban模块
-------------------

编辑 conf/autoload\_configs/modules.conf.xml 文件，添加如下内容：

<load module="mod\_fail2ban"/>

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202641067-951237563.png)

 重启FreeSWITCH或执行重新load操作：

load mod\_fail2ban

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202749385-874866759.png)

 如果加载不报错，则添加mod\_fail2ban 模块成功。

4、配置模块
------

配置文件路径：

/usr/local/freeswitch/conf/autoload\_configs/fail2ban.conf.xml

配置文件内容如下（默认）：

<configuration name\="fail2ban.conf" description\="fail2ban log configs"\>
  <bindings\>
    <config name\="settings" desription\="configs"\>
      <param name\="logfile" value\="$${log\_dir}/fail2ban.log"/>
    </config\>
  </bindings\>
</configuration\>

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202853369-1976413305.png)

5、模块运行效果
--------

模块启动后，会自动创建日志文件，并写入相关日志。

默认日志路径：/usr/local/freeswitch/log/

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202917714-1680057335.png)

 日志效果如下：

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120202934519-737176317.png)

三、安装fail2ban软件
==============

GitHub地址：

[https://github.com/fail2ban/fail2ban](https://github.com/fail2ban/fail2ban)

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203019617-1892088714.png)

需要注意的是apt 安装的fail2ban软件版本是1.0.2，不能使用nftables，这里使用的是1.1.0版本，可从GitHub下载：

[https://github.com/fail2ban/fail2ban/releases](https://github.com/fail2ban/fail2ban/releases)

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203044107-1145610349.png)

如果下载过慢，可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

安装命令如下：

dpkg -i fail2ban\_1.1.0\-1.upstream1\_all.deb

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203133178-2142941092.png)

 配置文件目录： /etc/fail2ban

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203154212-2088307438.png)

四、使用示例
======

 这里列举下使用示例。

1、配置防火墙
-------

这里使用nftables来过滤ip地址，该软件是debian12默认安装的，如果没有安装，可用如下命令进行安装：

apt install nftables

这里使用的nftables v1.0.6版本。

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203253773-171217730.png)

2、配置fail2ban软件使用nftable
-----------------------

/etc/fail2ban/action.d目录默认有nttables的动作配置：

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203316829-110603800.png)

 /etc/fail2ban/jail.conf文件默认有freeswitch配置，默认未启用：

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203337182-44327207.png)

 为了方便演示，这里不使用默认的配置文件，修改后的 jail.conf 文件内容可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

3、添加freeswitch过滤规则
------------------

文件： filter.d/freeswitch-fail2ban.conf

文件内容可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

查看状态：

fail2ban-client status freeswitch-fail2ban

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203649680-977305126.png)

4、开启nftable服务
-------------

需要开启nftables服务：

systemctl start nftables

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203721924-694786054.png)

5、使用分机模拟注册失败
------------

分机： 1009

填写错误的注册密码，执行注册操作。

连续10次注册失败，会自动拉黑，运行效果如下：

![bbe8de9acbd811216449533c8f7d6be4](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203823142-460759768.png)

 到时间后，会自动解除：

![66df47961c65f06e728a446bb50ab8bb](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203843454-1236349094.png)

 如需提前解除黑名单，可使用如下命令：

/usr/bin/fail2ban-client set freeswitch-fail2ban unbanip 192.168.137.1

运行效果如下：

![f4a189e090a9040caa71deae2fd23548](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120203929460-1320666710.png)

该部分涉及的配置文件，可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

五、模块源码说明
========

源码目录：

src/mod/event\_handlers/mod\_fail2ban/

![ef0bce2e81ab1c6bff88507e14eeb377](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120204031131-145113491.png)

源码只有一个文件： mod\_fail2ban.c

1、函数说明
------

该模块有4个函数：

mod\_fail2ban\_do\_config ： 模块配置解析函数
fail2ban\_logger ： 生成fail2ban日志
fail2ban\_event\_handler ： 模块事件处理回调函数
mod\_fail2ban\_load  ： 模块加载函数
mod\_fail2ban\_shutdown ： 模块关闭函数 

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120204109843-583626572.png)

2、关键函数说明
--------

模块的加载、关闭及配置解析没什么说的，这里描述下该模块的fail2ban\_event\_handler函数。

关于该函数的描述，可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。 

六、资源下载
======

本文相关资源及示例配置，可从如下渠道获取：

关注微信公众号（聊聊博文，文末可扫码）后回复 20251120 获取。

![image](https://img2024.cnblogs.com/blog/300959/202511/300959-20251120204245559-145722300.png)

**【文件说明】**

fail2ban-1.1.0 : fail2ban-1.1.0源码及deb格式安装包

etc\_fail2ban.tar.gz ： /etc/fail2ban目录打包文件

fail2ban模块.drawio ： drawio格式框架图

freeswitch-fail2ban.conf ： mod\_fail2ban模块日志的过滤规则

jail.conf ： fail2ban配置

status1.sh ：fail2ban结果查看脚本

如果你对该文章有疑问，可通过微信公众号（聊聊博文）向我提问：  
[![](https://files.cnblogs.com/files/MikeZhang/201804weixingongzhong1.gif)](https://files.cnblogs.com/files/MikeZhang/201804weixingongzhong1.gif)  
转载请注明出处，谢谢！