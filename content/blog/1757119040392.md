---
layout: post
title: 'Windows集成笔设备'
date: "2025-09-06T00:37:20Z"
---
Windows集成笔设备
============

Windows集成笔设备一般是指屏（数字化仪/笔数字化转换器）和笔（笔传感器）构成的整体。屏、笔、主机之间的连接包含了屏与笔的连接、屏与主机的连接、笔与主机的连接，集成笔的主要功能由屏与笔的连接和屏与主机的连接来实现，笔与主机的连接可以实现一些可选的扩展功能。

屏与主机的连接
=======

屏通过USB或I2C或SPI（或其他能够提供兼容的HID驱动的总线），使用HID连接到主机上。

> 在微软的一些文档中，会把数字化仪（屏）和笔传感器（笔）组合在一起叫做集成笔设备。在物理层上，和主机连接的是屏（标准笔设备，不包含笔和主机的蓝牙连接）

*   Pen Reports用于实现书写和向主机传递笔的唯一标识符
*   Mouse Reports用于在Win10以前的系统上显示鼠标光标
*   Device Certification Status
*   Latency Mode用于主机通知集成笔设备何时进入高延迟（低功耗）模式

笔与主机的连接
=======

笔通过蓝牙使用HID连接到主机上，主要实现触觉反馈、提笔检测、快捷按键功能。

*   **Stylus Identifier**用来传递笔的唯一标识符。触摸屏也会给主机传递笔的唯一标识符，因此主机系统可以将笔与触摸屏的输入报告关联起来
*   **Haptic Parameters/Waveform/Configuration**用于实现触觉反馈（即某些操作会使笔身振动）
*   **Keyboard Reports**用于实现提笔检测和快捷按钮
    *   放入/取出笔槽时报告WIN+CTRL+F19/WIN+CTRL+F20的键盘组合按键
    *   单击/双击/长按快捷按钮时报告WIN+F20/WIN+F19/WIN+F18的键盘组合按键

笔与主机的蓝牙无缝配对
===========

Surface pro8和pro11的笔看标签应该是同一个型号的，两支笔在两个平板上都能自动连接（放入充电槽或者靠近屏都可以），已经有笔连接的情况下，另一支笔也可以自动连接。  
hp的笔也是mpp协议的，在surface上可以书写，但不能自动连接。  
把surface的笔放在旁边，然后用hp的笔在surface上书写，不能自动连接上surface的笔，这说明笔需要发送某些信息才能够触发自动连接。（笔靠近屏时可以通过mpp协议发送信息给屏，通过屏传递给系统，放入充电槽时怎么发送给系统？通过NFC传递给充电槽，由充电槽传递给系统？）

实现笔与系统的蓝牙无缝配对需要相关的设备实现Microsoft Bluetooth Out-of-Band集合（这是Vendor-defined类型的集合，usage\_page为0xFFF4，usage\_id为0x01）。该集合应由屏或充电槽实现。  
**Device Capability Report**用于主机向设备报告自己是否支持无缝配对，并获取设备是否支持无缝配对  
**Device Bluetooth Report**用于向主机报告笔的蓝牙参数  
**Host Bluetooth Report**用于主机向设备提供自己的蓝牙参数  
**Pairing Key Report**用于主机向指定的笔发送蓝牙配对密钥

无缝配对的一般流程：

笔与屏的连接
======

笔与屏之间没有一一对应的连接关系，只要符合约定的电气传输的协议就能够进行通信。笔输出的是经过编码的高压打码信号，触摸屏按照约定的协议对主动笔的信号进行采样和解码，得到笔尖位置、压力等信息。用于约定笔和触摸屏之间电气信号的交互流程、时序、频点等信息的就是主动笔协议（也就是说，协议没有定义触摸屏/主动笔如何跟系统交互），目前使用比较广泛的是微软主导的MPP协议和谷歌主导的USI协议。

> 笔到触摸屏的通信使用笔尖的编码脉冲，触摸屏到笔的通信使用整屏的编码脉冲

主动式电容笔和被动式电容笔的最大区别在于，主动式电容笔的内部电路会通过电极向触摸屏发送电信号，从而实现更高性能的书写。主动式电容笔并不会以无线传输的方式与触摸屏或系统进行通信。和被动式电容笔的基本原理一样，触摸屏需要通过检测它和笔尖之间的电信号来识别触摸。区别在于，使用被动式电容笔时，电信号是触摸屏-笔尖-人-地通路产生的，需要较粗的笔尖来产生电信号，而使用主动式电容笔时，电信号是笔的内部电路产生后通过笔尖电极传输到触摸屏的，笔尖可以做到很细。

MPP历史版本
=======

*   **mpp1.51**：支持单个传输电极并提供 1024 级压力灵敏度
*   **mpp2.0**：支持两个传输电极以实现倾斜功能，并将压力灵敏度提高到 2048 级
*   **mpp2.5**：支持触摸和显示驱动程序集成（TDDI）
*   **mpp2.6**：添加了蓝牙和触觉反馈功能（通过带上行的笔协议实现触觉反馈跟mpp有关，通过蓝牙实现触觉反馈跟mpp无关）

参考链接
====

[MPP\_2.0\_TC.pdf](https://gitcode.com/Open-source-documentation-tutorial/8db76/blob/main/MPP_2.0_TC.pdf)

[应用于电容笔的双协议切换方法\_参考网](https://m.fx361.cc/news/2020/0202/11592951.html)

[Windows 笔无缝配对实施指南\_ Microsoft Learn](https://learn.microsoft.com/en-us/windows-hardware/design/component-guidelines/seamless-pairing-implementation-guide)

[触觉笔实施指南\_Microsoft Learn](https://learn.microsoft.com/en-us/windows-hardware/design/component-guidelines/haptic-pen-implementation-guide)

[集成笔设备所需的 HID 顶级集合\_Microsoft Learn](https://learn.microsoft.com/en-us/windows-hardware/design/component-guidelines/required-hid-top-level-collections)