---
layout: post
title: 'MAFå¿«é€Ÿå…¥é—¨ï¼ˆ11ï¼‰å¹¶è¡Œå·¥ä½œæµ'
date: "2026-01-10T00:44:46Z"
---
MAFå¿«é€Ÿå…¥é—¨ï¼ˆ11ï¼‰å¹¶è¡Œå·¥ä½œæµ
================

![MAFå¿«é€Ÿå…¥é—¨ï¼ˆ11ï¼‰å¹¶è¡Œå·¥ä½œæµ](https://img2024.cnblogs.com/blog/381412/202601/381412-20260104201029946-1112217715.png) åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾€å¾€éœ€è¦åœ¨å·¥ä½œæµä¸­è®©å¤šä¸ªAgentåŒæ—¶è¿è¡Œå†é€šè¿‡èšåˆç»“æœåšåšä¸€äº›æ•°æ®åˆ†ææˆ–å†³ç­–å‘ˆç°ï¼Œè¿™æ—¶å°±éœ€è¦å¹¶è¡Œæ‰§è¡Œæœºåˆ¶ã€‚æœ¬æ–‡ä»‹ç»äº†MAFä¸­å¹¶è¡Œå·¥ä½œæµä»¥åŠå¦‚ä½•å®ç°â€œFan-Out/Fan-Inâ€çš„å·¥ä½œæ¨¡å¼ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªè·¨å¢ƒç”µå•†ä»·æ ¼æŸ¥è¯¢æ™ºèƒ½å®šä»·çš„æ¡ˆä¾‹ä»‹ç»äº†è¿™ç§æ¨¡å¼çš„ä»£ç å®ç°ã€‚

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Edisonã€‚

æœ€è¿‘æˆ‘ä¸€ç›´åœ¨è·Ÿç€åœ£æ°çš„ã€Š[.NET+AIæ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹è¯¾ç¨‹å­¦ä¹ MAFçš„å¼€å‘æŠ€å·§ï¼Œæˆ‘å¼ºçƒˆæ¨èä½ ä¹Ÿä¸Šè½¦è·Ÿæˆ‘ä¸€èµ·å‡ºå‘ï¼

[ä¸Šä¸€ç¯‡](https://www.cnblogs.com/edisontalk/p/-/quick-start-on-maf-chatper10)ï¼Œæˆ‘ä»¬å­¦ä¹ äº†MAFä¸­å¦‚ä½•è¿›è¡Œå¾ªç¯ï¼ˆloopï¼‰è·¯ç”±ã€‚æœ¬ç¯‡ï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹åœ¨MAFä¸­å¦‚ä½•å¹¶è¡Œæ‰§è¡Œï¼ˆfan-out/fan-inï¼‰çš„å·¥ä½œæµã€‚

**1 å¹¶è¡Œæ‰§è¡Œæ¨¡å¼**
============

åœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾€å¾€éœ€è¦åœ¨å·¥ä½œæµä¸­è®©å¤šä¸ªAgentåŒæ—¶è¿è¡Œå†é€šè¿‡èšåˆç»“æœåšåšä¸€äº›æ•°æ®åˆ†ææˆ–å†³ç­–å‘ˆç°ï¼Œè¿™æ—¶å°±éœ€è¦å¹¶è¡Œæ‰§è¡Œæœºåˆ¶ã€‚

åœ¨MAFä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Fan-Out/Fan-In æ¨¡å¼æ¥å®ç°è¿™ä¸ªç›®çš„ï¼Œå¦‚ä¸‹ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼š

var workflow = new WorkflowBuilder(startExecutor)
    .AddFanOutEdge(startExecutor, \[amazonExecutor, ebayExecutor, shopeeExecutor\])
    .AddFanInEdge(\[amazonExecutor, ebayExecutor, shopeeExecutor\], strategyExecutor)
    .WithOutputFrom(strategyExecutor)
    .Build();

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡MAFçš„ AddFanOutEdge å’Œ AddFanInEdge æ¥å®ç°äº†å¹¶è¡Œæ‰§è¡Œçš„ç›®çš„ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªè‡ªå®šä¹‰çš„æ‰§è¡Œå™¨æ¥åšèšåˆã€‚

æ ¸å¿ƒæ¦‚å¿µè¡¥å……ï¼š

*   Fan-Out Edge => å¹¶å‘æ‰§è¡Œè¾¹
*   Fan-In Edge => æ±‡èšè¾¹

**2 å¹¶è¡Œå·¥ä½œæµå®éªŒæ¡ˆä¾‹**
===============

å‡è®¾æˆ‘ä»¬æ˜¯ä¸€ä¸ªè·¨å¢ƒç”µå•†å›¢é˜Ÿï¼Œæƒ³è¦å®æ—¶ç›‘æ§åŒä¸€ä¸ªå•†å“åœ¨å¤šä¸ªç”µå•†å¹³å°ï¼ˆå¦‚äºšé©¬é€Šã€eBayã€Shopeeç­‰ï¼‰çš„å®šä»·ç­–ç•¥ï¼Œåœ¨æ£€æµ‹åˆ°ç«äº‰å¯¹æ‰‹é™ä»·æ—¶å¿«é€Ÿåšå‡ºå“åº”å†³ç­–ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ï¼šé…ç½®ä¸€ä¸ªÂ Fan-Out + Fan-InÂ å·¥ä½œæµï¼Œå®ç°ä¸€æ¬¡æŸ¥è¯¢ã€å¹¶è¡ŒæŠ“å–ã€æ™ºèƒ½å†³ç­–çš„ä¼ä¸šçº§æ¨¡å¼ã€‚

### **2.1 å…³é”®ä¾èµ–åŒ…å¼•å…¥**

åœ¨ä»Šå¤©çš„è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä»ç„¶åˆ›å»ºäº†ä¸€ä¸ª.NETæ§åˆ¶å°åº”ç”¨ç¨‹åºï¼Œå®‰è£…äº†ä»¥ä¸‹NuGetåŒ…ï¼š

*   Microsoft.Agents.AI.OpenAI
*   Microsoft.Agents.AI.Workflows
*   Microsoft.Extensions.AI.OpenAI

### 2.2 å®šä¹‰æ•°æ®ä¼ è¾“æ¨¡å‹

é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸‹åœ¨è¿™ä¸ªå·¥ä½œæµä¸­éœ€è¦ç”Ÿæˆä¼ é€’çš„æ•°æ®æ¨¡å‹ï¼š

PriceQueryDto ï¼šä»·æ ¼æŸ¥è¯¢æ¨¡å‹DTO

internal class PriceQueryDto
{
    public string ProductId { get; private set; }
    public string ProductName { get; private set; }
    public string TargetRegion { get; private set; }
    public PriceQueryDto(string productId, string productName, string targetRegion)
    {
        ProductId \= productId;
        ProductName \= productName;
        TargetRegion \= targetRegion;
    }
}

### 2.3 å®šä¹‰Agents&Executors

**ï¼ˆ1ï¼‰ä»·æ ¼æŸ¥è¯¢ï¼š**å°è£…å„å¤§ç”µå•†å¹³å°çš„ä»·æ ¼æŸ¥è¯¢é€»è¾‘ï¼Œæ¨¡æ‹Ÿå…¶APIå“åº”ï¼Œä»…ä»…åšæ¼”ç¤ºç”¨æ— å®é™…é€»è¾‘ï¼š

internal sealed class PlatformPriceExecutor : Executor<ChatMessage>
{
    private readonly string \_instructions;
    private readonly IChatClient \_chatClient;

    public PlatformPriceExecutor(string id, IChatClient chatClient, string platformInstructions)
        : base(id)
    {
        \_chatClient \= chatClient;
        \_instructions \= platformInstructions;
    }

    public override async ValueTask HandleAsync(ChatMessage message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        var messages = new List<ChatMessage>
        {
            new(ChatRole.System, \_instructions),
            message
        };

        var response = await \_chatClient.GetResponseAsync(messages, cancellationToken: cancellationToken);
        var replyMessage = new ChatMessage(ChatRole.Assistant, response.Text ?? string.Empty)
        {
            AuthorName \= this.Id
        };

        await context.SendMessageAsync(replyMessage, cancellationToken: cancellationToken);
        Console.WriteLine($"âœ… {this.Id} å®ŒæˆæŸ¥è¯¢");
    }
}

**ï¼ˆ2ï¼‰å¹¿æ’­æŸ¥è¯¢è¯·æ±‚æ‰§è¡Œå™¨ï¼š**è´Ÿè´£å¹¿æ’­ä»·æ ¼æŸ¥è¯¢è¯·æ±‚åˆ°å„å¤§ç”µå•†å¹³å°å¹¶å‘æ”¾TurnTokenã€‚

NOTEï¼šåªæœ‰å‘æ”¾äº†TurnTokenæ‰èƒ½çœŸæ­£å¼€å¯æ‰§è¡Œåç»­LLMèŠ‚ç‚¹ï¼

internal sealed class PriceQueryStartExecutor() : Executor<PriceQueryDto>(nameof(PriceQueryStartExecutor))
{
    public override async ValueTask HandleAsync(PriceQueryDto query, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        var userPrompt = $@"å•†å“ID: {query.ProductId}
å•†å“åç§°: {query.ProductName}
ç›®æ ‡åŒºåŸŸ: {query.TargetRegion}

è¯·æŸ¥è¯¢è¯¥å•†å“åœ¨ä½ çš„å¹³å°ä¸Šçš„å½“å‰ä»·æ ¼ã€åº“å­˜çŠ¶æ€å’Œé…é€ä¿¡æ¯ã€‚";
        await context.SendMessageAsync(new ChatMessage(ChatRole.User, userPrompt), cancellationToken: cancellationToken);
        await context.SendMessageAsync(new TurnToken(emitEvents: true), cancellationToken: cancellationToken);

        Console.WriteLine("ğŸ“¡ Fan-out ä»·æ ¼æŸ¥è¯¢å¹¿æ’­å·²å‘é€");
    }
}

****ï¼ˆ3ï¼‰å®šä»·èšåˆï¼š****æ¨¡æ‹Ÿæ”¶é›†åˆ°æ‰€æœ‰å¹³å°çš„å®šä»·ä¹‹åæ‰§è¡Œçš„æ•°æ®èšåˆæ“ä½œã€‚

internal sealed class PricingStrategyExecutor : Executor<ChatMessage>
{
    private readonly List<ChatMessage> \_messages = \[\];
    private readonly int \_targetCount;

    public PricingStrategyExecutor(int targetCount) : base(nameof(PricingStrategyExecutor))
    {
        \_targetCount \= targetCount;
    }

    public override async ValueTask HandleAsync(ChatMessage message, IWorkflowContext context, CancellationToken cancellationToken = default)
    {
        this.\_messages.Add(message);
        Console.WriteLine($"ğŸ“Š å·²æ”¶é›† {\_messages.Count}/{\_targetCount} ä¸ªå¹³å°æ•°æ® - æ¥è‡ª {message.AuthorName}");

        if (this.\_messages.Count == this.\_targetCount)
        {
            var platformData = string.Join("\\n", this.\_messages.Select(m => $"â€¢ {m.AuthorName}: {m.Text}"));
            var strategyReport = $@"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š å¤šå¹³å°ä»·æ ¼æ±‡æ€»ï¼ˆå…± {this.\_messages.Count} ä¸ªå¹³å°ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{platformData}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ æ™ºèƒ½å®šä»·å»ºè®®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åŸºäºä»¥ä¸Šæ•°æ®ï¼Œå»ºè®®åˆ†æç«äº‰å¯¹æ‰‹ä»·æ ¼åŒºé—´ï¼Œåˆ¶å®šå·®å¼‚åŒ–å®šä»·ç­–ç•¥ã€‚
è€ƒè™‘å› ç´ ï¼šåº“å­˜å‹åŠ›ã€é…é€æˆæœ¬ã€å¹³å°ä½£é‡‘ç‡ã€ç›®æ ‡åˆ©æ¶¦ç‡ã€‚";

            await context.YieldOutputAsync(strategyReport, cancellationToken);

            Console.WriteLine("âœ¨ Fan-in å®šä»·ç­–ç•¥ç”Ÿæˆå®Œæˆ");
        }
    }
}

### 2.4 æ„å»ºå·¥ä½œæµ

ç°åœ¨ä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ ä¸€ä¸ªWorkflowï¼Œç°åœ¨Let's do it!

Step1: è·å–ChatClient

var chatClient = new OpenAIClient(
        new ApiKeyCredential(openAIProvider.ApiKey),
        new OpenAIClientOptions { Endpoint = new Uri(openAIProvider.Endpoint) })
    .GetChatClient(openAIProvider.ModelId)
    .AsIChatClient();

Step2: å®ä¾‹åŒ–è‡ªå®šä¹‰Agent & Executors

var amazonExecutor = new PlatformPriceExecutor(
    "AmazonPriceAgent",
    chatClient,
    "ä½ æ˜¯Amazonå¹³å°ä»·æ ¼æŸ¥è¯¢Agentã€‚è¿”å›æ ¼å¼ï¼šä»·æ ¼=$XXXï¼Œåº“å­˜çŠ¶æ€=å……è¶³/ç´§å¼ ï¼Œé…é€è¯´æ˜=Primeä¼šå‘˜å…è¿è´¹/æ ‡å‡†é…é€ã€‚"
);
var ebayExecutor = new PlatformPriceExecutor(
    "eBayPriceAgent",
    chatClient,
    "ä½ æ˜¯eBayå¹³å°ä»·æ ¼æŸ¥è¯¢Agentã€‚è¿”å›æ ¼å¼ï¼šä»·æ ¼=$XXXï¼Œå•†å“çŠ¶æ€=å…¨æ–°/äºŒæ‰‹XXæ–°ï¼Œè¿è´¹è¯´æ˜=åŒ…é‚®/ä¹°å®¶æ‰¿æ‹…ã€‚"
);
var shopeeExecutor = new PlatformPriceExecutor(
    "ShopeePriceAgent",
    chatClient,
    "ä½ æ˜¯Shopeeå¹³å°ä»·æ ¼æŸ¥è¯¢Agentã€‚è¿”å›æ ¼å¼ï¼šä»·æ ¼=$XXXï¼ˆå«ç¨ï¼‰ï¼ŒåŒºåŸŸ=ä¸œå—äºš/å°æ¹¾ï¼Œä¿ƒé”€ä¿¡æ¯=æ»¡å‡æ´»åŠ¨/æ— ã€‚"
);
var startExecutor = new PriceQueryStartExecutor();
var strategyExecutor = new PricingStrategyExecutor(3);

Step3: åˆ›å»ºå¹¶è¡Œæ‰§è¡Œå·¥ä½œæµ

var workflow = new WorkflowBuilder(startExecutor)
        .AddFanOutEdge(startExecutor, \[amazonExecutor, ebayExecutor, shopeeExecutor\])
        .AddFanInEdge(\[amazonExecutor, ebayExecutor, shopeeExecutor\], strategyExecutor)
        .WithOutputFrom(strategyExecutor)
        .Build();
Console.OutputEncoding \= Encoding.UTF8;
Console.WriteLine("âœ… Loop Workflow æ„å»ºå®Œæˆ");

### 2.5 æµ‹è¯•å·¥ä½œæµ

å®šä¹‰æŸ¥è¯¢çš„å•†å“æ˜¯IPhone15ï¼š

var priceQuery = new PriceQueryDto(
    productId: "IPHONE15-PRO-256",
    productName: "iPhone 15 Pro 256GB",
    targetRegion: "US"
);

é€šè¿‡Streamingæµå¼æ‰§è¡Œï¼š

await using (var run = await InProcessExecution.StreamAsync(workflow, priceQuery))
{
    await foreach (var evt in run.WatchStreamAsync())
    {
        switch (evt)
        {
            case ExecutorInvokedEvent started:
                Console.WriteLine($"ğŸš€ {started.ExecutorId} å¼€å§‹è¿è¡Œ");
                break;
            case ExecutorCompletedEvent completed:
                Console.WriteLine($"âœ… {completed.ExecutorId} ç»“æŸè¿è¡Œ");
                break;
            case WorkflowOutputEvent outputEvent:
                Console.WriteLine("ğŸ‰ Fan-in æ±‡æ€»è¾“å‡ºï¼š");
                Console.WriteLine($"{outputEvent.Data}");
                break;
            case WorkflowErrorEvent errorEvent:
                Console.WriteLine("âœ¨ æ”¶åˆ° Workflow Error Eventï¼š");
                Console.WriteLine($"{errorEvent.Data}");
                break;
        }
    }
}

æµ‹è¯•ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image](https://img2024.cnblogs.com/blog/381412/202601/381412-20260104200929287-1279437489.png)

å¯ä»¥çœ‹è§ï¼Œç»è¿‡å¹¶è¡Œæ‰§è¡Œä»·æ ¼æŸ¥è¯¢åï¼Œç”±èšåˆæ‰§è¡Œå™¨è¿›è¡Œäº†ä»·æ ¼æ±‡æ€»å¹¶å‘é€ç»™LLMè¿›è¡Œäº†æœ€ç»ˆçš„å®šä»·å»ºè®®ã€‚

**3 å°ç»“**
========

æœ¬æ–‡ä»‹ç»äº†MAFä¸­å¹¶è¡Œå·¥ä½œæµä»¥åŠå¦‚ä½•å®ç°â€œFan-Out/Fan-Inâ€çš„å·¥ä½œæ¨¡å¼ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªè·¨å¢ƒç”µå•†ä»·æ ¼æŸ¥è¯¢æ™ºèƒ½å®šä»·çš„æ¡ˆä¾‹ä»‹ç»äº†è¿™ç§æ¨¡å¼çš„ä»£ç å®ç°ã€‚

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†ç»§ç»­å­¦ä¹ MAFä¸­å·¥ä½œæµçš„å¤šé€‰è·¯ç”±å·¥ä½œæµã€‚

ç¤ºä¾‹æºç 
====

GitHub:Â [https://github.com/EdisonTalk/MAFD](https://github.com/EdisonTalk/MAFD)

å‚è€ƒèµ„æ–™
====

åœ£æ°ï¼Œã€Š[.NET + AI æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶](https://www.cnblogs.com/sheng-jie/p/19200934)ã€‹ï¼ˆæ¨èæŒ‡æ•°ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼‰

Microsoft Learnï¼Œã€Š[Agent Framework Tutorials](https://learn.microsoft.com/en-us/agent-framework/overview/agent-framework-overview?wt.mc_id=MVP_397012)ã€‹

![](https://images.cnblogs.com/cnblogs_com/edisonchou/1647700/o_200902144330EdisonTalk-Footer.jpg)

ä½œè€…ï¼šçˆ±è¿ªç”Ÿ

å‡ºå¤„ï¼š[https://edisontalk.cnblogs.com](https://edisontalk.cnblogs.com "from")

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ã€‚

[![](http://service.t.sina.com.cn/widget/qmd/2068032061/d643d182/10.png)](https://weibo.com/u/2068032061?s=6uyXnP)