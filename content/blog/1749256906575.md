---
layout: post
title: '2. LangChain4j-AIServicesï¼ŒåŸæ¥è°ƒç”¨AIè¿™ä¹ˆç®€å•ï¼Ÿ'
date: "2025-06-07T00:41:46Z"
---
2\. LangChain4j-AIServicesï¼ŒåŸæ¥è°ƒç”¨AIè¿™ä¹ˆç®€å•ï¼Ÿ
======================================

1\. ç®€ä»‹
------

ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬è®²äº†å¦‚ä½•ä½¿ç”¨`LangChain4J`çš„åº•å±‚ç»„ä»¶æ¥è¿›è¡ŒAIçš„äº¤äº’ï¼Œå¦‚ `ChatLanguageModel`ã€`ChatMessage`ã€`ChatMemory` ç­‰ã€‚ åœ¨è¿™ä¸ªå±‚é¢ä¸Šå·¥ä½œéå¸¸çµæ´»/è‡ªç”±ï¼Œä½†ä¹Ÿè¿«ä½¿æˆ‘ä»¬ç¼–å†™å¤§é‡çš„æ ·æ¿ä»£ç ã€‚ ç”±äº LLM é©±åŠ¨çš„åº”ç”¨ç¨‹åºé€šå¸¸ä¸ä»…éœ€è¦å•ä¸ªç»„ä»¶ï¼Œè¿˜éœ€è¦å¤šä¸ªç»„ä»¶ååŒå·¥ä½œ ï¼ˆä¾‹å¦‚ï¼Œæç¤ºæ¨¡æ¿ã€èŠå¤©è®°å¿†ã€LLMã€è¾“å‡ºè§£æå™¨ã€RAG ç»„ä»¶ï¼šåµŒå…¥æ¨¡å‹å’Œå­˜å‚¨ï¼‰ å¹¶ä¸”ç»å¸¸æ¶‰åŠå¤šæ¬¡äº¤äº’ï¼Œåè°ƒæ‰€æœ‰è¿™äº›ç»„ä»¶å˜å¾—æ›´åŠ ç¹çã€‚

è€Œæˆ‘ä»¬ä½¿ç”¨æ¡†æ¶çš„ç›®çš„æ˜¯å¸Œæœ›ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯ä½çº§å®ç°ç»†èŠ‚ã€‚ ä¸ºæ­¤ï¼Œ`LangChain4J`è¡ç”Ÿå‡ºä¸€ä¸ªé«˜çº§æ¦‚å¿µå¯ä»¥å¸®åŠ©æ›´å¿«çš„è¿›è¡ŒAIåº”ç”¨çš„å¼€å‘ï¼š`AI Services`ã€‚

2\. ç¯å¢ƒä¿¡æ¯
--------

æœ¬ç« çš„ç¯å¢ƒä¿¡æ¯è·Ÿä¸Šä¸€ç« å®Œå…¨ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šå±•ç¤ºäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹[ä¸Šä¸€ç« å†…å®¹](https://www.cnblogs.com/ludangxin/p/18913321)

3\. æ„å»ºAI Service
----------------

### 3.1 ç”³æ˜AI Service æ¥å£

    package com.ldx.langchaintest.aisvc;
    
    import com.ldx.langchaintest.model.PersonTest;
    import dev.langchain4j.service.Result;
    import dev.langchain4j.service.SystemMessage;
    import dev.langchain4j.service.TokenStream;
    import dev.langchain4j.service.UserMessage;
    import dev.langchain4j.service.V;
    import reactor.core.publisher.Flux;
    
    import java.util.List;
    
    /**
     * ai svc
     *
     * @author ludangxin
     * @date 2025/6/5
     */
    public interface AiAssistantServiceTest {
        String chat(String message);
    
        TokenStream chatWithTokenStream(String message);
    
        Flux<String> chatWithFlux(String message);
    
        @SystemMessage("""
                    ğŸ‘‰ å°†æ–‡æœ¬æ”¹å†™æˆç±»ä¼¼å°çº¢ä¹¦çš„ Emoji é£æ ¼ã€‚
                    è¯·ä½¿ç”¨ Emoji é£æ ¼ç¼–è¾‘ä»¥ä¸‹æ®µè½ï¼Œè¯¥é£æ ¼ä»¥å¼•äººå…¥èƒœçš„æ ‡é¢˜ã€æ¯ä¸ªæ®µè½ä¸­åŒ…å«è¡¨æƒ…ç¬¦å·å’Œåœ¨æœ«å°¾æ·»åŠ ç›¸å…³æ ‡ç­¾ä¸ºç‰¹ç‚¹ã€‚è¯·ç¡®ä¿ä¿æŒåŸæ–‡çš„æ„æ€ã€‚
                    """)
        String chatWithSysPrompt(String userMessage);
    
        @UserMessage("è¯·å¸®æˆ‘åˆ¤æ–­ä¸€ä¸‹è¿™æ®µè¡¨è¾¾å¼ã€Œ{{expression}}ã€çš„è¿”å›å€¼ å¦‚æœæˆç«‹åˆ™è¿”å›true åä¹‹ false")
        boolean chatWithPrompt(@V("expression") String expression);
    
        @UserMessage("éœ€è¦ä½ å¸®æˆ‘mockéœ€è¦çš„äººå‘˜ä¿¡æ¯")
        PersonTest chatWithPojo();
    
        @UserMessage("éœ€è¦ä½ å¸®æˆ‘mockäººå‘˜å§“å, å¸®æˆ‘ç”Ÿæˆ{{total}}ä¸ª")
        List<String> chatWithList(@V("total") Integer total);
    
        Result<String> chatWithMeta(String question);
    
        // can not support return list pojo
        @UserMessage("éœ€è¦ä½ å¸®æˆ‘mockéœ€è¦çš„äººå‘˜ä¿¡æ¯, å¸®æˆ‘ç”Ÿæˆ{{total}}ä¸ª")
        List<PersonTest> chatWithPojoList(@V("total") Integer total);
    }
    

å…³äºèŠå¤©è®°å¿†çš„svc

    package com.ldx.langchaintest.aisvc;
    
    import dev.langchain4j.service.MemoryId;
    import dev.langchain4j.service.SystemMessage;
    import dev.langchain4j.service.UserMessage;
    
    /**
     * memory svc
     *
     * @author ludangxin
     * @date 2025/6/5
     */
    public interface AiAssistantServiceWithMemoryTest {
        String chat(@MemoryId String memoryId, @UserMessage String message);
    }
    

### 3.2 åˆ›å»ºAI Service å®ä¾‹

> ä½¿ç”¨AiServiceså¯¹è±¡åˆ›å»ºä¸Šè¿°æˆ‘ä»¬è‡ªå®šä¹‰çš„svcï¼Œå…¶åº•å±‚æ˜¯é€šè¿‡jdkçš„åŠ¨æ€ä»£ç†å®ç°çš„ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç•™è¨€ï¼Œåç»­å¯ä»¥åŠ ä¸€ç« æºç è§£æ

    private static ChatModel chatModel;
    
    private static StreamingChatModel streamingChatModel;
    
    private static AiAssistantServiceTest assistant;
    
    private static AiAssistantServiceTest streamingAssistant;
    
    @BeforeAll
    public static void init_chat_svc() {
        chatModel = OpenAiChatModel
                .builder()
                .apiKey(System.getenv("LLM_API_KEY"))
                .modelName("qwen-plus")
                .baseUrl("https://dashscope.aliyuncs.com/compatible-mode/v1")
                .build();
        streamingChatModel = OpenAiStreamingChatModel
                .builder()
                .apiKey(System.getenv("LLM_API_KEY"))
                .modelName("qwen-plus")
                .baseUrl("https://dashscope.aliyuncs.com/compatible-mode/v1")
                .build();
        // åˆ›å»ºæ™®é€šå¯¹è¯çš„ai svc
        assistant = AiServices.create(AiAssistantServiceTest.class, chatModel);
        // åˆ›å»ºæµå¼å¯¹è¯çš„ai svc
        streamingAssistant = AiServices.create(AiAssistantServiceTest.class, streamingChatModel);
    }
    

4\. è¿”å›å­—ç¬¦ä¸²
---------

    @Test
    public void should_return_str_when_use_normal_chat() {
        final String q = "ä½ æ˜¯è°";
        final String a = assistant.chat(q);
        log.info("call ai q:{}\na:{}", q, a);
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹

    23:56:02.143 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai q:ä½ æ˜¯è°
    a:æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œé˜¿é‡Œå·´å·´é›†å›¢æ——ä¸‹çš„é€šä¹‰å®éªŒå®¤è‡ªä¸»ç ”å‘çš„è¶…å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ã€‚æˆ‘èƒ½å¤Ÿå›ç­”é—®é¢˜ã€åˆ›ä½œæ–‡å­—ï¼Œæ¯”å¦‚å†™æ•…äº‹ã€å†™å…¬æ–‡ã€å†™é‚®ä»¶ã€å†™å‰§æœ¬ã€é€»è¾‘æ¨ç†ã€ç¼–ç¨‹ç­‰ç­‰ï¼Œè¿˜èƒ½è¡¨è¾¾è§‚ç‚¹ï¼Œç©æ¸¸æˆç­‰ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œæ¬¢è¿éšæ—¶å‘Šè¯‰æˆ‘ï¼
    

5\. è¿”å›æµ
-------

### 5.1 TokenStream

    @Test
    public void should_return_stream_when_use_stream_model() throws InterruptedException {
        final TokenStream tokenStream = streamingAssistant.chatWithTokenStream("ä½ æ˜¯è°");
        tokenStream
            .onPartialResponse((String partial) -> log.info("ai response partial data: {}", partial))
            .onCompleteResponse((ChatResponse chatResponse) -> log.info("ai response complete."))
            .onError((Throwable error) -> log.info("ai call error", error))
            .start();
        // é˜»å¡ ä¿è¯å¼‚æ­¥ç»“æœæ­£å¸¸å±•ç¤º
        Thread.sleep(10_000);
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

    23:57:54.639 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æˆ‘æ˜¯
    23:57:54.641 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: é€š
    23:57:54.657 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ä¹‰
    23:57:54.800 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: åƒé—®ï¼Œé˜¿é‡Œå·´å·´
    23:57:54.916 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: é›†å›¢æ——ä¸‹çš„é€šä¹‰
    23:57:55.036 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å®éªŒå®¤è‡ªä¸»ç ”å‘çš„è¶…
    23:57:55.287 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ã€‚
    23:57:55.700 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æˆ‘èƒ½å¤Ÿå›ç­”é—®é¢˜
    23:57:55.810 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ã€åˆ›ä½œæ–‡å­—ï¼Œ
    23:57:56.003 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æ¯”å¦‚å†™æ•…äº‹ã€
    23:57:56.112 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å†™å…¬æ–‡ã€
    23:57:56.255 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å†™é‚®ä»¶ã€å†™
    23:57:56.447 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å‰§æœ¬ã€é€»è¾‘æ¨ç†
    23:57:56.537 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ã€ç¼–ç¨‹ç­‰ç­‰ï¼Œ
    23:57:56.672 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: è¿˜èƒ½è¡¨è¾¾è§‚ç‚¹ï¼Œ
    23:57:56.873 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ç©æ¸¸æˆç­‰ã€‚å¦‚æœä½ 
    23:57:56.939 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦
    23:57:57.079 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å¸®åŠ©ï¼Œæ¬¢è¿éšæ—¶
    23:57:57.214 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å‘Šè¯‰æˆ‘ï¼
    23:57:57.262 [ForkJoinPool.commonPool-worker-1] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response complete.
    

### 5.2 Flux

    @Test
    public void should_return_stream_when_use_stream_model2() {
        final Flux<String> flux = streamingAssistant.chatWithFlux("ä½ æ˜¯è°");
        flux
                .toStream()
                .forEach(partial -> log.info("ai response partial data: {}", partial));
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹:

    00:00:04.753 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æˆ‘æ˜¯
    00:00:04.755 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: é€š
    00:00:04.755 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ä¹‰
    00:00:04.866 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: åƒé—®ï¼Œé˜¿é‡Œå·´å·´
    00:00:05.028 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: é›†å›¢æ——ä¸‹çš„é€šä¹‰
    00:00:05.165 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å®éªŒå®¤è‡ªä¸»ç ”å‘çš„è¶…
    00:00:05.248 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ã€‚
    00:00:05.426 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æˆ‘èƒ½å¤Ÿå›ç­”é—®é¢˜
    00:00:05.516 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ã€åˆ›ä½œæ–‡å­—ï¼Œ
    00:00:05.663 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æ¯”å¦‚å†™æ•…äº‹ã€
    00:00:05.815 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å†™å…¬æ–‡ã€
    00:00:05.920 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å†™é‚®ä»¶ã€å†™
    00:00:06.040 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å‰§æœ¬ã€é€»è¾‘æ¨ç†
    00:00:06.200 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ã€ç¼–ç¨‹ç­‰ç­‰ï¼Œ
    00:00:06.290 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: è¿˜èƒ½è¡¨è¾¾è§‚ç‚¹ï¼Œ
    00:00:06.424 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: ç©æ¸¸æˆç­‰ã€‚å¦‚æœä½ 
    00:00:06.579 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦
    00:00:06.685 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å¸®åŠ©ï¼Œæ¬¢è¿éšæ—¶
    00:00:06.781 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ai response partial data: å‘Šè¯‰æˆ‘ï¼
    

6\. æç¤ºè¯/æ¨¡æ¿
----------

    @Test
    public void should_return_prompt_content_when_use_prompt() {
        final String q1 = "ä½ æ˜¯è°";
        final String a1 = assistant.chatWithSysPrompt(q1);
        log.info("call ai q1:{}\na1:{}", q1, a1);
        final String q2 = "1+2=4";
        final boolean a2 = assistant.chatWithPrompt(q2);
        log.info("call ai q2:{}\na2:{}", q2, a2);
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

    00:01:37.390 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai q1:ä½ æ˜¯è°
    a1:âœ¨ä½ å¥½å‘€ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ğŸ’¡ï¼Œåœ¨è¿™é‡Œå¯ä»¥å¸®ä½ è§£ç­”å„ç§é—®é¢˜ã€åˆ›ä½œæ•…äº‹ã€å†™å…¬æ–‡ã€é‚®ä»¶ã€å‰§æœ¬ç­‰ç­‰å“¦ï¼å¦‚æœæœ‰ä»»ä½•ç–‘é—®ï¼Œå°½ç®¡é—®æˆ‘å§ï½ğŸ˜Š
    
    #AIåŠ©æ‰‹ #é—®ç­”å°èƒ½æ‰‹ #éšæ—¶åœ¨çº¿
    00:01:38.668 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai q2:1+2=4
    a2:false
    

7\. ç»“æ„åŒ–è¾“å‡º
---------

### 7.1 ç”³æ˜pojo

    import dev.langchain4j.model.output.structured.Description;
    import lombok.Data;
    
    import java.time.LocalDate;
    
    @Data
    public class PersonTest {
        // æ·»åŠ æè¿°ï¼Œå¸®åŠ© LLM æ›´å¥½åœ°ç†è§£
        @Description("first name of a person") 
        String firstName;
    
        @Description("last name of a person")
        String lastName;
    
        LocalDate birthDate;
    }
    

### 7.2 å®ç°

> æš‚ä¸æ”¯æŒè¿”å› List<è‡ªå®šä¹‰å¯¹è±¡>ï¼Œæ‰§è¡Œä¼šæŠ¥é”™

    @Test
    public void should_return_custom_obj_when_use_normal_model() {
        final PersonTest personTest = assistant.chatWithPojo();
        final List<String> names = assistant.chatWithList(3);
        final Result<String> resultMeta = assistant.chatWithMeta("ä½ æ˜¯è°");
        // can not support return list pojo
        //final List<PersonTest> personTests = assistant.chatWithPojoList(3);
        log.info("call ai personTest:{}", personTest);
        log.info("call ai mock names:{}", names);
        String content = resultMeta.content();
        // AI æœåŠ¡è°ƒç”¨æœŸé—´ä½¿ç”¨çš„ä»¤ç‰Œæ€»æ•°
        TokenUsage tokenUsage = resultMeta.tokenUsage();
        // åœ¨ RAG æ£€ç´¢æœŸé—´æ£€ç´¢åˆ°çš„ Content
        final List<Content> sources = resultMeta.sources();
        // å·²æ‰§è¡Œçš„å·¥å…·
        List<ToolExecution> toolExecutions = resultMeta.toolExecutions();
        // å®Œæˆæ ‡è¯†
        FinishReason finishReason = resultMeta.finishReason();
        log.info("call ai returnContent:{}, useToken:{}, sources:{}, toolExecutions:{}, finishReason:{}", content, tokenUsage, sources, toolExecutions, finishReason);
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

    00:03:14.288 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai personTest:PersonTest(firstName=å¼ , lastName=ä¸‰, birthDate=1990-05-20)
    00:03:14.292 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai mock names:[å¼ ä¼Ÿ, æå¨œ, ç‹å¼º]
    00:03:14.293 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai returnContent:æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œé˜¿é‡Œå·´å·´é›†å›¢æ——ä¸‹çš„è¶…å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹ã€‚æˆ‘èƒ½å¤Ÿå›ç­”é—®é¢˜ã€åˆ›ä½œæ–‡å­—ï¼Œæ¯”å¦‚å†™æ•…äº‹ã€å†™å…¬æ–‡ã€å†™é‚®ä»¶ã€å†™å‰§æœ¬ã€é€»è¾‘æ¨ç†ã€ç¼–ç¨‹ç­‰ç­‰ï¼Œè¿˜èƒ½è¡¨è¾¾è§‚ç‚¹ï¼Œç©æ¸¸æˆç­‰ã€‚å¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼Œæ¬¢è¿éšæ—¶å‘Šè¯‰æˆ‘ï¼, useToken:OpenAiTokenUsage { inputTokenCount = 10, inputTokensDetails = OpenAiTokenUsage.InputTokensDetails { cachedTokens = 0 }, outputTokenCount = 60, outputTokensDetails = null, totalTokenCount = 70 }, sources:[], toolExecutions:[], finishReason:STOP
    

8\. èŠå¤©è®°å¿†
--------

    @Test
    public void should_return_memory_content_when_use_memory_chat() {
        ChatMemoryProvider chatMemoryProvider = memoryId -> MessageWindowChatMemory
                .builder()
                .id(memoryId)
                .maxMessages(10)
                .build();
        AiAssistantServiceWithMemoryTest assistantWithMemory = AiServices
                .builder(AiAssistantServiceWithMemoryTest.class)
                .chatModel(chatModel)
                .chatMemoryProvider(chatMemoryProvider)
                .build();
        String q1 = "å¼ é“ç‰›æ˜¯ä¸€ä¸ªé«˜å¯Œå¸…ï¼Œä½ æ˜¯å¼ é“ç‰›çš„åŠ©æ‰‹";
        String q2 = "å¼ é“ç‰›æ˜¯è°";
        String memoryId = "zhangtieniu-01";
        final String a1 = assistantWithMemory.chat(memoryId, q1);
        final String a2 = assistantWithMemory.chat(memoryId, q2);
        log.info("call ai q1: {}\na1: {}", q1, a1);
        log.info("==========================åˆ†éš”ç¬¦==========================");
        log.info("call ai q2: {}\na2: {}", q2, a2);
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

    00:06:58.754 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai q1: å¼ é“ç‰›æ˜¯ä¸€ä¸ªé«˜å¯Œå¸…ï¼Œä½ æ˜¯å¼ é“ç‰›çš„åŠ©æ‰‹
    a1: æ‚¨å¥½ï¼Œæˆ‘æ˜¯å¼ é“ç‰›å…ˆç”Ÿçš„åŠ©æ‰‹ã€‚å¼ é“ç‰›å…ˆç”Ÿç¡®å®æ˜¯ä¸€ä½éå¸¸ä¼˜ç§€çš„äººå£«ï¼Œä»–ä¸ä»…èº«é«˜å‡ºä¼—ã€ç›¸è²Œå ‚å ‚ï¼Œè¿˜æ‹¥æœ‰å¾ˆé«˜çš„å­¦è¯†å’Œè´¢å¯Œã€‚ä½œä¸ºä»–çš„åŠ©æ‰‹ï¼Œæˆ‘ä¸»è¦è´Ÿè´£ååŠ©ä»–å¤„ç†ä¸€äº›æ—¥å¸¸äº‹åŠ¡ã€å•†åŠ¡å®‰æ’ä»¥åŠç¤¾äº¤æ´»åŠ¨ç­‰ã€‚åŒæ—¶ï¼Œæˆ‘ä¹Ÿåœ¨ä¸æ–­å­¦ä¹ ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒå¼ å…ˆç”Ÿçš„å·¥ä½œä¸ç”Ÿæ´»éœ€æ±‚ã€‚
    
    å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦äº†è§£å…³äºå¼ å…ˆç”Ÿçš„ç›¸å…³ä¿¡æ¯ï¼Œè¯·å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šåœ¨é€‚å½“èŒƒå›´å†…æä¾›å¸®åŠ©ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºå¼ å…ˆç”Ÿçš„ç§äººä¿¡æ¯ï¼Œæˆ‘ä»¬ä¼šä¸¥æ ¼ä¿å¯†ï¼Œå°Šé‡ä»–çš„éšç§æƒã€‚é‚£ä¹ˆï¼Œæ‚¨ä»Šå¤©æ˜¯æƒ³äº†è§£å“ªæ–¹é¢çš„å†…å®¹å‘¢ï¼Ÿæˆ–è€…æœ‰ä»€ä¹ˆå…·ä½“äº‹é¡¹éœ€è¦è½¬è¾¾ç»™å¼ å…ˆç”Ÿå—ï¼Ÿ
    00:06:58.757 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ==========================åˆ†éš”ç¬¦==========================
    00:06:58.757 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- call ai q2: å¼ é“ç‰›æ˜¯è°
    a2: å¼ é“ç‰›å…ˆç”Ÿæ˜¯ä¸€ä½æ°å‡ºçš„é«˜å¯Œå¸…ï¼Œä»–ä¸ä»…åœ¨å¤–è¡¨ä¸Šååˆ†å‡ºä¼—â€”â€”èº«é«˜æŒºæ‹”ã€é•¿ç›¸è‹±ä¿Šï¼Œæ›´æ‹¥æœ‰å“è¶Šçš„æ‰åå’Œé›„åšçš„ç»æµå®åŠ›ã€‚åœ¨äº‹ä¸šä¸Šï¼Œä»–æ¶‰è¶³å¤šä¸ªé¢†åŸŸå¹¶å–å¾—äº†æ˜¾è‘—æˆå°±ï¼Œæ˜¯ä¸€ä½å¤‡å—å°Šæ•¬çš„ä¼ä¸šå®¶ã€‚åŒæ—¶ï¼Œä»–è¿˜çƒ­è¡·äºå…¬ç›Šäº‹ä¸šï¼Œç§¯æå›é¦ˆç¤¾ä¼šã€‚
    
    ä¸è¿‡ï¼Œè¯·å…è®¸æˆ‘æ¾„æ¸…ä¸€ä¸‹ï¼šå¼ é“ç‰›è¿™ä¸ªè§’è‰²å…¶å®æ˜¯è™šæ„çš„ï¼Œä¸»è¦ç”¨äºæƒ…å¢ƒå‡è®¾æˆ–è§’è‰²æ‰®æ¼”ä¸­ã€‚å¦‚æœæ”¾åœ¨ç°å®è¯­å¢ƒä¸‹ï¼Œæˆ‘å¯ä»¥è¿›ä¸€æ­¥è°ƒæ•´æè¿°ä»¥è´´åˆå…·ä½“éœ€æ±‚ã€‚ä½œä¸ºä»–çš„åŠ©æ‰‹ï¼Œæˆ‘çš„èŒè´£å°±æ˜¯ååŠ©å¼ å…ˆç”Ÿå¤„ç†å„ç±»äº‹åŠ¡ï¼Œå¹¶ç¡®ä¿ä»–çš„æ—¥ç¨‹é¡ºåˆ©è¿›è¡Œã€‚
    
    æ‚¨å¯¹å¼ é“ç‰›å…ˆç”Ÿæœ‰ä»€ä¹ˆç‰¹åˆ«æƒ³äº†è§£çš„å†…å®¹å—ï¼Ÿæˆ–è€…æ˜¯å¦æœ‰ä¿¡æ¯éœ€è¦æˆ‘å¸®å¿™ä¼ è¾¾ï¼Ÿ
    

9\. å†…å®¹æŒä¹…åŒ–&function call
-----------------------

    @Test
    public void should_return_memory_content_when_use_memory_and_store_and_tool_chat() {
        PersistentChatMemoryStoreTest store = new PersistentChatMemoryStoreTest();
        ChatMemoryProvider chatMemoryProvider = memoryId -> MessageWindowChatMemory
                .builder()
                .id(memoryId)
                .maxMessages(10)
                .chatMemoryStore(store)
                .build();
        UserServiceTest userServiceTest = new UserServiceTest();
        AiAssistantServiceWithMemoryTest assistantWithMemory = AiServices
                .builder(AiAssistantServiceWithMemoryTest.class)
                .chatModel(chatModel)
                .chatMemoryProvider(chatMemoryProvider)
                .tools(userServiceTest)
                .build();
        String q1 = "å¼ é“ç‰›æ˜¯ä¸€ä¸ªé«˜å¯Œå¸…ï¼Œä½ æ˜¯å¼ é“ç‰›çš„åŠ©æ‰‹";
        String q2 = "å¼ é“ç‰›æ˜¯è°";
        String memoryId = "zhangtieniu-01";
        final String a1 = assistantWithMemory.chat(memoryId, q1);
        final String a2 = assistantWithMemory.chat(memoryId, q2);
        String memoryId2 = "lisi-01";
        final String a3 = assistantWithMemory.chat(memoryId2, q2);
        List<ChatMessage> chatMessages = store.messagesStore.get(memoryId);
    
        for (ChatMessage chatMessage : chatMessages) {
            log.info("session id: {}, message type: {}, message: {}", memoryId, chatMessage.type(), chatMessage);
        }
    
        log.info("==================åˆ†å‰²çº¿==================");
    
        List<ChatMessage> chatMessages2 = store.messagesStore.get(memoryId2);
        for (ChatMessage chatMessage : chatMessages2) {
            log.info("session id: {}, message type: {}, message: {}", memoryId, chatMessage.type(), chatMessage);
        }
    }
    

> æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š

    00:09:10.388 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: USER, message: UserMessage { name = null contents = [TextContent { text = "å¼ é“ç‰›æ˜¯ä¸€ä¸ªé«˜å¯Œå¸…ï¼Œä½ æ˜¯å¼ é“ç‰›çš„åŠ©æ‰‹" }] }
    00:09:10.391 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: AI, message: AiMessage { text = "å¥½çš„ï¼Œæˆ‘æ˜¯å¼ é“ç‰›çš„åŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿå¦‚æœæ‚¨éœ€è¦ä»»ä½•ä¿¡æ¯æˆ–è€…å¸®åŠ©å¤„ç†æŸäº›äº‹æƒ…ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„è¦æ±‚ã€‚æ¯”å¦‚ï¼Œå¦‚æœéœ€è¦è·å–å¼ é“ç‰›ç›¸å…³çš„ä»£ç ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å·²æœ‰çš„åŠŸèƒ½æ¥æŸ¥è¯¢ã€‚è¯·æ˜ç¡®æ‚¨çš„éœ€æ±‚ï¼" toolExecutionRequests = [] }
    00:09:10.391 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: USER, message: UserMessage { name = null contents = [TextContent { text = "å¼ é“ç‰›æ˜¯è°" }] }
    00:09:10.391 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: AI, message: AiMessage { text = "æ ¹æ®å½“å‰ä¸Šä¸‹æ–‡ï¼Œ"å¼ é“ç‰›"æ˜¯ä¸€ä¸ªæˆ‘ä»¬å‡è®¾çš„äººç‰©åå­—ï¼Œä»–æ˜¯æ‚¨çš„ä»£è¡¨äººç‰©ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä½œä¸ºå¼ é“ç‰›çš„åŠ©æ‰‹è¢«è®¾å®šæ¥å¸®åŠ©æ‚¨å®Œæˆå„ç§ä»»åŠ¡æˆ–è€…æä¾›æ‰€éœ€ä¿¡æ¯ã€‚å¦‚æœæ‚¨éœ€è¦å…·ä½“å…³äºâ€œå¼ é“ç‰›â€çš„æ›´å¤šä¿¡æ¯æˆ–è€…æ˜¯ä¸ä¹‹ç›¸å…³çš„æ“ä½œï¼ˆä¾‹å¦‚è·å–å…¶ç”¨æˆ·ä»£ç ç­‰ï¼‰ï¼Œè¯·å‘Šè¯‰æˆ‘æ›´è¯¦ç»†çš„ä¿¡æ¯æˆ–æå‡ºå…·ä½“è¯·æ±‚ã€‚
    
    å¦‚æœæˆ‘ä»¬è¦åŸºäºå®é™…åº”ç”¨æƒ…å¢ƒè¿›è¡Œäº’åŠ¨ï¼Œæ¯”å¦‚æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„ç‰¹å®šä»£ç ï¼Œæ‚¨å¯ä»¥è¦æ±‚æˆ‘æ‰§è¡Œåƒé€šè¿‡ç”¨æˆ·åè·å–ç”¨æˆ·ä»£ç è¿™æ ·çš„åŠŸèƒ½ã€‚ è‹¥è¦è¿™æ ·åšï¼Œè¯·æä¾›å…·ä½“çš„ç”¨æˆ·åï¼Œæˆ‘å°†ä¸ºæ‚¨æŸ¥æ‰¾å¯¹åº”çš„ä»£ç ã€‚
    å¦‚æœæœ‰å…¶ä»–ä»»ä½•é—®é¢˜æˆ–éœ€æ±‚ï¼Œä¹Ÿæ¬¢è¿éšæ—¶å‘ŠçŸ¥ï¼" toolExecutionRequests = [] }
    00:09:10.391 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- ==================åˆ†å‰²çº¿==================
    00:09:10.392 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: USER, message: UserMessage { name = null contents = [TextContent { text = "å¼ é“ç‰›æ˜¯è°" }] }
    00:09:10.392 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: AI, message: AiMessage { text = null toolExecutionRequests = [ToolExecutionRequest { id = "call_f936aff30d024ae1ae6793", name = "getUserCodeByUsername", arguments = "{"username": "å¼ é“ç‰›"}" }] }
    00:09:10.393 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: TOOL_EXECUTION_RESULT, message: ToolExecutionResultMessage { id = "call_f936aff30d024ae1ae6793" toolName = "getUserCodeByUsername" text = "003" }
    00:09:10.394 [main] INFO com.ldx.langchaintest.aisvc.AiChatWithSvcTest -- session id: zhangtieniu-01, message type: AI, message: AiMessage { text = "ç”¨æˆ·å¼ é“ç‰›çš„ä»£ç æ˜¯003ã€‚è¿™æ˜¯ç³»ç»Ÿä¸­å”¯ä¸€æ ‡è¯†è¯¥ç”¨æˆ·çš„ä»£ç ã€‚å¦‚æœæ‚¨éœ€è¦æ›´å¤šå…³äºå¼ é“ç‰›çš„ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æä¾›æ›´å…·ä½“çš„é—®é¢˜æˆ–è€…æŸ¥è¯¢è¯·æ±‚ã€‚" toolExecutionRequests = [] }
    

10\. å°ç»“
-------

æœ¬ç« ä½¿ç”¨äº†`LangChain4J`é«˜é˜¶Apiæ¥è¯·æ±‚å¤§æ¨¡å‹ï¼Œå±•ç¤ºäº†AIæœåŠ¡ä¸­å¸¸è§çš„ä½¿ç”¨æ–¹æ³•ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†ä½¿ç”¨`LangChain4J`çš„RAGåŠŸèƒ½ã€‚