---
layout: post
title: 'å¹‚ç­‰çš„åŒå€å¿«ä¹ï¼Œä½ å€¼å¾—æ‹¥æœ‰'
date: "2025-10-19T00:45:08Z"
---
å¹‚ç­‰çš„åŒå€å¿«ä¹ï¼Œä½ å€¼å¾—æ‹¥æœ‰
=============

helloï¼Œ è¿™æ˜¯æœ‰æ€åº¦é©¬ç”²çš„ç¬¬xxxç¯‡åŸåˆ›å£æ°´æ–‡ã€‚æœ‰è¶£æŒ‡æ•°5é¢—æ˜Ÿï¼Œæœ‰ç”¨æŒ‡æ•°5é¢—æ˜Ÿã€‚

ğŸ˜ ğŸ˜ æœ¬æ–‡æ˜¯å›½å¤–æŠ€æœ¯ç½‘ç«™mediumä¸Šç‚¹èµè¶…è¿‡200+çš„ç¿»è¯‘/ç¬”è®°æ–‡ï¼Œæœ‰å…³[è§„é¿/è§£å†³å¹‚ç­‰è¯·æ±‚](https://medium.com/swlh/retry-requests-fearlessly-with-idempotence-f6bc23f1c721 "å¹‚ç­‰")çš„æ€è·¯æŒ‡å—ã€‚

1\. è½¯ä»¶é¢†åŸŸäºŒæ¬¡è¯·æ±‚æ— æ³•é¿å…
----------------

æˆ‘ä»¬ç”Ÿæ´»çš„æ¯æ—¶æ¯åˆ»éƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œäº‹æƒ…/åŠ¨ä½œå¯èƒ½ä¸ä¼šç›¸åŒçš„å½¢å¼å†æ¬¡å‘ç”Ÿã€‚

åœ¨è½¯ä»¶é¢†åŸŸï¼ŒåŒä¸€åŠ¨ä½œè¯·æ±‚å¹¶ä¸æ€»ä¼šåªäº§ç”Ÿä¸€æ¬¡ï¼Œè¿™å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼š æƒ³è±¡ä½ æœˆåº•å‘è–ªï¼Œå…¬å¸çš„è½¬è´¦æŒ‡ä»¤é”™è¯¯çš„è§¦å‘äº†2æ¬¡ï¼Œè¿™æ˜¯ä¸æ˜¯åŒå€å¿«ä¹ã€‚

æˆ‘æ€»ç»“ï¼š

äºŒæ¬¡è¯·æ±‚çš„æ¥æº

èƒ½é¿å…å‡ºç°å—ï¼Ÿ

æ€ä¹ˆé¿å…å‡ºç°ï¼Ÿ

å‰ç«¯çš„é¢‘ç¹ç‚¹å‡»æäº¤

èƒ½

æäº¤åç½®ç°æŒ‰é’®/æäº¤ååˆ‡æ¢é¡µé¢/é˜²è¯¯è§¦æ¥è§£å†³

å®¢æˆ·ç«¯/ä¸­é—´æœåŠ¡å™¨çš„é‡è¯•åŠ¨ä½œ

ä¸èƒ½

\-

æ ¹æ®åŒå°†å†›ç†è®ºï¼Œå³ä½¿A/Bå°†å†›ä¸æ–­ç¡®è®¤æ”¶åˆ°å¯¹æ–¹çš„ä¸Šä¸€æ¡ä¿¡æ¯ï¼Œ ä¹Ÿæ²¡åŠæ³•ç¡®ä¿å¯¹æ–¹ä¸è‡ªå·±è¾¾æˆ(åŒä¸€æ—¶é—´æ”»å‡»çš„å…±è¯†)ã€‚

ä¸¤å°†å†›é—®é¢˜æ˜¯æ— è§£çš„ï¼Œé—´æ­‡æ€§é‡è¯•æ˜¯ä¸€ç§å·¥ç¨‹è§£ã€‚ ï¼ˆè¿˜æœ‰æ•£å¼¹æ‰“é¸Ÿï¼‰

ï¼šæˆ‘ä»¬ä¸€ç›´å‘é€ç›¸åŒçš„æœåŠ¡è¯·æ±‚ï¼Œç›´åˆ°æˆ‘ä»¬ç¡®å®šæ”¶åˆ°å®ƒï¼ˆè™½ç„¶å¯èƒ½ä¼šå¤šæ¬¡æ”¶åˆ°ï¼‰ï¼Œ è¿™å°±å«è‡³å°‘ä¸€æ¬¡äº¤ä»˜ã€‚

ä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›è¢«æ‰£æ¬¾ä¸¤æ¬¡ï¼Œé‚£æˆ‘ä»¬å°±å¿…é¡»**ç¡®ä¿å¤šæ¬¡å¤„ç†ç›¸åŒçš„è¯·æ±‚ä¸ä¼šæ”¹å˜æœ€åˆçš„åº”ç”¨çŠ¶æ€**ï¼Œ è¿™æ˜¯å¹‚ç­‰è¯·æ±‚çš„é‡ç‚¹ã€‚

> é™¤æ­¤ä¹‹å¤–ï¼Œé‡è¯•è¿˜å¯èƒ½å¸¦æ¥ é‡è¯•é£æš´ã€èµ„æºé›ªå´©ç­‰è¡ç”Ÿé—®é¢˜ã€‚

2\. æŸäº›è¯·æ±‚å¤©ç„¶å¹‚ç­‰ï¼Œä½ ä¸éœ€è¦åšä»€ä¹ˆ
--------------------

æƒ³è±¡ä½ æ­£åœ¨é“¶è¡Œå¼€æˆ·ã€‚

    public sealed class Account
    {
        public Guid Id { get; }
        public decimal Balance { get; private set; }
    
        public Account(Guid id, decimal balance)
        {
            if (id == default)
                throw new InvalidOperationException("Account id must be provided");
    
            if (balance < 0)
                throw new InvalidOperationException("Balance cannot be negative");
    
            Id = id;
            Balance = balance;
        }
       
        // å–é’±
        public void Withdraw(decimal amount)
        {
            if (amount < 0)
                throw new InvalidOperationException("Cannot withdraw negative amount");
            
            if (amount > Balance)
                throw new InvalidOperationException("Cannot withdraw more than existing balance");
    
            Balance -= amount;
        }
    
        // å­˜é’±
        public void Deposit(decimal amount)
        {
            if (amount < 0)
                throw new InvalidOperationException("Cannot deposit negative amount");
            
            Balance += amount;
        }
    }
    

å‰ç«¯å‘èµ·çš„å¼€æˆ·è¯·æ±‚`OpenAccountRequest`æ˜¯å¹‚ç­‰çš„ï¼Œ åªéœ€è¦åœ¨å¼€æˆ·é€»è¾‘é‡Œé¢æ£€æŸ¥ æ•°æ®è¡¨æ˜¯ä¸æ˜¯å­˜åœ¨è¿™ä¸ª`AccountId`ã€‚

ä½ ç”šè‡³å¯åœ¨æ•°æ®åº“**è®¾ç½®AccountIdä¸ºå”¯ä¸€ç´¢å¼•**ï¼Œè®©é‡è¯•åŠ¨ä½œçˆ†å‡ºå¼‚å¸¸ã€‚

    public async Task HandleAsync(OpenAccountRequest request, CancellationToken token = default)
    {
        var account = new Account(request.AccountId, request.Balance); 
        
        try
        {
            await _repository.InsertAsync(account, token);
        }
        catch (DuplicateKeyException)
        {
            //Ignore
        }
    }
    

* * *

å¯¹äºå­˜é’±(WithDrawï¼‰å–é’±ï¼ˆDepositï¼‰å°±ä¸è¡Œäº†ï¼Œå¦‚æœå› ä¸ºç½‘ç»œåŸå› è€Œé‡è¯•äº†2æ¬¡å­˜é’±è¯·æ±‚(deposit)ï¼Œå²‚ä¸å°±æ˜¯åŒå€å¿«ä¹ã€‚

3\. ä¹è§‚é”çš„ä»‹å…¥ä¸€å®šåˆç†å—ï¼Ÿ
----------------

ä¸€ç§å¤„ç†é‡å¤è¯·æ±‚çš„æ–¹å¼æ˜¯**è´¨è¯¢å®ä½“çš„çŠ¶æ€**ï¼Œä¸¥æ ¼æ„ä¹‰æ¥è®²ï¼Œ è¿™ä¸ªæ–¹æ¡ˆæ˜¯æ¥è§£å†³æ›´å¤§å™äº‹èƒŒæ™¯ï¼ˆä¹è§‚é”ï¼‰ä¸‹çš„æ–¹æ¡ˆã€‚

é¦–å…ˆæˆ‘ä»¬çŸ¥é“é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæœ‰ä¸€ä¸ªå«ä¹è§‚é”çš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼Œä¹è§‚åœ°è®¤ä¸ºæ•°æ®åœ¨æ“ä½œæ—¶ä¸ä¼šå†²çªï¼Œ å› æ­¤åœ¨æ“ä½œå‰ä¸åŠ é”ï¼Œåœ¨æäº¤æ—¶æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ã€‚

æ–‡ä¸­ä¸€å¼€å§‹ï¼š è®©å‰ç«¯åœ¨è¯·æ±‚æ—¶å¸¦ä¸Šéœ€è¦ä¿æŠ¤çš„`Balance`,  
åœ¨æ›´æ–°æ—¶åˆ©ç”¨`AccountId+åŸBalance`æ¥å®šä½å¹¶æ›´æ–°è´¦æˆ·ã€‚

    // ä¸‹é¢çš„å‰ç«¯DTOéœ€è¦å¸¦ä¸Šè´¦æˆ·ä½™é¢ï¼Œï¼ˆäºŒæ¬¡è¯·æ±‚ä¹Ÿæ˜¯è¿™ä¸ªå€¼ï¼‰ã€‚
    public sealed class DepositToAccountRequest
    {
        public Guid AccountId { get; }
        public decimal Amount { get; }   // æ“ä½œé‡‘é¢
        public decimal AccountBalance { get; }
    
        public DepositToAccountRequest(Guid accountId, decimal amount, decimal accountBalance)
        {
            AccountId = accountId;
            Amount = amount;
            AccountBalance = accountBalance;
        }
    }
    
    

    public async Task HandleAsync(DepositToAccountRequest request, CancellationToken token = default)
    {
        var account = await _repository.GetAsync(request.AccountId, token) ?? 
                      throw new EntityNotFoundException();
    
        account.Deposit(request.Amount);
    
        await _repository.UpdateAsync(account, request.AccountBalance, token);
        
        
    public sealed class AccountRepository : IAccountRepository
    {
        //....
    
        public async Task UpdateAsync(Account account, decimal expectedBalance, CancellationToken token = default)
        {
            var sql = "UPDATE Accounts SET Balance = @Balance WHERE Id = @Id AND Balance = @ExpectedBalance";
            var sqlParams = new
            {
                Id = account.Id, 
                Balance = account.Balance,  // æ–°ä½™é¢
                ExpectedBalance = expectedBalance  // åŸä½™é¢
            };
    
            await using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync(token);
            
            var rowsAffected = await connection.ExecuteAsync(sql, sqlParams);
            if (rowsAffected == 0)
                throw new InvalidStateException();
        }
    
        //....
    }
    

è¯»è€…è‚¯å®šä¹Ÿå‘ç°äº†ï¼š

â‘  è¿™ä¸ªæ–¹å¼ä¸çµæ´»ï¼Œå¦‚æœä¸æ˜¯Balanceï¼Œæˆ–è€…ä¸åªæ˜¯Balance, é‚£ä¹ˆè¿™ä¸ªsqlé€»è¾‘å°±å¾—å˜åŒ–ï¼›

â‘¡ å¦ä¸€æ–¹é¢ï¼Œè¿™ä¸ªæ–¹å¼å½’æ ¹åˆ°åº•ä¸è¯†åˆ«é‡å¤è¯·æ±‚ï¼Œä¸çŸ¥é“è¿™æ˜¯é‡å¤è¯·æ±‚ï¼Œè¿˜æ˜¯åº•å±‚çš„æ•°æ®çœŸçš„å‘ç”Ÿäº†å˜åŒ–ã€‚

æƒ³è±¡ä½ è¢«è§¦å‘äº†ç¬¬äºŒæ¬¡å–é’±è¯·æ±‚ï¼Œ è‹¥æ­¤æ—¶åˆšå¥½æœ‰äººç»™ä½ å­˜äº†ä¸€ç¬”é’±ï¼ˆåˆšå¥½ç­‰äºä½ ç¬¬ä¸€æ¬¡å–é’±é‡‘é¢ï¼‰ï¼Œä¿ƒä½¿ä½ çš„ç¬¬äºŒæ¬¡å–é’±è¯·æ±‚æˆåŠŸäº†ï¼Œè¿™å²‚ä¸æ˜¯æ–°çš„åŒå€æ‚²ä¼¤ã€‚

æ‰€ä»¥æ–‡ä¸­æå‡ºäº†åŸºäºå®è¾¾å™äº‹çš„æ­£ç»æ–¹æ¡ˆï¼š **çŠ¶æ€ç‰ˆæœ¬**  
**åœ¨å‰ç«¯DTOè¯·æ±‚å¸¦ä¸Š`AccountVersion`ï¼Œæ¯æ¬¡æ›´æ–°æ—¶ç”¨`AccoundId+åŸAccountVersion`å»å®šä½ã€æ›´æ–°çŠ¶æ€ç‰ˆæœ¬ï¼Œ å¦‚æœwhereæ¡ä»¶å¤±è´¥è¯´æ˜å®ä½“çŠ¶æ€å·²ç»å˜åŒ–ï¼Œéœ€è¦æŠ¥é”™ç»™åˆ°å‰ç«¯ï¼Œè®©å‰ç«¯é‡æ–°æ‹‰å–åšåŠ¨ä½œï¼Œ å¦‚æœwhereæ¡ä»¶æˆåŠŸï¼Œåˆ™è¯´æ˜çŠ¶æ€ç‰ˆæœ¬æ— å˜æ›´ï¼Œé€’å¢versionï¼Œå¹¶ç»™åˆ°å‰ç«¯ã€‚**

        public async Task UpdateAsync(Account account, int expectedVersion, CancellationToken token = default)
        {
            var sql = "UPDATE Accounts SET Balance = @Balance, Version = @Version WHERE Id = @Id AND Version = @ExpectedVersion";
            var sqlParams = new
            {
                Id = account.Id, 
                Balance = account.Balance, 
                Version = account.Version,
                ExpectedVersion = expectedVersion
            };
    
            await using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync(token);
            
            var rowsAffected = await connection.ExecuteAsync(sql, sqlParams);
            if (rowsAffected == 0)
                throw new InvalidStateException();
        }
    

è¿™ç§ä¹è§‚é”çš„æ€æƒ³å»è§£å†³å¹‚ç­‰é—®é¢˜æœ‰ä¸€ä¸ªå°å¼Šç«¯ï¼Œ å› ä¸ºä¹è§‚é”çš„æ€æƒ³æœ¬æ˜¯é’ˆå¯¹å¹¶å‘æ§åˆ¶ï¼Œå®ƒè§£å†³äº†å¹¶å‘è¯·æ±‚ä¸­çš„é‡å¤è¯·æ±‚è¿™ä¸€å­é›†åœºæ™¯ï¼Œä½†æ˜¯å¸¦æ¥çš„å‰¯ä½œç”¨å°±æ˜¯é«˜å¹¶å‘æ—¶ï¼Œå¾ˆå¤šè¯·æ±‚ä¼šè¢«æ‹’ç»(é‡è¯•è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¹¶å‘è¯·æ±‚ä¹Ÿä¼šè¢«æ‹’ç»)ï¼Œæ•ˆç‡å˜ä½ï¼Œä½†æ•°æ®ä¸ä¸€è‡´é—®é¢˜æ²¡æœ‰äº†ï¼ŒåŒå€æ‚²ä¼¤ä¹Ÿä¸ä¼šæœ‰ã€‚

4\. ç”¨æ•°æ®åº“äº‹åŠ¡åŒ…å›´ æ›´ç®€å•ã€å¸¸è§„
-------------------

ä½ æœ‰ä¸€å¼ è¡¨æ¥å­˜å‚¨ requestIdçš„å†å²è®°å½•ï¼Œ è¿™ä¸ªè¡¨ä¿è¯requestIdå”¯ä¸€ã€‚

é‚£ä¹ˆé€šè¿‡äº‹åŠ¡ï¼š requestIdå…ˆæ’å…¥å†å²è®°å½•è¡¨ã€ å®é™…çš„è¯·æ±‚åŠ¨ä½œï¼Œä¾¿å¯ä»¥çœŸå®è§£å†³å¹‚ç­‰é—®é¢˜ï¼Œ è¿™æ˜¯çœŸçš„å¹‚ç­‰ï¼Œ å› ä¸ºè¿™ä¸ªäº‹åŠ¡çœŸæ­£è¯†åˆ«å‡ºäº†é‡å¤è¯·æ±‚ã€‚

    public sealed class AccountRepository : IAccountRepository
    {
        //....
    
        public async Task UpdateAsync(Account account, Guid requestId, CancellationToken token = default)
        {
            var requestSql = "INSERT INTO RequestIds VALUES (@Id)";
            var requestSqlParams = new 
            { 
                Id = requestId.ToString() 
            };
    
            var accountSql = "UPDATE Accounts SET Balance = @Balance WHERE Id = @Id";
            var accountSqlParams = new
            {
                Id = account.Id,
                Balance = account.Balance
            };
    
            await using var connection = new SqlConnection(_connectionString);
            await connection.OpenAsync(token);
            await using var transaction = await connection.BeginTransactionAsync(token);
    
            try
            {
                await connection.ExecuteAsync(requestSql, requestSqlParams);
            }
            catch (Exception e) when (IsDuplicateKeyException(e))
            {
                throw new DuplicateKeyException();
            }
    
            await connection.ExecuteAsync(accountSql, accountSqlParams);
            await transaction.CommitAsync(token);
        }
    
        //....
    }
    

è¿˜å¯å¯¹ä¸Šé¢çš„requestIdå†å²è®°å½•è¡¨åšä¼˜åŒ–ï¼Œä¸ç”¨ä¸€ç›´è®°å½•è¯¥idï¼Œå¼„ä¸€ä¸ªè¿›ç¨‹å‘¨æœŸæ€§æ¸…ç†è¿™ä¸ªè¡¨ã€‚

æ€»ç»“
--

1.  æ²¡æœ‰æœ€ä½³çš„æ–¹å¼å»å¤„ç†å¹‚ç­‰ï¼Œåªæœ‰æœ€åˆé€‚çš„ã€‚
    
2.  æœ‰äº›ä¸šåŠ¡å¤©ç„¶å¹‚ç­‰ï¼Œ ä½¿ç”¨ç®€å•çš„å…¨å±€å”¯ä¸€idå°±å¯ä»¥å®šä½å‡ºäºŒæ¬¡è¯·æ±‚ã€‚
    
3.  å¦‚æœä½ çš„å®ä½“æ›´æ–°çš„ä¸é¢‘ç¹ï¼Œ å¯ä»¥è€ƒè™‘ä½¿ç”¨åŸºäºä¹è§‚é”çš„ç‰ˆæœ¬çŠ¶æ€æ¥è§£å†³ï¼ˆæ€»ä½“ä¸Šä¹è§‚é”æ˜¯æ›´å®è¾¾å™äº‹çš„ä¸€ä¸ªæ€è·¯ï¼Œåœ¨é¢‘ç¹æ›´æ–°åœºæ™¯ä¸‹èƒ½å¤„ç†å¹‚ç­‰é—®é¢˜ï¼Œä½†ä½“éªŒä¸ä½³ï¼Œæ˜¯ä¸€å‘³çŒ›è¯ï¼‰ã€‚
    
4.  æ›´å¸¸è§çš„å¹‚ç­‰è§£å†³æ–¹å¼æ˜¯ï¼šåŸºäºæ•°æ®åº“çš„ACIDäº‹åŠ¡ç†è®ºï¼Œåˆ©ç”¨äº‹åŠ¡è¯†åˆ«å‡ºäºŒæ¬¡è¯·æ±‚ï¼Œæ•´ä¸ªåŠ¨ä½œç›´æ¥é¢å‘æ•°æ®åº“ï¼Œ æ˜¯çœŸæ­£çš„å®ç°äº†å¹‚ç­‰è¯­ä¹‰ã€‚
    

ğŸ™ğŸ»ğŸ™ğŸ»ğŸ™ğŸ»

[https://medium.com/swlh/retry-requests-fearlessly-with-idempotence-f6bc23f1c721](https://medium.com/swlh/retry-requests-fearlessly-with-idempotence-f6bc23f1c721)

* * *

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š{æœ‰æ€åº¦çš„é©¬ç”²}ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/JulianHuang/p/19150319](https://www.cnblogs.com/JulianHuang/p/19150319)

**æ¬¢è¿å…³æ³¨æˆ‘çš„åŸåˆ›æŠ€æœ¯ã€èŒåœºå…¬ä¼—å·ï¼Œ åŠ å¥½å‹è°ˆå¤©è¯´åœ°ï¼Œä¸€èµ·è¿›åŒ–**

![](https://blog-static.cnblogs.com/files/JulianHuang/QR.gif)