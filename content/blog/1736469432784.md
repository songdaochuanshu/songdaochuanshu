---
layout: post
title: 'ã€æ‰‹å†™ RPCã€‘ä½¿ç”¨nettyæ‰‹å†™ä¸€ä¸ªRPCæ¡†æ¶ ç»“åˆæ–°ç‰¹æ€§ è™šæ‹Ÿçº¿ç¨‹'
date: "2025-01-10T00:37:12Z"
---
ã€æ‰‹å†™ RPCã€‘ä½¿ç”¨nettyæ‰‹å†™ä¸€ä¸ªRPCæ¡†æ¶ ç»“åˆæ–°ç‰¹æ€§ è™šæ‹Ÿçº¿ç¨‹
===================================

![ã€æ‰‹å†™ RPCã€‘ä½¿ç”¨nettyæ‰‹å†™ä¸€ä¸ªRPCæ¡†æ¶ ç»“åˆæ–°ç‰¹æ€§ è™šæ‹Ÿçº¿ç¨‹](https://img2024.cnblogs.com/blog/3585828/202501/3585828-20250109164540943-1761238027.png) å¦‚ä½•ä½¿ç”¨Javaçš„è™šæ‹Ÿçº¿ç¨‹å’ŒNettyæ‰‹å†™ä¸€ä¸ªåŸºäºè‡ªå®šä¹‰åè®®çš„RPCï¼ˆè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼‰æ¡†æ¶ã€‚æ–‡ç« é¦–å…ˆè§£é‡Šäº†RPCæ¡†æ¶çš„æ¦‚å¿µå’ŒNettyçš„ä¼˜åŠ¿ï¼Œæ¥ç€ä»‹ç»äº†Javaè™šæ‹Ÿçº¿ç¨‹çš„ç‰¹ç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚ç„¶åï¼Œæ–‡ç« è¯¦ç»†æè¿°äº†å®ç°RPCæ¡†æ¶çš„å„ä¸ªæ­¥éª¤ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°å’Œæ³¨å†Œã€è¯·æ±‚å’Œå“åº”çš„å¤„ç†ã€è¿æ¥çš„ç®¡ç†ç­‰ã€‚åŒæ—¶ï¼Œæ–‡ç« å±•ç¤ºäº†å¦‚ä½•å°†è™šæ‹Ÿçº¿ç¨‹ä¸Nettyç»“åˆï¼Œé€šè¿‡ä¿®æ”¹Nettyçš„çº¿ç¨‹æ¨¡å‹æ¥æé«˜æ€§èƒ½ã€‚

ã€æ‰‹å†™RPCæ¡†æ¶ã€‘å¦‚ä½•ä½¿ç”¨nettyæ‰‹å†™ä¸€ä¸ªRPCæ¡†æ¶ ç»“åˆæ–°ç‰¹æ€§ è™šæ‹Ÿçº¿ç¨‹
======================================

ä»€ä¹ˆæ˜¯RPCæ¡†æ¶
========

RPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ˜¯ä¸€ç§é€šè¿‡ç½‘ç»œä»è¿œç¨‹è®¡ç®—æœºç¨‹åºä¸Šè¯·æ±‚æœåŠ¡ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±‚ç½‘ç»œæŠ€æœ¯çš„åè®®ã€‚RPCæ¡†æ¶æ˜¯ä¸€ç§è¿œç¨‹è°ƒç”¨çš„æ¡†æ¶ï¼Œå®ƒå¯ä»¥è®©ä½ åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·è°ƒç”¨è¿œç¨‹æ–¹æ³•ã€‚

é¿å…äº†å¼€å‘äººå‘˜è‡ªå·±å»å°è£…ç½‘ç»œè¯·æ±‚ã€è¿æ¥ç®¡ç†ã€åºåˆ—åŒ–ã€ååºåˆ—åŒ–ç­‰æ“ä½œï¼Œæé«˜äº†å¼€å‘æ•ˆç‡ã€‚

Nettyæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨Netty
-------------------

Nettyæ˜¯ä¸€ä¸ªåŸºäºNIOçš„å®¢æˆ·ã€æœåŠ¡å™¨ç«¯ç¼–ç¨‹æ¡†æ¶ï¼Œä½¿ç”¨Nettyå¯ä»¥å¿«é€Ÿå¼€å‘ç½‘ç»œåº”ç”¨ï¼Œä¾‹å¦‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚Nettyæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¼‚æ­¥äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œå®ƒç®€åŒ–äº†ç½‘ç»œç¼–ç¨‹ï¼Œæä¾›äº†ä¸€ç§æ–°çš„æ–¹å¼æ¥å¤„ç†ç½‘ç»œé€šä¿¡ã€‚

å¤§ç™½è¯ç²—ç•¥ç†è§£ï¼šå› ä¸ºJavaçš„NIOçš„APIä½¿ç”¨èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼ŒNettyæ˜¯å¯¹NIOçš„å°è£…ï¼Œä½¿ç”¨èµ·æ¥æ›´åŠ ç®€å•ã€‚

æ‰€ä»¥è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä½¿ç”¨Nettyæ¥å®ç°RPCæ¡†æ¶çš„åŸå› ï¼Œnettyä¹Ÿè¢«å¾ˆå¤šæ¡†æ¶è¯æ˜äº†å®ƒçš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚

Javaè™šæ‹Ÿçº¿ç¨‹
--------

Javaè™šæ‹Ÿçº¿ç¨‹æ˜¯ä¸€ä¸ªè½»é‡çº§çš„çº¿ç¨‹ï¼Œå®ƒä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚Javaè™šæ‹Ÿçº¿ç¨‹æ˜¯ä¸€ä¸ªç”¨æˆ·æ€çš„çº¿ç¨‹ï¼Œå®ƒä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚

è™šæ‹Ÿçº¿ç¨‹å®é™…ä¸Šæ˜¯é€šè¿‡ä¼ ç»Ÿçš„çº¿ç¨‹æ¥ç®¡ç†å¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œåœ¨Javaçš„å¹³å°ä¸Šå»è°ƒåº¦è¿™äº›è™šæ‹Ÿçº¿ç¨‹ï¼Œä»è€Œå®ç°äº†è½»é‡çº§çš„çº¿ç¨‹ç§°ä¸ºè™šæ‹Ÿçº¿ç¨‹ï¼Œæƒ³è¦äº†è§£æ›´åŠ ç»†èŠ‚çš„å¯ä»¥å»çœ‹ä¸‹æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š[ã€è™šæ‹Ÿçº¿ç¨‹ã€‘Javaè™šæ‹Ÿçº¿ç¨‹ VirtualThread æ˜¯ä»€ä¹ˆé»‘ç§‘æŠ€](https://blog.csdn.net/weixin_47157828/article/details/144852879)

### è™šæ‹Ÿçº¿ç¨‹çš„ä¼˜åŠ¿ï¼š

1.  è½»é‡çº§ï¼šè™šæ‹Ÿçº¿ç¨‹æ˜¯è½»é‡çº§çš„çº¿ç¨‹ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚
2.  é«˜æ•ˆï¼šè™šæ‹Ÿçº¿ç¨‹æ˜¯ç”¨æˆ·æ€çš„çº¿ç¨‹ï¼Œä¸éœ€è¦æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ”¯æŒï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸æ¶‰åŠå†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ï¼Œæ•ˆç‡æ›´é«˜ã€‚

### é€‚åˆçš„åœºæ™¯ï¼š

1.  é«˜å¹¶å‘ï¼šè™šæ‹Ÿçº¿ç¨‹é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜æ€§èƒ½ã€‚
2.  IOå¯†é›†å‹ï¼šè™šæ‹Ÿçº¿ç¨‹é€‚åˆIOå¯†é›†å‹çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜æ€§èƒ½ã€‚
3.  ä»»åŠ¡çŸ­æš‚ï¼šè™šæ‹Ÿçº¿ç¨‹é€‚åˆä»»åŠ¡çŸ­æš‚çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜æ€§èƒ½ã€‚

å†™ä¸€ä¸ªRPCæ¡†æ¶éœ€è¦å“ªäº›æ­¥éª¤
==============

æ—¢ç„¶æˆ‘ä»¬è¦å†™ä¸€ä¸ªRPCæ¡†æ¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ä¸€ä¸‹æˆ‘ä»¬éœ€è¦åšå“ªäº›äº‹æƒ…ã€‚  
æˆ‘ä»¬æ˜¯ä»AæœåŠ¡è°ƒç”¨BæœåŠ¡ï¼Œé‚£ä¹ˆå°±ä»£è¡¨æˆ‘ä»¬çš„æœåŠ¡Aæ˜¯å®¢æˆ·ç«¯ï¼ŒæœåŠ¡Bæ˜¯æœåŠ¡ç«¯ã€‚ä½†æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿæ­£å¸¸æ¥è¯´è¦è°ƒç”¨åˆ«çš„æœåŠ¡ï¼Œä¹Ÿä¼šè¢«åˆ«çš„æœåŠ¡è°ƒç”¨ï¼Œ  
æ‰€ä»¥æˆ‘ä»¬çš„æœåŠ¡Aä¹Ÿæ˜¯æœåŠ¡ç«¯ï¼ŒæœåŠ¡Bä¹Ÿæ˜¯å®¢æˆ·ç«¯ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç³»ç»Ÿè¦åŒæ—¶å…·å¤‡å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŠŸèƒ½ã€‚

*   å®¢æˆ·ç«¯çš„åŠŸèƒ½ï¼šå‘ç°æœåŠ¡ã€è¯·æ±‚ï¼ˆè´Ÿè½½å‡è¡¡ã€å‘èµ·è¿æ¥ã€å‘é€è¯·æ±‚ï¼‰ã€æ¥æ”¶å“åº”ã€å…³é—­è¿æ¥ã€‚
*   æœåŠ¡ç«¯çš„åŠŸèƒ½ï¼šæ³¨å†ŒæœåŠ¡ã€æ¥æ”¶è¯·æ±‚ï¼ˆæ¥æ”¶è¿æ¥ã€æ¥æ”¶è¯·æ±‚ï¼‰ã€å‘é€å“åº”ã€å…³é—­è¿æ¥ã€‚

å…¶å®æ ¹æ®ä¸Šé¢å¯ä»¥å‘ç°ï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯æ‰€åšçš„äº‹æƒ…æ˜¯å¯¹åº”çš„ï¼Œæ˜¯ä¸€ä¸ªé•œåƒçš„å…³ç³»ã€‚æ‰€ä»¥æˆ‘ä»¬å°±æ˜¯å¯¹åº”æ”¾åœ¨ä¸€èµ·è®²ã€‚

æ³¨æ„æ³¨æ„æ³¨æ„âš ï¸ï¼š

1.  **ç¤ºä¾‹ä¸­çš„ä»£ç ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘åªæ‘˜å–äº†ä¸»è¦é€»è¾‘ï¼Œä¸”åšäº†ç®€ç•¥ï¼Œå…·ä½“çš„å®ç°å¯ä»¥çœ‹æˆ‘æ”¾åœ¨æœ€åçš„é¡¹ç›®æºç ã€‚**
2.  è¿™é‡Œæˆ‘ä»¬åªæ˜¯ç®€å•çš„å®ç°ä¸€ä¸ªRPCæ¡†æ¶ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å®ç°äº†æœ€åŸºæœ¬çš„åŠŸèƒ½ï¼Œå®é™…çš„RPCæ¡†æ¶è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šç†”æ–­ã€é™æµã€ç›‘æ§ç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½å¯ä»¥æ ¹æ®å®é™«çš„éœ€æ±‚æ¥å®ç°æ‰©å±•ã€‚

1 å‘ç°æœåŠ¡ã€æ³¨å†ŒæœåŠ¡
-----------

æ³¨å†ŒæœåŠ¡ï¼šæœåŠ¡ç«¯æƒ³å‘Šè¯‰åˆ«äººæˆ‘æä¾›äº†å“ªäº›æœåŠ¡ï¼ˆæ¥å£çš„æ–¹æ³•ï¼‰ï¼Œæˆ‘çš„åœ°å€æ˜¯ä»€ä¹ˆã€‚  
å‘ç°æœåŠ¡ï¼šå®¢æˆ·ç«¯éœ€è¦çŸ¥é“æˆ‘è°ƒç”¨çš„ä¸€äº›æœåŠ¡ï¼ˆæ¥å£çš„æ–¹æ³•ï¼‰æœ‰å“ªäº›åœ°å€ï¼ˆip + ç«¯å£ï¼‰å¯ä»¥è°ƒç”¨ã€‚

æœåŠ¡å‘ç°å’Œæ³¨å†Œçš„æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚ï¼šzookeeperã€nacosã€consulã€etcdç­‰ç­‰ã€‚æœ¬æ¬¡æˆ‘ä»¬ä»¥zookeeperä¸ºä¾‹ã€‚

æ³¨å†ŒæœåŠ¡ä»£ç ç¤ºä¾‹ï¼š

        private static CuratorFramework client;
        
        // è¿™é‡Œä½¿ç”¨Curatoræ¡†æ¶æ¥æ“ä½œzookeeper
        public ZookeeperRegistryCenter() {
           final var zookeeper = PROPERTIES_THREAD_LOCAL.get().getRegistry().getZookeeper();
        
           RetryPolicy retryPolicy = new ExponentialBackoffRetry(3000, 10);
           final var builder = CuratorFrameworkFactory.builder()
                   .connectString(zookeeper.getAddress())
                   .namespace(zookeeper.getRootPath());
           client = builder.build();
        }
        // åˆ›å»ºä¸€ä¸ªzkå®¢æˆ·ç«¯
        private static void create(String path, CreateMode mode) throws Exception {
            client.create()
                    .creatingParentsIfNeeded()
                    .withMode(mode)
                    .forPath(path);
        }
    

å‘ç°æœåŠ¡ä»£ç ç¤ºä¾‹ï¼š

        // å‘ç°æœåŠ¡ï¼Œåªè¦ç›‘å¬æ³¨å†Œä¸­å¿ƒçš„å˜åŒ–
        public void watch() {
        
            // è§‚å¯Ÿè€…æ¨¡å¼ï¼Œç›‘å¬æ³¨å†Œä¸­å¿ƒçš„å˜åŒ–
            registryCenter.watch((change, providerInfo) -> {
                switch (change) {
                    case Change.ADD -> addServiceAddress(providerInfo);
                    case Change.UPDATE -> updateServiceAddress(providerInfo);
                    case Change.REMOVE -> deleteServiceAddress(providerInfo);
                }
            });
        }
    
        private void addOrUpdateServiceAddress(String methodStr, Pair<String, Integer> address) {
            // è¿™é‡Œä½¿ç”¨SERVICE_ADDRESS_MAPï¼ˆConcurrentHashMapï¼‰æœ¬åœ°ç¼“å­˜æœåŠ¡åœ°å€ï¼Œkeyæ˜¯æ¥å£å+æ–¹æ³•åï¼Œvalueæ˜¯æœåŠ¡åœ°å€
            SERVICE_ADDRESS_MAP.computeIfAbsent(methodStr, _ -> new CopyOnWriteArraySet<>())
                    .add(address);
        }
    

2 è¯·æ±‚ã€æ¥æ”¶
-------

è¯·æ±‚ä»£ç ç¤ºä¾‹ï¼š

        // è¯·æ±‚
        public Object send(RpcRequestMessage msg, Method method, Set<Pair<String, Integer>> addressSet) throws LRPCTimeOutException {
            // è´Ÿè½½å‡è¡¡é€‰æ‹©æœåŠ¡åœ°å€
            final var address = clazzToAddress(method, addressSet);
            // è·å–è¿æ¥æ± 
            final var channelPool = getChannelPool(address);
            // åœ¨è¿æ¥æ± ä¸­æ‰§è¡Œè¯·æ±‚
            return channelManager.executeWithChannelPool(channelPool, channelExeFunction, msg);
        }
    

### 2.1 è´Ÿè½½å‡è¡¡

è´Ÿè½½å‡è¡¡ï¼šå®¢æˆ·ç«¯åœ¨å‘ç°äº†æœåŠ¡çš„åœ°å€ä¹‹åï¼Œå¯èƒ½æœ‰å¤šä¸ªæœåŠ¡çš„åœ°å€ï¼Œè¿™æ—¶å€™éœ€è¦åšè´Ÿè½½å‡è¡¡ï¼Œé€‰æ‹©ä¸€ä¸ªæœåŠ¡çš„åœ°å€æ¥è°ƒç”¨ã€‚

        // é€‰æ‹©æœåŠ¡åœ°å€ï¼Œè´Ÿè½½å‡è¡¡
        private Pair<String, Integer> clazzToAddress(Method method, Set<Pair<String, Integer>> addressSet) {
            if (addressSet != null && !addressSet.isEmpty()) {
                // è‹¥æŒ‡å®šäº†æœåŠ¡åœ°å€ï¼Œåˆ™åœ¨æŒ‡å®šçš„æœåŠ¡åœ°å€ä¸­é€‰æ‹©
                return loadBalancer.selectServiceAddress(method, addressSet);
            }
            addressSet = serviceManager.getServiceAddress(method);
            // è‹¥æœªæŒ‡å®šæœåŠ¡åœ°å€ï¼Œåˆ™åœ¨æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡åœ°å€ä¸­é€‰æ‹©
            return loadBalancer.selectServiceAddress(method, addressSet);
        }
    

### 2.2 å‘èµ·è¿æ¥ã€æ¥æ”¶è¿æ¥

å› ä¸ºæˆ‘ä»¬çš„rpcçš„è°ƒç”¨ä¼šæ¯”è¾ƒé¢‘ç¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¿æŒé•¿è¿æ¥ï¼Œé¿å…é¢‘ç¹çš„åˆ›å»ºè¿æ¥å’Œæ–­å¼€ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨è¿æ¥æ± æ¥ç®¡ç†è¿æ¥ã€‚

å‘èµ·è¿æ¥ï¼šå®¢æˆ·ç«¯åœ¨çŸ¥é“äº†æœåŠ¡çš„åœ°å€ä¹‹åï¼Œéœ€è¦å’ŒæœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œå»ºç«‹è¿æ¥åï¼Œå†å‘é€è¯·æ±‚ã€‚

æ¥æ”¶è¿æ¥ï¼šæœåŠ¡ç«¯éœ€è¦æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œæ¥æ”¶åˆ°è¿æ¥åï¼Œå†æ¥æ”¶è¯·æ±‚ã€‚

        private FixedChannelPool getChannelPool(Pair<String, Integer> address) {
            final var host = address.left;
            final var port = address.right;
            return serviceManager.getChannelPool(address,
                    // åˆ›å»ºè¿æ¥æ± 
                    _ -> LrpcChannelPoolFactory.createFixedChannelPool(host, port, lrpcProperties.getClient().getAddressMaxConnection()));
        }
        public FixedChannelPool getChannelPool(Pair<String, Integer> address, Function<String, FixedChannelPool> mappingFunction) {
            final var host = address.left;
            final var port = address.right;
            return ADDRESS_POOL_MAP.computeIfAbsent(host + ":" + port, mappingFunction);
        }
    

æ¥æ”¶è¿æ¥å…¶å®å°±æ˜¯bossGroupçš„å¤„ç†é€»è¾‘ï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå¯ä»¥çœ‹æœ€åæˆ‘è´´çš„é¡¹ç›®æºç ã€‚

### 2.3 å‘é€è¯·æ±‚ã€æ¥æ”¶è¯·æ±‚

**å‘é€è¯·æ±‚**ï¼šå®¢æˆ·ç«¯åœ¨å»ºç«‹è¿æ¥åï¼Œåœ¨è°ƒç”¨æœåŠ¡çš„æ–¹æ³•æ—¶ï¼Œéœ€è¦å‘é€æŠ¥æ–‡ä½“ï¼Œå‘é€æœ¬åœ°éœ€è¦ä¿å­˜è¯·æ±‚IDå’ŒPromise(ç”¨äºæ¥æ”¶è°ƒç”¨ç»“æœï¼ŒnettyåŒ…è£…ä¸€å±‚çš„future)çš„æ˜ å°„å…³ç³»ï¼Œç”¨æ¥æ¥æ”¶å“åº”æ—¶ï¼Œæ ¹æ®è¯·æ±‚IDæ‰¾åˆ°å¯¹åº”çš„è¯·æ±‚ã€‚

**æ¥æ”¶è¯·æ±‚**ï¼šæœåŠ¡ç«¯åœ¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¿æ¥åï¼Œéœ€è¦æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œè§£æè¯·æ±‚ï¼Œè°ƒç”¨å¯¹åº”çš„æ–¹æ³•ã€‚

**_æˆ‘ä»¬æœ¬æ¬¡ä½¿ç”¨è‡ªå®šä¹‰åè®®ï¼Œæ‰€ä»¥éœ€è¦çº¦å®šå¥½æŠ¥æ–‡ä½“çš„æ ¼å¼_**

    æŠ¥æ–‡ä½“ï¼š16å­—èŠ‚åè®®çº¦å®šå†…å®¹ + è¯·æ±‚ä½“ï¼›
    
    16å­—èŠ‚åè®®çº¦å®šå†…å®¹ï¼š
    
      ï¼ˆ1ï¼‰ï¼š4ä¸ªå­—èŠ‚çš„é•¿åº¦æ¥è¡¨ç¤ºåè®®çš„é­”æ•°ï¼šå°±æ˜¯ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œç”¨æ¥æ ‡è¯†è¿™æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„åè®®ï¼Œè¿™é‡Œä½¿ç”¨'L'ã€'R'ã€'P'ã€'C'ã€‚
    
      ï¼ˆ2ï¼‰ï¼š1ä¸ªå­—èŠ‚çš„ç‰ˆæœ¬å·ï¼šæ ‡è¯†è¿™ä¸ªåè®®çš„ç‰ˆæœ¬å·ï¼Œè¿™é‡Œå› ä¸ºæ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ‰€ä»¥ä½¿ç”¨1ã€‚
    
      ï¼ˆ3ï¼‰ï¼š1ä¸ªå­—èŠ‚çš„åºåˆ—åŒ–ç®—æ³•ï¼šæ ‡è¯†è¿™ä¸ªåè®®ä½¿ç”¨çš„åºåˆ—åŒ–ç®—æ³•ï¼Œå¯¹åº”äº†åºåˆ—åŒ–ç®—æ³•åœ¨æšä¸¾ä¸­çš„æ•°ç»„ä¸‹æ ‡ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯0ï¼Œè¡¨ç¤ºä½¿ç”¨JSONåºåˆ—åŒ–ã€‚
    
      ï¼ˆ4ï¼‰ï¼š4ä¸ªå­—èŠ‚çš„è¯·æ±‚IDï¼šæ ‡è¯†è¿™ä¸ªè¯·æ±‚çš„IDï¼Œç”¨æ¥æ ‡è¯†è¿™ä¸ªè¯·æ±‚çš„å”¯ä¸€æ€§ï¼Œè¿™é‡Œä½¿ç”¨UUIDç”Ÿæˆï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½ä¿å­˜ä¸€ä¸ªMapï¼Œç”¨æ¥ä¿å­˜è¯·æ±‚IDå’Œè¯·æ±‚çš„æ˜ å°„å…³ç³»ã€‚
    
      ï¼ˆ5ï¼‰ï¼š1ä¸ªå­—èŠ‚çš„æ¶ˆæ¯ç±»å‹ï¼šæ ‡è¯†è¿™ä¸ªæ¶ˆæ¯çš„ç±»å‹ï¼Œæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ï¼Œè¿™é‡Œä½¿ç”¨1è¡¨ç¤ºè¯·æ±‚æ¶ˆæ¯ï¼Œ2è¡¨ç¤ºå“åº”æ¶ˆæ¯ã€‚
    
      ï¼ˆ6ï¼‰ï¼š4ä¸ªå­—èŠ‚çš„è¯·æ±‚ä½“çš„é•¿åº¦ï¼šä½¿ç”¨Integerç±»å‹ï¼Œè¡¨ç¤ºè¯·æ±‚ä½“çš„é•¿åº¦ï¼Œåœ¨æ¥æ”¶è¯·æ±‚æ—¶ï¼Œæ ¹æ®è¿™ä¸ªé•¿åº¦æ¥è§£æè¯·æ±‚ä½“ã€‚
    
      ï¼ˆ7ï¼‰ï¼š1ä¸ªå­—èŠ‚çš„è¡¥å……ä½ï¼›æ— å®é™…æ„ä¹‰ï¼Œåªæ˜¯ä¸ºäº†å¯¹é½16å­—èŠ‚ã€‚
    
    è¯·æ±‚ä½“ï¼šåºåˆ—åŒ–åè½¬æˆå­—èŠ‚æ•°ç»„ï¼Œå†…å®¹æœ‰ï¼šæ¥å£å + æ–¹æ³•å + è¿”å›å‚æ•°ç±»å‹ + è¯·æ±‚å‚æ•°ç±»å‹æ•°ç»„ + è¯·æ±‚å‚æ•°å€¼æ•°ç»„ã€‚
    

æŒ‰åˆšåˆšä¸Šé¢çº¦å®šå¥½çš„åè®®æ ¼å¼è§£æï¼Œç„¶åå°†è¯·æ±‚ä½“çš„å†…å®¹ååºåˆ—åŒ–ï¼Œå¾—åˆ°æ¶ˆæ¯ç±»å‹ï¼Œä½¿ç”¨LengthFieldBasedFrameDecoderè§£ç å™¨ï¼Œè§£å†³ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ï¼Œå¾—åˆ°è¯·æ±‚ä½“çš„å­—èŠ‚æ•°ç»„ï¼Œç„¶åååºåˆ—åŒ–ï¼Œ

å¾—åˆ°æ¶ˆæ¯åï¼Œè·å–åˆ°æ¥å£åã€æ–¹æ³•åã€è¿”å›å‚æ•°ç±»å‹ã€è¯·æ±‚å‚æ•°ç±»å‹æ•°ç»„ã€è¯·æ±‚å‚æ•°å€¼æ•°ç»„ï¼Œä½¿ç”¨åŠ¨æ€ä»£ç†è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œå¾—åˆ°è¿”å›å€¼ã€‚

    
        public <T> T getProxy(Class<T> clazz, Set<Pair<String, Integer>> serviceAddress) {
            // ä½¿ç”¨ä»£ç†çš„æ–¹å¼ï¼Œè°ƒç”¨æ–¹æ³•
            final var proxyInstance = Proxy.newProxyInstance(clazz.getClassLoader(), new Class[]{clazz}, (proxy, method, args) -> {
                RpcRequestMessage msg = buildRpcRequestMessage(clazz, method, args);
                return consumerManager.send(msg, method, serviceAddress);
            });
            return clazz.cast(proxyInstance);
        }
        
        public Object executeWithChannelPool(ChannelPool channelPool,
                                                      BiFunction<Channel, RpcRequestMessage, Promise<Object>> function,
                                                      RpcRequestMessage msg) throws LRPCTimeOutException {
            // 1. ä»è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼Œç­‰å¾…è¶…å¸‚æ—¶é—´ï¼Œæœªè·å–è¿æ¥åˆ™æŠ›å‡ºå¼‚å¸¸
            final Future<Channel> future = channelPool.acquire();
            Channel channel = future.get();
            final var promise = function.apply(channel, msg);
            try {
                return getResult(promise, msg.getMessageId());
            } finally {
                // è¿™é‡Œçš„é‡Šæ”¾éœ€è¦æ”¾åœ¨æ‹¿åˆ°ç»“æœä¹‹åï¼Œå¦åˆ™ä¼šå¯¼è‡ƒè¿æ¥è¢«é‡Šæ”¾
                channelPool.release(channel);
            }
        }
        
        private static BiFunction<Channel, RpcRequestMessage, Promise<Object>> channelExeFunction() {
            // å‘é€è¯·æ±‚ï¼Œä¸”å¤„ç†å†™å¤±è´¥
            return (channel, msg) -> {
                final var promise = new DefaultPromise<>(channel.eventLoop());
                RpcRespHandler.addPromise(msg.getMessageId(), promise);
                // å‘é€è¯·æ±‚ï¼Œä¸”å¤„ç†å†™å¤±è´¥
                final var channelFuture = channel.writeAndFlush(msg);
                channelFuture.addListener(processAftermath(promise, msg));
                return promise;
            };
        }
    

æ¥æ”¶å¤„ç†è¯·æ±‚

    
        @Override
        protected void channelRead0(ChannelHandlerContext ctx, RpcRequestMessage msg) {
    
            log.info("æ¥æ”¶åˆ°æ¶ˆæ¯ {}", JSON.toJSON(msg));
            final var interfaceName = msg.getInterfaceName();
            final var methodName = msg.getMethodName();
            
            // æ ¹æ®æ¥å£åè·å–æœåŠ¡çš„æœ¬åœ°å®ä¾‹
            final var service = serviceManager.getService(interfaceName);
    
            final var response = new RpcResponseMessage();
            response.setMessageId(msg.getMessageId());
            try {
                // ä½¿ç”¨åå°„è°ƒç”¨æ–¹æ³•
                final Class<?> aClass = service.getClass();
                final var method = aClass.getMethod(methodName, msg.getParameterTypes());
                final var result = method.invoke(service, msg.getParameterValues());
                response.setReturnValue(result);
            } catch (IllegalAccessException | InvocationTargetException | NoSuchMethodException e) {
                log.error("e : ", e);
                response.setExceptionValue(new Error(e.getCause().getMessage()));
            }
            
            // ä»¥ä¸‹å±äºå‘é€å“åº”çš„é€»è¾‘
            ctx.writeAndFlush(response).addListener(future -> {
                if (future.isSuccess()) {
                    log.info("æ¶ˆæ¯å“åº”æˆåŠŸ {}", JSON.toJSON(msg));
                    return;
                }
                log.error("å‘é€æ¶ˆæ¯æ—¶æœ‰é”™è¯¯å‘ç”Ÿ: ", future.cause());
            });
        }
    
    
    

3 å‘é€å“åº”ã€æ¥æ”¶å“åº”
-----------

å¾—åˆ°ç¬¬6æ­¥çš„è¿”å›å€¼åï¼Œéœ€è¦å°†è¿”å›å€¼å°è£…æˆå“åº”æŠ¥æ–‡ä½“ï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚

è¿™é‡Œå‘é€å“åº”çš„æ–¹å¼å…¶å®æ˜¯å’Œå‘é€è¯·æ±‚çš„æ–¹å¼æ˜¯ä¸€æ ·çš„ï¼Œåªæ˜¯æ¶ˆæ¯ç±»å‹ä¸ä¸€æ ·ï¼Œè¿™é‡Œæ˜¯å“åº”æ¶ˆæ¯ã€‚  
å®¢æˆ·ç«¯æ¥æ”¶åˆ°å“åº”åï¼Œæ ¹æ®è¯·æ±‚IDæ‰¾åˆ°å¯¹åº”çš„è¯·æ±‚ï¼Œå°†å“åº”çš„å†…å®¹è¿”å›ç»™è°ƒç”¨æ–¹ã€‚

å‘é€å“åº”

    
            // åœ¨åˆšåˆšæ¥æ”¶è¯·æ±‚å¤„ç†çš„channelRead0å‡½æ•°ä¸­ï¼Œå¤„ç†å‘é€å“åº”çš„é€»è¾‘
            ctx.writeAndFlush(response).addListener(future -> {
                if (future.isSuccess()) {
                    log.info("æ¶ˆæ¯å“åº”æˆåŠŸ {}", JSON.toJSON(msg));
                    return;
                }
                log.error("å‘é€æ¶ˆæ¯æ—¶æœ‰é”™è¯¯å‘ç”Ÿ: ", future.cause());
            });
    

æ¥æ”¶å“åº”

        private static Object getResult(Promise<Object> promise, Integer messageId) throws LRPCTimeOutException {
            try {
                // è¶…æ—¶ç­‰å¾…
                if (promise.await(5, TimeUnit.SECONDS)) {
                    if (promise.isSuccess()) {
                        return promise.getNow();
                    } else {
                        throw new RuntimeException(promise.cause());
                    }
                } else {
                    throw new LRPCTimeOutException("è¯·æ±‚è¶…æ—¶");
                }
            } catch (InterruptedException e) {
                throw new RuntimeException("æ“ä½œè¢«ä¸­æ–­", e);
            } finally {
                // ç¡®ä¿ promise è¢«ç§»é™¤
                RpcRespHandler.removePromise(messageId);
            }
        }
    

4 å…³é—­è¿æ¥
------

å…³é—­è¿æ¥ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åœ¨å®Œæˆè¯·æ±‚å’Œå“åº”åï¼Œä¼šæŠŠè¿æ¥æ”¾å›è¿æ¥æ± ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„è°ƒç”¨ï¼Œç­‰è¿æ¥æ± å…³é—­æ—¶ï¼Œä¼šå…³é—­è¿æ¥ï¼ŒæœåŠ¡ç«¯æ„Ÿåº”åˆ°è¿æ¥å…³é—­ï¼Œä¼šå…³é—­è¿æ¥ã€‚

æ€ä¹ˆå°†è™šæ‹Ÿçº¿ç¨‹å’ŒNettyç»“åˆèµ·æ¥
=================

åˆ†æ
--

å‰é¢æˆ‘ä»¬è¯´è¿‡ï¼Œè™šæ‹Ÿçº¿ç¨‹é€‚åˆé«˜å¹¶å‘ã€IOå¯†é›†å‹çš„åœºæ™¯ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œæé«˜æ€§èƒ½ã€‚

çœ‹ä¸€ä¸‹nettyçš„æœåŠ¡ç«¯ç½‘ç»œé€šä¿¡çš„æ¶æ„ç®€å›¾ï¼š

![](https://img2024.cnblogs.com/blog/3585828/202501/3585828-20250109163154562-721931873.png)

åœ¨nettyä¸­ï¼Œä¸€ä¸ªNioEventLoopä¸­æœ‰ä¸€ä¸ªSelector,ä¸€ä¸ªSelectorå¯ä»¥æ³¨å†Œå¤šä¸ªChannelï¼Œä¸€ä¸ªChannelå¯¹åº”ä¸€ä¸ªè¿æ¥ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥ï¼Œè¿™å°±æ˜¯nettyçš„é«˜æ€§èƒ½çš„åŸå› ã€‚  
åœ¨æ¯æ¬¡å¾ªç¯ä¸­ï¼ŒSelectorå°±ä¼šé˜»å¡ç›‘å¬Channelçš„äº‹ä»¶ï¼Œå½“æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±ä¼šå¤„ç†è¿™ä¸ªäº‹ä»¶ã€‚  
æ‰€ä»¥åœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡ï¼Œå½±å“ç€Selectorçš„æ•°é‡ï¼Œå½±å“ç€Channelçš„æ•°é‡ï¼Œä½†æ˜¯åœ¨ä¼ ç»Ÿçš„çº¿ç¨‹ä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥è¿™å°±é™åˆ¶äº†Selectorçš„æ•°é‡ï¼Œå½±å“ç€Channelçš„æ•°é‡ï¼Œå½±å“ç€æ€§èƒ½ï¼Œ  
æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè™šæ‹Ÿçº¿ç¨‹å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œä¸”è™šæ‹Ÿçº¿ç¨‹ä¼šåœ¨å…¶ä¸­ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹é˜»å¡æ—¶ï¼Œä¼šåˆ‡æ¢åˆ°å…¶ä»–è™šæ‹Ÿçº¿ç¨‹ï¼Œä¸”æ²¡æœ‰ç³»ç»Ÿçº§åˆ«çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ‰€ä»¥å¯ä»¥å¸¦æ¥æ›´é«˜çš„æ€§èƒ½ã€‚  
æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯æ”¹å˜workerGroupçš„çº¿ç¨‹æ¨¡å‹ï¼Œä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æ¥ä»£æ›¿workerGroupé‡Œçš„ä¼ ç»Ÿçš„çº¿ç¨‹ã€‚

å®ç°
--

æ ¹æ®nettyçš„NioEventGroupçš„æºç ï¼Œçº¿ç¨‹æ¥è‡ªä¸‰ä¸ªåœ°æ–¹ï¼š

1.  æ„é€ å‡½æ•°çš„å…¥å‚çš„çº¿ç¨‹å·¥å‚ï¼›
2.  æ„é€ å‚æ•°çš„å…¥å‚çš„executorï¼›
3.  çˆ¶ç±»io.netty.channel.MultithreadEventLoopGroup#newDefaultThreadFactory()æ–¹æ³•è¿”å›çš„çº¿ç¨‹å·¥å‚ï¼›  
    è¿™é‡Œæˆ‘ä»¬ä»¥é‡å†™çˆ¶ç±»çš„newDefaultThreadFactory()æ–¹æ³•ä¸ºä¾‹ï¼Œæ¥å®ç°è™šæ‹Ÿçº¿ç¨‹ã€‚

        private NioEventLoopGroup getWorker() {
            final var workerMax = lrpcProperties.getServer().getWorkerMax();
            // åˆ›å»ºworkerGroup
            return new NioEventLoopGroup(workerMax) {
                // ç›´æ¥åœ¨åˆ›å»ºçš„æ—¶å€™é‡å†™newDefaultThreadFactory()æ–¹æ³•
                @Override
                protected ThreadFactory newDefaultThreadFactory() {
                    return new VirtualThreadFactory(NioEventLoopGroup.class, Thread.MAX_PRIORITY);
                }
            };
        }
    
    // è¿™é‡Œæ˜¯é‡å†™çš„ThreadFactory
    public class VirtualThreadFactory extends DefaultThreadFactory {
       public VirtualThreadFactory(Class<?> poolType, int priority) {
          super(poolType, priority);
       }
    
       @Override
       protected Thread newThread(Runnable r, String name) {
          // è¿™é‡Œä½¿ç”¨FastThreadLocalThreadï¼Œæ˜¯å› ä¸ºFastThreadLocalThreadæ˜¯nettyæä¾›çš„ä¸€ä¸ªçº¿ç¨‹,é‡Œé¢çš„æ–¹æ³•æœ‰äº›åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç›´æ¥ç»§æ‰¿å®ƒï¼Œç„¶åé‡å†™start()æ–¹æ³•
          return new FastThreadLocalThread(threadGroup, r, name){
             // è¿™é‡Œçš„Thread.ofVirtual().unstarted(this)æ˜¯åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹
             @Override
             public void start() {
                final var unstarted = Thread.ofVirtual().unstarted(this);
                unstarted.setName(this.getName());
                unstarted.start();
             }
          };
       }
    }
    

æ€»ç»“
==

æœ¬æ¬¡æˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„RPCæ¡†æ¶ï¼Œä½¿ç”¨äº†nettyä½œä¸ºåº•å±‚é€šä¿¡æ¡†æ¶ï¼Œä½¿ç”¨äº†zookeeperä½œä¸ºæœåŠ¡å‘ç°å’Œæ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨äº†è™šæ‹Ÿçº¿ç¨‹ä»£æ›¿æœåŠ¡ç«¯çš„workerGroupçš„çº¿ç¨‹æ¨¡å‹ï¼Œæ‰©å±•äº†å¯ç®¡æ§çš„Selectorçš„æ•°é‡ï¼Œä¸”åœ¨çº¿ç¨‹çš„åˆ‡æ¢ä¸Šï¼Œæ²¡æœ‰ç³»ç»Ÿçº§åˆ«çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæé«˜äº†æ€§èƒ½ã€‚

è¿™é‡Œåªæ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼Œå®é™…çš„RPCæ¡†æ¶è¿˜æœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šç†”æ–­ã€é™æµã€ç›‘æ§ç­‰ç­‰ï¼Œè¿™äº›åŠŸèƒ½å¯ä»¥æ ¹æ®å®é™«çš„éœ€æ±‚æ¥å®ç°ï¼Œè€Œä¸”åœ¨å®é™…çš„å®ç°è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ‰©å±•ã€çº¿ç¨‹å®‰å…¨é—®é¢˜ç­‰ç­‰ï¼Œéƒ½å€¼å¾—æˆ‘ä»¬å»æ·±å…¥ç ”ç©¶ã€‚  
è¿™é‡Œåˆ†äº«ä¸€ä¸‹æˆ‘çš„å®ç°çš„ä»£ç ï¼Œéº»çƒ¦è€å“¥ä»¬å¸®å¿™ç‚¹ä¸ªstar ğŸ˜­ ï¼Œè°¢è°¢ï¼æœ‰é—®é¢˜å¯ä»¥ç•™è¨€ï¼Œæˆ‘ä¼šåœ¨ç¬¬ä¸€æœ‰ç©ºé—²çš„æ—¶é—´å›å¤ã€‚  
é¡¹ç›®åœ°å€ï¼š[JGZHAN/lrpc æˆ³è¿™é‡Œå»ç‚¹star](https://github.com/JGZHAN/lrpc)  
![](https://img2024.cnblogs.com/blog/3585828/202501/3585828-20250109163147359-568507183.png)