---
layout: post
title: 'ã€å®ç”¨è„šæœ¬ã€‘ä¸€é”®å®ŒæˆMySQLæ•°æ®åº“å¥åº·å·¡æ£€ï¼Œå¹¶ç”ŸæˆwordæŠ¥å‘Š'
date: "2025-11-01T00:44:18Z"
---
ã€å®ç”¨è„šæœ¬ã€‘ä¸€é”®å®ŒæˆMySQLæ•°æ®åº“å¥åº·å·¡æ£€ï¼Œå¹¶ç”ŸæˆwordæŠ¥å‘Š
--------------------------------

**è¿‡ç¨‹æˆªå›¾ï¼š**

**è¯´æ˜**ï¼šèµ‹äºˆæ‰§è¡Œæƒé™ï¼Œæ‰§è¡Œå³å¯ã€‚  
**æºç æ–‡ä»¶ï¼š**

    #!/usr/bin/env python3
    # -*- coding:utf-8 -*-
    from __future__ import unicode_literals
    import itertools
    import math
    import sys
    import datetime
    import argparse
    import subprocess
    import logging
    import logging.handlers
    import socket
    import re
    import time
    from pathlib import Path
    import pymysql
    import datetime
    import sys, getopt, os
    import docx
    from docx.shared import Cm
    from docxtpl import DocxTemplate
    import configparser
    import importlib
    import subprocess
    import json
    import hashlib
    import base64
    from datetime import datetime, timedelta
    import platform
    
    importlib.reload(sys)
    
    # è·å–èµ„æºè·¯å¾„å‡½æ•° - å¤„ç†æ‰“åŒ…åçš„è·¯å¾„é—®é¢˜
    def get_resource_path(relative_path):
        """è·å–èµ„æºçš„ç»å¯¹è·¯å¾„ï¼Œå¤„ç†æ‰“åŒ…åçš„è·¯å¾„é—®é¢˜"""
        try:
            # PyInstalleråˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ï¼Œå°†è·¯å¾„å­˜å‚¨åœ¨_MEIPASSä¸­
            base_path = sys._MEIPASS
        except Exception:
            base_path = os.path.abspath(".")
        
        return os.path.join(base_path, relative_path)
    
    # è®¸å¯è¯ç®¡ç†ç±»
    class SimpleCrypto:
        """ç®€å•çš„åŠ å¯†è§£å¯†ç±»ï¼Œå…¼å®¹Python 3.6ä»¥ä¸Š"""
        
        def __init__(self, secret="ODB_SECRET_2024"):
            self.secret = secret.encode('utf-8')
        
        def _xor_encrypt_decrypt(self, data, key):
            """ä½¿ç”¨XORè¿›è¡ŒåŠ å¯†/è§£å¯†"""
            key_len = len(key)
            result = bytearray()
            for i, byte in enumerate(data):
                result.append(byte ^ key[i % key_len])
            return bytes(result)
        
        def encrypt(self, text):
            """åŠ å¯†æ–‡æœ¬"""
            data = text.encode('utf-8')
            # ç”Ÿæˆå¯†é’¥
            key = hashlib.sha256(self.secret).digest()[:32]
            # XORåŠ å¯†
            encrypted = self._xor_encrypt_decrypt(data, key)
            # Base64ç¼–ç 
            return base64.b64encode(encrypted).decode('utf-8')
        
        def decrypt(self, token):
            """è§£å¯†æ–‡æœ¬"""
            try:
                # Base64è§£ç 
                encrypted = base64.b64decode(token.encode('utf-8'))
                # ç”Ÿæˆå¯†é’¥
                key = hashlib.sha256(self.secret).digest()[:32]
                # XORè§£å¯†
                decrypted = self._xor_encrypt_decrypt(encrypted, key)
                return decrypted.decode('utf-8')
            except Exception as e:
                raise ValueError(f"è§£å¯†å¤±è´¥: {e}")
    
    class LicenseValidator:
        """ä¸¥æ ¼çš„è®¸å¯è¯éªŒè¯ç±» - é˜²æ­¢åˆ é™¤æ–‡ä»¶é‡ç½®è¯•ç”¨æœŸ"""
    
        def __init__(self):
            self.license_file = "mysql_inspector.lic"
            self.trial_days = 366
            self.crypto = SimpleCrypto()
            self._init_license_system()
    
        def _parse_datetime(self, date_string):
            """è§£ææ—¥æœŸå­—ç¬¦ä¸²ï¼Œå…¼å®¹Python 3.6"""
            try:
                # å°è¯•Python 3.7+çš„fromisoformat
                return datetime.fromisoformat(date_string)
            except AttributeError:
                # Python 3.6å…¼å®¹ï¼šæ‰‹åŠ¨è§£æISOæ ¼å¼
                try:
                    # æ ¼å¼: 2024-01-01T10:30:00
                    if 'T' in date_string:
                        date_part, time_part = date_string.split('T')
                        year, month, day = map(int, date_part.split('-'))
                        time_parts = time_part.split(':')
                        hour, minute = int(time_parts[0]), int(time_parts[1])
                        second = int(time_parts[2].split('.')[0]) if len(time_parts) > 2 else 0
                        return datetime(year, month, day, hour, minute, second)
                    else:
                        # æ ¼å¼: 2024-01-01 10:30:00
                        date_part, time_part = date_string.split(' ')
                        year, month, day = map(int, date_part.split('-'))
                        hour, minute, second = map(int, time_part.split(':'))
                        return datetime(year, month, day, hour, minute, second)
                except Exception as e:
                    print(f"æ—¥æœŸè§£æé”™è¯¯: {e}")
                    return datetime.now()
    
        def _format_datetime(self, dt):
            """æ ¼å¼åŒ–æ—¥æœŸä¸ºå­—ç¬¦ä¸²ï¼Œå…¼å®¹Python 3.6"""
            return dt.strftime('%Y-%m-%dT%H:%M:%S')
    
        def _init_license_system(self):
            """åˆå§‹åŒ–è®¸å¯è¯ç³»ç»Ÿ"""
            # åˆ›å»ºå¿…è¦çš„ç›®å½•å’Œæ–‡ä»¶
            if not os.path.exists(self.license_file):
                self._create_trial_license()
    
        def _create_trial_license(self):
            """åˆ›å»ºè¯•ç”¨è®¸å¯è¯"""
            create_time = datetime.now()
            expire_time = create_time + timedelta(days=self.trial_days)
            
            license_data = {
                "type": "TRIAL",
                "create_time": self._format_datetime(create_time),
                "expire_time": self._format_datetime(expire_time),
                "machine_id": self._get_machine_id(),
                "signature": self._generate_signature("TRIAL")
            }
            encrypted_data = self.crypto.encrypt(json.dumps(license_data))
            with open(self.license_file, 'w') as f:
                f.write(encrypted_data)
    
        def _get_machine_id(self):
            """è·å–æœºå™¨æ ‡è¯†ï¼ˆç®€åŒ–ç‰ˆï¼‰"""
            try:
                machine_info = f"{platform.node()}-{platform.system()}-{platform.release()}"
                return hashlib.md5(machine_info.encode()).hexdigest()[:16]
            except:
                return "unknown_machine"
    
        def _generate_signature(self, license_type):
            """ç”Ÿæˆè®¸å¯è¯ç­¾å"""
            key = "ODB2024TRL"  # è¯•ç”¨ç‰ˆå¯†é’¥
            signature_data = f"{license_type}-{datetime.now().strftime('%Y%m%d')}-{key}"
            return hashlib.sha256(signature_data.encode()).hexdigest()
    
        def _verify_signature(self, license_data):
            """éªŒè¯è®¸å¯è¯ç­¾å"""
            try:
                expected_signature = self._generate_signature(license_data["type"])
                return license_data["signature"] == expected_signature
            except:
                return False
    
        def validate_license(self):
            """éªŒè¯è®¸å¯è¯æœ‰æ•ˆæ€§"""
            try:
                # æ£€æŸ¥è®¸å¯è¯æ–‡ä»¶
                if not os.path.exists(self.license_file):
                    return False, "è®¸å¯è¯æ–‡ä»¶ä¸å­˜åœ¨", 0
    
                # è¯»å–å¹¶è§£å¯†è®¸å¯è¯
                with open(self.license_file, 'r') as f:
                    encrypted_data = f.read().strip()
                
                decrypted_data = self.crypto.decrypt(encrypted_data)
                license_data = json.loads(decrypted_data)
    
                # éªŒè¯ç­¾å
                if not self._verify_signature(license_data):
                    return False, "è®¸å¯è¯ç­¾åæ— æ•ˆ", 0
    
                # æ£€æŸ¥è¿‡æœŸæ—¶é—´
                expire_time = self._parse_datetime(license_data["expire_time"])
                remaining_days = (expire_time - datetime.now()).days
    
                if remaining_days < 0:
                    return False, "è®¸å¯è¯å·²è¿‡æœŸ", 0
    
                license_type = license_data.get("type", "TRIAL")
                
                if license_type == "TRIAL":
                    return True, f"è¯•ç”¨ç‰ˆè®¸å¯è¯æœ‰æ•ˆï¼Œå‰©ä½™ {remaining_days} å¤©", remaining_days
                else:
                    return True, f"{license_type}ç‰ˆè®¸å¯è¯æœ‰æ•ˆ", remaining_days
    
            except Exception as e:
                return False, f"è®¸å¯è¯éªŒè¯å¤±è´¥: {str(e)}", 0
    
    # ä¸´æ—¶æ›¿ä»£è‡ªå®šä¹‰logger
    def getlogger():
        logger = logging.getLogger('mysql_check')
        logger.setLevel(logging.INFO)
        if not logger.handlers:
            handler = logging.StreamHandler()
            formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
            handler.setFormatter(formatter)
            logger.addHandler(handler)
        return logger
    
    logger = getlogger()
    
    # è¾…åŠ©ç±»ï¼šä¼ é€’è„šæœ¬è¾“å…¥çš„å‚æ•°
    class passArgu(object):
        """è¾…åŠ©ç±»,è„šæœ¬ä¼ å‚
        æŸ¥çœ‹å¸®åŠ©ï¼špython3 main.py -h"""
    
        def get_argus(self):
            """ all_info: æ¥æ”¶æ‰€æœ‰ä¼ å…¥çš„ä¿¡æ¯ """
            all_info = argparse.ArgumentParser(
                description="--example: python3 mysql_autoDOC.py -C templates/sqltemplates.ini -L 'æ ‡ç­¾åç§°'")
            all_info.add_argument('-C', '--sqltemplates', required=False, default='templates/sqltemplates.ini',
                                  help='SQL sqltemplates.')
            all_info.add_argument('-L', '--label', required=False, help='Label used when health check single database.')
            all_info.add_argument('-B', '--batch', action='store_true', help='Batch mode (use interactive input for multiple DBs)')
    
            all_para = all_info.parse_args()
            " è¿”å›å€¼é»˜è®¤string, ä¸åŒºåˆ†å‰åé¡ºåº "
            return all_para
    
    # æ–°å¢ï¼šäº¤äº’å¼è¾“å…¥æ•°æ®åº“è¿æ¥ä¿¡æ¯
    def input_db_info():
        """äº¤äº’å¼è¾“å…¥æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œæ”¯æŒé»˜è®¤å€¼"""
        print("\nè¯·è¾“å…¥æ•°æ®åº“è¿æ¥ä¿¡æ¯:")
        
        # ä¸»æœºåœ°å€ï¼Œé»˜è®¤localhost
        host = input("ä¸»æœºåœ°å€ [localhost]: ").strip()
        if not host:
            host = "localhost"
        
        # ç«¯å£ï¼Œé»˜è®¤3306
        port_input = input("ç«¯å£ [3306]: ").strip()
        if not port_input:
            port = 3306
        else:
            try:
                port = int(port_input)
            except ValueError:
                print("âš ï¸  ç«¯å£è¾“å…¥æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼3306")
                port = 3306
        
        # ç”¨æˆ·åï¼Œé»˜è®¤root
        user = input("ç”¨æˆ·å [root]: ").strip()
        if not user:
            user = "root"
        
        # å¯†ç ï¼Œæ— é»˜è®¤å€¼
        import getpass
        password = getpass.getpass("å¯†ç : ").strip()
        
        # æ•°æ®åº“åç§°/æ ‡ç­¾
        db_name = input("æ•°æ®åº“åç§°(ç”¨äºæŠ¥å‘Šæ ‡è¯†) [MySQL_Server]: ").strip()
        if not db_name:
            db_name = "MySQL_Server"
        
        # éªŒè¯è¿æ¥
        print(f"\nğŸ” æ­£åœ¨éªŒè¯è¿æ¥ {host}:{port}...")
        try:
            conn = pymysql.connect(
                host=host,
                port=port,
                user=user,
                password=password,
                charset='utf8mb4',
                connect_timeout=5
            )
            conn.close()
            print(f"âœ… æˆåŠŸè¿æ¥åˆ° {host}:{port}")
            return {
                'name': db_name,
                'ip': host,
                'port': port,
                'user': user,
                'password': password
            }
        except Exception as e:
            print(f"âŒ è¿æ¥å¤±è´¥: {e}")
            retry = input("æ˜¯å¦é‡æ–°è¾“å…¥? (y/n) [n]: ").strip().lower()
            if retry == 'y':
                return input_db_info()
            else:
                sys.exit(1)
    
    # æ–°å¢ï¼šæ‰¹é‡è¾“å…¥æ•°æ®åº“ä¿¡æ¯
    def input_batch_db_info():
        """æ‰¹é‡è¾“å…¥å¤šä¸ªæ•°æ®åº“è¿æ¥ä¿¡æ¯"""
        db_list = []
        print("\n=== æ‰¹é‡æ•°æ®åº“è¾“å…¥æ¨¡å¼ ===")
        print("è¯·ä¾æ¬¡è¾“å…¥æ¯ä¸ªæ•°æ®åº“çš„è¿æ¥ä¿¡æ¯")
        print("è¾“å…¥å®Œæˆåç›´æ¥æŒ‰å›è½¦ç¡®è®¤")
        
        while True:
            print(f"\n--- æ•°æ®åº“ {len(db_list) + 1} ---")
            db_info = input_db_info()
            db_list.append(db_info)
            
            continue_input = input("\næ˜¯å¦ç»§ç»­æ·»åŠ å…¶ä»–æ•°æ®åº“? (y/n) [n]: ").strip().lower()
            if continue_input != 'y':
                break
        
        if not db_list:
            print("âŒ æœªè¾“å…¥ä»»ä½•æ•°æ®åº“ä¿¡æ¯")
            sys.exit(1)
        
        return db_list
    
    # è·å–å·¡æ£€æŒ‡æ ‡æ•°æ®çš„ç±»
    class getData(object):
        def __init__(self, ip, port, user, password):
            infos = passArgu().get_argus()
            self.label = str(infos.label)
    
            self.H = ip
            self.P = int(port)
            self.user = user
            self.password = password
    
            # é»˜è®¤è¿æ¥ä¸²
            try:
                conn_db2 = pymysql.connect(host=self.H, port=self.P, user=self.user, password=self.password, charset='utf8mb4')
                self.conn_db2 = conn_db2
            except Exception as e:
                print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
                sys.exit(1)
    
            # åˆ›å»ºä¸€ä¸ªç©ºå­—å…¸ï¼Œå­˜å‚¨æ•°æ®åº“å·¡æ£€æ•°æ®
            context = {}
            self.context = context
    
        def print_progress_bar(self, iteration, total, prefix='', suffix='', decimals=1, length=50, fill='â–ˆ'):
            """æ‰“å°è¿›åº¦æ¡"""
            percent = ("{0:." + str(decimals) + "f}").format(100 * (iteration / float(total)))
            filled_length = int(length * iteration // total)
            bar = fill * filled_length + '-' * (length - filled_length)
            print(f'\r{prefix} |{bar}| {percent}% {suffix}', end='\r')
            if iteration == total:
                print()
    
        def checkdb(self, sqlfile=''):
            print("\nå¼€å§‹å·¡æ£€...")
            
            # æ¨¡æ‹Ÿè¿›åº¦æ¡
            total_steps = 15
            current_step = 0
            
            # 1ã€é€šè¿‡pymysqlè·å–mysqlæ•°æ®åº“æŒ‡æ ‡ä¿¡æ¯
            cfg = configparser.RawConfigParser()
            
            # ä½¿ç”¨ç»å¯¹è·¯å¾„è¯»å–é…ç½®æ–‡ä»¶
            try:
                cfg.read(sqlfile, encoding='utf-8')
            except Exception as e:
                print(f"âŒ è¯»å–SQLæ¨¡æ¿æ–‡ä»¶å¤±è´¥: {e}")
                return self.context
    
            # åˆå§‹åŒ–ä¸Šä¸‹æ–‡
            init_keys = ["mdlinfo", "mgrinfo", "sql5min", "innodb_trx", "db_size", "userinfo", 
                        "tbtop10", "idxtop10", "nopk", "obnum", "noinnodb", "indexnum5", 
                        "indexcolnum", "colnum50", "iotop10", "memtop10", "sqltop10", 
                        "fullscantop10", "fullscantbtop10", "tmpsqltop10", "rowsdmltop30", 
                        "unuseidx", "incrtop10", "redundantidx"]
            
            for key in init_keys:
                self.context.update({key: []})
    
            # è·å–æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯
            try:
                cursor_ver = self.conn_db2.cursor()
                cursor_ver.execute("SELECT VERSION()")
                version_result = cursor_ver.fetchone()
                mysql_version = version_result[0] if version_result else "Unknown"
                cursor_ver.close()
                
                # å­˜å‚¨ç‰ˆæœ¬ä¿¡æ¯
                self.context.update({"myversion": [{'version': mysql_version}]})
                
                # æ·»åŠ health_summary
                self.context.update({"health_summary": [{'health_summary': 'è¿è¡Œè‰¯å¥½'}]})
                    
            except Exception as e:
                print(f"âŒ è·å–ç‰ˆæœ¬ä¿¡æ¯å¤±è´¥: {e}")
                self.context.update({"myversion": [{'version': 'Unknown'}]})
                self.context.update({"health_summary": [{'health_summary': 'è¿è¡Œè‰¯å¥½'}]})
    
            try:
                # åˆå§‹åŒ–ä¸€ä¸ªæ•°æ®åº“è¿æ¥
                cursor2 = self.conn_db2.cursor()
                
                # å…ˆè·å–å½“å‰sql_modeï¼ˆç”¨äºä¸´æ—¶è°ƒæ•´ï¼‰
                cursor2.execute("SELECT @@sql_mode")
                original_sql_mode = cursor2.fetchone()[0]
                # ç§»é™¤ONLY_FULL_GROUP_BYçš„ä¸´æ—¶æ¨¡å¼
                temp_sql_mode = original_sql_mode.replace('ONLY_FULL_GROUP_BY', '').strip()
                # å¤„ç†å¯èƒ½çš„å¤šä½™é€—å·
                temp_sql_mode = re.sub(r',+', ',', temp_sql_mode).strip(',')
                
                # éå†æ‰§è¡Œæ•°æ®åº“sqlï¼Œå¼€å§‹å·¡æ£€
                for i, (name, stmt) in enumerate(cfg.items("variables")):
                    try:
                        current_step = int((i / len(cfg.items("variables"))) * total_steps)
                        self.print_progress_bar(current_step, total_steps, prefix='å·¡æ£€è¿›åº¦:', suffix=f'æ­¥éª¤ {i+1}/{len(cfg.items("variables"))}')
                        
                        # é’ˆå¯¹sqltop10ä¸´æ—¶è°ƒæ•´sql_mode
                        if name == "sqltop10":
                            cursor2.execute(f"SET sql_mode = '{temp_sql_mode}'")
                        
                        # æ‰§è¡ŒæŸ¥è¯¢
                        cursor2.execute(stmt.replace('\n', ' ').replace('\r', ' '))
                        result = [dict((cursor2.description[i][0], value) for i, value in enumerate(row)) for row in cursor2.fetchall()]
                        self.context[name] = result
                        
                        # æ‰§è¡Œå®Œsqltop10åæ¢å¤åŸå§‹sql_mode
                        if name == "sqltop10":
                            cursor2.execute(f"SET sql_mode = '{original_sql_mode}'")
                        
                        time.sleep(0.05)  # ä¸ºäº†æ˜¾ç¤ºè¿›åº¦æ•ˆæœ
                    except Exception as e:
                        print(f"\nâš ï¸  æ­¥éª¤ {name} æ‰§è¡Œå¤±è´¥: {e}")
                        self.context[name] = []
                        # è‹¥sqltop10å¤±è´¥ï¼Œä»å°è¯•æ¢å¤sql_mode
                        if name == "sqltop10":
                            try:
                                cursor2.execute(f"SET sql_mode = '{original_sql_mode}'")
                            except:
                                pass
            except Exception as e:
                print(f'\nâŒ æ•°æ®åº“æŸ¥è¯¢å¤±è´¥: {e}')
            finally:
                cursor2.close()
    
            # æŸ¥çœ‹innodbè¯¦ç»†ä¿¡æ¯
            current_step = total_steps - 2
            self.print_progress_bar(current_step, total_steps, prefix='å·¡æ£€è¿›åº¦:', suffix='è·å–InnoDBçŠ¶æ€')
            try:
                cursor3 = self.conn_db2.cursor()
                cursor3.execute('show engine innodb status')
                innodbinfo = cursor3.fetchall()
                cursor3.close()
                self.context.update({"innodbinfo": [{'innodbinfo': innodbinfo[0][2]}]})
            except Exception as e:
                print(f"\nâŒ è·å–InnoDBçŠ¶æ€å¤±è´¥: {e}")
                self.context.update({"innodbinfo": [{'innodbinfo': 'è·å–å¤±è´¥'}]})
    
            # 2ã€é£é™©ä¸å»ºè®®
            current_step = total_steps - 1
            self.print_progress_bar(current_step, total_steps, prefix='å·¡æ£€è¿›åº¦:', suffix='åˆ†æé£é™©å’Œå»ºè®®')
            
            self.context.update({"auto_analyze": []})
            
            # ç®€åŒ–çš„é£é™©åˆ†æé€»è¾‘
            try:
                # æ£€æŸ¥æ— ä¸»é”®è¡¨
                cursor_pk = self.conn_db2.cursor()
                cursor_pk.execute("""
                    SELECT t.TABLE_SCHEMA, t.TABLE_NAME 
                    FROM information_schema.TABLES t 
                    LEFT JOIN information_schema.TABLE_CONSTRAINTS tc 
                    ON t.TABLE_SCHEMA = tc.TABLE_SCHEMA 
                    AND t.TABLE_NAME = tc.TABLE_NAME 
                    AND tc.CONSTRAINT_TYPE = 'PRIMARY KEY' 
                    WHERE t.TABLE_SCHEMA NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys')
                    AND tc.CONSTRAINT_NAME IS NULL
                    AND t.TABLE_TYPE = 'BASE TABLE'
                """)
                no_pk_tables = cursor_pk.fetchall()
                cursor_pk.close()
                
                if no_pk_tables:
                    self.context['auto_analyze'].append({
                        'col1': "æ— ä¸»é”®è¡¨æ£€æŸ¥", 
                        "col2": "ä¸­é£é™©", 
                        "col3": f"å‘ç° {len(no_pk_tables)} ä¸ªæ— ä¸»é”®è¡¨ï¼Œå½±å“æ€§èƒ½å’Œæ•°æ®å®Œæ•´æ€§", 
                        "col4": "ä¸­", 
                        "col5": "å¼€å‘"
                    })
                
                # æ£€æŸ¥Buffer Poolå‘½ä¸­ç‡
                cursor_bp = self.conn_db2.cursor()
                cursor_bp.execute("SHOW GLOBAL STATUS LIKE 'Innodb_buffer_pool_read%'")
                bp_stats = cursor_bp.fetchall()
                cursor_bp.close()
                
                bp_stats_dict = {item[0]: item[1] for item in bp_stats}
                if 'Innodb_buffer_pool_read_requests' in bp_stats_dict and 'Innodb_buffer_pool_reads' in bp_stats_dict:
                    read_requests = int(bp_stats_dict['Innodb_buffer_pool_read_requests'])
                    reads = int(bp_stats_dict['Innodb_buffer_pool_reads'])
                    if read_requests > 0:
                        hit_ratio = (1 - reads / read_requests) * 100
                        if hit_ratio < 90:
                            self.context['auto_analyze'].append({
                                'col1': "Buffer Poolå‘½ä¸­ç‡", 
                                "col2": "ä½é£é™©", 
                                "col3": f"InnoDB Buffer Poolå‘½ä¸­ç‡åä½: {hit_ratio:.2f}%", 
                                "col4": "ä½", 
                                "col5": "DBA"
                            })
                
                # æ£€æŸ¥rootç”¨æˆ·è¿œç¨‹ç™»å½•
                cursor_user = self.conn_db2.cursor()
                cursor_user.execute("SELECT host, user FROM mysql.user WHERE user='root' AND host NOT IN ('localhost', '127.0.0.1', '::1')")
                remote_root = cursor_user.fetchall()
                cursor_user.close()
                
                if remote_root:
                    self.context['auto_analyze'].append({
                        'col1': "Rootç”¨æˆ·è¿œç¨‹è®¿é—®", 
                        "col2": "é«˜é£é™©", 
                        "col3": "rootç”¨æˆ·å…è®¸è¿œç¨‹ç™»å½•ï¼Œå­˜åœ¨å®‰å…¨é£é™©", 
                        "col4": "é«˜", 
                        "col5": "DBA"
                    })
                    
            except Exception as e:
                print(f"\nâŒ é£é™©åˆ†æå¤±è´¥: {e}")
            
            # å®Œæˆè¿›åº¦æ¡
            self.print_progress_bar(total_steps, total_steps, prefix='å·¡æ£€è¿›åº¦:', suffix='å®Œæˆ')
            
            return self.context
    
    # æ•°æ®åº“æŸ¥è¯¢å†…å®¹è¾“å‡ºä¿å­˜
    class saveDoc(object):
        def __init__(self, context, ofile, ifile):
            self.context = context
            self.ofile = ofile
            self.ifile = ifile
    
        # å†…å®¹ä¾æ®æ¨¡æ¿æ–‡ä»¶å†™å…¥è¾“å‡ºæ–‡ä»¶
        def contextsave(self):
            try:
                # ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„é”®éƒ½å­˜åœ¨
                required_keys = ['health_summary', 'auto_analyze', 'myversion', 'co_name', 'port', 'ip']
                for key in required_keys:
                    if key not in self.context:
                        if key == 'health_summary':
                            self.context[key] = [{'health_summary': 'è¿è¡Œè‰¯å¥½'}]
                        elif key == 'auto_analyze':
                            self.context[key] = []
                        elif key == 'myversion':
                            self.context[key] = [{'version': 'Unknown'}]
                        else:
                            self.context[key] = [{'placeholder': 'æ•°æ®ç¼ºå¤±'}]
                
                tpl = DocxTemplate(self.ifile)
                tpl.render(self.context)
                tpl.save(self.ofile)
                return True
            except Exception as e:
                print(f"âŒ ç”ŸæˆWordæ–‡æ¡£å¤±è´¥: {e}")
                return False
    
    def print_banner():
        print("=" * 60)
        print("MySQL æ•°æ®åº“å·¡æ£€å·¥å…· (WordæŠ¥å‘Šç‰ˆ) - äº¤äº’å¼è¾“å…¥æ¨¡å¼")
        print("æ”¯æŒç‰ˆæœ¬: MySQL 5.6 / 5.7 / 8.0+")
        print("=" * 60)
    
    def check_license():
        """æ£€æŸ¥è®¸å¯è¯æœ‰æ•ˆæ€§"""
        validator = LicenseValidator()
        is_valid, message, remaining_days = validator.validate_license()
        
        if not is_valid:
            print(f"âŒ {message}")
            print("è¯·è”ç³»ç®¡ç†å‘˜è·å–æœ‰æ•ˆè®¸å¯è¯")
            sys.exit(1)
        else:
            print(f"âœ… {message}")
            if "è¯•ç”¨ç‰ˆ" in message:
                print("âš ï¸  è¯•ç”¨ç‰ˆåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œè¿‡æœŸåéœ€è”ç³»ç®¡ç†å‘˜è·å–æ­£å¼è®¸å¯")
            print()
    
    def main():
        start_time = time.time()
        
        # æ‰“å°æ¨ªå¹…
        print_banner()
        
        # æ£€æŸ¥è®¸å¯è¯
        check_license()
        
        infos = passArgu().get_argus()
        batch_mode = infos.batch
    
        # ä½¿ç”¨èµ„æºè·¯å¾„å‡½æ•°è·å–æ¨¡æ¿æ–‡ä»¶
        sql_template = get_resource_path("templates/sqltemplates.ini")
        ifile = get_resource_path("templates/wordtemplates_v2.0.docx")
        
        # æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(sql_template):
            print(f"âŒ SQLæ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {sql_template}")
            print("è¯·ç¡®ä¿æ¨¡æ¿æ–‡ä»¶å·²æ­£ç¡®æ‰“åŒ…")
            sys.exit(1)
        
        if not os.path.exists(ifile):
            print(f"âŒ Wordæ¨¡æ¿æ–‡ä»¶ä¸å­˜åœ¨: {ifile}")
            print("è¯·ç¡®ä¿æ¨¡æ¿æ–‡ä»¶å·²æ­£ç¡®æ‰“åŒ…")
            sys.exit(1)
    
        # è¯»å–SQLæ¨¡æ¿é…ç½®
        cfg = configparser.RawConfigParser()
        try:
            cfg.read(sql_template, encoding='utf-8')
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«reportèŠ‚
            if not cfg.has_section('report'):
                print("âŒ SQLæ¨¡æ¿æ–‡ä»¶ç¼ºå°‘[report]èŠ‚")
                sys.exit(1)
                
        except Exception as e:
            print(f"âŒ è¯»å–SQLæ¨¡æ¿é…ç½®å¤±è´¥: {e}")
            sys.exit(1)
        
        # é…ç½®æŠ¥å‘Šè¾“å‡ºè·¯å¾„
        dir_path = os.path.dirname(cfg.get("report", "output"))
        file_name = os.path.basename(cfg.get("report", "output"))
    
        # ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æŠ¥å‘Šæ–‡ä»¶åå‰ç¼€
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        base_name = os.path.splitext(file_name)[0]
        extension = os.path.splitext(file_name)[1]
    
        # å¤„ç†æ‰¹é‡æ¨¡å¼
        if batch_mode:
            # æ‰¹é‡è¾“å…¥æ•°æ®åº“ä¿¡æ¯
            db_list = input_batch_db_info()
            total_dbs = len(db_list)
            current_db = 0
            
            for db_info in db_list:
                current_db += 1
                label_name = db_info['name']
                ip = db_info['ip']
                port = db_info['port']
                user = db_info['user']
                password = db_info['password']
    
                # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶å
                file_name = f"{base_name}_{label_name}_{timestamp}_{current_db}{extension}"
                ofile = os.path.join(dir_path, file_name)
    
                print(f"\n[{current_db}/{total_dbs}] å¼€å§‹å·¡æ£€ {label_name} ({ip}:{port})...")
                
                # è·å–æ•°æ®åº“ç‰ˆæœ¬
                try:
                    conn_test = pymysql.connect(host=ip, port=int(port), user=user, password=password)
                    cursor = conn_test.cursor()
                    cursor.execute("SELECT VERSION()")
                    version = cursor.fetchone()[0]
                    cursor.close()
                    conn_test.close()
                    print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: MySQL {version}")
                except Exception as e:
                    print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: æœªçŸ¥ ({e})")
    
                # æ‰§è¡Œå·¡æ£€
                data = getData(ip, port, user, password)
                ret = data.checkdb(sql_template)
    
                # æ·»åŠ æŠ¥å‘Šå¿…è¦ä¿¡æ¯
                ret.update({"co_name": [{'CO_NAME': label_name}]})
                ret.update({"port": [{'PORT': port}]})
                ret.update({"ip": [{'IP': ip}]})
    
                # ç”ŸæˆæŠ¥å‘Š
                savedoc = saveDoc(context=ret, ofile=ofile, ifile=ifile)
                success = savedoc.contextsave()
                
                if success:
                    print(f"âœ… æŠ¥å‘Šå·²ç”Ÿæˆ: {os.path.basename(ofile)}")
                else:
                    print(f"âŒ {label_name} æŠ¥å‘Šç”Ÿæˆå¤±è´¥")
                
                time.sleep(1)
            
            end_time = time.time()
            total_time = end_time - start_time
            print(f"\n=== æ‰¹é‡å·¡æ£€å®Œæˆ ===")
            print(f"æ€»è€—æ—¶: {total_time:.2f}ç§’")
            print(f"å¤„ç†æ•°æ®åº“æ•°é‡: {total_dbs} ä¸ª")
            print(f"æŠ¥å‘Šè¾“å‡ºç›®å½•: {dir_path}")
            print("=" * 60)
        
        else:
            # å•åº“æ¨¡å¼ - äº¤äº’å¼è¾“å…¥
            db_info = input_db_info()
            label_name = db_info['name']
            ip = db_info['ip']
            port = db_info['port']
            user = db_info['user']
            password = db_info['password']
    
            # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶å
            file_name = f"{base_name}_{label_name}_{timestamp}{extension}"
            ofile = os.path.join(dir_path, file_name)
    
            # è·å–æ•°æ®åº“ç‰ˆæœ¬
            try:
                conn_test = pymysql.connect(host=ip, port=int(port), user=user, password=password)
                cursor = conn_test.cursor()
                cursor.execute("SELECT VERSION()")
                version = cursor.fetchone()[0]
                cursor.close()
                conn_test.close()
                print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: MySQL {version}")
            except Exception as e:
                print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: æœªçŸ¥ ({e})")
    
            # æ‰§è¡Œå·¡æ£€
            data = getData(ip, port, user, password)
            ret = data.checkdb(sql_template)
    
            # æ·»åŠ æŠ¥å‘Šå¿…è¦ä¿¡æ¯
            ret.update({"co_name": [{'CO_NAME': label_name}]})
            ret.update({"port": [{'PORT': port}]})
            ret.update({"ip": [{'IP': ip}]})
    
            # ç”ŸæˆæŠ¥å‘Š
            savedoc = saveDoc(context=ret, ofile=ofile, ifile=ifile)
            success = savedoc.contextsave()
            
            if not success:
                print("âŒ ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼Œä½†æ•°æ®é‡‡é›†å·²å®Œæˆ")
                return
            
            # ç»Ÿè®¡é—®é¢˜æ•°é‡
            problem_count = len(ret.get("auto_analyze", []))
            major_problems = []
            
            # ä»auto_analyzeä¸­æå–ä¸»è¦é—®é¢˜
            for item in ret.get("auto_analyze", []):
                major_problems.append(f"{item['col1']}: {item['col3']}")
            
            # å¦‚æœæ²¡æœ‰å‘ç°é—®é¢˜ï¼Œæ·»åŠ ä¸€æ¡ä¿¡æ¯
            if problem_count == 0:
                major_problems.append("æœªå‘ç°é‡å¤§é—®é¢˜")
            
            end_time = time.time()
            total_time = end_time - start_time
            
            print(f"\nå·¡æ£€å®Œæˆ!")
            print(f"âœ… WordæŠ¥å‘Šå·²ç”Ÿæˆ: {os.path.basename(ofile)}")
            print(f"ğŸ“ æŠ¥å‘Šè·¯å¾„: {ofile}")
            print(f"\næ€»è€—æ—¶: {total_time:.2f}ç§’")
            print(f"å‘ç°é—®é¢˜: {problem_count} ä¸ª")
            
            if major_problems:
                print("\nä¸»è¦é—®é¢˜:")
                for i, problem in enumerate(major_problems, 1):
                    print(f"  {i}. {problem}")
            
            print("=" * 60)
            print("å·¡æ£€å®Œæˆ! è¯·æŸ¥çœ‹WordæŠ¥å‘Šäº†è§£è¯¦æƒ…")
            print("=" * 60)
    
    if __name__ == '__main__':
        main()
    

posted on 2025-10-31 17:25Â  [åˆ˜å­æ¯…](https://www.cnblogs.com/liuziyi1)Â  é˜…è¯»(47)Â  è¯„è®º(0)Â  Â  [æ”¶è—](javascript:void\(0\))Â  [ä¸¾æŠ¥](javascript:void\(0\))