---
layout: post
title: 'fs1.6-fs1.10代码移植方案'
date: "2025-12-13T00:42:02Z"
---
fs1.6-fs1.10代码移植方案
==================

FreeSWITCH 1.10.x 版本发布说明初步分析
============================

FreeSWITCH 1.10.x 系列版本引入了多项重大变更，以下是初步识别的关键点：

*   `pgqsql` 模块化：从FreeSWITCH核心中移出，成为独立的 `mod_pgsql` 模块。如果AS模块依赖于 `pgqsql` 的核心功能，需要适配新的模块化方式。
*   `SpanDSP` 和 `sofia-sip` 移除：这两个依赖库已从核心中移出。如果AS模块直接或间接使用了这些库的功能，需要寻找替代方案或重新引入这些库作为独立组件。
*   默认行为变更：例如，不再跳过恢复时的通告类型应用、SRTP错误不再挂断呼叫、最大接收请求数限制、 `auth-messages` 和 `auth-subscriptions` 默认启用等。这些行为变更可能影响AS模块的逻辑，需要进行测试和调整。
*   API 变更：例如， `switch_curl_process_form_post_params` 函数被 `switch_curl_process_mime` 替代。这表明在 `switch_CURL` 相关的API上存在不兼容的修改，AS模块中如果使用了旧的API，需要进行更新。
*   操作系统和库支持：Debian 10 Buster 和 CentOS 支持被移除，同时增加了对Debian 11/12、OpenSSL 3 和 FFmpeg5 的支持。这可能影响编译环境和依赖库的选择。
*   安全修复和稳定性改进：新版本包含了重要的安全修复和稳定性改进，升级将带来更好的系统健壮性。

**下一步计划**：

1.  查找 FreeSWITCH 1.6.x 的发布说明，以便进行更全面的版本差异对比。
2.  深入分析 1.10.x 各个小版本中的具体变更，特别是“Breaking changes”部分，以识别所有可能影响AS模块的API和行为变化。

FreeSWITCH 1.6.x 和 1.10.x 版本差异分析
================================

FreeSWITCH 从 1.6.19 升级到 1.10.12 是一个跨越多个主要版本的升级，这意味着除了小版本间的增量变化外，还存在一些架构和API层面的重大调整。以下是根据已收集到的信息，对这两个版本之间差异的详细分析，以及这些差异可能对现有 AS 模块造成的影响。

1\. FreeSWITCH 核心和 API 变化
-------------------------

### 1.1. `pgqsql` 模块化为 `mod_pgsql`

在 FreeSWITCH 1.10.x 版本中，原先集成在核心中的 `pgqsql` 功能被剥离，并作为一个独立的模块 `mod_pgsql` 提供。这意味着如果 AS 模块直接使用了 `pgqsql` 相关的内部接口或宏定义，这些代码将不再有效。移植时需要：

*   **检查依赖**：AS 模块中所有与 PostgreSQL 数据库交互的代码，特别是那些直接调用 FreeSWITCH 核心中 `pgqsql` 相关函数的代码。
*   **适配新模块**：将这些调用修改为使用 `mod_pgsql` 提供的公共 API。这可能涉及到头文件的包含、函数签名的变化以及初始化/销毁流程的调整。
*   **配置变更**：相关的数据库连接配置可能也需要从核心配置中迁移到 `mod_pgsql` 的独立配置中。

### 1.2. `SpanDSP` 和 `sofia-sip` 移除

FreeSWITCH 1.10.x 移除了对 `SpanDSP` 和 `sofia-sip` 这两个第三方库的直接依赖。这两个库在 FreeSWITCH 中扮演着重要角色：

*   `SpanDSP`：主要用于传真 (T.38)、调制解调器仿真、回声消除等数字信号处理功能。如果 `mod_as_fax` 或其他 AS 模块使用了 `SpanDSP` 提供的特定功能，将需要：

*   **引入外部依赖**：手动将 `SpanDSP` 作为外部依赖引入项目，并确保其编译和链接到 AS 模块中。
*   **寻找替代方案**：如果可能，评估 FreeSWITCH 1.10.x 中是否有替代的内置功能或模块可以实现相同的目的，以减少外部依赖。

*   `sofia-sip`：是 FreeSWITCH 的 SIP 协议栈实现。虽然 FreeSWITCH 仍然支持 SIP，但核心对 `sofia-sip` 的直接依赖被移除，可能意味着内部 SIP 相关的 API 或数据结构发生了变化。`mod_as_sip`、`mod_as_sipphone` 等 SIP 相关模块需要特别关注：

*   **SIP 接口检查**：检查所有与 SIP 协议栈交互的 AS 模块代码，特别是那些直接操作 `sofia-sip` 内部结构或调用其私有函数的代码。
*   **适配 FreeSWITCH 新的 SIP 抽象层**：FreeSWITCH 可能会提供一套新的、更抽象的 SIP 接口，AS 模块需要适配这些新接口。

### 1.3. `switch_curl_process_form_post_params` API 变更

FreeSWITCH 1.10.10 版本中，`switch_curl_process_form_post_params` 函数被 `switch_curl_process_mime` 替代。这表明在处理 HTTP POST 请求时，特别是涉及到多部分表单数据 (multipart/form-data) 的场景，API 发生了变化。如果 AS 模块（例如 `mod_as_callcenter`、`mod_as_event` 或其他与外部 HTTP 服务交互的模块）使用了旧的 `curl` 相关 API，则需要：

*   **更新** `curl` **调用**：将所有对 `switch_curl_process_form_post_params` 的调用替换为 `switch_curl_process_mime`。
*   **适配新的 MIME 处理方式**：理解 `switch_curl_process_mime` 的新参数和使用方式，可能需要调整数据准备和传递的逻辑。

### 1.4. 宏定义和接口依赖

FreeSWITCH 核心的升级通常伴随着大量内部宏定义和接口的调整。AS 模块中使用了“fs的公共mod接口实现，使用了apr库的部分功能和switch接口的部分功能，宏定义和接口都有依赖”，这将是移植工作的重点和难点：

*   `switch_` 前缀接口：所有以 `switch_` 开头的 FreeSWITCH 核心接口都需要仔细检查其在 1.10.x 版本中的签名、行为和可用性。特别是那些在 1.6.x 中是公共的，但在 1.10.x 中可能被标记为内部或已移除的接口。
*   APR 库：虽然 APR (Apache Portable Runtime) 库相对稳定，但在 FreeSWITCH 内部使用 APR 的方式可能有所变化，或者 FreeSWITCH 对 APR 的版本依赖可能升级。需要确保 AS 模块使用的 APR 功能与 FreeSWITCH 1.10.x 所依赖的 APR 版本兼容。
*   宏定义：FreeSWITCH 内部的宏定义经常用于简化代码和提供平台抽象。这些宏定义在不同版本间可能被修改、移除或新增。AS 模块中所有使用的 FreeSWITCH 宏定义都需要进行兼容性检查。
*   数据结构：FreeSWITCH 内部的数据结构（如 `switch_core_session_t`、`switch_channel_t`、`switch_event_t` 等）的成员可能会发生变化，例如添加、删除或修改字段。如果 AS 模块直接访问这些数据结构的内部成员，则需要进行修改。

2\. 行为和配置变化
-----------

### 2.1. 默认行为变更

FreeSWITCH 1.10.x 引入了一些默认行为的改变，这些改变可能在不修改代码的情况下影响 AS 模块的运行时行为：

*   恢复时通告类型应用：默认不再跳过。如果 AS 模块依赖于此行为，可能需要调整逻辑或配置。
*   SRTP 错误处理：SRTP 错误不再默认挂断呼叫。这对于处理安全实时传输协议的模块（如 `mod_as_sip`）来说是一个重要变化，可能需要调整错误处理逻辑。
*   请求速率限制：最大接收请求数限制为 1000/秒。如果 AS 模块处理大量并发请求，需要评估此限制的影响。
*   `auth-messages` 和 `auth-subscriptions` 默认启用：这可能影响消息和订阅相关的模块（如 `mod_as_presence`、`mod_as_event`）的认证逻辑。

### 2.2. 编译和运行环境变化

*   操作系统支持：FreeSWITCH 1.10.x 移除了对 Debian 8 和 CentOS 的支持，并增加了对 Debian 11/12 的支持。这意味着编译和运行环境需要升级到 FreeSWITCH 1.10.x 支持的操作系统版本。
*   依赖库版本：对 OpenSSL 3 和 FFmpeg5 的支持意味着相关的加密和媒体处理库需要升级到兼容版本。AS 模块如果直接或间接依赖这些库，需要确保其与新版本兼容。
*   构建系统：构建系统可能也有所改进，使得贡献和编译模块更加容易。这可能简化 AS 模块的编译过程，但也可能需要对 `Makefile` 或 `autotools` 配置进行调整。

3\. 潜在的兼容性问题总结
--------------

综合来看，从 FreeSWITCH 1.6.19 升级到 1.10.12，AS 模块面临的主要兼容性挑战包括：

*   API 不兼容：核心 API 和模块 API 的签名、参数、返回值或行为发生变化。
*   内部结构访问：直接访问 FreeSWITCH 内部数据结构成员的代码可能失效。
*   宏定义变化：依赖于特定宏定义的代码可能需要更新。
*   外部库依赖：`SpanDSP` 和 `sofia-sip` 的移除要求 AS 模块自行管理这些依赖或寻找替代。
*   默认行为差异：系统默认行为的改变可能导致 AS 模块逻辑不符合预期。
*   编译环境和依赖库版本：需要升级操作系统和相关库以满足 1.10.x 的要求。

**建议**：在进行代码移植之前，务必详细阅读 FreeSWITCH 1.8.x 和 1.10.x 之间的所有发布说明和 `ChangeLog`，特别是“Breaking Changes”部分，以获取最全面的信息。同时，准备一个干净的 FreeSWITCH 1.10.12 开发环境，以便进行测试和调试。

4\. AS 模块依赖分析
-------------

由于无法直接访问您提供的 AS 模块的源代码，本节将提供一个通用的分析框架和建议，帮助您识别 AS 模块对 FreeSWITCH 核心、APR 库以及其他 FreeSWITCH 模块的依赖关系。此分析是制定具体移植方案的关键步骤。

### 4.1. 分析目标

*   **识别 FreeSWITCH 核心 API 依赖**：AS 模块中使用了哪些 `switch_` 开头的函数、结构体和宏定义。
*   **识别 APR 库依赖**：AS 模块中使用了哪些 `apr_` 开头的函数、结构体和宏定义。
*   **识别其他 FreeSWITCH 模块依赖**：AS 模块是否直接或间接调用了其他 FreeSWITCH 模块（例如 `mod_sofia`、`mod_event_socket` 等）的公共接口或内部功能。
*   **识别配置依赖**：AS 模块是否读取了 FreeSWITCH 的全局配置或特定模块的配置。
*   **识别事件依赖**：AS 模块是否订阅或发布了特定的 FreeSWITCH 事件。

### 4.2. 分析方法

以下是一些建议的分析方法，您可以根据实际情况选择或组合使用：

#### 4.2.1. 代码审查 (Code Review)

这是最直接也是最耗时的方法，但能提供最详细的依赖信息。对于每个 AS 模块，进行以下检查：

*   **头文件包含**：检查 `.c` 和 `.h` 文件中包含的头文件。例如，`switch.h`、`switch_core.h`、`switch_channel.h`、`apr.h` 等。这些头文件直接指示了模块所依赖的 FreeSWITCH 或 APR 组件。
*   **函数调用**：搜索代码中所有以 `switch_` 和 `apr_` 开头的函数调用。记录这些函数的名称和其所属的模块或库。特别关注那些在 FreeSWITCH 1.10.x 版本中可能已更改或移除的函数（参考上一节的版本差异分析）。
*   **结构体和宏定义**：搜索代码中使用的 FreeSWITCH 核心结构体（如 `switch_core_session_t`、`switch_channel_t`、`switch_event_t`）和宏定义。检查这些结构体的成员访问和宏定义的使用方式。
*   **模块加载和卸载函数**：检查模块的 `load` 和 `unload` 函数，它们通常会注册或注销 FreeSWITCH 提供的回调函数、API 命令、事件处理程序等。
*   **配置解析**：查找模块中解析 XML 配置或使用 `switch_xml_` 系列函数的部分，以了解其配置依赖。
*   **事件处理**：查找模块中注册事件处理程序（例如 `switch_event_bind`）或发布事件（例如 `switch_event_fire`）的部分，以了解其事件依赖。

#### 4.2.2. 自动化工具辅助

*   `grep` 或类似工具：使用 `grep` 命令在整个 AS 模块目录下搜索特定的字符串模式，例如 `switch_`、`apr_`、`SWITCH_`、`APR_` 等。这可以快速定位潜在的依赖点。

*   示例：

    grep -r "switch_" ./AS/
    grep -r "apr_" ./AS/
    grep -r "SWITCH_" ./AS/
    grep -r "APR_" ./AS/

*   `ctags` 或 `cscope`：这些工具可以生成源代码的交叉引用索引，帮助您快速跳转到函数定义、查找函数的所有引用点等，从而更高效地进行代码审查。
*   静态分析工具：虽然可能需要一些配置，但像 `Clang Static Analyzer` 或 `Cppcheck` 这样的工具可以帮助发现代码中的潜在问题，包括一些不兼容的 API 使用。

### 4.3. 模块特定分析建议

根据您提供的 AS 模块列表，以下是一些针对特定模块的分析建议：

*   `mod_as_common` 和 `mod_as_common_cpp`：这些模块很可能包含了大量公共函数、宏定义和数据结构，是其他 AS 模块的基础。它们是分析的重点，因为对它们的修改会影响所有依赖它们的模块。
*   `mod_as_sip`、`mod_as_sipphone`、`mod_as_sipphone_axb`：这些模块与 SIP 协议栈紧密相关。需要特别关注 `sofia-sip` 移除后，FreeSWITCH 内部 SIP API 的变化。检查它们是否直接操作了 SIP 消息结构或使用了 `sofia-sip` 的特定函数。
*   `mod_as_fax`：如果此模块提供了传真功能，很可能依赖于 `SpanDSP`。需要确认其对 `SpanDSP` 的依赖方式，并准备好引入外部 `SpanDSP` 库或寻找替代方案。
*   `mod_as_callcenter`、`mod_as_call_verification`、`mod_as_callcenter_agents_manage`：这些模块可能与 FreeSWITCH 的呼叫中心功能、队列、座席管理等相关。检查它们是否使用了 FreeSWITCH 呼叫中心模块的内部 API 或事件。
*   `mod_as_event`：此模块可能与 FreeSWITCH 的事件系统紧密相关。检查其是否使用了 `switch_event_` 系列函数，以及是否依赖于特定的事件类型或事件数据结构。
*   `mod_as_mongodb`、`mod_as_dbcache`、`mod_as_counter_client`：这些模块与数据库或缓存相关。检查它们是否使用了 FreeSWITCH 的数据库抽象层（例如 `switch_core_db`）或直接使用了第三方数据库客户端库。如果使用了 `pgqsql`，则需要适配 `mod_pgsql`。
*   `mod_as_ivr`、`mod_expert_ivr`：这些模块与 IVR 流程相关。检查它们是否使用了 FreeSWITCH 的 IVR 应用程序或 API，以及是否依赖于媒体播放、录音等功能。

### 4.4. 记录分析结果

在分析过程中，建议详细记录以下信息：

*   模块名称：受影响的 AS 模块。
*   依赖类型：是 FreeSWITCH 核心 API、APR 库、其他 FreeSWITCH 模块、宏定义、数据结构等。
*   具体依赖项：函数名、结构体名、宏定义名等。
*   问题描述：该依赖项在 1.10.x 中可能存在的问题（例如，已移除、签名变更、行为变更）。
*   建议的修改方向：初步的修改思路或替代方案。

通过以上详细的分析，您将能够全面了解 AS 模块在 FreeSWITCH 1.10.12 环境下的兼容性情况，为后续的移植方案制定提供坚实的基础。

5\. 移植方案制定
----------

基于 FreeSWITCH 1.6 到 1.10.12 的版本差异分析以及对 AS 模块依赖的通用分析框架，本节将制定详细的代码移植方案。该方案旨在提供一个结构化的方法，以应对升级过程中可能遇到的挑战。

### 5.1. 总体移植策略

*   **增量升级**：避免一次性完成所有修改。建议分阶段进行，例如先处理核心 API 变更，再处理模块特定依赖，最后进行行为调整。
*   **最小化修改**：尽可能在现有代码基础上进行适配，而不是大规模重写。除非旧有设计与新版本架构严重冲突，否则应优先考虑兼容性修改。
*   **自动化辅助**：充分利用 `grep`、`sed`、`awk` 等命令行工具进行批量查找和替换，提高效率并减少人为错误。
*   **版本控制**：在整个移植过程中，务必使用版本控制系统（如 Git）进行代码管理，并频繁提交，以便在出现问题时能够快速回滚。
*   **测试驱动**：为每个修改点编写或更新测试用例，确保修改的正确性，并防止引入新的回归问题。

### 5.2. 核心 API 和宏定义适配

这是移植工作中最重要的部分，因为 AS 模块与 FreeSWITCH 核心紧密耦合。针对 FreeSWITCH 1.10.x 中 API 和宏定义的变更，采取以下策略：

*   **函数签名变更**：

*   **识别**：通过编译错误、静态分析或代码审查，识别所有因函数签名（参数类型、数量、顺序、返回值）变化而导致的编译错误。
*   **适配**：根据 FreeSWITCH 1.10.x 的最新文档或源代码，修改 AS 模块中对这些函数的调用。例如，将 `switch_curl_process_form_post_params` 替换为 `switch_curl_process_mime`，并调整参数。

*   **函数行为变更**：

*   **识别**：即使函数签名未变，其内部行为也可能在 1.10.x 中有所不同。这通常需要通过阅读发布说明、`ChangeLog` 或进行运行时测试来发现。
*   **适配**：根据行为变化，调整 AS 模块的逻辑。例如，如果某个函数现在返回不同的错误码或处理方式，AS 模块需要相应地更新其错误处理逻辑。

*   **宏定义替换**：

*   **识别**：编译错误通常会直接指出未定义的宏。此外，通过 `grep` 搜索 AS 模块中使用的 `SWITCH_` 或 `FS_` 开头的宏定义。
*   **适配**：查找 FreeSWITCH 1.10.x 中对应的宏定义。如果宏被移除，可能需要用新的宏、函数调用或直接的代码逻辑来替代。

*   **数据结构成员访问**：

*   **识别**：如果 AS 模块直接访问了 `switch_core_session_t`、`switch_channel_t`、`switch_event_t` 等核心数据结构的内部成员，并且这些成员在 1.10.x 中被修改或移除，将导致编译错误或运行时错误。
*   **适配**：避免直接访问内部成员。尽可能使用 FreeSWITCH 提供的公共 API 来获取或设置数据。如果必须访问，则根据 1.10.x 的结构定义进行调整。

### 5.3. 外部依赖处理 (`SpanDSP`, `sofia-sip`, `pgqsql`)

*   `pgqsql` **到** `mod_pgsql`：

*   **移除旧依赖**：从 AS 模块的编译配置中移除对旧 `pgqsql` 核心功能的依赖。
*   **引入新模块**：确保 FreeSWITCH 1.10.x 环境中已编译并加载 `mod_pgsql`。AS 模块需要包含 `mod_pgsql` 相关的头文件，并使用其提供的 API 进行数据库操作。
*   **配置迁移**：将所有与 PostgreSQL 相关的配置从 FreeSWITCH 的主配置文件或其他旧位置迁移到 `mod_pgsql` 的配置文件中。

*   `SpanDSP` **和** `sofia-sip`：

*   **评估必要性**：首先评估 AS 模块对这两个库的依赖程度。是否可以完全移除对它们的使用？是否有 FreeSWITCH 1.10.x 内置的替代方案？
*   **独立编译和链接**：如果无法避免，则需要将 `SpanDSP` 和 `sofia-sip` 作为独立的第三方库，在 FreeSWITCH 1.10.x 环境中单独编译，并确保 AS 模块在编译和链接时能够找到这些库。
*   **API 适配**：即使独立引入，也需要检查 AS 模块中对这些库的 API 调用是否与库的最新版本兼容。可能需要对 AS 模块中的相关代码进行修改。

### 5.4. 模块间交互和事件处理

*   **事件系统**：检查 AS 模块中所有事件的订阅和发布。FreeSWITCH 事件系统可能在不同版本间有细微变化，例如事件字段的增减、事件名称的变更等。确保 AS 模块能够正确地处理和生成 1.10.x 版本的事件。
*   **模块间 API 调用**：如果 AS 模块直接调用了其他 FreeSWITCH 模块的公共 API，需要确保这些 API 在 1.10.x 中仍然可用且行为一致。特别是那些在 1.10.x 中被移除或重构的模块。

### 5.5. 编译和构建环境

*   **操作系统升级**：将开发和生产环境的操作系统升级到 FreeSWITCH 1.10.x 支持的版本（例如 Debian 11/12）。
*   **依赖库更新**：确保系统安装了 FreeSWITCH 1.10.x 所需的最新版本的依赖库，例如 OpenSSL 3、FFmpeg5 等。
*   **构建系统调整**：检查 AS 模块的 `Makefile` 或 `build` 脚本，确保它们与 FreeSWITCH 1.10.x 的构建系统兼容。可能需要调整头文件路径、库链接选项等。

### 5.6. 代码优化和清理

在移植过程中，可以考虑进行一些代码优化和清理工作：

*   **移除废弃代码**：删除所有与 FreeSWITCH 1.6.x 相关的、但在 1.10.x 中已不再需要的代码。
*   **遵循新版本最佳实践**：如果 FreeSWITCH 1.10.x 引入了新的编程范式或最佳实践，可以考虑在 AS 模块中逐步采纳。
*   **代码风格统一**：利用此机会统一 AS 模块的代码风格，使其与 FreeSWITCH 1.10.x 的代码风格保持一致。

### 5.7. 风险评估和缓解

*   **未知兼容性问题**：即使进行了详细分析，也可能存在未知的兼容性问题。因此，在移植过程中需要保持警惕，并准备好应对突发情况。
*   **性能影响**：API 变更或逻辑调整可能导致性能变化。在移植完成后，需要进行全面的性能测试。
*   **回归问题**：修改代码可能引入新的错误。严格的测试流程是避免回归问题的关键。

6\. 实施步骤和注意事项
-------------

本节将详细阐述 FreeSWITCH 从 1.6.19 升级到 1.10.12，并移植自定义 AS 模块的具体实施步骤和在整个过程中需要特别注意的事项。遵循这些步骤和建议将有助于确保移植过程的顺利进行，并最大程度地降低风险。

### 6.1. 实施步骤

#### 步骤 1：准备工作和环境搭建

*   **备份现有系统**：在开始任何修改之前，务必对当前的 FreeSWITCH 1.6.19 生产环境进行完整备份，包括 FreeSWITCH 的安装目录、配置文件、数据库（如果使用）以及所有自定义 AS 模块的源代码。这是任何升级或移植项目的黄金法则，以防万一出现不可预料的问题，可以快速回滚。
*   **搭建独立开发环境**：不要在生产环境直接进行移植工作。搭建一个全新的、独立的开发环境，操作系统版本应选择 FreeSWITCH 1.10.12 支持的最新版本（例如 Debian 11/12）。确保开发环境的网络配置、文件权限等与生产环境尽可能一致。
*   **安装 FreeSWITCH 1.10.12**：在新的开发环境中，按照官方文档安装 FreeSWITCH 1.10.12 的最新稳定版本。建议从源代码编译安装，以便更好地控制编译选项和依赖库版本。确保所有必要的依赖库（如 OpenSSL 3、FFmpeg5 等）都已正确安装。
*   **熟悉新版本**：花时间熟悉 FreeSWITCH 1.10.12 的基本操作、配置文件结构和日志输出。运行一些基本的测试，确保新版本 FreeSWITCH 能够正常工作。

#### 步骤 2：AS 模块代码迁移和初步编译

*   **复制 AS 模块代码**：将所有自定义 AS 模块的源代码复制到 FreeSWITCH 1.10.12 的 `src/mod` 目录下（或您自定义的模块目录）。
*   **调整构建配置**：根据 FreeSWITCH 1.10.12 的构建系统，调整 AS 模块的 `Makefile` 或 `mod_as.conf`（如果存在）等构建配置文件。这可能包括：

*   更新头文件搜索路径。
*   更新库链接路径和库名称（例如，如果 `pgqsql` 变为 `mod_pgsql`，则需要链接 `mod_pgsql` 库）。
*   确保编译选项与 FreeSWITCH 1.10.12 兼容。

*   **首次编译**：尝试编译所有 AS 模块。预期会遇到大量的编译错误。不要气馁，这些错误正是识别 API 和宏定义不兼容性的关键线索。

#### 步骤 3：逐一解决编译错误和 API 适配

*   **从核心模块开始**：优先处理 `mod_as_common` 和 `mod_as_common_cpp` 等基础模块的编译错误，因为它们是其他模块的依赖。
*   **分析编译错误**：仔细阅读每一个编译错误信息。错误信息通常会指出：

*   **未定义的引用**：表明函数或宏已被移除或名称发生变化。
*   **类型不匹配**：表明函数签名或数据结构成员类型发生变化。
*   **参数数量不匹配**：表明函数参数数量发生变化。

*   **查阅官方文档和源代码**：对于每一个编译错误，查阅 FreeSWITCH 1.10.x 的官方文档、发布说明和源代码，找到对应的新的 API、宏定义或数据结构。GitHub 上的 FreeSWITCH 仓库是查找最新代码和 `ChangeLog` 的重要资源。
*   **修改代码**：根据查阅结果，修改 AS 模块中的代码，使其适配 FreeSWITCH 1.10.12 的 API 和宏定义。例如：

*   将 `switch_curl_process_form_post_params` 替换为 `switch_curl_process_mime`。
*   将 `pgqsql` 相关的数据库操作替换为 `mod_pgsql` 的 API。
*   调整对 `switch_core_session_t` 等数据结构成员的访问方式，使用公共 API 替代直接访问。

*   **处理外部依赖**：如果 AS 模块依赖于 `SpanDSP` 或 `sofia-sip`，则需要：

*   **编译和安装这些库**：确保这些库在开发环境中已正确编译和安装。
*   **调整 AS 模块的链接**：确保 AS 模块在编译时能够正确链接到这些外部库。
*   **适配库 API**：如果这些库的版本也有更新，可能需要适配其 API。

*   **循环编译和修复**：每次修复一组错误后，重新编译，直到所有 AS 模块都能成功编译通过。

#### 步骤 4：功能测试和行为验证

*   **加载 AS 模块**：在 FreeSWITCH 1.10.12 中加载所有编译通过的 AS 模块。检查 FreeSWITCH 启动日志，确保模块加载成功，没有运行时错误。
*   **单元测试**：如果 AS 模块有单元测试，运行它们以验证基本功能的正确性。
*   **集成测试**：针对每个 AS 模块的核心功能，设计并执行详细的集成测试用例。例如：

*   对于 `mod_as_sip`，测试 SIP 注册、呼叫建立、媒体传输等。
*   对于 `mod_as_callcenter`，测试座席登录、队列呼叫、呼叫路由等。
*   对于 `mod_as_fax`，测试传真发送和接收。

*   **行为验证**：特别关注 FreeSWITCH 1.10.x 中默认行为的改变。例如，测试 SRTP 错误处理、请求速率限制、 `auth-messages` 和 `auth-subscriptions` 的行为是否符合预期。如果行为不符合预期，需要调整 AS 模块的逻辑或 FreeSWITCH 的配置。
*   **日志分析**：在测试过程中，密切关注 FreeSWITCH 的日志输出，查找任何警告、错误或异常行为。日志是诊断问题的最重要工具。
*   **性能测试**：在功能验证通过后，进行性能测试，对比升级前后的性能指标（如并发呼叫数、CPU 使用率、内存占用等），确保性能没有明显下降。如果性能下降，需要进一步分析和优化。

#### 步骤 5：少量基础代码优化

在完成主要移植工作后，可以考虑进行少量基础代码优化。这部分工作应谨慎进行，确保不会引入新的问题：

*   **代码风格统一**：根据 FreeSWITCH 1.10.x 的代码风格指南，对 AS 模块的代码进行格式化和风格统一。
*   **移除废弃代码**：删除所有在移植过程中被替换或不再使用的旧代码。
*   **遵循新版本最佳实践**：如果 FreeSWITCH 1.10.x 提供了新的 API 或功能可以简化现有代码，可以考虑逐步引入。

### 6.2. 注意事项

*   **版本控制的重要性**：再次强调，始终使用版本控制系统。在每次进行重大修改或解决一个主要问题后，及时提交代码。使用分支进行开发，避免直接在主分支上操作。
*   **逐步提交和测试**：不要一次性修改大量代码。每次只修改一小部分，然后编译并进行初步测试，确保修改是正确的。这有助于快速定位问题。
*   **充分利用 FreeSWITCH 社区资源**：FreeSWITCH 社区非常活跃。在遇到难以解决的问题时，可以查阅官方文档、邮件列表、论坛或 GitHub Issue，寻求社区的帮助。很多常见问题可能已经有人遇到并解决了。
*   **理解 FreeSWITCH 内部机制**：对 FreeSWITCH 的核心机制（如事件系统、会话管理、模块加载机制、内存管理等）有深入的理解，将有助于更好地诊断和解决移植过程中遇到的问题。
*   **内存管理**：FreeSWITCH 大量使用 APR 库进行内存管理。确保 AS 模块正确地使用 APR 内存池，避免内存泄漏或双重释放等问题。在升级过程中，APR 库的版本也可能更新，需要关注其兼容性。
*   **线程安全**：FreeSWITCH 是一个多线程应用。确保 AS 模块中的所有共享数据结构和资源都进行了适当的线程同步，避免竞态条件。
*   **日志级别和调试**：在开发和测试阶段，将 FreeSWITCH 的日志级别设置为 `DEBUG` 或 `INFO`，以获取更详细的日志信息，帮助诊断问题。可以使用 `fs_cli` 进行实时日志查看和调试。
*   **逐步上线**：在生产环境部署之前，务必在接近生产环境的预发布环境中进行充分的测试。可以考虑采用灰度发布的方式，逐步将流量切换到新版本，以降低风险。
*   **文档更新**：在移植完成后，更新 AS 模块的内部文档，记录所有重要的修改、适配细节和已知问题，以便未来的维护和升级。

通过遵循上述实施步骤和注意事项，您将能够系统地完成 FreeSWITCH 的版本升级和自定义 AS 模块的移植工作。这是一个具有挑战性的任务，但通过细致的规划和执行，最终将获得一个更稳定、更安全、功能更强大的通信平台。

空空如常

求真得真