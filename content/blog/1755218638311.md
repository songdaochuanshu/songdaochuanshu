---
layout: post
title: 'OCI编程高级篇（十三） 直接路径装载分配句柄'
date: "2025-08-15T00:43:58Z"
---
OCI编程高级篇（十三） 直接路径装载分配句柄
=======================

Oracle OCI编程分配直接路径装载用到的句柄，设置句柄的属性，比如要装载表的名称，表的属主，表的字段个数，直接路径装载转换缓冲区的大小等。

访问[www.tomcoding.com](http://www.tomcoding.com/ "www.tomcoding.com")网站，学习Oracle内部数据结构，详细文档说明，下载Oracle的exp/imp，DUL，logminer，ASM工具的源代码，学习高技术含量的内容。

直接路径装载最少分配三个句柄，第一个是直接路径上下文句柄OCIDirPathCtx，这个句柄从父句柄环境句柄envhp分配，每一个要装载的对象都要有一个OCIDirPathCtx，可以分配多个句柄，也可以多个对象共用一个句柄。以OCIDirPathCtx为父句柄，可以分配另外两个句柄，一个是直接路径字段数组句柄OCIDirPathColArray，用于设置表的字段信息和字段数据。另一个是直接路径流句柄OCIDirPathStream，用于把字段数组转换成数据流。

我们之前创建过一个表，用于前面的OCI代码演示，建表语句是CREATE TABLE test\_tab (ID NUMBER, NAME CHAR(30), ADDR VARCHAR2(200))。我们还以这个表为例，使用直接路径装载插入数据，看看开始分配句柄和设置句柄属性的过程。表的名称为test\_tab，表的schema为scott，下面是代码演示。

OCIEnv       \*envhp = NULL;
OCIError     \*errhp = NULL;
OCIServer    \*svrhp = NULL;
OCISession   \*usrhp = NULL;
OCISvcCtx    \*svchp = NULL;

int dp\_load(void){
    ub4                  buf\_sz;
    ub4                  ncol;
    OCIDirPathCtx        \*dpctx;
    OCIDirPathColArray   \*dpca;
    OCIDirPathStream     \*dpstr;


    /\* 分配直接路径上下文句柄，父句柄是envhp \*/
    if (check\_oci\_error(errhp,
        OCIHandleAlloc((void \*)envhp, (void \*\*)&dpctx,
            OCI\_HTYPE\_DIRPATH\_CTX, 0, (void \*\*)NULL)
        ) < 0)
        return (-1);

    /\* 分配直接路径字段数组句柄，父句柄是dpctx \*/
    if (check\_oci\_error(errhp,
        OCIHandleAlloc((void \*)dpctx, (void \*\*)&dpca,
            OCI\_HTYPE\_DIRPATH\_COLUMN\_ARRAY, 0, (void \*\*)NULL)
        ) < 0)
        return (-1);

    /\* 分配直接路径流句柄，父句柄是dpctx \*/
    if (check\_oci\_error(errhp,
        OCIHandleAlloc((void \*)dpctx, (void \*\*)&dpstr,
            OCI\_HTYPE\_DIRPATH\_STREAM, 0, (void \*\*)NULL)
        ) < 0)
        return (-1);

    /\* 设置表的schema，在上下文句柄中设置 \*/
    if (check\_oci\_error(errhp,
        OCIAttrSet((void \*)dpctx, (ub4)OCI\_HTYPE\_DIRPATH\_CTX,
            (void \*)"scott", strlen("scott"),
            (ub4)OCI\_ATTR\_SCHEMA\_NAME, errhp)
        ) < 0)
        return (-1);

    /\* 设置表名称，在上下文句柄中设置 \*/
    if (check\_oci\_error(errhp,
        OCIAttrSet((void \*)dpctx, (ub4)OCI\_HTYPE\_DIRPATH\_CTX,
            (void \*)"test\_tab", strlen("test\_tab"),
            (ub4)OCI\_ATTR\_NAME, errhp)
        ) < 0)
        return (-1);

    /\* 设置转换缓冲区的大小为2M \*/
    buf\_sz \= 2 \* 1024 \* 1024;
    if (check\_oci\_error(errhp,
        OCIAttrSet((void \*)dpctx, (ub4)OCI\_HTYPE\_DIRPATH\_CTX,
            (void \*)&buf\_sz, 0,
            (ub4)OCI\_ATTR\_BUF\_SIZE, errhp)
        ) < 0)
        return (-1);

    /\* 设置表的字段个数 \*/
    ncol \= 3;
    if (check\_oci\_error(errhp,
        OCIAttrSet((void \*)dpctx, (ub4)OCI\_HTYPE\_DIRPATH\_CTX,
            (void \*)&ncol, 0,
            (ub4)OCI\_ATTR\_NUM\_COLS, errhp)
        ) < 0)
        return (-1);

    /\* 后面需要设置表的字段信息了，我们在下一节中继续 \*/
    /\* 未完，待续 ... \*/

    return (0);
}

在上面的例子中我们分配了三个句柄，并且在代表对象的直接路径上下文中设置了表的属主，表的名称，表的字段个数，转换缓冲区的大小等属性。

在下一节中我们看看怎样设置表的字段属性和字段其他信息，字段的设置有点复杂，我们专门用一节来讲清楚。

学习Oracle高级知识，编写高质量代码，尽在www.tomcoding.com