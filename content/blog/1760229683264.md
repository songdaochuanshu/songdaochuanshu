---
layout: post
title: '【光照】Unity[PBR]环境光中的[漫反射]'
date: "2025-10-12T00:41:23Z"
---
【光照】Unity\[PBR\]环境光中的\[漫反射\]
============================

![【光照】Unity[PBR]环境光中的[漫反射]](https://img2024.cnblogs.com/blog/3685400/202510/3685400-20251011134827482-614842472.png) 本文解析Unity URP中漫反射辐照的技术演进与实现原理。URP通过球谐函数（SH）压缩环境光数据，将立方体贴图转换为9个浮点系数，相比传统方案内存降低90%以上，使移动端能高效计算动态物体间接光照。文章详细阐述SH卷积计算过程、光照探针混合机制，并对比不同方案优劣，指出SH特别适合处理Lambertian漫反射的低频特性。最后展示URP Shader中结合材质反照率实现环境光采样的代码示例，说明该技术与镜面IBL共同构成完整PBR光照体系。

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**

**漫反射辐照的核心作用**
==============

漫反射辐照（Diffuse Irradiance）在URP PBR中用于模拟环境光对物体表面的均匀散射效果，通过预计算环境立方体贴图的低频光照信息，为动态物体提供间接漫反射光照。其核心公式为：

$L\_d=\\frac{c}{\\pi}\\int\_\\Omega L\_i(\\omega\_i)(n\\cdot\\omega\_i)d\\omega\_i$

其中c为反照率，$L\_i$为环境光强度。

其核心是将环境立方体贴图卷积为球谐系数（SH）或光照探针数据。计算过程遵循Lambertian反射模型.

**技术演进关键节点**
============

*   ‌**Unity 5.x时代**‌
    
    首次引入标准PBR管线，但依赖内置渲染管线，环境光计算需全分辨率立方体贴图，内存消耗大。
    
*   ‌**URP 7.x 2020**‌
    
    采用三层球谐基函数压缩环境光数据，内存占用降低90%以上，同时支持动态光照探针混合，实现移动端高效运行。
    
*   ‌**URP 2022**‌
    
    引入HDR环境贴图支持，提升高动态范围场景下漫反射辐照的精度，通过RGBM编码解决LDR贴图亮度失真问题。
    

**解决的问题与方案优势**
==============

‌**传统问题**‌
----------

*   动态物体无法复用静态光照贴图，导致场景光照不连贯。
*   实时积分计算环境光性能开销过高，尤其在移动端。

‌**URP方案选择原因**‌
---------------

*   ‌**球谐函数压缩**‌：用9个系数（三层SH）近似环境光分布，相比立方体贴图减少90%内存占用。
    
    ### **球谐系数（SH）卷积计算原理**
    
    *   环境立方体贴图到球谐系数的转换过程分为两步：
        *   首先对立方体贴图进行蒙特卡洛积分，计算各阶球谐基函数的投影系数；
        *   然后在运行时通过法线向量重建光照。
    *   核心公式为：
    
    $c\_{l,m}=\\int\_\\Omega L\_i(\\omega)Y\_{l,m}(\\omega)d\\omega$
    
    其中$Y\_{l,m}$为球谐基函数，$L\_i$为环境光强度。Unity采用三阶SH（9个系数），仅需存储RGB三个通道的9个浮点数，相比立方体贴图内存占用减少99.8%。
    
    ### **具体实现步骤**
    
    *   ‌**预计算阶段**‌
        
        对立方体贴图的每个纹素进行半球积分，计算0-2阶球谐系数：
        
            hlsl
            // 伪代码：立方体贴图投影到SH
            for each texel in cubemap {
                float3 dir = normalize(texelDirection);
                float3 color = SampleCubemap(texel);
                for (int l=0; l<=2; ++l) {
                    for (int m=-l; m<=l; ++m) {
                        SHCoeff[l][m] += color * SHBasis(l,m,dir) * solidAngle;
                    }
                }
            }
            
        
        实际工程中会使用重要性采样优化计算量。
        
    *   ‌**运行时重建**‌
        
        在Shader中通过法线向量与预计算系数的点积快速重建光照：
        
            hlsl
            // URP中的SH重建代码（简化版）
            float3 SampleSH(float3 normalWS) {
                float4 vB = normalWS.xyzz * normalWS.yzzx;
                float3 x1 = float3(dot(unity_SHAr, normalWS),
                                  dot(unity_SHAg, normalWS),
                                  dot(unity_SHAb, normalWS));
                float3 x2 = float3(dot(unity_SHBr, vB),
                                  dot(unity_SHBg, vB),
                                  dot(unity_SHBb, vB));
                return x1 + x2 + unity_SHC.rgb;
            }
            
        
        此代码对应三阶SH重建公式：
        
        $L(n)=\\sum\_{l=0}{2}\\sum\_{m=−l}c\_{l,m}Y\_{l,m}(n)$
        
    
    该技术解决了动态物体无法实时计算全局光照的问题，通过球谐函数（SH）或光照探针存储预计算数据，显著降低实时渲染开销。
    
*   ‌**探针混合**‌：动态物体通过插值邻近探针数据实现平滑过渡，避免光照突变。
    
    ### **光照探针数据生成**
    
    *   ‌**探针烘焙**‌
        
        每个光照探针位置会生成球谐系数，通过射线追踪计算周围几何体的间接光照。Unity使用伴随勒让德多项式作为基函数，存储7个half4变量（unity\_SHAr至unity\_SHC）。
        
    *   ‌**动态物体采样**‌
        
        动态物体通过插值邻近探针的SH系数实现光照混合：
        
            hlsl
            // 探针混合伪代码
            float3 GetProbeIrradiance(float3 position) {
                Probe probes = FindNearbyProbes(position);
                float3 sh = lerp(probes[0].SH, probes[1].SH, weight);
                return SampleSH(sh, normalWS);
            }
            
        
        该方案解决了动态物体与环境光的一致性问题
        
*   ‌**硬件优化**‌：SH计算使用GPU并行，在Shader中通过`SampleSH`函数直接采样，避免实时积分。
    

**技术对比优势**
----------

方案

内存占用

计算开销

适用场景

立方体贴图

6MB+

高

静态环境反射

球谐光照（SH）

108字节

极低

动态物体漫反射

光照探针

可变

中

复杂动态场景

SH方案通过基函数投影实现高频信息剔除，特别适合Lambertian漫反射的低频特性。Unity选择该方案因其在移动端可实现0.5ms内的环境光重建，且支持动态更新.

**具体实现示例**
==========

在URP Shader中，漫反射辐照通过以下HLSL代码实现：

    hlsl
    // 球谐采样
    float3 irradiance = SampleSH(normalWS);
    // 结合材质反照率
    float3 diffuse = albedo * irradiance;
    

此过程将预计算的球谐系数与表面法线点乘，重建环境光照。例如，金属材质通过调整反照率c控制能量守恒，非金属材质则保留更多散射光。

**镜面IBL的协同作用**
==============

镜面IBL（Specular IBL）通过分裂求和近似（Split Sum Approximation）处理高光反射，与漫反射辐照共同构成完整的PBR环境光照模型。预滤波环境贴图（粗糙度分级）和BRDF LUT分别处理光线散射与菲涅尔效应，公式为：

$L\_s=\\int\_\\Omega f\_r(\\omega\_i,\\omega\_o)L\_i(\\omega\_i)(n\\cdot \\omega\_i)d\\omega\_i$

其中fr为BRDF函数。Unity选择此方案因其在移动端仅需两次纹理采样即可实现物理精确的高光反射，平衡性能与效果

* * *

> [【从UnityURP开始探索游戏渲染】](https://blog.csdn.net/chenghai37/category_13021255.html?fromshare=blogcolumn&sharetype=blogcolumn&sharerId=13021255&sharerefer=PC&sharesource=chenghai37&sharefrom=from_link)**专栏-直达**  
> （欢迎_点赞留言_探讨，更多人加入进来能更加完善这个探索的过程，🙏）