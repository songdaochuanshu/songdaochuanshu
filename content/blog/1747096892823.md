---
layout: post
title: 'è§£å†³uniappå®ç°iosç³»ç»Ÿä¸­ä½åŠŸè€—è“ç‰™é€šè®¯å¤±è´¥é—®é¢˜'
date: "2025-05-13T00:41:32Z"
---
è§£å†³uniappå®ç°iosç³»ç»Ÿä¸­ä½åŠŸè€—è“ç‰™é€šè®¯å¤±è´¥é—®é¢˜
===========================

ğŸ“± UniApp å®ç° App è¿æ¥ä½åŠŸè€—è“ç‰™ï¼ˆBLEï¼‰é€šè®¯
-------------------------------

æ‰‹å¤´ä¸Šæœ‰ä¸€ä¸ª uniapp å®ç°ä½åŠŸè€—è“ç‰™é€šè®¯è®¾å¤‡çš„é¡¹ç›®ï¼Œæœ¬æ¥ Android ç‰ˆæœ¬æ²¡é—®é¢˜å·²ç»ä¸Šçº¿ï¼Œåˆ°äº†å‘å¸ƒæµ‹è¯• iOS å‡ºé—®é¢˜äº†ï¼Œè¿æ¥ä¸Šäº†è®¾å¤‡ä½†æ˜¯é€šè®¯å¤±è´¥ï¼Œæ’æŸ¥äº†ä¸‹æ‰å‘ç°æ˜¯åè®®é€šè®¯ä¸­æœ‰åŒ…å«å…­ä½ IDï¼Œä¹Ÿå°±æ˜¯è®¾å¤‡çš„ MAC åœ°å€ï¼Œå› ä¸ºè®¾å¤‡ä¸»è¦æ ‡è¯†ç¬¦é€šå¸¸æ˜¯è®¾å¤‡ MACï¼ŒAndroid èƒ½ç›´æ¥è·å–ï¼Œä½†æ˜¯å–µçš„ iOS ä¸ç»™ï¼Œæ‰€ä»¥æœ€ç»ˆåªèƒ½æ‰¾ç¡¬ä»¶å·¥ç¨‹å¸ˆè¿›è¡Œåå•†æ‰¾è§£å†³æ–¹æ¡ˆã€‚

* * *

ä¸€ã€BLE é€šè®¯åè®®è¯´æ˜ï¼ˆè¿™æ˜¯æœ¬é¡¹ç›®åè®®æ¶ˆæ¯ä½“æ„æˆï¼‰
--------------------------

### å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ä½“æ ¼å¼ï¼š

    1Byteï¼ˆåŠŸèƒ½IDï¼‰ + 6Byteï¼ˆè®¾å¤‡IDï¼‰ + 1Byteï¼ˆç‰ˆæœ¬å·ï¼‰ + nByteï¼ˆåŠŸèƒ½å†…å®¹ï¼‰
    

### æœåŠ¡ç«¯å›åº”æ¶ˆæ¯ä½“æ ¼å¼ï¼š

    1Byteï¼ˆåŠŸèƒ½IDï¼‰ + nByteï¼ˆåŠŸèƒ½å†…å®¹ï¼‰
    

* * *

ğŸ”§ äºŒã€Android ä¸ iOS çš„å·®å¼‚ä¸è§£å†³æ–¹æ¡ˆ
---------------------------

### ğŸ¤– Android

*   `deviceId` è¿”å›å³ä¸ºè®¾å¤‡ **Mac åœ°å€**ï¼Œå¯ç›´æ¥è¿›è¡Œæ•°æ®é€šè®¯ã€‚

### ğŸ iOS

*   `deviceId` è¿”å›çš„æ˜¯ä¸€ä¸ª **UUID**ï¼Œå¹¶éçœŸå® Mac åœ°å€ã€‚

#### ğŸ” UUID æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ

*   iOS ä½¿ç”¨ `CBPeripheral.identifier` ç”Ÿæˆä¸€ä¸ªä¸´æ—¶ **UUID**ã€‚
*   æ­¤ UUID æ˜¯ iOS ç³»ç»ŸåŸºäº BLE å‘ç°è¿‡ç¨‹ä¸ºæ¯ä¸ªè®¾å¤‡ **éšæœºç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦**ã€‚
*   ä¸è®¾å¤‡çš„çœŸå®ç‰©ç†åœ°å€æ— å…³ï¼Œ**æ¯æ¬¡è“ç‰™é‡è¿æˆ–é‡æ–°å‘ç°è®¾å¤‡æ—¶å¯èƒ½ä¼šæ”¹å˜**ã€‚
*   Apple è¿™ä¹ˆè®¾è®¡æ˜¯ä¸º **ä¿æŠ¤ç”¨æˆ·éšç§**ï¼Œé¿å…å¼€å‘è€…è¿½è¸ªè®¾å¤‡æˆ–ç”¨æˆ·ã€‚

### è§£å†³æ–¹æ¡ˆï¼š

#### æ–¹æ³•ä¸€ï¼šè¿æ¥æˆåŠŸåç›‘å¬è®¾å¤‡ä¸»åŠ¨è¿”å› Mac åœ°å€

*   è®¾å¤‡ä¼šåœ¨è¿æ¥ **1 ç§’åä¸»åŠ¨å‘é€ Mac åœ°å€**ã€‚
*   è‹¥æ— å›åº”ï¼Œè®¾å¤‡ä¼šæ¯ **2 ç§’é‡å‘ä¸€æ¬¡**ï¼Œç›´åˆ°æ”¶åˆ°ã€‚

    uni.onBLECharacteristicValueChange((res) => {
      const value = ab2hex(res.value);
      if (value.startsWith("01")) {
        const mac = value.slice(2, 14); // æˆªå–6å­—èŠ‚mac
        uni.setStorageSync('deviceMac', mac) // å­˜å‚¨macç”¨äºåç»­é€šè®¯ï¼Œæœ‰ç”¨ vuex æˆ–è€… pinia ç­‰å…¶ä»–æ–¹æ³•ä¹Ÿå¯ä»¥
        await this.send('11');  // åº”ç­”è®¾å¤‡é˜²æ­¢ä¸€ç›´ä¸ŠæŠ¥
      }
    });
    

#### æ–¹æ³•äºŒï¼šé€šè¿‡å¹¿æ’­æ•°æ® (advertisData) æå– Mac åœ°å€

*   æ¯æ¬¡æ‰«æè®¾å¤‡æ—¶ï¼Œå¹¿æ’­åŒ…ä¸­å¯èƒ½åŒ…å« Mac åœ°å€å­—æ®µã€‚
*   è‹¥å­˜åœ¨éšç§é¡¾è™‘ï¼Œå¯å¯¹å…¶ **åŠ å¯†å¤„ç†**ï¼Œè¿æ¥è®¾å¤‡å‰è¿›è¡Œ **è§£å¯†å¹¶ç¼“å­˜**ã€‚

    import CryptoJS from "crypto-js";
    
    function decryptMac(cipherHex) {
      const key = CryptoJS.enc.Hex.parse("00112233445566778899aabbccddeeff"); // 16å­—èŠ‚å¯†é’¥
      const iv = CryptoJS.enc.Hex.parse("00000000000000000000000000000000"); // é»˜è®¤å…¨0 IV
      const encrypted = CryptoJS.enc.Hex.parse(cipherHex);
      const encryptedBase64 = CryptoJS.enc.Base64.stringify(encrypted);
      const decrypted = CryptoJS.AES.decrypt(encryptedBase64, key, {
        iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7,
      });
      return decrypted.toString(CryptoJS.enc.Hex);
    }
    
    uni.startBluetoothDevicesDiscovery({
      success() {
        uni.onBluetoothDeviceFound((device) => {
          const advertisData = device.advertisData;
          const raw = ab2hex(advertisData);
          const encryptedMac = raw.slice(10, 42); // ç¤ºä¾‹ä¸­ä¸º16å­—èŠ‚åŠ å¯†
          const mac = decryptMac(encryptedMac);
          console.log("è§£å¯†å‡ºçš„Macåœ°å€ï¼š", mac);
        });
      },
    });
    

* * *

ä¸‰ã€é€šè®¯æµç¨‹ç®€å•ç¤ºæ„
----------

    async function connectBLE(device) {
      await uni.createBLEConnection({ deviceId: device.deviceId });
    
      // ç›‘å¬ç‰¹å¾å€¼å˜åŒ–
      uni.onBLECharacteristicValueChange((res) => handleResponse(res));
    
      // å¯ç”¨ notify ç›‘å¬
      await uni.notifyBLECharacteristicValueChange({
        deviceId: device.deviceId,
        serviceId: serviceUUID,
        characteristicId: notifyUUID,
        state: true,
      });
    
      // å‘é€æ•°æ®
      const platform = uni.getSystemInfoSync().platform;
      const macAddress = uni.getStorageSync("deviceMac");
      const payload = buildPayload(
        "01",
        platform == "ios" ? macAddress : device.deviceId,
        "01",
        content
      );
      await uni.writeBLECharacteristicValue({
        deviceId: device.deviceId,
        serviceId: serviceUUID,
        characteristicId: writeUUID,
        value: str2ab(payload),
      });
    }
    

* * *

ğŸ›¡ï¸ å››ã€å®‰å…¨å»ºè®®
----------

*   **å¹¿æ’­ä¸­çš„ Mac åœ°å€åº”åŠ å¯†**ï¼Œé˜²æ­¢æ³„éœ²ã€‚
*   **é€šè®¯å†…å®¹å»ºè®®ä½¿ç”¨ AES åŠ å¯†**ï¼Œæå‡å®‰å…¨ç­‰çº§ã€‚
*   ä½¿ç”¨ **CRC16 æˆ– hash** æ ¡éªŒæ•°æ®å®Œæ•´æ€§ã€‚

* * *

ğŸ“š äº”ã€æ€»ç»“
-------

é¡¹ç›®

Android

iOS

deviceId

è¿”å›çœŸå® Mac åœ°å€ âœ…

è¿”å› UUIDï¼Œéœ€ç‰¹æ®Šå¤„ç† âš ï¸

è·å– Mac

å¯ç›´æ¥ä½¿ç”¨

è¿æ¥åç›‘å¬ / å¹¿æ’­åŒ…è§£æ

å¹¿æ’­æ•°æ®

å¯ç”¨ï¼Œå¯åŠ å¯†æºå¸¦ Mac åœ°å€

æ¨èä½¿ç”¨ï¼Œç”¨äºè¿æ¥å‰æ ‡è¯†è®¾å¤‡

åŠ å¯†å»ºè®®

AES å¯¹ç§°åŠ å¯† / CRC16 æ ¡éªŒ

åŒ Androidï¼Œå»ºè®®ä¸€è‡´å¤„ç†æ–¹å¼