---
layout: post
title: 'freeswitch的proxy_media模式下video流的问题与修正'
date: "2025-10-18T00:37:39Z"
---
freeswitch的proxy\_media模式下video流的问题与修正
======================================

概述
==

freeswitch是一款简单好用的VOIP开源软交换平台。

测试过程中发现fs的proxy\_media模式的一个bug，就是video媒体流的转发处理有问题。

环境
==

CentOS 7.9

freeswitch 1.6.20

问题
==

fs配置为proxy\_media模式，A路发起呼叫，A路远端的sdp中有audio和video媒体信息。

a642b367-754c-492e-b227-87f94e8010c7 m=audio 16394 RTP/AVP 8 18 101

a642b367-754c-492e-b227-87f94e8010c7 m=video 16396 RTP/AVP 99

fs处理拨号计划后，发起B路呼叫，B路的sdp继承了A路的sdp，本地sdp信息如下。

a642b367-754c-492e-b227-87f94e8010c7 m=audio 54398 RTP/AVP 8 18 101

a642b367-754c-492e-b227-87f94e8010c7 m=video 54400 RTP/AVP 99

B路收到终端的183sdp信息，处理媒体信息后，本地sdp修改如下。

a642b367-754c-492e-b227-87f94e8010c7 m=audio 54398 RTP/AVP 8 18 101

a642b367-754c-492e-b227-87f94e8010c7 m=video 44622 RTP/AVP 99

其中B路本端的audio端口为54398，video的端口从54400修改为了44622。

结果就是，B路本端的video媒体流从44622端口发到远端，远端的video媒体流送到本地的54400，造成媒体流擦肩而过。

查看switch\_core\_media.c的switch\_core\_media\_patch\_sdp函数，在处理video信息时，强制重选了video本地端口，而audio端口处理正常。

switch\_core\_media\_choose\_port(session, SWITCH\_MEDIA\_TYPE\_VIDEO, 1);

查看调用堆栈，mod\_sofia模块在处理183sdp的流程中，proxy\_media模式下会主动调用“switch\_core\_media\_patch\_sdp”这一并无必要的操作。

修复
==

修改mod\_sofia模块的sofia.c文件，屏蔽“switch\_core\_media\_patch\_sdp”操作。

    } else if (switch_channel_test_flag(channel, CF_PROXY_MEDIA)) {
        switch_channel_set_variable(channel, SWITCH_ENDPOINT_DISPOSITION_VARIABLE, "PROXY MEDIA");
        // switch_core_media_patch_sdp(tech_pvt->session);
        if (sofia_media_activate_rtp(tech_pvt) != SWITCH_STATUS_SUCCESS) {
            nua_respond(nh, SIP_488_NOT_ACCEPTABLE, TAG_END());
            switch_channel_hangup(channel, SWITCH_CAUSE_INCOMPATIBLE_DESTINATION);
        } else{
            switch_channel_mark_pre_answered(channel);
        }

测试
==

重新编译mod\_sofia模块后，测试视频流程，媒体协商正常，B路本地端口协商正常，媒体流正常转发。

总结
==

未经过充分测试，不清楚对其他业务流程的影响。

经过修改后的fs虽然可以正常转发rtp媒体流，但是仍然无法转发rtcp消息，在网络较差的情况下，视频媒体流无法利用rtcp的特性修复视频卡顿。

空空如常

求真得真