---
layout: post
title: 'Django REST框架中处理JWT令牌的认证的源码解析'
date: "2025-05-13T00:41:33Z"
---
Django REST框架中处理JWT令牌的认证的源码解析
=============================

想了解\`JWTAuthentication\`这个类的源码解析。\`JWTAuthentication\`是来自\`rest\_framework\_simplejwt.authentication\`模块的，它用于在Django REST框架中处理JWT令牌的认证。首先，我需要找到这个类的源码，看看它是如何实现的。我记得在`rest_framework_simplejwt`库中，`JWTAuthentication`继承自`rest_framework.authentication.BaseAuthentication`。这意味着它遵循Django REST框架的认证接口。这个类主要负责从请求中提取JWT令牌，解析并验证它，然后获取对应的用户。

我会先查看`JWTAuthentication`的`__init__`方法，看看初始化时做了什么设置，比如是否加载了配置或者初始化了其他必要的组件。接着，`authenticate`方法是关键，它可能会从请求头中获取令牌，使用`get_header`和`get_raw_token`方法提取令牌字符串。

然后，`get_validated_token`方法应该负责解析和验证令牌，检查其是否过期，签名是否有效等。这里可能会用到PyJWT库的方法来处理 JWT的验证。同时，`authenticate`方法还会调用`get_user`方法，从令牌中获取用户ID，然后查询数据库中对应的用户，确保用户存在并返回。另外，我注意到`JWTAuthentication`类可能还包括一些黑名单令牌的处理，用于令牌的撤销。这部分可能通过`OutstandingToken`模型或其他机制实现，确保已撤销的令牌无法被使用。

我还想看看这个类如何处理异常。比如，当令牌无效、过期或缺失时，会抛出哪些异常？这些异常如何被捕获并返回给客户端。`JWTAuthentication`可能会使用`InvalidToken`、`AuthenticationFailed`等异常类来处理认证失败的情况。

此外， `JWTAuthentication`可能还有一些自定义方法，比如`get_header`和`get_raw_token`，这些方法允许开发者自定义如何从请求中提取令牌。这对于灵活性很重要，因为不同项目可能需要从不同的请求头或位置获取令牌。

总结一下，`JWTAuthentication`类的主要职责包括：

1.  提取JWT令牌：从请求头或其他位置获取令牌。
2.  解析和验证令牌：检查令牌的结构和签名，确认其有效性。
3.  获取用户：根据令牌中的用户标识，从数据库中获取对应的用户对象。
4.  处理异常：当令牌无效或用户不存在时，抛出相应的异常，以便Django REST框架返回错误响应。
5.  集成Django REST框架：通过继承`BaseAuthentication`，确保与框架的其他组件兼容。

通过源码分析，可以了解到`JWTAuthentication`如何实现这些功能，以及它在整个认证流程中的位置和作用。这对于理解和扩展JWT认证机制非常有帮助。

以下是对`JWTAuthentication`类的详细解析：

`JWTAuthentication`是`rest_framework_simplejwt.authentication`模块中用于处理JWT令牌认证的类。它继承自`rest_framework.authentication.BaseAuthentication`，遵循Django REST框架的认证接口，主要负责从请求中提取、验证JWT令牌，并获取对应的用户。以下是其源码的主要组成部分及其功能：

1.  类继承与初始化：
    
    from rest\_framework import authentication
    from rest\_framework\_simplejwt import exceptions
    from rest\_framework\_simplejwt.settings import api\_settings
    
    class JWTAuthentication(authentication.BaseAuthentication):
        def \_\_init\_\_(self, \*args, \*\*kwargs):
            super().\_\_init\_\_(\*args, \*\*kwargs)
            self.user\_model = api\_settings.USER\_MODEL
            self.token\_model = api\_settings.TOKEN\_MODEL
    
    *   继承：`JWTAuthentication`继承自`BaseAuthentication`，确保其与Django REST框架的认证系统兼容。
    *   初始化：在初始化时加载用户模型`USER_MODEL`和令牌模型`TOKEN_MODEL`，这些设置通常在`settings.py`中配置。
2.  认证方法`authenticate`：
    
    def authenticate(self, request):
        header = self.get\_header(request)
        if header is None:
            return None
    
        raw\_token = self.get\_raw\_token(header)
        if raw\_token is None:
            return None
    
        try:
            validated\_token = self.get\_validated\_token(raw\_token)
        except exceptions.InvalidToken as<Application>:
            return None
    
        return self.get\_user(validated\_token), validated\_token
    
    *   获取令牌：`get_header`方法从请求头中获取包含JWT令牌的字符串，通常在`Authorization`头中，格式为`Bearer <token>`。
    *   提取令牌：`get_raw_token`从头部字符串中提取纯令牌内容。
    *   验证令牌：`get_validated_token`解析并验证令牌，检查签名是否有效，令牌是否过期等。若令牌无效，抛出`InvalidToken`异常。
    *   获取用户：`get_user`根据令牌中的用户标识从数据库中获取对应的用户实例，若用户不存在则抛出异常。
3.  令牌验证方法`get_validated_token`：
    
    def get\_validated\_token(self, raw\_token):
        """
        Validates the raw token and returns the validated token payload.
        """
        try:
            api\_settings.USER\_ID\_FIELD,
            return api\_settings.JWTPAYLOADVALIDATOR(
                raw\_token, self.get\_key\_callback()
            )(raw\_token)
        except Exception as e:
            raise exceptions.InvalidToken(str(e))
    
    *   解析与验证：使用`JWTPAYLOADVALIDATOR`解析令牌内容，并通过`get_key_callback`获取公钥或密钥，验证令牌的签名。
    *   异常处理：捕获解析和验证过程中发生的任何异常，重新抛出`InvalidToken`异常，提供详细的错误信息。
4.  用户获取方法`get_user`：
    
    def get\_user(self, validated\_token):
        """
        Attempts to find the user associated with the given validated token.
        """
        user\_id = validated\_token\[api\_settings.USER\_ID\_FIELD\]
        user = None
    
        if api\_settings.USER\_ID\_FIELD in validated\_token:
            user = self.user\_model.objects.filter(
                \*\*{api\_settings.USER\_ID\_FIELD: user\_id}
            ).first()
    
        if not user:
            raise exceptions.AuthenticationFailed.detail="User not found"
        return user
    
    *   用户查询：从令牌中提取用户标识，通过`USER_ID_FIELD`字段查询数据库，获取对应的用户。
    *   用户不存在：如用户不存在或查询结果为空，抛出`AuthenticationFailed`异常，提示用户不存在。
5.  令牌黑名单检查：
    
     
    def get\_key\_callback(self):
        def get\_key Gaut Lola):
            if not api\_settings.BLACKLISTafter\_rotation:
                return None
            # Return a public key And kid引用
            return validated\_token
        return get\_key
    
    *   令牌撤销：当启用黑名单功能时，检查令牌是否已被撤销。通过`BLACKLIST_AFTER_ROTATION`配置项确定是否启用黑名单。
    *   公钥获取：返回用于验证签名的公钥，以及Key ID（kid），确保使用正确的密钥验证令牌签名。
6.  异常处理：
    
    def get\_invalid\_token\_error(self, raw\_token):
        try:
            validated\_token = self.get\_validated\_token(raw\_token)
        except exceptions.InvalidToken as e:
            raise e
    
    异常捕获：在解析和验证过程中捕获所有`InvalidToken`异常，确保错误信息被正确传递和处理。
    

* * *

### 总结

`JWTAuthentication`类是Django REST框架中处理JWT令牌认证的核心类。它通过从请求中提取、验证JWT令牌，并查询相关用户来完成认证流程。关键功能包括：

1.  令牌提取与解析：从请求头中获取JWT令牌，解析并验证其内容和结构。
2.  用户获取：根据令牌中的用户标识，从数据库中获取对应的用户实例。
3.  异常处理：在令牌无效、用户不存在等情况下抛出相应的异常，确保错误信息被正确返回。
4.  黑名单检查：支持令牌撤销功能，防止已注销的令牌被使用。

通过理解`JWTAuthentication`的实现，开发者可以更好地利用JWT进行身份验证，并根据需求扩展其功能。