---
layout: post
title: '.NET+AI | MEAI | Function Caling å®æ“ï¼ˆ4ï¼‰'
date: "2025-11-23T00:48:13Z"
---
.NET+AI | MEAI | Function Caling å®æ“ï¼ˆ4ï¼‰
======================================

.NET+AI | MEAI | Function Caling å®æ“
===================================

TL;DR
-----

*   âœ… æ³¨å†Œä½ çš„æ–¹æ³•ä¸ºå·¥å…·ï¼ˆToolï¼‰
*   âœ… å¯ç”¨ä¸­é—´ä»¶ `UseFunctionInvocation()`
*   âœ… è®¾ç½® `ChatOptions.ToolMode = Auto`
*   âœ… å‘èµ·å¯¹è¯ï¼ŒMEAI è‡ªåŠ¨å®Œæˆï¼šè¯·æ±‚ â†’ è°ƒç”¨ â†’ å›å¡« â†’ ä½œç­”

![](https://img2024.cnblogs.com/blog/577140/202511/577140-20251122194144918-2127415908.png)

ğŸ¢ åœºæ™¯ä¸ä»·å€¼
--------

*   ğŸ’¬ æ™ºèƒ½åŠ©ç†éœ€è¦å¯æ§è®¿é—®åç«¯ï¼šå¤©æ°”/åº“å­˜/çŸ¥è¯†åº“/å·¥å•
*   ğŸ“¦ MEAI ç”¨ç»Ÿä¸€â€œå·¥å…·â€æŠ½è±¡ï¼Œå±è”½æ¨¡å‹/å‚å•†å·®å¼‚
*   ğŸ›¡ï¸ å¯æ§ã€å¯è§‚æµ‹ã€å¯æ‰©å±•ï¼ˆæ—¥å¿—/ç¼“å­˜/é™æµæ˜“æ¥å…¥ï¼‰

ğŸŒ æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°
---------

*   ğŸ“¦ ToolCollection/AIToolï¼šæŠŠä½ çš„æ–¹æ³•åŒ…è£…æˆâ€œå¯è¢«è°ƒç”¨çš„å·¥å…·â€
*   ğŸšï¸ ChatOptions.ToolModeï¼šæ§åˆ¶æ¨¡å‹æ˜¯å¦/å¦‚ä½•è°ƒç”¨å·¥å…·ï¼ˆNone/Auto/Requireï¼‰
*   ğŸ’¬ FunctionCallContent / FunctionResultContentï¼šè°ƒç”¨æ„å›¾ä¸å‡½æ•°ç»“æœçš„æ¶ˆæ¯è½½ä½“
*   ğŸ“¦ FunctionInvokingChatClientï¼šè‡ªåŠ¨å®Œæˆè°ƒç”¨å¾ªç¯çš„ä¸­é—´ä»¶

ğŸš€ å¿«é€Ÿä¸Šæ‰‹ï¼ˆ4 æ­¥ï¼‰
------------

### 1ï¼‰è·å– ChatClient

    // æ–¹å¼ Aï¼šè¯¾ç¨‹è¾…åŠ©ç±»ï¼ˆæ¨èï¼‰
    var chatClient = AIClientHelper.GetDefaultChatClient();
    
    // æ–¹å¼ Bï¼šè‡ªè¡Œåˆ›å»ºï¼ˆç¤ºæ„ï¼‰
    // var chatClient = new OpenAIChatClient(apiKey: "...", model: "gpt-4o-...");
    

### 2ï¼‰æ³¨å†Œå·¥å…·ï¼ˆToolï¼‰

    using Microsoft.Extensions.AI;
    
    // æœ€å°ç¤ºä¾‹ï¼šæ— å…¥å‚ï¼Œè¿”å›å­—ç¬¦ä¸²
    string GetCurrentWeather() => Random.Shared.NextDouble() > 0.5 ? "It's sunny" : "It's raining";
    var tools = AIFunctionFactory.Create(GetCurrentWeather, name: "GetCurrentWeather", description: "æŸ¥è¯¢å½“å‰å¤©æ°”");
    

ç¨å¤æ‚ï¼ˆå¸¦æè¿°/ç±»å‹ï¼‰

    using System.ComponentModel;
    
    public record WeatherReport(string City, int TemperatureCelsius, bool WillRain);
    
    public class TravelToolset
    {
        [Description("æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”")]
        public WeatherReport QueryWeather(string city)
            => new(city, 25, willRain: false);
    }
    
    var travelTools = AIFunctionFactory.CreateFromMethods(new TravelToolset());
    

### 3ï¼‰å¯ç”¨å‡½æ•°è°ƒç”¨ä¸­é—´ä»¶

    var client = chatClient.AsBuilder()
        .UseFunctionInvocation() // ğŸ”§ å…³é”®ï¼šå¯ç”¨è‡ªåŠ¨å‡½æ•°è°ƒç”¨
        .Build();
    

### 4ï¼‰é…ç½®å¹¶å¯¹è¯

    var messages = new List<ChatMessage>
    {
        new(ChatRole.System, "ä½ æ˜¯å‡ºè¡ŒåŠ©æ‰‹ï¼Œå–„äºè°ƒç”¨å·¥å…·ç»™å‡ºç©¿æ­å»ºè®®ã€‚"),
        new(ChatRole.User,   "å¸®æˆ‘æŸ¥çœ‹ä»Šå¤©åŒ—äº¬çš„å¤©æ°”ï¼Œè¦ä¸è¦å¸¦ä¼ï¼Ÿ")
    };
    
    var options = new ChatOptions
    {
        ToolMode = ChatToolMode.Auto,
        Tools = [ tools ] // æˆ– travelTools
    };
    
    var response = await client.GetResponseAsync(messages, options);
    Console.WriteLine(response.Text);
    

ğŸ’» å¯è¿è¡Œæœ€å°ç¤ºä¾‹
----------

> ä¾èµ–ï¼šMicrosoft.Extensions.AIï¼ˆä»¥åŠé€‰ç”¨çš„æä¾›æ–¹å®ç°ï¼Œå¦‚ Microsoft.Extensions.AI.OpenAI æˆ– Azure.AI.OpenAIï¼‰

    using System;
    using System.Collections.Generic;
    using Microsoft.Extensions.AI;
    
    class Program
    {
        static async System.Threading.Tasks.Task Main()
        {
            // 1) è·å– ChatClient
            var chatClient = AIClientHelper.GetDefaultChatClient();
    
            // 2) æ³¨å†Œå·¥å…·
            string GetCurrentWeather() => Random.Shared.NextDouble() > 0.5 ? "It's sunny" : "It's raining";
            var tools = AIFunctionFactory.Create(GetCurrentWeather, name: "GetCurrentWeather", description: "æŸ¥è¯¢å½“å‰å¤©æ°”");
    
            // 3) å¯ç”¨å‡½æ•°è°ƒç”¨
            var client = chatClient.AsBuilder().UseFunctionInvocation().Build();
    
            // 4) é…ç½®ä¸å¯¹è¯
            var messages = new List<ChatMessage>
            {
                new(ChatRole.System, "ä½ æ˜¯å‡ºè¡ŒåŠ©æ‰‹ï¼Œå–„äºè°ƒç”¨å·¥å…·ç»™å‡ºç©¿æ­å»ºè®®ã€‚"),
                new(ChatRole.User,   "å¸®æˆ‘æŸ¥çœ‹ä»Šå¤©åŒ—äº¬çš„å¤©æ°”ï¼Œè¦ä¸è¦å¸¦ä¼ï¼Ÿ")
            };
    
            var options = new ChatOptions { ToolMode = ChatToolMode.Auto, Tools = [ tools ] };
            var result = await client.GetResponseAsync(messages, options);
            Console.WriteLine(result.Text);
        }
    }
    

ğŸ”„ æ‰§è¡Œæµç¨‹å›¾ï¼ˆMermaidï¼‰
-----------------

![](https://img2024.cnblogs.com/blog/577140/202511/577140-20251122194144817-42494857.png)

ğŸ“Š ToolMode é€ŸæŸ¥è¡¨
---------------

æ¨¡å¼

å«ä¹‰

é€‚ç”¨åœºæ™¯

None

ç¦ç”¨å·¥å…·è°ƒç”¨

åªå¯¹è¯ï¼Œä¸èµ°å·¥å…·

Auto

æ¨¡å‹è‡ªè¡Œå†³å®šæ˜¯å¦è°ƒç”¨

é€šç”¨æ¨èï¼Œçµæ´»å¼º

RequireAny

å¿…é¡»è°ƒç”¨ä»»æ„ä¸€ä¸ªå·¥å…·

å¼ºåˆ¶èµ°å·¥å…·æµç¨‹

RequireSpecific("name")

å¿…é¡»è°ƒç”¨æŒ‡å®šå·¥å…·

å›ºå®šå…³é”®æ­¥éª¤

â“ å¸¸è§é—®é¢˜ä¸è§£å†³
---------

*   æ¨¡å‹æ²¡è°ƒç”¨å·¥å…·ï¼Ÿ
    *   ğŸ” æ£€æŸ¥ `ToolMode` æ˜¯å¦ä¸º `Auto/Require*`
    *   ğŸ” å·¥å…·åç§°/æè¿°/å‚æ•°æ˜¯å¦æ¸…æ™°ã€å¯æ¨æ–­
*   ä¼ å‚ä¸åŒ¹é…/è§£æå¤±è´¥ï¼Ÿ
    *   ğŸ“ æ˜ç¡®å‚æ•°ç±»å‹ä¸æè¿°ï¼Œé¿å…æ¨¡ç³Šå‘½å
    *   ğŸ›¡ï¸ çº¦æŸè¾“å…¥ï¼ˆæšä¸¾/èŒƒå›´ï¼‰ï¼Œå¿…è¦æ—¶æŠ›å‡ºå¯è¯»å¼‚å¸¸
*   å¤šæ¬¡å·¥å…·è°ƒç”¨é“¾è¿‡é•¿ï¼Ÿ
    *   ğŸ¯ æ”¶æ•›ä»»åŠ¡ç›®æ ‡ï¼Œæä¾›æ¸…æ™°ç³»ç»Ÿæç¤ºä¸ç»“æœæ ¼å¼
    *   ğŸšï¸ éœ€è¦ä¸€æ­¥åˆ°ä½æ—¶ï¼Œç”¨ `RequireSpecific` å¼ºåˆ¶å…³é”®å·¥å…·

âœ… æœ€ä½³å®è·µ
------

*   âœï¸ å·¥å…·å‘½åä¸æè¿°ç²¾ç‚¼ï¼Œé¢å‘â€œæ¨¡å‹è¯»è€…â€
*   ğŸ§© å·¥å…·åªåšä¸€ä»¶äº‹ï¼›è¿”å›ç»“æ„åŒ–ç»“æœï¼ˆrecord/classï¼‰æ›´ç¨³
*   ğŸ“¦ åŸºäº `UseFunctionInvocation` å åŠ ä¸­é—´ä»¶ï¼šæ—¥å¿—/ç¼“å­˜/é™æµ
*   â™»ï¸ é€šç”¨èƒ½åŠ›æ³¨å†Œåˆ°å…¨å±€ `AdditionalTools`ï¼Œåœºæ™¯å†…å¤ç”¨
*   ğŸ§¯ è®¾ç½®å…œåº•å›ç­”ä¸å¤±è´¥é‡è¯•ï¼Œæå‡å¥å£®æ€§

âœ¨ æ€»ç»“
----

MEAI çš„å‡½æ•°è°ƒç”¨æŠŠâ€œæ¨¡å‹ + ä½ çš„ä¸šåŠ¡èƒ½åŠ›â€æ— ç¼æ‹¼èµ·æ¥ï¼šå£°æ˜å·¥å…·ã€æ‰“å¼€å¼€å…³ã€å¼€å§‹å¯¹è¯ï¼Œå‰©ä¸‹çš„äº¤ç»™ä¸­é—´ä»¶è‡ªåŠ¨ç¼–æ’ã€‚

![](https://files.cnblogs.com/files/sheng-jie/maf-course-card-scan.bmp)

> **ğŸ‘†é¢å‘.NETå¼€å‘è€…çš„AI Agent å¼€å‘è¯¾ç¨‹ã€.NET+AI | æ™ºèƒ½ä½“å¼€å‘è¿›é˜¶ã€‘å·²ä¸Šçº¿ï¼Œæ¬¢è¿æ‰«ç åŠ å…¥å­¦ä¹ ã€‚ğŸ‘†**

![](https://files.cnblogs.com/files/sheng-jie/scan-follow.bmp)

> **å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€å‘ AI è€Œè¡Œã€ï¼Œæˆ‘ä»¬å¾®ä¿¡ä¸è§ä¸æ•£ã€‚  
> é˜…ç½¢æ­¤æ–‡ï¼Œå¦‚æœæ‚¨è§‰å¾—æœ¬æ–‡ä¸é”™å¹¶æœ‰æ‰€æ”¶è·ï¼Œè¯·ã€æ‰“èµã€‘æˆ–ã€æ¨èã€‘ï¼Œä¹Ÿå¯ã€è¯„è®ºã€‘ç•™ä¸‹æ‚¨çš„é—®é¢˜æˆ–å»ºè®®ä¸æˆ‘äº¤æµã€‚ ä½ çš„æ”¯æŒæ˜¯æˆ‘ä¸æ–­åˆ›ä½œå’Œåˆ†äº«çš„ä¸ç«­åŠ¨åŠ›ï¼**

ä½œè€…ï¼š[ã€åœ£æ°ã€](http://www.jianshu.com/u/39ec0e6b1844)

å‡ºå¤„ï¼š[http://www.cnblogs.com/sheng-jie/](http://www.cnblogs.com/sheng-jie/)

æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡é“¾æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚