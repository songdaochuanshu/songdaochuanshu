---
layout: post
title: 'FastAPIæ•°æ®åº“å®æˆ˜ï¼šä»SQLAlchemyåŸç†åˆ°é«˜æ•ˆè¿æ¥ç®¡ç†ï¼Œå‘Šåˆ«æ€§èƒ½ç“¶é¢ˆ'
date: "2026-01-15T00:43:37Z"
---
FastAPIæ•°æ®åº“å®æˆ˜ï¼šä»SQLAlchemyåŸç†åˆ°é«˜æ•ˆè¿æ¥ç®¡ç†ï¼Œå‘Šåˆ«æ€§èƒ½ç“¶é¢ˆ
========================================

æœ¬æ–‡ä»FastAPIå¼€å‘ä¸­æ•°æ®åº“æ“ä½œçš„å¸¸è§ç—›ç‚¹åˆ‡å…¥ï¼Œæ·±å…¥æµ…å‡ºåœ°è§£æäº†SQLAlchemyçš„æ ¸å¿ƒåŸç†ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„SQLiteæ“ä½œå®ä¾‹ï¼Œæ¼”ç¤ºäº†å¦‚ä½•æ„å»ºé«˜æ•ˆã€å¥å£®çš„æ•°æ®åº“è¿æ¥ä¸å­˜å–æ–¹æ¡ˆã€‚é‡ç‚¹å‰–æäº†è¿æ¥æ± æœºåˆ¶ä¸ä¾èµ–æ³¨å…¥çš„æœ€ä½³å®è·µï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…å†™å‡ºæ€§èƒ½æ›´ä¼˜ã€æ›´æ˜“ç»´æŠ¤çš„Web APIã€‚

ä½ æ˜¯å¦ä¹Ÿæ›¾è¢«Web APIä¸­æ‚ä¹±æ— ç« çš„æ•°æ®åº“è¿æ¥ä»£ç æå¾—ç„¦å¤´çƒ‚é¢ï¼Ÿæ€§èƒ½ä¸Šä¸å»ï¼ŒBugå´ä¸å°‘ã€‚

è¯•æƒ³åœ¨ä¸€ä¸ªä¸­å‹é¡¹ç›®ä¸­ï¼ŒåˆæœŸä¸ºäº†å›¾å¿«ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½æ–°å»ºæ•°æ®åº“è¿æ¥ï¼Œç»“æœåœ¨å¹¶å‘æµ‹è¯•æ—¶ï¼ŒAPIå“åº”æ—¶é—´ä»50msé£™å‡åˆ°2ç§’ä»¥ä¸Šï¼Œæ•°æ®åº“è¿æ¥æ•°ç¬é—´æ‰“æ»¡ï¼ŒæœåŠ¡ç›´æ¥é›ªå´©ã€‚è¿™ç»ä¸æ˜¯ä¸ªä¾‹ï¼Œ**ä½æ•ˆçš„æ•°æ®åº“è¿æ¥ç®¡ç†ï¼Œæ˜¯Webåº”ç”¨ä¸­æœ€å¸¸è§å´ä¹Ÿæœ€å®¹æ˜“è¢«å¿½è§†çš„æ€§èƒ½æ€æ‰‹ä¹‹ä¸€ã€‚**

ä»Šå¤©ï¼Œæˆ‘ä»¬å°±ä»¥FastAPI + SQLite + SQLAlchemyè¿™å¥—è½»é‡ä¸”å¼ºå¤§çš„ç»„åˆä¸ºä¾‹ï¼Œå½»åº•è®²æ¸…æ¥šå¦‚ä½•é«˜æ•ˆã€ä¼˜é›…åœ°æ“ä½œæ•°æ®åº“ã€‚

ğŸ¯ ä¸€ã€æ ¸å¿ƒå›°å¢ƒï¼šæˆ‘ä»¬åˆ°åº•åœ¨è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
----------------------

åœ¨Webå¼€å‘ä¸­ï¼Œæ•°æ®åº“æ“ä½œçœ‹ä¼¼ç®€å•ï¼Œæ— éâ€œè¿æ¥ã€æ‰§è¡Œã€å…³é—­â€ã€‚ä½†ä¸€æ—¦æ”¾åˆ°é«˜å¹¶å‘ã€é•¿ç”Ÿå‘½å‘¨æœŸçš„WebæœåŠ¡å™¨ç¯å¢ƒä¸­ï¼Œé—®é¢˜å°±å¤æ‚äº†ï¼š

\- ğŸ¢ **æ€§èƒ½ç“¶é¢ˆ**ï¼šé¢‘ç¹åˆ›å»ºå’Œé”€æ¯æ•°æ®åº“è¿æ¥å¼€é”€å·¨å¤§ã€‚

\- ğŸ’¥ **èµ„æºè€—å°½**ï¼šè¿æ¥ä¸åŠæ—¶é‡Šæ”¾ï¼Œå¯¼è‡´è¿æ¥æ± è€—å°½ï¼ŒæœåŠ¡ä¸å¯ç”¨ã€‚

\- ğŸ¤¯ **ä»£ç æ··ä¹±**ï¼šä¸šåŠ¡é€»è¾‘å’Œæ•°æ®åº“è¿æ¥ä»£ç çº ç¼ ä¸æ¸…ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•ã€‚

\- ğŸ”€ **å¹¶å‘éšæ‚£**ï¼šåœ¨å¤šçº¿ç¨‹/å¼‚æ­¥ç¯å¢ƒä¸‹ï¼Œè¿æ¥å…±äº«å¯èƒ½å¼•å‘æ•°æ®é”™ä¹±ã€‚

FastAPIçš„å¼‚æ­¥ç‰¹æ€§è®©äº‹æƒ…å˜å¾—æ›´â€œå¾®å¦™â€ã€‚ç›´æ¥ç”¨ä¼ ç»Ÿçš„åŒæ­¥æ•°æ®åº“é©±åŠ¨ï¼ˆå¦‚`sqlite3`æ¨¡å—ï¼‰ä¼šé˜»å¡æ•´ä¸ªäº‹ä»¶å¾ªç¯ï¼Œ**å¼‚æ­¥ä¼˜åŠ¿è¡ç„¶æ— å­˜**ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ—¢èƒ½ç®¡ç†è¿æ¥ç”Ÿå‘½å‘¨æœŸï¼Œåˆèƒ½ä¸å¼‚æ­¥æ¡†æ¶å‹å¥½åä½œçš„è§£å†³æ–¹æ¡ˆã€‚

ğŸ§  äºŒã€åŸç†é€è§†ï¼šSQLAlchemyï¼Œä¸åªæ˜¯ORM
---------------------------

å¾ˆå¤šäººæŠŠSQLAlchemyç­‰åŒäºä¸€æ¬¾ORMï¼ˆå¯¹è±¡å…³ç³»æ˜ å°„ï¼‰å·¥å…·ã€‚è¿™æ²¡é”™ï¼Œä½†å®ƒçš„æ ¸å¿ƒä»·å€¼è¿œä¸æ­¢äºæ­¤ã€‚ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ª**å¼ºå¤§çš„â€œæ•°æ®åº“è¿æ¥ä¸æŸ¥è¯¢æ„å»ºå·¥å‚â€**ã€‚

æƒ³è±¡ä¸€ä¸‹é¤å…çš„åå¨ï¼š

\- ğŸ› ï¸ **å¼•æ“ï¼ˆEngineï¼‰**ï¼šé¤å…çš„â€œä¸­å¤®å¨æˆ¿â€ã€‚å®ƒæ˜¯æ•°æ®åº“è¿æ¥çš„å·¥å‚å’Œè¿æ¥æ± çš„æŒæœ‰è€…ã€‚ä½ é…ç½®å¥½ä¸€æ¬¡ï¼ˆæ•°æ®åº“åœ°å€ã€è¿æ¥å‚æ•°ã€æ± å¤§å°ï¼‰ï¼Œæ•´ä¸ªåº”ç”¨éƒ½ä»è¿™é‡Œâ€œå–ç”¨â€è¿æ¥ã€‚å®ƒæ˜¯å…¨å±€çš„ã€é‡é‡çº§çš„ã€‚

\- ğŸ§¾ **ä¼šè¯ï¼ˆSessionï¼‰**ï¼šå¨å¸ˆæ‰‹ä¸­çš„â€œè®¢å•ç¯®â€ã€‚ä¸€ä¸ªSessionä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„æ•°æ®åº“æ“ä½œâ€œå·¥ä½œå•å…ƒâ€ã€‚å®ƒä»Engineè·å–ä¸€ä¸ªç‰©ç†è¿æ¥ï¼Œç®¡ç†ä¸€ç³»åˆ—ç›¸å…³çš„å¢åˆ æ”¹æŸ¥ï¼Œå¹¶åœ¨å®Œæˆåâ€œå½’è¿˜â€è¿æ¥ã€‚å®ƒæ˜¯å±€éƒ¨çš„ã€è½»é‡çº§çš„ï¼Œ**å¹¶ä¸”ç»å¯¹ä¸åº”è¯¥è·¨è¯·æ±‚å…±äº«**ã€‚

\- ğŸ **ORMï¼ˆDeclarative Baseï¼‰**ï¼šæ ‡å‡†åŒ–çš„â€œèœè°±â€ã€‚å®ƒå®šä¹‰äº†æ•°æ®æ¨¡å‹ï¼ˆè¡¨ç»“æ„ï¼‰å’Œä¸šåŠ¡å¯¹è±¡ï¼ˆPythonç±»ï¼‰çš„æ˜ å°„å…³ç³»ï¼Œè®©ä½ èƒ½ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæ•°æ®åº“ã€‚

**å…³é”®ç»“è®ºï¼šé«˜æ€§èƒ½å­˜å–çš„æ ¸å¿ƒï¼Œåœ¨äºæ­£ç¡®ç®¡ç†Engineå’ŒSessionçš„ç”Ÿå‘½å‘¨æœŸã€‚** Engineé€šå¸¸åº”ç”¨å¯åŠ¨æ—¶åˆ›å»ºï¼Œå…³é—­æ—¶é”€æ¯ã€‚è€ŒSessionå¿…é¡»**â€œå³ç”¨å³åˆ›ï¼Œç”¨å®Œå³å…³â€**ï¼Œä¸”æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ã€‚

âš™ï¸ ä¸‰ã€å®æˆ˜æ¼”ç»ƒï¼šä¸‰æ­¥æ„å»ºé«˜æ•ˆæ•°æ®å±‚
-------------------

ç†è®ºè¯´å†å¤šï¼Œä¸å¦‚ä»£ç æ¥å¾—å®åœ¨ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€æ­¥æ­¥æ­å»ºä¸€ä¸ªå¯ç”¨çš„æ¡†æ¶ã€‚

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ ¸å¿ƒå¼•æ“ä¸æ¨¡å‹

æˆ‘ä»¬å…ˆåˆ›å»ºæ•°æ®åº“è¿æ¥çš„æ ¸å¿ƒï¼ˆEngineï¼‰å’Œæ•°æ®æ¨¡å‹çš„åŸºç±»ã€‚

    # database.py
    from sqlalchemy import create_engine
    from sqlalchemy.ext.declarative import declarative_base
    from sqlalchemy.orm import sessionmaker
    import os
    
    # å®šä¹‰æ•°æ®åº“æ–‡ä»¶è·¯å¾„
    SQLALCHEMY_DATABASE_URL = f"sqlite:///./test.db"
    
    # åˆ›å»ºå¼•æ“ (æ ¸å¿ƒ)
    # `connect_args={"check_same_thread": False}` å¯¹äºSQLiteå¤šçº¿ç¨‹æ˜¯å¿…é¡»çš„
    # `echo=True` å¼€å‘æ—¶å¼€å¯ï¼Œå¯ä»¥æŸ¥çœ‹ç”Ÿæˆçš„SQLï¼Œç”Ÿäº§ç¯å¢ƒè¯·å…³é—­
    # `pool_pre_ping=True` è¿æ¥æ± å–å‡ºè¿æ¥å‰è¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œé¿å…ä½¿ç”¨å¤±æ•ˆè¿æ¥
    engine = create_engine(
        SQLALCHEMY_DATABASE_URL,
        connect_args={"check_same_thread": False},
        echo=False, # ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºFalse
        pool_pre_ping=True,
        pool_size=5, # è¿æ¥æ± å¤§å°
        max_overflow=10 # å…è®¸è¶…å‡ºpool_sizeçš„ä¸´æ—¶è¿æ¥æ•°
    )
    
    # åˆ›å»ºä¼šè¯å·¥å‚ï¼Œç»‘å®šåˆ°å¼•æ“
    # `autocommit=False, autoflush=False` æ˜¯æ¨èè®¾ç½®ï¼Œä¾¿äºäº‹åŠ¡æ§åˆ¶
    SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
    
    # å£°æ˜æ€§åŸºç±»ï¼Œæ‰€æœ‰æ¨¡å‹ç±»éƒ½å°†ç»§æ‰¿è‡ªæ­¤
    Base = declarative_base()

### ç¬¬äºŒæ­¥ï¼šå®šä¹‰æ•°æ®æ¨¡å‹ä¸ä¾èµ–æ³¨å…¥

æ¥ç€ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç”¨æˆ·æ¨¡å‹ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè·å–æ•°æ®åº“ä¼šè¯çš„FastAPIä¾èµ–é¡¹ã€‚è¿™æ˜¯å®ç°â€œè¯·æ±‚çº§åˆ«Sessionâ€çš„å…³é”®ï¼

    # models.py
    from sqlalchemy import Column, Integer, String
    from database import Base
    
    class User(Base):
        __tablename__ = "users"
        id = Column(Integer, primary_key=True, index=True)
        username = Column(String, unique=True, index=True, nullable=False)
        email = Column(String, unique=True, index=True)
    
    # åˆ›å»ºè¡¨ï¼ˆé€šå¸¸åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
    # Base.metadata.create_all(bind=engine)
    
    # dependencies.py
    from database import SessionLocal
    from fastapi import Depends
    from typing import Generator
    
    def get_db() -> Generator:
        """
        æ•°æ®åº“ä¼šè¯ä¾èµ–é¡¹ã€‚
        æ¯ä¸ªè¯·æ±‚è·å–ä¸€ä¸ªç‹¬ç«‹Sessionï¼Œè¯·æ±‚ç»“æŸåç¡®ä¿å…³é—­ã€‚
        """
        db = SessionLocal()
        try:
            yield db # å°†dbæ³¨å…¥åˆ°è·¯ç”±å‡½æ•°ä¸­
        finally:
            db.close() # æ— è®ºè¯·æ±‚æˆåŠŸä¸å¦ï¼Œæœ€ç»ˆéƒ½ä¼šå…³é—­ä¼šè¯

### ç¬¬ä¸‰æ­¥ï¼šåœ¨è·¯ç”±ä¸­å®ç°CRUD

ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨APIè·¯ç”±ä¸­æ„‰å¿«åœ°ä½¿ç”¨æ•°æ®åº“äº†ã€‚æ³¨æ„çœ‹`db: Session = Depends(get_db)`è¿™è¡Œé­”æ³•ã€‚

    # main.py
    from fastapi import FastAPI, Depends, HTTPException
    from sqlalchemy.orm import Session
    from pydantic import BaseModel
    from typing import List
    from models import User
    from dependencies import get_db
    
    app = FastAPI()
    
    # Pydanticæ¨¡å‹ï¼Œç”¨äºè¯·æ±‚/å“åº”éªŒè¯
    class UserCreate(BaseModel):
        username: str
        email: str
    
    class UserResponse(BaseModel):
        id: int
        username: str
        email: str
    
        class Config:
            orm_mode = True # å…è®¸ä»ORMå¯¹è±¡è½¬æ¢
    
    @app.post("/users/", response_model=UserResponse)
    def create_user(user: UserCreate, db: Session = Depends(get_db)):
        # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
        db_user = db.query(User).filter(User.username == user.username).first()
        if db_user:
            raise HTTPException(status_code=400, detail="Username already registered")
        # åˆ›å»ºORMå¯¹è±¡
        db_user = User(username=user.username, email=user.email)
        # æ·»åŠ åˆ°ä¼šè¯
        db.add(db_user)
        # æäº¤äº‹åŠ¡
        db.commit()
        # åˆ·æ–°ï¼Œä½¿å¯¹è±¡è·å¾—æ•°æ®åº“ç”Ÿæˆçš„IDç­‰æ•°æ®
        db.refresh(db_user)
        return db_user
    
    @app.get("/users/", response_model=List[UserResponse])
    def read_users(skip: int = 0, limit: int = 10, db: Session = Depends(get_db)):
        users = db.query(User).offset(skip).limit(limit).all()
        return users

ğŸš¨ å››ã€æ³¨æ„äº‹é¡¹ä¸è¿›é˜¶æ€è€ƒ
--------------

æ­å–œä½ ï¼Œä¸€ä¸ªç»“æ„æ¸…æ™°ã€è¿æ¥é«˜æ•ˆçš„æ•°æ®å±‚å·²ç»æ­å»ºå®Œæˆã€‚ä½†åœ¨æŠ•å…¥ç”Ÿäº§å‰ï¼Œè¯·åŠ¡å¿…ç•™æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1\. **è¿æ¥æ± é…ç½®æ˜¯è‰ºæœ¯**ï¼š`pool_size`å’Œ`max_overflow`æ²¡æœ‰é“¶å¼¹ã€‚è®¾ç½®å¤ªå°ï¼Œé«˜å¹¶å‘æ—¶è¯·æ±‚æ’é˜Ÿï¼›è®¾ç½®å¤ªå¤§ï¼Œæµªè´¹èµ„æºç”šè‡³æ‹–å®æ•°æ®åº“ã€‚éœ€è¦æ ¹æ®å®é™…è´Ÿè½½å‹åŠ›æµ‹è¯•è°ƒæ•´ã€‚

2\. **Sessionçš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚ä¸€ä¸ªå¤æ‚çš„ä¸šåŠ¡æ“ä½œåº”è¯¥åœ¨åŒä¸€ä¸ªSessionä¸­å®Œæˆï¼Œä»¥ä¿è¯äº‹åŠ¡ä¸€è‡´æ€§ã€‚ä¸è¦åœ¨ä¸åŒè¯·æ±‚é—´å…±äº«Sessionã€‚

3\. **å¼‚æ­¥æ•°æ®åº“é©±åŠ¨**ï¼šå¯¹äºè¿½æ±‚æè‡´æ€§èƒ½æˆ–åŸç”Ÿå¼‚æ­¥æ•°æ®åº“ï¼ˆå¦‚PostgreSQLï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨`asyncpg` + `SQLAlchemy 1.4+`çš„å¼‚æ­¥æ¨¡å¼ã€‚è¿™æ—¶ï¼ŒEngineå’ŒSessionéƒ½éœ€è¦æ¢æˆå¼‚æ­¥ç‰ˆæœ¬ï¼ˆ`AsyncEngine`, `AsyncSession`ï¼‰ï¼Œä¾èµ–é¡¹ä¹Ÿè¦ç”¨`async with`ç®¡ç†ã€‚

4\. **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨SQLite**ï¼ˆé™¤éæ˜¯æå°è§„æ¨¡åº”ç”¨ï¼‰ã€‚SQLiteåœ¨é«˜å¹¶å‘å†™å…¥ã€åˆ†å¸ƒå¼éƒ¨ç½²æ–¹é¢æœ‰å¤©ç„¶é™åˆ¶ã€‚å®ƒéå¸¸é€‚åˆåŸå‹å¼€å‘ã€æµ‹è¯•å’Œå°å‹åªè¯»åº”ç”¨ã€‚

å‡åä¸€ä¸‹ï¼š**æˆ‘ä»¬å€ŸåŠ©SQLAlchemyï¼Œä¸ä»…ä»…æ˜¯å†™æ›´å°‘çš„SQLï¼Œæ›´æ˜¯å¼•å…¥äº†ä¸€å¥—æˆç†Ÿã€å¯æ§çš„æ•°æ®åº“è®¿é—®æ¨¡å¼ã€‚**å®ƒå°†ä½çº§çš„è¿æ¥ç®¡ç†ã€äº‹åŠ¡æ§åˆ¶æŠ½è±¡å‡ºæ¥ï¼Œè®©æˆ‘ä»¬èƒ½æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘æœ¬èº«ã€‚è€ŒFastAPIçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿï¼Œå®Œç¾åœ°å°†è¿™å¥—æ¨¡å¼æ•´åˆåˆ°è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå®ç°äº†èµ„æºç®¡ç†çš„è‡ªåŠ¨åŒ–ä¸ä¼˜é›…åŒ–ã€‚

* * *

\---**å†™åœ¨æœ€å**\---  
å¸Œæœ›è¿™ä»½æ€»ç»“èƒ½å¸®ä½ é¿å¼€ä¸€äº›å‘ã€‚å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œä¸å¦¨ç‚¹ä¸ª èµğŸ‘ æˆ– æ”¶è—â­ æ ‡è®°ä¸€ä¸‹ï¼Œæ–¹ä¾¿éšæ—¶å›é¡¾ã€‚ä¹Ÿæ¬¢è¿å…³æ³¨æˆ‘ï¼Œåç»­ä¸ºä½ å¸¦æ¥æ›´å¤šç±»ä¼¼çš„å®æˆ˜è§£æã€‚æœ‰ä»»ä½•ç–‘é—®æˆ–æƒ³æ³•ï¼Œæˆ‘ä»¬è¯„è®ºåŒºè§ï¼Œä¸€èµ·äº¤æµå¼€å‘ä¸­çš„å„ç§å¿ƒå¾—ä¸é—®é¢˜ã€‚