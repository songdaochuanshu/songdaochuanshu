---
layout: post
title: 'ã€Agentã€‘MemOS æºç ç¬”è®°---(6)---MemScheduler -- æ€»ä½“'
date: "2025-12-19T00:45:05Z"
---
ã€Agentã€‘MemOS æºç ç¬”è®°---(6)---MemScheduler -- æ€»ä½“
============================================

ã€Agentã€‘MemOS æºç ç¬”è®°---(6)---MemScheduler -- æ€»ä½“
============================================

ç›®å½•

*   [ã€Agentã€‘MemOS æºç ç¬”è®°---(6)---MemScheduler -- æ€»ä½“](#agentmemos-æºç ç¬”è®°---6---memscheduler----æ€»ä½“)
    *   [0x00 æ‘˜è¦](#0x00-æ‘˜è¦)
    *   [0x01 èƒ½åŠ›ä»‹ç»](#0x01-èƒ½åŠ›ä»‹ç»)
        *   [1.1 éœ€æ±‚](#11-éœ€æ±‚)
        *   [1.2 å¦‚ä½•è°ƒåº¦](#12-å¦‚ä½•è°ƒåº¦)
        *   [1.3 MemScheduler åŠŸèƒ½](#13-memscheduler-åŠŸèƒ½)
        *   [1.4 æ‰§è¡Œç¤ºä¾‹](#14-æ‰§è¡Œç¤ºä¾‹)
            *   [1.4.1 ä»£ç åŠŸèƒ½æ¦‚è¿°](#141-ä»£ç åŠŸèƒ½æ¦‚è¿°)
            *   [1.4.2 æ¡ˆä¾‹ï¼šå®¶åº­åŠ©ç†åœºæ™¯ä¸­çš„è®°å¿†è°ƒåº¦](#142-æ¡ˆä¾‹å®¶åº­åŠ©ç†åœºæ™¯ä¸­çš„è®°å¿†è°ƒåº¦)
    *   [0x02 MemScheduler åŸºæœ¬æ¦‚å¿µ](#0x02-memscheduler-åŸºæœ¬æ¦‚å¿µ)
        *   [2.1 æ ¸å¿ƒç»„ä»¶](#21-æ ¸å¿ƒç»„ä»¶)
        *   [2.2 ä¸»è¦ç‰¹ç‚¹](#22-ä¸»è¦ç‰¹ç‚¹)
        *   [2.3 BaseScheduler](#23-basescheduler)
            *   [2.3.1 å›¾ä¾‹](#231-å›¾ä¾‹)
            *   [2.3.2 å®šä¹‰](#232-å®šä¹‰)
        *   [2.4 æ¶ˆæ¯å¤„ç†](#24-æ¶ˆæ¯å¤„ç†)
            *   [2.4.1 æ¶ˆæ¯ç±»å‹](#241-æ¶ˆæ¯ç±»å‹)
            *   [2.4.2 è°ƒåº¦æ¶ˆæ¯ç»“æ„](#242-è°ƒåº¦æ¶ˆæ¯ç»“æ„)
        *   [2.5 å‡½æ•°å®ç°](#25-å‡½æ•°å®ç°)
    *   [0xFF å‚è€ƒ](#0xff-å‚è€ƒ)

0x00 æ‘˜è¦
-------

è®°å¿†è°ƒåº¦å°±åƒå¤§è„‘çš„æ³¨æ„åŠ›æœºåˆ¶ï¼ŒåŠ¨æ€å†³å®šåœ¨åˆé€‚çš„æ—¶åˆ»è°ƒç”¨åˆé€‚çš„è®°å¿†ã€‚

åœ¨ MemOS ä¸­ï¼Œ**è®°å¿†è°ƒåº¦ï¼ˆMemory Schedulingï¼‰** é€šè¿‡å¯¹ã€ä¸åŒä½¿ç”¨æ•ˆç‡ï¼ˆå‚æ•°>æ¿€æ´»>å·¥ä½œ>å…¶ä»–æ˜æ–‡ï¼‰çš„è®°å¿†ã€‘çš„ç›¸äº’è°ƒåº¦ï¼Œè®©æ¨¡å‹èƒ½æ›´é«˜æ•ˆã€å‡†ç¡®åœ°è·å–ç”¨æˆ·æ‰€éœ€çš„è®°å¿†ã€‚åœ¨å¯¹è¯å’Œä»»åŠ¡è¿›è¡Œæ—¶ï¼Œé€šè¿‡é¢„æµ‹ç”¨æˆ·åç»­å¯¹è¯æ‰€éœ€è®°å¿†å¹¶æå‰è°ƒå…¥é«˜æ•ˆç‡è®°å¿†ç±»å‹å¦‚æ¿€æ´»è®°å¿†å·¥ä½œè®°å¿†ï¼ŒåŠ é€Ÿæ¨ç†é“¾è·¯ã€‚

è®°å¿†è°ƒåº¦çš„å…·ä½“å®ç°å°±æ˜¯MemScheduler ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ MemOS ç³»ç»Ÿå¹¶è¡Œè¿è¡Œçš„å¹¶å‘è®°å¿†ç®¡ç†ç³»ç»Ÿï¼Œå®ƒåè°ƒ AI ç³»ç»Ÿä¸­å·¥ä½œè®°å¿†ã€é•¿æ—¶è®°å¿†å’Œæ¿€æ´»è®°å¿†ä¹‹é—´çš„è®°å¿†æ“ä½œã€‚å®ƒé€šè¿‡äº‹ä»¶é©±åŠ¨è°ƒåº¦å¤„ç†è®°å¿†æ£€ç´¢ã€æ›´æ–°å’Œå‹ç¼©ã€‚è¯¥ç³»ç»Ÿç‰¹åˆ«é€‚åˆéœ€è¦åŠ¨æ€è®°å¿†ç®¡ç†çš„å¯¹è¯ä»£ç†å’Œæ¨ç†ç³»ç»Ÿã€‚

å¤‡æ³¨ï¼šæœ¬æ–‡åŸºäºMemOSçš„æ–‡æ¡£å’Œæºç è¿›è¡Œå­¦ä¹ å’Œè§£è¯»ï¼Œä¼¼ä¹å…¶æ–‡æ¡£å¹¶æ²¡æœ‰è·Ÿä¸Šæºç æ›´æ–°çš„é€Ÿåº¦ï¼Œè€Œä¸”ä¹Ÿæœ‰éƒ¨åˆ†åŠŸèƒ½æœªå®ç°æˆ–è€…æœªå¼€æºã€‚

å› ä¸º MemScheduler å†…å®¹è¿‡å¤šï¼Œå› æ­¤åˆ†ä¸ºä¸¤ç¯‡ã€‚

0x01 èƒ½åŠ›ä»‹ç»
---------

MemOSï¼ˆMemory Operating Systemï¼‰æ˜¯é¢å‘ Agent çš„è®°å¿†æ“ä½œç³»ç»Ÿï¼Œè€Œ MemScheduler æ˜¯å…¶ä¸­çš„ â€œè°ƒåº¦å™¨â€ï¼Œç±»æ¯”æ“ä½œç³»ç»Ÿçš„ CPU è°ƒåº¦å™¨ï¼Œæ ¸å¿ƒè´Ÿè´£**æ‰€æœ‰è®°å¿†æ“ä½œçš„ç»Ÿç­¹ã€è°ƒåº¦ã€ä¼˜å…ˆçº§ç®¡ç†å’Œèµ„æºåˆ†é…**ã€‚å¯ä»¥è¯´ï¼ŒMemOSæä¾›äº†åŸºç¡€çš„è®°å¿†ç®¡ç†æ¡†æ¶ï¼Œè€ŒMemScheduleråˆ™åœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ äº†åŠ¨æ€è°ƒåº¦å’Œè‡ªåŠ¨åŒ–ç®¡ç†çš„èƒ½åŠ›ï¼Œä½¿å¾—æ•´ä¸ªè®°å¿†ç³»ç»Ÿæ›´åŠ æ™ºèƒ½åŒ–å’Œé«˜æ•ˆã€‚

### 1.1 éœ€æ±‚

æˆ‘ä»¬é¦–å…ˆçœ‹çœ‹ä¸ºä»€ä¹ˆéœ€è¦è°ƒåº¦ã€‚

åœ¨å¤æ‚çš„äº¤äº’é‡Œï¼Œå¦‚æœæ¯æ¬¡è¿‡æ¥åªé ç®€å•çš„å…¨å±€æœç´¢ï¼Œç³»ç»Ÿå¯èƒ½ä¼šï¼š

*   **å¤ªæ…¢**ï¼šç­‰åˆ°ç”¨æˆ·é—®å®Œå†ä¸´æ—¶æœç´¢ï¼Œé¦–Â TokenÂ å»¶è¿Ÿé«˜ã€‚
    
*   **ä¸å‡†**ï¼šå¤ªå¤šå†å²ï¼Œåè€Œæ·¹æ²¡äº†å…³é”®ä¿¡æ¯ï¼Œéš¾ä»¥æ£€ç´¢ã€‚
    

è°ƒåº¦çš„ä½œç”¨å°±æ˜¯è®©ç³»ç»Ÿå…·å¤‡â€œå³æ—¶å‡†å¤‡ã€å¿«é€Ÿå“åº”â€çš„èƒ½åŠ›ï¼š

*   **é¢„åŠ è½½**ï¼šåœ¨å¯¹è¯ä¸€å¼€å§‹ï¼Œå°±åŠ è½½ç”¨æˆ·çš„å¸¸ç”¨èƒŒæ™¯ã€‚
*   **é¢„æµ‹è°ƒç”¨**ï¼šåœ¨ç”¨æˆ·è¿˜æ²¡è¾“å…¥å®Œæ—¶ï¼Œæå‰å‡†å¤‡å¯èƒ½è¦ç”¨çš„è®°å¿†ã€‚

### 1.2 å¦‚ä½•è°ƒåº¦

å¯ä»¥ç»“åˆä»»åŠ¡è¯­ä¹‰ã€ä¸Šä¸‹æ–‡ã€è®¿é—®é¢‘ç‡ã€ç”Ÿå‘½å‘¨æœŸç­‰ä¿¡æ¯ï¼ŒåŠ¨æ€å®‰æ’è®°å¿†çš„è°ƒç”¨ä¸å­˜å‚¨ã€‚

ç»´åº¦

è¯´æ˜

è°ƒä»€ä¹ˆï¼Ÿ

å‚æ•°è®°å¿†ï¼ˆé•¿æœŸçŸ¥è¯†ä¸æŠ€èƒ½ï¼‰  
æ¿€æ´»è®°å¿†ï¼ˆè¿è¡Œæ—¶çš„Â KVÂ ç¼“å­˜ä¸éšå±‚çŠ¶æ€ï¼‰  
æ˜æ–‡è®°å¿†ï¼ˆå¤–éƒ¨å¯ç¼–è¾‘çš„äº‹å®ã€ç”¨æˆ·åå¥½ã€æ£€ç´¢ç‰‡æ®µï¼‰  
æ”¯æŒ`æ˜æ–‡Â â‡†Â æ¿€æ´»Â â‡†Â å‚æ•°`çš„åŠ¨æ€è¿ç§»ï¼Œé«˜é¢‘ä½¿ç”¨çš„æ˜æ–‡ç‰‡æ®µå¯ä»¥æå‰ç¼–è¯‘æˆÂ KVÂ ç¼“å­˜ï¼›é•¿æœŸç¨³å®šçš„æ¨¡æ¿å¯ä»¥æ²‰æ·€åˆ°å‚æ•°ä¸­ã€‚

ä»€ä¹ˆæ—¶å€™è°ƒï¼Ÿ

ä¸Šä¸‹æ–‡å’Œé«˜æ•ˆè®°å¿†ä¸è¶³ä»¥æ”¯æ’‘å›ç­”ç”¨æˆ·æé—®æ—¶è¿›è¡Œè®°å¿†ç»“æ„çš„ä¼˜åŒ–  
æ ¹æ®ç”¨æˆ·çš„æ„å›¾å’Œéœ€æ±‚ï¼Œå¯¹ç”¨æˆ·å¯èƒ½éœ€è¦çš„è®°å¿†å†…å®¹è¿›è¡Œæå‰çš„å‡†å¤‡  
åœ¨è¿ç»­æé—®è¿‡ç¨‹ä¸­ï¼Œè°ƒåº¦è®°å¿†ä¿æŒå¯¹è¯åœºæ™¯çš„é«˜æ•ˆå‡†ç¡®

è°ƒç»™è°ï¼Ÿ

å½“å‰ç”¨æˆ·ã€ç‰¹å®šè§’è‰²ä»£ç†ï¼ˆAgentï¼‰ã€æˆ–è·¨ä»»åŠ¡çš„å…±äº«ä¸Šä¸‹æ–‡

è°ƒæˆä»€ä¹ˆæ ·ï¼Ÿ

è®°å¿†ä¼šè¢«æ‰“ä¸Šçƒ­åº¦ã€æ—¶æ•ˆæ€§ã€é‡è¦æ€§ç­‰æŒ‡æ ‡ã€‚è°ƒåº¦å™¨æ®æ­¤å†³å®šå…ˆåŠ è½½è°ã€è°æ”¾å†·å­˜ã€è°éœ€è¦å½’æ¡£ã€‚

ä½¿ç”¨Â MemOSÂ äº‘æœåŠ¡æ—¶ï¼Œè°ƒåº¦çš„ä½œç”¨å¯ä»¥ä»Â `searchMemory`Â APIÂ çš„è¡¨ç°ä¸­è§‚æµ‹åˆ°ï¼š

*   å®ƒèƒ½å¿«é€Ÿè¿”å›ç›¸å…³è®°å¿†ï¼Œé¿å…ä¸Šä¸‹æ–‡æ–­è£‚ã€‚
*   è¿”å›çš„å†…å®¹å·²ç»è¿‡è°ƒåº¦å™¨ä¼˜åŒ–ï¼Œç¡®ä¿ç»“æœæ—¢ç›¸å…³åˆä¸ä¼šè¿‡è½½æ¨¡å‹è¾“å…¥ã€‚

### 1.3 MemScheduler åŠŸèƒ½

æ ¸å¿ƒèŒè´£å¦‚ä¸‹ã€‚

*   è®°å¿†å•å…ƒç¼–æ’ç®¡ç†
    *   ç®¡ç†å¤šä¸ª MemCube å®ä¾‹ï¼ˆå³è®°å¿†å®¹å™¨ï¼‰
    *   ä½œä¸ºæ“ä½œç³»ç»Ÿå±‚çº§æ¥å¤„ç†å’Œåè°ƒè¿™äº›è®°å¿†å•å…ƒ
    *   æä¾›åˆ›å»ºã€æœç´¢ã€æ›´æ–°å’Œåˆ é™¤è®°å¿†å•å…ƒçš„æ–¹æ³•
*   ä»»åŠ¡è°ƒåº¦ä¸è‡ªåŠ¨åŒ–
    *   é€šè¿‡é¢„å®šçš„æ“ä½œå®ç°è‡ªåŠ¨åŒ–çš„å†…å­˜ç®¡ç†ä»»åŠ¡
    *   å¤„ç†å„ç§å†…å­˜æ“ä½œï¼ŒåŒ…æ‹¬ï¼š
        *   æ·»åŠ æ–°è®°å¿†ï¼ˆADD\_LABELï¼‰
        *   å›ç­”æŸ¥è¯¢ï¼ˆANSWER\_LABELï¼‰
        *   å¤„ç†æŸ¥è¯¢ï¼ˆQUERY\_LABELï¼‰
*   å¤šç”¨æˆ·æ”¯æŒ
    *   è®¾è®¡ç”¨äºå¤šç”¨æˆ·åœºæ™¯ï¼Œå¹¶é‡‡ç”¨çº¿ç¨‹å®‰å…¨æ“ä½œ
    *   éªŒè¯ç”¨æˆ·å¯¹ç‰¹å®šè®°å¿†å•å…ƒçš„è®¿é—®æƒé™
    *   ä¸ºä¸åŒç”¨æˆ·æä¾›ç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ç¯å¢ƒ
*   è®°å¿†ç”Ÿå‘½å‘¨æœŸç®¡ç†
    *   åè°ƒä¿¡æ¯åœ¨ä¸åŒç»„ä»¶ä¹‹é—´çš„æµåŠ¨
    *   ç®¡ç†ä½•æ—¶ä»¥åŠå¦‚ä½•å¤„ç†ã€å­˜å‚¨å’Œæ£€ç´¢è®°å¿†
    *   ä¸å…¶ä»– MemOS ç»„ä»¶ï¼ˆå¦‚ MemReader å’Œå¤§è¯­è¨€æ¨¡å‹ï¼‰é›†æˆ

### 1.4 æ‰§è¡Œç¤ºä¾‹

å®˜æ–¹æ–‡æ¡£ä¸­è¯´ï¼Œ`examples/mem_scheduler/schedule_w_memos.py` æ˜¯ä¸€ä¸ªæ¼”ç¤ºè„šæœ¬ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨ `MemScheduler` æ¨¡å—ã€‚å®ƒè¯´æ˜äº†å¯¹è¯ä¸Šä¸‹æ–‡ä¸­çš„è®°å¿†ç®¡ç†å’Œæ£€ç´¢ã€‚

#### 1.4.1 ä»£ç åŠŸèƒ½æ¦‚è¿°

æ­¤è„šæœ¬æ¼”ç¤ºäº†åˆå§‹åŒ–å’Œä½¿ç”¨è®°å¿†è°ƒåº¦å™¨çš„ä¸¤ç§æ–¹æ³•ï¼š

1.  **è‡ªåŠ¨åˆå§‹åŒ–**: é€šè¿‡é…ç½®æ–‡ä»¶é…ç½®è°ƒåº¦å™¨
2.  **æ‰‹åŠ¨åˆå§‹åŒ–**: æ˜¾å¼åˆ›å»ºå’Œé…ç½®è°ƒåº¦å™¨ç»„ä»¶

è¯¥è„šæœ¬æ¨¡æ‹Ÿç”¨æˆ·å’ŒåŠ©æ‰‹ä¹‹é—´å…³äºå® ç‰©çš„å¯¹è¯ï¼Œæ¼”ç¤ºè®°å¿†è°ƒåº¦å™¨å¦‚ä½•ç®¡ç†å¯¹è¯å†å²å¹¶æ£€ç´¢ç›¸å…³ä¿¡æ¯ã€‚

#### 1.4.2 æ¡ˆä¾‹ï¼šå®¶åº­åŠ©ç†åœºæ™¯ä¸­çš„è®°å¿†è°ƒåº¦

**å‰æ®µæ—¶é—´ï¼šç”¨æˆ·å¿™ç€ä¹°æˆ¿**

ç”¨æˆ·ç»å¸¸è¯´ï¼š

*   â€œå¸®æˆ‘æŸ¥ä¸€ä¸‹Â XXÂ å°åŒºçš„äºŒæ‰‹æˆ¿å‡ä»·ã€‚â€
    
*   â€œæé†’æˆ‘å‘¨å…­å»çœ‹æˆ¿ã€‚â€
    
*   â€œè®°å½•ä¸€ä¸‹æˆ¿è´·åˆ©ç‡çš„æœ€æ–°å˜åŒ–ã€‚â€
    

MemOSç³»ç»Ÿæ“ä½œ

*   ç³»ç»Ÿæœ€åˆå°†è¿™äº›æ¡ç›®éƒ½ç”ŸæˆÂ **æ˜æ–‡è®°å¿†**ã€‚
*   å› ä¸ºâ€œä¹°æˆ¿â€ç›¸å…³ä¿¡æ¯è¢«é¢‘ç¹æåŠï¼Œè°ƒåº¦å™¨åœ¨åå°åˆ¤æ–­å®ƒæ˜¯è¿‘æœŸçš„**æ ¸å¿ƒä¸»é¢˜**ï¼Œäºæ˜¯å°†è¿™äº›æ˜æ–‡è¿ç§»ä¸ºÂ **æ¿€æ´»è®°å¿†**ï¼Œè®©åç»­æŸ¥è¯¢æ›´å¿«æ›´ç›´æ¥ã€‚

**æœ€è¿‘ï¼šç”¨æˆ·æˆ¿å­ä¹°å¥½äº†å¼€å§‹è£…ä¿®**

ç”¨æˆ·å¼€å§‹é¢‘ç¹æåˆ°ï¼š

*   â€œå‘¨æœ«è¦å»çœ‹ç“·ç –ã€‚â€
    
*   â€œæé†’æˆ‘å’Œè£…ä¿®å…¬å¸ç¡®è®¤æ°´ç”µæ”¹é€ ã€‚â€
    
*   â€œè®°ä¸€ä¸‹ä¸‹å‘¨å®¶å…·é€è´§æ—¶é—´ã€‚â€
    

MemOSç³»ç»Ÿæ“ä½œ

*   ç³»ç»Ÿç»§ç»­ç”Ÿæˆæ–°çš„Â **æ˜æ–‡è®°å¿†**ã€‚
*   è°ƒåº¦å™¨æ£€æµ‹åˆ°â€œè£…ä¿®â€å·²ç»æˆä¸ºæ–°çš„é«˜é¢‘ä¸»é¢˜ï¼Œäºæ˜¯æŠŠè¿™äº›æ¡ç›®è¿ç§»ä¸ºÂ **æ¿€æ´»è®°å¿†**ã€‚
*   åŒæ—¶ï¼Œä¹‹å‰â€œä¹°æˆ¿â€ç›¸å…³æ¿€æ´»è®°å¿†ä¸å†è¢«é¢‘ç¹ä½¿ç”¨ï¼Œä¼šè¢«è‡ªåŠ¨**é™çº§å›æ˜æ–‡å±‚**ï¼Œä»¥å‡å°‘æ´»è·ƒå ç”¨ã€‚

**å½“å‰æ—¶åˆ»ï¼šç”¨æˆ·éšå£è¯´â€”â€”æˆ‘æ„Ÿè§‰å¥½å¤šäº‹å †åœ¨ä¸€èµ·ï¼Œä½ å¸®æˆ‘ç†ä¸€ä¸‹**

å¦‚æœæ²¡æœ‰è°ƒåº¦ï¼Œç³»ç»Ÿåªèƒ½å…¨åº“æ£€ç´¢ï¼ŒæŠŠæ‰€æœ‰å¯èƒ½ç›¸å…³çš„è®°å¿†æ‹‰å‡ºæ¥ï¼š

*   çœ‹ç“·ç –ï¼ˆè£…ä¿®ï¼‰
*   ç¡®è®¤æ°´ç”µæ”¹é€ ï¼ˆè£…ä¿®ï¼‰
*   å®¶å…·é€è´§ï¼ˆè£…ä¿®ï¼‰
*   æŸ¥æˆ¿ä»·ï¼ˆä¹°æˆ¿æ—¶æœŸï¼Œè¿‡æ—¶ï¼‰
*   çœ‹æˆ¿ï¼ˆä¹°æˆ¿æ—¶æœŸï¼Œè¿‡æ—¶ï¼‰
*   ä¹°èœï¼ˆç”Ÿæ´»çäº‹ï¼‰
*   çœ‹ç”µå½±ï¼ˆç”Ÿæ´»çäº‹ï¼‰

æœ‰è°ƒåº¦æ—¶ï¼Œç³»ç»Ÿå¯ä»¥æ›´å¿«é€Ÿè¿”å›

*   çœ‹ç“·ç –
    
*   ç¡®è®¤æ°´ç”µæ”¹é€ 
    
*   å®¶å…·é€è´§
    
    ğŸ‘‰Â **ç”¨æˆ·ä½“æ„ŸÂ UP**
    
*   å“åº”æ›´å¿«ï¼ˆå› ä¸ºä¸éœ€è¦å…¨åº“æ£€ç´¢ï¼‰ã€‚
    
*   åˆ—å‡ºçš„å°±æ˜¯è‡ªå·±æœ€æŒ‚å¿µçš„äº‹Â â†’Â æ„Ÿè§‰åŠ©ç†â€œå¾ˆæ‡‚æˆ‘â€
    

ç„¶è€Œï¼Œå®é™…ä¸Šï¼Œåœ¨ä»£ç ä¸­åªèƒ½æ‰¾åˆ°è¿™ä¸ªä¾‹å­ï¼šMemOS-main\\examples\\mem\_scheduler\\memos\_w\_scheduler.pyã€‚

æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚

0x02 MemScheduler åŸºæœ¬æ¦‚å¿µ
----------------------

MemScheduler å®é™…ä¸Šæ‰®æ¼”ç€ MemOS ç³»ç»Ÿçš„â€œè¿›ç¨‹ç®¡ç†å™¨â€è§’è‰²ï¼Œç¡®ä¿æŒ‰ç…§ç³»ç»Ÿçš„ç­–ç•¥å’Œç”¨æˆ·éœ€æ±‚æ­£ç¡®åœ°åè°ƒã€è°ƒåº¦å’Œæ‰§è¡Œå†…å­˜æ“ä½œã€‚

### 2.1 æ ¸å¿ƒç»„ä»¶

`MemScheduler` ç³»ç»Ÿå›´ç»•å‡ ä¸ªå…³é”®ç»„ä»¶æ„å»ºï¼š

*   æ¶ˆæ¯å¤„ç†: é€šè¿‡å¸¦æœ‰æ ‡è®°processorçš„è°ƒåº¦å™¨å¤„ç†ä¼ å…¥æ¶ˆæ¯
*   è®°å¿†ç®¡ç†: ç®¡ç†ä¸åŒçš„è®°å¿†ç±»å‹ (å·¥ä½œã€é•¿æ—¶ã€ç”¨æˆ·)
*   æ£€ç´¢ç³»ç»Ÿ: åŸºäºä¸Šä¸‹æ–‡é«˜æ•ˆæ£€ç´¢ç›¸å…³è®°å¿†é¡¹
*   ç›‘æ§: è·Ÿè¸ªè®°å¿†ä½¿ç”¨ã€é¢‘ç‡å’Œè§¦å‘æ›´æ–°
*   è°ƒåº¦å™¨ (è·¯ç”±å™¨): é€šè¿‡æ£€æŸ¥æ¥è‡ª MemOS ç³»ç»Ÿçš„æ¶ˆæ¯è§¦å‘ä¸åŒçš„è®°å¿†é‡åˆ†é…ç­–ç•¥ã€‚
*   æ—¥å¿—è®°å½•: ç»´æŠ¤è®°å¿†æ“ä½œæ—¥å¿—ç”¨äºè°ƒè¯•å’Œåˆ†æ

### 2.2 ä¸»è¦ç‰¹ç‚¹

*   æ¨¡å—åŒ–æ¶æ„
    *   é‡‡ç”¨æ’ä»¶å¼æ¶æ„ï¼Œå¯é€šè¿‡é…ç½®è¿›è¡Œå®šåˆ¶
    *   é€šè¿‡å·¥å‚æ¨¡å¼æ”¯æŒä¸åŒçš„å®ç°æ–¹å¼
    *   å…è®¸è‡ªå®šä¹‰è°ƒåº¦è¡Œä¸º
*   ä»»åŠ¡è°ƒåº¦
    *   è‡ªåŠ¨å¤„ç†è®°å¿†çš„æ·»åŠ ã€æŸ¥è¯¢ã€æ›´æ–°ç­‰æ“ä½œ
    *   æ”¯æŒå®šæ—¶ä»»åŠ¡å’Œäº‹ä»¶é©±åŠ¨çš„ä»»åŠ¡
*   ä¸ MOS æ ¸å¿ƒé›†æˆ
    *   ä¸ä¸» MOS åŠŸèƒ½ååŒå·¥ä½œ
    *   å¯é€šè¿‡é…ç½®å¯ç”¨/ç¦ç”¨
    *   å¤„ç†æ¶ˆæ¯å¹¶åè°ƒå†…å­˜æ“ä½œ
*   åå°å¤„ç†
    *   åœ¨åå°è¿è¡Œè®¡åˆ’ä»»åŠ¡
    *   æ”¯æŒå¯åŠ¨å’Œåœæ­¢è°ƒåº¦æœåŠ¡
    *   ç®¡ç†å†…å­˜æ“ä½œçš„èµ„æºåˆ†é…

### 2.3 BaseScheduler

*   è¯¥ç±»æ˜¯ MemOS çš„æ ¸å¿ƒè°ƒåº¦å™¨åŸºç±»ï¼Œæ•´åˆäº†æ¶ˆæ¯é˜Ÿåˆ—ã€å†…å­˜ç®¡ç†ã€ä»»åŠ¡åˆ†å‘ã€ç›‘æ§ç­‰åŠŸèƒ½ï¼Œç”¨äºç»Ÿç­¹å†…å­˜ç«‹æ–¹ä½“ï¼ˆMemCubeï¼‰çš„è°ƒåº¦é€»è¾‘ã€‚
*   æ ¸å¿ƒèƒ½åŠ›åŒ…æ‹¬å·¥ä½œå†…å­˜æ›¿æ¢ã€æ¿€æ´»å†…å­˜å‘¨æœŸæ€§æ›´æ–°ã€æ¶ˆæ¯æäº¤ä¸æ¶ˆè´¹ã€å¤šçº¿ç¨‹å¹¶è¡Œä»»åŠ¡åˆ†å‘ï¼ŒåŒæ—¶æ”¯æŒ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—å’Œ Redis å­˜å‚¨é›†æˆã€‚
*   æ”¯æŒåŠ¨æ€ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé€šè¿‡é…ç½®çµæ´»å¯ç”¨ / ç¦ç”¨æ¿€æ´»å†…å­˜ã€å¹¶è¡Œåˆ†å‘ç­‰åŠŸèƒ½ï¼Œé€‚é…ä¸åŒåœºæ™¯éœ€æ±‚ã€‚
*   ç‰¹è‰²æ˜¯æ¨¡å—åŒ–è®¾è®¡ï¼ˆé›†æˆæ£€ç´¢å™¨ã€ç›‘æ§å™¨ã€åˆ†å‘å™¨ç­‰å­æ¨¡å—ï¼‰ï¼Œçº¿ç¨‹å®‰å…¨çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œä¼˜é›…çš„å¯åŠ¨ / åœæ­¢æœºåˆ¶ï¼Œä»¥åŠå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚

#### 2.3.1 å›¾ä¾‹

å…·ä½“æ¶æ„å¦‚ä¸‹ã€‚

    +================================================+
    |               BaseScheduler                    |
    |  (æ•´åˆæ¶ˆæ¯é˜Ÿåˆ—ã€å†…å­˜ç®¡ç†ã€ä»»åŠ¡åˆ†å‘çš„æ ¸å¿ƒè°ƒåº¦å™¨)       |
    +================================================+
    | åˆå§‹åŒ–æµç¨‹:                                      |
    |  +------------------------+                    |
    |  | æ¥æ”¶é…ç½®å‚æ•°             |                     |
    |  +------------------------+                     |
    |  | è®¾ç½®è¶…å‚æ•° (top_k/çª—å£å¤§å°ç­‰) |                 |
    |  +------------------------+                     |
    |  | åˆå§‹åŒ–å†…éƒ¨æ¶ˆæ¯é˜Ÿåˆ—        |                     |
    |  +------------------------+                     |
    |  | å»¶è¿Ÿåˆå§‹åŒ–å­æ¨¡å—          |                     |
    |  | (æ£€ç´¢å™¨/ç›‘æ§å™¨/åˆ†å‘å™¨)    |                     |
    |  +------------------------+                     |
    +=================================================+
    | å­æ¨¡å—åˆå§‹åŒ–æµç¨‹:                                  |
    |  +------------------------+                     |
    |  | ç»‘å®šLLMå®ä¾‹              |                     |
    |  +------------------------+                     |
    |  | åˆå§‹åŒ–ç›‘æ§å™¨(é€šç”¨/åˆ†å‘)    |                     |
    |  +------------------------+                     |
    |  | åˆå§‹åŒ–æ£€ç´¢å™¨             |                     |
    |  +------------------------+                     |
    |  | åŠ è½½è®¤è¯é…ç½®             |                     |
    |  +------------------------+                     |
    |  | åˆå§‹åŒ–RabbitMQè¿æ¥       |                     |
    |  +------------------------+                     |
    +=================================================+
    | æ¶ˆæ¯å¤„ç†æµç¨‹:                                     |
    |  +------------------------+                     |
    |  | æäº¤æ¶ˆæ¯åˆ°é˜Ÿåˆ—            |                     |
    |  | (æ”¯æŒå•æ¡/å¤šæ¡æ¶ˆæ¯)       |                     |
    |  +------------------------+                     |
    |  | æ¶ˆè´¹çº¿ç¨‹å¾ªç¯æ£€æµ‹é˜Ÿåˆ—       |                     |
    |  | (æŒ‰é—´éš”æ‰¹é‡å–æ¶ˆæ¯)        |                     |
    |  +------------------------+                     |
    |  | åˆ†å‘å™¨è°ƒåº¦ä»»åŠ¡æ‰§è¡Œ        |                     |
    |  | (å¹¶è¡Œ/ä¸²è¡Œæ¨¡å¼å¯é€‰)       |                     |
    |  +------------------------+                     |
    +=================================================+
    | å·¥ä½œå†…å­˜æ›¿æ¢æµç¨‹:                                  |
    |  +------------------------+                     |
    |  | è·å–ç”¨æˆ·æŸ¥è¯¢å†å²          |                     |
    |  +------------------------+                     |
    |  | é‡æ–°æ’åºå†…å­˜(LLMå‚ä¸)     |                     |
    |  +------------------------+                     |
    |  | è¿‡æ»¤ä¸ç›¸å…³å†…å­˜            |                     |
    |  +------------------------+                     |
    |  | æ›´æ–°å†…å­˜ç›‘æ§å™¨           |                     |
    |  +------------------------+                     |
    |  | æ›¿æ¢æ–‡æœ¬å†…å­˜ä¸­çš„å·¥ä½œé›†     |                     |
    |  +------------------------+                     |
    +=================================================+
    | æ¿€æ´»å†…å­˜æ›´æ–°æµç¨‹:                                  |
    |  +------------------------+                     |
    |  | æ£€æŸ¥æ›´æ–°é—´éš”æ˜¯å¦åˆ°è¾¾       |                     |
    |  +------------------------+                     |
    |  | ä»ç›‘æ§å™¨è·å–æ–°å†…å­˜        |                     |
    |  +------------------------+                     |
    |  | ç»„è£…æ–‡æœ¬å¹¶æå–KVç¼“å­˜      |                     |
    |  +------------------------+                     |
    |  | æ¸…é™¤æ—§ç¼“å­˜å¹¶æ·»åŠ æ–°ç¼“å­˜     |                     |
    |  +------------------------+                     |
    |  | æŒä¹…åŒ–ç¼“å­˜åˆ°ç£ç›˜          |                     |
    |  +------------------------+                     |
    +=================================================+
    | å¯åŠ¨/åœæ­¢æµç¨‹:                                    |
    | å¯åŠ¨:                                            |
    |  +------------------------+                     |
    |  | åˆå§‹åŒ–åˆ†å‘å™¨çº¿ç¨‹æ±         |                     |
    |  +------------------------+                     |
    |  | å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹          |                     |
    |  +------------------------+                     |
    | åœæ­¢:                                            |
    |  +------------------------+                     |
    |  | æ ‡è®°è¿è¡ŒçŠ¶æ€ä¸ºåœæ­¢        |                     |
    |  +------------------------+                     |
    |  | ç­‰å¾…æ¶ˆè´¹çº¿ç¨‹é€€å‡º          |                     |
    |  +------------------------+                     |
    |  | å…³é—­åˆ†å‘å™¨/ç›‘æ§å™¨         |                     |
    |  +------------------------+                     |
    |  | æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—          |                     |
    |  +------------------------+                     |
    +=================================================+
    

#### 2.3.2 å®šä¹‰

ä»£ç å¦‚ä¸‹ã€‚

    class BaseScheduler(RabbitMQSchedulerModule, RedisSchedulerModule, SchedulerLoggerModule):
        """æ‰€æœ‰å†…å­˜è°ƒåº¦å™¨çš„åŸºç±»ï¼Œæ•´åˆæ¶ˆæ¯é˜Ÿåˆ—ã€å†…å­˜ç®¡ç†å’Œä»»åŠ¡åˆ†å‘åŠŸèƒ½"""
    
        def __init__(self, config: BaseSchedulerConfig):
            """ä½¿ç”¨ç»™å®šé…ç½®åˆå§‹åŒ–è°ƒåº¦å™¨"""
            super().__init__()
            self.config = config  # å­˜å‚¨è°ƒåº¦å™¨é…ç½®
    
            # è¶…å‚æ•°é…ç½®ï¼ˆä»é…ç½®ä¸­è¯»å–ï¼Œæ— åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼‰
            self.top_k = self.config.get("top_k", 10)  # æ£€ç´¢æ—¶è¿”å›çš„Top-Kç»“æœæ•°
            self.context_window_size = self.config.get("context_window_size", 5)  # ä¸Šä¸‹æ–‡çª—å£å¤§å°
            self.enable_activation_memory = self.config.get("enable_activation_memory", False)  # æ˜¯å¦å¯ç”¨æ¿€æ´»å†…å­˜
            self.act_mem_dump_path = self.config.get("act_mem_dump_path", DEFAULT_ACT_MEM_DUMP_PATH)  # æ¿€æ´»å†…å­˜å­˜å‚¨è·¯å¾„
            self.search_method = TreeTextMemory_SEARCH_METHOD  # æ–‡æœ¬å†…å­˜æœç´¢æ–¹æ³•
            self.enable_parallel_dispatch = self.config.get("enable_parallel_dispatch", False)  # æ˜¯å¦å¯ç”¨å¹¶è¡Œåˆ†å‘
            self.thread_pool_max_workers = self.config.get(
                "thread_pool_max_workers", DEFAULT_THREAD__POOL_MAX_WORKERS
            )  # çº¿ç¨‹æ± æœ€å¤§å·¥ä½œçº¿ç¨‹æ•°
    
            # å­æ¨¡å—åˆå§‹åŒ–ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé€šè¿‡initialize_modulesæ–¹æ³•å®Œæˆï¼‰
            self.retriever: SchedulerRetriever | None = None  # æ£€ç´¢å™¨ï¼šç”¨äºå†…å­˜æ£€ç´¢å’Œæ’åº
            self.db_engine: Engine | None = None  # æ•°æ®åº“å¼•æ“ï¼šç”¨äºæ•°æ®æŒä¹…åŒ–
            self.monitor: SchedulerGeneralMonitor | None = None  # é€šç”¨ç›‘æ§å™¨ï¼šç›‘æ§è°ƒåº¦å™¨è¿è¡ŒçŠ¶æ€
            self.dispatcher_monitor: SchedulerDispatcherMonitor | None = None  # åˆ†å‘å™¨ç›‘æ§å™¨ï¼šç›‘æ§ä»»åŠ¡åˆ†å‘
            # ä»»åŠ¡åˆ†å‘å™¨ï¼šç®¡ç†ä»»åŠ¡åˆ†å‘ï¼Œæ”¯æŒå¹¶è¡Œ/ä¸²è¡Œæ¨¡å¼
            self.dispatcher = SchedulerDispatcher(
                max_workers=self.thread_pool_max_workers,
                enable_parallel_dispatch=self.enable_parallel_dispatch,
            )
    
            # å†…éƒ¨æ¶ˆæ¯é˜Ÿåˆ—é…ç½®
            self.max_internal_message_queue_size = self.config.get(
                "max_internal_message_queue_size", 100
            )  # å†…éƒ¨æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§å®¹é‡
            self.memos_message_queue: Queue[ScheduleMessageItem] = Queue(
                maxsize=self.max_internal_message_queue_size
            )  # è°ƒåº¦æ¶ˆæ¯é˜Ÿåˆ—
            self.max_web_log_queue_size = self.config.get("max_web_log_queue_size", 50)  # Webæ—¥å¿—é˜Ÿåˆ—æœ€å¤§å®¹é‡
            self._web_log_message_queue: Queue[ScheduleLogForWebItem] = Queue(
                maxsize=self.max_web_log_queue_size
            )  # Webæ—¥å¿—å­˜å‚¨é˜Ÿåˆ—
            self._consumer_thread = None  # æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹å¼•ç”¨
            self._running = False  # è°ƒåº¦å™¨è¿è¡ŒçŠ¶æ€æ ‡è¯†
            self._consume_interval = self.config.get(
                "consume_interval_seconds", DEFAULT_CONSUME_INTERVAL_SECONDS
            )  # æ¶ˆæ¯æ¶ˆè´¹é—´éš”ï¼ˆç§’ï¼‰
    
            # å…¶ä»–å±æ€§
            self._context_lock = threading.Lock()  # ä¸Šä¸‹æ–‡é”ï¼šä¿è¯çº¿ç¨‹å®‰å…¨
            self.current_user_id: UserID | str | None = None  # å½“å‰ç”¨æˆ·ID
            self.current_mem_cube_id: MemCubeID | str | None = None  # å½“å‰å†…å­˜ç«‹æ–¹ä½“ID
            self.current_mem_cube: GeneralMemCube | None = None  # å½“å‰å†…å­˜ç«‹æ–¹ä½“å®ä¾‹
            self.auth_config_path: str | Path | None = self.config.get("auth_config_path", None)  # è®¤è¯é…ç½®æ–‡ä»¶è·¯å¾„
            self.auth_config = None  # è®¤è¯é…ç½®å®ä¾‹
            self.rabbitmq_config = None  # RabbitMQé…ç½®å®ä¾‹
    
        def initialize_modules(
            self,
            chat_llm: BaseLLM,
            process_llm: BaseLLM | None = None,
            db_engine: Engine | None = None,
        ):
            """åˆå§‹åŒ–è°ƒåº¦å™¨çš„æ‰€æœ‰å­æ¨¡å—ï¼ˆæ£€ç´¢å™¨ã€ç›‘æ§å™¨ã€åˆ†å‘å™¨ç­‰ï¼‰"""
            # è‹¥æœªæŒ‡å®šå¤„ç†ç”¨LLMï¼Œé»˜è®¤ä½¿ç”¨èŠå¤©ç”¨LLM
            if process_llm is None:
                process_llm = chat_llm
    
            try:
                # å­˜å‚¨LLMå®ä¾‹
                self.chat_llm = chat_llm
                self.process_llm = process_llm
                self.db_engine = db_engine
    
                # åˆå§‹åŒ–é€šç”¨ç›‘æ§å™¨ï¼šç›‘æ§å†…å­˜å’ŒæŸ¥è¯¢çŠ¶æ€
                self.monitor = SchedulerGeneralMonitor(
                    process_llm=self.process_llm, config=self.config, db_engine=self.db_engine
                )
                self.db_engine = self.monitor.db_engine  # åŒæ­¥ç›‘æ§å™¨çš„æ•°æ®åº“å¼•æ“
    
                # åˆå§‹åŒ–åˆ†å‘å™¨ç›‘æ§å™¨ï¼šç›‘æ§ä»»åŠ¡åˆ†å‘çŠ¶æ€
                self.dispatcher_monitor = SchedulerDispatcherMonitor(config=self.config)
                # åˆå§‹åŒ–æ£€ç´¢å™¨ï¼šå¤„ç†å†…å­˜æ£€ç´¢ã€æ’åºå’Œè¿‡æ»¤
                self.retriever = SchedulerRetriever(process_llm=self.process_llm, config=self.config)
    
                # è‹¥å¯ç”¨å¹¶è¡Œåˆ†å‘ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨åˆ†å‘å™¨ç›‘æ§å™¨
                if self.enable_parallel_dispatch:
                    self.dispatcher_monitor.initialize(dispatcher=self.dispatcher)
                    self.dispatcher_monitor.start()
    
                # åˆå§‹åŒ–è®¤è¯é…ç½®
                if self.auth_config_path is not None and Path(self.auth_config_path).exists():
                    # ä»æŒ‡å®šè·¯å¾„åŠ è½½è®¤è¯é…ç½®
                    self.auth_config = AuthConfig.from_local_config(config_path=self.auth_config_path)
                elif AuthConfig.default_config_exists():
                    # ä»é»˜è®¤è·¯å¾„åŠ è½½è®¤è¯é…ç½®
                    self.auth_config = AuthConfig.from_local_config()
                else:
                    # ä»ç¯å¢ƒå˜é‡åŠ è½½è®¤è¯é…ç½®
                    self.auth_config = AuthConfig.from_local_env()
    
                # è‹¥åŠ è½½åˆ°è®¤è¯é…ç½®ï¼Œåˆå§‹åŒ–RabbitMQ
                if self.auth_config is not None:
                    self.rabbitmq_config = self.auth_config.rabbitmq
                    self.initialize_rabbitmq(config=self.rabbitmq_config)
    
            except Exception as e:
                logger.error(f"Failed to initialize scheduler modules: {e}", exc_info=True)
                # åˆå§‹åŒ–å¤±è´¥æ—¶æ¸…ç†éƒ¨åˆ†åˆå§‹åŒ–çš„èµ„æº
                self._cleanup_on_init_failure()
                raise
    
    

### 2.4 æ¶ˆæ¯å¤„ç†

è°ƒåº¦å™¨é€šè¿‡å¸¦æœ‰ä¸“ç”¨processorçš„è°ƒåº¦å™¨æ¥å¤„ç†æ¶ˆæ¯ã€‚

#### 2.4.1 æ¶ˆæ¯ç±»å‹

æ¶ˆæ¯ç±»å‹

processoræ–¹æ³•

æè¿°

`QUERY_LABEL`

`_query_message_consume`

å¤„ç†ç”¨æˆ·æŸ¥è¯¢å¹¶è§¦å‘æ£€ç´¢

`ANSWER_LABEL`

`_answer_message_consume`

å¤„ç†ç­”æ¡ˆå¹¶æ›´æ–°è®°å¿†ä½¿ç”¨

#### 2.4.2 è°ƒåº¦æ¶ˆæ¯ç»“æ„

è°ƒåº¦å™¨ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼ˆScheduleMessageItemï¼‰å¤„ç†æ¥è‡ªå…¶é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼š

å­—æ®µ

ç±»å‹

æè¿°

`item_id`

`str`

UUID (è‡ªåŠ¨ç”Ÿæˆ) ç”¨äºå”¯ä¸€æ ‡è¯†

`user_id`

`str`

å…³è”ç”¨æˆ·çš„æ ‡è¯†ç¬¦

`mem_cube_id`

`str`

mem cube çš„æ ‡è¯†ç¬¦

`label`

`str`

æ¶ˆæ¯æ ‡ç­¾ (ä¾‹å¦‚ï¼Œ`QUERY_LABEL`ã€`ANSWER_LABEL`)

`mem_cube`

`GeneralMemCubeï½œstr`

mem cube å¯¹è±¡æˆ–å¼•ç”¨

`content`

`str`

æ¶ˆæ¯å†…å®¹

`timestamp`

`datetime`

æ¶ˆæ¯æäº¤æ—¶é—´

åŒæ—¶è°ƒåº¦å™¨å°†æŒ‰ç…§ä»¥ä¸‹ç»“æ„ï¼ˆScheduleLogForWebItemï¼‰å‘é€è°ƒåº¦æ¶ˆæ¯ã€‚

å­—æ®µ

ç±»å‹

æè¿°

é»˜è®¤å€¼

`item_id`

`str`

å”¯ä¸€æ—¥å¿—æ¡ç›®æ ‡è¯†ç¬¦ (UUIDv4)

è‡ªåŠ¨ç”Ÿæˆ (`uuid4()`)

`user_id`

`str`

å…³è”ç”¨æˆ·æ ‡è¯†ç¬¦

(å¿…éœ€)

`mem_cube_id`

`str`

é“¾æ¥çš„ mem cube ID

(å¿…éœ€)

`label`

`str`

æ—¥å¿—ç±»åˆ«æ ‡è¯†ç¬¦

(å¿…éœ€)

`from_memory_type`

`str`

æºè®°å¿†åˆ†åŒº  
å¯èƒ½çš„å€¼ï¼š  
\- `"LongTermMemory"`  
\- `"UserMemory"`  
\- `"WorkingMemory"`

(å¿…éœ€)

`to_memory_type`

`str`

ç›®æ ‡è®°å¿†åˆ†åŒº

(å¿…éœ€)

`log_content`

`str`

è¯¦ç»†æ—¥å¿—æ¶ˆæ¯

(å¿…éœ€)

`current_memory_sizes`

`MemorySizes`

å½“å‰è®°å¿†åˆ©ç”¨ç‡

DEFAULT\_MEMORY\_SIZES = {  
  "long\_term\_memory\_size": -1,  
  "user\_memory\_size": -1,  
  "working\_memory\_size": -1,  
  "transformed\_act\_memory\_size": -1  
}

`memory_capacities`

`MemoryCapacities`

è®°å¿†åˆ†åŒºé™åˆ¶

DEFAULT\_MEMORY\_CAPACITIES = {  
  "long\_term\_memory\_capacity": 10000,  
  "user\_memory\_capacity": 10000,  
  "working\_memory\_capacity": 20,  
  "transformed\_act\_memory\_capacity": -1  
}

`timestamp`

`datetime`

æ—¥å¿—åˆ›å»ºæ—¶é—´

è‡ªåŠ¨è®¾ç½® (`datetime.now`)

### 2.5 å‡½æ•°å®ç°

BaseScheduler çš„å‡½æ•°å¦‚ä¸‹ï¼š

        def replace_working_memory(
            self,
            user_id: UserID | str,
            mem_cube_id: MemCubeID | str,
            mem_cube: GeneralMemCube,
            original_memory: list[TextualMemoryItem],
            new_memory: list[TextualMemoryItem],
        ) -> None | list[TextualMemoryItem]:
            """é‡æ–°æ’åºåç”¨æ–°å†…å­˜æ›¿æ¢å·¥ä½œå†…å­˜"""
            text_mem_base = mem_cube.text_mem
            # ä»…æ”¯æŒTreeTextMemoryç±»å‹çš„æ–‡æœ¬å†…å­˜
            if isinstance(text_mem_base, TreeTextMemory):
                text_mem_base: TreeTextMemory = text_mem_base
    
                # è·å–å½“å‰ç”¨æˆ·-å†…å­˜ç«‹æ–¹ä½“çš„æŸ¥è¯¢ç›‘æ§å™¨
                query_db_manager = self.monitor.query_monitors[user_id][mem_cube_id]
                # ä¸æ•°æ®åº“åŒæ­¥è·å–æœ€æ–°æŸ¥è¯¢å†å²
                query_db_manager.sync_with_orm()
    
                # è·å–æŒ‰æ—¶é—´æ’åºçš„æŸ¥è¯¢å†å²
                query_history = query_db_manager.obj.get_queries_with_timesort()
                # ç”¨LLMå¤„ç†å¹¶é‡æ–°æ’åºå†…å­˜
                memories_with_new_order, rerank_success_flag = (
                    self.retriever.process_and_rerank_memories(
                        queries=query_history,
                        original_memory=original_memory,
                        new_memory=new_memory,
                        top_k=self.top_k,)
                )
    
                # æ ¹æ®æŸ¥è¯¢å†å²è¿‡æ»¤å®Œå…¨ä¸ç›¸å…³çš„å†…å­˜
                filtered_memories, filter_success_flag = self.retriever.filter_unrelated_memories(
                    query_history=query_history,
                    memories=memories_with_new_order,
                )
    
                # å¤„ç†è¿‡æ»¤ç»“æœ
                if filter_success_flag:
                    memories_with_new_order = filtered_memories
    
                # è·å–æŸ¥è¯¢å…³é”®è¯é›†åˆ
                query_keywords = query_db_manager.obj.get_keywords_collections()
    
                # å°†å·¥ä½œå†…å­˜è½¬æ¢ä¸ºç›‘æ§é¡¹
                new_working_memory_monitors = self.transform_working_memories_to_monitors(
                    query_keywords=query_keywords,
                    memories=memories_with_new_order,
                )
    
                # è‹¥é‡æ–°æ’åºå¤±è´¥ï¼Œå°†æ’åºåˆ†æ•°è®¾ä¸º0
                if not rerank_success_flag:
                    for one in new_working_memory_monitors:
                        one.sorting_score = 0
    
                # æ›´æ–°å·¥ä½œå†…å­˜ç›‘æ§å™¨
                self.monitor.update_working_memory_monitors(
                    new_working_memory_monitors=new_working_memory_monitors,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                )
    
                # è·å–æ’åºåçš„å†…å­˜ç›‘æ§é¡¹ï¼Œè½¬æ¢ä¸ºå·¥ä½œå†…å­˜
                mem_monitors: list[MemoryMonitorItem] = self.monitor.working_memory_monitors[user_id][
                    mem_cube_id
                ].obj.get_sorted_mem_monitors(reverse=True)
                new_working_memories = [mem_monitor.tree_memory_item for mem_monitor in mem_monitors]
    
                # æ›¿æ¢æ–‡æœ¬å†…å­˜çš„å·¥ä½œå†…å­˜
                text_mem_base.replace_working_memory(memories=new_working_memories)
    
                # è®°å½•å·¥ä½œå†…å­˜æ›¿æ¢æ—¥å¿—
                self.log_working_memory_replacement(
                    original_memory=original_memory,
                    new_memory=new_working_memories,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    log_func_callback=self._submit_web_logs,
                )
            else:
                memories_with_new_order = new_memory
    
            return memories_with_new_order
    
        def update_activation_memory(
            self,
            new_memories: list[str | TextualMemoryItem],
            label: str,
            user_id: UserID | str,
            mem_cube_id: MemCubeID | str,
            mem_cube: GeneralMemCube,
        ) -> None:
            """
            æ›´æ–°æ¿€æ´»å†…å­˜ï¼šä»æ–°å†…å­˜ä¸­æå–KVç¼“å­˜é¡¹ï¼Œæ·»åŠ åˆ°KVç¼“å­˜å†…å­˜å®ä¾‹å¹¶æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚
            æ”¯æŒå­—ç¬¦ä¸²åˆ—è¡¨å’ŒTextualMemoryItemåˆ—è¡¨ä¸¤ç§è¾“å…¥æ ¼å¼ã€‚
            """
            # æ£€æŸ¥æ–°å†…å­˜æ˜¯å¦ä¸ºç©º
            if len(new_memories) == 0:
                return
    
            # æå–æ–‡æœ¬å†…å®¹ï¼ˆé€‚é…ä¸¤ç§è¾“å…¥æ ¼å¼ï¼‰
            if isinstance(new_memories[0], TextualMemoryItem):
                new_text_memories = [mem.memory for mem in new_memories]
            elif isinstance(new_memories[0], str):
                new_text_memories = new_memories
            else:
                return
    
            try:
                # è·å–æ¿€æ´»å†…å­˜å®ä¾‹ï¼ˆæ”¯æŒKVCacheMemoryå’ŒVLLMKVCacheMemoryï¼‰
                if isinstance(mem_cube.act_mem, VLLMKVCacheMemory):
                    act_mem: VLLMKVCacheMemory = mem_cube.act_mem
                elif isinstance(mem_cube.act_mem, KVCacheMemory):
                    act_mem: KVCacheMemory = mem_cube.act_mem
                else:
                     return
    
                # ç”¨æ¨¡æ¿ç»„è£…æ–°çš„æ–‡æœ¬å†…å­˜ï¼ˆè¿‡æ»¤ç©ºå­—ç¬¦ä¸²ï¼‰
                new_text_memory = MEMORY_ASSEMBLY_TEMPLATE.format(
                    memory_text="".join(
                        [
                            f"{i + 1}. {sentence.strip()}\n"
                            for i, sentence in enumerate(new_text_memories)
                            if sentence.strip()  # è·³è¿‡ç©ºå­—ç¬¦ä¸²
                        ]
                    )
                )
    
                # å¤„ç†å·²æœ‰ç¼“å­˜ï¼ˆé¿å…é‡å¤æ›´æ–°ï¼‰
                original_cache_items: list[VLLMKVCacheItem] = act_mem.get_all()
                original_text_memories = []
                if len(original_cache_items) > 0:
                    pre_cache_item: VLLMKVCacheItem = original_cache_items[-1]
                    original_text_memories = pre_cache_item.records.text_memories
                    original_composed_text_memory = pre_cache_item.records.composed_text_memory
                    # è‹¥æ–°ç»„è£…çš„æ–‡æœ¬ä¸å·²æœ‰ç¼“å­˜ä¸€è‡´ï¼Œè·³è¿‡æ›´æ–°
                    if original_composed_text_memory == new_text_memory:
                        return
                    # æ¸…é™¤æ—§ç¼“å­˜
                    act_mem.delete_all()
    
                # æå–KVç¼“å­˜å¹¶æ·»åŠ åˆ°æ¿€æ´»å†…å­˜
                cache_item = act_mem.extract(new_text_memory)
                cache_item.records.text_memories = new_text_memories
                cache_item.records.timestamp = datetime.utcnow()
                act_mem.add([cache_item])
                # æŒä¹…åŒ–æ¿€æ´»å†…å­˜åˆ°ç£ç›˜
                act_mem.dump(self.act_mem_dump_path)
    
                # è®°å½•æ¿€æ´»å†…å­˜æ›´æ–°æ—¥å¿—
                self.log_activation_memory_update(
                    original_text_memories=original_text_memories,
                    new_text_memories=new_text_memories,
                    label=label,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    log_func_callback=self._submit_web_logs,
                )
    
            except Exception as e:
                logger.error(f"MOS-based activation memory update failed: {e}", exc_info=True)
                # å…³é”®æ“ä½œå¤±è´¥æ—¶å¯é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œæ­¤å¤„æš‚ä¸ä¸­æ–­æ‰§è¡Œ
    
        def update_activation_memory_periodically(
            self,
            interval_seconds: int,
            label: str,
            user_id: UserID | str,
            mem_cube_id: MemCubeID | str,
            mem_cube: GeneralMemCube,
        ):
            try:
                # æ£€æŸ¥æ˜¯å¦è¾¾åˆ°æ›´æ–°é—´éš”ï¼ˆé¦–æ¬¡æ›´æ–°æˆ–é—´éš”æ—¶é—´å·²åˆ°ï¼‰
                if (
                    self.monitor.last_activation_mem_update_time == datetime.min
                    or self.monitor.timed_trigger(
                        last_time=self.monitor.last_activation_mem_update_time,
                        interval_seconds=interval_seconds,
                    )
                ):
                    # æ£€æŸ¥å·¥ä½œå†…å­˜ç›‘æ§å™¨ä¸­æ˜¯å¦æœ‰å¯ç”¨å†…å­˜
                    if (
                        user_id not in self.monitor.working_memory_monitors
                        or mem_cube_id not in self.monitor.working_memory_monitors[user_id]
                        or len(self.monitor.working_memory_monitors[user_id][mem_cube_id].obj.memories)
                        == 0
                    ):
                        return
                    
                    # æ›´æ–°æ¿€æ´»å†…å­˜ç›‘æ§å™¨ï¼ˆåŒæ­¥æœ€æ–°å†…å­˜çŠ¶æ€ï¼‰
                    self.monitor.update_activation_memory_monitors(
                        user_id=user_id, mem_cube_id=mem_cube_id, mem_cube=mem_cube
                    )
    
                    # ä¸æ•°æ®åº“åŒæ­¥è·å–æœ€æ–°æ¿€æ´»å†…å­˜
                    activation_db_manager = self.monitor.activation_memory_monitors[user_id][
                        mem_cube_id
                    ]
                    activation_db_manager.sync_with_orm()
                    new_activation_memories = [
                        m.memory_text for m in activation_db_manager.obj.memories
                    ]
    
                    # æ—¥å¿—è¾“å‡ºæ–°å†…å­˜æ•°é‡åŠéƒ¨åˆ†å†…å®¹ï¼ˆæœ€å¤šå‰ 5 æ¡ï¼‰
                    for i, memory in enumerate(new_activation_memories[:5], 1):
                        logger.info(
                            f"Part of New Activation Memorires | {i}/{len(new_activation_memories)}: {memory[:20]}"
                        )
    
                    # æ‰§è¡Œæ¿€æ´»å†…å­˜æ›´æ–°
                    self.update_activation_memory(
                        new_memories=new_activation_memories,
                        label=label,
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        mem_cube=mem_cube,
                    )
                    
                    # æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                    self.monitor.last_activation_mem_update_time = datetime.utcnow()
                else:
                    # æœªè¾¾åˆ°æ›´æ–°é—´éš”ï¼Œè·³è¿‡æ›´æ–°
    
            except Exception as e:
                logger.error(f"Error in update_activation_memory_periodically: {e}", exc_info=True)
    
        def submit_messages(self, messages: ScheduleMessageItem | list[ScheduleMessageItem]):
            """æäº¤ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—"""
            # å¤„ç†å•ä¸ªæ¶ˆæ¯ï¼ˆè½¬æ¢ä¸ºåˆ—è¡¨ï¼‰
            if isinstance(messages, ScheduleMessageItem):
                messages = [messages]  # transform single message to list
    
            # éªŒè¯æ¶ˆæ¯ç±»å‹å¹¶åŠ å…¥é˜Ÿåˆ—
            for message in messages:
                if not isinstance(message, ScheduleMessageItem):
                    error_msg = f"Invalid message type: {type(message)}, expected ScheduleMessageItem"
                    raise TypeError(error_msg)
    
                self.memos_message_queue.put(message)
    
        def _message_consumer(self) -> None:
            """æŒç»­æ£€æŸ¥æ¶ˆæ¯é˜Ÿåˆ—å¹¶åˆ†å‘æ¶ˆæ¯ï¼ˆè¿è¡Œåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­ï¼‰å®šæœŸæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œé¿å…å¿™ç­‰"""
            while self._running:  # Use a running flag for graceful shutdown
                try:
                    # æ‰¹é‡è·å–é˜Ÿåˆ—ä¸­æ‰€æœ‰å¯ç”¨æ¶ˆæ¯ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
                    messages = []
                    while True: # åŸºäºè¿è¡ŒçŠ¶æ€æ ‡è¯†å®ç°ä¼˜é›…å…³é—­
                        try:
                            # éé˜»å¡è·å–æ¶ˆæ¯ï¼Œæ— æ¶ˆæ¯æ—¶æŠ›å‡º Empty å¼‚å¸¸
                            message = self.memos_message_queue.get_nowait()
                            messages.append(message)
                        except queue.Empty:
                            # é˜Ÿåˆ—å·²ç©ºï¼Œé€€å‡ºå¾ªç¯
                            break
    
                    if messages: # è‹¥è·å–åˆ°æ¶ˆæ¯ï¼Œæ‰§è¡Œåˆ†å‘
                        try:
                            self.dispatcher.dispatch(messages)
                        except Exception as e:
                            logger.error(f"Error dispatching messages: {e!s}")
                        finally:
                            # æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²å¤„ç†
                            for _ in messages:
                                self.memos_message_queue.task_done()
    
                    # çŸ­æš‚ä¼‘çœ ï¼Œé¿å… CPU å ç”¨è¿‡é«˜
                    time.sleep(self._consume_interval)  # Adjust interval as needed
    
                except Exception as e:
                    time.sleep(self._consume_interval)  # å¼‚å¸¸æ—¶åŒæ ·ä¼‘çœ ï¼Œé¿å…å¾ªç¯æŠ¥é”™
    
        def start(self) -> None:
            """
                å¯åŠ¨è°ƒåº¦å™¨ï¼ˆåˆå§‹åŒ–èµ„æºå¹¶å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹ï¼‰
                å¯åŠ¨å†…å®¹ï¼š1. æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹ 2. åˆ†å‘å™¨çº¿ç¨‹æ± ï¼ˆè‹¥å¯ç”¨å¹¶è¡Œåˆ†å‘ï¼‰
            """        
            if self._running:
                return
    
            # å¯åŠ¨æ¶ˆæ¯æ¶ˆè´¹çº¿ç¨‹
            self._running = True
            self._consumer_thread = threading.Thread(
                target=self._message_consumer,
                daemon=True,
                name="MessageConsumerThread",
            )
            self._consumer_thread.start()
    

0xFF å‚è€ƒ
-------