---
layout: post
title: 'è§£å¯†promptç³»åˆ—46. LLMç»“æž„åŒ–è¾“å‡ºä»£ç ç¤ºä¾‹å’ŒåŽŸç†åˆ†æž'
date: "2025-01-05T00:39:27Z"
---
è§£å¯†promptç³»åˆ—46. LLMç»“æž„åŒ–è¾“å‡ºä»£ç ç¤ºä¾‹å’ŒåŽŸç†åˆ†æž
===============================

![è§£å¯†promptç³»åˆ—46. LLMç»“æž„åŒ–è¾“å‡ºä»£ç ç¤ºä¾‹å’ŒåŽŸç†åˆ†æž](https://img2024.cnblogs.com/blog/1326688/202501/1326688-20250104110649905-653437686.png) è¿™ä¸€ç« æˆ‘ä»¬å…ˆç»“åˆdemoçœ‹ä¸‹å¼€æºå’Œé—­æºå¯¹ç»“æž„åŒ–è¾“å‡ºçš„æ”¯æŒï¼ŒéšåŽä¼šä»‹ç»Constrained Decodingå’ŒFormat Restricting Instructions ä¸¤ç§ç»“æž„åŒ–è¾“å‡ºçº¦æŸæ–¹æ¡ˆï¼Œæœ€åŽä¼šç»™å‡ºç»“æž„åŒ–è¾“å‡ºå¯¹æ¯”è‡ªç„¶è¯­è¨€è¾“å‡ºçš„ä¸€äº›è§‚ç‚¹ã€‚

æœ€è¿‘é—­æºå¤§æ¨¡åž‹ä»¬éƒ½é™†ç»­æ”¯æŒç»“æž„åŒ–è¾“å‡ºï¼Œè¿™ä¸€ç« æˆ‘ä»¬å…ˆç»“åˆdemoçœ‹ä¸‹å¼€æºå’Œé—­æºå¯¹ç»“æž„åŒ–è¾“å‡ºçš„æ”¯æŒï¼ŒéšåŽä¼šä»‹ç»Constrained Decodingå’ŒFormat Restricting Instructions ä¸¤ç§ç»“æž„åŒ–è¾“å‡ºçº¦æŸæ–¹æ¡ˆï¼Œæœ€åŽä¼šç»™å‡ºç»“æž„åŒ–è¾“å‡ºå¯¹æ¯”è‡ªç„¶è¯­è¨€è¾“å‡ºçš„ä¸€äº›è§‚ç‚¹ã€‚

ä»£ç ç¤ºä¾‹
----

### é—­æº - OpenAI

> *   [https://platform.openai.com/docs/guides/structured-outputs/supported-schemas](https://platform.openai.com/docs/guides/structured-outputs/supported-schemas)
> *   [https://ai.google.dev/gemini-api/docs/json-mode?lang=python&hl=zh-cn](https://ai.google.dev/gemini-api/docs/json-mode?lang=python&hl=zh-cn)

é—­æºä¸‰å·¨å¤´éƒ½æ˜¯æ”¯æŒç»“æž„åŒ–è¾“å‡ºçš„ï¼Œä¸Šé¢é“¾äº†OpenAIå’ŒGeminiå…³äºŽç»“æž„åŒ–è¾“å‡ºçš„ç›¸å…³APIæ–‡æ¡£ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä»¥OpenAIä¸ºä¾‹ï¼ŒèŠä¸‹ç»“æž„åŒ–è¾“å‡ºã€‚

è¿™é‡Œå¹¶éžæŒ‡OpenAIå¾ˆæ—©å°±æ”¯æŒçš„Json Modeï¼Œè€ŒJSON Modeçš„å‡çº§ç‰ˆ**Structure Output**ï¼Œåªå¯¹gpt-4o-mini-2024-07-18å’Œgpt-4o-2024-08-06ä¹‹åŽçš„æ¨¡åž‹ç‰ˆæœ¬æ”¯æŒã€‚ç®€å•è¯´åŽŸæ¥çš„JSON Modeåªä¿è¯æ¨¡åž‹è¾“å‡ºä¸€ä¸ªåˆæ³•å¯ä»¥è§£æžçš„jsonè€Œå·²ï¼Œå¯¹jsonçš„å­—æ®µï¼Œå­—æ®µç±»åž‹ï¼Œå–å€¼ä¸åšä»»ä½•çº¦æŸï¼Œè€ŒStrucutre Ouputåˆ™ä¼šè¿›ä¸€æ­¥å¯¹JSONé‡Œé¢çš„å…·ä½“å­—æ®µå’Œç±»åž‹è¿›è¡Œçº¦æŸã€‚è¿™é‡Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼Œä»ŽåŸºé‡‘å­£æŠ¥ä¸­æŠ½å–åŸºé‡‘ç»ç†å¯¹å¸‚åœºä¸åŒè¡Œä¸šçš„è§‚ç‚¹ï¼Œå¯¹è§‚ç‚¹è¿›è¡Œæƒ…ç»ªåˆ†ç±»ï¼Œå¹¶å…³è”ç›¸å…³çš„ç”³ä¸‡ä¸€çº§è¡Œä¸šã€‚ï¼ˆå“ˆå“ˆå¹¶ä¸æ˜¯è¯´è¿™æ˜¯æœ€ä¼˜çš„è§£å†³æ–¹æ¡ˆåªæ˜¯æƒ³æŠŠæŠ½å–ï¼Œåˆ†ç±»ï¼Œç”Ÿæˆä»»åŠ¡èžåœ¨ä¸€ä¸ªcaseé‡Œé¢ï¼‰

é¦–å…ˆæˆ‘ä»¬å…ˆå®šä¹‰æŠ½å–ä»»åŠ¡çš„ç»“æž„ä½“ï¼Œç”³ä¸‡ä¸€çº§è¡Œä¸šçš„æžšä¸¾å€¼å’Œæƒ…ç»ªçš„æžšä¸¾å€¼ï¼Œè¿™é‡Œç»“æž„åŒ–è¾“å‡ºéƒ½æ˜¯ä½¿ç”¨pydanticå®šä¹‰çš„ã€‚é€šè¿‡æžšä¸¾å€¼å®šä¹‰æˆ‘ä»¬å¯ä»¥çº¦æŸæ¨¡åž‹è¾“å‡ºçš„å–å€¼èŒƒå›´ï¼Œè€Œé€šè¿‡æŠ½å–ç»“æž„å®šä¹‰æˆ‘ä»¬å¯ä»¥çº¦æŸæ¨¡åž‹è¾“å‡ºçš„ç»“æž„ã€‚ä¸è¿‡è¿™é‡Œå¯¹Enumçš„å–å€¼æ•°é‡æœ‰é™åˆ¶ä¸€æ¬¡è¾“å‡ºçš„æžšä¸¾å€¼æ€»é‡ä¸èƒ½è¶…è¿‡500ï¼Œæ¯•ç«Ÿæ˜¯ç›´æŽ¥ä½œä¸ºæ¨¡åž‹ä¸Šæ–‡ï¼Œæžšä¸¾å€¼å¤ªå¤šä¸€æ˜¯æ…¢äºŒæ˜¯è´µï¼Œä¸‰æ˜¯ä¸ç¨³å®šã€‚

    from enum import Enum
    from typing import List
    from pydantic import BaseModel, Field
    
    class SWIndustry(Enum):
        AGRICULTURE = "å†œæž—ç‰§æ¸”"
        MINING = "é‡‡æŽ˜"
        CHEMICALS = "åŒ–å·¥"
        STEEL = "é’¢é“"
        NONFERROUS_METALS = "æœ‰è‰²é‡‘å±ž"
        BUILDING_MATERIALS = "å»ºç­‘ææ–™"
        ELECTRICAL_EQUIPMENT = "ç”µæ°”è®¾å¤‡"
        APPLIANCES = "å®¶ç”¨ç”µå™¨"
        FOOD_BEVERAGE = "é£Ÿå“é¥®æ–™"
        TEXTILE_APPAREL = "çººç»‡æœè£…"
        LIGHT_MANUFACTURING = "è½»å·¥åˆ¶é€ "
        PHARMACEUTICALS = "åŒ»è¯ç”Ÿç‰©"
        PUBLIC_UTILITIES = "å…¬ç”¨äº‹ä¸š"
        TRANSPORTATION = "äº¤é€šè¿è¾“"
        REAL_ESTATE = "æˆ¿åœ°äº§"
        COMMERCE_TRADE = "å•†ä¸šè´¸æ˜“"
        COMPUTER = "è®¡ç®—æœº"
        MEDIA = "ä¼ åª’"
        COMMUNICATION = "é€šä¿¡"
        BANKING = "é“¶è¡Œ"
        NON_BANK_FINANCIAL = "éžé“¶é‡‘èž"
        AUTOMOBILE = "æ±½è½¦"
        MACHINERY = "æœºæ¢°è®¾å¤‡"
        DEFENSE_MILITARY = "å›½é˜²å†›å·¥"
        BUILDING_CONSTRUCTION = "å»ºç­‘è£…é¥°"
        ELECTRONICS = "ç”µå­"
        COMPREHENSIVE = "ç»¼åˆ"
        LEISURE_SERVICES = "ä¼‘é—²æœåŠ¡"
        COMPUTER_APPLICATIONS = "è®¡ç®—æœºåº”ç”¨"
        CHEMICAL_FIBERS = "åŒ–çº¤"
        METAL_PRODUCTS = "é‡‘å±žåˆ¶å“"
    
    class ViewAspect(Enum):
        POSITIVE = 'æ­£é¢'
        NETURAL = 'ä¸­æ€§'
        NEGATIVE = 'è´Ÿé¢'
    
        
    class View(BaseModel):
        extract_view: str = Field(description="æŠ½å–æ–‡æ¡£ä¸­ä¸­å¯¹æŸä¸ªé‡‘èžè¡Œä¸šã€æˆ–è¡Œä¸šç›¸å…³çš„ä¸»é¢˜æˆ–æ¦‚å¿µè¡¨è¾¾è§‚ç‚¹çš„å¥å­")
        extract_view_entities: List[str] = Field(description="æŠ½å–è§‚ç‚¹é‡‘èžä¸»ä½“,è¯¥ä¸»ä½“å¿…é¡»å‡ºçŽ°åœ¨è§‚ç‚¹å¥å­ä¸­ï¼Œå¯ä»¥æ˜¯é‡‘èžè¡Œä¸šï¼Œæˆ–è¡Œä¸šç›¸å…³æ¦‚å¿µæˆ–ä¸»é¢˜")
        related_industry: list[SWIndustry] = Field(description=f"è§‚ç‚¹é‡‘èžä¸»ä½“æœ€ç›¸å…³çš„1ä¸ªæˆ–å¤šä¸ªç”³ä¸‡ä¸€çº§è¡Œä¸š")
        view_aspect: ViewAspect = Field(description=f'å¯¹è§‚ç‚¹æƒ…ç»ªè¿›è¡Œç²¾å‡†åˆ†ç±»ï¼Œæ¨¡ç³Šæƒ…ç»ªå‡ä¸ºä¸­æ€§')
    
    class ViewExtraction(BaseModel):
        views: list[View] = Field(
            ...,
            description="æ¯ä¸ªè§‚ç‚¹éƒ½åº”è¯¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„å¯¹è±¡ï¼ŒåŒ…å«åŽŸæ–‡ä¸­è¡¨è¾¾è§‚ç‚¹çš„å¥å­ï¼Œè§‚ç‚¹ä¸»ä½“ï¼Œè§‚ç‚¹æƒ…ç»ªåˆ†ç±»å’Œå…³è”çš„ç”³ä¸‡ä¸€çº§è¡Œä¸š",
        )
    

ç„¶åŽåªéœ€è¦æŠŠä»¥ä¸Šçš„ç»“æž„ä½“ä½œä¸ºresponse\_formatçš„å‚æ•°è¾“å…¥openaiå³å¯

    from openai import AzureOpenAI
    
    client = AzureOpenAI(
        api_key = '...',
        api_version="2024-08-01-preview",
        azure_endpoint= "..."
    )
    
    completion = client.beta.chat.completions.parse(
        model='gpt-4o',
     messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä¸ªå®Œç¾Žçš„é‡‘èžè§‚ç‚¹è§£æžç³»ç»Ÿï¼Œå¯ä»¥ä»Žæ–‡æ¡£ä¸­æŠ½å–è§‚ç‚¹ï¼Œå’Œè§‚ç‚¹å¯¹åº”ä¸»ä½“å¹¶å¯¹è§‚ç‚¹è¿›è¡Œåˆ†ç±»ã€‚è¯·ä»Žä»¥ä¸‹æ–‡æ¡£ä¸­æŠ½å–ä¸€ç³»åˆ—è§‚ç‚¹",
                },
                {
                    "role": "user",
                    "content": content,
                },
            ],
        response_format= ViewExtraction
    )
    

è¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ°ç»“æž„åŒ–çš„è¾“å‡ºå¦‚ä¸‹

![image](https://img2024.cnblogs.com/blog/1326688/202501/1326688-20250104110555123-641216276.png)

å†ä¸¾ä¸€ä¸ªfunction callingçš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå·¥å…·ä¸€ä¸ªBingæœç´¢ï¼Œä¸€ä¸ªæ˜¯åŸºé‡‘ä¿¡æ¯æŸ¥è¯¢å·¥å…·ï¼Œæ¨¡åž‹éœ€è¦æ ¹æ®ç”¨æˆ·æé—®é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªå·¥å…·æ¥è§£å†³é—®é¢˜ã€‚

    from typing import Literal,Union,Optional
    class BingSearch(BaseModel):
        query: str = Field(description="ç½‘é¡µæœç´¢query")
            
    class FundInfo(BaseModel):
        """
        å¯ä»¥é€šè¿‡åŸºé‡‘ä»£ç æˆ–åŸºé‡‘åç§°ï¼ŒæŸ¥è¯¢åŸºé‡‘åŸºç¡€ä¿¡æ¯
        """
        fund_code_or_name: Optional[str] = Field(description="æé—®æåŠçš„åŸºé‡‘ä»£ç æˆ–åç§°ï¼Œæ²¡æœ‰åˆ™ä¸ºç©º")
        lookup_field: Literal["fund_manager", "unit_value","contract_date","manage_fee","net_value"]
    
    class Task(BaseModel):
        name: str = Field(description="ä»»åŠ¡åç§°")
        tool: Union[BingSearch, FundInfo] = Field(description="å®Œæˆä»»åŠ¡æ‰€éœ€è°ƒç”¨çš„å·¥å…·")
            
    class TaskSequence(BaseModel):
        reason: str = Field(description="å…ˆé€æ­¥æ€è€ƒè¦è§£å†³ç”¨æˆ·çš„é—®é¢˜éœ€è¦å“ªäº›æ­¥éª¤")
        task_actions: List[Task] = Field(description="ä»»åŠ¡åˆ—è¡¨ï¼ŒæŒ‰æ‰§è¡Œé¡ºåºä¾æ¬¡æŽ’åˆ—")
       
    completion = client.beta.chat.completions.parse(
        model='gpt-4o',
     messages=[
                {
                    "role": "system",
                    "content": "ä½ æ˜¯ä¸€ä¸ªé‡‘èžå·¥å…·åŠ©æ‰‹ï¼Œå¯ä»¥å®Œç¾Žæ ¹æ®ç”¨æˆ·æé—®é€‰æ‹©éœ€è¦è°ƒç”¨çš„å·¥å…·åˆ—è¡¨",
                },
                {
                    "role": "user",
                    "content": 'å¤©å¼˜ä¸­è¯500å½“å‰çš„ç®¡ç†è´¹æ˜¯å¤šå°‘ï¼Œæ˜¯å¦éšç€åŸºé‡‘è§„æ¨¡çš„å¢žåŠ è€Œå¢žåŠ ',
                },
            ],
        response_format= TaskSequence
    )
    

ç„¶åŽæˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸‹é¢çš„ç»“æž„åŒ–è¾“å‡ºå•¦~

![image](https://img2024.cnblogs.com/blog/1326688/202501/1326688-20250104110555008-410558367.png)

### å¼€æºå®žçŽ° - Instructor

> *   [https://github.com/jxnl/instructor](https://github.com/jxnl/instructor)
> *   [https://github.com/PrefectHQ/marvin](https://github.com/PrefectHQ/marvin)
> *   [https://github.com/dottxt-ai/outlines](https://github.com/dottxt-ai/outlines)

å¼€æºä¹Ÿæœ‰ä¸€äº›æ–¹æ¡ˆæ˜¯é’ˆå¯¹ç»“æž„åŒ–è¾“å‡ºçš„ï¼Œä¾‹å¦‚Instructor, Outlinesã€‚ç®€å•å¯¹æ¯”çš„è¯å¦‚æžœä½ ç”¨APIè°ƒæ¨¡åž‹é‚£Instructoræ›´åˆé€‚ï¼Œå¦‚æžœä½ è‡ªå·±éƒ¨ç½²æ¨¡åž‹è°ƒç”¨é‚£Outlinesæ›´åˆé€‚ï¼Œvllmè¿™äº›æŽ¨ç†æ¡†æž¶æœ€æ–°çš„ç‰ˆæœ¬ä¹Ÿå·²ç»èžå…¥äº†Outlinesã€‚è¿™é‡Œæˆ‘ä»¬å°±é€‰Instructorè¿›è¡Œä»‹ç»ã€‚è¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼Œè¾“å‡ºæ ¼å¼çš„å®šä¹‰ç›¸åŒï¼Œé’ˆå¯¹ä¸æ»¡è¶³openaiç‰ˆæœ¬æ¡ä»¶çš„è€æ¨¡åž‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨instructoræ¥å®žçŽ°ç»“æž„åŒ–è¾“å‡ºã€‚

    from openai import AzureOpenAI
    import instructor
    client = AzureOpenAI(
        api_key = '...',
        api_version="2024-08-01-preview",
        azure_endpoint= "..."
    )
    client = instructor.from_openai(client)
    
    resp = client.chat.completions.create(
        model='thgpt4o',
        response_model= ViewExtraction,
        messages=[
            {
                "role": "system",
                "content": "ä½ æ˜¯ä¸€ä¸ªå®Œç¾Žçš„é‡‘èžè§‚ç‚¹è§£æžç³»ç»Ÿï¼Œå¯ä»¥ä»Žæ–‡æ¡£ä¸­æŠ½å–è§‚ç‚¹ï¼Œå’Œè§‚ç‚¹å¯¹åº”ä¸»ä½“å¹¶å¯¹è§‚ç‚¹è¿›è¡Œåˆ†ç±»ã€‚è¯·ä»Žä»¥ä¸‹æ–‡æ¡£ä¸­æŠ½å–ä¸€ç³»åˆ—è§‚ç‚¹",
            },
            {
                "role": "user",
                "content": content,
            },
        ],
    ) 
    

![image](https://img2024.cnblogs.com/blog/1326688/202501/1326688-20250104110555304-484493432.png)

é‚£instructorï¼Œopenaiè¿™äº›ç»“æž„åŒ–è¾“å‡ºèƒ½åŠ›éƒ½æ˜¯å¦‚ä½•å®žçŽ°çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬æ¥çœ‹å‡ ç§çº¦æŸæ¨¡åž‹ç»™å‡ºç»“æž„åŒ–è¾“å‡ºçš„æ–¹æ¡ˆ

å®žçŽ°åŽŸç†
----

è¿™é‡Œæä¾›ä¸¤ç§ä¸åŒçš„å®žçŽ°æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯åŸºäºŽæ¡ä»¶è§£ç çš„å¼ºçº¦æŸæ–¹æ¡ˆï¼Œå’ŒåŸºäºŽæŒ‡ä»¤çš„å¼±çº¦æŸæ–¹æ¡ˆï¼Œå¹¶ä¸”ä¼šç»™å‡ºä¸åŒæ–¹æ¡ˆå¯¹æ¨¡åž‹æŽ¨ç†æ•ˆæžœçš„å½±å“ã€‚

### Constrained Decoding

> *   Efficient Guided Generation for Large Language
> *   [https://github.com/dottxt-ai/outlines/tree/main](https://github.com/dottxt-ai/outlines/tree/main)

å¼€æºé¡¹ç›®Outlinesçš„ä¸¤ä½ä½œè€…Brandon T. Willardå’ŒRÂ´emi Loufæ˜¯æ¯”è¾ƒæ—©æå‡ºå¤§æ¨¡åž‹å¯æŽ§ç”Ÿæˆæ–¹æ¡ˆçš„å¤§ä½¬ã€‚

æ¡ä»¶è§£ç æ–¹æ¡ˆå…¶å®žå°±æ˜¯åœ¨æ¯ä¸€æ­¥è§£ç æ—¶éƒ½å¯¹è¾“å‡ºè¯è¡¨è¿›è¡ŒMASKï¼ˆRegular Expression Guided Maskingï¼‰ï¼Œåªå…è®¸æ¨¡åž‹å¯¹å½“å‰ä½ç½®ç¬¦åˆè¾“å‡ºæ ¼å¼çš„Tokenè¿›è¡Œé¢„æµ‹ï¼ŒæŠŠåŽŸå§‹åŸºäºŽå®Œæ•´è¯è¡¨çš„softmaxï¼Œè½¬æ¢æˆå¯¹äºŽå±€éƒ¨æŽ©ç è¯è¡¨çš„softmaxã€‚

é‚£é—®é¢˜å…¶å®žå°±ç®€åŒ–æˆäº†åœ¨æ¯ä¸€æ­¥æŽ¨ç†æ—¶ï¼Œå¦‚ä½•é€‰æ‹©è¯¥è¿›è¡ŒæŽ©ç çš„Tokenå‘¢ï¼Ÿæ¯•ç«ŸGPTé¢„æµ‹æ˜¯è‡ªå·¦å‘å³ï¼Œæ— æ³•èŽ·å¾—å®Œæ•´Tokenåºåˆ—ã€‚è®ºæ–‡æŠŠåŸºäºŽè¾“å‡ºæ ¼å¼æŽ©ç çš„é—®é¢˜ï¼Œè½¬æ¢æˆäº†åŸºäºŽæœ‰é™çŠ¶æ€æœºçš„çŠ¶æ€è½¬ç§»é—®é¢˜ï¼ˆFSMï¼‰ã€‚ç®€å•è§£é‡Šä¸‹FSMå…¶å®žå°±æ˜¯ç”±ä¸€ç»„çŠ¶æ€å’ŒçŠ¶æ€ä¹‹é—´çš„è½¬ç§»è¿‡ç¨‹ç»„æˆï¼Œè¯è¡¨ä¸­çš„å­—ç¬¦æ»¡è¶³æ¡ä»¶çš„å¯ä»¥åŒ¹é…åˆ°FSMçš„æŸä¸ªæˆ–æŸå‡ ä¸ªçŠ¶æ€ï¼Œä»Žè€Œåœ¨ç¢°åˆ°å­—ç¬¦AåŽï¼Œå°±å¯ä»¥ç¡®è®¤å‡ ç§æ»¡è¶³æ¡ä»¶çš„çŠ¶æ€è½¬ç§»è·¯å¾„ï¼Œä»Žè€Œæ ¹æ®åŽé¢çš„è·¯å¾„ç¡®è®¤æŽ©ç è¯è¡¨ã€‚

å› ä¸ºè¯è¡¨ä¸­çš„æ¯ä¸ªå­—ç¬¦ç©¶ç«Ÿæ»¡è¶³å“ªäº›çŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€åŽæœ‰å“ªäº›å¯èƒ½çš„è½¬ç§»çŠ¶æ€è¿™äº›éƒ½æ˜¯é¢„å…ˆè®¡ç®—å¥½çš„ï¼Œå› æ­¤å¹¶ä¸éœ€è¦åœ¨æŽ¨ç†ä¸­åŠ¨æ€è®¡ç®—ï¼Œç›¸åå¯ä»¥é¢„å…ˆæž„å»ºå¥½æ¯ä¸ªè¯è¡¨åˆ°çŠ¶æ€ï¼Œå†åˆ°åŽç»­è½¬ç§»çŠ¶æ€çš„mappingã€‚åœ¨è§£ç è¿‡ç¨‹ä¸­åªéœ€è¦æ ¹æ®è§£ç å­—ç¬¦è¯»å–mappingï¼Œå¯¹ä¸‹ä¸€ä¸ªå­—ç¬¦è¿›è¡Œå¯¹åº”çš„æŽ©ç å³å¯ã€‚å› æ­¤ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯Oï¼ˆ1ï¼‰ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯Oï¼ˆçŠ¶æ€æ•°ï¼‰ã€‚

è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä¸¾è®ºæ–‡ä¸­çš„ä¾‹å­ã€‚æˆ‘ä»¬çš„è¾“å‡ºè¦æ±‚æ˜¯æ»¡è¶³æµ®ç‚¹æ•°â€œ(\[0-9\]_)?.?\[0-9\]_â€ã€‚è¿™ä¸ªè¾“å‡ºçº¦æŸå¯ä»¥è¢«è½¬æ¢æˆFSMä¸­çš„4ç§ä¸åŒçŠ¶æ€ï¼Œæ¯ä¸ªçŠ¶æ€æœ‰ä¸åŒçš„è½¬ç§»çŠ¶æ€ï¼ˆå“ˆå“ˆä¸‹é¢çš„ä¾‹å­æ˜¯DeepSeekç»™å¤§å®¶ä¸¾çš„ï¼‰

*   çŠ¶æ€ 0: åˆå§‹çŠ¶æ€ï¼Œå¯ä»¥è¿›å…¥çŠ¶æ€1å’Œ2
*   çŠ¶æ€ 1: åŒ¹é…æ•°å­— \[0-9\]ï¼Œå¯ä»¥ç»§ç»­åœ¨çŠ¶æ€1æˆ–è€…åŽ»çŠ¶æ€2
*   çŠ¶æ€ 2: åŒ¹é…å°æ•°ç‚¹ \[.\]ï¼Œåªèƒ½è¿›å…¥çŠ¶æ€3
*   çŠ¶æ€ 3: åŒ¹é…å°æ•°ç‚¹åŽçš„æ•°å­— \[0-9\]ï¼Œå¯ä»¥ç»§ç»­åœ¨çŠ¶æ€3

å‡è®¾æˆ‘ä»¬çš„è¯è¡¨åªæœ‰5ä¸ªå­—ç¬¦{"A", ".", "42", ".2", "1"}ï¼Œé‚£æ•´ä¸ªFSMæŽ©ç è¿‡ç¨‹å¦‚ä¸‹ï¼ˆä»¥ä¸‹è¯è¡¨é€‰æ‹©è¿‡ç¨‹æ˜¯è¯»å–é¢„å…ˆæž„å»ºå¥½çš„indexï¼‰

*   æ­¥éª¤ 1ï¼šåˆå§‹åŒ– FSMã€‚æˆ‘ä»¬ä»ŽçŠ¶æ€ 0 å¼€å§‹ã€‚
*   æ­¥éª¤ 2ï¼šæŸ¥æ‰¾å½“å‰çŠ¶æ€ä¸‹å…è®¸çš„è¯æ±‡ã€‚åœ¨çŠ¶æ€ 0ï¼Œæ ¹æ® FSMï¼Œæˆ‘ä»¬å¯ä»¥åŒ¹é…æ•°å­— \[0-9\] æˆ–å°æ•°ç‚¹ \[.\]ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…è®¸çš„è¯æ±‡æ˜¯ï¼š{".", "42", ".2", "1"}ã€‚
*   æ­¥éª¤ 3ï¼šé€‰æ‹©ä¸€ä¸ªè¯æ±‡å¹¶æ›´æ–° FSM çŠ¶æ€ã€‚å‡è®¾æˆ‘ä»¬é€‰æ‹©äº† ".2"ã€‚é€‰æ‹© ".2" åŽï¼ŒFSM ä»ŽçŠ¶æ€ 0 è¿›å…¥çŠ¶æ€ 2ï¼ˆå› ä¸ºåŒ¹é…äº†å°æ•°ç‚¹ \[.\]ï¼‰ã€‚ç„¶åŽï¼ŒFSM ç»§ç»­åŒ¹é… "2"ï¼Œè¿›å…¥çŠ¶æ€ 3ã€‚
*   æ­¥éª¤ 4ï¼šç»§ç»­ç”Ÿæˆä¸‹ä¸€ä¸ªè¯æ±‡ã€‚åœ¨çŠ¶æ€ 3ï¼Œæˆ‘ä»¬åªèƒ½åŒ¹é…æ•°å­— \[0-9\]ã€‚å› æ­¤ï¼Œå…è®¸çš„è¯æ±‡æ˜¯ï¼š{"42", "1"}ã€‚å‡è®¾æˆ‘ä»¬é€‰æ‹©äº† "1"ã€‚é€‰æ‹© "1" åŽï¼ŒFSM ä¿æŒåœ¨çŠ¶æ€ 3ã€‚
*   æ­¥éª¤ 5ï¼šç”Ÿæˆç»“æŸã€‚å¦‚æžœæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ªè¡¨ç¤ºç»“æŸçš„ç‰¹æ®Šè¯æ±‡ï¼ˆå¦‚ EOSï¼‰ï¼Œç”Ÿæˆè¿‡ç¨‹ç»“æŸã€‚

åŸºäºŽå·²ç»æž„å»ºå¥½çš„FSMè¿›è¡Œè§£ç çš„æ­¥éª¤åœ¨Outlinesé‡Œé¢å¦‚ä¸‹ï¼ˆ./generator/generatae.pyï¼‰ï¼ˆå“ˆå“ˆä¸‹é¢çš„ä»£ç æ˜¯cursorå¸®å¿™ç›´æŽ¥å®šä½åˆ°çš„ï¼‰

    def sequence_generator(model, sampler, fsms, token_ids, sequence_weights, attention_masks, fsm_states, rng):
        while True:
            # 1. èŽ·å–æ¨¡åž‹è¾“å‡ºçš„logits
            logits, kv_cache = model(token_ids, attention_masks, kv_cache)
            
            # 2. èŽ·å–FSMå…è®¸çš„ä¸‹ä¸€ä¸ªtoken
            allowed_tokens = get_allowed_tokens(fsms, fsm_states)
            
            # 3. åŸºäºŽallowed_tokenså¯¹logitsè¿›è¡Œmask,ä¸å…è®¸çš„tokenå‡ä¸º-inf
            biased_logits = bias_logits(logits, allowed_tokens)
            
            # 4. é‡‡æ ·ä¸‹ä¸€ä¸ªtoken
            next_token_ids, ancestors, sequence_weights = sampler(biased_logits, sequence_weights, rng)
            
            # 5. æ›´æ–°FSMçŠ¶æ€
            fsm_states = get_next_fsm_states(fsms, fsm_states, next_token_ids)
            
            # 6. æ£€æŸ¥æ˜¯å¦ç”Ÿæˆå®Œæˆ
            is_finished = is_generation_finished(fsms, fsm_states)
    

### Format Restricting Instructions

FRIæ˜¯æ›´ç®€å•çš„å®žçŽ°æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯åœ¨æŒ‡ä»¤ä¸­åŠ å…¥å¯¹åº”è¾“å‡ºçš„çº¦æŸã€‚è¿™é‡Œè¿˜æ˜¯æ‹¿Instructoræ¥ä¸¾ä¾‹å­å§ï¼Œè™½ç„¶è¿™å¹¶ä¸å‡†ç¡®ï¼Œå› ä¸ºInstructorè°ƒç”¨çš„APIæŽ¥å£èƒŒåŽè¿˜æ˜¯åšäº†Constrained Decodingçš„é€»è¾‘ï¼ŒInstructorå…¶å®žåªæ˜¯ä»Žä¸­åšäº†ä¸€å±‚Adapterã€‚ä½†æ˜¯ä¸å¦¨ç¢æˆ‘ä»¬é€šè¿‡instructorçš„å®žçŽ°æ¥çœ‹ä¸‹å¦‚ä½•æŠŠpydanticçš„å®šä¹‰è½¬æ¢æˆç»“æž„åŒ–è¾“å‡ºçš„æŒ‡ä»¤çº¦æŸã€‚

åœ¨ä¸Šé¢ä½¿ç”¨instructor.from\_openai(client)æ—¶ï¼ŒInstructorä¼šæ‰“çŒ´å­è¡¥ä¸ï¼Œåœ¨å¸¸è§„openaiçš„æŽ¥å£ä¸Šï¼Œå¢žåŠ response\_modelçš„é¢„å¤„ç†ï¼Œå’Œå¯¹è¾“å‡ºçš„retryæœºåˆ¶ï¼ˆpatch.py)

    @overload
    def from_openai(
        client: openai.OpenAI,
        mode: instructor.Mode = instructor.Mode.TOOLS,
        **kwargs: Any,
    ) -> Instructor:
        pass
        
    @overload
    def patch(
        client: OpenAI,
        mode: Mode = Mode.TOOLS,
    ) -> OpenAI: ...
    
    def patch(  # type: ignore
        client: OpenAI | AsyncOpenAI | None = None,
        create: Callable[T_ParamSpec, T_Retval] | None = None,
        mode: Mode = Mode.TOOLS,
    ) -> OpenAI | AsyncOpenAI:
        """
        Patch the `client.chat.completions.create` method
    
        Enables the following features:
    
        - `response_model` parameter to parse the response from OpenAI's API
        - `max_retries` parameter to retry the function if the response is not valid
        - `validation_context` parameter to validate the response using the pydantic model
        - `strict` parameter to use strict json parsing
        - `hooks` parameter to hook into the completion process
        """
    
        logger.debug(f"Patching `client.chat.completions.create` with {mode=}")
    
        if create is not None:
            func = create
        elif client is not None:
            func = client.chat.completions.create
        else:
            raise ValueError("Either client or create must be provided")
    
        @wraps(func)  # type: ignore
        def new_create_sync(
            response_model: type[T_Model] | None = None,
            validation_context: dict[str, Any] | None = None,
            context: dict[str, Any] | None = None,
            max_retries: int | Retrying = 1,
            strict: bool = True,
            hooks: Hooks | None = None,
            *args: T_ParamSpec.args,
            **kwargs: T_ParamSpec.kwargs,
        ) -> T_Model:
            context = handle_context(context, validation_context)
    
            response_model, new_kwargs = handle_response_model(
                response_model=response_model, mode=mode, **kwargs
            )
    
            new_kwargs = handle_templating(new_kwargs, context)
    
            response = retry_sync(
                func=func,  # type: ignore
                response_model=response_model,
                context=context,
                max_retries=max_retries,
                args=args,
                hooks=hooks,
                strict=strict,
                kwargs=new_kwargs,
                mode=mode,
            )
            return response  # type: ignore
        new_create = new_create_async if func_is_async else new_create_sync
        if client is not None:
            client.chat.completions.create = new_create  # type: ignore
            return client
        else:
            return new_create  # type: ignore
    

å…¶ä¸­handle\_response\_modelçš„éƒ¨åˆ†ä¼šé’ˆå¯¹ä¸åŒæ¨¡åž‹çš„APIæŽ¥å£è¿›è¡Œä¸åŒçš„æŒ‡ä»¤å¤„ç†ï¼Œä¸Šé¢ä½¿ç”¨OpenAIæ—¶ä½¿ç”¨äº†å·¥å…·è°ƒç”¨æ¨¡å¼æ¥å®žçŽ°ç»“æž„åŒ–è¾“å‡ºã€‚

    def openai_schema(cls) -> dict[str, Any]:
        """
        Return the schema in the format of OpenAI's schema as jsonschema
    
        Note:
            Its important to add a docstring to describe how to best use this class, it will be included in the description attribute and be part of the prompt.
    
        Returns:
            model_json_schema (dict): A dictionary in the format of OpenAI's schema as jsonschema
        """
        schema = cls.model_json_schema()
        docstring = parse(cls.__doc__ or "")
        parameters = {
            k: v for k, v in schema.items() if k not in ("title", "description")
        }
        for param in docstring.params:
            if (name := param.arg_name) in parameters["properties"] and (
                description := param.description
            ):
                if "description" not in parameters["properties"][name]:
                    parameters["properties"][name]["description"] = description
    
        parameters["required"] = sorted(
            k for k, v in parameters["properties"].items() if "default" not in v
        )
    
        if "description" not in schema:
            if docstring.short_description:
                schema["description"] = docstring.short_description
            else:
                schema["description"] = (
                    f"Correctly extracted `{cls.__name__}` with all "
                    f"the required parameters with correct types"
                )
    
        return {
            "name": schema["title"],
            "description": schema["description"],
            "parameters": parameters,
        }
    

æ‹¿å‰é¢åŸºé‡‘Function Callçš„ä¾‹å­æ¥è¯´ï¼Œå®žé™…è¿›å…¥GPTæ¨¡åž‹çš„æŒ‡ä»¤è¢«è½¬æ¢æˆäº†ä»¥ä¸‹å‡½æ•°è°ƒç”¨çš„æŒ‡ä»¤æ ¼å¼

    {'name': 'TaskSequence',
     'description': 'Correctly extracted `TaskSequence` with all the required parameters with correct types',
     'parameters': {'$defs': {'BingSearch': {'properties': {'query': {'description': 'ç½‘é¡µæœç´¢query',
          'title': 'Query',
          'type': 'string'}},
        'required': ['query'],
        'title': 'BingSearch',
        'type': 'object'},
       'FundInfo': {'description': 'å¯ä»¥é€šè¿‡åŸºé‡‘ä»£ç æˆ–åŸºé‡‘åç§°ï¼ŒæŸ¥è¯¢åŸºé‡‘åŸºç¡€ä¿¡æ¯',
        'properties': {'fund_code_or_name': {'anyOf': [{'type': 'string'},
           {'type': 'null'}],
          'description': 'æé—®æåŠçš„åŸºé‡‘ä»£ç æˆ–åç§°ï¼Œæ²¡æœ‰åˆ™ä¸ºç©º',
          'title': 'Fund Code Or Name'},
         'lookup_field': {'enum': ['fund_manager',
           'unit_value',
           'contract_date',
           'manage_fee',
           'net_value'],
          'title': 'Lookup Field',
          'type': 'string'}},
        'required': ['fund_code_or_name', 'lookup_field'],
        'title': 'FundInfo',
        'type': 'object'},
       'Task': {'properties': {'name': {'description': 'ä»»åŠ¡åç§°',
          'title': 'Name',
          'type': 'string'},
         'tool': {'anyOf': [{'$ref': '#/$defs/BingSearch'},
           {'$ref': '#/$defs/FundInfo'}],
          'description': 'å®Œæˆä»»åŠ¡æ‰€éœ€è°ƒç”¨çš„å·¥å…·',
          'title': 'Tool'}},
        'required': ['name', 'tool'],
        'title': 'Task',
        'type': 'object'}},
      'properties': {'reason': {'description': 'å…ˆé€æ­¥æ€è€ƒè¦è§£å†³ç”¨æˆ·çš„é—®é¢˜éœ€è¦å“ªäº›æ­¥éª¤',
        'title': 'Reason',
        'type': 'string'},
       'task_actions': {'description': 'ä»»åŠ¡åˆ—è¡¨ï¼ŒæŒ‰æ‰§è¡Œé¡ºåºä¾æ¬¡æŽ’åˆ—',
        'items': {'$ref': '#/$defs/Task'},
        'title': 'Task Actions',
        'type': 'array'}},
      'required': ['reason', 'task_actions'],
      'type': 'object'}}
    

FRIç¼ºå°‘ä¸¥æ ¼çº¦æŸï¼Œæ‰€ä»¥åªèƒ½ä¾èµ–æ¨¡åž‹çš„æŒ‡ä»¤éµä»Žèƒ½åŠ›ï¼Œæœ‰ä¸€å®šæ¦‚çŽ‡è¾“å‡ºç»“æžœä¼šæ— æ³•è¿˜åŽŸæˆåŽŸå§‹çš„çš„Pydanticç±»åž‹ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹å¦ä¸€ç§å¼ºçº¦æŸçš„æ–¹æ¡ˆã€‚

### ä¼˜åŠ£å¯¹æ¯”

> *   Let Me Speak Freely? A Study on the Impact of Format Restrictions on Performance of Large Language Models
> *   [https://blog.dottxt.co/say-what-you-mean.html](https://blog.dottxt.co/say-what-you-mean.html)

é’ˆå¯¹ä¸Šè¿°çš„ä¸¤ç§ç»“æž„åŒ–è§£ç æ–¹æ¡ˆï¼Œå¯¹æ¯”å¸¸è§„çš„è‡ªç„¶è¯­è¨€æŽ¨ç†å¯¹æ¨¡åž‹æ•ˆæžœçš„å½±å“å‡ ä½•ï¼Ÿæˆ‘å…ˆæ˜¯è¯»åˆ°çš„ç¬¬ä¸€ç¯‡è®ºæ–‡ï¼ˆLet Me Speak Freelyï¼‰ï¼Œæ ¸å¿ƒç»“è®ºå…¶å®žæ˜¯ç»“æž„åŒ–è¾“å‡ºä¼šå½±å“æ¨¡åž‹çš„æŽ¨ç†æ•ˆæžœã€‚

ä½†æ˜¯éšåŽOutlinesçš„ä½œè€…ä»¬å°±å‘äº†ä¸€ç¯‡åšå®¢æŒ‡å‡ºäº†è®ºæ–‡çš„å‡ ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚åŒæ–¹å„è‡ªç«™çš„ç«‹åœºä¸åŒï¼Œä½†é€»è¾‘ä¸Šä¸ªåšå®¢æŒ‡å‡ºçš„å‡ ä¸ªè®ºæ–‡çš„æ ¸å¿ƒé—®é¢˜ç¡®å®žå¾ˆæœ‰è¯´æœåŠ›ï¼ŒåŒ…æ‹¬

*   è®ºæ–‡ä½¿ç”¨è‡ªç„¶è¯­è¨€æŽ¨ç†å’Œä½¿ç”¨ç»“æž„åŒ–è¾“å‡ºæŽ¨ç†çš„æŒ‡ä»¤ä¸åŒï¼Œå› æ­¤æ•ˆæžœä¸å¯æ¯”
*   è®ºæ–‡ä½¿ç”¨äº†ç¬¬äºŒä¸ªå¤§æ¨¡åž‹å¯¹ç»“æž„åŒ–è¾“å‡ºçš„ç»“æžœè¿›è¡Œè§£æžï¼ˆå¼•å…¥äº†æ›´å¤šé”™è¯¯ï¼‰ï¼Œå®žé™…ä¸Šæ­£ç¡®çš„ä½¿ç”¨æ–¹å¼åº”è¯¥æ˜¯ç›´æŽ¥ä½¿ç”¨æŽ¨ç†è¾“å‡ºæ¥è¿˜åŽŸpydantic modelå³å¯ï¼Œæ¯•ç«Ÿå¤§å®¶ä½¿ç”¨ç»“æž„åŒ–è¾“å‡ºçš„å…¶ä¸­ä¸€ä¸ªåŽŸå› å°±æ˜¯æ›´å¥½è§£æžã€‚
*   è®ºæ–‡ä½¿ç”¨çš„ç»“æž„åŒ–è¾“å‡ºpromptè´¨é‡æœ‰å¾…æå‡

åšå®¢ç»™å‡ºçš„æœ€ç»ˆç»“è®ºæ˜¯åœ¨GSM8kï¼ŒLast Letterï¼ŒShuffled Objectè¿™ä¸‰ä¸ªä»»åŠ¡ä¸Šç»“æž„åŒ–è¾“å‡ºç›¸æ¯”NLè¾“å‡ºéƒ½æœ‰æå‡ã€‚å¹¶ä¸”ç›´æŽ¥ç»™å‡ºäº†åŸºäºŽOutlinesçš„ç»“æžœå¤çŽ°ä»£ç [github repo](https://github.com/dottxt-ai/demos/tree/main/say-what-you-mean)ï¼ˆè¿™é‡Œå¼ºçƒˆå»ºè®®å¤§å®¶åŽ»çž…çž…ä¸Šé¢çš„åšå®¢ï¼Œå¯¹äºŽç»“æž„åŒ–è¾“å‡ºæœ‰äº›å¾ˆæœ‰æ„æ€çš„è§è§£ï¼‰

![image](https://img2024.cnblogs.com/blog/1326688/202501/1326688-20250104110555268-1934591259.png)

ä½†æ˜¯å¸å–å‰é¢ç›²ç›®åä¿¡å‰ä¸€ç¯‡è®ºæ–‡çš„æ•™è®­ï¼Œå…¶å®žåœ¨å¹³æ—¶çš„ä»»åŠ¡å°è¯•ä¸Šï¼Œä¸ªäººæ„Ÿè§‰ç»“æž„åŒ–è¾“å‡ºçš„æ•ˆæžœå’Œå…·ä½“ä»»åŠ¡ï¼ŒPromptï¼ˆfewshotï¼‰è´¨é‡ï¼Œæ¨¡åž‹æœ¬èº«çš„æŒ‡ä»¤èƒ½åŠ›å¼ºç›¸å…³ã€‚å› æ­¤è¿˜æ˜¯å€¾å‘äºŽåœ¨åº”ç”¨æ—¶å……åˆ†å¯¹æ¯”NLå’ŒStructureçš„æ•ˆæžœåŽå†åšåº”ç”¨ã€‚åœ¨å¤§æ¨¡åž‹æ—¶ä»£å¾ˆå¤šç»“è®ºéƒ½æœ‰é¢†åŸŸå’Œæ¨¡åž‹å±€é™æ€§ï¼Œå¤§å®¶éœ€è¦åœ¨è‡ªå·±çš„åœºæ™¯ä¸Šå®¡æ…Žåˆ¤æ–­å“ˆå“ˆ~

â€œæ–°å¹´ä¼Šå§‹ï¼Œæ„¿å„ä½ä»£ç å¦‚è¯—è¡Œäº‘æµæ°´ï¼Œbugå¦‚æœéœ²è§å…‰å³æ•£ï¼›åˆ›æ„å¦‚æ³‰æ¶Œï¼Œè®ºæ–‡å¦‚å®è—ï¼Œå®žéªŒå¦‚ç¥žåŠ©ï¼ŒæˆåŠŸçŽ‡ç™¾åˆ†ç™¾ï¼ç§‘ç ”è·¯ä¸Šï¼Œä½ æˆ‘çš†æ˜¯â€˜ç â€™åˆ°æˆåŠŸçš„å¹¸è¿å„¿ï¼ðŸŽ‰â€

**æƒ³çœ‹æ›´å…¨çš„å¤§æ¨¡åž‹è®ºæ–‡Â·å¾®è°ƒé¢„è®­ç»ƒæ•°æ®Â·å¼€æºæ¡†æž¶Â·AIGCåº”ç”¨ >>** [**DecryPrompt**](https://github.com/DSXiangLi/DecryptPrompt/)