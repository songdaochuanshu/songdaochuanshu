---
layout: post
title: 'K8s 必备：kubectl patch 命令详解'
date: "2025-09-19T00:39:16Z"
---
K8s 必备：kubectl patch 命令详解
-------------------------

> 精准高效的Kubernetes资源更新技巧

一、为什么需要kubectl patch？
---------------------

在日常Kubernetes运维工作中，我们经常需要对集群中的资源进行修改。虽然`kubectl apply`和`kubectl edit`都很常用，但它们都存在一些局限性：

*   **kubectl apply**：需要提供完整的配置文件
*   **kubectl edit**：需要交互式编辑整个资源定义

而`kubectl patch`命令允许我们**只提供需要更改的部分内容**，实现对Kubernetes资源的精准局部更新，大大提高了运维效率。

二、三种patch策略详解
-------------

### 1\. Strategic Merge Patch（策略合并补丁，默认）

这是Kubernetes特有的一种智能补丁方式，根据字段的`patchStrategy`和`patchMergeKey`标签来决定如何合并字段。

**实战示例：向Deployment添加新容器**

    # 创建示例Deployment
    kubectl apply -f - <<EOF
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: patch-demo
    spec:
      replicas: 2
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx-container
            image: nginx
    EOF
    
    # 添加redis容器
    kubectl patch deployment patch-demo --patch '{
      "spec": {
        "template": {
          "spec": {
            "containers": [
              {
                "name": "redis-container",
                "image": "redis"
              }
            ]
          }
        }
      }
    }'
    

**智能数组合并机制**：对于Pod的`containers`字段，Kubernetes使用`name`作为键来智能合并：

*   如果patch中指定了已存在的容器名，则更新该容器
*   如果是新的容器名，则添加到容器列表中

### 2\. JSON Merge Patch（JSON合并补丁）

遵循RFC 7386标准，规则简单：

*   存在的字段则替换（字段值为`null`则表示删除）
*   不存在的字段则保持原样

**实战示例：调整Deployment副本数**

    # 将副本数调整为5
    kubectl patch deployment --type merge patch-demo --patch '{
      "spec": {
        "replicas": 5
      }
    }'
    

**注意事项**：JSON Merge Patch会替换整个数组，不适合精细操作数组字段。

### 3\. JSON Patch（JSON补丁）

遵循RFC 6902标准，通过明确的指令进行操作，支持6种操作：

*   `add`：添加字段
*   `remove`：删除字段
*   `replace`：替换字段
*   `move`：移动字段值
*   `copy`：复制字段值
*   `test`：测试字段值

**实战示例：精确更新特定字段**

    # 使用JSON Patch精确操作
    kubectl patch deployment --type json patch-demo --patch '[
      {
        "op": "replace",
        "path": "/spec/replicas",
        "value": 3
      }
    ]'
    

三、三种策略对比与选择
-----------

特性

Strategic Merge Patch

JSON Merge Patch

JSON Patch

**数组处理**

智能合并（按name等key）

整体替换

精确操作（按索引）

**适用资源**

Kubernetes原生资源

任何JSON资源

任何JSON资源

**控制精度**

中

低

高

**语法复杂度**

低

低

高

**推荐场景**

日常K8s资源操作

简单字段更新

需要精确控制

四、实战技巧与最佳实践
-----------

### 1\. 使用patch文件

对于复杂的patch操作，建议使用patch文件：

    # update-replicas.yaml
    spec:
      replicas: 5
    

    kubectl patch deployment patch-demo --patch-file update-replicas.yaml
    

### 2\. dry-run预览效果

执行前使用`--dry-run`预览更改效果：

    kubectl patch deployment patch-demo --patch '...' --dry-run=client -o yaml
    

### 3\. 处理特殊字段

某些字段需要使用`$retainKeys`策略：

    # 正确更新Deployment策略
    kubectl patch deployment patch-demo --patch '{
      "spec": {
        "strategy": {
          "$retainKeys": ["type"],
          "type": "Recreate"
        }
      }
    }'
    

### 4\. 查看字段patch策略

可以通过Kubernetes API文档查看字段的patch策略，决定使用哪种patch方式：

    # 查看Deployment的API定义
    kubectl explain deployment.spec.strategy
    

五、常见应用场景
--------

### 1\. 快速更新容器镜像

    kubectl patch deployment my-app --type json --patch '[{
      "op": "replace",
      "path": "/spec/template/spec/containers/0/image",
      "value": "my-app:v2.0.0"
    }]'
    

### 2\. 调整资源配额

    kubectl patch deployment my-app --patch '{
      "spec": {
        "template": {
          "spec": {
            "containers": [{
              "name": "app",
              "resources": {
                "limits": {
                  "cpu": "1000m",
                  "memory": "1Gi"
                }
              }
            }]
          }
        }
      }
    }'
    

### 3\. 添加或更新标签/注解

    # 添加注解
    kubectl patch deployment my-app --type json --patch '[{
      "op": "add",
      "path": "/metadata/annotations/deployed-by",
      "value": "kubernetes-admin"
    }]'
    

六、总结
----

`kubectl patch`是Kubernetes运维中一个强大而灵活的工具，特别适用于：

*   **精准更新**：只需要修改部分字段，无需处理完整资源配置
*   **自动化脚本**：在CI/CD流水线中自动更新特定配置
*   **高效操作**：减少传输的数据量，提高更新效率

根据实际需求选择合适的patch策略：

*   **日常操作**：推荐使用默认的Strategic Merge Patch
*   **简单字段更新**：可使用JSON Merge Patch
*   **需要精确控制**：使用JSON Patch

掌握`kubectl patch`命令，让你的Kubernetes资源管理更加精准和高效！

本文来自博客园，作者：[dashery](https://www.cnblogs.com/ydswin/)，转载请注明原文链接：[https://www.cnblogs.com/ydswin/p/19099353](https://www.cnblogs.com/ydswin/p/19099353)

posted on 2025-09-18 18:10  [dashery](https://www.cnblogs.com/ydswin)  阅读(45)  评论(0)    [收藏](javascript:void\(0\))  [举报](javascript:void\(0\))