---
layout: post
title: 'Admin.NETå¼€æºç‰ˆå¾®æœåŠ¡æ”¹é€ è®°å½•'
date: "2026-02-14T00:56:27Z"
---
Admin.NETå¼€æºç‰ˆå¾®æœåŠ¡æ”¹é€ è®°å½•
===================

Admin.NETå¼€æºç‰ˆå¾®æœåŠ¡æ”¹é€ è®°å½•
===================

å°†Admin.NET.Coreé¡¹ç›®æ‹†åˆ†æˆä¸¤ä¸ªé¡¹ç›®ï¼šAdmin.NET.Commonï¼ŒAdmin.NET.Core
--------------------------------------------------------

Admin.NET.Commonæ”¾åŸºç¡€å·¥å…·ç±»

Admin.NET.Coreæ”¾æ¡†æ¶æ ¸å¿ƒç±»åº“

AspireApp.AppHostä¸­çš„AppHost.csé…ç½®ï¼š
--------------------------------

    using Aspire.Hosting;
    using Aspire.Hosting.Dapr;
    using AspireApp.AppHost;
    
    var builder = DistributedApplication.CreateBuilder(args);
    
    var postgresQL = builder.AddPostgres("postgresQL")
                            .WithImage("ankane/pgvector")
                            .WithImageTag("latest")
                            .WithLifetime(ContainerLifetime.Persistent)
                            .WithHealthCheck()
                            .WithPgWeb();
    var postgres = postgresQL.AddDatabase("postgres");
    var postgres2 = postgresQL.AddDatabase("postgres2");
    
    //var redis = builder.AddRedis("redis").WithLifetime(ContainerLifetime.Persistent)
    //                    .WithHealthCheck()
    //                    .WithRedisCommander();
    
    // ä½¿ç”¨ RabbitMQ ä½œä¸º Pub/Sub ç»„ä»¶
    //var rabbitmq = builder.AddRabbitMQ("rabbitmq")
    //                        .WithLifetime(ContainerLifetime.Persistent)
    //                        .WithHealthCheck()
    //                        .WithManagementPlugin();
    
    // 1. å®šä¹‰å…±äº«ç›®å½•çš„ç»å¯¹è·¯å¾„ï¼ˆå»ºè®®æŒ‡å‘ admin-net-core çš„å®é™…ç›®å½•æˆ–ç‹¬ç«‹çš„ shared ç›®å½•ï¼‰
    var uploadPath = Path.GetFullPath("../Admin.NET/Admin.NET.Core/wwwroot/upload");
    
    // ç¡®ä¿ç›®å½•å­˜åœ¨
    if (!Directory.Exists(uploadPath))
    {
        Directory.CreateDirectory(uploadPath);
    }
    
    // Admin.NET.Core ä½¿ç”¨ Furion çš„ Knife4j UIï¼Œä¸ä½¿ç”¨ Aspire çš„ Swagger UI
    var core = builder.AddProject<Projects.Admin_NET_Core>("admin-net-core")
        .WithReference(postgres)
        .WaitFor(postgres)
        .WithSwaggerUI();
    
    var baseApi = builder.AddProject<Projects.Base>("base")
        .WithReference(postgres2)
        .WithSwaggerUI()
        .WithReference(core)
        .WaitFor(postgres2)
        .WaitFor(core);
    
    var yarp = builder.AddProject<Projects.AspireApp_Yarp>("aspireapp-yarp")
        .WithEndpoint( port: 5008, scheme: "http", name: "yarp-http")    // æŒ‡å®šå”¯ä¸€åç§°
        .WithEndpoint( port: 7008, scheme: "https", name: "yarp-https") // æŒ‡å®šå”¯ä¸€åç§°
        .WithReference(core)
        .WithReference(baseApi)
        .WaitFor(core)
        .WaitFor(baseApi);
    
    //var frontend = builder.AddNodeApp(
    //       "frontend",
    //       scriptPath: "scripts/run-pnpm.cjs",
    //       workingDirectory: "../Web",
    //       args: new[] { "dev" }
    //   )
    //   .WithReference(yarp)
    //   .WaitFor(yarp);
    
    builder.Build().Run();
    
    
    

AIPç½‘å…³ï¼šAspireApp.Yarp
--------------------

Program.cs

    var builder = WebApplication.CreateBuilder(args);
    
    builder.AddServiceDefaults();
    builder.Services.AddReverseProxy()
                    .LoadFromConfig(builder.Configuration.GetSection("ReverseProxy"))
                    .AddServiceDiscoveryDestinationResolver();
    
    var app = builder.Build();
    
    app.MapDefaultEndpoints();
    app.MapReverseProxy();
    
    app.MapGet("/", () => "Hello World!");
    
    app.Run();
    
    

appsettings.json

    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning"
        }
      },
      "AllowedHosts": "*",
      "ReverseProxy": {
        "Routes": {
          "core": {
            "ClusterId": "core",
            "Match": {
              "Path": "/core/{**remainder}"
            },
            "Transforms": [
              { "PathRemovePrefix": "/core" },
              { "PathPrefix": "/" },
              { "RequestHeaderOriginalHost": "true" }
            ]
          },
          "base": {
            "ClusterId": "base",
            "Match": {
              "Path": "/base/{**remainder}"
            },
            "Transforms": [
              { "PathRemovePrefix": "/base" },
              { "PathPrefix": "/" },
              { "RequestHeaderOriginalHost": "true" }
            ]
          }
        },
        "Clusters": {
          "core": {
            "Destinations": {
              "base_destination": {
                "Address": "http+https://admin-net-core"
              }
            }
          },
          "base": {
            "Destinations": {
              "base_destination": {
                "Address": "http+https://base"
              }
            }
          }
        }
      }
    }
    

ä¸šåŠ¡é¡¹ç›®(baseé¡¹ç›®)è°ƒç”¨æ ¸å¿ƒé¡¹ç›®(coreé¡¹ç›®ï¼‰çš„æ–¹æ³•
-----------------------------

æˆ‘ä»¬ä½¿ç”¨Refitæ¥æœåŠ¡è°ƒç”¨

åœ¨baseé¡¹ç›®ä¸­çš„Startup.csä¸­

            // æ³¨å†Œ JwtTokenHandler - ç”¨äºè‡ªåŠ¨æ·»åŠ  JWT Token åˆ° Refit è¯·æ±‚
            services.AddTransient<JwtTokenHandler>();
            
            // é…ç½® Refit å®¢æˆ·ç«¯å¹¶æ·»åŠ  JWT Token å¤„ç†å™¨
            //ç³»ç»Ÿé…ç½®
            services.AddRefitClient<IConfigService>(refitSettings)
                   .ConfigureHttpClient(c => c.BaseAddress = new("https+http://admin-net-core"))
                   .AddHttpMessageHandler<JwtTokenHandler>();
            //ç³»ç»Ÿèœå•     
            services.AddRefitClient<IMenuService>(refitSettings)
                   .ConfigureHttpClient(c => c.BaseAddress = new("https+http://admin-net-core"))
                   .AddHttpMessageHandler<JwtTokenHandler>();
            //ç»„ç»‡æœºæ„
            services.AddRefitClient<IOrgService>(refitSettings)
                   .ConfigureHttpClient(c => c.BaseAddress = new("https+http://admin-net-core"))
                   .AddHttpMessageHandler<JwtTokenHandler>();
            //æ–‡ä»¶
            services.AddRefitClient<IFileService>(refitSettings)
                   .ConfigureHttpClient(c => c.BaseAddress = new("https+http://admin-net-core"))
                   .AddHttpMessageHandler<JwtTokenHandler>();
    
            services.AddRefitClient<ITest>(refitSettings)
                .ConfigureHttpClient(c => c.BaseAddress = new("https+http://apiservice"))
                .AddHttpMessageHandler<JwtTokenHandler>();
    

å…¶ä¸­æœ€é‡è¦çš„æƒé™æ¥å£è°ƒç”¨

    using Refit;
    using GetAttribute = Refit.GetAttribute;
    namespace Base.Rest;
    
    public interface IMenuService
    {
        [Get("/api/sysMenu/getOwnBtnPermList")]
        Task<List<string>> GetOwnBtnPermList();
    
        [Get("/api/sysMenu/getAllBtnPermList")]
        Task<List<string>> GetAllBtnPermList();
    }
    

ä¿®æ”¹baseé¡¹ç›®çš„æƒé™éªŒè¯æ–¹æ³•JwtHandler.cs

IConfigService IMenuService å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„Refitæ¥å£ï¼Œè¿™æ ·ï¼Œæ¯æ¬¡æƒé™éªŒè¯å°±ä¼šè°ƒç”¨coreé¡¹ç›®çš„APIæ¥å£

    using Admin.NET.Core;
    using Admin.NET.Core.Service;
    using Base.Rest;
    using Furion;
    using Furion.Authorization;
    using Furion.DataEncryption;
    using Microsoft.AspNetCore.Authorization;
    using Microsoft.AspNetCore.Http;
    using System;
    using System.Threading.Tasks;
    
    namespace Admin.NET.Application;
    
    public class JwtHandler : AppAuthorizeHandler
    {
        private readonly SysCacheService _sysCacheService = App.GetRequiredService<SysCacheService>();
        private readonly IConfigService _sysConfigService = App.GetRequiredService<IConfigService>();
        private static readonly IMenuService SysMenuService = App.GetRequiredService<IMenuService>();
    
        /// <summary>
        /// è‡ªåŠ¨åˆ·æ–°Token
        /// </summary>
        /// <param name="context"></param>
        /// <param name="httpContext"></param>
        /// <returns></returns>
        public override async Task HandleAsync(AuthorizationHandlerContext context, DefaultHttpContext httpContext)
        {
            // è‹¥å½“å‰è´¦å·å­˜åœ¨é»‘åå•ä¸­åˆ™æˆæƒå¤±è´¥
            if (_sysCacheService.ExistKey($"{CacheConst.KeyBlacklist}{context.User.FindFirst(ClaimConst.UserId)?.Value}"))
            {
                context.Fail();
                context.GetCurrentHttpContext().SignoutToSwagger();
                return;
            }
    
            var tokenExpire = await _sysConfigService.GetTokenExpire();
            var refreshTokenExpire = await _sysConfigService.GetRefreshTokenExpire();
            if (JWTEncryption.AutoRefreshToken(context, context.GetCurrentHttpContext(), tokenExpire.Result, refreshTokenExpire.Result))
            {
                await AuthorizeHandleAsync(context);
            }
            else
            {
                context.Fail(); // æˆæƒå¤±è´¥
                var currentHttpContext = context.GetCurrentHttpContext();
                if (currentHttpContext == null) return;
    
                // è·³è¿‡ç”±äº SignatureAuthentication å¼•å‘çš„å¤±è´¥
                if (currentHttpContext.Items.ContainsKey(SignatureAuthenticationDefaults.AuthenticateFailMsgKey)) return;
                currentHttpContext.SignoutToSwagger();
            }
        }
    
        public override async Task<bool> PipelineAsync(AuthorizationHandlerContext context, DefaultHttpContext httpContext)
        {
            // å·²è‡ªåŠ¨éªŒè¯ Jwt Token æœ‰æ•ˆæ€§
            return await CheckAuthorizeAsync(httpContext);
        }
    
        /// <summary>
        /// æƒé™æ ¡éªŒæ ¸å¿ƒé€»è¾‘
        /// </summary>
        /// <param name="httpContext"></param>
        /// <returns></returns>
        private static async Task<bool> CheckAuthorizeAsync(DefaultHttpContext httpContext)
        {
            // ç™»å½•æ¨¡å¼åˆ¤æ–­PCã€APP
            if (App.User.FindFirst(ClaimConst.LoginMode)?.Value == ((int)LoginModeEnum.APP).ToString())
                return true;
    
            // æ’é™¤è¶…ç®¡
            if (App.User.FindFirst(ClaimConst.AccountType)?.Value == ((int)AccountTypeEnum.SuperAdmin).ToString())
                return true;
    
            // è·¯ç”±åç§°
            var routeName = httpContext.Request.Path.StartsWithSegments("/api")
                ? httpContext.Request.Path.Value![5..].Replace("/", ":")
                : httpContext.Request.Path.Value![1..].Replace("/", ":");
    
            // è·å–ç”¨æˆ·æ‹¥æœ‰æŒ‰é’®æƒé™é›†åˆ
            var ownBtnPermList = await SysMenuService.GetOwnBtnPermList();
            if (ownBtnPermList.Exists(u => routeName.Equals(u, StringComparison.CurrentCultureIgnoreCase)))
                return true;
    
            // è·å–ç³»ç»Ÿæ‰€æœ‰æŒ‰é’®æƒé™é›†åˆ
            var allBtnPermList = await SysMenuService.GetAllBtnPermList();
            return allBtnPermList.TrueForAll(u => !routeName.Equals(u, StringComparison.CurrentCultureIgnoreCase));
        }
    }
    

é¡¹ç›®åœ°å€
----

[AspireApp: Admin.NETå¾®æœåŠ¡ç‰ˆ](https://gitee.com/shiningrise/aspire-app)

[Admin.NET: ğŸ”¥ğŸ”¥ğŸ”¥ Admin.NET åŸºäº .NET8/10 (Furion/SqlSugar) å®ç°çš„é€šç”¨æƒé™å¼€å‘æ¡†æ¶ï¼Œå‰ç«¯é‡‡ç”¨ Vue3/Element-plusï¼Œä»£ç ç®€æ´ã€æ˜“æ‰©å±•ã€‚æ•´åˆæœ€æ–°æŠ€æœ¯ï¼Œæ¨¡å—æ’ä»¶å¼å¼€å‘ï¼Œå‰åç«¯åˆ†ç¦»ï¼Œå¼€ç®±å³ç”¨ã€‚é›†æˆå¤šç§Ÿæˆ·ã€ç¼“å­˜ã€æ•°æ®æ ¡éªŒã€é‰´æƒã€äº‹ä»¶æ€»çº¿ã€åŠ¨æ€APIã€é€šè®¯ã€è¿œç¨‹è¯·æ±‚ã€ä»»åŠ¡è°ƒåº¦ã€æ‰“å°ç­‰ä¼—å¤šé»‘ç§‘æŠ€ã€‚è®©å¼€å‘æ›´ç®€å•ã€æ›´é€šç”¨ã€æ›´æµè¡Œï¼](https://gitee.com/zuohuaijun/Admin.NET)

æ¬¢è¿å…‰ä¸´:[http://shiningrise.cnblogs.com](http://shiningrise.cnblogs.com/)