---
layout: post
title: 'Jenkins Share Libraryæ•™ç¨‹ â€”â€” ä¼ä¸šçº§ Jenkins Shared Library å®æˆ˜ç¤ºä¾‹'
date: "2025-10-29T00:42:48Z"
---
Jenkins Share Libraryæ•™ç¨‹ â€”â€” ä¼ä¸šçº§ Jenkins Shared Library å®æˆ˜ç¤ºä¾‹
==========================================================

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/b4d2b038d4b64bff9b717e02a4d54db4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rWL6K-V5ZCb:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMzU0MDkwMTExMjMxNzIyNCJ9&rk3s=e9ecf3d6&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1761745210&x-orig-sign=47CqrbwOtRpQAJe9TwvdxNJdfMY%3D)

### å†™åœ¨å‰é¢

å¥½ä¹…ä¸è§ï½æœ€è¿‘çŠ¶æ€ç¨ç¼“ï¼Œæ›´æ–°ä¹Ÿæ…¢äº†äº›ï¼Œè¿™ç¯‡æ–‡ç« åŒæ ·è®©å¤§å®¶ç­‰äº†æŒºä¹…ï¼Œå…ˆè·Ÿå¤§å®¶è¯´å£°æŠ±æ­‰ã€‚

å¦‚æœä½ è®¤çœŸè¯»äº†å‰é¢å‡ ç¯‡ï¼Œè¿˜è·Ÿç€å®è·µäº†ï¼Œé‚£åˆ°è¿™é‡Œï¼Œå’±ä»¬å°±è¦æ­£å¼å¼€å¯çœŸæ­£çš„ â€œè¿›é˜¶é˜¶æ®µâ€ å•¦ï¼

ç¡®å®ï¼Œå¤§å¤šæ•°å…¬å¸å†…éƒ¨çš„ Jenkins Shared Library ä¸åªæ˜¯ç®€å•çš„â€œå°è£…å‡ ä¸ª stageâ€è€Œå·²ï¼Œå®ƒä»¬å¾€å¾€åŒ…å«ï¼š

*   workspace æ¸…ç†æœºåˆ¶ï¼ˆé¿å…ç£ç›˜çˆ†æ»¡ï¼‰
*   ç¼“å­˜/ä¾èµ–é‡ç”¨é€»è¾‘
*   å¤šåˆ†æ”¯/å¤šç¯å¢ƒé…ç½®
*   åŠ¨æ€å‚æ•°å’Œæ¡ä»¶é€»è¾‘
*   æµæ°´çº¿é’©å­ï¼ˆpre/post hooksï¼‰
*   é«˜çº§é€šçŸ¥ç³»ç»Ÿï¼ˆSlackã€é‚®ä»¶ã€é£ä¹¦ã€Teamsï¼‰

ä¸‹é¢ï¼Œæˆ‘ä»¬å¯ä»¥ä¸€èµ·å†™ä¸€ä¸ªæ›´â€œä¼ä¸šçº§â€çš„æ¡ˆä¾‹ï¼Œä¼šè®©ä½ çœ‹æ‡‚ä¸ºä»€ä¹ˆå…¬å¸é‚£å¥— Shared Library é‚£ä¹ˆå¤æ‚äº†ã€‚

> ç›®æ ‡ï¼šæ„å»ºä¸€ä¸ª**å¸¦ workspace æ¸…ç†ã€ç¼“å­˜ç®¡ç†ã€é”™è¯¯æ¢å¤ã€é€šçŸ¥ç³»ç»Ÿ**çš„å¯å¤ç”¨ CI Pipelineã€‚

### ä¸€ã€é¡¹ç›®ç»“æ„

    jenkins-shared-lib-enterprise/
    â”œâ”€â”€ vars/
    â”‚   â”œâ”€â”€ enterprisePipeline.groovy       # ä¸»å…¥å£ Pipeline
    â”‚   â”œâ”€â”€ workspaceManager.groovy         # æ¸…ç†ä¸å‡†å¤‡å·¥ä½œåŒº
    â”‚   â”œâ”€â”€ notifyManager.groovy            # é€šçŸ¥æ¨¡å—
    â”‚   â”œâ”€â”€ gitHelper.groovy                # Git æ‹‰å–ä¸åˆ†æ”¯æ“ä½œ
    â”œâ”€â”€ src/org/company/
    â”‚   â”œâ”€â”€ Utils.groovy                    # å·¥å…·ç±»ï¼ˆæ—¶é—´æˆ³ã€æ—¥å¿—ã€é‡è¯•ç­‰ï¼‰
    â”‚   â””â”€â”€ ConfigLoader.groovy             # YAML/JSON é…ç½®è¯»å–å™¨
    â””â”€â”€ resources/templates/
        â””â”€â”€ notifyTemplate.txt
    

### äºŒã€æ¸…ç†å‡½æ•°

ğŸ“„ `vars/cleanWorkspace.groovy`

    def call(Map config = [:]) {
        def cleanBeforeBuild = config.get('clean', true)
        def keepPatterns = config.get('keep', ['.git', '.gradle'])
    
        if (!cleanBeforeBuild) {
            echo "â­ï¸ Skipping workspace cleanup."
            echo "âœ… Workspace ready at: ${pwd()}"
            return
        }
    
        echo "ğŸ§¹ Cleaning workspace, preserving: ${keepPatterns}"
    
        def os = getOS()
    
        if (os == 'Windows') {
            cleanWindows(keepPatterns)
        } else {
            cleanUnix(keepPatterns)
        }
    
        echo "âœ… Workspace ready at: ${pwd()}"
    }
    
    // åˆ¤æ–­æ“ä½œç³»ç»Ÿ
    private String getOS() {
        def osName = System.getProperty('os.name').toLowerCase()
        return osName.contains('windows') ? 'Windows' : 'Unix'
    }
    
    // Unix/Linux/macOS æ¸…ç†æ–¹å¼
    private void cleanUnix(List keepPatterns) {
        def patternStr = keepPatterns.join('|')
        sh """
            echo "Running on Unix/Linux..."
            ls -A1 | grep -v -E '^(${patternStr})\$' | xargs rm -rf || true
        """
    }
    
    // Windows æ¸…ç†æ–¹å¼ï¼ˆä½¿ç”¨ cmd æˆ– PowerShellï¼‰
    private void cleanWindows(List keepPatterns) {
        // è½¬æˆå°å†™ç”¨äºæ¯”è¾ƒ
        def keepSet = keepPatterns.collect { it.toLowerCase() } as Set
    
        // è·å–å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶/ç›®å½•ï¼ˆåŒ…æ‹¬éšè—ï¼‰
        def files = new File(pwd()).listFiles()
        if (!files) return
    
        files.each { file ->
            def name = file.name.toLowerCase()
            if (!keepSet.contains(name)) {
                echo "ğŸ—‘ï¸ Deleting: ${file.name}"
                deleteFileOrDir(file)
            }
        }
    }
    
    // å®‰å…¨åˆ é™¤æ–‡ä»¶æˆ–ç›®å½•ï¼ˆé€’å½’ï¼‰
    private void deleteFileOrDir(File file) {
        try {
            if (file.directory) {
                file.deleteDir() // é€’å½’åˆ é™¤ç›®å½•
            } else {
                file.delete()
            }
        } catch (Exception e) {
            echo "âš ï¸ Failed to delete ${file.name}: ${e.message}"
        }
    }
    

**åŠŸèƒ½è¯´æ˜ï¼š**

*   é»˜è®¤åœ¨æ¯æ¬¡æ„å»ºå‰æ¸…ç†å·¥ä½œåŒºï¼ˆä½†ä¿ç•™ `.git`ã€`.gradle` ç­‰ç¼“å­˜ç›®å½•ï¼‰
    
*   å…¬å¸é‡Œè¿™æ ·åšæ˜¯ä¸ºäº†é¿å…ï¼š
    
    *   Jenkins èŠ‚ç‚¹ç£ç›˜çˆ†æ»¡
    *   å‰æ¬¡æ„å»ºæ®‹ç•™æ–‡ä»¶å¯¼è‡´æ„å»ºå¼‚å¸¸

**Jenkinsfile è°ƒç”¨æ–¹å¼**

    @Library('my-shared-lib') _
    
    pipeline {
        agent any 
    
        stages {
            stage('Cleanup') {
                steps {
                    script {
                        cleanWorkspace(
                            clean: true,
                            keep: ['.git', '.gradle', 'settings.gradle']
                        )
                    }
                }
            }
            // ... å…¶ä»–é˜¶æ®µ
        }
    }
    

è¿è¡Œåï¼Œä½ ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºçœ‹åˆ°ï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/bdeaf9b562974088a18bebc02de3290d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rWL6K-V5ZCb:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMzU0MDkwMTExMjMxNzIyNCJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1762260162&x-orig-sign=l6uzTSPxE3WKofvkp3aLRO8naiY%3D)

### ä¸‰ã€é€šçŸ¥æ¨¡å—

ğŸ“„ `vars/notifyManager.groovy`

    def call(Map args = [:]) {
        def status = args.status ?: 'SUCCESS'
        def message = args.message ?: "Build completed."
        def color = status == 'SUCCESS' ? 'good' : (status == 'FAILURE' ? 'danger' : 'warning')
        def project = env.JOB_NAME
        def buildUrl = env.BUILD_URL
    
        def fullMessage = """
        [${status}] ${project}
        ${message}
        ğŸ‘‰ ${buildUrl}
        """
        echo "ğŸ”” Notify: ${fullMessage.trim()}"
    }
    

**Jenkinsfile è°ƒç”¨æ–¹å¼**

    @Library('my-shared-lib') _
    
    pipeline {
        agent any  // å¯ä»¥æ˜¯ linuxã€windowsã€docker ç­‰
    
        stages {
            stage('Cleanup') {
                steps {
                    script {
                        notifyManager(
                            status: 'SUCCESS',
                            message: 'Build completed.'
                        )
                    }
                }
            }
            // ... å…¶ä»–é˜¶æ®µ
        }
    }
    

è¿è¡Œåï¼Œä½ ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºçœ‹åˆ°ï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/4cdfcf070652430594f39f4490400ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rWL6K-V5ZCb:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMzU0MDkwMTExMjMxNzIyNCJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1762260162&x-orig-sign=%2B%2B246KNHRUK%2FgzNAKRVNywEOXj4%3D)

* * *

### å››ã€Git æ“ä½œå°è£…

ğŸ“„ `vars/gitHelper.groovy`

    // vars/gitCheckout.groovy
    def call(Map config = [:]) {
        def repo = config.repo
        def branch = config.get('branch', 'main')
        def credentialsId = config.get('credentialsId', 'git-credentials')
    
        if (!repo) {
            error "âŒ gitCheckout: 'repo' parameter is required!"
        }
    
        echo "ğŸ” Checking out ${repo} (branch: ${branch})"
    
        checkout([
            $class: 'GitSCM',
            branches: [[name: branch]],
            userRemoteConfigs: [[
                url: repo,
                credentialsId: credentialsId
            ]]
        ])
    }
    

**Jenkinsfile è°ƒç”¨æ–¹å¼**

    @Library('my-shared-lib') _
    
    pipeline {
        agent any
    
        options {
            skipDefaultCheckout()  // ğŸ‘ˆ å…³é”®ï¼è·³è¿‡é»˜è®¤çš„ SCM æ­¥éª¤
        }
    
        parameters {
            string(name: 'GIT_REPO', defaultValue: 'your giturl', description: 'Git repository URL')
            string(name: 'GIT_BRANCH', defaultValue: 'master', description: 'Branch to build')
        }
    
        stages {
            stage('Checkout Code') {
                steps {
                    script {
                        def repo = params.GIT_REPO
                        def branch = params.GIT_BRANCH
    
                        echo "ğŸ” å¼€å§‹æ‹‰å–ä»£ç ï¼š${repo} (åˆ†æ”¯ï¼š${branch})"
    
                        // è°ƒç”¨ vars/gitHelper.groovy
                        gitHelper(
                            repo: repo,
                            branch: branch,
                            credentialsId: 'gitee-credentials'  // æ›¿æ¢ä¸ºä½ çš„å®é™…å‡­æ® ID
                        )
                    }
                }
            }
            stage('Debug') {
                steps {
                    echo "ğŸ“¦ å½“å‰è·¯å¾„ï¼š${pwd()}"
                    bat 'git branch -a'
                    bat 'git log --oneline -5'
                }
            }
        }
    
        post {
            failure {
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
            }
        }
    }
    

è¿è¡Œåï¼Œä½ ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºçœ‹åˆ°ï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/4f40d1439cec4ac5b424d250a47b06e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rWL6K-V5ZCb:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMzU0MDkwMTExMjMxNzIyNCJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1762260162&x-orig-sign=3AuF5psUVBI5LOpYLxP5c%2Fs1xiM%3D)

* * *

### äº”ã€æ ¸å¿ƒ Pipeline

ğŸ“„ `vars/enterprisePipeline.groovy`

    import com.company.Utils
    
    def call(Map config = [:], Closure customStages = null) {
        echo "repo: ${config.repo}, branch: ${config.branch}"
        // åˆå§‹åŒ–
        Utils.printHeader(this, "Initializing Pipeline")
        cleanWorkspace([clean: true, keep: ['.git']])
        gitHelper([repo: config.repo, branch: config.branch])
    
        // æ„å»º
        Utils.printHeader(this, "Build Stage")
        try {
            bat config.buildCommand ?: 'mvn clean package -DskipTests'
        } catch (err) {
            notifyManager([status: 'FAILURE', message: "Build failed: ${err.message}"])
            error("Build failed.")
        }
    
        // æµ‹è¯•
        Utils.printHeader(this, "Test Stage")
        try {
            bat config.testCommand ?: 'mvn compile test'
        } catch (err) {
            notifyManager([status: 'FAILURE', message: "Tests failed: ${err.message}"])
            error("Tests failed.")
        }
    
        // è‡ªå®šä¹‰é˜¶æ®µ
        if (customStages != null) {
            Utils.printHeader(this, "Custom Stages")
            customStages()
        }
    
        // éƒ¨ç½²
        if (config.deploy == true) {
            Utils.printHeader(this, "Deploy Stage")
            // bat config.deployCommand ?: './deploy.sh'
            notifyManager([status: 'SUCCESS', message: "Deployed successfully!"])
        }
    
        // æ”¶å°¾
        def result = currentBuild.result ?: 'SUCCESS'
        notifyManager([status: result, message: "Pipeline finished with status: ${result}"])
        Utils.printHeader(this, "Cleaning workspace after build")
        cleanWorkspace([clean: true])
    }
    

**Jenkinsfile è°ƒç”¨æ–¹å¼**

    @Library('my-shared-lib') _
    
    pipeline {
        agent any
        tools {
            maven 'maven'
        }
        parameters {
            string(name: 'REPO_URL', defaultValue: 'your giturl', description: 'Gitä»“åº“åœ°å€')
            string(name: 'BRANCH', defaultValue: 'master', description: 'åˆ†æ”¯')
        }
        stages {
            stage('ä¼ä¸šæµæ°´çº¿') {
                steps {
                    script {
                        enterprisePipeline([
                            repo: params.REPO_URL,
                            branch: params.BRANCH
                        ])
                    }
                }
            }
        }
    }
    

è¿è¡Œåï¼Œä½ ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºçœ‹åˆ°ï¼š

![image.png](https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/e74f79c6387f4e5d92b1219fe270fa98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L2v5Lu25rWL6K-V5ZCb:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMzU0MDkwMTExMjMxNzIyNCJ9&rk3s=f64ab15b&x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&x-orig-expires=1762260162&x-orig-sign=N9XVoCo52EQ3OFterKmLI0D8m2c%3D)

### å†™åœ¨æœ€å

æœ¬æ–‡ä»¥ Maven é¡¹ç›®ä¸ºç¤ºä¾‹ï¼Œæ ¸å¿ƒæ€è·¯å¯è¿ç§»è‡³å…¶ä»–è¯­è¨€é¡¹ç›®ï¼Œåç»­ä»æœ‰æ‰©å±•ç©ºé—´ï¼Œæ„Ÿå…´è¶£è€…å¯è‡ªè¡Œæ¢ç´¢ã€‚

æ„Ÿè°¢ä½ çš„è®¤çœŸé˜…è¯»ï¼è‹¥æ–‡ç« å¯¹ä½ æœ‰ä»·å€¼ï¼Œæ¬¢è¿æ–‡æœ«ç•™è¨€äº¤æµï¼Œä¹Ÿè¯·å¸®å¿™ç‚¹èµè½¬å‘ï¼Œè°¢è°¢æ”¯æŒï¼

**ä¼˜ç§€ä¸å¤Ÿï¼Œä½ æ˜¯å¦æ— å¯æ›¿ä»£**

**è½¯ä»¶æµ‹è¯•äº¤æµQQç¾¤ï¼š721256703ï¼ŒæœŸå¾…ä½ çš„åŠ å…¥ï¼ï¼**

**æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ï¼šè½¯ä»¶æµ‹è¯•å›**

![](https://www.cnblogs.com/images/cnblogs_com/longronglang/1061549/o_QQ%E6%88%AA%E5%9B%BE20190728134401.jpg)