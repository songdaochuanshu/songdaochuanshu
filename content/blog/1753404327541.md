---
layout: post
title: 'æœ¬å¯é¿å…çš„P1äº‹æ•…ï¼šNginxå˜æ›´å¯¼è‡´ç½‘å…³è¯·æ±‚å‡å“åº”400'
date: "2025-07-25T00:45:27Z"
---
æœ¬å¯é¿å…çš„P1äº‹æ•…ï¼šNginxå˜æ›´å¯¼è‡´ç½‘å…³è¯·æ±‚å‡å“åº”400
=============================

##### é—®é¢˜èƒŒæ™¯

é¡¹ç›®ä¸Šä½¿ç”¨SpringCloudGatewayä½œä¸ºç½‘å…³æ‰¿æ¥å…¬ç½‘ä¸Šå„ä¸ªä¸šåŠ¡çº¿è¿›æ¥çš„è¯·æ±‚æµé‡ï¼Œåœ¨ç½‘å…³çš„å‰é¢æœ‰ä¸¤å°Nginxåå‘ä»£ç†äº†ç½‘å…³ï¼Œç½‘å…³åšäº†ä¸€ç³»åˆ—çš„å‰ç½®å¤„ç†åè½¬å‘è¯·æ±‚åˆ°åé¢å„ä¸ªä¸šåŠ¡çº¿çš„æœåŠ¡ï¼Œç®€è¦çš„ç½‘ç»œé“¾è·¯ä¸ºï¼š

    ç½‘å…³åŸŸå(wmg.test.com) -> ... -> Nginx ->F5(ç¡¬è´Ÿè½½åŸŸåfp.wmg.test) -> ç½‘å…³ -> ä¸šåŠ¡ç³»ç»Ÿ
    

æŸå¤©ï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¦å¢åŠ ä¸¤å°æ–°çš„Nginxæœºå™¨ï¼ŒåŸå› è¯´æ¥è¯é•¿ï¼ŒæŒ‰ä¸‹ä¸è¡¨ï¼Œä½¿ç”¨ä¸¤å°æ–°çš„Nginxæœºå™¨æ›¿ä»£æ‰åŸå…ˆåå‘ä»£ç†ç½‘å…³çš„ä¸¤å°Nginxã€‚

##### SREç­‰çº§å®šæ€§P1

ä¸€ä¸ªæœˆé»‘é£é«˜çš„å¤œæ™šï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¿›è¡Œäº†ç”Ÿäº§å˜æ›´ï¼Œåœ¨ä¸¤å°æ–°æœºå™¨ä¸Šéƒ¨ç½²äº†Nginxï¼Œç„¶åè®©ç½‘ç»œå›¢é˜Ÿå°†ç½‘å…³åŸŸåçš„æµé‡åˆ‡æ¢åˆ°äº†ä¸¤å°æ–°çš„Nginxæœºå™¨ä¸Šï¼Œåˆšåˆ‡æ¢å®Œï¼Œç«‹é©¬æœ‰ä¸šåŠ¡çº¿å›¢é˜Ÿçš„äººååº”ï¼Œè¿‡ç½‘å…³çš„æ¥å£è¯·æ±‚éƒ½å˜æˆ400äº†ã€‚è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿåˆè®©ç½‘ç»œå›¢é˜Ÿå°†ç½‘å…³åŸŸåæµé‡åˆ‡å›åˆ°åŸæœ‰çš„ä¸¤å°Nginxä¸Šï¼Œä¸šåŠ¡çº¿è¿‡ç½‘å…³çš„æ¥å£è¯·æ±‚æ¢å¤æ­£å¸¸ï¼ŒæŒç»­äº†ä¸¤åˆ†å¤šé’Ÿï¼ŒSREç­‰çº§å®šæ€§P1ã€‚

è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿè¯´ï¼Œä¸¤å°æ–°çš„Nginxé…ç½®å’ŒåŸæœ‰çš„ä¸¤å°Nginxé…ç½®ä¸€æ ·ï¼Œçœ‹ä¸å‡ºä»€ä¹ˆé—®é¢˜ï¼Œæ‰¾åˆ°æˆ‘ï¼Œè®©æˆ‘ä»ç½‘å…³æ’æŸ¥æœ‰æ²¡æœ‰ä»€ä¹ˆé”™è¯¯æ—¥å¿—ã€‚

ä¸å¤ªå¯èƒ½å§ï¼Œå¦‚æœæ–°çš„ä¸¤å°Nginxé…ç½®å’ŒåŸæœ‰çš„ä¸¤å°Nginxé…ç½®ä¸€æ ·çš„è¯ï¼Œä¸ä¼šå‡ºç°è¯·æ±‚éƒ½æ˜¯400çš„é—®é¢˜å•Šï¼Œæˆ‘å¿ƒæƒ³ï¼Œä¸è¿‡è¿˜æ˜¯å»çœ‹äº†ç½‘å…³ä¸Šçš„æ—¥å¿—ï¼Œåœ¨é‚£ä¸ªæ—¶é—´æ®µï¼Œç½‘å…³æ²¡æœ‰é”™è¯¯æ—¥å¿—å‡ºç°ã€‚

çœ‹äº†ä¸‹æ–°Nginxçš„æ—¥å¿—ï¼ŒOptionsè¯·æ±‚æ­£å¸¸è¿”å›204ï¼Œå…¶å®ƒçš„GETã€POSTè¯·æ±‚éƒ½æ˜¯400ï¼ŒOptionsæ˜¯é¢„æ£€è¯·æ±‚ï¼Œåœ¨Nginxå±‚é¢å°±å¤„ç†è¿”å›äº†ï¼Œæ–°Nginxçš„æ—¥å¿—ç¤ºä¾‹å¦‚ä¸‹ï¼š

    10.x.x.x:63048 > -  > 10.x.x.x:8099 > [2025-07-17T10:36:26+08:00] > 10.x.x.x:8099  OPTIONS /api/xxx HTTP/1.1 > 204 > 0 > https://domain/ > Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 > - > [req_time:0.000 s] >[upstream_connect_time:- s]> [upstream_header_time:- s] > [upstream_resp_time:- s] [-]
    10.x.x.x:63048 > -  > 10.x.x.x:8099 > [2025-07-17T10:36:26+08:00] > 10.x.x.x:8099  POST /api/xxx HTTP/1.1 > 400 > 0 > https://domain/ > Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/138.0.0.0 Safari/537.36 > - > [req_time:0.001 s] >[upstream_connect_time:0.000 s]> [upstream_header_time:0.001 s] > [upstream_resp_time:0.001 s] [10.x.x.x:8082]
    

å»æ‰¾äº†ç½‘ç»œå›¢é˜Ÿï¼Œä»æµé‡å›æº¯è®¾å¤‡ä¸Šçœ‹åˆ°400ç¡®å®æ˜¯ç½‘å…³è¿”å›çš„ï¼Œè¿˜æ²¡æœ‰åˆ°åé¢çš„ä¸šåŠ¡ç³»ç»Ÿï¼Œ400ä»£è¡¨BadRequestï¼Œæˆ‘æ€€ç–‘æ˜¯ä¸æ˜¯è¯·æ±‚ä½“çš„é—®é¢˜ï¼Œæƒ³è®©ç½‘ç»œå°†é‚£ä¸ªæ—¶é—´æ®µçš„æµé‡åŒ…æ•°æ®å–ä¸‹æ¥åˆ†æï¼Œç½‘ç»œæ²¡ç»™ï¼Œåªç»™æˆ‘äº†ä¸šåŠ¡æŠ¥æ–‡å‚æ•°ï¼Œèµ°ç½‘å…³è¯·æ±‚çš„ä¸šåŠ¡å‚æ•°æŠ¥æ–‡æ˜¯åŠ å¯†çš„ï¼Œæˆ‘æœ¬åœ°è¿è¡Œç¨‹åºå¯ä»¥æ­£å¸¸è§£å¯†æŠ¥æ–‡ï¼Œæˆ‘åé¦ˆç»™äº†è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿã€‚

è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸåˆèŠ±äº†ä¸€æ®µæ—¶é—´å®šä½é—®é¢˜ï¼Œè¿˜æ˜¯æ²¡æœ‰å¤´ç»ªï¼Œåˆæ‰¾åˆ°æˆ‘ï¼Œè®©æˆ‘å¸®å¿™åˆ†æè°ƒæŸ¥ä¸‹ã€‚

##### ä»‹å…¥è°ƒæŸ¥

æˆ‘è¯´æµ‹è¯•ç¯å¢ƒåœ°å€æ˜¯å•¥ï¼Œæˆ‘å…ˆåœ¨æµ‹è¯•ç¯å¢ƒçœ‹ä¸‹èƒ½ä¸èƒ½å¤ç°ï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿæˆå‘˜è¯´ï¼Œæ²¡æœ‰åœ¨æµ‹è¯•ç¯å¢ƒæ­å»ºæµ‹è¯•ï¼Œè¿™ä¸€æ¬¡å˜æ›´æ˜¯å¦ä¸€ä¸ªæˆå‘˜ç›´æ¥ç”Ÿäº§å˜æ›´ã€‚

ğŸ˜“

æˆ‘è¦æ¥äº†æ–°çš„Nginxé…ç½®æ–‡ä»¶å’Œè€çš„Nginxé…ç½®æ–‡ä»¶æ¯”å¯¹äº†ä¸‹ï¼Œå‘ç°æœ‰ä¸ä¸€æ ·çš„åœ°æ–¹ï¼Œè€Nginxä¸Šåå‘ä»£ç†ç½‘å…³çš„é…ç½®å¦‚ä¸‹ï¼š

    server {
        listen 8080;
        server_name wmg.test.com;
        
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Content-Security-Policy "frame-ancestors 'self'";
    	
        location / {
            proxy_hide_header  host;
            client_max_body_size    100m;
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
            add_header 'Access-Control-Allow-Headers' '...';
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            proxy_pass http://fp.wmg.test:8090;
        }
    }
    

æ–°Nginxé…ç½®å¦‚ä¸‹ï¼š

    upstream http_gateways{
      server fp.wmg.test:8090;
      keepalive 30;
    }
    
    server {
        listen 8080 backlog=512;
        server_name wmg.test.com;
        
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Content-Security-Policy "frame-ancestors 'self'";
        
        location / {
            proxy_hide_header  host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            client_max_body_size    100m;
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
            add_header 'Access-Control-Allow-Headers' '...';
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            proxy_pass http://http_gateways;
        }
    }
    

æ–°Nginxä»£ç†ç½‘å…³çš„é…ç½®ä¸åŸæœ‰Nginxä¸Šçš„é…ç½®åŒºåˆ«åœ¨äºï¼š

*   ä½¿ç”¨upstreamé…ç½®äº†ç½‘å…³çš„F5è´Ÿè½½å‡è¡¡åœ°å€ï¼š
    
        upstream http_gateways{
          server fp.wmg.test:8090;
          keepalive 30;
        }
        
    
*   è®¾ç½®httpåè®®ä¸º1.1ï¼Œå¯ç”¨é•¿è¿æ¥
    
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
    

æˆ‘è®©è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿåœ¨æµ‹è¯•ç¯å¢ƒçš„Nginxä¸ŠæŒ‰ç…§æ–°çš„Nginxé…ç½®æ¨¡æ‹Ÿäº†ç”Ÿäº§ç¯å¢ƒï¼š

Nginxï¼š10.100.8.11 ç›‘å¬9104ç«¯å£

ç½‘å…³ï¼š10.100.22.48 ç›‘å¬8081ç«¯å£

Nginxçš„9104ç«¯å£è½¬å‘åˆ°ç½‘å…³çš„8081ç«¯å£ï¼Œé…ç½®å¦‚ä¸‹ï¼š

    upstream http_gateways{
      server 10.100.22.48:8081;
      keepalive 30;
    }
    
    server {
        listen 9104 backlog=512;
        server_name localhost;
    
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Content-Security-Policy "frame-ancestors 'self'";
    
        location / {
            proxy_hide_header  host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            client_max_body_size    100m;
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
            add_header 'Access-Control-Allow-Headers' '...';
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            proxy_pass http://http_gateways;
        }
    }
    

##### é—®é¢˜å¤ç°

é€šè¿‡Nginxè¯·æ±‚ç½‘å…³åˆ°åç«¯æœåŠ¡æ¥å£ï¼Œé—®é¢˜å¤ç°ï¼Œè¯·æ±‚å“åº”400ï¼š

    curl -v -X GET http://10.100.8.11:9104/wechat-web/actuator/info
    

å»æ‰ä¸‹é¢çš„ä¸¤ä¸ªé…ç½®ï¼Œè¯·æ±‚æ­£å¸¸å“åº”200ï¼š

    proxy_http_version 1.1;
    proxy_set_header Connection "";
    

##### å¤©å¤–æ¥é”…

å°†è¿™ä¸ªç°è±¡åé¦ˆç»™äº†è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿï¼Œç»“æœè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸæŸ¥äº†åŠå¤©è¯´ç½‘å…³ä¸æ”¯æŒé•¿è¿æ¥ï¼Œè¦è®©ç½‘å…³æ”¹é€ ã€‚

ğŸ˜“

ä¸åº”è¯¥å•Šï¼Œä»¥å¾€ç½‘å…³å‘ç‰ˆçš„æ—¶å€™ï¼Œæ˜¯æ»šåŠ¨å‘ç‰ˆçš„ï¼ŒF5ä¸Šå…ˆä¸‹æ‰ä¸€ä¸ªæœºå™¨çš„æµé‡ï¼Œåœå¯è¿™ä¸ªæœºå™¨ä¸Šçš„ç½‘å…³æœåŠ¡ï¼Œç„¶åF5ä¸Šæµé‡ï¼ŒF5ä¸‹æµé‡çš„æ—¶å€™æ˜¯æœ‰é•¿è¿æ¥å­˜åœ¨çš„ï¼Œæ¯æ¬¡éƒ½ä¼šç­‰ä¸ª5åˆ†é’Ÿå·¦å³æ‰èƒ½ä¸‹æ‰ä¸€è·¯çš„æµé‡ã€‚

å¾—ï¼Œå…ˆæ”¾ä¸‹æ‰‹å¤´çš„å·¥ä½œï¼ŒèŠ±ç‚¹æ—¶é—´æ¥è¯æ˜ç½‘å…³æ˜¯æ”¯æŒé•¿è¿æ¥çš„ã€‚

åœ¨Nginxæœºå™¨ä¸Šé€šè¿‡å‘½ä»¤è¡ŒæŒ‡å®šé•¿è¿æ¥æ–¹å¼è®¿é—®ç½‘å…³è¯·æ±‚åç«¯æœåŠ¡æ¥å£ï¼š

    wget -d --header="Connection: keepalive" http://10.100.22.48:8081/wechat-web/actuator/info http://10.100.22.48:8081/wechat-web/actuator/info http://10.100.22.48:8081/wechat-web/actuator/info
    

å›è½¦å‡ºç°å¦‚ä¸‹æ—¥å¿—ï¼š

    Setting --header (header) to Connection: keepalive
    DEBUG output created by Wget 1.14 on linux-gnu.
    
    URI encoding = â€˜UTF-8â€™
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    --2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
    Connecting to 10.100.22.48:8081... connected.
    Created socket 3.
    Releasing 0x0000000000c95a90 (new refcount 0).
    Deleting unused 0x0000000000c95a90.
    
    ---request begin---
    GET /wechat-web/actuator/info HTTP/1.1
    User-Agent: Wget/1.14 (linux-gnu)
    Accept: */*
    Host: 10.100.22.48:8081
    Connection: keepalive
    
    ---request end---
    HTTP request sent, awaiting response... 
    ---response begin---
    HTTP/1.1 200 OK
    transfer-encoding: chunked
    Content-Type: application/vnd.spring-boot.actuator.v3+json
    Date: Thu, 17 Jul 2025 05:25:34 GMT
    
    ---response end---
    200 OK
    Registered socket 3 for persistent reuse.
    Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
    Saving to: â€˜infoâ€™
    
        [ <=>                                                                                                                                                              ] 83          --.-K/s   in 0s      
    
    2025-07-17 13:45:08 (7.75 MB/s) - â€˜infoâ€™ saved [83]
    
    URI encoding = â€˜UTF-8â€™
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    --2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
    Reusing existing connection to 10.100.22.48:8081.
    Reusing fd 3.
    
    ---request begin---
    GET /wechat-web/actuator/info HTTP/1.1
    User-Agent: Wget/1.14 (linux-gnu)
    Accept: */*
    Host: 10.100.22.48:8081
    Connection: keepalive
    
    ---request end---
    HTTP request sent, awaiting response... 
    ---response begin---
    HTTP/1.1 200 OK
    transfer-encoding: chunked
    Content-Type: application/vnd.spring-boot.actuator.v3+json
    Date: Thu, 17 Jul 2025 05:25:34 GMT
    
    ---response end---
    200 OK
    Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
    Saving to: â€˜info.1â€™
    
        [ <=>                                                                                                                                                              ] 83          --.-K/s   in 0s      
    
    2025-07-17 13:45:08 (9.47 MB/s) - â€˜info.1â€™ saved [83]
    
    URI encoding = â€˜UTF-8â€™
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    Converted file name 'info' (UTF-8) -> 'info' (UTF-8)
    --2025-07-17 13:45:08--  http://10.100.22.48:8081/wechat-web/actuator/info
    Reusing existing connection to 10.100.22.48:8081.
    Reusing fd 3.
    
    ---request begin---
    GET /wechat-web/actuator/info HTTP/1.1
    User-Agent: Wget/1.14 (linux-gnu)
    Accept: */*
    Host: 10.100.22.48:8081
    Connection: keepalive
    
    ---request end---
    HTTP request sent, awaiting response... 
    ---response begin---
    HTTP/1.1 200 OK
    transfer-encoding: chunked
    Content-Type: application/vnd.spring-boot.actuator.v3+json
    Date: Thu, 17 Jul 2025 05:25:34 GMT
    
    ---response end---
    200 OK
    Length: unspecified [application/vnd.spring-boot.actuator.v3+json]
    Saving to: â€˜info.2â€™
    
        [ <=>                                                                                                                                                              ] 83          --.-K/s   in 0s      
    
    2025-07-17 13:45:08 (11.1 MB/s) - â€˜info.2â€™ saved [83]
    
    FINISHED --2025-07-17 13:45:08--
    Total wall clock time: 0.1s
    Downloaded: 3 files, 249 in 0s (9.25 MB/s)
    
    

å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚å»ºç«‹äº†socket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200

ç¬¬äºŒä¸ªè¯·æ±‚é‡ç”¨äº†ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œsocket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200

ç¬¬ä¸‰ä¸ªè¯·æ±‚ä¾ç„¶é‡ç”¨äº†ç¬¬ä¸€ä¸ªè¿æ¥ï¼Œsocket 3ï¼ŒConnection: keepaliveï¼Œè¯·æ±‚æˆåŠŸï¼Œhttpå“åº”çŠ¶æ€ç ä¸º200

ç½‘å…³æ˜¯æ”¯æŒé•¿è¿æ¥çš„ï¼Œåé¦ˆç»™è´Ÿè´£è¿ç»´Nginxçš„å›¢é˜Ÿï¼Œè´Ÿè´£è¿ç»´Nginxçš„å›¢é˜ŸåˆæŸ¥äº†åŠå¤©ï¼Œåˆæ‰¾åˆ°æˆ‘è¯´è¿˜æ˜¯å¾—æ‹œæ‰˜æˆ‘æ¥è°ƒæŸ¥è§£å†³æ‰è¿™ä¸ªé—®é¢˜ã€‚

##### æ·±åº¦è°ƒæŸ¥

åœ¨æµ‹è¯•ç¯å¢ƒNginxæœºå™¨10.100.8.11ä¸Šä½¿ç”¨tcpdumpå‘½ä»¤æŠ“å–ä¸ç½‘å…³ç›¸å…³çš„æµé‡åŒ…ï¼š

    tcpdump -vv -i ens192 host 10.100.22.48 and tcp port 8081 -w /tmp/ng400.cap
    

æ‰¾åˆ°å‡ºç°httpå“åº”ç ä¸º400çš„è¯·æ±‚ï¼Œå¯ä»¥çœ‹åˆ°æµé‡åŒ…ä¸­çš„wechat-web/actuator/infoè¯·æ±‚å“åº”ä¸ºï¼šHTTP/1.1 400 Bad Request

è§‚å¯Ÿè¯·æ±‚ä½“ï¼Œå…¶ä¸­ä¸€ä¸ªè¯·æ±‚å¤´Hostçš„å€¼ä¸ºï¼šhttp\_gatewaysï¼Œè¿™å¼•èµ·äº†æˆ‘çš„æ³¨æ„ï¼š

æŸ¥é˜…èµ„æ–™å¾—åˆ°ï¼ŒHTTP/1.1åè®®è§„èŒƒå®šä¹‰HTTP/1.1ç‰ˆæœ¬å¿…é¡»ä¼ é€’Hostè¯·æ±‚å¤´

    - Both clients and servers MUST support the Host request-header.
    - A client that sends an HTTP/1.1 request MUST send a Host header.
    - Servers MUST report a 400 (Bad Request) error if an HTTP/1.1
            request does not include a Host request-header.
    - Servers MUST accept absolute URIs.
    

[https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.2](https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.2)

[https://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html#sec19.6.1.1](https://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html#sec19.6.1.1)

Hostçš„æ ¼å¼å¯ä»¥åŒ…å«ï¼š. å’Œ - ç‰¹æ®Šç¬¦å·ï¼Œ\_ ä¸è¢«æ”¯æŒ

æŸ¥é˜…Nginxçš„å®˜æ–¹æ–‡æ¡£å¾—çŸ¥ï¼Œ_proxy\_set\_header_ æœ‰ä¸¤ä¸ªé»˜è®¤é…ç½®ï¼š

    proxy_set_header Host       $proxy_host;
    proxy_set_header Connection close;
    

[https://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_set\_header](https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header)

å¯ä»¥çœ‹å‡ºNginxå¯ç”¨äº†HTTP/1.1åè®®ï¼ŒHostå¦‚æœæ²¡æœ‰æŒ‡å®šä¼šå–$proxy\_hostï¼Œé‚£ä¹ˆä½¿ç”¨upstreamçš„æƒ…å†µä¸‹ï¼Œ$proxy\_hostå°±æ˜¯upstreamçš„åç§°ï¼Œè€Œæ­¤å¤„çš„upstreamä¸­åŒ…å«\_ï¼Œä¸æ˜¯åˆæ³•çš„Hostæ ¼å¼ã€‚

HTTP/1.1è§„å®šå¿…é¡»ä¼ é€’Hostçš„ä¸€æ–¹é¢åŸå› å°±æ˜¯ä¸ºäº†æ”¯æŒå•IPåœ°å€æ‰˜ç®¡å¤šåŸŸåçš„è™šæ‹Ÿä¸»æœºåŠŸèƒ½ï¼Œæ–¹ä¾¿åç«¯æœåŠ¡æ ¹æ®ä¸åŒæ¥æºHoståšä¸åŒçš„å¤„ç†ã€‚

    Older HTTP/1.0 clients assumed a one-to-one relationship of IP addresses and servers; there was no other established mechanism for distinguishing the intended server of a request than the IP address to which that request was directed. The changes outlined above will allow the Internet, once older HTTP clients are no longer common, to support multiple Web sites from a single IP address, greatly simplifying large operational Web servers, where allocation of many IP addresses to a single host has created serious problems. 
    

é‚£ä¹ˆåªè¦éµå¾ªäº†HTTP/1.1åè®®è§„èŒƒçš„æ¡†æ¶ï¼ˆTomcatã€SpringCloudGatewayã€...ï¼‰åœ¨è§£æHostæ—¶å‘ç°Hostä¸æ˜¯åˆæ³•çš„æ ¼å¼æ—¶ï¼Œå°±å“åº”äº†400ã€‚

æœ¬åœ°æ­å»ºäº†ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œdebugäº†ä¸‹ç½‘å…³çš„ä»£ç ï¼Œåœ¨SpringCloudGatewayè§£æhttpè¯·æ±‚ç±»ReactorHttpHandlerAdapterä¸­çš„applyæ–¹æ³•é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œè§£æHostå¤±è´¥ä¼šå“åº”400ï¼š

ä¸‹é¢æ˜¯SpringCloudGatewayè§£æhttpè¯·æ±‚ç±»ReactorHttpHandlerAdapterä¸­çš„applyæ–¹æ³•é€»è¾‘ï¼š

    public Mono<Void> apply(HttpServerRequest reactorRequest, HttpServerResponse reactorResponse) {
    	NettyDataBufferFactory bufferFactory = new NettyDataBufferFactory(reactorResponse.alloc());
    	try {
    		ReactorServerHttpRequest request = new ReactorServerHttpRequest(reactorRequest, bufferFactory);
    		ServerHttpResponse response = new ReactorServerHttpResponse(reactorResponse, bufferFactory);
    		if (request.getMethod() == HttpMethod.HEAD) {
    			response = new HttpHeadResponseDecorator(response);
    		}
    		return this.httpHandler.handle(request, response)
    				.doOnError(ex -> logger.trace(request.getLogPrefix() + "Failed to complete: " + ex.getMessage()))
    				.doOnSuccess(aVoid -> logger.trace(request.getLogPrefix() + "Handling completed"));
    	}
    	catch (URISyntaxException ex) {
    		if (logger.isDebugEnabled()) {
    			logger.debug("Failed to get request URI: " + ex.getMessage());
    		}
    		reactorResponse.status(HttpResponseStatus.BAD_REQUEST);
    		return Mono.empty();
    	}
    }
    

SpringCloudGatewayé€šè¿‡debugçº§åˆ«æ—¥å¿—è¾“å‡ºè¿™ç±»ä¸ç¬¦åˆåè®®è§„èŒƒçš„æ—¥å¿—ï¼Œç”Ÿäº§æ—¥å¿—çº§åˆ«ä¸ºinfoï¼Œå› æ­¤ä¸ä¼šæ‰“å°è¿™æ ·å¼‚å¸¸çš„æ—¥å¿—ã€‚

##### è§£å†³æ–¹æ¡ˆ

æ—¢ç„¶HTTP/1.1åè®®è§„å®šå¿…é¡»ä¼ é€’Hostä¸”æ²¡æœ‰é€šè¿‡é…ç½®æ˜¾å¼æŒ‡å®šNginxä¼ é€’çš„Hostæ—¶Nginxä¼šæœ‰é»˜è®¤å€¼ï¼Œé‚£ä¹ˆåœ¨Nginxçš„é…ç½®ä¸­å¢åŠ ä¼ é€’Hostçš„é…ç½®è¦†ç›–é»˜è®¤å€¼çš„é€»è¾‘ï¼ŒæŸ¥é˜…Nginxçš„æ–‡æ¡£ï¼Œå¯ä»¥é€šè¿‡å¢åŠ ä¸‹é¢çš„é…ç½®è§£å†³ï¼š

    proxy_set_header Host       $host;
    

åœ¨æµ‹è¯•ç¯å¢ƒNginx9104ç«¯å£ä»£ç†é…ç½®ä¸­å¢åŠ ä¸Šé¢çš„é…ç½®ï¼Œå†æ¬¡æ‰§è¡Œï¼Œè¯·æ±‚æ­£å¸¸å“åº”200ã€‚

å®Œæ•´é…ç½®å¦‚ä¸‹ï¼š

    upstream http_gateways{
      server 10.100.22.48:8081;
      keepalive 30;
    }
    
    server {
        listen 9104 backlog=512;
        server_name wmg.test.com;
        
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";
        add_header Content-Security-Policy "frame-ancestors 'self'";
        
        location / {
            proxy_set_header Host       $host;
            proxy_hide_header  host;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            client_max_body_size    100m;
            add_header 'Access-Control-Allow-Origin' "$http_origin" always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, DELETE, PUT';
            add_header 'Access-Control-Allow-Headers' '...';
            if ($request_method = 'OPTIONS') {
                return 204;
            }
            proxy_pass http://http_gateways;
        }
    }
    

è§£å†³æ–¹æ¡ˆä¸æ­¢ä¸€ä¸ª:

*   å¯ä»¥ä¿®æ”¹upstreamçš„åç§°ï¼Œå»æ‰ä¸æ”¯æŒçš„\_ï¼Œæ¯”å¦‚æ›´æ¢ä¸ºï¼šhttp-gatewaysã€httpgateways
*   è¿˜å¯ä»¥ç›´æ¥æŒ‡å®šHostçš„å€¼ä¸ºåŸŸåï¼ˆdomainï¼‰ï¼Œproxy\_set\_header Host 'doamin';

##### æ€»ç»“

è¿™ä¸ªé—®é¢˜åªè¦åœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ä¸‹ï¼Œæ˜¯å¿…ç°çš„ï¼Œä¸å±äºæµ‹è¯•caseæ²¡æœ‰è¦†ç›–åˆ°çš„èŒƒç•´ï¼Œä¸€å®šè¦é‡è§†æµ‹è¯•æµç¨‹ï¼Œå¾ˆå¤šæµç¨‹çœ‹ä¼¼ç¹çï¼Œå…¶å®éƒ½æ˜¯è¡€ä¸æ³ªçš„æ•™è®­å¾—æ¥çš„ã€‚

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[æœåŠ²æ¾](https://www.cnblogs.com/imadc/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/imadc/p/19002991](https://www.cnblogs.com/imadc/p/19002991)