---
layout: post
title: 'Spring Boot è¿›é˜¶ï¼šä¼ä¸šçº§æ€§èƒ½ä¸å¯è§‚æµ‹æ€§æŒ‡å—'
date: "2025-11-14T00:42:56Z"
---
Spring Boot è¿›é˜¶ï¼šä¼ä¸šçº§æ€§èƒ½ä¸å¯è§‚æµ‹æ€§æŒ‡å—
===========================

æ‰©å±• Spring Boot åº”ç”¨ä¸ä»…ä»…æ˜¯æ·»åŠ æ›´å¤šæœåŠ¡å™¨ã€‚å®ƒå…³ä¹**å·¥ç¨‹æ•ˆç‡**â€”â€”åœ¨æ°´å¹³æ‰©å±•ä¹‹å‰ï¼Œä»ç°æœ‰ç¡¬ä»¶ä¸­æ¦¨å–æ¯ä¸€åˆ†æ€§èƒ½ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨å¦‚ä½•ä¸ºé«˜æ€§èƒ½ã€äº‘åŸç”Ÿç¯å¢ƒè°ƒä¼˜ã€æ‰©å±•å’Œåˆ†æ Spring Boot åº”ç”¨â€”â€”åŒ…å«**å®è·µç¤ºä¾‹**ã€**ä»£ç æ³¨é‡Š**å’Œ**æ¶æ„å¯è§†åŒ–**ï¼Œä½ å¯ä»¥ç«‹å³åº”ç”¨ã€‚

ä¸ºä»€ä¹ˆæ€§èƒ½ä¼˜åŒ–å¾ˆé‡è¦
----------

å¤§å¤šæ•° Spring Boot åº”ç”¨åœ¨å¼€å‘ç¯å¢ƒä¸­è¡¨ç°è‰¯å¥½ï¼Œä½†åœ¨ç”Ÿäº§çº§è´Ÿè½½ä¸‹å´©æºƒï¼ŒåŸå› åŒ…æ‹¬ï¼š

*   æœªä¼˜åŒ–çš„è¿æ¥æ± 
*   ä½æ•ˆçš„ç¼“å­˜
*   é˜»å¡çš„ I/O çº¿ç¨‹
*   ç³Ÿç³•çš„ JVM é…ç½®

> **ç›®æ ‡ï¼š** åœ¨æ‰©å±•åŸºç¡€è®¾æ–½\_ä¹‹å‰\_ä¿®å¤ç“¶é¢ˆã€‚

æˆ‘ä»¬å°†æ¶µç›–ä»¥ä¸‹å†…å®¹ï¼š

*   è¿æ¥æ± ä¸æ•°æ®åº“ä¼˜åŒ–
*   æ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼ˆCaffeine + Redisï¼‰
*   å¼‚æ­¥ä¸å“åº”å¼ç¼–ç¨‹
*   HTTP å±‚è°ƒä¼˜
*   JVMã€GC ä¸åˆ†ææŠ€æœ¯
*   å¯è§‚æµ‹æ€§ä¸è‡ªåŠ¨æ‰©ç¼©å®¹

1\. è¿æ¥æ± ä¸æ•°æ®åº“ä¼˜åŒ–
-------------

æ•°æ®åº“è¿æ¥æ± é€šå¸¸æ˜¯ Spring Boot åº”ç”¨ä¸­çš„**ç¬¬ä¸€ä¸ªå¯æ‰©å±•æ€§ç“¶é¢ˆ**ã€‚è™½ç„¶ Spring Boot å†…ç½®äº† **HikariCP**ï¼ˆæœ€å¿«çš„è¿æ¥æ± ä¹‹ä¸€ï¼‰ï¼Œä½†é»˜è®¤é…ç½®å¹¶æœªé’ˆå¯¹ç”Ÿäº§å·¥ä½œè´Ÿè½½è¿›è¡Œè°ƒä¼˜ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹é…ç½®å¦‚ä½•å½±å“ååé‡å’Œå»¶è¿Ÿã€‚

### é»˜è®¤é…ç½®ï¼ˆä¸é€‚åˆç”Ÿäº§ï¼‰

    spring:
      datasource:
        url: jdbc:postgresql://localhost:5432/app_db
        username: app_user
        password: secret
    

ä½¿ç”¨é»˜è®¤é…ç½®æ—¶ï¼ŒHikariCP ä¼šåˆ›å»ºä¸€ä¸ªå°çš„è¿æ¥æ± ï¼ˆé€šå¸¸ä¸º 10 ä¸ªè¿æ¥ï¼‰ï¼Œè¿™å¯èƒ½å¯¼è‡´è´Ÿè½½ä¸‹çš„**çº¿ç¨‹é˜»å¡**å’Œ**è¶…æ—¶**ã€‚

### é’ˆå¯¹é«˜ååé‡çš„ä¼˜åŒ–é…ç½®

    spring:
      datasource:
        url: jdbc:postgresql://localhost:5432/app_db
        username: app_user
        password: secret
        hikari:
          maximum-pool-size: 30     # (1) æœ€å¤§æ´»è·ƒè¿æ¥æ•°
          minimum-idle: 10          # (2) é¢„çƒ­å¤‡ç”¨è¿æ¥
          idle-timeout: 10000       # (3) å›æ”¶ç©ºé—²è¿æ¥
          connection-timeout: 30000 # (4) å¤±è´¥å‰çš„ç­‰å¾…æ—¶é—´
          max-lifetime: 1800000     # (5) å›æ”¶è€åŒ–è¿æ¥
    

**æ³¨é‡Šï¼š**

*   ä¿æŒ `maximum-pool-size` â‰¤ æ•°æ®åº“çš„å®é™…é™åˆ¶ï¼ˆé¿å…è¿æ¥è€—å°½ï¼‰ã€‚
*   `minimum-idle` ç¡®ä¿åœ¨è´Ÿè½½å³°å€¼ä¸‹å¿«é€Ÿå“åº”ã€‚
*   `max-lifetime` < æ•°æ®åº“è¶…æ—¶æ—¶é—´å¯é˜²æ­¢**åƒµå°¸å¥—æ¥å­—**ã€‚

### æ£€æµ‹æ…¢æŸ¥è¯¢

Hibernate å¯ä»¥è®°å½•è¶…è¿‡é˜ˆå€¼çš„æŸ¥è¯¢ï¼Œå¸®åŠ©åŠæ—©å‘ç°æ€§èƒ½é—®é¢˜ã€‚

    spring.jpa.properties.hibernate.session.events.log.LOG_QUERIES_SLOWER_THAN_MS=1000
    

è¿™ä¼šè®°å½•æ‰€æœ‰è¶…è¿‡ 1 ç§’çš„ SQLâ€”â€”éå¸¸é€‚åˆå‘ç° **N+1 æŸ¥è¯¢**ã€**ç¼ºå¤±ç´¢å¼•**æˆ–**é‡åº¦è¿æ¥**ã€‚

> ğŸ’¡ æç¤ºï¼šå°†è¿™äº›æ—¥å¿—ä¸ **Actuator è·Ÿè¸ªæŒ‡æ ‡**ç»“åˆä½¿ç”¨ï¼Œä»¥å…³è” API å»¶è¿Ÿä¸æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ã€‚

### æ‰¹é‡å†™å…¥ä¼˜åŒ–

æ‰¹å¤„ç†å¯ä»¥æ˜¾è‘—å‡å°‘æ•°æ®åº“å¾€è¿”æ¬¡æ•°ã€‚

    spring.jpa.properties.hibernate.jdbc.batch_size=50
    spring.jpa.properties.hibernate.order_inserts=true
    spring.jpa.properties.hibernate.order_updates=true
    

æ“ä½œ | æ— æ‰¹å¤„ç† | æœ‰æ‰¹å¤„ç†ï¼ˆsize=50ï¼‰  
500 æ¬¡æ’å…¥ | 500 æ¬¡ç½‘ç»œè°ƒç”¨ | 10 æ‰¹ Ã— 50 æ¡è®°å½•  
â±ï¸ æ—¶é—´ | ~4s | ~0.4sï¼ˆå¿« 8â€“10 å€ï¼‰

**å¯è§†åŒ–æç¤ºï¼š**  
å°†æ¯æ¬¡æ•°æ®åº“å†™å…¥æƒ³è±¡ä¸ºä¸€æ¬¡"ç½‘ç»œè·³è½¬"ã€‚æ‰¹å¤„ç†ä½¿ä½ çš„åº”ç”¨ä»¥æ›´å°‘çš„è·³è½¬åˆ°è¾¾ç»ˆç‚¹ã€‚

2\. é«˜æ€§èƒ½æ™ºèƒ½ç¼“å­˜ç­–ç•¥
-------------

### ä½¿ç”¨ Caffeine çš„å†…å­˜ç¼“å­˜

æ²¡æœ‰ç¼“å­˜æ—¶ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šå‘½ä¸­æ•°æ®åº“ã€‚æœ‰äº†ç¼“å­˜ï¼Œé‡å¤æŸ¥è¯¢å¯ä»¥åœ¨**å¾®ç§’çº§**è¿”å›ç»“æœã€‚

    <dependency>
      <groupId>com.github.ben-manes.caffeine</groupId>
      <artifactId>caffeine</artifactId>
    </dependency>
    

    @Configuration
    @EnableCaching
    public class CacheConfig {
      @Bean
      public CacheManager cacheManager() {
        return new CaffeineCacheManager("products", "users");
      }
    }
    

    @Service
    public class ProductService {
      @Cacheable("products")
      public Product getProductById(Long id) {
        simulateSlowService(); // 2s DB call
        return repository.findById(id).orElseThrow();
      }
    }
    

**ç»“æœï¼š**

*   é¦–æ¬¡è°ƒç”¨ï¼šå‘½ä¸­æ•°æ®åº“ï¼ˆ2sï¼‰
*   åç»­è°ƒç”¨ï¼š<10msï¼ˆæ¥è‡ªç¼“å­˜ï¼‰

> **ä¸“ä¸šæç¤ºï¼š** ä½¿ç”¨ä»¥ä¸‹é…ç½®è°ƒä¼˜æ·˜æ±°ç­–ç•¥ï¼š

    spring.cache.cache-names=products
    spring.cache.caffeine.spec=maximumSize=1000,expireAfterWrite=5m
    

è¿™ç¡®ä¿è¿‡æœŸæ•°æ®ä¸ä¼šæ»ç•™ï¼ŒåŒæ—¶é¿å… OOMã€‚

### ä½¿ç”¨ Redis çš„åˆ†å¸ƒå¼ç¼“å­˜

æœ¬åœ°ç¼“å­˜åœ¨å¤šä¸ªåº”ç”¨å®ä¾‹ä¹‹é—´ä¸èµ·ä½œç”¨â€”â€”è¿™æ—¶éœ€è¦ **Redis**ã€‚

    spring:
      cache:
        type: redis
      data:
        redis:
          host: localhost
          port: 6379
    

    @Cacheable(value = "userProfiles", key = "#id", sync = true)
    public UserProfile getUserProfile(Long id) {
      return userRepository.findById(id).orElseThrow();
    }
    

> `sync = true` å¯é˜²æ­¢**_ç¼“å­˜é›ªå´©_**ï¼šå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶æœªå‘½ä¸­ï¼Œåªæœ‰ä¸€ä¸ªä¼šé‡æ–°è®¡ç®—ã€‚

**å›¾è¡¨ï¼š**

    Client â†’ Spring Boot â†’ Redis Cache â†’ Database
               â†‘             â†“
            cache hit     cache miss
    

3\. å¼‚æ­¥ä¸å“åº”å¼å¤„ç†
------------

### ä½¿ç”¨ `@Async` å¹¶è¡Œæ‰§è¡Œ

é˜»å¡è°ƒç”¨ä¼šæ‰¼æ€å¹¶å‘æ€§ã€‚Spring çš„ `@Async` æ”¯æŒéé˜»å¡æ‰§è¡Œã€‚

    @Service
    public class ReportService {
    
      @Async
      public CompletableFuture<String> generateReport() {
        simulateHeavyComputation();
        return CompletableFuture.completedFuture("Report Ready");
      }
    }
    
    @Configuration
    @EnableAsync
    public class AsyncConfig {
      @Bean
      public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(30);
        executor.setQueueCapacity(100);
        executor.initialize();
        return executor;
      }
    }
    

ğŸ“ˆ **ç»“æœï¼š**

*   åœ¨é‡è´Ÿè½½ä¸‹å»¶è¿Ÿé™ä½ 30â€“50%
*   çªå‘æµé‡æœŸé—´ CPU ä½¿ç”¨ç‡å¹³è¡¡

> **æœ€ä½³å®è·µï¼š** å§‹ç»ˆä½¿ç”¨ Actuator ä¸­çš„ `ThreadPoolTaskExecutorMetrics` ç›‘æ§çº¿ç¨‹æ± è€—å°½æƒ…å†µã€‚

### ä½¿ç”¨ Spring WebFlux çš„å“åº”å¼ API

**å“åº”å¼ç¼–ç¨‹**åœ¨**\_I/O å¯†é›†å‹\_åº”ç”¨**ä¸­è¡¨ç°å‡ºè‰²ï¼Œå¦‚æµå¼ä¼ è¾“ã€èŠå¤©æˆ–å®æ—¶ä»ªè¡¨æ¿ã€‚

    @RestController
    public class ReactiveController {
      @GetMapping("/users")
      public Flux<User> getAllUsers() {
        return userRepository.findAll();
      }
    }
    

åœ¨è¿™é‡Œï¼Œå•ä¸ªçº¿ç¨‹å¤„ç†æ•°åƒä¸ªå¹¶å‘è¿æ¥â€”â€”**æ²¡æœ‰æ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹çš„å¼€é”€**ã€‚

**å¯è§†åŒ–æµç¨‹ï¼š**

    Request 1 â†’ Reactor Event Loop
    Request 2 â†’ same thread, queued as Flux
    Request 3 â†’ non-blocking async chain
    

4\. HTTP å±‚ä¼˜åŒ–
------------

åœ¨å¤„ç†å¹¶å‘ HTTP è¯·æ±‚æ—¶ï¼Œæ¯ä¸€æ¯«ç§’éƒ½å¾ˆé‡è¦ã€‚

### ä¸ºç”Ÿäº§ç¯å¢ƒè°ƒä¼˜ Tomcat

    server:
      tomcat:
        threads:
          max: 200
          min-spare: 20
        connection-timeout: 5000
        accept-count: 100
    

*   `max`ï¼š2Ã— CPU æ ¸å¿ƒæ•°ï¼ˆé€‚ç”¨äº CPU å¯†é›†å‹åº”ç”¨ï¼‰
*   `accept-count`ï¼šæ–°è¿æ¥çš„é˜Ÿåˆ—å¤§å°
*   `connection-timeout`ï¼šåŠæ—©ä¸¢å¼ƒæ…¢å®¢æˆ·ç«¯

**ä¸ºä»€ä¹ˆé‡è¦ï¼š** çº¿ç¨‹è¿‡å¤šä¼šå¢åŠ ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚çº¿ç¨‹è¿‡å°‘ â†’ è¿æ¥è¢«ä¸¢å¼ƒã€‚

### ä¸ºå¼‚æ­¥å·¥ä½œè´Ÿè½½åˆ‡æ¢åˆ° Undertow

    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-undertow</artifactId>
    </dependency>
    

Undertow çš„äº‹ä»¶é©±åŠ¨ I/O æ¨¡å‹åœ¨ä»¥ä¸‹åœºæ™¯ä¸­æ‰©å±•æ€§æ›´å¥½ï¼š

*   é•¿è½®è¯¢ API
*   æµå¼å“åº”
*   WebFlux åº”ç”¨

**_åŸºå‡†æµ‹è¯•ï¼š_** åœ¨å¼‚æ­¥å¯†é›†å‹åº”ç”¨ä¸­ï¼ŒUndertow çš„å»¶è¿Ÿæ€§èƒ½æ¯” Tomcat é«˜å‡º **20â€“30%**ã€‚

5\. JVM ä¸ GC ä¼˜åŒ–
---------------

### ç”Ÿäº§ç¯å¢ƒçš„ JVM å‚æ•°

    JAVA_OPTS="
      -Xms512m -Xmx2048m \
      -XX:+UseG1GC \
      -XX:MaxGCPauseMillis=200 \
      -XX:+UseStringDeduplication \
      -XX:+HeapDumpOnOutOfMemoryError"
    

**ä¸»è¦ä¼˜åŠ¿ï¼š**

*   `UseG1GC`ï¼šé€‚åˆå¾®æœåŠ¡å»¶è¿Ÿã€‚
*   `MaxGCPauseMillis`ï¼šä¿æŒ GC æš‚åœæ—¶é—´ <200msã€‚
*   `UseStringDeduplication`ï¼šåœ¨ JSON å¯†é›†å‹ API ä¸­èŠ‚çœ 20â€“40% å †å†…å­˜ã€‚
*   `HeapDumpOnOutOfMemoryError`ï¼šæ”¯æŒå´©æºƒåçš„æ ¹æœ¬åŸå› åˆ†æã€‚

**_ä¸“ä¸šæç¤º_**_ï¼š_ å¯¹äºè¶…ä½å»¶è¿Ÿåº”ç”¨ï¼Œæµ‹è¯• **ZGC**ï¼ˆJava 17+ï¼‰æˆ– **Shenandoah GC**â€”â€”æš‚åœæ—¶é—´å¯ä»¥é™è‡³ 10ms ä»¥ä¸‹ã€‚

6\. å¯è§‚æµ‹æ€§ä¸è‡ªåŠ¨æ‰©ç¼©å®¹
--------------

### Spring Boot Actuator + Micrometer

æ— æ³•æµ‹é‡çš„ä¸œè¥¿ï¼Œå°±æ— æ³•ä¼˜åŒ–ã€‚

    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
    

    @Autowired
    MeterRegistry registry;
    
    @PostConstruct
    public void registerCustomMetric() {
      Gauge.builder("custom.activeUsers", this::getActiveUserCount)
           .description("Number of active users")
           .register(registry);
    }
    

ğŸ“ˆ å¯¼å‡ºåˆ° Prometheus å¹¶åœ¨ Grafana ä¸­å¯è§†åŒ–ï¼š

*   æ¯ç§’è¯·æ±‚æ•°ï¼ˆRPSï¼‰
*   æ•°æ®åº“è¿æ¥åˆ©ç”¨ç‡
*   ç¼“å­˜å‘½ä¸­ç‡
*   GC æš‚åœæ—¶é•¿

**å¯è§†åŒ–æç¤ºï¼š** å°†æŒ‡æ ‡ç»„åˆåˆ°"æœåŠ¡å¥åº·ä»ªè¡¨æ¿"ä¸­ï¼Œå…³è”è´Ÿè½½ä¸‹çš„ CPUã€å»¶è¿Ÿå’Œå†…å­˜ã€‚

### ä½¿ç”¨ Kubernetes HPA è‡ªåŠ¨æ‰©ç¼©å®¹

    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: springboot-app
    spec:
      minReplicas: 2
      maxReplicas: 10
      metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              averageUtilization: 70
    

å½“ CPU è¶…è¿‡ 70% æ—¶ï¼Œ**Kubernetes è‡ªåŠ¨æ‰©ç¼©å®¹** Podâ€”â€”æ— éœ€äººå·¥å¹²é¢„ã€‚

> **ä¸“ä¸šæç¤ºï¼š** ä½¿ç”¨è‡ªå®šä¹‰ Prometheus æŒ‡æ ‡ï¼ˆä¾‹å¦‚ï¼Œè¯·æ±‚é€Ÿç‡æˆ–é˜Ÿåˆ—æ·±åº¦ï¼‰å®ç°è¶…è¶Š CPU çš„æ›´æ™ºèƒ½æ‰©ç¼©å®¹ä¿¡å·ã€‚

CI/CD ä¸­çš„æŒç»­è´Ÿè½½æµ‹è¯•
--------------

ä½¿ç”¨ **Gatling** æŒç»­éªŒè¯æ€§èƒ½ã€‚

    <plugin>
      <groupId>io.gatling</groupId>
      <artifactId>gatling-maven-plugin</artifactId>
      <version>3.9.5</version>
    </plugin>
    

åœ¨éƒ¨ç½²åé›†æˆè´Ÿè½½åœºæ™¯ï¼š

    mvn gatling:test
    

ğŸ“Š åœ¨ç”Ÿäº§ç”¨æˆ·æ„Ÿå—åˆ°ä¹‹å‰æ£€æµ‹æ€§èƒ½å›å½’ã€‚

ğŸ§© ç»“è®º
-----

æ‰©å±• Spring Boot ä¸æ˜¯æ·»åŠ æœåŠ¡å™¨çš„é—®é¢˜â€”â€”è€Œæ˜¯**ä¸ºæ•ˆç‡è€Œå·¥ç¨‹åŒ–**ã€‚  
é€šè¿‡è°ƒä¼˜æ¯ä¸€å±‚â€”â€”ä»**è¿æ¥æ± **åˆ° **JVM å‚æ•°**ã€**ç¼“å­˜è®¾è®¡**å’Œ**å¯è§‚æµ‹æ€§ä»ªè¡¨æ¿**â€”â€”ä½ å¯ä»¥å®ç°ï¼š

*   æ›´å¿«çš„å“åº”æ—¶é—´
*   å¯é¢„æµ‹çš„èµ„æºåˆ©ç”¨ç‡
*   è‡ªæ„ˆã€è‡ªåŠ¨æ‰©ç¼©å®¹çš„ç³»ç»Ÿ

> æ›´å¤šSpring BootæŠ€æœ¯æŒ‡å—å¯å…³æ³¨æˆ‘ä»¬çš„[SpringForAllç¤¾åŒº](https://spring4all.com/)