---
layout: post
title: 'æå¤§æé«˜é¡¹ç›®éƒ¨ç½²çš„ç”Ÿäº§åŠ›ï¼åˆ†äº«ä¸€ä¸ªåŠè‡ªåŠ¨åŒ–çš„CICDå®ç°æ–¹æ¡ˆ'
date: "2025-07-12T00:44:45Z"
---
æå¤§æé«˜é¡¹ç›®éƒ¨ç½²çš„ç”Ÿäº§åŠ›ï¼åˆ†äº«ä¸€ä¸ªåŠè‡ªåŠ¨åŒ–çš„CICDå®ç°æ–¹æ¡ˆ
==============================

å‰è¨€
--

å®Œå…¨è‡ªåŠ¨åŒ–çš„ CICD ç¡®å®å¥½ï¼Œä»£ç æäº¤åå°±è‡ªåŠ¨æ„å»ºè‡ªåŠ¨å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œå®ç°ä¸åœæœºæ›´æ–°çš„æƒ…å†µä¸‹ï¼Œè¿˜èƒ½éšæ—¶å›æ»šï¼Œè¿™æè°ä¸å–œæ¬¢å•Š~

ä½†ç†æƒ³å¾ˆä¸°æ»¡ï¼Œç°å®å¾€å¾€å¾ˆéª¨æ„Ÿï¼Œä¸æ˜¯æ‰€æœ‰å¼€å‘/ç”Ÿäº§ç¯å¢ƒéƒ½å…·å¤‡éƒ¨ç½² CICD çš„æ¡ä»¶

å…ˆè¯´ç»“è®ºï¼Œè¿™äº› CICD æœåŠ¡éƒ½æœ‰ä¸€äº›é—®é¢˜ï¼Œè¦ä¹ˆå°±æ˜¯ç½‘ç»œä¸é€šï¼Œè¦ä¹ˆå°±æ˜¯å¤ªé‡å¤ªéº»çƒ¦ä¸å…·å¤‡éƒ¨ç½²æ¡ä»¶ï¼ˆæœåŠ¡å™¨éƒ½åœ¨å†…ç½‘ï¼Œæ— æ³•ç›´è¿ï¼‰

æ‰€ä»¥æˆ‘åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œã€Œåˆ›æ–°ã€äº†ä¸€ç§ CICD çš„å¹³æ›¿æ–¹æ¡ˆï¼Œé€šè¿‡ä¸€ä¸ªè„šæœ¬ï¼Œå®ç°ä¸€é”®å‘å¸ƒï¼

> PS: ç”±äºç¯‡å¹…å…³ç³»ï¼Œæ— æ³•åœ¨æ–‡ç« é‡Œè´´å‡ºå…¨éƒ¨ä»£ç ï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**åŠè‡ªåŠ¨ CICD è„šæœ¬**ã€è·å–

å…³äº CICD
-------

ç°åœ¨å¸¸è§çš„ CICD æœåŠ¡éƒ½å…·å¤‡ä¸€å®šé—¨æ§›ï¼Œå’±ä»¬è®¨è®ºä¸€ä¸‹ï¼š

*   Github Actions: æœ€é€‚åˆå¼€æºé¡¹ç›®ä½¿ç”¨ï¼Œä¸ç”¨éƒ¨ç½²é…ç½®ï¼Œå®Œå…¨å…è´¹ ğŸ‘ ä¸è¿‡åœ¨ç”Ÿäº§ç¯å¢ƒå¾€å¾€å› ä¸ºç½‘ç»œé—®é¢˜ç”¨ä¸äº†
*   GitLab CI/CD: å¾ˆé‡ï¼Œéœ€è¦éƒ¨ç½²å’Œé…ç½® GitLab æœåŠ¡
*   Jenkins: å¾ˆé‡ï¼Œéœ€è¦éƒ¨ç½²å’Œé…ç½® Jenkins æœåŠ¡
*   Azure DevOps å’Œ AWS CodePipeline: è¿™ä¿©ä¾èµ–å®ƒå®¶çš„äº‘æœåŠ¡ï¼Œè€Œä¸”éƒ½æ˜¯å›½å¤–çš„ï¼ŒåŸºæœ¬ä¸ç”¨è€ƒè™‘çš„

åœ¨è¿™äº›å¸¸ç”¨çš„ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–ä¸å…¥æµçš„ï¼Œè¿™é‡Œä¹Ÿä¸€å¹¶çœ‹çœ‹ï¼š

*   å›½å†…çš„ Gitee æµæ°´çº¿: è¿™ä¸ªç±»ä¼¼ Github Actionsï¼Œä¸è¿‡å´æ˜¯æ”¶è´¹çš„ï¼Œæ‰“ä¸ªå·¥è€Œå·²ï¼Œéš¾é“è¿˜å¾—è‡ªè´¹ä¸Šç­ï¼Ÿç›´æ¥ pass
*   CircleCI: äº‘åŸç”Ÿ CI/CD æœåŠ¡ï¼Œæä¾›ä¸ GitHub å’Œ Bitbucket çš„é›†æˆï¼Œå›½å¤–ä½¿ç”¨åº”è¯¥å¾ˆä¸é”™ï¼Œä½†å›½å†…ç½‘ç»œç¯å¢ƒè‚¯å®šæ˜¯ä¸å…è®¸çš„
*   Bitbucket Pipelines: ä¸ Bitbucket ä»“åº“ç´§å¯†é›†æˆï¼Œé€‚åˆä½¿ç”¨ Bitbucket è¿›è¡Œä»£ç æ‰˜ç®¡çš„å›¢é˜Ÿï¼Œä¸ Github ç±»ä¼¼çš„æƒ…å†µï¼Œä¸ç”¨è€ƒè™‘äº†

> PS: æœ‰æ—¶å€™ä¸å¾—ä¸æ„Ÿå¹ï¼Œå›½å†…å›½å¤–ä»¿ä½›ä¸¤ä¸ªä¸–ç•Œâ€¦

é™¤äº†è¿™äº›ä¹‹å¤–ï¼Œæˆ‘è¿˜æ‰¾åˆ°ä¸€ä¸ªè½»é‡çº§çš„å¼€æº CICD é¡¹ç›®: [https://github.com/flowci/flow-core-x](https://github.com/flowci/flow-core-x)

è¿™ä¸ªçœ‹èµ·æ¥ä¸é”™ï¼Œæ„Ÿè§‰å¯ä»¥ç”¨åœ¨ HomeLab æˆ–è€… NAS ä¸Šï¼Œåˆ°æ—¶æ¥å°è¯•ä¸€ä¸‹ã€‚

è§£å†³æ–¹æ¡ˆ
----

æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ç”¨ã€Œè„šæœ¬ + dockerã€å®ç°ä¸€é”®å‘å¸ƒã€ä¸åœæœºæ›´æ–°ã€éšæ—¶å›æ»šç‰ˆæœ¬~

åŸºæœ¬æ€è·¯ï¼Œæˆ‘ç”»äº†ä¸ªç®€å•çš„å›¾ï¼Œæ–¹ä¾¿ç†è§£

graph LR A(\[æœ¬åœ°\])-->B1(æ‰“ TAG) A-->B2(docker build) B2-- æ¨é€é•œåƒ -->C\[(é•œåƒä»“åº“)\] A-- SSHè¿æ¥ -->D{æœåŠ¡å™¨} C-- æ‹‰å–é•œåƒ -->D D-- å¯åŠ¨ -->E(\[çº¿ä¸ŠæœåŠ¡\])

è¿™ä¸ªæ–¹æ¡ˆåªéœ€è¦ç®€å•çš„é…ç½®ï¼Œä¹‹åå°±å¯ä»¥ä¸€é”®å‘å¸ƒäº†ï¼Œæ‰€ä»¥æˆ‘ç§°ä¹‹ä¸ºã€ŒåŠè‡ªåŠ¨ CICDã€

åŸç†æ˜¯æœ¬åœ° git ä»“åº“æ‰“ç‰ˆæœ¬ tagï¼ˆå¦‚: v0.0.1ï¼‰ï¼Œç„¶åè¿è¡Œè„šæœ¬ä¼šè‡ªåŠ¨è¯†åˆ«è¿™ä¸ªç‰ˆæœ¬ tagï¼Œæ„å»ºé•œåƒä¹‹åæ‰“ä¸ŠåŒæ ·çš„ tagï¼Œå†æ¨é€è¿œç¨‹é•œåƒä»“åº“ï¼Œåˆ°äº†æœåŠ¡å™¨ä¸Šå†æ‹‰ä¸‹æ¥å¯åŠ¨ï¼Œå®Œäº‹~ï¼ˆå°±æ˜¯è¿™ä¹ˆç®€å•æœ´ç´ ï¼‰

å¦‚ä½•ä½¿ç”¨
----

ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆçš„å‰ææ˜¯ï¼š

*   ä½¿ç”¨ git ç®¡ç†ä»£ç 
*   ä½¿ç”¨ docker éƒ¨ç½²é¡¹ç›®
*   éœ€è¦æœ‰ä¸€ä¸ªç§æœ‰çš„ docker é•œåƒä»“åº“ï¼Œå¯ä»¥è‡ªå»ºï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘è¿™ç±»ç§æœ‰é•œåƒæœåŠ¡ï¼ˆå…è´¹ï¼‰
*   æœåŠ¡å™¨èƒ½è®¿é—®åˆ° docker é•œåƒä»“åº“ï¼ˆå†…ç½‘çš„è¯å¯ä»¥è‡ªå»ºï¼‰

### ä¿®æ”¹ compose é…ç½®

åœ¨ä½¿ç”¨è„šæœ¬ä¹‹å‰ï¼Œéœ€è¦ä¸€ç‚¹å°å°çš„é…ç½®ï¼Œåé¢å°±å¯ä»¥è§£æ”¾ç”Ÿäº§åŠ›äº†~

è¿˜æ˜¯ä»¥åŸºäº [DjangoStarter æ¡†æ¶](https://github.com/Deali-Axy/DjangoStarter) çš„é¡¹ç›®ä¸ºä¾‹

`compose.yaml` é…ç½®æ–‡ä»¶

    services:
    	# çœç•¥æ— å…³å†…å®¹
      app:
        image: ${APP_IMAGE_NAME}:${APP_IMAGE_TAG}
        container_name: $APP_NAME-app
    

`.env` ç¯å¢ƒå˜é‡

    APP_PORT=9876
    APP_NAME=meta-hub
    APP_IMAGE_NAME=meta-hub
    APP_IMAGE_TAG=v0.0.2
    

åˆ°æ—¶è„šæœ¬è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¿®æ”¹ `.env` é‡Œçš„ç‰ˆæœ¬ `APP_IMAGE_TAG`

### æ‰“ tag

åœ¨æœ¬åœ°å¼€å‘å®Œæˆä¹‹å

ä½¿ç”¨ git tag åŠŸèƒ½ç»™ commit æ‰“ç‰ˆæœ¬ tag

ä¾‹å¦‚ï¼š

    git tag v0.1.1
    

### è¿è¡Œè„šæœ¬

è¿™æ¬¡çš„è„šæœ¬æˆ‘æ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œä¸è¿‡æ²¡æœ‰å…¶ä»–å¤–éƒ¨ä¾èµ–ï¼Œå®Œå…¨ä½¿ç”¨æ ‡å‡†åº“å®ç°ï¼Œè¿˜ç®—æ¯”è¾ƒæ–¹ä¾¿çš„

    python scripts/build_docker.py
    

> PS: åç»­æˆ‘ä¼šè€ƒè™‘ä½¿ç”¨ C# æˆ–è€… Go é‡æ–°å†™è¿™ä¸ªè„šæœ¬ï¼Œæ”¯æŒ AOTï¼Œä½œä¸ºä¸€ä¸ªå·¥å…·æ·»åŠ åˆ°ç³»ç»Ÿ PATHï¼Œä½¿ç”¨èµ·æ¥æ›´æ–¹ä¾¿

è„šæœ¬
--

æ¥ä¸‹æ¥æ”¾ä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„è„šæœ¬

ç”±äºç¯‡å¹…å…³ç³»ï¼Œæ— æ³•åœ¨æ–‡ç« é‡Œè´´å‡ºå…¨éƒ¨ä»£ç ï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥åœ¨å…¬ä¼—å·åå°å›å¤ã€Œ**åŠè‡ªåŠ¨ CICD è„šæœ¬**ã€è·å–

è¿™ä¸ªè„šæœ¬ï¼Œæ€»å…±ä¸€ç™¾å¤šè¡Œï¼Œéº»é›€è™½å°äº”è„ä¿±å…¨ï¼Œå®ç°äº†å®Œæ•´çš„åŠŸèƒ½ã€‚

ä¸€å¼€å§‹æˆ‘æ˜¯ç”¨çš„ `paramiko.SSHClient` æ¥å»ºç«‹ SSH è¿æ¥çš„ï¼Œä¸è¿‡åé¢è§‰å¾—è¿˜æ˜¯ä¸è¦å¼•å…¥é¢å¤–çš„å¤æ‚åº¦æ¯”è¾ƒå¥½ï¼Œæœ€ç»ˆç®€åŒ–æˆè¿™æ ·ï¼Œç›´æ¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ SSH å‘½ä»¤ã€‚

    #!/usr/bin/env python3
    # -*- coding: utf-8 -*-
    """
    Dockeré•œåƒæ„å»ºã€æ¨é€å’Œè¿œç¨‹éƒ¨ç½²è„šæœ¬
    
    åŠŸèƒ½ï¼š
    1. è·å–æœ€æ–°git tagä½œä¸ºç‰ˆæœ¬å·
    2. æ„å»ºDockeré•œåƒå¹¶æ¨é€åˆ°é…ç½®çš„é•œåƒä»“åº“
    3. SSHè¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨è¿›è¡Œè‡ªåŠ¨éƒ¨ç½²
    
    é…ç½®é¡¹(ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼)ï¼š
    - REGISTRY_URL: é•œåƒä»“åº“åœ°å€ï¼Œå¦‚: registry.example.com
    - REGISTRY_NAMESPACE: é•œåƒä»“åº“å‘½åç©ºé—´
    - IMAGE_NAME: é•œåƒåç§°
    - REMOTE_HOST: è¿œç¨‹æœåŠ¡å™¨é…ç½®ï¼Œå¦‚: user@server-ip -p 2022
    - REMOTE_PROJECT_PATH: è¿œç¨‹é¡¹ç›®è·¯å¾„
    """
    
    import os
    import sys
    import subprocess
    import threading
    from typing import Optional, Tuple
    
    # é»˜è®¤é…ç½®
    DEFAULTS = {
        'REGISTRY_URL': 'registry.example.com',
        'REGISTRY_NAMESPACE': 'namespace',
        'IMAGE_NAME': 'image-name',
        'REMOTE_HOST': 'host-name',  # è¿œç¨‹æœåŠ¡å™¨åœ°å€æˆ–~/.ssh/configä¸­çš„Hoståˆ«å
        'REMOTE_PROJECT_PATH': '/path/to/project',
    }
    
    
    def get_config(key: str) -> str:
        """è·å–é…ç½®å€¼ï¼Œä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼"""
        return os.environ.get(key, DEFAULTS.get(key, ''))
    
    
    def _reader_thread(pipe, lines_list, stream_to_print_to):
        """åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¯»å–ç®¡é“è¾“å‡º"""
        try:
            for line in iter(pipe.readline, ''):
                lines_list.append(line)
                if stream_to_print_to:
                    # å®æ—¶æ‰“å°
                    stream_to_print_to.write(line)
                    stream_to_print_to.flush()
        finally:
            pipe.close()
    
    def run_cmd(cmd: str, show_output: bool = True) -> Tuple[int, str, str]:
        """
        æ‰§è¡Œå‘½ä»¤å¹¶å®æ—¶æ˜¾ç¤ºè¾“å‡ºï¼ŒåŒæ—¶æ•è·è¾“å‡ºå†…å®¹ã€‚
        è¿”å›çŠ¶æ€ç ã€stdoutå’Œstderrã€‚
        """
        if show_output:
            print(f"æ‰§è¡Œ: {cmd}")
    
        process = subprocess.Popen(
            cmd,
            shell=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True,
            bufsize=1,
            universal_newlines=True
        )
    
        stdout_lines = []
        stderr_lines = []
    
        stdout_thread = threading.Thread(
            target=_reader_thread,
            args=(process.stdout, stdout_lines, sys.stdout if show_output else None)
        )
        stderr_thread = threading.Thread(
            target=_reader_thread,
            args=(process.stderr, stderr_lines, sys.stderr if show_output else None)
        )
    
        stdout_thread.start()
        stderr_thread.start()
    
        stdout_thread.join()
        stderr_thread.join()
    
        returncode = process.wait()
    
        stdout = ''.join(stdout_lines)
        stderr = ''.join(stderr_lines)
    
        if returncode != 0:
            print(f"\né”™è¯¯: å‘½ä»¤æ‰§è¡Œå¤±è´¥ (è¿”å›ç : {returncode})")
            # é”™è¯¯è¾“å‡ºå·²ç»è¢«å®æ—¶æ‰“å°ï¼Œè¿™é‡Œä¸å†é‡å¤æ‰“å°
            sys.exit(1)
    
        return returncode, stdout, stderr
    
    
    def get_latest_tag() -> str:
        """è·å–æœ€æ–°git tag"""
        _, tag, _ = run_cmd("git describe --tags --abbrev=0")
        tag = tag.strip()
        if not tag:
            print("é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°git tag")
            sys.exit(1)
        print(f"æœ€æ–°tag: {tag}")
        return tag
    
    
    def deploy_to_remote(version: str) -> None:
        """éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨"""
        host = get_config('REMOTE_HOST')
        remote_path = get_config('REMOTE_PROJECT_PATH')
    
        print(f"\nğŸ”— é€šè¿‡SSHè¿æ¥åˆ° {host} è¿›è¡Œéƒ¨ç½²...")
    
        # 1. æ›´æ–°è¿œç¨‹ .env æ–‡ä»¶
        print(f"\nğŸ”„ æ›´æ–°è¿œç¨‹.envæ–‡ä»¶...")
        update_cmd = f'ssh {host} "sed -i \'s/^TAG=.*/TAG={version}/\' {remote_path}/.env"'
        run_cmd(update_cmd)
    
        # 2. é‡å¯è¿œç¨‹å®¹å™¨
        print(f"\nğŸ”„ é‡å¯è¿œç¨‹å®¹å™¨...")
        restart_cmd = f'ssh {host} "cd {remote_path} && docker compose up -d"'
        run_cmd(restart_cmd)
    
        print("\nâœ… è¿œç¨‹éƒ¨ç½²å®Œæˆï¼")
    
    
    def main():
        print("ğŸš€ å¼€å§‹Dockeré•œåƒæ„å»ºã€æ¨é€å’Œéƒ¨ç½²æµç¨‹\n")
    
        # 1. è·å–æœ€æ–°tag
        version = get_latest_tag()
    
        # 2. æ„å»ºé•œåƒ
        print("\nğŸ“¦ æ„å»ºDockeré•œåƒ...")
        run_cmd("docker compose build app")
    
        # 3. æ‰“tag
        registry = get_config('REGISTRY_URL')
        namespace = get_config('REGISTRY_NAMESPACE')
        image_name = get_config('IMAGE_NAME')
        registry_image = f"{registry}/{namespace}/{image_name}:{version}"
    
        print(f"\nğŸ·ï¸ ç»™é•œåƒæ‰“tag...")
        run_cmd(f"docker tag {image_name} {registry_image}")
    
        # 4. æ¨é€é•œåƒ
        print(f"\nğŸ“¤ æ¨é€é•œåƒåˆ°ä»“åº“...")
        run_cmd(f"docker push {registry_image}")
        print(f"é•œåƒå·²æ¨é€: {registry_image}")
    
        # 5. è¿œç¨‹éƒ¨ç½²
        deploy_to_remote(version)
    
        print("\nğŸ‰ æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼")
    
    
    if __name__ == "__main__":
        main()
    

å°ç»“
--

çœŸçš„æ˜¯è§£æ”¾ç”Ÿäº§åŠ›å•Šï¼Œè¿™ä¸ªæ–¹æ¡ˆæå¤§é™ä½äº†éƒ¨ç½²çš„å·¥ä½œé‡

è¿™ä¸ªæ–¹æ³•å€¼å¾—æ¨å¹¿ï¼Œæˆ‘å†³å®šæŠŠè¿™ä¸ªè„šæœ¬å†…ç½®åœ¨ã€Œ[DjangoStarter æ¡†æ¶](https://github.com/Deali-Axy/DjangoStarter)ã€ä¸­~

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚