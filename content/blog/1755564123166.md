---
layout: post
title: 'è§£å¯†promptç³»åˆ—59. MCPå®žæˆ˜ï¼šä»ŽLow-Levelåˆ°FastMCPçš„æ­å»ºæ¼”è¿›'
date: "2025-08-19T00:42:03Z"
---
è§£å¯†promptç³»åˆ—59. MCPå®žæˆ˜ï¼šä»ŽLow-Levelåˆ°FastMCPçš„æ­å»ºæ¼”è¿›
===========================================

![è§£å¯†promptç³»åˆ—59. MCPå®žæˆ˜ï¼šä»ŽLow-Levelåˆ°FastMCPçš„æ­å»ºæ¼”è¿›](https://img2024.cnblogs.com/blog/1326688/202508/1326688-20250818125532835-1569600247.png) ðŸš€ æ ¸å¿ƒæŒ‘æˆ˜ï¼šå¦‚ä½•ä¸ºå¤æ‚æ•°æ®åˆ†æžä»»åŠ¡æž„å»ºå¯æ‰©å±•çš„ä»£ç æ²™ç®±å·¥å…·ï¼Ÿæœ¬æ–‡å°†ä»¥E2Bæ²™ç®±ä¸ºä¾‹ï¼Œé€šè¿‡å¯¹æ¯”Low-Levelä¸ŽFastMCPä¸¤ç§MCP-Serverå®žçŽ°æ–¹æ¡ˆï¼Œæ·±å…¥å‰–æžï¼š - Resource/Tool/Promptçš„é«˜é˜¶åº”ç”¨åœºæ™¯ - æ•°æ®åˆ†æžcodingä»»åŠ¡çš„éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ - FastMCPåœ¨åŽŸæœ‰mcp-serverçš„åŸºç¡€ä¸Šåšäº†å“ªäº›å¼€å‘ç®€åŒ–

ðŸš€ æ ¸å¿ƒæŒ‘æˆ˜ï¼šå¦‚ä½•ä¸ºå¤æ‚æ•°æ®åˆ†æžä»»åŠ¡æž„å»ºå¯æ‰©å±•çš„ä»£ç æ²™ç®±å·¥å…·ï¼Ÿæœ¬æ–‡å°†ä»¥E2Bæ²™ç®±ä¸ºä¾‹ï¼Œé€šè¿‡å¯¹æ¯”Low-Levelä¸ŽFastMCPä¸¤ç§MCP-Serverå®žçŽ°æ–¹æ¡ˆï¼Œæ·±å…¥å‰–æžï¼š

*   Resource/Tool/Promptçš„é«˜é˜¶åº”ç”¨åœºæ™¯
*   æ•°æ®åˆ†æžcodingä»»åŠ¡çš„éš¾ç‚¹å’Œè§£å†³æ–¹æ¡ˆ
*   FastMCPåœ¨åŽŸæœ‰mcp-serverçš„åŸºç¡€ä¸Šåšäº†å“ªäº›å¼€å‘ç®€åŒ–

Cluadeçš„ç»å…¸Demoå¤šæ˜¯ç”¨low levelæž„å»ºï¼Œè€Œåœ¨æœ€æ–°ç‰ˆæœ¬ä¸­æŽ¨å‡ºäº†é«˜çº§FastMCPï¼Œä½†æ˜¯å·¥ç¨‹ä¸Šçš„ç®€åŒ–ï¼Œæ„å‘³ç€å¾ˆå¤šåŠŸèƒ½è¢«éšè—ï¼Œæ‰€ä»¥æ›´é€‚åˆä»Žlow levelä¸€æ­¥æ­¥èµ°è¿‡æ¥å¯¹MCPè®¾è®¡æ¯ä¸€æ­¥éƒ½å¾ˆæ¸…æ™°å¾—é«˜çº§ä½¿ç”¨ç”¨æˆ·ï¼Œè€Œéžæ–°æ‰‹å°ç™½ã€‚

è¿™é‡Œæˆ‘é€‰äº†åŸºäºŽE2Bçš„codingæ²™ç®±æ¥æ­å»ºMCP serverï¼Œåˆšå¥½ä¸ºä¸‹ä¸€ç« æˆ‘ä»¬æ‰‹æ“æ•°æ®åˆ†æžæ™ºèƒ½ä½“åšä¸ªé“ºåž«ï¼Œå®Œæ•´ä»£ç è¯¦è§: [DAAgent](https://github.com/DSXiangLi/DAAgent)

Coding MCP
----------

ðŸ”¥ çœŸå®žåœºæ™¯çš„å¤æ‚æ€§ï¼šç”Ÿäº§çº§æ•°æ®åˆ†æžæ™ºèƒ½ä½“ä¸­çš„Codingå·¥å…·è¿œéžPython REPLå¯èƒœä»»ï¼Œæ ¸å¿ƒç—›ç‚¹åœ¨äºŽä¸‰ç±»æ•°æ®æµçš„ä¿¡æ¯ä¼ é€’ï¼š

æ•°æ®æµç±»åž‹

æŒ‘æˆ˜åœºæ™¯

æœ¬æ–¹æ¡ˆè§£å†³æ€è·¯

code2code

å¤šæ®µä»£ç å—å˜é‡ä¼ é€’

æŒä¹…åŒ–å­˜å‚¨(CSV/JSON)

code2llm

æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆstdout/errorï¼‰

ç»“æž„åŒ–æ—¥å¿—æ•èŽ·

code2human

ç»“æžœå¯è§†åŒ–

Jupyter Notebookç»„è£…

é‚£åŸºäºŽä»¥ä¸Š3ç‚¹è€ƒé‡ï¼Œæˆ‘ä»¬è¦è®¾è®¡çš„coding MCP serverå°±éœ€è¦å…·å¤‡ä»¥ä¸‹åŠŸèƒ½

*   **sandbox initialize & stop**ï¼šæ²™ç®±åˆ›å»ºå’Œé”€æ¯
*   **upload file**ï¼šæ•°æ®åˆ†æžåœºæ™¯å¾€å¾€ä¾èµ–å‰ç½®è¾“å‡ºçš„csvæ•°æ®æ–‡ä»¶
*   **execude code**ï¼šæœ€åŽæ‰æ˜¯codingå·¥å…·é»˜è®¤æ‹¥æœ‰çš„ä»£ç æ‰§è¡Œå·¥å…·

ðŸ” å’Œå…¶ä»–çš„ä¸€äº›sandbox mcpç›¸æ¯”åœ¨å·¥å…·è®¾è®¡ä¸Šæœ‰å‡ ç‚¹ä¸åŒ

å¸¸è§åŠŸèƒ½

æœ¬æ–¹æ¡ˆå®žçŽ°æ–¹å¼

é€‰æ‹©ä¾æ®

åº“å®‰è£…âŒ

åˆ©ç”¨kernleå†…æ ¸å†…åµŒ!pip

Codingä¸€è‡´æ€§æ›´å¥½ï¼Œå¾ˆå¤šlibraryæ˜¯åœ¨codeè¿è¡Œè¿‡ç¨‹ä¸­å‘çŽ°çš„ï¼Œè€Œéžåœ¨codingä¹‹å‰åˆ¶å®š

æ–‡ä»¶ä¸‹è½½âŒ

æ•æ‰æ‰€æœ‰å¤šæ¨¡æ€çš„æ‰§è¡Œç»“æžœç›´æŽ¥è¿”å›ž

å¯¹è¾“å‡ºæ–‡ä»¶çš„ç›®å½•ç®¡ç†ä¼šæ›´åŠ çµæ´»

å•æ­¥ä»£ç æ‰§è¡ŒâŒ

æ˜¾å¼create/destroyæ²™ç®±æ”¯æŒå¤šæ­¥coding

å¤æ‚ä»»åŠ¡é€šè¿‡å¤šæ­¥codingä¼ é€’ä¸­é—´å˜é‡å’ŒæŒä¹…åŒ–æ–‡ä»¶ï¼ŒåŒæ—¶é¿å…å¤šæ¬¡pipçš„æ—¶é—´æµªè´¹

### Low-Level Server

ä¸‹é¢æˆ‘ä»¬å…ˆç”¨Low-level Serveræ¡†æž¶æ¥è®¾è®¡Coding MCPã€‚æŒ‰å‰é¢çš„è®¾è®¡ï¼Œæˆ‘ä»¬åˆ†åˆ«éœ€è¦initialize sandboxï¼Œstop sandboxï¼Œupload fileï¼Œexecute codeè¿™å››ä¸ªå·¥å…·ã€‚

é™¤äº†æ‰§è¡Œä»£ç ä¹‹å¤–çš„å‰ä¸‰ä¸ªå·¥å…·ï¼Œå®ƒä»¬éƒ½å¯ä»¥ä½¿ç”¨æ–‡æœ¬è¾“å‡ºæ ¼å¼ï¼Œä»–ä»¬ä¼ é€’ç»™æ¨¡åž‹çš„ä¿¡æ¯ç›¸å¯¹ç®€å•å°±æ˜¯æ˜¯å¦æˆåŠŸåˆ›å»ºã€é”€æ¯æ²™ç®±ã€ä»¥åŠæ˜¯å¦æˆåŠŸä¸Šä¼ æ–‡ä»¶ï¼Œä»¥åŠå¯¹åº”çš„æ²™ç®±IDæ ‡è¯†å’Œæ–‡ä»¶ä¸Šä¼ ç›®å½•ã€‚æ‰€ä»¥è¿™ä¸‰ä¸ªå·¥å…·æˆ‘é€‰æ‹©äº†æ–‡æœ¬æ ¼å¼çš„è¾“å‡ºã€‚ä»£ç æ‰§è¡Œå·¥å…·è¿™é‡Œï¼Œæˆ‘é€‰æ‹©äº†ç»“æž„åŒ–è¾“å‡ºï¼Œè¿™æ ·å¯ä»¥æ›´æœ‰æ•ˆçš„æ‹†åˆ†ä»£ç æ‰§è¡ŒåŽçš„å„ç§ä¸åŒæ—¥å¿—ç±»åž‹ï¼Œæ–¹é¢åŽé¢çš„codingæ­¥éª¤å®šä½ä¿®å¤é—®é¢˜ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æž„å»ºMCP å·¥å…·æ—¶ä¸ä»…è¦å…¨é¢å®Œæ•´è¾“å‡ºæˆåŠŸæ—¥å¿—ï¼Œå¯¹äºŽæŠ¥é”™ä¹Ÿè¦æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œå¿…è¦æ—¶éœ€è¦è¿”å›žtracebackï¼Œå¦åˆ™æ¨¡åž‹æ— æ³•èŽ·å–å®Œæ•´ä¸Šä¸‹æ–‡å¾ˆéš¾ä¿®æ­£å·¥å…·è°ƒç”¨æ–¹å¼ã€‚**

ä»¥ä¸‹æ˜¯code åŠŸèƒ½å±‚æ ¸å¿ƒä»£ç å®žçŽ°

    
    # å·¥å…·å‡½æ•°å®šä¹‰
    async def initialize_sandbox(timeout: int = Field(description='æ²™ç®±æœ€å¤§è¿è¡Œæ—¶é•¿ï¼Œå•ä½ä¸ºç§’', default=1000)) -> str:
        """åˆ›å»ºä¸€ä¸ªæ–°çš„æ²™ç®±çŽ¯å¢ƒç”¨äºŽä»£ç æ‰§è¡Œ
        """
        global Active_Sandboxes
        session_id = str(uuid.uuid4())
        logger.info(f'åˆ›å»ºæ²™ç®±ä¸­ï¼šsession_id = {session_id}')
        try:
            sandbox = Sandbox(api_key=os.getenv("E2B_API_KEY"), timeout=timeout)
            Active_Sandboxes[session_id] = sandbox
        except Exception as e:
            msg = f'Failed to initialize sandbox: {str(e)}'
            logger.warning(e)
            return msg
        msg = f"Sandbox initialized successfully with session ID: {session_id}"
        logger.info(msg)
        return msg
    
    
    async def close_sandbox(session_id: str = Field(description='éœ€è¦å…³é—­çš„æ²™ç®±id')) -> str:
        """æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ä¹‹åŽï¼Œå…³é—­å·²æœ‰çš„æ²™ç®±çŽ¯å¢ƒ
        :param session_id: æ²™ç®±å”¯ä¸€æ ‡è¯†ç¬¦
        :return: æ‰§è¡Œæ—¥å¿—
        """
        global Active_Sandboxes
        if session_id in Active_Sandboxes:
            sandbox = Active_Sandboxes[session_id]
            try:
                sandbox.kill()
            except Exception as e:
                msg = f'Failed to close sandbox with session ID: {session_id}, {str(e)}'
                logger.warning(e)
                return msg
            msg = f"Sandbox close successfully with session ID: {session_id}"
            logger.info(msg)
            return msg
        else:
            msg = f"Sandbox failed to stop session ID: {session_id} not found."
            logger.warning(msg)
            return msg
    
    
    class CodeOutput(BaseModel):
        stdout: str
        stderr: str
        error: str
        traceback: str
    
    
    async def execute_code(session_id: str = Field(description='éœ€è¦è¿è¡Œä»£ç çš„ç›®æ ‡æ²™ç®±id'),
                           code: str = Field(description='å¾…è¿è¡Œçš„ä»£ç ')) -> CodeOutput:
        """åœ¨æ²™ç®±ä¸­è¿è¡Œä»£ç å¹¶èŽ·å–ä»£ç çš„æ‰€æœ‰è¿”å›žç»“æžœï¼ŒåŒ…æ‹¬stdoutã€stderrã€å„ç±»æŒä¹…åŒ–è¾“å‡ºã€å›¾ç‰‡ç­‰ç­‰
        :param session_id: æ²™ç®±å”¯ä¸€æ ‡è¯†ç¬¦
        :param code: å¾…æ‰§è¡Œçš„ä»£ç 
        :return: ä»£ç æ‰§è¡Œè¿”å›žç»“æž„çš„ç»“æž„ä½“
        """
        global Active_Sandboxes, Execution_DB
        if session_id not in Active_Sandboxes:
            msg = f'Sandbox with session ID : {session_id} not found'
            data = {'error': msg}
        else:
            try:
                sandbox = Active_Sandboxes[session_id]
                # sandboxä¼šåœ¨serverå†…æä¾›æµå¼çš„å†…å®¹è¾“å‡º
                execution = sandbox.run_code(
                    code,
                    on_stdout=lambda data: logger.info(data),
                    on_stderr=lambda data: logger.info(data),
                    on_error=lambda data: logger.info(data)
                )
    
                data = CodeOutput(
                    stdout=''.join(execution.logs.stdout),
                    stderr=''.join(execution.logs.stderr),
                    error=str(execution.error) if execution.error else '',
                    traceback=execution.error.traceback if execution.error else '',
                )
                # Store execution record in database
                execution_record = {
                    'timestamp': datetime.now().isoformat(),
                    'code': code,
                    'output': execution  # å­˜å‚¨æ²™ç®±åŽŸå§‹ç»“æžœå³å¯
                }
                Execution_DB[session_id]['executions'].append(execution_record)
                logger.info(f"Stored execution record for session {session_id}")
            except Exception as e:
                error_msg = f"Code execution failed: {str(e)}"
                traceback_str = traceback.format_exc()
                logger.warning(f"Execution error: {error_msg}\n{traceback_str}")
                data = CodeOutput(
                    error=error_msg,
                    traceback=traceback_str,
                    stdout='',
                    stderr=''
                )
                execution_record = {
                    'timestamp': datetime.now().isoformat(),
                    'code': code,
                    'output': None
                }
                Execution_DB[session_id]['executions'].append(execution_record)
                logger.info(f"Stored error execution record for session {session_id}")
    
        return data
    
    
    async def upload_file(session_id: str = Field(description='å¾…ä¸Šä¼ æ–‡ä»¶çš„ç›®æ ‡æ²™ç®±id'),
                          file_list: List = Field(description='ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªéƒ½æ˜¯æœ¬åœ°æ–‡ä»¶çš„ç»å¯¹è·¯å¾„')
                          ) -> str:
        """ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ²™ç®±ä¸­
        :param session_id: æ²™ç®±å”¯ä¸€æ ‡è¯†ID
        :param file_list: å¾…ä¸Šä¼ çš„æœ¬åœ°æ–‡ä»¶åˆ—è¡¨ï¼Œæ–‡ä»¶åç§°åŒ…å«æœ¬åœ°æ–‡ä»¶è·¯å¾„
        :return: æ‰§è¡Œæ—¥å¿—
        """
        global Active_Sandboxes
        if session_id not in Active_Sandboxes:
            msg = f'Sandbox with session ID : {session_id} not found'
            logger.warning(msg)
            return msg
        else:
            sandbox = Active_Sandboxes[session_id]
        return_msg = ''
        for file in file_list:
            try:
                with open(file, 'rb') as f:
                    sandbox.files.write(file, f.read())
                msg = f'Uploading {file} success'
                logger.info(msg)
            except Exception as e:
                msg = f'Uploading {file} failed:' + str(e)
                logger.warning(msg)
            return_msg += msg + '\n'
        return return_msg
    

ä¸‹é¢æ˜¯low level Serveræ ¸å¿ƒlist\_toolå’Œcall\_toolçš„å®žçŽ°ï¼Œéœ€è¦ç”¨æˆ·æ˜¾å¼å®šä¹‰æ¯ä¸€ä¸ªå·¥å…·çš„schemaå’Œå…·ä½“çš„è°ƒç”¨æ–¹æ³•, ä»¥ä¸‹æˆ‘å·²ç»å‚è€ƒåŽé¢çš„FastMCPçš„é«˜çº§å°è£…åœ¨å®šä¹‰æ—¶åšäº†ä¸€äº›ç®€åŒ–ã€‚æ¯ä¸ªå·¥å…·çš„åç§°å’Œæè¿°ï¼Œç›´æŽ¥æ¥è‡ªå‡½æ•°åç§°å’Œæ³¨é‡Šï¼Œä¸ç”¨å†æ‰‹å·¥å¡«å†™ã€‚

    @server.list_tools()
    async def list_tools() -> list[Tool]:
        tools = [
            Tool(name=initialize_sandbox.__name__,
                 description=initialize_sandbox.__doc__,
                 inputSchema={
                     "type": "object",
                     "properties": {
                         "timeout": {
                             "type": "integer",
                             "description": "æ²™ç®±æœ€å¤§è¿è¡Œæ—¶é•¿ï¼Œå•ä½ä¸ºç§’"
                         }
                     },
                     "required": ["timeout"],
                 }),
            Tool(name=close_sandbox.__name__,
                 description=close_sandbox.__doc__,
                 inputSchema={
                     "type": "object",
                     "properties": {
                         "session_id": {
                             "type": "string",
                             "description": "éœ€è¦å…³é—­çš„æ²™ç®±id"
                         }
                     },
                     "required": ["session_id"],
                 }),
            Tool(name=execute_code.__name__,
                 description=execute_code.__doc__,
                 inputSchema={
                     "type": "object",
                     "properties": {
                         "session_id": {
                             "type": "string",
                             "description": "å¾…è¿è¡Œä»£ç çš„æ²™ç®±id"
                         },
                         "code": {
                             "type": "string",
                             "description": 'å¾…è¿è¡Œçš„ä»£ç '
                         }
                     },
                     "required": ["session_id", "code"],
                 },
                 outputSchema=CodeOutput.model_json_schema()),
            Tool(name=upload_file.__name__,
                 description=upload_file.__doc__,
                 inputSchema={
                     "type": "object",
                     "properties": {
                         "session_id": {
                             "type": "string",
                             "description": "å¾…ä¸Šä¼ æ–‡ä»¶çš„ç›®æ ‡æ²™ç®±id"
                         },
                         "file_list": {
                             "type": "array",
                             "description": "ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªéƒ½æ˜¯æœ¬åœ°æ–‡ä»¶çš„ç»å¯¹è·¯å¾„"
                         }
                     },
                     "required": ["session_id", "file_list"]
                 })
    
        ]
    
        return tools
    
    
    @server.call_tool()
    async def call_tool(name: str, arguments: dict[str, Any]):
        """
        call toolè¿”å›žç»“æž„å¹¶ä¸å±€é™åœ¨Textï¼Œ Audio å’Œ Imageç±»åž‹, å¦‚æžœä½ å®šä¹‰å¤æ‚ç»“æž„ä½“ï¼Œè¿”å›žAnyç±»åž‹å³å¯
        """
        try:
            match name:
                case initialize_sandbox.__name__:
                    result = await initialize_sandbox(arguments['timeout'])
                    result = [TextContent(type="text", text=result)]
    
                case close_sandbox.__name__:
                    result = await close_sandbox(arguments['session_id'])
                    result = [TextContent(type="text", text=result)]
    
                case upload_file.__name__:
                    result = await upload_file(arguments['session_id'], arguments['file_list'])
                    result = [TextContent(type="text", text=result)]
    
                case execute_code.__name__:
                    result = await execute_code(arguments['session_id'], arguments['code'])
                    result = result.dict()
                case _:
                    raise ValueError('Error calling tool: input name do not match any tool name')
            return result
        except Exception as e:
            raise ValueError(f'Error calling tool: {str(e)}')
    
    
    async def main():
        options = server.create_initialization_options()
        async with stdio_server() as (read_stream, write_stream):
            await server.run(read_stream, write_stream, options)
            
    if __name__ == '__main__':
        import asyncio
        asyncio.run(main())
    

å”¯ä¸€åœ¨å¼€å‘æ—¶è®©æˆ‘æœ‰äº›å›°æƒ‘çš„åœ¨äºŽcall\_toolçš„è¿”å›žç±»åž‹ï¼Œå› ä¸ºéœ€è¦å…¼å®¹ç»“æž„åŒ–è¾“å‡ºå’Œçº¯æ–‡æœ¬è¾“å‡ºè¿™ä¸¤ç§ç±»åž‹ï¼Œç»†çœ‹serverçš„Type Hintä¼šå‘çŽ°call\_toolçš„è¾“å‡ºç±»åž‹æ˜¯`Sequence[ContentBlock] | dict[str, Any]`, ä¹Ÿå°±æ˜¯ç»“æž„åŒ–å’Œéžç»“æž„åŒ–ï¼ˆçº¯æ–‡æœ¬ï¼‰çš„è¾“å‡ºç±»åž‹åˆ†åˆ«æ˜¯Listå’ŒDictä¸¤ç§ç±»åž‹ï¼Œä¼šè¢«è§£æžåˆ°ä¸¤ä¸ªä¸åŒçš„å­—æ®µ`content`å’Œ`structuredContent`ã€‚

æœ¬è´¨ä¸Šæ˜¯å¦ä»¥æ–‡æœ¬æ ¼å¼è¿”å›žçš„**äº‰è®®ç‚¹åœ¨äºŽå·¥å…·è¿”å›žå†…å®¹çš„ä½¿ç”¨æ–¹æ˜¯å·¥å…·ï¼Ÿæ¨¡åž‹ï¼Ÿäººç±»ï¼Ÿ**ï¼Œçº¯æ–‡æœ¬é»˜è®¤äº†å·¥å…·çš„ä½¿ç”¨æ–¹æ˜¯æ¨¡åž‹ï¼Œä½†å…¶å®žå¾ˆå¤šåœºæ™¯ä¸‹å¹¶ä¸æ˜¯ï¼Œä¾‹å¦‚å¤šæ­¥å·¥å…·è°ƒç”¨ä¼ é€’å‚æ•°ã€å·¥å…·ä½œä¸ºç¨‹åºæŽ§åˆ¶å™¨ã€ç¼–ç¨‹åœºæ™¯ã€æ•°æ®åˆ†æžåœºæ™¯ç­‰ç­‰ã€‚äºŽæ˜¯å®˜æ–¹ä»£ç åŽé¢æ‰æŠŠStructuredContentåŠ ä¸Šï¼Œgitä¸Šæœ‰ä¸å°‘è®¨è®ºï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åŽ»çž…çž…[Bring back the concept of "toolResult" (non-chat result)](https://github.com/modelcontextprotocol/modelcontextprotocol/issues/97)

### High-Level FastMCP

æœ‰äº†Low-Level APIçš„åŸºç¡€FastMCPå°±å¥½ç†è§£å¤šäº†ã€‚ä»¥ä¸‹æ˜¯æ•ˆæžœç›¸åŒï¼ŒåŸºäºŽFastMCPè¿™ä¸ªHigh Level APIçš„MCPå·¥å…·å®žçŽ°ï¼ŒcodeåŠŸèƒ½éƒ¨åˆ†å’Œä»¥ä¸Šç›¸åŒå°±ä¸é‡å¤äº†ã€‚

    
    from mcp.server.fastmcp import FastMCP
    
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    logger = logging.getLogger("e2b-sandbox")
    
    # æœåŠ¡åˆå§‹åŒ–
    mcp = FastMCP("code-sandbox")
    Active_Sandboxes = {}
    load_dotenv()  # è¯»å–envæ–‡ä»¶ä¸­çš„E2B API Key
    
    
    @mcp.tool()
    async def initialize_sandbox(timeout: int = Field(description='æ²™ç®±æœ€å¤§è¿è¡Œå¸‚åœºï¼Œå•ä½ä¸ºç§’', default=1000)) -> str:
        """åˆ›å»ºä¸€ä¸ªæ–°çš„æ²™ç®±çŽ¯å¢ƒç”¨äºŽä»£ç æ‰§è¡Œ
        :return: str: è¿”å›žåˆå§‹åŒ–æ—¥å¿—åŒ…å«å¯åŠ¨æ²™ç®±id
        """
        ...
        return msg
    
    
    @mcp.tool()
    async def close_sandbox(session_id: str = Field(description='éœ€è¦å…³é—­çš„æ²™ç®±id')) -> str:
        """æ‰€æœ‰ä»£ç è¿è¡Œå®Œæ¯•ä¹‹åŽï¼Œå…³é—­å·²æœ‰çš„æ²™ç®±çŽ¯å¢ƒ
        :return: æ‰§è¡Œæ—¥å¿—
        """
        ...
        return msg
    
    
    class CodeOutput(TypedDict):
        results: List
        stdout: str
        stderr: str
        error: str
        traceback: str
    
    
    @mcp.tool()
    async def execute_code(session_id: str = Field(description='éœ€è¦è¿è¡Œä»£ç çš„æ²™ç®±id'),
                           code: str = Field(description='å¾…è¿è¡Œçš„ä»£ç ')) -> CodeOutput:
        """åœ¨æ²™ç®±ä¸­è¿è¡Œä»£ç å¹¶èŽ·å–ä»£ç çš„æ‰€æœ‰è¿”å›žç»“æžœ
        :return: ä»£ç æ‰§è¡Œè¿”å›žç»“æž„ä½“åŒ…å«stdoutï¼Œstderrï¼Œerror
        """
        ...
        return data
    
    
    @mcp.tool()
    async def upload_file(session_id: str = Field(description='ä¸Šä¼ åˆ°ç›®æ ‡æ²™ç®±çš„å”¯ä¸€æ ‡è¯†ç¬¦'),
                    file_list: List = Field(description='ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼Œæ¯ä¸ªéƒ½æ˜¯æœ¬åœ°æ–‡ä»¶çš„ç»å¯¹è·¯å¾„')
                    ) -> str:
        """ä¸Šä¼ æœ¬åœ°æ–‡ä»¶åˆ°å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ²™ç®±ä¸­
        :return: æ‰§è¡Œæ—¥å¿—
        """
        ...
        return return_msg
        
    if __name__ == '__main__':
        mcp.run(transport='stdio')
    
    

ä»Žä¸­æˆ‘ä»¬å¯ä»¥å‘çŽ°FastMCPåœ¨æœåŠ¡å¼€å‘ä¸Šåšäº†ä»¥ä¸‹å‡ ç‚¹ç®€åŒ–

1.  **æœåŠ¡å™¨åˆ›å»ºå’Œå¯åŠ¨çš„ç®€åŒ–**ï¼šFastMCPå¯ä»¥åƒflaskã€FastAPIä¸€æ ·ç›´æŽ¥mcp.runå¯åŠ¨
2.  **å·¥å…·ï¼ˆèµ„æºã€promptï¼‰å®šä¹‰å’Œè°ƒç”¨çš„ç®€åŒ–**ï¼šæ— éœ€æ˜¾å¼æž„å»ºlist\_toolå’Œcall\_tool APIï¼Œä½¿ç”¨mcp.toolè£…é¥°å™¨ç›´æŽ¥æ³¨å†Œå·¥å…·ï¼ŒèƒŒåŽçš„tool Managerä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸Šå·¥å…·è¯´æ˜Žå’Œå·¥å…·è°ƒç”¨æ–¹æ³•çš„æž„å»ºï¼Œresourceå’Œpromptä¹Ÿæ˜¯åŒç†ã€‚
3.  **ä¸Šä¸‹æ–‡å’Œæ—¥å¿—çš„ç®€åŒ–**ï¼šçœ‹å®žçŽ°FastMCPæŠ½è±¡äº†Contextå¯¹è±¡æ¥ç®€åŒ–æ—¥å¿—å’Œè¿›åº¦ç®¡ç†ï¼Œä½†è¿™å—æˆ‘è¿˜æ²¡å…·ä½“ç”¨è¿‡å°±ä¸åšå±•å¼€ã€‚

âš™ï¸ ç®€å•è¯´ä¸‹FastMCPçš„æž¶æž„æ ¸å¿ƒï¼š

1.  **FastMCPå¼•å…¥äº†3ä¸ªæ ¸å¿ƒç®¡ç†å™¨Toolã€Resourceã€Prompt Manger**:æ¯ä¸ªmanagerå†…éƒ¨éƒ½å„è‡ªå®žçŽ°äº†æ³¨å†Œï¼ˆadd\_toolï¼‰ã€èŽ·å–(list\_tool)ã€è°ƒç”¨ï¼ˆcall\_toolï¼‰çš„åŠŸèƒ½ï¼Œå…±åŒç»´æŠ¤æœåŠ¡å†…æ‰€æœ‰çš„toolã€resourceå’Œprompt

    class FastMCP:
        def __init__(self, ...):
            self._tool_manager = ToolManager(...)
            self._resource_manager = ResourceManager(...)
            self._prompt_manager = PromptManager(...)
    

2.  **FastMCPé€šè¿‡è£…é¥°å™¨å’Œè‡ªåŠ¨ç±»åž‹æŽ¨æ–­ç®€åŒ–æ³¨å†Œ**ï¼šåœ¨è£…é¥°å™¨æ³¨å†Œå·¥å…·åŽï¼Œé€šè¿‡typingå’Œpydantic BaseModelnèƒ½è‡ªåŠ¨å®Œæˆå·¥å…·è¾“å…¥å‚æ•°å’Œè¾“å‡ºç±»åž‹çš„è§£æžç›´æŽ¥ç”Ÿæˆlist\_toolçš„schemaã€‚å¹¶ä¸”å¯¹æ¯”low-levelï¼ŒFastMCPåŸºäºŽpydanticæä¾›äº†æ›´å¤šå‚æ•°éªŒè¯çš„åŠŸèƒ½ã€‚

    def tool(self, name=None, title=None, description=None):
        def decorator(fn):
            # è‡ªåŠ¨åˆ†æžå‡½æ•°ç­¾å
            func_metadata = func_metadata(fn)
            
            # è‡ªåŠ¨ç”Ÿæˆå‚æ•°schema
            parameters = func_metadata.arg_model.model_json_schema()
            
            # æ³¨å†Œåˆ°å·¥å…·ç®¡ç†å™¨
            self._tool_manager.add_tool(fn, name, title, description)
            return fn
        return decorator
    

è€ƒè™‘åˆ°FastMCPå¼€å‘çš„ä¾¿æ·æ€§ï¼ŒåŽé¢å†è¿›ä¸€æ­¥çš„MCPå¼€å‘æˆ‘ä»¬éƒ½ä¼šåŸºäºŽFastMCPå¼€å‘ï¼Œä¸å†æ¼”ç¤ºlow-level serverçš„å®žçŽ°ï¼ˆå“ˆå“ˆå“ˆç”¨low-levelçš„è€å¿ƒå·²è€—å°½ï¼‰ã€‚

MCPç”¨æ³•è„‘æš´
-------

### Promptæœ‰å•¥ç”¨ï¼Ÿ

**å’Œå·¥å…·ä¸åŒï¼ŒPromptæ˜¯ç”¨æˆ·æ‰‹åŠ¨é€‰æ‹©ï¼Œè€Œéžæ¨¡åž‹é€‰æ‹©çš„ã€‚** æœ¬è´¨ä¸Šåªæ˜¯Serveræä¾›è€…ç»™åˆ°çš„ä¸€äº›å·¥å…·æŒ‡ä»¤çš„æœ€ä½³å®žè·µè€Œå·²ï¼Œmcpçš„ä½¿ç”¨è€…å¯ä»¥é€‰æ‹©ç”¨æˆ–è€…ä¸ç”¨ã€‚

ä¸è¿‡ä¸€ä¸ªæœ‰æ„æ€çš„ä½¿ç”¨æ–¹å¼ï¼Œæ˜¯åœ¨å›¢é˜Ÿå†…éƒ¨å¯ä»¥æ•´ä¸€ä¸ªprompt-mcp-serveræ¥æŠŠå¤§å®¶åœ¨å¹³æ—¶å¼€å‘ä¸­äº²æµ‹å¥½ç”¨çš„ä¸€äº›promptç´¯ç§¯èµ·æ¥ï¼Œé¿å…å„è‡ªä¸ºæˆ˜å’Œé‡å¤åŠ³åŠ¨ï¼Œå“ˆå“ˆå‡†å¤‡æžèµ·æ¥~

### Resource vs Tool

Toolå’ŒPromptçš„ç”¨æ³•ç›¸å¯¹å¸¸è§ï¼Œä½†æ˜¯`Resource`çš„å­˜åœ¨ä¸€åº¦è®©æˆ‘å¾ˆéš¾ç†è§£ï¼Œæˆ‘çœ‹åˆ°äº†åŒ…æ‹¬ä»¥ä¸‹çš„å‡ ç§è§£é‡Š

*   Get vs Postï¼šToolå’ŒResourceçš„åŒºåˆ«å°±æ˜¯Getå’ŒPostçš„åŒºåˆ«ï¼Œå·¥å…·å¯ä»¥æ‰§è¡Œä»»åŠ¡è€ŒResourceåªèƒ½èŽ·å–ä¿¡æ¯ã€‚è°è¯´Toolä¸èƒ½ç”¨Getæ–¹æ³•äº†ï¼Ÿ
*   å’Œæ–‡ä»¶æˆ–æ•°æ®åº“å¯¹æŽ¥è¿”å›žæ•°æ®ï¼šResourceä¸“ç”¨äºŽå’Œæ–‡ä»¶å’Œæ•°æ®åº“å¯¹æŽ¥ï¼Œç”¨äºŽè¿”å›žæ¨¡åž‹éœ€è¦çš„æ•°æ®ã€‚Toolä¸æ˜¯ä¸€æ ·ä¹Ÿèƒ½å¯¹æŽ¥æ•°æ®åº“å’Œç³»ç»Ÿæ–‡ä»¶ï¼Ÿ

ä»¥ä¸Šçš„è¯´æ³•å¹¶æ²¡è¯´æœæˆ‘ï¼Œçœ‹äº†çœ‹å¤šserverä¹Ÿåªå‘çŽ°Resourceå’Œtoolä¹‹å‰è¿˜æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒ

*   è®¢é˜…å’ŒæŽ¨é€ï¼šResourceå¯ä»¥å®žçŽ°è®¢é˜…æŽ¨é€æœºåˆ¶ï¼Œä»Žæ¨¡åž‹ä¸»åŠ¨èŽ·å–æ•°æ®å˜æ›´ï¼Œåˆ°æ£€æµ‹æ•°æ®å˜æ›´å¹¶æŽ¨é€ç»™æ¨¡åž‹ï¼Œä½†æ˜¯è¿™ä¾èµ–å®¢æˆ·ç«¯æ˜¯å¦æœ‰ç±»ä¼¼çš„è®¾è®¡ï¼Œéœ€è¦å®¢æˆ·ç«¯è®¢é˜…resourceå˜æ›´
*   å¤šæ¨¡æ€æ•°æ®ç±»åž‹ï¼šè¿˜æ˜¯å‰é¢çš„æ€è·¯toolçš„è¿”å›žç»“æžœé»˜è®¤æ˜¯ä¼ é€’ç»™æ¨¡åž‹çš„ï¼Œå› æ­¤ä»¥æ–‡æœ¬ä½œä¸ºä¸»è¦æ ¼å¼ï¼ŒåŽé¢æ‰åŠ å…¥äº†structureOutputï¼Œè€Œresourceåˆ™æ”¯æŒæ•°æ®æµã€äºŒè¿›åˆ¶ç­‰æ›´å¤šæ•°æ®ç±»åž‹

ä¸ªäººæ„Ÿè§‰resourceçš„ä½¿ç”¨ç‰¹æ€§è¿˜åœ¨æ‘¸ç´¢é˜¶æ®µï¼Œæˆ‘è¿˜æ²¡å¤ªæƒ³æ˜Žç™½å“ˆå“ˆå“ˆï¼Œè¦æ˜¯å¤§å®¶æœ‰å¥½çš„æ€è·¯ä»¥æ¬¢è¿Žè¯„è®ºåŒºç•™è¨€~

åœ¨serveré‡Œé¢æˆ‘è®¾è®¡äº†ä¸€ä¸ªjupyter resourceï¼Œç”¨äºŽå½“æ•´ä¸ªä»»åŠ¡å®ŒæˆåŽï¼ŒæŠŠæ‰€æœ‰codeå’Œcodeæ‰§è¡Œç»“æžœæ‰“åŒ…æˆjupyter notebookå›žä¼ ç»™å®¢æˆ·ç«¯ï¼Œè¿›è¡Œå±•ç¤ºã€‚è¿™é‡Œæˆ‘é€‰æ‹©æŠŠjupyter notebookæŒ‰ç…§nb4çš„æ ¼å¼è¿”å›žjsonå­—ç¬¦ä¸²çš„æ€è·¯ï¼Œå½“ç„¶è¿”å›žäºŒè¿›åˆ¶æµä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

serveréƒ¨åˆ†çš„ä»£ç å¦‚ä¸‹ï¼Œåœ¨ç”Ÿäº§åœºæ™¯ä¸€èˆ¬è¿™é‡Œä¼šä½¿ç”¨OSSç­‰è¿œç¨‹å­˜å‚¨ï¼Œç›´æŽ¥æŠŠipynbä¸Šä¼ åˆ°äº‘ï¼Œåœ¨å®¢æˆ·ç«¯å†ç›´æŽ¥ä½¿ç”¨è¿”å›žçš„é“¾æŽ¥åŽ»äº‘ä¸Šä¸‹è½½æ–‡ä»¶å³å¯ï¼Œè¿™é‡Œå’±éƒ½åœ¨æœ¬åœ°å°±ç®€åŒ–æˆå›žä¼ æ–‡ä»¶ä¿¡æ¯äº†~

    @mcp.resource("file://notebook/{session_id}.ipynb",
                  mime_type='application/json')
    async def get_execution_history(session_id: str) -> str:
        """èŽ·å–æŒ‡å®šsessionçš„æ‰€æœ‰ä»£ç å’Œä»£ç æ‰§è¡ŒåŽ†å²è®°å½•ï¼Œä»¥Jupyter Meta Dataå½¢å¼è¿”å›ž
        """
        global Execution_DB
        cell_list = []
        code_counter = 0
        logger.info('get jupyter history')
        if session_id in Execution_DB:
            session_data = Execution_DB[session_id]
            executions = session_data.get('executions', [])
            for execution_record in executions:
                cell_list.append({
                    "cell_type": "code",
                    "execution_count": code_counter,
                    "metadata": {},
                    "source": execution_record['code'],
                    "outputs": parse_nb(execution_record["output"])
                })
                code_counter += 1
            notebook = update_notebook_data(cell_list)
            
            logger.info(f"Generated notebook for session {session_id}")
            # è¿”å›žnotebookçš„JSONå†…å®¹ä½œä¸ºbytesï¼Œè¿™æ ·å®¢æˆ·ç«¯ä¼šæŽ¥æ”¶åˆ°çœŸæ­£çš„ipynbæ–‡ä»¶å†…å®¹
            return json.dumps(notebook,ensure_ascii=False)
        else:
            raise ValueError(f'Sandbox with session ID : {session_id} not found')
    

MCP Client
----------

è¯´å®ŒæœåŠ¡ç«¯ï¼Œå’±æœ€åŽæ¥çœ‹ä¸‹å®¢æˆ·ç«¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯low-level mcpå’Œhigh-level FastMCPæŽ¥å£ä¹Ÿå­˜åœ¨ç»†å¾®å·®å¼‚ï¼Œç®€å•è¯´fastmcpè¿”å›žå€¼åµŒå¥—å‡å°‘äº†ä¸€å±‚ï¼Œè€ƒè™‘åŽé¢éƒ½ä¼šä»¥FastMCPä¸ºä¸»ï¼Œè¿™é‡Œåªå±•ç¤ºFastMCPå¯¹åº”clientçš„ç›¸å…³ä»£ç å’Œç»“æžœ

    from fastmcp import Client
    from fastmcp.client.transports import StdioTransport
    
    # ä½¿ç”¨Transportçš„åŽŸå› ä¸ºä¸ºäº†åˆ¶å®šserver.pyè„šæœ¬çš„è·¯å¾„
    transport = StdioTransport(
        command="python",
        args=["-m", "src.servers.e2b_high_level.server"],
        env={"LOG_LEVEL": "DEBUG"}
    )
    session = Client(transport)
    
    async with session:
        # List available prompts
        prompts = await session.list_prompts()
        print(f"Available prompts: {[p.name for p in prompts]}")
    
        # List available resources:é™æ€resource
        resources = await session.list_resources()
        print(f"Available resources: {[r.uri for r in resources]}")
    
        # List available resource templatesï¼šåŠ¨æ€resource
        templates = await session.list_resource_templates()
        print(f"Available templates: {[r.uriTemplate for r in templates]}")
    
        # List available tools
        tools = await session.list_tools()
        print(tools)
        print(f"Available tools: {[t.name for t in tools]}")
    
        # åˆå§‹åŒ–æ²™ç®±
        result = await session.call_tool("initialize_sandbox", arguments={"timeout": 1000})
        print(f"Tool result: {result.content[0].text}")
        # å®žé™…ä¸Šsession_idåº”è¯¥ç”±æ¨¡åž‹åŸºäºŽä¸Šæ–‡ï¼Œåœ¨ä¸‹ä¸€æ­¥execute codeçš„å·¥å…·è°ƒç”¨ä¸­æŽ¨ç†å¾—åˆ°
        session_id = result.content[0].text.split(':')[1].strip()
        # ä¸Šä¼ æ–‡ä»¶
    
        current_dir = os.path.dirname(os.path.abspath(__file__))
        result = await session.call_tool("upload_file",
                                         arguments={"session_id": session_id,
                                                    "file_list": [os.path.join(current_dir, 'tests',
                                                                               'fund_information.csv')]})
        print(f"Tool result: {result.content[0].text}")
    
        # æ‰§è¡Œ2æ­¥ä»£ç : å¯¹äºŽç»“æž„åŒ–è¾“å‡ºï¼Œcall_toolå†…éƒ¨ä¼šæ ¹æ®toolçš„output schemaï¼Œè‡ªåŠ¨è¿›è¡Œmodel validateè§£æž
        result = await session.call_tool("execute_code",
                                         arguments={"session_id": session_id, "code": test_code1})
        print(f"Execute Code: {result.structured_content}")
    
        result = await session.call_tool("execute_code",
                                         arguments={"session_id": session_id, "code": test_code2})
        print(f"Execute Code: {result.structured_content}")
    
        # ç›´æŽ¥èŽ·å–notebookæ–‡ä»¶å†…å®¹ - ä½¿ç”¨application/octet-stream
        notebook_resource = await session.read_resource(f'file://notebook/{session_id}.ipynb')
        with open( f'notebook_{session_id}.ipynb', 'w',encoding='UTF-8') as f:
            f.write(notebook_resource[0].text)
    
        # å…³é—­æ²™ç®±
        result = await session.call_tool("close_sandbox", arguments={"session_id": session_id})
        print(f"Tool result: {result.content[0].text}")
    

ç»“æžœå¦‚ä¸‹

ä½¿ç”¨èµ„æºèŽ·å–çš„notebookæ–‡ä»¶å¦‚ä¸‹  

* * *

å­¦ä¹ èµ„æºåˆ—è¡¨
------

*   [Claude å®˜æ–¹MCPæŒ‡å—](https://modelcontextprotocol.io/introduction)
*   [Microsoft MCP for Beginner](https://github.com/microsoft/mcp-for-beginners)
*   [E2B SDK](https://github.com/e2b-dev/e2b)
*   [Glamaå¼€æºMCPæ±‡æ€»](https://glama.ai/mcp/servers?query=&attributes=language%3Apython&sort=recent-github-stargazers%3Adesc)
*   [MCP Basedå¼€æºMCPæ±‡æ€»](https://mcpbased.com/servers/c2ee38e8-f99f-4c98-9ffa-fd19c2e674be)

æƒ³çœ‹æ›´å…¨çš„å¤§æ¨¡åž‹è®ºæ–‡Â·AgentÂ·å¼€æºæ¡†æž¶Â·AIGCåº”ç”¨ >> [DecryPrompt](https://github.com/DSXiangLi/DecryptPrompt)