---
layout: post
title: 'Javaå¹¶å‘åˆ©å™¨ï¼šCountDownLatchæ·±åº¦è§£æä¸å®æˆ˜åº”ç”¨'
date: "2025-06-18T00:42:23Z"
---
Javaå¹¶å‘åˆ©å™¨ï¼šCountDownLatchæ·±åº¦è§£æä¸å®æˆ˜åº”ç”¨
================================

Javaå¹¶å‘åˆ©å™¨ï¼šCountDownLatchæ·±åº¦è§£æä¸å®æˆ˜åº”ç”¨
================================

> å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œè®©ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆæ˜¯ä¸ªå¸¸è§éœ€æ±‚ã€‚CountDownLatchå°±åƒä¸€ä¸ªå€’è®¡æ—¶å™¨ï¼Œå½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œä¸»çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œã€‚æœ¬æ–‡å°†é€šè¿‡ç®€å•æ˜“æ‡‚çš„æ–¹å¼ï¼Œå¸¦ä½ æŒæ¡è¿™ä¸ªå¼ºå¤§çš„å¹¶å‘å·¥å…·ã€‚

ä¸€ã€CountDownLatchæ˜¯ä»€ä¹ˆï¼Ÿ
--------------------

### 1\. åŸºæœ¬æ¦‚å¿µ

CountDownLatchå°±æ˜¯ä¸€ä¸ª"å€’è®¡æ•°é—¨é—©"ï¼š

*   **å€’è®¡æ•°**ï¼šä»æŒ‡å®šæ•°å­—å¼€å§‹é€’å‡åˆ°0
*   **é—¨é—©**ï¼šå½“è®¡æ•°ä¸º0æ—¶ï¼Œé—¨é—©æ‰“å¼€ï¼Œç­‰å¾…çš„çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
*   **ä¸€æ¬¡æ€§**ï¼šç”¨å®Œå³å¼ƒï¼Œä¸èƒ½é‡ç½®

graph TD A\[åˆ›å»ºCountDownLatch 3\] --> B\[å¯åŠ¨3ä¸ªä»»åŠ¡\] B --> C\[ä»»åŠ¡1å®Œæˆ countDown\] B --> D\[ä»»åŠ¡2å®Œæˆ countDown\] B --> E\[ä»»åŠ¡3å®Œæˆ countDown\] C --> F{è®¡æ•°å™¨=0?} D --> F E --> F F -->|æ˜¯| G\[ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ\] F -->|å¦| H\[ç»§ç»­ç­‰å¾…\]

### 2\. åŸºæœ¬ç”¨æ³•

    public class CountDownLatchDemo {
        public static void main(String[] args) throws InterruptedException {
            // åˆ›å»ºè®¡æ•°å™¨ï¼Œåˆå§‹å€¼ä¸º3
            CountDownLatch latch = new CountDownLatch(3);
          
            // å¯åŠ¨3ä¸ªä»»åŠ¡
            for (int i = 0; i < 3; i++) {
                final int taskId = i;
                new Thread(() -> {
                    System.out.println("ä»»åŠ¡" + taskId + "å¼€å§‹æ‰§è¡Œ");
                    try {
                        Thread.sleep(2000); // æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œ
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    System.out.println("ä»»åŠ¡" + taskId + "æ‰§è¡Œå®Œæˆ");
                    latch.countDown(); // è®¡æ•°å™¨å‡1
                }).start();
            }
          
            System.out.println("ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ...");
            latch.await(); // ç­‰å¾…è®¡æ•°å™¨å˜ä¸º0
            System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ");
        }
    }
    

**è¿è¡Œç»“æœï¼š**

    ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ...
    ä»»åŠ¡0å¼€å§‹æ‰§è¡Œ
    ä»»åŠ¡1å¼€å§‹æ‰§è¡Œ
    ä»»åŠ¡2å¼€å§‹æ‰§è¡Œ
    ä»»åŠ¡0æ‰§è¡Œå®Œæˆ
    ä»»åŠ¡1æ‰§è¡Œå®Œæˆ
    ä»»åŠ¡2æ‰§è¡Œå®Œæˆ
    æ‰€æœ‰ä»»åŠ¡å®Œæˆï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
    

äºŒã€æ ¸å¿ƒAPIä»‹ç»
---------

CountDownLatchåªæœ‰4ä¸ªå…³é”®æ–¹æ³•ï¼š

    public class CountDownLatchAPI {
        public void demonstrateAPI() throws InterruptedException {
            CountDownLatch latch = new CountDownLatch(3);
          
            // 1. countDown() - è®¡æ•°å™¨å‡1
            latch.countDown();
          
            // 2. await() - ç­‰å¾…è®¡æ•°å™¨å˜ä¸º0
            latch.await();
          
            // 3. await(æ—¶é—´, å•ä½) - è¶…æ—¶ç­‰å¾…
            boolean finished = latch.await(5, TimeUnit.SECONDS);
          
            // 4. getCount() - è·å–å½“å‰è®¡æ•°å€¼
            long count = latch.getCount();
            System.out.println("å‰©ä½™è®¡æ•°: " + count);
        }
    }
    

ä¸‰ã€ç»å…¸åº”ç”¨åœºæ™¯
--------

### åœºæ™¯1ï¼šç­‰å¾…å¤šä¸ªä»»åŠ¡å®Œæˆ

æœ€å¸¸ç”¨çš„åœºæ™¯ï¼Œä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡å®Œæˆï¼š

    public class WaitMultipleTasksDemo {
      
        // æ¨¡æ‹Ÿè®¢å•å¤„ç†ï¼šéœ€è¦ç­‰å¾…åº“å­˜æ£€æŸ¥ã€ç”¨æˆ·éªŒè¯ã€æ”¯ä»˜éªŒè¯éƒ½å®Œæˆ
        public void processOrder(String orderId) throws InterruptedException {
            CountDownLatch latch = new CountDownLatch(3);
          
            // åº“å­˜æ£€æŸ¥
            new Thread(() -> {
                try {
                    System.out.println("å¼€å§‹åº“å­˜æ£€æŸ¥...");
                    Thread.sleep(1000);
                    System.out.println("åº“å­˜æ£€æŸ¥å®Œæˆ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    latch.countDown();
                }
            }).start();
          
            // ç”¨æˆ·éªŒè¯
            new Thread(() -> {
                try {
                    System.out.println("å¼€å§‹ç”¨æˆ·éªŒè¯...");
                    Thread.sleep(1500);
                    System.out.println("ç”¨æˆ·éªŒè¯å®Œæˆ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    latch.countDown();
                }
            }).start();
          
            // æ”¯ä»˜éªŒè¯
            new Thread(() -> {
                try {
                    System.out.println("å¼€å§‹æ”¯ä»˜éªŒè¯...");
                    Thread.sleep(800);
                    System.out.println("æ”¯ä»˜éªŒè¯å®Œæˆ");
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    latch.countDown();
                }
            }).start();
          
            System.out.println("ç­‰å¾…æ‰€æœ‰éªŒè¯å®Œæˆ...");
            latch.await();
            System.out.println("è®¢å•å¤„ç†å®Œæˆ: " + orderId);
        }
    }
    

### åœºæ™¯2ï¼šæ§åˆ¶å¹¶å‘å¯åŠ¨

è®©å¤šä¸ªçº¿ç¨‹åŒæ—¶å¼€å§‹æ‰§è¡Œï¼š

    public class ConcurrentStartDemo {
      
        // æ¨¡æ‹Ÿèµ›è·‘ï¼šæ‰€æœ‰é€‰æ‰‹åŒæ—¶èµ·è·‘
        public void startRace() throws InterruptedException {
            int runnerCount = 5;
            CountDownLatch startGun = new CountDownLatch(1); // å‘ä»¤æª
            CountDownLatch finish = new CountDownLatch(runnerCount); // ç»ˆç‚¹çº¿
          
            // åˆ›å»ºé€‰æ‰‹
            for (int i = 0; i < runnerCount; i++) {
                final int runnerId = i;
                new Thread(() -> {
                    try {
                        System.out.println("é€‰æ‰‹" + runnerId + "å‡†å¤‡å°±ç»ª");
                        startGun.await(); // ç­‰å¾…å‘ä»¤æª
                      
                        // å¼€å§‹è·‘æ­¥
                        System.out.println("é€‰æ‰‹" + runnerId + "å¼€å§‹è·‘æ­¥");
                        Thread.sleep(new Random().nextInt(3000)); // æ¨¡æ‹Ÿè·‘æ­¥æ—¶é—´
                        System.out.println("é€‰æ‰‹" + runnerId + "åˆ°è¾¾ç»ˆç‚¹");
                      
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    } finally {
                        finish.countDown();
                    }
                }).start();
            }
          
            Thread.sleep(2000); // ç­‰å¾…é€‰æ‰‹å‡†å¤‡
            System.out.println("é¢„å¤‡...å¼€å§‹ï¼");
            startGun.countDown(); // å‘ä»¤
          
            finish.await(); // ç­‰å¾…æ‰€æœ‰é€‰æ‰‹å®Œæˆ
            System.out.println("æ¯”èµ›ç»“æŸï¼");
        }
    }
    

### åœºæ™¯3ï¼šåˆ†æ®µè®¡ç®—

å°†å¤§ä»»åŠ¡æ‹†åˆ†æˆå°ä»»åŠ¡å¹¶è¡Œè®¡ç®—ï¼š

    public class ParallelCalculationDemo {
      
        // å¹¶è¡Œè®¡ç®—æ•°ç»„çš„å’Œ
        public long calculateSum(int[] array) throws InterruptedException {
            int threadCount = 4;
            CountDownLatch latch = new CountDownLatch(threadCount);
            AtomicLong totalSum = new AtomicLong(0);
          
            int chunkSize = array.length / threadCount;
          
            for (int i = 0; i < threadCount; i++) {
                final int start = i * chunkSize;
                final int end = (i == threadCount - 1) ? array.length : (i + 1) * chunkSize;
              
                new Thread(() -> {
                    long partialSum = 0;
                    for (int j = start; j < end; j++) {
                        partialSum += array[j];
                    }
                    totalSum.addAndGet(partialSum);
                    System.out.println("çº¿ç¨‹è®¡ç®—èŒƒå›´[" + start + "," + end + ")ï¼Œç»“æœï¼š" + partialSum);
                    latch.countDown();
                }).start();
            }
          
            latch.await();
            return totalSum.get();
        }
      
        public static void main(String[] args) throws InterruptedException {
            int[] array = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
            ParallelCalculationDemo demo = new ParallelCalculationDemo();
            long result = demo.calculateSum(array);
            System.out.println("æ€»å’Œï¼š" + result);
        }
    }
    

å››ã€ä½¿ç”¨æ³¨æ„äº‹é¡¹
--------

### 1\. å¼‚å¸¸å¤„ç†è¦ç‚¹

**æ ¸å¿ƒåŸåˆ™ï¼šæ— è®ºæ˜¯å¦å¼‚å¸¸ï¼Œéƒ½è¦è°ƒç”¨countDown()**

    // âœ… æ­£ç¡®å†™æ³•
    new Thread(() -> {
        try {
            // ä¸šåŠ¡é€»è¾‘
            doSomething();
        } catch (Exception e) {
            System.err.println("ä»»åŠ¡å¼‚å¸¸ï¼š" + e.getMessage());
        } finally {
            latch.countDown(); // ç¡®ä¿åœ¨finallyä¸­è°ƒç”¨
        }
    }).start();
    
    // âŒ é”™è¯¯å†™æ³•
    new Thread(() -> {
        try {
            doSomething();
            latch.countDown(); // å¼‚å¸¸æ—¶ä¸ä¼šæ‰§è¡Œï¼Œå¯¼è‡´æ­»é”
        } catch (Exception e) {
            System.err.println("ä»»åŠ¡å¼‚å¸¸ï¼š" + e.getMessage());
            // å¿˜è®°è°ƒç”¨countDown()
        }
    }).start();
    

### 2\. é¿å…æ— é™ç­‰å¾…

    // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé¿å…æ— é™ç­‰å¾…
    boolean finished = latch.await(10, TimeUnit.SECONDS);
    if (finished) {
        System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆ");
    } else {
        System.out.println("ç­‰å¾…è¶…æ—¶ï¼Œå¯èƒ½æœ‰ä»»åŠ¡å¤±è´¥");
    }
    

### 3\. åˆç†ä½¿ç”¨çº¿ç¨‹æ± 

    public void useWithThreadPool() throws InterruptedException {
        CountDownLatch latch = new CountDownLatch(5);
        ExecutorService executor = Executors.newFixedThreadPool(3);
      
        for (int i = 0; i < 5; i++) {
            final int taskId = i;
            executor.submit(() -> {
                try {
                    System.out.println("æ‰§è¡Œä»»åŠ¡" + taskId);
                    Thread.sleep(1000);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                } finally {
                    latch.countDown();
                }
            });
        }
      
        latch.await();
        executor.shutdown(); // å…³é—­çº¿ç¨‹æ± 
        System.out.println("æ‰€æœ‰ä»»åŠ¡å®Œæˆ");
    }
    

äº”ã€å®é™…é¡¹ç›®æ¡ˆä¾‹
--------

### æ¡ˆä¾‹ï¼šç³»ç»Ÿå¯åŠ¨åˆå§‹åŒ–

    public class SystemInitializer {
      
        public boolean initializeSystem() {
            System.out.println("å¼€å§‹ç³»ç»Ÿåˆå§‹åŒ–...");
          
            CountDownLatch latch = new CountDownLatch(4);
            AtomicBoolean success = new AtomicBoolean(true);
          
            // æ•°æ®åº“åˆå§‹åŒ–
            new Thread(() -> {
                try {
                    System.out.println("åˆå§‹åŒ–æ•°æ®åº“è¿æ¥...");
                    Thread.sleep(2000);
                    System.out.println("æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ");
                } catch (InterruptedException e) {
                    success.set(false);
                } finally {
                    latch.countDown();
                }
            }).start();
          
            // Redisåˆå§‹åŒ–
            new Thread(() -> {
                try {
                    System.out.println("åˆå§‹åŒ–Redisè¿æ¥...");
                    Thread.sleep(1000);
                    System.out.println("Redisåˆå§‹åŒ–å®Œæˆ");
                } catch (InterruptedException e) {
                    success.set(false);
                } finally {
                    latch.countDown();
                }
            }).start();
          
            // é…ç½®åŠ è½½
            new Thread(() -> {
                try {
                    System.out.println("åŠ è½½ç³»ç»Ÿé…ç½®...");
                    Thread.sleep(800);
                    System.out.println("é…ç½®åŠ è½½å®Œæˆ");
                } catch (InterruptedException e) {
                    success.set(false);
                } finally {
                    latch.countDown();
                }
            }).start();
          
            // æœåŠ¡æ³¨å†Œ
            new Thread(() -> {
                try {
                    System.out.println("æ³¨å†ŒæœåŠ¡...");
                    Thread.sleep(1500);
                    System.out.println("æœåŠ¡æ³¨å†Œå®Œæˆ");
                } catch (InterruptedException e) {
                    success.set(false);
                } finally {
                    latch.countDown();
                }
            }).start();
          
            try {
                boolean finished = latch.await(10, TimeUnit.SECONDS);
                if (finished && success.get()) {
                    System.out.println("ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸï¼");
                    return true;
                } else {
                    System.out.println("ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼");
                    return false;
                }
            } catch (InterruptedException e) {
                System.out.println("åˆå§‹åŒ–è¢«ä¸­æ–­");
                return false;
            }
        }
      
        public static void main(String[] args) {
            SystemInitializer initializer = new SystemInitializer();
            initializer.initializeSystem();
        }
    }
    

å…­ã€æ€»ç»“
----

CountDownLatchæ˜¯Javaå¹¶å‘ç¼–ç¨‹ä¸­çš„å®ç”¨å·¥å…·ï¼Œå®ƒçš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

### ğŸ¯ æ ¸å¿ƒç‰¹ç‚¹

*   **ç®€å•æ˜“ç”¨**ï¼šAPIç®€æ´ï¼Œæ¦‚å¿µæ¸…æ™°
*   **çº¿ç¨‹å®‰å…¨**ï¼šå†…éƒ¨å®ç°ä¿è¯å¤šçº¿ç¨‹å®‰å…¨
*   **çµæ´»åº”ç”¨**ï¼šé€‚åˆå¤šç§å¹¶å‘åä½œåœºæ™¯

### ğŸ“ ä½¿ç”¨è¦ç‚¹

1.  **å¼‚å¸¸å®‰å…¨**ï¼šåœ¨finallyä¸­è°ƒç”¨countDown()
2.  **è¶…æ—¶æ§åˆ¶**ï¼šä½¿ç”¨å¸¦è¶…æ—¶çš„await()æ–¹æ³•
3.  **ä¸€æ¬¡æ€§ä½¿ç”¨**ï¼šCountDownLatchä¸èƒ½é‡ç½®
4.  **åˆç†è®¾è®¡**ï¼šæ ¹æ®å®é™…ä»»åŠ¡æ•°é‡è®¾ç½®è®¡æ•°å™¨

### ğŸš€ é€‚ç”¨åœºæ™¯

*   ä¸»çº¿ç¨‹ç­‰å¾…å¤šä¸ªå­ä»»åŠ¡å®Œæˆ
*   æ§åˆ¶å¤šä¸ªçº¿ç¨‹åŒæ—¶å¼€å§‹æ‰§è¡Œ
*   åˆ†æ®µå¹¶è¡Œè®¡ç®—åæ±‡æ€»ç»“æœ
*   ç³»ç»Ÿå¯åŠ¨æ—¶çš„ç»„ä»¶åˆå§‹åŒ–

æŒæ¡CountDownLatchï¼Œè®©ä½ çš„å¤šçº¿ç¨‹ç¨‹åºæ›´åŠ ä¼˜é›…å’Œé«˜æ•ˆï¼

* * *

> è§‰å¾—æ–‡ç« æœ‰ç”¨ï¼Ÿæ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€ä¸€åªåˆ’æ°´çš„ç¨‹åºçŒ¿ã€‘ï¼ŒæŒç»­åˆ†äº«Javaå¹¶å‘ç¼–ç¨‹ã€æ€§èƒ½ä¼˜åŒ–ç­‰æŠ€æœ¯å¹²è´§ï¼Œä¸€èµ·åœ¨æŠ€æœ¯è·¯ä¸Šç²¾è¿›æˆé•¿ï¼