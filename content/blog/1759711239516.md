---
layout: post
title: 'ç”¨çº¯.NETå¼€å‘å¹¶åˆ¶ä½œä¸€ä¸ªæ™ºèƒ½æ¡Œé¢æœºå™¨äººï¼ˆå…­ï¼‰ï¼šä½¿ç”¨.NETå¼€å‘ä¸€ä¸ªè·¨å¹³å°åŠŸèƒ½å®Œå–„çš„å°æ™ºAIå®¢æˆ·ç«¯'
date: "2025-10-06T00:40:39Z"
---
ç”¨çº¯.NETå¼€å‘å¹¶åˆ¶ä½œä¸€ä¸ªæ™ºèƒ½æ¡Œé¢æœºå™¨äººï¼ˆå…­ï¼‰ï¼šä½¿ç”¨.NETå¼€å‘ä¸€ä¸ªè·¨å¹³å°åŠŸèƒ½å®Œå–„çš„å°æ™ºAIå®¢æˆ·ç«¯
=================================================

å‰è¨€
--

å‰é¢å‡ ç¯‡æ–‡ç« å·²ç»æŠŠæœºå™¨äººç¡¬ä»¶æ§åˆ¶éƒ¨åˆ†çš„å¼€å‘è®²å¾—å·®ä¸å¤šäº†ï¼ŒåŒ…æ‹¬å±å¹•æ§åˆ¶ã€èˆµæœºé©±åŠ¨ã€è¯­éŸ³äº¤äº’ç­‰åŠŸèƒ½ã€‚ä½†æ˜¯ä¹‹å‰çš„å¤–å½¢å¤ªè¿‡ç®€å•ï¼Œå¯åŠ¨è§’åº¦ä¸å¤Ÿå¤šï¼Œæ‰€ä»¥æˆ‘å°±æ–°æ”¹è¿›äº†ä¸€ä¸ªç‰ˆæœ¬ï¼Œå«[VerdiBotï¼ˆé˜¿è«ï¼‰](https://verdibot.verdure-hiro.cn/zh/)ï¼Œè¯¦ç»†[è§†é¢‘ä»‹ç»åœ°å€è¯·ç‚¹å‡»é“¾æ¥](https://www.bilibili.com/video/BV1Y3nZzXEM2/)ã€‚

ESP32ç¤¾åŒºæœ€ç«çš„AIå¯¹è¯æœºå™¨äººéå°æ™ºAIè«å±äº†ï¼Œæ‰€ä»¥ä¸ºäº†è®©è‡ªå·±åšçš„æœºå™¨äººå¯¹è¯éƒ¨åˆ†ä¹Ÿè¶³å¤Ÿçš„ç”ŸåŠ¨æˆ‘å°±é‡æ–°å®ç°äº†ä¸€ä¸ª.NETç‰ˆæœ¬çš„å°æ™ºå®¢æˆ·ç«¯ï¼Œæ‰“ç®—åæœŸé›†æˆæ›´å¤šçš„åŠŸèƒ½ï¼Œå¹¶æ•´ç†æˆäº†ä¸€ä¸ªå®Œæ•´çš„å¼€æºé¡¹ç›®â€”â€”**[Verdure Assistantï¼ˆç»¿è«åŠ©æ‰‹ï¼‰](https://github.com/maker-community/Verdure.Assistant)**ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº.NET 9.0çš„å¤šå¹³å°AIè¯­éŸ³åŠ©æ‰‹ï¼Œæ”¯æŒWindowsæ¡Œé¢ã€Androidç§»åŠ¨ç«¯ã€å‘½ä»¤è¡Œä»¥åŠWeb APIç­‰å¤šç§ä½¿ç”¨æ–¹å¼ã€‚

è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ç»™å¤§å®¶è®²è®²è¿™ä¸ªå¯¹è¯æœºå™¨äººé¡¹ç›®çš„ä¸€äº›ä»£ç ï¼Œæ–¹ä¾¿æƒ³å°è¯•çš„å°ä¼™ä¼´å¿«é€Ÿä¸Šæ‰‹ä½“éªŒã€‚é¡¹ç›®ä»£ç å·²ç»å¼€æºäº†ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±ç ”ç©¶ï¼Œé‡åˆ°é—®é¢˜ä¹Ÿæ¬¢è¿æIssueè®¨è®ºã€‚

![æœºå™¨äººå›¾ç‰‡](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004141039278-682730428.jpg)

**GitHubé¡¹ç›®åœ°å€**ï¼š[https://github.com/maker-community/Verdure.Assistant](https://github.com/maker-community/Verdure.Assistant)

é—®é¢˜è§£ç­”
----

**Q: ä¹‹å‰ä¸ºä»€ä¹ˆç‰¹æ„åšæ ‘è“æ´¾wifié…ç½‘çš„åŠŸèƒ½ï¼Ÿ**

A: ä¹‹å‰çš„åšå®¢æœ‰ç½‘å‹è¯´æˆ‘æµªè´¹ç”Ÿå‘½å¼€å‘wifié…ç½‘åŠŸèƒ½ï¼Œæˆ‘åœ¨è¯„è®ºåŒºä¹Ÿæœ‰è®²è¿‡åŸå› ï¼Œç°åœ¨æˆ‘åœ¨è¿™é‡Œå†è®²ä¸€éï¼Œå› ä¸ºæœ‰æ—¶å€™æˆ‘ä»¬æ‹¿ç€è®¾å¤‡åˆ°æ–°ç¯å¢ƒçš„æ—¶å€™ï¼Œå¹¶ä¸èƒ½æ—¶åˆ»æœ‰å¯ç”¨çš„æ˜¾ç¤ºå™¨å’Œé¼ æ ‡é”®ç›˜ï¼Œä½†æ˜¯åˆéœ€è¦è”ç½‘ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨wifié…ç½‘äº†ã€‚ç„¶åsshè¿æ¥åˆ°è®¾å¤‡ä¸Šå°±å¯ä»¥åƒæœåŠ¡å™¨ä¸€æ ·æ§åˆ¶äº†ã€‚

**Q: æ”¯æŒå“ªäº›AIæœåŠ¡ï¼Ÿ**

A: ç›®å‰ä¸»è¦å¯¹æ¥çš„æ˜¯å°æ™ºAIæœåŠ¡ï¼Œåç»­è®¡åˆ’æ”¯æŒæ›´å¤šAIæœåŠ¡çš„æ¥å…¥ï¼ŒåŒ…æ‹¬OpenAIç­‰ã€‚é¡¹ç›®é‡‡ç”¨äº†æŠ½è±¡è®¾è®¡ï¼Œæ‰©å±•èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ã€‚

**Q: é¡¹ç›®ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ ˆï¼Ÿ**

A: æ ¸å¿ƒä½¿ç”¨.NET 9.0ï¼Œè·¨å¹³å°UIç”¨.NET MAUIï¼ŒWindowsæ¡Œé¢ä½¿ç”¨çš„WinUI 3ã€‚ç½‘ç»œéŸ³é¢‘ç¼–è§£ç ç”¨çš„OpusSharpåº“ï¼ŒéŸ³é¢‘å½•åˆ¶æ’­æ”¾ä½¿ç”¨çš„æœ€è¿‘ç¤¾åŒºåˆšæœ‰äººå¼€æºçš„çš„SoundFlowåº“ï¼Œè¿™ä¸ªåº“åŠŸèƒ½å®Œå–„ï¼Œä½¿ç”¨æ–¹ä¾¿ï¼Œå¹¶ä¸”å†…ç½®äº†å¤šç§éŸ³é¢‘æ ¼å¼è§£ç çš„æ’­æ”¾ï¼Œæ‰€ä»¥æˆ‘ç”¨å®ƒæ›¿æ¢äº†ä¹‹å‰çš„PortAudioSharp2ï¼Œç½‘ç»œé€šä¿¡åŸºäºWebSocketå’ŒMQTTï¼ˆæœªæµ‹è¯•ï¼‰ã€‚è¯¦ç»†çš„æŠ€æœ¯ç‚¹åœ¨GitHubçš„READMEé‡Œéƒ½æœ‰è¯´æ˜ã€‚

**Q: ä¸ºä»€ä¹ˆè¦é‡æ–°å®ç°è¿™ä¸ªé¡¹ç›®ï¼Ÿ**  
A: ç›®å‰å°æ™ºAIæœºå™¨äººæœ‰å…è´¹çš„æœåŠ¡ç«¯å¯ä»¥ä½¿ç”¨ï¼Œè€Œä¸”æ•´ä¸ªæ¶æ„éƒ½å¾ˆä¼˜é›…ï¼Œå¯¹æ¯”æˆ‘ä¹‹å‰çš„å®ç°ä¼˜ç‚¹å¾ˆå¤šï¼Œæ‰€ä»¥é‡æ–°å®ç°ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹äºç”¨æˆ·ä½“éªŒæœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¹¶ä¸”åè®®æ˜¯å…¬å¼€çš„ï¼Œä»¥åå¦‚æœæƒ³è‡ªå·±æ‹“å±•å®ç°æœåŠ¡ç«¯ä¹Ÿæ˜¯å¾ˆè½»æ¾çš„ã€‚

é¡¹ç›®æ•´ä½“æ¶æ„
------

### ç›®å½•ç»“æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„åˆ†å±‚æ¶æ„ï¼Œä¾¿äºç†è§£å’Œæ‰©å±•ï¼š

    Verdure.Assistant/
    â”œâ”€â”€ src/                              # æºä»£ç 
    â”‚   â”œâ”€â”€ Verdure.Assistant.Core/       # æ ¸å¿ƒåº“ï¼ˆéŸ³é¢‘ã€ç½‘ç»œã€æœåŠ¡ï¼‰
    â”‚   â”œâ”€â”€ Verdure.Assistant.ViewModels/ # å…±äº«è§†å›¾æ¨¡å‹ï¼ˆMVVMï¼‰
    â”‚   â”œâ”€â”€ Verdure.Assistant.Console/    # æ§åˆ¶å°åº”ç”¨
    â”‚   â”œâ”€â”€ Verdure.Assistant.WinUI/      # WinUIæ¡Œé¢åº”ç”¨
    â”‚   â”œâ”€â”€ Verdure.Assistant.MAUI/       # MAUIç§»åŠ¨åº”ç”¨
    â”‚   â””â”€â”€ Verdure.Assistant.Api/        # Web APIæœåŠ¡
    â”œâ”€â”€ tests/                            # æµ‹è¯•é¡¹ç›®
    â”œâ”€â”€ docs/                             # æŠ€æœ¯æ–‡æ¡£
    â””â”€â”€ scripts/                          # æ„å»ºè„šæœ¬
    

**GitHubé¡¹ç›®åœ°å€**ï¼š[https://github.com/maker-community/Verdure.Assistant](https://github.com/maker-community/Verdure.Assistant)

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

*   **è¯­éŸ³äº¤äº’æ¨¡å—**ï¼šä½¿ç”¨å¾®è½¯çš„è¯­éŸ³è®¤çŸ¥æœåŠ¡çš„å…³é”®è¯å”¤é†’ï¼ŒåŠ è½½å…³é”®è¯å”¤é†’æ¨¡å‹æ–‡ä»¶ä¸éœ€è¦Azureè®¢é˜…ï¼ˆ"ä½ å¥½å°ç”µ"/"ä½ å¥½å°å¨œ"ï¼‰
    
    src/Verdure.Assistant.Core/Services/WakeWords/KeywordSpottingService.cs
    
*   **éŸ³é¢‘å¤„ç†æ¨¡å—**ï¼šOpusç¼–è§£ç ã€SoundFlowéŸ³é¢‘æ’­æ”¾ã€è·¨å¹³å°éŸ³é¢‘å½•åˆ¶
    
    src/Verdure.Assistant.Core/Services/Audio/AudioDataDistributor.cs  
    src/Verdure.Assistant.Core/Services/Audio/OpusSharpAudioCodec.cs  
    src/Verdure.Assistant.Core/Services/Audio/SoundFlowAudioPlayer.cs  
    src/Verdure.Assistant.Core/Services/Audio/SoundFlowAudioRecorder.cs
    
*   **ç½‘ç»œé€šä¿¡æ¨¡å—**ï¼šWebSocketå®æ—¶é€šä¿¡ã€MQTTç‰©è”ç½‘åè®®
    
    src/Verdure.Assistant.Core/Services/Protocols/WebSocketClient.cs
    
*   **çŠ¶æ€ç®¡ç†æ¨¡å—**ï¼šè®¾å¤‡çŠ¶æ€æœºã€ä¼šè¯çŠ¶æ€æ§åˆ¶
    
    src/Verdure.Assistant.Core/Services/StateMachine/ConversationStateMachine.cs  
    src/Verdure.Assistant.Core/Services/StateMachine/ConversationStateMachineContext.cs
    
*   **éŸ³ä¹æ’­æ”¾æ¨¡å—**ï¼šé›†æˆé…·ç‹—/é…·æˆ‘APIã€åœ¨çº¿æ’­æ”¾å’Œç¼“å­˜
    
    src/Verdure.Assistant.Core/Services/KuwoMusicService
    

ğŸ“¸ åº”ç”¨æˆªå›¾ä¸æ¼”ç¤º
----------

### ğŸ–¥ï¸ WinUI æ¡Œé¢åº”ç”¨

[![WinUI Application Screenshot - ç‚¹å‡»æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004143644892-1920380335.jpg)](https://github.com/user-attachments/assets/46531b2c-83f0-4eed-9f31-073de5a1a38e)

**ğŸ“¹ æ¼”ç¤ºè§†é¢‘ï¼š[ç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µæ’­æ”¾ â†—](https://github.com/user-attachments/assets/46531b2c-83f0-4eed-9f31-073de5a1a38e)**

_ç°ä»£åŒ–çš„ Windows æ¡Œé¢åº”ç”¨ç•Œé¢ï¼Œæ”¯æŒè¯­éŸ³äº¤äº’å’Œå®æ—¶çŠ¶æ€æ˜¾ç¤º_

* * *

### ğŸ“± MAUI ç§»åŠ¨åº”ç”¨ï¼ˆAndroidï¼‰

[![MAUI Application Screenshot - ç‚¹å‡»æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004143748226-1940939787.jpg)](https://github.com/user-attachments/assets/1534b1cf-4e7b-424b-8f9a-fee8fd650cb8)

**ğŸ“¹ æ¼”ç¤ºè§†é¢‘ï¼š[ç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µæ’­æ”¾ â†—](https://github.com/user-attachments/assets/1534b1cf-4e7b-424b-8f9a-fee8fd650cb8)**

_åŸºäº .NET MAUI çš„ Android ç§»åŠ¨åº”ç”¨ï¼Œæ”¯æŒåå°è¯­éŸ³å¤„ç†å’ŒéŸ³ä¹æ’­æ”¾_

* * *

### âŒš MAUI å®‰å“æ‰‹è¡¨åº”ç”¨ï¼ˆAndroid Watchï¼‰

[![MAUI Android Watch Application Screenshot - ç‚¹å‡»æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004143842357-1785643286.jpg)](https://github.com/user-attachments/assets/1e64c14c-e2eb-4f71-b99c-2b7ea5cfd0e6)

**ğŸ“¹ æ¼”ç¤ºè§†é¢‘ï¼š[ç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µæ’­æ”¾ â†—](https://github.com/user-attachments/assets/1e64c14c-e2eb-4f71-b99c-2b7ea5cfd0e6)**

_åŸºäº .NET MAUI çš„å®‰å“æ‰‹è¡¨åº”ç”¨ï¼Œé€‚é…åœ†å½¢/æ–¹å½¢è¡¨ç›˜ï¼Œæ”¯æŒè¯­éŸ³åŠ©æ‰‹æ ¸å¿ƒåŠŸèƒ½_

* * *

### ğŸ’» Web API æœåŠ¡

[![Console Application Screenshot - ç‚¹å‡»æŸ¥çœ‹æ¼”ç¤ºè§†é¢‘](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004143940207-861899980.jpg)](https://github.com/user-attachments/assets/cae5a403-cd3e-437e-bef5-173568a849b1)

**ğŸ“¹ æ¼”ç¤ºè§†é¢‘ï¼š[ç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µæ’­æ”¾ â†—](https://github.com/user-attachments/assets/cae5a403-cd3e-437e-bef5-173568a849b1)**

_é€‚åˆæ ‘è“æ´¾æœºå™¨äººå’Œæ™®é€šçš„æµ‹è¯•ä½¿ç”¨_

å¿«é€Ÿå¼€å§‹
----

### ç¯å¢ƒå‡†å¤‡

#### åŸºç¡€è¦æ±‚

*   **.NET 9.0 SDK** - [ä¸‹è½½åœ°å€](https://dotnet.microsoft.com/download/dotnet/9.0)
*   **Visual Studio 2022 (17.8+)** æˆ– **Visual Studio Code**

### å…‹éš†é¡¹ç›®

    git clone https://github.com/maker-community/Verdure.Assistant.git
    cd Verdure.Assistant
    

å„å¹³å°ä½¿ç”¨æŒ‡å—
-------

### 1\. Windowsæ¡Œé¢ç‰ˆï¼ˆWinUIï¼‰

#### è¿è¡Œæ–¹å¼

åœ¨Visual Studioä¸­ç›´æ¥è®¾ç½®ä¸ºå¯åŠ¨é¡¹ç›®è¿è¡Œã€‚

#### ä½¿ç”¨æµç¨‹

1.  å¯åŠ¨åº”ç”¨åï¼Œç•Œé¢ä¼šæ˜¾ç¤ºè¿æ¥çŠ¶æ€
2.  å¦‚æœæ²¡æœ‰åœ¨å°æ™ºåå°ç»‘å®šï¼Œä¼šæç¤ºè¿›è¡Œç»‘å®š
3.  ç»‘å®šå®Œæˆè¯´å‡º**ä½ å¥½å°ç”µ**å¼€å¯å¯¹è¯
4.  è¯´å†è§ä¼šå†æ¬¡è¿›å…¥ç­‰å¾…çŠ¶æ€

#### åŠŸèƒ½ç‰¹æ€§

*   **è‡ªåŠ¨æ¨¡å¼**ï¼šè‡ªåŠ¨æŒç»­ç›‘å¬ï¼Œæ— éœ€é‡å¤å”¤é†’
*   **å®æ—¶çŠ¶æ€æ˜¾ç¤º**ï¼šè¿æ¥çŠ¶æ€ã€è¯­éŸ³è¯†åˆ«çŠ¶æ€å¯è§†åŒ–
*   **éŸ³ä¹æ§åˆ¶**ï¼šæœç´¢ã€æ’­æ”¾ã€æš‚åœéŸ³ä¹
*   **ä¸»é¢˜åˆ‡æ¢**ï¼šæ”¯æŒæ·±è‰²/æµ…è‰²ä¸»é¢˜

### 2\. Androidç§»åŠ¨ç‰ˆï¼ˆMAUIï¼‰

#### è¿è¡Œæ–¹å¼

ä½¿ç”¨Visual Studioæ‰“å¼€è§£å†³æ–¹æ¡ˆï¼Œé€‰æ‹©Androidè®¾å¤‡æˆ–æ¨¡æ‹Ÿå™¨ï¼š

#### ä½¿ç”¨æµç¨‹

1.  å®‰è£…APKåˆ°Androidè®¾å¤‡
2.  æˆäºˆ**å½•éŸ³**å’Œ**é€šçŸ¥**æƒé™
3.  ä½¿ç”¨å”¤é†’è¯å¼€å¯å¯¹è¯

### 3\. å‘½ä»¤è¡Œç‰ˆï¼ˆConsoleï¼‰

#### è¿è¡Œæ–¹å¼

    cd src/Verdure.Assistant.Console
    dotnet restore
    dotnet run
    

#### ä½¿ç”¨åœºæ™¯

*   æœåŠ¡å™¨ç«¯éƒ¨ç½²ï¼ˆLinux/Windows Serverï¼‰
*   å¼€å‘è°ƒè¯•å’Œæµ‹è¯•
*   æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¾“å‡º
*   è‡ªåŠ¨åŒ–è„šæœ¬é›†æˆ

### 4\. Web APIæœåŠ¡ï¼ˆæ ‘è“æ´¾/æœåŠ¡å™¨ï¼‰

#### è¿è¡Œæ–¹å¼

    cd src/Verdure.Assistant.Api
    dotnet restore
    dotnet run
    

#### ä¸»è¦APIç«¯ç‚¹

**éŸ³ä¹ç›¸å…³ï¼š**

    # æœç´¢éŸ³ä¹
    GET /api/music/search?songName=é’èŠ±ç“·
    
    # æ’­æ”¾éŸ³ä¹
    POST /api/music/search-and-play
    Content-Type: application/json
    {"songName": "é’èŠ±ç“·"}
    
    # æ’­æ”¾æ§åˆ¶
    POST /api/music/pause
    POST /api/music/resume
    POST /api/music/stop
    

#### æ ‘è“æ´¾éƒ¨ç½²

é€‚åˆéƒ¨ç½²åœ¨æ ‘è“æ´¾ç­‰åµŒå…¥å¼è®¾å¤‡ä¸Šï¼Œé…åˆVerdiBotç¡¬ä»¶æœºå™¨äººä½¿ç”¨ã€‚è¯¦ç»†éƒ¨ç½²æ­¥éª¤å‚è€ƒé¡¹ç›®ä¸­çš„APIæ–‡æ¡£ã€‚

æ ¸å¿ƒæŠ€æœ¯è¯¦è§£
------

### 1\. ä¼šè¯çŠ¶æ€æœº

é¡¹ç›®ä½¿ç”¨çŠ¶æ€æœºç®¡ç†è®¾å¤‡çŠ¶æ€ï¼Œä¸»è¦çŠ¶æ€åŒ…æ‹¬ï¼š

*   **IDLEï¼ˆç©ºé—²ï¼‰**ï¼šç­‰å¾…å”¤é†’
*   **LISTENINGï¼ˆç›‘å¬ï¼‰**ï¼šæ­£åœ¨å½•éŸ³
*   **SPEAKINGï¼ˆè¯´è¯ï¼‰**ï¼šæ’­æ”¾å›å¤

çŠ¶æ€è½¬æ¢é€»è¾‘æ¸…æ™°ï¼Œé¿å…æ··ä¹±çš„æ¡ä»¶åˆ¤æ–­ã€‚

æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š

è¯·æ±‚çŠ¶æ€å˜æ›´ä»£ç ï¼š

    /// <summary>
        /// è¯·æ±‚çŠ¶æ€è½¬æ¢
        /// </summary>
        /// <param name="trigger">è§¦å‘äº‹ä»¶</param>
        /// <param name="context">ä¸Šä¸‹æ–‡ä¿¡æ¯</param>
        /// <returns>æ˜¯å¦æˆåŠŸè½¬æ¢</returns>
        public bool RequestTransition(ConversationTrigger trigger, string? context = null)
        {
            lock (_stateLock)
            {
                var fromState = _currentState;
                var toState = GetNextState(_currentState, trigger);
    
                if (toState == null)
                {
                    _logger?.LogWarning("Invalid state transition: {FromState} -> {Trigger} (context: {Context})",
                        fromState, trigger, context);
                    return false;
                }
    
                if (fromState == toState.Value)
                {
                    _logger?.LogDebug("State transition ignored (already in target state): {State} -> {Trigger}",
                        fromState, trigger);
                    return true;
                }
    
                _logger?.LogInformation("State transition: {FromState} -> {ToState} (trigger: {Trigger}, context: {Context})",
                    fromState, toState.Value, trigger, context);
    
                _currentState = toState.Value;
    
                _previousState = fromState;
    
                // Fire state change event
                var eventArgs = new StateTransitionEventArgs
                {
                    FromState = fromState,
                    ToState = toState.Value,
                    Trigger = trigger,
                    Context = context
                };
    
                try
                {
                    StateChanged?.Invoke(this, eventArgs);
                }
                catch (Exception ex)
                {
                    _logger?.LogError(ex, "Error in state change event handler");
                }
    
                return true;
            }
        }
    

çŠ¶æ€å¤„ç†ä»£ç ï¼š

     private void InitializeStateMachine()
        {
            _stateMachine = new ConversationStateMachine();
            _stateMachineContext = new ConversationStateMachineContext(_stateMachine)
            {
                // Set up state machine actions
                OnEnterListening = async () =>
                    {
                        await StartListeningInternalAsync();
                    },
    
                OnExitListening = async () =>
                    {
                        await StopListeningInternalAsync();
                    },
    
                OnEnterSpeaking = async () =>
                    {
                        // è¿›å…¥è¯´è¯çŠ¶æ€ - ä¿æŒå½•éŸ³ä»¥æ£€æµ‹ç”¨æˆ·æ‰“æ–­
                        // ä¸éœ€è¦åœæ­¢å½•éŸ³ï¼Œç»§ç»­ç›‘å¬ç”¨æˆ·çš„æ‰“æ–­
                        _logger?.LogDebug("è¿›å…¥è¯´è¯çŠ¶æ€ï¼Œä¿æŒå½•éŸ³ä»¥æ£€æµ‹æ‰“æ–­");
                        await Task.CompletedTask;
                    },
    
                OnExitSpeaking = async () =>
                    {
                        await StopSpeakingInternalAsync();
                    },
    
                OnEnterIdle = async () =>
                    {
                        await EnterIdleStateAsync();
                    },
    
                OnEnterConnecting = async () =>
                    {
                        await EnterConnectingStateAsync();
                    }
            };
    
            // Subscribe to state changes to sync with legacy state property
            _stateMachine.StateChanged += OnStateMachineStateChanged;
        }
    

### 2\. Opusç¼–è§£ç 

ä½¿ç”¨Opusç¼–è§£ç å™¨è¿›è¡ŒéŸ³é¢‘å‹ç¼©ï¼Œç‰¹ç‚¹ï¼š

*   **ä½å»¶è¿Ÿ**ï¼šé€‚åˆå®æ—¶è¯­éŸ³é€šä¿¡
*   **é«˜è´¨é‡**ï¼šä¿è¯è¯­éŸ³æ¸…æ™°åº¦
*   **å¸¦å®½èŠ‚çœ**ï¼šæœ‰æ•ˆé™ä½ç½‘ç»œä¼ è¾“å‹åŠ›

é¡¹ç›®ä¸­å°è£…äº†`OpusCodec`ç±»ï¼Œç®€åŒ–äº†ç¼–è§£ç æ“ä½œã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

    using OpusSharp.Core;
    using Verdure.Assistant.Core.Interfaces;
    
    namespace Verdure.Assistant.Core.Services;
    
    /// <summary>
    /// OpusSharpéŸ³é¢‘ç¼–è§£ç å™¨å®ç°
    /// </summary>
    public class OpusSharpAudioCodec : IAudioCodec
    {
        private OpusEncoder? _encoder;
        private OpusDecoder? _decoder;
        private readonly object _lock = new();
        private int _currentSampleRate;
        private int _currentChannels;    
        public byte[] Encode(byte[] pcmData, int sampleRate, int channels)
        {
            lock (_lock)
            {
                // éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦ç¬¦åˆå®˜æ–¹è§„æ ¼
                if (sampleRate != 16000)
                {
                    System.Console.WriteLine($"è­¦å‘Š: ç¼–ç é‡‡æ ·ç‡ {sampleRate} ä¸ç¬¦åˆå®˜æ–¹è§„æ ¼ 16000Hz");
                }
                if (channels != 1)
                {
                    System.Console.WriteLine($"è­¦å‘Š: ç¼–ç å£°é“æ•° {channels} ä¸ç¬¦åˆå®˜æ–¹è§„æ ¼ 1ï¼ˆå•å£°é“ï¼‰");
                }
    
                if (_encoder == null || _currentSampleRate != sampleRate || _currentChannels != channels)
                {
                    _encoder?.Dispose();
                    _encoder = new OpusEncoder(sampleRate, channels, OpusPredefinedValues.OPUS_APPLICATION_AUDIO);
                    _currentSampleRate = sampleRate;
                    _currentChannels = channels;
                    System.Console.WriteLine($"Opusç¼–ç å™¨å·²åˆå§‹åŒ–: {sampleRate}Hz, {channels}å£°é“");
                }
    
                try
                {
                    // è®¡ç®—å¸§å¤§å° (é‡‡æ ·æ•°ï¼Œä¸æ˜¯å­—èŠ‚æ•°) - ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹60msè§„æ ¼
                    int frameSize = sampleRate * 60 / 1000; // å¯¹äº16kHz = 960æ ·æœ¬
                    
                    // ç¡®ä¿è¾“å…¥æ•°æ®é•¿åº¦æ­£ç¡® (16ä½éŸ³é¢‘ = 2å­—èŠ‚/æ ·æœ¬)
                    int expectedBytes = frameSize * channels * 2;
                    
                    //System.Console.WriteLine($"ç¼–ç PCMæ•°æ®: è¾“å…¥é•¿åº¦={pcmData.Length}å­—èŠ‚, æœŸæœ›é•¿åº¦={expectedBytes}å­—èŠ‚, å¸§å¤§å°={frameSize}æ ·æœ¬");
                    
                    if (pcmData.Length != expectedBytes)
                    {
                        //System.Console.WriteLine($"è°ƒæ•´PCMæ•°æ®é•¿åº¦: ä»{pcmData.Length}å­—èŠ‚åˆ°{expectedBytes}å­—èŠ‚");
                        // è°ƒæ•´æ•°æ®é•¿åº¦æˆ–å¡«å……é›¶
                        byte[] adjustedData = new byte[expectedBytes];
                        if (pcmData.Length < expectedBytes)
                        {
                            // æ•°æ®ä¸è¶³ï¼Œå¤åˆ¶ç°æœ‰æ•°æ®å¹¶å¡«å……é›¶
                            Array.Copy(pcmData, adjustedData, pcmData.Length);
                            //System.Console.WriteLine($"PCMæ•°æ®ä¸è¶³ï¼Œå·²å¡«å……{expectedBytes - pcmData.Length}å­—èŠ‚çš„é›¶");
                        }
                        else
                        {
                            // æ•°æ®è¿‡å¤šï¼Œæˆªæ–­
                            Array.Copy(pcmData, adjustedData, expectedBytes);
                            //System.Console.WriteLine($"PCMæ•°æ®è¿‡å¤šï¼Œå·²æˆªæ–­{pcmData.Length - expectedBytes}å­—èŠ‚");
                        }
                        pcmData = adjustedData;
                    }
    
                    // è½¬æ¢ä¸º16ä½çŸ­æ•´å‹æ•°ç»„
                    short[] pcmShorts = new short[frameSize * channels];
                    for (int i = 0; i < pcmShorts.Length && i * 2 + 1 < pcmData.Length; i++)
                    {
                        pcmShorts[i] = BitConverter.ToInt16(pcmData, i * 2);
                    }
    
                    // å¯é€‰ï¼šæ·»åŠ è¾“å…¥éŸ³é¢‘è´¨é‡æ£€æŸ¥
                    //CheckAudioQuality(pcmData, $"ç¼–ç è¾“å…¥PCMï¼Œé•¿åº¦={pcmData.Length}å­—èŠ‚");
    
                    // OpusSharpç¼–ç  - ä½¿ç”¨æ­£ç¡®çš„API
                    byte[] outputBuffer = new byte[4000]; // Opusæœ€å¤§åŒ…å¤§å°
                    int encodedLength = _encoder.Encode(pcmShorts, frameSize, outputBuffer, outputBuffer.Length);
    
                    //System.Console.WriteLine($"ç¼–ç ç»“æœ: è¾“å‡ºé•¿åº¦={encodedLength}å­—èŠ‚");
    
                    if (encodedLength > 0)
                    {
                        // è¿”å›å®é™…ç¼–ç çš„æ•°æ®
                        byte[] result = new byte[encodedLength];
                        Array.Copy(outputBuffer, result, encodedLength);
                        return result;
                    }
                    else
                    {
                        //System.Console.WriteLine($"ç¼–ç å¤±è´¥: è¿”å›é•¿åº¦ä¸º {encodedLength}");
                    }
    
                    return Array.Empty<byte>();
                }
                catch (Exception ex)
                {
                    System.Console.WriteLine($"OpusSharpç¼–ç å¤±è´¥: {ex.Message}");
                    System.Console.WriteLine($"å †æ ˆè·Ÿè¸ª: {ex.StackTrace}");
                    return Array.Empty<byte>();
                }
            }
        }    
        public byte[] Decode(byte[] encodedData, int sampleRate, int channels)
        {
            lock (_lock)
            {
                // éªŒè¯è¾“å…¥å‚æ•°æ˜¯å¦ç¬¦åˆå®˜æ–¹è§„æ ¼
                if (sampleRate != 16000)
                {
                    System.Console.WriteLine($"è­¦å‘Š: é‡‡æ ·ç‡ {sampleRate} ä¸ç¬¦åˆå®˜æ–¹è§„æ ¼ 16000Hz");
                }
                if (channels != 1)
                {
                    System.Console.WriteLine($"è­¦å‘Š: å£°é“æ•° {channels} ä¸ç¬¦åˆå®˜æ–¹è§„æ ¼ 1ï¼ˆå•å£°é“ï¼‰");
                }
    
                if (_decoder == null || _currentSampleRate != sampleRate || _currentChannels != channels)
                {
                    _decoder?.Dispose();
                    _decoder = new OpusDecoder(sampleRate, channels);
                    _currentSampleRate = sampleRate;
                    _currentChannels = channels;
                    System.Console.WriteLine($"Opusè§£ç å™¨å·²åˆå§‹åŒ–: {sampleRate}Hz, {channels}å£°é“");
                }
    
                // æ£€æŸ¥è¾“å…¥æ•°æ®æœ‰æ•ˆæ€§
                if (encodedData == null || encodedData.Length == 0)
                {
                    System.Console.WriteLine("è­¦å‘Š: æ¥æ”¶åˆ°ç©ºçš„Opusæ•°æ®åŒ…");
                    int frameSize = sampleRate * 60 / 1000; // 60mså¸§ï¼Œç¬¦åˆå®˜æ–¹è§„æ ¼
                    byte[] silenceData = new byte[frameSize * channels * 2];
                    return silenceData;
                }
    
                try
                {
                    // è®¡ç®—å¸§å¤§å° (é‡‡æ ·æ•°ï¼Œä¸æ˜¯å­—èŠ‚æ•°) - ä¸¥æ ¼æŒ‰ç…§å®˜æ–¹60msè§„æ ¼
                    int frameSize = sampleRate * 60 / 1000; // å¯¹äº16kHz = 960æ ·æœ¬
                    
                    // ä¸ºè§£ç è¾“å‡ºåˆ†é…ç¼“å†²åŒºï¼Œç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´
                    // Opuså¯èƒ½è§£ç å‡ºä¸åŒé•¿åº¦çš„å¸§ï¼Œæ‰€ä»¥ä½¿ç”¨æœ€å¤§å¯èƒ½çš„å¸§å¤§å°
                    int maxFrameSize = sampleRate * 120 / 1000; // æœ€å¤§120mså¸§ä½œä¸ºå®‰å…¨ç¼“å†²
                    short[] outputBuffer = new short[maxFrameSize * channels];
                    
                    System.Console.WriteLine($"è§£ç Opusæ•°æ®: è¾“å…¥é•¿åº¦={encodedData.Length}å­—èŠ‚, æœŸæœ›å¸§å¤§å°={frameSize}æ ·æœ¬");
                    
                    // OpusSharpè§£ç  - ä½¿ç”¨æ­£ç¡®çš„APIï¼Œè®©è§£ç å™¨è‡ªåŠ¨ç¡®å®šå¸§å¤§å°
                    int decodedSamples = _decoder.Decode(encodedData, encodedData.Length, outputBuffer, maxFrameSize, false);
                    
                    System.Console.WriteLine($"è§£ç ç»“æœ: è§£ç äº†{decodedSamples}æ ·æœ¬");
                    
                    if (decodedSamples > 0)
                    {
                        // éªŒè¯è§£ç å‡ºçš„æ ·æœ¬æ•°æ˜¯å¦åˆç†
                        if (decodedSamples > maxFrameSize)
                        {
                            System.Console.WriteLine($"è­¦å‘Š: è§£ç æ ·æœ¬æ•°({decodedSamples})è¶…å‡ºæœ€å¤§å¸§å¤§å°({maxFrameSize})");
                            decodedSamples = maxFrameSize;
                        }
                        
                        // è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„ - ç¡®ä¿æ­£ç¡®çš„å­—èŠ‚åº
                        byte[] pcmBytes = new byte[decodedSamples * channels * 2];
                        for (int i = 0; i < decodedSamples * channels; i++)
                        {
                            var bytes = BitConverter.GetBytes(outputBuffer[i]);
                            pcmBytes[i * 2] = bytes[0];     // ä½å­—èŠ‚
                            pcmBytes[i * 2 + 1] = bytes[1]; // é«˜å­—èŠ‚
                        }
                        
                        // å¯é€‰ï¼šæ·»åŠ ç®€å•çš„éŸ³é¢‘è´¨é‡æ£€æŸ¥
                        CheckAudioQuality(pcmBytes, $"è§£ç è¾“å‡ºPCMï¼Œé•¿åº¦={pcmBytes.Length}å­—èŠ‚");
                        
                        return pcmBytes;
                    }
                    else
                    {
                        System.Console.WriteLine($"è§£ç å¤±è´¥: è¿”å›çš„æ ·æœ¬æ•°ä¸º {decodedSamples}");
                    }
                    
                    // è¿”å›é™éŸ³æ•°æ®è€Œä¸æ˜¯ç©ºæ•°ç»„ï¼Œä¿æŒéŸ³é¢‘æµè¿ç»­æ€§
                    int silenceFrameSize = frameSize * channels * 2;
                    byte[] silenceData = new byte[silenceFrameSize];
                    System.Console.WriteLine($"è¿”å›é™éŸ³æ•°æ®: {silenceFrameSize}å­—èŠ‚");
                    return silenceData;
                }
                catch (Exception ex)
                {
                    System.Console.WriteLine($"OpusSharpè§£ç å¤±è´¥: {ex.Message}");
                    System.Console.WriteLine($"å †æ ˆè·Ÿè¸ª: {ex.StackTrace}");
                    
                    // è¿”å›é™éŸ³æ•°æ®è€Œä¸æ˜¯ç©ºæ•°ç»„ï¼Œä¿æŒéŸ³é¢‘æµè¿ç»­æ€§
                    int frameSize = sampleRate * 60 / 1000; // 60mså¸§
                    byte[] silenceData = new byte[frameSize * channels * 2];
                    return silenceData;
                }
            }
        }
    
        /// <summary>
        /// ç®€å•çš„éŸ³é¢‘è´¨é‡æ£€æŸ¥ï¼Œå¸®åŠ©è¯Šæ–­éŸ³é¢‘é—®é¢˜
        /// </summary>
        private void CheckAudioQuality(byte[] pcmData, string context)
        {
            if (pcmData.Length < 4) return;
    
            // è½¬æ¢ä¸º16ä½æ ·æœ¬è¿›è¡Œåˆ†æ
            var samples = new short[pcmData.Length / 2];
            Buffer.BlockCopy(pcmData, 0, samples, 0, pcmData.Length);
    
            // è®¡ç®—éŸ³é¢‘ç»Ÿè®¡ä¿¡æ¯
            double sum = 0;
            double sumSquares = 0;
            short min = short.MaxValue;
            short max = short.MinValue;
            int zeroCount = 0;
    
            foreach (short sample in samples)
            {
                sum += sample;
                sumSquares += sample * sample;
                min = Math.Min(min, sample);
                max = Math.Max(max, sample);
                if (sample == 0) zeroCount++;
            }
    
            double mean = sum / samples.Length;
            double rms = Math.Sqrt(sumSquares / samples.Length);
            double zeroPercent = (double)zeroCount / samples.Length * 100;
    
            // æ£€æµ‹æ½œåœ¨é—®é¢˜
            bool hasIssues = false;
            var issues = new List<string>();
    
            // æ£€æŸ¥æ˜¯å¦å…¨ä¸ºé›¶ï¼ˆé™éŸ³ï¼‰
            if (zeroPercent > 95)
            {
                issues.Add("å‡ ä¹å…¨ä¸ºé™éŸ³");
                hasIssues = true;
            }
    
            // æ£€æŸ¥æ˜¯å¦æœ‰å‰Šæ³¢ï¼ˆé¥±å’Œï¼‰
            if (max >= 32760 || min <= -32760)
            {
                issues.Add("å¯èƒ½å­˜åœ¨éŸ³é¢‘å‰Šæ³¢");
                hasIssues = true;
            }
    
            // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸çš„DCåç§»
            if (Math.Abs(mean) > 1000)
            {
                issues.Add($"å¼‚å¸¸çš„DCåç§»: {mean:F1}");
                hasIssues = true;
            }
    
            // æ£€æŸ¥RMSæ˜¯å¦å¼‚å¸¸ä½ï¼ˆå¯èƒ½çš„æŸåä¿¡å·ï¼‰
            if (rms < 10 && zeroPercent < 50)
            {
                issues.Add($"å¼‚å¸¸ä½çš„RMS: {rms:F1}");
                hasIssues = true;
            }        if (hasIssues)
            {
                //System.Console.WriteLine($"éŸ³é¢‘è´¨é‡è­¦å‘Š ({context}): {string.Join(", ", issues)}");
                //System.Console.WriteLine($"  ç»Ÿè®¡: æ ·æœ¬æ•°={samples.Length}, RMS={rms:F1}, èŒƒå›´=[{min}, {max}], é›¶å€¼æ¯”ä¾‹={zeroPercent:F1}%");
            }
            else
            {
                //System.Console.WriteLine($"éŸ³é¢‘è´¨é‡æ­£å¸¸ ({context}): RMS={rms:F1}, èŒƒå›´=[{min}, {max}]");
            }
        }
    
        public void Dispose()
        {
            lock (_lock)
            {
                _encoder?.Dispose();
                _decoder?.Dispose();
            }
        }
    }
    

### 3\. SoundFlowéŸ³é¢‘æ¡†æ¶

è·¨å¹³å°éŸ³é¢‘æ’­æ”¾æ¡†æ¶ï¼š

æä¾›ç»Ÿä¸€çš„éŸ³é¢‘æ’­æ”¾æ¥å£ï¼Œå±è”½å¹³å°å·®å¼‚ã€‚

å½•éŸ³åˆå§‹åŒ–ä»£ç ï¼š

        private static SoundFlowAudioRecorder? _instance;
        private static readonly object _instanceLock = new();
        
        private AudioEngine? _engine;
        private AudioCaptureDevice? _captureDevice;
        private Recorder? _recorder;
        private readonly object _streamLock = new();
        private readonly AudioDataDistributor _audioDistributor; // ä½¿ç”¨ Channel ä¼˜åŒ–çš„éŸ³é¢‘åˆ†å‘å™¨
        private bool _isRecording = false;
        private bool _isDisposed = false;
        private int _sampleRate = 16000;
        private int _channels = 1;
        private readonly ILogger<SoundFlowAudioRecorder>? _logger;
    
        // è®¾å¤‡é…ç½® - ä¼˜åŒ–ä¸ºä½å»¶è¿Ÿå½•éŸ³
        private static readonly MiniAudioDeviceConfig DeviceConfig = new()
        {
            PeriodSizeInFrames = 960,   // 60ms @ 16kHz = 960 samples
            PeriodSizeInMilliseconds = 0,
            Periods = 3,
            NoPreSilencedOutputBuffer = true,
            NoClip = false,
            NoDisableDenormals = false,
            NoFixedSizedCallback = false,
            Capture = new DeviceSubConfig 
            { 
                ShareMode = ShareMode.Shared 
            },
            Wasapi = new WasapiSettings 
            { 
                Usage = WasapiUsage.ProAudio,
                NoAutoConvertSRC = false,     // å…è®¸è‡ªåŠ¨é‡‡æ ·ç‡è½¬æ¢
                NoDefaultQualitySRC = false,  // å…è®¸é«˜è´¨é‡é‡é‡‡æ ·
                NoAutoStreamRouting = false,
                NoHardwareOffloading = false
            }
        };
    
        // å‚è€ƒ py-xiaozhi çš„äº‹ä»¶ç³»ç»Ÿ
        public event EventHandler<byte[]>? DataAvailable;
        public event EventHandler? RecordingStopped;
    
        public bool IsRecording => _isRecording;
    
        private SoundFlowAudioRecorder(ILogger<SoundFlowAudioRecorder>? logger = null)
        {
            _logger = logger;
            _audioDistributor = new AudioDataDistributor(logger);
            InitializeAudioEngine();
        }
    
        /// <summary>
        /// åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–éŸ³é¢‘å¼•æ“å’ŒåŸºç¡€ç»„ä»¶
        /// </summary>
        private void InitializeAudioEngine()
        {
            try
            {
                // åœ¨æ„é€ æ—¶å°±åˆå§‹åŒ–å¼•æ“
                _engine = new MiniAudioEngine();
                
                // æ˜¾ç¤ºå¯ç”¨çš„å½•éŸ³è®¾å¤‡ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
                if (_logger != null && _logger.IsEnabled(LogLevel.Debug))
                {
                    _logger.LogDebug("SoundFlowå½•éŸ³å¼•æ“åˆå§‹åŒ–å®Œæˆ");
                    _logger.LogDebug("å¯ç”¨SoundFlowå½•éŸ³è®¾å¤‡:");
                    for (int i = 0; i < _engine.CaptureDevices.Length; i++)
                    {
                        var device = _engine.CaptureDevices[i];
                        var marker = device.IsDefault ? " (é»˜è®¤)" : "";
                        _logger.LogDebug("  [{Index}] {Name}{Marker}", i, device.Name, marker);
                    }
                }
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "åˆå§‹åŒ–SoundFlowå½•éŸ³å¼•æ“å¤±è´¥");
                throw;
            }
        }
    

æ’­æ”¾å™¨åˆå§‹åŒ–ä»£ç ï¼š

        private readonly ILogger<SoundFlowAudioPlayer>? _logger;
        private AudioEngine? _engine;
        private AudioPlaybackDevice? _playbackDevice;
        private SoundPlayer? _soundPlayer;
        private QueueDataProvider? _dataProvider;
        private readonly object _lock = new();
        private bool _isPlaying = false;
        private bool _isDisposed = false;
        private int _sampleRate = 16000;
        private int _channels = 1;
        // è®¾å¤‡é…ç½® - ä¼˜åŒ–ä¸ºæ›´ä½å»¶è¿Ÿæ’­æ”¾ï¼Œå‡å°‘æ–­æ–­ç»­ç»­
        private static readonly MiniAudioDeviceConfig DeviceConfig = new()
        {
            PeriodSizeInFrames = 480,   // 30ms @ 16kHz = 480 samples (å‡å°‘åˆ°30msæé«˜å“åº”æ€§)
            PeriodSizeInMilliseconds = 0,
            Periods = 4,                // å¢åŠ åˆ°4ä¸ªå‘¨æœŸï¼Œæä¾›æ›´å¥½çš„ç¼“å†²
            NoPreSilencedOutputBuffer = false,
            NoClip = false,
            NoDisableDenormals = false,
            NoFixedSizedCallback = false,
            Playback = new DeviceSubConfig
            {
                ShareMode = ShareMode.Shared
            },
            Wasapi = new WasapiSettings
            {
                Usage = WasapiUsage.ProAudio,    // ä¸“ä¸šéŸ³é¢‘æ¨¡å¼ï¼Œé™ä½å»¶è¿Ÿ
                NoAutoConvertSRC = false,        // å…è®¸è‡ªåŠ¨é‡‡æ ·ç‡è½¬æ¢
                NoDefaultQualitySRC = false,     // å…è®¸é«˜è´¨é‡é‡é‡‡æ ·
                NoAutoStreamRouting = false,
                NoHardwareOffloading = false
            }
        };
    
        public event EventHandler? PlaybackStopped;
        public bool IsPlaying => _isPlaying;
    
        public SoundFlowAudioPlayer(ILogger<SoundFlowAudioPlayer>? logger = null)
        {
            _logger = logger;
    
            // åˆ›å»ºæ— ç•Œé€šé“ç”¨äºéŸ³é¢‘æ•°æ®ç¼“å†²ï¼Œé¿å…é˜»å¡é—®é¢˜
            var options = new UnboundedChannelOptions
            {
                SingleReader = true,   // åªæœ‰æ’­æ”¾ä»»åŠ¡è¯»å–
                SingleWriter = false,  // å¤šä¸ªæ¥æºå¯èƒ½å†™å…¥éŸ³é¢‘æ•°æ®
                AllowSynchronousContinuations = false // é¿å…æ­»é”
            };
    
            InitializeAudioEngine();
            // ä»¥é»˜è®¤å‚æ•°é¢„åˆå§‹åŒ–æ’­æ”¾è®¾å¤‡ä¸æ’­æ”¾å™¨ï¼Œä¾¿äºåç»­å¿«é€Ÿåˆ‡æ¢/æ’­æ”¾
            try
            {
                InitializePlaybackDevice(_sampleRate, _channels);
            }
            catch (Exception ex)
            {
                // é¢„åˆå§‹åŒ–å¤±è´¥ä¸è‡´å‘½ï¼Œå»¶è¿Ÿåˆ°é¦–æ¬¡æ’­æ”¾å†åˆå§‹åŒ–
                _logger?.LogWarning(ex, "SoundFlowé¢„åˆå§‹åŒ–å¤±è´¥ï¼Œå°†åœ¨é¦–æ¬¡æ’­æ”¾æ—¶é‡è¯•");
            }
        }
    
        /// <summary>
        /// åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–éŸ³é¢‘å¼•æ“å’ŒåŸºç¡€ç»„ä»¶
        /// </summary>
        private void InitializeAudioEngine()
        {
            try
            {
                // åœ¨æ„é€ æ—¶å°±åˆå§‹åŒ–å¼•æ“
                _engine = new MiniAudioEngine();
    
                // æ˜¾ç¤ºå¯ç”¨çš„æ’­æ”¾è®¾å¤‡ï¼ˆè°ƒè¯•æ¨¡å¼ï¼‰
                if (_logger != null && _logger.IsEnabled(LogLevel.Debug))
                {
                    _logger.LogDebug("SoundFlowæ’­æ”¾å¼•æ“åˆå§‹åŒ–å®Œæˆ");
                    _logger.LogDebug("å¯ç”¨SoundFlowæ’­æ”¾è®¾å¤‡:");
                    for (int i = 0; i < _engine.PlaybackDevices.Length; i++)
                    {
                        var device = _engine.PlaybackDevices[i];
                        var status = device.IsDefault ? " (é»˜è®¤)" : "";
                        _logger.LogDebug("  [{Index}] {Name}{Status}", i, device.Name, status);
                    }
                }
    
                if (_engine.PlaybackDevices.Length == 0)
                {
                    throw new InvalidOperationException("æœªæ‰¾åˆ°SoundFlowéŸ³é¢‘æ’­æ”¾è®¾å¤‡");
                }
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "åˆå§‹åŒ–SoundFlowæ’­æ”¾å¼•æ“å¤±è´¥");
                throw;
            }
        }
    
        /// <summary>
        /// åˆå§‹åŒ–æ’­æ”¾è®¾å¤‡ï¼ˆä»…åœ¨å‚æ•°å˜åŒ–æ—¶è°ƒç”¨ï¼‰
        /// </summary>
        private void InitializePlaybackDevice(int sampleRate, int channels)
        {
            if (!ValidateAudioParameters(sampleRate, channels))
            {
                throw new ArgumentException("Invalid audio parameters");
            }
    
            // å¦‚æœå‚æ•°ç›¸åŒä¸”è®¾å¤‡å·²åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
            if (_playbackDevice != null && _sampleRate == sampleRate && _channels == channels)
            {
                return;
            }
    
            // æ¸…ç†ç°æœ‰è®¾å¤‡
            if (_playbackDevice != null)
            {
                try
                {
                    _playbackDevice.Stop();
                    _playbackDevice = null;
                }
                catch (Exception ex)
                {
                    _logger?.LogDebug(ex, "æ¸…ç†æ—§æ’­æ”¾è®¾å¤‡æ—¶å‡ºé”™");
                }
            }
    
            _sampleRate = sampleRate;
            _channels = channels;
    
            try
            {
                // å¼•æ“å·²åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–
                if (_engine == null)
                {
                    throw new InvalidOperationException("SoundFlowå¼•æ“æœªæ­£ç¡®åˆå§‹åŒ–");
                }
    
                // ä¿®å¤ï¼šç»Ÿä¸€ä½¿ç”¨F32æ ¼å¼ï¼Œä¸QueueDataProviderä¿æŒä¸€è‡´
                var format = new AudioFormat
                {
                    SampleRate = sampleRate,
                    Channels = channels,
                    Format = SampleFormat.F32  // æ”¹ä¸ºF32ï¼Œä¸æ’­æ”¾å™¨æ ¼å¼ä¸€è‡´
                };
    
                _playbackDevice = _engine.InitializePlaybackDevice(null, format, DeviceConfig);
    
                _logger?.LogDebug("å·²é€‰æ‹©SoundFlowæ’­æ”¾è®¾å¤‡: {DeviceName}", _playbackDevice.Info?.Name ?? "é»˜è®¤è®¾å¤‡");
                _logger?.LogDebug("æ’­æ”¾è®¾å¤‡æ ¼å¼: {Format}, {Channels}ch, {SampleRate}Hz",
                    _playbackDevice.Format.Format, _playbackDevice.Format.Channels, _playbackDevice.Format.SampleRate);
    
                _logger?.LogInformation("SoundFlowéŸ³é¢‘æ’­æ”¾å™¨è®¾å¤‡åˆå§‹åŒ–æˆåŠŸ: {SampleRate}Hz, {Channels}å£°é“",
                    sampleRate, channels);
            }
            catch (Exception ex)
            {
                throw new Exception($"åˆå§‹åŒ–SoundFlowéŸ³é¢‘æ’­æ”¾è®¾å¤‡å¤±è´¥: {ex.Message}", ex);
            }
        }
    
        /// <summary>
        /// åˆå§‹åŒ–SoundPlayerä¸QueueDataProviderï¼ˆä»…åœ¨å‚æ•°å˜åŒ–æ—¶è°ƒç”¨ï¼‰
        /// </summary>
        private async Task InitializePlayer(int sampleRate, int channels)
        {
            if (_engine == null || _playbackDevice == null)
            {
                throw new InvalidOperationException("SoundFlowå¼•æ“æˆ–æ’­æ”¾è®¾å¤‡æœªåˆå§‹åŒ–");
            }
    
            _sampleRate = sampleRate;
            _channels = channels;
    
            try
            {
                // åˆ›å»ºéŸ³é¢‘æ ¼å¼ - åŒ¹é…æµ‹è¯•é¡¹ç›®çš„è¦æ±‚
                var format = new AudioFormat
                {
                    SampleRate = sampleRate,
                    Channels = channels,
                    Format = SampleFormat.F32 // QueueDataProviderä½¿ç”¨Float32æ ¼å¼
                };
    
                // æ¸…ç†æ—§æ’­æ”¾å™¨
                if (_soundPlayer != null)
                {
                    try
                    {
                        _soundPlayer.Stop();
                        _playbackDevice.MasterMixer.RemoveComponent(_soundPlayer);
                        _soundPlayer.Dispose();
                    }
                    catch (Exception ex)
                    {
                        _logger?.LogDebug(ex, "æ¸…ç†æ—§æ’­æ”¾å™¨æ—¶å‡ºé”™");
                    }
                }
    
                _dataProvider?.Dispose();
    
                // åˆ›å»ºQueueDataProvider - ä¸“ä¸ºæµå¼æ•°æ®è®¾è®¡
                _dataProvider = new QueueDataProvider(format);
    
                _dataProvider.EndOfStreamReached += (s, e) =>
                {
                    _logger?.LogDebug("SoundFlowæ•°æ®æä¾›è€…å·²åˆ°è¾¾æµæœ«å°¾");
                    PlaybackStopped?.Invoke(this, EventArgs.Empty);
                };
    
                // åˆ›å»ºæ’­æ”¾å™¨
                _soundPlayer = new SoundPlayer(_engine, format, _dataProvider);
    
                // æ·»åŠ åˆ°æ’­æ”¾è®¾å¤‡çš„æ··éŸ³å™¨
                _playbackDevice.MasterMixer.AddComponent(_soundPlayer);
    
                _logger?.LogDebug("SoundFlowæ’­æ”¾å™¨åˆå§‹åŒ–å®Œæˆ: {SampleRate}Hz, {Channels}ch", sampleRate, channels);
    
                await Task.CompletedTask;
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "SoundFlowæ’­æ”¾å™¨åˆå§‹åŒ–é”™è¯¯");
                throw;
            }
        }
      
    

### 4\. å…³é”®è¯å”¤é†’

æ”¯æŒä¸¤ç§å”¤é†’è¯æ¨¡å‹ï¼š

*   **xiaodianï¼ˆå°ç”µï¼‰**ï¼š"ä½ å¥½å°ç”µ"
*   **cortanaï¼ˆå°å¨œï¼‰**ï¼š"ä½ å¥½å°å¨œ"

åŸºäºéŸ³é¢‘æµå®æ—¶æ£€æµ‹ï¼ŒCPUå ç”¨ä½ï¼Œå“åº”é€Ÿåº¦å¿«ã€‚

å…³é”®è¯å”¤é†’æ ¸å¿ƒé€»è¾‘ï¼š

        /// <summary>
        /// åˆå§‹åŒ–è¯­éŸ³é…ç½®ï¼ˆç¦»çº¿æ¨¡å¼ï¼Œæ— éœ€è®¢é˜…å¯†é’¥ï¼‰
        /// </summary>
        private void InitializeSpeechConfig()
        {
            try
            {
                // åˆ›å»ºç¦»çº¿è¯­éŸ³é…ç½®
                // å¯¹äºå…³é”®è¯æ£€æµ‹ï¼Œå¯ä»¥ä½¿ç”¨ç©ºçš„é…ç½®ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨æœ¬åœ°.tableæ–‡ä»¶
                _speechConfig = SpeechConfig.FromSubscription("dummy", "dummy");
    
                // è®¾ç½®ä¸ºç¦»çº¿æ¨¡å¼
                _speechConfig.SetProperty("SPEECH-UseOfflineRecognition", "true");
    
                _logger?.LogInformation("è¯­éŸ³é…ç½®åˆå§‹åŒ–æˆåŠŸï¼ˆç¦»çº¿æ¨¡å¼ï¼‰");
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "åˆå§‹åŒ–è¯­éŸ³é…ç½®å¤±è´¥");
                _isEnabled = false;
            }
        }
    
        /// <summary>
        /// å¯åŠ¨å…³é”®è¯æ£€æµ‹ï¼ˆå¯¹åº”py-xiaozhiçš„startæ–¹æ³•ï¼‰
        /// </summary>
        public async Task<bool> StartAsync(IAudioRecorder? audioRecorder = null)
        {
            if (!_isEnabled)
            {
                _logger?.LogWarning("å…³é”®è¯æ£€æµ‹åŠŸèƒ½æœªå¯ç”¨");
                return false;
            }
    
            if (_isRunning)
            {
                _logger?.LogWarning("å…³é”®è¯æ£€æµ‹å·²åœ¨è¿è¡Œ");
                return true;
            }
    
            try
            {
                await _semaphore.WaitAsync();
    
                _cancellationTokenSource = new CancellationTokenSource();
    
                // è®¾ç½®éŸ³é¢‘æºï¼ˆå¯¹åº”py-xiaozhiçš„å¤šç§å¯åŠ¨æ¨¡å¼ï¼‰
                if (audioRecorder != null)
                {
                    _audioRecorder = audioRecorder;
                    _useExternalAudioSource = true;
                    _logger?.LogInformation("ä½¿ç”¨å¤–éƒ¨éŸ³é¢‘æºå¯åŠ¨å…³é”®è¯æ£€æµ‹");
                }
                else
                {
                    _useExternalAudioSource = false;
                    _logger?.LogInformation("ä½¿ç”¨ç‹¬ç«‹éŸ³é¢‘æ¨¡å¼å¯åŠ¨å…³é”®è¯æ£€æµ‹");
                }
    
                // åŠ è½½å…³é”®è¯æ¨¡å‹
                if (!await LoadKeywordModelsAsync())
                {
                    _logger?.LogError("åŠ è½½å…³é”®è¯æ¨¡å‹å¤±è´¥");
                    return false;
                }
    
                // é…ç½®éŸ³é¢‘è¾“å…¥ - ä½¿ç”¨å…±äº«éŸ³é¢‘æµç®¡ç†å™¨
                var audioConfig = await ConfigureSharedAudioInput();
                if (audioConfig == null)
                {
                    _logger?.LogError("é…ç½®éŸ³é¢‘è¾“å…¥å¤±è´¥");
                    return false;
                }
    
                // åˆ›å»ºå…³é”®è¯è¯†åˆ«å™¨ - ç¡®ä¿æ¯æ¬¡å¯åŠ¨éƒ½æ˜¯å…¨æ–°å®ä¾‹
                _keywordRecognizer = new KeywordRecognizer(audioConfig);
    
                // è®¢é˜…äº‹ä»¶
                SubscribeToRecognizerEvents();
    
                // åœ¨åå°ä»»åŠ¡ä¸­å¯åŠ¨å…³é”®è¯è¯†åˆ«ï¼Œé¿å…é˜»å¡ä¸»æµç¨‹
                _ = Task.Run(async () =>
                {
                    try
                    {
                        if (_keywordModel != null && _keywordRecognizer != null)
                        {
                            await _keywordRecognizer.RecognizeOnceAsync(_keywordModel);
                            _logger?.LogInformation("å…³é”®è¯è¯†åˆ«å·²å¯åŠ¨ï¼ˆåå°ä»»åŠ¡ï¼‰");
                        }
                    }
                    catch (Exception ex)
                    {
                        _logger?.LogError(ex, "å…³é”®è¯è¯†åˆ«åå°ä»»åŠ¡å¼‚å¸¸");
                        OnErrorOccurred($"å…³é”®è¯è¯†åˆ«å¼‚å¸¸: {ex.Message}");
                    }
                });
    
                _isRunning = true;
                _isPaused = false;
    
                _logger?.LogInformation("å…³é”®è¯æ£€æµ‹å¯åŠ¨æˆåŠŸ");
                return true;
            }
            catch (Exception ex)
            {
                _logger?.LogError(ex, "å¯åŠ¨å…³é”®è¯æ£€æµ‹å¤±è´¥");
                return false;
            }
            finally
            {
                _semaphore.Release();
            }
        }
    

å¸¸è§é—®é¢˜æ’æŸ¥
------

### æ ‘è“æ´¾è¿è¡ŒWebAPIæœåŠ¡åˆå§‹åŒ–è¯­éŸ³è®¾å¤‡å¤±è´¥

1.  ç¡®è®¤usbå£°å¡å·²ç»æ˜¯é»˜è®¤è®¾å¤‡

![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004170719544-824164991.png)

2.  å¦‚ä½•ç¦ç”¨é»˜è®¤çš„å£°å¡  
    é€šè¿‡ä¸‹é¢çš„æŒ‡ä»¤ç¼–è¾‘é…ç½®æ–‡ä»¶

    sudo nano /boot/firmware/config.txt
    

æ³¨é‡Šæ‰å›¾ç‰‡ä¸Šçš„ä»£ç å°±å¯ä»¥å…³é—­  
![img](https://img2024.cnblogs.com/blog/1690009/202510/1690009-20251004170927409-773905350.png)

### è¿æ¥å¤±è´¥

1.  ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
2.  æŸ¥çœ‹é˜²ç«å¢™æ˜¯å¦é˜»æ­¢äº†è¿æ¥

### éŸ³é¢‘é—®é¢˜

1.  ç¡®è®¤éº¦å…‹é£æƒé™å·²æˆäºˆ
2.  æ£€æŸ¥éŸ³é¢‘è®¾å¤‡æ˜¯å¦æ­£å¸¸å·¥ä½œ
3.  æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰éŸ³é¢‘ç›¸å…³é”™è¯¯

### Androidæƒé™é—®é¢˜

åœ¨`AndroidManifest.xml`ä¸­ç¡®è®¤æƒé™å£°æ˜ï¼š

    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />
    

æ€»ç»“
--

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘æƒ³å±•ç¤º.NETåœ¨è·¨å¹³å°å¼€å‘æ–¹é¢çš„å¼ºå¤§èƒ½åŠ›ã€‚ä¸€å¥—æ ¸å¿ƒä»£ç ï¼Œå¯ä»¥è¿è¡Œåœ¨Windowsã€Androidã€Linuxç­‰å¤šä¸ªå¹³å°ä¸Šã€‚

å¤§å¤šæ•°çš„ä»£ç æ˜¯æˆ‘æŒ‡å¯¼Github Copilotç”Ÿæˆçš„ï¼Œè¦æ˜¯æˆ‘ä¸ªäººç‹¬è‡ªå®ç°çš„è¯ï¼Œåº”è¯¥ä¼šèŠ±è´¹æ›´å¤šçš„æ—¶é—´ï¼Œæˆ‘ä¸ªäººæ„Ÿè§‰AIç¼–ç¨‹ç›®å‰å¯¹äºä¸ªäººå¼€å‘è€…æ¥è¯´ç¡®å®èƒ½å¤Ÿå¸®åŠ©å¾ˆå¤šçš„ï¼Œå¦‚æœç”Ÿæˆçš„è´¨é‡ä¸å¥½ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´æç¤ºè¯å’Œæ›´æ¢æ›´å‰å®³çš„æ¨¡å‹ï¼Œè¯·ä¸è¦æ”¾å¼ƒä½¿ç”¨ã€‚

é¡¹ç›®ä»£ç å¼€æºåœ¨GitHubä¸Šï¼Œæ–‡æ¡£ä¹Ÿæ¯”è¾ƒå®Œå–„ã€‚å¦‚æœä½ å¯¹.NETè·¨å¹³å°å¼€å‘æˆ–AIè¯­éŸ³åŠ©æ‰‹æ„Ÿå…´è¶£ï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥ç ”ç©¶ç ”ç©¶ã€‚é‡åˆ°é—®é¢˜æ¬¢è¿æIssueæˆ–è€…åœ¨è¯„è®ºåŒºè®¨è®ºã€‚

ç›®å‰é¡¹ç›®çš„æ–‡æ¡£æœ‰ä½¿ç”¨AIè¿›è¡Œä¸€äº›ç¼–å†™ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰è¿›è¡Œä»”ç»†çš„æ ¡éªŒï¼Œè¯·å¤§å®¶ä»¥ä»£ç å®ç°ä¸ºå‡†ã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©å¤§å®¶å¿«é€Ÿä¸Šæ‰‹è¿™ä¸ªé¡¹ç›®ã€‚åç»­æˆ‘è¿˜ä¼šç»§ç»­æ›´æ–°ç›¸å…³çš„æŠ€æœ¯ç»†èŠ‚å’Œå¼€å‘ç»éªŒï¼Œæ¬¢è¿æŒç»­å…³æ³¨ï¼

å‚è€ƒèµ„æº
----

*   **GitHubé¡¹ç›®åœ°å€**ï¼š[https://github.com/maker-community/Verdure.Assistant](https://github.com/maker-community/Verdure.Assistant)
*   **é¡¹ç›®æ–‡æ¡£ç«™ç‚¹**ï¼š[https://verdure-assistant.verdure-hiro.cn/zh/](https://verdure-assistant.verdure-hiro.cn/zh/)
*   **VerdiBotæœºå™¨äººé¡¹ç›®**ï¼š[https://github.com/maker-community/VerdiBot](https://github.com/maker-community/VerdiBot)
*   **åˆ›å®¢ç¤¾åŒº**ï¼š[https://github.com/maker-community](https://github.com/maker-community)
*   **.NETå®˜æ–¹æ–‡æ¡£**ï¼š[https://docs.microsoft.com/zh-cn/dotnet/](https://docs.microsoft.com/zh-cn/dotnet/)
*   **WinUI 3æ–‡æ¡£**ï¼š[https://learn.microsoft.com/windows/apps/winui/winui3/](https://learn.microsoft.com/windows/apps/winui/winui3/)
*   **.NET MAUIæ–‡æ¡£**ï¼š[https://learn.microsoft.com/dotnet/maui/](https://learn.microsoft.com/dotnet/maui/)
*   **xiaozhi-esp32 ESP32 å‚è€ƒå®ç°**ï¼š[https://github.com/78/xiaozhi-esp32](https://github.com/78/xiaozhi-esp32)
*   **py-xiaozhi Python å‚è€ƒå®ç°**ï¼š[https://github.com/huangjunsen0406/py-xiaozhi](https://github.com/huangjunsen0406/py-xiaozhi)
*   **xiaozhi-sharp**ï¼š[https://github.com/GreenShadeZhang/xiaozhi-sharp](https://github.com/GreenShadeZhang/xiaozhi-sharp)
*   **SoundFlow**ï¼š[https://github.com/LSXPrime/SoundFlow](https://github.com/LSXPrime/SoundFlow)
*   **æœ¬äººBç«™åœ°å€ï¼š**ï¼š[https://space.bilibili.com/25228512](https://space.bilibili.com/25228512)

* * *

_æœ¬æ–‡é¦–å‘äºä¸ªäººæŠ€æœ¯åšå®¢ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚å¦‚æœå¯¹.NETè·¨å¹³å°å¼€å‘å’ŒIoTæ„Ÿå…´è¶£ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„åšå®¢è·å–æ›´å¤šæŠ€æœ¯åˆ†äº«ï¼_