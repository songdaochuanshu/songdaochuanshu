---
layout: post
title: "MySQLäº‹åŠ¡å’Œé”"
date: "2022-03-16T06:10:34.653Z"
---
MySQLäº‹åŠ¡å’Œé”
=========

> ä½œè€…ï¼šITç‹å°äºŒ
> 
> åšå®¢ï¼š[https://itwxe.com](https://itwxe.com/)

MySQLæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘äº‹åŠ¡æ‰€äº§ç”Ÿçš„é—®é¢˜å‘¢ï¼Ÿåˆå€ŸåŠ©äº†å“ªäº›é”çš„æ€æƒ³å‘¢ï¼Ÿè¿™ç¯‡å°äºŒç»™å°ä¼™ä¼´ä»¬ç»§ç»­å” ä¸€å” MySQLçš„é‚£äº›äº‹ã€‚

ä¸€ã€äº‹åŠ¡æ˜¯ä»€ä¹ˆ
-------

äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒï¼Œè¿™äº›æ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ã€‚é€šå¸¸æœ‰ä¸‹é¢4ä¸ªç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯å’±ç¨‹åºçŒ¿ä¿—ç§°çš„ACIDå±æ€§ã€‚

*   **åŸå­æ€§(Atomicity)**ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚ä¸¾ä¸ªä¾‹å­ï¼šæƒ…äººèŠ‚å°äºŒç»™å¥³æœ‹å‹è½¬è´¦520å—ï¼Œé‚£ä¹ˆSQLä¸­ä¸€å…±ä¸¤ä¸ªæ“ä½œï¼Œå°äºŒçš„è´¦æˆ·ä½™é¢`-520`å—ï¼Œå¥³æœ‹å‹è´¦æˆ·ä½™é¢`+520`å—ï¼Œè¿™ä¸€ç»„è½¬è´¦æ“ä½œï¼Œä¸èƒ½åªæ‰§è¡Œå°äºŒçš„è´¦æˆ·`-520`å—ï¼Œæˆ–è€…åªæ‰§è¡Œå¥³æœ‹å‹è´¦æˆ·ä½™é¢`+520`å—ï¼Œåªèƒ½éƒ½æ‰§è¡Œï¼Œæˆ–è€…éƒ½ä¸æ‰§è¡Œã€‚
*   **ä¸€è‡´æ€§(Consistent)**ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ï¼Œæ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚ä¸€è‡´æ€§å’ŒåŸå­æ€§æ¯æ¯ç›¸å…³ï¼Œå³ä¸€ç»„è½¬è´¦æ“ä½œä¸‹æ¥å°äºŒè´¦æˆ·ä½™é¢åº”è¯¥`-520`å—ï¼Œå¥³æœ‹å‹è´¦æˆ·ä½™é¢`+520`å—ï¼Œä¸¤äººè½¬è´¦æ“ä½œä¹‹åè´¦æˆ·æ€»é‡‘é¢æ˜¯ä¸€è‡´çš„ã€‚
*   **éš”ç¦»æ€§(Isolation)**ï¼šä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ï¼Œå³æ¯ä¸ªäº‹åŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸å—å…¶ä»–äº‹åŠ¡çš„å½±å“ã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªäº‹åŠ¡(T1)å¤„ç†è¿‡ç¨‹çš„ä¸­é—´çŠ¶æ€å¯¹å…¶ä»–äº‹åŠ¡(T2, T3...)æ˜¯ä¸å¯è§çš„ï¼›åŒç†ï¼ŒT2åŒæ ·å¯¹T1å’ŒT3çš„ä¸­é—´çŠ¶æ€ä¸å¯è§çš„ã€‚å³åªè¦å°äºŒçš„è½¬è´¦æ“ä½œæ²¡å®Œæˆï¼Œé‚£ä¹ˆå¥³æœ‹å‹ä¸ç®¡æ€ä¹ˆæŸ¥è¯¢ç»“æœéƒ½æ˜¯åŸæ¥çš„ä½™é¢ï¼Œè€Œä¸ä¼šæŸ¥è¯¢å¤šå‡º`520`å—ã€‚
*   **æŒä¹…æ€§(Durable)**ï¼šäº‹åŠ¡å®Œæˆä¹‹åï¼Œå¯¹æ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿æ˜¯åœ¨æ•°æ®åº“ç³»ç»Ÿé‡åˆ°æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šä¸¢å¤±æäº¤äº‹åŠ¡çš„æ“ä½œã€‚å³åªè¦å°äºŒè½¬è´¦æˆåŠŸäº†ï¼Œæ•°æ®å°±ä¿å­˜ç£ç›˜äº†ã€‚

äºŒã€å¹¶å‘äº‹åŠ¡æ‰€äº§ç”Ÿçš„é—®é¢˜
------------

**è„å†™æˆ–è€…æ›´æ–°ä¸¢å¤±(Lost Update)**

å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡åŒä¸€æ—¶é—´ä¿®æ”¹åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼è¿›è¡Œä¸šåŠ¡æ“ä½œæ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜ã€‚

ç®€å•æ¥è¯´å°±æ˜¯**æœ€åçš„æ›´æ–°è¦†ç›–äº†ç”±å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°**ã€‚

**è„è¯»(Dirty Reads)**

**ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°äº†å…¶ä»–äº‹åŠ¡å·²ç»ä¿®æ”¹ä½†æ˜¯æœªæäº¤çš„æ•°æ®**ï¼Œæœªæäº¤æ„å‘³ç€è¿™äº›æ•°æ®å¯èƒ½ä¼šå›æ»šï¼Œä¹Ÿå°±æ˜¯å¯èƒ½æœ€ç»ˆä¸ä¸€å®šä¼šå­˜åˆ°æ•°æ®åº“ä¸­ï¼Œæ‰€ä»¥è¯»å‡ºæ¥çš„æ•°æ®æ˜¯æ— æ•ˆçš„ã€‚

**ä¸å¯é‡å¤è¯»(Non-Repeatable Reads)**

ä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„é‚£æ‰¹æ•°æ®ï¼Œå´å‘ç°å…¶è¯»å‡ºçš„æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œå¯èƒ½ä¼šå—åˆ°å…¶ä»–äº‹åŠ¡çš„å½±å“ï¼Œæ¯”å¦‚å…¶ä»–äº‹åŠ¡æ”¹äº†è¿™æ‰¹æ•°æ®å¹¶æäº¤äº†ã€‚é€šå¸¸é’ˆå¯¹æ•°æ®æ›´æ–°(UPDATE)æ“ä½œæˆ–è€…åˆ é™¤(DELETE)æ“ä½œã€‚

ç®€å•æ¥è¯´å°±æ˜¯**åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç›¸åŒæŸ¥è¯¢è¯­å¥åœ¨ä¸åŒæ—¶åˆ»æŸ¥è¯¢å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´ï¼Œå¯èƒ½æ˜¯ç»“æœå­—æ®µå€¼ä¸ä¸€è‡´ï¼Œä¹Ÿå¯èƒ½æ˜¯å°‘äº†è¡Œæ•°æ®**ã€‚

**å¹»è¯»(Phantom Reads)**

å¯¹æ¯”ä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»æ˜¯é’ˆå¯¹æ•°æ®æ–°å¢(INSERT)æ¥è¯´çš„ï¼Œåœ¨åŒä¸€äº‹åŠ¡ä¸‹ï¼Œåœ¨è¯»å–æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ç‚¹ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„é‚£æ‰¹æ•°æ®ï¼Œ**ç¬¬äºŒæ¬¡çš„SQLè¯­å¥è¿”å›äº†ä¹‹å‰ä¸å­˜åœ¨çš„è¡Œ**ã€‚

ç®€å•æ¥è¯´å°±æ˜¯**äº‹åŠ¡Aè¯»å–åˆ°äº†å…¶ä»–äº‹åŠ¡æäº¤çš„æ–°å¢æ•°æ®**ã€‚

å†æ¥åŒºåˆ†ä¸€ä¸‹ç»å¸¸ææ··çš„**ä¸å¯é‡å¤è¯»**å’Œ**å¹»è¯»**ã€‚

*   **ä¸å¯é‡å¤è¯»**ï¼šè¯´çš„æ˜¯åŸæ¥å­˜åœ¨çš„è®°å½•Aï¼Œè®°å½•Aä»Aå˜æˆäº†è®°å½•Bã€‚
*   **å¹»è¯»**ï¼šå‡ºç°äº†åŸæ¥ä¸å­˜åœ¨çš„è®°å½•ã€‚

å½“ç„¶è¿˜æ˜¯åŒºåˆ†ä¸æ˜æ˜¾çš„å°ä¼™ä¼´å¯ä»¥ç»“åˆäº”ã€è¡Œé”ä¸äº‹åŠ¡éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æç†è§£ç†è§£ï¼Œç†è®ºç»“åˆå®è·µï¼Œnice~

ä¸‰ã€äº‹åŠ¡éš”ç¦»çº§åˆ«
--------

å¹¶å‘äº‹åŠ¡äº§ç”Ÿçš„è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»éƒ½æ˜¯æ•°æ®åº“è¯»å–çš„ä¸€è‡´æ€§ï¼Œé—®é¢˜ï¼Œæ‰€ä»¥æ•°æ®åº“æä¾›äº†ä¸€å®šçš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ¥è§£å†³äº§ç”Ÿçš„é—®é¢˜ã€‚

éš”ç¦»çº§åˆ«

è„è¯»

ä¸å¯é‡å¤è¯»

å¹»è¯»

è¯»æœªæäº¤(read-uncommitted)

æ˜¯

æ˜¯

æ˜¯

ä¸å¯é‡å¤è¯»(read-committed)

å¦

æ˜¯

æ˜¯

å¯é‡å¤è¯»(repeatable-read)

å¦

å¦

æ˜¯

ä¸²è¡ŒåŒ–(serializable)

å¦

å¦

å¦

MySQLæ•°æ®åº“é»˜è®¤çš„éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»(repeatable-read)ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„RRçº§åˆ«ã€‚

æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š`show variables like 'tx_isolation';`

è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¾‹å¦‚è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºè¯»æœªæäº¤ï¼š

*   ä»…å¯¹å½“å‰ä¼šè¯ç”Ÿæ•ˆï¼Œç«‹å³ç”Ÿæ•ˆï¼š`set session transaction isolation level read uncommitted;`æˆ–è€…`set tx_isolation = 'read-uncommitted';`
*   å¯¹å…¨å±€ä¼šè¯ç”Ÿæ•ˆï¼Œéœ€è¦é€€å‡ºä¼šè¯åç”Ÿæ•ˆï¼š`set global transaction isolation level read uncommitted;`

ç”¨Springå¼€å‘ç¨‹åºæ—¶ï¼Œå¦‚æœä¸è®¾ç½®éš”ç¦»çº§åˆ«é»˜è®¤ç”¨MySQLè®¾ç½®çš„éš”ç¦»çº§åˆ«ï¼Œå¦‚æœSpringè®¾ç½®äº†å°±ç”¨è®¾ç½®çš„éš”ç¦»çº§åˆ«ã€‚

å››ã€é”åˆ†ç±»
-----

é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹å¹¶å‘è®¿é—®åŒä¸€èµ„æºçš„æœºåˆ¶ï¼Œè€Œå¯¹äºæ•°æ®åº“æ¥è¯´æ•°æ®å°±æ˜¯ä¸€ç§éœ€è¦ç”¨æˆ·å…±äº«çš„èµ„æºï¼Œæ€ä¹ˆä¿è¯æ•°æ®çš„å¹¶å‘è®¿é—®ä¸€è‡´æ€§å’Œé«˜æ•ˆæ€§æ˜¯æ•°æ®åº“éœ€è¦è§£å†³çš„é—®é¢˜ã€‚

æŒ‰ä¸åŒåˆ†ç±»æœ‰ä»¥ä¸‹åˆ†ç±»ã€‚

*   ä»æ€§èƒ½ä¸Šæ¥åˆ†ï¼Œåˆ†ä¸º**ä¹è§‚é”å’Œæ‚²è§‚é”**ã€‚
    *   ä¹è§‚é”æ¯”è¾ƒä¹è§‚ï¼Œä¹è§‚é”å‡è®¾æ•°æ®ä¸€èˆ¬æƒ…å†µä¸ä¼šé€ æˆå†²çªï¼Œå¤šçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€è¡Œæ•°æ®ä¿®æ”¹çš„æ—¶å€™ï¼Œåœ¨æ•°æ®è¿›è¡Œæäº¤æ›´æ–°çš„æ—¶å€™ï¼Œæ‰ä¼šæ­£å¼å¯¹æ•°æ®çš„å†²çªä¸å¦è¿›è¡Œæ£€æµ‹ï¼Œå¦‚æœå†²çªï¼Œåˆ™è¿”å›ç»™ç”¨æˆ·å¼‚å¸¸ä¿¡æ¯ï¼Œè®©ç”¨æˆ·å†³å®šå¦‚ä½•å»åšã€‚
    *   æ‚²è§‚é”æ¯”è¾ƒæ‚²è§‚ï¼Œå¤šçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€è¡Œæ•°æ®ä¿®æ”¹çš„æ—¶å€™ï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹æˆåŠŸã€‚
*   ä»å¯¹æ•°æ®åº“æ“ä½œçš„ç±»å‹åˆ†ï¼Œåˆ†ä¸º**è¯»é”å’Œå†™é”**(éƒ½å±äºæ‚²è§‚é”)ã€‚
    *   è¯»é”(å…±äº«é”ï¼ŒSé”(**S**hared))ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªè¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“ã€‚
    *   å†™é”(æ’å®ƒé”ï¼ŒXé”(e**X**clusive))ï¼šå½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ã€‚
*   ä»å¯¹æ•°æ®æ“ä½œçš„ç²’åº¦åˆ†ï¼Œåˆ†ä¸º**è¡¨é”å’Œè¡Œé”**ã€‚

### 1\. è¡¨é”

æ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚å¼€é”€å°ï¼ŒåŠ é”å¿«ï¼Œä¸ä¼šå‡ºç°æ­»é”ï¼Œé”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼Œä¸€èˆ¬ç”¨åœ¨æ•´è¡¨æ•°æ®è¿ç§»çš„åœºæ™¯ã€‚

**åŸºæœ¬æ“ä½œ**

*   æ‰‹åŠ¨å¢åŠ è¡¨é”ï¼š`lock table è¡¨åç§° read/write,è¡¨åç§°2 read/write;`
*   æŸ¥çœ‹è¡¨ä¸ŠåŠ è¿‡çš„é”ï¼š`show open tables;`
*   åˆ é™¤è¡¨é”ï¼š`unlock tables;`

**å®æ“ä¸€ä¸‹**

    -- åˆ›å»ºç¤ºä¾‹è¡¨
    CREATE TABLE `test_myisam_lock` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `name` varchar(20) NOT NULL,
      `age` int(11) NOT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE = MyISAM DEFAULT CHARSET = utf8;
    
    -- æ’å…¥å‡ æ¡æ•°æ®
    INSERT INTO `blog_test`.`test_myisam_lock` (`id`, `name`, `age`) VALUES (1, 'itwxe', 18);
    INSERT INTO `blog_test`.`test_myisam_lock` (`id`, `name`, `age`) VALUES (2, 'Lee Patel', 62);
    INSERT INTO `blog_test`.`test_myisam_lock` (`id`, `name`, `age`) VALUES (3, 'Sakurai Mio', 55);
    INSERT INTO `blog_test`.`test_myisam_lock` (`id`, `name`, `age`) VALUES (4, 'Tan Xiuying', 42);
    INSERT INTO `blog_test`.`test_myisam_lock` (`id`, `name`, `age`) VALUES (5, 'Cheng Yunxi', 47);
    

1ã€åŠ è¯»é”

**æœ¬æ–‡è¡¨æ ¼ä¸­åºå·ä»£è¡¨ä¸¤ä¸ªsessionä¸­SQLçš„æ‰§è¡Œé¡ºåºï¼ŒåŒä¸€è¡Œä¸ºä»å·¦å¾€å³æ‰§è¡Œçš„è¯­å¥ã€‚å›¾ä¸­å·²æ ‡æ³¨å½“å‰ç¤ºä¾‹SQLæ‰§è¡Œé¡ºåºï¼Œåç»­ä¸å†æˆªå›¾è¯´æ˜ã€‚**

åºå·

session1

session2

1

lock table test\_myisam\_lock read;

2

select \* from test\_myisam\_lock;  
\-- å¯ä»¥æŸ¥è¯¢

select \* from test\_myisam\_lock;  
\-- å¯ä»¥æŸ¥è¯¢

3

insert into blog\_test.test\_myisam\_lock ( name, age) values ('xiaowu', 18);  
\-- æ’å…¥å¤±è´¥ï¼ŒæŠ¥é”™

insert into blog\_test.test\_myisam\_lock ( name, age) values ('xiaowu', 18);  
\-- ç­‰å¾…æ‰§è¡Œ

4

unlock tables;

\-- é‡Šæ”¾é”åæ²¡æœ‰è¶…æ—¶åˆ™æ‰§è¡Œæ’å…¥æ“ä½œ

![åŠ è¯»é”](https://img2022.cnblogs.com/blog/2358889/202203/2358889-20220316085002642-660792984.png)

å¯¹MyISAMè¡¨çš„è¯»æ“ä½œ(åŠ è¯»é”)ï¼Œä¸ä¼šé˜»å¡å…¶ä»–è¿›ç¨‹å¯¹åŒä¸€è¡¨çš„è¯»è¯·æ±‚ï¼›ä½†ä¼šé˜»å¡å¯¹åŒä¸€è¡¨çš„å†™è¯·æ±‚ï¼Œå½“å‰çº¿ç¨‹æ— æ³•æ‰§è¡Œå†™æ“ä½œï¼Œå…¶ä»–çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œåªæœ‰å½“è¯»é”é‡Šæ”¾åï¼Œæ‰ä¼šæ‰§è¡Œå…¶å®ƒè¿›ç¨‹çš„å†™æ“ä½œã€‚

2ã€åŠ å†™é”

åºå·

session1

session2

1

Lock table test\_myisam\_lock write;

2

select \* from test\_myisam\_lock;  
\-- å¯ä»¥æŸ¥è¯¢

select \* from test\_myisam\_lock;  
\-- è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰‹åŠ¨å–æ¶ˆ(ctrl + c)

3

insert into blog\_test.test\_myisam\_lock ( name, age) values ('xiaoer', 18);  
\-- æ’å…¥æˆåŠŸ

insert into blog\_test.test\_myisam\_lock ( name, age) values ('xiaoer', 18);  
\-- è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰‹åŠ¨å–æ¶ˆ(ctrl + c)

4

update blog\_test.test\_myisam\_lock set name = 'wangxiaoer' where id = 8;  
\-- æ›´æ–°æˆåŠŸ

update blog\_test.test\_myisam\_lock set name = 'wangxiaoer' where id = 8;  
\-- è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰‹åŠ¨å–æ¶ˆ(ctrl + c)

5

delete from blog\_test.test\_myisam\_lock where id = 8;  
\-- åˆ é™¤æˆåŠŸ

delete from blog\_test.test\_myisam\_lock where id = 8;  
\-- è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

6

unlock tables;

\-- é‡Šæ”¾é”åæ²¡æœ‰è¶…æ—¶åˆ™è¿›è¡Œåˆ é™¤æ“ä½œ

ç®€å•æ¥è¯´ï¼šå¯¹MylSAMè¡¨çš„å†™æ“ä½œ(åŠ å†™é”)ï¼Œä¸ä¼šé˜»å¡å½“å‰è¿›ç¨‹å¯¹è¡¨çš„è¯»å†™æ“ä½œï¼›ä½†æ˜¯ä¼šé˜»å¡å…¶ä»–è¿›ç¨‹å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œï¼Œåªæœ‰å½“å†™é”é‡Šæ”¾åï¼Œæ‰ä¼šæ‰§è¡Œå…¶å®ƒè¿›ç¨‹çš„è¯»å†™æ“ä½œã€‚

### 2\. è¡Œé”

æ¯æ¬¡æ“ä½œé”ä½ä¸€è¡Œæ•°æ®ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼Œä¼šå‡ºç°æ­»é”ï¼Œé”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚

åŒæ—¶InnoDBä¸MyISAMæœ€å¤§çš„ä¸¤ç‚¹ä¸åŒå°±æ˜¯**æ”¯æŒäº‹åŠ¡**å’Œ**æ”¯æŒè¡Œçº§é”**ã€‚

**åŸºæœ¬æ“ä½œ**

    -- åˆ›å»ºç¤ºä¾‹è¡¨
    CREATE TABLE `account` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `name` varchar(20) DEFAULT NULL,
      `balance` int(11) DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;
    
    -- æ’å…¥å‡ æ¡æ•°æ®
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (1, 'itwxe', 1000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (2, 'Kenneth Adams', 2000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (3, 'Takada Daichi', 3000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (4, 'Anne Russell', 4000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (5, 'Jia Yuning', 5000);
    

é»˜è®¤çš„RRéš”ç¦»çº§åˆ«ä¸‹ç¤ºä¾‹ï¼Œå³å¯é‡å¤è¯»(repeatable-read)ã€‚

åºå·

session1

session2

1

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

2

update account set balance = balance + 1000 where id = 1;  
\-- æ›´æ–°id = 1çš„ä½™é¢

select \* from account where id = 1;  
\-- æŸ¥è¯¢ä¸é˜»å¡ï¼Œæ­£å¸¸æŸ¥è¯¢

3

update account set balance = balance + 1000 where id = 1;  
\-- æ›´æ–°æ“ä½œé˜»å¡ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæœ€åä¼šè¶…æ—¶æˆ–è€…ç­‰å¾…session1æäº¤(å›æ»š)äº‹åŠ¡åæ‰ä¼šæ‰§è¡Œæ›´æ–°è¯­å¥ã€‚

4

commit;  
\-- æäº¤äº‹åŠ¡

\-- session1æäº¤(å›æ»š)äº‹åŠ¡åï¼Œæ²¡æœ‰è¶…æ—¶åˆ™è¿›è¡Œæ›´æ–°æ“ä½œ

å½“ç„¶å•¦ï¼Œå°äºŒè¿™é‡Œå†™çš„åªæœ‰ä¸¤ä¸ªä¼šè¯ï¼Œå¦‚æœæœ‰å¾ˆå¤šä¸ªsessionåŒæ—¶æ›´æ–°ä¸€è¡Œæ•°æ®ä¹Ÿæ˜¯ä¸€æ ·è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

ç®€å•æ¥è¯´ï¼šåœ¨éä¸²è¡ŒåŒ–äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼ŒInnoDBåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥selectæ—¶ä¸ä¼šåŠ é”ï¼Œä½†æ˜¯updateã€insertã€deleteæ“ä½œä¼šåŠ è¡Œé”ã€‚

å½“ç„¶ï¼Œå½“æŸ¥è¯¢è¯­å¥ä¹Ÿéœ€è¦åŠ é”ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½¿ç”¨ `select ... for update`ã€‚

    select * from account where id = 1 for update;
    

æ­¤æ—¶å½“å‰ä¼šè¯å¯¹äº`id = 1`çš„è¡Œå¯ä»¥è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå…¶å®ƒä¼šè¯ä¸èƒ½å¯¹`id = 1` è¡Œè¿›è¡Œæ“ä½œã€‚åªæœ‰ç­‰å¾…å½“å‰ä¼šè¯é‡Šæ”¾é”(æäº¤/å›æ»šäº‹åŠ¡)åæ‰èƒ½å¤Ÿæ“ä½œè®°å½•`id = 1`çš„è¡Œã€‚

äº”ã€è¡Œé”ä¸äº‹åŠ¡éš”ç¦»çº§åˆ«æ¡ˆä¾‹åˆ†æ
---------------

è¡Œé”æ”¯æŒäº‹åŠ¡æ‰€ä»¥å½“ç„¶å°±å¾—ç»“åˆäº‹åŠ¡éš”ç¦»çº§åˆ«æ¥åˆ†æå®æ“ä¸€ä¸‹ã€‚

### 1\. è¯»æœªæäº¤

é¦–å…ˆå°†ç¤ºä¾‹è´¦æˆ·ä½™é¢è¿˜åŸåˆ°1000ï¼Œ`update account set balance = 1000 where id = 1;`ã€‚

åºå·

session1

session2

1

set tx\_isolation = 'read-uncommitted';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»æœªæäº¤

set tx\_isolation = 'read-uncommitted';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»æœªæäº¤

2

begin;  
\-- å¼€å¯äº‹åŠ¡

3

select \* from account where id = 1;  
\-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä½™é¢ä¸º1000

begin;  
\-- å¼€å¯äº‹åŠ¡

4

update account set balance = balance + 1000 where id = 1;  
\-- æ›´æ–°id = 1çš„ä½™é¢

5

select \* from account where id = 1;  
\-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ä½™é¢ä¸º2000ï¼Œè¿™é‡Œå°±æ˜¯è„è¯»äº†ï¼Œè¯»åˆ°äº†æ²¡æœ‰æäº¤çš„æ•°æ®

6

rollback;  
\-- å›æ»š

7

select \* from account where id = 1;  
\-- ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ä½™é¢ä¸º1000

8

update account set balance = balance - 2000 where id = 1;  
\-- ä¾‹å¦‚åºå·5ä¸­çš„ä½™é¢åœ¨Javaä»£ç ä¸­åˆ¤æ–­å¯ä»¥è´­ä¹°åæ‰§è¡Œäº†æ‰£å‡ä½™é¢

9

commit;  
\-- æäº¤äº‹åŠ¡

å¯ä»¥çœ‹åˆ°ï¼Œè¯»æœªæäº¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œç¬¬5è¡Œsessionè¯»å–åˆ°çš„è´¦æˆ·ä½™é¢å°±æ˜¯2000äº†ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœJavaåº”ç”¨ç¨‹åºä½¿ç”¨2000ä½œä¸ºåˆ¤æ–­äº†æŸäº›ä¸šåŠ¡æ“ä½œï¼Œä¾‹å¦‚åˆ¤æ–­æ˜¯å¦å¯ä»¥è´­ä¹°ä¸€ä¸ª2000çš„å•†å“ï¼Œæ­¤æ—¶sessionåˆè¿˜æ²¡æœ‰æ‰£å‡ä½™é¢ï¼Œé‚£ä¹ˆå½“session2å› ä¸ºæŸäº›åŸå› å›æ»šäº†ï¼Œæ­¤æ—¶idä¸º1çš„ç”¨æˆ·ä½™é¢å°±æ˜¯ -1000 å—äº†ï¼Œè¿™æ˜¯æ˜æ˜¾ä¸åˆç†çš„ï¼›å¹¶ä¸”å®é™…å¼€å‘ä¸­ä¸€å®šä¸è¦ä½¿ç”¨Javaç¨‹åºè®¡ç®—åç›´æ¥å°†å€¼æ›´æ–°åˆ°æ•°æ®åº“ï¼Œè¿™æ ·ä¼šé€ æˆè„å†™ï¼Œä¾‹å¦‚Javaç¨‹åºè®¡ç®—å€¼åè´¦æˆ·ä½™é¢ä¸ºé›¶ï¼Œé‚£ä¹ˆæ‰§è¡Œ`update account set balance = 0 where id = 1;`çš„è¯é—®é¢˜å°±æ›´å¤§äº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å°±è¦ç”¨åˆ°è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«äº†ã€‚

### 2\. è¯»å·²æäº¤

é¦–å…ˆå°†ç¤ºä¾‹è´¦æˆ·ä½™é¢è¿˜åŸåˆ°1000ï¼Œ`update account set balance = 1000 where id = 1;`ã€‚

åºå·

session1

session2

1

set tx\_isolation = 'read-committed';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»å·²æäº¤

set tx\_isolation = 'read-committed';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè¯»å·²æäº¤

2

begin;  
\-- å¼€å¯äº‹åŠ¡

3

select \* from account where id = 1;  
\-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä½™é¢ä¸º1000

begin;  
\-- å¼€å¯äº‹åŠ¡

4

update account set balance = balance + 1000 where id = 1;  
\-- æ›´æ–°id = 1çš„ä½™é¢

5

select \* from account where id = 1;  
\-- ç¬¬äºŒæ¬¡æŸ¥è¯¢ä½™é¢ä¸º1000

6

commit;  
\-- æäº¤äº‹åŠ¡

7

select \* from account where id = 1;  
\-- ç¬¬ä¸‰æ¬¡æŸ¥è¯¢ä½™é¢ä¸º2000

8

commit;  
\-- æäº¤äº‹åŠ¡

å¯ä»¥çœ‹åˆ°å·²ç»è§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨session2æäº¤åå‡ºç°äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜ï¼Œä¸å¯é‡å¤è¯»ä¼šè®©æˆ‘ä»¬åœ¨ç¼–å†™Javaåº”ç”¨ä»£ç çš„æ—¶å€™å¾ˆéš¾ç¼–å†™ï¼Œè€Œä¸å¯é‡å¤è¯»å°±å¾—é **å¯é‡å¤è¯»**çš„éš”ç¦»çº§åˆ«æ¥è§£å†³äº†ã€‚

### 3\. å¯é‡å¤è¯»

é¦–å…ˆå°†ç¤ºä¾‹è´¦æˆ·ä½™é¢è¿˜åŸåˆ°1000ï¼Œ`update account set balance = 1000 where id = 1;`ã€‚

åºå·

session1

session2

1

set tx\_isolation='repeatable-read';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»

set tx\_isolation='repeatable-read';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»

2

begin;  
\-- å¼€å¯äº‹åŠ¡

3

select \* from account;  
\-- ç¬¬ä¸€æ¬¡æŸ¥è¯¢id = 1è´¦æˆ·ä½™é¢ä¸º1000

begin;  
\-- å¼€å¯äº‹åŠ¡

4

update account set balance = balance + 1000 where id = 1;  
\-- æ›´æ–°id = 1çš„ä½™é¢

5

select \* from account;  
\-- ç¬¬äºŒæ¬¡æŸ¥è¯¢id = 1è´¦æˆ·ä½™é¢ä¸º1000

6

commit;  
\-- æäº¤äº‹åŠ¡

7

select \* from account;  
\-- ç¬¬äºŒæ¬¡æŸ¥è¯¢id = 1è´¦æˆ·ä½™é¢ä¸º1000ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»è§£å†³äº†ä¸å¯é‡å¤è¯»çš„é—®é¢˜

8

begin;  
\-- é‡æ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼ŒéªŒè¯å¹»è¯»é—®é¢˜

9

insert into account (id, name, balance) values (6, 'xiaoer', 6000);  
\-- æ’å…¥ä¸€è¡Œæ•°æ®  
commit;  
\-- æäº¤äº‹åŠ¡

10

select \* from account;  
\-- ç»“æœå’Œåºå·7ä¸­å±•ç¤ºçš„ç»“æœä¸€è‡´ï¼Œåªæœ‰id = 1~5çš„è®°å½•

11

update account set balance = 6666 where id = 6;  
\-- æ›´æ–°æ–°å¢çš„id = 6è®°å½•

12

select \* from account;  
\-- å†æ¬¡å‘ç°æŸ¥è¯¢åˆ°çš„è®°å½•å¤šäº†id = 6çš„è®°å½•ï¼Œä¸”id=6çš„è´¦æˆ·ä½™é¢ä¸º6666

13

commit;

æ‰€ä»¥ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®**MySQLå¹¶æ²¡æœ‰å®Œå…¨è§£å†³å¹»è¯»çš„é—®é¢˜ï¼Œåœ¨RRçº§åˆ«ä¸‹å½“MySQLæœ‰å¯èƒ½ä¼šå‡ºç°å¹»è¯»é—®é¢˜**ã€‚

å½“ç„¶æˆ‘ä»¬å®é™…å¼€å‘é€šå¸¸ä¹Ÿä¸ä¼šè¿™æ ·å»æ“ä½œï¼Œå› ä¸º`id = 6`è¿™ä¸ªå¯¹å½“å‰sessionæ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥é€šå¸¸ä¸ä¼šç›´æ¥ä¿®æ”¹åˆ°å…¶ä»–sessionæ’å…¥çš„è®°å½•ã€‚

æ‰€ä»¥MySQLé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«å°±æ˜¯RRçº§åˆ«ï¼Œå¹¶å‘é«˜ä¸”èƒ½è§£å†³99.99%çš„ä¸šåŠ¡åœºæ™¯ã€‚

### 4\. ä¸²è¡ŒåŒ–

é¦–å…ˆå°†ç¤ºä¾‹è´¦æˆ·ä½™é¢è¿˜åŸåˆ°1000ï¼Œ`update account set balance = 1000 where id = 1;`ã€‚

åºå·

session1

session2

1

set tx\_isolation='serializable';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºä¸²è¡ŒåŒ–

set tx\_isolation='serializable';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºä¸²è¡ŒåŒ–

2

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

3

select \* from account where id = 1;  
\-- æŸ¥è¯¢id = 1ä¿¡æ¯ï¼Œè´¦æˆ·ä½™é¢ä¸º1000

select \* from account where id = 2;  
\-- id = 2çš„è®°å½•å¯ä»¥æŸ¥è¯¢

4

select \* from account where id = 1;  
\-- id = 1è´¦æˆ·ä½™é¢ä¸º1000

5

select \* from account where id = 2;  
\-- è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæœ€åä¼šè¶…æ—¶æˆ–è€…ç­‰å¾…session1æäº¤äº‹åŠ¡æˆ–è€…å›æ»šåæ‰ä¼šæ‰§è¡ŒæŸ¥è¯¢ã€‚

6

commit;

\-- å¦‚æœæ²¡æœ‰è¶…æ—¶åˆ™æ‰§è¡ŒæŸ¥è¯¢id = 2çš„è®°å½•ä¿¡æ¯

7

commit;

å¯ä»¥çœ‹åˆ°ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ï¼Œä½¿ç”¨çš„æ˜¯æ’å®ƒé”ï¼Œé”å®šè®°å½•çš„å¢åˆ æ”¹æŸ¥éƒ½ä¼šæ”¶åˆ°å½±å“è¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ã€‚

æ‰€ä»¥ï¼Œ**ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ä¸ä¼šæœ‰å¹»è¯»çš„é—®é¢˜ï¼Œå½“ç„¶æ•ˆç‡ä¹Ÿæœ€ä½**ï¼Œé€šå¸¸å®é™…é¡¹ç›®å¼€å‘ä¸­éƒ½ä¸ä¼šä½¿ç”¨ã€‚

å…­ã€è¡Œé”è¯¦è§£
------

### 1\. è®°å½•é”ã€é—´éš™é”ã€ä¸´é”®é”

è¡Œé”æœ‰ä¸‰ä¸ªç±»å‹ï¼Œåˆ†åˆ«æ˜¯è®°å½•é”ã€é—´éš™é”ã€ä¸´é”®é”ï¼Œè®°å½•é”åªé”å®šä¸€è¡Œè®°å½•ï¼Œè€Œé—´éš™é”å’Œä¸´é”®é”éƒ½æ˜¯é”å®šä¸€ä¸ªèŒƒå›´çš„è®°å½•è¡Œã€‚

#### è®°å½•é”(Record Locks)

è®°å½•é”é”å®šä¸€è¡Œè®°å½•çš„å·²ç»åœ¨é”åˆ†ç±»ä¸­æ¼”ç¤ºè¿‡äº† `id = 1` çš„åœºæ™¯ï¼Œä¸å” å¨äº†ã€‚

#### é—´éš™é”(Gap Locks)

é—´éš™é”æŒ‡çš„æ˜¯é”çš„æ˜¯ä¸¤ä¸ªå€¼ä¹‹é—´çš„é—´éš™ï¼Œå¯ä»¥è§£å†³RRçº§åˆ«ä¸‹ä¸€äº›æƒ…æ™¯çš„å¹»è¯»é—®é¢˜ã€‚

    -- å†æ’å…¥å‡ æ¡æ•°æ®æ¼”ç¤ºé—´éš™é”å’Œä¸´é”®é”
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (13, 'itwxe.com', 13000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (18, 'zhangsan', 18000);
    INSERT INTO `blog_test`.`account` (`id`, `name`, `balance`) VALUES (25, 'lisi', 25000);
    

æ’å…¥æ•°æ®åidå°±äº§ç”Ÿäº†`(6, 13), (13, 18), (18, 25), (25, æ­£æ— ç©·)` è¿™å››ä¸ªç©ºé—´é—´éš™ã€‚

ä¸‹é¢ä½¿ç”¨RRäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œ`set tx_isolation='repeatable-read';`ã€‚

åºå·

session1

session2

1

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

2

update account set balance = balance + 1000 where id > 8 and id < 13;  
\-- æŸ¥è¯¢åˆ¶é€ é—´éš™(8, 13)

insert into account values(6, 'jianxi', 6000);  
\-- å¯ä»¥æ­£å¸¸æ‰§è¡Œå“åº”ç»“æœï¼Œä½†æ˜¯ä¸»é”®å·²å­˜åœ¨ï¼Œæ’å…¥å¤±è´¥

3

insert into account values(7, 'jianxi', 7000);  
\-- æ’å…¥id = 10çš„è®°å½•ä¼šå‘ç°æ’å…¥ä¸äº†ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

4

insert into account values(10, 'jianxi', 8000);  
\-- æ’å…¥id = 10çš„è®°å½•ä¼šå‘ç°æ’å…¥ä¸äº†ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œæ‰‹åŠ¨å–æ¶ˆ(ctrl + c)

5

insert into account values(13, 'jianxi', 8000);  
\-- æ’å…¥id = 13åŒæ ·ä¼šé˜»å¡ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

6

insert into account values(14, 'jianxi', 8000);  
\-- å¯ä»¥æ­£å¸¸æ’å…¥

7

rollback;  
\-- å›æ»šäº‹åŠ¡

rollback;  
\-- å›æ»šäº‹åŠ¡

å¯ä»¥çœ‹åˆ°æµ‹è¯•ä¸­äº§ç”Ÿé”å®šçš„èŒƒå›´ä¸º`(6, 13]`ï¼Œä¹Ÿå°±æ˜¯è¯´**é—´éš™é”é”å®šçš„èŒƒå›´æ˜¯å°èŒƒå›´(id=8)å‰ä¸€æ¡è¡Œè®°å½•(id=6)çš„å¼€åŒºé—´åˆ°å¤§èŒƒå›´(id=13)çš„åä¸€æ¡è®°å½•ï¼Œå·¦å¼€å³é—­åŒºé—´ã€‚**

å¯ä»¥çœ‹åˆ°é—´éš™é”åœ¨å‡å°‘äº†æŸäº›æƒ…å†µä¸‹å¹»è¯»çš„å‘ç”Ÿï¼Œé€šè¿‡å¯¹é—´éš™åŠ é”è®©é—´éš™å†…åœ¨session1æäº¤(å›æ»š)äº‹åŠ¡ä¹‹å‰å…¶ä»–sessionéƒ½æ— æ³•è¿›è¡Œæ’å…¥æˆ–è€…ä¿®æ”¹ä»»ä½•æ•°æ®ã€‚

**é—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆã€‚**

#### ä¸´é”®é”(Next-key Locks)

ä¸´é”®é”å¯ä»¥è¯´æ˜¯ç‰¹æ®Šçš„é—´éš™é”ï¼Œå³è¡Œé”å’Œé—´éš™é”çš„ç»“åˆï¼Œå¯ä»¥ç†è§£ä¸ºé—´éš™é”ä¸­åŒ…å«è®°å½•è¡Œã€‚

ç›®å‰å­˜åœ¨`(6, 13), (13, 18), (18, 25), (25, æ­£æ— ç©·)` è¿™å››ä¸ªç©ºé—´é—´éš™ã€‚

ä¸‹é¢ä½¿ç”¨RRäº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œ`set tx_isolation='repeatable-read';`ã€‚

åºå·

session1

session2

1

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

2

update account set balance = balance + 1000 where id > 15 and id < 28;  
\-- æŸ¥è¯¢åˆ¶é€ é—´éš™(8, 13)

insert into account values(13, 'linjian', 13000);  
\-- å¯ä»¥æ­£å¸¸æ‰§è¡Œå“åº”ç»“æœï¼Œä½†æ˜¯ä¸»é”®å·²å­˜åœ¨ï¼Œæ’å…¥å¤±è´¥

3

insert into account values(17, 'linjian', 17000);  
\-- æ’å…¥id = 17çš„è®°å½•ä¼šå‘ç°æ’å…¥ä¸äº†ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

4

insert into account values(18, 'linjian', 18000);  
\-- æ’å…¥id = 18çš„è®°å½•ä¼šå‘ç°æ’å…¥ä¸äº†ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™å°±æ˜¯åŒ…å«çš„è¡Œé”ã€‚æ‰‹åŠ¨å–æ¶ˆ(ctrl + c)

5

insert into account values(25, 'linjian', 25000);  
\-- æ’å…¥id = 25åŒæ ·ä¼šé˜»å¡ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

6

insert into account values(29, 'linjian', 29000);  
\-- æ’å…¥id = 29åŒæ ·ä¼šé˜»å¡ï¼Œè¿›å…¥ç­‰å¾…æ‰§è¡ŒçŠ¶æ€

7

rollback;  
\-- å›æ»šäº‹åŠ¡

8

\-- å¦‚æœè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰è¶…æ—¶åˆ™æ‰§è¡Œæ’å…¥id = 29çš„è®°å½•

9

rollback;  
\-- å›æ»šäº‹åŠ¡

å¯ä»¥çœ‹åˆ°ä¸´é”®é”é”å®šçš„èŒƒå›´æ˜¯`(13,æ­£æ— ç©·]`ã€‚åŒæ ·æ˜¯å·¦å¼€å³é—­ï¼Œå–ä¸åˆ°13è€Œå–å¾—åˆ°æ­£æ— ç©·ã€‚

### 2\. æ— ç´¢å¼•è¡Œé”å‡çº§è¡¨é”

åºå·

session1

session2

1

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

2

update account set balance = balance + 1000 where name = 'itwxe';  
\-- è¿›è¡Œæ›´æ–°æ“ä½œï¼Œnameåˆ—æ²¡æœ‰ç´¢å¼•

select \* from account where id = 2;  
\-- å‡çº§è¡¨é”å¯ä»¥æŸ¥è¯¢

3

insert into account values(14, 'linjian', 13000);  
\-- å‡çº§è¡¨é”æ— æ³•æ’å…¥ï¼Œè¿›å…¥ç­‰å¾…çŠ¶æ€

4

rollback;  
\-- å›æ»šäº‹åŠ¡ï¼Œå½“ç„¶æäº¤ä¹Ÿå¯ä»¥

5

\-- å¦‚æœè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰è¶…æ—¶åˆ™æ‰§è¡Œæ’å…¥id = 14çš„è®°å½•

6

rollback;  
\-- å›æ»šäº‹åŠ¡ï¼Œå½“ç„¶æäº¤ä¹Ÿå¯ä»¥

çœ‹åˆ°è¿™é‡Œéƒ½æ˜¯è€å¿ƒçš„å°ä¼™ä¼´å•¦ï¼Œ**InnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹ç´¢å¼•åŠ çš„é”ï¼Œä¸æ˜¯é’ˆå¯¹è®°å½•åŠ çš„é”ã€‚å¹¶ä¸”è¯¥ç´¢å¼•ä¸èƒ½å¤±æ•ˆï¼Œå¦åˆ™ä¼šä»è¡Œé”å‡çº§ä¸ºè¡¨é”ã€‚**

æ‰€ä»¥ï¼Œå¦‚æœå¯¹éç´¢å¼•å­—æ®µæ›´æ–°ï¼Œè¡Œé”ä¼šå‡çº§æˆè¡¨é”ï¼Œå‡çº§æˆè¡¨é”åä»»æ„è¡Œçš„å†™æ“ä½œéƒ½ä¼šé˜»å¡ï¼Œç›´åˆ°è¡¨é”è¢«é‡Šæ”¾ã€‚

### 3\. è¡Œé”åˆ†æ

å¯ä»¥é€šè¿‡æ£€æŸ¥`innodb_row_lock`çŠ¶æ€å˜é‡æ¥åˆ†æMySQLè¡Œé”çš„æƒ…å†µã€‚

    show status like 'innodb_row_lock%'
    

![è¡Œé”åˆ†æ](https://img2022.cnblogs.com/blog/2358889/202203/2358889-20220316085002599-1666742485.png)

*   Innodb\_row\_lock\_current\_waitsï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡
*   Innodb\_row\_lock\_timeï¼šä»MySQLå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦
*   Innodb\_row\_lock\_time\_avgï¼šæ¯æ¬¡ç­‰å¾…çš„å¹³å‡æ—¶é—´
*   Innodb\_row\_lock\_time\_maxï¼šMySQLå¯åŠ¨åˆ°ç°åœ¨æœ€é•¿çš„ä¸€æ¬¡ç­‰å¾…æ—¶é—´
*   Innodb\_row\_lock\_waitsï¼šMySQLå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°

å½“ç­‰å¾…æ¬¡æ•°å¾ˆå¤šï¼Œå¹¶ä¸”æ¯æ¬¡ç­‰å¾…æ—¶é•¿ä¹Ÿå¾ˆé•¿æ—¶ï¼Œå°±è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœç€æ‰‹åˆ¶å®šä¼˜åŒ–è®¡åˆ’ã€‚

### 4\. ç³»ç»Ÿåº“ä¸é”ç›¸å…³çš„è¡¨

MySQLç³»ç»Ÿåº“ä¸­å‡ ä¸ªä¸é”ç›¸å…³çš„è¡¨ï¼Œæœ‰æ—¶å¼€å‘ä¸­debugè°ƒè¯•ç¢°åˆ°ä¸€ç›´å¡ç€SQLè¯­å¥ä¸æ‰§è¡Œï¼Œè¿™æ—¶å€™å®Œå…¨æœ‰å¯èƒ½æ˜¯å…¶ä»–å°ä¼™ä¼´ä¹Ÿåœ¨è°ƒè¯•è¿™ä¸€è¡Œæ•°æ®ï¼Œç„¶åä¸€ç›´é”å®šäº†é‚£è¡Œæ•°æ®æ‰€ä»¥ä½ å°±è°ƒè¯•ä¸ä¸‹å»äº†ï¼Œé‚£ä¹ˆå’‹åŠå˜ï¼Ÿ

MySQLç»™æˆ‘ä»¬æä¾›äº†è¡¨æ¥æŸ¥è¯¢ï¼Œåªè¦`kill`æ‰å…¶ä»–å°ä¼™ä¼´çš„äº‹åŠ¡è‡ªç„¶ä½ å°±å¯ä»¥è°ƒè¯•äº†ï¼Œä¸è¿‡è½»æ˜“ä¸è¦å°è¯•ï¼Œå› ä¸ºä½ `kill`æ‰é‚£ä¸ªäº‹åŠ¡åå…¶ä»–å°ä¼™ä¼´å¦‚æœæ²¡è°ƒè¯•å®Œé‚£ä¹ˆå°±ç™½è°ƒè¯•äº†ï¼Œæ‰€ä»¥è¢«æäº†å°äºŒæ¦‚ä¸è´Ÿè´£ğŸ˜‚

    â€â€ æŸ¥çœ‹äº‹åŠ¡
    select * from INFORMATION_SCHEMA.INNODB_TRX;
    
    â€â€ æŸ¥çœ‹é”
    select * from INFORMATION_SCHEMA.INNODB_LOCKS;
    
    â€â€ æŸ¥çœ‹é”ç­‰å¾…
    select * from INFORMATION_SCHEMA.INNODB_LOCK_WAITS;
    
    â€â€ é‡Šæ”¾é”ï¼Œtrx_mysql_thread_idæ˜¯INNODB_TRXè¡¨ä¸­æŸ¥è¯¢çš„ä¿¡æ¯çš„å€¼ï¼Œä¾‹å¦‚`kill 394`ï¼Œkillæ‰çš„äº‹åŠ¡æ— æ³•æäº¤ä¹Ÿæ— æ³•å›æ»šï¼Œä¼šåŒ…ERRORé”™è¯¯
    kill trx_mysql_thread_id;
    
    â€â€ æŸ¥çœ‹é”ç­‰å¾…è¯¦ç»†ä¿¡æ¯
    show engine innodb status\G;
    

### 5\. æ­»é”

åºå·

session1

session2

1

set tx\_isolation='repeatable-read';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»

set tx\_isolation='repeatable-read';  
\-- è®¾ç½®å½“å‰å›è¯äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»

2

begin;  
\-- å¼€å¯äº‹åŠ¡

begin;  
\-- å¼€å¯äº‹åŠ¡

3

select \* from account where id = 1 for update;  
\-- æ­£å¸¸æŸ¥è¯¢

select \* from account where id = 2 for update;  
\-- æ­£å¸¸æŸ¥è¯¢

4

select \* from account where id = 2 for update;  
\-- è¿›å…¥ç­‰å¾…çŠ¶æ€

select \* from account where id = 1 for update;  
\-- æŠ¥é”™ï¼Œæ£€æµ‹åˆ°æ­»é”ï¼Œé‡æ–°å¯åŠ¨äº‹åŠ¡  
\-- ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction

5

\-- å› ä¸ºsessionäº‹åŠ¡è¢«é‡å¯ï¼Œæ‰€ä»¥id = 2çš„è¡Œé”è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥æ²¡æœ‰è¶…æ—¶çš„æƒ…å†µä¸‹æ‰§è¡ŒæŸ¥è¯¢

rollback;

6

rollback;

![æ­»é”](https://img2022.cnblogs.com/blog/2358889/202203/2358889-20220316085002559-938327622.png)

å¤§å¤šæ•°æƒ…å†µä¸‹MySQLå¯ä»¥è‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šäº§ç”Ÿæ­»é”çš„é‚£ä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µMySQLæ²¡æ³•è‡ªåŠ¨æ£€æµ‹æ­»é”ã€‚

### 6\. é”ä¼˜åŒ–å»ºè®®

*   å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”ã€‚
*   å°½å¯èƒ½å‡å°‘æ£€ç´¢æ¡ä»¶èŒƒå›´ï¼Œé¿å…é—´éš™é”ã€‚
*   å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦ï¼Œæ¶‰åŠäº‹åŠ¡åŠ é”çš„sqlå°½é‡æ”¾åœ¨äº‹åŠ¡æœ€åæ‰§è¡Œã€‚