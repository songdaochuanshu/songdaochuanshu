---
layout: post
title: "Kubernetesï¼šIngressæ€»ç»“(ä¸€)"
date: "2022-03-17T13:24:58.918Z"
---
Kubernetesï¼šIngressæ€»ç»“(ä¸€)
=======================

Kubernetesçš„Ingressç®€å•ç†è§£å°±æ˜¯ä¸ªè§„åˆ™å®šä¹‰ï¼Œä¾‹å¦‚æŸä¸ªåŸŸåå¯¹åº”æŸä¸ªServiceï¼Œå³å½“æŸä¸ªåŸŸåçš„è¯·æ±‚è¿›æ¥æ—¶ï¼Œè½¬å‘ç»™æŸä¸ªServiceã€‚Ingress Controllerè´Ÿè´£å®ç°è¿™ä¸ªè§„åˆ™ï¼Œå³Ingress Controllerå°†å…¶åŠ¨æ€å†™å…¥è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®ä¸­ï¼Œä»è€Œå®ç°æœåŠ¡çš„è´Ÿè½½å‡è¡¡ã€‚

> Blogï¼š[åšå®¢å›­](https://www.cnblogs.com/Rohn/) [ä¸ªäºº](https://k8sdev.com/)  
> å‚è€ƒï¼š[Ingress | Kubernetes](https://kubernetes.io/zh/docs/concepts/services-networking/ingress/)ã€ã€ŠKubernetesè¿›é˜¶å®æˆ˜ã€‹ã€ã€ŠKubernetesç½‘ç»œæƒå¨æŒ‡å— ã€‹

ä½•è°“Ingressï¼Ÿä»å­—é¢æ„æ€è§£è¯»ï¼Œå°±æ˜¯**å…¥ç«™æµé‡**ã€‚Kubernetesçš„Ingressèµ„æºå¯¹è±¡æ˜¯æŒ‡**æˆæƒå…¥ç«™è¿æ¥åˆ°è¾¾é›†ç¾¤å†…æœåŠ¡çš„è§„åˆ™é›†åˆ**ã€‚

æˆ‘ä»¬çŸ¥é“ï¼ŒKubernetesä¸Šçš„NodePortå’ŒLoadBalancerç±»å‹çš„Serviceèµ„æºèƒ½å¤ŸæŠŠé›†ç¾¤å†…éƒ¨æœåŠ¡æš´éœ²ç»™é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯è®¿é—®ï¼Œä½†ä¸¤ä¸ªè´Ÿè½½å‡è¡¡è·ƒç‚¹(è·¯ç”±)å¿…ç„¶äº§ç”Ÿæ›´å¤§çš„ç½‘ç»œå»¶è¿Ÿï¼Œä¸”æ— ç–‘ä¼šå¤§å¤§å¢åŠ ç»„ç»‡åœ¨ä½¿ç”¨äº‘æœåŠ¡æ–¹é¢çš„è´¹ç”¨å¼€é”€ã€‚

å› æ­¤ï¼ŒKubernetesä¸ºè¿™ç§éœ€æ±‚æä¾›äº†ä¸€ç§æ›´ä¸ºé«˜çº§çš„æµé‡ç®¡ç†çº¦æŸæ–¹å¼ï¼Œå°¤å…¶æ˜¯å¯¹HTTP/HTTPSåè®®çš„çº¦æŸã€‚Kubernetesä½¿ç”¨Ingressæ§åˆ¶å™¨ä½œä¸ºç»Ÿä¸€çš„æµé‡å…¥å£ï¼Œç®¡ç†å†…éƒ¨å„ç§å¿…è¦çš„æœåŠ¡ï¼Œå¹¶é€šè¿‡Ingressè¿™ä¸€APIèµ„æºæ¥æè¿°å¦‚ä½•åŒºåˆ†æµé‡ä»¥åŠå†…éƒ¨çš„è·¯ç”±é€»è¾‘ã€‚æœ‰äº†Ingresså’ŒIngressæ§åˆ¶å™¨ï¼Œæˆ‘ä»¬å°±å¯é€šè¿‡å®šä¹‰è·¯ç”±æµé‡çš„è§„åˆ™æ¥å®ŒæˆæœåŠ¡å‘å¸ƒï¼Œè€Œæ— é¡»åˆ›å»ºä¸€å †NodePortæˆ–LoadBalancerç±»å‹çš„Serviceï¼Œè€Œä¸”æµé‡ä¹Ÿä¼šç”±Ingressæ§åˆ¶å™¨ç›´æ¥åˆ°è¾¾Podå¯¹è±¡ã€‚

Kubernetes Ingressæä¾›äº†è´Ÿè½½å¹³è¡¡å™¨çš„å…¸å‹ç‰¹æ€§ï¼šHTTPè·¯ç”±ã€é»æ€§ä¼šè¯ã€SSLç»ˆæ­¢ã€SSLç›´é€šã€TCPå’ŒUDPè´Ÿè½½å¹³è¡¡ç­‰ã€‚ç›®å‰ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„Ingress Controlleréƒ½å®ç°äº†è¿™äº›åŠŸèƒ½ï¼Œéœ€è¦æŸ¥çœ‹å…·ä½“çš„Ingress Controlleræ–‡æ¡£ã€‚Ingressæ§åˆ¶å™¨æœ‰å„ç§ç±»å‹ï¼ŒåŒ…æ‹¬GoogleCloud Load Balancerã€Nginxã€Istioç­‰ã€‚æœ‰äº›Ingress Controllerå¯èƒ½è¿˜ä¾èµ–å„ç§æ’ä»¶ï¼Œä¾‹å¦‚cert-managerï¼Œå®ƒå¯ä»¥ä¸ºæœåŠ¡è‡ªåŠ¨æä¾›SSLè¯ä¹¦ã€‚

> ğŸ’¡Tipsï¼šäººä»¬é€šå¸¸æŠŠKubernetesé›†ç¾¤å†…éƒ¨çš„é€šä¿¡ç§°ä¸ºä¸œè¥¿å‘æµé‡ï¼Œè€ŒæŠŠé›†ç¾¤å†…å¤–éƒ¨çš„é€šä¿¡ç§°ä¸ºå—åŒ—å‘æµé‡ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå°†æ‰€æœ‰æµé‡éƒ½å‘é€åˆ°åŒä¸€ Service çš„ç®€å• Ingress ç¤ºä¾‹ï¼š

![image-20220317141340808](https://rohn-web.oss-cn-hangzhou.aliyuncs.com/img/blog/image-20220317141340808.png?x-oss-process=style/cnblog)

é€šå¸¸æƒ…å†µä¸‹ï¼ŒServiceå’ŒPodä»…å¯åœ¨é›†ç¾¤å†…éƒ¨ç½‘ç»œä¸­é€šè¿‡IPåœ°å€è®¿é—®ã€‚æ‰€æœ‰åˆ°è¾¾è¾¹ç•Œè·¯ç”±çš„æµé‡æˆ–è¢«ä¸¢å¼ƒæˆ–è¢«è½¬å‘åˆ°å…¶ä»–åœ°æ–¹ã€‚

Ingressçš„ä½œç”¨å°±æ˜¯åœ¨è¾¹ç•Œè·¯ç”±å¤„å¼€ä¸ªå£å­ï¼Œæ”¾å¤–éƒ¨æµé‡è¿›æ¥ã€‚å› æ­¤ï¼ŒIngressæ˜¯å»ºç«‹åœ¨Serviceä¹‹ä¸Šçš„L7è®¿é—®å…¥å£ï¼Œå®ƒæ”¯æŒé€šè¿‡URLçš„æ–¹å¼å°†Serviceæš´éœ²åˆ°k8sé›†ç¾¤å¤–ï¼›æ”¯æŒè‡ªå®šä¹‰Serviceçš„è®¿é—®ç­–ç•¥ï¼›æä¾›æŒ‰åŸŸåè®¿é—®çš„è™šæ‹Ÿä¸»æœºåŠŸèƒ½ï¼›æ”¯æŒTLSé€šä¿¡ã€‚

### Ingressè§„åˆ™

æ¯ä¸ª HTTP è§„åˆ™éƒ½åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

*   å¯é€‰çš„ `host`ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒæœªæŒ‡å®š `host`ï¼Œå› æ­¤è¯¥è§„åˆ™é€‚ç”¨äºé€šè¿‡æŒ‡å®š IP åœ°å€çš„æ‰€æœ‰å…¥ç«™ HTTP é€šä¿¡ã€‚ å¦‚æœæä¾›äº† `host`ï¼ˆä¾‹å¦‚ foo.bar.comï¼‰ï¼Œåˆ™ `rules` é€‚ç”¨äºè¯¥ `host`ã€‚
*   è·¯å¾„åˆ—è¡¨ pathsï¼ˆä¾‹å¦‚ï¼Œ`/testpath`ï¼‰,æ¯ä¸ªè·¯å¾„éƒ½æœ‰ä¸€ä¸ªç”± `serviceName` å’Œ `servicePort` å®šä¹‰çš„å…³è”åç«¯ã€‚ åœ¨è´Ÿè½½å‡è¡¡å™¨å°†æµé‡å®šå‘åˆ°å¼•ç”¨çš„æœåŠ¡ä¹‹å‰ï¼Œä¸»æœºå’Œè·¯å¾„éƒ½å¿…é¡»åŒ¹é…ä¼ å…¥è¯·æ±‚çš„å†…å®¹ã€‚
*   `backend`ï¼ˆåç«¯ï¼‰æ˜¯ [Kubernetesï¼šæœåŠ¡ä¸è´Ÿè½½å‡è¡¡](https://www.cnblogs.com/Rohn/p/16012857.html)ä¸­æ‰€è¿°çš„æœåŠ¡å’Œç«¯å£åç§°çš„ç»„åˆã€‚ ä¸è§„åˆ™çš„ `host` å’Œ `path` åŒ¹é…çš„å¯¹ Ingress çš„ HTTPï¼ˆå’Œ HTTPS ï¼‰è¯·æ±‚å°†å‘é€åˆ°åˆ—å‡ºçš„ `backend`ã€‚

é€šå¸¸åœ¨ Ingress æ§åˆ¶å™¨ä¸­ä¼šé…ç½® `defaultBackend`ï¼ˆé»˜è®¤åç«¯ï¼‰ï¼Œä»¥æœåŠ¡äºä»»ä½•ä¸ç¬¦åˆè§„çº¦ä¸­ `path` çš„è¯·æ±‚ã€‚

> ğŸ’¡æ³¨æ„ï¼šæ²¡æœ‰ `rules` çš„ Ingress å°†æ‰€æœ‰æµé‡å‘é€åˆ°åŒä¸€ä¸ªé»˜è®¤åç«¯ã€‚å¦‚æœ `hosts` æˆ– `paths` éƒ½æ²¡æœ‰ä¸ Ingress å¯¹è±¡ä¸­çš„ HTTP è¯·æ±‚åŒ¹é…ï¼Œåˆ™æµé‡å°†è·¯ç”±åˆ°é»˜è®¤åç«¯ã€‚

### è·¯å¾„ç±»å‹

Ingress ä¸­çš„æ¯ä¸ªè·¯å¾„éƒ½éœ€è¦æœ‰å¯¹åº”çš„è·¯å¾„ç±»å‹ï¼ˆPath Typeï¼‰ã€‚æœªæ˜ç¡®è®¾ç½® `pathType` çš„è·¯å¾„æ— æ³•é€šè¿‡åˆæ³•æ€§æ£€æŸ¥ã€‚å½“å‰æ”¯æŒçš„è·¯å¾„ç±»å‹æœ‰ä¸‰ç§ï¼š

*   `ImplementationSpecific`ï¼šå¯¹äºè¿™ç§è·¯å¾„ç±»å‹ï¼ŒåŒ¹é…æ–¹æ³•å–å†³äº IngressClassã€‚ å…·ä½“å®ç°å¯ä»¥å°†å…¶ä½œä¸ºå•ç‹¬çš„ `pathType` å¤„ç†æˆ–è€…ä¸ `Prefix` æˆ– `Exact` ç±»å‹ä½œç›¸åŒå¤„ç†ã€‚
*   `Exact`ï¼šç²¾ç¡®åŒ¹é… URL è·¯å¾„ï¼Œä¸”åŒºåˆ†å¤§å°å†™ã€‚
*   `Prefix`ï¼šåŸºäºä»¥ `/` åˆ†éš”çš„ URL è·¯å¾„å‰ç¼€åŒ¹é…ã€‚åŒ¹é…åŒºåˆ†å¤§å°å†™ï¼Œå¹¶ä¸”å¯¹è·¯å¾„ä¸­çš„å…ƒç´ é€ä¸ªå®Œæˆã€‚ è·¯å¾„å…ƒç´ æŒ‡çš„æ˜¯ç”± `/` åˆ†éš”ç¬¦åˆ†éš”çš„è·¯å¾„ä¸­çš„æ ‡ç­¾åˆ—è¡¨ã€‚ å¦‚æœæ¯ä¸ª _p_ éƒ½æ˜¯è¯·æ±‚è·¯å¾„ _p_ çš„å…ƒç´ å‰ç¼€ï¼Œåˆ™è¯·æ±‚ä¸è·¯å¾„ _p_ åŒ¹é…ã€‚

> ğŸ’¡æ³¨æ„ï¼šå¦‚æœè·¯å¾„çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯è¯·æ±‚è·¯å¾„ä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„å­å­—ç¬¦ä¸²ï¼Œåˆ™ä¸ä¼šåŒ¹é… ï¼ˆä¾‹å¦‚ï¼š`/foo/bar` åŒ¹é… `/foo/bar/baz`, ä½†ä¸åŒ¹é… `/foo/barbaz`ï¼‰ã€‚

ä¾‹å¦‚ï¼š

ç±»å‹

è·¯å¾„

è¯·æ±‚è·¯å¾„

åŒ¹é…ä¸å¦ï¼Ÿ

Prefix

`/`

ï¼ˆæ‰€æœ‰è·¯å¾„ï¼‰

æ˜¯

Exact

`/foo`

`/foo`

æ˜¯

Exact

`/foo`

`/bar`

å¦

Exact

`/foo`

`/foo/`

å¦

Exact

`/foo/`

`/foo`

å¦

Prefix

`/foo`

`/foo`, `/foo/`

æ˜¯

Prefix

`/foo/`

`/foo`, `/foo/`

æ˜¯

Prefix

`/aaa/bb`

`/aaa/bbb`

å¦

Prefix

`/aaa/bbb`

`/aaa/bbb`

æ˜¯

Prefix

`/aaa/bbb/`

`/aaa/bbb`

æ˜¯ï¼Œå¿½ç•¥å°¾éƒ¨æ–œçº¿

Prefix

`/aaa/bbb`

`/aaa/bbb/`

æ˜¯ï¼ŒåŒ¹é…å°¾éƒ¨æ–œçº¿

Prefix

`/aaa/bbb`

`/aaa/bbb/ccc`

æ˜¯ï¼ŒåŒ¹é…å­è·¯å¾„

Prefix

`/aaa/bbb`

`/aaa/bbbxyz`

å¦ï¼Œå­—ç¬¦ä¸²å‰ç¼€ä¸åŒ¹é…

Prefix

`/`, `/aaa`

`/aaa/ccc`

æ˜¯ï¼ŒåŒ¹é… `/aaa` å‰ç¼€

Prefix

`/`, `/aaa`, `/aaa/bbb`

`/aaa/bbb`

æ˜¯ï¼ŒåŒ¹é… `/aaa/bbb` å‰ç¼€

Prefix

`/`, `/aaa`, `/aaa/bbb`

`/ccc`

æ˜¯ï¼ŒåŒ¹é… `/` å‰ç¼€

Prefix

`/aaa`

`/ccc`

å¦ï¼Œä½¿ç”¨é»˜è®¤åç«¯

æ··åˆ

`/foo` (Prefix), `/foo` (Exact)

`/foo`

æ˜¯ï¼Œä¼˜é€‰ Exact ç±»å‹

åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒIngress ä¸­çš„å¤šæ¡è·¯å¾„ä¼šåŒ¹é…åŒä¸€ä¸ªè¯·æ±‚ã€‚ è¿™ç§æƒ…å†µä¸‹æœ€é•¿çš„åŒ¹é…è·¯å¾„ä¼˜å…ˆã€‚ å¦‚æœä»ç„¶æœ‰ä¸¤æ¡åŒç­‰çš„åŒ¹é…è·¯å¾„ï¼Œåˆ™ç²¾ç¡®è·¯å¾„ç±»å‹ä¼˜å…ˆäºå‰ç¼€è·¯å¾„ç±»å‹ã€‚

### ä¸»æœºåé€šé…ç¬¦

ä¸»æœºåå¯ä»¥æ˜¯ç²¾ç¡®åŒ¹é…ï¼ˆä¾‹å¦‚â€œ`foo.bar.com`â€ï¼‰æˆ–è€…ä½¿ç”¨é€šé…ç¬¦æ¥åŒ¹é… ï¼ˆä¾‹å¦‚â€œ`*.foo.com`â€ï¼‰ã€‚ ç²¾ç¡®åŒ¹é…è¦æ±‚ HTTP `host` å¤´éƒ¨å­—æ®µä¸ `host` å­—æ®µå€¼å®Œå…¨åŒ¹é…ã€‚ é€šé…ç¬¦åŒ¹é…åˆ™è¦æ±‚ HTTP `host` å¤´éƒ¨å­—æ®µä¸é€šé…ç¬¦è§„åˆ™ä¸­çš„åç¼€éƒ¨åˆ†ç›¸åŒã€‚

ä¸»æœº

host å¤´éƒ¨

åŒ¹é…ä¸å¦ï¼Ÿ

`*.foo.com`

`bar.foo.com`

åŸºäºç›¸åŒçš„åç¼€åŒ¹é…

`*.foo.com`

`baz.bar.foo.com`

ä¸åŒ¹é…ï¼Œé€šé…ç¬¦ä»…è¦†ç›–äº†ä¸€ä¸ª DNS æ ‡ç­¾

`*.foo.com`

`foo.com`

ä¸åŒ¹é…ï¼Œé€šé…ç¬¦ä»…è¦†ç›–äº†ä¸€ä¸ª DNS æ ‡ç­¾

### Ingressç±»å‹

#### å•ä¸ªServiceå®ç°

ç°æœ‰çš„ Kubernetes æ¦‚å¿µå…è®¸ä½ æš´éœ²å•ä¸ª Serviceï¼Œä¾‹å¦‚ï¼š

    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: test-ingress
    spec:
      defaultBackend:
        service:
          name: test
          port:
            number: 80
    

æ‰§è¡Œï¼š

    [root@master test]# kubectl apply -f ./test-ingress.yaml 
    ingress.networking.k8s.io/test-ingress created
    

#### ç®€å•æ‰‡å‡º(Simple fanout)

ä¸€ä¸ªæ‰‡å‡ºï¼ˆfanoutï¼‰é…ç½®æ ¹æ®è¯·æ±‚çš„ HTTP URI å°†æ¥è‡ªåŒä¸€ IP åœ°å€çš„æµé‡è·¯ç”±åˆ°å¤šä¸ª Serviceã€‚ Ingress å…è®¸ä½ å°†è´Ÿè½½å‡è¡¡å™¨çš„æ•°é‡é™è‡³æœ€ä½ã€‚ä¾‹å¦‚ï¼Œè¿™æ ·çš„è®¾ç½®ï¼š

![image-20220317143027055](https://rohn-web.oss-cn-hangzhou.aliyuncs.com/img/blog/image-20220317143027055.png?x-oss-process=style/cnblog)

é…ç½®å¦‚ä¸‹ï¼š

    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: simple-fanout-example
    spec:
      rules:
      - host: foo.bar.com
        http:
          paths:
          - path: /foo
            pathType: Prefix
            backend:
              service:
                name: service1
                port:
                  number: 4200
          - path: /bar
            pathType: Prefix
            backend:
              service:
                name: service2
                port:
                  number: 8080
    

#### åŸºäºåç§°çš„è™šæ‹Ÿæ‰˜ç®¡(Name based virtual hosting)

åŸºäºåç§°çš„è™šæ‹Ÿä¸»æœºæ”¯æŒå°†é’ˆå¯¹å¤šä¸ªä¸»æœºåçš„ HTTP æµé‡è·¯ç”±åˆ°åŒä¸€ IP åœ°å€ä¸Šã€‚

![image-20220317145747418](https://rohn-web.oss-cn-hangzhou.aliyuncs.com/img/blog/image-20220317145747418.png?x-oss-process=style/cnblog)

### æ€»ç»“

Kubernetesçš„Ingressç®€å•ç†è§£å°±æ˜¯ä¸ªè§„åˆ™å®šä¹‰ï¼Œä¾‹å¦‚æŸä¸ªåŸŸåå¯¹åº”æŸä¸ªServiceï¼Œå³å½“æŸä¸ªåŸŸåçš„è¯·æ±‚è¿›æ¥æ—¶ï¼Œè½¬å‘ç»™æŸä¸ªServiceã€‚Ingress Controllerè´Ÿè´£å®ç°è¿™ä¸ªè§„åˆ™ï¼Œå³Ingress Controllerå°†å…¶åŠ¨æ€å†™å…¥è´Ÿè½½å‡è¡¡å™¨çš„é…ç½®ä¸­ï¼Œä»è€Œå®ç°æœåŠ¡çš„è´Ÿè½½å‡è¡¡ã€‚