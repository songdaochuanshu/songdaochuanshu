---
layout: post
title: "C#处理医学影像(三):基于漫水边界自动选取病灶范围的实现思路"
date: "2022-03-18T10:58:14.640Z"
---
C#处理医学影像(三):基于漫水边界自动选取病灶范围的实现思路
===============================

开发背景：

医生在实际使用PACS软件观察病灶时，经常会测量不规则病灶的周长和面积，使用画笔工具勾勒比较耗时且准度欠佳，

或者在标记人工智能训练样本时少则几百张，多则几千张，为极大减少耗时和极大提高工作效率，故开发此功能用来自动勾勒病灶范围并自动测量。

国际惯例，先看效果：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318154540737-87714606.png)

思路流程概览：

①以鼠标按下作为漫水算法中心点向外扩散填充

②裁剪最大外接矩形，缩小计算范围

③灰度转换

④Canny算子或Sobel算子提取轮廓

⑤背景降噪

⑥提取边界轮廓

⑦设置容差范围

⑧可变多边形坐标转化

⑨缩放、平移、旋转后的坐标映射

准备一张样本并以手臂骨头作为假设病灶：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318155620913-826513509.png)

①以鼠标按下作为漫水算法中心点向外扩散填充

通过给定指定的中心坐标，和指定染色的颜色值，向四周扩撒，遇到一样或近似值将其包含在范围内，网上源码很多，很容易实现。

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318160604148-413149739.png)

②裁剪最大外接矩形，缩小计算范围

将漫水填充范围的最大外接矩形裁剪出来，提高后续计算效率。

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318160711637-832509996.png)

③灰度转换

转换成灰度图，为后续计算做准备。

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318160814607-922214327.png)

④Canny算子或Sobel算子进行边缘检测

Canny算子和Sobel算子区别：

Canny算子：

在计算前先将图像进行高斯滤波转换，得到一个相对模糊的图像，使得噪点在平滑过度时的影响降到最低：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318161625822-345599523.png)

根据算法原理得到如下结果：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318161746611-1519958960.png)![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318161825787-1588514409.png)

Sobel算子：

根据算法原理得到如下结果：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318161929647-1535266017.png)![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318162008102-2088673447.png)

其中直观区别是canny算子计算的结果清晰，但不连续，容易受噪点影响，而sobel算子线条相对柔和，连续性强。

⑤背景降噪

进行一次手动背景降噪，使得展现的无用边缘更少，结果更清晰：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318162452740-1774395355.png)![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318162501036-681819382.png)![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318162430341-587803873.png)

⑥提取边界轮廓

经过上面的计算后会得到一个边界坐标集合记为List<Point> list;

这些点是不连续的，不首尾相连的，我们需要将非边缘坐标删除，并将边缘坐标按顺时针或逆时针排序；

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318163751085-92520330.png)

此时虽然得到了边缘坐标，但他是非连续性的，当我们把这些点连起来的时候就会出现问题：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318163908640-1499612101.png)

所以我们将这些边缘坐标按逆时针或顺时针排序：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318164041414-1792528003.png)

⑦在界面上增加滑块控件并设置容差范围

当碰到边界不是很清晰的时候，我们需要调整容差范围，以影响漫水扩散时的范围准确性：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318164344770-265665405.png)

观察容差范围10和20的区别：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318164543304-580940811.png)![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318164550880-323153772.png)

⑧可变多边形坐标转化

根据本系列教程的测量工具开发，在此基础上我们将标识的范围转化为可变多边形：

微调结果并显示周长和面积：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318170154924-1932648126.gif)

⑨缩放、平移、旋转后的坐标映射

当图像发生放大、平移、旋转时，要注意边缘坐标的映射以保证结果正确：

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318170513746-1926413389.png)

配合色彩增强，食用效果更佳！

![](https://img2022.cnblogs.com/blog/1083581/202203/1083581-20220318170701296-1441886202.png)