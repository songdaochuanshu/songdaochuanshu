---
layout: post
title: "面试官：Redis集群有哪些方式，Leader选举又是什么原理呢？"
date: "2022-03-17T20:44:33.673Z"
---
面试官：Redis集群有哪些方式，Leader选举又是什么原理呢？
=================================

> 哈喽！大家好，我是小奇，一位不靠谱的程序员  
> 小奇打算以轻松幽默的对话方式来分享一些技术，如果你觉得通过小奇的文章学到了东西，那就给小奇一个赞吧  
> 文章持续更新

一、前言
====

> 作为一名Java程序员，Redis底层的一些原理是我们**不必学会**就可以搬砖工作的一种技能点，但是小奇为什么还要讲一下呢？难道就是为了浪费大家**1分钟**的宝贵时间，一个人1分钟，50万人就是**1年**，5000万人就是**100年**，赚了，小奇以一己之力成功搞挂一个人（血赚）。

> 当然不是，并且小奇的文章也没有那么多人看，最多也就浪费个**肾**吧。

> 学习Redis底层原理是因为**面试官要问啊**！，所以我们就要学，什么？不实用的你不学？那邻居小奇可要使劲学啦，到时候面试官只要小奇不要你。  
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/ea5d1dd3447c4edc93da369790a1467b.png)

> 至于你问为什么面试官要问Redis底层原理呢，这个。。。我把这次机会留给你，下次你面试的时候面试官问：“讲一下Redis底层原理”。你：“面试官你好，请问为什么你要问Redis底层原理呢，你给我台电脑，我**五分钟**给你搭建好**图书管理系统**他不香吗，咱们键盘上见真章”。这时面试官就会告诉你答案，你就可以把答案打在评论区，让小奇以及众多小伙伴一起知道一下到底为什么要问？  
>   
>   
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/61cee6fb1a0540269595b92529d1a843.png#pic_center)

二、面试
====

> 在一个晴朗的周日，我来到了一个陌生的园区（别问为什么是周日，问就是997，不过为了填饱肚子的打工人，只能明知山有虎、偏向虎山行），坐在陌生的会议室，等待HR小姐姐去叫面试官，此时我的心情和各位小伙伴一样五味杂陈，**担心面试官问的会不会很难？问到我的知识盲区我该怎么办？一会自我介绍的时候要不要吹一下我和小奇的关系？**

> 一位英俊潇洒，眼神犀利的面试官走了进来，看到他那犀利、仿佛能看穿一切的眼神 ，我在想要不然一会就不要20k了，要8k得了，这个面试官一看就不好糊弄啊，但是我想起来我来之前刚看了小奇的趣学编程系列，我已经完全学会了小奇的精髓，我顿时就来了底气，决定一会要30k，不给就学小奇赖着不走（哈哈）

> **面试官：小奇是吧，带简历了吗？**

> 我：没带，现在彩印两块一张，我简历五张，每次面试都要花费十块，我朋友说了还没工作就先让你掏钱的工作不要去。

> **面试官：。。。那你靠什么来征服我，让我录用你**

> 我：气质？  
> ![请添加图片描述](https://img-blog.csdnimg.cn/c701ee9e709b404786e268dd06ebfce3.png)

> （此时面试官并没有叫保安，而是从门后拿出了恭候我多时的棍子，我瞬间怂了）  
>   
>   
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/c437a81c80b3446a93aa90c998434365.png#pic_center)

> 我只好从我的双肩包中拿出了我上午从其他公司面试官手中**要回的简历**，上午的情形是这样的。  
>   
>   
> **上午的面试官：今天的面试就到这吧，回去等通知吧！**  
>   
>   
> 我：面试官你好，如果贵公司不打算录取我的话，**能不能把我的纸质简历还给我**，我下午还有一家面试。  
>   
>   
> **上午的面试官：我说你的简历怎么皱皱巴巴，原来你一直在循环利用啊！这个症状出现多久了？**  
>   
>   
> 我：**半拉月了**。。。  
>   
>   
> （当我把皱皱巴巴的简历交给面试官后，这场面试才得以继续进行。。。）

三、Redis哨兵集群
===========

> **面试官：我看你简历上写的精通Redis？（哼，面试官轻蔑的一笑）**

> （看着面试官轻蔑的笑容，我忍不住拿出了我的Redis书籍推给了他）

> 我：这本书我倒背如流，你随便提问，答不上来算我输，答上来你就要为你的轻蔑向我道歉。  
>   
>   
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/b567f68310c54b8fad2c4a2e695a0aa2.png#pic_center)

> （我的笑容逐渐自信。。。）  
>   
>   
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/8f1c7a6ee84c4a449e9d6fedae5a37e5.gif#pic_center)

> （此时面试官看着书若有所思，我怀疑他肯定在想他对这本书的了解程度吧）

> **面试官：好吧，那你先说一下Redis有哪些集群方式呢**

> 我：Redis主要有两种持集群方式，哨兵集群和Cluster（高可用）集群。

> **面试官：可以说一说两者的区别和如何配置使用吗**

> 我：上次面试我已经简单说了一下哨兵模式，现在再来简单看一下  
> ![在这里插入图片描述](https://img-blog.csdnimg.cn/d1f8039c0e8348ba91022e42b49dc7b5.png)

> 这里我们可以看到客户端只能连接一个哨兵集群，也就是说客户端在写入数据的时候只能通过哨兵集群告诉的地址来进行写入

> 假如主节点挂了，那么哨兵选举一个从节点成为主节点，在这期间客户端来访问是被阻塞的，因为主节点正在被选举，还不知道谁是主节点呢，怎么插入数据。

> 那么为了解决这个问题，我们可以使用高可用集群模式Cluster模式，也可以称之为多个主从节点（主从节点上一章讲过）模式集群

四、Redis高可用集群Cluster模式
=====================

> **面试官：能说一下高可用集群模式具体是怎么一个流程吗，为什么可以解决选举等待问题？**

> 我：（能不说吗。。。）

![在这里插入图片描述](https://img-blog.csdnimg.cn/690b4fa76ee54c8c9818e3b5486cd79e.png)

> 通过图中可以看出我们客户端通过访问入口可以访问多个主节点，如果其中一个主节点挂了，那么其他的主节点还可以正常工作不受影响。

> **面试官：这么多主节点，我哪知道我set一个数据应该放入到哪个主从结构里面呢？**

> 我：（你随机放一个不就行了吗。。。不对，随机放一个取的时候就不知道去哪个主从结构里去取了，总不能每一个主节点里面都去查找一遍吧）

> 我：他会根据要set进去的key进行一个hash计算，计算完后就知道要往哪个主节点里面存放值了，取得时候也根据key进行一个hash计算，就知道去哪个主节点里拿取了。

![在这里插入图片描述](https://img-blog.csdnimg.cn/bd1f945ec19242d5a36f7ca647280edf.png)

> **面试官：那这个时候来一个age计算hash是150要插入哪个主节点**

> 我：肯定是第二个主节点啊，redis集群采用分片模式，将所有数据分片放入多个主节点中，方便与水平扩展。

> **面试官：如果主节点挂了，哨兵模式下哨兵集群会选举出一个主节点，那你这种高可用模式，如果一个主节点挂了，怎么选举呢？**

> 我：（应该是按照大小个吧。。。）

![在这里插入图片描述](https://img-blog.csdnimg.cn/1b5d809ac9224ca2970fd73f93bd4d2f.webp#pic_center)

> **面试官：你特么找打是吧，数据那特么有大小个。。。**

![在这里插入图片描述](https://img-blog.csdnimg.cn/30001dd8dccc49858df69527e465adda.webp#pic_center)

五、Leader选举原理
============

> 我：这个时候就需要其他主节点来支持选举了，我来用一张图描述一下。

![在这里插入图片描述](https://img-blog.csdnimg.cn/1202536491684f379854c74a6255fd21.png)

> 我：我们可以把这三个主从节点看做是**三个国家**，如果一个国家的头目挂掉了，那么他底下其中一股势力就会找其他的国家头目来支持自己成为头目。

> 我：当然其他国家的头目不会看你国家这两股势力哪个好哪个坏，而是哪个先找我我就支持你。

> 我：而且图中有三个国家，支持自己的票数必须超过总国家的一半以上，也就是最少要有两票支持，所以redis集群节点最少要三个主从结构，不然的话两个没办法选举，票数最多一票不够两个国家的半数以上。

![在这里插入图片描述](https://img-blog.csdnimg.cn/2e0410c42d1a4030b419183e2c1df3a0.png#pic_center)

> **面试官：还别说你小子使用这个图讲的是有声有色**

> 我：你这不废话吗，趣学编程不趣学那还学个屌。。。

> **面试官：那塔利班和正规军他们两个怎么确定谁先发出请求呢，肯定是谁先发出消息谁赢呗？**

> 我：他们两个小势力并不是头目挂了就立马发出请求支持消息，而是有一定的延迟时间，这个延迟时间根据一个公式计算，公式中包含随机数，和根据SLAVE\_RANK的大小来计算，SLAVE\_RANK的大小表示从节点从主节点同步的数据总量的Rank。Rank越小代表一复制的数据越新，可以做主节点。

> 延迟公式：DELAY = 500ms +random(0 ~ 500ms) + SLAVE\_RANK \* 1000ms

> **面试官：假如现在网络抖动，从节点一瞬间连接不上主节点了，他就开始发送消息，网络好了以后不就有两个主节（俗称脑裂，主节点相当于一个主从结构的大脑，只能有一个）点了吗？**

> 我：那我们可以配置连接不上的时间让他长一点，通过cluster-node-timeout来配置，假如配置5秒钟，那么5秒钟之内从节点连接不上主节点是不会发起请求支持的信息的。

> **面试官：万一5秒不够呢，万一我网络抖动的厉害呢？**

> 我：你是食堂阿姨吗，手抖的这么厉害。。。

![在这里插入图片描述](https://img-blog.csdnimg.cn/92922d1596b14eddbd55b43697598181.webp#pic_center)

> 我：你说的这种情况属于一瞬间有两个主节点都在写入新的数据，那么等网络恢复以后只会将一个节点作为主节点，其他节点变为从节点过来同步，那么就会丢失一部分数据。

![在这里插入图片描述](https://img-blog.csdnimg.cn/852d75ad554340958bb3a4c09e6f8514.png)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/3a7973936278402ea9970dea5087561f.png)

> 我：这里我们会发现**age 20数据丢失了**，那这个怎么办呢，我们可以通过一个配置**min‐replicas‐to‐write \[数量\]**，这个配置是写的数据最少同步的从节点数量。

> 假如我这里配置的是1，那么就是我写入一个值最少有一个从节点同步到了这个值才算写入成功，不然就是写入失败。

> 这样的话就可以解决上述问题，当网络抖动主节点无法给从节点同步数据的时候就写入失败，不会造成丢失数据，但是这种配置非常影响性能，不建议使用。

> **面试官：如果redis集群中一个主从结构全部挂了，这个redis集群还可以使用吗？**

> 我：我们可以配置**cluster-require-full-coverage 为no**，这样只是一个主从结构全部挂了不影响其他主从结构的使用，如果为yes，一个主从结构挂了整个redis集群就不能用了。

> **面试官：Redis集群为什么至少需要三个主节点，并且推荐节点数为奇数？**

> 我：上面我们说过如果是两个主节点，那么其中一个主节点挂了，剩下活着的主节点**只有一个了**，没有达到**总数的一半以上**，投票也不好使啊，挂了的主节点那里还是选举不出来新的主节点。

> 另外假如是4台主节点，那么他跟三台主节点一样都是最多只能挂一个主节点，如果同时挂两个主节点，那么剩下活着的主节点也无法超过总数的一半，所以按照性价比来说，奇数主节点性价比更高，不过贵公司要是土豪，愿意弄几个主节点就弄几个吧。。。

![在这里插入图片描述](https://img-blog.csdnimg.cn/4996bb6c984b47ba8805f59bb9959d9e.webp#pic_center)

> **面试官：小伙子真厉害啊，我这边没有什么要问的了，你还有什么问题要问（面试官两眼放光）**

> 我：额。。。面试官这个我的纸质简历可以给我吗，可以不往我的简历上写写画画吗，我明天的面试还要用。

> **面试官：还面啥别的公司啊，就来我这吧，条件随便开**

> 我：那就100k吧（此时面试官又拿起了他准备好的棍子）

**面试官：你要是不来就给我推荐一下，让别人来我这面试一下**

> 我：你先好好学习一下Redis吧，今天幸亏只是我来了，如果是小奇的忠实读者来了，你将会被虐的很惨的。（我将我的《Redis设计与实现》留给了面试官，转身留下了帅气的背影，而面试官落寞无神的呆呆的坐在那里，仿佛一个亿离他而去。。。）

六、总结
====

> 这里关于Redis还没有整理完毕，文章后面持续更新，建议收藏。

> 文章中涉及到的命令大家一定要像我一样每个都敲几遍，只有在敲的过程中才能发现自己对命令是否真正的掌握了。

> 如果觉得我的文章还不错的话就点个赞吧。