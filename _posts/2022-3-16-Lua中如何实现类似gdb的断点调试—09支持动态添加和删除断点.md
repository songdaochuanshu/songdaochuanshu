---
layout: post
title: "Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”09æ”¯æŒåŠ¨æ€æ·»åŠ å’Œåˆ é™¤æ–­ç‚¹"
date: "2022-03-16T19:14:06.958Z"
---
Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”09æ”¯æŒåŠ¨æ€æ·»åŠ å’Œåˆ é™¤æ–­ç‚¹

å‰é¢å·²ç»æ”¯æŒäº†å‡ ç§ä¸åŒçš„æ–¹å¼æ·»åŠ æ–­ç‚¹ï¼Œä½†æ˜¯å¿…é¡»äº‹å…ˆåœ¨ä»£ç ä¸­æ·»åŠ æ–­ç‚¹ï¼Œåœ¨ä½¿ç”¨ä¸Šä¸æ˜¯é‚£ä¹ˆçµæ´»æ–¹ä¾¿ã€‚æœ¬æ–‡å°†æ”¯æŒåŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œåªéœ€è¦å¼€ä¸€å¼€å§‹å¼•å…¥è°ƒè¯•åº“å³å¯ï¼Œåç»­å¯ä»¥åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­åŠ¨æ€çš„æ·»åŠ å’Œåˆ é™¤æ–­ç‚¹ã€‚äº‹ä¸å®œè¿Ÿï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ã€‚

æºç å·²ç»ä¸Šä¼ [Github](https://github.com/catbro666/lua-debugger)ï¼Œæ¬¢è¿watch/starğŸ˜˜ã€‚

æœ¬åšå®¢å·²è¿ç§»è‡³[CatBro's Blog](https://catbro666.github.io/)ï¼Œé‚£æ˜¯æˆ‘è‡ªå·±æ­å»ºçš„ä¸ªäººåšå®¢ï¼Œæ¬¢è¿å…³æ³¨ã€‚[æœ¬æ–‡é“¾æ¥](https://catbro666.github.io/posts/1fdd30ce/)

å®ç°åˆ†æ
----

### å…¥å£æ–­ç‚¹

å°½ç®¡æˆ‘ä»¬ç›®æ ‡æ˜¯æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹ï¼Œä½†è¿˜æ˜¯éœ€è¦ä¸€ä¸ªå…¥å£ï¼Œæä¾›ç”¨æˆ·æ·»åŠ åˆå§‹çš„æ–­ç‚¹ã€‚ä»ç„¶åƒä¹‹å‰ä¸€æ ·ï¼Œåœ¨ç”¨æˆ·ä»£ç ä¸­æ˜¾å¼æ·»åŠ çš„ç¡®å¯ä»¥ï¼Œä½†æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦æ•ˆæœã€‚ç†æƒ³çš„æ•ˆæœå°±æ˜¯ç”¨æˆ·å¼€å§‹è°ƒè¯•ç¨‹åºï¼Œå°±è‡ªåŠ¨åœåœ¨å…¥å£å¤„ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥äº¤äº’ä¿¡æ¯ï¼Œå°±åƒgdbé‚£æ ·ã€‚

å› ä¸ºå¼•å…¥è°ƒè¯•åº“è¿™ä¸ªåŠ¨ä½œæ˜¯è‚¯å®šè¦åšçš„ï¼Œæ‰€ä»¥æœ€æ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯åœ¨å¼•å…¥è¿™ä¸ªåº“çš„æ—¶å€™å°±ç›´æ¥åœåˆ°å…¥å£æ–­ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è°ƒè¯•åº“ä¸­å®ç°ä¸€ä¸ªinitæ–¹æ³•ï¼Œåœ¨requireè¿™ä¸ªè°ƒè¯•åº“ä¹‹åè°ƒç”¨initè¿›å…¥è°ƒè¯•å…¥å£ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·

    require("luadebug").init()
    

ç”¨æˆ·ä»£ç ä¸­åªéœ€è¦æ·»åŠ è¿™æ ·ä¸€è¡Œï¼Œæ— éœ€å…¶ä»–ä»»ä½•æ”¹åŠ¨ï¼Œåç»­å°±å¯ä»¥äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€æ·»åŠ æ–­ç‚¹äº†ã€‚

### æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹

è¦åœ¨äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€æ·»åŠ æ–­ç‚¹ï¼Œæˆ‘ä»¬çš„æ¥å£å‡½æ•°å¦‚æ·»åŠ æ–­ç‚¹å‡½æ•°ã€åˆ é™¤æ–­ç‚¹å‡½æ•°å°±éœ€è¦åœ¨äº¤äº’æ¨¡å¼çš„ä½œç”¨åŸŸä¸­å¯è§ï¼Œæ‰€ä»¥éœ€è¦å°†å…¬å…±æ¥å£å‡½æ•°æ”¾åˆ°`_G`æˆ–`_ENV`ä¸­ã€‚ä½†æ˜¯æ”¾åˆ°è¿™æ ·çš„å…¨å±€è¡¨ä¸­ï¼Œå¯èƒ½å‡ºç°åå­—å†²çªçš„æƒ…å†µï¼Œéœ€è¦æ”¯æŒé€šè¿‡å‚æ•°è‡ªå®šä¹‰æ¥å£å‡½æ•°çš„åç§°ã€‚

æ”¯æŒäº†åŠ¨æ€æ–­ç‚¹ä¹‹åï¼ŒåŸæœ¬åœ¨calläº‹ä»¶ä¸­åˆ¤æ–­å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹å¹¶è®°å½•åœ¨status.stackinfosä¸­ï¼Œç„¶ååœ¨returnäº‹ä»¶ä¸­æŸ¥è¯¢è¯¥å€¼çš„æœºåˆ¶å°±å¤±æ•ˆäº†ã€‚å› ä¸ºéšæ—¶å¯ä»¥åŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œæ‰€ä»¥åœ¨callå’Œreturnäº‹ä»¶éƒ½éœ€è¦å®æ—¶è¿›è¡Œåˆ¤æ–­ï¼Œç„¶åæ ¹æ®ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æˆ–åˆ é™¤lineäº‹ä»¶ã€‚

å¦å¤–ä¸ºäº†æ–¹ä¾¿æ·»åŠ æ–­ç‚¹ï¼Œæ‰©å±•æ–­ç‚¹æ·»åŠ å‡½æ•°ä»¥æ”¯æŒç”¨"."è¡¨ç¤ºå½“å‰å‡½æ•°æˆ–å½“å‰åŒ…ã€‚

### æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹

è¦æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ–­ç‚¹æ‰“å°å‡½æ•°ä»¥æŸ¥çœ‹å½“å‰çš„æ–­ç‚¹æƒ…å†µã€‚

é’©å­å‡½æ•°
----

é¦–å…ˆæ¥çœ‹é’©å­å‡½æ•°ï¼Œå› ä¸ºéœ€è¦æ”¯æŒåŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œæ‰€ä»¥callå’Œreturnäº‹ä»¶éœ€è¦ç›¸åº”ä¿®æ”¹ã€‚å…ˆçœ‹calläº‹ä»¶æ”¹åŠ¨ï¼Œupdatehookeventå‡½æ•°æŠŠä¹‹å‰æ ¹æ®å‡½æ•°ä¿¡æ¯åˆ¤æ–­æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå¹¶è°ƒæ•´lineäº‹ä»¶çš„é€»è¾‘ç»™å°è£…èµ·æ¥äº†ï¼Œå› ä¸ºç°åœ¨åœ¨returnäº‹ä»¶ä¸­ä¹Ÿéœ€è¦è¿›è¡Œè¿™äº›æ“ä½œã€‚è€Œstatus.stackinfosä¸­åˆ™ä¸å†ç¼“å­˜hasbreakï¼Œå› ä¸ºæ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹åï¼Œéœ€è¦å®æ—¶åˆ¤æ–­äº†ã€‚

    local function hook (event, line)
        local s = status
        if event == "call" or event == "tail call" then
            -- level 2: hook, target func
            local sinfo = debug.getinfo(2, "nf")
            local finfo = updatehookevent(sinfo)
            if event == "call" then     -- for tail call, just overwrite
                s.stackdepth = s.stackdepth + 1
            end
            s.stackinfos[s.stackdepth] =
                {stackinfo = sinfo, funcinfo = finfo}
            -- çœç•¥...
        end
    end
    

ç„¶åæ¥çœ‹returnäº‹ä»¶çš„æ”¹åŠ¨ã€‚s.stackinfosä¸­æŠŠå½“å‰å‡½æ•°å‡ºæ ˆï¼Œè¿™è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ã€‚ç„¶åå¦‚æœå·²ç»åˆ é™¤äº†æ‰€æœ‰æ–­ç‚¹ï¼Œé‚£ä¹ˆå°†é’©å­å‡½æ•°ç§»é™¤ï¼Œå¹¶æ¸…ç©ºs.stackinfosç¼“å­˜ã€‚å¦‚æœæ ˆä¸­è¿˜æœ‰å‡½æ•°ï¼Œåˆ™è°ƒç”¨updatehookeventå‡½æ•°ï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯å³å°†è¿”å›çš„å‡½æ•°çš„ä¿¡æ¯ã€‚

    local function hook (event, line)
        -- çœç•¥...
            elseif event == "return" or event == "tail return" then
            if s.stackdepth > 0 then
                s.stackinfos[s.stackdepth] = nil
                s.stackdepth = s.stackdepth - 1
            end
            if s.bpnum == 0 then
                debug.sethook()
                s.stackinfos = {}
                s.stackdepth = 0
            end
            if s.stackdepth > 0 then
                updatehookevent(s.stackinfos[s.stackdepth].stackinfo)
            end
        -- çœç•¥...
    end
    

æˆ‘ä»¬æ¥çœ‹ä¸‹updatehookeventçš„å®ç°ï¼š

    function updatehookevent(stackinfo)
        local s = status
        local func = stackinfo.func
        local name = stackinfo.name
        local funcinfo = getfuncinfo(func)
        local hasbreak = false
        -- check unsolved srcbp
        solvesrcbp(funcinfo, func)
    
        if funcinfo.what ~= "C" then
            setsrcfunc(funcinfo, func)
        end
    
        if s.funcbpt[func] then
            hasbreak = true
        end
        if not hasbreak and s.namebpt[name] then
            local min = funcinfo.linedefined
            local max = funcinfo.lastlinedefined
            for k, _ in pairs(s.namebpt[name]) do
                if type(k) == "number" and ((k >= min and k <= max) or k == 0) then
                    hasbreak = true
                    break
                end
            end
        end
        -- found breakpoint in current function
        if hasbreak then
            debug.sethook(hook, "crl")  -- add "line" event
        else        -- no breakpoints found
            debug.sethook(hook, "cr")   -- remove "line" event
        end
    
        return funcinfo
    end
    

å¤§éƒ¨åˆ†éƒ½æ˜¯ä¹‹å‰çš„calläº‹ä»¶ä¸­å¹²çš„äº‹æƒ…ï¼Œé¦–å…ˆæ£€æŸ¥srcbptä¸­æ˜¯å¦æœ‰å½“å‰åŒ…ä¸­æœªè§£æçš„æ–­ç‚¹ï¼Œç„¶ååˆ¤æ–­å½“å‰å‡½æ•°æ—¶å€™æœ‰æ–­ç‚¹ï¼Œæœ‰æ–­ç‚¹æ‰“å¼€lineäº‹ä»¶ï¼Œæ²¡æœ‰æ–­ç‚¹ç§»é™¤lineäº‹ä»¶ã€‚

åˆå§‹åŒ–å‡½æ•°
-----

æˆ‘ä»¬åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†æ¥çœ‹åˆå§‹åŒ–å‡½æ•°ï¼Œé¦–å…ˆç¬¬ä¸€éƒ¨åˆ†æ˜¯å°†å‡½æ•°æ³¨å†Œåˆ°å…¨å±€è¡¨`_G`ã€‚

    local function init(name_table)
        local s = status
        if not _G.luadebug_inited then
            _G.luadebug_inited = true
            if name_table and type(name_table) == "table" then
                if hasdupname(name_table) then
                    return
                end
                _G[name_table[1]] = setbreakpoint
                _G[name_table[2]] = removebreakpoint
                _G[name_table[3]] = printvarvalue
                _G[name_table[4]] = setvarvalue
                _G[name_table[5]] = printtraceback
                _G[name_table[6]] = printbreakinfo
                _G[name_table[7]] = help
                hascustomnames = true
                customnames = name_table
            else
                if hasdupname(longnames) then
                    return
                end
                if hasdupname(shortnames) then
                    return
                end
                _G.setbreakpoint = setbreakpoint
                _G.removebreakpoint = removebreakpoint
                _G.printvarvalue = printvarvalue
                _G.setvarvalue = setvarvalue
                _G.printtraceback = printtraceback
                _G.printbreakinfo = printbreakinfo
                _G.help = help
                -- short names
                _G.b = setbreakpoint
                _G.d = removebreakpoint
                _G.p = printvarvalue
                _G.bt = printtraceback
                _G.s = setvarvalue
                _G.i = printbreakinfo
                _G.h = help
            end
        end
        -- çœç•¥...
    end
    

å¯é€‰å‚æ•°`name_table`ç”¨äºæŒ‡å®šè‡ªå®šä¹‰çš„å‡½æ•°åç§°ã€‚æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ ‡è®°`luadebug_inited`è¡¨ç¤ºæ˜¯å¦å·²ç»åˆå§‹åŒ–äº†å…¨å±€è¡¨ã€‚å¦‚æœè¿˜æ²¡æœ‰åˆ™è¿›è¡Œæ³¨å†Œï¼Œå¦‚æœæä¾›äº†è‡ªå®šä¹‰çš„å‡½æ•°åï¼Œåˆ™æ³¨å†Œè‡ªå®šä¹‰çš„ï¼Œå¦åˆ™æ³¨å†Œé»˜è®¤çš„å‡½æ•°åã€‚æ³¨å†Œå‰ä½¿ç”¨hasdupnameå‡½æ•°æ£€æŸ¥`_G`è¡¨ä¸­æ˜¯å¦å·²ç»æœ‰äº†åŒåçš„æˆå‘˜ï¼Œå¦‚æœæœ‰åˆ™ç»ˆæ­¢æ³¨å†Œï¼Œå‡½æ•°è¿”å›ã€‚

æ¥ç€çœ‹å‡½æ•°ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†åœ¨è¾“å‡ºä¸€äº›æç¤ºä¿¡æ¯ådebug.debugè¿›å…¥äº¤äº’æ¨¡å¼ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªå…¥å£æ–­ç‚¹ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›åˆå§‹çš„æ–­ç‚¹ã€‚

    local function init(name_table)
        -- çœç•¥...
        io.write(string.format("luadebug %s start ...\n", version))
        if hascustomnames then
            io.write("input '" .. customnames[7] .. "()' for help info or '"
                .. customnames[7] .. "(1)' for verbose info\n")
        else
            io.write("input 'help()' for help info or 'help(1)' for verbose info\n")
        end
    
        local sinfo = debug.getinfo(2, "nfl")
        local func = sinfo.func
        local name = sinfo.name
        local finfo = getfuncinfo(func)
        local prompt = string.format("%s (%s)%s %s:%d\n",
            finfo.what, sinfo.namewhat, name, finfo.short_src, sinfo.currentline)
        io.write(prompt)
        debug.debug()
        -- çœç•¥...
    end
    

æ¥ä¸‹æ¥çœ‹å‡½æ•°çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†å¯èƒ½ä¸å¤ªå¥½ç†è§£ã€‚æˆ‘ä»¬çš„status.stackinfosæ˜¯ç”¨äºç¼“å­˜è°ƒç”¨æ ˆçš„å‡½æ•°ä¿¡æ¯çš„ï¼Œcalläº‹ä»¶æ—¶å…¥æ ˆï¼Œreturnäº‹ä»¶æ—¶å‡ºæ ˆï¼Œæˆ‘ä»¬ä¾èµ–è¿™ä¸ªç¼“å­˜çš„å‡½æ•°ä¿¡æ¯æ¥å†³å®šæ˜¯å¦æ·»åŠ lineäº‹ä»¶ã€‚ä½†æ˜¯åœ¨sethookå‡½æ•°å¯åŠ¨é’©å­ä¹‹å‰å·²ç»åœ¨è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰ç¼“å­˜çš„å‡½æ•°ä¿¡æ¯çš„ï¼Œä¹Ÿå°±é€ æˆå³ä½¿æˆ‘ä»¬åœ¨è¿™äº›å‡½æ•°ä¸Šæ·»åŠ äº†æ–­ç‚¹ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•çœŸæ­£æ–­åˆ°é‚£é‡Œã€‚

è§£å†³åŠæ³•æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½debug.getinfoå®æ—¶è·å–è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ä¿¡æ¯ã€‚è¿™æ ·è™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ€§èƒ½æœ‰ä¸€å®šæŸå¤±ã€‚ç¬¬äºŒä¸ªåŠæ³•å°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨sethookå‡½æ•°å‰ï¼ŒæŠŠç¼ºå¤±çš„è°ƒç”¨æ ˆå‡½æ•°ä¿¡æ¯æ‰‹åŠ¨è¡¥ä¸Šå»ã€‚

åŸå…ˆæˆ‘ä»¬æ˜¯åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªæ–­ç‚¹æ—¶ï¼Œdebug.sethookå¯åŠ¨é’©å­å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å¤šä¸ªæ–­ç‚¹æ·»åŠ å‡½æ•°ï¼Œä¸”å­˜åœ¨æ½œåµŒå¥—è°ƒç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥å¦‚æœåœ¨æ–­ç‚¹è®¾ç½®å‡½æ•°ä¸­å¤„ç†ä»£ç ä¸Šä¼šæœ‰é‡å¤ï¼Œè€Œä¸”debug.getinfoåœ¨å±‚æ•°ä¸Šæ—¶ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šåœ¨initå‡½æ•°ä¸­å¹²è¿™ä¸ªäº‹æƒ…ã€‚

    local function init(name_table)
        -- çœç•¥...
        if s.bpnum > 0 then
            if s.stackdepth == 0 then       -- set hook
                local max_depth = 2
                while ( true ) do
                    if not debug.getinfo(max_depth, "f") then
                        max_depth = max_depth - 1
                        break
                    end
                    max_depth = max_depth + 1
                end
                -- init stackinfos
                for i=max_depth, 1, -1 do
                    s.stackdepth = s.stackdepth + 1
                    local sinfo = debug.getinfo(i, "nf")
                    local func = sinfo.func
                    local finfo = getfuncinfo(func)
                    s.stackinfos[s.stackdepth] =
                        {stackinfo = sinfo, funcinfo = finfo}
                end
                -- add sethook
                s.stackdepth = s.stackdepth + 1
                s.stackinfos[s.stackdepth] =
                    {stackinfo = {name = "sethook", func = debug.sethook},
                     funcinfo = getfuncinfo(debug.sethook)}
                debug.sethook(hook, "cr")
            end
        end
    	-- çœç•¥...
    end
    

é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–­ç‚¹ï¼Œå¦‚æœæ²¡æœ‰æ–­ç‚¹ä¸éœ€è¦æ·»åŠ é’©å­å‡½æ•°ã€‚ç„¶åæ£€æŸ¥å½“å‰s.stackdepthæ˜¯å¦ä¸º0ï¼Œè¿™æ˜¯è€ƒè™‘åˆ°initå‡½æ•°å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨çš„æƒ…å†µï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ‰éœ€è¦æ‰‹åŠ¨è¡¥è°ƒç”¨æ ˆä¿¡æ¯ã€‚æ¥ä¸‹æ¥çš„whileå¾ªç¯æ˜¯ä¸ºäº†æ¢æµ‹è°ƒç”¨æ ˆçš„æ·±åº¦ï¼Œä¹‹æ‰€ä»¥ä¸ä½¿ç”¨å›ºå®šå€¼ï¼Œæ˜¯è€ƒè™‘åˆ°è°ƒç”¨initå‡½æ•°çš„ä¹Ÿä¸ä¸€å®šå°±æ˜¯æœ€å¤–å±‚ã€‚ç„¶åä»æ ˆçš„æœ€æ·±å¤„å¼€å§‹ä¸€å±‚ä¸€å±‚æ·»åŠ ï¼Œæœ€åå†è¡¥ä¸Šsethookå‡½æ•°æœ¬èº«ã€‚è¡¥å……å®Œstatus.stackinfosä¿¡æ¯åå°±å¯ä»¥è°ƒç”¨debug.sethookè®¾ç½®é’©å­å‡½æ•°äº†ã€‚

æ—¢ç„¶æˆ‘ä»¬åœ¨initå‡½æ•°ä¸­sethookäº†ï¼Œé‚£ä¹ˆä¹‹å‰è®¾ç½®æ–­ç‚¹å‡½æ•°ä¸­çš„sethookå°±éƒ½å¯ä»¥å»æ‰äº†ã€‚

æ–­ç‚¹æ‰“å°å‡½æ•°
------

æ–­ç‚¹æ‰“å°å‡½æ•°éå¸¸ç®€å•ï¼Œåªæ˜¯éå†status.bptableè¡¨ï¼Œæ‰“å°æ–­ç‚¹ä¿¡æ¯ï¼Œå¯¹åº”é€šè¿‡å‡½æ•°åå­—æ·»åŠ çš„æ–­ç‚¹æ‰“å°åå­—åŠè¡Œæ•°ï¼Œå…¶ä½™æ–­ç‚¹æ‰“å°åŒ…ååŠè¡Œæ•°ã€‚

    local function printbreakinfo()
        local s = status
        for i=1,s.bpid do
            local bp = s.bptable[i]
            local prompt
            if bp then
                if bp.name then
                    prompt = string.format("id: %d, name: %s, line: %d\n",
                        i, bp.name, bp.line)
                else
                    prompt = string.format("id: %d, src: %s, line: %d\n",
                        i, bp.src, bp.line)
                end
                io.write(prompt)
            end
        end
    end
    

å…¶ä»–
--

helpå¸®åŠ©å‡½æ•°ï¼Œä»¥åŠæ‰©å±•æ–­ç‚¹æ·»åŠ å‡½æ•°æ”¯æŒç”¨"."è¡¨ç¤ºå½“å‰å‡½æ•°æˆ–å½“å‰åŒ…ï¼Œæˆ‘å°±ä¸ä¸“é—¨è®²äº†ã€‚å¦å¤–ï¼Œæ—¢ç„¶æˆ‘ä»¬çš„æ¥å£å‡½æ•°å·²ç»æ”¯æŒåœ¨äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€è°ƒç”¨äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸éœ€è¦å†å¯¼å‡ºäº†ï¼Œæ¨¡å—åªéœ€è¦å¯¼å‡ºinitå‡½æ•°å³å¯ã€‚

    return {
        init = init,
    }
    

æµ‹è¯•
--

æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå¦‚ä¸‹çš„Luaæµ‹è¯•è„šæœ¬

    require("luadebug").init()
    local lib = require "testlib"
    
    local g = 1
    local function faa ()
        g = 2
    end
    
    faa()
    lib.foo()
    lib.bar()
    faa()
    

æµ‹è¯•åŒ…è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·

    local function foo ()
        local a = 1
    end
    
    local function bar()
        local a = 1
    end
    
    local a = 1
    
    return {
        foo = foo,
        bar = bar,
    }
    

### å…¥å£è„šæœ¬ä¸­æ–­ç‚¹æµ‹è¯•

é¦–å…ˆæµ‹è¯•ä»…åœ¨å…¥å£è„šæœ¬ä¸­æ·»åŠ æ–­ç‚¹

    $ lua dynamictest.lua
    luadebug 0.0.1 start ...
    input 'help()' for help info or 'help(1)' for verbose info
    main ()nil dynamictest.lua:1
    lua_debug> 
    

æˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ï¼Œä¸€ä¸ªæ˜¯å½“å‰åŒ…çš„ç¬¬7è¡Œï¼ŒåŠfaaå‡½æ•°çš„æœ€åä¸€è¡Œï¼Œä¸€ä¸ªæ˜¯å½“å‰å‡½æ•°å³mainchunkçš„ç¬¬9è¡Œ

    lua_debug> b(".:7")
    lua_debug> b(".@9")
    lua_debug> i()
    id: 1, src: dynamictest.lua, line: 7, refname: nil
    id: 2, src: dynamictest.lua, line: 9, refname: main
    lua_debug>
    

æˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œé¦–å…ˆåœåœ¨äº†mainchunkçš„ç¬¬9è¡Œï¼Œæ­¤æ—¶gçš„å€¼ä¸º1ï¼Œç»§ç»­æ‰§è¡Œï¼Œåˆåœåœ¨äº†faaçš„ç¬¬7è¡Œï¼Œæ­¤æ—¶gå·²ç»æ”¹ä¸º2

    lua_debug> cont
    main ()nil dynamictest.lua:9
    lua_debug> p("g")
    local	1
    lua_debug> cont
    Lua (local)faa dynamictest.lua:7
    lua_debug> p("g")
    upvalue	2
    lua_debug> i()
    id: 1, src: dynamictest.lua, line: 7, refname: faa
    id: 2, src: dynamictest.lua, line: 9, refname: main
    lua_debug>
    

æ­¤æ—¶æˆ‘ä»¬åˆ é™¤ä¸¤ä¸ªæ–­ç‚¹ï¼Œå†æ¬¡ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºä¸å†åœåˆ°faaä¸Š

    lua_debug> d(1)
    lua_debug> d(2)
    lua_debug> i()
    lua_debug> cont
    $ 
    

### å…¶ä»–åŒ…ä¸­æ–­ç‚¹æµ‹è¯•

æ¥ç€æµ‹è¯•ä¸‹åœ¨testlibåŒ…ä¸­æ·»åŠ æ–­ç‚¹ï¼Œé¦–å…ˆå¯åŠ¨è°ƒè¯•ï¼Œæ·»åŠ ä¸¤ä¸ªæ–­ç‚¹

    $ lua dynamictest.lua
    luadebug 0.0.1 start ...
    input 'help()' for help info or 'help(1)' for verbose info
    main ()nil dynamictest.lua:1
    lua_debug> b("testlib:-9")
    lua_debug> b("foo@")
    lua_debug> i()
    id: 1, src: /usr/local/share/lua/5.3/testlib.lua, line: -9, refname: nil
    id: 2, name: foo, line: 0
    lua_debug>
    

ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºé¦–å…ˆåœåœ¨äº†testlibçš„mainchunkç¬¬9è¡Œï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ faaçš„æ–­ç‚¹

    lua_debug> cont
    main ()nil /usr/local/share/lua/5.3/testlib.lua:9
    lua_debug> i()
    id: 1, src: /usr/local/share/lua/5.3/testlib.lua, line: 9, refname: main
    id: 2, name: foo, line: 0
    lua_debug> b("faa@")
    lua_debug>
    

ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºå…ˆåœåœ¨faaå‡½æ•°ï¼Œç„¶ååœåœ¨fooå‡½æ•°ï¼Œæœ€åå¬åˆ°faaå‡½æ•°ã€‚

    lua_debug> cont
    Lua (local)faa dynamictest.lua:6
    lua_debug> cont
    Lua (field)foo /usr/local/share/lua/5.3/testlib.lua:2
    lua_debug> cont
    Lua (local)faa dynamictest.lua:6
    lua_debug> cont
    

### å¤šæ¬¡åˆå§‹åŒ–æµ‹è¯•

æˆ‘ä»¬åœ¨testlibåŒ…å¼€å¤´æ·»åŠ ä¸€è¡Œ`require("luadebug").init()`ã€‚é¦–å…ˆä¸€æ ·åœåœ¨äº†dynamictest.luaä¸­çš„å…¥å£æ–­ç‚¹å¤„ï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ã€‚

    $ lua dynamictest.lua
    luadebug 0.0.1 start ...
    input 'help()' for help info or 'help(1)' for verbose info
    main ()nil dynamictest.lua:1
    lua_debug> b("faa@")
    lua_debug> b("foo@")
    lua_debug> i()
    id: 1, name: faa, line: 0
    id: 2, name: foo, line: 0
    lua_debug>
    

ç„¶åç»§ç»­æ‰§è¡Œï¼Œå‘ç°ç¨‹åºåœåˆ°äº†testlibçš„å…¥å£æ–­ç‚¹å¤„ï¼Œæ–­ç‚¹æƒ…å†µæ­£å¸¸

    lua_debug> cont
    luadebug 0.0.1 start ...
    input 'help()' for help info or 'help(1)' for verbose info
    main ()nil /usr/local/share/lua/5.3/testlib.lua:1
    lua_debug> bt()
    stack traceback:
    	/usr/local/share/lua/5.3/testlib.lua:1: in main chunk
    	[C]: in function 'require'
    	dynamictest.lua:2: in main chunk
    	[C]: in ?
    lua_debug> i()
    id: 1, name: faa, line: 0
    id: 2, name: foo, line: 0
    lua_debug>
    

æˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œåœåœ¨äº†faaå‡½æ•°å¤„ï¼Œæˆ‘ä»¬åˆ é™¤æ–­ç‚¹1ï¼Œç„¶åç»§ç»­æ‰§è¡Œ

    lua_debug> cont
    Lua (local)faa dynamictest.lua:6
    lua_debug> d(1)
    lua_debug> i()
    id: 2, name: foo, line: 0
    lua_debug>
    
    

ç¨‹åºåœåœ¨äº†fooå‡½æ•°å¤„ï¼Œå†ç»§ç»­å› ä¸ºfaaå‡½æ•°å¤„çš„æ–­ç‚¹1å·²ç»åˆ é™¤ï¼Œæ‰€ä»¥ç¨‹åºç›´æ¥ç»“æŸã€‚

    lua_debug> cont
    Lua (field)foo /usr/local/share/lua/5.3/testlib.lua:3
    lua_debug> cont
    $
    

### ä»…åœ¨testlibåŒ…ä¸­åˆå§‹åŒ–

æˆ‘ä»¬åˆ é™¤dynamictest.luaä¸­çš„ç¬¬ä¸€è¡Œï¼Œç»§ç»­æµ‹è¯•ï¼Œç¨‹åºç›´æ¥åœåœ¨äº†testlibåŒ…çš„å…¥å£æ–­ç‚¹ï¼Œæˆ‘ä»¬åŒæ ·æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ã€‚

    lua dynamictest.lua
    luadebug 0.0.1 start ...
    input 'help()' for help info or 'help(1)' for verbose info
    main ()nil /usr/local/share/lua/5.3/testlib.lua:1
    lua_debug> b("faa@")
    lua_debug> b("foo@")
    lua_debug> i()
    id: 1, name: faa, line: 0
    id: 2, name: foo, line: 0
    lua_debug>
    

ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºåœåœ¨äº†faaå‡½æ•°å¤„ï¼Œæˆ‘ä»¬åˆ é™¤æ–­ç‚¹1ï¼Œç„¶åç»§ç»­æ‰§è¡Œ

    lua_debug> cont
    Lua (local)faa dynamictest.lua:5
    lua_debug> d(1)
    lua_debug> i()
    id: 2, name: foo, line: 0
    lua_debug>
    

ç¨‹åºåœåœ¨äº†fooå‡½æ•°å¤„ï¼Œå†ç»§ç»­å› ä¸ºæ–­ç‚¹1å·²ç»åˆ é™¤ï¼Œæ‰€ä»¥ä¸å†åœåœ¨faaå‡½æ•°å¤„ï¼Œç¨‹åºç›´æ¥ç»“æŸã€‚

    lua_debug> cont
    Lua (field)foo /usr/local/share/lua/5.3/testlib.lua:3
    lua_debug> cont
    $
    

### è‡ªå®šä¹‰å‡½æ•°åç§°åŠé‡åæµ‹è¯•

æˆ‘ä»¬åœ¨dynamictest.luaæœ€å‰é¢æ·»åŠ ä¸€è¡Œï¼š

    d = 1
    

æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼Œæç¤ºé”™è¯¯ä¹‹åæ²¡æœ‰è¿›å…¥äº¤äº’æ¨¡å¼ã€‚

    $ lua dynamictest.lua
    table `_G` already has element called "d" please specify custom names as the following example:
    require("luadebug").init({"bb", "dd", "pp", "ss", "tt", "ii", "hh"})
    

æˆ‘ä»¬å†å°†ç¬¬äºŒè¡Œæ”¹ä¸ºå¦‚ä¸‹

    require("luadebug").init({"bb", "dd", "pp", "ss", "tt", "ii", "hh"})
    

ç„¶åé‡æ–°æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•°åå·²ç»é¡ºåˆ©ä¿®æ”¹

    lua dynamictest.lua
    luadebug 0.0.1 start ...
    input 'hh()' for help info or 'hh(1)' for verbose info
    main ()nil dynamictest.lua:2
    lua_debug> bb("faa@")
    lua_debug> bb("foo@")
    lua_debug> ii()
    id: 1, name: faa, line: 0
    id: 2, name: foo, line: 0
    lua_debug>
    

ç»§ç»­æ‰§è¡Œï¼Œä¸€åˆ‡æ­£å¸¸ã€‚

    lua_debug> cont
    luadebug 0.0.1 start ...
    input 'hh()' for help info or 'hh(1)' for verbose info
    main ()nil /usr/local/share/lua/5.3/testlib.lua:1
    lua_debug> cont
    Lua (local)faa dynamictest.lua:7
    lua_debug> dd(1)
    lua_debug> cont
    Lua (field)foo /usr/local/share/lua/5.3/testlib.lua:3
    lua_debug> tt()
    stack traceback:
    	/usr/local/share/lua/5.3/testlib.lua:3: in function 'testlib.foo'
    	dynamictest.lua:11: in main chunk
    	[C]: in ?
    lua_debug> cont
    $
    

posted on 2022-03-16 22:45Â  [çŒ«çŒ«å“¥](https://www.cnblogs.com/logchen/)Â  é˜…è¯»(0)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=16015276)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))