---
layout: post
title: "3. å ªæ¯”JMeterçš„.Netå‹æµ‹å·¥å…· - Crank è¿›é˜¶ç¯‡ - è®¤è¯†bombardier"
date: "2022-03-21T08:38:33.071Z"
---
3\. å ªæ¯”JMeterçš„.Netå‹æµ‹å·¥å…· - Crank è¿›é˜¶ç¯‡ - è®¤è¯†bombardier
================================================

1\. å‰è¨€
------

é€šè¿‡ä¹‹å‰çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å„å‚æ•°ä»¥åŠé…ç½®çš„æ„ä¹‰ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« æˆ‘ä»¬åˆ†åˆ«ä»bombardierä»¥åŠwrkå…¥æ‰‹ï¼Œè¿›ä¸€æ­¥äº†è§£å½¼æ­¤ä¹‹é—´çš„è”ç³»

2\. è®¤è¯† bombardier
-----------------

[bombardier](https://github.com/codesenberg/bombardier) æ˜¯ä¸€ä¸ª HTTP(S) åŸºå‡†æµ‹è¯•å·¥å…·ã€‚å®ƒæ˜¯ç”¨ Go ç¼–ç¨‹è¯­è¨€ç¼–å†™çš„ï¼Œå¹¶ä½¿ç”¨ä¼˜ç§€çš„fasthttpä»£æ›¿ Go çš„é»˜è®¤ http åº“ï¼Œå› ä¸ºå®ƒå…·æœ‰é—ªç”µèˆ¬çš„å¿«é€Ÿæ€§èƒ½ï¼Œ[è¯¦ç»†æ–‡æ¡£æŸ¥çœ‹](https://pkg.go.dev/github.com/codesenberg/bombardier?utm_source=godoc)

å…¶æ”¯æŒå‚æ•°ï¼š

    -c, --connections=125       Maximum number of concurrent connections
    -t, --timeout=2s            Socket/request timeout
    -l, --latencies             Print latency statistics
    -m, --method=GET            Request method
    -b, --body=""               Request body
    -f, --body-file=""          File to use as request body
    -s, --stream                Specify whether to stream body using chunked
                                transfer encoding or to serve it from memory
        --cert=""               Path to the client's TLS Certificate
        --key=""                Path to the client's TLS Certificate Private Key
    -k, --insecure              Controls whether a client verifies the server's
                                certificate chain and host name
    -H, --header="K: V" ...     HTTP headers to use(can be repeated)
    -n, --requests=[pos. int.]  Number of requests
    -d, --duration=10s          Duration of test
    -r, --rate=[pos. int.]      Rate limit in requests per second
        --fasthttp              Use fasthttp client
        --http1                 Use net/http client with forced HTTP/1.x
        --http2                 Use net/http client with enabled HTTP/2.0
    -p, --print=<spec>          Specifies what to output. Comma-separated list of
                                values 'intro' (short: 'i'), 'progress' (short:
                                'p'), 'result' (short: 'r'). Examples:
    
                                  * i,p,r (prints everything)
                                  * intro,result (intro & result)
                                  * r (result only)
                                  * result (same as above)
    -q, --no-print              Don't output anything
    -o, --format=<spec>         Which format to use to output the result. <spec>
                                is either a name (or its shorthand) of some format
                                understood by bombardier or a path to the
                                user-defined template, which uses Go's
                                text/template syntax, prefixed with 'path:' string
                                (without single quotes), i.e.
                                "path:/some/path/to/your.template" or
                                "path:C:\some\path\to\your.template" in case of
                                Windows. Formats understood by bombardier are:
    
                                  * plain-text (short: pt)
                                  * json (short: j)
    

å¹¶ä¸”bombardieræ”¯æŒå¤šå¹³å°ï¼Œå¯ä»¥åœ¨Windowsã€Linuxã€OSXç³»ç»Ÿä¸Šè¿è¡Œï¼Œé‚£æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨bombardieræµ‹è¯•ä¸€ä¸‹ç™¾åº¦çš„å‹æµ‹æƒ…å†µ

**å®‰è£…ï¼ˆWSL-Ubuntuï¼‰ï¼š**

    sudo apt install wget
    sudo wget https://github.com/codesenberg/bombardier/releases/download/v1.2.5/bombardier-linux-arm64
    

è¿è¡Œï¼š

    ./bombardier-linux-arm64  -c 200 -d 1s --insecure -l https://www.baidu.com --print r --format json
    

[![asciicast](https://asciinema.org/a/Uz2fTLkoBmIVD8Xc7HwQqJAqg.svg)](https://asciinema.org/a/Uz2fTLkoBmIVD8Xc7HwQqJAqg)

å…¶ä¸­:

*   req1xxä»£è¡¨httpå“åº”ç ä¸º1\*\*
*   req2xxä»£è¡¨httpå“åº”ç ä¸º2\*\*
*   req3xxä»£è¡¨httpå“åº”ç ä¸º3\*\*
*   req4xxä»£è¡¨httpå“åº”ç ä¸º4\*\*
*   req5xxä»£è¡¨httpå“åº”ç ä¸º5\*\*
*   result.rps.meanä»£è¡¨æ¯ç§’è¯·æ±‚æ•°
*   result.rps.maxä»£è¡¨æ¯ç§’æœ€å¤§è¯·æ±‚æ•°
*   result.latency.meanä»£è¡¨æ¯æ¯«ç§’å»¶è¿Ÿ
*   result.latency.maxä»£è¡¨æ¯æ¯«ç§’æœ€å¤§å»¶è¿Ÿ

3\. äº†è§£Microsoft.Crank.Jobs.Bombardier
-------------------------------------

åœ¨Microsoft.Crank.Jobs.Bombardieré¡¹ç›®ä¸­Program.cs

1.  æ ¹æ®å‚æ•°è·å–-wã€-dã€-nã€-få‚æ•°ä¿¡æ¯
2.  æ ¡éªŒå‹æµ‹æ—¶é•¿ã€è¯·æ±‚æ•°ç­‰å‚æ•°ä¿¡æ¯
3.  åˆ¤æ–­å½“å‰è¿è¡Œç¯å¢ƒæ˜¯Windowsã€Linuxã€OSXï¼Œæ ¹æ®ç¯å¢ƒä¸‹è½½å¯¹åº”çš„bombardierï¼Œå¹¶æ ¹æ®ä¼ é€’çš„
4.  æ ¹æ®ymlå‚æ•°æœ€åæ‹¼è£…bombardierçš„åŸå§‹å‘½ä»¤:

> bombardier -c 200 -d 1s --insecure -l [https://www.baidu.com](https://www.baidu.com) --print r --format json

5.  å°†è¾“å‡ºçš„ç»“æœä½¿ç”¨è¿½åŠ åˆ°stringBuilderä¸Šï¼Œå†èµ‹å€¼ç»™output
6.  é€šè¿‡JObject.Parseè§£ææŒ‡æ ‡ï¼Œæœ€åé€šè¿‡BenchmarksEventSourceå­˜å‚¨å¹¶è¾“å‡ºåˆ°æ§åˆ¶å°æˆ–æ•°æ®åº“ã€csvã€jsonä¸­

å…¶ä¸­

*   è¯·æ±‚æ€»æ•° = req1xx + req2xx + req3xx + req4xx + req5xx + others
*   æˆåŠŸè¯·æ±‚æ•° = req2xx + req3xx
*   å¤±è´¥è¯·æ±‚æ•° = è¯·æ±‚æ€»æ•° - æˆåŠŸè¯·æ±‚æ•°

    BenchmarksEventSource.Register("bombardier/requests;http/requests", Operations.Max, Operations.Sum, "Requests", "Total number of requests", "n0");
    BenchmarksEventSource.Register("bombardier/badresponses;http/requests/badresponses", Operations.Max, Operations.Sum, "Bad responses", "Non-2xx or 3xx responses", "n0");
    
    BenchmarksEventSource.Register("bombardier/latency/mean;http/latency/mean", Operations.Max, Operations.Avg, "Mean latency (us)", "Mean latency (us)", "n0");
    BenchmarksEventSource.Register("bombardier/latency/max;http/latency/max", Operations.Max, Operations.Max, "Max latency (us)", "Max latency (us)", "n0");
    
    BenchmarksEventSource.Register("bombardier/rps/mean;http/rps/mean", Operations.Max, Operations.Sum, "Requests/sec", "Requests per second", "n0");
    BenchmarksEventSource.Register("bombardier/rps/max;http/rps/max", Operations.Max, Operations.Sum, "Requests/sec (max)", "Max requests per second", "n0");
    BenchmarksEventSource.Register("bombardier/throughput;http/throughput", Operations.Max, Operations.Sum, "Read throughput (MB/s)", "Read throughput (MB/s)", "n2");
    
    BenchmarksEventSource.Register("bombardier/raw", Operations.All, Operations.All, "Raw results", "Raw results", "json");
    
    var total =
        document["result"]["req1xx"].Value<long>()
        + document["result"]["req2xx"].Value<long>()
        + document["result"]["req3xx"].Value<long>()
        + document["result"]["req3xx"].Value<long>()
        + document["result"]["req4xx"].Value<long>()
        + document["result"]["req5xx"].Value<long>()
        + document["result"]["others"].Value<long>();
    
    var success = document["result"]["req2xx"].Value<long>() + document["result"]["req3xx"].Value<long>();
    
    BenchmarksEventSource.Measure("bombardier/requests;http/requests", total);
    BenchmarksEventSource.Measure("bombardier/badresponses;http/requests/badresponses", total - success);
    
    BenchmarksEventSource.Measure("bombardier/latency/mean;http/latency/mean", document["result"]["latency"]["mean"].Value<double>());
    BenchmarksEventSource.Measure("bombardier/latency/max;http/latency/max", document["result"]["latency"]["max"].Value<double>());
    
    BenchmarksEventSource.Measure("bombardier/rps/max;http/rps/max", document["result"]["rps"]["max"].Value<double>());
    BenchmarksEventSource.Measure("bombardier/rps/mean;http/rps/mean", document["result"]["rps"]["mean"].Value<double>());
    
    BenchmarksEventSource.Measure("bombardier/raw", output);
    
    var bytesPerSecond = document["result"]["bytesRead"].Value<long>() / document["result"]["timeTakenSeconds"].Value<double>();
    
    // B/s to MB/s
    BenchmarksEventSource.Measure("bombardier/throughput", bytesPerSecond / 1024 / 1024);
    

4\. è§£è¯»bombardier.ymlå„å‚æ•°ä½œç”¨
-------------------------

*   connections: æœ€å¤§å¹¶å‘è¿æ¥æ•°ï¼Œé»˜è®¤: 256
*   warmup: é¢„çƒ­æ—¶é—´ï¼Œé»˜è®¤15sï¼Œä¸æ‰§è¡Œdurationç±»ä¼¼ï¼Œè€Œå¹¶éå‹æµ‹æ¬¡æ•°
    *   å½“warmup > 0æ—¶ï¼Œä¼šå…ˆé¢„çƒ­warmupç§’åå†æ‰§è¡Œä¸€æ¬¡å‹æµ‹ï¼Œç¬¬äºŒæ¬¡çš„å‹æµ‹æ‰æ˜¯æœ€åè¿”å›çš„ç»“æœ
    *   å½“warmup = 0æ—¶ï¼Œä¸è¿›è¡Œé¢„çƒ­ï¼Œç›´æ¥å¼€å§‹å‹æµ‹
*   duration: æµ‹è¯•æ—¶é•¿ï¼Œå•ä½: s
*   requests: è¯·æ±‚æ•°
*   rate: æ¯ç§’è¯·æ±‚æ•°é™åˆ¶
*   transport: ä¼ è¾“æ–¹å¼ã€‚é»˜è®¤: fasthttp ã€æ”¯æŒfasthttpã€http1ã€http2ä¸‰ç§
*   presetHeaders: é¢„è®¾headerï¼Œæ ¹æ®å…¨å±€å‚æ•°headersï¼Œè‡ªé€‰å…¶ä¸€å³å¯ï¼Œé€‰æ‹©jsonï¼Œé‚£è¯·æ±‚çš„headerå³ä¸º: --header "Accept: application/json,text/html;q=0.9,application/xhtml+xml;q=0.9,application/xml;q=0.8,_/_;q=0.7" --header "Connection: keep-alive"
*   customHeaders: è‡ªå®šä¹‰headersï¼Œå¦‚æœé¢„è®¾headersä¸­æ²¡æœ‰éœ€è¦çš„headerï¼Œåˆ™é€šè¿‡é‡å†™customHeadersï¼Œä»¥å®Œæˆè‡ªå®šä¹‰headerçš„ç›®çš„
*   serverUri: è‡ªå®šä¹‰urlï¼Œå¦‚æœæ­¤å‚æ•°å­˜åœ¨ï¼Œåˆ™è¯·æ±‚åœ°å€ä¸º: {serverUri}:{serverPort}{path}
*   serverPort: æœåŠ¡ç«¯å£
*   serverScheme: æœåŠ¡çš„Schemeï¼Œé»˜è®¤httpã€æ”¯æŒhttpã€httpsä¸¤ç§
*   serverAddress: æœåŠ¡åœ°å€ã€ä¸åŒ…å«httpã€ä¾‹å¦‚: www.baidu.comï¼Œå¦‚æœserverUriå­˜åœ¨ï¼Œæ­¤é…ç½®æ— æ•ˆï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¯·æ±‚æ ¼å¼ä¸º: {serverScheme}ğŸ˜•/{serverAddress}:{serverPort}{path}
*   path: æœåŠ¡æ¥å£åœ°å€ï¼Œä¸åŒ…å«åŸŸï¼Œä¾‹å¦‚: /api/check/healthy
*   bodyFile: bodyå†…å®¹ï¼Œä»…åœ¨éGetè¯·æ±‚æ—¶ä½¿ç”¨ï¼Œæ”¯æŒè¿œç¨‹è·¯å¾„ä¸æœ¬åœ°ç»å¯¹è·¯å¾„ï¼ˆAgentæœåŠ¡çš„ç»å¯¹åœ°å€ï¼ŒéControllerç«¯çš„ç»å¯¹åœ°å€ï¼‰
*   verb: è¯·æ±‚æ–¹å¼: é»˜è®¤GETã€æ”¯æŒPOSTã€PUTã€DELETEã€PATCHã€GET

5\. æ€»ç»“
------

ä¼˜åŠ¿:

*   è·¨å¹³å°
*   ç”¨æ³•ç®€å•
*   ä½¿ç”¨goè¯­è¨€å¼€å‘ã€æ€§èƒ½é«˜

åŠ£åŠ¿:

*   ä¸æ”¯æŒåŠ¨æ€å‚æ•°
*   ä¸æ”¯æŒå¤šä¸ªæ¥å£åŒæ—¶å‹æµ‹

> bombardier.ymlçš„å­˜åœ¨æ˜¯ä¸ºMicrosoft.Crank.Jobs.Bombardieræä¾›é…ç½®å‚æ•°ï¼ŒMicrosoft.Crank.Jobs.Bombardieré€šè¿‡è°ƒç”¨å¼€æºé¡¹ç›®bombardierå®ç°å‹æµ‹ï¼Œå¹¶å°†å‹æµ‹ç»“æœé€šè¿‡BenchmarksEventSourceå­˜å‚¨å¹¶è¾“å‡ºåˆ°æ§åˆ¶å°æˆ–æ•°æ®åº“ã€csvã€jsonä¸­

æºç åœ°å€ï¼š[https://github.com/doddgu/crank/tree/sample](https://github.com/doddgu/crank/tree/sample)

å¼€æºåœ°å€
----

MASA.BuildingBlocksï¼š[https://github.com/masastack/MASA.BuildingBlocks](https://github.com/masastack/MASA.BuildingBlocks)

MASA.Contribï¼š[https://github.com/masastack/MASA.Contrib](https://github.com/masastack/MASA.Contrib)

MASA.Utilsï¼š[https://github.com/masastack/MASA.Utils](https://github.com/masastack/MASA.Utils)

MASA.EShopï¼š[https://github.com/masalabs/MASA.EShop](https://github.com/masalabs/MASA.EShop)

MASA.Blazorï¼š[https://github.com/BlazorComponent/MASA.Blazor](https://github.com/BlazorComponent/MASA.Blazor)

å¦‚æœä½ å¯¹æˆ‘ä»¬çš„ MASA Framework æ„Ÿå…´è¶£ï¼Œæ— è®ºæ˜¯ä»£ç è´¡çŒ®ã€ä½¿ç”¨ã€æ Issueï¼Œæ¬¢è¿è”ç³»æˆ‘ä»¬

![16373211753064.png](https://i.loli.net/2021/11/19/NPsOdZuGfBep3DY.png)