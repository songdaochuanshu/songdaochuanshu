---
layout: post
title: "RestTemplateè¸©å‘ ä¹‹ ContentType è‡ªåŠ¨æ·»åŠ å­—ç¬¦é›†"
date: "2022-03-25T07:17:30.248Z"
---
RestTemplateè¸©å‘ ä¹‹ ContentType è‡ªåŠ¨æ·»åŠ å­—ç¬¦é›†
====================================

å†™åœ¨å‰è¾¹
----

æœ€è¿‘åœ¨å†™ OAuth2 å¯¹æ¥çš„ä»£ç ï¼Œç”±äºæˆæƒæœåŠ¡å™¨ï¼ˆç«¹äº‘BambooCloud IAMï¼‰éƒ¨ç½²åœ¨ç”²æ–¹å†…ç½‘ï¼Œæ‰€ä»¥æƒ³ç€è‡ªå·± Mock ä¸€ä¸‹æˆæƒæ–¹çš„è¿”å›ä½“ï¼ŒéªŒè¯ä¸€ä¸‹æˆ‘çš„ä»£ç ã€‚æˆ‘è¿™æ‰è¸©åˆ°äº†å‘â€¦â€¦

æ•…äº‹èƒŒæ™¯
----

é€‰æ‹©çš„ Mock æ¡†æ¶æ˜¯ å›½äº§å¼€æºçš„ Mocoï¼ˆ[https://github.com/dreamhead/mocoï¼‰ï¼Œå…ˆ](https://github.com/dreamhead/moco%EF%BC%89%EF%BC%8C%E5%85%88)[ä¸‹è½½moco-runner-1.3.0-standalone.jar](https://repo1.maven.org/maven2/com/github/dreamhead/moco-runner/1.3.0/moco-runner-1.3.0-standalone.jar)

å†æ ¹æ® Mocoçš„å®˜æ–¹æ–‡æ¡£ï¼ˆ[https://github.com/dreamhead/moco/blob/master/moco-doc/apis.mdï¼‰å’Œç«¹äº‘å¯¹æ¥æ–‡æ¡£é…ç½®äº†ä»¥ä¸‹çš„mocké…ç½®ï¼š](https://github.com/dreamhead/moco/blob/master/moco-doc/apis.md%EF%BC%89%E5%92%8C%E7%AB%B9%E4%BA%91%E5%AF%B9%E6%8E%A5%E6%96%87%E6%A1%A3%E9%85%8D%E7%BD%AE%E4%BA%86%E4%BB%A5%E4%B8%8B%E7%9A%84mock%E9%85%8D%E7%BD%AE%EF%BC%9A)

BambooCloud-IAM-OAuth2-Moco.json

    [
        {
            "description": "æˆæƒå›è°ƒæ¥å£",
            "request": {
                "uri": "/idp/oauth2/authorize",
                "method": "get",
                "queries": {
                    "client_id": "client-id-test",
                    "redirect_uri": "http://localhost:8188/api/oauth2/callback",
                    "response_type": "code"
                }
            },
            "redirectTo" : "http://localhost:8188/api/oauth2/callback?code=123456"
        },
        {
            "description": "è·å–tokenæ¥å£",
            "request": {
                "uri": "/idp/oauth2/getToken",
                "method": "post",
                "headers": {
                    "content-type": "application/x-www-form-urlencoded"
                },
                "forms": {
                    "client_id" : "client-id-test",
                    "client_secret" : "client-secret-test",
                    "grant_type" : "authorization_code",
                    "code" : "123456"
                }
            },
            "response": {
                "json": {
                    "access_token" : "123456789"
                }
            }
        },
        {
            "description": "è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£",
            "request": {
                "uri": "/idp/oauth2/getUserInfo",
                "method": "get",
                "queries": {
                    "client_id": "client-id-test",
                    "access_token": "123456789"
                }
            },
            "response": {
                "json": {
                    "spRoleList":["zhangsan"],
                    "uid":"20190904124905344-F4BE-C2C9EFF24",
                    "sorgId":null,
                    "displayName":"å¼ ä¸‰",
                    "loginName":"zhangsan",
                    "secAccValid":1,
                    "givenName":"729026",
                    "pinyinShortName":null,
                    "spNameList":["portalID","tyxtest","data","certificate","sysCertification","customer"],
                    "employeeNumber":null
                }
            }
        }
    ]
    

å¯åŠ¨ Moco

    java -Dfile.encoding=UTF-8 -jar moco-runner-1.3.0-standalone.jar http -p 12306 -c BambooCloud-IAM-OAuth2-Moco.json
    

> *   ä½œè€…ä¸æ„§æ˜¯å›½äººï¼Œå®˜æ–¹æ–‡æ¡£é‡Œçš„ç«¯å£å·ç«Ÿç„¶æ˜¯12306ç«è½¦ç¥¨è®¢ç¥¨ç½‘ç«™ï¼Œç­‰ç­‰ï¼Œè¯¥ä¸ä¼šä½œè€…æ˜¯æ–¹ä¾¿æ¨¡æ‹Ÿ 12306 å¼€å‘æŠ¢ç¥¨åŠŸèƒ½æ‰å†™çš„ Moco å§ğŸ˜‚ï¼Œè¿™é‡Œä¹Ÿç”¨12306ç«¯å£~
>     
> *   `-Dfile.encoding=UTF-8` - æŒ‡å®š Moco å¯åŠ¨æœåŠ¡çš„å­—ç¬¦é›†ï¼Œä½œè€…é»˜è®¤åœ¨ç¨‹åºé‡Œå†™äº† GBKï¼Œä¸æŒ‡å®šè¿”å›ä¸­æ–‡å¯èƒ½ä¹±ç 
>     

ç„¶åé…ç½® SpringBoot æœåŠ¡é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå°±æ˜¯ç»™å¤§å®¶çœ‹çœ‹ï¼Œä¸ä¸€å®šå…·å¤‡é€šç”¨æ€§ï¼š

    #                 OAuth2é…ç½®                   #
    ################################################
    #æ˜¯å¦å¼€å¯oauth2å•ç‚¹ç™»å½•ï¼Œtrue/falseï¼Œé»˜è®¤ä¸å¯ç”¨ã€‚
    oauth2.sso.enabled=true
    #æˆæƒæ–¹é¢å‘çš„clientId
    oauth2.sso.clientId=client-id-test
    #æˆæƒæ–¹é¢å‘çš„clientSecret
    oauth2.sso.clientSecret=client-secret-test
    #ç™»å½•åœ°å€ï¼Œæˆæƒæ–¹æä¾›ï¼Œç¤ºä¾‹ï¼šhttps://{host}:{port}/idp/oauth2/authorize
    oauth2.sso.authUrl=http://localhost:12306/idp/oauth2/authorize
    #è·å–tokenåœ°å€ï¼Œæˆæƒæ–¹æä¾›ï¼Œç¤ºä¾‹ï¼šhttps://{host}:{port}/idp/oauth2/getToken
    oauth2.sso.tokenUrl=http://localhost:12306/idp/oauth2/getToken
    #è·å–ç”¨æˆ·ä¿¡æ¯åœ°å€ï¼Œæˆæƒæ–¹æä¾›ï¼Œç¤ºä¾‹ï¼šhttps://{host}:{port}/idp/oauth2/getUserInfo
    oauth2.sso.userInfoUrl=http://localhost:12306/idp/oauth2/getUserInfo
    #æˆæƒå›è°ƒåœ°å€ï¼Œç”±ã€Nginxä»£ç†å½“å‰æœåŠ¡çš„åœ°å€ æˆ– å½“å‰æœåŠ¡åœ°å€+"/api/oauth2/callback"ã€‘ ç»„æˆï¼Œç¤ºä¾‹ï¼šhttps://{host}:{port}/api/oauth2/callback
    oauth2.sso.redirectUri=http://localhost:8188/api/oauth2/callback
    

å¯åŠ¨é¡¹ç›®(8188ç«¯å£ï¼Œæœ‰ä¸¤ä¸ªapiåœ°å€: `/api/oauth2/sso` ä¸ `/api/oauth2/callback`)ï¼Œå…ˆé€šè¿‡ç¨‹åº `http://localhost:8188/api/oauth2/sso`

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325101107363-507682946.png)

ç¬¬ä¸€ã€äºŒä¸ªè¯·æ±‚ä¼šé‡å®šå‘è¯·æ±‚åˆ° Moco æœåŠ¡ä¸Šçš„ `æˆæƒå›è°ƒæ¥å£` å¹¶å¸¦ä¸Šä¸€äº›å‚æ•°

ç¬¬ä¸‰ä¸ªè¯·æ±‚ç”± Moco æœåŠ¡çš„ `æˆæƒå›è°ƒæ¥å£` å›è°ƒé¡¹ç›®çš„å›è°ƒåœ°å€ï¼ˆæˆæƒç å›è°ƒï¼Œé¡¹ç›®ä¼šå…ˆè°ƒç”¨ Moco çš„ `è·å–tokenæ¥å£` ï¼‰ï¼Œç„¶åå› ä¸ºå…¨å±€é”™è¯¯æ‹¦æˆªè¿”å›äº†å·¦ä¾§çš„ JSONï¼Œæç¤º `"400 Bad Request: [no body]"`

å‘ç°é—®é¢˜
----

æˆ‘è¿˜ä»¥ä¸ºæ˜¯ Moco æœåŠ¡çš„é—®é¢˜ï¼Œå°±ç”¨ Postman è°ƒäº†ä¸‹ `è·å–tokenæ¥å£`ï¼Œç»“æœæ˜¯é€šçš„ï¼ï¼

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325102035777-581524310.png)

ç„¶åå†çœ‹ä¸‹ Moco çš„æ§åˆ¶å°è¾“å‡ºï¼š

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325102424777-1318527051.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325102636699-226902369.png)

ç»è¿‡æ‰¾ä¸åŒï¼Œå‘ç°é¡¹ç›®è°ƒç”¨æ¥å£æ—¶è¯·æ±‚å¤´ `Content-Type` åŠ äº† `;chartset=UTF-8` ï¼ï¼ï¼

ç”±äº Moco é…ç½®æ–‡ä»¶é‡ŒæŒ‡å®šè¯·æ±‚å¤´å¿…é¡»ä¸€è‡´ï¼Œæ‰èƒ½æ­£ç¡®è¿”å›ï¼Œå¦åˆ™å°±æ˜¯ `400`çŠ¶æ€ç ï¼Œè€Œä¸”æ²¡æœ‰è¿”å›ä½“ã€‚

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325103352057-262174373.png)

å®šä½é—®é¢˜
----

å…ˆçœ‹çœ‹å‡ºé—®é¢˜çš„ä»£ç éƒ¨åˆ†ï¼š

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325125029153-710308271.png)

æ€€ç–‘ `MediaType.APPLICATION_FORM_URLENCODED` å€¼æœ‰UTF-8å­—ç¬¦é›†ï¼Œç‚¹è¿›å»

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325125305004-177637497.png)

çœ‹æ³¨é‡Šæ—¶å†™çš„æ˜¯ä¸å¸¦å­—ç¬¦é›†çš„ï¼Œdebug çœ‹ä¸‹ `setContentType`åçš„ `headers` å†…å®¹

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325125524010-1996726871.png)

ç»§ç»­debug

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325125701843-349738690.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325125807640-1148721126.png)

çœ‹æ¥è¿˜æ²¡æ”¹å˜ï¼Œç»§ç»­debugï¼Œè¿›å…¥ `RestTemplate` çš„ `exchange()` æ–¹æ³•

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325130113580-706600569.png)

`resolveUrl()` è¿™ä¸ªæ–¹æ³•æˆ‘çœ‹äº†ä¸‹ï¼Œæ²¡æ¶‰åŠæ”¹è¯·æ±‚å¤´ï¼Œé—®é¢˜åº”å‡ºåœ¨ `doExecute()` æ–¹æ³•ä¸­ï¼Œæ–­ç‚¹æ‰“åœ¨ `request` å¯¹è±¡åï¼Œçœ‹çœ‹ `request` å¯¹è±¡ä¸­çš„ `headers`ï¼Œå‘ç°æ˜¯ç©ºçš„ï¼Œè€Œä¸‹è¾¹æœ‰ä¸€ä¸ªæ–¹æ³•æ˜¯ `requestCallback.doWithRequest(request);` çœ‹èµ·æ¥æ˜¯å¯¹ `request` å¯¹è±¡è¿›è¡Œäº†å¤„ç†ï¼Œç›´æ¥è·Ÿè¿›å»

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325130608137-1395527372.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325130808207-402988079.png)

`RequestCallback` æœ‰ä¸¤ä¸ªæœ€ç»ˆçš„å®ç°ï¼Œ`Xhr` å¯¹åº” `XMLHttpRequest`ï¼Œè¿™é‡Œå‘çš„æ˜¯HTTPè¯·æ±‚ï¼Œæ‰€ä»¥æ˜¯ `HttpEntityRequestCallback` çš„å®ç°

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325130901584-892798707.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325132000057-781872539.png)

åœ¨æ€€ç–‘çš„ä½ç½®æ‰“ä¸¤ä¸ªæ–­ç‚¹ï¼Œè·Ÿè¿›å¾ªç¯çœ‹çœ‹ï¼Œé¦–å…ˆè¿›äº†ä¸‹è¾¹çš„åˆ¤æ–­ï¼Œ`messageConverter` å¯¹è±¡æ˜¯ `AllEncompassingFormHttpMessageConverter` çš„å®ä¾‹ï¼Œè€Œä¸”åœ¨`write()`æ–¹æ³•æ‰§è¡Œå‰ï¼Œ`headers` ä»æ˜¯æ­£å¸¸çš„

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325132351647-1403072723.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325132243004-672424294.png)

æŸ¥çœ‹ `write()` æ–¹æ³•å®ç°ï¼Œç»å…¸ 3 é€‰ 1ï¼Œç”±äºæˆ‘ä»¬çš„ `Content-Type` æ˜¯ `application/x-www-form-urlencoded`ï¼Œç†åº”è¿›å…¥ `FormHttpMessageConverter` å®ç°ä¸­

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325132536011-1044787903.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325132902691-969354425.png)

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325133006977-923933080.png)

`writeForm()` æ‰§è¡Œå‰ `ContentType` ä»æœªæ”¹å˜ï¼Œè¿›å…¥ `writeForm()` æ–¹æ³•çœ‹çœ‹

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325133509684-284143485.png)

ç»ˆäºï¼Œåœ¨ `org.springframework.http.converter.FormHttpMessageConverter.getFormContentType(MediaType)` çš„æ³¨é‡Šå’Œä»£ç ä¸­å‘ç°äº†é—®é¢˜ã€‚

å¯¹äºè¡¨å•å†…å®¹ç±»å‹çš„è¯·æ±‚çš„ `ContentType` è®¾ç½®åˆ†ä¸‰ç§æƒ…å†µï¼š

*   å¦‚æœæ²¡æœ‰ `ContentType` å°±é»˜è®¤æ·»åŠ  `application/x-www-form-urlencoded;charset=UTF-8`
*   å¦‚æœæœ‰ `ContentType` ä½†æ²¡å­—ç¬¦é›†ï¼Œä¹Ÿä¼šè‡ªåŠ¨åŠ å­—ç¬¦é›†
*   å¦‚æœ `ContentType` å­˜åœ¨ä¸”æœ‰å­—ç¬¦é›†è®¾ç½®ï¼Œåˆ™ç›´æ¥è¿”å›

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325133747809-1730535418.png)

è·³å‡º `getFormContentType()`ï¼Œå¯ä»¥çœ‹åˆ° `contenType` å¯¹è±¡å·²ç»æœ‰å­—ç¬¦é›†äº†ã€‚

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325135120754-1001395953.png)

è”æƒ³åˆ°ä½œè€…ä¿¡èª“æ—¦æ—¦åœ°æ³¨é‡Š `// should never occur` è¿™å°±å¾ˆè¯´æ˜é—®é¢˜äº† ğŸ¤ª

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325134253628-1533773112.png)

è§£å†³é—®é¢˜
----

`RestTemplate` è‡ªåŠ¨ä½¿ç”¨ `org.springframework.http.converter.FormHttpMessageConverter` æ·»åŠ å­—ç¬¦é›†å¯èƒ½æ˜¯å‡ºäºå¯¹è¯·æ±‚ä¹±ç çš„æ‹…å¿§ã€‚è€Œæˆ‘ä»¬è¿™é‡Œçš„ Moco é…ç½®æ·»åŠ äº†è¯·æ±‚å¤´åˆ¤æ–­ï¼Œå€¼å…¨è½¬æˆå¤§å†™æˆ–å°å®ä¸€å®šè¦ä¸€è‡´ï¼Œæ‰€ä»¥æ”¹ä¸€ä¸‹ Moco é—®é¢˜æ¥å£é…ç½®çš„content-typeçš„å€¼ï¼ŒåŠ ä¸Šå­—ç¬¦é›†éªŒè¯æ•ˆæœã€‚

![](https://img2022.cnblogs.com/blog/1149398/202203/1149398-20220325135455175-2072188491.png)

æœ‰1è¯´1 ï¼Œä¿å­˜å®Œåï¼Œçœ‹ä¸‹ Moco æ§åˆ¶å°å®ƒå·²ç»è‡ªåŠ¨åˆ·æ–°é…ç½®æ–‡ä»¶äº†ï¼ŒMoco çœŸå¥½ç”¨ã€‚

é‡æ–°è°ƒç”¨æ¥å£éªŒè¯é€šè¿‡ã€‚