---
layout: post
title: "Seata 1.5.2 æºç å­¦ä¹ "
date: "2022-11-09T16:28:08.649Z"
---
Seata 1.5.2 æºç å­¦ä¹ 
================

æ–‡ç« æœ‰ç‚¹é•¿ï¼Œæˆ‘å†³å®šç”¨åŠä¸ªå°æ—¶æ¥å’Œä½ åˆ†äº«~ğŸ˜‚ åºŸè¯ä¸å¤šè¯´ï¼Œä¸Šä»£ç ã€‚ã€‚ã€‚

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107171907664-441059075.png)

åŸºäºSeata 1.5.2ï¼Œé¡¹ç›®ä¸­ç”¨ seata-spring-boot-starter

1\. SeataDataSourceAutoConfiguration

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107171840926-1361420588.png)

SeataDataSourceAutoConfiguration ä¸»è¦æ˜¯é…ç½®æ•°æ®æºä»£ç†ï¼Œå¯ä»¥çœ‹åˆ°ï¼š

1.  é»˜è®¤seata.enabledã€seata.enableAutoDataSourceProxyã€seata.enable-auto-data-source-proxyéƒ½æ˜¯true
2.  åªæœ‰å½“classpathä¸­æœ‰DataSourceæ—¶æ‰ä¼šè¿›è¡Œæ­¤é…ç½®
3.  åˆ›å»ºäº†ä¸€ä¸ªSeataAutoDataSourceProxyCreatorï¼Œç”¨äºè‡ªåŠ¨ä»£ç†æ•°æ®æº

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107172628110-926685738.png)

å…ˆè®°ä¸€ä¸‹ï¼ŒSeataAutoDataSourceProxyCreatoræ˜¯ä¸€ä¸ªBeanPostProcessor

åˆšæ‰newäº†ä¸€ä¸ªSeataAutoDataSourceProxyCreatorï¼Œç»§ç»­çœ‹æ„é€ æ–¹æ³•ï¼Œé»˜è®¤useJdkProxyæ˜¯falseï¼Œexcludesä¸ºç©ºï¼ŒdataSourceProxyModeæ˜¯AT

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107175359347-1977222225.png)

æ„é€ æ–¹æ³•ä¸­æœ€é‡è¦çš„ä¸€ä»¶äº‹æƒ…æ˜¯æ„é€ AOPé€šçŸ¥ï¼ˆæ‹¦æˆªå™¨ï¼‰ï¼Œè¿™é‡Œnewäº†ä¸€ä¸ªSeataAutoDataSourceProxyAdvice

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107180719002-959863460.png)

SeataAutoDataSourceProxyAdviceæ˜¯ä¸€ä¸ªMethodInterceptorã€‚

MethodInterceptoræ˜¯aopä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå½“ç›®æ ‡æ–¹æ³•è¢«è°ƒç”¨æ—¶å°±ä¼šè°ƒç”¨ä¸ä¹‹å…³è”çš„MethodInterceptorçš„invokeæ–¹æ³•

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107181438892-1131873033.png)

è‡³æ­¤ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­å®Œæˆäº†advisorsçš„èµ‹å€¼ï¼Œadvisors\[\]ä¸­æœ‰ä¸€ä¸ªDefaultIntroductionAdvisorï¼ŒDefaultIntroductionAdvisorä¸­å¼•ç”¨äº†SeataAutoDataSourceProxyAdvice

å‰é¢è¯´è¿‡ï¼ŒSeataAutoDataSourceProxyCreatoræ˜¯ä¸€ä¸ªBeanPostProcessorï¼Œè€ŒBeanPostProcessoræ˜¯BeanFactoryä¸­çš„ä¸€ä¸ªé’©å­ï¼ˆå›è°ƒï¼‰ï¼Œç§°ä¹‹ä¸ºåç½®å¤„ç†å™¨

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221107182724826-1863689240.png)

AbstractAutoProxyCreator#postProcessBeforeInstantiation()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108112107659-2051647751.png)

AbstractAutoProxyCreator#postProcessAfterInitialization()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108101721346-1844429461.png)

AbstractAutoProxyCreator#wrapIfNecessary()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108103117730-1463722344.png)

AbstractAutoProxyCreator#getAdvicesAndAdvisorsForBean()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108104132547-1628430548.png)

SeataAutoDataSourceProxyCreator#getAdvicesAndAdvisorsForBean()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108104814084-1771654288.png)

SeataAutoDataSourceProxyCreator#wrapIfNecessary()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108101731889-492192588.png)

DataSourceProxyHolderç»´æŠ¤äº†æ•°æ®æºå¯¹è±¡ä¸æ•°æ®æºä»£ç†å¯¹è±¡çš„æ˜ å°„

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108113605353-1249002755.png)

è‡³æ­¤ï¼Œæ•°æ®æºä»£ç†éƒ¨åˆ†å°±çœ‹å®Œäº†ï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ï¼š

1ã€å¯åŠ¨çš„æ—¶å€™è‡ªåŠ¨é…ç½®æ•°æ®æºä»£ç†ï¼Œåˆ›å»ºäº†ä¸€ä¸ªSeataAutoDataSourceProxyCreator

2ã€SeataAutoDataSourceProxyCreatoråœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºAOPé€šçŸ¥ï¼Œå¹¶èµ‹å€¼ç»™å…¶å±æ€§

3ã€AbstractAutoProxyCreatoræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ä¸èƒ½è¢«å®ä¾‹åŒ–ï¼Œèƒ½å®ä¾‹åŒ–çš„åªæœ‰SeataAutoDataSourceProxyCreator

4ã€SeataAutoDataSourceProxyCreatorä»AbstractAutoProxyCreatoré‚£é‡Œç»§æ‰¿äº†å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ï¼Œå…¶ä¸­å°±åŒ…æ‹¬postProcessBeforeInstantiation()ã€postProcessAfterInitialization()ã€createProxy()ç­‰ç­‰

5ã€SeataAutoDataSourceProxyCreatoré—´æ¥å®ç°äº†BeanPostProcessoræ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¹Ÿæ˜¯BeanPostProcessorçš„ä¸€ä¸ªå®ç°ç±»

6ã€BeanFactoryå›è°ƒæ‰€æœ‰çš„BeanPostProcessor#postProcessAfterInitialization()æ—¶ï¼Œå°±ä¼šè°ƒç”¨SeataAutoDataSourceProxyCreatorçš„postProcessAfterInitialization()æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨wrapIfNecessary()æ–¹æ³•

7ã€wrapIfNecessary()åªå…³å¿ƒDataSourceå¯¹è±¡ï¼Œå®ƒè´Ÿè´£ä¸ºDataSourceå¯¹è±¡ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨SeataAutoDataSourceProxyCreatorä¸­ç»´æŠ¤äº†DataSourceå¯¹è±¡ä¸SeataDataSourceProxyå¯¹è±¡ä¹‹é—´çš„æ˜ å°„å…³å¿ƒ

8ã€åˆ›å»ºä»£ç†å¯¹è±¡æ—¶ï¼Œä¼šç»™DataSourceå¯¹è±¡åº”ç”¨AOPæ‹¦æˆªå™¨ã€‚ç”¨AOPçš„è¯æ¥è®²ï¼Œå°±æ˜¯ç»™ç›®æ ‡å¯¹è±¡DataSourceç»‡å…¥é€šçŸ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªè¢«å¢å¼ºçš„ä»£ç†å¯¹è±¡

9ã€é€šçŸ¥ï¼ˆæ‹¦æˆªå™¨ï¼‰æ˜¯SeataAutoDataSourceProxyAdviceï¼Œå®ƒå®ç°äº†MethodInterceptoræ¥å£

10ã€SeataAutoDataSourceProxyAdvice#invoke()æ–¹æ³•æ‰€åšçš„äº‹æƒ…å°±æ˜¯ï¼Œæ‹¿åˆ°åŸå§‹DataSourceçš„ä»£ç†å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ç›®æ ‡æ–¹æ³•

ç»¼ä¸Šæ‰€è¿°ï¼Œä»¥ä¸Šåšçš„æ‰€æœ‰å·¥ä½œéƒ½æ˜¯ä¸ºäº†å°†æ¥è°ƒç”¨ javax.sql.DataSource ä¸Šçš„ä»»æ„æ–¹æ³•æ—¶éƒ½ä¼šè¢«æ‹¦æˆªï¼Œç„¶åè°ƒç”¨å…¶ä»£ç†å¯¹è±¡ä¸Šå¯¹åº”çš„æ–¹æ³•ã€‚è€ŒDataSourceä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ–¹æ³•å°±æ˜¯getConnection()

åˆ’é‡ç‚¹ï¼šå°†æ¥ï¼Œæ‰€æœ‰è°ƒç”¨ javax.sql.DataSource#getConnection() éƒ½ä¼šè¢«æ‹¦æˆªï¼Œç„¶ååœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡ŒgetConnection()ï¼Œå› æ­¤å¯ä»¥è¿™æ ·è¯´

è°ƒ javax.sql.DataSource#getConnection() å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ io.seata.rm.datasource.SeataDataSourceProxy#getConnection()

2\. SeataAutoConfiguration

SeataAutoConfigurationé‡Œé¢ä¸»è¦æ˜¯é…ç½®GlobalTransactionScannerï¼ˆå…¨å±€äº‹åŠ¡æ‰«æå™¨ï¼‰

seata.enabled=true æ‰ä¼šå¼€å¯ SeataAutoConfiguration

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108144057109-1707155121.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108144219512-2002776459.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108141501369-1891395501.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108144313626-1070422826.png)

GlobalTransactionScanner ä¹Ÿç»§æ‰¿è‡ª AbstractAutoProxyCreatorï¼ŒåŒæ—¶è¿˜å®ç°äº†InitializingBeanæ¥å£ã€‚BeanFactoryåœ¨è®¾ç½®äº†æ‰€æœ‰beanå±æ€§ä¹‹åä¼šè°ƒç”¨InitializingBeançš„afterPropertiesSet()æ–¹æ³•

GlobalTransactionScanner#afterPropertiesSet()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108142413614-441205471.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108142820973-69441343.png)

io.seata.common.DefaultValuesä¸­å®šä¹‰äº†å¾ˆå¤šé»˜è®¤å€¼

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108143124457-1970671247.png)

åŒæ ·åœ°ï¼Œå› ä¸ºå®ç°äº†BeanPostProcessoræ¥å£ï¼Œæ‰€ä»¥åœ¨å¯åŠ¨æ—¶BeanFactoryå®ä¾‹åŒ–Beanä¹‹åï¼Œä¼šè°ƒç”¨GlobalTransactionScannerçš„postProcessAfterInitialization()ï¼Œå°½ç®¡è¿™ä¸ªpostProcessAfterInitialization()æ–¹æ³•æ—¶ä»AbstractAutoProxyCreatoré‚£é‡Œç»§æ‰¿æ¥çš„ï¼Œä½†æ˜¯ä¸å½±å“å•Šï¼Œè¿˜æ˜¯ä¼šè°ƒç”¨GlobalTransactionScannerè¿™ä¸ªbeançš„postProcessAfterInitialization()æ–¹æ³•ã€‚äºæ˜¯ï¼Œæœ€ç»ˆåˆä¼šè°ƒwrapIfNecessary()æ–¹æ³•ã€‚

GlobalTransactionScanner#wrapIfNecessary()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108162523049-1771318525.png)

è¿™é‡Œé¢æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„é€»è¾‘å°±æ˜¯ï¼Œåˆ›å»ºäº†ä¸€ä¸ªGlobalTransactionalInterceptorå¯¹è±¡ï¼Œå¹¶èµ‹å€¼ç»™interceptor

AbstractAutoProxyCreator#getAdvicesAndAdvisorsForBean()æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ç°åœ¨å­ç±»GlobalTransactionScannerä¸­

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108162936236-1644367648.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108163036709-1892250316.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108163437845-946275007.png)

å› æ­¤ï¼Œæ‰€æœ‰åœ¨GlobalTransactionScanner#wrapIfNecessary()ä¸­è¢«ä»£ç†çš„å¯¹è±¡ï¼Œéƒ½è¢«åº”ç”¨GlobalTransactionalInterceptor

GlobalTransactionalInterceptorä¹Ÿæ˜¯ä¸€ä¸ªMethodInterceptor

ä¹Ÿå°±æ˜¯è¯´ï¼Œç›®æ ‡æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè½¬åˆ°GlobalTransactionalInterceptor#invoke()ä¸Š

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108170227390-633320580.png)

GlobalTransactionalInterceptor#handleGlobalTransaction()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108171226128-1252076327.png)

äº‹åŠ¡æ‰§è¡Œç›´æ¥è°ƒç”¨TransactionalTemplateçš„execute()æ–¹æ³•

io.seata.tm.api.TransactionalTemplate#execute()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108174300762-1962189263.png)

io.seata.tm.api.GlobalTransactionContext#getCurrent() è·å–å½“å‰äº‹åŠ¡

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108174507238-1965200698.png)

io.seata.tm.api.TransactionalTemplate#beginTransaction()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108174933239-796752092.png)

txæ˜¯DefaultGlobalTransaction

io.seata.tm.api.DefaultGlobalTransaction#begin()

DefaultGlobalTransactionä¸­çš„TransactionManageræ˜¯DefaultTransactionManager

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108175408718-1005950442.png)

DefaultTransactionManagerä¸­æä¾›äº†äº‹åŠ¡ç›¸å…³çš„åº•å±‚æ“ä½œ

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108180416158-642873715.png)

io.seata.tm.api.DefaultGlobalTransaction#commit()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108180848374-1038720566.png)

io.seata.tm.api.DefaultGlobalTransaction#rollback()çš„é€»è¾‘ä¸commit()ç±»ä¼¼ï¼Œéƒ½æ˜¯é‡è¯•è°ƒç”¨transactionManager.rollback(xid)

å…¨å±€äº‹åŠ¡æ‰«æå™¨éƒ¨åˆ†çš„ä»£ç å°±çœ‹åˆ°è¿™é‡Œï¼Œä¸‹é¢æ€»ç»“ä¸€ä¸‹ï¼š

1ã€é…ç½®é¡¹seata.enabled=true ä¼šè§¦å‘ SeataAutoConfiguration è‡ªåŠ¨é…ç½®

2ã€SeataAutoConfigurationä¸­åˆ›å»ºäº†ä¸€ä¸ªGlobalTransactionScanner

3ã€GlobalTransactionScannerç»§æ‰¿äº†AbstractAutoProxyCreatorï¼Œå¹¶å®ç°InitializingBeanæ¥å£

4ã€åˆå§‹åŒ–TMã€RM

5ã€ç”±äºç»§æ‰¿äº†AbstractAutoProxyCreatorï¼Œæ‰€ä»¥BeanFactoryä¼šè°ƒç”¨GlobalTransactionScanner#æ–¹æ³•postProcessAfterInitialization()ï¼Œæœ€ç»ˆä¼šè°ƒç”¨GlobalTransactionScanner#wrapIfNecessary()æ¥ä¸ºç›®æ ‡å¯¹è±¡åˆ›å»ºä»£ç†å¯¹è±¡

6ã€GlobalTransactionScanner#wrapIfNecessary()ä¸­åˆ›å»ºäº†ä¸€ä¸ªGlobalTransactionalInterceptorï¼ŒGlobalTransactionalInterceptoræ˜¯ä¸€ä¸ªMethodInterceptor

7ã€åœ¨åˆ›å»ºä»£ç†å¯¹è±¡çš„æ—¶å€™ï¼Œåœ¨AbstractAutoProxyCreator#wrapIfNecessary()æ–¹æ³•ä¸­ï¼Œä¸ºä»£ç†å¯¹è±¡åº”ç”¨GlobalTransactionalInterceptorï¼Œäºæ˜¯æ‰€æœ‰ç›®æ ‡å¯¹è±¡ä¸Šçš„æ–¹æ³•è°ƒç”¨å°±ä¼šè½¬ä¸ºè°ƒç”¨GlobalTransactionalInterceptor#invoke()

8ã€GlobalTransactionalInterceptor#invoke()æ–¹æ³•ä¸­ï¼Œé¦–å…ˆè·å–è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡çš„Classå’ŒMethodå¯¹è±¡ï¼Œç„¶åæ£€æŸ¥ç›®æ ‡æ–¹æ³•æˆ–ç±»ä¸Šæ˜¯å¦æœ‰@GlobalTransactionalæˆ–@GlobalLockæ³¨è§£ï¼Œè€Œä¸”é…ç½®é¡¹ä¸­ä¸èƒ½ç¦ç”¨å…¨å±€äº‹åŠ¡

9ã€å¦‚æœåŠ äº†@GlobalTransactionalæ³¨è§£ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªAspectTransactionalï¼Œç„¶åå¼€å§‹å¤„ç†å…¨å±€äº‹åŠ¡ï¼Œé»˜è®¤ä¼ æ’­ç‰¹æ€§æ˜¯REQUIRED

10ã€å¦‚æœåŠ äº†@GlobalLockæ³¨è§£ï¼Œåˆ™å¼€å§‹å¤„ç†å…¨å±€é”

11ã€å¤„ç†å…¨å±€äº‹åŠ¡å°±æ˜¯ç›´æ¥è°ƒç”¨äº‹åŠ¡æ¨¡æ¿ä¸­çš„executeæ–¹æ³•ï¼ŒTransactionalTemplate#execute()æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå…¶ä¸­å®šä¹‰äº†äº‹åŠ¡å¤„ç†çš„æµç¨‹ã€‚é¦–å…ˆå¼€å¯äº‹åŠ¡ï¼Œç„¶åæ‰§è¡Œä¸šåŠ¡é€»è¾‘ï¼Œæœ€åæäº¤äº‹åŠ¡ï¼Œå¼‚å¸¸å›æ»šäº‹åŠ¡ã€‚

12ã€äº‹åŠ¡æ“ä½œæ˜¯åœ¨DefaultGlobalTransactionä¸­å¤„ç†çš„ï¼Œæœ€ç»ˆå¤„ç†åœ¨DefaultTransactionManagerã€‚DefaultTransactionManagerè´Ÿè´£åŒæ­¥è¿œç¨‹è°ƒç”¨ï¼Œå‘TCå‘è¯·æ±‚æ¥å¼€å¯ã€æäº¤ã€å›æ»šäº‹åŠ¡ç­‰æ“ä½œ

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221108185229605-402816916.png)

3\. æ•°æ®åº“æ“ä½œæ‰§è¡ŒSQLè¯­å¥

é€šè¿‡Javaè‡ªå¸¦çš„JDBCæ“ä½œæ•°æ®åº“é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š

    Class.forName(driverClass);
    // è·å–Connection
    Connection connection = DriverManager.getConnection(url,user,password);
    // åˆ›å»ºStatementæˆ–è€…PreparedStatement
    Statement stmt = connection.createStatement();
    stmt.execute(sql);
    
    // PreparedStatement ps = connection.prepareStatement(sql);
    // ps.execute();

MyBatisåº•å±‚ä¹Ÿæ˜¯è¿™ä¸€å¥—

æ¥ä¸‹æ¥çœ‹Seataæ˜¯å¦‚ä½•åšçš„

é¦–å…ˆæ˜¯è·å–æ•°æ®åº“è¿æ¥Connectionï¼Œå‰é¢å·²ç»è¯´è¿‡äº†ï¼Œè°ƒç”¨DataSourceçš„getConnection()æ–¹æ³•åº•å±‚æ˜¯åœ¨ä»£ç†å¯¹è±¡SeataDataSourceProxyä¸Šè°ƒç”¨getConnection()ã€‚SeataDataSourceProxyæ˜¯æ¥å£ï¼Œå¦‚æœæ˜¯ATæ¨¡å¼ï¼Œåˆ™è¿™ä¸ªæ•°æ®æºä»£ç†å¯¹è±¡æ˜¯DataSourceProxy

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109110844980-1838961946.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109111156350-1393397445.png)

DataSourceProxy#getConnection()è·å–æ•°æ®åº“è¿æ¥

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109111703898-678048951.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109111901428-205267395.png)

ConnectionProxy#createStatement()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109112444597-1024823.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109112626940-358549685.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109112752094-1343758169.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109112853646-218547298.png)

ConnectionProxy#prepareStatement()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109113023330-2098681247.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109113159042-109228636.png)

PreparedStatementProxy ç»§æ‰¿è‡ª StatementProxyï¼Œå› æ­¤ä¸‹é¢å°±ç›´æ¥çœ‹PreparedStatementProxyå¦‚ä½•æ‰§è¡ŒSQL

PreparedStatementProxy#execute()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109114150721-1866370946.png)

ExecuteTemplate#execute()Â  æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109115603531-971728161.png)

æŒ‘ä¸€ä¸ªçœ‹çœ‹å§ï¼Œå°±æŒ‘UpdateExecutor

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109115828447-245939565.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109115948591-301533812.png)

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109120142868-1383066187.png)

UpdateExecutoræ„é€ æ–¹æ³•ä¸­ä¸€ç›´è°ƒçˆ¶ç±»çš„æ„é€ æ³•ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£ä¹ˆç›´æ¥çœ‹BaseTransactionalExecutor

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109120236766-1593801622.png)

UpdateExecutor#execute()

è¿™ä¸ªæ–¹æ³•æ—¶ä»BaseTransactionalExecutoré‚£é‡Œç»§æ‰¿æ¥çš„ï¼Œåˆæ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œå¯è§è®¾è®¡æ¨¡å¼æ˜¯å¤šä¹ˆé‡è¦

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109120806284-78839760.png)

AbstractDMLBaseExecutor#doExecute()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109121658988-616343043.png)

AbstractDMLBaseExecutor#executeAutoCommitTrue()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109143705552-1362209246.png)

ConnectionProxy#changeAutoCommit()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109154515729-1559986124.png)

ç°åœ¨äº‹åŠ¡è‡ªåŠ¨æäº¤å·²ç»è¢«Seataæ”¹æˆfalseäº†

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109151229123-1861551283.png)

UpdateExecutor#beforeImage()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109150453822-1590066217.png)

BaseTransactionalExecutor#prepareUndoLog()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109152235456-1978807148.png)

æ¥ä¸‹æ¥ï¼Œæäº¤äº‹åŠ¡

ConnectionProxy#commit()

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109154627260-174126513.png)

ConnectionProxy#processGlobalTransactionCommit() å¤„ç†å…¨å±€äº‹åŠ¡æäº¤

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109162235869-1577977412.png)

åˆ†æ”¯äº‹åŠ¡æäº¤ä»¥åï¼Œä¸šåŠ¡æ•°æ®æ›´æ”¹å’Œundo\_logå°±éƒ½æäº¤äº†

å›æƒ³ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆåœ¨æ‰§è¡Œä¸šåŠ¡ä¿®æ”¹å‰è¦å…ˆå°†é»˜è®¤çš„è‡ªåŠ¨æäº¤æ”¹æˆæ‰‹åŠ¨æäº¤ï¼Œæœ€åå†æ”¹æˆè‡ªåŠ¨æäº¤å‘¢ï¼Ÿ

å› ä¸ºï¼Œè¦å°†ä¸šåŠ¡æ•°æ®ä¿®æ”¹å’Œæ’å…¥undo\_logæ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡é‡Œï¼Œä¸€èµ·æäº¤

è¿™ä¸€åˆ‡éƒ½å½’åŠŸäºä»£ç†

å›é¡¾ä¸€ä¸‹æ•´ä¸ªè°ƒç”¨é“¾

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109173430529-1001698251.png)

ç»“åˆä¹‹å‰çš„æ¡ˆä¾‹ï¼ŒATæ¨¡å¼TCã€TMã€RMä¸‰è€…çš„äº¤äº’åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š

![](https://img2022.cnblogs.com/blog/874963/202211/874963-20221109184652811-515068922.png)

**é—®é¢˜ä¸€**ï¼šä¸ºä»€ä¹ˆåœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå…ˆå°†æ•°æ®åº“è‡ªåŠ¨æäº¤autoCommitè®¾ä¸ºfalseï¼Œæœ€åå†æ”¹æˆtrueå‘¢ï¼Ÿ

ç­”ï¼šå› ä¸ºï¼Œéœ€è¦å°†undo\_logå’Œä¸šåŠ¡æ•°æ®ä¿®æ”¹æ”¾åˆ°åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä¸šåŠ¡æ•°æ®ä¿®æ”¹æˆåŠŸåundo\_logå¿…ç„¶æ’å…¥æˆåŠŸï¼Œæ‰€ä»¥Seataè¦å°†å…¶æ”¹ä¸ºæ‰‹åŠ¨æäº¤ã€‚æœ€åå†æ”¹æˆtrueæ˜¯å› ä¸ºé»˜è®¤autoCommitå°±æ˜¯trueï¼Œè¿™æ ·å¯ä»¥ä¸å½±å“å…¶å®ƒä¸šåŠ¡ã€‚

**é—®é¢˜äºŒ**ï¼šä»€ä¹ˆæƒ…å†µä¸‹ConnectionContextä¸­xid=nullï¼Œä¸”isGlobalLockRequire=trueå‘¢ï¼Ÿæˆ–è€…æ¢ä¸€ç§é—®æ³•ï¼Œä»€ä¹ˆæƒ…å†µä¸‹ä¸åœ¨å…¨å±€äº‹åŠ¡ä¸­ï¼Œå½“ä»ç„¶éœ€è¦å…¨å±€é”å‘¢ï¼Ÿ

ç­”ï¼šå½“ä¸šåŠ¡æ–¹æ³•ä¸Šä¸åŠ @GlobalTransactionalï¼Œè€Œæ˜¯åªåŠ äº†@GlobalLockæ³¨è§£çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šå‡ºç°ä¸Šè¿°æƒ…å†µï¼Œä¹Ÿå°±ä¼šæ‰§è¡Œ ConnectionProxy#processLocalCommitWithGlobalLocks()æ–¹æ³•ï¼Œåœ¨äº‹åŠ¡æäº¤å‰æ£€æŸ¥å…¨å±€é”ï¼Œè¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯åœ¨ATæ¨¡å¼ä¸‹ï¼Œä¸å‡ºç°è„è¯»ã€è„å†™ã€‚ç”±äºæ•°æ®æºè¢«ä»£ç†äº†ï¼Œå½“ä¸€ä¸ªåŠ äº†@GlobalTransactionalçš„å…¨å±€äº‹åŠ¡ï¼Œä¸å¦ä¸€ä¸ªåŠ äº†@GlobalTransactionalæˆ–@GlobalLockæ³¨è§£çš„äº‹åŠ¡åœ¨æœ¬åœ°äº‹åŠ¡æäº¤å‰å°±ä¼šæ£€æŸ¥å…¨å±€é”ï¼Œè¦å…ˆè·å¾—å…¨å±€é”æ‰èƒ½æäº¤æœ¬åœ°äº‹åŠ¡ï¼Œè¿™æ ·å°±é¿å…äº†è„è¯»è„å†™ï¼Œä»è€Œç›¸å½“äºå®ç°äº†å…¨å±€äº‹åŠ¡çš„è¯»å·²æäº¤éš”ç¦»çº§åˆ«ã€‚å‚è§ï¼š[https://seata.io/zh-cn/blog/seata-at-lock.html](https://seata.io/zh-cn/blog/seata-at-lock.html)

å…³äºSeata 1.5.2 Clientç«¯çš„æºç å­¦ä¹ å°±å…ˆåˆ°è¿™é‡Œï¼Œæ¬¢è¿äº¤æµ~

å¦‚æœä½ éƒ½å·²ç»çœ‹åˆ°äº†è¿™é‡Œï¼Œä¸å¦¨ç»™æˆ‘ç‚¹ä¸ªèµå§ğŸ˜„