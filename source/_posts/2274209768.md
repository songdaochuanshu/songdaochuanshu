---
layout: post
title: "çº¿ç¨‹ç§æœ‰å˜é‡ThreadLocalè¯¦è§£"
date: "2023-02-14T23:16:52.530Z"
---
æœ¬æ–‡å·²æ”¶å½•è‡³Githubï¼Œæ¨èé˜…è¯» ğŸ‘‰ [Javaéšæƒ³å½•](https://github.com/ZhengShuHai/JavaRecord)

å¾®ä¿¡å…¬ä¼—å·ï¼šJavaéšæƒ³å½•

CSDNï¼š [ç å†œBookSea](https://blog.csdn.net/bookssea)

> çƒˆç«è¯•çœŸé‡‘ï¼Œé€†å¢ƒè¯•å¼ºè€…ã€‚â€”â€”å¡å†…åŠ 

ç›®å½•

*   [ä»€ä¹ˆæ˜¯ThreadLocal](#ä»€ä¹ˆæ˜¯threadlocal)
*   [ThreadLocal åŸç†](#threadlocal-åŸç†)
    *   [set()æ–¹æ³•](#setæ–¹æ³•)
    *   [get()æ–¹æ³•](#getæ–¹æ³•)
    *   [remove()æ–¹æ³•](#removeæ–¹æ³•)
*   [ThreadLocal çš„Hashç®—æ³•](#threadlocal-çš„hashç®—æ³•)
*   [ThreadLocal 1.7å’Œ1.8çš„åŒºåˆ«](#threadlocal-17å’Œ18çš„åŒºåˆ«)
*   [ThreadLocal çš„é—®é¢˜](#threadlocal-çš„é—®é¢˜)
    *   [ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜](#threadlocal-å†…å­˜æ³„éœ²é—®é¢˜)
        *   [ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨?](#ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨)
    *   [ThreadLocal çˆ¶å­çº¿ç¨‹ç»§æ‰¿](#threadlocal-çˆ¶å­çº¿ç¨‹ç»§æ‰¿)

ä»€ä¹ˆæ˜¯ThreadLocal
--------------

é¦–å…ˆçœ‹ä¸‹ThreadLocalçš„ä½¿ç”¨ç¤ºä¾‹ï¼š

    public class ThreadLocalTest {
        private static ThreadLocal<String> threadLocal = new ThreadLocal<>();
     
        public static void main(String[] args) {
            Thread thread1 = new Thread(() -> {
                threadLocal.set("æœ¬åœ°å˜é‡1");
                print("thread1");
                System.out.println("çº¿ç¨‹1çš„æœ¬åœ°å˜é‡çš„å€¼ä¸º:"+threadLocal.get());
            });
     
            Thread thread2 = new Thread(() -> {
                threadLocal.set("æœ¬åœ°å˜é‡2");
                print("thread2");
                System.out.println("çº¿ç¨‹2çš„æœ¬åœ°å˜é‡çš„å€¼ä¸º:"+threadLocal.get());
            });
     
            thread1.start();
            thread2.start();
        }
     
        public static void print(String s){
            System.out.println(s+":"+threadLocal.get());
         
        }
    
    

æ‰§è¡Œç»“æœå¦‚ä¸‹

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1NbRPMl0QtMDm5rRqSmwtQrX0h1blZNEYlcYUgVCQOf9AlM0e7huUopaQ/0?wx_fmt=png)

æˆ‘ä»¬ä» `Thread` ç±»è®²èµ·ï¼Œåœ¨ `Thread` ç±»ä¸­æœ‰ç»´æŠ¤ä¸¤ä¸ª `ThreadLocal.ThreadLocalMap` å¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯ï¼š`threadLocals` å’Œ`inheritableThreadLocals`ã€‚

    /* ThreadLocal values pertaining to this thread. This map is maintained
     * by the ThreadLocal class. */
    ThreadLocal.ThreadLocalMap threadLocals = null;
    
    /*
     * InheritableThreadLocal values pertaining to this thread. This map is
     * maintained by the InheritableThreadLocal class.
     */
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    

åˆå§‹å®ƒä»¬éƒ½ä¸º nullï¼Œåªæœ‰åœ¨è°ƒç”¨ `ThreadLocal` ç±»çš„ set æˆ– get æ—¶æ‰åˆ›å»ºå®ƒä»¬ã€‚ThreadLocalMapå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹ç§æœ‰çš„HashMapã€‚

ThreadLoalMapæ˜¯ThreadLocalä¸­çš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œç±»ä¼¼HashMapçš„æ•°æ®ç»“æ„ï¼Œä½†å¹¶æ²¡æœ‰å®ç°Mapæ¥å£ã€‚

ThreadLoalMapä¸­åˆå§‹åŒ–äº†ä¸€ä¸ª**å¤§å°16çš„Entryæ•°ç»„**ï¼ŒEntryå¯¹è±¡ç”¨æ¥ä¿å­˜æ¯ä¸€ä¸ªkey-valueé”®å€¼å¯¹ã€‚keyæ˜¯ThreadLocalå¯¹è±¡ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1Nb99SpunAyTqvlVVfb7UiaRgKrrfZ4ol66dwao1eAEHaQs5xqNVe7CyKg/0?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1Nbicx9QuS9iadDf2MIWGWJoaJBQkhtOX92WBN4XclnOWTFgblibdYl07F7g/0?wx_fmt=png)

Entryç”¨æ¥ä¿å­˜æ•°æ® ï¼Œè€Œä¸”è¿˜æ˜¯ç»§æ‰¿çš„å¼±å¼•ç”¨ã€‚åœ¨Entryå†…éƒ¨ä½¿ç”¨ThreadLocalä½œä¸ºkeyï¼Œä½¿ç”¨æˆ‘ä»¬è®¾ç½®çš„valueä½œä¸ºvalueã€‚

ThreadLocal åŸç†
--------------

### set()æ–¹æ³•

å½“æˆ‘ä»¬è°ƒç”¨ ThreadLocal çš„ `set()` æ–¹æ³•æ—¶å®é™…æ˜¯è°ƒç”¨äº†å½“å‰çº¿ç¨‹çš„ ThreadLocalMap çš„ set() æ–¹æ³•ã€‚ThreadLocal çš„ set() æ–¹æ³•ä¸­ï¼Œä¼šè¿›ä¸€æ­¥è°ƒç”¨`Thread.currentThread()` è·å¾—å½“å‰çº¿ç¨‹å¯¹è±¡ ï¼Œç„¶åè·å–åˆ°å½“å‰çº¿ç¨‹å¯¹è±¡çš„ThreadLocalï¼Œåˆ¤æ–­æ˜¯ä¸æ˜¯ä¸ºç©ºï¼Œä¸ºç©ºå°±å…ˆè°ƒç”¨`creadMap()`åˆ›å»ºå†`set(value)`åˆ›å»º ThreadLocalMap å¯¹è±¡å¹¶æ·»åŠ å˜é‡ã€‚ä¸ä¸ºç©ºå°±ç›´æ¥`set(value)` ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1NbvgPzggrd3O6mYhN1XOPJ6ic2Gdyl8Cleec7iaG5owyWtmh7qPY8BZ1vA/0?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1NbpibZMdAMY6HWBJ7jQBAMEfDUHDiaDRruZKWqbXTicTicf6uUraG3rRbD8g/0?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1Nbia6lr2ic09icJoicDhgZ6uB6xyZZpmSgAYicm3ibHQWaI80HZ47vROSRl3Lg/0?wx_fmt=png)

è¿™ç§ä¿è¯çº¿ç¨‹å®‰å…¨çš„æ–¹å¼ç§°ä¸º`çº¿ç¨‹å°é—­`ã€‚çº¿ç¨‹åªèƒ½çœ‹åˆ°è‡ªå·±çš„ThreadLocalå˜é‡ã€‚çº¿ç¨‹ä¹‹é—´æ˜¯äº’ç›¸éš”ç¦»çš„ã€‚

### get()æ–¹æ³•

å…¶ä¸­**get()æ–¹æ³•**ç”¨æ¥è·å–ä¸å½“å‰çº¿ç¨‹å…³è”çš„ThreadLocalçš„å€¼ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰è¯¥ThreadLocalçš„å€¼ï¼Œåˆ™è°ƒç”¨**initialValueå‡½æ•°**è·å–åˆå§‹å€¼è¿”å›ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨æ—¶éœ€è¦ç»§æ‰¿è¯¥å‡½æ•°ï¼Œç»™å‡ºåˆå§‹å€¼ï¼ˆä¸é‡å†™çš„è¯é»˜è®¤è¿”å›Nullï¼‰ã€‚

ä¸»è¦æœ‰ä»¥ä¸‹å‡ æ­¥ï¼š

1.  è·å–å½“å‰çš„Threadå¯¹è±¡ï¼Œé€šè¿‡getMapè·å–Threadå†…çš„ThreadLocalMap
2.  å¦‚æœmapå·²ç»å­˜åœ¨ï¼Œä»¥å½“å‰çš„ThreadLocalä¸ºé”®ï¼Œè·å–Entryå¯¹è±¡ï¼Œå¹¶ä»ä»Entryä¸­å–å‡ºå€¼
3.  å¦åˆ™ï¼Œè°ƒç”¨setInitialValueè¿›è¡Œåˆå§‹åŒ–ã€‚

    /**
     * Returns the value in the current thread's copy of this
     * thread-local variable.  If the variable has no value for the
     * current thread, it is first initialized to the value returned
     * by an invocation of the {@link #initialValue} method.
     *
     * @return the current thread's value of this thread-local
     */
    public T get() {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                @SuppressWarnings("unchecked")
                T result = (T)e.value;
                return result;
            }
        }
        return setInitialValue();
    }
    

æˆ‘ä»¬å¯ä»¥é‡å†™`initialValue()`ï¼Œè®¾ç½®åˆå§‹å€¼ã€‚

        private static final ThreadLocal<Integer> threadLocal = new ThreadLocal<Integer>(){
            @Override
            protected Integer initialValue() {
                return Integer.valueOf(0);
            }
        }
    

### remove()æ–¹æ³•

æœ€åä¸€ä¸ªéœ€è¦æ¢ç©¶çš„å°±æ˜¯removeæ–¹æ³•ï¼Œå®ƒç”¨äºåœ¨mapä¸­ç§»é™¤ä¸€ä¸ªä¸ç”¨çš„Entryã€‚ä¹Ÿæ˜¯å…ˆè®¡ç®—å‡ºhashå€¼ï¼Œè‹¥æ˜¯ç¬¬ä¸€æ¬¡æ²¡æœ‰å‘½ä¸­ï¼Œå°±å¾ªç¯ç›´åˆ°nullï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¹Ÿä¼šè°ƒç”¨expungeStaleEntryæ¸…é™¤ç©ºkeyèŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

    public void remove() {
             ThreadLocalMap m = getMap(Thread.currentThread());
             if (m != null)
                 m.remove(this);
    }
    
    
    /**
     * Remove the entry for key.
     */
    private void remove(ThreadLocal<?> key) {
                Entry[] tab = table;
                int len = tab.length;
                int i = key.threadLocalHashCode & (len-1);
                for (Entry e = tab[i];
                     e != null;
                     e = tab[i = nextIndex(i, len)]) {
                    if (e.get() == key) {
                        e.clear();
                        expungeStaleEntry(i);
                        return;
                    }
                }
    }
    

å®é™…ä¸Š ThreadLocalMap ä¸­ä½¿ç”¨çš„ key ä¸º ThreadLocal çš„å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨çš„ç‰¹ç‚¹æ˜¯ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡åªå­˜åœ¨å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶çš„æ—¶å€™å¿…ç„¶ä¼šè¢«æ¸…ç†æ‰ã€‚

æ‰€ä»¥å¦‚æœ ThreadLocal æ²¡æœ‰è¢«å¤–éƒ¨å¼ºå¼•ç”¨çš„æƒ…å†µä¸‹ï¼Œåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™ä¼šè¢«æ¸…ç†æ‰çš„ï¼Œè¿™æ ·ä¸€æ¥ ThreadLocalMapä¸­ä½¿ç”¨è¿™ä¸ª ThreadLocal çš„ key ä¹Ÿä¼šè¢«æ¸…ç†æ‰ã€‚ä½†æ˜¯ï¼Œvalue æ˜¯å¼ºå¼•ç”¨ï¼Œä¸ä¼šè¢«æ¸…ç†ï¼Œè¿™æ ·ä¸€æ¥å°±ä¼šå‡ºç° key ä¸º null çš„ valueã€‚å‡ºç°å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚

**åœ¨æ‰§è¡Œ ThreadLocal çš„ setã€removeã€rehash ç­‰æ–¹æ³•æ—¶ï¼Œå®ƒéƒ½ä¼šæ‰«æ key ä¸º null çš„ Entryï¼Œå¦‚æœå‘ç°æŸä¸ª Entry çš„ key ä¸º nullï¼Œåˆ™ä»£è¡¨å®ƒæ‰€å¯¹åº”çš„ value ä¹Ÿæ²¡æœ‰ä½œç”¨äº†ï¼Œæ‰€ä»¥å®ƒå°±ä¼šæŠŠå¯¹åº”çš„ value ç½®ä¸º nullï¼Œè¿™æ ·ï¼Œvalue å¯¹è±¡å°±å¯ä»¥è¢«æ­£å¸¸å›æ”¶äº†ã€‚ä½†æ˜¯å‡è®¾ ThreadLocal å·²ç»ä¸è¢«ä½¿ç”¨äº†ï¼Œé‚£ä¹ˆå®é™…ä¸Š setã€removeã€rehash æ–¹æ³•ä¹Ÿä¸ä¼šè¢«è°ƒç”¨ï¼Œä¸æ­¤åŒæ—¶ï¼Œå¦‚æœè¿™ä¸ªçº¿ç¨‹åˆä¸€ç›´å­˜æ´»ã€ä¸ç»ˆæ­¢çš„è¯ï¼Œé‚£ä¹ˆåˆšæ‰çš„é‚£ä¸ªè°ƒç”¨é“¾å°±ä¸€ç›´å­˜åœ¨ï¼Œä¹Ÿå°±å¯¼è‡´äº† value çš„å†…å­˜æ³„æ¼**ã€‚

ThreadLocal çš„Hashç®—æ³•
-------------------

`ThreadLocalMap`ç±»ä¼¼HashMapï¼Œå®ƒæœ‰è‡ªå·±çš„Hashç®—æ³•ã€‚

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1Nb7Xo4XTjrLTVagAvOak7y7LAy6IMiaSyLbesbq7iaU7DHIXhtUt9YDWTQ/0?wx_fmt=png)

    private final int threadLocalHashCode = nextHashCode();
    
    private static final int HASH_INCREMENT = 0x61c88647;
      
    private static int nextHashCode() {
      return nextHashCode.getAndAdd(HASH_INCREMENT);
    }
        
    public final int getAndAdd(int delta) {
      return unsafe.getAndAddInt(this, valueOffset, delta);
    }
    
    

`HASH_INCREMENT`è¿™ä¸ªæ•°å­—è¢«ç§°ä¸º**æ–æ³¢é‚£å¥‘æ•°** ä¹Ÿå« **é»„é‡‘åˆ†å‰²æ•°**ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ `hash` **åˆ†å¸ƒéå¸¸å‡åŒ€**ã€‚

æ¯å½“åˆ›å»ºä¸€ä¸ª`ThreadLocal`å¯¹è±¡ï¼Œè¿™ä¸ª`ThreadLocal.nextHashCode` è¿™ä¸ªå€¼å°±ä¼šå¢é•¿ `0x61c88647` ã€‚

è®²åˆ°Hashå°±ä¼šæ¶‰åŠåˆ°Hashå†²çªï¼Œè·ŸHashMapé€šè¿‡**é“¾åœ°å€æ³•**ä¸åŒçš„æ˜¯ï¼ŒThreadLocalæ˜¯é€šè¿‡**çº¿æ€§æ¢æµ‹æ³•/å¼€æ”¾åœ°å€æ³•**æ¥è§£å†³hashå†²çªã€‚

ThreadLocal 1.7å’Œ1.8çš„åŒºåˆ«
----------------------

ThreadLocal 1.7ç‰ˆæœ¬çš„æ—¶å€™ï¼Œentryå¯¹è±¡çš„keyæ˜¯Threadã€‚

1.8ç‰ˆæœ¬entryçš„keyæ˜¯ThreadLocalã€‚

1.8ç‰ˆæœ¬çš„å¥½å¤„ ï¼šå½“Threadé”€æ¯çš„æ—¶å€™ï¼ŒThreadLocalMapä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œå‡å°‘å†…å­˜çš„ä½¿ç”¨ã€‚å› ä¸ºThreadLocalMapæ˜¯åœ¨Threadé‡Œé¢çš„ï¼Œæ‰€ä»¥åªè¦Threadæ¶ˆå¤±äº†ï¼Œé‚£ThreadLocalMapå°±ä¸å¤å­˜åœ¨äº†ã€‚

ThreadLocal çš„é—®é¢˜
---------------

### ThreadLocal å†…å­˜æ³„éœ²é—®é¢˜

åœ¨ ThreadLocalMap ä¸­çš„ Entry çš„ key æ˜¯å¯¹ ThreadLocal çš„ `WeakReference` å¼±å¼•ç”¨ï¼Œè€Œ value æ˜¯å¼ºå¼•ç”¨ã€‚å½“ ThreadLocalMap çš„æŸ ThreadLocal å¯¹è±¡åªè¢«å¼±å¼•ç”¨ï¼ŒGC å‘ç”Ÿæ—¶è¯¥å¯¹è±¡ä¼šè¢«æ¸…ç†ï¼Œæ­¤æ—¶ key ä¸º nullï¼Œä½† value ä¸ºå¼ºå¼•ç”¨ä¸ä¼šè¢«æ¸…ç†ã€‚æ­¤æ—¶ value å°†è®¿é—®ä¸åˆ°ä¹Ÿä¸è¢«æ¸…ç†æ‰å°±å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

æ³¨æ„æ„é€ å‡½æ•°é‡Œçš„ç¬¬ä¸€è¡Œä»£ç super(k)ï¼Œè¿™æ„å‘³ç€ThreadLocalå¯¹è±¡æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨

    /**
     * The entries in this hash map extend WeakReference, using
     * its main ref field as the key (which is always a
     * ThreadLocal object).  Note that null keys (i.e. entry.get()
     * == null) mean that the key is no longer referenced, so the
     * entry can be expunged from table.  Such entries are referred to
     * as "stale entries" in the code that follows.
     */
    static class Entry extends WeakReference<ThreadLocal<?>> {
        /** The value associated with this ThreadLocal. */
        Object value;
    
        Entry(ThreadLocal<?> k, Object v) {
            super(k);
            value = v;
        }
    }
    

å› æ­¤æˆ‘ä»¬ä½¿ç”¨å®Œ ThreadLocal åæœ€å¥½æ‰‹åŠ¨è°ƒç”¨ `remove()` æ–¹æ³•ã€‚ä½†å…¶å®åœ¨ ThreadLocalMap çš„å®ç°ä¸­ä»¥åŠè€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œå› æ­¤åœ¨è°ƒç”¨ `set()`ã€`get()`ã€`remove()` æ–¹æ³•æ—¶ï¼Œä¼šæ¸…ç† key ä¸º null çš„è®°å½•ã€‚

#### ä¸ºä»€ä¹ˆä½¿ç”¨å¼±å¼•ç”¨è€Œä¸æ˜¯å¼ºå¼•ç”¨?

ä¸ºä»€ä¹ˆé‡‡ç”¨äº†å¼±å¼•ç”¨çš„å®ç°è€Œä¸æ˜¯å¼ºå¼•ç”¨å‘¢ï¼Ÿ

![](https://mmbiz.qpic.cn/mmbiz_png/jC8rtGdWScPIlWKwgbQ65sKiaib8iapt1NbkRof7HnHK3alZP02QCxiaxyAulEHzNb5Ndoc4hVSxKq3MPZNr8miaULg/0?wx_fmt=png)

æ³¨é‡Šä¸Šæœ‰è¿™ä¹ˆä¸€æ®µè¯ï¼š**ä¸ºäº†ååŠ©å¤„ç†æ•°æ®æ¯”è¾ƒå¤§å¹¶ä¸”ç”Ÿå‘½å‘¨æœŸæ¯”è¾ƒé•¿çš„åœºæ™¯ï¼Œhash tableçš„æ¡ç›®ä½¿ç”¨äº†WeakReferenceä½œä¸ºkey**ã€‚

**æ‰€ä»¥ï¼Œå¼±å¼•ç”¨åè€Œæ˜¯ä¸ºäº†è§£å†³å†…å­˜å­˜å‚¨é—®é¢˜è€Œä¸“é—¨ä½¿ç”¨çš„ã€‚**

å®é™…ä¸Šï¼Œé‡‡ç”¨å¼±å¼•ç”¨åè€Œå¤šäº†ä¸€å±‚ä¿éšœï¼ŒThreadLocalè¢«æ¸…ç†åkeyä¸ºnullï¼Œå¯¹åº”çš„valueåœ¨ä¸‹ä¸€æ¬¡ThreadLocalMapè°ƒç”¨setã€getï¼Œå°±ç®—å¿˜è®°è°ƒç”¨ remove æ–¹æ³•ï¼Œå¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¯ä»¥å¤šä¸€å±‚ä¿éšœã€‚

æ‰€ä»¥ï¼Œå†…å­˜æ³„éœ²çš„æ ¹æœ¬åŸå› æ˜¯æ˜¯å¦æ‰‹åŠ¨æ¸…é™¤æ“ä½œï¼Œè€Œä¸æ˜¯å¼±å¼•ç”¨ã€‚

### ThreadLocal çˆ¶å­çº¿ç¨‹ç»§æ‰¿

å¼‚æ­¥åœºæ™¯ä¸‹æ— æ³•ç»™å­çº¿ç¨‹å…±äº«çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å‰¯æœ¬æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ `InheritableThreadLocal` ç±»è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

å®ƒçš„åŸç†å°±æ˜¯å­çº¿ç¨‹æ˜¯é€šè¿‡åœ¨çˆ¶çº¿ç¨‹ä¸­è°ƒç”¨ `new Thread()` åˆ›å»ºçš„ï¼Œåœ¨ Thread çš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº† `Threadçš„init` æ–¹æ³•ï¼Œåœ¨ `init` æ–¹æ³•ä¸­çˆ¶çº¿ç¨‹æ•°æ®ä¼šå¤åˆ¶åˆ°å­çº¿ç¨‹ï¼ˆ`ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);`ï¼‰ã€‚

ä»£ç ç¤ºä¾‹ï¼š

    public class InheritableThreadLocalDemo {
        public static void main(String[] args) {
            ThreadLocal<String> threadLocal = new ThreadLocal<>();
            ThreadLocal<String> inheritableThreadLocal = new InheritableThreadLocal<>();
            threadLocal.set("çˆ¶ç±»æ•°æ®:threadLocal");
            inheritableThreadLocal.set("çˆ¶ç±»æ•°æ®:inheritableThreadLocal");
    
            new Thread(new Runnable() {
                @Override
                public void run() {
                    System.out.println("å­çº¿ç¨‹è·å–çˆ¶ç±»threadLocalæ•°æ®ï¼š" + threadLocal.get());
                    System.out.println("å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼š" +inheritableThreadLocal.get());
                }
            }).start();
        }
    }
    

ä½†æ˜¯æˆ‘ä»¬åšå¼‚æ­¥å¤„ç†éƒ½æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ± ä¼šå¤ç”¨çº¿ç¨‹ä¼šå¯¼è‡´é—®é¢˜å‡ºç°ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é˜¿é‡Œå·´å·´çš„TTLè§£å†³è¿™ä¸ªé—®é¢˜ã€‚

[https://github.com/alibaba/transmittable-thread-local](https://github.com/alibaba/transmittable-thread-local)

* * *

å¦‚æœæœ¬ç¯‡åšå®¢æœ‰ä»»ä½•é”™è¯¯å’Œå»ºè®®ï¼Œæ¬¢è¿ç»™æˆ‘ç•™è¨€æŒ‡æ­£ã€‚æ–‡ç« æŒç»­æ›´æ–°ï¼Œå¯ä»¥å…³æ³¨å…¬ä¼—å·ç¬¬ä¸€æ—¶é—´é˜…è¯»ã€‚

![](https://mmbiz.qpic.cn/mmbiz_jpg/jC8rtGdWScMuzzTENRgicfnr91C5Bg9QNgMZrxFGlGXnTlXIGAKfKAibKRGJ2QrWoVBXhxpibTQxptf8MsPTyHvSg/0?wx_fmt=jpeg)

å‘è¡¨äº 2023-02-14 20:05Â  [Booksea](https://www.cnblogs.com/booksea/)Â  é˜…è¯»(58)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=17120757)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))