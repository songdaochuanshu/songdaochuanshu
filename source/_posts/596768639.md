---
layout: post
title: "【JVM】经典垃圾回收器"
date: "2022-12-19T03:17:09.542Z"
---
本文已收录至Github，推荐阅读 👉 [Java随想录](https://github.com/ZhengShuHai/JavaRecord)  
  
微信公众号：Java随想录  
  
CSDN： [码农BookSea](https://blog.csdn.net/bookssea)  

> 转载请在文首注明出处，如发现恶意抄袭/搬运，会动用法律武器维护自己的权益。让我们一起维护一个良好的技术创作环境！

经典垃圾回收器
=======

这一章节不会讨论`CMS`和`G1`，因为看完垃圾回收器的章节，我发现书中大部分的篇幅都在讨论`CMS`和`G1`。所以会专门开启章节讲述这两个垃圾收集器，这篇还是先讨论除此之外的垃圾回收器。

标题中“经典”二字并非情怀，它其实是讨论范围的限定语，**这里讨论的是在JDK 7 Update 4之后（在这个版本中正式提供了商用的G1收集器，此前G1仍处于实验状态）、JDK 11正式发布之前，OracleJDK中的HotSpot虚拟机所包含的全部可用的垃圾收集器。**使用“经典”二字是为了与几款目前仍处于实验状态，但执行效果上有革命性改进的高性能低延迟收集器区分开来，这些经典的收集器尽管已经算不上是最先进的技术，但它们曾在实践中千锤百炼，足够成熟，基本上可认为是现在到未来两、三年内，能够在商用生产环境上放心使用的全部垃圾收集器了。各款经典收集器之间的关系如图：

![](https://files.mdnice.com/user/38894/0cc8da06-f33a-4f77-8436-f19bfd42642b.png)

如果两个收集器之间存在连线，就说明它们可以搭配使用 ，图中收集器所处的区域，则表示它是属于新生代收集器抑或是老年代收集器。

Stop The World
--------------

**Stop The World**在垃圾收集器里是非常重要的概念，听**起来这个词有点炫酷，但其实它是GC"最大的敌人"。**之后会多次出现，先提前进行说明。

Stop The World指的是GC事件发生过程中，会产生应用程序的停顿。停顿产生时整个应用程序线程都会被暂停，没有任何响应, 有点像卡死的感觉，这个停顿称为STW。

为什么要停顿，可以在脑海里模拟一个场景：“你妈妈在给你打扫房间的时候，肯定也会让你老老实实地在椅子上或者房间外待着，如果她一边打扫，你一边乱扔纸屑，这房间还能打扫完？”

这里另外介绍一个概念，GC优化一般有两个目标：**低延迟和高吞吐**。很可惜的是这两个目标往往无法同时达成，低延迟有时是牺牲高吞吐换得的，反之亦然。这点在之后的CMS垃圾回收器会有体现。

Serial收集器
---------

Serial收集器是最基础、历史最悠久的收集器，曾经（在JDK 1.3.1之前）是HotSpot虚拟机新生代收集器的唯一选择。

这个收集器是一个单线程工作的收集器，**但它的“单线程”的意义并不仅仅是说明它只会使用一个处理器或一条收集线程去完成垃圾收集工作，更重要的是强调在它进行垃圾收集时，必须暂停其他所有工作线程，直到它收集结束。**

![](https://files.mdnice.com/user/38894/b2402ec4-72ec-48f0-9389-48e484cdafc6.png)  
看起来貌似Serial并不十分友好，要暂停其他工作线程，但事实上，迄今为止，它依然是HotSpot虚拟机运行在客户端模式下的默认新生代收集器，有着优于其他收集器的地方，那就是简单而高效，对于内存资源受限的环境，它是所有收集器里额外内存消耗最小的（这点跟G1相比就十分明显，G1的内存消耗是非常大的，之后在G1篇会给出原因）。

ParNew收集器
---------

ParNew收集器实质上是Serial收集器的多线程并行版本，**除了同时使用多条线程进行垃圾收集之外，其余的行为包括Serial收集器可用的所有控制参数（例如：-XX：SurvivorRatio、-XX：PretenureSizeThreshold、-XX：HandlePromotionFailure等）、收集算法、Stop The World、对象分配规则、回收策略等都与Serial收集器完全一致**，在实现上这两种收集器也共用了相当多的代码。

![](https://files.mdnice.com/user/38894/651a53b4-a709-4728-8c3f-1d8cc5d2cd9f.png)

ParNew收集器除了支持多线程并行收集之外，其他与Serial收集器相比并没有太多创新之处，但是他有一个很牛B的特点：**除了Serial收集器外，目前只有它能与CMS收集器配合工作。**ParNew收集器是激活CMS后（使用-XX：+UseConcMarkSweepGC选项）的默认新生代收集器，也可以使用-XX：+/-UseParNewGC选项来强制指定或者禁用它。但是自JDK 9开始取消了ParNew加Serial Old以及Serial加CMS这两组收集器组合的支持，并直接取消了-XX：+UseParNewGC参数，**这意味着ParNew和CMS从此只能互相搭配使用**，再也没有其他收集器能够和它们配合了。**为什么要这么干——因为G1来了。**

**ParNew默认开启的收集线程数与处理器核心数量相同**，可以使用`-XX：ParallelGCThreads`参数来限制垃圾收集的线程数。

Parallel Scavenge收集器
--------------------

**Parallel Scavenge收集器基于标记-复制算法实现，是JDK8默认的新生代收集器。**与我们前面说过垃圾收集器最大的不同就是，CMS等收集器的关注点是尽可能地缩短垃圾收集时用户线程的停顿时间，而Parallel Scavenge收集器的目标则是达到一个**可控制**的吞吐量（Throughput）。所谓吞吐量就是处理器用于运行用户代码的时间与处理器总消耗时间的比值， 即：

![](https://files.mdnice.com/user/38894/43922fed-a274-42ad-9256-338282ff90d7.png)

如果虚拟机完成某个任务，用户代码加上垃圾收集总共耗费了100分钟，其中垃圾收集花掉1分钟，那吞吐量就是99%。

`注意字体加粗的地方：可控制。`

**如何体现可控制？**Parallel Scavenge收集器提供了两个参数用于精确控制吞吐量，分别是控制最大垃圾收集停顿时间的`-XX：MaxGCPauseMillis`参数以及直接设置吞吐量大小的`-XX：GCTimeRatio`参数。

**\-XX：MaxGCPauseMillis**参数允许的值是一个大于0的毫秒数，收集器将尽力保证内存回收花费的时间不超过用户设定值。不过大家不要异想天开地认为如果把这个参数的值设置得更小一点就能使得系统的垃圾收集速度变得更快，垃圾收集停顿时间缩短是以牺牲吞吐量和新生代空间为代价换取的：系统把新生代调得小一些，收集300MB新生代肯定比收集500MB快，但这也直接导致垃圾收集发生得更频繁，**原来10秒收集一次、每次停顿100毫秒，现在变成5秒收集一次、每次停顿70毫秒。停顿时间的确在下降，但吞吐量也降下来了。**

**\-XX：GCTimeRatio**参数的值则应当是一个大于0小于100的整数，也就是垃圾收集时间占总时间的比率，相当于吞吐量的倒数。譬如把此参数设置为19，那允许的最大垃圾收集时间就占总时间的5%（即1/(1+19)），默认值为99，即允许最大1%（即1/(1+99)）的垃圾收集时间。

除上述两个参数之外，Parallel Scavenge收集器还有一个参数-XX：+UseAdaptiveSizePolicy值得我们关注。

**我看到这里的时候觉得这个参数真滴牛皮。**

当这个参数被激活之后，就不需要人工指定新生代的大小（-Xmn）、Eden与Survivor区的比例（-XX：SurvivorRatio）、晋升老年代对象大小（-XXPretenureSizeThreshold）等细节参数了，**虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量。**

如果对于Parallel Scavenge收集器不太了解，开启这个参数，把内存管理的调优任务交给虚拟机去完成是一个不错的选择，**简直就是小白福音**。

Serial Old
----------

Serial Old是Serial收集器的老年代版本，它同样是一个单线程收集器，使用**标记-整理**算法。这个收集器的主要意义也是供客户端模式下的HotSpot虚拟机使用。如果在服务端模式下，它也可能有两种用途：一种是在JDK 5以及之前的版本中与Parallel Scavenge收集器搭配使用 ，另外一种就是作为CMS收集器发生失败时的后备预案，在并发收集发生Concurrent Mode Failure时使用。

![](https://files.mdnice.com/user/38894/573bc029-404f-45ca-ad1b-effe3eb42522.png)

Parallel Old收集器
---------------

Parallel Old是Parallel Scavenge收集器的老年代版本，支持多线程并发收集，基于标记-整理算法实现。

**Parallel Scavenge+Parallel Old被称为吞吐量优先组合**

![](https://files.mdnice.com/user/38894/edd19040-c05d-4813-8a50-9f45134b74a0.png)

发表于 2022-12-19 10:13  [Booksea](https://www.cnblogs.com/booksea/)  阅读(45)  评论(0)  [编辑](https://i.cnblogs.com/EditPosts.aspx?postid=16991558)  [收藏](javascript:void(0))  [举报](javascript:void(0))