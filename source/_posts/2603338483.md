---
layout: post
title: "[å¼€æºç²¾å“] .NET Redis Client åˆå¤šäº†ä¸€ä¸ªé€‰æ‹©ï¼Œè¿˜åœ¨è¢« StackExchange.Redis Timeout é—®é¢˜å›°æ‰°å—ï¼Ÿ"
date: "2022-07-08T05:24:42.144Z"
---
\[å¼€æºç²¾å“\] .NET Redis Client åˆå¤šäº†ä¸€ä¸ªé€‰æ‹©ï¼Œè¿˜åœ¨è¢« StackExchange.Redis Timeout é—®é¢˜å›°æ‰°å—ï¼Ÿ
=========================================================================

ğŸ’» å‰è¨€
-----

.NET ä¸‹ RedisClient SDK é€‰æ‹©æŒºå¤šï¼Œå›½äººå¸¸ç”¨å…è´¹çš„æœ‰ StackExchange.Redis/CSRedis/Newlife.Redisï¼Œæ”¶è´¹çš„æœ‰ ServiceStack.Redisã€‚

å°å¼Ÿä»æ¥æ‰‹ CSRedis ä»£ç  2016 å¹´è‡³ä»Šç»´æŠ¤äº†6å¹´ï¼ŒåŸå› æ˜¯åˆå…¥ .NETCore å‘å¯é€‰æ‹©æ€§å°‘ï¼Œä½¿ç”¨çš„ StackExchange.Redis å‘ç”Ÿ Timeout é—®é¢˜æ— æ³•è§£å†³ï¼Œé¡¹ç›®é¦–æ€¥ä¸Šçº¿äºæ˜¯ä½¿ç”¨äº† CSRedisï¼Œç”±äºä½œè€…åœæ­¢ç»´æŠ¤ä¸€äº›æ‰©å±•æˆ–åŠŸèƒ½å¾—ä¸åˆ°è§£å†³ï¼Œæ‰€ä»¥åæ¥ç›´æ¥å¼•å…¥æºç åˆ°é¡¹ç›®å†…æ”¹è¿›ï¼Œå¢åŠ äº† RedisHelperã€è¿æ¥æ± ã€é›†ç¾¤ã€ä»¥åŠé«˜ç‰ˆæœ¬ Redis-server çš„ä¸€äº›å‘½ä»¤ï¼Œæœ€åç”±äºæ”¹åŠ¨å¤ªå¤šä¸åŸä½œè€…å¼€æºçº¿è·¯ä¸¢å¤±ï¼Œä¸”åˆæ¬¡æ¥è§¦ä¸æ‡‚å¼€æºåè®®ï¼Œç›´æ¥åˆ›å»ºäº† CSRedisCore ä»“å‚¨è¿›è¡Œäº†ç¤¾åŒºå¼€æºç»´æŠ¤ï¼Œå¯¹æ­¤è¡Œä¸ºç»™åŸä½œè€…è‡´æ­‰ï¼Œå¹¶ä¸”åœ¨ CSRedisCore é¦–é¡µæ ‡æ˜è‡´è°¢è¯è¯­ã€‚

ä¸ªäººè®¤ä¸º CSRedis API å¾ˆç¬¦åˆä½¿ç”¨è€…ä¹ æƒ¯ï¼Œå› ä¸ºæ–¹æ³•åä¸ redis-command ä¿æŒä¸€è‡´ï¼Œé¿å…äº†äºŒæ¬¡ç†è§£æˆæœ¬ï¼Œå¦åˆ™çœ‹å®Œ redis æ–‡æ¡£è¿˜è¦å»æ‰¾ SDK æ–¹æ³•ç”¨å“ªä¸ªå°±å¾ˆè›‹ç–¼äº†ã€‚å¯æ˜¯è¶Šå¾€åé¢ï¼Œå°å¼Ÿå‘ç° CSRedisCore è‡ªå·±ä¸€äº›é”™è¯¯çš„æ”¹åŠ¨ï¼Œåˆæˆ–è€…è¯´åŸä½œè€…çš„ä»£ç å®ç°ç†å¿µéš¾ä»¥æ”¯æŒ redis-server é«˜ç‰ˆæœ¬ï¼Œåˆæˆ–è€…ä¼šé€ æˆç ´åæ€§å‡çº§ï¼Œä¸å…¶è¿™æ ·ä¸å¦‚é‡æ–°å†™ä¸€ä¸ª RedisClientï¼Œäºæ˜¯ FreeRedis å°±è¿™æ ·è¯ç”Ÿäº†ã€‚

* * *

ğŸŒ³ å¼€æºç†å¿µ
-------

FreeRedis çš„å‘½åæ¥è‡ªï¼Œâ€œè‡ªç”±â€ã€â€œå…è´¹â€ï¼Œå®ƒå’Œåå­—ä¸ FreeSql æ˜¯ä¸€ä¸ªç†å¿µï¼Œç®€æ˜“æ˜¯ä»–ä»¬ä¸€è‡´çš„è¿½å¯»æ–¹å‘ï¼Œæœ€ä½å¯æ”¯æŒ .NET Framework 4.0 è¿è¡Œç¯å¢ƒï¼Œæ”¯æŒåˆ° Redis-server 7.0ã€‚

æ„Ÿè°¢ Nuget FreeRedis åŸæ‹¥æœ‰è€…å¯¹ FreeRedis çš„å‰²çˆ±ï¼Œä»–çš„å¼€æºåœ°å€ï¼š[https://gitee.com/LeanCai](https://gitee.com/LeanCai)

å¦‚ä»Šï¼ŒFreeRedis ä»ç¬¬ä¸€ä¸ªç‰ˆæœ¬å‘å¸ƒè‡³ä»Š 20ä¸ªæœˆï¼Œæ—¶é—´éªŒè¯äº†å…¶å¯é æ€§ï¼Œæ˜¯æ—¶å€™å…¬å¼€ç»™å¤§å®¶ï¼Œå¤šä¸€ä¸ªé€‰æ‹©å¤šä¸€æ¡è·¯ã€‚FreeRedis æ•´ä¸ªæºç æ˜¯é›¶ä¾èµ–ï¼Œä½¿ç”¨å®ƒåªä¼šåœ¨ bin ç›®å½•äº§ç”Ÿä¸€ä¸ª FreeRedis.dllï¼Œéå¸¸çš„è½»é‡çº§ï¼Œå¹¶ä¸”å…¶åŠŸèƒ½éå¸¸å¼ºå¤§ï¼š

* * *

ğŸ¦„ FreeRedis
============

åŸºäº .NET çš„ Redis å®¢æˆ·ç«¯ï¼Œæ”¯æŒ .NET Core 2.1+ã€.NET Framework 4.0+ ä»¥åŠ Xamarinã€‚

*   ğŸŒˆ æ‰€æœ‰æ–¹æ³•åä¸ redis-cli ä¿æŒä¸€è‡´
*   ğŸŒŒ æ”¯æŒ Redis é›†ç¾¤ï¼ˆæœåŠ¡ç«¯è¦æ±‚ 3.2 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰
*   â›³ æ”¯æŒ Redis å“¨å…µæ¨¡å¼
*   ğŸ£ æ”¯æŒä¸»ä»åˆ†ç¦»ï¼ˆMaster-Slaveï¼‰
*   ğŸ“¡ æ”¯æŒå‘å¸ƒè®¢é˜…ï¼ˆPub-Subï¼‰
*   ğŸ“ƒ æ”¯æŒ Redis Lua è„šæœ¬
*   ğŸ’» æ”¯æŒç®¡é“ï¼ˆPipelineï¼‰
*   ğŸ“° æ”¯æŒäº‹åŠ¡
*   ğŸŒ´ æ”¯æŒ GEO å‘½ä»¤ï¼ˆæœåŠ¡ç«¯è¦æ±‚ 3.2 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰
*   ğŸŒ² æ”¯æŒ STREAM ç±»å‹å‘½ä»¤ï¼ˆæœåŠ¡ç«¯è¦æ±‚ 5.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰
*   âš¡ æ”¯æŒæœ¬åœ°ç¼“å­˜ï¼ˆClient-side-cahingï¼ŒæœåŠ¡ç«¯è¦æ±‚ 6.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰
*   ğŸŒ³ æ”¯æŒ Redis 6 çš„ RESP3 åè®®

QQç¾¤ï¼š4336577(å·²æ»¡)ã€8578575(åœ¨çº¿)ã€52508226(åœ¨çº¿)

* * *

ğŸš€ å¿«é€Ÿå…¥é—¨
-------

    public static RedisClient cli = new RedisClient("127.0.0.1:6379,password=123,defaultDatabase=13");
    //cli.Serialize = obj => JsonConvert.SerializeObject(obj);
    //cli.Deserialize = (json, type) => JsonConvert.DeserializeObject(json, type);
    cli.Notice += (s, e) => Console.WriteLine(e.Log); //æ‰“å°å‘½ä»¤æ—¥å¿—
    
    cli.Set("key1", "value1");
    cli.MSet("key1", "value1", "key2", "value2");
    
    string value1 = cli.Get("key1");
    string[] vals = cli.MGet("key1", "key2");
    

> æ”¯æŒ STRINGã€HASHã€LISTã€SETã€ZSETã€BITMAPã€HyperLogLogã€GEOã€Stream ä»¥åŠå¸ƒéš†è¿‡æ»¤å™¨ç­‰ã€‚

å‚æ•°

é»˜è®¤å€¼

è¯´æ˜

protocol

RESP2

è‹¥ä½¿ç”¨ RESP3 åè®®ï¼Œä½ éœ€è¦ Redis 6.0 ç¯å¢ƒ

user

<empty>

Redis æœåŠ¡ç«¯ç”¨æˆ·åï¼Œè¦æ±‚ Redis 6.0 ç¯å¢ƒ

password

<empty>

Redis æœåŠ¡ç«¯å¯†ç 

defaultDatabase

0

Redis æœåŠ¡ç«¯æ•°æ®åº“

max poolsize

100

è¿æ¥æ± æœ€å¤§è¿æ¥æ•°

min poolsize

5

è¿æ¥æ± æœ€å°è¿æ¥æ•°

idleTimeout

20000

è¿æ¥æ± ä¸­å…ƒç´ çš„ç©ºé—²æ—¶é—´ï¼ˆå•ä½ä¸ºæ¯«ç§’ msï¼‰ï¼Œé€‚ç”¨äºè¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨

connectTimeout

10000

è¿æ¥è¶…æ—¶ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆmsï¼‰

receiveTimeout

10000

æ¥æ”¶è¶…æ—¶ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆmsï¼‰

sendTimeout

10000

å‘é€è¶…æ—¶ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼ˆmsï¼‰

encoding

utf-8

å­—ç¬¦ä¸²å­—ç¬¦é›†

retry

0

åè®®å‘ç”Ÿé”™è¯¯æ—¶ï¼Œé‡è¯•æ‰§è¡Œçš„æ¬¡æ•°

ssl

false

å¯ç”¨åŠ å¯†ä¼ è¾“

name

<empty>

è¿æ¥åï¼Œä½¿ç”¨ CLIENT LIST å‘½ä»¤æŸ¥çœ‹

prefix

<empty>

`key` å‰è¾ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½ä¼šé™„å¸¦æ­¤å‰è¾ï¼Œcli.Set(prefix + "key", 111);

> IPv6: \[fe80::b164:55b3:4b4f:7ce6%15\]:6379

* * *

### ğŸ£ Master-Slave (è¯»å†™åˆ†ç¦»)

    public static RedisClient cli = new RedisClient(
        "127.0.0.1:6379,password=123,defaultDatabase=13",
        "127.0.0.1:6380,password=123,defaultDatabase=13",
        "127.0.0.1:6381,password=123,defaultDatabase=13"
        );
    
    var value = cli.Get("key1");
    

> å†™å…¥æ—¶è¿æ¥ 127.0.0.1:6379ï¼Œè¯»å–æ—¶éšæœºè¿æ¥ 6380 6381

* * *

### â›³ Redis Sentinel (å“¨å…µé«˜å¯ç”¨)

    public static RedisClient cli = new RedisClient(
        "mymaster,password=123", 
        new [] { "192.169.1.10:26379", "192.169.1.11:26379", "192.169.1.12:26379" },
        true //æ˜¯å¦è¯»å†™åˆ†ç¦»
        );
    

* * *

### ğŸŒŒ Redis Cluster (é›†ç¾¤)

å‡å¦‚ä½ æœ‰ä¸€ä¸ª Redis Cluster é›†ç¾¤ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªä¸»èŠ‚ç‚¹(7001-7003)ã€ä¸‰ä¸ªä»èŠ‚ç‚¹(7004-7006)ï¼Œåˆ™è¿æ¥æ­¤é›†ç¾¤çš„ä»£ç ï¼š

    public static RedisClient cli = new RedisClient(
        new ConnectionStringBuilder[] { "192.168.0.2:7001", "192.168.0.2:7002", "192.168.0.2:7003" }
        );
    

* * *

### âš¡ Client-side-cahing (æœ¬åœ°ç¼“å­˜)

> æœåŠ¡ç«¯è¦æ±‚ 6.0 åŠä»¥ä¸Šç‰ˆæœ¬

    cli.UseClientSideCaching(new ClientSideCachingOptions
    {
        //æœ¬åœ°ç¼“å­˜çš„å®¹é‡
        Capacity = 3,
        //è¿‡æ»¤å“ªäº›é”®èƒ½è¢«æœ¬åœ°ç¼“å­˜
        KeyFilter = key => key.StartsWith("Interceptor"),
        //æ£€æŸ¥é•¿æœŸæœªä½¿ç”¨çš„ç¼“å­˜
        CheckExpired = (key, dt) => DateTime.Now.Subtract(dt) > TimeSpan.FromSeconds(2)
    });
    

é‡è¦åŠŸèƒ½äº†è§£è¯¦ç»†ï¼š[https://www.cnblogs.com/kellynic/p/14009158.html](https://www.cnblogs.com/kellynic/p/14009158.html)

* * *

### ğŸ“¡ Subscribe (è®¢é˜…)

    using (cli.Subscribe("abc", ondata)) //wait .Dispose()
    {
        Console.ReadKey();
    }
    
    void ondata(string channel, string data) =>
        Console.WriteLine($"{channel} -> {data}");
    

* * *

### ğŸ“ƒ Scripting (è„šæœ¬)

    var r1 = cli.Eval("return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}", 
        new[] { "key1", "key2" }, "first", "second") as object[];
    
    var r2 = cli.Eval("return {1,2,{3,'Hello World!'}}") as object[];
    
    cli.Eval("return redis.call('set',KEYS[1],'bar')", 
        new[] { Guid.NewGuid().ToString() })
    

* * *

### ğŸ’» Pipeline (ç®¡é“)

    using (var pipe = cli.StartPipe())
    {
        pipe.IncrBy("key1", 10);
        pipe.Set("key2", Null);
        pipe.Get("key1");
    
        object[] ret = pipe.EndPipe();
        Console.WriteLine(ret[0] + ", " + ret[2]);
    }
    

* * *

### ğŸ“° Transaction (äº‹åŠ¡)

    using (var tran = cli.Multi())
    {
        tran.IncrBy("key1", 10);
        tran.Set("key2", Null);
        tran.Get("key1");
    
        object[] ret = tran.Exec();
        Console.WriteLine(ret[0] + ", " + ret[2]);
    }
    

* * *

### ğŸ“¯ GetDatabase (åˆ‡åº“)

    using (var db = cli.GetDatabase(10))
    {
        db.Set("key1", 10);
        var val1 = db.Get("key1");
    }
    

* * *

### ğŸ” Scan (æ‰«æ)

> æ”¯æŒé›†ç¾¤æ¨¡å¼

    foreach (var keys in cli.Scan("*", 10, null))
    {
        Console.WriteLine(string.Join(", ", keys));
    }
    

* * *

ğŸ—„ License (è®¸å¯è¯)
----------------

[MIT](LICENSE)

* * *

â›³ ç»“æŸè¯­
-----

å¦‚æœä½ é‡åˆ°äº† StackExchange.Redis Timeout é—®é¢˜ï¼Œä¸å¦¨è¯•è¯• FreeRedisï¼Œå®ƒè½»å·§ã€å¼ºå¤§ã€å¬è¯ã€‚

å¦‚æœä½ è¿˜åœ¨ä½¿ç”¨ ServiceStack.Redis ç ´è§£ç‰ˆï¼Œä¸å¦¨è¯•è¯•å…è´¹çš„ FreeRedisï¼Œå®ƒå…è´¹ã€å¼€æºã€ä¹–å·§ã€‚

å¼€æºåœ°å€ï¼š[https://github.com/2881099/FreeRedis](https://github.com/2881099/FreeRedis)

* * *

ä½œè€…æ˜¯ä»€ä¹ˆäººï¼Ÿ

ä½œè€…æ˜¯ä¸€ä¸ªå…¥è¡Œ 18å¹´çš„è€æ‰¹ï¼Œä»–ç›®å‰å†™çš„.net å¼€æºé¡¹ç›®æœ‰ï¼š

å¼€æºé¡¹ç›®

æè¿°

å¼€æºåœ°å€

å¼€æºåè®®

ImCore

æ¶æ„æœ€ç®€å•ï¼Œæ‰©å±•æ€§æœ€å¼ºçš„èŠå¤©ç³»ç»Ÿæ¶æ„

[https://github.com/2881099/im](https://github.com/2881099/im)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FreeRedis

æœ€ç®€å•çš„ RediscClient

[https://github.com/2881099/FreeRedis](https://github.com/2881099/FreeRedis)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

csredis

[https://github.com/2881099/csredis](https://github.com/2881099/csredis)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FightLandlord

æ–—åœ°ä¸»å•æœºæˆ–ç½‘ç»œç‰ˆ

[https://github.com/2881099/FightLandlord](https://github.com/2881099/FightLandlord)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå­¦ä¹ ç”¨é€”

IdleScheduler

å®šæ—¶ä»»åŠ¡

[https://github.com/2881099/IdleBus/tree/master/IdleScheduler](https://github.com/2881099/IdleBus/tree/master/IdleScheduler)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

IdleBus

ç©ºé—²å®¹å™¨

[https://github.com/2881099/IdleBus](https://github.com/2881099/IdleBus)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FreeSql

å›½äº§æœ€å¥½ç”¨çš„ ORM

[https://github.com/dotnetcore/FreeSql](https://github.com/dotnetcore/FreeSql)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FreeSql.Cloud

åˆ†å¸ƒå¼äº‹åŠ¡tcc/saga

[https://github.com/2881099/FreeSql.Cloud](https://github.com/2881099/FreeSql.Cloud)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FreeSql.AdminLTE

ä½ä»£ç åå°ç®¡ç†é¡¹ç›®ç”Ÿæˆ

[https://github.com/2881099/FreeSql.AdminLTE](https://github.com/2881099/FreeSql.AdminLTE)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå¯å•†ç”¨

FreeSql.DynamicProxy

åŠ¨æ€ä»£ç†

[https://github.com/2881099/FreeSql.DynamicProxy](https://github.com/2881099/FreeSql.DynamicProxy)

æœ€å®½æ¾çš„ MIT åè®®ï¼Œå­¦ä¹ ç”¨é€”

éœ€è¦çš„è¯·æ‹¿èµ°ï¼Œè¿™äº›éƒ½æ˜¯æœ€è¿‘å‡ å¹´çš„å¼€æºä½œå“ï¼Œä»¥å‰æ›´æ—©å†™çš„å°±ä¸å‘äº†ã€‚

QQç¾¤ï¼š4336577(å·²æ»¡)ã€8578575(åœ¨çº¿)ã€52508226(åœ¨çº¿)