---
layout: post
title: "æ“ä½œç³»ç»Ÿå­¦ä¹ ç¬”è®°11 | ç”Ÿç£ç›˜çš„ä½¿ç”¨ä¸ç®¡ç†"
date: "2022-09-13T23:22:46.784Z"
---
æ“ä½œç³»ç»Ÿå­¦ä¹ ç¬”è®°11 | ç”Ÿç£ç›˜çš„ä½¿ç”¨ä¸ç®¡ç†
======================

![æ“ä½œç³»ç»Ÿå­¦ä¹ ç¬”è®°11 | ç”Ÿç£ç›˜çš„ä½¿ç”¨ä¸ç®¡ç†](https://img2022.cnblogs.com/blog/2192866/202209/2192866-20220913225809805-98439806.png) è¿™éƒ¨åˆ†æ˜¯è®¾å¤‡é©±åŠ¨çš„æœ€åä¸€éƒ¨åˆ†â€”â€”ç£ç›˜ç®¡ç†ï¼Œç›¸è¾ƒäºä¸Šä¸€ç¯‡çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨è¦æ›´å¤æ‚ï¼Œä½†å¤§è‡´è¿‡ç¨‹åŸºæœ¬ç›¸åŒã€‚ç£ç›˜ç®¡ç†å…±æœ‰4å±‚æŠ½è±¡ï¼Œæˆ‘ä»¬å°†ä»æ­¤å­¦ä¹ ã€æŒæ¡è®¾å¤‡é©±åŠ¨çš„ä¸€èˆ¬ç ”ç©¶ç†å¿µå’Œè®¾è®¡æ–¹æ³•ã€‚è¿™éƒ¨åˆ†å…ˆä»‹ç»å‰2å±‚ç”Ÿç£ç›˜çš„æŠ½è±¡ã€‚

è¿™éƒ¨åˆ†æ˜¯è®¾å¤‡é©±åŠ¨çš„æœ€åä¸€éƒ¨åˆ†â€”â€”ç£ç›˜ç®¡ç†ï¼Œç›¸è¾ƒäºä¸Šä¸€ç¯‡çš„é”®ç›˜å’Œæ˜¾ç¤ºå™¨è¦æ›´å¤æ‚ï¼Œä½†å¤§è‡´è¿‡ç¨‹åŸºæœ¬ç›¸åŒã€‚ç£ç›˜ç®¡ç†å…±æœ‰4å±‚æŠ½è±¡ï¼Œæˆ‘ä»¬å°†ä»æ­¤å­¦ä¹ ã€æŒæ¡è®¾å¤‡é©±åŠ¨çš„ä¸€èˆ¬ç ”ç©¶ç†å¿µå’Œè®¾è®¡æ–¹æ³•ã€‚è¿™éƒ¨åˆ†å…ˆä»‹ç»å‰2å±‚æŠ½è±¡ã€‚

* * *

å‚è€ƒèµ„æ–™ï¼š

*   è¯¾ç¨‹ï¼šå“ˆå·¥å¤§æ“ä½œç³»ç»Ÿï¼ˆæœ¬éƒ¨åˆ†å¯¹åº” L28ï¼‰
    
    > å› ä¸ºå¤ªå¤šäº†ï¼Œæ‰€ä»¥ç£ç›˜ç®¡ç†4å±‚æŠ½è±¡å‡†å¤‡åˆ†æˆ2~3ç¯‡æ¥è®²ã€‚
    
*   å®éªŒï¼š[æ“ä½œç³»ç»ŸåŸç†ä¸å®è·µ\_Linux - è“æ¡¥äº‘è¯¾ (lanqiao.cn)](https://www.lanqiao.cn/courses/115)
    
*   è¯¾æœ¬ï¼šã€Šæ“ä½œç³»ç»ŸåŸç†ã€å®ç°ä¸å®è·µã€‹-ææ²»å†›ã€åˆ˜å®ä¼Ÿ
    
    > 2022-09-13ï¼Œä¸Šäº†æ±‡ç¼–ä¸æ¥å£è¯¾ï¼Œå‘ç°æˆ‘æ ¡çš„å¤–è®¾é©±åŠ¨æ˜¯åœ¨è¿™ä¸ªè¯¾ä¸Šè®²ã€‚
    

* * *

1\. ç£ç›˜å·¥ä½œåŸç†
----------

æˆ‘ä»¬å…ˆè®©ç£ç›˜ä½¿ç”¨èµ·æ¥ï¼Œåé¢å†å¼•å…¥ **â€œç®¡ç†â€** æ¥è®©ç£ç›˜æ›´å¥½çš„è¢«ä½¿ç”¨ã€‚

> ç”Ÿç£ç›˜å°±æ˜¯æŒ‡ç›´æ¥è¢«é©±åŠ¨çš„ç£ç›˜ï¼Œä¸ä¹‹ç›¸åº”çš„ï¼Œç†Ÿç£ç›˜å°±æ˜¯å¼•å…¥äº†æ–‡ä»¶ç³»ç»ŸæŠ½è±¡çš„ç£ç›˜ã€‚

### 1.1 ç”Ÿç£ç›˜é©±åŠ¨åŸç†çš„ä¸»å¹²ç†è§£

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåƒä¸Šç¯‡ç¬”è®°æ‰€è®²çš„å¤–è®¾ä¸€æ ·ï¼Œç£ç›˜å·¥ä½œä¾ç„¶åŸºäºå†¯Â·è¯ºä¾æ›¼æ¶æ„ï¼š

*   CPU é€šè¿‡ PCI æ€»çº¿ å‘å‡º out æŒ‡ä»¤è¯»å†™ç£ç›˜ï¼›
*   ç£ç›˜å·¥ä½œå®Œåå‘ CPU å‘å‡ºä¸­æ–­è¯·æ±‚ï¼›
*   åç»­ä¼šå°†ç£ç›˜æŠ½è±¡ä¸ºæ–‡ä»¶è§†å›¾ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145250_1.png)

### 1.2 ç£ç›˜ç»“æ„ã€å®¹é‡å’Œåˆ†ç±»

ä½¿ç”¨ç£ç›˜ï¼Œå½“ç„¶è¦å…ˆç†è§£ç£ç›˜çš„ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

*   ç£ç›˜æ˜¯ç”±ä¸€ä¸ªæŸ±å­ä¸²èµ·å¾ˆå¤šç›˜ç‰‡è€Œç»„æˆçš„ç«‹ä½“ç»“æ„ï¼Œåƒä¸€ä¸ªç³–è‘«èŠ¦ä¸²ï¼›æ¯ä¸ªç›˜é¢éƒ½ç”±è®¸å¤šç£é“ç»„æˆï¼Œç›˜ç‰‡ä¸Šä¸‹ä¸¤é¢éƒ½æ˜¯å¯è¯»å†™çš„ï¼›
    
    > ç¡¬ç›˜åˆåˆ’åˆ†ä¸ºç£å¤´ï¼ˆHeadsï¼‰ã€æŸ±é¢(Cylinder)ã€æ‰‡åŒº(Sector)ï¼›
    > 
    > *   ç£ç›˜çš„è®¿é—®å•ä½æ˜¯æ‰‡åŒºï¼Œå³æ¯æ¬¡è¯»å†™çš„æœ€å°ç£ç›˜å•å…ƒï¼›
    >     
    > *   æ‰‡åŒºå¤§å°æ˜¯ 512 å­—èŠ‚ï¼›
    >     
    > *   ç¡¬ç›˜å®¹é‡ï¼ç£å¤´æ•°ï¼ˆåŒä¸€æŸ±é¢ä¸Šçš„ç£ç‰‡æ•°ï¼‰Ã—æŸ±é¢æ•°Ã—æ‰‡åŒºæ•°Ã—512 å­—èŠ‚
    >     
    > *   è®¾è®¡ç£ç›˜æ—¶ï¼Œæ‰‡åŒºå¤§å°æ˜¯è®¿é—®æ—¶é—´å’Œç¢ç‰‡æµªè´¹çš„æŠ˜è¡·è€ƒè™‘
    >     
    >     è¿™ä¸ªåç»­ä¼šæã€‚
    >     
    
*   å­¦åˆ°åé¢çš„è¡¥å……ï¼šæŸ±é¢æ˜¯ä»€ä¹ˆï¼Ÿ
    
    *   æ‰€æœ‰ç›˜é¢ä¸­ç›¸å¯¹ä½ç½®ç›¸åŒçš„ç£é“ç»„æˆæŸ±é¢ï¼Œå³åŒä¸€åœˆç©ºå¿ƒåœ†æŸ±ä½“ã€‚
    *   æˆ‘ä»¬åé¢æ‰€è¯´çš„å¯»é“ï¼Œä¸å¯»æ‰¾æŸ±é¢ç­‰ä»·ã€‚
*   æ—‹è½¬æ—¶ï¼Œåˆ©ç”¨ç”µæµçš„ç£æ•ˆåº”ï¼Œå¯¹ä¸€äº›ç”µä¿¡å·è¿›è¡Œç£åŒ–ï¼Œä¿å­˜åœ¨ç£ç›˜ä¸­ï¼Œç”¨æ¥å­˜å‚¨ä¸€äº›ä¿¡æ¯ï¼›åŒæ ·çš„ï¼Œå°†ç£ä¿¡å·è½¬åŒ–ä¸ºç”µä¿¡å·ï¼Œå°±å¯ä»¥è¯»å‡ºç£ç›˜ä¿¡æ¯ã€‚
    
    > ç£ç›˜çš„ç‰©ç†åŸç†ï¼Œè¯¦è§ï¼š[ç£ç›˜åŸç†ï¼šä»ç”µç£æ„Ÿåº”è¯´èµ·](https://www.jianshu.com/p/87f03f08a99b)
    

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145317_2.png)

ç°è¡Œç£ç›˜å¯ä»¥ä½œå¦‚ä¸‹åˆ†ç±»ï¼š

*   å›ºæ€ç¡¬ç›˜ç›˜
    
    *   SSDï¼ŒSolid State Disk æˆ– Solid State Driveï¼›
        
    *   SSD ä¸ç®—æ˜¯ç£ç›˜ï¼Œå®é™…ä¸Šæ˜¯ä¸€ç§é—ªå­˜å›ºæ€ç¡¬ç›˜ï¼Œå…¶å·¥ä½œåŸç†åº”å½“å‚è§ Flashï¼›å›ºæ€ç¡¬ç›˜èƒ½å¤Ÿå®ç°éšæœºå­˜å‚¨ï¼Œæ§åˆ¶é€»è¾‘ä¸æœºæ¢°ç£ç›˜å®Œå…¨ä¸ä¸€æ ·ï¼›
        
    *   **ä¸‹é¢è®¨è®ºçš„ç£ç›˜å·¥ä½œåŸç†ä¹Ÿæ˜¯æœºæ¢°ç¡¬ç›˜çš„ã€‚**
        
        > å‚è€ƒèµ„æ–™ï¼š[æœºæ¢°ç¡¬ç›˜å’Œssdå›ºæ€ç¡¬ç›˜çš„åŸç†å¯¹æ¯”åˆ†æ](https://www.cnblogs.com/ricklz/p/16415763.html)ï¼Œè¿™ç¯‡ç¬”è®°å¾ˆè¯¦ç»†ã€‚
        
*   æœºæ¢°ç£ç›˜
    
    *   æ ¹æ®ç£å¤´æ˜¯å¦å¯ä»¥ç§»åŠ¨
        *   å›ºå®šå¤´ç£ç›˜ï¼ˆæ¯ä¸ªç£é“æœ‰ä¸€ä¸ªç£å¤´ï¼‰
        *   ç§»åŠ¨å¤´ç£ç›˜ï¼ˆæ¯ä¸ªç›˜é¢æœ‰ä¸€ä¸ªç£å¤´ï¼‰
        *   è¿™é‡Œæˆ‘ä»¬ä»‹ç»çš„æ˜¯**ç§»åŠ¨å¤´ç£ç›˜**ï¼›
    *   æ ¹æ®ç›˜é¢æ˜¯å¦å¯æ›´æ¢
        *   å›ºå®šç›˜ç£ç›˜ï¼›
        *   å¯æ¢ç›˜ç£ç›˜ï¼›

### 1.3 ç£ç›˜çš„ I/O è¿‡ç¨‹

#### 1.3.1 è¯»å†™ç£ç›˜

è¯»å–ç£ç›˜ä¿¡æ¯æ—¶ï¼Œæ¯”å¦‚è¯»å–ç£ç›˜ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼š

*   é¦–å…ˆæ˜¯å°†ç£å¤´ç§»åŠ¨åˆ°æŒ‡å®šçš„ç£é“ä¸Šï¼Œæ­¤æ—¶ç£å¤´ä¸é€šç”µï¼ˆç£ç‰‡ä¸€ç›´æœ‰ç£ï¼‰ï¼›
*   ç£é“å¼€å§‹æ—‹è½¬ï¼Œè½¬åˆ°ç›®æ ‡ä½ç½® / ç›®æ ‡æ‰‡åŒºæ—¶ï¼Œç£ç”Ÿç”µï¼Œç£ä¿¡å·å˜ä¸ºç”µä¿¡å·ï¼Œå°±é€šè¿‡ç£å¤´å¯¼å›å†…å­˜ç¼“å†²åŒºï¼›
*   \=ğŸ‘†è¯»ï¼Œå†™ğŸ‘‡\===
*   è¯»å…¥å†…å­˜åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»“åˆå‰é¢çš„å†…å­˜ç®¡ç†ï¼Œç¨‹åºä¿®æ”¹å…¶ä¸­çš„å€¼ï¼Œæ¯”å¦‚ä¿®æ”¹æ­¤æ—¶è¯»å…¥çš„ 1 å­—èŠ‚æ•°æ®ï¼›
*   ä¿®æ”¹åçš„æ•°æ®å†å¯¼å›ç£ç›˜ï¼Œä»ç„¶æ˜¯è½¬åŠ¨ï¼Œä½†æ­¤æ—¶æ˜¯ç”µç”Ÿç£ï¼Œå°±å°†ç”µä¿¡å·/æ•°æ®å†™å…¥ç£ç›˜ã€‚

å°æ€»ç»“ï¼š

*   ç§»åŠ¨ç£å¤´åˆ°ç£é“->æ—‹è½¬ç£ç›˜åˆ°æ‰‡åŒº->ç”µç£è¯»å†™ï¼›
*   æ§åˆ¶å™¨ã€å¯»é“ã€è¯»å†™ã€æ•°æ®ä¼ è¾“ï¼›

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145325_3.png)

#### 1.3.2 ç‰©ç†è¿‡ç¨‹

> æ³¨æ„è¿™é‡Œçš„è®²çš„ç£ç›˜å·¥ä½œæ–¹å¼éƒ½æ˜¯ æœºæ¢°ç£ç›˜ï¼ŒåŸºæœ¬åŸç†å°±æ˜¯ç”µç£æ„Ÿåº”ï¼Œèƒ½ç”¨åˆ°è¿™ä¸€ç‚¹çœŸçš„æ˜¯å¾ˆå‰å®³çš„è®¾è®¡ã€‚

*   **ç£å¤´**ï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç£å¤´æ˜¯ä¸€ä¸ªå¤–é¢è¢«çº¿åœˆç¼ ç»•ç€çš„Uå‹ç£èŠ¯ï¼Œå¯ä»¥çœ‹å‡ºå½“ç£å¤´é€šç”µæ—¶ä¾¿ä¼šäº§ç”Ÿç£åœºï¼Œç£åœºçš„æ–¹å‘éšç”µæµæ–¹å‘çš„å˜åŒ–è€Œå˜åŒ–ã€‚
    
    ![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145334_4.png)
*   **ç£ç›˜**ï¼šç£ç›˜çš„è¡¨é¢æ¶‚æœ‰ä¸€å±‚ç£æ€§ç‰©è´¨ï¼Œåœ¨æœªæ²¡æœ‰å¤–éƒ¨ç£åœºå½±å“çš„æƒ…å†µä¸‹ï¼Œç£ç›˜è¡¨é¢çš„ç£æ€§ç²’å­çš„ç£ææ–¹å‘æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚
    
    ä¸€èˆ¬ä»æœªå—åˆ°å¤–éƒ¨å¹²æ‰°çš„ç£æ€§ç²’å­ç£ææ–¹å‘æ˜¯éšæœºçš„ï¼Œäºæ˜¯å‡ºç°äº’ç›¸æŠµæ¶ˆçš„æƒ…å†µï¼Œè¿™æ—¶ç£ç›˜çš„è¡¨ç°å‡ºæ— ç£ææ˜¾ç°ã€‚
    
*   **æ•°æ®åœ¨ç£ç›˜ä¸Šå°±æ˜¯ä¸€äº›ç£ææ–¹å‘ä¸åŒçš„å¾®å°å±€éƒ¨åŒºåŸŸ**ï¼›
    
*   **è¯»å–ï¼š**
    
    *   ä¸é€šç”µçš„ç£å¤´åœ¨å†™å…¥æ•°æ®çš„ä½ç½®ä¸Šç§»åŠ¨ï¼Œæ•°æ®åœ¨ç£ç›˜ä¸Šå°±æ˜¯ä¸€äº›ç£ææ–¹å‘ä¸åŒçš„å¾®å°å±€éƒ¨åŒºåŸŸï¼›
    *   ç”±äºå„ä¸ªåŸŸçš„ç£ææ–¹å‘ä¸å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥ç£å¤´åœ¨é€šè¿‡è¿™äº›ä¸åŒæ–¹å‘çš„åŒºåŸŸæ—¶ä¼šäº§ç”Ÿä¸åŒæ–¹å‘çš„æ„Ÿåº”ç”µæµï¼›
    *   è¿™äº›å¾®å¼±æ­£è´Ÿè„‰å†²ç”µæµï¼Œç»è¿‡ é©±åŠ¨/æ§åˆ¶å™¨ çš„ å»å™ªã€æ‰©å¤§ æˆä¸ºå†…å­˜ä¸­çš„äºŒè¿›åˆ¶æ•°æ®ã€‚
*   **å†™å…¥**ï¼š
    
    *   å†™æ•°æ®æ—¶ç£å¤´ç§»åˆ°åˆ°ç£ç›˜è¦å†™å…¥çš„ä½ç½®ï¼Œè¾“å…¥ ç”µæµ / ç”µä¿¡å· äº§ç”Ÿæ„Ÿåº”ç£åœºï¼Œç”µç”Ÿç£ï¼›
    *   å—ç£åœºçš„å½±å“ï¼Œç£å¤´ä¸‹ç£æ€§ç²’å­çš„ç£ææ–¹å‘å˜ä¸ºä¸ç£åœºåŒå‘ã€‚é€š**è¿‡ç»™ç£å¤´ä¸åŒçš„ç”µæµæ–¹å‘ï¼Œä½¿å¾—ç£ç›˜å±€éƒ¨äº§ç”Ÿä¸åŒçš„ç£æ**ï¼›è€Œè¿™ç§å±€éƒ¨ç£æçš„ç‰¹æ€§ï¼Œå°±æ˜¯ç£ç›˜å­˜å‚¨æ•°æ®çš„æ–¹å¼ï¼›
    *   äº§ç”Ÿçš„ç£æåœ¨æœªå—åˆ°å¤–éƒ¨ç£åœºå¹²æ‰°ä¸‹**æ˜¯ä¸ä¼šæ”¹å˜çš„**ã€‚**é€šè¿‡è¿™ç§æ–¹å¼å°±å°† ç”µä¿¡å· / æ•°æ® æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Š**ã€‚
    
    > å½“ç„¶ä¹Ÿå¹¶ä¸æ˜¯ä¸€ä¸ªç£ææ–¹å‘ä»£è¡¨1å¦ä¸€ä¸ªä»£è¡¨0
    

åœ¨ç¡¬ç›˜è¯»å†™æ—¶ï¼Œè¯»æ“ä½œè¿œå¿«äºå†™æ“ä½œï¼Œå¹¶ä¸”ç£ç›˜çš„ è¯»/å†™æ“ä½œ å…·æœ‰å®Œå…¨ä¸åŒçš„ç‰¹æ€§ï¼Œæ‰€ä»¥ç›®å‰çš„ç¡¬ç›˜ä¸€èˆ¬éƒ½è®¾è®¡ è¯»å’Œå†™ ä¸¤ä¸ªç£å¤´ï¼Œä½†æ˜¯åŸç†è¿˜æ˜¯ä¸Šé¢çš„åŸç†ã€‚

#### 1.3.3 ç®€å•æ€»ç»“

ç”±ä¸Šè¿°ç›¸å…³å†…å®¹å¯çŸ¥ï¼Œä¸Šå±‚åªéœ€è¦å‘ä¸‹ä¼ é€’å‡ ä¸ªå‚æ•°å³å¯æ§åˆ¶æ•´ä¸ªè¿‡ç¨‹ï¼š

1.  ç¬¬å‡ æŸ±é¢ï¼›
    
    > å› ä¸ºç£ç›˜é‚£ä¹ˆå¤§ï¼Œä¸ä¸€å®šåªæœ‰ä¸€ä¸ªç³–è‘«èŠ¦ä¸²ï¼›
    
2.  ç¬¬å‡ ç£å¤´ï¼›
    
    > å†³å®šæ˜¯ç¬¬å‡ ä¸ªç›˜é¢ / ç³–è‘«èŠ¦ä¸²ä¸Šçš„ç¬¬å‡ ä¸ªç³–è‘«èŠ¦ï¼›
    
3.  ç¬¬å‡ ç£é“ï¼›
    
    > å¯»é“ï¼Œéœ€è¦çŸ¥é“æ˜¯ç›˜é¢ä¸Šçš„å“ªä¸€ä¸ªåœ†ç¯ï¼›
    
4.  ç¬¬å‡ æ‰‡åŒºï¼›
    
    > æ—‹è½¬å¯»æ‰¾æ‰‡åŒºï¼Œéœ€è¦çŸ¥é“æ˜¯åœ†ç¯çš„å“ªä¸€ä¸ªå¼§å½¢åŒºåŸŸï¼›
    
5.  è¯»å‡º è¿˜æ˜¯ å†™å…¥ï¼›
    
    > å†³å®šæ‰§è¡Œçš„æ“ä½œ
    
6.  è¯»åˆ°å“ªä¸ªç¼“å­˜ä½ç½® / ä»å“ªä¸ªç¼“å­˜ä½ç½®å†™å…¥ï¼›
    
    > å¯ä»¥ä½¿ç”¨ DMA æ€»çº¿ç›—ç”¨æŠ€æœ¯ï¼Œå®Œæˆç£ç›˜å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®äº¤æµã€‚
    

æ ¹æ®è¿™äº›å‚æ•°ï¼ˆ**æŸ±é¢å·ã€ç›˜é¢å·ã€æ‰‡åŒºå·**ï¼‰ï¼Œç£ç›˜æ§åˆ¶å™¨ å°±å¯ä»¥ è‡ªåŠ¨é©±åŠ¨ç›¸å…³æœºæ„ å»æ‰§è¡Œã€‚**ç”Ÿç£ç›˜çš„é©±åŠ¨**ä¹Ÿä¸è¿‡å°±æ˜¯å°†è¿™äº›å‚æ•°å†™åˆ°ç£ç›˜æ§åˆ¶å™¨ä¸Šï¼Œ**ä¹Ÿå°±æ˜¯ OUT æŒ‡ä»¤ã€‚**

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145338_5.png)

2\. 0å±‚æŠ½è±¡ï¼šä½¿ç”¨ç£ç›˜çš„ç›´è§‚æ–¹æ³•
------------------

ç›´è§‚æ–¹æ³•å°±æ˜¯å¦‚ä¸Šé¢1.3.3 çš„æ€»ç»“ä¸­æ‰€æƒ³çš„æ€è·¯ï¼Œæ‹¿åˆ°è¿™äº›å‚æ•°ï¼Œå°±å¯ä»¥è®©ç£ç›˜æ§åˆ¶å™¨å¦‚æˆ‘ä»¬é¢„æœŸçš„å·¥ä½œã€‚

### 2.1 è¯»å†™è¯·æ±‚

ä»£ç å›¾ç‰‡åœ¨ 1.3.3 ä¸­ï¼Œé¦–å…ˆæ˜¯ç£ç›˜è¯»å†™çš„è¯·æ±‚å‡½æ•° `do_hd_request()`ï¼Œå°†å‚æ•°ä¼ é€’ç»™ç£ç›˜æ§åˆ¶å™¨ã€‚

    
    void do_hd_request(void)
    {
    	..... 
    	//å¾—åˆ°dev,nsect,sec,head,cylï¼ŒWIN_WRITE,&write_intr å‚æ•°
        // dev æ§åˆ¶å™¨ï¼Œnsect è¯»å†™å‡ ä¸ªæ‰‡åŒºï¼Œcyl æŸ±é¢ï¼Œhead ç£å¤´ï¼Œsec æ‰‡åŒºï¼ŒWIN_WRITE å†™ï¼Œ&write_intr ç¼“å­˜ä½ç½®
    	//ä¼ é€’ç»™ç£ç›˜æ§åˆ¶å™¨
    	if (CURRENT->cmd == WRITE) {
    		hd_out(dev,nsect,sec,head,cyl,WIN_WRITE,&write_intr);
    		for(i=0 ; i<3000 && !(r=inb_p(HD_STATUS)&DRQ_STAT) ; i++)
    			/* nothing */ ;
    		if (!r) {
    			bad_rw_intr();
    			goto repeat;
    		}
    		port_write(HD_DATA,CURRENT->buffer,256);
    	} else if (CURRENT->cmd == READ) {
    		hd_out(dev,nsect,sec,head,cyl,WIN_READ,&read_intr);
    	} else
    		panic("unknown hd-command");
    }
    

### 2.2 ç£ç›˜é©±åŠ¨

æ¥ç€æ˜¯ ç£ç›˜é©±åŠ¨çš„æ ¸å¿ƒä»£ç  `hd_out()`ï¼Œå°†ä¸Šè¿°å‚æ•°æ”¾åˆ°ç«¯å£ä¸Šï¼Œå¹¶å°†ç›¸å…³ä¿¡æ¯æŒ‰ç…§è¦æ±‚æ‹¼æ¥èµ·æ¥ï¼Œæ‰€ä»¥æœ‰ä¸€äº›ç§»ä½ï¼Œå¹¶ä¸”å¾—åˆ°è¯»å†™çš„å†…å­˜ç¼“å†²åŒºï¼š

    static void hd_out(unsigned int drive,unsigned int nsect,unsigned int sect,
    		unsigned int head,unsigned int cyl,unsigned int cmd,
    		void (*intr_addr)(void))
    {
    	register int port asm("dx");
    
    	if (drive>1 || head>15)
    		panic("Trying to write bad sector");
    	if (!controller_ready())
    		panic("HD controller not ready");
        // è®¡ç®—ç¼“å­˜åœ°å€
    	do_hd = intr_addr;
    	outb_p(hd_info[drive].ctl,HD_CMD);
    	port=HD_DATA; //æ•°æ®å¯„å­˜å™¨ç«¯å£(0x1f0)
    
    	//outb_p æ¥å£å°±æ˜¯å‘å¤–è®¾ä¼ é€æ•°æ®çš„
    	//è¿™å°±æ˜¯cpuä¸­ç£ç›˜é©±åŠ¨çš„æ ¸å¿ƒä»£ç 
    	outb_p(hd_info[drive].wpcom>>2,++port);
    	outb_p(nsect,++port);
    	outb_p(sect,++port);
    	outb_p(cyl,++port);
    	outb_p(cyl>>8,++port);
    	outb_p(0xA0|(drive<<4)|head,++port);
    	outb(cmd,++port);
    }
    

### 2.3 ç®€å•æ€»ç»“

è¿™æ ·ä½¿ç”¨å¾ˆç®€å•ç›´æ¥ï¼Œä½†æ˜¯éœ€è¦ä¼ é€’çš„å‚æ•°å¤ªå¤šäº†ï¼Œå¦‚æœä½¿ç”¨è¿™ç§ç›´æ¥ä½¿ç”¨çš„æ–¹æ¡ˆï¼Œè¿™äº›å‚æ•°éƒ½æ˜¯éœ€è¦ä¸Šå±‚ä¼ é€’ç»™ç£ç›˜æ§åˆ¶å™¨çš„ï¼Œå¤ªéº»çƒ¦äº†ã€‚å¦‚æœæˆ‘ä»¬åªç»™å‡ºè¦è®¿é—®çš„ç£ç›˜ä½ç½®ï¼ˆä¸€ä¸ªæ•° / **ä¹Ÿå°±æ˜¯ç£ç›˜å—**ï¼‰ï¼Œç”±æ“ä½œç³»ç»Ÿè‡ªåŠ¨è§£ç®—æŸ±é¢ã€ç£å¤´ã€ç£é“ã€æ‰‡åŒºã€æ‰‡åŒºä¸ªæ•°ï¼Œè¿™æ ·å°±ä¼šæ–¹ä¾¿å¾ˆå¤šã€‚

æ—¢ç„¶ 0 å±‚æŠ½è±¡ä¸ä¾¿ä½¿ç”¨ï¼Œè¿™å°±å¼•å‡ºäº†**ç¬¬ 1 å±‚æŠ½è±¡**ã€‚

3\. ç¬¬1å±‚æŠ½è±¡ï¼šç›˜å—å·è¯»å†™ç£ç›˜
-----------------

ç”¨ä¸Šæ–‡çŸ¥ï¼Œç¬¬ 1 å±‚æŠ½è±¡ å°†æŸ±é¢ã€ç£å¤´ã€æ‰‡åŒºåŒ…è£…æˆä¸€ä¸ª**ç£ç›˜å—**ï¼Œä¸Šå±‚ç”¨æˆ·åªéœ€å‘ä¸‹ä¼ é€’ç£ç›˜å—ï¼Œç£ç›˜é©±åŠ¨ä» ç£ç›˜å— / block è§£ç®—å‡º CHSã€‚

è¿™æ¶‰åŠä¸€ç»´åœ°å€ç¼–å€ä¸‰ç»´ç©ºé—´ï¼Œä¸‹é¢çœ‹çœ‹å¦‚ä½•ç¼–å€ã€‚

> *   CHS: cyl æŸ±é¢ï¼Œhead ç£å¤´ï¼Œsec æ‰‡åŒºã€‚
> *   æ³¨æ„ï¼šCHSå¯ä»¥å®šä½ä¸€ä¸ªæŸ±ä½“é‡Œçš„ä»»æ„ä½ç½®ï¼Œè¿™é‡Œå°±æ˜¯å¤§å­¦ç‰©ç†ã€é«˜æ•°æåˆ°è¿‡çš„æŸ±é¢åæ ‡ç³»ï¼›
> *   è¿™æ ·å°è£…ï¼Œä¹Ÿæ˜¯è®¾è®¡æ¨¡å¼çš„ adapter æ¨¡å¼ã€‚å¯ä»¥è®©ç”¨æˆ·ä½¿ç”¨ç£ç›˜æ›´åŠ **ç®€å•ã€é«˜æ•ˆ**ã€‚

### 3.1 ç›˜å—å·ç¼–å€ä¸‰ç»´ç©ºé—´

åŸºäºä¸€ä¸ªå¸¸è§äº‹å®ï¼Œå³å¯¹äº ç£ç›˜å—çš„è®¿é—®/è¯»å†™ é€šå¸¸æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬ä¼šå¸Œæœ›ä¸€ä¸ª blockå— çš„ç›¸é‚»ç›˜å—å¯ä»¥å¿«é€Ÿè¯»å‡ºã€‚

ä¸ºäº†è¾¾åˆ°è¿™ä¸€æ•ˆæœï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ†æä¸€ä¸‹0å±‚æŠ½è±¡æ—¶çš„ç£ç›˜è®¿é—®æ—¶é—´ï¼Œçœ‹çœ‹å“ªéƒ¨åˆ†æµªè´¹æ—¶é—´æœ€å¤šã€‚å¦‚ä¸‹å›¾ä¸­é—´æ‰€ç¤ºï¼š

*   ç£ç›˜è®¿é—®æ—¶é—´ = å†™å…¥æ§åˆ¶å™¨æ—¶é—´ + å¯»é“æ—¶é—´ + æ—‹è½¬æ—¶é—´ + ä¼ è¾“æ—¶é—´ï¼›
*   å¯è§ï¼Œå¤§å¤šæ•°æ—¶é—´è¢«ç”¨æ¥ **å¯»é“**ã€‚ä¹Ÿå³ç£å¤´åœ¨åŠå¾„æ–¹å‘ä¸Šçš„ç§»åŠ¨å¾ˆæ…¢ï¼Œè€Œæ—‹è½¬å’Œä¿¡å·ä¼ é€’çš„è¿‡ç¨‹æ›´å¿«ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿ç»­è®¿é—®ç›¸é‚»çš„ç£ç›˜å—ï¼Œåº”å½“å‡å°‘ç›¸é‚»çš„ç£ç›˜å—è®¿é—®çš„**å¯»é“æ—¶é—´**ï¼Œå³ï¼Œ**å°†ç›¸é‚»ç£ç›˜å—æ”¾åœ¨åŒä¸€ç£é“ä¸Š**ã€‚

> *   ç£ç›˜å—æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿå±‚æ¬¡çš„æŠ½è±¡æ¦‚å¿µï¼Œæ“ä½œç³»ç»Ÿä¸ç£ç›˜ä¹‹é—´äº¤æµçš„æœ€å°å•ä½å°±æ˜¯ç£ç›˜å—ï¼Œè€Œç£ç›˜ä¸Šçš„ç‰©ç†æœ€å°å•ä½æ˜¯æ‰‡åŒºã€‚
> *   æ“ä½œç³»ç»Ÿå¯ä»¥è®¾ç½®ç£ç›˜å—å¯¹åº”å¤šå°‘ä¸ªæ‰‡åŒºã€‚
> *   ç›¸é‚»ç£ç›˜å—æ”¾åœ¨åŒä¸€ç£é“ä¸Šä¸å‡†ç¡®ï¼Œåº”å½“æ˜¯ç›¸é‚»ç£ç›˜å—åº”å½“å°½é‡å¯¹åº”åŒä¸€ç£é“ä¸Šçš„æ‰‡åŒºï¼Œå¦‚è‹¥ä¸ç„¶ï¼Œé‚£ä¹Ÿå°½é‡æ–¹ä¾¿è®¿é—®ã€‚

ç£ç›˜å±‚é¢ å…·ä½“æ‰‡åŒºæ”¾ç½®æ–¹å¼ å¦‚ä¸‹å›¾çš„ä¸‹åŠéƒ¨åˆ†æ‰€ç¤ºï¼š

*   1å·æ‰‡åŒº åœ¨ 0å·æ‰‡åŒº æ—‹è½¬æ–¹å‘çš„ä¸‹ä¸€æ‰‡åŒºï¼›
    
*   å‡è®¾ä¸€ä¸ªç›˜é¢æœ‰ 7 ä¸ªæ‰‡åŒºï¼Œåˆ™ 0-6 æ‰‡åŒºåœ¨ç¬¬ä¸€ä¸ªç›˜é¢ï¼Œ7 å·æ‰‡åŒºå°±åœ¨ 0 å·æ‰‡åŒº \*\*ç«–ç›´æ–¹å‘çš„ä¸‹ä¸ªç›˜é¢/ç¬¬2ä¸ªç›˜é¢ \*\*çš„å¯¹åº”æ‰‡åŒºï¼›
    
    > ä¹Ÿå³ **0å·æ‰‡åŒºçš„æ­£ä¸‹æ–¹**ï¼Œè¿™æ˜¯å› ä¸ºä¸åŒç›˜é¢çš„ç£å¤´æ˜¯ä¸€åŒæ—‹è½¬çš„ï¼ˆåŒä¸€ç£è‡‚ï¼‰ï¼Œç¬¬ä¸€ä¸ªç›˜é¢çš„ç£å¤´æ—‹è½¬åˆ°6å·æ‰‡åŒºçš„æœ«å°¾æ—¶ï¼Œç¬¬äºŒä¸ªç›˜é¢çš„ç£å¤´ä¹Ÿæ­£å¥½åˆ°è¾¾7å·æ‰‡åŒºã€‚
    

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145343_6.png)

æŒ‰ç…§ä¸Šé¢çš„æ‰‡åŒºå®‰æ’é¡ºåºï¼ˆä¹Ÿå°±æ˜¯ç¼–å€æ–¹å¼ï¼‰ï¼Œæ‰‡åŒºå· LBA ç”¨å…¬å¼è¡¨ç¤ºä¸ºï¼š

*   \\\[LBA = C Ã— (Heads Ã— Sectors) + H Ã— Sectors + S \\\]
    
    > LBA æ˜¯æ‰‡åŒºçš„ç¼–å·ï¼Œ æŒ‰ç…§æŸ±é¢ã€ç£å¤´å’Œç£é“ä»å°åˆ°å¤§çš„é¡ºåº**å¯¹æ‰‡åŒºç¼–å·**ã€‚è¿™é‡Œç†è§£æ¯ä¸ªç£é“ä¸Šçš„æ‰‡åŒºæ•°é‡æ˜¯ä¸€æ ·çš„ï¼ˆå®é™…ä¸Šä¼šæœ‰æ‰€å·®åˆ«ï¼‰ã€‚
    
*   C æ˜¯ æŸ±é¢ï¼Œ H æ˜¯ç›˜é¢ï¼ŒSæ˜¯æ‰‡åŒºï¼›
    
*   æ„æ€å°±æ˜¯å·²ç»èµ°è¿‡äº†å¤šå°‘æŸ±é¢ä¸ªæ‰‡åŒºï¼Œå¤šå°‘ç£é¢ä¸ªæ‰‡åŒºï¼Œä»¥åŠåŒä¸€ç£é¢ä¸Šå·²ç»è¿‡çš„å¤šå°‘æ‰‡åŒºã€‚
    
*   å¯è§ç£ç›˜å¯»å€æ˜¯åŸºäºæ‰‡åŒºçš„ã€‚**ä¸Šå¼å¾—åˆ°çš„å°±æ˜¯ä»0æŸ±é¢å¼€å§‹ç¼–å€çš„æ‰‡åŒºå·ï¼Œä¹Ÿå°±å¾—åˆ°äº† LBA**ã€‚
    

è€Œåè¿‡æ¥ç”± æ‰‡åŒºå·LBA åæ¨ CHSï¼Œä¹Ÿå¾ˆå¥½åšï¼š

*   S = LBA % Sectorsï¼›ï¼ˆå–ä½™ï¼‰
*   H = (LBA / Sectors) % Headsï¼›
*   C = LBA / Sectors / Headsï¼›

åˆ°è¿™é‡Œï¼Œé€šè¿‡ç¼–å€å»ºç«‹äº†ä» CHS æ‰‡åŒºåœ°å€åˆ°æ‰‡åŒºå·çš„ä¸€ä¸ªæ˜ å°„ï¼Œä¹Ÿå»ºç«‹äº†ä» æ‰‡åŒºå·LBA åˆ° CHS çš„åå‘è®¡ç®—æ–¹æ³•ï¼›**è¿™å°±æ˜¯ç¬¬1å±‚æŠ½è±¡çš„æ ¸å¿ƒä»»åŠ¡**ã€‚

è€Œæˆ‘ä»¬åå¤æåˆ°è¿‡ï¼Œ**æ‰‡åŒºå·è¿ç»­çš„å¤šä¸ªæ‰‡åŒºå°±æ˜¯ä¸€ä¸ªç£ç›˜å—ã€‚**åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ“ä½œç³»ç»Ÿå°±èƒ½é€šè¿‡ç”¨æˆ·è¯·æ±‚çš„**ç£ç›˜å—**æ¥è‡ªåŠ¨è§£ç®—è®¿é—®ç£ç›˜**å¯¹åº”æ‰‡åŒº**ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145348_7.png)

ä¸‹é¢åˆ†æä¸€ä¸‹ ç¬¬1å±‚æŠ½è±¡ å¯¹äºç£ç›˜è®¿é—®æ—¶é—´ä¸Šçš„èŠ‚çœæƒ…å†µï¼Œå¦‚ä¸Šå›¾ä¸‹åŠéƒ¨åˆ†æ‰€ç¤ºï¼š

*   **ç£ç›˜çš„è®¿é—®æ—¶é—´ = å†™å…¥æ§åˆ¶å™¨æ—¶é—´ + å¯»é“æ—¶é—´ + æ—‹è½¬æ—¶é—´ + ä¼ è¾“æ—¶é—´**ï¼›
*   æ“ä½œç³»ç»Ÿå¯ä»¥æ¯æ¬¡è¯»å†™ä¸€ä¸ªç›˜å—ï¼š
    *   æ¯æ¬¡è¯»å†™1 Kï¼š ç¢ç‰‡0.5Kï¼›è¯»å†™é€Ÿåº¦100K/ç§’ï¼›
    *   æ¯æ¬¡è¯»å†™1 Mï¼šç¢ç‰‡0.5Mï¼›è¯»å†™é€Ÿåº¦çº¦40M/ç§’

è¿™é‡Œçš„æ•°å­—æ„ä¹‰ä¸å¤§ï¼Œåªæ˜¯ç†è§£ï¼š

*   å¦‚æœç›˜å—/æ‰‡åŒºçš„å¤§å°å˜å¤§ï¼Œè¯»å†™é€Ÿåº¦å˜å¤§
    
    > å› ä¸ºèŠ‚çœäº†å¯»é“æ—¶é—´ã€‚
    
*   ä½†æ˜¯å¤§å°å˜å¤§ä¸æ˜¯æ²¡æœ‰ä¸Šé™çš„ï¼Œè¯»å†™çš„å•ä½ç©ºé—´è¶Šå¤§ï¼Œæµªè´¹ç©ºé—´ä¹Ÿè¶Šå¤§ï¼ˆç¢ç‰‡ï¼‰ï¼Œç©ºé—´åˆ©ç”¨ç‡ä½ï¼›
    
    > å› ä¸ºå¯èƒ½æ‰€éœ€è¦çš„åªæœ‰0.5Mï¼Œä½†æ˜¯è¯»å–å•ä½æ˜¯1Mï¼Œè¯»è¿›æ¥ 1M å°±ä¼šæœ‰ 0.5M æµªè´¹ã€‚
    
*   **è¿™é‡Œä½“ç°äº† ç©ºé—´å’Œæ—¶é—´ çš„æŠ˜è¡·ã€‚**
    

ä½†æ˜¯ç°ä»£å­˜å‚¨æŠ€æœ¯ä¸æ–­å‘å±•ï¼Œå¤§ç£ç›˜å·²ç»å¹¿æ³›åº”ç”¨ï¼Œä½†æ˜¯ç£ç›˜çš„å¯»é“ã€æ—‹è½¬æ—¶é—´æ–¹é¢æ²¡æœ‰å¾ˆå¤§çš„æå‡ã€‚å› æ­¤æµªè´¹çš„ç©ºé—´å¯ä»¥ç¨å¾®å¤šä¸€äº›ï¼Œä»¥æ­¤å‡å°‘å¯»é“æ—¶é—´ æ¥**æ¢å–** æ›´å¿«çš„ç£ç›˜è¯»å†™é€Ÿåº¦ã€‚

### 3.2 ä»£ç å®ç°

ç®€å•æ€»ç»“ä¸€ä¸‹ä¸Šè¿°çš„ç¬¬1å±‚æŠ½è±¡ï¼š

*   **ä¸Šå±‚ç”¨æˆ·**åœ¨ç¨‹åºä¸­è¯·æ±‚ç£ç›˜å—ï¼›
*   **æ“ä½œç³»ç»Ÿ**æ ¹æ®è‡ªèº«è®¾ç½®ï¼ˆä¸€ä¸ªç£ç›˜å—å¯¹åº”å¤šå°‘æ‰‡åŒºï¼‰ï¼Œæ¢ç®—ä¸ºéœ€è¦è¯»å–çš„è¿ç»­æ‰‡åŒºï¼›æ ¹æ®LBAå’ŒCHSçš„æ¢ç®—ï¼Œè§£ç®—å‡ºç£ç›˜ä¸­æ‰‡åŒºåœ°å€ï¼›
*   **æ“ä½œç³»ç»Ÿ**å°†å‘é€ç»™**ç£ç›˜æ§åˆ¶å™¨**ï¼Œè®¿é—®/è¯»å†™ å¯¹åº”æ‰‡åŒºï¼›

å¯è§æŠ½è±¡åœ¨äºï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿ**å°†ç£ç›˜æ‰‡åŒºåœ°å€å°è£…ä¸ºç£ç›˜å—**ï¼Œç”¨æˆ·åªéœ€è¦é€šè¿‡è¯·æ±‚ç›˜å—å· blocknr å³å¯è®¿é—®ç£ç›˜ã€‚è¿™å±‚æŠ½è±¡åšåˆ°äº†æ—¢ç®€å•åˆé«˜æ•ˆã€‚

ä¸‹é¢å°±å¯ä»¥é€šè¿‡ç£ç›˜å·è¯»å†™ç£ç›˜ï¼š

    static void make_request()
    { 
    	struct requset *req;
    	req=request+NR_REQUEST;
        //ç”¨ ç›˜å—å·block è®¡ç®— æ‰‡åŒºå·sector
    	req->sector=bh->b_blocknr<<1;
        //æ ¹æ® æ‰‡åŒºå·sector è®¡ç®—æ‰‡åŒºåœ°å€
    	add_request(major+blk_dev,req); 
    }
    
    void do_hd_request(void)
    { 
    	unsigned int block=CURRENT->sector;
        //ä¸‹é¢å°±æ˜¯é™¤æ³•è·Ÿå–ä½™ï¼Œè®¡ç®— chs
    	__asm__(â€œdivl %4â€:â€=aâ€(block),â€=dâ€(sec):â€0â€(block),
    	â€œ1â€(0),â€râ€(hd_info[dev].sect));
    	__asm__(â€œdivl %4â€:â€=aâ€(cyl),â€=dâ€(head):â€0â€(block),
    	â€œ1â€(0),â€râ€(hd_info[dev].head));
        //è¾“å‡ºå¯¹åº”ä½ç½®çš„æ‰‡åŒºï¼Œè¿™æ˜¯ç¬¬0å±‚æŠ½è±¡çš„å†…å®¹
    	hd_out(dev,nsect,sec,head,cyl,WIN_WRITE,...);
    	... 
    }
    
    

æ®ä¸Šé¢ä»£ç ä¹Ÿå¯ä»¥æ¨çŸ¥ï¼šLinux 0.11è®¾ç½®çš„ç›˜å—çš„å¤§å°æ˜¯1Kï¼ˆå·¦ç§»äº†ä¸€ä½ï¼Œä»£è¡¨ç›˜å—å’Œæ‰‡åŒºæ¢ç®—å•ä½æ˜¯2ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªæ‰‡åŒºã€‚

### 3.3 å‚è€ƒèµ„æ–™

*   å¦‚æœä¸ç†è§£ç£ç›˜å—å’Œæ‰‡åŒºï¼Œå‚è€ƒèµ„æ–™ï¼š
    
    *   [è®¡ç®—æœºå­˜å‚¨æœ¯è¯­: æ‰‡åŒºï¼Œç£ç›˜å—ï¼Œé¡µ](https://zhuanlan.zhihu.com/p/117375905)
    *   [ç£ç›˜å—ä¸æ‰‡åŒºçš„åŒºåˆ«å’Œè”ç³»\_](https://blog.csdn.net/u010711495/article/details/119055677)
    *   è¿™ä¸€ç‚¹æˆ‘å·²ç»åœ¨ 3.1 ä¸­ç»™äº†æ¯”è¾ƒç²¾è¦çš„ç†è§£ã€‚
*   å¦‚æœä¸äº†è§£ ç¼–å€æ–¹å¼ï¼Œå‚è€ƒèµ„æ–™ï¼š
    
    *   [æœºæ¢°ç¡¬ç›˜LBAå’ŒCHS](https://www.jianshu.com/p/a5a55da86a15)ï¼Œè¯¾ç¨‹æ²¡æœ‰è®²ï¼Œ1å±‚æŠ½è±¡å°±æ˜¯ LBAï¼ˆ LBAå°±æ˜¯æ‰‡åŒºçš„ç¼–å·ï¼Œç‰©ç†æ‰‡åŒºå·ï¼‰ã€‚
        
        > è¯¾ç¨‹ä¸­è®²è§£LBAä¸CHSçš„è§£ç®—æ—¶ï¼ˆ3.1éƒ¨åˆ†ï¼‰ï¼Œç”¨çš„ç›´æ¥æ˜¯block/ç›˜å—ï¼Œæˆ‘è§‰å¾—ä¸åˆé€‚ï¼Œåº”å½“æ˜¯LBAæ‰‡åŒºå·ï¼Œç„¶åæ‰‡åŒºå·å’Œç£ç›˜å—æœ‰å¯¹åº”å…³ç³»ã€‚
        

4\. ç¬¬2å±‚æŠ½è±¡ï¼šå¤šè¿›ç¨‹é€šè¿‡é˜Ÿåˆ—ä½¿ç”¨ç£ç›˜
---------------------

ç¬¬ 1 å±‚æŠ½è±¡ä¸­ï¼Œæˆ‘ä»¬å±è”½äº†åº•å±‚ç£ç›˜çš„å‚æ•°ï¼Œä¸Šå±‚ç”¨æˆ·ç¨‹åºåªéœ€è¦å‘å‡ºç›˜å—å·ç»™æ“ä½œç³»ç»Ÿå¤„ç†å°±å¯ä»¥äº†ã€‚

ä½†æ˜¯å®é™…æ“ä½œç³»ç»Ÿä¸­ï¼Œä¸€èˆ¬æœ‰å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæå‡ºç£ç›˜å—è®¿é—®è¯·æ±‚ï¼Œè¿™æ—¶**éœ€è¦ç”¨é˜Ÿåˆ—æ¥ç®¡ç†å¤šè¿›ç¨‹çš„ç£ç›˜è®¿é—®è¯·æ±‚**ï¼Œè¿™å°±æ˜¯æ“ä½œç³»ç»Ÿå¯¹ç£ç›˜ç®¡ç†çš„**ç¬¬2å±‚æŠ½è±¡**ã€‚

### 4.1 ç¬¬2æŠ½è±¡å±‚æè¿°

**ç¬¬2å±‚æŠ½è±¡çš„æ ¸å¿ƒ**æ˜¯ï¼šå½“å¤šä¸ªç£ç›˜è®¿é—®è¯·æ±‚å‡ºç°åœ¨è¯·æ±‚é˜Ÿåˆ—ï¼Œéœ€è¦å¯¹ç£ç›˜è¿›è¡Œé€‚å½“çš„è°ƒåº¦ã€‚

> å½“**ç£ç›˜ä¸­æ–­**æ—¶ï¼Œå†ä»è¯·æ±‚é˜Ÿåˆ—ä¸­è°ƒåº¦ä¸‹ä¸€ä¸ªç£ç›˜è®¿é—®è¯·æ±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æ­¤æ—¶ä»ä½¿ç”¨ç›˜å—å·ï¼Œè¿˜æ˜¯ç”Ÿç£ç›˜ï¼Œè¿˜æ²¡æœ‰å¼•å…¥æ–‡ä»¶çš„æŠ½è±¡ã€‚

åœ¨è¿™å±‚æŠ½è±¡ä¸­ï¼Œç”±äºæ¶‰åŠé€‰æ‹©ã€è°ƒåº¦çš„é—®é¢˜ï¼Œæ‰€ä»¥åˆéœ€è¦ç›¸å…³è°ƒåº¦ç®—æ³•çš„æ”¯æ’‘ã€‚**è°ƒåº¦ç®—æ³•ç›®æ ‡ï¼šå¹³å‡å»¶è¿Ÿå°ã€‚**ç”±äºè°ƒåº¦ä¸»è¦è€ƒè™‘æ—¶é—´ï¼Œæ‰€ä»¥**å¯»é“æ—¶é—´**è¿˜æ˜¯ä¸»è¦ä¼˜åŒ–çš„æ–¹é¢ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145400_8.png)

### 4.2 è°ƒåº¦ç®—æ³•1ï¼šFCFS

è¿˜æ˜¯ä»æœ€ç®€å•çš„ ç®—æ³•/æƒ³æ³• å¼€å§‹ï¼ŒFirst Come First Serveã€‚è¿™ä¹Ÿæœ€å…¬å¹³ã€æœ€ç›´è§‚ã€‚

*   å¦‚ä¸‹å›¾ä¾‹å­ï¼šç£å¤´çš„èµ·å§‹ä½ç½®ä¸º 53ï¼Œè€Œè¯·æ±‚é˜Ÿåˆ—çš„ç£ç›˜è¯·æ±‚èµ·å§‹ä½ç½®ä¹Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›
*   å¯ä»¥æ–™æƒ³ç£å¤´é•¿é€”å¥”è¢­ï¼Œè€Œç£å¤´ç§»åŠ¨æ°æ°å°±æ˜¯å¯»é“æ—¶é—´ï¼Œç§»**åŠ¨çš„å¤šäº†æ—¶é—´å°±å˜é•¿äº†ã€‚**æ­¤ç®—æ³•ç£å¤´ç§»åŠ¨äº†640ä¸ªç£é“ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145407_9.png)

### 4.3 è°ƒåº¦ç®—æ³•2ï¼šSSTF

çŸ­å¯»é“ä¼˜å…ˆ Shortest-seek-time Firstã€‚åŸºäºä¸Šé¢çš„ä¸€ç§å¼ºçƒˆæ„Ÿå—ï¼šå†é‡åˆ°65è¯·æ±‚æ—¶ï¼Œç›´æ¥é¡ºä¾¿æŠŠ67è¯·æ±‚ä¹Ÿç»™æ‰§è¡Œäº†ï¼Œè¿™æ ·å°±ä¸å¿…æ¥å›è·‘äº†ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145415_10.png)

å¯è§ç»è¿‡è¿™æ ·çš„ä¼˜åŒ–ï¼Œç£å¤´ç§»åŠ¨236ä¸ªç£é“ï¼Œè¾ƒäºè°ƒåº¦ç®—æ³•1FCFSè¦å¥½å¾ˆå¤šã€‚

ä½†æ˜¯è¿™ç§ç®—æ³•ä¹Ÿæœ‰é—®é¢˜ï¼š

*   ç£ç›˜è¯·æ±‚æ€»æ˜¯ä¸æ–­åœ°åˆ°æ¥ï¼Œç”±äºè¿™ç§ç®—æ³•çš„å±€éƒ¨æ€§ï¼Œå­˜åœ¨æ’é˜Ÿå¯èƒ½æ€§ï¼›
*   ä½ç½®åè¿œçš„ç£ç›˜è¯·æ±‚å¯èƒ½æ—©éƒ½åˆ°è¾¾äº†ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰å“åº”ï¼›
*   è¿™å°±é€ æˆäº† **é¥¥é¥¿é—®é¢˜**ã€‚

### 4.4 è°ƒåº¦ç®—æ³•3ï¼šSCANç£ç›˜è°ƒåº¦

SCANç£ç›˜è°ƒåº¦ = SSTF+ä¸­é€”ä¸å›æŠ˜ï¼Œä¹Ÿå«ç”µæ¢¯ç®—æ³•ã€‚æ—¢ç„¶SSTFå­˜åœ¨å±€éƒ¨éœ‡è¡æ€§ï¼Œé‚£ä¹ˆçº¦æŸå…¶å…ˆæ²¿ä¸€ä¸ªæ–¹å‘è®¿é—®å®Œæ‰€æœ‰çš„ç£ç›˜è¯·æ±‚å†æ‰å¤´ï¼Œå°±ä¸ä¼šæ¼ä¸‹ä¸€äº›åè¿œçš„ç£ç›˜è¯·æ±‚ã€‚ï¼ˆè¿™ä¹Ÿå¾ˆåƒä¸€ä¸ªç”µæ¢¯ã€‚ï¼‰

å¯è§ç£å¤´ç§»åŠ¨ 236 æ¬¡ï¼Œä¸ SSTF é½å¹³ï¼›æ—¢ä¿è¯äº†å…¬å¹³ï¼Œä¹Ÿä¿è¯äº†æ•ˆç‡ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145421_11.png)

ä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€ç‚¹ç‚¹é—®é¢˜ï¼šç”±äºæŠ˜è¿”è·‘çš„å½¢å¼ï¼Œä¸­é—´çš„ç£ç›˜è¯·æ±‚è¿˜æ˜¯æ¯”è¾ƒæ²¾å…‰ã€‚æ‰€ä»¥è€ƒè™‘ç£å¤´åˆ°å¤´ä¹‹åç›´æ¥å¤ä½å†æ»‘åŠ¨ï¼Œè§ä¸‹ä¸€ç§è°ƒåº¦ç®—æ³•ï¼š

### 4.5 è°ƒåº¦ç®—æ³•4ï¼šC-SCANç£ç›˜è°ƒåº¦

è¿™æ˜¯æ“ä½œç³»ç»Ÿä¸­çœŸå®ä½¿ç”¨çš„ç®—æ³•ï¼Œä¹Ÿæ˜¯ç”µæ¢¯ç®—æ³•ï¼ˆå¯æˆç§°ä¸ºè·³æ¥¼æœºï¼‰ã€‚

å…¶æ€è·¯å°±æ˜¯åªå•å‘å¯»é“ï¼Œåˆ°å¤´åç›´æ¥å¤ä½å†æ¬¡æ²¿åŒæ–¹å‘å¯»é“ï¼Œè¿™æ ·å¯¹äºæ‰€æœ‰ç£ç›˜ä½ç½®çš„è¯·æ±‚éƒ½æ˜¯å…¬å¹³çš„ã€‚

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145427_12.png)

### 4.6 C-SCAN ä»£ç å®ç°

é¦–å…ˆæ˜¯ make\_request **å¤šè¿›ç¨‹äº§ç”Ÿç£ç›˜è®¿é—®è¯·æ±‚**ï¼š

    static void make_request(){
        ...
        //æ ¹æ®ç”¨æˆ·å‘æ¥çš„ç›˜å—å·æ¢ç®—ä¸ºæ‰‡åŒºå·
        req->sector = bh -> b_blocknr << 1;
        //å°†è¯·æ±‚æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—
        add_request(major+blk_dev,req);
    }
    

**å°†ç£ç›˜è®¿é—®è¯·æ±‚æŒ‰ç…§ç”µæ¢¯ç®—æ³•æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—**ï¼Œä½¿ç”¨çš„æ˜¯ add\_request å‡½æ•°ï¼Œç”±äºæ˜¯å¤šè¿›ç¨‹éƒ½åœ¨è®¿é—®è¿™ä¸ªè¯·æ±‚é˜Ÿåˆ—ï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸Šé” / ä¸´ç•ŒåŒºè¿›è¡Œä¿æŠ¤ï¼š

> é”å’Œä¸´ç•ŒåŒºçš„æ¦‚å¿µå‚è§ï¼š[æ“ä½œç³»ç»Ÿå­¦ä¹ ç¬”è®°7 | è¿›ç¨‹åŒæ­¥ä¸åˆä½œ - climerecho - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/Roboduster/p/16643905.html)

    // linux-0.11/kernel/blk_drv/ll_rw_blk.c
    static void add_request(struct blk_dev_struct * dev, struct request * req){
    	struct request * tmp = dev->current_request;
        //è¯·æ±‚é˜Ÿåˆ—
    	req->next = NULL;
        // å¼€å¯ä¸´ç•ŒåŒºä¿æŠ¤
    	cli();   
    	if (req->bh)
    		req->bh->b_dirt = 0;
    	if (!(tmp = dev->current_request)) {
    		dev->current_request = req;
    		sti();
    		(dev->request_fn)();
    		return;
    	}
    	/*
    	å½“ç¬¦åˆä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶å°±è·³å‡ºå¾ªç¯ï¼Œå¹¶å°†req æ’å…¥tmpå’Œnextä¹‹é—´
    	(1)å½“tmpçš„æ‰‡åŒºå·å°äºreqçš„æ‰‡åŒºå·ï¼Œä¸”reqå°äºnextçš„æ‰‡åŒºå·
    	è¿™ç§æ˜¯æ­£å¸¸å®šå‘æ‰«æ
    	(2)å½“tmpçš„æ‰‡åŒºå·å°äºnextçš„æ‰‡åŒºå·ï¼Œä¸”reqå°äºnextçš„æ‰‡åŒºå·
    	è¿™ç§æ˜¯æŠ˜å›ä»å¤´å¤„ç†
    	ç¬¦åˆä¸Šè¿°æ¡ä»¶å…¶ä¸€ï¼Œä¸‹ä¸€æ­¥ç£ç›˜è¯»å†™ï¼ˆç›®å‰åœ¨tmpä¸Šï¼‰éƒ½ä¼šè¿›å…¥reqè¿™ä¸ªå¯¹è±¡ä¸Šï¼›
        å¦åˆ™å°±æŒ‰ç…§åŸæœ‰çš„,é˜Ÿåˆ—è¿›è¡Œç£ç›˜è¯»å†™ï¼Œè¿™æ ·å°±å®ç°äº†ç”µæ¢¯é˜Ÿåˆ—
        */
    	for ( ; tmp->next ; tmp=tmp->next)
            //è¿™å‡ å¥æ˜¯æ ¸å¿ƒä»£ç ï¼šç£ç›˜è¯·æ±‚æŒ‰è·³æ¥¼æœºç®—æ³•æ”¾å…¥é˜Ÿåˆ—
    		if ((IN_ORDER(tmp,req) || 
    		    !IN_ORDER(tmp,tmp->next)) &&
    		    IN_ORDER(req,tmp->next))
    			break;
    	req->next=tmp->next;
    	tmp->next=req;
    	sti();
    }
    
    

æ¥ç€æ˜¯æŒ‰ç…§è·³æ¥¼æœºç®—æ³• C-SCAN å°†ç£ç›˜è¯·æ±‚æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—ï¼Œè¿™é‡Œéœ€è¦å…ˆæ¯”è¾ƒä¸¤ä¸ªç£ç›˜è¯·æ±‚çš„æŸ±é¢å·å¤§å°ï¼ˆæ¢ç®—åï¼‰ï¼š

    /*
    æ ¸å¿ƒæ€æƒ³æ˜¯æ¯”è¾ƒs1ä¸s2ä¸­çš„sectoræ‰‡åŒºå·å¤§å°ï¼Œä¹Ÿå°±æ˜¯æ¯”è¾ƒs1ä¸s2ä¸­çš„æŸ±é¢å·çš„å¤§å°
    å› ä¸ºæŸ±é¢çš„å¯»æ‰¾æ˜¯è€—æ—¶æœ€é•¿çš„ï¼Œæ‰€ä»¥è¦ä¿è¯
    å¯»æ‰¾æŸ±é¢ä¹Ÿå³å¯»é“çš„æ—¶é—´ä¸èƒ½å¤ªé•¿ï¼Œå°±è¦åœ¨
    å¯»é“ä¸Šé¢åšä¼˜åŒ–å¤„ç†
    */
    #define IN_ORDER(s1,s2) \
    ((s1)->cmd<(s2)->cmd || ((s1)->cmd==(s2)->cmd && \
    ((s1)->dev < (s2)->dev || ((s1)->dev == (s2)->dev && \
    (s1)->sector < (s2)->sector))))
    

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145433_13.png)

5\. ç”Ÿç£ç›˜å±‚æ¬¡æŠ½è±¡ç®¡ç†çš„æ¢³ç†
----------------

è‡³æ­¤ï¼Œç”Ÿç£ç›˜å±‚é¢çš„ä¸¤å±‚æŠ½è±¡å°±è®²å®Œäº†ï¼Œè¿èµ·æ¥å°±æ˜¯ï¼š

*   å¤šè¿›ç¨‹â€œå¾—åˆ°ç›˜å—å·â€ï¼Œè®¡ç®—å‡ºæ‰‡åŒºå·ã€‚
    
    > *   è‡³äºè¿™é‡Œçš„ç›˜å—å·æ€ä¹ˆå¾—åˆ°ï¼Œå°±æ˜¯ä¸‹é¢ **æ–‡ä»¶ç³»ç»Ÿçš„å·¥ä½œ**ï¼
    > *   ç”Ÿç£ç›˜å‡å®šç›˜å—å·å·²çŸ¥ / ç”±ç”¨æˆ·ç»™å‡ºã€‚
    
*   å¾—åˆ°èµ·å§‹æ‰‡åŒºå·ï¼Œè®¿é—®ç£ç›˜**äº§ç”Ÿè¯·æ±‚**ï¼ˆmake\_requestï¼‰ï¼Œå°†å…¶æŒ‰ç…§ç”µæ¢¯ç®—æ³•æ”¾åˆ°è¯·æ±‚é˜Ÿåˆ—ä¸­ï¼ˆadd\_requestï¼‰ï¼›
    
    > æ³¨æ„ï¼Œæ­¤å¤„ make\_request ä¹Ÿæ¶‰åŠäº†å†…å­˜ç¼“å†²åŒºçš„ç”³è¯·ï¼Œæ­¤å¤„ä»£ç ä½¿ç”¨äº†å¾ˆå¤šä¼˜åŒ–æŠ€å·§ï¼Œä½†æ­¤å¤„ä¸ç»†è®²è¿™æ®µä»£ç äº†ã€‚
    
*   æ”¾å…¥è¯·æ±‚é˜Ÿåˆ—åï¼Œè¯·æ±‚è®¿é—®ç£ç›˜çš„è¿›ç¨‹ç¡çœ  / åˆ‡åˆ°ç¡çœ é˜Ÿåˆ—ï¼Œå› ä¸ºæ¥ä¸‹æ¥ä¹Ÿæ˜¯å¤–è®¾çš„å·¥ä½œäº†ã€‚è¿™ä¹Ÿæ˜¯å¤šè¿›ç¨‹åŒæ­¥åˆä½œçš„ä¸€ä¸ªä¾‹å­ã€‚
    
*   ç£ç›˜ä¸­æ–­ï¼Œå¤„ç†ç£ç›˜è¯·æ±‚ï¼Œè°ƒç”¨ do\_hd\_requestï¼›
    
    > å…·ä½“ä»£ç è§2.1.
    
*   do\_hd\_request å°† ç£ç›˜è¯·æ±‚ / æ‰‡åŒºå· æ¢ç®—ä¸ºCHSï¼›
    
*   ç”¨ hd\_out å°†CHSå‘ç»™ç›¸åº”çš„ç£ç›˜æ§åˆ¶å™¨ï¼Œå¯ç”¨æ€»çº¿è¿›è¡Œç£ç›˜è¯»å†™ã€‚
    
*   å®Œæˆè¯»å†™å·¥ä½œåï¼Œè¿›è¡Œä¸­æ–­å¤„ç†ï¼Œç»“æŸè¯·æ±‚ï¼Œå”¤é†’ç›¸åº”è¿›ç¨‹ï¼Œæ­¤æ—¶å†…å­˜ä¸­å°±æœ‰è¯¥è¿›ç¨‹éœ€è¦çš„æ•°æ®äº†ï¼Œè¿›ç¨‹ç»§ç»­å·¥ä½œã€‚
    
    > æ¥ä¸Šåé¢çš„æ–‡ä»¶ç³»ç»Ÿã€ç›®å½•ï¼Œä½¿ç”¨ç£ç›˜çš„å®Œæ•´å›¾åƒå°±å®Œæˆäº†ã€‚
    

![img](https://images.cnblogs.com/cnblogs_com/blogs/705487/galleries/2216973/o_220913145438_14.png)