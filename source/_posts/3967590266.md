---
layout: post
title: "SIP会话发起协议 - 先知道是什么（一）"
date: "2022-11-02T04:17:14.982Z"
---
SIP会话发起协议 - 先知道是什么（一）
=====================

> 少年，思无邪，最最动人。
> ============

#### 协议概述

*   `SIP`会话发起协议是`VoIP`技术中最常用的协议之一。它是一种`应用层协议`，与其它应用层协议协同工作，通过Internet控制`多媒体通信会话`。
    
*   `SIP`采用`SDP（会话描述协议）`的帮助，它描述了用于通过`IP`网络传送`语音和视频的会话和RTP（实时传输协议）`。
    
*   `SIP`可用于双方（单播）或多方（多播）会话。
    
*   其它SIP应用包括文件传输，即时通讯、视频会议、网络游戏、以及`流媒体分发`。
    

#### 网络元素

*   用户代理
    
*   代理服务器
    
*   注册服务器
    
*   重定向服务器
    
*   位置服务器
    

##### 用户代理

用户代理是`SIP`网络中最智能的设备或网络原件。它可以是软电话、手机或笔记本电脑。

用户代理在逻辑上分为两部分：

*   `用户代理客户端（UAC)`：发送请求并接收响应的实体。
    
*   `用户代理服务器（UAS）`：接收请求并发送响应的实体。
    

SIP基于`客户机 - 服务器`架构，其中呼叫者的电话充当发起呼叫的客户端，被叫方的电话充当响应呼叫的服务器。**即：一部电话既可以做客户端，也可以做服务器端。**

##### 代理服务器

网络元素接收来自用户代理的**请求并将其转发**给另外一个用户。

*   **作用类似路由**
    
*   在`URI`的帮助下进行转发
    
*   位于两个用户代理之间
    

代理服务器的两种类型

*   无状态代理：只是转发收到的消息，不存储任何呼叫或交易的信息。
    
*   有状态代理：可以跟踪收到每个请求与响应，在有需要的时候，将来可以使用，对方没有响应，可以重新发送请求。
    

##### 注册服务器

注册服务器**接受用户代理的注册请求。帮助用户在网络中进行身份认证**。将URI和用户的位置存储在数据库中，以帮助同一域内的其它SIP服务器。

设备注册流程图：

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085035063-1766161507.png)

注册流程描述：

1.  设备向服务器发送 Register请求;
    
2.  服务器向设备发送响应401,并在响应的消息头 WWW\_Authenticate字段中给出适合设备的认证体制和参数;
    
3.  设备重新向服务器发送 Register请求,在请求的 Authorization字段给出信任书, 包含认证信息;
    
4.  服务器对请求进行验证,如果检查出 设备身份合法,向设备发送成功响应 200 OK,如果身份不合法则发送拒绝服务应答。
    

##### 重定向服务器

重定向服务器接收请求，并在注册器创建的位置数据库中查找请求的预期收件人。**使用数据库获取位置信息，并以`3xx（重定向响应）`响应给用户。**

##### 位置服务器

位置服务器**提供**有关**呼叫者**可能的位置到重定向服务器或代理服务器的**信息**。

#### SIP系统架构图

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085048702-1132723178.png)

呼叫流程图

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085102553-415422561.png)

#### 会话基本呼叫流程图

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085119829-1646022747.png)

说明：

*   发送到代理服务器的INVITE请求负责启动会话。
    
*   代理服务器发送**100 尝试**立即响应呼叫者（`lijiatu`）以停止INVITE请求的重新发送。
    
*   代理服务器在位置服务器中搜索`nuonuo`的地址。获取地址后，进一步转发INVITE请求。
    
*   此后，`nuonuo`手机生成的**180 振铃**（临时响应）返回给`lijiatu`。
    
*   `nuonuo`拿起手机后一个**200 OK**响应很快产生。
    
*   一旦**200 OK**到达`lijiatu`，`nuonuo` 从`lijiatu` 收到一个**ACK。**
    
*   同时，会话建立，RTP数据包（会话）从两端开始流动。
    
*   会话结束后，任何参与者（`lijiatu`，`nuonuo`）都可以发送一个**BYE**请求来终止会话。
    
*   **BYE**直接从`lijiatu`到`nuonuo`绕过代理服务器。
    
*   最后，`nuonuo`发送**200 OK**响应来确认BYE，会话终止。
    
*   在上述基本呼叫流程中，可以使用三个**事务**（标记为1，2，3）。
    

完整的呼叫（从INVITE到200 OK）称为**对话Dialog**。

#### SIP请求与响应

SIP消息有两种类型 - 请求与响应

*   请求的开始行包含**定义请求的方法**及定义要发送**请求的URI**
    
*   同样，响应的开始行包含响应代码
    

方法可以被认为是SIP请求，它们请求由另一用户代理或服务器采取的特定动作。

方法分为两种类型 ： 核心方法 与 扩展方法

##### 六种核心方法

###### Invite 邀请

*   用于启动与用户代理的会话。
    
*   成功的Invite 请求在两个用户代理之间建立对话。
    
*   在已经建立的对话框中发送Invite 被称为 re-invite，re-invite用于更改会话特性或刷新对话框的状态。
    
*   可以在邮件正文中包含主叫方的媒体信息。
    

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085134721-1889778556.png)

示例：

INVITE sips:Bob@TMC.com SIP/2.0   
   Via: SIP/2.0/TLS client.ANC.com:5061;branch = z9hG4bK74bf9   
   Max-Forwards: 70   
   From: Alice<sips:Alice@TTP.com>;tag = 1234567   
   To: Bob<sips:Bob@TMC.com>  
   Call-ID: 12345601@192.168.2.1    
   CSeq: 1 INVITE   
   Contact: <sips:Alice@client.ANC.com>   
   Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY   
   Supported: replaces   
   Content-Type: application/sdp   
   Content-Length: ...    
      v = 0   
   o = Alice 2890844526 2890844526 IN IP4 client.ANC.com   
   s = Session SDP   
   c = IN IP4 client.ANC.com   
   t = 3034423619 0   
   m = audio 49170 RTP/AVP 0   
   a = rtpmap:0 PCMU/8000 

###### Bye 挂断

*   Bye是用于终止既定会话的方法。
    
*   BYE请求通常路由端到端，绕过代理服务器。
    

###### Register 注册

*   REGISTER请求执行用户代理的注册。
    
*   它在正在注册的用户的**To**头中携带`AOR（记录地址）`。
    

###### Cancel 取消

*   CANCEL用于终止未建立的会话。
    
*   CANCEL是**逐跳**请求，即它通过用户代理之间的元素，并接收下一个有状态元素生成的响应。
    

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085148232-214513186.png)

###### ACK 确认

*   ACK用于确认对INVITE方法的最终响应。
    

###### options

*   OPTIONS方法用于向用户代理或代理服务器询问其功能并发现其当前的可用性。
    

##### 八种扩展方法

###### 订阅

*   用户代理使用Subscribe建立订阅，以获取有关特定事件的通知。
    
*   它包含一个**Expires**头字段，指示订阅的持续时间。期限过后，订阅将自动终止。
    
*   订阅在用户代理之间建立一个对话。
    
*   用户可以使用Expires值0（零）发送另一个SUBSCRIBE方法来取消订阅。
    

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085200965-1452850473.png)

###### 通知

*   用户代理使用NOTIFY来获取特定事件的发生。通常，当订户和通知程序之间存在订阅时，NOTIFY将在对话框内触发。
    
*   NOTIFY包含指示事件的**事件**头字段和指示**订阅**的当前状态的`subscriptionstate`头字段。
    
*   始终在订阅的开始和结束时发送NOTIFY。
    

###### 发布

*   PUBLISH被用户代理用于向服务器发送事件状态信息。
    
*   当有多个来源的事件信息时，PUBLISH是非常有用的。
    
*   PUBLISH请求类似于NOTIFY，除了它不在对话框中发送。
    
*   PUBLISH请求必须包含**Expires**头字段和**Min-Expires**头字段。
    

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085217052-1835423949.png)

###### 参考

*   REFER由用户代理用于引用另一个用户代理来访问对话框的URI。
    
*   REFER必须包含**Refer-To**标题。这是REFER的强制标题。
    
*   REFER可以在对话框内部或外部发送。
    
*   A **202 Accepted**将触发REFER请求，指示其他用户代理已经接受引用。
    

###### 信息

*   INFO由用户代理使用，以向其已经建立媒体会话的另一用户代理发送呼叫信令信息。
    
*   这是一个端到端的请求。
    
*   代理将始终转发INFO请求。
    

###### UPDATE

*   如果会话未建立，则UPDATE用于修改会话的状态。用户可以使用UPDATE更改编解码器。
    
*   如果会话建立，则使用重新邀请来更改/更新会话。
    

###### PRACK

*   PRACK用于确认接收到可靠的临时响应转移（1XX）。
    
*   一般来说，PRACK在接收到包含`RSeq可靠序列号`和`supported:100rel` 头的临时响应时由客户端生成。
    
*   PRACK在**race**头部中包含`（RSeq + CSeq）`值。
    
*   PRACK方法适用于所有临时响应，除了100尝试响应，这是永远不可靠的运输。
    
*   PRACK可能包含消息体; 它可以用于提供/答复交换。
    

###### 信息

*   它用于使用SIP发送即时消息。`IM`通常由参与文字会话的参与者实时交换的短消息。
    
*   MESSAGE可以在对话框内或对话框外发送。
    
*   MESSAGE的内容作为**MIME**附件在邮件正文中载入。
    
*   一个**200 OK**被正常接收响应，以指示该消息已在其目的地被递送。
    

![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085231601-1044873729.png)

#### SIP响应码

SIP响应是由用户代理服务器`（UAS）`或SIP服务器生成的用于回复客户端生成的请求的消息。这可能是一个正式的确认，以防止`UAC`转发请求。

*   响应可能包含`UAC`所需的一些额外的信息头字段。
    
*   SIP有六个响应。
    
*   从HTTP中借用`1xx`到`5xx`，在SIP中引入了`6xx`。
    
*   `1xx`被视为**临时**响应，其余的是**最终**响应。
    

S.No.

功能和说明

1

[1xx：临时/信息响应](https://www.tutorialspoint.com/session_initiation_protocol/sip_informational_responses.htm)信息响应用于指示**呼叫进程**。通常回应是端到端（100尝试除外）。

2

[2xx：成功回应](https://www.tutorialspoint.com/session_initiation_protocol/sip_success_responses.htm)这类回应旨在表明请求已被接受。

3

[3xx：重定向响应](https://www.tutorialspoint.com/session_initiation_protocol/sip_redirect_responses.htm)一般来说，这些类响应是由重定向服务器响应INVITE发送的。他们也被称为重定向类响应。

4

[4xx：客户端失败响应](https://www.tutorialspoint.com/session_initiation_protocol/sip_client_failure_responses.htm)客户端错误响应表明，从UAC方面识别出一些错误，无法满足请求。

五

[5xx：服务器故障响应](https://www.tutorialspoint.com/session_initiation_protocol/sip_server_failure_responses.htm)此类响应用于指示由于服务器错误而无法处理该请求。

6

[6xx：全局失效响应](https://www.tutorialspoint.com/session_initiation_protocol/sip_global_failure_responses.htm)此响应类指示服务器知道请求将在尝试的任何地方失败。因此，请求不应发送到其他位置。

#### SIP - header

报头是SIP消息的组成部分，其传达有关消息的信息。它被构造为头序列字段序列。

SIP头字段在大多数情况下遵循与HTTP头字段相同的规则。标头字段定义为**标题：字段**，其中标题用于表示标题字段名称，字段是包含信息的标记集。每个字段由一个字段名，后跟冒号（“：”）和字段值（即**字段名称：字段值**）组成。

#### SIP标题格式

 ![](https://img2022.cnblogs.com/blog/2185233/202211/2185233-20221102085245882-19015365.png)