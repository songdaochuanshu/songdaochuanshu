---
layout: post
title: "ç®€æXDPçš„é‡å®šå‘æœºåˆ¶"
date: "2022-09-04T03:33:10.186Z"
---
ç®€æXDPçš„é‡å®šå‘æœºåˆ¶
===========

*   GreatSQLç¤¾åŒºåŸåˆ›å†…å®¹æœªç»æˆæƒä¸å¾—éšæ„ä½¿ç”¨ï¼Œè½¬è½½è¯·è”ç³»å°ç¼–å¹¶æ³¨æ˜æ¥æºã€‚
*   GreatSQLæ˜¯MySQLçš„å›½äº§åˆ†æ”¯ç‰ˆæœ¬ï¼Œä½¿ç”¨ä¸Šä¸MySQLä¸€è‡´ã€‚

* * *

ä¸€. XDP Socketç¤ºä¾‹è§£æ
-----------------

> æºç å‚è§ï¼š[https://github.com/xdp-project/xdp-tutorial/tree/master/advanced03-AF\_XDP](https://github.com/xdp-project/xdp-tutorial/tree/master/advanced03-AF_XDP)  
> è¯¥ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•é€šè¿‡BPFå°†ç½‘ç»œæ•°æ®åŒ…ä»XDP Hookç‚¹æ—è·¯åˆ°ç”¨æˆ·æ€çš„XDP Socketï¼Œè§£æè¿‡ç¨‹ä¸­ä¸ºçªå‡ºé‡ç‚¹ï¼Œå°†åªå…³æ³¨é‡ç‚¹ä»£ç æ®µï¼Œä¸€äº›å‡½æ•°ä¼šè¢«ç²¾ç®€ï¼Œæ¯”å¦‚ï¼šé”™è¯¯å¤„ç†ç­‰

äºŒ. BPF ç¨‹åº af\_xdp\_kern.c
-------------------------

> BPFç¨‹åºæ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çš„ä¸€æ®µä»£ç ï¼Œå¦‚ä¸‹ï¼š

    struct bpf_map_def SEC("maps") xsks_map = {
        .type = BPF_MAP_TYPE_XSKMAP,
        .key_size = sizeof(int),
        .value_size = sizeof(int),
        .max_entries = 64,  /* Assume netdev has no more than 64 queues */
    };
    
    SEC("xdp_sock")
    int xdp_sock_prog(struct xdp_md *ctx)
    {
        int index = ctx->rx_queue_index;
    
        if (bpf_map_lookup_elem(&xsks_map, &index))
            return bpf_redirect_map(&xsks_map, index, 0);
        
        return XDP_PASS;
    }
    

1.  `struct bpf_map_def SEC("maps") xsks_map`ï¼š å®šä¹‰äº†ä¸€ä¸ª`BPF_MAP_TYPE_XSKMAP`ç±»å‹çš„æ˜ å°„è¡¨ï¼Œå½“é‡‡ç”¨SEC("maps")æ–¹å¼æ¥æ˜¾ç¤ºå®šä¹‰æ—¶ï¼Œå°†åœ¨ç”Ÿæˆçš„bpfç›®æ ‡æ–‡ä»¶çš„ELFæ ¼å¼ä¸­çœ‹åˆ°ç›¸å…³æè¿°ï¼Œå½“BPFç¨‹åºè¢«åŠ è½½åˆ°å†…æ ¸æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºåä¸ºâ€œxsks\_mapâ€çš„æè¿°ç¬¦ï¼Œ ç”¨æˆ·æ€å¯é€šè¿‡æŸ¥æ‰¾â€œxsks\_mapâ€æ¥è·å–è¯¥mapçš„æè¿°ç¬¦ï¼Œè¿™æ ·ç”¨æˆ·æ€å’Œå†…æ ¸BPFç¨‹åºå°±å¯ä»¥å…±åŒè®¿é—®è¯¥map
    
2.  `type = BPF_MAP_TYPE_XSKMAP`ï¼šæŒ‡å®šè¯¥mapçš„ç±»å‹ï¼Œå®ƒä¸bpf\_redirect\_map() ç»“åˆä½¿ç”¨ä»¥å°†æ”¶åˆ°çš„å¸§ä¼ é€’åˆ°æŒ‡å®šå¥—æ¥å­—
    
3.  `key_size = sizeof(int)ï¼Œvalue_size = sizeof(int)`ï¼šæŒ‡å®škeyï¼Œvalueé•¿åº¦
    
4.  é’ˆå¯¹ä»¥ä¸Škeyï¼Œvalueéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼šå¯¹äº`BPF_MAP_TYPE_XSKMAP`ç±»å‹çš„mapï¼Œvalueå¿…é¡»æ˜¯XDP socketæè¿°ç¬¦ï¼Œkeyå¿…é¡»æ˜¯intç±»å‹ï¼ŒåŸå› åœ¨äºbpf\_redirect\_map()çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå‚è§ä¸‹é¢2.10
    
5.  `max_entries = 64`ï¼šæŒ‡å®šmapæœ€å¤šå­˜å‚¨64ä¸ªå…ƒç´ 
    
6.  `SEC("xdp_sock")`ï¼šæŒ‡å®šprogå‡½æ•°ç¬¦å·ï¼Œåº”ç”¨å±‚å¯é€šè¿‡æŸ¥æ‰¾"xdp\_sock"åŠ è½½è¯¥progï¼Œå¹¶ç»‘å®šåˆ°æŒ‡å®šç½‘å¡
    
7.  `int xdp_sock_prog(struct xdp_md *ctx)`ï¼šå½“ç½‘å¡æ”¶åˆ°æ•°æ®åŒ…æ—¶ï¼Œä¼šåœ¨xdp hookç‚¹è°ƒç”¨è¯¥å‡½æ•°
    
8.  `int index = ctx->rx_queue_index`ï¼š è·å–è¯¥æ•°æ®åŒ…æ¥è‡ªç½‘å¡åˆ°å“ªä¸ªrxé˜Ÿåˆ—IDï¼Œctxæœ‰è®¸å¤šæˆå‘˜ï¼Œæ¯”å¦‚ï¼šç½‘å¡IDï¼Œæ•°æ®å¸§ç­‰ç­‰
    
9.  `if (bpf_map_lookup_elem(&xsks_map, &index))`ï¼š åˆ¤æ–­xsks\_mapæ˜¯å¦å­˜åœ¨keyä¸ºindexï¼ˆå³rxé˜Ÿåˆ—å·ï¼‰çš„æ•°æ®ï¼Œæ³¨æ„ï¼Œè¿™é‡Œå®é™…ä¸Šå°±æ˜¯åˆ¤æ–­è¯¥ç½‘å¡æ˜¯å¦ç»‘å®šäº†xdp Socket
    
10.  *   `bpf_redirect_map(&xsks_map, index, 0)`ï¼š`bpf_redirect_map`å‡½æ•°ä½œç”¨å°±æ˜¯é‡å®šå‘ï¼Œæ¯”å¦‚ï¼šå°†æ•°æ®é‡å®šå‘åˆ°æŸä¸ªç½‘å¡ï¼ŒCPUï¼Œ Socketç­‰ç­‰ï¼›å½“`bpf_redirect_map`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„mapç±»å‹ä¸º`BPF_MAP_TYPE_XSKMAP`æ—¶ï¼Œåˆ™è¡¨ç¤ºå°†æ•°æ®é‡å®šå‘åˆ°XDP Scoket
    *   `bpf_redirect_mapï¼ˆï¼‰`ä¼šæŸ¥æ‰¾å‚æ•°1å³xsks\_map ä¸­ keyä¸ºindex çš„ value æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™æ£€æŸ¥valueæ˜¯å¦æ˜¯ä¸€ä¸ªXDP Scoketï¼Œå¹¶ä¸”æ˜¯å¦ç»‘å®šåˆ°äº†è¯¥ç½‘å¡ï¼ˆå¯ä»¥ç»‘å®šåˆ°ä»»æ„æœ‰æ•ˆé˜Ÿåˆ—ï¼‰

**ç»¼åˆä»¥ä¸Šï¼Œè¯¥bpfç¨‹åºå®ç°çš„åŠŸèƒ½å°±æ˜¯ï¼šå°†æ”¶åˆ°çš„æ•°æ®åŒ…é‡å®šå‘åˆ°`xsks_map`ä¸­æŒ‡å®šçš„XDP Socket**

ä¸‰. ç”¨æˆ·æ€ç¨‹åº af\_xdp\_user.c
------------------------

> è¯¥ç¨‹åºå®ç°bpfåŠ è½½åˆ°ç½‘å¡ï¼Œåˆ›å»ºXDP Scoketå¹¶ç»‘å®šåˆ°ç½‘å¡çš„æŒ‡å®šé˜Ÿåˆ—ï¼Œå¹¶é€šè¿‡XDP Scoketæ”¶å‘æ•°æ®ï¼Œè¿™é‡Œä»…åˆ†æxXDP Scoketç›¸å…³éƒ¨åˆ†

    int main(int argc, char **argv)
    {
        ...
        bpf_obj = load_bpf_and_xdp_attach(&cfg);
        map = bpf_object__find_map_by_name(bpf_obj, "xsks_map");
        ...
        xsks_map_fd = bpf_map__fd(map);
        ...
        umem = configure_xsk_umem(packet_buffer, packet_buffer_size);
        ...
        xsk_socket = xsk_configure_socket(&cfg, umem);
        ...
        rx_and_process(&cfg, xsk_socket);
        ...
    }
    
    static struct xsk_socket_info *xsk_configure_socket(struct config *cfg,
                                struct xsk_umem_info *umem)
    {
        ...
        ret = xsk_socket__create(&xsk_info->xsk, cfg->ifname,
                     cfg->xsk_if_queue, umem->umem, &xsk_info->rx,
                     &xsk_info->tx, &xsk_cfg);
        ...
    }
    

*   `bpf_obj = load_bpf_and_xdp_attach(&cfg)`: åŠ è½½bpfç¨‹åºï¼Œå¹¶ç»‘å®šåˆ°ç½‘å¡
*   `map = bpf_object__find_map_by_name(bpf_obj, "xsks_map")`ï¼š æŸ¥æ‰¾bpfç¨‹åºå†…å®šä¹‰çš„xsks\_map
*   `umem = configure_xsk_umem(packet_buffer, packet_buffer_size)`ï¼š ä¸ºXDP Scoketå‡†å¤‡UMEM
*   `xsk_configure_socket()`é€šè¿‡è°ƒç”¨bpf helperå‡½æ•°xsk\_socket\_\_createï¼ˆï¼‰åˆ›å»ºXDP Scoketå¹¶ç»‘å®šåˆ°cfg->ifnameç½‘å¡çš„cfg->xsk\_if\_queueé˜Ÿåˆ—ï¼Œé»˜è®¤æƒ…å†µä¸‹å°†è¯¥ã€cfg->xsk\_if\_queueï¼Œ xsk\_info->xsk fdã€‘æ·»åŠ åˆ°xsks\_map, è¿™æ ·bpfç¨‹åºå°±å¯ä»¥é‡å®šå‘åˆ°è¯¥XDP Scoketï¼ˆå‚è§2.9, 2.10), é™¤éæŒ‡å®šXSK\_LIBBPF\_FLAGS\_\_INHIBIT\_PROG\_LOADæ ‡å¿—

    static void rx_and_process(struct config *cfg,
                   struct xsk_socket_info *xsk_socket)
    {
        struct pollfd fds[2];
        int ret, nfds = 1;
    
        memset(fds, 0, sizeof(fds));
        fds[0].fd = xsk_socket__fd(xsk_socket->xsk);
        fds[0].events = POLLIN;
        
        while(!global_exit) {
            if (cfg->xsk_poll_mode) {
                ret = poll(fds, nfds, -1);
                if (ret <= 0 || ret > 1)
                    continue;
            }
            handle_receive_packets(xsk_socket);
        }
    }
    

*   XDP Scoketä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå› æ­¤å¯ä»¥é€šè¿‡poll/epoll/selectæ¥ç­‰å¾…IOäº‹ä»¶ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼šæ”¶/å‘çš„æ•°æ®åŒ…æ˜¯åŸå§‹çš„ä»¥å¤ªç½‘å¸§ï¼Œå› æ­¤åœ¨åŒ…å¤„ç†ä¸Šè¦éº»çƒ¦ä¸€äº›

å››. æ€»ç»“
-----

*   ä»¥ä¸Šç®€ç•¥åˆ†æäº†bpfç¨‹åºå¦‚ä½•å°†æ•°æ®é‡å®šå‘åˆ°ç”¨æˆ·æ€ç¨‹åºï¼Œé€šè¿‡xsks\_mapæ¥å®ç°bpfä¸ç”¨æˆ·æ€ç¨‹åºçš„äº¤äº’ï¼›
*   éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œè¿™äº›åˆ†æä»…æ˜¯æ¢³ç†äº†æµ…å±‚æ¬¡çš„ä»£ç ï¼Œå®é™…ä¸ŠBPFæ˜¯å¦‚ä½•å°†æ•°æ®è¯»å†™åˆ°XDP Scoketæ”¶å‘ç¼“å†²åŒºçš„å‘¢ï¼Ÿå…¶å®æ˜¯é€šè¿‡åˆ›å»ºå…±äº«å†…å­˜å¹¶å…³è”XDP Scoketçš„rx\_ringï¼Œtx\_ringï¼Œä»¥åŠumemæ¥å®ç°çš„ï¼Œåç»­ç»§ç»­åˆ†æ
*   bpfç¨‹åºé€šå¸¸éƒ½éå¸¸ç®€å•ï¼Œå¤æ‚çš„æ˜¯ç”¨æˆ·æ€ç¨‹åºï¼Œæ­¤å¤–ï¼ŒBPFæœ‰éå¸¸å¤šçš„æŠ€æœ¯ç»†èŠ‚ï¼Œé™äºç¯‡å¹…åŠä¸»é¢˜ä¸åœ¨æ­¤å±•å¼€ã€‚

* * *

Enjoy GreatSQL ğŸ˜ƒ

å…³äº GreatSQL
-----------

GreatSQLæ˜¯ç”±ä¸‡é‡Œæ•°æ®åº“ç»´æŠ¤çš„MySQLåˆ†æ”¯ï¼Œä¸“æ³¨äºæå‡MGRå¯é æ€§åŠæ€§èƒ½ï¼Œæ”¯æŒInnoDBå¹¶è¡ŒæŸ¥è¯¢ç‰¹æ€§ï¼Œæ˜¯é€‚ç”¨äºé‡‘èçº§åº”ç”¨çš„MySQLåˆ†æ”¯ç‰ˆæœ¬ã€‚

ç›¸å…³é“¾æ¥ï¼š [GreatSQLç¤¾åŒº](https://greatsql.cn/) [Gitee](https://gitee.com/GreatSQL/GreatSQL) [GitHub](https://github.com/GreatSQL/GreatSQL) [Bilibili](https://space.bilibili.com/1363850082/favlist)

GreatSQLç¤¾åŒºï¼š
-----------

> æ¬¢è¿æ¥GreatSQLç¤¾åŒºå‘å¸–æé—®  
> [https://greatsql.cn/](https://greatsql.cn/)

![GreatSQLç¤¾åŒº](https://img2022.cnblogs.com/other/2630741/202209/2630741-20220903180605376-830016628.jpg)

æŠ€æœ¯äº¤æµç¾¤ï¼š
------

> å¾®ä¿¡ï¼šæ‰«ç æ·»åŠ `GreatSQLç¤¾åŒºåŠ©æ‰‹`å¾®ä¿¡å¥½å‹ï¼Œå‘é€éªŒè¯ä¿¡æ¯`åŠ ç¾¤`ã€‚

![å›¾ç‰‡](https://img2022.cnblogs.com/other/2630741/202209/2630741-20220903180605784-1064281397.png)