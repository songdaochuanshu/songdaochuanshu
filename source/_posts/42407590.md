---
layout: post
title: "ã€Spring AOPã€‘æš´åŠ›æ‰“é€šä¸¤ä¸ªåˆ‡é¢ä¹‹é—´çš„é€šä¿¡"
date: "2022-03-29T17:19:21.075Z"
---
ã€Spring AOPã€‘æš´åŠ›æ‰“é€šä¸¤ä¸ªåˆ‡é¢ä¹‹é—´çš„é€šä¿¡
=========================

### åœºæ™¯æè¿°

åœ¨ç§’æ€å¾®æœåŠ¡ä¸­ï¼Œç¬”è€…åœ¨éœ€è¦å„ç§æ ¡éªŒå‰ç«¯ä¼ æ¥çš„å‚æ•°åï¼Œé€šè¿‡ Redis åŠ é”é™æµï¼ˆåˆ‡é¢Aï¼‰å¹¶è¿”å›ï¼Œæœ€åå°è£…è®¢å•æ•°æ®æ¨é€åˆ° RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆåˆ‡é¢Bï¼‰åšå–„åå·¥ä½œã€‚

é—®é¢˜ï¼šå¦‚ä½•å°† åˆ‡é¢ A çš„æ•°æ®ä¼ é€’ ç»™åˆ‡é¢B å¤„ç†å‘¢ï¼Ÿ

    /**
     * æ·»åŠ åˆ°ç§’æ€æµç¨‹
     *
     * @param killId ç§’æ€å•†å“ç¼“å­˜é”® sessionId_skuId
     * @param key    éšæœºç  randomCode
     * @param num    æ•°é‡
     * @return {@link R}
     */
    @GetMapping("/kill")
    public R addToSeckill(
            @RequestParam("killId") String killId,
            @RequestParam("key") String key,
            @RequestParam("num") Integer num) {
        // å®ç°ç±»åªæ˜¯å¸¦æœ‰ä¸¤ä¸ªæ³¨è§£æ–¹æ³•ï¼Œè¿”å› nullï¼ˆå› ä¸ºå…¨éƒ¨äº¤ç»™åˆ‡é¢æ‰˜ç®¡äº†ï¼‰
        String orderSn = seckillService.kill(killId, key, num);
        if (StringUtils.isEmpty(orderSn)) {
            return R.error();
        }
        return R.ok().setData(orderSn);
    }
    
    

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡å‚æ•°ä¼ é€’æ•°æ®ï¼Œé€šè¿‡æ•è·å¼‚å¸¸ä¿è¯ä¸šåŠ¡é€»è¾‘ï¼ˆç¦»è°±ä½†æœ‰ç”¨ï¼‰ ğŸ‘

    // å¼ºåˆ¶ä¿®æ”¹å‚æ•°ï¼Œé€šè¿‡å¼‚å¸¸è¿”å›æ­£å¸¸æµç¨‹ï¼Œè€Œé€šè¿‡AOPæ¶ˆæ¯é˜Ÿåˆ—å¤„ç†æ”¶å°¾åŠ¨ä½œ
    try {
        return pjp.proceed(new Object[]{orderTo, null, null});
    } catch (Throwable e) {
        return orderSn;
    }
    

æ³¨æ„äº‹é¡¹ï¼š

1.  å‚æ•°ä¸€è‡´æ€§ï¼šå¿…é¡»ä¼ªé€ å’Œæ–¹æ³•ç­¾åçš„**æ•°é‡ç›¸ç­‰**çš„å‚æ•° â‡’ å¦åˆ™çº¿ç¨‹ä¼šæŠ›å‡ºå¼‚å¸¸ I å°±è¿”å›äº†ï¼Œæ— æ³•æ‰§è¡Œ `pjp.proceed` åŸå§‹æ–¹æ³• â‡’ æ— æ³•è·³è½¬ç¬¬äºŒä¸ªåˆ‡é¢  
    `java.lang.IllegalArgumentException: Expecting 3 arguments to proceed, but was passed 1 arguments`
    
2.  æ•è·å¼‚å¸¸ä¸æŠ›å‡ºï¼Œç›´æ¥æ‰§è¡Œæ­£å¸¸ä¸šåŠ¡é€»è¾‘ â‡’ å¦åˆ™çº¿ç¨‹å°†åæ²¡å¼‚å¸¸ II  
    `cn.miozus.gulimall.common.to.mq.SeckillOrderTo cannot be cast to java.lang.String`
    

3.è™½ç„¶ä¸¤ä¸ªåˆ‡é¢éƒ½è¿”å›äº† `orderSn` ï¼Œå®é™…æœ€ç»ˆåªæœ‰åˆ‡é¢Aä¼ é€’åˆ°äº†æ§åˆ¶å±‚å’Œå‰ç«¯ï¼Œ åˆ‡é¢Bçš„è¿”å›å€¼æˆäº†æ‘†è®¾ã€‚

### è·³è½¬è¿‡ç¨‹

æ‰“æ–­ç‚¹æŸ¥çœ‹ä¸¤ä¸ªåˆ‡é¢çš„è·³è½¬è¿‡ç¨‹ã€‚

åˆ‡é¢Aï¼šå‡†å¤‡è·³è½¬ç¬¬äºŒä¸ªåˆ‡é¢

![åˆ‡é¢Aï¼šå‡†å¤‡è·³è½¬ç¬¬äºŒä¸ªåˆ‡é¢.png](https://img-blog.csdnimg.cn/img_convert/0c33509e867c2f85a7d07203a9f9a621.png)

åˆ‡é¢Bï¼šå‘é€æ¶ˆæ¯å®Œæˆ

![åˆ‡é¢Bï¼šå‘é€æ¶ˆæ¯å®Œæˆ.png](https://img-blog.csdnimg.cn/img_convert/50426d8a2e0de39ae2c9d531b6b668e8.png)

æ‰“å°æ—¥å¿—ï¼Œå¯è§åœºæ™¯éœ€æ±‚ï¼Œå·²ç»æ»¡è¶³äº†ã€‚

    2022-03-29 17:32:56.521  INFO 7904 --- [io-25000-exec-8] c.m.g.s.aspect.SeckillRabbitMqAspect     : å¿«é€Ÿåˆ›å»ºè®¢å•ï¼šå‘é€æ¶ˆæ¯åˆ›å»ºå®Œæˆ: 202203291732444881508738921192005634
    2022-03-29 17:33:01.526  INFO 7904 --- [io-25000-exec-8] c.m.g.s.controller.SeckillController     : ç§’æ€åˆ›å»ºè®¢å•ç”¨æ—¶ï¼š28778
    ğŸŠ seckill orderSn = 202203291732444881508738921192005634
    2022-03-29 17:33:01.527  INFO 7904 --- [nectionFactory5] c.m.g.s.config.RabbitMqSeckillConfig     : ğŸ“¨ æ¶ˆæ¯å·²å‘é€, params: correlationData:null,ack:true,cause:null 
    

### å…¶ä»–æ–¹æ¡ˆ

æœ€ç®€å•çš„åŠæ³•ï¼Œä¸åˆ‡äº†ï¼Œä¸¤ä¸ªåˆ‡é¢è€¦åˆåœ¨ä¸€èµ·ã€‚æ³¨å…¥å’Œè°ƒç”¨æ–¹æ³•ã€‚

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[miozus](https://www.cnblogs.com/miozus/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/miozus/p/16073134.html](https://www.cnblogs.com/miozus/p/16073134.html)