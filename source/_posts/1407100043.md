---
layout: post
title: "CSS SandBox"
date: "2022-06-22T01:55:50.705Z"
---
CSS SandBox
===========

å¼•è¨€
==

æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„æ˜¯å…³äº`CSS Sandbox`çš„ä¸€äº›äº‹æƒ…ï¼Œä¸ºä»€ä¹ˆè¦ä»‹ç»è¿™ä¸ªå‘¢ï¼Ÿåœ¨æˆ‘ä»¬æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Œæ ·å¼é—®é¢˜å…¶å®ä¸€ç›´æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„äº‹æƒ…ï¼Œä¸€æ–¹é¢æˆ‘ä»¬æ ¹æ® UI ç¨¿ä¸æ–­çš„å»è°ƒæ•´ï¼Œå¦ä¸€æ–¹é¢éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤§å¯èƒ½å“ªä¸€æ¬¡å¼€å‘å°±å‘ç°â€”â€”è¯¶ï¼Œæˆ‘çš„æ ·å¼æ€ä¹ˆä¸èµ·ä½œç”¨äº†ï¼Œäº¦æˆ–æ˜¯æ€ä¹ˆè¢«å¦ä¸€ä¸ªæ ·å¼æ‰€è¦†ç›–äº†ã€‚åŸå› å¯èƒ½æœ‰å¾ˆå¤šï¼š

*   ä¸è§„èŒƒçš„å‘½åå¯¼è‡´é‡å¤
*   ä¸ºäº†ç®€å•ï¼Œç›´æ¥æ·»åŠ å…¨å±€æ ·å¼çš„ä¿®æ”¹
*   æ ·å¼çš„ä¸åˆç†å¤ç”¨
*   å¤šä¸ªé¡¹ç›®åˆå¹¶æ—¶ï¼Œæ¯ä¸ªå­é¡¹ç›®éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹æ ·å¼å’Œé…ç½®ï¼Œå¯èƒ½åœ¨è‡ªå·±é¡¹ç›®ä¸­ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œä½†æ˜¯åˆå¹¶ä»¥åäº’ç›¸å½±å“é€ æˆäº†æ ·å¼æ±¡æŸ“
*   ç¬¬ä¸‰æ–¹æ¡†æ¶å¼•å…¥
*   â€¦â€¦

è€Œ`CSS Sandbox`æ­£å¼ä¸ºäº†éš”ç¦»æ ·å¼ï¼Œä»è€Œè§£å†³æ ·å¼æ±¡æŸ“çš„é—®é¢˜

åº”ç”¨åœºæ™¯
====

é€šè¿‡ä¸Šè¿°æˆ‘ä»¬äº†è§£äº†æ ·å¼æ±¡æŸ“äº§ç”Ÿçš„åŸå› ï¼Œä»ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥æ€»ç»“ä¸€ä¸‹å“ªäº›åœºæ™¯æ—¶æˆ‘ä»¬éœ€è¦ä½¿ç”¨`CSS Sandbox`è¿›è¡Œæ ·å¼éš”ç¦»å‘¢

*   å¾®å‰ç«¯åœºæ™¯ä¸‹çš„çˆ¶å­ä»¥åŠå­å­åº”ç”¨
*   å¤§å‹é¡¹ç›®ä»¥åŠå¤æ‚é¡¹ç›®çš„æ ·å¼å†²çª
*   ç¬¬ä¸‰æ–¹æ¡†æ¶ä»¥åŠè‡ªå®šä¹‰ä¸»é¢˜æ ·å¼çš„è¦†ç›–
*   â€¦â€¦

å¸¸è§çš„è§£å†³æ–¹æ¡ˆ
=======

æ—¢ç„¶è¯´äº†è¿™ä¹ˆå¤šæ ·å¼æ±¡æŸ“äº§ç”Ÿçš„åŸå› å’Œåº”ç”¨åœºæ™¯ï¼Œé‚£æˆ‘ä»¬è¯¥å¦‚ä½•è§£å†³ä»–ä»¬å‘¢ï¼Œç›®å‰æœ‰ä»¥ä¸‹å‡ ç§è§£å†³æ–¹æ¡ˆï¼Œå…¶å®è§£å†³çš„æ ¸å¿ƒè¿˜æ˜¯ä¸å˜çš„â€”â€”`ä½¿CSSé€‰æ‹©å™¨ä½œç”¨çš„Domå…ƒç´ å”¯ä¸€`

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094909788-815826510.png)

Tipsï¼šå½“æˆ‘ä»¬åœ¨å®é™…çš„å¼€å‘ä¸­å¯ä»¥æ ¹æ®é¡¹ç›®çš„å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©

CSS in JS
---------

çœ‹åå­—æ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆé«˜çº§ï¼Œç›´è¯‘ä¸‹å°±æ˜¯ç”¨ JS å»å†™ CSS æ ·å¼ï¼Œè€Œä¸æ˜¯å†™åœ¨å•ç‹¬çš„æ ·å¼æ–‡ä»¶é‡Œã€‚ä¾‹å¦‚ï¼š

    <p style='color:red'>css in js</p>
    

è¿™å’Œæˆ‘ä»¬ä¼ ç»Ÿçš„å¼€å‘æ€æƒ³å¾ˆä¸ä¸€æ ·ï¼Œä¼ ç»Ÿçš„å¼€å‘åŸåˆ™æ˜¯`å…³æ³¨ç‚¹åˆ†ç¦»`ï¼Œå°±æ¯”å¦‚æˆ‘ä»¬å¸¸è¯´çš„ä¸å†™`è¡Œå†…æ ·å¼`ã€`è¡Œå†…è„šæœ¬`ï¼Œå³ HTMLã€JSã€CSS éƒ½å†™åœ¨å¯¹åº”çš„æ–‡ä»¶é‡Œã€‚

å…³äº CSS in JS ä¸æ˜¯ä¸€ä¸ªæ–°å…´çš„æŠ€æœ¯ï¼Œä»–çš„çƒ­åº¦ä¸»è¦å‡ºç°äºä¸€äº› Web æ¡†æ¶çš„å‘å±•ï¼Œæ¯”å¦‚è¯´ï¼šReactï¼Œå®ƒæ‰€æ”¯æŒçš„ jsx è¯­æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­åŒæ—¶å†™ jsã€html å’Œ cssï¼Œå¹¶ä¸”`ç»„ä»¶`å†…éƒ¨ç®¡ç†è‡ªå·±çš„æ ·å¼ã€é€»è¾‘ï¼Œç»„ä»¶åŒ–å¼€å‘çš„æ€æƒ³æ·±å…¥äººå¿ƒã€‚

    const style = {
    	color: 'red'
    }
    
    ReactDOM.render(
      <p style={style}>
         css in js
      </h1>,
      document.getElementById('main')
    );
    

æ¯ä¸ªç»„ä»¶çš„æ ·å¼ç”±è‡ªèº«çš„ style å†³å®šï¼Œä¸ä¾èµ–ä¹Ÿä¸å½±å“å¤–éƒ¨ï¼Œä»è¿™ä¸€ç‚¹æ¥çœ‹ç¡®å®å®ç°äº†æ ·å¼éš”ç¦»çš„æ•ˆæœã€‚

å…³äº`Css in js`çš„åº“ä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚è¯´ï¼š

*   [styled-components](https://styled-components.com/docs)
*   [polished](https://polished.js.org/)
*   Â·Â·Â·Â·Â·Â·

å…¶ä¸­ styled-components ä¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ªé€‰æ‹©å™¨

    import styled from 'styled-components'
    
    function App() {
      const Title = styled.h1`
        font-size: 1.5em;
        text-align: center;
        color: palevioletred;
      `;
    
      return (
        <div>
          <Title>Hello World, this is my first styled component!</Title>
        </div>
      );
    }
    

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | â€¢ æ²¡æœ‰ä½œç”¨åŸŸçš„æ ·å¼æ±¡æŸ“é—®é¢˜ï¼ˆä¸»è¦æŒ‡çš„æ˜¯é€šè¿‡å†™å†…è¡Œæ ·å¼ä»¥åŠç”Ÿæˆå”¯ä¸€çš„ CSS é€‰æ‹©å™¨ï¼‰

â€¢ å‡å°‘äº†æ— ç”¨æ ·å¼çš„å †ç§¯ï¼Œåˆ é™¤ç»„ä»¶å³åˆ é™¤å¯¹åº”çš„æ ·å¼

â€¢ é€šè¿‡å¯¼å‡ºå®šä¹‰çš„æ ·å¼å˜é‡æ–¹ä¾¿è¿›è¡Œå¤ç”¨å’Œé‡æ„ |  
| --- | --- |  
| ç¼ºç‚¹ | â€¢ å†…è”æ ·å¼ä¸æ”¯æŒä¼ªç±»å’Œé€‰æ‹©å™¨ç­‰å†™æ³•  
â€¢ ä»£ç çš„å¯è¯»æ€§æ¯”è¾ƒå·®ï¼Œè¿èƒŒäº†å…³æ³¨ç‚¹åˆ†ç¦»çš„åŸåˆ™

â€¢ è¿è¡Œæ—¶ä¼šæ¶ˆè€—æ€§èƒ½ï¼ŒåŠ¨æ€ç”Ÿæˆ CSSï¼ˆæˆ‘ä»¬åœ¨å†™ CSS æ—¶å…¶å®è¿˜æ˜¯ jsï¼‰

â€¢ ä¸èƒ½ç»“åˆä¸€äº› CSS é¢„å¤„ç†å™¨ï¼Œæ— æ³•è¿›è¡Œé¢„ç¼–è¯‘ |

æ ·å¼çº¦å®š
----

é€šè¿‡çº¦åº”ç”¨çš„å‘½åå‰ç¼€å®ç°ç»Ÿä¸€çš„å¼€å‘å’Œç»´æŠ¤ï¼Œæ¯”å¦‚è¯´ BEM çš„å‘½åæ–¹å¼ï¼Œé€šè¿‡å¯¹å—ã€å…ƒç´ ä»¥åŠä¿®é¥°ç¬¦ä¸‰è€…çš„å‘½åæ¥è§„èŒƒçš„æè¿°ä¸€ä¸ªç»„ä»¶

    .dropdown-menu__item-button--disabled
    

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | â€¢ æ ·å¼éš”ç¦»  
â€¢ è¯­ä¹‰åŒ–å¼ºï¼Œç»„ä»¶å¯è¯»æ€§é«˜ |  
| --- | --- |  
| ç¼ºç‚¹ | â€¢ å‘½åå¤ªé•¿  
â€¢ ä¾èµ–äºå¼€å‘è€…çš„å‘½å |

é¢„å¤„ç†å™¨
----

é€šè¿‡ CSS é¢„å¤„ç†å™¨å¯ä»¥å¤„ç†å¾ˆå¤šç‹¬ç‰¹çš„è¯­æ³•æ ¼å¼ï¼Œæ¯”å¦‚ï¼š

*   å¯åµŒå¥—æ€§

    body {
    	with: 20px;
    	p {
    		color: red;
    	}
    }
    

*   çˆ¶é€‰æ‹©å™¨

    body {
    	with: 20px;
    	&:hover {
    		with: 30px;
    	}
    }
    

*   å±æ€§ç»§æ‰¿

    .dev {
    	width: 200px;
    }
    
    span {
    	.dev
    }
    

é€šè¿‡è¿™äº›ç‰¹æ®Šçš„è¯­æ³•è®© CSS æ›´å®¹æ˜“è§£è¯»å’Œç»´æŠ¤

ä¸€äº›å¸¸è§çš„å¸‚åœºä¸Šçš„é¢„å¤„ç†å™¨

*   Sass
*   Less
*   Stylus
*   PostCss

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | â€¢ å¯è¯»æ€§è¾ƒå¥½ï¼Œæ–¹ä¾¿ç†è§£å’Œç»´æŠ¤ DOM ç»“æ„  
â€¢ åˆ©ç”¨åµŒå¥—ç­‰æ–¹å¼ï¼Œä¹Ÿå¯ä»¥å¤§å¹…åº¦è§£å†³æ ·å¼æ±¡æŸ“çš„é—®é¢˜ |  
| --- | --- |  
| ç¼ºç‚¹ | â€¢éœ€è¦å¢åŠ é¢å¤–çš„åŒ…ï¼Œå€ŸåŠ©ç›¸å…³ç¼–è¯‘å·¥å…· |

Tipsï¼šé€šå¸¸ä¸ç±»ä¼¼äº BEM çš„å‘½åæ–¹å¼ç»“åˆï¼Œå¯ä»¥è¾¾åˆ°æé«˜å¼€å‘æ•ˆç‡ï¼Œå¢å¼ºå¯è¯»æ€§ä»¥åŠå¤ç”¨çš„æ•ˆæœ

CSS Module
----------

é¡¾åæ€ä¹‰å°±æ˜¯å°† CSS è¿›è¡Œæ¨¡å—åŒ–å¤„ç†ï¼Œç¼–è¯‘å¥½åå¯ä»¥é¿å…æ ·å¼è¢«æ±¡æŸ“çš„é—®é¢˜ï¼Œä¸è¿‡ä¾èµ–äº**Webpack**éœ€è¦é…ç½®`css-loader`ç­‰æ‰“åŒ…å·¥å…·ï¼Œä»¥ä¸‹æ˜¯æˆ‘åœ¨`create-react-app`åˆ›å»ºçš„é¡¹ç›®ä¸­è¿è¡Œï¼Œç”±äºå…¶å·²ç»åœ¨ webpack é…ç½®äº†`css-loader`ï¼Œå› æ­¤åœ¨æ­¤ç¯‡æ–‡ç« ä¸­ä¸å±•ç¤ºå…·ä½“é…ç½®

index.ts æ–‡ä»¶

    import style from './style.module.css'
    
    function App() {
    
      return (
        <div>
          <p className={style.text}>Css Module</p>
        </div>
      );
    }
    

style.module.css æ–‡ä»¶

    .text {
      color: red;
    }
    
    // ç­‰åŒäº
    :local(.text) {
        color: blue;
    }
    
    // è¿˜æœ‰ä¸€ç§å…¨å±€æ¨¡å¼ï¼Œæ­¤æ—¶ä¸ä¼šè¿›è¡Œç¼–è¯‘
    :global(.text) {
        color: blue;
    }
    

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094910960-1212084154.png)

æ‰“åŒ…å·¥å…·ä¼šåŒæ—¶æŠŠ style.text ä»¥åŠ text ç¼–è¯‘æˆç‹¬ä¸€æ— äºŒçš„å€¼

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | â€¢ å­¦ä¹ æˆæœ¬è¾ƒä½ï¼Œä¸ä¾èµ–äºäººå·¥çº¦æŸ

â€¢ åŸºæœ¬ä¸Šèƒ½ 100%è§£å†³æ ·å¼æ±¡æŸ“é—®é¢˜

â€¢ æ–¹ä¾¿å®ç°æ¨¡å—çš„å¤ç”¨ |  
| --- | --- |  
| ç¼ºç‚¹ | â€¢ åªèƒ½åœ¨æ„å»ºæ—¶ä½¿ç”¨ï¼Œä¾èµ–äº css-loader ç­‰

â€¢ å¯è¯»æ€§å·®ï¼Œåœ¨æ§åˆ¶å°è°ƒè¯•æ—¶å‡ºç° hash å€¼ä¸æ–¹ä¾¿è°ƒè¯• |

Shadow DOM
----------

å®ƒå¯ä»¥å°†ä¸€ä¸ªéšè—ä¸”ç‹¬ç«‹çš„ DOM é™„åŠ åˆ°ä¸€ä¸ªå…ƒç´ ä¸Šã€‚å½“æˆ‘ä»¬ç”¨ Shadow DOM åŒ…è£¹ä¸€ä¸ªå…ƒç´ åï¼Œå…¶å†…æ ·å¼ä¸ä¼šå¯¹å¤–éƒ¨æ ·å¼é€ æˆå½±å“ï¼Œå¤–éƒ¨æ ·å¼ä¹Ÿä¸ä¼šå¯¹å…¶å†…éƒ¨é€ æˆå½±å“

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094911572-1514578251.png)

    // åˆ›å»ºä¸€ä¸ªshadow domï¼Œæˆ‘è¿™é‡Œæ˜¯é€šè¿‡refå»æ‹¿é™„ç€çš„èŠ‚ç‚¹ï¼Œä¸€èˆ¬å¯ä»¥ç”¨documentå»æ‹¿
    import './App.css'; // å®šä¹‰äº†shadow-textçš„æ ·å¼
    
    function App() {
      const divRef = useRef(null)
    
      useEffect(() => {
        if(divRef?.current) {
          const { current } = divRef
          const shadow = current.attachShadow({mode: 'open'}); // modeç”¨æ¥æ§åˆ¶èƒ½å¦ç”¨jsè·å–shaow domå†…çš„å…ƒç´ 
          shadow.innerHTML = '<p className="shadow-text">Here is some new text</p>';
        }
      }, [])
    
      return (
        <div>
          <div ref={divRef} className='shadow-host'></div>
        </div>
      );
    }
    

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094912051-1764214547.png)

å¤–éƒ¨æ ·å¼æ— æ³•å½±å“ shadow dom å†…éƒ¨çš„æ ·å¼

æˆ‘ä»¬å†æ¥çœ‹ä¸‹ shadow dom å†…éƒ¨å¾—æ ·å¼ä¼šå½±å“å¤–éƒ¨æ ·å¼å—ï¼Ÿ

    function App() {
      useEffect(() => {
        if(divRef?.current) {
          const { current } = divRef
          const shadow = current.attachShadow({mode: 'open'});
          shadow.innerHTML = '<style>.shadow-h1 { color: red } </style><p class="shadow-h1">Here is some new text</p>';
          
        }
      }, [])
    
      return (
        <div>
          <Title>Hello World, this is my first styled component!</Title>
          <h1 className='shadow-h1'>lalla1</h1>
          <div ref={divRef} className='shadow-host'></div>
        </div>
      );
    }
    

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094913174-851561476.png)

ä½†æ˜¯ä¹Ÿæœ‰ä¾‹å¤–ï¼Œé™¤äº†`[:focus-within](https://developer.mozilla.org/zh-CN/docs/Web/CSS/:focus-within)`

    import { useEffect, useRef } from 'react'
    import './App.css'; // .shadow-host:focus-within { background-color: yellow;}
    
    function ShadowExample() {
      const divRef = useRef(null)
    
      useEffect(() => {
        if(divRef?.current) {
          const { current } = divRef
          const shadow = current.attachShadow({mode: 'open'});
          shadow.innerHTML = '<input class="shadow-h1"/>';
          
        }
      }, [])
    
      return (
        <div>
          <p>Css Module</p>
          <div ref={divRef} className='shadow-host'></div>
        </div>
      );
    }
    
    export default ShadowExample;
    

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094913586-378751128.png)

### é—®é¢˜

æ­£ç”±äº`shadow dom`å†…çš„æ ·å¼åªä¼šåº”ç”¨äºå†…éƒ¨ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ shadow dom å†…éƒ¨ç”¨äº†ç±»ä¼¼äº`antd`çš„`Modal`è¿™äº›åˆ›å»ºäº`document.body`ä¸‹çš„å¼¹çª—æˆ–è€…å…¶ä»–ç»„ä»¶æ—¶ï¼Œæ— æ³•åº”ç”¨äº`antd`çš„æ ·å¼ï¼Œéœ€è¦æŠŠ`antd`çš„æ ·å¼æ”¾åˆ°ä¸Šä¸€å±‚ä¸­ã€‚

### ä¼˜ç¼ºç‚¹

| ä¼˜ç‚¹ | â€¢ ä¸éœ€è¦å¼•å…¥é¢å¤–çš„åŒ…ï¼Œæµè§ˆå™¨åŸç”Ÿæ”¯æŒ

â€¢ ä¸¥æ ¼éš”ç¦» |  
| --- | --- |  
| ç¼ºç‚¹ | â€¢ åœ¨æŸäº›åœºæ™¯ä¸‹å¯èƒ½å‡ºç°æ ·å¼å¤±æ•ˆçš„é—®é¢˜ï¼Œå¦‚ä¸Šé—®é¢˜ä¸­çš„ shadow dom å†…åˆ›å»ºäº†å…¨å±€çš„ Modal |

æµ…æ QianKun ä¸­çš„ CSS SandBox
=========================

ä¸Šé¢æˆ‘ä»¬è®²è§£äº†ä¸€äº›å®ç°æ ·å¼éš”ç¦»çš„åŸºæœ¬æ–¹æ¡ˆï¼Œé‚£ä½œä¸ºä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„å¾®å‰ç«¯æ¡†æ¶`QianKun`ä¸­åˆæ˜¯æ€ä¹ˆå®ç°æ ·å¼éš”ç¦»æ–¹æ¡ˆçš„å‘¢ï¼Œä»¥ä¸‹çš„æºç è§£ææ˜¯åœ¨`v2.6.3`çš„ç‰ˆæœ¬ä¸Šç ”ç©¶çš„ï¼Œé¦–å…ˆé€šè¿‡çœ‹æ–‡æ¡£å¯ä»¥å‘ç°

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094913839-1580269182.png)

åœ¨ QianKun ä¸­ CSS SandBox æœ‰ä¸¤ç§æ¨¡å¼ï¼š

*   `strictStyleIsolation`â€”â€”ä¸¥æ ¼æ²™ç®±æ¨¡å¼
*   `experimentalStyleIsolation`â€”â€”å®éªŒæ€§æ²™ç®±æ¨¡å¼

strictStyleIsolation
--------------------

> éœ€è¦æ³¨æ„çš„æ˜¯è¯¥æ–¹æ¡ˆä¸æ˜¯ä¸€ä¸ªæ— è„‘çš„è§£å†³æ–¹æ¡ˆï¼Œå¼€å¯åéœ€è¦è¿›è¡Œä¸€å®šçš„é€‚é…

ä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸‹è¯¥æ¨¡å¼ï¼š

æˆ‘ä»¬è®¾ç½®`strictStyleIsolation`ä¸º`true`æ—¶ï¼Œ`QianKun`é‡‡ç”¨çš„æ˜¯`Shadow DOM`æ–¹æ¡ˆï¼Œæ ¸å¿ƒå°±æ˜¯ä¸ºæ¯ä¸ªå¾®åº”ç”¨åŒ…è£¹ä¸Šä¸€ä¸ª Shadow DOM èŠ‚ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹æ˜¯æ€ä¹ˆå®ç°çš„

å…ˆæ¥ä¸ªæµç¨‹å›¾æˆ‘ä»¬æœ‰ä¸ªå¤§è‡´çš„æ¦‚å¿µï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094914286-1043833982.png)

*   `**registerMicroApps**`**ï¼šæ³¨å†Œå­åº”ç”¨ï¼ŒåŒæ—¶è°ƒç”¨ single-spa ä¸­çš„**`registerApplication`**è¿›è¡Œæ³¨å†Œ**
*   `**loadApp**`ï¼šåŠ è½½å­åº”ç”¨ï¼Œåˆå§‹åŒ–åŠ è½½å­åº”ç”¨çš„ Dom ç»“æ„ï¼Œåˆ›å»ºæ ·å¼æ²™ç®±å’Œ JS æ²™ç®±ç­‰ï¼ŒåŒæ—¶è¿”å›ä¸åŒé˜¶æ®µçš„ç”Ÿå‘½å‘¨æœŸ
*   `**createElement**`ï¼šæ ·å¼æ²™ç®±çš„å…·ä½“å®ç°ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§`strictStyleIsolation`å’Œ`experimentalStyleIsolation`

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094914924-1597481662.png)

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094915304-1146902508.png)

### registerMicroAppsï¼šæ³¨å†Œå­åº”ç”¨

    export function registerMicroApps<T extends ObjectType>(apps: Array<RegistrableApp<T>>,lifeCycles?: FrameworkLifeCycles<T>,) {
    ...
        registerApplication({
          name,
          app: async () => {
            ...
            // åŠ è½½å¾®åº”ç”¨çš„å…·ä½“æ–¹æ³•ï¼Œæš´éœ²bootstrapã€mountã€unmountç­‰ç”Ÿå‘½å‘¨æœŸä»¥åŠä¸€äº›å…¶ä»–é…ç½®ä¿¡æ¯
            const { mount, ...otherMicroAppConfigs } = (
              await loadApp({ name, props, ...appConfig }, frameworkConfiguration, lifeCycles)
            )();
    				...
          },
          // å­åº”ç”¨çš„æ¿€æ´»æ¡ä»¶
          activeWhen: activeRule
    			...
        });
      });
    }
    

è°ƒç”¨ single-spa çš„ registerApplication å¯¹åº”ç”¨è¿›è¡Œæ³¨å†Œï¼Œå¹¶ä¸”åœ¨åº”ç”¨æ¿€æ´»çš„æ—¶å€™è°ƒç”¨ app çš„å›è°ƒï¼Œå…¶ä¸­æœ€ä¸»è¦çš„æ˜¯`loadApp`åŠ è½½å¾®åº”ç”¨çš„å…·ä½“æ–¹æ³•

ä¸€äº›å‚æ•°çš„è¯´æ˜ï¼š

*   `apps`ï¼šå¾®åº”ç”¨çš„æ³¨å†Œä¿¡æ¯

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094915636-1917641262.png)

*   `lifeCycles`ï¼šå¾®åº”ç”¨çš„ä¸€äº›ç”Ÿå‘½å‘¨æœŸé’©å­

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094915863-2021391508.png)

### loadAppï¼šåŠ è½½å­åº”ç”¨

    function loadApp (app: LoadableApp<T>, configuration: FrameworkConfiguration = {},lifeCycles?: FrameworkLifeCycles<T>) {
    ...
    /**
     * å°†æ“ä½œæƒäº¤ç»™ä¸»åº”ç”¨æ§åˆ¶ï¼Œè¿”å›ç»“æœæ¶‰åŠCSS SandBoxå’ŒJS SandBox
     * template --templateçš„ä¸ºlinkæ›¿æ¢ä¸ºstyleæ³¨é‡Šscriptçš„HTMLæ¨¡ç‰ˆ
     * execScripts --è„šæœ¬æ‰§è¡Œå™¨ï¼Œè®©æŒ‡å®šçš„è„šæœ¬(scripts)åœ¨è§„å®šçš„ä¸Šä¸‹æ–‡ç¯å¢ƒä¸­æ‰§è¡Œï¼Œåªåšäº†è§£æš‚æ—¶ä¸è®²
     * assetPublicPath -- é™æ€èµ„æºåœ°å€ï¼Œåªåšäº†è§£æš‚æ—¶ä¸è®²
     */
    const { template, execScripts, assetPublicPath } = await importEntry(entry, importEntryOpts);
    
    // ç»™å­åº”ç”¨åŒ…è£¹ä¸€å±‚divåçš„å­åº”ç”¨htmlæ¨¡ç‰ˆ, æ˜¯æ¨¡ç‰ˆå­—ç¬¦ä¸²çš„å½¢å¼
    const appContent = getDefaultTplWrapper(appInstanceId)(template);
    
    let initialAppWrapperElement: HTMLElement | null = createElement(
        appContent,
    		// æ˜¯å¦å¼€å¯äº†ä¸¥æ ¼æ¨¡å¼
        strictStyleIsolation,
    		// æ˜¯å¦å¼€å¯å®éªŒæ€§çš„æ ·å¼éš”ç¦»
        scopedCSS,
    		// æ ¹æ®åº”ç”¨åç”Ÿæˆçš„å”¯ä¸€å€¼ï¼Œå”¯ä¸€åˆ™ä¸ºappNameï¼Œä¸å”¯ä¸€åˆ™ä¸ºappName_[count]ä¸ºå…·ä½“æ•°é‡ï¼Œé‡å¤ä¼šcount++
        appInstanceId,
      );
    ...
    // ä¸‹é¢è¿˜æœ‰ä¸€äº›ç”Ÿå‘½å‘¨æœŸçš„å¤„ç†æ–¹æ³•
    }
    

Q1ï¼šåˆ°ç°åœ¨ä¸çŸ¥é“è¿˜æœ‰æ²¡æœ‰äººè®°å¾—æˆ‘ä»¬å¼€å¯ä¸¥æ ¼æ ·å¼æ¨¡å¼æ˜¯éœ€è¦åšå•¥ï¼Ÿ

ï¼ï¼ï¼æŠŠå­åº”ç”¨çš„ Dom ç»“æ„æ”¾åˆ° Shadow dom ä¸­ä¸ä¸»åº”ç”¨éš”ç¦»ï¼Œé˜²æ­¢æ ·å¼æ±¡æŸ“

Q2ï¼šé‚£æˆ‘ä»¬å’‹æ‹¿åˆ°å­åº”ç”¨çš„ Dom ç»“æ„å‘¢ï¼Ÿ

æ²¡é”™å°±æ˜¯é€šè¿‡`import-html-entry`åº“çš„`import-html-entry`æ–¹æ³•ï¼Œæœ‰å…´è¶£ç»™çœ‹ä¸‹å…³äº[import-html-entry è§£æ](https://juejin.cn/post/6885212507837825038)

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094916217-1584430945.png)

æ²¡é”™æˆ‘ä»¬æ‹¿åˆ°äº†`template`ã€`execScripts`å’Œ`assetPublicPath`ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸å¯¹åä¸¤ä¸ªè¿›è¡Œè®²è§£ï¼Œèšç„¦åˆ°`template`ä¸Šï¼š

å¯¹æ¯”ä¸‹å­åº”ç”¨åŸæ¥çš„ HTML ç»“æ„

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094916624-607471083.png)

å¯ä»¥å‘ç°æˆ‘ä»¬æ‹¿åˆ°çš„`template`æ˜¯`link`æ ‡ç­¾å˜æˆ`style`æ ‡ç­¾æ³¨é‡Šäº†`script`çš„ HTML æ¨¡ç‰ˆï¼Œå…¶ä¸­å°±æœ‰æˆ‘ä»¬éœ€è¦çš„å­åº”ç”¨çš„ Dom ç»“æ„ã€‚

æ‹¿åˆ°ä»¥å QianKun é‡Œåˆåœ¨`template`ä¸ŠåŒ…è£¹äº†ä¸€å±‚ Div å½¢æˆä¸€ä¸ªæ–°çš„ HTML ç»“æ„çš„æ¨¡ç‰ˆå­—ç¬¦ä¸²ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸»åº”ç”¨ä¸­æ ‡è¯†è¯¥èŠ‚ç‚¹ä¸‹çš„å†…å®¹ä¸ºå­åº”ç”¨ï¼Œå½“ç„¶åœ¨åé¢æˆ‘ä»¬ä¹Ÿéœ€è¦å®ƒè¿›è¡Œç‰¹åˆ«çš„å¤„ç†ï¼Œè¿™ä¸ªåé¢è®²åˆ°çš„æ—¶å€™å†è¯´ã€‚å› æ­¤æˆ‘ä»¬ç°åœ¨æ‹¿åˆ°çš„`appContent`é•¿æˆè¿™ä¸ªæ ·å­ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094917095-627616545.png)

è¿™ä¸ª div çš„ id æ˜¯å”¯ä¸€çš„å“ˆï¼ï¼ï¼

é‚£æˆ‘ä»¬ç°åœ¨æ˜¯ä¸æ˜¯å·²ç»åšå¥½äº†å‰æœŸå‡†å¤‡ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è¿›å…¥æœ€åä¸€ä¸ªæ­¥éª¤ï¼ŒæŠŠå­åº”ç”¨çš„è¿™ä¸ª Dom ç»“æ„æŒ‚è½½åˆ°ä¸€ä¸ª shadow dom ä¸Šï¼Œè¿™å°±è¦ç”¨åˆ°`createElement`æ–¹æ³•ã€‚

è¿›å…¥`createElement`æ–¹æ³•å‰æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ç›®å‰çš„å‚æ•°å€¼ï¼š

*   appContentï¼šåŒ…è£¹äº†ä¸€å±‚ id å”¯ä¸€çš„ divï¼Œå…·ä½“å¦‚ä¸Šæ‰€ç¤º
*   strictStyleIsolationï¼š`true`
*   scopedCSSï¼š`false`
*   appInstanceIdï¼š`react16`

### createElementï¼šæ·»åŠ  shadow dom

é‚£æˆ‘ä»¬ç°åœ¨å¦‚ä½•å»åˆ›å»ºä¸€ä¸ª shadow domï¼Œåœ¨å‰é¢å…³äº shadow dom çš„è®²è§£ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºä¸€ä¸ª shadow dom æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªä¸œè¥¿ï¼š

ä¸€ã€æŒ‚è½½çš„ Dom èŠ‚ç‚¹

äºŒã€éœ€è¦æ·»åŠ åˆ° shadow dom çš„å†…å®¹

é‚£æˆ‘ä»¬ä»å“ªé‡Œå»æ‰¾å‘¢ï¼Œæ ¹æ®ä¼ è¿›æ¥çš„å‚æ•°å§ï¼Œæˆ‘ä»¬æ— ç–‘æ˜¯è¦å¯¹`appContent`è¿›è¡Œå¤„ç†äº†ï¼Œå›é¡¾ä¸‹`appContent`æœ‰ä»€ä¹ˆï¼ŒåŒ…è£¹äº†ä¸€å±‚ div çš„å­åº”ç”¨çš„ HTML æ¨¡ç‰ˆæ˜¯å§ï¼Œè‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬å°±å¯ä»¥ä»¥å¤–é¢çš„ div ä¸ºæŒ‚è½½çš„ dom èŠ‚ç‚¹ï¼Œæ‹¿å­åº”ç”¨çš„ HTML æ¨¡ç‰ˆä¸ºéœ€è¦æ·»åŠ åˆ° shadow dom çš„å†…å®¹ï¼Œå³ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094917402-1199462959.png)

ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œ ç›®å‰çš„`appContent`æ˜¯æ¨¡ç‰ˆå­—ç¬¦ä¸²å˜ï¼Œæˆ‘ä»¬å’‹åŠï¼Ÿè¿™è¾¹ QianKun çš„å¤„ç†æ–¹æ¡ˆæ˜¯ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094917816-1214560128.png)

è¿™åªæ˜¯ä¸ªå¤§è‡´æµç¨‹ï¼Œä¸‹é¢è®©æˆ‘ä»¬è·Ÿç€è¿™æ ·çš„æ€æƒ³çœ‹ä¸‹ä»£ç é‡Œå¤„ç†ï¼š

    function createElement(appContent: string,strictStyleIsolation: boolean,scopedCSS: boolean,appInstanceId: string) {
    ...
    const containerElement = document.createElement('div');
      containerElement.innerHTML = appContent;
      const appElement = containerElement.firstChild as HTMLElement;
    	// ä¸¥æ ¼æ ·å¼æ²™ç®±æ¨¡å¼
      if (strictStyleIsolation) {
        if (!supportShadowDOM) {
          console.warn(
            '[qiankun]: As current browser not support shadow dom, your strictStyleIsolation configuration will be ignored!',
          );
        } else {
          const { innerHTML } = appElement;
          appElement.innerHTML = '';
          let shadow: ShadowRoot;
    
    			// åˆ›å»ºshadow domèŠ‚ç‚¹
          if (appElement.attachShadow) {
            shadow = appElement.attachShadow({ mode: 'open' });
          } else {
            // å…¼å®¹ä½ç‰ˆæœ¬
            shadow = (appElement as any).createShadowRoot();
          }
          shadow.innerHTML = innerHTML;
        }
      }
    ...
    // æ­¤å¤„çœç•¥äº†å¼€å¯experimentalStyleIsolationçš„å¤„ç†æ–¹æ³•
    ...
    return appElement;
    }
    

è¿™é‡Œæœ‰ä¸ªå¾ˆæœ‰æ„æ€çš„æ˜¯ï¼š

appContent ä»¥ innerHTML å˜æˆ dom ç»“æ„åï¼ŒHTML æ¨¡ç‰ˆä¸­çš„`<html>`ã€`<head>`ä»¥åŠ`<body>`ä¼šè¢«å»æ‰

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094918455-1440876797.png)

æœ€åæˆ‘ä»¬å†æ¥çœ‹ä¸‹å­åº”ç”¨æŒ‚è½½åˆ°ä¸»åº”ç”¨çš„ Dom ç»“æ„ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094918828-1631374061.png)

ç¬”è€…åœ¨å®è·µçš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼š

1ã€å¾®åº”ç”¨ä¸­ä½¿ç”¨ç›¸å¯¹è·¯å¾„å¼•å…¥å›¾ç‰‡å‡ºç°åŠ è½½èµ„æº 404 çš„é—®é¢˜ï¼Œè¿™è¾¹ç¬”è€…æ²¡æœ‰è¿›è¡Œè¿‡å¤šçš„å°è¯•å¯ä»¥å‚è€ƒä¸‹å®˜æ–¹çš„ï¼š[https://qiankun.umijs.org/zh/faq#ä¸ºä»€ä¹ˆå¾®åº”ç”¨åŠ è½½çš„èµ„æºä¼š-404](https://qiankun.umijs.org/zh/faq#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%BE%AE%E5%BA%94%E7%94%A8%E5%8A%A0%E8%BD%BD%E7%9A%84%E8%B5%84%E6%BA%90%E4%BC%9A-404)

2ã€è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ react ä¸­åŠ¨æ€æ‰“å¼€ Modal å¤±æ•ˆçš„é—®é¢˜ï¼ŒåŸå› å¯ä»¥çœ‹ä¸‹â€£ï¼Œå¤§æ¦‚çœ‹äº†ä¸‹å’Œ React çš„äº‹ä»¶æœºåˆ¶æœ‰å…³ï¼Œå³ä½¿æ˜¯è®¾ç½®å¼¹çª—é»˜è®¤å¼€å¯ï¼Œä¹Ÿä¼šå‡ºç°ä¹‹å‰ä¸Šé¢æåˆ°çš„ï¼Œæ ·å¼ä¸¢å¤±çš„é—®é¢˜

experimentalStyleIsolation
--------------------------

æˆ‘ä»¬è®¾ç½®`experimentalStyleIsolation`ä¸º`true`æ—¶ï¼Œ`QianKun`é‡‡ç”¨çš„æ˜¯`Runtime css transformer` åŠ¨æ€åŠ è½½/å¸è½½æ ·å¼è¡¨æ–¹æ¡ˆï¼Œä¸ºå­åº”ç”¨çš„æ ·å¼è¡¨å¢åŠ ä¸€ä¸ªç‰¹æ®Šçš„é€‰æ‹©å™¨ä»è€Œé™å®šå½±å“èŒƒå›´ï¼Œç±»ä¼¼ä»¥ä¸‹ç»“æ„ï¼š

    // å‡è®¾åº”ç”¨åæ˜¯ react16
    <style>
    	.app-main {
    	  font-size: 14px;
    	}
    </style>
    
    <style>
    	div[data-qiankun="react16"] .app-main {
    	  font-size: 14px;
    	}
    <style>
    

å…ˆæ¥é€šè¿‡æµç¨‹å›¾äº†è§£ä¸‹å¤§è‡´æµç¨‹

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094919377-208392907.png)

### createElementï¼šç»™æœ€å¤–å±‚å¢åŠ  data-qiankun å±æ€§ï¼Œå¹¶ä¸”è·å–æ‰€æœ‰ style æ ‡ç­¾

    function createElement(appContent: string, strictStyleIsolation: boolean, scopedCSS: boolean,appInstanceId: string) {
    ...
    if (scopedCSS) {
    		// ç»™æœ€å¤–å±‚è®¾ç½®data-qiankunçš„å±æ€§
        const attr = appElement.getAttribute(css.QiankunCSSRewriteAttr);
        if (!attr) {
          appElement.setAttribute(css.QiankunCSSRewriteAttr, appInstanceId);
        }
    		// è·å–æ‰€æœ‰çš„styleæ ‡ç­¾,è¿›è¡Œéå†
        const styleNodes = appElement.querySelectorAll('style') || [];
        forEach(styleNodes, (stylesheetElement: HTMLStyleElement) => {
          css.process(appElement!, stylesheetElement, appInstanceId);
        });
      }
    ...
    }
    
    export const QiankunCSSRewriteAttr = 'data-qiankun';
    

æˆ‘ä»¬æ¥çœ‹ä¸‹è®¾ç½®å®Œå±æ€§åçš„å±æ€§åçš„ appElement

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094919994-2075611116.png)

styleNodes

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094920241-678423043.png)

### css.process è¯¦ç»†å¤„ç†

    /**
    * å®ä¾‹åŒ–ScopedCSS
    * ç”Ÿæˆæ ¹å…ƒç´ å±æ€§é€‰æ‹©å™¨[data-qiankun="åº”ç”¨å"]å‰ç¼€
    */
    export const process = (
      appWrapper: HTMLElement,
      stylesheetElement: HTMLStyleElement | HTMLLinkElement,
      appName: string,
    ): void => {
      // å®ä¾‹åŒ–ScopedCSS
      if (!processor) {
        processor = new ScopedCSS();
      }
    	...
    	// ä¸€äº›ç©ºå€¼çš„å¤„ç†
      const mountDOM = appWrapper;
      if (!mountDOM) {
        return;
      }
    
      const tag = (mountDOM.tagName || '').toLowerCase();
    
      if (tag && stylesheetElement.tagName === 'STYLE') {
    		// ç”Ÿæˆå‰ç¼€ï¼Œæ ¹å…ƒç´ æ ‡ç­¾å[data-qiankun="åº”ç”¨å"]
        const prefix = `${tag}[${QiankunCSSRewriteAttr}="${appName}"]`;
        processor.process(stylesheetElement, prefix);
      }
    };
    

*   prefixï¼š  
    `div[data-qiankun="react16"]`
*   stylesheetElementï¼š

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094920448-386312089.png)

### è¿›å…¥ processor.process çœ‹çœ‹å¯¹å®ƒè¿›è¡Œäº†ä»€ä¹ˆæ“ä½œ

    // é‡å†™æ ·å¼é€‰æ‹©å™¨ä»¥åŠå¯¹äºç©ºçš„styleèŠ‚ç‚¹è®¾ç½®MutationObserverç›‘å¬ï¼ŒåŸå› å¯èƒ½å­˜åœ¨åŠ¨æ€å¢åŠ æ ·å¼çš„æƒ…å†µ
    process(styleNode: HTMLStyleElement, prefix: string = '') {
    		// å½“styleæ ‡ç­¾æœ‰å†…å®¹æ—¶è¿›è¡Œæ“ä½œ
        if (styleNode.textContent !== '') {
    			// styleNode.textContentä¸ºstyleæ ‡ç­¾å†…çš„å†…å®¹
          const textNode = document.createTextNode(styleNode.textContent || '');
    			// swapNodeä¸ºåˆ›å»ºçš„ç©ºçš„styleæ ‡ç­¾
          this.swapNode.appendChild(textNode);
    			// è·å–æ ·å¼è¡¨
          const sheet = this.swapNode.sheet as any;
    			// ä»æ ·å¼è¡¨è·å–cssRulesè¯¥å€¼æ˜¯æ ‡å‡†çš„ï¼ŒæŠŠæ ·å¼è§„åˆ™ä»ä¼ªæ•°ç»„è½¬åŒ–æˆæ•°ç»„
          const rules = arrayify<CSSRule>(sheet?.cssRules ?? []);
    			// é€šè¿‡éå†å’Œæ­£åˆ™é‡å†™æ¯ä¸ªé€‰æ‹©å™¨çš„å‰ç¼€
          const css = this.rewrite(rules, prefix);
    			// å°†å¤„ç†åçš„é‡å†™åçš„cssæ”¾å…¥åŸæ¥çš„styleNodeä¸­
          styleNode.textContent = css;
          // æ¸…ç†å·¥å…·äººswapNode
          this.swapNode.removeChild(textNode);
          return;
        }
    
    		//å¯¹ç©ºçš„æ ·å¼èŠ‚ç‚¹è¿›è¡Œç›‘å¬ï¼Œå¯èƒ½å­˜åœ¨åŠ¨æ€æ’å…¥çš„é—®é¢˜
        const mutator = new MutationObserver((mutations) => {
          for (let i = 0; i < mutations.length; i += 1) {
    				// mutationä¸ºå˜æ›´çš„æ¯ä¸ªè®°å½•MutationRecord
            const mutation = mutations[i];
    
    				// åˆ¤æ–­è¯¥èŠ‚ç‚¹æ˜¯å¦åº”å¤„ç†è¿‡
            if (ScopedCSS.ModifiedTag in styleNode) {
              return;
            }
    
            if (mutation.type === 'childList') {
              const sheet = styleNode.sheet as any;
              const rules = arrayify<CSSRule>(sheet?.cssRules ?? []);
              const css = this.rewrite(rules, prefix);
    
              styleNode.textContent = css;
              // å¢åŠ å¤„ç†èŠ‚ç‚¹çš„æ ‡è¯†
              (styleNode as any)[ScopedCSS.ModifiedTag] = true;
            }
          }
        });
    
        // ç›‘å¬å½“å‰çš„styleæ ‡ç­¾ï¼Œå½“styleNodeä¸ºç©ºçš„æ—¶å€™ï¼Œä»¥åŠå˜æ›´çš„æ—¶å€™ï¼Œæ¯”å¦‚å¼•å…¥çš„antdæ ·å¼æ–‡ä»¶
        mutator.observe(styleNode, { childList: true });
      }
    

Q1ï¼šä¸ºä»€ä¹ˆåœ¨`style`æ ‡ç­¾æœ‰å†…å®¹çš„æ—¶å€™ä½¿ç”¨`this.swapNode`è¿™ä¸ªå·¥å…·äººï¼Œè€Œåœ¨ç›‘å¬çš„æ—¶å€™ä¸ä½¿ç”¨ï¼Ÿ

è¿˜è®°å¾—æˆ‘ä»¬æ˜¯éœ€è¦å¹²ä»€ä¹ˆå—ï¼Ÿ

æ”¹å†™`style`æ ‡ç­¾å†…çš„æ ·å¼è§„åˆ™

å› æ­¤è¿™é‡Œå°±é€šè¿‡`style.sheet.cssRules`æ–¹å¼å»è·å– style æ ‡ç­¾é‡Œçš„æ¯ä¸€æ¡è§„åˆ™è¿›è¡Œé‡å†™ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹`sheet`æ ·å¼è¡¨çš„æ•°æ®ç»“æ„

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094920639-1292164205.png)

é€šè¿‡è¿™ä¸ªç»“æ„æˆ‘ä»¬å…¶å®ä¸‹ä¸€æ­¥æƒ³è¦åšçš„äº‹æƒ…å¾ˆæ¸…æ¥šäº†

å°±æ˜¯é‡å†™æ¯ä¸€æ¡`cssRules`å¹¶ä¸”é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥èµ‹å€¼ç»™`style`æ ‡ç­¾

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094920890-499017363.png)

ä½†æ˜¯æˆ‘ä»¬å¾—æ³¨æ„ä¸¤ç‚¹ï¼š

*   é€‰æ‹©å™¨ä¸åŒæˆ‘ä»¬çš„å¤„ç†æ–¹å¼ä¹Ÿä¸åŒ
*   å¯¹é€‰æ‹©å™¨çš„åŒ¹é…è§„åˆ™çš„å¤„ç†

### è®©æˆ‘ä»¬çœ‹çœ‹ rewrite å…·ä½“è¿›è¡Œäº†ä»€ä¹ˆæ“ä½œï¼Œè¿™é‡Œä¸»è¦åˆ†ä¸ºä¸¤å—

*   ä¸€å¯¹é€‰æ‹©å™¨çš„ç±»å‹è¿›è¡Œåˆ¤æ–­  
    [CSSRule.type](https://developer.mozilla.org/en-US/docs/Web/API/CSSRule/type)

    private rewrite(rules: CSSRule[], prefix: string = '') {
        let css = '';
    
        rules.forEach((rule) => {
          switch (rule.type) {
    				// æ™®é€šé€‰æ‹©å™¨ç±»å‹
            case RuleType.STYLE:
              css += this.ruleStyle(rule as CSSStyleRule, prefix);
              break;
    				// @mediaé€‰æ‹©å™¨ç±»å‹
            case RuleType.MEDIA:
              css += this.ruleMedia(rule as CSSMediaRule, prefix);
              break;
    				// @supportsé€‰æ‹©å™¨ç±»å‹
            case RuleType.SUPPORTS:
              css += this.ruleSupport(rule as CSSSupportsRule, prefix);
              break;
            default:
              css += `${rule.cssText}`;
              break;
          }
        });
    
        return css;
      }
    

*   äºŒæ˜¯è¿›è¡Œæ­£åˆ™æ›¿æ¢

ç‰¹æ®Šçš„

    // å¤„ç†ç±»ä¼¼äº@media screen and (min-width: 900px) {}
    private ruleMedia(rule: CSSMediaRule, prefix: string) {
      const css = this.rewrite(arrayify(rule.cssRules), prefix);
      return `@media ${rule.conditionText} {${css}}`;
    }
    
    // å¤„ç†ç±»ä¼¼äº@supports (display: grid) {}
    private ruleSupport(rule: CSSSupportsRule, prefix: string) {
      const css = this.rewrite(arrayify(rule.cssRules), prefix);
      return `@supports ${rule.conditionText} {${css}}`;
    }
    

æ™®é€šçš„

    // prefixä¸º"div[data-qiankun="react16"]"
    private ruleStyle(rule: CSSStyleRule, prefix: string) {
    		// æ ¹é€‰æ‹©å™¨ï¼Œæ¯”å¦‚bodyã€htmlä»¥åŠ:root
        const rootSelectorRE = /((?:[^\w\-.#]|^)(body|html|:root))/gm;
    		// æ ¹ç»„åˆé€‰æ‹©å™¨ï¼Œç±»ä¼¼äº html body{...}
        const rootCombinationRE = /(html[^\w{[]+)/gm;
    
    		// è·å–é€‰æ‹©å™¨
        const selector = rule.selectorText.trim();
    
    		// è·å–æ ·å¼æ–‡æœ¬ï¼Œæ¯”å¦‚"html { font-family: sans-serif; line-height: 1.15; text-size-adjust: 100%; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); }"
        let { cssText } = rule;
    	   // å¯¹æ ¹é€‰æ‹©å™¨(bodyã€htmlã€:root)è¿›è¡Œåˆ¤æ–­ï¼Œæ›¿æ¢æˆprefix
        if (selector === 'html' || selector === 'body' || selector === ':root') {
          return cssText.replace(rootSelectorRE, prefix);
        }
    
        // å¯¹äºæ ¹ç»„åˆé€‰æ‹©å™¨è¿›è¡ŒåŒ¹é…
        if (rootCombinationRE.test(rule.selectorText)) {
          const siblingSelectorRE = /(html[^\w{]+)(\+|~)/gm;
    			// å¯¹äºéæ ‡å‡†çš„å…„å¼Ÿé€‰æ‹©å™¨è½¬æ¢æ—¶è¿›è¡Œå¿½ç•¥ï¼Œç½®ç©ºå¤„ç†
          if (!siblingSelectorRE.test(rule.selectorText)) {
            cssText = cssText.replace(rootCombinationRE, '');
          }
        }
    
        // æ™®é€šé€‰æ‹©å™¨åŒ¹é…
        cssText = cssText.replace(/^[\s\S]+{/, (selectors) =>
    			// selectorsä¸ºç±»ä¼¼äº.link{
          selectors.replace(/(^|,\n?)([^,]+)/g, (item, p, s) => {
    				// å¤„ç†ç±»ä¼¼äºdiv,body,span { ... }ï¼Œå«æœ‰æ ¹å…ƒç´ çš„
            if (rootSelectorRE.test(item)) {
              return item.replace(rootSelectorRE, (m) => {
                const whitePrevChars = [',', '('];
    						// å°†å…¶ä¸­çš„æ ¹å…ƒç´ æ›¿æ¢ä¸ºå‰ç¼€ä¿ç•™,æˆ–è€…ï¼ˆ
                if (m && whitePrevChars.includes(m[0])) {
                  return `${m[0]}${prefix}`;
                }
    						// ç›´æ¥æŠŠæ ¹å…ƒç´ æ›¿æ¢æˆå‰ç¼€
                return prefix;
              });
            }
    
            return `${p}${prefix} ${s.replace(/^ */, '')}`;
          }),
        );
    
        return cssText;
      }
    

### åŠ¨æ€æ·»åŠ æ ·å¼çš„æ€è€ƒğŸ¤”

é‚£ä¹ˆé€šè¿‡ JS åŠ¨æ€æ·»åŠ çš„`style`ã€`link`æˆ–è€…`script`æ ‡ç­¾æ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦è¿è¡Œåœ¨ç›¸åº”çš„`CSS`æˆ–è€…`JS`æ²™ç®±ä¸­å‘¢ï¼Œæ·»åŠ è¿™äº›æ ‡ç­¾çš„å¸¸è§æ–¹æ³•æ— ç–‘æ˜¯`createElement`ã€`appendChild`å’Œ`insertBefore`ï¼Œé‚£å…¶å®æˆ‘ä»¬åªè¦å¯¹ä»–ä»¬è®¾ç½®ç›‘å¬å°±å¯ä»¥äº†

`dynamicAppend`å°±æ˜¯ç”¨æ¥è§£å†³ä¸Šé¢çš„é—®é¢˜çš„ï¼Œå®ƒæš´éœ²äº†ä¸¤ä¸ªæ–¹æ³•

*   patchStrictSandboxï¼šQianKun JS æ²™ç®±æ¨¡å¼çš„å¤šä¾‹æ¨¡å¼

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094921336-290642804.png)

**patchStrictSandbox**

    export function patchStrictSandbox(
      appName: string,
    	// è¿”å›åŒ…è£¹å­åº”ç”¨çš„é‚£ä¸€å—Domç»“æ„
      appWrapperGetter: () => HTMLElement | ShadowRoot,
      proxy: Window,
      mounting = true,
      scopedCSS = false,
      excludeAssetFilter?: CallableFunction,
    ){
      ...
    let containerConfig = proxyAttachContainerConfigMap.get(proxy);
      if (!containerConfig) {
        containerConfig = {
          appName,
          proxy,
          appWrapperGetter,
          dynamicStyleSheetElements: [],
          strictGlobal: true,
          excludeAssetFilter,
          scopedCSS,
        };
    		// å»ºç«‹äº†ä»£ç†å¯¹è±¡å’Œå­åº”ç”¨é…ç½®ä¿¡æ¯Mapå…³ç³»
        proxyAttachContainerConfigMap.set(proxy, containerConfig);
      }
    
    	// é‡å†™Document.prototype.createElement
      const unpatchDocumentCreate = patchDocumentCreateElement();
    
    	// é‡å†™appendChildã€insertBefore
      const unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(
        (element) => elementAttachContainerConfigMap.has(element),
        (element) => elementAttachContainerConfigMap.get(element)!,
      );
      ...
    }
    

*   é‡å†™`Document.prototype.createElement`
*   é‡å†™`appendChild`ã€`insertBefore`

**patchDocumentCreateElement**

    function patchDocumentCreateElement() {
    	// è®°å½•createElementæ˜¯å¦è¢«é‡å†™
      const docCreateElementFnBeforeOverwrite = docCreatePatchedMap.get(document.createElement);
    
      if (!docCreateElementFnBeforeOverwrite) {
        const rawDocumentCreateElement = document.createElement;
    		// é‡å†™Document.prototype.createElement
        Document.prototype.createElement = function createElement<K extends keyof HTMLElementTagNameMap>(
          this: Document,
          tagName: K,
          options?: ElementCreationOptions,
        ): HTMLElement {
          const element = rawDocumentCreateElement.call(this, tagName, options);
    			// åˆ¤æ–­åˆ›å»ºçš„æ˜¯å¦ä¸ºstyleã€linkå’Œscriptæ ‡ç­¾
          if (isHijackingTag(tagName)) {
            const { window: currentRunningSandboxProxy } = getCurrentRunningApp() || {};
            if (currentRunningSandboxProxy) {
    					// è·å–å­åº”ç”¨çš„é…ç½®ä¿¡æ¯
              const proxyContainerConfig = proxyAttachContainerConfigMap.get(currentRunningSandboxProxy);
              if (proxyContainerConfig) {
                // å»ºç«‹æ–°å…ƒç´ elementå’Œå­åº”ç”¨é…ç½®çš„å¯¹åº”å…³ç³»
                elementAttachContainerConfigMap.set(element, proxyContainerConfig);
              }
            }
          }
    
          return element;
        };
    
        if (document.hasOwnProperty('createElement')) {
    			// é‡å†™
          document.createElement = Document.prototype.createElement;
        }
    
        docCreatePatchedMap.set(Document.prototype.createElement, rawDocumentCreateElement);
      }
    }
    
    function isHijackingTag(tagName?: string) {
      return (
        tagName?.toUpperCase() === LINK_TAG_NAME ||
        tagName?.toUpperCase() === STYLE_TAG_NAME ||
        tagName?.toUpperCase() === SCRIPT_TAG_NAME
      );
    }
    

*   é‡å†™`document.createElement`
*   å»ºç«‹æ–°å…ƒç´  element å’Œå­åº”ç”¨é…ç½®çš„å¯¹åº”å…³ç³»`elementAttachContainerConfigMap`

**patchHTMLDynamicAppendPrototypeFunctions**

    export function patchHTMLDynamicAppendPrototypeFunctions(
      isInvokedByMicroApp: (element: HTMLElement) => boolean,
      containerConfigGetter: (element: HTMLElement) => ContainerConfig,
    ) {
      // å½“appendChildå’ŒinsertBeforeæ²¡æœ‰è¢«é‡å†™çš„æ—¶å€™
      if (
        HTMLHeadElement.prototype.appendChild === rawHeadAppendChild &&
        HTMLBodyElement.prototype.appendChild === rawBodyAppendChild &&
        HTMLHeadElement.prototype.insertBefore === rawHeadInsertBefore
      ) {
        HTMLHeadElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({
          rawDOMAppendOrInsertBefore: rawHeadAppendChild,
          containerConfigGetter,
          isInvokedByMicroApp,
        }) as typeof rawHeadAppendChild;
        HTMLBodyElement.prototype.appendChild = getOverwrittenAppendChildOrInsertBefore({
          rawDOMAppendOrInsertBefore: rawBodyAppendChild,
          containerConfigGetter,
          isInvokedByMicroApp,
        }) as typeof rawBodyAppendChild;
    
        HTMLHeadElement.prototype.insertBefore = getOverwrittenAppendChildOrInsertBefore({
          rawDOMAppendOrInsertBefore: rawHeadInsertBefore as any,
          containerConfigGetter,
          isInvokedByMicroApp,
        }) as typeof rawHeadInsertBefore;
      }}
    

*   å½“ appendChildã€appendChild å’Œ insertBefore æ²¡æœ‰è¢«é‡å†™çš„æ—¶å€™è¿›è¡Œé‡å†™

getOverwrittenAppendChildOrInsertBefore

    function getOverwrittenAppendChildOrInsertBefore(opts: {
      rawDOMAppendOrInsertBefore: <T extends Node>(newChild: T, refChild?: Node | null) => T;
      isInvokedByMicroApp: (element: HTMLElement) => boolean;
      containerConfigGetter: (element: HTMLElement) => ContainerConfig;
    }) {
      return function appendChildOrInsertBefore<T extends Node>(
        this: HTMLHeadElement | HTMLBodyElement,
        newChild: T,
        refChild: Node | null = null,
      ) {
        let element = newChild as any;
        const { rawDOMAppendOrInsertBefore, isInvokedByMicroApp, containerConfigGetter } = opts;
        // å½“ä¸æ˜¯styleã€linkæˆ–è€…æ˜¯scriptæ ‡ç­¾çš„æ—¶å€™æˆ–è€…åœ¨å…ƒç´ çš„åˆ›å»ºæ‰¾ä¸åˆ°å¯¹åº”çš„å­åº”ç”¨é…ç½®ä¿¡æ¯æ—¶ï¼Œèµ°åŸç”Ÿçš„æ–¹æ³•
        if (!isHijackingTag(element.tagName) || !isInvokedByMicroApp(element)) {
          return rawDOMAppendOrInsertBefore.call(this, element, refChild) as T;
        }
    
        if (element.tagName) {
          // è·å–å½“å‰å­åº”ç”¨çš„é…ç½®ä¿¡æ¯
          const containerConfig = containerConfigGetter(element);
          const {
            appName,
            appWrapperGetter,
            proxy,
            strictGlobal,
            dynamicStyleSheetElements,
            scopedCSS,
            excludeAssetFilter,
          } = containerConfig;
    
          switch (element.tagName) {
            case LINK_TAG_NAME:
            case STYLE_TAG_NAME: {
              let stylesheetElement: HTMLLinkElement | HTMLStyleElement = newChild as any;
              const { href } = stylesheetElement as HTMLLinkElement;
              // é…ç½®é¡¹ä¸éœ€è¦è¢«åŠ«æŒçš„èµ„æº
              if (excludeAssetFilter && href && excludeAssetFilter(href)) {
                return rawDOMAppendOrInsertBefore.call(this, element, refChild) as T;
              }
    
              // æŒ‚è½½çš„domç»“æ„ï¼Œå³å­åº”ç”¨çš„domç»“æ„
              const mountDOM = appWrapperGetter();
    
              // å¦‚æœå¼€å¯äº†å®éªŒæ€§çš„æ ·å¼æ²™ç®±æ¨¡å¼
              if (scopedCSS) {
                // exclude link elements like <link rel="icon" href="favicon.ico">
                const linkElementUsingStylesheet =
                  element.tagName?.toUpperCase() === LINK_TAG_NAME &&
                  (element as HTMLLinkElement).rel === 'stylesheet' &&
                  (element as HTMLLinkElement).href;
                // å¯¹äºlinkæ ‡ç­¾è¿›è¡Œæ ·å¼èµ„æºä¸‹è½½ï¼Œå¹¶è¿›è¡Œæ ·å¼çš„é‡å†™
                if (linkElementUsingStylesheet) {
                  const fetch =
                    typeof frameworkConfiguration.fetch === 'function'
                      ? frameworkConfiguration.fetch
                      : frameworkConfiguration.fetch?.fn;
                  stylesheetElement = convertLinkAsStyle(
                    element,
                    (styleElement) => css.process(mountDOM, styleElement, appName),
                    fetch,
                  );
                  dynamicLinkAttachedInlineStyleMap.set(element, stylesheetElement);
                } else {
                  css.process(mountDOM, stylesheetElement, appName);
                }
              }
    
              // é‡å†™ä»¥åçš„styleæ ‡ç­¾
              dynamicStyleSheetElements.push(stylesheetElement);
              const referenceNode = mountDOM.contains(refChild) ? refChild : null;
              return rawDOMAppendOrInsertBefore.call(mountDOM, stylesheetElement, referenceNode);
            }
    	...
    }
    

*   patchLooseSandboxï¼šQianKun JS æ²™ç®±æ¨¡å¼çš„å•ä¾‹æ¨¡å¼å’Œå¿«ç…§æ¨¡å¼ä¸‹

![file](https://img2022.cnblogs.com/other/2332333/202206/2332333-20220622094921994-1852785635.png)

    export function patchLooseSandbox(
      appName: string,
      appWrapperGetter: () => HTMLElement | ShadowRoot,
      proxy: Window,
      mounting = true,
      scopedCSS = false,
      excludeAssetFilter?: CallableFunction,
    ): Freer {
      let dynamicStyleSheetElements: Array<HTMLLinkElement | HTMLStyleElement> = [];
    
      const unpatchDynamicAppendPrototypeFunctions = patchHTMLDynamicAppendPrototypeFunctions(
        // åˆ¤æ–­å½“å‰å¾®åº”ç”¨æ˜¯å¦è¿è¡Œ
    		() => checkActivityFunctions(window.location).some((name) => name === appName),
        // è¿”å›å¾®åº”ç”¨çš„é…ç½®ä¿¡æ¯
    		() => ({
          appName,
          appWrapperGetter,
          proxy,
          strictGlobal: false,
          scopedCSS,
          dynamicStyleSheetElements,
          excludeAssetFilter,
        }),
      );
    }
    

ç”±äºæ˜¯å•ä¾‹æ¨¡å¼ä¿®æ”¹çš„è¿˜æ˜¯å…¨å±€çš„ window å»æ‰äº†å¯¹`document.createElement`çš„é‡å†™ï¼Œä¸éœ€è¦å»ºç«‹å¾®åº”ç”¨å’Œæ–°å»ºå…ƒç´ çš„ä¸€ä¸€å¯¹åº”