---
layout: post
title: "K8S Pod Sidecar åº”ç”¨åœºæ™¯ä¹‹ä¸€-åŠ å…¥ NGINX Sidecar åšåä»£å’Œ web æœåŠ¡å™¨"
date: "2023-02-27T01:14:38.938Z"
---
K8S Pod Sidecar åº”ç”¨åœºæ™¯ä¹‹ä¸€-åŠ å…¥ NGINX Sidecar åšåä»£å’Œ web æœåŠ¡å™¨
====================================================

Kubernetes Pod Sidecar ç®€ä»‹
-------------------------

![Sidecar](https://pic-cdn.ewhisper.cn/img/2022/10/08/6cb82139b5f6778f7a14af0a1fdc1ad1-sidecar.jpg)

Sidecar æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œä¸ Kubernetes pod ä¸­çš„åº”ç”¨å®¹å™¨ä¸€èµ·è¿è¡Œï¼Œæ˜¯ä¸€ç§è¾…åŠ©æ€§çš„åº”ç”¨ã€‚

Sidecar çš„å¸¸è§è¾…åŠ©æ€§åŠŸèƒ½æœ‰è¿™ä¹ˆå‡ ç§ï¼š

1.  æœåŠ¡ç½‘æ ¼ (service mesh) ä»£ç†
2.  ç›‘æ§ Exporterï¼ˆå¦‚ redis exporter)
3.  ConfigMap æˆ–/å’Œ Secret Reloaderï¼ˆå¦‚ Prometheus çš„ Config Reloader)
4.  Auth Proxyï¼ˆå¦‚ OAuth Proxy ç­‰ï¼‰
5.  7 å±‚åå‘ä»£ç†å’Œ Web æœåŠ¡å™¨
6.  æ—¥å¿—æ•´åˆï¼ˆå®¡è®¡æ—¥å¿—å•ç‹¬å‘åˆ°æŸä¸ªæ—¥å¿—æ¸ é“ã€‚..)
7.  Demo æˆ– AllInOne åº”ç”¨ï¼ˆå¦‚ nextcloud æˆ– Jaeger AllInOne ç­‰ç¤ºä¾‹åº”ç”¨ï¼‰
8.  ...

è¿™é‡Œé€‰å‡ ä¸ªåœºæ™¯ç»†è¯´ä¸€ä¸‹ï¼Œåœ¨æœåŠ¡ç½‘æ ¼çš„æƒ…å†µä¸‹ï¼Œsidecar è´Ÿè´£ä»åº”ç”¨ç¨‹åºæœ¬èº«å¸è½½æœåŠ¡ç½‘æ ¼ä¸­æ‰€æœ‰åº”ç”¨ç¨‹åºæ‰€éœ€çš„åŠŸèƒ½--SSL/mTLSã€æµé‡è·¯ç”±ã€é«˜å¯ç”¨æ€§ç­‰ï¼Œå¹¶å®æ–½éƒ¨ç½²å„ç§é«˜çº§å‘å¸ƒæ¨¡å¼ï¼Œå¦‚æ–­è·¯å™¨ã€é‡‘ä¸é›€å’Œè“ç»¿ç­‰ã€‚

ä½œä¸ºæ•°æ®å¹³é¢ç»„ä»¶ï¼Œsidecar é€šå¸¸ç”±æœåŠ¡ç½‘æ ¼ä¸­çš„æŸç§ç±»å‹çš„æ§åˆ¶å¹³é¢ç®¡ç†ã€‚å½“ sidecar è·¯ç”±åº”ç”¨æµé‡å¹¶æä¾›å…¶ä»–æ•°æ®å¹³é¢æœåŠ¡æ—¶ï¼Œæ§åˆ¶å¹³é¢åœ¨å¿…è¦æ—¶å°† sidecars æ³¨å…¥ pod å¹¶æ‰§è¡Œç®¡ç†ä»»åŠ¡ï¼Œä¾‹å¦‚æ›´æ–° mTLS è¯ä¹¦å¹¶åœ¨éœ€è¦æ—¶å°†å…¶æ¨é€åˆ°é€‚å½“çš„ sidecarsã€‚

æ—¥å¿—æ•´åˆåœºæ™¯ä¸‹ï¼ŒSidecar è¢«ç”¨æ¥å°†å¤šä¸ªåº”ç”¨å®ä¾‹çš„æ—¥å¿—ä¿¡æ¯æ±‡æ€»å¹¶æ ¼å¼åŒ–ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚

æ¥ä¸‹æ¥è¿›å…¥æœ¬æ¬¡çš„æ­£é¢˜ï¼šå°† NGINX ï¼ˆæˆ– Caddy ç­‰ï¼‰ä½œä¸º Sidecar ä½¿ç”¨ï¼Œä¸»è¦ç”¨åšåä»£å’Œ web æœåŠ¡å™¨

![Web Server Sidecar](https://pic-cdn.ewhisper.cn/img/2022/10/08/f3ec9ad18ca681bc581c166aa3c5cba2-sidecar-pod.svg)

åœºæ™¯å‡è®¾
----

å‡è®¾æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼š

æˆ‘åœ¨ä½¿ç”¨åŸç”Ÿçš„ Prometheus AlertManager, æˆ‘å·²ç»æœ‰ Ingress.  
æˆ‘ç°åœ¨æƒ³è¦åš 2 ä»¶äº‹ï¼š

1.  æå‡ AlertManager UI çš„å¹¶å‘èƒ½åŠ›ï¼ˆå¢åŠ  buffer, cache; å¯ç”¨ gzip ç­‰ï¼‰
2.  AlertManager çš„æŸä¸ª jsï¼ˆå‡è®¾æ˜¯ `script.js`), æˆ‘åšäº†ä¸€ç‚¹ä¿®æ”¹ï¼Œä½†ä¸å¸Œæœ›ä¾µå…¥å¼åœ°ä¿®æ”¹ åŸç”Ÿ AlertManager äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œæ˜¯æŠŠä¿®æ”¹å js æ”¾åˆ° nginx çš„ www ç›®å½•ï¼Œè®© nginx æ¥ç”¨ä¸åŒçš„ location è¿›è¡Œå¤„ç†ã€‚

è¿™ç§åœºæ™¯ä¸‹ï¼Œæ˜¾ç„¶ Ingress æ˜¯æ— æ³•åŒæ—¶æ»¡è¶³çš„ã€‚è¿™æ—¶å€™å°±å¯ä»¥åœ¨ AlertManager Pod é‡ŒåŠ ä¸ª NGINX çš„ sidecar æ¥å®ç°ã€‚

å…·ä½“å¦‚ä¸‹

NGINX Sidecar å…¸å‹ä½¿ç”¨æ­¥éª¤
--------------------

1.  åˆ›å»º NGINX Conf çš„ configmap; ï¼ˆç›‘å¬ 8080, åå‘ä»£ç†åˆ°åç«¯çš„ 9093)
2.  åˆ›å»º alertmanager script.js çš„ configmap;
3.  ä¿®æ”¹åŸ AlertManager çš„ StatefulSets, å¢åŠ ï¼š
    1.  NGINX Sidecar
    2.  3 ä¸ª volumes: å…¶ä¸­ 2 ä¸ªå°±æ˜¯ç”¨äºæŒ‚è½½ä¸Šé¢çš„ ConfigMap, å¦å¤–ä¸€ä¸ª EmptyDir ç”¨äºæŒ‚è½½ nginx cache
4.  ä¿®æ”¹ AlertManager Service çš„ç«¯å£ï¼Œä» 9093 æ”¹ä¸º 8080, name ä»`http` æ”¹ä¸º `nginx-http`
5.  ï¼ˆå¯é€‰ï¼‰ä¿®æ”¹å…¶ä»–éƒ¨åˆ†ï¼Œå¦‚ Ingress ç­‰ï¼Œè°ƒæ•´ç«¯å£ã€‚

### NGINX Conf çš„ ConfigMap

å…·ä½“å¦‚ä¸‹ï¼š

    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: alertmanager-nginx-proxy-config
      labels:
        app.kubernetes.io/name: alertmanager
    data:
      nginx.conf: |-
        worker_processes      auto;
        error_log             /dev/stdout warn;
        pid                   /var/cache/nginx/nginx.pid;
    
        events {
           worker_connections 1024;
        }
    
        http {
          include       /etc/nginx/mime.types;
          log_format    main '[$time_local - $status] $remote_addr - $remote_user $request ($http_referer)';
    
          proxy_connect_timeout       10;
          proxy_read_timeout          180;
          proxy_send_timeout          5;
          proxy_buffering             off;
          proxy_cache_path            /var/cache/nginx/cache levels=1:2 keys_zone=my_zone:100m inactive=1d max_size=10g;
    
          server {
            listen          8080;
            access_log      off;
    
            gzip            on;
            gzip_min_length 1k;
            gzip_comp_level 2;
            gzip_types      text/plain application/javascript application/x-javascript text/css application/xml text/javascript image/jpeg image/gif image/png;
            gzip_vary       on;
            gzip_disable    "MSIE [1-6]\.";
    
            proxy_set_header Host $host;
    
            location = /script.js {
              root /usr/share/nginx/html;
              expires             90d;
            }
    
            location / {
              proxy_cache         my_zone;
              proxy_cache_valid   200 302 1d;
              proxy_cache_valid   301 30d;
              proxy_cache_valid   any 5m;
              proxy_cache_bypass  $http_cache_control;
              add_header          X-Proxy-Cache $upstream_cache_status;
              add_header          Cache-Control "public";
              
              proxy_pass     http://localhost:9093/;
    
              if ($request_filename ~ .*\.(?:js|css|jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm)$) {
                expires             90d;
              }
            }
          }
        }
    

### AlertManager script.js ConfigMap

è¯¦ç»†å†…å®¹ç•¥ã€‚

å…ˆé€šè¿‡æµè§ˆå™¨å°†`script.js` ä¸‹è½½ä¸‹æ¥ã€‚ç„¶åæŒ‰éœ€ä¿®æ”¹ï¼š

    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: alertmanager-script-js
      labels:
        app.kubernetes.io/name: alertmanager
    data:
      script.js: >-
        ...
    

### ä¿®æ”¹ StatefulSets

ä¿®æ”¹çš„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼š

    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: monitor-alertmanager
    spec:
      template:
        spec:
          volumes:
            # å¢åŠ  3 ä¸ª volumes
            - name: nginx-home
              emptyDir: {}
            - name: html
              configMap:
                name: alertmanager-script-js
                items:
                - key: script.js
                  mode: 438
                  path: script.js
            - name: alertmanager-nginx
              configMap:
                name: alertmanager-nginx-proxy-config
                items:
                - key: nginx.conf
                  mode: 438
                  path: nginx.conf
          containers:
            # å¢åŠ  NGINX sidecar
            - name: alertmanager-proxy
              args:
              - nginx
              - -g
              - daemon off;
              - -c
              - /nginx/nginx.conf
              image: "nginx:stable"
              ports:
              - containerPort: 8080
                name: nginx-http
                protocol: TCP
              volumeMounts:
              - mountPath: /nginx
                name: alertmanager-nginx
              - mountPath: /var/cache/nginx
                name: nginx-home
              - mountPath: /usr/share/nginx/html
                name: html
              securityContext:
                runAsUser: 101
                runAsGroup: 101
    

### ä¿®æ”¹ Service ç«¯å£

å¦‚ä¸‹ï¼š

    apiVersion: v1
    kind: Service
    metadata:
      name: monitor-alertmanager
      labels:
        app.kubernetes.io/name: alertmanager
    spec:
      ports:
        - name: nginx-http
          protocol: TCP
          # ä¿®æ”¹ä»¥ä¸‹ 2 é¡¹
          port: 8080
          targetPort: nginx-http
    

### æœ€ç»ˆæ•ˆæœ

ä»¥è¿™æ¬¡çš„ AlertManager ä¸ºä¾‹ï¼Œä¿®æ”¹å‰ï¼š

![AlertManager UI - matcher](https://pic-cdn.ewhisper.cn/img/2022/10/08/6aa328ba86951fbf5e517fafad45b5ab-20221008164824.png)

ä¿®æ”¹åï¼š(matcher çš„ä¾‹å­æ›´ç¬¦åˆå®é™…åœºæ™¯ï¼Œå¹¶å¢åŠ äº†å¤šä¸ªç¤ºä¾‹ã€‚ç¡®å®æ˜¯å¾ˆå°çš„æ”¹åŠ¨ï¼‰

![AlertManager UI - matcher ä¿®æ”¹å](https://pic-cdn.ewhisper.cn/img/2022/10/08/8c08587fd690b57c6b34cd2ee21764a2-20221008164955.png)

æ€»ç»“
--

Kubernetes çš„ Pod è®¾è®¡ä¹‹åˆå°±å®šä¹‰ä¸ºï¼šä¸€ä¸ª Pod å¯ä»¥åŒ…å«å¤šä¸ª Containers, è¿™ä¸º Kubernetes ä¸­ Pod çš„ Sidecar ä½¿ç”¨ç•™ä¸‹äº†æ— å°½çš„æƒ³è±¡ç©ºé—´ã€‚

Sidecar ä¸€èˆ¬æ˜¯ç”¨æ¥åšè¾…åŠ©åŠŸèƒ½çš„ï¼Œæ¯”å¦‚ï¼š

1.  æœåŠ¡ç½‘æ ¼ (service mesh) ä»£ç†
2.  ç›‘æ§ Exporterï¼ˆå¦‚ redis exporter)
3.  ConfigMap æˆ–/å’Œ Secret Reloaderï¼ˆå¦‚ Prometheus çš„ Config Reloader)
4.  Auth Proxyï¼ˆå¦‚ OAuth Proxy ç­‰ï¼‰
5.  7 å±‚åå‘ä»£ç†å’Œ Web æœåŠ¡å™¨
6.  æ—¥å¿—æ•´åˆï¼ˆå®¡è®¡æ—¥å¿—å•ç‹¬å‘åˆ°æŸä¸ªæ—¥å¿—æ¸ é“ã€‚..)
7.  Demo æˆ– AllInOne åº”ç”¨ï¼ˆå¦‚ nextcloud æˆ– Jaeger AllInOne ç­‰ç¤ºä¾‹åº”ç”¨ï¼‰
8.  ...

æˆ‘ä»¬è¿™æ¬¡é€šè¿‡åŠ å…¥ NGINX ä½œä¸º 7 å±‚åå‘ä»£ç†å’Œ Web æœåŠ¡å™¨ç”¨é€”çš„ Sidecar æ¥è¿›è¡Œæ¼”ç¤ºï¼Œç”ŸåŠ¨åœ°è¯´æ˜äº† Sidecar çš„å®ç”¨ä¹‹å¤„ã€‚

ğŸ‰ğŸ‰ğŸ‰

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [Pod | Kubernetes](https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/)