---
layout: post
title: "eBPF Ciliumå®æˆ˜(1) - åŸºäºå›¢é˜Ÿçš„ç½‘ç»œéš”ç¦»"
date: "2022-04-06T03:31:17.271Z"
---
eBPF Ciliumå®æˆ˜(1) - åŸºäºå›¢é˜Ÿçš„ç½‘ç»œéš”ç¦»
============================

åœ¨ [Rainbond](https://www.rainbond.com/) é›†ç¾¤ä¸­ï¼Œæ¯ä¸ªå›¢é˜Ÿå¯¹åº”äºåº•å±‚ Kubernetes çš„ä¸€ä¸ª Namespace ï¼Œç”±äºä¹‹å‰ä½¿ç”¨çš„åº•å±‚ç½‘ç»œæ— æ³•è¿›è¡Œ Namespace çº§åˆ«çš„ç½‘ç»œç®¡ç†ï¼Œæ‰€ä»¥åœ¨ Rainbond åŒä¸€é›†ç¾¤ä¸‹çš„ä¸åŒå›¢é˜Ÿé—´ï¼Œæ‰€ä»¥ç»„ä»¶å¯ä»¥è‡ªç”±çš„è¿›è¡Œäº’ç›¸è®¿é—®ï¼Œç”¨æˆ·æ— æ³•å¯¹æ­¤åšå‡ºä»»ä½•é™åˆ¶ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†åº•å±‚ç½‘ç»œçš„å®‰å…¨éšæ‚£ä¸€ç›´å­˜åœ¨ã€‚ç°åœ¨ç”± cilium æä¾›ç½‘ç»œæœåŠ¡çš„ Kubernetes é›†ç¾¤å¯ä»¥å¾ˆå¥½çš„è§£å†³è¿™ä¸€é—®é¢˜ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ï¼Œåˆ¶å®šé’ˆå¯¹æ¯ä¸ªå›¢é˜Ÿã€æ¯ä¸ªç»„ä»¶çš„ç½‘ç»œç­–ç•¥ï¼ŒåŠ å¼ºåº•å±‚ç½‘ç»œç®¡ç†ï¼Œå®ç°ç½‘ç»œå±‚çš„å®‰å…¨æŠŠæ§ã€‚

ä½¿ç”¨ cilium ä½œä¸º Kubernetes ç½‘ç»œæœåŠ¡
----------------------------

*   ä½¿ç”¨ä»ä¸»æœºå®‰è£…æ—¶ï¼Œä¿®æ”¹ network.plugin å€¼ä¸º none
    
    ![](https://static.goodrain.com/wechat/cilium/1.png)
    
*   å®‰è£… helm
    

    wget https://goodrain-pkg.oss-cn-shanghai.aliyuncs.com/pkg/helm && chmod +x helm && mv helm /usr/local/bin/
    

*   éƒ¨ç½² cilium

    helm repo add cilium https://helm.cilium.io/
    helm install cilium cilium/cilium --version 1.11.2 --namespace kube-system --set operator.replicas=1
    
    kubectl get pods --all-namespaces -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,HOSTNETWORK:.spec.hostNetwork --no-headers=true | grep '<none>' | awk '{print "-n "$1" "$2}' | xargs -L 1 -r kubectl delete pod
    
    

*   éªŒè¯ cilium

ä¸‹è½½ cilium å‘½ä»¤è¡Œå·¥å…·

    curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}
    sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
    sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
    rm cilium-linux-amd64.tar.gz{,.sha256sum}
    

*   ç¡®è®¤çŠ¶æ€

    $ cilium status --wait
    /Â¯Â¯\
    /Â¯Â¯\__/Â¯Â¯\    Cilium:         OK
    \__/Â¯Â¯\__/    Operator:       OK
    /Â¯Â¯\__/Â¯Â¯\    Hubble:         disabled
    \__/Â¯Â¯\__/    ClusterMesh:    disabled
    \__/
    
    DaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2
    Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
    Containers:       cilium-operator    Running: 2
    cilium             Running: 2
    Image versions    cilium             quay.io/cilium/cilium:v1.9.5: 2
    cilium-operator    quay.io/cilium/operator-generic:v1.9.5: 2
    

*   æµ‹è¯•ç½‘ç»œè”é€šæ€§ï¼ˆå›½å†…æœåŠ¡å™¨æµ‹è¯•æ—¶ï¼Œæ¶‰åŠåˆ°å¤–éƒ¨ç½‘ç»œçš„æµ‹è¯•å¯èƒ½ä¼šå¤±è´¥ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨ï¼‰

    $ cilium connectivity test
    â„¹ï¸  Monitor aggregation detected, will skip some flow validation steps
    âœ¨ [k8s-cluster] Creating namespace for connectivity check...
    (...)
    ---------------------------------------------------------------------------------------------------------------------
    ğŸ“‹ Test Report
    ---------------------------------------------------------------------------------------------------------------------
    âœ… 69/69 tests successful (0 warnings)
    

â€‹

è®¾ç½®å›¢é˜Ÿç½‘ç»œéš”ç¦»
--------

Cilium çš„ç½‘ç»œéš”ç¦»ç­–ç•¥éµå¾ªç™½åå•æœºåˆ¶ï¼Œåœ¨ä¸åˆ›å»ºç½‘ç»œç­–ç•¥çš„æƒ…å†µä¸‹ï¼Œå¯¹äºç½‘ç»œä¸ä½œä»»ä½•é™åˆ¶ï¼Œåœ¨ä¸ºæŒ‡å®šç±»å‹çš„ pod é›†åˆåˆ›å»ºç½‘ç»œç­–ç•¥åï¼Œé™¤ç­–ç•¥ä¸­å…è®¸çš„è®¿é—®åœ°å€å¤–ï¼Œå…¶å®ƒè¯·æ±‚éƒ½ä¼šè¢«æ‹’ç»ã€‚

*   å‰æœŸå‡†å¤‡
    
    *   åˆ›å»ºä¸¤ä¸ªå¼€å‘å›¢é˜Ÿå’Œæµ‹è¯•å›¢é˜Ÿï¼Œè‹±æ–‡åç§°è®¾ç½®ä¸º dev å’Œ test
    *   åœ¨å¼€å‘å›¢é˜Ÿå’Œæµ‹è¯•å›¢é˜Ÿä¸‹åˆ›å»º nginx-dev å’Œ nginx-test ç»„ä»¶ï¼Œå¼€å¯å¯¹å†…ç«¯å£ï¼Œå†…éƒ¨åŸŸååˆ†åˆ«è®¾ç½®ä¸º nginx-dev å’Œ nginx-test
    *   åœ¨å¼€å‘å’Œæµ‹è¯•å›¢é˜Ÿä¸‹åˆ›å»ºå®¢æˆ·ç«¯ç»„ä»¶
*   ä¸åšä»»ä½•é™åˆ¶
    
    åœ¨ä¸åšé™åˆ¶çš„æƒ…å†µä¸‹ï¼Œå„ä¸ªå›¢é˜Ÿä¹‹é—´çš„æ‰€æœ‰æœåŠ¡å‡å¯ä»¥è‡ªç”±é€šä¿¡ï¼Œä¸å—ä»»ä½•ç‰¹æ®Šé™åˆ¶
    

![](https://static.goodrain.com/wechat/cilium/2.png)

![](https://static.goodrain.com/wechat/cilium/3.png)

*   é™åˆ¶åªå…è®¸æœ¬å›¢é˜Ÿå†…ç»„ä»¶äº’ç›¸è®¿é—®ï¼Œéš”ç»å…¶å®ƒå›¢é˜Ÿè®¿é—®
    
    åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œä¸€ä¸ªé›†ç¾¤å†…éƒ¨å¯èƒ½ä¼šåŒæ—¶éƒ¨ç½²å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç­‰å¤šä¸ªå›¢é˜Ÿï¼ŒåŸºäºå®‰å…¨æ€§çš„è€ƒè™‘ï¼Œéœ€è¦å¯¹æ¯ä¸ªçš„å›¢é˜Ÿåšå‡ºç½‘ç»œéš”ç¦»ï¼Œç¦æ­¢å…¶å®ƒå›¢é˜Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œè®¿é—®ï¼Œä¸‹é¢ä»¥å¼€å‘å›¢é˜Ÿä¸ºä¾‹è¯´æ˜å¦‚ä½•é™åˆ¶ä¸å…è®¸å…¶å®ƒå›¢é˜Ÿå¯¹å…¶è®¿é—®ã€‚
    

![](https://static.goodrain.com/wechat/cilium/4.png)

*   Cilium ç½‘ç»œç­–ç•¥æ–‡ä»¶(dev-ingress.yaml)

    apiVersion: "cilium.io/v2"
    kind: CiliumNetworkPolicy
    metadata:
    name: "dev-namespace-ingress"
    spec:
    endpointSelector:
    matchLabels:
    "k8s:io.kubernetes.pod.namespace": dev
    ingress:
    - fromEndpoints:
    - matchLabels:
    "k8s:io.kubernetes.pod.namespace": dev
    

*   åˆ›å»ºç­–ç•¥

    kubectl create -f dev-ingress.yaml -n dev
    

*   ç¡®è®¤ç­–ç•¥

    $ kubectl get CiliumNetworkPolicy -A
    NAMESPACE   NAME                    AGE
    dev         dev-namespace-ingress   39s
    

*   æµ‹è¯•æ•ˆæœ

![](https://static.goodrain.com/wechat/cilium/5.png)

![](https://static.goodrain.com/wechat/cilium/6.png)

*   è®¾ç½®å¼€å‘å›¢é˜Ÿä¸‹çš„ nginx-dev ç»„ä»¶åªå…è®¸æµ‹è¯•å›¢é˜Ÿä¸‹çš„ç»„ä»¶è®¿é—®
    
    åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€äº›ç»„ä»¶çš„å®‰å…¨è¦æ±‚ä¼šæ›´ä¸ºä¸¥æ ¼ï¼Œå¯èƒ½åªä¼šå…è®¸æœ¬å›¢é˜Ÿå†…ç¬¦åˆè¦æ±‚çš„éƒ¨åˆ†ç»„ä»¶è¿›è¡Œè®¿é—®ï¼Œä¸‹é¢ä»¥ nginx-dev ä¸ºä¾‹è¯´æ˜å¦‚ä½•é™åˆ¶ä»…å…è®¸éƒ¨åˆ†ç»„ä»¶è¿›è¡Œè®¿é—®ã€‚
    

![](https://static.goodrain.com/wechat/cilium/7.png)

*   Cilium ç½‘ç»œç­–ç•¥æ–‡ä»¶(nginx-dev-ingress0.yaml)

    apiVersion: "cilium.io/v2"
    kind: CiliumNetworkPolicy
    metadata:
    name: "nginx-dev-ingress"
    spec:
    endpointSelector:
    matchLabels:
    name: grc156cb
    ingress:
    - fromEndpoints:
    - matchLabels:
    name: 
    

*   åˆ›å»ºç­–ç•¥

    kubectl create -f nginx-dev-ingress0.yaml -n dev
    

*   ç¡®è®¤ç­–ç•¥

    $ kubectl get CiliumNetworkPolicy -A
    NAMESPACE   NAME                    AGE
    dev         nginx-dev-ingress0       85s
    

*   æµ‹è¯•æ•ˆæœ

![](https://static.goodrain.com/wechat/cilium/8.png)

![](https://static.goodrain.com/wechat/cilium/9.png)

*   è®¾ç½®å¼€å‘å›¢é˜Ÿå…è®¸æœ¬å›¢é˜Ÿä¸‹ç»„ä»¶è®¿é—®çš„åŒæ—¶ï¼Œå…è®¸å¼€å‘å›¢é˜Ÿä¸‹çš„ nginx-dev ç»„ä»¶è¢«æµ‹è¯•å›¢é˜Ÿä¸­ä»»æ„ç»„ä»¶è®¿é—®
    
    åœ¨è®¾ç½®äº†å›¢é˜Ÿç½‘ç»œéš”ç¦»çš„æƒ…å†µä¸‹ï¼Œæœ‰æ—¶å€™éœ€è¦ä¸´æ—¶å¼€æ”¾ä¸€äº›ç»„ä»¶ç»™å…¶å®ƒå›¢é˜Ÿè®¿é—®ä»¥ä¾¿è¿›è¡Œè°ƒè¯•ï¼Œä¸‹é¢ä»¥ nginx-dev ç»„ä»¶ä¸ºä¾‹è¯´æ˜å¦‚ä½•åœ¨è®¾ç½®ç½‘ç»œéš”ç¦»çš„æƒ…å†µä¸‹å¼€æ”¾å¤–éƒ¨å›¢é˜Ÿçš„è®¿é—®æƒé™ã€‚
    

![](https://static.goodrain.com/wechat/cilium/10.png)

*   Cilium ç½‘ç»œç­–ç•¥æ–‡ä»¶(nginx-dev-ingress1.yaml)

    apiVersion: "cilium.io/v2"
    kind: CiliumNetworkPolicy
    metadata:
    name: "nginx-dev-ingress1"
    spec:
    endpointSelector:
    matchLabels:
    name: grc156cb
    ingress:
    - fromEndpoints:
    - matchLabels:
    "k8s:io.kubernetes.pod.namespace": test
    

*   åˆ›å»ºç­–ç•¥

    kubectl create -f dev-ingress.yaml -n dev
    kubectl create -f nginx-dev-ingress.yaml -n dev
    

*   ç¡®è®¤ç­–ç•¥

    $ kubectl get CiliumNetworkPolicy -A
    NAMESPACE   NAME                    AGE
    dev         dev-namespace-ingress   19s
    dev         nginx-dev-ingress1      12s
    

*   æµ‹è¯•æ•ˆæœ

![](https://static.goodrain.com/wechat/cilium/11.png)

![](https://static.goodrain.com/wechat/cilium/12.png)