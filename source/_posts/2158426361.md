---
layout: post
title: "è®°ä¸€æ¬¡ .NET å·®æ—…ç®¡ç†åå° CPU çˆ†é«˜åˆ†æ"
date: "2022-07-02T06:21:33.440Z"
---
è®°ä¸€æ¬¡ .NET å·®æ—…ç®¡ç†åå° CPU çˆ†é«˜åˆ†æ
========================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰æ®µæ—¶é—´æœ‰ä½æœ‹å‹åœ¨å¾®ä¿¡ä¸Šæ‰¾åˆ°æˆ‘ï¼Œè¯´ä»–çš„ web ç³»ç»Ÿ cpu è¿è¡Œä¸€æ®µæ—¶å€™åå°±çˆ†é«˜äº†ï¼Œè®©æˆ‘å¸®å¿™çœ‹ä¸€ä¸‹æ˜¯æ€ä¹ˆå›äº‹ï¼Œé‚£å°±çœ‹å§ï¼Œå£°æ˜ä¸€ä¸‹ï¼Œæˆ‘çœ‹ dump æ˜¯å…è´¹çš„ï¼Œä¸»è¦æ˜¯é”¤ç‚¼è‡ªå·±æŠ€æœ¯ï¼Œæ²¡æœ‰æŸè½¯å·¥ç¨‹å¸ˆé«˜é¢çš„æŠ€æœ¯åˆ†æè´¹ã€‚ ğŸ˜…ğŸ˜…ğŸ˜…

é—²è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ä¸Š windbg è¯´è¯ã€‚

äºŒï¼šWinDbg åˆ†æ
-----------

### 1\. CPU çœŸçš„çˆ†é«˜å—

æ˜¯å¦çœŸçš„çˆ†é«˜ï¼Œæˆ‘ä»¬å¾—è‡ªå·±å…ˆéªŒè¯ä¸‹ï¼Œä½¿ç”¨ `!tp` å‘½ä»¤çœ‹ä¸€ä¸‹å³å¯ã€‚

    
    0:065> !tp
    CPU utilization: 81%
    Worker Thread: Total: 32 Running: 7 Idle: 25 MaxLimit: 8191 MinLimit: 32
    Work Request in Queue: 1
        AsyncTimerCallbackCompletion TimerInfo@018eedc8
    --------------------------------------
    Number of Timers: 1
    --------------------------------------
    Completion Port Thread:Total: 4 Free: 4 MaxFree: 64 CurrentLimit: 4 MaxLimit: 1000 MinLimit: 32
    
    

ä»å¦è±¡çœ‹ï¼Œç¡®å®å­˜åœ¨ CPU çˆ†é«˜çš„æƒ…å†µï¼Œæ ¹æ®è¿‡å¾€ç»éªŒï¼Œæ‰˜ç®¡ç¨‹åºçˆ†é«˜å¤§å¤šæ˜¯å› ä¸º`GC`è§¦å‘æ‰€è‡´ï¼Œä½†è§¦å‘ GC çš„åŸå› åƒå¥‡ç™¾æ€ªï¼Œæ¯•ç«Ÿåœ¨ clr å±‚é¢ GC è§¦å‘çš„åŸå› é«˜è¾¾ 14 ç§ï¼Œä»£ç å¦‚ä¸‹ï¼š

    
    static const char* const str_gc_reasons[] =
    {
        "alloc_soh",
        "induced",
        "lowmem",
        "empty",
        "alloc_loh",
        "oos_soh",
        "oos_loh",
        "induced_noforce",
        "gcstress",
        "induced_lowmem",
        "induced_compacting",
        "lowmemory_host",
        "pm_full_gc",
        "lowmemory_host_blocking"
    };
    
    

### 2\. çœŸçš„æ˜¯ GC è§¦å‘å—

éªŒè¯å½“å‰ç¨‹åºæ˜¯å¦ä¸º GC è§¦å‘ï¼Œæ–¹å¼æœ‰å¾ˆå¤šï¼Œå¯ä»¥ç”¨ `!t` æˆ–è€… `!t -special`ï¼Œä½†è¿™ä¸¤ç§æ–¹å¼ä¸æ˜¯ç‰¹åˆ«å‡†ï¼Œæœ€å‡†çš„å°±æ˜¯æ ¹æ®GCæ¨¡å¼ç›´æ¥åˆ° CLR é‡Œå»æœå…¨å±€å˜é‡ `clr!SVR::gc_heap::gc_started` çš„å€¼å°±å¯ä»¥äº†ï¼Œå‚è€ƒå¦‚ä¸‹ï¼š

    
    0:038> dp clr!SVR::gc_heap::gc_started L1
    712d3190  00000001
    
    

å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶çš„ `gc_started=1`ï¼Œè¯´æ˜ GC æ˜¯è§¦å‘çŠ¶æ€ï¼Œæ¥ä¸‹æ¥å¯ä»¥ä»æ‰€æœ‰çš„çº¿ç¨‹æ ˆä¸­æœ `garbage_collect` æˆ–è€… `gc1` ä»€ä¹ˆçš„å…³é”®è¯å³å¯ã€‚

    
    0:038> k
     # ChildEBP RetAddr      
    00 0318f934 70de8248     clr!SVR::gc_heap::relocate_survivor_helper+0x1ea
    01 0318f944 70de83df     clr!SVR::gc_heap::relocate_survivors_in_plug+0x24
    02 0318f970 70de84ac     clr!SVR::gc_heap::relocate_survivors_in_brick+0x70
    03 0318f9a8 70de830b     clr!SVR::gc_heap::relocate_survivors+0xe4
    04 0318fa00 70de218a     clr!SVR::gc_heap::relocate_phase+0xb9
    05 0318fbb4 70de18bf     clr!SVR::gc_heap::plan_phase+0x136e
    06 0318fbec 70de1d49     clr!SVR::gc_heap::gc1+0x101
    07 0318fc3c 70de1421     clr!SVR::gc_heap::garbage_collect+0x746
    08 0318fc58 70ddacde     clr!SVR::gc_heap::gc_thread_function+0x14a
    09 0318fc6c 70ddac6f     clr!SVR::gc_heap::gc_thread_stub+0x72
    0a 0318fc80 770a6a14     clr!GCThreadStub+0x1f
    0b 0318fc94 77e4a9ef     kernel32!BaseThreadInitThunk+0x24
    0c 0318fcdc 77e4a9ba     ntdll!__RtlUserThreadStart+0x2f
    0d 0318fcec 00000000     ntdll!_RtlUserThreadStart+0x1b
    
    

ä»å¦è±¡çœ‹ï¼Œ`gc_thread_stub` è¡¨ç¤ºå½“å‰æ˜¯ä¸€ä¸ª GC çº¿ç¨‹ï¼Œå®ƒæ­£åœ¨å¤„äº `relocate_phase` é˜¶æ®µï¼Œè¿™è¡¨æ˜å½“å‰æ˜¯ä¸€ä¸ª `å‹ç¼©å›æ”¶`ï¼ŒGCå›æ”¶æµç¨‹å›¾å¯ä»¥çœ‹ä¸‹å®˜æ–¹æ–‡æ¡£ã€‚

    
        GarbageCollectGeneration()
        {
            SuspendEE();
            garbage_collect();
            RestartEE();
        }
        
        garbage_collect()
        {
            generation_to_condemn();
            gc1();
        }
        
        gc1()
        {
            mark_phase();
            plan_phase();
        }
        
        plan_phase()
        {
            // actual plan phase work to decide to 
            // compact or not
            if (compact)
            {
                relocate_phase();
                compact_phase();
            }
            else
                make_free_lists();
        }
    
    

åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ‰˜ç®¡å †ä¹Ÿä¼šæ˜¯æŸåçŠ¶æ€ï¼Œä½ å¯ä»¥ç”¨ `!dumpheap -stat` éªŒè¯ä¸‹ã€‚

    
    0:038> !dumpheap -stat
    The garbage collector data structures are not in a valid state for traversal.
    It is either in the "plan phase," where objects are being moved around, or
    we are at the initialization or shutdown of the gc heap. Commands related to 
    displaying, finding or traversing objects as well as gc heap segments may not 
    work properly. !dumpheap and !verifyheap may incorrectly complain of heap 
    consistency errors.
    Object <exec cmd="!ListNearObj /d 03301000">03301000</exec> has an invalid method table.
    
    

### 3\. ä¸ºä»€ä¹ˆä¼šå‡ºç°å‹ç¼©å›æ”¶

ä¸€èˆ¬æ¥è¯´ï¼ŒGC åˆ†æ¸…é™¤å’Œå‹ç¼©å›æ”¶ï¼Œåè€…å±äºä¸€ç§é‡é‡çº§æ“ä½œï¼Œå¾ˆä¼¤GCï¼Œåœ¨ä¸´æ—¶æ®µä¸Šè¿˜ç¨å¾®å¥½ä¸€äº›ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹å½“å‰ GC æ˜¯åœ¨å›æ”¶å“ªä¸€ä»£ï¼Ÿå¯ä»¥åˆ° CLR é‡Œé¢å»æŸ¥ä¸€ä¸‹åˆ¤å†³ä»£å­—æ®µã€‚`clr!WKS::GCHeap::GcCondemnedGeneration`ã€‚

    
    0:038> dp clr!SVR::GCHeap::GcCondemnedGeneration L1
    712d79d8  00000002
    
    

ç³Ÿäº†ï¼Œç»“æœæ˜¯ä¸ª 2ï¼Œè¿™ä¸ª 2 è¡¨ç¤º `fullGC`, ä¹Ÿå°±æ˜¯å…¨é‡å›æ”¶ï¼Œå¤§å¤šå¯¹åº”ç€ `gc_reason=lowmem` çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å†…å­˜ä¸è¶³ã€‚

### 4\. çœŸçš„å†…å­˜ä¸è¶³å—

è¦æƒ³æ‰¾åˆ°ç­”æ¡ˆï¼Œæˆ‘ä»¬ç”¨ `!address -summary` çœ‹ä¸‹å½“å‰çš„è™šæ‹Ÿå†…å­˜æƒ…å†µã€‚

    
    0:038> !address -summary
    
    --- Usage Summary ---------------- RgnCount ----------- Total Size -------- %ofBusy %ofTotal
    <unknown>                              1835          dce6e000 (   3.452 GB)  91.56%   86.29%
    Image                                   842           f436000 ( 244.211 MB)   6.33%    5.96%
    Free                                    312           eba5000 ( 235.645 MB)            5.75%
    Stack                                   451           2d80000 (  45.500 MB)   1.18%    1.11%
    Heap                                     72           2342000 (  35.258 MB)   0.91%    0.86%
    TEB                                     150             96000 ( 600.000 kB)   0.02%    0.01%
    Other                                     7             4e000 ( 312.000 kB)   0.01%    0.01%
    PEB                                       1              1000 (   4.000 kB)   0.00%    0.00%
    
    --- Type Summary (for busy) ------ RgnCount ----------- Total Size -------- %ofBusy %ofTotal
    MEM_PRIVATE                            2051          dd635000 (   3.459 GB)  91.76%   86.48%
    MEM_IMAGE                              1267          11ad1000 ( 282.816 MB)   7.33%    6.90%
    MEM_MAPPED                               40           2345000 (  35.270 MB)   0.91%    0.86%
    
    --- State Summary ---------------- RgnCount ----------- Total Size -------- %ofBusy %ofTotal
    MEM_COMMIT                             2604          cbe7d000 (   3.186 GB)  84.51%   79.65%
    MEM_RESERVE                             754          255ce000 ( 597.805 MB)  15.49%   14.60%
    MEM_FREE                                312           eba5000 ( 235.645 MB)            5.75%
    
    --- Largest Region by Usage ----------- Base Address -------- Region Size ----------
    <unknown>                                    3300000          20087000 ( 512.527 MB)
    Image                                       6f819000            f5f000 (  15.371 MB)
    Free                                        fea50000           1590000 (  21.562 MB)
    Stack                                        3110000             7a000 ( 488.000 kB)
    Heap                                        3bc80000            621000 (   6.129 MB)
    TEB                                         fe6e5000              1000 (   4.000 kB)
    Other                                       fea10000             33000 ( 204.000 kB)
    PEB                                         fea49000              1000 (   4.000 kB)
    
    

ä»å¦è±¡çœ‹ï¼Œå½“å‰çš„ `MEM_COMMIT=3.186G`ï¼Œ æœ€å¤§çš„Freeå— `Free=15.371MB`ï¼Œå†æ ¹æ®ä¹‹å‰å±•ç¤ºçš„å†…å­˜åœ°å€ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸ªç¨‹åºæ˜¯ 32bit ï¼Œè·‘äº† 64bit æœºå™¨ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹ç¨‹åºæœ€å¤šå¯å ç”¨ `4G` å†…å­˜ç©ºé—´ï¼Œè™½ç„¶ `MEM_RESERVE= 597.805 MB`, ä½†è¿™ç§ `RESERVE` æ˜¯é›¶æ•£çš„ï¼Œæœ¬è´¨ä¸Šæ¥è¯´æ­¤æ—¶çš„ç¨‹åºå¤„äº**è™šæ‹Ÿåœ°å€ç´§å¼ **ï¼Œç”±äº è™šæ‹Ÿåœ°å€ ç´§å¼ ï¼Œå¯¼è‡´ GC åœ¨ä¸æ–­çš„åš å…¨é‡å†…å­˜ å›æ”¶ã€‚

ä¸‰ï¼šæ€»ç»“
----

æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œ GC è§¦å‘çš„åŸå› ä¸»è¦è¿˜æ˜¯ 32bit ç¨‹åºçš„ 4G å†…å­˜é™åˆ¶æ‰€è‡´ï¼Œ å¯¼è‡´ GC åœ¨ä¸åœçš„åšå…¨é‡å›æ”¶ï¼Œè¿™ç§åœºæ™¯çœŸçš„è®© GC å¾ˆå°´å°¬ï¼Œä¼˜å…ˆè§£å†³åŠæ³•å°±æ˜¯å°†ç¨‹åºæ”¹æˆ 64bitï¼Œåé¢å†çœ‹çœ‹å¦‚ä½•ä¼˜åŒ–ç¨‹åºå†…å­˜ï¼Œæ¯•ç«Ÿç°åœ¨`æ‰˜ç®¡å †`å¤„äºæŸåçŠ¶æ€ï¼Œä¹Ÿä¸å¥½åˆ†æå•¦ã€‚  
![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)