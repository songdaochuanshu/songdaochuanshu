---
layout: post
title: "Semantic Kernel å…¥é—¨ç³»åˆ—ï¼šğŸ¥‘Memoryå†…å­˜"
date: "2023-04-14T01:05:52.850Z"
---
Semantic Kernel å…¥é—¨ç³»åˆ—ï¼šğŸ¥‘Memoryå†…å­˜
===============================

Memoryè‡ªç„¶æ˜¯è¶Šå¤§è¶Šå¥½ã€‚

![image](https://img2023.cnblogs.com/blog/758442/202304/758442-20230413225351922-1745816324.png)

äº†è§£çš„[è¿ä½œåŸç†](https://www.cnblogs.com/xbotter/p/semantic_kernel_introduction_memory_part_1.html)ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹ä½¿ç”¨Semantic Kernelæ¥åˆ¶ä½œåº”ç”¨äº†ã€‚

Semantic Kernelå°†embeddingçš„åŠŸèƒ½å°è£…åˆ°äº†Memoryä¸­ï¼Œç”¨æ¥å­˜å‚¨ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå°±å¥½åƒç”µè„‘çš„å†…å­˜ä¸€æ ·ï¼Œè€ŒLLMå°±åƒæ˜¯CPUä¸€æ ·ï¼Œæˆ‘ä»¬æ‰€éœ€è¦åšçš„å°±æ˜¯ä»å†…å­˜ä¸­å–å‡ºç›¸å…³çš„ä¿¡æ¯äº¤ç»™CPUå¤„ç†å°±å¥½äº†ã€‚

å†…å­˜é…ç½®
----

ä½¿ç”¨Memoryéœ€è¦æ³¨å†Œ `embedding`æ¨¡å‹ï¼Œç›®å‰ä½¿ç”¨çš„å°±æ˜¯ `text-embedding-ada-002`ã€‚åŒæ—¶éœ€è¦ä¸ºKernelæ·»åŠ MemoryStoreï¼Œç”¨äºå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼Œè¿™é‡ŒSemantic Kernelæä¾›äº†ä¸€ä¸ª `VolatileMemoryStore`ï¼Œå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„å†…å­˜å­˜å‚¨çš„MemoryStoreã€‚

    var kernel = Kernel.Builder.Configure(c =>
    {
    	c.AddOpenAITextCompletionService("openai", "text-davinci-003", Environment.GetEnvironmentVariable("MY_OPEN_AI_API_KEY"));
    	c.AddOpenAIEmbeddingGenerationService("openai", "text-embedding-ada-002", Environment.GetEnvironmentVariable("MY_OPEN_AI_API_KEY"));
    })
    .WithMemoryStorage(new VolatileMemoryStore())
    .Build();
    

ä¿¡æ¯å­˜å‚¨
----

å®Œæˆäº†åŸºç¡€ä¿¡æ¯çš„æ³¨å†Œåï¼Œå°±å¯ä»¥å¾€Memroyä¸­å­˜å‚¨ä¿¡æ¯äº†ã€‚

    const string MemoryCollectionName = "aboutMe";
    
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info1", text: "My name is Andrea");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info2", text: "I currently work as a tourist operator");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info3", text: "I currently live in Seattle and have been living there since 2005");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info4", text: "I visited France and Italy five times since 2015");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info5", text: "My family is from New York");
    

`SaveInformationAsync` ä¼šå°†textçš„å†…å®¹é€šè¿‡ `embedding` æ¨¡å‹è½¬åŒ–ä¸ºå¯¹åº”çš„æ–‡æœ¬å‘é‡ï¼Œå­˜æ”¾åœ¨çš„MemoryStoreä¸­ã€‚å…¶ä¸­CollectionNameå¦‚åŒæ•°æ®åº“çš„è¡¨åï¼ŒIdå°±æ˜¯Idã€‚

è¯­ä¹‰æœç´¢
----

å®Œæˆä¿¡æ¯çš„å­˜å‚¨ä¹‹åï¼Œå°±å¯ä»¥ç”¨æ¥è¯­ä¹‰æœç´¢äº†ã€‚

ç›´æ¥ä½¿ç”¨`Memory.SearchAsync`æ–¹æ³•ï¼ŒæŒ‡å®šå¯¹åº”çš„Collectionï¼ŒåŒæ—¶æä¾›ç›¸åº”çš„æŸ¥è¯¢é—®é¢˜ï¼ŒæŸ¥è¯¢é—®é¢˜ä¹Ÿä¼šè¢«è½¬åŒ–ä¸ºembeddingï¼Œå†åœ¨MemoryStoreä¸­è®¡ç®—æŸ¥æ‰¾æœ€ç›¸ä¼¼çš„ä¿¡æ¯ã€‚

    var questions = new[]
    {
    	"what is my name?",
    	"where do I live?",
    	"where is my family from?",
    	"where have I travelled?",
    	"what do I do for work?",
    };
    
    foreach (var q in questions)
    {
    	var response = await kernel.Memory.SearchAsync(MemoryCollectionName, q).FirstOrDefaultAsync();
    	Console.WriteLine(q + " " + response?.Metadata.Text);
    }
    
    // output
    /*
    what is my name? My name is Andrea
    where do I live? I currently live in Seattle and have been living there since 2005
    where is my family from? My family is from New York
    where have I travelled? I visited France and Italy five times since 2015
    what do I do for work? I currently work as a tourist operator
    */
    

åˆ°è¿™ä¸ªæ—¶å€™ï¼Œå³ä¾¿ä¸éœ€è¦è¿›è¡Œæ€»ç»“å½’çº³ï¼Œå…‰æ˜¯è¿™æ ·çš„è¯­ä¹‰æŸ¥æ‰¾ï¼Œéƒ½ä¼šå¾ˆæœ‰ä»·å€¼ã€‚

å¼•ç”¨å­˜å‚¨
----

é™¤äº†æ·»åŠ ä¿¡æ¯ä»¥å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ å¼•ç”¨ï¼Œåƒæ˜¯éå¸¸æœ‰ç”¨çš„å‚è€ƒé“¾æ¥ä¹‹ç±»çš„ã€‚

    const string memoryCollectionName = "SKGitHub";
    
    var githubFiles = new Dictionary<string, string>()
    {
    	["https://github.com/microsoft/semantic-kernel/blob/main/README.md"]
    		= "README: Installation, getting started, and how to contribute",
    	["https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/2-running-prompts-from-file.ipynb"]
    		= "Jupyter notebook describing how to pass prompts from a file to a semantic skill or function",
    	["https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/Getting-Started-Notebook.ipynb"]
    		= "Jupyter notebook describing how to get started with the Semantic Kernel",
    	["https://github.com/microsoft/semantic-kernel/tree/main/samples/skills/ChatSkill/ChatGPT"]
    		= "Sample demonstrating how to create a chat skill interfacing with ChatGPT",
    	["https://github.com/microsoft/semantic-kernel/blob/main/dotnet/src/SemanticKernel/Memory/Volatile/VolatileMemoryStore.cs"]
    		= "C# class that defines a volatile embedding store",
    	["https://github.com/microsoft/semantic-kernel/tree/main/samples/dotnet/KernelHttpServer/README.md"]
    		= "README: How to set up a Semantic Kernel Service API using Azure Function Runtime v4",
    	["https://github.com/microsoft/semantic-kernel/tree/main/samples/apps/chat-summary-webapp-react/README.md"]
    		= "README: README associated with a sample starter react-based chat summary webapp",
    };
    foreach (var entry in githubFiles)
    {
    	await kernel.Memory.SaveReferenceAsync(
    		collection: memoryCollectionName,
    		description: entry.Value,
    		text: entry.Value,
    		externalId: entry.Key,
    		externalSourceName: "GitHub"
    	);
    }
    

åŒæ ·çš„ï¼Œä½¿ç”¨SearchAsyncæœç´¢å°±è¡Œã€‚

    string ask = "I love Jupyter notebooks, how should I get started?";
    Console.WriteLine("===========================\n" +
    					"Query: " + ask + "\n");
    
    var memories = kernel.Memory.SearchAsync(memoryCollectionName, ask, limit: 5, minRelevanceScore: 0.77);
    var i = 0;
    await foreach (MemoryQueryResult memory in memories)
    {
    	Console.WriteLine($"Result {++i}:");
    	Console.WriteLine("  URL:     : " + memory.Metadata.Id);
    	Console.WriteLine("  Title    : " + memory.Metadata.Description);
    	Console.WriteLine("  ExternalSource: " + memory.Metadata.ExternalSourceName);
    	Console.WriteLine("  Relevance: " + memory.Relevance);
    	Console.WriteLine();
    }
    //output
    /*
    ===========================
    Query: I love Jupyter notebooks, how should I get started?
    
    Result 1:
      URL:     : https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/Getting-Started-Notebook.ipynb
      Title    : Jupyter notebook describing how to get started with the Semantic Kernel
      ExternalSource: GitHub
      Relevance: 0.8677381632778319
    
    Result 2:
      URL:     : https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/2-running-prompts-from-file.ipynb
      Title    : Jupyter notebook describing how to pass prompts from a file to a semantic skill or function
      ExternalSource: GitHub
      Relevance: 0.8162989178955157
    
    Result 3:
      URL:     : https://github.com/microsoft/semantic-kernel/blob/main/README.md
      Title    : README: Installation, getting started, and how to contribute
      ExternalSource: GitHub
      Relevance: 0.8083238591883483
    */
    

è¿™é‡Œå¤šä½¿ç”¨äº†ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯limitï¼Œç”¨äºé™åˆ¶è¿”å›ä¿¡æ¯çš„æ¡æ•°,åªè¿”å›æœ€ç›¸ä¼¼çš„å‰å‡ æ¡æ•°æ®ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯minRelevanceScoreï¼Œé™åˆ¶æœ€å°çš„ç›¸å…³åº¦åˆ†æ•°ï¼Œè¿™ä¸ªå–å€¼èŒƒå›´åœ¨0.0 ~ 1.0 ä¹‹é—´ï¼Œ1.0æ„å‘³ç€å®Œå…¨åŒ¹é…ã€‚

è¯­ä¹‰é—®ç­”
----

å°†Memoryçš„å­˜å‚¨ã€æœç´¢åŠŸèƒ½å’Œè¯­ä¹‰æŠ€èƒ½ç›¸ç»“åˆï¼Œå°±å¯ä»¥å¿«é€Ÿçš„æ‰“é€ ä¸€ä¸ªå®ç”¨çš„è¯­ä¹‰é—®ç­”çš„åº”ç”¨äº†ã€‚

åªéœ€è¦å°†æœç´¢åˆ°çš„ç›¸å…³ä¿¡æ¯å†…å®¹å¡«å……åˆ° promptä¸­ï¼Œç„¶åå°†å†…å®¹å’Œé—®é¢˜éƒ½æŠ›ç»™LLMï¼Œå°±å¯ä»¥ç­‰ç€å¾—åˆ°ä¸€ä¸ªæ»¡æ„çš„ç­”æ¡ˆäº†ã€‚

    const string MemoryCollectionName = "aboutMe";
    
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info1", text: "My name is Andrea");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info2", text: "I currently work as a tourist operator");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info3", text: "I currently live in Seattle and have been living there since 2005");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info4", text: "I visited France and Italy five times since 2015");
    await kernel.Memory.SaveInformationAsync(MemoryCollectionName, id: "info5", text: "My family is from New York");
    
    var prompt = 
    """
    It can give explicit instructions or say 'I don't know' if it does not have an answer.
    
    Information about me, from previous conversations:
    {{ $fact }}
    
    User: {{ $ask }}
    ChatBot:
    """;
    
    var skill = kernel.CreateSemanticFunction(prompt);
    var ask = "Hello, I think we've met before, remember? my name is...";
    var fact = await kernel.Memory.SearchAsync(MemoryCollectionName,ask).FirstOrDefaultAsync();
    var context = kernel.CreateNewContext();
    context["fact"] = fact?.Metadata?.Text;
    context["ask"] = ask;
    
    var resultContext =await skill.InvokeAsync(context);
    resultContext.Result.Dump();
    
    //output
    /*
    Hi there! Yes, I remember you. Your name is Andrea, right?
    */
    
    

ä¼˜åŒ–æœç´¢è¿‡ç¨‹
------

ç”±äºè¿™ç§åœºæ™¯å¤ªå¸¸è§äº†ï¼Œæ‰€ä»¥Semantic Kernelä¸­ç›´æ¥æä¾›äº†ä¸€ä¸ªæŠ€èƒ½TextMemorySkillï¼Œé€šè¿‡Functionè°ƒç”¨çš„æ–¹å¼ç®€åŒ–äº†æœç´¢çš„è¿‡ç¨‹ã€‚

    // .. SaveInformations 
    
    // TextMemorySkill provides the "recall" function
    kernel.ImportSkill(new TextMemorySkill());
    
    var prompt = 
    """
    It can give explicit instructions or say 'I don't know' if it does not have an answer.
    
    Information about me, from previous conversations:
    {{ recall $ask }}
    
    User: {{ $ask }}
    ChatBot:
    """;
    
    var skill = kernel.CreateSemanticFunction(prompt);
    var ask = "Hello, I think we've met before, remember? my name is...";
    
    var context = kernel.CreateNewContext();
    context["ask"] = ask;
    context[TextMemorySkill.CollectionParam] = MemoryCollectionName;
    
    var resultContext =await skill.InvokeAsync(context);
    resultContext.Result.Dump();
    // output
    /*
    Hi there! Yes, I remember you. Your name is Andrea, right?
    */
    

è¿™é‡Œç›´æ¥ä½¿ç”¨ recall æ–¹æ³•ï¼Œå°†é—®é¢˜ä¼ ç»™äº† TextMemorySkillï¼Œæœç´¢å¯¹åº”å¾—åˆ°ç»“æœï¼Œå…å»äº†æ‰‹åŠ¨æœç´¢æ³¨å…¥å¾—è¿‡ç¨‹ã€‚

å†…å­˜çš„æŒä¹…åŒ–
------

`VolatileMemoryStore`æœ¬èº«ä¹Ÿæ˜¯æ˜“ä¸¢å¤±çš„ï¼Œå¾€å¾€ä½¿ç”¨åˆ°å†…å­˜çš„åœºæ™¯ï¼Œå…¶ä¸­çš„ä¿¡æ¯éƒ½æ˜¯æœ‰å¯èƒ½é•¿æœŸå­˜å‚¨çš„ï¼Œèµ·ç å¹¶ä¸ä¼šå³åˆ»è¿‡æœŸã€‚é‚£ä¹ˆå°†è¿™äº›ä¿¡æ¯çš„ `embedding` èƒ½å¤Ÿé•¿æœŸå­˜å‚¨èµ·æ¥ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒåˆ’ç®—çš„äº‹æƒ…ã€‚æ¯•ç«Ÿæ¯ä¸€æ¬¡åš embeddingçš„è½¬åŒ–ä¹Ÿæ˜¯éœ€è¦è°ƒæ¥å£ï¼Œéœ€è¦èŠ±é’±çš„ã€‚

Semantic Kernelåº“ä¸­åŒ…å«äº†SQLiteã€Qdrantå’ŒCosmosDBçš„å®ç°ï¼Œè‡ªè¡Œæ‰©å±•çš„è¯ï¼Œä¹Ÿåªéœ€è¦å®ç° `IMemoryStore` è¿™ä¸ªæ¥å£å°±å¯ä»¥äº†ã€‚

è‡³äºæœªæ¥ï¼Œå¯èƒ½å°±æ˜¯ä¸“ç”¨çš„ `Vector Database` äº†ã€‚

* * *

å‚è€ƒèµ„æ–™ï¼š

1.  [https://learn.microsoft.com/en-us/semantic-kernel/concepts-sk/memories](https://learn.microsoft.com/en-us/semantic-kernel/concepts-sk/memories)
2.  [https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/6-memory-and-embeddings.ipynb](https://github.com/microsoft/semantic-kernel/blob/main/samples/notebooks/dotnet/6-memory-and-embeddings.ipynb)
3.  [https://github.com/johnmaeda/SK-Recipes/blob/main/e4-memories/notebook.ipynb](https://github.com/johnmaeda/SK-Recipes/blob/main/e4-memories/notebook.ipynb)
4.  [https://learn.microsoft.com/en-us/semantic-kernel/concepts-ai/vectordb](https://learn.microsoft.com/en-us/semantic-kernel/concepts-ai/vectordb)