---
layout: post
title: "åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šé€»è¾‘å›žå½’çš„å¹¶è¡ŒåŒ–å®žçŽ°ï¼ˆPySparkï¼‰"
date: "2022-05-27T17:23:37.686Z"
---
åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šé€»è¾‘å›žå½’çš„å¹¶è¡ŒåŒ–å®žçŽ°ï¼ˆPySparkï¼‰
===========================

![åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šé€»è¾‘å›žå½’çš„å¹¶è¡ŒåŒ–å®žçŽ°ï¼ˆPySparkï¼‰](https://img2022.cnblogs.com/blog/1784958/202205/1784958-20220527190018640-2133222528.png) é€»è¾‘å›žå½’çš„ç›®æ ‡å‡½æ•°å¸¸é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ±‚è§£ï¼Œè¯¥ç®—æ³•çš„å¹¶è¡ŒåŒ–å¯ä»¥é‡‡ç”¨Map-Reduceæž¶æž„ã€‚å…ˆå°†ç¬¬ð‘¡tè½®è¿­ä»£çš„æƒé‡å¹¿æ’­åˆ°å„workerï¼Œå„workerè®¡ç®—ä¸€ä¸ªå±€éƒ¨æ¢¯åº¦ï¼ˆmapè¿‡ç¨‹ï¼‰ï¼Œç„¶åŽå†å°†æ¯ä¸ªèŠ‚ç‚¹çš„æ¢¯åº¦èšåˆï¼ˆreduceè¿‡ç¨‹ï¼‰ï¼Œæœ€ç»ˆå¯¹å‚æ•°è¿›è¡Œæ›´æ–°ã€‚åœ¨Sparkä¸­æ¯ä¸ªtaskå¯¹åº”ä¸€ä¸ªåˆ†åŒºï¼Œå†³å®šäº†è®¡ç®—çš„å¹¶è¡Œåº¦ã€‚åœ¨Sparkçš„å®žçŽ°è¿‡ç¨‹ä¸­ï¼Œmapé˜¶æ®µå„taskè¿è¡Œmap()å‡½æ•°å¯¹æ¯ä¸ªæ ·æœ¬(ð‘¥ð‘–,ð‘¦ð‘–)è®¡ç®—æ¢¯åº¦ð‘”ð‘–ï¼Œ ç„¶åŽå¯¹æ¯ä¸ªæ ·æœ¬å¯¹åº”çš„æ¢¯åº¦è¿è¡Œè¿›è¡Œæœ¬åœ°èšåˆï¼Œä»¥å‡å°‘åŽé¢çš„æ•°æ®ä¼ è¾“é‡ã€‚

1\. æ¢¯åº¦è®¡ç®—å¼å¯¼å‡º
-----------

æˆ‘ä»¬åœ¨åšå®¢[ã€Šç»Ÿè®¡å­¦ä¹ ï¼šé€»è¾‘å›žå½’ä¸Žäº¤å‰ç†µæŸå¤±ï¼ˆPytorchå®žçŽ°ï¼‰ã€‹](https://www.cnblogs.com/orion-orion/p/15891850.html)ä¸­æåˆ°ï¼Œè®¾\\(w\\)ä¸ºæƒå€¼(æœ€åŽä¸€ç»´ä¸ºåç½®)ï¼Œæ ·æœ¬æ€»æ•°ä¸º\\(N\\)ï¼Œ\\(\\{(x\_i, y\_i)\\}\_{i=1}^N\\)ä¸ºè®­ç»ƒæ ·æœ¬é›†ã€‚æ ·æœ¬ç»´åº¦ä¸º\\(D\\)ï¼Œ\\(x\_i\\in \\mathbb{R}^{D+1}\\)ï¼ˆæœ€åŽä¸€ç»´æ‰©å……ï¼‰ï¼Œ\\(y\_i\\in\\{0, 1\\}\\)ã€‚åˆ™é€»è¾‘å›žå½’çš„æŸå¤±å‡½æ•°ä¸ºï¼š

\\\[\\mathcal{l}(w) = \\sum\_{i=1}^{N}\\left\[y\_{i} \\log \\pi\_{w}\\left(x\_{i}\\right)+\\left(1-y\_{i}\\right) \\log \\left(1-\\pi\_w\\left(x\_{i}\\right)\\right)\\right\] \\\]

è¿™é‡Œ

\\\[\\begin{aligned} \\pi\_w(x) = p(y=1 \\mid x; w) =\\frac{1}{1+\\exp \\left(-w^{T} x\\right)} \\end{aligned} \\\]

å†™æˆè¿™ä¸ªå½¢å¼å°±å·²ç»å¯ä»¥ç”¨è¯¸å¦‚Pytorchè¿™ç±»å·¥å…·æ¥è¿›è¡Œè‡ªåŠ¨æ±‚å¯¼ç„¶åŽé‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ±‚è§£äº†ã€‚ä¸è¿‡è‹¥éœ€è¦ç”¨è¡¨è¾¾å¼ç›´æŽ¥è®¡ç®—å‡ºæ¢¯åº¦ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†æŸå¤±å‡½æ•°ç»§ç»­åŒ–ç®€ä¸ºï¼š

\\\[\\mathcal{l}(w) = -\\sum\_{i=1}^N(y\_i w^T x\_i - \\log(1 + \\exp(w^T x\_i))) \\\]

å¯å°†æ¢¯åº¦è¡¨ç¤ºå¦‚ä¸‹ï¼š

\\\[\\nabla\_w{\\mathcal{l}(w)} = -\\sum\_{i=1}^N(y\_i - \\frac{1}{\\exp(-w^Tx)+1})x\_i \\\]

2\. åŸºäºŽSparkçš„å¹¶è¡ŒåŒ–å®žçŽ°
-----------------

é€»è¾‘å›žå½’çš„ç›®æ ‡å‡½æ•°å¸¸é‡‡ç”¨æ¢¯åº¦ä¸‹é™æ³•æ±‚è§£ï¼Œè¯¥ç®—æ³•çš„å¹¶è¡ŒåŒ–å¯ä»¥é‡‡ç”¨å¦‚ä¸‹çš„Map-Reduceæž¶æž„ï¼š

![](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2074226/o_220225103222_%E5%90%8C%E6%AD%A5%E6%A2%AF%E5%BA%A6%E6%B1%82%E5%92%8C%E7%AE%97%E6%B3%95.png)

å…ˆå°†ç¬¬\\(t\\)è½®è¿­ä»£çš„æƒé‡å¹¿æ’­åˆ°å„workerï¼Œå„workerè®¡ç®—ä¸€ä¸ªå±€éƒ¨æ¢¯åº¦ï¼ˆmapè¿‡ç¨‹ï¼‰ï¼Œç„¶åŽå†å°†æ¯ä¸ªèŠ‚ç‚¹çš„æ¢¯åº¦èšåˆï¼ˆreduceè¿‡ç¨‹ï¼‰ï¼Œæœ€ç»ˆå¯¹å‚æ•°è¿›è¡Œæ›´æ–°ã€‚

åœ¨Sparkä¸­æ¯ä¸ªtaskå¯¹åº”ä¸€ä¸ªåˆ†åŒºï¼Œå†³å®šäº†è®¡ç®—çš„å¹¶è¡Œåº¦(åˆ†åŒºçš„æ¦‚å¿µè¯¦é—´æˆ‘ä»¬ä¸Šä¸€ç¯‡åšå®¢[ã€ŠSpark: å•è¯è®¡æ•°(Word Count)çš„MapReduceå®žçŽ°(Java/Python)ã€‹](https://www.cnblogs.com/orion-orion/p/16314837.html) )ã€‚åœ¨Sparkçš„å®žçŽ°è¿‡ç¨‹å¦‚ä¸‹ï¼š

*   **map**é˜¶æ®µï¼š å„taskè¿è¡Œ`map()`å‡½æ•°å¯¹æ¯ä¸ªæ ·æœ¬\\((x\_i, y\_i)\\)è®¡ç®—æ¢¯åº¦\\(g\_i\\)ï¼Œ ç„¶åŽå¯¹æ¯ä¸ªæ ·æœ¬å¯¹åº”çš„æ¢¯åº¦è¿è¡Œè¿›è¡Œæœ¬åœ°èšåˆï¼Œä»¥å‡å°‘åŽé¢çš„æ•°æ®ä¼ è¾“é‡ã€‚å¦‚ç¬¬1ä¸ªtaskæ‰§è¡Œ`reduce()`æ“ä½œå¾—åˆ°\\(\\widetilde{g}\_1 = \\sum\_{i=1}^3 g\_i\\) å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
    
*   **reduce**é˜¶æ®µï¼šä½¿ç”¨`reduce()`å°†æ‰€æœ‰taskçš„è®¡ç®—ç»“æžœæ”¶é›†åˆ°Driverç«¯è¿›è¡Œèšåˆï¼Œç„¶åŽè¿›è¡Œå‚æ•°æ›´æ–°ã€‚
    

![](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2074226/o_4365badd.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œè®­ç»ƒæ•°æ®ç”¨`points:PrallelCollectionRDD`æ¥è¡¨ç¤ºï¼Œå‚æ•°å‘é‡ç”¨\\(w\\)æ¥è¡¨ç¤ºï¼Œæ³¨æ„å‚æ•°å‘é‡ä¸æ˜¯RDDï¼Œåªæ˜¯ä¸€ä¸ªå•ç‹¬çš„å‚ä¸Žè¿ç®—çš„å˜é‡ã€‚

æ­¤å¤–éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œè™½ç„¶æ¯ä¸ªtaskåœ¨æœ¬åœ°è¿›è¡Œäº†å±€éƒ¨èšåˆï¼Œä½†å¦‚æžœtaskè¿‡å¤šä¸”æ¯ä¸ªtaskæœ¬åœ°èšåˆåŽçš„ç»“æžœï¼ˆå•ä¸ªgradientï¼‰è¿‡å¤§é‚£ä¹ˆç»Ÿä¸€ä¼ é€’åˆ°Driverç«¯ä»ç„¶ä¼šé€ æˆå•ç‚¹çš„ç½‘ç»œå¹³å‡ç­‰é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSparkè®¾è®¡äº†æ€§èƒ½æ›´å¥½çš„`treeAggregate()`æ“ä½œï¼Œä½¿ç”¨æ ‘å½¢èšåˆæ–¹æ³•æ¥å‡å°‘ç½‘ç»œå’Œè®¡ç®—å»¶è¿Ÿã€‚

3\. PySparkå®žçŽ°ä»£ç 
---------------

PySparkçš„å®Œæ•´å®žçŽ°ä»£ç å¦‚ä¸‹ï¼š

    from sklearn.datasets import load_breast_cancer
    import numpy as np
    from pyspark.sql import SparkSession
    from operator import add
    from sklearn.model_selection import train_test_split
    from sklearn.metrics import accuracy_score
    
    n_slices = 3  # Number of Slices
    n_iterations = 300  # Number of iterations
    alpha = 0.01  # iteration step_size
    
    
    def logistic_f(x, w):
        return 1 / (np.exp(-x.dot(w)) + 1)
    
    
    def gradient(point: np.ndarray, w: np.ndarray) -> np.ndarray:
        """ Compute linear regression gradient for a matrix of data points
        """
        y = point[-1]    # point label
        x = point[:-1]   # point coordinate
        # For each point (x, y), compute gradient function, then sum these up
        return - (y - logistic_f(x, w)) * x
    
    
    if __name__ == "__main__":
    
        X, y = load_breast_cancer(return_X_y=True)
    
        D = X.shape[1]
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.3, random_state=0)
        n_train, n_test = X_train.shape[0], X_test.shape[0]
    
        spark = SparkSession\
            .builder\
            .appName("Logistic Regression")\
            .getOrCreate()
    
        matrix = np.concatenate(
            [X_train, np.ones((n_train, 1)), y_train.reshape(-1, 1)], axis=1)
    
        points = spark.sparkContext.parallelize(matrix, n_slices).cache()
    
        # Initialize w to a random value
        w = 2 * np.random.ranf(size=D + 1) - 1
        print("Initial w: " + str(w))
    
        for t in range(n_iterations):
            print("On iteration %d" % (t + 1))
            g = points.map(lambda point: gradient(point, w)).reduce(add)
            w -= alpha * g
    
            y_pred = logistic_f(np.concatenate(
                [X_test, np.ones((n_test, 1))], axis=1), w)
            pred_label = np.where(y_pred < 0.5, 0, 1)
            acc = accuracy_score(y_test, pred_label)
            print("iterations: %d, accuracy: %f" % (t, acc))
    
        print("Final w: %s " % w)
        print("Final acc: %f" % acc)
    
        spark.stop()
    

æ³¨æ„`spark.sparkContext.parallelize(matrix, n_slices)`ä¸­çš„`n_slices`å°±æ˜¯Sparkä¸­çš„åˆ†åŒºæ•°ã€‚æˆ‘ä»¬åœ¨ä»£ç ä¸­é‡‡ç”¨breast canceræ•°æ®é›†è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•ï¼Œè¯¥æ•°æ®é›†æ˜¯ä¸ªäºŒåˆ†ç±»æ•°æ®é›†ã€‚æ¨¡åž‹åˆå§‹æƒé‡é‡‡ç”¨éšæœºåˆå§‹åŒ–ã€‚

æœ€åŽï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç®—æ³•çš„è¾“å‡ºç»“æžœã€‚

åˆå§‹æƒé‡å¦‚ä¸‹ï¼š

    Initial w: [-0.0575882   0.79680833  0.96928013  0.98983501 -0.59487909 -0.23279241
     -0.34157571  0.93084048 -0.10126002  0.19124314  0.7163746  -0.49597826
     -0.50197367  0.81784642  0.96319482  0.06248513 -0.46138666  0.76500396
      0.30422518 -0.21588114 -0.90260279 -0.07102884 -0.98577817 -0.09454256
      0.07157487  0.9879555   0.36608845 -0.9740067   0.69620032 -0.97704433
     -0.30932467]
    

æœ€ç»ˆçš„æ¨¡åž‹æƒé‡ä¸Žåœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®çŽ‡ç»“æžœå¦‚ä¸‹ï¼š

    Final w: [ 8.22414803e+02  1.48384087e+03  4.97062125e+03  4.47845441e+03
      7.71390166e+00  1.21510016e+00 -7.67338147e+00 -2.54147183e+00
      1.55496346e+01  6.52930570e+00  2.02480712e+00  1.09860082e+02
     -8.82480263e+00 -2.32991671e+03  1.61742379e+00  8.57741145e-01
      1.30270454e-01  1.16399854e+00  2.09101988e+00  5.30845885e-02
      8.28547658e+02  1.90597805e+03  4.93391021e+03 -4.69112527e+03
      1.10030574e+01  1.49957834e+00 -1.02290791e+01 -3.11020744e+00
      2.37012097e+01  5.97116694e+00  1.03680530e+02] 
    Final acc: 0.923977
    

å¯è§æˆ‘ä»¬çš„ç®—æ³•æ”¶æ•›è‰¯å¥½ã€‚

å‚è€ƒ
--

*   \[1\] [GiHub: Sparkå®˜æ–¹Pythonæ ·ä¾‹](https://github.com/apache/spark/blob/master/examples/src/main/python/logistic_regression.py)
*   \[2\] [çŽ‹æ ‘æ£®-å¹¶è¡Œè®¡ç®—ä¸Žæœºå™¨å­¦ä¹ (1/3)](https://www.youtube.com/watch?v=gVcnOe6_c6Q&list=PLvOO0btloRns6egXueiRju4DXQjNRJQd5)
*   \[3\] åˆ˜é“å²©ï¼Œé™ˆè–‡ç­‰. åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šç®—æ³•ã€ç†è®ºä¸Žæ—¶é—´\[M\]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2018.
*   \[4\] è®¸åˆ©æ°ï¼Œæ–¹äºšèŠ¬. å¤§æ•°æ®å¤„ç†æ¡†æž¶Apache Sparkè®¾è®¡ä¸Žå®žçŽ°\[M\]. ç”µå­å·¥ä¸šå‡ºç‰ˆç¤¾, 2021.

æ•°å­¦æ˜¯ç¬¦å·çš„è‰ºæœ¯ï¼ŒéŸ³ä¹æ˜¯ä¸Šç•Œçš„è¯­è¨€ã€‚