---
layout: post
title: "Rancher ç³»åˆ—æ–‡ç« -åœ¨è…¾è®¯äº‘çš„ K3S ä¸Šå®‰è£…é«˜å¯ç”¨ Rancher é›†ç¾¤"
date: "2023-03-26T01:13:35.192Z"
---
Rancher ç³»åˆ—æ–‡ç« -åœ¨è…¾è®¯äº‘çš„ K3S ä¸Šå®‰è£…é«˜å¯ç”¨ Rancher é›†ç¾¤
========================================

å¼€ç¯‡
--

> ğŸ“œ **å¼•è¨€**ï¼š
> 
> *   ä¸‰äººè¡Œå¿…æœ‰æˆ‘å¸ˆç„‰
> *   çŸ¥è¯†å…±äº«ï¼Œå¤©ä¸‹ä¸ºå…¬

*   ã€Š[K3s ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/K3S/)ã€‹
*   ã€Š[Rancher ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Rancher/)ã€‹

æ–¹æ¡ˆ
--

**åœ¨è…¾è®¯äº‘çš„ K3S ä¸Šå®‰è£… Rancher**

### æ–¹æ¡ˆç›®æ ‡

1.  é«˜å¯ç”¨
    1.  3 å° master çš„ k3s é›†ç¾¤
    2.  é«˜å¯ç”¨æ¨¡å¼çš„ rancher
2.  æ•°æ®å¤‡ä»½
    1.  rancher æ•°æ®å¤‡ä»½åˆ° è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ cos
3.  å®‰å…¨åŠ å¯†
    1.  ä¸èƒ½å­˜åœ¨ httpï¼Œå…¨éƒ¨æ˜¯ https
4.  é¢å‘å®¢æˆ·
    1.  å…¬ç½‘å¯è®¿é—®ï¼›
    2.  åŸŸåå¯è®¿é—®ï¼›
    3.  æ­£å¼è¯ä¹¦
5.  å°½é‡å¤ç”¨å…¬æœ‰äº‘çš„èƒ½åŠ›
    1.  Tencent Cloud Controller Manager (âŒ å› ä¸ºè…¾è®¯äº‘å·²ç»æ”¾å¼ƒç»´æŠ¤ç›¸å…³æºç ï¼Œæ‰€ä»¥æ— æ³•å¤ç”¨ï¼‰
    2.  SVC LoadBalancer è°ƒç”¨ CLB (âŒ å› ä¸ºè…¾è®¯äº‘å·²ç»æ”¾å¼ƒç»´æŠ¤ç›¸å…³æºç ï¼Œæ‰€ä»¥æ— æ³•å¤ç”¨ï¼‰
    3.  CLB - ä½¿ç”¨ 4 å±‚ CLB
    4.  å¤‡ä»½ - ä½¿ç”¨è…¾è®¯äº‘ COS

å‰ææ¡ä»¶
----

1.  æœ‰è…¾è®¯äº‘è´¦æˆ·ï¼Œè´¦æˆ·è‡³å°‘æ‹¥æœ‰å¦‚ä¸‹æƒé™ï¼š[auto k3s å®‰è£… - è®¾ç½® CAM](https://docs.rancher.cn/docs/k3s/autok3s/tencent/_index#%E8%AE%BE%E7%BD%AE-cam) ä»¥åŠè¿™äº›æƒé™ï¼š
    
    1.  `QcloudTAGFullAccess`
2.  è¯¥è…¾è®¯äº‘è´¦å·æœ‰å¯¹åº”çš„ API å¯†é’¥ï¼Œåœ°å€ï¼š[è®¿é—®å¯†é’¥ - æ§åˆ¶å° (tencent.com)](https://console.cloud.tencent.com/cam/capi) ï¼Œæˆ–è€…æ‹¥æœ‰ç›¸å…³æƒé™ï¼š`cam:QueryCollApiKey`å’Œ `cam:CreateCollApiKey`
    
3.  ä¸€ä¸ªå¯¹è±¡å­˜å‚¨é€š cosï¼Œç”¨äºå¤‡ä»½
    
4.  Rancher çš„åŸŸå
    
5.  Rancher çš„åŸŸåå¯¹åº”çš„è¯ä¹¦ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œä¼šå°è¯•é€šè¿‡ cert-manager å’Œ letâ€™s encrypt è‡ªåŠ¨ç”Ÿæˆå…è´¹çš„è¯ä¹¦ï¼‰
    

æ³¨æ„äº‹é¡¹
----

### Rancher å®‰è£…æ³¨æ„äº‹é¡¹

1.  [é€šè¿‡ Helm Chart è¿›è¡Œé«˜å¯ç”¨å®‰è£…](https://docs.rancher.cn/docs/rancher2.5/installation/install-rancher-on-k8s/chart-options/_index)
    
2.  å®‰è£…å‰éœ€è¦è°ƒæ•´ï¼š
    
    1.  å®‰å…¨ç»„
3.  å®‰è£…åéœ€è¦é…ç½®ï¼š
    
    1.  LB
    2.  Backup
4.  âš ï¸ä»˜è´¹æ¨¡å¼ï¼ŒCOS æŒ‰éœ€è°ƒæ•´ä»˜è´¹æ¨¡å¼ã€‚
    

å®‰è£…æ­¥éª¤
----

### Rancher

> ğŸš© **Important:**
> 
> **é€šè¿‡ Helm Chart å®‰è£…**

#### Rancher ç«¯å£è¦æ±‚

> ğŸ“šï¸ **Quote:**
> 
> [K3s ä¸Š Rancher Server èŠ‚ç‚¹çš„ç«¯å£](https://docs.rancher.cn/docs/rancher2.5/installation/requirements/ports/_index#k3s-%E4%B8%8A-rancher-server-%E8%8A%82%E7%82%B9%E7%9A%84%E7%AB%AF%E5%8F%A3)

Rancher Server èŠ‚ç‚¹çš„å…¥ç«™è§„åˆ™

åè®®

ç«¯å£

æ¥æº

æè¿°

TCP

80

Load balancer/proxyï¼Œåšå¤–éƒ¨ SSL ç»ˆç«¯

ä½¿ç”¨å¤–éƒ¨ SSL ç»ˆæ­¢æ—¶çš„ Rancher UI/API

TCP

443

server èŠ‚ç‚¹ agent èŠ‚ç‚¹æ‰˜ç®¡/æ³¨å†Œçš„ Kubernetes ä»»ä½•éœ€è¦èƒ½å¤Ÿä½¿ç”¨ Rancher UI æˆ– API çš„æº

Rancher agent, Rancher UI/API, kubectl

TCP

6443

K3s server èŠ‚ç‚¹

Kubernetes API

æœ€åå…·ä½“çš„å®‰å…¨ç»„é…ç½®å¦‚ä¸‹ï¼šï¼ˆåº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ”¶ç´§ï¼‰

![](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145744049-1757627832.png)

#### Rancher é«˜å¯ç”¨å®‰è£…

å…ˆå®‰è£… helm chart å¹¶åˆ›å»º ns:

    helm repo add rancher-stable http://rancher-mirror.oss-cn-beijing.aliyuncs.com/server-charts/stable
    
    kubectl create namespace cattle-system
    

SSL é€‰é¡¹ä¸ºï¼š**å·²æœ‰çš„è¯ä¹¦**ï¼Œé€šè¿‡ Helm å®‰è£… Rancher:

> ğŸ“šï¸ **Quote:**
> 
> [æ ¹æ®ä½ é€‰æ‹©çš„ SSL é€‰é¡¹ï¼Œé€šè¿‡ Helm å®‰è£… Rancher](https://docs.rancher.cn/docs/rancher2.5/installation/install-rancher-on-k8s/_index/#5-%E6%A0%B9%E6%8D%AE%E4%BD%A0%E9%80%89%E6%8B%A9%E7%9A%84-ssl-%E9%80%89%E9%A1%B9%EF%BC%8C%E9%80%9A%E8%BF%87-helm-%E5%AE%89%E8%A3%85-rancher)

å…ˆæ·»åŠ è¯ä¹¦åˆ° k8s secret:

    kubectl -n cattle-system create secret tls tls-rancher-ingress \
      --cert=tls.crt \
      --key=tls.key
    

    helm install rancher rancher-stable/rancher \
     --namespace cattle-system \
     --set hostname=<your-rancher-domain> \
     --set replicas=3 \
     --set ingress.tls.source=secret \
     --set systemDefaultRegistry=registry.cn-hangzhou.aliyuncs.com \
     --set auditLog.level=1 \
    

è¿è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š

    NAME: rancher
    LAST DEPLOYED: Sat Feb 12 20:10:14 2022
    NAMESPACE: cattle-system
    STATUS: deployed
    REVISION: 1
    TEST SUITE: None
    NOTES:
    Rancher Server has been installed.
    
    NOTE: Rancher may take several minutes to fully initialize. Please standby while Certificates are being issued, Containers are started and the Ingress rule comes up.
    
    Check out our docs at https://rancher.com/docs/
    
    If you provided your own bootstrap password during installation, browse to https://<your-rancher-domain> to get started.
    
    If this is the first time you installed Rancher, get started by running this command and clicking the URL it generates:
    
    echo https://<your-rancher-domain>/dashboard/?setup=$(kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{{.data.bootstrapPassword|base64decode}}')
    
    To get just the bootstrap password on its own, run:
    
    kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{{.data.bootstrapPassword|base64decode}}{{ "\n" }}'
    
    Happy Containering!
    

> ğŸ”¥ **Notice:**
> 
> æ³¨æ„ Rancher åŸŸåçš„ 443 æƒé™è¦å¼€é€šã€‚

> â„¹ï¸ **Info:**
> 
> *   è¦å®‰è£…ä¸€ä¸ªç‰¹å®šçš„ Rancher ç‰ˆæœ¬ï¼Œä½¿ç”¨`--version` æ ‡å¿—ï¼Œä¾‹å¦‚ï¼š`--version 2.3.6`ã€‚

ä¹‹åè®¿é—® UI è¿›è¡Œåˆå§‹å¯†ç è®¾ç½®ç­‰å·¥ä½œã€‚

ğŸ‰ è‡³æ­¤ï¼ŒRancher é«˜å¯ç”¨é›†ç¾¤å®‰è£…å®Œæˆã€‚

#### Rancher ä¸­å›½åŒºä¼˜åŒ–é…ç½®

å‚è€ƒè¿™é‡Œï¼š

*   [Rancher ä¸­å›½åŒºä¼˜åŒ–é…ç½®](https://ewhisper.cn/posts/36541/#2-1-4-Rancher-%20%E4%B8%AD%E5%9B%BD%E5%8C%BA%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE)

æ”¶å°¾å·¥ä½œ
----

### è°ƒæ•´å®‰å…¨ç»„

å…¥ç«™è§„åˆ™ï¼š

1.  TCP:22(SSH) ç«¯å£æƒé™æ”¶ç´§
2.  TCP:6443(K8S API) ç«¯å£æƒé™æ”¶ç´§
3.  UDP:8472(K3s vxlan) åªå¼€æ”¾ç»™å†…ç½‘
4.  TCP:10250(kube api-server) åªå¼€æ”¾ç»™å†…ç½‘

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼šï¼ˆåº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ”¶ç´§ï¼‰

![](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145744049-1757627832.png)

### é…ç½® LB

> ğŸ“šï¸ **Quote:**
> 
> [å¤–éƒ¨ TLS Termination](https://docs.rancher.cn/docs/rancher2.5/installation/install-rancher-on-k8s/chart-options/_index#%E5%A4%96%E9%83%A8-tls-termination):
> 
> æˆ‘ä»¬å»ºè®®å°†è´Ÿè½½å‡è¡¡å™¨é…ç½®ä¸º 4 å±‚å‡è¡¡å™¨ï¼Œå°†æ™®é€š 80/tcp å’Œ 443/tcp è½¬å‘åˆ° Rancher ç®¡ç†é›†ç¾¤èŠ‚ç‚¹ã€‚é›†ç¾¤ä¸Šçš„ Ingress Controller ä¼šå°†ç«¯å£ 80 ä¸Šçš„ http é€šä¿¡é‡å®šå‘åˆ°ç«¯å£ 443 ä¸Šçš„ httpsã€‚

å¦‚ä¸Šé¢æ‰€è¿°ï¼Œæ‰€ä»¥é€šè¿‡ 4 å±‚ LB, å°† 443/tcp è½¬åˆ°åç«¯ã€‚å¦‚ä¸‹å›¾ï¼š

![](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145744599-640928773.png)

### é…ç½® Rancher Backup

> ğŸ“šï¸ **Quote:**
> 
> [Rancher v2.5 ä¸­çš„å¤‡ä»½å’Œæ¢å¤ | Rancher æ–‡æ¡£](https://docs.rancher.cn/docs/rancher2.5/backups/_index#%E5%AE%89%E8%A3%85-rancher-backup-operator)
> 
> [å¤‡ä»½ Rancher | Rancher æ–‡æ¡£](https://docs.rancher.cn/docs/rancher2.5/backups/back-up-rancher/_index/)
> 
> [Rancher Backup Examples](https://rancher.com/docs/rancher/v2.5/en/backups/examples/#backup)

é€šè¿‡ UI å®‰è£…ï¼š

å…ˆåˆ›å»º cos å­˜å‚¨çš„è®¤è¯ä¿¡æ¯ Secret:

    apiVersion: v1
    stringData:
      accessKey: <your-ak>
      secretKey: <your-sk>
    kind: Secret
    metadata:
      name: cos-creds
      namespace: cattle-resources-system
    type: Opaque
    

ç„¶ååœ¨ _åº”ç”¨å¸‚åœº_ é€‰æ‹© _Rancher Backup_ å®‰è£…ï¼š

![image-20220212234820849](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145744855-1508718838.png)

é…ç½® å¯¹è±¡å­˜å‚¨ï¼š

![](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145745062-1536659739.png)

å®‰è£…æˆåŠŸæ—¥å¿—å¦‚ä¸‹ï¼š

    
    helm upgrade --install=true --namespace=cattle-resources-system --timeout=10m0s --values=/home/shell/helm/values-rancher-backup-crd-2.1.0.yaml --version=2.1.0 --wait=true rancher-backup-crd /home/shell/helm/rancher-backup-crd-2.1.0.tgz
    ...
    ---------------------------------------------------------------------
    SUCCESS: helm upgrade --install=true --namespace=cattle-resources-system --timeout=10m0s --values=/home/shell/helm/values-rancher-backup-crd-2.1.0.yaml --version=2.1.0 --wait=true rancher-backup-crd /home/shell/helm/rancher-backup-crd-2.1.0.tgz
    ---------------------------------------------------------------------
    helm upgrade --install=true --namespace=cattle-resources-system --timeout=10m0s --values=/home/shell/helm/values-rancher-backup-2.1.0.yaml --version=2.1.0 --wait=true rancher-backup /home/shell/helm/rancher-backup-2.1.0.tgz
    ...
    ---------------------------------------------------------------------
    SUCCESS: helm upgrade --install=true --namespace=cattle-resources-system --timeout=10m0s --values=/home/shell/helm/values-rancher-backup-2.1.0.yaml --version=2.1.0 --wait=true rancher-backup /home/shell/helm/rancher-backup-2.1.0.tgz
    ---------------------------------------------------------------------
    

é…ç½® _Backup_, å¦‚ä¸‹ï¼š

![image-20220213000206732](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145745302-1820072352.png)

ğŸ‰ ç™»å½• COS å‘ç°å·²ç»æˆåŠŸå¤‡ä»½ã€‚

æ€»ç»“
--

ğŸ‰ğŸ‰ğŸ‰ è‡³æ­¤ï¼Œå®Œæˆè…¾è®¯äº‘ä¸Š K3S é«˜å¯ç”¨é›†ç¾¤ åŠ Rancher é«˜å¯ç”¨é›†ç¾¤çš„æ­å»ºï¼Œå¹¶é…ç½®å¤‡ä»½ã€‚

ä»¥ä¸‹æ˜¯å®‰è£…çš„ç›¸å…³ä¿¡æ¯ï¼š

### K3s

1.  3 ä¸ª Master å’Œ Server åœ°å€
    
2.  K3S API Server åœ°å€ï¼š`https://<3ä¸ªmaster IP åœ°å€ä»»ä¸€ä¸ª>:6443` (6443 ç«¯å£ç›®å‰æ²¡æœ‰é…ç½® CLB)
    
3.  K3S kubeconfig é…ç½®ï¼šä½äº k3s çš„`/etc/rancher/k3s/k3s.yaml` ä»¥åŠæ“ä½œæœºçš„ `/root/.autok3s/.kube/config`
    

### Rancher

1.  åœ°å€ï¼š
    1.  å…¬ç½‘è®¿é—®ï¼š`https://<your-rancher-domain>:<port>/`
    2.  å†…ç½‘è®¿é—®ï¼š`https://<your-rancher-domain>:443` ï¼ˆéœ€è¦ç¼–è¾‘è‡ªå·±ç”µè„‘çš„ `hosts` , å°† 3 ä¸ª master ä»»ä¸€å†…ç½‘ IP æ˜ å°„åˆ°è¯¥åŸŸåï¼‰
2.  è´¦å·ï¼š`Admin`
3.  å¯†ç 

### å®‰å…¨ç»„

ä½¿ç”¨çš„å®‰å…¨ç»„ï¼Œæœ€ç»ˆé…ç½®å¦‚ä¸‹ï¼šï¼ˆåº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ”¶ç´§ï¼‰

![](https://img2023.cnblogs.com/other/3034537/202303/3034537-20230325145744049-1757627832.png)

### CLB

ä½¿ç”¨çš„ CLB

ç›‘å¬å™¨ä¸ºï¼š`rancher(TCP:<port>)` è½¬åˆ° 3 å° master çš„ 443 ç«¯å£ã€‚

### å¤‡ä»½ COS

K3S å’Œ Rancher éƒ½é…ç½®äº†å¤‡ä»½ï¼Œå¤‡ä»½åˆ°å¯¹è±¡å­˜å‚¨ cos ä¸­ã€‚å…·ä½“çš„åœ°å€ä¸ºï¼š

1.  æ¡¶ï¼šrancher-backup-
2.  åŸŸåï¼š`https://rancher-backup-<cos-id>.cos.ap-shanghai.myqcloud.com`
3.  S3 Endpoint: `cos.ap-shanghai.myqcloud.com`
4.  æ–‡ä»¶å¤¹ä¸ºï¼š
    1.  k3s ä¸ºï¼š`/rancher-1/rancher/rancher`ï¼ˆå¤‡ä»½ç­–ç•¥ï¼šæ¯å¤© 0 ç‚¹å¤‡ä»½ï¼Œä¿ç•™ 5 ä»½ï¼‰
    2.  rancher ä¸ºï¼š`/rancher-1/rancher/k3s` ï¼ˆå¤‡ä»½ç­–ç•¥ï¼Œæ¯å¤© 0 ç‚¹å¤‡ä»½ï¼‰
5.  COS ç”Ÿå‘½å‘¨æœŸä¸ºï¼šè‡ªåŠ¨æ¸…ç† 1 ä¸ªæœˆå‰çš„æ–‡ä»¶ã€‚ï¼ˆé…ç½® [è‡ªåŠ¨æ¸…ç†è§„åˆ™](https://console.cloud.tencent.com/cos/bucket?bucket=rancher-backup-1258988025&region=ap-shanghai&type=basicconfig&anchorType=lifeCycle)ï¼‰

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.