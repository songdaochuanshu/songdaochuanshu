---
layout: post
title: "在hyper-v虚拟机中安装并配置linux"
date: "2022-09-05T02:11:10.558Z"
---
在hyper-v虚拟机中安装并配置linux
======================

> 虽然都是自己写的，还是贴个[原文链接](https://lovexy.fun/2022/08/30/%E5%9C%A8hyper-v%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AElinux/)吧，如果文章里的图片错乱了，可能就是我贴错了，去看原文吧。  
> ⚠ 多图警告

WSL2真香？
-------

WSL2相比于WSL1前者更类似于虚拟机，配合上[Windoes Terminal](https://apps.microsoft.com/store/detail/windows-terminal/9N0DX20HK701?hl=zh-cn&gl=CN)的漂亮界面以及通过localhost直接访问，让人直呼真香!

那么WSL2真香吗？

WSL2理所当然的可以运行docker，你可以把一些mysql、redis之类的服务放在docker容器里运行。

当有一天你会发现在使用`systemctl`命令的时候会报这样的错误：

    System has not been booted with systemd as init system (PID 1). Can't operate.
    Failed to connect to bus: Host is down
    

出现这个问题是有解决方案的，去google搜索也能找到教程，但是点进教程连接我就默默地离开了页面（完全不想看）。

既然systemctl存在这样的问题，那其他地方也可能存在着问题，不如就直接使用虚拟机了。

Hyper-V方案
---------

### 1、开启Hyper-V功能

在这里默认为你觉得WSL2有问题才考虑使用虚拟机的，那么你的设备一定开启了Hyper-V功能。

另外的，如果你没有使用过WSL2或者电脑系统为Windows10家庭版（Windows11家庭版），那么你需要参考下面的操作（具体操作方式请自行搜索，下面几步并非全部都是完成）。

1.  如果你的系统为家庭版，你可以搜索家庭版开启Hyper-V的教程。
2.  如果你的系统为家庭版，你可以更换系统为专业版或者使用 [蓝点网](https://www.landiannews.com/) 的系统版本转换工具进行转换（不论是更换系统还是进行转换，都会失去原来的正版系统）。
3.  如果你的系统是专业版，仅仅需要在`控制面板>程序>启用或关闭Windows功能`中打开Hyper-V功能就可以。

### 2、Ubuntu镜像下载

[Ubuntu Server 22.04 LTS](https://ubuntu.com/download/server)

写这篇博客时的，最新server lts版本是22.04，目前没有测试18.04。

### 3、创建虚拟机配置（暂时不安装操作系统）

经过前几步的配置后应该可以在Win菜单中搜索到**Hyper-V 管理器**，打开后界面如下：

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904224918314-203937896.png)

点击右侧操作栏目的**新建>虚拟机**后会出现配置引导

* * *

点击下一步进行配置

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904224939116-956093012.png)

* * *

在这里需要制指定一下虚拟机的名称和虚拟机的存放位置。  
如果是长期使用并且安装较多软件的话尽量选择一个存储空间足够的位置。  
设置完成后点击下一步继续。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904224944466-2146479432.png)

* * *

这里选择第二代，然后下一步。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904224950210-1442033889.png)

* * *

内存先使用默认的1024MB动态内存，后期可以调整内存大小。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904224956027-1639991240.png)

* * *

先选择**Default Switch**，默认的网络连接用来连接互联网，后面装完系统后需要再新增一个网卡来固定虚拟机IP用来SSH连接使用。  
选择默认后点击下一步。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225000251-1428875284.png)

* * *

暂时选择不添加虚拟硬盘，点击下一步继续。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225005068-1340159795.png)

* * *

点击完成等待虚拟机配置创建完成。  
![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225011968-274205211.png)

### 4、添加硬盘

点击**Hyper-V管理器**主界面上前面几步创建的虚拟机

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225016765-626430070.png)

* * *

在弹出界面上依次点击`SCSI控制器>硬盘驱动器>添加`

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225021186-2103311284.png)

* * *

在点击添加后我们可以看到如下的界面，可以看到能够使用虚拟硬盘和脱机的虚拟硬盘。

当我们有空闲的硬盘时可以考虑使用物理硬盘。

这里先选择创建虚拟硬盘，点击**新建**按钮

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225024668-1232195113.png)

* * *

接下来回进入到虚拟硬盘创建引导。

这里可以看到有三种模式。  
当想要创建一个长期使用的虚拟机时建议选择固定大小并分配较大容量。  
现在做配置演示属于临时性的并且硬盘IO非常低，这里我选择动态扩展。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225103995-2078647099.png)

* * *

给硬盘一个名称并指定位置，建议放在创建的虚拟机目录下。  
![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225109949-821323605.png)

* * *

接下来是指定硬盘大小，如果是固定硬盘大小模式，这里指定之后硬盘就会被初始化为指定的大小。  
如果是选择的动态扩展，这里创建的虚拟硬盘文件小于这个最大值。  
当然可以选择复制物理硬盘或其他虚拟硬盘的内容到新的虚拟硬盘。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225114745-49842614.png)

* * *

磁盘配置完成后会看到如下信息

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225123136-804091541.png)

### 5、添加系统镜像

再点击`SCSI控制器>DVD驱动器>添加>映像文件`选择下载好的Ubuntu22.04系统镜像。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225128505-1714610291.png)

### 6、启动位置

点击**固件**，调整启动顺序为如图所示：

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225133755-1783572628.png)

### 7、关闭安全启动

点击**安全**，把启用安全启动去掉勾选，然后点击确定保存。

到这里虚拟机的基本配置已经完成了，接下来就是启动安装系统了。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225138965-260381547.png)

### 8、安装系统

在主界面上选中我们创建的虚拟机右击连接，在弹出窗口中点击启动。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225222079-1054021459.png)

* * *

等待几秒后会出现选择菜单，这里我们选择第一项安装系统。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225227053-2130579953.png)

* * *

经过等待几十秒后出出现语言选择界面，然后选择English

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225233318-1135089855.png)

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225236773-721597905.png)

* * *

选择正常安装

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225240974-807063506.png)

* * *

网络配置我们默认使用DHCP，这里不要修改否则可能安装完成后无法连接互联网。

这个eth0网卡就的Hyper-V的**Default Switch**，它的IP地址是系统开机自动分配的，我们无法固定这个IP，后面将通过再添加一个网卡的方式实现固定IP连接SSH。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225255079-1001655739.png)

* * *

代理设置和源设置默认就可以

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225313084-773887176.png)

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225316676-729101326.png)

* * *

硬盘分区选择，第一个方案，继续。想自定义分区可以参考：[UbuntuServer2204分区](https://lovexy.fun/2022/09/03/UbuntuServer2204%E5%88%86%E5%8C%BA/)

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225323830-256388140.png)

* * *

这是默认提供的分区方案，我们可以看到**free space**还有60G+的空间。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225337813-1312452159.png)

选择中free space后回车，选择Create Logical Volume

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225342644-681615357.png)

设置如下配置后选择Create继续

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225347488-986094351.png)

设置完成后选择Done继续，会有一个确认提示，选择Continue。

* * *

接下来就是常见的用户信息设置了，设置完成后继续。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225354352-947823608.png)

* * *

这里要选择上ssh服务，如图所示。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225359596-1966252414.png)

* * *

这一步是Snaps软件安装，一个都不要选，后面自己安装需要的软件。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225404504-1691031316.png)

* * *

接下来会进入安装阶段，等待出现**Reboot Now**选项。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225411589-1340696183.png)

选中reboot now，进行重启，这里一定会出错，不过没有关系，直接强制关机虚拟机就可以了。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225418030-2067361207.png)

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225420748-966586255.png)

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225423487-45684739.png)

* * *

接下来我们再次启动虚拟机就可以进入系统了。

### 9、配置固定IP

在Hyper-V管理器主界面点击右侧的**虚拟交换机管理器**，点击`新建虚拟网络交换机>内部>创建虚拟交换机`

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225437091-620045305.png)

按照如图所示的进行配置：

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225442870-1313957273.png)

* * *

关闭虚拟机的系统，点击选中虚拟机进行设置。  
选中`添加硬件>网络适配器>添加`

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225449463-1182912940.png)

虚拟交换选中上面创建的10.10.10.254。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225453609-250278455.png)

完成后保存虚拟机配置。

* * *

在`控制面板>网络和Internet>网络连接`里可以看到上面配置的虚拟网卡。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225459091-838702137.png)

需要给这个网卡配置固定的IP地址

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225507626-1406028321.png)

* * *

启动虚拟机的系统，进入系统后切换到root用户

    sudo su
    

更新软件源

    apt update
    

安装net-tools

    apt install net-tools
    

编辑`/etc/netplan`下的唯一一个yaml文件

    vi /etc/netplan/00-installer-config.yaml
    

文件默认内容为：

    # This is the network config written by 'subiquity'
    network:
      ethernets:
        eth0:
          dhcp4: true
      version: 2
    

这里的网卡不一定都是eht，也可能是ens

需要添加一个网卡eth1，修改这个文件内容为：

    # This is the network config written by 'subiquity'
    network:
      ethernets:
        eth0:
          dhcp4: true
        eth1:
          dhcp4: false
          addresses: [10.10.10.1/24]
      version: 2
    

应用配置

    netplan apply
    

如果配置没有错误，在windows实体机器上`ssh ubuntu@10.10.10.1`就可以连接到虚拟机的Ubuntu了。

### 10、优化虚拟机访问

修改`C:\Windows\System32\drivers\etc\hosts`文件，在文件末尾添加

    10.10.10.1 vmlinux1
    

在命令行中`ssh ubuntu@vmlinux1`就可以连接到系统了。

打开windows terminal，到设置中添加一项配置。  
这里我没有设置图标，如果需要的话可以自行设置。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225521993-1667542180.png)

这样每次连接仅输入密码就可以了，如果觉得输入密码比较麻烦可以配置一下RSA密钥。

如果想要像WSL一样在资源管理器里就可以浏览linux文件，可以参考：[sftp映射为win磁盘](http://lovexy.fun/2022/09/04/sftp%E6%98%A0%E5%B0%84%E4%B8%BAwin%E7%A3%81%E7%9B%98/)

### 11、挂载物理硬盘

要挂载物理硬盘必要条件是电脑是双硬盘的，这里要注意挂载的是硬盘不是分区。

首先将要挂载的物理硬盘清空所有分区(推荐使用 [DiskGenius](https://www.diskgenius.cn/) 来操作)：

右击磁盘选择脱机。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225529255-1334826906.png)

得到如下状态的磁盘：

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225535454-174463177.png)

在虚拟机设置窗口依次点击`SCSI控制器>硬盘驱动器>物理硬盘`

只有存在脱机的物理硬盘这里才能识别到具体的硬盘

完成后确定保存配置。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225540328-47197602.png)

需要注意的是挂载了物理磁盘后就不能再使用检查点了，需要关闭检查点后才能启动开机。

![](https://img2022.cnblogs.com/blog/1496348/202209/1496348-20220904225544499-2125655533.png)

需要注意系统安装到物理硬盘上后，如果BIOS的第一启动项是这个硬盘的话，是完全可以启动的。

所以要设置一下BIOS让这个硬盘不会在第一启动位

最终解决方案
------

[Buy a Mac](https://www.apple.com/mac/)