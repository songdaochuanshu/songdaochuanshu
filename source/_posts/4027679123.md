---
layout: post
title: "【面试普通人VS高手系列】volatile关键字有什么用？它的实现原理是什么？"
date: "2022-04-29T23:18:49.135Z"
---
【面试普通人VS高手系列】volatile关键字有什么用？它的实现原理是什么？
=======================================

> 一个工作了6年的Java程序员，在阿里二面，被问到“volatile”关键字。
> 
> 然后，就没有然后了…
> 
> 同样，另外一个去美团面试的工作4年的小伙伴，也被“volatile关键字“。
> 
> 然后，也没有然后了…
> 
> 这个问题说实话，是有点偏底层，但也的确是并发编程里面比较重要的一个关键字。
> 
> 下面，我们来看看普通人和高手对于这个问题的回答吧。

普通人：
----

嗯… volatile可以保证可见性。

高手：
---

volatile关键字有两个作用。

1.  可以保证在多线程环境下共享变量的可见性。
2.  通过增加内存屏障防止多个指令之间的重排序。

我理解的可见性，是指当某一个线程对共享变量的修改，其他线程可以立刻看到修改之后的值。

其实这个可见性问题，我认为本质上是由几个方面造成的。

1.  CPU层面的高速缓存，在CPU里面设计了三级缓存去解决CPU运算效率和内存IO效率问题，但是带来的就是缓存的一致性问题，而在多线程并行执行的情况下，缓存一致性就会导致可见性问题。
    
    ![image-20220328161249113](https://img2022.cnblogs.com/other/1666682/202204/1666682-20220429194533183-1397935034.png)
    
    所以，对于增加了volatile关键字修饰的共享变量，JVM虚拟机会自动增加一个#Lock汇编指令，这个指令会根据CPU型号自动添加总线锁或/缓存锁
    
    我简单说一下这两种锁，
    
    *   总线锁是锁定了CPU的前端总线，从而导致在同一时刻只能有一个线程去和内存通信，这样就避免了多线程并发造成的可见性。
    *   缓存锁是对总线锁的优化，因为总线锁导致了CPU的使用效率大幅度下降，所以缓存锁只针对CPU三级缓存中的目标数据加锁，缓存锁是使用MESI缓存一致性来实现的。
2.  指令重排序，所谓重排序，就是指令的编写顺序和执行顺序不一致，在多线程环境下导致可见性问题。指令重排序本质上是一种性能优化的手段，它来自于几个方面。
    
    *   CPU层面，针对MESI协议的更进一步优化去提升CPU的利用率，引入了StoreBuffer机制，而这一种优化机制会导致CPU的乱序执行。当然为了避免这样的问题，CPU提供了内存屏障指令，上层应用可以在合适的地方插入内存屏障来避免CPU指令重排序问题。
    *   编译器的优化，编译器在编译的过程中，在不改变单线程语义和程序正确性的前提下，对指令进行合理的重排序优化来提升性能。
    
    所以，如果对共享变量增加了volatile关键字，那么在编译器层面，就不会去触发编译器优化，同时再JVM里面，会插入内存屏障指令来避免重排序问题。
    

当然，除了volatile以外，从JDK5开始，JMM就使用了一种Happens-Before模型去描述多线程之间的内存可见性问题。

如果两个操作之间具备Happens-Before关系，那么意味着这两个操作具备可见性关系，不需要再额外去考虑增加volatile关键字来提供可见性保障。

以上就是我对这个问题的理解。

总结
--

在我看来，并发编程是每个程序员必须要掌握好的领域，它里面涵盖的设计思想、和并发问题的解决思路、以及作为一个并发工具，都是非常值得深度研究的。

我推荐大家去读一下《Java并发编程深度解析与原理实战》这本书，对Java并发这块的内容描述得很清晰。

好的，本期的普通人VS高手面试系列就到这里结束了，喜欢的朋友记得点赞和收藏。

另外，有任何技术上的问题，职业发展有关的问题，都可以私信我，我会在第一时间回复。

![file](http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_80D26D8C1CB04165B81925DDA87011F7)

> 版权声明：本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明来自 `Mic带你学架构`！  
> 如果本篇文章对您有帮助，还请帮忙点个关注和赞，您的坚持是我不断创作的动力。欢迎关注「跟着Mic学架构」公众号公众号获取更多技术干货！

![](https://img2022.cnblogs.com/other/1666682/202204/1666682-20220429194534145-817341552.png)