---
layout: post
title: "【原创】FFMPEG录屏入门指南"
date: "2022-09-20T06:06:05.656Z"
---
【原创】FFMPEG录屏入门指南
================

> 最近部门内部在做技术分享交流，需要将内容录制成视频存档。很自然的想到了去网上找一些录屏的软件，试过了几款诸如`屏幕录像大师` `Captura`之类的录屏软件，要么操作太繁琐，要么压缩率太低不支持H265编码。于是想到了音视频处理的神器`ffmpeg`!于是查了一些资料，踩了若干坑之后，总结出了本文。现在分享给大家！

1.  **下载ffmpeg**

*   点击 [ffmpeg官网](https://ffmpeg.org/download.html)，选择windows，然后点击`Windows builds from gyan.dev`：  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920093746879-557294213.png)
    
*   也可以直接点击 [https://www.gyan.dev/ffmpeg/builds/](https://www.gyan.dev/ffmpeg/builds/) ,在点击`ffmpeg-git-full.7z`,即可下载:  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920093815546-1200857425.png)
    
*   下载到的文件格式为7z(一种压缩格式)，用电脑安装的压缩工具解压即可。如果没有安装支持7z的压缩工具，可以点击[https://www.7-zip.org/](https://www.7-zip.org/),下载：  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920094503949-159162494.png)  
    下载完，双击打开，一路`同意`和`下一步`直到完成即可。
    
*   解压后剪切至自己习惯放软件的文件夹下即可：  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920094910984-2109814545.png)
    
    我把它放在了`D:\opt\ffmpeg\`。**然后记住这个路径`D:\opt\ffmpeg\bin`,后面的录屏命令用的到**。  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920095016489-394837319.png)
    
*   选做：将`D:\opt\ffmpeg\bin`添加到系统环境变量。目的是不用记住上一步的这个路径`D:\opt\ffmpeg\bin`，就可以用ffmpeg。具体方法请自行百度。
    

至此，ffmpeg就安装完了。

按下`Windows`+`R`键，输入`cmd`,回车，打开命令提示符窗口：  
![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920095702038-379450960.png)  
依次输入以下命令

    # 跳转至ffmpeg程序所在路径，设置了ffmpeg环境变量的可以略过
    d:
    cd /opt/ffmpeg/bin/
    # 上面的盘符`d:`和路径`/opt/ffmpeg/bin/` 要根据你ffmpeg的安装路径灵活修改！
    

![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920100253219-1711727483.png)

2.  **查看输入设备**  
    输入：`ffmpeg -list_devices true -f dshow -i dummy`，查看可用设备的清单（每台电脑的结果都不太一样，但是相似，可以根据我下面的结果甄别自己电脑的设备）：  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920101133862-1488029703.png)

*   我这次录屏，需要录制电脑画面和麦克风的声音，于是用到了上面结果中的`麦克风阵列 (Realtek(R) Audio)` 设备，注意不包含引号：  
    ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920101445505-1970088871.png)

电脑画面该选哪个呢？有两种方案：

*   安装[`Screen Capturer Recorder`](https://sourceforge.net/projects/screencapturer/files/)然后选择上面的设备清单中的`screen-capture-recorder`(见上图；安装好后再重新执行查看设备的命令才会出现)。
*   直接使用ffmpeg内置的`gdigrab`。  
    第一种我操作失败了，所以我选用第二种。现在**我需要记住的的是音频输入设备名称**`麦克风阵列 (Realtek(R) Audio)`。

3.  **查看可用编码器**

输入`ffmpeg -encoders |findstr "hevc 265"` ，查看可用的编码器。我的电脑支持这些：  
![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920102455489-1909360250.png)

该选择哪一个呢？

*   首先`libx265`是通用的，选这个最保守，但是它在不做优化的情况下是靠cpu运算。简单理解，一旦开启录屏，你的电脑cpu使用率会飙升，甚至造成电脑卡顿。尝试一下，如果没有造成卡顿，就可以继续用这个编码器了。
*   如果电脑配置有限，或者有独立显卡的话，咱们可以挑一个独显支持的编码器。我的电脑是NVIDIA的独显，所以我选择与之对应的`hevc_nvenc`编码器。  
    你该怎么找到适合的呢？首先要知道自己的电脑有没有独显，其次搞清楚独显是Intel的，还是NVIDIA的，还是AMD的，然后从关键词里面找对应的就可以了。拿我的清单举例：如果是AMD的，就选`hevc_amf`,如果是Intel的，就选`hevc_qsv`。 或者干脆挨个尝试一下，反正又不多。  
    怎么判断录屏是否用到了独显呢？咱们在下一步的时候介绍。现在**我要记住适合我的编码器**`hevc_nvenc`。

4.  **录屏**

通过上面两步，我记住了我的音频输入设备是`麦克风阵列 (Realtek(R) Audio)`，编码器是`hevc_nvenc`。下面在命令提示符窗口输入我的录屏命令

    D:
    /opt/ffmpeg/bin/ffmpeg.exe ^
    -f dshow -i audio="麦克风阵列 (Realtek(R) Audio)"   ^
    -f gdigrab -i desktop   ^
    -c:v hevc_nvenc   ^
    -r 8 -b:v 0.8M -minrate 0.4M -maxrate 2M -bufsize 4M  ^
    -y  ^
    D:\Personal\Desktop\录屏%date:~0,4%%date:~5,2%%date:~8,2%%time:~0,2%%time:~3,2%%time:~6,2%.mp4
    

> 按下回车，录屏就开始了！结束录屏的话，选中录屏的命令提示符窗口，按下`Q`键就可以了。

*   其中`-f dshow -i audio="麦克风阵列 (Realtek(R) Audio)"` 是指定采集的音频设备，你可以将`麦克风阵列 (Realtek(R) Audio)` 换成你想要采集的音频输入设备。
    
*   其中`-f gdigrab -i desktop` 是指定采集的视频设备，含义为采集电脑屏幕画面，此项无需修改。（还记得上面说过，录制电脑画面有两种方案吗，这是第二种。）
    
*   其中`-c:v hevc_nvenc` 是指定视频编码器，你可以将`hevc_nvenc` 换成适合你的编码器。如果实在不知道该选哪个，就用`libx265`，如果用这个电脑录屏会卡，就用`libx264`。还卡？就放弃吧。
    
    *   如果开始录屏后，cpu飙升，说明使用的cpu进行编码运算：  
        ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920105237021-2044063905.png)
    *   如果是GPU生生明显，cpu上升不明显，则说明编码器再用独显计算：  
        ![](https://img2022.cnblogs.com/blog/2437928/202209/2437928-20220920110400692-989723032.png)
    
    > 可以通过这个判断自己的编码器选择是否合适
    
*   其中`-r 8`是指定视频的帧率。(帧率是什么，可自行百度。)简单说，这个值越高，视频就会越流畅，但是录屏后的视频文件越大（其他参数不变的情况下）；反之，视频就会越跳跃，极端情况下会变成ppt的效果，但是视频文件的体积会越小。**对于录屏来说，建议设置在5--30之间，通过多次尝试，找到自己满意的数值**。
    
*   其中`-b 0.6M -minrate 0.4M -maxrate 2M -bufsize 4M` 是设置视频的比特率，就是每秒会产生多大的体积。0.6M就是每秒会占600kbp，简单说就是一秒的视频体积是600➗8也就是不到100K。**`-b`后面跟的是基准比特率，`-minrate`是最小比特率 `-maxrate`是最大比特率**。比特率不能过低，虽然会降低文件体积，但是过低会导致画面的清晰度惨不忍睹！过高也没有意义，因为画面的效果还收其他参数的影响，比如分辨率、帧率等等。推荐的最小值是`-b 0.6M -minrate 0.4M -maxrate 2M -bufsize 4M` ，最大值是`-b 2M -minrate 1M -maxrate 4M -bufsize 8M`
    
*   其中`D:\Personal\Desktop\录屏%date:~0,4%%date:~5,2%%date:~8,2%%time:~0,2%%time:~3,2%%time:~6,2%.mp4` 是录屏文件保存位置和名称。可根据自己的需要修改。
    

5.  **调优**

*   ffmpeg关于音视频的参数非常多，本文仅仅是入门用，像是分辨率、音视频质量、音频编码等等一系列参数并没有完全列出来。未指定的参数，ffmpeg会使用默认参数，如分辨率，会使用屏幕的分辨率。
*   对与帧率`-r`，码率`-b`,分辨率等参数，**可以在多次尝试中找到文件体积和录制效果间的一个权衡**。这里给出一个参考：通常H265编码下，1080p的视频大小应该在300M到1.5G之间，我按照上手参数录制的视频在400M左右。
*   找到适合自己的参数后，可以将其保存为bat批处理文件，以后双击该文件，就可以一键录屏了！下面给出我的以作参考：

    D:
    /opt/ffmpeg/bin/ffmpeg.exe ^
    -f dshow -i audio="麦克风阵列 (Realtek(R) Audio)"   ^
    -f gdigrab -i desktop   ^
    -c:v hevc_nvenc   ^
    -r 8 -b:v 0.8M -minrate 0.4M -maxrate 2M -bufsize 4M  ^
    -y  ^
    D:\Personal\Desktop\录屏%date:~0,4%%date:~5,2%%date:~8,2%%time:~0,2%%time:~3,2%%time:~6,2%.mp4
    

注意：保存后的**bat文件编码得是**windows默认的**GBK**，如果是UTF-8会导致执行失败！

> ffmpeg能做的事情远不止这些，它还能加水印，多路混采（像是同事录制电脑和话筒的声音，同事录制桌面和摄像头等等），感兴趣的同学可以自省挖掘和研究。

最后，如有交代不清的，或者错误之处，欢迎交流指正！