---
layout: post
title: "ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼é™æµä¼šå‡ºç°ä¸å‡è¡¡çš„æƒ…å†µï¼Ÿ"
date: "2022-12-16T02:33:45.342Z"
---
ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼é™æµä¼šå‡ºç°ä¸å‡è¡¡çš„æƒ…å†µï¼Ÿ
==================

æ¦‚è¿°
--

åœ¨å¾®æœåŠ¡ã€API åŒ–ã€äº‘åŸç”Ÿå¤§è¡Œå…¶é“çš„ä»Šå¤©ï¼ŒæœåŠ¡æ²»ç†ä¸å¯æˆ–ç¼ºï¼Œè€ŒæœåŠ¡æ²»ç†ä¸­é™æµå‡ ä¹æ˜¯å¿…ä¸å¯å°‘çš„æ‰‹æ®µï¼›å¾®æœåŠ¡åŒ–å¾€å¾€ä¼´éšç€åˆ†å¸ƒå¼çš„æ¶æ„ï¼Œé‚£ä¹ˆä»…ä»…å•æœºé™æµæ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦åˆ†å¸ƒå¼çš„é™æµã€‚  
é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼šåˆ†å¸ƒå¼é™æµä¸­ï¼Œå¾€å¾€ä¼šå‡ºç°ã€Œé™æµä¸å‡è¡¡ã€æˆ–ã€Œé™æµè¯¯å·®ã€çš„æƒ…å†µï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

é™æµ
--

å›½åº†å‡æœŸï¼Œé™æµè¿™ä¸ªè¯åœ¨æ–°é—»ä¸­åº”è¯¥èƒ½é¢‘ç¹å¬åˆ°ï¼Œå°±æ˜¯ã€Œæ™¯åŒºé™æµã€ã€‚è¿™é‡Œä»¥æ— é”¡çš„ä¸¤ä¸ªæ™¯ç‚¹ä¸ºä¾‹ï¼š

> ğŸ“Œç¤ºä¾‹ï¼š
> 
> *   æ— é”¡è ¡å›­ï¼šæœ€å¤§æ‰¿è½½é‡è°ƒæ•´è‡³ 20000 äººï¼›ç¬æ—¶æœ€å¤§æ‰¿è½½é‡è°ƒæ•´è‡³ 4000 äººï¼›
> *   æ— é”¡ä¸œæ—ä¹¦é™¢ï¼šä¹¦é™¢æ¥å¾…æ—¥æœ€å¤§æ‰¿è½½é‡å³æ—¶é™è‡³ 1500 äººï¼Œç¬æ—¶æ‰¿è½½é‡é™è‡³ 300 äººã€‚

åœ¨è®¡ç®—æœºç½‘ç»œä¸­ï¼Œé™æµå°±æ˜¯ç”¨äºæ§åˆ¶ç½‘ç»œæ¥å£æ§åˆ¶å™¨å‘é€æˆ–æ¥æ”¶è¯·æ±‚çš„é€Ÿç‡[\[1\]](#fn1)ï¼Œç”±æ­¤å»¶ä¼¸ä¸ºï¼š**é™åˆ¶åˆ°è¾¾ç³»ç»Ÿçš„å¹¶å‘è¯·æ±‚æ•°**ï¼Œä»¥æ­¤æ¥ä¿éšœç³»ç»Ÿçš„ç¨³å®šæ€§ï¼ˆç‰¹åˆ«æ˜¯åœ¨å¾®æœåŠ¡ã€API åŒ–ã€äº‘åŸç”Ÿç³»ç»Ÿä¸Šï¼‰ã€‚

å¸¸è§çš„é™æµç®—æ³•
-------

1.  å›ºå®šçª—å£è®¡æ•°å™¨
2.  æ»‘åŠ¨çª—å£è®¡æ•°å™¨
3.  æ¼æ¡¶
4.  ä»¤ç‰Œæ¡¶

å•æœºé™æµå’Œåˆ†å¸ƒå¼é™æµ
----------

æœ¬è´¨ä¸Šå•æœºé™æµå’Œåˆ†å¸ƒå¼é™æµçš„åŒºåˆ«å°±åœ¨äºã€Œæ‰¿è½½é‡ã€å­˜æ”¾çš„ä½ç½®ã€‚

å•æœºé™æµç›´æ¥åœ¨å•å°æœåŠ¡å™¨ä¸Šå®ç°ï¼Œè€Œåœ¨å¾®æœåŠ¡ã€API åŒ–ã€äº‘åŸç”Ÿç³»ç»Ÿä¸Šï¼Œåº”ç”¨å’ŒæœåŠ¡æ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œå› æ­¤éœ€è¦é›†ç¾¤å†…çš„å¤šä¸ªå®ä¾‹ååŒå·¥ä½œï¼Œä»¥æä¾›é›†ç¾¤èŒƒå›´çš„é™æµï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é™æµã€‚

ğŸ¤”ä¸ºä»€ä¹ˆåˆ†å¸ƒå¼é™æµä¼šå‡ºç°ä¸å‡è¡¡çš„æƒ…å†µï¼Ÿ
--------------------

æ¯”å¦‚ä¸Šé¢æåˆ°çš„æ»‘åŠ¨çª—å£çš„ç®—æ³•ï¼Œå¯ä»¥å°†è®¡æ•°å™¨å­˜æ”¾è‡³ Redis è¿™æ ·çš„ KV æ•°æ®åº“ä¸­ã€‚  
ä¾‹å¦‚æ»‘åŠ¨çª—å£çš„æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´è®°å½•å¯ä»¥åˆ©ç”¨ Redis çš„ `zset` å­˜å‚¨ï¼Œåˆ©ç”¨ `ZREMRANGEBYSCORE` åˆ é™¤æ—¶é—´çª—å£ä¹‹å¤–çš„æ•°æ®ï¼Œå†ç”¨ `ZCARD` è®¡æ•°ã€‚

ç¤ºä¾‹ä»£ç [\[2\]](#fn2)å¦‚ä¸‹ï¼š

    package com.lizba.redis.limit;
    
    import redis.clients.jedis.Jedis;
    import redis.clients.jedis.Pipeline;
    import redis.clients.jedis.Response;
    
    /**
     * <p>
     *     Limiting current by sliding window algorithm through zset
     * </p>
     *
     * @Author: Liziba
     * @Date: 2021/9/6 18:11
     */
    public class SimpleSlidingWindowByZSet {
    
        private Jedis jedis;
    
        public SimpleSlidingWindowByZSet(Jedis jedis) {
            this.jedis = jedis;
        }
    
        /**
         * Judging whether an action is allowed
         *
         * @param userId        User id
         * @param actionKey     Behavior key
         * @param period        Current Limiting Cycle
         * @param maxCount      Maximum number of requests (sliding window size)
         * @return
         */
        public boolean isActionAllowed(String userId, String actionKey, int period, int maxCount) {
            String key = this.key(userId, actionKey);
            long ts = System.currentTimeMillis();
            Pipeline pipe = jedis.pipelined();
            pipe.multi();
            pipe.zadd(key, ts, String.valueOf(ts));
            // Remove data other than sliding windows
            pipe.zremrangeByScore(key, 0, ts - (period * 1000));
            Response<Long> count = pipe.zcard(key);
            // Set the expiration time of the behavior, and if the data is cold, zset will be deleted to save memory space
            pipe.expire(key, period);
            pipe.exec();
            pipe.close();
            return count.get() <= maxCount;
        }
    
    
        /**
         * Current limiting key
         *
         * @param userId
         * @param actionKey
         * @return
         */
        public String key(String userId, String actionKey) {
            return String.format("limit:%s:%s", userId, actionKey);
        }
    
    }
    

åƒä»¤ç‰Œæ¡¶ä¹Ÿå¯ä»¥å°†ä»¤ç‰Œæ•°é‡æ”¾åˆ° Redis ä¸­ã€‚

### ğŸ§ ç­”æ¡ˆä¸€ï¼šæ‰¹é‡å¯¼è‡´çš„è¯¯å·®

ä¸è¿‡ä»¥ä¸Šçš„æ–¹å¼ç›¸å½“äºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦å» Redis åˆ¤æ–­ä¸€ä¸‹èƒ½ä¸èƒ½é€šè¿‡ï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰ä¸€å®šçš„æŸè€—ï¼Œæ‰€ä»¥é’ˆå¯¹å¤§å¹¶å‘ç³»ç»Ÿï¼Œæœ‰ä¸ªä¼˜åŒ–ç‚¹å°±æ˜¯ ã€Œæ‰¹é‡ã€ã€‚ä¾‹å¦‚æ¯æ¬¡å–ä»¤ç‰Œä¸æ˜¯ä¸€ä¸ªä¸€å–ï¼Œè€Œæ˜¯å–ä¸€æ‰¹ï¼Œä¸å¤Ÿäº†å†å»å–ä¸€æ‰¹ã€‚è¿™æ ·å¯ä»¥å‡å°‘å¯¹ Redis çš„è¯·æ±‚ã€‚  
ä½†æ˜¯ï¼Œ**æ‰¹é‡è·å–å°±ä¼šå¯¼è‡´ä¸€å®šèŒƒå›´å†…çš„é™æµè¯¯å·®**ã€‚æ¯”å¦‚ a å®ä¾‹æ­¤åˆ»å–äº† 100 ä¸ªï¼Œç­‰ä¸‹ä¸€ç§’å†ç”¨ï¼Œé‚£ä¸‹ä¸€ç§’é›†ç¾¤æ€»æ‰¿è½½é‡å°±æœ‰å¯èƒ½è¶…è¿‡é˜ˆå€¼ã€‚

è¿™æ˜¯ä¸€ç§åŸå› ã€‚

### ğŸ§ ç­”æ¡ˆäºŒï¼šè´Ÿè½½å‡è¡¡è´Ÿè½½ä¸å‡

åˆ†å¸ƒå¼é™æµè¿˜æœ‰ä¸€ç§åšæ³•æ˜¯ã€Œå¹³åˆ†ã€ï¼Œæ¯”å¦‚ä¹‹å‰å•æœºé™æµ 100ï¼Œç°åœ¨é›†ç¾¤éƒ¨ç½²äº† 5 ä¸ªå®ä¾‹ï¼Œé‚£å°±è®©æ¯å°ç»§ç»­é™æµ 100ï¼Œå³åœ¨æ€»çš„å…¥å£åšæ€»çš„æµé‡é™åˆ¶ï¼Œæ¯”å¦‚ 500ï¼Œç„¶åæ¯ä¸ªå®ä¾‹å†è‡ªå·±å®ç°é™æµã€‚  
è¿™ç§æƒ…å†µä¸‹ï¼Œå‡è®¾æ€»çš„å…¥å£æ”¾å…¥äº† 500 è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚éœ€è¦é€šè¿‡è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆå¦‚ï¼šè½®è¯¢ã€æœ€å°è¿æ¥æ•°ã€æœ€å°è¿æ¥æ—¶é—´ç­‰ï¼‰ä»¥åŠä¼šè¯ä¿æŒç­–ç•¥ï¼ˆå¦‚ï¼šæºåœ°å€ä¿æŒã€cookie ä¿æŒæˆ–ç‰¹å®šå‚æ•°çš„ hashï¼‰ï¼Œåˆ†åˆ°æ¯å°çš„è¯·æ±‚å°±å¯èƒ½æ˜¯ä¸å‡è¡¡çš„ï¼Œæ¯”å¦‚ a å®ä¾‹æœ‰ 70 ä¸ªï¼Œb å®ä¾‹æœ‰ 130 ä¸ªã€‚é‚£ä¹ˆ a å®ä¾‹çš„ 70 ä¸ªä¼šé€šè¿‡ï¼Œè€Œ b å®ä¾‹çš„ 130 ä¸ªå¯èƒ½åªæœ‰ 100 ä¸ªä¼šé€šè¿‡ã€‚è¿™æ—¶å°±å‡ºç°äº†ã€Œé™æµä¸å‡è¡¡ã€æˆ–ã€Œé™æµåå·®ã€çš„æƒ…å†µã€‚

è¿™æ˜¯ç¬¬äºŒç§åŸå› ã€‚

æ€»ç»“
--

ç”±äºæœ¬äººç»éªŒæ‰€é™ï¼Œæœ¬æ–‡åªåˆ—å‡ºäº†æˆ‘ç›®å‰èƒ½æƒ³åˆ°çš„ 2 ä¸ªç­”æ¡ˆç»™å¤§å®¶å‚è€ƒï¼Œæ¬¢è¿å„ä½äº¤æµè¡¥å……ã€‚  
çœŸå®çš„ä¸šåŠ¡åœºæ™¯æ˜¯å¾ˆå¤æ‚çš„ï¼Œå…·ä½“åˆ°ä¸€ä¸ªå·¥ç¨‹ï¼Œé™æµéœ€è¦è€ƒè™‘çš„æ¡ä»¶å’Œèµ„æºæœ‰å¾ˆå¤šã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯é€šè¿‡ä¼°ç®—ã€å‹æµ‹ã€è¯•è¿è¡Œã€è°ƒæ•´ã€å†ç”Ÿäº§éªŒè¯å†è°ƒæ•´æ¥é€¼è¿‘ç†æƒ³æƒ…å†µã€‚

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.

* * *

1.  [Rate limiting - Wikipedia](https://en.wikipedia.org/wiki/Rate_limiting) [â†©ï¸](#fnref1)
    
2.  [Redis zset for sliding window current limiting (programmer.group)](https://programmer.group/redis-zset-for-sliding-window-current-limiting.html) [â†©ï¸](#fnref2)