---
layout: post
title: "ä½¿ç”¨ Vite æ’ä»¶å¼€å‘æ„å»º Tampermonkey ç”¨æˆ·è„šæœ¬"
date: "2022-05-24T23:19:57.373Z"
---
ä½¿ç”¨ Vite æ’ä»¶å¼€å‘æ„å»º Tampermonkey ç”¨æˆ·è„šæœ¬
================================

âš¡å·¥ç¨‹åŒ–ã€æ¨¡å—åŒ–ä¸æ›´èˆ’æœçš„ç”¨æˆ·è„šæœ¬å¼€å‘æ–¹å¼ï¼Œæ˜¾è‘—æå‡å¼€å‘ä½“éªŒ

èµ·å› 
--

ä¸€ç›´ä»¥æ¥ï¼Œæˆ‘éƒ½æ˜¯ç›´æ¥åœ¨æµè§ˆå™¨ Tampermonkey æ‰©å±•é¡µé¢ç›´æ¥æ–°å»ºç”¨æˆ·è„šæœ¬æ¥å¼€å‘çš„ï¼š

![å›¾ 1](https://img2022.cnblogs.com/blog/1091021/202205/1091021-20220524203605783-1406731768.png)

å¯¹äºä¸€äº›ç®€å•çš„è„šæœ¬ï¼Œè¿™æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå³æ”¹å³çœ‹ã€‚ä½†å½“ä»£ç å¤šäº†ä»¥åé—®é¢˜å°±æ¥äº†ï¼Œè‡ªå¸¦ç¼–è¾‘å™¨å¼€å‘ä½“éªŒç¡®å®ä¸å¤ªèˆ’æœï¼Œæ²¡æœ‰æ ¼å¼åŒ–ï¼Œæ²¡æœ‰ä»£ç è¡¥å…¨ï¼Œæ— æ³•æ¨¡å—åŒ–ç¼–å†™ä»£ç ç­‰ç­‰ï¼Œè¿™æ—¶å€™æˆ‘å°±æƒ³å¯»æ‰¾ä¸€ä¸ªæ‰“åŒ…æ–¹æ¡ˆï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±çš„ç¼–è¾‘å™¨å¦‚ VSCode é‡Œå¼€å‘ï¼Œè¿™æ ·å°±å¯ä»¥å……åˆ†åˆ©ç”¨å‰ç«¯å·¥ç¨‹åŒ–çš„ä¾¿åˆ©ï¼Œæå‡å¼€å‘ä½“éªŒã€‚

å¸¸è§çš„æ‰“åŒ…å·¥å…·æ¯”å¦‚ webpackã€parcelã€rollup ç­‰ï¼Œé¦–å…ˆæ’é™¤ webpackï¼ˆç¬‘ï¼‰ï¼Œç„¶åè¯•äº†ä¸‹ parcelï¼Œæ•ˆæœä¸å¤ªç†æƒ³ï¼Œä¹‹åè¯•äº† rollup æ„Ÿè§‰è¿˜å¯ä»¥ã€‚è½¬çœ¼æƒ³åˆ°è¦ç”¨ vue å¼€å‘ï¼Œé‚£å°±ç›´æ¥ä¸Š vite å§ ğŸ˜‚ï¼Œvite ä¹Ÿæ˜¯ç”¨ rollup æ¥æ‰“åŒ…ç”Ÿäº§ä»£ç çš„ã€‚

ç›´æ¥æ‰“å¼€ npmï¼Œçœ‹çœ‹æœ‰æ²¡æœ‰äººé€ è½®å­ï¼Œç„¶åå‘ç°ä¸‹é¢å‡ ä¸ªåŒ…ï¼š

*   gorilla (rollup æ’ä»¶ï¼‰
*   vite-plugin-tampermonkey
*   vite-plugin-monkey

è¿™å‡ ä¸ªéƒ½ç¬¦åˆåŸºæœ¬éœ€æ±‚ï¼Œå…¶ä¸­ `gorilla` ä¸èƒ½æ‰“åŒ…æ ·å¼ï¼Œå¦å¤–ä¸¤ä¸ªæ’ä»¶éƒ½å·®ä¸å¤šï¼Œé€‰äº† `vite-plugin-tampermonkey` è¿›è¡Œæ”¹é€ ã€‚

ä¿®æ”¹åçš„æ’ä»¶ï¼š [Github](https://github.com/asadahimeka/vite-plugin-tm-userscript) | [npm](https://www.npmjs.com/package/vite-plugin-tm-userscript)

æ’ä»¶ç‰¹ç‚¹
----

*   é€šè¿‡å•ç‹¬çš„é…ç½®æ–‡ä»¶æˆ–è€… `package.json` ä¸­çš„ `tmHeader` å­—æ®µæ¥é…ç½® Tampermonkey çš„ Userscript Header
*   æ„å»ºç”Ÿäº§æ—¶æ”¯æŒè‡ªåŠ¨åˆ†æä»£ç ç”¨åˆ°çš„ `grant`
*   å¼€å‘æ¨¡å¼æ—¶é»˜è®¤å¯¼å…¥æ‰€æœ‰ `grant`ï¼Œå¹¶ä¸”æŠŠæ‰€æœ‰çš„ `grant` æ–¹æ³•åŠ å…¥åˆ° `unsafeWindow`
*   å¯é€šè¿‡ç®€å•é…ç½®ï¼ŒæŠŠå¼•å…¥çš„å¤–éƒ¨åŒ… `require` åŒ–ï¼Œè‡ªåŠ¨å¼•å…¥ jsdelivr CDN ï¼Œè¯¦æƒ…è§ä¸‹é¢çš„æ’ä»¶é…ç½®

å¼€å§‹ä¹‹å‰
----

[Vite å®˜æ–¹ä¸­æ–‡æ–‡æ¡£](https://cn.vitejs.dev/)

[Tampermonkey æ–‡æ¡£](https://www.tampermonkey.net/documentation.php)

[gorilla](https://github.com/apsking/gorilla)

[vite-plugin-tampermonkey](https://www.npmjs.com/package/vite-plugin-tampermonkey)

[vite-plugin-monkey](https://github.com/lisonge/vite-plugin-monkey)

åˆå§‹åŒ–é¡¹ç›®
-----

> å…¼å®¹æ€§æ³¨æ„  
> Vite éœ€è¦ Node.js ç‰ˆæœ¬ >= 12.0.0ã€‚ç„¶è€Œï¼Œæœ‰äº›æ¨¡æ¿éœ€è¦ä¾èµ–æ›´é«˜çš„ Node ç‰ˆæœ¬æ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œå½“ä½ çš„åŒ…ç®¡ç†å™¨å‘å‡ºè­¦å‘Šæ—¶ï¼Œè¯·æ³¨æ„å‡çº§ä½ çš„ Node ç‰ˆæœ¬ã€‚

ä½¿ç”¨ NPM:

    $ npm create vite@latest
    

ä½¿ç”¨ Yarn:

    $ yarn create vite
    

ä½¿ç”¨ PNPM:

    $ pnpm create vite
    

æŒ‰éœ€é€‰æ‹©æ¡†æ¶

![å›¾ 3](https://img2022.cnblogs.com/blog/1091021/202205/1091021-20220524203605659-1756233921.png)

æ¨èä½¿ç”¨ TypeScript

![å›¾ 4](https://img2022.cnblogs.com/blog/1091021/202205/1091021-20220524203605883-1456968752.png)

ç„¶ååˆ°é¡¹ç›®ç›®å½•å¼€å§‹å®‰è£…ä¾èµ–

æ’ä»¶ä½¿ç”¨
----

### å®‰è£…

    yarn add vite-plugin-tm-userscript -D
    # OR
    npm install vite-plugin-tm-userscript -D
    

### é…ç½® `vite.config.ts`

    import { defineConfig } from 'vite'
    import Userscript from 'vite-plugin-tm-userscript'
    
    // https://vitejs.dev/config/
    export default defineConfig({
      plugins: [
        Userscript({
          externalGlobals: ['vue']
        })
      ]
    })
    

### é…ç½® Userscript Header

æœ‰å››ç§æ–¹å¼æ¥é…ç½® `Userscript Header`, ä¼˜å…ˆçº§å¦‚ä¸‹æ‰€ç¤º

1.  `header.config.json`
2.  `header.config.js`
3.  `header.config.txt`
4.  `package.json` ä¸­çš„ `tmHeader` å­—æ®µ

å…¶ä¸­ `header.config.txt` ä½¿ç”¨ Tampermonkey å¤´éƒ¨æ³¨é‡Šé…ç½®ï¼Œä¸ä¼šç»è¿‡å¤„ç†ï¼Œç›´æ¥æ’å…¥è„šæœ¬å¤´éƒ¨ä½œä¸º Header ä½¿ç”¨

å…¶ä»–ä¸‰ç§æ ¼å¼æŒ‰ json æ ¼å¼é…ç½®ï¼Œå¤šä¸ªå±æ€§é…ç½®å¦‚ `match` ç”¨æ•°ç»„è¡¨ç¤ºï¼Œç»è¿‡å¤„ç†è‡ªåŠ¨æ·»åŠ  `grant` ä¸ `require`

ç¤ºä¾‹é…ç½®è§ `example/header.config.js`

ä½¿ç”¨ js æ–‡ä»¶æ¥é…ç½®çš„å¥½å¤„æ˜¯å¯ä»¥æœ‰è‡ªåŠ¨è¡¥å…¨ï¼š

![å›¾ 5](https://img2022.cnblogs.com/blog/1091021/202205/1091021-20220524203606028-695197173.png)

å…·ä½“å±æ€§é…ç½®è§ [Tampermonkey æ–‡æ¡£](https://www.tampermonkey.net/documentation.php)

æ’ä»¶é…ç½®
----

    export interface TMPluginOptions {
      entry?: string;
      autoGrant?: boolean;
      externalGlobals?: string[] | Record<string, string | string[]>;
    }
    

### `externalGlobals`

é…ç½®å¤–éƒ¨åŒ…ï¼Œæ¯”å¦‚ `vue`ï¼Œ`axios` ç­‰ï¼Œå‡å°‘æ‰“åŒ…ä½“ç§¯ï¼Œå¹¶ä¸”ä¼šè‡ªåŠ¨å£°æ˜ `require` ï¼Œå¦‚ä¸‹é…ç½®ï¼š

ä¸‰ç§é…ç½®å½¢å¼ï¼Œå¯è‡ªå®šä¹‰ CDNï¼Œä¸é…ç½® CDN çš„è¯é»˜è®¤ä½¿ç”¨ jsdelivr CDN

    // 1
    TMPlugin({
      externalGlobals: ['jquery']
    })
    
    // 2
    TMPlugin({
      externalGlobals: {
        'jquery': 'jQuery'
      }
    })
    
    // 3
    TMPlugin({
      externalGlobals: {
        'jquery': ['jQuery', 'https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js']
      }
    })
    
    // =>
    
    return {
      rollupOptions: {
        external: ['jquery']
        output: {
          globals: {
            jquery: 'jQuery'
          }
        }
      }
    }
    
    // @require https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js
    

### `autoGrant`

`boolean` ç±»å‹ï¼Œé»˜è®¤ä¸º `true`

è‡ªåŠ¨åˆ†æä»£ç ä¸­ä½¿ç”¨çš„ Tampermonkey çš„ `grant`ï¼Œå¹¶åŠ å…¥ Userscript Header å£°æ˜ä¸­

### `entry`

å…¥å£æ–‡ä»¶ï¼Œé»˜è®¤ä¸º `src/main.js` æˆ–è€… `src/main.ts`

å¼€å‘å¯åŠ¨
----

`npm run dev` æˆ– `yarn dev` è¿è¡Œå¼€å‘æœåŠ¡ï¼Œç„¶åç‚¹å‡»ä¸‹å›¾æ‰€ç¤ºé“¾æ¥å®‰è£…

![å›¾ 6](https://img2022.cnblogs.com/blog/1091021/202205/1091021-20220524203605823-2067116955.png)

ç”Ÿäº§æ‰“åŒ…
----

`npm run build` æˆ– `yarn build` è¿›è¡Œç”Ÿäº§æ¨¡å¼æ‰“åŒ…ï¼Œæ‰“åŒ…æ–‡ä»¶æ”¾åœ¨ `dist` æ–‡ä»¶å¤¹é‡Œ

ç„¶åå¯ä»¥å‘å¸ƒåˆ°æ’ä»¶å¸‚åœºæˆ–è€…ç›´æ¥å®‰è£…åˆ°æµè§ˆå™¨

ç¤ºä¾‹
--

[https://github.com/asadahimeka/vite-plugin-tm-userscript/tree/master/example](https://github.com/asadahimeka/vite-plugin-tm-userscript/tree/master/example)

è¯´æ˜
--

### vite é…ç½®é¢å¤–è¯´æ˜

ç”Ÿäº§æ„å»ºæ¨¡å¼å°†å¼ºåˆ¶é…ç½® `config.build`:

*   æ„å»ºçš„åŒ…åä¸º `package.json` çš„ `name` ï¼ˆ**å¿…é¡»å¡«å†™**ï¼‰å±æ€§çš„é©¼å³°æ¨¡å¼ï¼Œæ„å»ºçš„æ–‡ä»¶åä¹Ÿä¸å…¶ç›¸å…³
*   æ–‡ä»¶æ‰“åŒ…æ ¼å¼ä¸º `iife`ï¼Œä¸å‹ç¼©ï¼Œä¸åˆ†ç¦» `css` æ–‡ä»¶
*   é¢å¤–é…ç½®äº† `rollupOptions`ï¼Œä»¥æ”¯æŒå…¶ä»–åŠŸèƒ½

### ç¦æ­¢ CSP(Content-Security-Policy)

åœ¨å¼€å‘æ¨¡å¼ä¸‹ï¼Œéœ€è¦é€šè¿‡ `script` æ ‡ç­¾æ³¨å…¥ `vite` çš„è„šæœ¬ï¼Œæœ‰äº›ç½‘ç«™å¼€å¯äº† `CSP(Content-Security-Policy)`ï¼Œå¯¼è‡´æŠ¥é”™ï¼Œå¯ä»¥å®‰è£… `Chrome` æ’ä»¶ [Disable Content-Security-Policy](https://chrome.google.com/webstore/detail/disable-content-security/ieelmcmcagommplceebfedjlakkhpden) æˆ–è€… [Always Disable Content-Security-Policy](https://chrome.google.com/webstore/detail/always-disable-content-se/ffelghdomoehpceihalcnbmnodohkibj)ï¼Œæ¥ç¦æ­¢ `CSP(Content-Security-Policy)`ï¼Œ**åœ¨å¼€å‘æ—¶å¼€å¯æ’ä»¶å³å¯ï¼ˆå…¶ä»–æ—¶é—´è®°å¾—å…³é—­ä»¥ä¿è¯ç½‘é¡µæµè§ˆçš„å®‰å…¨æ€§ï¼‰**ã€‚

* * *

_fin._