---
layout: post
title: "å¦‚ä½•ä½¿ç”¨ LinkedHashMap å®ç° LRU ç¼“å­˜ï¼Ÿ"
date: "2022-12-01T04:22:11.927Z"
---
å¦‚ä½•ä½¿ç”¨ LinkedHashMap å®ç° LRU ç¼“å­˜ï¼Ÿ
=============================

> **æœ¬æ–‡å·²æ”¶å½•åˆ° [AndroidFamily](https://github.com/pengxurui/AndroidFamily)ï¼ŒæŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] æé—®ã€‚**

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

[åœ¨ä¸Šä¸€ç¯‡æ–‡ç« é‡Œ](https://juejin.cn/post/7163985718417555487)ï¼Œæˆ‘ä»¬èŠåˆ°äº† HashMap çš„å®ç°åŸç†å’Œæºç åˆ†æï¼Œåœ¨æºç åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°ä¸€äº› LinkedHashMap ç›¸å…³çš„æºç ï¼Œå½“æ—¶æ²¡æœ‰å±•å¼€ï¼Œç°åœ¨å®ƒæ¥äº†ã€‚

é‚£ä¹ˆï¼ŒLinkedHashMap ä¸ HashMap æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå…¶å®ï¼ŒLinkedHashMap çš„ä½¿ç”¨åœºæ™¯éå¸¸æ˜ç¡® â€”â€” LRU ç¼“å­˜ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°±æ¥è®¨è®º LinkedHashMap æ˜¯å¦‚ä½•å®ç° LRU ç¼“å­˜çš„ã€‚

æœ¬æ–‡æºç åŸºäº Java 8 LinkedHashMapã€‚

* * *

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤å·²ç»å»ºç«‹å•¦ï¼Œæ‰«ææ–‡æœ«äºŒç»´ç è¿›å…¥~

* * *

**æ€ç»´å¯¼å›¾ï¼š**

![](https://files.mdnice.com/user/3257/a6182185-c573-4402-9f81-a35ba24bd70a.png)

* * *

1\. è®¤è¯† LRU ç¼“å­˜æ·˜æ±°ç®—æ³•
-----------------

### 1.1 ä»€ä¹ˆæ˜¯ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Ÿ

ç¼“å­˜æ˜¯æé«˜æ•°æ®è¯»å–æ€§èƒ½çš„é€šç”¨æŠ€æœ¯ï¼Œåœ¨ç¡¬ä»¶å’Œè½¯ä»¶è®¾è®¡ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¾‹å¦‚ [CPU ç¼“å­˜](https://mp.weixin.qq.com/s/oHsISqb-TUiu11q58ZDCmg)ã€Glide å†…å­˜ç¼“å­˜ï¼Œæ•°æ®åº“ç¼“å­˜ç­‰ã€‚ç”±äºç¼“å­˜ç©ºé—´ä¸å¯èƒ½æ— é™å¤§ï¼Œå½“ç¼“å­˜å®¹é‡å æ»¡æ—¶ï¼Œå°±éœ€è¦åˆ©ç”¨æŸç§ç­–ç•¥å°†éƒ¨åˆ†æ•°æ®æ¢å‡ºç¼“å­˜ï¼Œè¿™å°±æ˜¯ç¼“å­˜çš„æ›¿æ¢ç­–ç•¥ / æ·˜æ±°é—®é¢˜ã€‚å¸¸è§ç¼“å­˜æ·˜æ±°ç­–ç•¥æœ‰ï¼š

*   **1ã€éšæœºç­–ç•¥ï¼š** ä½¿ç”¨ä¸€ä¸ªéšæœºæ•°ç”Ÿæˆå™¨éšæœºåœ°é€‰æ‹©è¦è¢«æ·˜æ±°çš„æ•°æ®å—ï¼›
    
*   **2ã€FIFO å…ˆè¿›å…ˆå‡ºç­–ç•¥ï¼š** è®°å½•å„ä¸ªæ•°æ®å—çš„è®¿é—®æ—¶é—´ï¼Œæœ€æ—©è®¿é—®çš„æ•°æ®æœ€å…ˆè¢«æ·˜æ±°ï¼›
    
*   **3ã€LRU ï¼ˆLeast Recently Usedï¼‰æœ€è¿‘æœ€å°‘ç­–ç•¥ï¼š** è®°å½•å„ä¸ªæ•°æ®å—çš„è®¿é—® **â€œæ—¶é—´æˆ³â€** ï¼Œæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®æœ€å…ˆè¢«æ·˜æ±°ã€‚ä¸å‰ 2 ç§ç­–ç•¥ç›¸æ¯”ï¼ŒLRU ç­–ç•¥å¹³å‡ç¼“å­˜å‘½ä¸­ç‡æ›´é«˜ï¼Œè¿™æ˜¯å› ä¸º LRU ç­–ç•¥åˆ©ç”¨äº† â€œå±€éƒ¨æ€§åŸç†â€ï¼šæœ€è¿‘è¢«è®¿é—®è¿‡çš„æ•°æ®ï¼Œå°†æ¥è¢«è®¿é—®çš„å‡ ç‡è¾ƒå¤§ï¼Œæœ€è¿‘å¾ˆä¹…æœªè®¿é—®çš„æ•°æ®ï¼Œå°†æ¥è®¿é—®çš„å‡ ç‡ä¹Ÿè¾ƒå°ï¼›
    
*   **4ã€LFU ï¼ˆLeast Frequently Usedï¼‰æœ€ä¸ç»å¸¸ä½¿ç”¨ç­–ç•¥ï¼š** ä¸ LRU ç›¸æ¯”ï¼ŒLFU æ›´åŠ æ³¨é‡ä½¿ç”¨çš„ **â€œé¢‘ç‡â€** ã€‚LFU ä¼šè®°å½•æ¯ä¸ªæ•°æ®å—çš„è®¿é—®æ¬¡æ•°ï¼Œæœ€å°‘è®¿é—®æ¬¡æ•°çš„æ•°æ®æœ€å…ˆè¢«æ·˜æ±°ã€‚ä½†æ˜¯æœ‰äº›æ•°æ®åœ¨å¼€å§‹æ—¶ä½¿ç”¨æ¬¡æ•°å¾ˆé«˜ï¼Œä»¥åä¸å†ä½¿ç”¨ï¼Œè¿™äº›æ•°æ®å°±ä¼šé•¿æ—¶é—´æ±¡æŸ“ç¼“å­˜ã€‚å¯ä»¥å®šæœŸå°†è®¡æ•°å™¨å³ç§»ä¸€ä½ï¼Œå½¢æˆæŒ‡æ•°è¡°å‡ã€‚
    

`FIFO ä¸ LRU ç­–ç•¥`

![](https://files.mdnice.com/user/3257/cb587558-3ba9-493c-bc25-f265372f4478.png)

### 1.2 å‘å¤–çœ‹ï¼šLRU çš„å˜å‹

å…¶å®ï¼Œåœ¨æ ‡å‡†çš„ LRU ç®—æ³•ä¸Šè¿˜æœ‰ä¸€äº›å˜å‹å®ç°ï¼Œè¿™æ˜¯å› ä¸º LRU ç®—æ³•æœ¬èº«ä¹Ÿå­˜åœ¨ä¸€äº›ä¸è¶³ã€‚ä¾‹å¦‚ï¼Œå½“æ•°æ®ä¸­çƒ­ç‚¹æ•°æ®è¾ƒå¤šæ—¶ï¼ŒLRU èƒ½å¤Ÿä¿è¯è¾ƒé«˜çš„å‘½ä¸­ç‡ã€‚ä½†æ˜¯å½“æœ‰å¶å‘çš„æ‰¹é‡çš„éçƒ­ç‚¹æ•°æ®äº§ç”Ÿæ—¶ï¼Œå°±ä¼šå°†çƒ­ç‚¹æ•°æ®å¯„å‡ºç¼“å­˜ï¼Œä½¿å¾—ç¼“å­˜è¢«æ±¡æŸ“ã€‚å› æ­¤ï¼ŒLRU ä¹Ÿæœ‰ä¸€äº›å˜å‹ï¼š

*   **LRU-Kï¼š** æä¾›ä¸¤ä¸ª LRU é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯è®¿é—®è®¡æ•°é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯æ ‡å‡†çš„ LRU é˜Ÿåˆ—ï¼Œä¸¤ä¸ªé˜Ÿåˆ—éƒ½æŒ‰ç…§ LRU è§„åˆ™æ·˜æ±°æ•°æ®ã€‚å½“è®¿é—®ä¸€ä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®å…ˆè¿›å…¥è®¿é—®è®¡æ•°é˜Ÿåˆ—ï¼Œå½“æ•°æ®è®¿é—®æ¬¡æ•°è¶…è¿‡ K æ¬¡åï¼Œæ‰ä¼šè¿›å…¥æ ‡å‡† LRU é˜Ÿåˆ—ã€‚æ ‡å‡†çš„ LRU ç®—æ³•ç›¸å½“äº LRU-1ï¼›
*   **Two Queueï¼š** ç›¸å½“äº LRU-2 çš„å˜å‹ï¼Œå°†è®¿é—®è®¡æ•°é˜Ÿåˆ—æ›¿æ¢ä¸º FIFO é˜Ÿåˆ—æ·˜æ±°æ•°æ®æ•°æ®ã€‚å½“è®¿é—®ä¸€ä¸ªæ•°æ®æ—¶ï¼Œæ•°æ®å…ˆè¿›å…¥ FIFO é˜Ÿåˆ—ï¼Œå½“ç¬¬ 2 æ¬¡è®¿é—®æ•°æ®æ—¶ï¼Œæ‰ä¼šè¿›å…¥æ ‡å‡† LRU é˜Ÿåˆ—ï¼›
*   **Multi Queueï¼š** åœ¨ LRU-K çš„åŸºç¡€ä¸Šå¢åŠ æ›´å¤šé˜Ÿåˆ—ï¼Œæä¾›å¤šä¸ªçº§åˆ«çš„ç¼“å†²ã€‚

> å°å½­åœ¨ Redis å’Œ Vue ä¸­æœ‰çœ‹åˆ°è¿™äº› LRU å˜å‹çš„åº”ç”¨ï¼Œåœ¨ Android é¢†åŸŸçš„æ¡†æ¶ä¸­è¿˜æ²¡æœ‰çœ‹åˆ°å…·ä½“åº”ç”¨ï¼Œä½ çŸ¥é“çš„è¯å¯ä»¥æé†’æˆ‘ã€‚

### 1.3 å¦‚ä½•å®ç° LRU ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Ÿ

è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å°è¯•æ‰¾åˆ° LRU ç¼“å­˜æ·˜æ±°ç®—æ³•çš„å®ç°æ–¹æ¡ˆã€‚ç»è¿‡æ€»ç»“ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œï¼š

*   **æ“ä½œ 1 - æ·»åŠ æ•°æ®ï¼š** å…ˆæŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ æ•°æ®ï¼Œå­˜åœ¨åˆ™æ›´æ–°æ•°æ®ï¼Œå¹¶å°è¯•æ·˜æ±°æ•°æ®ï¼›
*   **æ“ä½œ 2 - åˆ é™¤æ•°æ®ï¼š** å…ˆæŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™åˆ é™¤æ•°æ®ï¼›
*   **æ“ä½œ 3 - æŸ¥è¯¢æ•°æ®ï¼š** å¦‚æœæ•°æ®ä¸å­˜åœ¨åˆ™è¿”å› nullï¼›
*   **æ“ä½œ 4 - æ·˜æ±°æ•°æ®ï¼š** æ·»åŠ æ•°æ®æ—¶å¦‚æœå®¹é‡å·²æ»¡ï¼Œåˆ™æ ¹æ®ç¼“å­˜æ·˜æ±°ç­–ç•¥ä¸€ä¸ªæ•°æ®ã€‚

æˆ‘ä»¬å‘ç°ï¼Œå‰ 3 ä¸ªæ“ä½œéƒ½æœ‰ â€œæŸ¥è¯¢â€ æ“ä½œï¼Œ **æ‰€ä»¥ç¼“å­˜ç³»ç»Ÿçš„æ€§èƒ½ä¸»è¦å–å†³äºæŸ¥æ‰¾æ•°æ®å’Œæ·˜æ±°æ•°æ®æ˜¯å¦é«˜æ•ˆã€‚** ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨é€’æ¨çš„æ€è·¯æ¨å¯¼ LRU ç¼“å­˜çš„å®ç°æ–¹æ¡ˆï¼Œä¸»è¦åˆ†ä¸º 3 ç§æ–¹æ¡ˆï¼š

*   **æ–¹æ¡ˆ 1 - åŸºäºæ—¶é—´æˆ³çš„æ•°ç»„ï¼š** åœ¨æ¯ä¸ªæ•°æ®å—ä¸­è®°å½•æœ€è¿‘è®¿é—®çš„æ—¶é—´æˆ³ï¼Œå½“æ•°æ®è¢«è®¿é—®ï¼ˆæ·»åŠ ã€æ›´æ–°æˆ–æŸ¥è¯¢ï¼‰æ—¶ï¼Œå°†æ•°æ®çš„æ—¶é—´æˆ³æ›´æ–°åˆ°å½“å‰æ—¶é—´ã€‚å½“æ•°ç»„ç©ºé—´å·²æ»¡æ—¶ï¼Œåˆ™æ‰«ææ•°ç»„æ·˜æ±°æ—¶é—´æˆ³æœ€å°çš„æ•°æ®ã€‚
    
    *   æŸ¥æ‰¾æ•°æ®ï¼š éœ€è¦éå†æ•´ä¸ªæ•°ç»„æ‰¾åˆ°ç›®æ ‡æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼›
    *   æ·˜æ±°æ•°æ®ï¼š éœ€è¦éå†æ•´ä¸ªæ•°ç»„æ‰¾åˆ°æ—¶é—´æˆ³æœ€å°çš„æ•°æ®ï¼Œä¸”åœ¨ç§»é™¤æ•°ç»„å…ƒç´ æ—¶éœ€è¦æ¬è¿æ•°æ®ï¼Œæ•´ä½“æ—¶é—´å¤æ‚åº¦ä¸º O(n)ã€‚
*   **æ–¹æ¡ˆ 2 - åŸºäºåŒå‘é“¾è¡¨ï¼š** ä¸å†ç›´æ¥ç»´æŠ¤æ—¶é—´æˆ³ï¼Œè€Œæ˜¯åˆ©ç”¨é“¾è¡¨çš„é¡ºåºéšå¼ç»´æŠ¤æ—¶é—´æˆ³çš„å…ˆåé¡ºåºã€‚å½“æ•°æ®è¢«è®¿é—®ï¼ˆæ·»åŠ ã€æ›´æ–°æˆ–æŸ¥è¯¢ï¼‰æ—¶ï¼Œå°†æ•°æ®æ’å…¥åˆ°é“¾è¡¨å¤´éƒ¨ã€‚å½“ç©ºé—´å·²æ»¡æ—¶ï¼Œç›´æ¥æ·˜æ±°é“¾è¡¨çš„å°¾èŠ‚ç‚¹ã€‚
    
    *   æŸ¥è¯¢æ•°æ®ï¼šéœ€è¦éå†æ•´ä¸ªé“¾è¡¨æ‰¾åˆ°ç›®æ ‡æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(n)ï¼›
    *   æ·˜æ±°æ•°æ®ï¼šç›´æ¥æ·˜æ±°é“¾è¡¨å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
*   **æ–¹æ¡ˆ 3 - åŸºäºåŒå‘é“¾è¡¨ + æ•£åˆ—è¡¨ï¼š** ä½¿ç”¨åŒå‘é“¾è¡¨å¯ä»¥å°†æ·˜æ±°æ•°æ®çš„æ—¶é—´å¤æ‚åº¦é™ä½ä¸º O(1)ï¼Œä½†æ˜¯æŸ¥è¯¢æ•°æ®çš„æ—¶é—´å¤æ‚åº¦è¿˜æ˜¯ O(n)ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒå‘é“¾è¡¨çš„åŸºç¡€ä¸Šå¢åŠ æ•£åˆ—è¡¨ï¼Œå°†æŸ¥è¯¢æ“ä½œçš„æ—¶é—´å¤æ‚åº¦é™ä½ä¸º O(1)ã€‚
    
    *   æŸ¥è¯¢æ•°æ®ï¼šé€šè¿‡æ•£åˆ—è¡¨å®šä½æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
    *   æ·˜æ±°æ•°æ®ï¼šç›´æ¥æ·˜æ±°é“¾è¡¨å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

æ–¹æ¡ˆ 3 è¿™ç§æ•°æ®ç»“æ„å°±å« â€œå“ˆå¸Œé“¾è¡¨æˆ–é“¾å¼å“ˆå¸Œè¡¨â€ï¼Œæˆ‘æ›´å€¾å‘äºç§°ä¸ºå“ˆå¸Œé“¾è¡¨ï¼Œå› ä¸ºå½“è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„ç›¸ç»“åˆæ—¶ï¼Œæˆ‘ä»¬æ›´çœ‹é‡çš„æ˜¯å®ƒä½œä¸ºé“¾è¡¨çš„æ’åºèƒ½åŠ›ã€‚

æˆ‘ä»¬ä»Šå¤©è¦è®¨è®ºçš„ Java LinkedHashMap å°±æ˜¯åŸºäºå“ˆå¸Œé“¾è¡¨çš„æ•°æ®ç»“æ„ã€‚

* * *

2\. è®¤è¯† LinkedHashMap å“ˆå¸Œé“¾è¡¨
-------------------------

### 2.1 è¯´ä¸€ä¸‹ LinkedHashMap çš„ç‰¹ç‚¹

éœ€è¦æ³¨æ„ï¼šLinkedHashMap ä¸­çš„ **â€œLinkedâ€** å®é™…ä¸Šæ˜¯æŒ‡åŒå‘é“¾è¡¨ï¼Œå¹¶ä¸æ˜¯æŒ‡è§£å†³æ•£åˆ—å†²çªä¸­çš„åˆ†ç¦»é“¾è¡¨æ³•ã€‚

*   1ã€LinkedHashMap æ˜¯ç»§æ‰¿äº HashMap å®ç°çš„å“ˆå¸Œé“¾è¡¨ï¼Œå®ƒåŒæ—¶å…·å¤‡åŒå‘é“¾è¡¨å’Œæ•£åˆ—è¡¨çš„ç‰¹ç‚¹ã€‚äº‹å®ä¸Šï¼ŒLinkedHashMap ç»§æ‰¿äº† HashMap çš„ä¸»è¦åŠŸèƒ½ï¼Œå¹¶é€šè¿‡ HashMap é¢„ç•™çš„ Hook ç‚¹ç»´æŠ¤åŒå‘é“¾è¡¨çš„é€»è¾‘ã€‚
    
    *   1.1 å½“ LinkedHashMap ä½œä¸ºæ•£åˆ—è¡¨æ—¶ï¼Œä¸»è¦ä½“ç°å‡º O(1) æ—¶é—´å¤æ‚åº¦çš„æŸ¥è¯¢æ•ˆç‡ï¼›
    *   1.2 å½“ LinkedHashMap ä½œä¸ºåŒå‘é“¾è¡¨æ—¶ï¼Œä¸»è¦ä½“ç°å‡ºæœ‰åºçš„ç‰¹æ€§ã€‚
*   2ã€LinkedHashMap æ”¯æŒ 2 ç§æ’åºæ¨¡å¼ï¼Œè¿™æ˜¯é€šè¿‡æ„é€ å™¨å‚æ•° `accessOrder` æ ‡è®°ä½æ§åˆ¶çš„ï¼Œè¡¨ç¤ºæ˜¯å¦æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œé»˜è®¤ä¸º false æŒ‰ç…§æ’å…¥é¡ºåºã€‚
    
    *   **2.1 æ’å…¥é¡ºåºï¼ˆé»˜è®¤ï¼‰ï¼š** æŒ‰ç…§æ•°æ®æ·»åŠ åˆ° LinkedHashMap çš„é¡ºåºæ’åºï¼Œå³ FIFO ç­–ç•¥ï¼›
    *   **2.2 è®¿é—®é¡ºåºï¼š** æŒ‰ç…§æ•°æ®è¢«è®¿é—®ï¼ˆåŒ…æ‹¬æ’å…¥ã€æ›´æ–°ã€æŸ¥è¯¢ï¼‰çš„é¡ºåºæ’åºï¼Œå³ LRU ç­–ç•¥ã€‚
*   3ã€åœ¨æœ‰åºæ€§çš„åŸºç¡€ä¸Šï¼ŒLinkedHashMap æä¾›äº†ç»´æŠ¤äº†æ·˜æ±°æ•°æ®èƒ½åŠ›ï¼Œå¹¶å¼€æ”¾äº†æ·˜æ±°åˆ¤æ–­çš„æ¥å£ `removeEldestEntry()`ã€‚åœ¨æ¯æ¬¡æ·»åŠ æ•°æ®æ—¶ï¼Œä¼šå›è°ƒ `removeEldestEntry()` æ¥å£ï¼Œå¼€å‘è€…å¯ä»¥é‡å†™è¿™ä¸ªæ¥å£å†³å®šæ˜¯å¦ç§»é™¤æœ€æ—©çš„èŠ‚ç‚¹ï¼ˆåœ¨ FIFO ç­–ç•¥ä¸­æ˜¯æœ€æ—©æ·»åŠ çš„èŠ‚ç‚¹ï¼Œåœ¨ LRU ç­–ç•¥ä¸­æ˜¯æœ€æ—©æœªè®¿é—®çš„èŠ‚ç‚¹ï¼‰ï¼›
    
*   4ã€ä¸ HashMap ç›¸åŒï¼ŒLinkedHashMap ä¹Ÿä¸è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¯ä»¥ä½¿ç”¨ Collections.synchronizedMap åŒ…è£…ç±»ï¼Œå…¶åŸç†ä¹Ÿæ˜¯åœ¨æ‰€æœ‰æ–¹æ³•ä¸Šå¢åŠ  synchronized å…³é”®å­—ã€‚
    

### 2.2 è¯´ä¸€ä¸‹ HashMap å’Œ LinkedHashMap çš„åŒºåˆ«ï¼Ÿ

äº‹å®ä¸Šï¼ŒHashMap å’Œ LinkedHashMap å¹¶ä¸æ˜¯å¹³è¡Œçš„å…³ç³»ï¼Œè€Œæ˜¯ç»§æ‰¿çš„å…³ç³»ï¼ŒLinkedHashMap æ˜¯ç»§æ‰¿äº HashMap å®ç°çš„å“ˆå¸Œé“¾è¡¨ã€‚

**ä¸¤è€…ä¸»è¦çš„åŒºåˆ«åœ¨äºæœ‰åºæ€§ï¼š** LinkedHashMap ä¼šç»´æŠ¤æ•°æ®çš„æ’å…¥é¡ºåºæˆ–è®¿é—®é¡ºåºï¼Œè€Œä¸”å°è£…äº†æ·˜æ±°æ•°æ®çš„èƒ½åŠ›ã€‚åœ¨è¿­ä»£å™¨éå†æ—¶ï¼ŒHashMap ä¼šæŒ‰ç…§æ•°ç»„é¡ºåºéå†æ¡¶èŠ‚ç‚¹ï¼Œä»å¼€å‘è€…çš„è§†è§’çœ‹æ˜¯æ— åºçš„ã€‚è€Œæ˜¯æŒ‰ç…§åŒå‘é“¾è¡¨çš„é¡ºåºä» head èŠ‚ç‚¹å¼€å§‹éå†ï¼Œä»å¼€å‘è€…çš„è§†è§’æ˜¯å¯ä»¥æ„ŸçŸ¥åˆ°çš„æ’å…¥é¡ºåºæˆ–è®¿é—®é¡ºåºã€‚

`LinkedHashMap ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/f0fd142e-7a82-48ec-a7f2-c8bc4c0bd535.png)

* * *

3\. HashMap é¢„ç•™çš„ Hook ç‚¹
----------------------

LinkedHashMap ç»§æ‰¿äº HashMapï¼Œåœ¨åè€…çš„åŸºç¡€ä¸Šé€šè¿‡åŒå‘é“¾è¡¨ç»´æŠ¤èŠ‚ç‚¹çš„æ’å…¥é¡ºåºæˆ–è®¿é—®é¡ºåºã€‚å› æ­¤ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸‹ HashMap ä¸º LinkedHashMap é¢„ç•™çš„ Hook ç‚¹ï¼š

*   **afterNodeAccessï¼š** åœ¨èŠ‚ç‚¹è¢«è®¿é—®æ—¶å›è°ƒï¼›
*   **afterNodeInsertionï¼š** åœ¨èŠ‚ç‚¹è¢«æ’å…¥æ—¶å›è°ƒï¼Œå…¶ä¸­æœ‰å‚æ•° `evict` æ ‡è®°æ˜¯å¦æ·˜æ±°æœ€æ—©çš„èŠ‚ç‚¹ã€‚åœ¨åˆå§‹åŒ–ã€ååºåˆ—åŒ–æˆ–å…‹éš†ç­‰æ„é€ è¿‡ç¨‹ä¸­ï¼Œ`evict` é»˜è®¤ä¸º falseï¼Œè¡¨ç¤ºåœ¨æ„é€ è¿‡ç¨‹ä¸­ä¸æ·˜æ±°ã€‚
*   **afterNodeRemovalï¼š** åœ¨èŠ‚ç‚¹è¢«ç§»é™¤æ—¶å›è°ƒã€‚

`HashMap.java`

    // èŠ‚ç‚¹è®¿é—®å›è°ƒ
    void afterNodeAccess(Node<K,V> p) { }
    // èŠ‚ç‚¹æ’å…¥å›è°ƒ
    // evictï¼šæ˜¯å¦æ·˜æ±°æœ€æ—©çš„èŠ‚ç‚¹
    void afterNodeInsertion(boolean evict) { }
    // èŠ‚ç‚¹ç§»é™¤å›è°ƒ
    void afterNodeRemoval(Node<K,V> p) { }
    

é™¤æ­¤äº†è¿™ 3 ä¸ªç©ºæ–¹æ³•å¤–ï¼ŒLinkedHashMap ä¹Ÿé‡å†™äº†éƒ¨åˆ† HashMap çš„æ–¹æ³•ï¼Œåœ¨å…¶ä¸­æ’å…¥åŒé“¾è¡¨çš„ç»´æŠ¤é€»è¾‘ï¼Œä¹Ÿç›¸å½“äº Hook ç‚¹ã€‚åœ¨ HashMap çš„æ·»åŠ ã€è·å–ã€ç§»é™¤æ–¹æ³•ä¸­ï¼Œä¸ LinkedHashMap æœ‰å…³çš„ Hook ç‚¹å¦‚ä¸‹ï¼š

### 3.1 HashMap çš„æ·»åŠ æ–¹æ³•ä¸­çš„ Hook ç‚¹

LinkedHashMap ç›´æ¥å¤ç”¨ HashMap çš„æ·»åŠ æ–¹æ³•ï¼Œä¹Ÿæ”¯æŒæ‰¹é‡æ·»åŠ ï¼š

*   **HashMap#putï¼š** é€ä¸ªæ·»åŠ æˆ–æ›´æ–°é”®å€¼å¯¹ï¼›
*   **HashMap#putAllï¼š** æ‰¹é‡æ·»åŠ æˆ–æ›´æ–°é”®å€¼å¯¹ã€‚

ä¸ç®¡æ˜¯é€ä¸ªæ·»åŠ è¿˜æ˜¯æ‰¹é‡æ·»åŠ ï¼Œæœ€ç»ˆéƒ½ä¼šå…ˆé€šè¿‡ hash å‡½æ•°è®¡ç®—é”®ï¼ˆKeyï¼‰çš„æ•£åˆ—å€¼ï¼Œå†é€šè¿‡ `HashMap#putVal` æ·»åŠ æˆ–æ›´æ–°é”®å€¼å¯¹ï¼Œè¿™äº›éƒ½æ˜¯ HashMap çš„è¡Œä¸ºã€‚å…³é”®çš„åœ°æ–¹åœ¨äºï¼šLinkedHashMap åœ¨ `HashMap#putVal` çš„ Hook ç‚¹ä¸­åŠ å…¥äº†åŒçº¿é“¾è¡¨çš„é€»è¾‘ã€‚åŒºåˆ† 2 ç§æƒ…å†µï¼š

*   **æ·»åŠ æ•°æ®ï¼š** å¦‚æœæ•°æ®ä¸å­˜åœ¨æ•£åˆ—è¡¨ä¸­ï¼Œåˆ™è°ƒç”¨ `newNode()` æˆ– `newTreeNode()` åˆ›å»ºèŠ‚ç‚¹ï¼Œå¹¶å›è°ƒ `afterNodeInsertion()`ï¼›
*   **æ›´æ–°æ•°æ®ï¼š** å¦‚æœæ•°æ®å­˜åœ¨æ•£åˆ—è¡¨ä¸­ï¼Œåˆ™æ›´æ–° Valueï¼Œå¹¶å›è°ƒ `afterNodeAccess()`ã€‚

`HashMap.java`

    // æ·»åŠ æˆ–æ›´æ–°é”®å€¼å¯¹
    public V put(K key, V value) {
        return putVal(hash(key) /*è®¡ç®—æ•£åˆ—å€¼*/, key, value, false, true);
    }
    
    // hashï¼šKey çš„æ•£åˆ—å€¼ï¼ˆç»è¿‡æ‰°åŠ¨ï¼‰
    final V putVal(int hash, K key, V value, boolean onlyIfAbsent, boolean evict) {
        Node<K,V>[] tab; 
        Node<K,V> p; 
        int n;
        int i;
        if ((tab = table) == null || (n = tab.length) == 0)
            n = (tab = resize()).length;
        // (n - 1) & hashï¼šæ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
        if ((p = tab[i = (n - 1) & hash]) == null)
            // çœç•¥éå†æ¡¶çš„ä»£ç ï¼Œå…·ä½“åˆ†æè§ HashMap æºç è®²è§£
    
            // 1.1 å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢èŠ‚ç‚¹
            p.next = newNode(hash, key, value, null);
            // 2.1 å¦‚æœèŠ‚ç‚¹å­˜åœ¨æ›´æ–°èŠ‚ç‚¹ Value
            if (e != null) {
                V oldValue = e.value;
                if (!onlyIfAbsent || oldValue == null)
                    e.value = value;
                // 2.2 Hookï¼šè®¿é—®èŠ‚ç‚¹å›è°ƒ
                afterNodeAccess(e);
                return oldValue;
            }
        }
        ++modCount;
        // æ‰©å®¹
        if (++size > threshold)
            resize();
        // 1.2 Hookï¼šæ–°å¢èŠ‚ç‚¹å›è°ƒ
        afterNodeInsertion(evict);
        return null;
    }
    

`HashMap#put ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/10d1c669-ddd0-492e-a860-6fe6bb12444d.png)

### 3.2 HashMap çš„è·å–æ–¹æ³•ä¸­çš„ Hook ç‚¹

LinkedHashMap é‡å†™äº† `HashMap#get` æ–¹æ³•ï¼Œåœ¨ HashMap ç‰ˆæœ¬çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº† `afterNodeAccess()` å›è°ƒã€‚

`HashMap.java`

    public V get(Object key) {
        Node<K,V> e;
        return (e = getNode(hash(key), key)) == null ? null : e.value;
    }
    

`LinkedHashMap.java`

    public V get(Object key) {
        Node<K,V> e;
        if ((e = getNode(hash(key), key)) == null)
            return null;
        // Hookï¼šèŠ‚ç‚¹è®¿é—®å›è°ƒ
        if (accessOrder)
            afterNodeAccess(e);
        return e.value;
    }
    
    public V getOrDefault(Object key, V defaultValue) {
        Node<K,V> e;
        if ((e = getNode(hash(key), key)) == null)
            return defaultValue;
        // Hookï¼šèŠ‚ç‚¹è®¿é—®å›è°ƒ
        if (accessOrder)
            afterNodeAccess(e);
        return e.value;
    }
    

`HashMap#get ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/d4df4508-b8f2-4cfb-87cf-0920b0765fb8.png)

### 3.3 HashMap çš„ç§»é™¤æ–¹æ³•ä¸­çš„ Hook ç‚¹

LinkedHashMap ç›´æ¥å¤ç”¨ HashMap çš„ç§»é™¤æ–¹æ³•ï¼Œåœ¨ç§»é™¤èŠ‚ç‚¹åï¼Œå¢åŠ  `afterNodeRemoval()` å›è°ƒã€‚

`HashMap.java`

    // ç§»é™¤èŠ‚ç‚¹
    public V remove(Object key) {
        Node<K,V> e;
        return (e = removeNode(hash(key)/*è®¡ç®—æ•£åˆ—å€¼*/, key, null, false, true)) == null ? null : e.value;
    }
    
    final Node<K,V> removeNode(int hash, Object key, Object value,
    				boolean matchValue, boolean movable) {
        Node<K,V>[] tab; 
        Node<K,V> p; 
        int n, index;
        // (n - 1) & hashï¼šæ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
        if ((tab = table) != null && (n = tab.length) > 0 && (p = tab[index = (n - 1) & hash]) != null) {
            Node<K,V> node = null, e; K k; V v;
            // çœç•¥éå†æ¡¶çš„ä»£ç ï¼Œå…·ä½“åˆ†æè§ HashMap æºç è®²è§£
            // åˆ é™¤ node èŠ‚ç‚¹
            if (node != null && (!matchValue || (v = node.value) == value || (value != null && value.equals(v)))) {
                // çœç•¥åˆ é™¤èŠ‚ç‚¹çš„ä»£ç ï¼Œå…·ä½“åˆ†æè§ HashMap æºç è®²è§£
                ++modCount;
                --size;
                // Hookï¼šåˆ é™¤èŠ‚ç‚¹å›è°ƒ
                afterNodeRemoval(node);
                return node;
            }
        }
        return null;
    }
    

`HashMap#remove ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/3f19c251-29a1-4934-b251-617d05b94715.png)

* * *

4\. LinkedHashMap æºç åˆ†æ
----------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥åˆ†æ LinkedHashMap ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

### 4.1 LinkedHashMap çš„å±æ€§

*   LinkedHashMap ç»§æ‰¿äº HashMapï¼Œå¹¶ä¸”æ–°å¢ `head` å’Œ `tail` æŒ‡é’ˆæŒ‡å‘é“¾è¡¨çš„å¤´å°¾èŠ‚ç‚¹ï¼ˆä¸ LinkedList ç±»ä¼¼çš„å¤´å°¾èŠ‚ç‚¹ï¼‰ï¼›
*   LinkedHashMap çš„åŒé“¾è¡¨èŠ‚ç‚¹ Entry ç»§æ‰¿äº HashMap çš„å•é“¾è¡¨èŠ‚ç‚¹ Nodeï¼Œè€Œ HashMap çš„çº¢é»‘æ ‘èŠ‚ç‚¹ TreeNode ç»§æ‰¿äº LinkedHashMap çš„åŒé“¾è¡¨èŠ‚ç‚¹ Entryã€‚

`èŠ‚ç‚¹ç»§æ‰¿å…³ç³»`

![](https://files.mdnice.com/user/3257/7e224cb2-e439-4b5f-82cb-cf9f140a6f0c.png)

`LinkedHashMap.java`

    public class LinkedHashMap<K,V> extends HashMap<K,V> implements Map<K,V> {
        // å¤´æŒ‡é’ˆ
        transient LinkedHashMap.Entry<K,V> head;
        // å°¾æŒ‡é’ˆ
        transient LinkedHashMap.Entry<K,V> tail;
        // æ˜¯å¦æŒ‰ç…§è®¿é—®é¡ºåºæ’åº
        final boolean accessOrder;
    
        // åŒå‘é“¾è¡¨èŠ‚ç‚¹
        static class Entry<K,V> extends HashMap.Node<K,V> {
            // å‰é©±æŒ‡é’ˆå’Œåç»§æŒ‡é’ˆï¼ˆç”¨äºåŒå‘é“¾è¡¨ï¼‰
            Entry<K,V> before, after;
            Entry(int hash, K key, V value, Node<K,V> next/*å•é“¾è¡¨æŒ‡é’ˆï¼ˆç”¨äºæ•£åˆ—è¡¨çš„å†²çªè§£å†³ï¼‰*/) {
                super(hash, key, value, next);
            }
        }
    }
    

`LinkedList.java`

    public class LinkedList<E> extends AbstractSequentialList<E> implements List<E>, Deque<E>, Cloneable, java.io.Serializable {
        // å¤´æŒ‡é’ˆï¼ˆ// LinkedList ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„å¤´å°¾èŠ‚ç‚¹ï¼‰
        transient Node<E> first;
        // å°¾æŒ‡é’ˆ
        transient Node<E> last;
    
        // åŒå‘é“¾è¡¨èŠ‚ç‚¹
        private static class Node<E> {
            // èŠ‚ç‚¹æ•°æ®
            // ï¼ˆç±»å‹æ“¦é™¤åï¼šObject item;ï¼‰
            E item;
            // å‰é©±æŒ‡é’ˆ
            Node<E> next;
            // åç»§æŒ‡é’ˆ
            Node<E> prev;
    
            Node(Node<E> prev, E element, Node<E> next) {
                this.item = element;
                this.next = next;
                this.prev = prev;
            }
        }
    }
    

LinkedHashMap çš„å±æ€§å¾ˆå¥½ç†è§£çš„ï¼Œä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†ï¼š

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 1ï¼šHashMap.TreeNode å’Œ LinkedHashMap.Entry çš„ç»§æ‰¿é¡ºåºæ˜¯ä¸æ˜¯åäº†ï¼Ÿ**

æˆ‘çš„ç†è§£æ˜¯ä½œè€…å¸Œæœ›ç®€åŒ–èŠ‚ç‚¹ç±»å‹ï¼Œæ‰€ä»¥é‡‡ç”¨äº†éå¸¸è§„çš„åšæ³•ï¼ˆä¸æ„§æ˜¯æ ‡å‡†åº“ï¼‰ã€‚ç”±äº Java æ˜¯å•ç»§æ‰¿çš„ï¼Œå¦‚æœæŒ‰ç…§å¸¸è§„çš„åšæ³•è®© HashMap.TreeNode ç›´æ¥ç»§æ‰¿ HashMap.Nodeï¼Œé‚£ä¹ˆåœ¨ LinkedHashMap ä¸­å°±éœ€è¦åŒºåˆ† LinkedHashMap.Entry å’Œ LinkedHashMap.TreeEntryï¼Œå†ä½¿ç”¨æ¥å£ç»Ÿä¸€ä¸¤ç§ç±»å‹ã€‚

`å¸¸è§„å®ç°`

![](https://files.mdnice.com/user/3257/c6ff679e-fa9c-4a35-8422-8cad178b4818.png)

### 4.2 LinkedHashMap çš„æ„é€ æ–¹æ³•

LinkedHashMap æœ‰ 5 ä¸ªæ„é€ æ–¹æ³•ï¼Œä½œç”¨ä¸ HashMap çš„æ„é€ æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼ŒåŒºåˆ«åªåœ¨äºå¯¹ `accessOrder` å­—æ®µçš„åˆå§‹åŒ–ã€‚

    // å¸¦åˆå§‹å®¹é‡å’Œè£…è½½å› å­çš„æ„é€ æ–¹æ³•
    public LinkedHashMap(int initialCapacity, float loadFactor) {
        super(initialCapacity, loadFactor);
        accessOrder = false;
    }
    
    // å¸¦åˆå§‹å®¹é‡çš„æ„é€ æ–¹æ³•
    public LinkedHashMap(int initialCapacity) {
        super(initialCapacity);
        accessOrder = false;
    }
    
    // æ— å‚æ„é€ æ–¹æ³•
    public LinkedHashMap() {
        super();
        accessOrder = false;
    }
    
    // å¸¦ Map çš„æ„é€ æ–¹æ³•
    public LinkedHashMap(Map<? extends K, ? extends V> m) {
        super();
        accessOrder = false;
        putMapEntries(m, false);
    }
    
    // å¸¦åˆå§‹å®¹é‡ã€è£…è½½å› å­å’Œ accessOrder çš„æ„é€ æ–¹æ³•
    // æ˜¯å¦æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œä¸º true è¡¨ç¤ºæŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œé»˜è®¤ä¸º false
    public LinkedHashMap(int initialCapacity, float loadFactor, boolean accessOrder) {
        super(initialCapacity, loadFactor);
        this.accessOrder = accessOrder;
    }
    

### 4.3 LinkedHashMap å¦‚ä½•ç»´æŠ¤åŒé“¾è¡¨

ç°åœ¨ï¼Œæˆ‘ä»¬çœ‹ä¸‹ LinkedHashMap æ˜¯å¦‚ä½•ç»´æŠ¤åŒé“¾è¡¨çš„ã€‚å…¶å®ï¼Œæˆ‘ä»¬å°†ä¸Šä¸€èŠ‚æ‰€æœ‰çš„ Hook ç‚¹æ±‡æ€»ï¼Œä¼šå‘ç°è¿™äº› Hook ç‚¹æ­£å¥½ç»„æˆäº† LinkedHashMap åŒå‘é“¾è¡¨çš„è¡Œä¸ºï¼š

*   **æ·»åŠ æ•°æ®ï¼š** å°†æ•°æ®é“¾æ¥åˆ°åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
*   **è®¿é—®æ•°æ®ï¼ˆåŒ…æ‹¬æ·»åŠ ã€æŸ¥è¯¢ã€æ›´æ–°ï¼‰ï¼š** å°†æ•°æ®ç§»åŠ¨åˆ°åŒå‘é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œäº¦ç›¸å½“äºå…ˆç§»é™¤å†æ·»åŠ åˆ°å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
*   **åˆ é™¤æ•°æ®ï¼š** å°†æ•°æ®ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
*   **æ·˜æ±°æ•°æ®ï¼š** ç›´æ¥æ·˜æ±°åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

`LinkedHashMap.java`

    // -> 1.1 å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢èŠ‚ç‚¹
    Node<K,V> newNode(int hash, K key, V value, Node<K,V> e) {
        // æ–°å»ºåŒå‘é“¾è¡¨èŠ‚ç‚¹
        LinkedHashMap.Entry<K,V> p = new LinkedHashMap.Entry<K,V>(hash, key, value, e);
        // æ·»åŠ åˆ°åŒå‘é“¾è¡¨å°¾éƒ¨ï¼Œç­‰ä»·äº LinkedList#linkLast
        linkNodeLast(p);
        return p;
    }
    
    // -> 1.1 å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢èŠ‚ç‚¹
    TreeNode<K,V> newTreeNode(int hash, K key, V value, Node<K,V> next) {
        // æ–°å»ºçº¢é»‘æ ‘èŠ‚ç‚¹ï¼ˆç»§æ‰¿äºåŒå‘é“¾è¡¨èŠ‚ç‚¹ï¼‰
        TreeNode<K,V> p = new TreeNode<K,V>(hash, key, value, next);
        // æ·»åŠ åˆ°åŒå‘é“¾è¡¨å°¾éƒ¨ï¼Œç­‰ä»·äº LinkedList#linkLast
        linkNodeLast(p);
        return p;
    }
    
    // æ·»åŠ åˆ°åŒå‘é“¾è¡¨å°¾éƒ¨ï¼Œç­‰ä»·äº LinkedList#linkLast
    private void linkNodeLast(LinkedHashMap.Entry<K,V> p) {
        LinkedHashMap.Entry<K,V> last = tail;
        tail = p;
        if (last == null)
            // last ä¸º null è¯´æ˜é¦–ä¸ªæ·»åŠ çš„å…ƒç´ ï¼Œéœ€è¦ä¿®æ”¹ first æŒ‡é’ˆ
            head = p;
        else {
            // å°†æ–°èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆæŒ‡å‘ last 
            p.before = last;
            // å°† last çš„ next æŒ‡é’ˆæŒ‡å‘æ–°èŠ‚ç‚¹
            last.after = p;
        }
    }
    
    // èŠ‚ç‚¹æ’å…¥å›è°ƒ
    // evictï¼šæ˜¯å¦æ·˜æ±°æœ€æ—©çš„èŠ‚ç‚¹
    void afterNodeInsertion(boolean evict) { // possibly remove eldest
        LinkedHashMap.Entry<K,V> first;
        // removeEldestEntryï¼šæ˜¯å¦æ·˜æ±°æœ€æ—©çš„èŠ‚ç‚¹ï¼Œå³æ˜¯å¦æ·˜æ±°å¤´èŠ‚ç‚¹ï¼ˆç”±å­ç±»å®ç°ï¼‰
        if (evict && (first = head) != null && removeEldestEntry(first)) {
            // ç§»é™¤ first èŠ‚ç‚¹ï¼Œè…¾å‡ºç¼“å­˜ç©ºé—´
            K key = first.key;
            removeNode(hash(key), key, null, false, true);
        }
    }
    
    // ç§»é™¤èŠ‚ç‚¹å›è°ƒ
    void afterNodeRemoval(Node<K,V> e) { // unlink
        // å®ç°äº†æ ‡å‡†çš„åŒé“¾è¡¨ç§»é™¤
        LinkedHashMap.Entry<K,V> p = (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;
        p.before = p.after = null;
        if (b == null)
            // åˆ é™¤çš„æ˜¯å¤´èŠ‚ç‚¹ï¼Œåˆ™ä¿®æ­£ head æŒ‡é’ˆ
            head = a;
        else
            // ä¿®æ­£å‰é©±èŠ‚ç‚¹çš„åç»§æŒ‡é’ˆï¼ŒæŒ‡å‘è¢«åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹
            b.after = a;
        if (a == null)
            // åˆ é™¤çš„æ˜¯å°¾èŠ‚ç‚¹ï¼Œåˆ™ä¿®æ­£ tail æŒ‡é’ˆ
            tail = b;
        else
            // ä¿®æ­£åç»§èŠ‚ç‚¹çš„å‰é©±æŒ‡é’ˆï¼ŒæŒ‡å‘è¢«åˆ é™¤èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹
            a.before = b;
    }
    
    // èŠ‚ç‚¹è®¿é—®å›è°ƒ
    void afterNodeAccess(Node<K,V> e) { // move node to last
        // å…ˆå°†èŠ‚ç‚¹ e ç§»é™¤ï¼Œå†æ·»åŠ åˆ°é“¾è¡¨å°¾éƒ¨
        LinkedHashMap.Entry<K,V> last;
        // accessOrderï¼šæ˜¯å¦æŒ‰ç…§è®¿é—®é¡ºåºæ’åºï¼Œä¸º false åˆ™ä¿ç•™æ’å…¥é¡ºåº
        if (accessOrder && (last = tail) != e) {
            // è¿™ä¸¤ä¸ª if è¯­å¥å—å°±æ˜¯ afterNodeRemoval çš„é€»è¾‘
            LinkedHashMap.Entry<K,V> p = (LinkedHashMap.Entry<K,V>)e, b = p.before, a = p.after;
            p.after = null;
            if (b == null)
                head = a;
            else
                b.after = a;
            if (a != null)
                a.before = b;
            else
                last = b;
            // è¿™ä¸ª if è¯­å¥å—å°±æ˜¯ linkNodeLast çš„é€»è¾‘
            if (last == null)
                head = p;
            else {
                p.before = last;
                last.after = p;
            }
            tail = p;
            ++modCount;
        }
    }
    
    // æ·˜æ±°åˆ¤æ–­æ¥å£ï¼Œç”±å­ç±»å®ç°
    protected boolean removeEldestEntry(Map.Entry<K,V> eldest) {
        return false;
    }
    

### 4.4 LinkedHashMap çš„è¿­ä»£å™¨

ä¸ HashMap ç±»ä¼¼ï¼ŒLinkedHashMap ä¹Ÿæä¾›äº† 3 ä¸ªè¿­ä»£å™¨ï¼š

*   **LinkedEntryIteratorï¼š** é”®å€¼å¯¹è¿­ä»£å™¨
*   **LinkedKeyIteratorï¼š** é”®è¿­ä»£å™¨
*   **LinkedValueIteratorï¼š** å€¼è¿­ä»£å™¨

åŒºåˆ«åœ¨äº LinkedHashMap è‡ªå·±å®ç°äº† `LinkedHashIterator`ã€‚åœ¨è¿­ä»£å™¨éå†æ—¶ï¼ŒHashMap ä¼šæŒ‰ç…§æ•°ç»„é¡ºåºéå†æ¡¶èŠ‚ç‚¹ï¼Œä»å¼€å‘è€…çš„è§†è§’çœ‹æ˜¯æ— åºçš„ã€‚è€Œ LinkedHashMap æ˜¯æŒ‰ç…§åŒå‘é“¾è¡¨çš„é¡ºåºä» head èŠ‚ç‚¹å¼€å§‹éå†ï¼Œä»å¼€å‘è€…çš„è§†è§’æ˜¯å¯ä»¥æ„ŸçŸ¥åˆ°çš„æ’å…¥é¡ºåºæˆ–è®¿é—®é¡ºåºã€‚

`LinkedHashMap.java`

    abstract class LinkedHashIterator {
        LinkedHashMap.Entry<K,V> next;
        LinkedHashMap.Entry<K,V> current;
        // ä¿®æ”¹è®¡æ•°
        int expectedModCount;
    
        LinkedHashIterator() {
            // ä»å¤´ç»“ç‚¹å¼€å§‹éå†
            next = head;
            // ä¿®æ”¹è®¡æ•°
            expectedModCount = modCount;
            current = null;
        }
    
        public final boolean hasNext() {
            return next != null;
        }
    
        final LinkedHashMap.Entry<K,V> nextNode() {
            LinkedHashMap.Entry<K,V> e = next;
            // æ£€æŸ¥ä¿®æ”¹è®¡æ•°
            if (modCount != expectedModCount)
                throw new ConcurrentModificationException();
            if (e == null)
                throw new NoSuchElementException();
            current = e;
            next = e.after;
            return e;
        }
        ...
    }
    

### 4.5 LinkedHashMap çš„åºåˆ—åŒ–è¿‡ç¨‹

ä¸ HashMap ç›¸åŒï¼ŒLinkedHashMap ä¹Ÿé‡å†™äº† JDK åºåˆ—åŒ–çš„é€»è¾‘ï¼Œå¹¶ä¿ç•™äº† HashMap ä¸­åºåˆ—åŒ–çš„ä¸»ä½“ç»“æ„ã€‚LinkedHashMap åªæ˜¯é‡å†™äº† `internalWriteEntries()`ï¼ŒæŒ‰ç…§åŒå‘é“¾è¡¨çš„é¡ºåºè¿›è¡Œåºåˆ—åŒ–ï¼Œè¿™æ ·åœ¨ååºåˆ—åŒ–æ—¶å°±èƒ½å¤Ÿæ¢å¤åŒå‘é“¾è¡¨é¡ºåºã€‚

`HashMap.java`

    // åºåˆ—åŒ–è¿‡ç¨‹
    private void writeObject(java.io.ObjectOutputStream s) throws IOException {
        int buckets = capacity();
        s.defaultWriteObject();
        // å†™å…¥å®¹é‡
        s.writeInt(buckets);
        // å†™å…¥æœ‰æ•ˆå…ƒç´ ä¸ªæ•°
        s.writeInt(size);
        // å†™å…¥æœ‰æ•ˆå…ƒç´ 
        internalWriteEntries(s);
    }
    
    // ä¸å…³å¿ƒé”®å€¼å¯¹æ‰€åœ¨çš„æ¡¶ï¼Œåœ¨ååºåˆ—åŒ–ä¼šé‡æ–°æ˜ å°„
    void internalWriteEntries(java.io.ObjectOutputStream s) throws IOException {
        Node<K,V>[] tab;
        if (size > 0 && (tab = table) != null) {
            for (int i = 0; i < tab.length; ++i) {
                for (Node<K,V> e = tab[i]; e != null; e = e.next) {
                    s.writeObject(e.key);
                    s.writeObject(e.value);
                }
            }
        }
    }
    

`LinkedHashMap.java`

    // é‡å†™ï¼šæŒ‰ç…§åŒå‘é“¾è¡¨é¡ºåºå†™å…¥
    void internalWriteEntries(java.io.ObjectOutputStream s) throws IOException {
        for (LinkedHashMap.Entry<K,V> e = head; e != null; e = e.after) {
            s.writeObject(e.key);
            s.writeObject(e.value);
        }
    }
    

* * *

5\. åŸºäº LinkedHashMap å®ç° LRU ç¼“å­˜
------------------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ªç®€å•çš„ LRU ç¼“å­˜ã€‚ç†è§£äº† LinkedHashMap ç»´æŠ¤æ’å…¥é¡ºåºå’Œè®¿é—®é¡ºåºçš„åŸç†åï¼Œç›¸ä¿¡ä½ å·²ç»çŸ¥é“å¦‚ä½•å®ç° LRU ç¼“å­˜äº†ã€‚

*   é¦–å…ˆï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒLinkedHashMap æ”¯æŒ 2 ç§æ’åºæ¨¡å¼ï¼Œè¿™æ˜¯é€šè¿‡æ„é€ å™¨å‚æ•° `accessOrder` æ ‡è®°ä½æ§åˆ¶çš„ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦å°† `accessOrder` è®¾ç½®ä¸º true è¡¨ç¤ºä½¿ç”¨ LRU æ¨¡å¼çš„è®¿é—®é¡ºåºæ’åºã€‚
*   å…¶æ¬¡ï¼Œæˆ‘ä»¬ä¸éœ€è¦å®ç°æ·˜æ±°æ•°æ®çš„é€»è¾‘ï¼Œåªéœ€è¦é‡å†™æ·˜æ±°åˆ¤æ–­æ¥å£ `removeEldestEntry()`ï¼Œå½“ç¼“å­˜æ•°é‡å¤§äºç¼“å­˜å®¹é‡æ—¶è¿”å› trueï¼Œè¡¨ç¤ºç§»é™¤æœ€æ—©çš„èŠ‚ç‚¹ã€‚

`MaxSizeLruCacheDemo.java`

    public class MaxSizeLruCacheDemo extends LinkedHashMap {
    
        private int maxElements;
    
        public LRUCache(int maxSize) {
            super(maxSize, 0.75F, true);
            maxElements = maxSize;
        }
    
        protected boolean removeEldestEntry(java.util.Map.Entry eldest) {
            // è¶…å‡ºå®¹é‡
            return size() > maxElements;
        }
    }
    

* * *

6\. æ€»ç»“
------

*   1ã€LRU æ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œä¸å…¶ä»–æ·˜æ±°ç®—æ³•ç›¸æ¯”ï¼ŒLRU ç®—æ³•åˆ©ç”¨äº† â€œå±€éƒ¨æ€§åŸç†â€ï¼Œç¼“å­˜çš„å¹³å‡å‘½ä¸­ç‡æ›´é«˜ï¼›
    
*   2ã€ä½¿ç”¨åŒå‘é“¾è¡¨ + æ•£åˆ—è¡¨å®ç°çš„ LRUï¼Œåœ¨æ·»åŠ ã€æŸ¥è¯¢ã€ç§»é™¤å’Œæ·˜æ±°æ•°æ®çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ O(1)ï¼Œè¿™ç§æ•°æ®ç»“æ„ä¹Ÿå«å“ˆå¸Œé“¾è¡¨ï¼›
    
    *   **æŸ¥è¯¢æ•°æ®ï¼š** é€šè¿‡æ•£åˆ—è¡¨å®šä½æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
    *   **æ·˜æ±°æ•°æ®ï¼š** ç›´æ¥æ·˜æ±°é“¾è¡¨å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚
*   3ã€ä½¿ç”¨ LinkedHashMap æ—¶ï¼Œä¸»è¦å…³æ³¨ 2 ä¸ª APIï¼š
    
    *   **`accessOrder` æ ‡è®°ä½ï¼š** LinkedHashMap åŒæ—¶å®ç°äº† FIFO å’Œ LRU ä¸¤ç§æ·˜æ±°ç­–ç•¥ï¼Œé»˜è®¤ä¸º FIFO æ’åºï¼Œå¯ä»¥ä½¿ç”¨ accessOrder æ ‡è®°ä½ä¿®æ”¹æ’åºæ¨¡å¼ã€‚
    *   **`removeEldestEntry()` æ¥å£ï¼š** æ¯æ¬¡æ·»åŠ æ•°æ®æ—¶ï¼ŒLinkedHashMap ä¼šå›è°ƒ removeEldestEntry() æ¥å£ã€‚å¼€å‘è€…å¯ä»¥é‡å†™ removeEldestEntry() æ¥å£å†³å®šæ˜¯å¦ç§»é™¤æœ€æ—©çš„èŠ‚ç‚¹ï¼ˆåœ¨ FIFO ç­–ç•¥ä¸­æ˜¯æœ€æ—©æ·»åŠ çš„èŠ‚ç‚¹ï¼Œåœ¨ LRU ç­–ç•¥ä¸­æ˜¯æœ€ä¹…æœªè®¿é—®çš„èŠ‚ç‚¹ï¼‰ã€‚
*   4ã€Android çš„ LruCache å†…å­˜ç¼“å­˜å’Œ DiskLruCache ç£ç›˜ç¼“å­˜ä¸­ï¼Œéƒ½ç›´æ¥å¤ç”¨äº† LinkedHashMap çš„ LRU èƒ½åŠ›ã€‚
    

ä»Šå¤©ï¼Œæˆ‘ä»¬åˆ†æäº† LinkedHashMap çš„å®ç°åŸç†ã€‚åœ¨ä¸‹ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬æ¥åˆ†æ LRU çš„å…·ä½“å®ç°åº”ç”¨ï¼Œä¾‹å¦‚ Android æ ‡å‡†åº“ä¸­çš„ LruCache å†…å­˜ç¼“å­˜ã€‚

å¯ä»¥æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼ŒLinkedHashMap æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼ŒAndroid çš„ [LruCache](https://juejin.cn/post/7166476725981806628/) æ˜¯å¦‚ä½•è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ï¼Ÿè¯·å…³æ³¨ [å°å½­è¯´ Â· Android å¼€æºç»„ä»¶](https://juejin.cn/column/7139791146988863496) ä¸“æ ã€‚

* * *

### å‚è€ƒèµ„æ–™

*   æ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æ Â· Java è¯­è¨€æè¿°ï¼ˆç¬¬ 5 ç«  Â· æ•£åˆ—ï¼‰â€”â€” \[ç¾\] Mark Allen Weiss è‘—
*   ç®—æ³•å¯¼è®ºï¼ˆç¬¬ 11 ç«  Â· æ•£åˆ—è¡¨ï¼‰â€”â€” \[ç¾\] Thomas H. Cormen ç­‰ è‘—
*   [æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾ï¼ˆç¬¬ 6ã€18~22 è®²ï¼‰](https://time.geekbang.org/column/intro/100017301?tab=catalog) â€”â€” ç‹äº‰ è‘—ï¼Œæå®¢æ—¶é—´ å‡ºå“
*   [LinkedHashMap æºç è¯¦ç»†åˆ†æï¼ˆJDK1.8ï¼‰](https://www.imooc.com/article/22931)â€”â€” ç”°å°æ³¢ è‘—
*   [LRU ç®—æ³•åŠå…¶ä¼˜åŒ–ç­–ç•¥â€”â€”ç®—æ³•ç¯‡](https://juejin.cn/post/6844904049263771662) â€”â€” è±†è±‰è¾£æ¤’ç‚’è…Šè‚‰ è‘—
*   [ç¼“å†²æ± (buffer pool)ï¼Œè¿™æ¬¡å½»åº•æ‡‚äº†ï¼](https://juejin.cn/post/6844903874172551181) â€”â€” 58 æ²ˆå‰‘ è‘—
*   [LeetCode 146. LRU ç¼“å­˜](https://leetcode.cn/problems/lru-cache/) â€”â€” LeetCode
*   [Cache replacement policies](https://en.wikipedia.org/wiki/Cache_replacement_policies#LRU) â€”â€” Wikipedia

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤
--------------------

![](https://files.mdnice.com/user/3257/4a2e243b-3b26-4c14-9826-cfe3c9cc99a9.png)