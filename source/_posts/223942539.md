---
layout: post
title: "Spring Data JPA åœ¨ @Query ä¸­ä½¿ç”¨æŠ•å½±çš„æ–¹æ³•"
date: "2022-07-17T17:17:52.324Z"
---
Spring Data JPA åœ¨ @Query ä¸­ä½¿ç”¨æŠ•å½±çš„æ–¹æ³•
=================================

Spring Data JPA åœ¨ @Query ä¸­ä½¿ç”¨æŠ•å½±çš„æ–¹æ³•
=================================

å…³äºæŠ•å½±çš„åŸºæœ¬ä½¿ç”¨å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š[https://www.baeldung.com/spring-data-jpa-projectionsã€‚ä¸‹æ–‡æ²¿ç”¨äº†è¿™ç¯‡æ–‡ç« ä¸­çš„ç¤ºä¾‹ä»£ç ã€‚](https://www.baeldung.com/spring-data-jpa-projections%E3%80%82%E4%B8%8B%E6%96%87%E6%B2%BF%E7%94%A8%E4%BA%86%E8%BF%99%E7%AF%87%E6%96%87%E7%AB%A0%E4%B8%AD%E7%9A%84%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81%E3%80%82)

æŠ•å½±çš„å®˜æ–¹æ–‡æ¡£é“¾æ¥æ˜¯ï¼š[https://docs.spring.io/spring-data/jpa/docs/2.6.5/reference/html/#projections](https://docs.spring.io/spring-data/jpa/docs/2.6.5/reference/html/#projections) (æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ 2.6.5 çš„ç‰ˆæœ¬)ã€‚

èƒŒæ™¯é“ºå«å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ­£æ–‡ã€‚

æœ€è¿‘åœ¨å†™éœ€æ±‚çš„æ—¶å€™ç”¨åˆ°äº†æŠ•å½±æ¥å‡å°‘æ•°æ®åº“æŸ¥è¯¢çš„å­—æ®µï¼Œç»“æœå‘ç°å®˜æ–¹æ–‡æ¡£ä¸­æŒ–äº†ä¸ªå‘= =ã€‚å®˜æ–¹æ–‡æ¡£ä¸­ä»¥åŠå¦ä¸€ç¯‡ç¤ºä¾‹æ–‡ç« ä¸­ï¼Œå…¨ç¨‹ä½¿ç”¨äº†`æ–¹æ³•åæ´¾ç”Ÿ`çš„æŸ¥è¯¢æ–¹å¼ï¼Œè€ŒæŠ•å½±çš„æ–‡æ¡£ä¸­å´**å…¨ç¨‹æ²¡æœ‰**æåˆ°ç¤ºä¾‹çš„å†…å®¹**ä»…**åœ¨`æ–¹æ³•åæ´¾ç”Ÿ`çš„æŸ¥è¯¢æ–¹å¼ä¸‹æ‰æœ‰æ•ˆã€‚  
é‚£ä¹ˆï¼Œ`æ–¹æ³•åæ´¾ç”Ÿ`çš„æŸ¥è¯¢æ–¹å¼å¥½ç”¨å—ï¼Ÿå¯¹äºç®€å•çš„åªæœ‰ä¸¤ä¸‰ä¸ªå­—æ®µçš„æŸ¥è¯¢æ¥è¯´ï¼Œç¡®å®æ–¹ä¾¿å¥½ç”¨ï¼Œä½†æ¡ä»¶ä¸€å¤šï¼Œé—®é¢˜å°±æ¥äº†ï¼Œå¦‚æœæœ‰äº”å…­ä¸ªå­—æ®µè¦è¿‡æ»¤ï¼Œé‚£æ–¹æ³•åç®€ç›´é•¿çš„ä¸èƒ½çœ‹ï¼Œå¹¶ä¸”å¾ˆå¤šæŸ¥è¯¢é»˜è®¤å€¼éƒ½éœ€è¦é€šè¿‡å‚æ•°ä¼ è¿›æ¥è€Œä¸æ˜¯ç›´æ¥å†…ç½®åˆ° SQL ä¸­ã€‚  
åœ¨è¿™ç§æ—¶å€™æˆ‘æ›´åå¥½ä½¿ç”¨`è‡ªå®šä¹‰æŸ¥è¯¢`çš„æ–¹å¼ï¼Œç›´æ¥é¢å‘ SQL ç¼–ç¨‹ï¼Œæ¯”çœ‹å·¨é•¿çš„æ–¹æ³•åè¦å®¹æ˜“çš„å¤šã€‚

å½“æˆ‘åœ¨è¿™æ¬¡éœ€æ±‚ä¸­æŠŠæŠ•å½±å’Œ`è‡ªå®šä¹‰æŸ¥è¯¢`ä¸€ç»“åˆï¼Œè¿™å‘å®ƒå°±æ¥äº†...

ä¸Šé¢æè¿‡ï¼Œä½¿ç”¨æŠ•å½±æ˜¯ä¸ºäº†å‡å°‘æ•°æ®åº“æŸ¥è¯¢çš„å­—æ®µã€‚è€Œç›´æ¥è¿è¡Œç¤ºä¾‹ä»£ç çš„æ—¶å€™ä¹Ÿç¡®å®çœ‹åˆ°äº†è¿™ä¸ªæ•ˆæœï¼š

æµ‹è¯•ä»£ç 

    @Test
    public void whenUsingOpenProjections_thenViewWithRequiredPropertiesIsReturned() {
            PersonView personView = personRepository.findByLastName("Doe");
    }
    
    
    public interface PersonView {
    
        String getLastName();
    
    }
    
    
    @Entity
    public class Person {
        @Id
        private Long id;
        private String firstName;
        private String lastName;
    }    
    

æ‰§è¡Œçš„ SQL

    select person0_.last_name as col_0_0_ from person person0_ where person0_.last_name=?
    

ç„¶åå½“æˆ‘æ¢æˆ`è‡ªå®šä¹‰æŸ¥è¯¢`çš„æ–¹å¼æ—¶ï¼Œæ•ˆæœå°±å˜æˆäº†è¿™æ ·ï¼š

æµ‹è¯•ä»£ç 

    @Query("select p from Person p where p.lastName = ?1")
    PersonView findByLastNameByQuery(String lastName);
    
    @Test
    public void whenUsingOpenProjections_thenViewWithRequiredPropertiesIsReturned2() {
            PersonView personView = personRepository.findByLastNameByQuery("Doe");
    }
    

æ‰§è¡Œçš„SQL

    select person0_.id as id1_6_, person0_.first_name as first_na2_6_, person0_.last_name as last_nam3_6_ from person person0_ where person0_.last_name=?
    

å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯æŸ¥è¯¢äº†å…¨éƒ¨çš„å­—æ®µ(å®åœ¨æ˜¯è®©äººæ‘¸ä¸ç€å¤´è„‘)ã€‚

åæ¥æœ‰åŒäº‹æé†’è¯´æ˜¯å› ä¸ºæˆ‘å†™äº†`select p`å¯¼è‡´çš„ï¼Œæˆ‘å°±å°è¯•å†™æ˜è¦æŸ¥è¯¢çš„å­—æ®µ(ä½†è¿˜æ˜¯æ— æ³•ç†è§£ä¸ºä»€ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹æŠ•å½±ç›´æ¥ä¸ç”Ÿæ•ˆ)ï¼š  
æµ‹è¯•ä»£ç 

    @Query("select p.lastName from Person p where p.lastName = ?1")
    PersonView findByLastNameByQuery(String lastName);
    

æ‰§è¡Œçš„ SQL

    select person0_.last_name as col_0_0_ from person person0_ where person0_.last_name=?
    

ä» SQL ä¸Šæ¥çœ‹ï¼Œè¿™æ ·å†™å·²ç»æ˜¯å®ç°äº†æˆ‘æƒ³è¦çš„æ•ˆæœï¼Œå¯æ˜¯å®é™…ä¸ŠçœŸæ­£ä½¿ç”¨è¿™ä¸ªä»£ç çš„æ—¶å€™ï¼Œå‘å°±åˆæ¥äº†ï¼š  
æµ‹è¯•ä»£ç 

    @Test
    public void whenUsingOpenProjections_thenViewWithRequiredPropertiesIsReturned2() {
            PersonView personView = personRepository.findByLastNameByQuery("Doe");
            assertThat(personView.getLastName()).isEqualTo("Doe");
    }
    

åŠ äº†ä¸€è¡Œæ–­è¨€æ¥æ¨¡æ‹Ÿä½¿ç”¨çš„åœºæ™¯  
æ‰§è¡Œç»“æœ

    org.opentest4j.AssertionFailedError: 
    expected: "Doe"
     but was: null
    Expected :"Doe"
    Actual   :null
    

ç›´æ¥é»‘äººé—®å·è„¸ã€‚

åˆ†æäº†ä¸€ä¸‹ï¼Œæ‰§è¡Œçš„ SQL æ²¡æœ‰é—®é¢˜ï¼ŒæŠ•å½±ç±»ä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œé‚£é—®é¢˜å°±æ˜¯å‡ºåœ¨ç»“æœé›†æ˜ å°„çš„æ—¶å€™äº†ã€‚è™½ç„¶æ²¡çœ‹è¿‡ JPA çš„ä»£ç ï¼Œä½†æ˜¯æœ€ç»ˆè‚¯å®šæ˜¯åŸºäº `JDBC API` çš„ï¼Œè€Œ`JDBC API`æ˜¯æ€ä¹ˆå¤„ç†ç»“æœé›†æ˜ å°„çš„ï¼Ÿ  
ç¿»ä¸€ç¿» `ResultSet` ç±»å¯ä»¥çœ‹åˆ°ä¸€å…±æœ‰ä¸¤ç§æ–¹æ³•è·å–ç»“æœï¼š`by index` å’Œ `by name`ï¼Œä»”ç»†çœ‹çœ‹æ‰§è¡Œçš„ SQLï¼Œ`person0_.last_name as col_0_0_` last\_name è‡ªåŠ¨ç”Ÿæˆäº†ä¸€ä¸ªåˆ«åå«`col_0_0_`ï¼Œè€ŒæŠ•å½±ç±»ä¸­èƒ½è·å¾—çš„ä¿¡æ¯åªæœ‰å­—æ®µå`last_name`è€Œæ²¡æœ‰åˆ«å`col_0_0_`ï¼Œæ‰€ä»¥ `by name` çš„è·¯èµ°ä¸é€šï¼›  
é‚£ä¹ˆ`by index`å‘¢ï¼Œå¾ˆæ˜æ˜¾ä¹Ÿä¸è¡Œï¼Œæˆ‘è¿™é‡Œçš„ç¤ºä¾‹åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œå‡å¦‚æœ‰ä¸¤ä¸ªå­—æ®µï¼Œé‚£ä¹ˆSQL ä¸­çš„å­—æ®µçš„é¡ºåºå’ŒæŠ•å½±ç±»ä¸­çš„å­—æ®µçš„é¡ºåºå°±æ— æ³•ä¿è¯ä¸€è‡´ï¼Œä»è€Œå°±æ— æ³•æ ¹æ® index æ¥è·å–æƒ³è¦çš„å¯¹åº”çš„ç»“æœã€‚

ç„¶åå°±æ˜¯éªŒè¯ç¯èŠ‚äº†ï¼Œå‡å¦‚æ˜¯å› ä¸ºåå­—æ˜ å°„ä¸ä¸Šå¯¼è‡´çš„ç»“æœä¸º nullï¼Œé‚£æˆ‘å°±ç»™ä½ ä¸€ä¸ªèƒ½å¯¹åº”çš„åå­—ï¼š  
æµ‹è¯•ä»£ç 

    @Query("select p.lastName as lastName from Person p where p.lastName = ?1")
    PersonView findByLastNameByQuery(String lastName);
    
    @Test
    public void whenUsingOpenProjections_thenViewWithRequiredPropertiesIsReturned2() {
            PersonView personView = personRepository.findByLastNameByQuery("Doe");
            assertThat(personView.getLastName()).isEqualTo("Doe");
    }
    

æ‰§è¡Œçš„ SQL

    select person0_.last_name as col_0_0_ from person person0_ where person0_.last_name=?
    

è™½ç„¶æ‰§è¡Œçš„ SQL ä¸Šè¿˜æ˜¯ç”¨äº†è‡ªåŠ¨ç”Ÿæˆçš„åˆ«åï¼Œä½†æ˜¯æ–­è¨€å´é€šè¿‡äº†ï¼ŒçŒœæµ‹æ˜¯ JPA åœ¨è§£æ Query çš„æ—¶å€™å­˜å‚¨äº†æ‰‹åŠ¨å£°æ˜çš„åˆ«åä¿¡æ¯ã€‚

æœ€åæ€»ç»“ä¸€ä¸‹ï¼Œå¦‚æœè¦åœ¨ @Query ä¸­ä½¿ç”¨æŠ•å½±ï¼Œ**å¿…é¡»è¦ä¸»åŠ¨å£°æ˜è¦æŸ¥è¯¢çš„å­—æ®µï¼Œå¹¶ä¸”ä¸»åŠ¨å†™æ˜å­—æ®µçš„åˆ«å**æ‰è¡Œã€‚

æœ€åçš„æœ€åï¼Œå†åæ§½ä¸€ä¸‹ JPAï¼Œæ–‡æ¡£ä¸­æåˆ°æŠ•å½±é™¤äº†åŸºäºæ¥å£ä¹‹å¤–ï¼Œè¿˜å¯ä»¥åŸºäºç±»æ¥å®ç°ï¼Œç„¶é¹…å½“ä½ æƒ³åœ¨ @Query ä¸­ä½¿ç”¨åŸºäºç±»çš„æŠ•å½±æ—¶ï¼ŒğŸ’¥~ã€‚