---
layout: post
title: "Kubernetes IPVSå’ŒIPTABLES"
date: "2022-11-18T22:18:26.870Z"
---
Kubernetes IPVSå’ŒIPTABLES
========================

> **ä¸ªäººåç‰‡ï¼š**  
> å¯¹äººé—´çš„çƒ­çˆ±ä¸æ­Œé¢‚ï¼Œå¯æŠµå²æœˆå†—é•¿ğŸŒ  
> GithubğŸ‘¨ğŸ»â€ğŸ’»ï¼š[å¿µèˆ’\_C.ying](https://nianshu2022.github.io/)  
> CSDNä¸»é¡µâœï¸ï¼š[å¿µèˆ’\_C.ying](https://blog.csdn.net/qq_52716296?spm=1011.2415.3001.5343)  
> ä¸ªäººåšå®¢ğŸŒ ï¼š[å¿µèˆ’\_C.ying](https://www.cnblogs.com/nianshu/)

### Kubernetes IPVSå’ŒIPTABLES

*   *   [ä»€ä¹ˆæ˜¯IPVS](#IPVS_8)
    *   [IPVS vs IPTABLES](#IPVS_vs_IPTABLES_14)
    *   [IPVS å¯¹ IPTABLES çš„ä¾èµ–](#IPVS__IPTABLES__27)
    *   *   [1\. kube-proxyä»¥--masquerade-all=trueå¯åŠ¨](#1_kubeproxymasqueradealltrue_49)
        *   [2\. åœ¨kube-proxyå¯åŠ¨æ—¶æŒ‡å®šé›†ç¾¤CIDR](#2_kubeproxyCIDR_83)
        *   [3\. loadBalancerç±»å‹çš„æœåŠ¡](#3_loadBalancer_117)
        *   [4\. NodePortç±»å‹çš„æœåŠ¡](#4_NodePort_166)
        *   [5\. æŒ‡å®šexternalIPçš„æœåŠ¡](#5_externalIP_204)
*   [Kubernetesä½¿ç”¨IPVS](#KubernetesIPVS_237)
*   *   [å®‰è£…IPVS](#IPVS_239)
    *   *   [CentOS](#CentOS_241)
        *   [Ubuntu](#Ubuntu_246)

ä»€ä¹ˆæ˜¯IPVS
-------

`IPVSï¼ˆIP Virtual Serverï¼ŒIPè™šæ‹ŸæœåŠ¡å™¨ï¼‰`å®ç°äº†ä¼ è¾“å±‚çš„è´Ÿè½½å¹³è¡¡ï¼Œé€šå¸¸ç§°ä¸º`4 LANï¼ˆå››å±‚å±€åŸŸç½‘ï¼‰`äº¤æ¢ï¼Œæ˜¯Linuxå†…æ ¸çš„ä¸€éƒ¨åˆ†ã€‚

IPVSåœ¨ä¸»æœºä¸Šè¿è¡Œï¼Œåœ¨çœŸå®æœåŠ¡å™¨é›†ç¾¤å‰é¢å……å½“è´Ÿè½½å¹³è¡¡å™¨ã€‚IPVSå¯ä»¥å°†åŸºäº TCP å’Œ UDP çš„æœåŠ¡è¯·æ±‚å®šå‘åˆ°çœŸå®æœåŠ¡å™¨ä¸Šã€‚

IPVS vs IPTABLES
----------------

IPVS æ¨¡å¼åœ¨ `Kubernetes v1.8`ä¸­å¼•å…¥ï¼Œåœ¨v1.9ä¸­æˆä¸ºæµ‹è¯•ç‰ˆï¼Œåœ¨v1.11ä¸­æˆä¸ºGAã€‚  
IPTABLESæ¨¡å¼æ˜¯åœ¨v1.1ç‰ˆæœ¬ä¸­åŠ å…¥çš„ï¼Œä»v1.2ç‰ˆæœ¬å¼€å§‹æˆä¸ºé»˜è®¤çš„æ“ä½œæ¨¡å¼ã€‚

IPVSå’ŒIPTABLESéƒ½æ˜¯åŸºäºnetfilterçš„ã€‚IPVSæ¨¡å¼å’ŒIPTABLESæ¨¡å¼çš„åŒºåˆ«å¦‚ä¸‹ï¼š

1.  IPVSä¸ºå¤§å‹é›†ç¾¤æä¾›æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚
    
2.  IPVSæ¯”IPTABLESæ”¯æŒæ›´å¤æ‚çš„è´Ÿè½½å¹³è¡¡ç®—æ³•ï¼ˆæœ€å°è´Ÿè½½ã€æœ€å°è¿æ¥ã€å®šä½ã€åŠ æƒç­‰ï¼‰ã€‚
    
3.  IPVS æ”¯æŒæœåŠ¡å™¨å¥åº·æ£€æŸ¥å’Œè¿æ¥é‡è¯•ç­‰ã€‚
    

IPVS å¯¹ IPTABLES çš„ä¾èµ–
-------------------

IPVSä»£ç†ä½¿ç”¨`IPTABLES`åšæ•°æ®åŒ…`è¿‡æ»¤`ã€`SNAT`æˆ–`ä¼ªè£…`ã€‚å…·ä½“æ¥è¯´ï¼ŒIPVSä»£ç†å°†ä½¿ç”¨ipsetæ¥å­˜å‚¨éœ€è¦DROPæˆ–åšä¼ªè£…çš„æµé‡çš„æºåœ°å€æˆ–ç›®çš„åœ°å€ï¼Œä»¥ç¡®ä¿æ— è®ºæˆ‘ä»¬æœ‰å¤šå°‘æœåŠ¡ï¼ŒIPTABLESè§„åˆ™çš„æ•°é‡ä¸å˜ã€‚

ä¸‹é¢æ˜¯IPVSä»£ç†æœåŠ¡å™¨ä½¿ç”¨çš„ipseté›†çš„è¡¨æ ¼ã€‚

set name

members

usage

KUBE-CLUSTER-IP

All service IP + port

Mark-Masq for cases that `masquerade-all=true` or `clusterCIDR` specified

KUBE-LOOP-BACK

All service IP + port + IP

masquerade for solving hairpin purpose

KUBE-EXTERNAL-IP

service external IP + port

masquerade for packages to external IPs

KUBE-LOAD-BALANCER

load balancer ingress IP + port

masquerade for packages to load balancer type service

KUBE-LOAD-BALANCER-LOCAL

LB ingress IP + port with `externalTrafficPolicy=local`

accept packages to load balancer with `externalTrafficPolicy=local`

KUBE-LOAD-BALANCER-FW

load balancer ingress IP + port with `loadBalancerSourceRanges`

package filter for load balancer with `loadBalancerSourceRanges` specified

KUBE-LOAD-BALANCER-SOURCE-CIDR

load balancer ingress IP + port + source CIDR

package filter for load balancer with `loadBalancerSourceRanges` specified

KUBE-NODE-PORT-TCP

nodeport type service TCP port

masquerade for packets to nodePort(TCP)

KUBE-NODE-PORT-LOCAL-TCP

nodeport type service TCP port with `externalTrafficPolicy=local`

accept packages to nodeport service with `externalTrafficPolicy=local`

KUBE-NODE-PORT-UDP

nodeport type service UDP port

masquerade for packets to nodePort(UDP)

KUBE-NODE-PORT-LOCAL-UDP

nodeport type service UDP port with `externalTrafficPolicy=local`

accept packages to nodeport service with `externalTrafficPolicy=local`

åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼ŒIPVS ä»£ç†å°†ä¾èµ– IPTABLESã€‚

### 1\. kube-proxyä»¥â€“masquerade-all=trueå¯åŠ¨

å¦‚æœkube-proxyä»¥`--masquerade-all=true`å¯åŠ¨ï¼ŒIPVSä»£ç†å°†ä¼ªè£…æ‰€æœ‰è®¿é—®æœåŠ¡é›†ç¾¤IPçš„æµé‡ï¼Œè¿™ä¸IPTABLESä»£ç†çš„è¡Œä¸ºç›¸åŒã€‚å‡è®¾kube-proxyæŒ‡å®šäº†æ ‡å¿—`--masquerade-all=true`ï¼Œé‚£ä¹ˆIPVSä»£ç†å®‰è£…çš„IPTABLESåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

    # iptables -t nat -nL
    
    Chain PREROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain POSTROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
    
    Chain KUBE-MARK-MASQ (2 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000
    
    Chain KUBE-POSTROUTING (1 references)
    target     prot opt source               destination
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOOP-BACK dst,dst,src
    
    Chain KUBE-SERVICES (2 references)
    target     prot opt source               destination
    KUBE-MARK-MASQ  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-CLUSTER-IP dst,dst
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-CLUSTER-IP dst,dst
    

### 2\. åœ¨kube-proxyå¯åŠ¨æ—¶æŒ‡å®šé›†ç¾¤CIDR

å¦‚æœkube-proxyä»¥`--cluster-cidr=<cidr>`å¯åŠ¨ï¼ŒIPVSä»£ç†å°†ä¼ªè£…è®¿é—®æœåŠ¡é›†ç¾¤IPçš„éé›†ç¾¤æµé‡ï¼Œå…¶è¡Œä¸ºä¸IPTABLESä»£ç†ç›¸åŒã€‚å‡è®¾kube-proxyæä¾›çš„é›†ç¾¤cidræ˜¯`10.244.16.0/24`ï¼Œé‚£ä¹ˆIPVSä»£ç†å®‰è£…çš„IPTABLESåº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚

    # iptables -t nat -nL
    
    Chain PREROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain POSTROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
    
    Chain KUBE-MARK-MASQ (3 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000
    
    Chain KUBE-POSTROUTING (1 references)
    target     prot opt source               destination
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOOP-BACK dst,dst,src
    
    Chain KUBE-SERVICES (2 references)
    target     prot opt source               destination
    KUBE-MARK-MASQ  all  -- !10.244.16.0/24       0.0.0.0/0            match-set KUBE-CLUSTER-IP dst,dst
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-CLUSTER-IP dst,dst
    

### 3\. loadBalancerç±»å‹çš„æœåŠ¡

å¯¹äºloadBalancerç±»å‹çš„æœåŠ¡ï¼ŒIPVSä»£ç†å°†å®‰è£…IPTABLESä¸ipset `KUBE-LOAD-BALANCER`åŒ¹é…ã€‚ç‰¹åˆ«æ˜¯å½“æœåŠ¡çš„`LoadBalancerSourceRanges`è¢«æŒ‡å®šæˆ–æŒ‡å®šexternalTrafficPolicy=localæ—¶ï¼ŒIPVSä»£ç†å°†åˆ›å»ºipseté›†`KUBE-LOAD-BALANCER-LOCAL`/`KUBE-LOAD-BALANCER-FW`/`KUBE-LOAD-BALANCER-SOURCE-CIDR`å¹¶ç›¸åº”åœ°å®‰è£…IPTABLESï¼Œå®ƒåº”è¯¥çœ‹èµ·æ¥åƒä¸‹é¢æ‰€ç¤ºã€‚

    # iptables -t nat -nL
    
    Chain PREROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain POSTROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
    
    Chain KUBE-FIREWALL (1 references)
    target     prot opt source               destination
    RETURN     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOAD-BALANCER-SOURCE-CIDR dst,dst,src
    KUBE-MARK-DROP  all  --  0.0.0.0/0            0.0.0.0/0
    
    Chain KUBE-LOAD-BALANCER (1 references)
    target     prot opt source               destination
    KUBE-FIREWALL  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOAD-BALANCER-FW dst,dst
    RETURN     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOAD-BALANCER-LOCAL dst,dst
    KUBE-MARK-MASQ  all  --  0.0.0.0/0            0.0.0.0/0
    
    Chain KUBE-MARK-DROP (1 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x8000
    
    Chain KUBE-MARK-MASQ (2 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000
    
    Chain KUBE-POSTROUTING (1 references)
    target     prot opt source               destination
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOOP-BACK dst,dst,src
    
    Chain KUBE-SERVICES (2 references)
    target     prot opt source               destination
    KUBE-LOAD-BALANCER  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOAD-BALANCER dst,dst
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOAD-BALANCER dst,dst
    

### 4\. NodePortç±»å‹çš„æœåŠ¡

å¯¹äºNodePortç±»å‹çš„æœåŠ¡ï¼ŒIPVSä»£ç†å°†å®‰è£…IPTABLESä¸ipset `KUBE-NODE-PORT-TCP/KUBE-NODE-PORT-UDP`çš„åŒ¹é…ã€‚å½“æŒ‡å®š`externalTrafficPolicy=local`æ—¶ï¼ŒIPVSä»£ç†å°†åˆ›å»ºipseté›†`KUBE-NODE-PORT-LOCAL-TCP`/`KUBE-NODE-PORT-LOCAL-UDP`å¹¶ç›¸åº”åœ°å®‰è£…IPTABLESï¼Œè¿™åº”è¯¥æ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„ï¼š

å‡è®¾æœåŠ¡çš„TCPç±»å‹ä¸ºnodePortã€‚

    Chain PREROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain POSTROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
    
    Chain KUBE-MARK-MASQ (2 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000
    
    Chain KUBE-NODE-PORT (1 references)
    target     prot opt source               destination
    RETURN     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-NODE-PORT-LOCAL-TCP dst
    KUBE-MARK-MASQ  all  --  0.0.0.0/0            0.0.0.0/0
    
    Chain KUBE-POSTROUTING (1 references)
    target     prot opt source               destination
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOOP-BACK dst,dst,src
    
    Chain KUBE-SERVICES (2 references)
    target     prot opt source               destination
    KUBE-NODE-PORT  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-NODE-PORT-TCP dst
    

### 5\. æŒ‡å®šexternalIPçš„æœåŠ¡

å¯¹äºæŒ‡å®šäº†å¤–éƒ¨IPçš„æœåŠ¡ï¼ŒIPVSä»£ç†å°†å®‰è£…IPTABLESä¸ipset `KUBE-EXTERNAL-IP`åŒ¹é…ï¼Œå‡è®¾æˆ‘ä»¬æœ‰æŒ‡å®šäº†å¤–éƒ¨IPçš„æœåŠ¡ï¼ŒIPTABLESè§„åˆ™åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š

    Chain PREROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain OUTPUT (policy ACCEPT)
    target     prot opt source               destination
    KUBE-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */
    
    Chain POSTROUTING (policy ACCEPT)
    target     prot opt source               destination
    KUBE-POSTROUTING  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes postrouting rules */
    
    Chain KUBE-MARK-MASQ (2 references)
    target     prot opt source               destination
    MARK       all  --  0.0.0.0/0            0.0.0.0/0            MARK or 0x4000
    
    Chain KUBE-POSTROUTING (1 references)
    target     prot opt source               destination
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            /* kubernetes service traffic requiring SNAT */ mark match 0x4000/0x4000
    MASQUERADE  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-LOOP-BACK dst,dst,src
    
    Chain KUBE-SERVICES (2 references)
    target     prot opt source               destination
    KUBE-MARK-MASQ  all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-EXTERNAL-IP dst,dst
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-EXTERNAL-IP dst,dst PHYSDEV match ! --physdev-is-in ADDRTYPE match src-type !LOCAL
    ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0            match-set KUBE-EXTERNAL-IP dst,dst ADDRTYPE match dst-type LOCAL
    

Kubernetesä½¿ç”¨IPVS
================

å®‰è£…IPVS
------

### CentOS

    yum install ipset ipvsadm -y
    

### Ubuntu

    apt-get install ipset ipvsadm -y
    
    

è®¾ç½®

    cat > /etc/sysconfig/modules/ipvs.modules <<EOF
    #!/bin/bash
    modprobe -- ip_vs
    modprobe -- ip_vs_rr
    modprobe -- ip_vs_wrr
    modprobe -- ip_vs_sh
    modprobe -- nf_conntrack_ipv4
    EOF
    chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
    

> æœŸå¾…ä¸‹æ¬¡çš„åˆ†äº«ï¼Œåˆ«å¿˜äº†ä¸‰è¿æ”¯æŒåšä¸»å‘€~  
> æˆ‘æ˜¯ **[å¿µèˆ’\_C.ying](https://blog.csdn.net/qq_52716296?type=blog)** ï¼ŒæœŸå¾…ä½ çš„å…³æ³¨~ğŸ’ªğŸ’ªğŸ’ª