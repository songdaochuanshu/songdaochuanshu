---
layout: post
title: "Go For Webï¼šGolang http åŒ…è¯¦è§£ï¼ˆæºç å‰–æï¼‰"
date: "2023-04-15T01:07:15.098Z"
---
Go For Webï¼šGolang http åŒ…è¯¦è§£ï¼ˆæºç å‰–æï¼‰
================================

å‰è¨€ï¼š
===

> æœ¬æ–‡ä½œä¸ºè§£å†³å¦‚ä½•é€šè¿‡ Golang æ¥ç¼–å†™ Web åº”ç”¨è¿™ä¸ªé—®é¢˜çš„å‰ç»ï¼Œå¯¹ Golang ä¸­çš„ Web åŸºç¡€éƒ¨åˆ†è¿›è¡Œä¸€ä¸ªç®€å•çš„ä»‹ç»ã€‚ç›®å‰ Go æ‹¥æœ‰æˆç†Ÿçš„ Http å¤„ç†åŒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬å»ç¼–å†™ä¸€ä¸ªåšä»»ä½•äº‹æƒ…çš„åŠ¨æ€ Web ç¨‹åºåº”è¯¥æ˜¯å¾ˆè½»æ¾çš„ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å»å­¦ä¹ äº†è§£ä¸€äº›å…³äº Web çš„ç›¸å…³åŸºç¡€ï¼Œäº†è§£ä¸€äº›æ¦‚å¿µï¼Œä»¥åŠ Golang æ˜¯å¦‚ä½•è¿è¡Œä¸€ä¸ª Web ç¨‹åºçš„ã€‚  
> **æ–‡ç« é¢„è®¡åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†é€æ­¥æ›´æ–°**  
> 2023-04-13 æ˜ŸæœŸå›› ä¸€æ›´ å…¨æ–‡å…±è®¡çº¦ 3800 å­— é˜…è¯»å¤§çº¦èŠ±è´¹ 5 åˆ†é’Ÿ  
> 2023-04-14 æ˜ŸæœŸäº” äºŒæ›´ï¼ˆä¸¤ç¯‡ï¼‰ å…¨æ–‡å…±è®¡çº¦ 2000 å­— é˜…è¯»å¤§æ¦‚èŠ±è´¹ 4 åˆ†é’Ÿ  
> 2023-04-14 æ˜ŸæœŸäº” ä¸‰æ›´ å…¨æ–‡å…±è®¡çº¦ 2000 å­— é˜…è¯»å¤§æ¦‚èŠ±è´¹ 5 åˆ†é’Ÿ

* * *

æ–‡ç« ç›®å½•ï¼š
=====

1.  [Web çš„å·¥ä½œæ–¹å¼](https://www.cnblogs.com/slowlydance2me/p/17314553.html "Web çš„å·¥ä½œæ–¹å¼")
2.  [ç”¨ Go æ­å»ºä¸€ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡](https://www.cnblogs.com/slowlydance2me/p/17315966.html "ç”¨ Go æ­å»ºä¸€ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡")
3.  [äº†è§£ Golang è¿è¡Œ web çš„åŸç†](https://www.cnblogs.com/slowlydance2me/p/17315966.html "äº†è§£ Golang è¿è¡Œ web çš„åŸç†")
4.  [Golang http åŒ…è¯¦è§£ï¼ˆæºç å‰–æï¼‰](https://www.cnblogs.com/slowlydance2me/p/17318092.html "Golang http åŒ…è¯¦è§£ï¼ˆæºç å‰–æï¼‰")

æ­£æ–‡ï¼š
===

Golang http åŒ…è¯¦è§£ï¼ˆæºç å‰–æï¼‰
---------------------

å‰é¢å°èŠ‚æˆ‘ä»¬è®¤è¯†äº† Web çš„å·¥ä½œæ–¹å¼ï¼Œä¹ŸæˆåŠŸç”¨ Go æ­å»ºäº†ä¸€ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡äº†è§£äº† Golang è¿è¡Œ Web çš„åŸç†ã€‚ç°åœ¨æˆ‘ä»¬è¯¦ç»†åœ°å»è§£å‰–ä»¥ä¸‹ http åŒ…ï¼Œçœ‹çœ‹å®ƒå¦‚ä½•å®ç°æ•´ä¸ªè¿‡ç¨‹çš„

Go çš„ http åŒ…ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼š**Conn ã€ServeMux**

### Conn çš„ goroutine

ä¸æˆ‘ä»¬ä½¿ç”¨å…¶ä»–è¯­è¨€ç¼–å†™ http æœåŠ¡å™¨ä¸åŒï¼Œ Goä¸ºäº†å®ç°é«˜å¹¶å‘å’Œé«˜æ€§èƒ½ï¼Œä½¿ç”¨äº† goroutines æ¥å¤„ç† Conn çš„è¯»å†™äº‹ä»¶ã€‚è¿™æ ·è®©æ¯ä¸ªè¯·æ±‚éƒ½èƒ½ä¿æŒç‹¬ç«‹ï¼Œç›¸äº’ä¸ä¼šé˜»å¡ï¼Œå¯ä»¥é«˜æ•ˆåœ°å“åº”ç½‘ç»œäº‹ä»¶ï¼Œè¿™æ˜¯ Go é«˜æ•ˆçš„ä¿è¯ã€‚

æ ¹æ®ä¸Šä¸€èŠ‚ï¼Œæˆ‘ä»¬çŸ¥é“ Go åœ¨ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚é‡Œé¢æ˜¯è¿™æ ·å†™çš„ï¼š

ç‚¹å‡»æŸ¥çœ‹ä»£ç 

    c, err := srv.newConn(rw)
    if ree != nil {
    	continue
    }
    go c.serve()

è¿™æ®µä»£ç ä¸­ï¼Œå®¢æˆ·ç«¯çš„æ¯ä¸€æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ª Connï¼Œè¿™ä¸ª Conn é‡Œé¢ä¿å­˜äº†è¿™æ¬¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œç„¶åå†ä¼ é€’åˆ°å¯¹åº”çš„ handlerï¼Œè¯¥handlerä¸­ä¾¿å¯ä»¥è¯»å–åˆ°ç›¸åº”çš„ header ä¿¡æ¯ï¼Œè¿™æ ·ä¿è¯äº†æ¯ä¸ªè¯·æ±‚çš„ç‹¬ç«‹æ€§ã€‚

### ServeMux çš„è‡ªå®šä¹‰

åœ¨ä¹‹å‰æˆ‘ä»¬ ä½¿ç”¨ `conn.server` çš„æ—¶å€™ï¼Œå…¶å®å†…éƒ¨æ˜¯è°ƒç”¨äº† http åŒ…é»˜è®¤çš„è·¯ç”±å™¨ä¹Ÿå°±æ˜¯`DefaultServeMux`ï¼Œé€šè¿‡è¿™ä¸ªè·¯ç”±å™¨æŠŠæœ¬æ¬¡è¯·æ±‚çš„ä¿¡æ¯ä¼ é€’åˆ°äº†åç«¯çš„å¤„ç†å‡½æ•°ã€‚é‚£ä¹ˆè¿™ä¸ªè·¯ç”±å™¨æ˜¯æ€ä¹ˆå®ç°çš„å‘¢?

ç»“æ„å¦‚ä¸‹ï¼š

*   é¦–å…ˆæ˜¯ä¸€ä¸ª è‡ªå®šä¹‰ç±»å‹ç»“æ„ä½“ ServeMux å…¶ä¸­åŒ…å«ä¸€ä¸ª _é”_  
    å’Œä¸€ä¸ª _è·¯ç”±è§„åˆ™_  
    ![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414135320162-1791080561.png)
    
*   è·¯ç”±è§„åˆ™ä¸­ä¸€ä¸ª string å¯¹åº”ä¸€ä¸ª mux å®ä½“ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ muxEntry å®ƒä¹Ÿæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰ç±»å‹ç»“æ„ä½“ï¼ŒåŒ…å«ä¸€ä¸ª å¸ƒå°”å€¼ï¼Œä¸€ä¸ªHandler å¤„ç†å‡½æ•°  
    ![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414135539659-1493301447.png)
    
*   æœ€åå†æ¥çœ‹çœ‹ Handler çš„å®šä¹‰ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°äº† `ServeHTTP` è¿™ä¸ªå‡½æ•°  
    ![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414135652278-1329270717.png)
    

è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å›è¿‡å¤´æ¥çœ‹æˆ‘ä»¬ä¹‹å‰è‡ªå·±å†™çš„ Web æœåŠ¡å™¨

ç‚¹å‡»æŸ¥çœ‹ä»£ç 

    // Handlerå¤„ç†å‡½æ•°
    func sayhelloName(w http.ResponseWriter, r *http.Request) {
    	r.ParseForm() // è§£æå‚æ•°ï¼Œé»˜è®¤ä¸ä¼šè§£æ
    	fmt.Println(r.Form)// ä»¥ä¸‹è¿™äº›ä¿¡æ¯æ˜¯è¾“å‡ºåˆ°æœåŠ¡ç«¯çš„æ‰“å°ä¿¡æ¯ï¼šè¯·æ±‚è¡¨å•formã€è·¯å¾„pathã€æ ¼å¼scheme
    	fmt.Println("path", r.URL.Path)
    	fmt.Println("scheme", r.URL.Scheme)
    	fmt.Println(r.Form["url_long"])
    	for k, v := range r.Form {
    		fmt.Println("key:", k)
    		fmt.Println("val:", strings.Join(v, ""))
    	}
    	fmt.Fprintln(w, "Hello astaxie!") // è¾“å‡ºåˆ°å®¢æˆ·ç«¯
    }
è°ƒç”¨ï¼š \`http.HandleFunc("/", sayhelloName) // è®¾ç½®è®¿é—®çš„è·¯ç”±\`

æˆ‘ä»¬ä¼šå‘ç°ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ sayhelloName å‡½æ•°å¹¶æ²¡æœ‰å®ç° ServeHTTP è¿™ä¸ªå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‰ç…§å¸¸ç†æˆ‘ä»¬å¹¶æ²¡æœ‰å®ç° Handler è¿™ä¸ªæ¥å£ï¼Œé‚£æˆ‘ä»¬æ˜¯æ€ä¹ˆæ·»åŠ çš„ï¼Ÿ

åŸæ¥ï¼Œ http åŒ…é‡Œé¢è¿˜å®šä¹‰äº†ä¸€ä¸ªè‡ªå®šä¹‰å‡½æ•°ç±»å‹ `HandlerFunc`ï¼Œè€Œæˆ‘ä»¬å®šä¹‰çš„å‡½æ•° `sayhelloName` å°±æ˜¯è¿™ä¸ª `HandlerFunc` è°ƒç”¨ä¹‹åçš„ç»“æœï¼Œè¿™ä¸ªè‡ªå®šä¹‰å‡½æ•°ç±»å‹é»˜è®¤ä¼šå®ç° `ServeHTTP` è¿™ä¸ªæ–¹æ³•ï¼Œå³æˆ‘ä»¬è°ƒç”¨äº† `HandlerFunc(f)`å¼ºåˆ¶ç±»å‹è½¬æ¢ f æˆä¸ºäº† `HandlerFunc` ç±»å‹ï¼Œè¿™æ · f å°±æ‹¥æœ‰äº†`ServeHTTP` æ–¹æ³•  
![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414140455484-236294062.png)

è·¯ç”±å™¨é‡Œå­˜å‚¨å¥½äº†ç›¸åº”çš„è·¯ç”±è§„åˆ™ï¼ˆResponse / Requestï¼‰ä¹‹åï¼Œé‚£ä¹ˆå…·ä½“çš„è¯·æ±‚åˆæ˜¯æ€ä¹ˆåˆ†å‘çš„å‘¢ï¼Ÿ  
è·¯ç”±å™¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åè°ƒç”¨ `mux.handler(r).ServeHTTP(w,r)`  
ä¹Ÿå°±æ˜¯è°ƒç”¨å¯¹åº”è·¯ç”±çš„ handler çš„ ServerHTTP æ¥å£ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹  
`mux.handler(r)`æ˜¯æ€ä¹ˆå¤„ç†çš„â†“  
![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414140928242-1654164079.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„ URL å’Œè·¯ç”±å™¨é‡Œé¢å­˜å‚¨çš„ map å»åŒ¹é…çš„ï¼Œå½“åŒ¹é…åˆ°ä¹‹åè¿”å›å­˜å‚¨çš„ handlerï¼Œè°ƒç”¨è¿™ä¸ª handler çš„ `ServeHTTP` æ¥å£å°±å¯ä»¥æ‰§è¡Œç›¸åº”çš„å‡½æ•°äº†

é€šè¿‡ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¤§è‡´äº†è§£äº†æ•´ä¸ªæ„å»ºè·¯ç”±çš„è¿‡ç¨‹ï¼ŒGoå…¶å®æ”¯æŒå¤–éƒ¨å®ç°çš„è·¯ç”±å™¨ è€Œ `ListenAndServe` çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç”¨æ¥é…ç½®å¤–éƒ¨è·¯ç”±å™¨çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ª Handler æ¥å£ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å¤–éƒ¨è·¯ç”±åªè¦å®ç°äº† Handler æ¥å£å°±å¯ä»¥å‘æŒ¥ä½œç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±å®ç°çš„è·¯ç”±å™¨çš„ `ServeHTTP` é‡Œé¢å®ç°è‡ªå®šä¹‰çš„è·¯ç”±åŠŸèƒ½

è´´ä¸ªä»£ç â†“

ç‚¹å‡»æŸ¥çœ‹ä»£ç 

    package main
    
    import (
    	"fmt"
    	"net/http"
    )
    
    type MyMux struct {
    }
    
    func (p *MyMux) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    	if r.URL.Path == "/" {
    		sayhelloName2(w, r)
    		return
    	} else {
    		http.NotFound(w, r)
    		return
    	}
    }
    
    func sayhelloName2(w http.ResponseWriter, r *http.Request) {
    	fmt.Fprintf(w, "Hello myroute!")
    }
    
    func main() {
    	mux := &MyMux{}
    	http.ListenAndServe(":9090", mux)
    }

å®ç°æ•ˆæœï¼š  
![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414143612009-658063951.png)

### Go ä»£ç çš„æ‰§è¡Œæµç¨‹

æœ€åæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹æ•´ä¸ªä»£ç çš„æ‰§è¡Œè¿‡ç¨‹

*   é¦–å…ˆè°ƒç”¨ Http.HandleFunc  
    æŒ‰ç…§é¡ºåºåšäº†è¿™å‡ ä»¶äº‹ï¼š

1.  è°ƒç”¨äº† DefaultServeMux çš„ HandleFunc
2.  è°ƒç”¨äº† DefaultServeMux çš„ Handler
3.  å¾€ DefaultServeMux çš„ map\[string\]muxEntry ä¸­å¢åŠ å¯¹åº”çš„handler å’Œ è·¯ç”±è§„åˆ™

*   å…¶æ¬¡è°ƒç”¨ `http.ListenAndServe(":9090",nil)`  
    æŒ‰é¡ºåºåšäº†è¿™å‡ ä»¶äº‹ï¼š

1.  å®ä¾‹åŒ– Server
    
2.  è°ƒç”¨ Server çš„ ListenAndServer()
    
3.  è°ƒç”¨ net.Listen("tcp", addr)**ç›‘å¬ç«¯å£**
    
4.  å¯åŠ¨ä¸€ä¸ª for å¾ªç¯ï¼Œåœ¨å¾ªç¯é¢˜ä¸­ Accept è¯·æ±‚
    
5.  å¯¹æ¯ä¸€ä¸ªè¯·æ±‚å®ä¾‹åŒ–ä¸€ä¸ª Connï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ª goroutine ä¸ºè¿™ä¸ªè¯·æ±‚å¼€ä¸€ä¸ª go.c.serve()
    
6.  **è¯»å–æ¯ä¸ªè¯·æ±‚çš„å†…å®¹** w, err := c.readRequest()
    
7.  åˆ¤æ–­ handler æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰å°±è®¾ç½® handlerï¼ˆé»˜è®¤è®¾ç½®ï¼‰
    
8.  è°ƒç”¨ handler çš„ServeHTTP
    
9.  è¿›å…¥åˆ° DefaultServerMux.ServeHTTP
    
10.  æ ¹æ® request é€‰æ‹© handlerï¼Œ å¹¶ä¸”è¿›å»åˆ°è¿™ä¸ª handler çš„ ServerHTTP  
    ![image](https://img2023.cnblogs.com/blog/2986763/202304/2986763-20230414144810987-837728710.png)
    
11.  **é€‰æ‹© handler**  
    A åˆ¤æ–­æ˜¯å¦æœ‰è·¯ç”±èƒ½æ»¡è¶³è¿™ä¸ª request ï¼ˆå¾ªç¯éå† ServerMux çš„ muxEntryï¼‰  
    B å¦‚æœæ»¡è¶³ï¼Œåˆ™è°ƒç”¨è¿™ä¸ªè·¯ç”± handler çš„ ServeHTTP  
    C å¦‚æœä¸æ»¡è¶³ï¼Œåˆ™è°ƒç”¨ NotFoundHandler çš„ ServeHTTP
    

æ€»ç»“
==

åˆ°è¿™é‡Œä¸ºæ­¢æˆ‘ä»¬ä»ç¬¬ä¸€ç« ä»‹ç»äº† HTTP åè®®ï¼ŒDNS è§£æè¿‡ç¨‹ï¼Œäº†è§£äº† Web çš„å·¥ä½œæ–¹å¼ï¼Œç¬¬äºŒç« åˆ†åˆ«ç”¨ Go æ­å»ºä¸€ä¸ªæœ€ç®€å•çš„ Web æœåŠ¡ï¼Œå¹¶ä¸”äº†è§£ Golang è¿è¡Œ web çš„åŸç†ï¼Œåœ¨æœ€åä¸€ç« ï¼Œæˆ‘ä»¬è¿˜æ·±å…¥åˆ° **net/http** åŒ…ä¸­çš„æºç é‡Œä¸ºå¤§å®¶æ­å¼€äº†æ›´åº•å±‚çš„åŸç†

æ—¢ç„¶å¯¹ Go å¼€å‘ Web æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æœ‰åè¶³çš„ä¿¡å¿ƒå»å­¦ä¹ æ›´å¤š Go For Web çš„åç»­å†…å®¹äº†ï¼

å…³äº Golang åŸºç¡€éƒ¨åˆ† ä»¥åŠ è®¡ç®—æœºç½‘ç»œéƒ¨åˆ†è¯»è€…å¯ä»¥å‚é˜…æˆ‘çš„å¾€æœŸ blogğŸ‘‡  
[Goalngï¼šåŸºç¡€å¤ä¹ ä¸€éè¿‡](https://www.cnblogs.com/slowlydance2me/p/17286403.html "Goalngï¼šåŸºç¡€å¤ä¹ ä¸€éè¿‡")

[æ¼«è°ˆè®¡ç®—æœºç½‘ç»œï¼šç½‘ç»œå±‚ ------ é‡ç‚¹ï¼šIPåè®®ä¸äº’è”ç½‘è·¯ç”±é€‰æ‹©åè®®](https://www.cnblogs.com/slowlydance2me/p/16936384.html "æ¼«è°ˆè®¡ç®—æœºç½‘ç»œï¼šç½‘ç»œå±‚ ------ é‡ç‚¹ï¼šIPåè®®ä¸äº’è”ç½‘è·¯ç”±é€‰æ‹©åè®®")

ä»¥ä¸Š

çœ‹å®Œè®°å¾—ç•™ä¸‹ä¸€ä¸ªğŸ‘

hello my world

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[slowlydance2me](https://www.cnblogs.com/slowlydance2me/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/slowlydance2me/p/17318092.html](https://www.cnblogs.com/slowlydance2me/p/17318092.html)