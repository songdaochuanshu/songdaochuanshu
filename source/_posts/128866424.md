---
layout: post
title: "ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLä¹‹MVCCå®ç°åŸç†&&äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å®ç°"
date: "2022-11-01T04:37:22.877Z"
---
ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLä¹‹MVCCå®ç°åŸç†&&äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å®ç°
===================================

![ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLä¹‹MVCCå®ç°åŸç†&amp;&amp;äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å®ç°](https://img2022.cnblogs.com/blog/2334298/202210/2334298-20221031232803471-2039185653.png) â‘ MVCCå®šä¹‰ï¼Œç”¨å¤„ï¼Œå¿«ç…§è¯»ï¼Œå½“å‰è¯» â‘¡MVCCå®ç°åŸç†ï¼šéšè—å­—æ®µï¼Œreadviewï¼Œundo log â‘¢readviewè®¿é—®è§„åˆ™ â‘£äº‹åŠ¡éš”ç¦»çº§åˆ«çš„å…·ä½“å®ç°

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯meloï¼Œä¸€åå¤§ä¸‰åå°ç»ƒä¹ ç”Ÿï¼Œæ­»å»çš„MVCCçªç„¶å¼€å§‹æ‹·æ‰“æˆ‘ğŸ¤£ğŸ¤£ğŸ¤£ï¼

ğŸ³å¼•è¨€
====

MVCCï¼Œéå¸¸é¡ºå£çš„ä¸€ä¸ªè¯ï¼Œç¿»è¯‘èµ·æ¥å´ä¸æ˜¯ç‰¹åˆ«é¡ºå£ï¼šå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚

*   å…¶ä¸­å¤šç‰ˆæœ¬æ˜¯æŒ‡ä»€ä¹ˆå‘¢ï¼Ÿä¸€æ¡è®°å½•çš„å¤šä¸ªç‰ˆæœ¬ã€‚
*   å¹¶å‘æ§åˆ¶ï¼Ÿå¦‚ä½•å®ç°å‘¢ï¼Ÿæˆ‘ä»¬ä¸Šç¯‡åˆšè®²åˆ°äº†é”æœºåˆ¶ï¼Œè€ŒMVCCåˆ™æ˜¯ç”¨æ›´å¥½çš„æ–¹å¼æ¥æé«˜å¹¶å‘æ€§èƒ½ï¼Œé¿å…åŠ é”ï¼å…·ä½“å¦‚ä½•å®ç°ï¼Œåº•å±‚åŸç†æ˜¯ä»€ä¹ˆï¼Œè¿™ç¯‡å°†å¸¦ä½ æ”»ç ´taã€‚  
    

ğŸæœ¬ç¯‡é€Ÿè§ˆè„‘å›¾
========

![MVCC.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eee5dfb50b84a31bcb2ed8627d8dfaf~tplv-k3u1fbpfcp-zoom-1.image)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6c701dce08464f748883176246f92e7d~tplv-k3u1fbpfcp-zoom-1.image)  
**é€šè¿‡ã€Œç‰ˆæœ¬é“¾ã€æ¥æ§åˆ¶å¹¶å‘äº‹åŠ¡è®¿é—®åŒä¸€ä¸ªè®°å½•æ—¶çš„è¡Œä¸ºå°±å« MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ã€‚**

> çœ‹å®Œåæ–‡ï¼Œå†å›è¿‡å¤´æ¥çœ‹è¿™å¼ å›¾ï¼Œå°±ä¼šç†è§£äº†

å½“å‰è¯»ï¼Œå¿«ç…§è¯»
=======

é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€äº›å‰ç½®çŸ¥è¯†ï¼ŒåŒºåˆ†å¼€å½“å‰è¯»å’Œå¿«ç…§è¯»ã€‚

1.  åŠ é”çš„è¯»ï¼Œåˆ™æ˜¯å½“å‰è¯»ï¼Œå¦å¤–updateï¼Œinsertï¼Œdeleteä¹Ÿéƒ½æ˜¯å½“å‰è¯»
2.  å¿«ç…§è¯»ï¼Œæˆ‘ä»¬å¹³æ—¶ç®€å•çš„selectè¯­å¥å…¶å®å°±æ˜¯ã€ä¸åŠ é”ã€‘

> æ³¨æ„ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸‹ï¼Œå¿«ç…§è¯»ä¼šé€€åŒ–ä¸ºå½“å‰è¯»ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/89c4f0f358ab4f07b5afe0e9fcc8b3bf~tplv-k3u1fbpfcp-zoom-1.image)

*   _é‚£è¿™ä¿©è·ŸMVCCæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ_

å¿«ç…§è¯»ï¼Œç›¸å½“äºä½ å¯ä»¥è¯»åˆ°çš„æ˜¯ä¸€ä¸ªå†å²ç‰ˆæœ¬ï¼Œç»´æŠ¤è¿™äº›å†å²ç‰ˆæœ¬å°±éœ€è¦MVCCå‡ºé©¬äº†ã€å…¶ä¸­çš„undologç‰ˆæœ¬é“¾ã€‘  

MVCCç”¨å¤„
======

è§£å†³ **è¯»â€”å†™** å†²çªçš„**æ— é”å¹¶å‘æ§åˆ¶**ï¼Œæ¯æ¬¡å¯¹Aè®°å½•çš„å†™æ“ä½œï¼Œéƒ½ä¼šç»™Aä¿å­˜ä¸€ä¸ªå¿«ç…§ç‰ˆæœ¬ï¼Œè‡³äºè¯»æ“ä½œçš„æ—¶å€™ï¼Œè¯»çš„æ˜¯å“ªä¸ªå¿«ç…§ç‰ˆæœ¬ï¼Œè¿™å°±å¾—çœ‹MVCCçš„å®ç°åŸç†äº†ã€ä¸‹æ–‡çš„readviewè®¿é—®è§„åˆ™ã€‘  

ğŸ¯MVCCå®ç°åŸç†
==========

ğŸ¯è®°å½•ä¸­çš„éšè—å­—æ®µ
----------

InnoDB é‡Œé¢æ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªå”¯ä¸€çš„äº‹åŠ¡ IDï¼Œå«ä½œ transaction idã€‚å®ƒæ˜¯åœ¨äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å‘ InnoDB çš„äº‹åŠ¡ç³»ç»Ÿç”³è¯·çš„ï¼Œæ˜¯**æŒ‰ç”³è¯·é¡ºåºä¸¥æ ¼é€’å¢çš„**ã€‚

è€Œ**æ¯è¡Œæ•°æ®ä¹Ÿéƒ½æ˜¯æœ‰å¤šä¸ªç‰ˆæœ¬**çš„ã€‚æ¯æ¬¡äº‹åŠ¡æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œå¹¶ä¸”æŠŠ transaction id èµ‹å€¼ç»™è¿™ä¸ªæ•°æ®ç‰ˆæœ¬çš„äº‹åŠ¡ IDï¼Œè®°ä¸º **row trx\_id**ã€ä¹Ÿå°±æ˜¯ä¸‹å›¾çš„DB\_TRX\_IDã€‘ã€‚åŒæ—¶ï¼Œæ—§çš„æ•°æ®ç‰ˆæœ¬è¦ä¿ç•™ï¼Œå¹¶ä¸”åœ¨æ–°çš„æ•°æ®ç‰ˆæœ¬ä¸­ï¼Œèƒ½å¤Ÿæœ‰ä¿¡æ¯å¯ä»¥ç›´æ¥æ‹¿åˆ°å®ƒã€‚  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e19704912b57409882b815563fa8f7ee~tplv-k3u1fbpfcp-zoom-1.image)

*   DB\_TRX\_IDï¼ˆ6å­—èŠ‚ï¼‰ï¼šè¡¨ç¤º**æœ€åä¸€æ¬¡æ’å…¥æˆ–æ›´æ–°è¯¥è¡Œ**çš„äº‹åŠ¡ idã€‚æ­¤å¤–ï¼Œdelete æ“ä½œåœ¨å†…éƒ¨è¢«è§†ä¸ºæ›´æ–°ï¼Œåªä¸è¿‡ä¼šåœ¨è®°å½•å¤´ Record header ä¸­çš„ deleted\_flag å­—æ®µå°†å…¶æ ‡è®°ä¸ºå·²åˆ é™¤
    
*   DB\_ROLL\_PTRï¼ˆ7å­—èŠ‚ï¼‰ å›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘è¯¥è¡Œçš„ undo log ã€‚å¦‚æœè¯¥è¡Œæœªè¢«æ›´æ–°ï¼Œåˆ™ä¸ºç©º
    
*   DB\_ROW\_IDï¼ˆ6å­—èŠ‚ï¼‰ï¼šå¦‚æœ**æ²¡æœ‰è®¾ç½®ä¸»é”®ä¸”è¯¥è¡¨æ²¡æœ‰å”¯ä¸€éç©ºç´¢å¼•**æ—¶ï¼ŒInnoDB ä¼šä½¿ç”¨è¯¥ id æ¥ç”Ÿæˆèšç°‡ç´¢å¼•  
    

ğŸ¯readview
----------

### å››ä¸ªæ ¸å¿ƒå­—æ®µ

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/32fbd2bb591042b6851917d8cb7138b7~tplv-k3u1fbpfcp-zoom-1.image)  
è®¡ç®—m\_idsçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰æ–°çš„äº‹åŠ¡äº§ç”Ÿï¼Œä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‡ºç°ï¼ŒMySQLä¿è¯è®¡ç®—m\_idsã€ä¹Ÿå°±æ˜¯ç”Ÿæˆè§†å›¾æ•°ç»„çš„æ—¶å€™ã€‘ä¼šåœ¨äº‹åŠ¡ç³»ç»Ÿçš„é”ä¿æŠ¤ä¸‹è¿›è¡Œï¼Œæ˜¯åŸå­æ“ä½œï¼ŒæœŸé—´ä¸ä¼šåˆ›å»ºæ–°çš„äº‹åŠ¡ã€‚  

### ğŸˆğŸˆè®¿é—®è§„åˆ™

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/57e0cc95bf84489ea6e2842a11ae8f72~tplv-k3u1fbpfcp-zoom-1.image)

*   å¦‚æœè®°å½•çš„ trx\_id å€¼å°äº Read View ä¸­çš„ min\_trx\_id å€¼ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬çš„è®°å½•æ˜¯åœ¨åˆ›å»º Read View **å‰**å·²ç»æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**å¯è§**ã€‚
    
*   å¦‚æœè®°å½•çš„ trx\_id å€¼å¤§äºç­‰äº Read View ä¸­çš„ max\_trx\_id å€¼ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬çš„è®°å½•æ˜¯åœ¨åˆ›å»º Read View **å**æ‰å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**ä¸å¯è§**ã€‚
    
*   å¦‚æœè®°å½•çš„ trx\_id å€¼åœ¨ Read View çš„ min\_trx\_id å’Œ max\_trx\_id ä¹‹é—´ï¼Œè¡¨æ˜è¿™ä¸ªç‰ˆæœ¬çš„è®°å½•åœ¨åˆ›å»º Read View **çš„æ—¶å€™ **å¯èƒ½å¤„äºâ€œæ´»åŠ¨çŠ¶æ€â€**æˆ–è€…â€œå·²æäº¤çŠ¶æ€â€**ï¼›éœ€è¦åˆ¤æ–­ trx\_id æ˜¯å¦åœ¨ m\_ids åˆ—è¡¨ã€æ´»è·ƒçŠ¶æ€ã€‘ä¸­ï¼š--ã€å› ä¸ºæ˜¯æœ‰åºçš„ï¼Œæ•…é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾ã€‘
    
    *   å¦‚æœè®°å½•çš„ trx\_id **åœ¨** m\_ids åˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºç”Ÿæˆè¯¥ç‰ˆæœ¬è®°å½•çš„æ´»è·ƒäº‹åŠ¡**ä¾ç„¶æ´»è·ƒç€ï¼ˆè¿˜æ²¡æäº¤äº‹åŠ¡**ï¼‰ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**ä¸å¯è§**ã€‚
    *   å¦‚æœè®°å½•çš„ trx\_id **ä¸åœ¨** m\_idsåˆ—è¡¨ä¸­ï¼Œè¡¨ç¤ºç”Ÿæˆè¯¥ç‰ˆæœ¬è®°å½•çš„æ´»è·ƒäº‹åŠ¡**å·²ç»è¢«æäº¤**ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬çš„è®°å½•å¯¹å½“å‰äº‹åŠ¡**å¯è§**ã€‚  
        

#### ğŸ”ğŸ”æ€»ç»“

1.  ç‰ˆæœ¬æœªæäº¤ï¼Œä¸å¯è§ï¼›
2.  ç‰ˆæœ¬å·²æäº¤ï¼Œä½†æ˜¯æ˜¯åœ¨è§†å›¾åˆ›å»ºåæäº¤çš„ï¼Œä¸å¯è§ï¼›
3.  ç‰ˆæœ¬å·²æäº¤ï¼Œè€Œä¸”æ˜¯åœ¨è§†å›¾åˆ›å»ºå‰æäº¤çš„ï¼Œå¯è§ã€‚  
    

#### ğŸˆğŸˆupdateç‰¹ä¾‹

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4ed4bb2d184d441892a6f5159f8cca5f~tplv-k3u1fbpfcp-zoom-1.image)  
åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœè¿˜æŒ‰ä¸Šè¾¹çš„è®¿é—®è§„åˆ™æ¥çœ‹çš„è¯ï¼Œåº”è¯¥æ˜¯è¯»å–ä¸åˆ°102è¿™ä¸ªç‰ˆæœ¬æ¥ç€ï¼Œä½†å®é™…æƒ…å†µæ˜¯å¦‚ä½•å‘¢ï¼Ÿ

å¦‚æœè¯»å–ä¸åˆ°çš„è¯ï¼šé‚£äº‹åŠ¡Bè¿˜æ˜¯åœ¨åŸæ¥çš„kåŸºç¡€ä¸Šå»+1ï¼Œé‚£ä¹ˆäº‹åŠ¡Cçš„æ›´æ–°**ç›¸å½“äºæ˜¯ä¸¢å¤±äº†ï¼**

> è¿™é‡Œå°±æ¶‰åŠåˆ°äº†æˆ‘ä»¬å¼€ç¯‡è®²åˆ°çš„å½“å‰è¯»ï¼Œ**æ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åå†™çš„ï¼Œè¿™ä¸ªè¯»ï¼Œå°±æ˜¯â€œå½“å‰è¯»â€ã€‚**

è€Œä¸”å½“å‰è¯»éœ€è¦å¯¹æ•°æ®è¡ŒåŠ é”ï¼Œæ­¤å¤„ç”±äºäº‹åŠ¡Cå·²ç»æäº¤äº†ï¼Œé‡Šæ”¾äº†é”ã€ä¸¤é˜¶æ®µåè®®ã€‘ï¼Œå› æ­¤äº‹åŠ¡Bå¯ä»¥ç›´æ¥æŸ¥åˆ°ï¼Œè‹¥äº‹åŠ¡Cè¿˜æœªæäº¤çš„è¯ï¼Œè¿˜éœ€è¦é˜»å¡ç­‰å¾…ã€‚  

#### ğŸ¤·â€â™‚ï¸ğŸ¤·â€â™‚ï¸45è®²ç–‘é—®

å¯èƒ½çœ‹äº†45è®²çš„å°ä¼™ä¼´ä¼šæœ‰ç–‘é—®ï¼Œ45è®²é‡Œè¾¹è¿™ä¸ªå›¾  
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/186a8b218db3461c9b6f7ca7973b3ed0~tplv-k3u1fbpfcp-zoom-1.image)  
è¿™æ ·ï¼Œå¯¹äºå½“å‰äº‹åŠ¡çš„å¯åŠ¨ç¬é—´æ¥è¯´ï¼Œä¸€ä¸ªæ•°æ®ç‰ˆæœ¬çš„ row trx\_idï¼Œæœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼š

1.  å¦‚æœè½åœ¨ç»¿è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²æäº¤çš„äº‹åŠ¡æˆ–è€…æ˜¯å½“å‰äº‹åŠ¡è‡ªå·±ç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ•°æ®æ˜¯å¯è§çš„ï¼›
2.  å¦‚æœè½åœ¨çº¢è‰²éƒ¨åˆ†ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±å°†æ¥å¯åŠ¨çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œæ˜¯è‚¯å®šä¸å¯è§çš„ï¼›
3.  å¦‚æœ**è½åœ¨é»„è‰²éƒ¨åˆ†**ï¼Œé‚£å°±åŒ…æ‹¬ä¸¤ç§æƒ…å†µ  
    a. è‹¥ row trx\_id åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯ç”±è¿˜æ²¡æäº¤çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œä¸å¯è§ï¼›  
    b. è‹¥ row trx\_id ä¸åœ¨æ•°ç»„ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªç‰ˆæœ¬æ˜¯å·²ç»æäº¤äº†çš„äº‹åŠ¡ç”Ÿæˆçš„ï¼Œå¯è§ã€‚

è¿™ä¸ªå›¾å¾ˆå®¹æ˜“è¿·æƒ‘åˆ°æˆ‘ä»¬ï¼Œè®©æˆ‘ä»¬**è¯¯ä»¥ä¸ºé»„è‰²éƒ¨åˆ†è·Ÿæœªæäº¤äº‹åŠ¡é›†åˆæ˜¯ç­‰åŒçš„**ï¼Œé‚£æ€ä¹ˆè½åœ¨é»„è‰²éƒ¨åˆ†é‡Œè¾¹ï¼Œè¿˜èƒ½å†ç»†åˆ†æˆä¸¤ç§æƒ…å†µå‘¢ï¼Ÿ

meloç”»äº†ä¸ª**èŠ±é‡Œèƒ¡å“¨**çš„å›¾ï¼Œæ¥çœ‹çœ‹è®¡ç®—çš„è¿‡ç¨‹ã€å¦‚æœ‰é”™è¯¯ä¹‹å¤„è¿˜è¯·æŒ‡æ­£ã€‘

1.  1-10å°±æ˜¯**45è®²é‡Œè¾¹çš„ç»¿è‰²éƒ¨åˆ†**ï¼Œ11-15æ˜¯é»„è‰²éƒ¨åˆ†ï¼Œ15ä¹‹åæ˜¯çº¢è‰²éƒ¨åˆ†
    1.  å¦‚æ­¤å¯ä»¥çœ‹åˆ°ï¼Œé»„è‰²éƒ¨åˆ†é‡Œè¾¹ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›ä¸åœ¨m\_idsé‡Œè¾¹çš„å§ï¼Œä¸è¦è¢«è¡¨é¢çš„å›¾åƒè¿·æƒ‘äº†
    2.  å¹¶ä¸æ˜¯è¯´åªæœ‰11ä¹‹å‰çš„ï¼Œæ‰æ˜¯å·²æäº¤äº‹åŠ¡ï¼Œ**11-15é‡Œè¾¹**ä¹Ÿæ˜¯å¯èƒ½ä¼šæœ‰å·²æäº¤äº‹åŠ¡çš„

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0a11efa813984a899786896cb774fecc~tplv-k3u1fbpfcp-zoom-1.image)  

### ç”Ÿæˆæ—¶æœº

> æ³¨æ„ï¼Œå¹¶ä¸æ˜¯å¼€å¯äº‹åŠ¡å°±ç”Ÿæˆäº†ï¼Œå¾—æ‰§è¡Œ**å¿«ç…§è¯»**äº†æ‰ä¼š

RC: åœ¨äº‹åŠ¡ä¸­**æ¯ä¸€æ¬¡**æ‰§è¡Œå¿«ç…§è¯»éƒ½ä¼šç”Ÿæˆ  
RRï¼šä»…åœ¨äº‹åŠ¡ä¸­**ç¬¬ä¸€æ¬¡æ‰§è¡Œå¿«ç…§æ—¶ç”Ÿæˆ**ï¼Œåç»­éƒ½æ˜¯å¤ç”¨è¿™ä¸ªreadview  
**ä½†æ˜¯å¦‚æœäº‹åŠ¡ä¸­è¿›è¡Œäº†å½“å‰è¯»çš„æ“ä½œï¼Œæ¯”å¦‚äº‹åŠ¡ä¸­è¿›è¡Œäº†updateæ“ä½œï¼Œåç»­å†æŸ¥è¯¢å°±ä¼šé‡æ–°ç”ŸæˆReadView**

> å…¶å®å°±æ˜¯ä¸Šè¾¹çš„updateç‰¹ä¾‹

ğŸ¯undo log
----------

å½“è¯»å–è®°å½•æ—¶ï¼Œè‹¥è¯¥è®°å½•**è¢«å…¶ä»–äº‹åŠ¡å ç”¨æˆ–å½“å‰ç‰ˆæœ¬å¯¹è¯¥äº‹åŠ¡ä¸å¯è§**ï¼Œåˆ™å¯ä»¥é€šè¿‡ undo log è¯»å–ä¹‹å‰çš„ç‰ˆæœ¬æ•°æ®ï¼Œ**ä»¥æ­¤å®ç°å¿«ç…§è¯»**  

### ç±»å‹

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b1aef2f5c29c479fa78cb0079bb7de10~tplv-k3u1fbpfcp-zoom-1.image)  
**åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ undo log åˆ†ä¸ºä¸¤ç§ï¼š insert undo log å’Œ update undo logï¼š**

1.  **insert undo log** ï¼šæŒ‡åœ¨ insert æ“ä½œä¸­äº§ç”Ÿçš„ undo logã€‚å› ä¸º insert æ“ä½œçš„è®°å½•**åªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ã€åªåœ¨äº‹åŠ¡å›æ»šæ—¶éœ€è¦ã€‘ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§**ï¼Œæ•…è¯¥ undo log å¯ä»¥åœ¨**äº‹åŠ¡æäº¤å**ç›´æ¥åˆ é™¤ã€‚ä¸éœ€è¦è¿›è¡Œ purge æ“ä½œ
2.  **update undo log** ï¼šupdate æˆ– delete æ“ä½œä¸­äº§ç”Ÿçš„ undo logã€‚è¯¥ undo logå¯èƒ½**éœ€è¦æä¾› MVCC æœºåˆ¶**ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ã€‚æäº¤æ—¶**æ”¾å…¥ undo log é“¾è¡¨ã€ä¸‹æ–‡çš„ç‰ˆæœ¬é“¾ã€‘**ï¼Œç­‰å¾… purgeçº¿ç¨‹ è¿›è¡Œæœ€åçš„åˆ é™¤  
    

### ğŸˆç‰ˆæœ¬é“¾

ç±»ä¼¼ä¸€ä¸ªé“¾è¡¨ï¼Œé€šè¿‡**å›æ»šæŒ‡é’ˆ**ï¼Œä¸²è”èµ·æ¥

*   é“¾è¡¨å¤´éƒ¨æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œå°¾éƒ¨æ˜¯æœ€æ—§çš„è®°å½•

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/76825e995830409290251c8dcba7bcc1~tplv-k3u1fbpfcp-zoom-1.image)  

ğŸ”æ —å­
----

### ğŸˆğŸˆRCçš„ä¾‹å­

#### å¿«ç…§è¯»

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/26fd6bd5b9f842dbb719dd462fe33943~tplv-k3u1fbpfcp-zoom-1.image)  
å…ˆçœ‹äº‹åŠ¡5é‡Œè¾¹ï¼Œä¸¤æ¬¡å¿«ç…§è¯»ç”Ÿæˆçš„readviewæ˜¯æ€æ ·çš„ï¼Ÿ

1.  ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ­¤æ—¶æ´»è·ƒçš„äº‹åŠ¡idæœ‰ã€3ï¼Œ4ï¼Œ5ã€‘ï¼ˆ2å·²ç»æäº¤äº†ï¼‰
2.  æœ€å°å³æ˜¯3ï¼Œæœ€å¤§ã€æ³¨æ„æ˜¯é¢„åˆ†é…æœ€å¤§ã€‘æ˜¯6
3.  åˆ›å»ºè¯¥äº‹åŠ¡çš„idè‡ªç„¶æ˜¯5

> ç¬¬äºŒæ¬¡å¿«ç…§è¯»ä¹Ÿæ˜¯åŒæ ·çš„åˆ†ææ–¹å¼

#### ğŸˆåˆ¤æ–­èƒ½æŸ¥åˆ°å“ªä¸ªäº‹åŠ¡è®°å½•

æˆ‘ä»¬æƒ³çŸ¥é“ç¬¬ä¸€æ¬¡å¿«ç…§è¯»ï¼Œè¯»å–åˆ°çš„æ˜¯å“ªä¸ªäº‹åŠ¡å¯¹åº”çš„è®°å½•ã€å·¦ä¸‹è§’ä¸­å››ä¸ªè®°å½•ã€‘

æ¯”å¦‚æ‹¿ 0x0003è¿™æ¡è®°å½•æ¥åˆ†æï¼Œtrx\_idæ˜¯3ï¼Œå»è·Ÿç¬¬ä¸€ä¸ªreadviewæ¯”å¯¹

1.  åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰äº‹åŠ¡åˆ›å»ºçš„è®°å½•ï¼Œ3!=5ï¼Œè¯´æ˜ä¸æ˜¯
2.  åˆ¤æ–­æ˜¯å¦å·²ç»æäº¤äº†ã€å°äºmin\_trx\_idã€‘ï¼Œ3ä¸å°äº3ï¼Œåˆ™è¿˜æœªæäº¤
3.  åˆ¤æ–­æ˜¯å¦æ˜¯åˆ›å»ºreadviewä¹‹åæ‰åˆ›å»ºçš„äº‹åŠ¡è®°å½•ã€å¤§äºmax\_trx\_idã€‘ï¼Œ3ä¸å¤§äºï¼Œåˆ™ä¸æ˜¯
4.  åˆ¤æ–­æ•°æ®æ˜¯å¦å·²ç»æäº¤ã€ä¸åœ¨m\_idsã€‘é‡Œè¾¹ï¼Œ3åœ¨è¯´æ˜è¿˜æœªæäº¤

> å› æ­¤ï¼Œç¬¬ä¸€æ¬¡å¿«ç…§è¯»ï¼Œæ˜¯æ²¡æ³•è¯»å–åˆ° 0x0003è¿™æ¡è®°å½•çš„

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3488187282714083b097c99fce012d68~tplv-k3u1fbpfcp-zoom-1.image)  

### RRçš„ä¾‹å­

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/09cc10bbb4094de59fd540a76906999d~tplv-k3u1fbpfcp-zoom-1.image)  
å…·ä½“å¦‚ä½•åˆ†æï¼Œè·Ÿä¸Šè¾¹RCæ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°

> åªéœ€è¦æ³¨æ„ï¼šå¦‚æœæœŸé—´å‡ºç°äº†**å½“å‰è¯»**ï¼Œåˆ™ä¼šé‡æ–°ç”Ÿæˆreadview

æ€»ç»“
==

MVCCå°±æ˜¯ä¸º**å¿«ç…§è¯»**è€Œç”Ÿçš„ï¼Œç»´æŠ¤ä¸åŒçš„å¿«ç…§ç‰ˆæœ¬ï¼Œä½¿å¾—ä¸åŒäº‹åŠ¡çš„**è¯»-å†™**æ“ä½œä¸ä¼šå†²çªï¼Œå®ç°å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œå€ŸåŠ©MVCCï¼Œæ•°æ®åº“å¯ä»¥å®ç°READ COMMITTEDï¼ŒREPEATABLE READç­‰éš”ç¦»çº§åˆ«

![MVCC.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/18df340e97004f6288661a31f0f42a23~tplv-k3u1fbpfcp-zoom-1.image)

ğŸ’ ä¸‹ç¯‡é¢„å‘Š
======

è¿™ç¯‡æˆ‘ä»¬ä¸»è¦è®²çš„æ˜¯MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼Œç»“åˆäº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼Œè€Œå…³äº**äº‹åŠ¡èƒŒåçš„åŸç†**ï¼Œ**ç›¸å…³çš„æ—¥å¿—**,è¿™äº›æˆ‘ä»¬ç•™åˆ°åè¾¹å†æ¥è¯¦è§£ã€‚

ğŸ–¨å‚è€ƒæ–‡çŒ®
======

*   MySQL45è®²
*   é»‘é©¬MySQLè§†é¢‘

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/338d60ebfd6542e3809c12a0f9b12eba~tplv-k3u1fbpfcp-watermark.image)

> æ”¶è—=ç™½å«–ï¼Œç‚¹èµ+å…³æ³¨æ‰æ˜¯çœŸçˆ±ï¼ï¼ï¼æœ¬ç¯‡æ–‡ç« å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œè¿˜è¯·åœ¨è¯„è®ºåŒºæŒ‡å‡ºï¼Œæ¬¢è¿æ·»åŠ æˆ‘çš„å¾®ä¿¡ä¸€èµ·äº¤æµï¼š**Melo\_\_Jun**

ğŸ§¿å‹é“¾
====

*   [MySQLé«˜çº§ç¯‡ä¸“æ ](https://juejin.cn/column/7060377126666502157)
    
*   [ğŸ‰æˆ‘çš„ä¸€å¹´åå°ç»ƒä¹ ç”Ÿæ¶¯](https://juejin.cn/post/7047707966187208711)
    
*   [èŠèŠJava](https://juejin.cn/column/7025173818280771614)
    
*   [åˆ†å¸ƒå¼å¼€å‘å®æˆ˜](https://juejin.cn/column/7019916554053615652)
    
*   [Rediså…¥é—¨ä¸å®æˆ˜](https://juejin.cn/column/7028537737347072037)
    
*   [æ•°æ®ç»“æ„ä¸ç®—æ³•](https://juejin.cn/column/7005759018002186247)