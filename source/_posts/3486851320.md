---
layout: post
title: "åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (22) å¼€å‘åšå®¢æ–‡ç« ç›¸å…³æ¥å£"
date: "2022-12-18T21:12:49.147Z"
---
åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (22) å¼€å‘åšå®¢æ–‡ç« ç›¸å…³æ¥å£
===========================================

å‰è¨€
--

æœ¬æ–‡ä»‹ç»åšå®¢æ–‡ç« ç›¸å…³æ¥å£çš„å¼€å‘ï¼Œä½œä¸ºæ¥å£å¼€å‘ä»‹ç»çš„ç¬¬ä¸€ç¯‡ï¼Œä¼šå†™å¾—æ¯”è¾ƒè¯¦ç»†ï¼Œä»¥æŠ›ç –å¼•ç‰ï¼Œåé¢çš„å…¶ä»–æ¥å£å°±ç²—ç•¥å¸¦è¿‡äº†ï¼Œç€é‡äºWebApiå¼€å‘çš„å‘¨è¾¹è®¾æ–½ã€‚

æ¶‰åŠåˆ°çš„æ¥å£ï¼šæ–‡ç« CRUDã€ç½®é¡¶æ–‡ç« ã€æ¨èæ–‡ç« ç­‰ã€‚

å¼€å§‹å‰å…ˆä»‹ç»ä¸‹AspNetCoreæ¡†æ¶çš„åŸºç¡€æ¦‚å¿µï¼ŒMVCæ¨¡å¼ï¼ˆå‰åç«¯ä¸åˆ†ç¦»ï¼‰ã€WebApiæ¨¡å¼ï¼ˆå‰åç«¯åˆ†ç¦»ï¼‰ï¼Œéƒ½æ˜¯æœ‰Controllerçš„ã€‚

åŒºåˆ«åœ¨å‰è€…çš„Controlleré›†æˆè‡ª `Controller` ç±»ï¼Œåè€…ç»§æ‰¿è‡ª `ControllerBase` ç±»ã€‚

æ— è®ºåšå®¢å‰å°ï¼Œè¿˜æ˜¯æ¥å£ï¼Œå¤§éƒ¨åˆ†é€»è¾‘éƒ½æ˜¯é€šç”¨çš„ï¼Œå› æ­¤æˆ‘æŠŠè¿™äº›é€»è¾‘å°è£…åœ¨ `service` ä¸­ï¼Œä»¥å‡å°‘å†—ä½™ä»£ç ã€‚

æ–‡ç« CRUD
------

åœ¨ä¹‹å‰çš„æ–‡ç« é‡Œï¼Œå·²ç»å®ç°äº†æ–‡ç« åˆ—è¡¨ã€æ–‡ç« è¯¦æƒ…çš„åŠŸèƒ½ï¼Œç­‰äºæ˜¯CRUDé‡Œçš„ `R (Retrieve)` â€œæŸ¥â€åŠŸèƒ½å·²ç»å®ç°ã€‚

ç›¸å…³ä»£ç åœ¨ `StarBlog.Web/Services/PostService.cs` æ–‡ä»¶ä¸­ã€‚

> PSï¼šæ ¹æ®RESTFulè§„èŒƒï¼ŒCRUDä¸åŒçš„æ“ä½œå¯¹åº”ä¸åŒçš„HTTPæ–¹æ³•
> 
> åœ¨AspNetCoreä¸­ï¼Œå¯ä»¥é€šè¿‡åœ¨ Action ä¸ŠåŠ ä¸Š `[HttpPost]`ã€`[HttpDelete("{id}")]` è¿™æ ·çš„ç‰¹æ€§æ¥æ ‡è®°æ¥å£ä½¿ç”¨çš„HTTPæ–¹æ³•å’ŒURLã€‚

ç°åœ¨éœ€è¦å®ç°â€œå¢åˆ æ”¹â€çš„åŠŸèƒ½ã€‚

### å¢å’Œæ”¹ (Create/Update)

å› ä¸ºè¿™ä¿©åŠŸèƒ½å·®ä¸å¤šï¼Œæ‰€ä»¥æ”¾åœ¨ä¸€èµ·å®ç°ï¼Œå¾ˆå¤šORMä¹Ÿæ˜¯æŠŠ `Insert` å’Œ `Update` åˆåœ¨ä¸€èµ·ï¼Œå³ `InsertOrUpdate`

#### DTO

> åœ¨è®¡ç®—æœºç¼–ç¨‹ä¸­ï¼Œ**æ•°æ®ä¼ è¾“å¯¹è±¡ (data transfer objectï¼ŒDTO)**æ˜¯åœ¨2ä¸ªè¿›ç¨‹ä¸­æºå¸¦æ•°æ®çš„å¯¹è±¡ã€‚å› ä¸ºè¿›ç¨‹é—´é€šä¿¡é€šå¸¸ç”¨äºè¿œç¨‹æ¥å£ï¼ˆå¦‚webæœåŠ¡ï¼‰çš„æ˜‚è´µæ“ä½œã€‚æˆæœ¬çš„ä¸»ä½“æ˜¯å®¢æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ¥å›é€šä¿¡æ—¶é—´ã€‚ä¸ºé™ä½è¿™ç§è°ƒç”¨æ¬¡æ•°ï¼Œä½¿ç”¨DTOèšåˆæœ¬æ¥éœ€è¦å¤šæ¬¡é€šä¿¡ä¼ è¾“çš„æ•°æ®ã€‚
> 
> DAOä¸ä¸šåŠ¡å¯¹è±¡æˆ–æ•°æ®è®¿é—®å¯¹è±¡çš„åŒºåˆ«æ˜¯ï¼šDTOçš„æ•°æ®çš„å˜å¼‚å­ä¸è®¿é—®å­ï¼ˆmutatorå’Œaccessorï¼‰ã€è¯­æ³•åˆ†æï¼ˆparserï¼‰ã€åºåˆ—åŒ–ï¼ˆserializerï¼‰æ—¶ä¸ä¼šæœ‰ä»»ä½•å­˜å‚¨ã€è·å–ã€åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¼‚å¸¸ã€‚å³DTOæ˜¯ç®€å•å¯¹è±¡ï¼Œä¸å«ä»»ä½•ä¸šåŠ¡é€»è¾‘ï¼Œä½†å¯åŒ…å«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä»¥ç”¨äºä¼ è¾“æ•°æ®ã€‚
> 
> by **Wikipedia**

æ·»åŠ æ–‡ç« åªéœ€è¦ `Post` æ¨¡å‹çš„å…¶ä¸­å‡ ä¸ªå±æ€§å°±è¡Œï¼Œä¸é€‚åˆæŠŠæ•´ä¸ª `Post` æ¨¡å‹ä½œä¸ºå‚æ•°ï¼Œæ‰€ä»¥ï¼Œé¦–å…ˆè¦å®šä¹‰ä¸€ä¸ªDTOä½œä¸ºæ·»åŠ æ–‡ç« çš„å‚æ•°ã€‚

æ–‡ä»¶è·¯å¾„ `StarBlog.Web/ViewModels/Blog/PostCreationDto.cs`

    public class PostCreationDto {
        /// <summary>
        /// æ ‡é¢˜
        /// </summary>
        public string? Title { get; set; }
    
        /// <summary>
        /// æ¢—æ¦‚
        /// </summary>
        public string? Summary { get; set; }
    
        /// <summary>
        /// å†…å®¹ï¼ˆmarkdownæ ¼å¼ï¼‰
        /// </summary>
        public string? Content { get; set; }
        
        /// <summary>
        /// åˆ†ç±»ID
        /// </summary>
        public int CategoryId { get; set; }
    }
    

#### AutoMapper

æœ‰äº†DTOä½œä¸ºå‚æ•°ï¼Œåœ¨ä¿å­˜æ–‡ç« çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æŠŠDTOå¯¹è±¡é‡Œé¢çš„å±æ€§ï¼Œä¸€ä¸ªä¸ªèµ‹å€¼åˆ° `Post` å¯¹è±¡ä¸Šï¼Œåƒè¿™æ ·ï¼š

    var post = new Post {
        Id = Guid.NewGuid(),
    	Title = dto.Title,
        Summary = dto.Summary,
        Content = dto.Content,
        CategoryId = dto.CategoryId
    };
    

ä¸€ä¸ªä¿©ä¸ªè¿˜å¥½ï¼Œæ¥å£å¤šäº†çš„è¯ï¼Œå¤§é‡é‡å¤çš„ä»£ç ä¼šå¾ˆçƒ¦äººï¼Œè€Œä¸”ä¹Ÿå®¹æ˜“å‡ºé”™ã€‚

è¿˜å¥½æˆ‘ä»¬å¯ä»¥ç”¨AutoMapperç»„ä»¶æ¥å®ç°å¯¹è±¡è‡ªåŠ¨æ˜ å°„ã€‚

é€šè¿‡nugetå®‰è£… `AutoMapper.Extensions.Microsoft.DependencyInjection` è¿™ä¸ªåŒ…

æ³¨å†ŒæœåŠ¡ï¼š

    builder.Services.AddAutoMapper(typeof(Program));
    

ç„¶åå†åˆ›å»ºå¯¹åº”çš„Profileï¼ˆé…ç½®ï¼‰ï¼Œå¦‚æœæ²¡æœ‰ç‰¹æ®Šé…ç½®å…¶å®ä¹Ÿå¯ä»¥ä¸æ·»åŠ è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ‰§è¡Œé»˜è®¤çš„æ˜ å°„è¡Œä¸ºå³å¯ã€‚

ä½œä¸ºä¾‹å­ï¼Œæœ¬æ–‡ç®€å•ä»‹ç»ä¸€ä¸‹ï¼Œåˆ›å»º `StarBlog.Web/Properties/AutoMapper/PostProfile.cs` æ–‡ä»¶

    public class PostProfile : Profile {
        public PostProfile() {
            CreateMap<PostUpdateDto, Post>();
            CreateMap<PostCreationDto, Post>();
        }
    }
    

åœ¨æ„é€ æ–¹æ³•é‡Œæ‰§è¡Œ `CreateMap` é…ç½®ä»å·¦åˆ°å³çš„æ˜ å°„å…³ç³»ã€‚

ä¸Šé¢çš„ä»£ç é…ç½®äº†ä» `PostUpdateDto` / `PostCreationDto` è¿™ä¸¤ä¸ªå¯¹è±¡åˆ° `Post` å¯¹è±¡çš„æ˜ å°„å…³ç³»ã€‚

å¦‚æœæœ‰äº›å­—æ®µä¸è¦æ˜ å°„çš„ï¼Œå¯ä»¥è¿™æ ·å†™ï¼š

    public class PostProfile : Profile {
        private readonly List<string> _unmapped = new List<string> {
            "Categories",
        };
        public PostProfile() {
            CreateMap<PostUpdateDto, Post>();
            CreateMap<PostCreationDto, Post>();
            ShouldMapProperty = property => !_unmapped.Contains(property.Name);
        }
    }
    

å…¶ä»–ä»£ç ä¸å˜ï¼Œä¿®æ”¹ `_unmapped` è¿™ä¸ªå­—æ®µå°±è¡Œã€‚

æ¥ç€åœ¨ Controller é‡Œæ³¨å…¥ `IMapper` å¯¹è±¡

    private readonly IMapper _mapper;
    

ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•

    var post = _mapper.Map<Post>(dto);
    

ä¼ å…¥ä¸€ä¸ª `PostCreationDto` ç±»å‹çš„ dtoï¼Œå¯ä»¥å¾—åˆ° `Post` å¯¹è±¡ã€‚

#### Controller

å…ˆä¸ŠControllerçš„ä»£ç 

    [Authorize]
    [ApiController]
    [Route("Api/[controller]")]
    [ApiExplorerSettings(GroupName = "blog")]
    public class BlogPostController : ControllerBase {
        private readonly IMapper _mapper;
        private readonly PostService _postService;
        private readonly BlogService _blogService;
        
        public BlogPostController(PostService postService, BlogService blogService, IMapper mapper) {
            _postService = postService;
            _blogService = blogService;
            _mapper = mapper;
        }
    }
    

åŠ åœ¨Controllerä¸Šé¢çš„å››ä¸ªç‰¹æ€§ï¼ŒæŒ¨ä¸ªä»‹ç»

*   `Authorize` è¡¨ç¤ºè¿™ä¸ªcontrollerä¸‹é¢çš„æ‰€æœ‰æ¥å£éœ€è¦ç™»å½•æ‰èƒ½è®¿é—®
*   `ApiController` è¡¨ç¤ºè¿™æ˜¯ä¸ªWebApi Controller
*   `Route` æŒ‡å®šäº†è¿™ä¸ªControllerçš„è·¯ç”±æ¨¡æ¿ï¼Œå³ä¸‹é¢çš„æ¥å£å…¨æ˜¯ä»¥ `Api/BlogPostController` å¼€å¤´
*   `ApiExplorerSettings` æ¥å£åˆ†ç»„ï¼Œåœ¨swaggeræ–‡æ¡£é‡Œçœ‹ä¼šæ›´æ¸…æ™°

æ¥ä¸‹æ¥ï¼Œæ·»åŠ å’Œä¿®æ”¹æ˜¯ä¿©æ¥å£ï¼Œåˆ†å¼€è¯´ã€‚

##### æ·»åŠ 

å¾ˆå®¹æ˜“ï¼Œç›´æ¥ä¸Šä»£ç äº†

    [HttpPost]
    public async Task<ApiResponse<Post>> Add(PostCreationDto dto, [FromServices] CategoryService categoryService) {
        // ä½¿ç”¨ AutoMapperï¼Œå‰é¢ä»‹ç»è¿‡çš„
        var post = _mapper.Map<Post>(dto);
        // è·å–æ–‡ç« åˆ†ç±»ï¼Œå¦‚æœä¸å­˜åœ¨å°±è¿”å›æŠ¥é”™ä¿¡æ¯
        var category = categoryService.GetById(dto.CategoryId);
        if (category == null) return ApiResponse.BadRequest($"åˆ†ç±» {dto.CategoryId} ä¸å­˜åœ¨ï¼");
    
        // ç”Ÿæˆæ–‡ç« çš„IDã€åˆ›å»ºã€æ›´æ–°æ—¶é—´
        post.Id = GuidUtils.GuidTo16String();
        post.CreationTime = DateTime.Now;
        post.LastUpdateTime = DateTime.Now;
        // è®¾ç½®æ–‡ç« çŠ¶æ€ä¸ºå·²å‘å¸ƒ
        post.IsPublish = true;
    
        // è·å–åˆ†ç±»çš„å±‚çº§ç»“æ„
        post.Categories = categoryService.GetCategoryBreadcrumb(category);
    
        return new ApiResponse<Post>(await _postService.InsertOrUpdateAsync(post));
    }
    

å°±æ˜¯è¿™ä¸ª `Add` æ–¹æ³•

ç›®å‰ `CategoryService` åªéœ€è¦åœ¨è¿™ä¸ªæ·»åŠ çš„æ¥å£é‡Œç”¨åˆ°ï¼Œæ‰€ä»¥ä¸ç”¨æ•´ä¸ªControlleræ³¨å…¥ï¼Œåœ¨ `Add` æ–¹æ³•é‡Œä½¿ç”¨ `[FromServices]` ç‰¹æ€§æ³¨å…¥ã€‚

åé¢æœ‰ä¸ªè·å–åˆ†ç±»çš„å±‚çº§ç»“æ„ï¼Œå› ä¸ºStarBlogçš„è®¾è®¡æ˜¯æ”¯æŒå¤šçº§åˆ†ç±»ï¼Œä¸ºäº†åœ¨å‰å°å±•ç¤ºæ–‡ç« åˆ†ç±»å±‚çº§çš„æ—¶å€™å‡å°‘è¿ç®—é‡ï¼Œæ‰€ä»¥æˆ‘æŠŠæ–‡ç« çš„åˆ†ç±»å±‚çº§ç»“æ„ï¼ˆå½¢å¼æ˜¯åˆ†ç±»IDç”¨é€—å·åˆ†éš”å¼€ï¼Œå¦‚ï¼š1,3,5,7,9ï¼‰ç›´æ¥å­˜å…¥æ•°æ®åº“ï¼Œç©ºé—´æ¢æ—¶é—´ã€‚

æœ€åï¼Œæ‰§è¡Œ `PostService` é‡Œçš„ `InsertOrUpdateAsync` æ–¹æ³•ï¼Œè§£æå¤„ç†æ–‡ç« å†…å®¹ï¼Œå¹¶å°†æ–‡ç« å­˜å…¥æ•°æ®åº“ã€‚

> PSï¼šæœ¬é¡¹ç›®çš„æ¥å£è¿”å›å€¼å·²ç»åšç»Ÿä¸€åŒ…è£…å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°å¤§é‡ä½¿ç”¨ `ApiResponse` ä½œä¸ºè¿”å›å€¼ï¼Œè¿™ä¸ªåç»­æ–‡ç« ä¼šä»‹ç»ã€‚

##### ä¿®æ”¹

å™¢ï¼Œè¿˜æœ‰ **ä¿®æ”¹æ–‡ç« (Update)** çš„æ¥å£ï¼Œä¿®æ”¹ä½¿ç”¨ PUT æ–¹æ³•

    [HttpPut("{id}")]
    public async Task<ApiResponse<Post>> Update(string id, PostUpdateDto dto) {
        // å…ˆè·å–æ–‡ç« å¯¹è±¡
        var post = _postService.GetById(id);
        if (post == null) return ApiResponse.NotFound($"åšå®¢ {id} ä¸å­˜åœ¨");
    
    	// åœ¨å·²æœ‰å¯¹è±¡çš„åŸºç¡€ä¸Šè¿›è¡Œæ˜ å°„
        post = _mapper.Map(dto, post);
        // æ›´æ–°ä¿®æ”¹æ—¶é—´
        post.LastUpdateTime = DateTime.Now;
        
        return new ApiResponse<Post>(await _postService.InsertOrUpdateAsync(post));
    }
    

ä¾ç„¶å¾ˆç®€å•ï¼Œé‡Œé¢æ³¨é‡Šå†™å¾—å¾ˆæ¸…æ¥šäº†

AutoMapperå¯ä»¥å¯¹å·²æœ‰å¯¹è±¡çš„åŸºç¡€ä¸Šè¿›è¡Œæ˜ å°„

*   `mapper.Map(source)` å¾—åˆ°ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡
*   `mapper.Map(source, dest)` åœ¨ dest å¯¹è±¡çš„åŸºç¡€ä¸Šä¿®æ”¹

æå®šã€‚

#### Service

ä½œä¸ºä¸€ä¸ªå¤šå±‚æ¶æ„é¡¹ç›®ï¼Œæ ¸å¿ƒé€»è¾‘ä¾ç„¶æ”¾åœ¨ Service é‡Œ

å¹¶ä¸”è¿™é‡Œæ˜¯æ·»åŠ å’Œä¿®æ”¹äºŒåˆä¸€ï¼Œä¼˜é›…~

    public async Task<Post> InsertOrUpdateAsync(Post post) {
        var postId = post.Id;
        // æ˜¯æ–°æ–‡ç« çš„è¯ï¼Œå…ˆä¿å­˜åˆ°æ•°æ®åº“
        if (await _postRepo.Where(a => a.Id == postId).CountAsync() == 0) {
            post = await _postRepo.InsertAsync(post);
        }
    
        // æ£€æŸ¥æ–‡ç« ä¸­çš„å¤–éƒ¨å›¾ç‰‡ï¼Œä¸‹è½½å¹¶è¿›è¡Œæ›¿æ¢
        // todo å°†å¤–éƒ¨å›¾ç‰‡ä¸‹è½½æ”¾åˆ°å¼‚æ­¥ä»»åŠ¡ä¸­æ‰§è¡Œï¼Œä»¥å…ä¿å­˜æ–‡ç« çš„æ—¶å€™å¤ªæ…¢
        post.Content = await MdExternalUrlDownloadAsync(post);
        // ä¿®æ”¹æ–‡ç« æ—¶ï¼Œå°†markdownä¸­çš„å›¾ç‰‡åœ°å€æ›¿æ¢æˆç›¸å¯¹è·¯å¾„å†ä¿å­˜
        post.Content = MdImageLinkConvert(post, false);
    
        // å¤„ç†å®Œå†…å®¹å†æ›´æ–°ä¸€æ¬¡
        await _postRepo.UpdateAsync(post);
        return post;
    }
    

å¦å¤–ï¼Œè¿™éƒ¨åˆ†ä»£ç åœ¨ä¹‹å‰çš„markdownæ¸²æŸ“å’Œè‡ªåŠ¨ä¸‹è½½å¤–éƒ¨å›¾ç‰‡çš„ç›¸å…³æ–‡ç« é‡Œå·²ç»ä»‹ç»è¿‡äº†ï¼Œæœ¬æ–‡ä¸å†é‡å¤ã€‚è¯¦æƒ…å¯ä»¥çœ‹æœ¬ç³»åˆ—çš„ç¬¬17ç¯‡æ–‡ç« ã€‚

### åˆ  (Delete)

æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œç›´æ¥ä¸Šä»£ç 

StarBlog.Web/Services/PostService.cs

    public int Delete(string id) {
        return _postRepo.Delete(a => a.Id == id);
    }
    

StarBlog.Web/Apis/Blog/BlogPostController.cs

    [HttpDelete("{id}")]
    public ApiResponse Delete(string id) {
        var post = _postService.GetById(id);
        if (post == null) return ApiResponse.NotFound($"åšå®¢ {id} ä¸å­˜åœ¨");
        var rows = _postService.Delete(id);
        return ApiResponse.Ok($"åˆ é™¤äº† {rows} ç¯‡åšå®¢");
    }
    

### æŸ¥ (Retrieve)

æŸ¥ï¼Œåˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯åˆ—è¡¨ï¼Œä¸€ç§æ˜¯å•ä¸ªã€‚

#### å•ä¸ª

å…ˆè¯´å•ä¸ªçš„ï¼Œæ¯”è¾ƒå®¹æ˜“ã€‚

StarBlog.Web/Services/PostService.cs

    public Post? GetById(string id) {
        // è·å–æ–‡ç« çš„æ—¶å€™å¯¹markdownä¸­çš„å›¾ç‰‡åœ°å€è§£æï¼ŒåŠ ä¸Šå®Œæ•´åœ°å€è¿”å›ç»™å‰ç«¯
        var post = _postRepo.Where(a => a.Id == id).Include(a => a.Category).First();
        if (post != null) post.Content = MdImageLinkConvert(post, true);
    
        return post;
    }
    

StarBlog.Web/Apis/Blog/BlogPostController.cs

    [AllowAnonymous]
    [HttpGet("{id}")]
    public ApiResponse<Post> Get(string id) {
        var post = _postService.GetById(id);
        return post == null ? ApiResponse.NotFound() : new ApiResponse<Post>(post);
    }
    

è¿™é‡Œæ¥å£åŠ äº†ä¸ª `[AllowAnonymous]`ï¼Œè¡¨ç¤ºè¿™æ¥å£ä¸ç”¨ç™»å½•ä¹Ÿèƒ½è®¿é—®ã€‚

#### åˆ—è¡¨

åˆ—è¡¨æœ‰ç‚¹éº»çƒ¦ï¼Œéœ€è¦è¿‡æ»¤ç­›é€‰ã€æ’åºã€åˆ†é¡µç­‰åŠŸèƒ½ï¼Œæˆ‘æ‰“ç®—æŠŠè¿™äº›åŠŸèƒ½æ”¾åˆ°åé¢çš„æ–‡ç« è®²ï¼Œä¸ç„¶æœ¬æ–‡çš„ç¯‡å¹…å°±çˆ†ç‚¸äº†â€¦

é‚£æœ€ç®€å•çš„å°±æ˜¯ç›´æ¥è¿”å›å…¨éƒ¨æ–‡ç« åˆ—è¡¨ã€‚

    [HttpGet]
    public List<Post> GetAll() {
        return _postService.GetAll();
    }
    

å¤Ÿç®€å•å§ï¼Ÿ

æ–‡ç« çš„ç›¸å…³æ“ä½œ
-------

å•çº¯çš„CRUDæ˜¯æ— æ³•æ»¡è¶³åŠŸèƒ½éœ€æ±‚çš„

æ‰€ä»¥è¦åœ¨RESTFulæ¥å£çš„æ¥è§¦ä¸Šï¼Œé…åˆä¸€äº›RPCé£æ ¼æ¥å£ï¼Œå®ç°æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½ã€‚

### è®¾ç½®æ¨èæ–‡ç« 

æœ‰ä¸€ä¸ªæ¨¡å‹ä¸“é—¨ç®¡ç†æ¨èæ–‡ç« ï¼Œåä¸º `FeaturedPost`

è¦è®¾ç½®æ¨èæ–‡ç« ï¼Œç›´æ¥å¾€é‡Œé¢æ·»åŠ æ•°æ®å°±è¡Œäº†ã€‚åä¹‹ï¼Œå–æ¶ˆå°±æ˜¯åˆ é™¤å¯¹åº”çš„è®°å½•ã€‚

ä¸Šä»£ç 

StarBlog.Web/Services/PostService.cs

    public FeaturedPost AddFeaturedPost(Post post) {
        var item = _fPostRepo.Where(a => a.PostId == post.Id).First();
        if (item != null) return item;
        item = new FeaturedPost {PostId = post.Id};
        _fPostRepo.Insert(item);
        return item;
    }
    

StarBlog.Web/Apis/Blog/BlogPostController.cs

    [HttpPost("{id}/[action]")]
    public ApiResponse<FeaturedPost> SetFeatured(string id) {
        var post = _postService.GetById(id);
        return post == null
            ? ApiResponse.NotFound()
            : new ApiResponse<FeaturedPost>(_blogService.AddFeaturedPost(post));
    }
    

é…ç½®å®ŒURLå°±æ˜¯ï¼š`Api/BlogPost/{id}/SetFeatured` äº†

### å–æ¶ˆæ¨èæ–‡ç« 

ä¸Šé¢é‚£ä¸ªæ¨èçš„é€†å‘æ“ä½œ

serviceè¿™æ ·å†™

    public int DeleteFeaturedPost(Post post) {
        var item = _fPostRepo.Where(a => a.PostId == post.Id).First();
        return item == null ? 0 : _fPostRepo.Delete(item);
    }
    

controlleré…±å­

    [HttpPost("{id}/[action]")]
    public ApiResponse CancelFeatured(string id) {
        var post = _postService.GetById(id);
        if (post == null) return ApiResponse.NotFound($"åšå®¢ {id} ä¸å­˜åœ¨");
        var rows = _blogService.DeleteFeaturedPost(post);
        return ApiResponse.Ok($"delete {rows} rows.");
    }
    

### è®¾ç½®ç½®é¡¶

StarBlogè®¾è®¡ä¸ºåªå…è®¸ä¸€ç¯‡ç½®é¡¶æ–‡ç« 

è®¾ç½®æ–°çš„ç½®é¡¶æ–‡ç« ï¼Œä¼šæŠŠåŸæœ‰çš„é¡¶æ‰

serviceä»£ç 

    /// <returns>è¿”å› <see cref="TopPost"/> å¯¹è±¡å’Œåˆ é™¤åŸæœ‰ç½®é¡¶åšå®¢çš„è¡Œæ•°</returns>
    public (TopPost, int) SetTopPost(Post post) {
        var rows = _topPostRepo.Select.ToDelete().ExecuteAffrows();
        var item = new TopPost {PostId = post.Id};
        _topPostRepo.Insert(item);
        return (item, rows);
    }
    

å…ˆåˆ é™¤å·²æœ‰ç½®é¡¶æ–‡ç« ï¼Œå†æ·»åŠ æ–°çš„è¿›å»ã€‚è¿”å›å€¼ç”¨äº†å…ƒç»„è¯­æ³•ã€‚

controllerä»£ç 

    [HttpPost("{id}/[action]")]
    public ApiResponse<TopPost> SetTop(string id) {
        var post = _postService.GetById(id);
        if (post == null) return ApiResponse.NotFound($"åšå®¢ {id} ä¸å­˜åœ¨");
        var (data, rows) = _blogService.SetTopPost(post);
        return new ApiResponse<TopPost> {Data = data, Message = $"ok. deleted {rows} old topPosts."};
    }
    

å°±è¿™æ ·ï¼Œç®€ç®€å•å•ã€‚

### ä¸Šä¼ å›¾ç‰‡

åœºæ™¯ï¼šåœ¨åå°ç¼–è¾‘æ–‡ç« ï¼Œä¼šæ’å…¥ä¸€äº›å›¾ç‰‡ã€‚

è¿™ä¸ªæ¥å£å› ä¸ºè¦ä¸Šä¼ æ–‡ä»¶ï¼Œæ‰€ä»¥ä½¿ç”¨FormDataæ¥æ”¶å‚æ•°ï¼Œå‰ç«¯å‘èµ·è¯·æ±‚éœ€è¦æ³¨æ„ã€‚

è¿™æ˜¯controllerä»£ç ï¼š

    [HttpPost("{id}/[action]")]
    public ApiResponse UploadImage(string id, IFormFile file) {
        var post = _postService.GetById(id);
        if (post == null) return ApiResponse.NotFound($"åšå®¢ {id} ä¸å­˜åœ¨");
        var imgUrl = _postService.UploadImage(post, file);
        return ApiResponse.Ok(new {
            imgUrl,
            imgName = Path.GetFileNameWithoutExtension(imgUrl)
        });
    }
    

åé¢çš„ `PostService.UploadImage()` æ–¹æ³•ï¼Œæœ¬æ–‡(å›¿äºç¯‡å¹…å…³ç³»)å…ˆä¸ä»‹ç»äº†ï¼Œç•™ä¸ªå‘ï¼Œæ”¾åœ¨åé¢å›¾ç‰‡ç®¡ç†æ¥å£é‡Œä¸€èµ·ä»‹ç»å“ˆ~

åšå®¢çš„ç›¸å…³æ“ä½œ
-------

åˆšæ‰åŸºæœ¬æ˜¯åœ¨å¯¹æ–‡ç« åšCRUDï¼Œåˆ«å¿˜äº†è¿˜æœ‰ä¸ª `BlogController` å‘¢~ğŸ˜

åŠŸèƒ½å°±æ˜¯è·å–æ¨èã€è·å–ç½®é¡¶ã€åšå®¢æ–‡ç« æ€»è§ˆã€æ‰“åŒ…ä¸Šä¼ ä¹‹ç±»çš„ã€‚

è¿™é‡Œä¹Ÿå¤§æ¦‚ä»‹ç»ä¸€ä¸‹ã€‚

è·å–æ¨èã€ç½®é¡¶çš„serviceä»£ç ï¼š

    public List<Post> GetFeaturedPosts() {
        return _fPostRepo.Select.Include(a => a.Post.Category)
            .ToList(a => a.Post);
    }
    public Post? GetTopOnePost() {
        return _topPostRepo.Select.Include(a => a.Post.Category).First()?.Post;
    }
    

controllerå¤ªç®€å•ï¼Œå°±ä¸å†™äº†ã€‚

### æ€»è§ˆä¿¡æ¯

è¿™é‡Œæ²¡å°è£…åˆ°serviceé‡Œï¼Œæ„Ÿè§‰å…¶ä»–åœ°æ–¹ä¸ä¼šç”¨åˆ°ï¼Œæ‹’ç»è¿‡åº¦å°è£…ã€‚

ç›´æ¥ä»ORMè¯»å–ï¼Œæ–‡ç« ã€åˆ†ç±»ã€å›¾ç‰‡ã€æ¨èç­‰çš„æ•°é‡ã€‚

> PSï¼šè¦åšå±•ç¤ºå¤§å±çš„è¯ï¼Œè¿™äº›åº”è¯¥è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œåç»­å†å¢åŠ ï¼ˆflagç«‹ä¸‹äº†ï¼‰

    public BlogOverview Overview() {
        return new BlogOverview {
            PostsCount = _postRepo.Select.Count(),
            CategoriesCount = _categoryRepo.Select.Count(),
            PhotosCount = _photoRepo.Select.Count(),
            FeaturedPostsCount = _fPostRepo.Select.Count(),
            FeaturedCategoriesCount = _fCategoryRepo.Select.Count(),
            FeaturedPhotosCount = _fPhotoRepo.Select.Count()
        };
    }
    

### æ‰“åŒ…ä¸Šä¼ 

è¿™ä¸ªåŠŸèƒ½æ˜¯ï¼šæŠŠæœ¬åœ°å†™å®Œçš„markdownæ–‡ä»¶è¿åŒå›¾ç‰‡ç­‰èµ„æºä¸€èµ·æ‰“åŒ…zipä¸Šä¼ ï¼ŒStarBlogè§£æmarkdownå¹¶å°†å›¾ç‰‡é™„ä»¶å¤„ç†åå­˜å…¥æ•°æ®åº“ï¼Œå®ç°å¾ˆæ–¹ä¾¿çš„æœ¬åœ°å†™æ–‡ç« ï¼Œåšå®¢å‘è¡¨åŠŸèƒ½ã€‚

å…·ä½“å®ç°å·²ç»åœ¨ä¹‹å‰çš„æ–‡ç« é‡Œä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤å•¦ï¼Œè¯¦æƒ…å¯ä»¥æŸ¥çœ‹æœ¬ç³»åˆ—çš„ç¬¬18ç¯‡æ–‡ç« ã€‚[åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (18) å®ç°æœ¬åœ°Typoraæ–‡ç« æ‰“åŒ…ä¸Šä¼ ](https://www.cnblogs.com/deali/p/16758878.html)

å°ç»“
--

AspNetCore WebApiçš„å¼€å‘æœ‰å¾ˆå¤šä¸œè¥¿å¯ä»¥å†™çš„ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä¹Ÿåœ¨ä¸æ–­å­¦ä¹ ï¼Œæœ‰å¾ˆå¤šå¥½ç©çš„æ–°åŠŸèƒ½ã€éªšæ“ä½œæ˜¯åœ¨åé¢æ‰åŠ å…¥StarBlogé¡¹ç›®çš„ï¼Œä½†ä¸ºäº†ä¿è¯æœ¬ç³»åˆ—æ–‡ç« é˜…è¯»çš„è¿è´¯æ€§ï¼Œå³ä½¿æŸåŠŸèƒ½åœ¨æ–‡ç« æ’°å†™æ—¶å·²ç»å®ç°ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šåŠ å…¥ä»‹ç»ã€‚è¿™äº›æˆ‘ä¼šåœ¨åé¢å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« æ¥ä»‹ç»(ç»ä¸æ˜¯åœ¨æ°´å“¦)ï¼Œä»¥æå‡è¯»è€…çš„é˜…è¯»ä½“éªŒã€‚

è¿˜æœ‰ï¼Œä½œä¸ºæ–°æ‰‹å‘æ•™ç¨‹ï¼Œæˆ‘ä¼šå°½é‡å†™å¾—æ¯”è¾ƒè¯¦ç»†ï¼ˆåºŸè¯æ¯”è¾ƒå¤šï¼‰ï¼Œå¯¼è‡´ç¯‡å¹…è¾ƒé•¿ï¼Œä½†ä½†ä»æ— æ³•é¢é¢ä¿±åˆ°ä»‹ç»AspNetCoreçš„å…¨éƒ¨ç»†èŠ‚ï¼Œå»ºè®®è¾¹çœ‹è¾¹å­¦çš„è¯»è€…æ­é…AspNetCoreå®˜æ–¹æ–‡æ¡£æˆ–æ•™æé˜…è¯»~

ç³»åˆ—æ–‡ç« 
----

*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (1) ä¸ºä»€ä¹ˆéœ€è¦è‡ªå·±å†™ä¸€ä¸ªåšå®¢ï¼Ÿ](https://www.cnblogs.com/deali/p/16104454.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (2) ç¯å¢ƒå‡†å¤‡å’Œåˆ›å»ºé¡¹ç›®](https://www.cnblogs.com/deali/p/16172342.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (3) æ¨¡å‹è®¾è®¡](https://www.cnblogs.com/deali/p/16180920.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (4) markdownåšå®¢æ‰¹é‡å¯¼å…¥](https://www.cnblogs.com/deali/p/16211720.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (5) å¼€å§‹æ­å»ºWebé¡¹ç›®](https://www.cnblogs.com/deali/p/16276448.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (6) é¡µé¢å¼€å‘ä¹‹åšå®¢æ–‡ç« åˆ—è¡¨](https://www.cnblogs.com/deali/p/16286780.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (7) é¡µé¢å¼€å‘ä¹‹æ–‡ç« è¯¦æƒ…é¡µé¢](https://www.cnblogs.com/deali/p/16293309.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (8) åˆ†ç±»å±‚çº§ç»“æ„å±•ç¤º](https://www.cnblogs.com/deali/p/16307604.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (9) å›¾ç‰‡æ‰¹é‡å¯¼å…¥](https://www.cnblogs.com/deali/p/16328825.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (10) å›¾ç‰‡ç€‘å¸ƒæµ](https://www.cnblogs.com/deali/p/16335162.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (11) å®ç°è®¿é—®ç»Ÿè®¡](https://www.cnblogs.com/deali/p/16349155.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (12) Razoré¡µé¢åŠ¨æ€ç¼–è¯‘](https://www.cnblogs.com/deali/p/16391656.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (13) åŠ å…¥å‹æƒ…é“¾æ¥åŠŸèƒ½](https://www.cnblogs.com/deali/p/16421699.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (14) å®ç°ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½](https://www.cnblogs.com/deali/p/16441294.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (15) ç”Ÿæˆéšæœºå°ºå¯¸å›¾ç‰‡](https://www.cnblogs.com/deali/p/16457314.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (16) ä¸€äº›æ–°åŠŸèƒ½ (ç›‘æ§/ç»Ÿè®¡/é…ç½®/åˆå§‹åŒ–)](https://www.cnblogs.com/deali/p/16523157.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (17) è‡ªåŠ¨ä¸‹è½½æ–‡ç« é‡Œçš„å¤–éƒ¨å›¾ç‰‡](https://www.cnblogs.com/deali/p/16586437.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (18) å®ç°æœ¬åœ°Typoraæ–‡ç« æ‰“åŒ…ä¸Šä¼ ](https://www.cnblogs.com/deali/p/16758878.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (19) Markdownæ¸²æŸ“æ–¹æ¡ˆæ¢ç´¢](https://www.cnblogs.com/deali/p/16834452.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (20) å›¾ç‰‡æ˜¾ç¤ºä¼˜åŒ–](https://www.cnblogs.com/deali/p/16929677.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (21) å¼€å§‹å¼€å‘RESTFulæ¥å£](https://www.cnblogs.com/deali/p/16989798.html)
*   [åŸºäº.NetCoreå¼€å‘åšå®¢é¡¹ç›® StarBlog - (22) å¼€å‘åšå®¢æ–‡ç« ç›¸å…³æ¥å£](https://www.cnblogs.com/deali/p/16991279.html)

å¾®ä¿¡å…¬ä¼—å·ï¼šã€Œç¨‹åºè®¾è®¡å®éªŒå®¤ã€ ä¸“æ³¨äºäº’è”ç½‘çƒ­é—¨æ–°æŠ€æœ¯æ¢ç´¢ä¸å›¢é˜Ÿæ•æ·å¼€å‘å®è·µï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æœºå™¨å­¦ä¹ ä¸æ•°æ®åˆ†æç®—æ³•ã€ç§»åŠ¨ç«¯å¼€å‘ã€Linuxã€Webå‰åç«¯å¼€å‘ç­‰ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨æŠ€æœ¯ï¼Œåˆ†äº«å­¦ä¹ å®è·µç»éªŒã€‚