---
layout: post
title: "Vben Admin æºç å­¦ä¹ :çŠ¶æ€ç®¡ç†-é”™è¯¯æ—¥å¿—"
date: "2022-05-31T09:19:22.642Z"
---
Vben Admin æºç å­¦ä¹ :çŠ¶æ€ç®¡ç†-é”™è¯¯æ—¥å¿—
-------------------------

2022-05-31 14:32Â  [Anduril](https://www.cnblogs.com/anduril/)Â  é˜…è¯»(5)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=16326852)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))

![Vben Admin æºç å­¦ä¹ :çŠ¶æ€ç®¡ç†-é”™è¯¯æ—¥å¿—](https://img2022.cnblogs.com/blog/754488/202205/754488-20220530151137120-2117310544.png) æœ¬æ–‡å°†å¯¹ Vue-Vben-Adminçš„çŠ¶æ€ç®¡ç†(é”™è¯¯æ—¥å¿—)å®ç°æºç è¿›è¡Œåˆ†æè§£è¯»ï¼Œè€å¿ƒè¯»å®Œï¼Œç›¸ä¿¡æ‚¨ä¸€å®šä¼šæœ‰æ‰€æ”¶è·!

0x00 å‰è¨€
=======

æœ¬æ–‡å°†å¯¹ [Vue-Vben-Admin](https://github.com/vbenjs/vue-vben-admin) çš„çŠ¶æ€ç®¡ç†å®ç°æºç è¿›è¡Œåˆ†æè§£è¯»ï¼Œè€å¿ƒè¯»å®Œï¼Œç›¸ä¿¡æ‚¨ä¸€å®šä¼šæœ‰æ‰€æ”¶è·!

0x01 errorLog.ts é”™è¯¯æ—¥å¿—
=====================

æ–‡ä»¶ `src\store\modules\errorLog.ts` å£°æ˜å¯¼å‡ºä¸€ä¸ªstoreå®ä¾‹ `useErrorLogStore` ã€ä¸€ä¸ªæ–¹æ³• `useErrorLogStoreWithOut()`ç”¨äºæ²¡æœ‰ä½¿ç”¨Â `setup`Â ç»„ä»¶æ—¶ä½¿ç”¨ã€‚

    // é”™è¯¯æ—¥å¿—å­˜å‚¨å®ä¾‹
    export const useAppStore = defineStore({
      id: 'app-error-log',  
      state: {},
      getters: {}
      actionsï¼š{}   
    });
    
    export function useErrorLogStoreWithOut() {
      return useErrorLogStore(store);
    }
    

State / Getter
--------------

çŠ¶æ€å¯¹è±¡å®šä¹‰äº†é”™è¯¯æ—¥å¿—ä¿¡æ¯æ•°ç»„ã€é”™è¯¯æ—¥å¿—ä¿¡æ¯æ€»æ•°ã€‚

    state: (): ErrorLogState => ({
      errorLogInfoList: null, // Nullable<ErrorLogInfo[]>
      errorLogListCount: 0,
    }), 
    getters: {
      // è·å–é”™è¯¯æ—¥å¿—  é»˜è®¤ç©ºæ•°ç»„
      getErrorLogInfoList(): ErrorLogInfo[] {
        return this.errorLogInfoList || [];
      },
      // è·å–é”™è¯¯æ—¥å¿—æ€»æ•°é‡
      getErrorLogListCount(): number {
        return this.errorLogListCount;
      },
    },
    

`errorLogInfoList` æ˜¯ä¸€ä¸ªåä¸º `ErrorLogInfo` å¯¹è±¡æ•°ç»„ï¼Œè®°å½•äº†é”™è¯¯è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…å«é”™è¯¯ç±»å‹ã€é”™è¯¯äº§ç”Ÿé”™æ–‡ä»¶ä¿¡æ¯ã€é”™è¯¯åç§°ã€é”™è¯¯ä¿¡æ¯ã€è°ƒç”¨å †æ ˆä¿¡æ¯ã€é”™è¯¯è¯¦æƒ…ã€é¡µé¢urlã€é”™è¯¯å‘ç”Ÿæ—¶é—´ã€‚

    export interface ErrorLogInfo { 
      type: ErrorTypeEnum; // é”™è¯¯ç±»å‹
      file: string;  // äº§ç”Ÿé”™è¯¯æ–‡ä»¶
      name?: string; // é”™è¯¯åç§°
      message: string; // é”™è¯¯ä¿¡æ¯
      stack?: string; // è°ƒç”¨å †æ ˆä¿¡æ¯
      detail: string; // é”™è¯¯è¯¦æƒ…
      url: string; // é¡µé¢url
      time?: string; // å‘ç”Ÿæ—¶é—´
    }
    

é”™è¯¯ç±»å‹æœ‰4ç§ï¼Œåˆ†åˆ«ä¸º `Vueå¼‚å¸¸`ã€ `è„šæœ¬é”™è¯¯`ã€ `é™æ€èµ„æºå¼‚å¸¸`ã€ `promiseå¼‚å¸¸`ã€‚

    // é”™è¯¯ç±»å‹
    export enum ErrorTypeEnum {
      VUE = 'vue',
      SCRIPT = 'script',
      RESOURCE = 'resource',
      AJAX = 'ajax',
      PROMISE = 'promise',
    }
    

Actions
-------

`addErrorLogInfo` æ–¹æ³•ç”¨äºæ·»åŠ é”™è¯¯æ—¥å¿—ï¼Œæ¥å—ç±»å‹ä¸º`ErrorLogInfo` çš„å‚æ•°ï¼Œä½¿ç”¨ [**å±•å¼€è¯­æ³•(Spread syntax)**](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax) ç®€æ´çš„æ„é€ æ–¹å¼è¿›è¡Œæ•°ç»„å’Œå¯¹è±¡æ„é€ ã€‚

1.  æ›´æ–°é”™è¯¯æ—¥å¿—æ—¶é—´å±æ€§ã€‚
2.  å°†æ—¥å¿—ä¿¡æ¯åŠ å…¥åä¸º `errorLogInfoList` çš„æ•°ç»„ä¸­ã€‚
3.  åŒæ—¶æ›´æ–°é”™è¯¯æ—¥å¿—æ€»æ•°(`errorLogListCount`) `+1`ã€‚

    addErrorLogInfo(info: ErrorLogInfo) {
      const item = {
        ...info,
        time: formatToDateTime(new Date()),
      };
      this.errorLogInfoList = [item, ...(this.errorLogInfoList || [])];
      this.errorLogListCount += 1;
    },
    

`setErrorLogListCount` æ–¹æ³•ç”¨äºé‡ç½®é”™è¯¯æ—¥å¿—æ€»æ•°æ•°å€¼ã€‚

    setErrorLogListCount(count: number): void {
      this.errorLogListCount = count;
    },
    

`addAjaxErrorInfo` æ–¹æ³•ç”¨äºåœ¨ajaxè¯·æ±‚é”™è¯¯åè§¦å‘ï¼Œå°†è¿”å›çš„é”™è¯¯ä¿¡æ¯æ ¼å¼åŒ–åï¼Œè°ƒç”¨ `addErrorLogInfo`æ–¹æ³•å°†å…¶æ·»åŠ è‡³ç³»ç»Ÿå…¨å±€æ•°ç»„ä¸­ã€‚

    addAjaxErrorInfo(error) {
      const { useErrorHandle } = projectSetting;
      if (!useErrorHandle) {
        return;
      }
      const errInfo: Partial<ErrorLogInfo> = {
        message: error.message,
        type: ErrorTypeEnum.AJAX,
      };
      if (error.response) {
        ...
      }
      this.addErrorLogInfo(errInfo as ErrorLogInfo);
    },
    

éœ€è¦åœ¨é¡¹ç›®é…ç½® `src/settings/projectSetting.ts`ä¸­å¼€å¯,å°†`useErrorHandle`å±æ€§å€¼è®¾ç½® `true` ï¼Œé»˜è®¤ä¸å¼€å¯ã€‚

    // src/settings/projectSetting.ts
    
    // æ˜¯å¦ä½¿ç”¨å…¨å±€é”™è¯¯æ•è·
    useErrorHandle: true, 
    

ä½¿ç”¨ `Partial` å°†ç±»å‹å®šä¹‰çš„æ‰€æœ‰å±æ€§éƒ½ä¿®æ”¹ä¸ºå¯é€‰ã€‚

å£°æ˜äº†ä¸€ä¸ªé”™è¯¯æ—¥å¿—å¯¹è±¡ï¼Œä»…å®šä¹‰äº†ç±»å‹å’Œæ¶ˆæ¯ä¸¤ä¸ªå±æ€§å€¼ã€‚  
å…¶ä½™çš„å±æ€§å€¼é€šè¿‡å¯¹ `error.response` å¯¹è±¡å†…å®¹è¿›è¡Œè§£æ„,ç„¶åè¿›è¡Œå¯¹è±¡å±æ€§èµ‹å€¼ã€‚

      const errInfo: Partial<ErrorLogInfo> = {
        message: error.message,
        type: ErrorTypeEnum.AJAX,
      };
      if (error.response) {
        const {
          config: { url = '', data: params = '', method = 'get', headers = {} } = {},
          data = {},
        } = error.response;
        errInfo.url = url;
        errInfo.name = 'Ajax Error!';
        errInfo.file = '-';
        errInfo.stack = JSON.stringify(data);
        errInfo.detail = JSON.stringify({ params, method, headers });
      }
    

æœ€åè°ƒç”¨`addErrorLogInfo`æ–¹æ³•ï¼Œæ·»åŠ é”™è¯¯æ—¥å¿—ä¿¡æ¯ã€‚

    this.addErrorLogInfo(errInfo as ErrorLogInfo);
    

0x02 ğŸ“šå‚è€ƒ
=========

["å±•å¼€è¯­æ³•(Spread syntax)",MDN](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax)

ä½œè€…ï¼š[Anduril](http://www.cnblogs.com/anduril/)  
  
ç®€ä¹¦ä¼ é€é—¨ï¼š[ç®€ä¹¦/Anduril](https://www.jianshu.com/u/Sw64xD)  
  
æ˜é‡‘ä¼ é€é—¨ï¼š[æ˜é‡‘/Andurils](https://juejin.cn/user/272334612084702)  
  
ä¸ªäººå°ç«™ï¼š[anduril.cn](http://anduril.cn/)  
  
æŠ€æœ¯åªæœ‰ä¸æ²‰æµ¸å…¶ä¸­æ‰èƒ½å¯¹å…¶æ›´åŠ å…¬æ­£çœ‹å¾…ï¼ æ²¡äº†ç‹‚çƒ­å’Œæµ®èºï¼Œå»ä½“ä¼šä¸‹å¼€æºä¸‹çš„è¯­æ³•é­…åŠ›ï¼è¿™é‡Œæ²¡æœ‰æŠ€æœ¯å®—æ•™çš„ç‹‚çƒ­å’Œé„™å¤·ï¼Œæ²¡æœ‰ç–¯ç‹‚çš„ä¸ªäººå´‡æ‹œï¼Œåªæ˜¯ä¸€ä¸ªæŠ€æœ¯äººæ¢ç´¢ä¹‹è·¯ä¸Šå¯¹äºç¾ä¸½ä¸ä¸‘é™‹çš„éšç¬”å’Œæ„Ÿæ‚Ÿï¼  
  
æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚

*   åˆ†ç±» [0x02.FrontEnd](https://www.cnblogs.com/anduril/category/729635.html)
*   æ ‡ç­¾ [vben-admin](https://www.cnblogs.com/anduril/tag/vben-admin/) , [vue](https://www.cnblogs.com/anduril/tag/vue/)