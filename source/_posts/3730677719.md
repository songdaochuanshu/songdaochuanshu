---
layout: post
title: "å›¾æ–‡çœ‹æ‡‚JavaScritptå¼•æ“ŽV8ä¸ŽJSæ‰§è¡Œè¿‡ç¨‹"
date: "2022-07-03T08:21:06.258Z"
---
å›¾æ–‡çœ‹æ‡‚JavaScritptå¼•æ“ŽV8ä¸ŽJSæ‰§è¡Œè¿‡ç¨‹
==========================

æœ¬ç¯‡æ–‡ç« é€šè¿‡å›¾æ–‡ä¸ºä½ ä»‹ç»äº†V8å¼•æ“Žå¤§æ¦‚çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä½ å¯ä»¥äº†è§£åˆ°ä»£ç æ˜¯ä»Žä»Žæ‰«æå™¨Scanerå˜æˆtokensï¼Œä»Žè§£æžå™¨Parserå˜æˆASTï¼Œä»Žè§£é‡Šå™¨å˜æˆå­—èŠ‚ç ç­‰ç­‰ã€‚ä»¥åŠJavaScriptä»£ç åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒåœ¨å†…å­˜çš„æƒ…å†µæ˜¯å¦‚ä½•å˜åŒ–çš„ï¼Œè®©ä½ ä»Žæ›´åŠ åº•å±‚çš„è§’åº¦åŽ»ç†è§£ä½ çš„jsä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚äº†è§£è¿™äº›åŽä½ å°±èƒ½ä»Žæ›´åŠ åº•å±‚çš„è§’åº¦åŽ»ç†è§£varçš„å˜é‡æå‡ï¼Œé—­åŒ…çš„å½¢æˆç­‰äº†ã€‚

æœ¬ç¯‡æ–‡ç« é€šè¿‡å›¾æ–‡ä¸ºä½ ä»‹ç»äº†V8å¼•æ“Ž**å¤§æ¦‚**çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä½ å¯ä»¥äº†è§£åˆ°ä»£ç æ˜¯ä»Žæ‰«æå™¨Scanerå˜æˆtokensï¼Œä»Žè§£æžå™¨Parserå˜æˆASTï¼Œä»Žè§£é‡Šå™¨å˜æˆå­—èŠ‚ç ç­‰ç­‰ã€‚ä»¥åŠJavaScriptä»£ç åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒåœ¨å†…å­˜çš„æƒ…å†µæ˜¯å¦‚ä½•å˜åŒ–çš„ï¼Œè®©ä½ ä»Žæ›´åŠ åº•å±‚çš„è§’åº¦åŽ»ç†è§£ä½ çš„jsä»£ç æ˜¯å¦‚ä½•è¿è¡Œçš„ã€‚äº†è§£è¿™äº›åŽä½ å°±èƒ½ä»Žæ›´åŠ åº•å±‚çš„è§’åº¦åŽ»ç†è§£varçš„å˜é‡æå‡ï¼Œé—­åŒ…çš„å½¢æˆç­‰äº†ã€‚

æµè§ˆå™¨åŽŸç†
-----

### æµè§ˆå™¨å†…æ ¸ä¸Žjså¼•æ“Ž

[æµè§ˆå™¨å†…æ ¸](https://zh.wikipedia.org/wiki/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E "æµè§ˆå™¨å†…æ ¸")åˆç§°â€œæŽ’ç‰ˆå¼•æ“Žâ€ï¼Œâ€œæ¸²æŸ“å¼•æ“Žâ€ï¼Œâ€œæµè§ˆå™¨å¼•æ“Žâ€ï¼Œå«æ³•å¾ˆå¤šï¼Œç®€å•æ¥è¯´å¹²çš„æ´»å°±æ˜¯å°†ä»£ç ï¼ˆHTML,XML,CSS,å›¾ç‰‡ç­‰ï¼‰è§£æžæŽ’ç‰ˆå¸ƒå±€åŽè¾“å‡ºåˆ°æ˜¾ç¤ºå™¨è®©ä½ çœ‹åˆ°ã€‚

[JavaScriptå¼•æ“Ž](https://zh.wikipedia.org/wiki/JavaScript%E5%BC%95%E6%93%8E "JavaScriptå¼•æ“Ž")æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†JavaScriptè„šæœ¬çš„è™šæ‹Ÿæœºï¼Œä¸€èˆ¬ä¼šé™„å¸¦åœ¨ç½‘é¡µæµè§ˆå™¨ä¹‹ä¸­ã€‚

ä¸»æµæµè§ˆå™¨å†…æ ¸ä¸Žjså¼•æ“Žï¼š

æµè§ˆå™¨

å†…æ ¸

jså¼•æ“Ž

Safari

WebKit

javaScriptCore

Chrome

Blink

V8

firefox

Gecko

SpiderMonkey...

### æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹æ¦‚è¿°

è¾“å…¥ç½‘å€ï¼ŒæœåŠ¡å™¨è¿”å›žhtmlï¼Œæµè§ˆå™¨å†…æ ¸å¼€å§‹è§£æžhtmlï¼Œé‡åˆ°link ç­‰ä¹‹ç±»åˆ™ä¼šæš‚åœï¼ŒåŽ»ä¸‹è½½å¯¹åº”çš„cssæˆ–è€…jsã€‚

1.  é¦–å…ˆhmtlä¼šè¢«è§£æžä¸ºdomæ ‘ï¼›
2.  ç„¶åŽcssä¼šè¢«è§£æžä¸ºcssomè§„åˆ™æ ‘ï¼›
3.  æ ¹æ®domæ ‘å’Œcssomè§„åˆ™æ ‘æž„å»ºæ¸²æŸ“æ ‘ã€‚
4.  æµè§ˆå™¨æ ¹æ®æ¸²æŸ“æ•°æ®è¿›è¡Œå¸ƒå±€ï¼ˆå›žæµï¼‰ï¼Œæ­¤é˜¶æ®µæµè§ˆå™¨è®¡ç®—å„èŠ‚ç‚¹åœ¨é¡µé¢ä¸­ç¡®åˆ‡ä½ç½®å’Œå¤§å°ï¼Œä¹Ÿç§°è‡ªåŠ¨é‡æŽ’ã€‚
5.  å¸ƒå±€åŽè¿›è¡Œç»˜åˆ¶ï¼Œå°†å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

æ¸²æŸ“å¼•æ“Žä¸ä¼šç­‰æ‰€æœ‰htmlè§£æžå®ŒæˆåŽå†åŽ»ï¼Œæž„å»ºrender treeï¼Œè€Œæ˜¯è§£æžå®Œä¸€éƒ¨åˆ†å°±æ˜¾ç¤ºä¸€éƒ¨åˆ†ã€‚ä»¥æé«˜ç”¨æˆ·ä½“éªŒã€‚

V8å¼•æ“Žçš„æ‰§è¡Œ
-------

### V8å¼•æ“Žè§£æžè¿‡ç¨‹æ¦‚è¿°

![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702220057925-973662019.svg)  
BLinKå†…æ ¸é‡åˆ°jsä»£ç åŽï¼Œä¼šä»¥æµçš„å½¢å¼ä¼ é€’ç»™v8ï¼Œç„¶å…¶å¼€å§‹å·¥ä½œï¼š

*   é¦–å…ˆæŽ¥æ”¶åˆ°æµåŽï¼Œä¼šæœ‰æ‰«æå™¨Scannerå¯¹å…¶è¿›è¡Œè¯æ³•åˆ†æžå°†ä»£ç è½¬åŒ–ä¸º`tokens`ï¼›
*   ç„¶åŽè§£æžå™¨parserå°†å…¶è½¬æ¢ä¸ºASTæŠ½è±¡è¯­æ³•æ ‘ã€‚
*   å†ç”±è§£é‡Šå™¨ignitionï¼ˆå›¾ä¸­é—ªç”µéƒ¨åˆ†ï¼‰ç”Ÿæˆå­—èŠ‚ç å†è¿›è¡Œæ‰§è¡Œã€‚

#### Parserå†æŽ¢ï¼š

**Parser**è§£æžçš„æ—¶å¹¶ä¸ä¼šè¿›è¡Œå…¨é‡è§£æžï¼ˆå…¨éƒ¨è§£æž1.è€—æ—¶é—´ï¼›2.è§£æžåŽçš„å­—èŠ‚ç éœ€æ”¾å…¥å†…å­˜è€—å†…å­˜ï¼‰ï¼Œè€Œæ˜¯æœ‰**å»¶è¿Ÿè§£æž**çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸€ç§æŒ‰éœ€è§£æžç»™æ–¹æ¡ˆï¼Œ( ç†è§£ï¼šé¦–å…ˆä¼š**Perpaser**ä¼šè§£æžå‡ºæ‰€éœ€çš„æœ€å°‘é™åº¦çš„å†…å®¹ï¼Œæ¯”å¦‚å†…éƒ¨æœ‰æœªè°ƒç”¨çš„å‡½æ•°ï¼Œåˆ™è§£æžå‡ºå‡½æ•°å£°æ˜Žï¼Œå½“è°ƒç”¨æ—¶åˆ™paserå¯¹è¯¥å‡½æ•°è¿›è¡Œå®Œæ•´çš„è§£æž )ã€‚

#### Ignitionå†æŽ¢ï¼š

**Ignition**å…³æ³¨çš„æ˜¯å‡å°‘ V8 çš„å†…å­˜å¼€é”€ï¼Œä¼šè¿›è¡Œæ‰§è¡Œå‰çš„ä¼˜åŒ–å·¥ä½œã€‚å®ƒä¼šå°†ASTè¿›è¡Œåˆ†æžå°†å¤šæ¬¡è°ƒç”¨çš„å‡½æ•°æ ‡è®°ä¸º**çƒ­ç‚¹å‡½æ•°** äº¤ç”±**TurboFan**è¿›è¡Œç¼–è¯‘ç”Ÿæˆä¼˜åŒ–åŽçš„æœºå™¨ç ï¼ˆä¼˜åŒ–ï¼Œæ–¹ä¾¿å¿«é€Ÿè°ƒç”¨ï¼‰æ‰§è¡Œã€‚è€Œå•æ¬¡è°ƒç”¨çš„å‡½æ•°åˆ™ä¼šè¢«ç”Ÿæˆå­—èŠ‚ç å†åšæ‰§è¡Œã€‚æ‰€ä»¥å®ƒä¹Ÿä¼šæœ‰ç¼–è¯‘è¿‡ç¨‹çš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰äººå¯¹JSæ˜¯å¦æ˜¯è§£é‡Šåž‹è¯­è¨€æœ‰äº‰è®®ã€‚è€Œæ­£å¦‚æœ€æ–°çš„MDNä¸Šçš„æ–‡æ¡£è¯´çš„JavaScriptæ˜¯ä¸€ç§å…·æœ‰å‡½æ•°ä¼˜å…ˆçš„è½»é‡çº§ï¼Œè§£é‡Šåž‹æˆ–å³æ—¶ç¼–è¯‘åž‹çš„ç¼–ç¨‹è¯­è¨€ï¼Œåº”è¯¥æ˜¯æœ€å‡†ç¡®çš„å§ã€‚

### V8å†…å­˜æ¨¡åž‹

V8çš„å†…å­˜ä¸»è¦åˆ†ä¸ºå †å’Œæ ˆä¸¤éƒ¨åˆ†ï¼Œç”¨ä»¥æ‰§è¡Œä»£ç ï¼Œå’ŒJVMæœ‰ç‚¹ç±»ä¼¼ðŸ˜‚ã€‚  
**å †ï¼š** è¿™æ˜¯æœ€å¤§çš„å†…å­˜å—ï¼Œä¹Ÿæ˜¯åžƒåœ¾å›žæ”¶ï¼ˆGCï¼‰å‘ç”Ÿçš„åœ°æ–¹ã€‚  
**æ ˆï¼š** æ¯ä¸ªV8è¿›ç¨‹æœ‰ä¸€ä¸ªå †å†…å­˜ã€‚è¿™æ˜¯å­˜å‚¨é™æ€æ•°æ®çš„åœ°æ–¹ï¼ŒåŒ…æ‹¬æ–¹æ³•/å‡½æ•°æ¡†æž¶ã€åŽŸå§‹å€¼å’ŒæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€‚  
![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702231759250-1725796526.png)

å½“ç„¶è¿™åªæ˜¯ç®€åŒ–ç‰ˆï¼Œå®žé™…çš„æƒ…å†µä¹Ÿä¼šæ¯”è¿™å¤æ‚å¾—å¤šï¼ˆå¦‚ä¸‹ï¼‰ï¼š  
![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702231610810-247708999.png)

### GCåžƒåœ¾å›žæ”¶

*   å¼•ç”¨è®¡æ•°ï¼šå¯¹è±¡æœ‰å¼•ç”¨æŒ‡å‘å®ƒï¼Œå¼•ç”¨å°±+1ï¼Œå¼•ç”¨ä¸º0å°±è¿›è¡Œå›žæ”¶ã€‚ä½†å…¶ä¼šäº§ç”Ÿå¾ªçŽ¯å¼•ç”¨ã€‚
*   æ ‡è®°æ¸…é™¤ï¼šæ—©æœŸV8ä¸­å †å†…å­˜é‡‡ç”¨çš„ä¸€ç§æ¸…é™¤ç®—æ³•ï¼Œæ­¤ä¼šæœ‰ä¸€ä¸ª**æ ¹å¯¹è±¡**ï¼Œå¦‚V8ä¸­å…¨å±€å¯¹è±¡ã€‚åžƒåœ¾å›žæ”¶å™¨ä¼šå®šæ—¶ä»Žæ ¹å¼€å§‹åŽ»æ‰¾å¼•ç”¨çš„å¯¹è±¡ï¼Œæ²¡æœ‰å¼•ç”¨çš„å¯¹è±¡å°±ä¼šå›žæ”¶ã€‚å¯ä»¥å¾ˆå¥½è§£å†³å¾ªçŽ¯å¼•ç”¨çš„é—®é¢˜ã€‚

JavaScriptåœ¨å†…å­˜ä¸­çš„æ‰§è¡Œè¿‡ç¨‹
-------------------

### æ‰§è¡Œå‰å‡†å¤‡ï¼š

\-> é¦–å…ˆï¼Œjså¼•æ“Žåœ¨æ‰§è¡Œä»£ç ä¹‹å‰ä¼šåœ¨åœ¨**å †å†…å­˜**ä¸­åˆ›å»ºä¸€ä¸ªå…¨å±€å¯¹è±¡GOï¼ˆGlobal Objectï¼‰ï¼š

1.  è¯¥å¯¹è±¡åœ¨**æ‰€æœ‰ä½œç”¨åŸŸ**å¯è®¿é—®
2.  ä¼šæœ‰ `Date`,`Math`,`SetTimeOut`,`SetInterval`,`String`,`Array`,`Number`ç­‰
3.  å†…ç½®windowå±žæ€§æŒ‡å‘å®ƒæœ¬èº«

\-> ç„¶åŽï¼ŒJavaScriptå¼•æ“Žä¼šåœ¨å†…éƒ¨åˆ›å»º**æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆECSï¼ˆExecution Context Stackï¼‰**ï¼Œç”¨äºŽæ‰§è¡Œä»£ç è°ƒç”¨ã€‚

### å¼€å§‹æ‰§è¡Œï¼š

\-> é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ª**å…¨å±€æ‰§è¡ŒçŽ¯å¢ƒGECï¼ˆGlobal Execution Contextï¼‰**ï¼Œå®ƒåŒ…å«ï¼šåœ¨**paserè½¬æˆASTçš„è¿‡ç¨‹**ä¸­ï¼Œå°†**å…¨å±€å®šä¹‰çš„å˜é‡ï¼Œå‡½æ•°**åŠ å…¥åˆ°**GO**ä¸­ï¼Œåˆå§‹ä¸º`undefined`ã€‚ï¼ˆå˜é‡ä½œç”¨åŸŸæå‡ï¼šå…¨å±€å®šä¹‰çš„å˜é‡ï¼Œå‡½æ•°ä¼šå…ˆå…¥GOå†æ‰§è¡Œï¼‰ã€‚

å¹¶å°†å…¶å…¥æ ˆåˆ°`ECS`ä¸­ã€‚ç„¶åŽé€è¡Œæ‰§è¡Œï¼Œè¿›è¡Œå˜é‡èµ‹å€¼ï¼Œå‡½æ•°æ‰§è¡Œæ“ä½œã€‚

\-> åœ¨æ‰§è¡Œåˆ°ä¸€ä¸ªå‡½æ•°æ—¶ä¼šåˆ›å»º**å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡FEC**ï¼ˆFuction Execution Contextï¼‰ï¼Œå¹¶åŽ‹å…¥**æ‰§è¡Œä¸Šä¸‹æ–‡æ ˆECS**ï¼Œå®ƒåŒ…å«ä¸‰éƒ¨åˆ†ï¼š

1.  åœ¨è§£æžå‡½æ•°æˆä¸ºASTæ ‘ç»“æž„æ—¶ï¼Œä¼šåˆ›å»ºAOï¼ˆActivation Objectï¼‰åŒ…å«ï¼š**å½¢å‚ï¼Œargumentsï¼Œå‡½æ•°å®šä¹‰(å‡½æ•°ä»£ç )ï¼Œå‡½æ•°æŒ‡å‘å¯¹è±¡ï¼Œå®šä¹‰è¾¹é‡**ï¼›
2.  ä½œç”¨åŸŸé“¾ï¼šVO(åœ¨å‡½æ•°ä¸­å°±æ˜¯AOå¯¹è±¡) + çˆ¶çº§ä½œç”¨åŸŸ
3.  thisç»‘å®šçš„å€¼ã€‚

å‡†å¤‡æ‰§è¡Œã€åˆ›å»ºGO åˆ›å»ºECS è§£æžå…¨å±€å˜é‡ï¼Œå‡½æ•°ï¼ˆè‹¥å˜é‡åˆå§‹ä¸ºundefinedï¼Œè‹¥å‡½æ•°åˆ™åˆ›å»ºå‡½æ•°å¯¹è±¡è¿›è¡Œå­˜å‚¨ï¼‰ã€‘-> æ‰§è¡Œä»£ç ã€é‡åˆ°å‡½æ•°è°ƒç”¨ -> åˆ›å»ºå…¶å‡½æ•°çš„AOå¯¹è±¡ -> åˆ›å»ºå…¶å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ -> æ‰§è¡Œå‡½æ•°å†…éƒ¨ä»£ç ã€‘

æ³¨ï¼šåœ¨æœ€æ–°çš„ECMAæ ‡å‡†ä¸­ï¼Œå˜é‡å¯¹è±¡VOï¼Œè¯¥ä¸ºäº†å˜é‡çŽ¯å¢ƒVEï¼Œå…¶å¯ä»¥ä¸ä¸ºå¯¹è±¡ï¼Œåªè¦å…¶èƒ½å­˜å‚¨çŽ¯å¢ƒè®°å½•ï¼Œå…¶åŒ…å«çš„å†…å®¹ä¹Ÿæœ‰äº›å·®å¼‚ã€‚

### ç»“åˆä»£ç ç¤ºä¾‹è¿›è¡Œåˆ†æž

#### æ¡ˆä¾‹ä¸€

    var name = "shinna_mashiro";
    foo(666);
    function foo(num){
        console.log(m);
        var m = 10;
        var n = 20;
        function bar(){
            console.log(name)
        }
        bar()
    }
    

è¿™æ˜¯é€šè¿‡varå£°æ˜Žçš„å˜é‡ï¼Œè€Œé€šè¿‡letï¼Œconstå£°æ˜Žçš„å˜é‡ECMA262å¯¹å®ƒä»¬æ˜¯è¿™ä¹ˆæè¿°çš„ï¼šThe variablesï¼ˆlet æˆ– constï¼‰are created when their containing Lexical Environment is instantiate but may not be accessed in any way until the variable's LexicalBinding is evaluated. è¿™äº›å˜é‡ä¼šè¢«åˆ›å»ºåœ¨åŒ…å«ä»–ä»¬çš„è¯æ³•çŽ¯å¢ƒï¼ˆVE -> VOï¼‰è¢«å®žä¾‹åŒ–æ—¶ï¼Œä½†æ˜¯æ˜¯ä¸å¯ä»¥è®¿é—®çš„ï¼Œç›´åˆ°è¯æ³•ç»‘å®šè¢«æ‰§è¡Œã€‚**ä¹Ÿå°±æ˜¯åœ¨FECåˆ›å»ºçš„æ—¶å€™ï¼ŒVEè¢«å®žä¾‹åŒ–æ—¶å°±ä¼šåˆ›å»ºå®ƒï¼Œä½†æ˜¯ä¸èƒ½è¢«è®¿é—®ï¼Œæ‰€ä»¥æå‡ä¸äº†ã€‚**ï¼ˆæš‚æ—¶æ€§æ­»åŒºï¼‰

![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702233044378-1790950433.png)  
![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220703000226994-1525867840.png)  
![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702233426002-14414353.png)

#### æ¡ˆä¾‹äºŒé—­åŒ…

    function makeAdder(count){
        return function(num){
            retrun count + num;
        }
    }
    var add10 = makeAdder(10);
    console.log(add10(5));
    

å¯ä»¥çœ‹åˆ°åœ¨ä»£ç æ‰§è¡Œå®ŒåŽï¼Œé—­åŒ…ç»“æž„ä¸­ï¼Œä¼šä¸€ç›´è¿˜æœ‰å¼•ç”¨åœ¨GOä¸­ï¼Œæ‰€ä»¥æ­¤æ—¶ä¸ä¼šå¯¹å…¶å†…å­˜è¿›è¡Œå›žæ”¶ã€‚  
![image](https://img2022.cnblogs.com/blog/1249408/202207/1249408-20220702234259139-2129948383.png)

> éƒ¨åˆ†å‚è€ƒåŠè¡¥å……ï¼š  
> 1.Visualizing memory management in V8 Engine (JavaScript, NodeJS, Deno, WebAssembly)ï¼š[https://deepu.tech/memory-management-in-v8/](https://deepu.tech/memory-management-in-v8/)  
> 2.å…¨é¢åˆ†æžæ€»ç»“JSå†…å­˜æ¨¡åž‹ï¼š[https://segmentfault.com/a/1190000021996331](https://segmentfault.com/a/1190000021996331)  
> 3.V8å¼•æ“Žè¯¦è§£ï¼š[https://juejin.cn/post/6844904146798116871](https://juejin.cn/post/6844904146798116871)  
> 4.JavaScriptåˆ°åº•æ˜¯è§£é‡Šåž‹è¯­è¨€è¿˜æ˜¯ç¼–è¯‘åž‹è¯­è¨€?ï¼š[https://segmentfault.com/a/1190000013126460](https://segmentfault.com/a/1190000013126460)  
> 5.Blazingly fast parsing, part 2: lazy parsing: [https://v8.dev/blog/preparser](https://v8.dev/blog/preparser)