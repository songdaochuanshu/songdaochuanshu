---
layout: post
title: "Feigné€šè¿‡è‡ªå®šä¹‰æ³¨è§£å®ç°è·¯å¾„çš„è½¬ä¹‰"
date: "2022-06-28T03:44:36.981Z"
---
Feigné€šè¿‡è‡ªå®šä¹‰æ³¨è§£å®ç°è·¯å¾„çš„è½¬ä¹‰
===================

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201117221722916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM0NjIzNTU3,size_16,color_FFFFFF,t_70#pic_center)

æœ¬æ–‡ä¸»è¦è®²è§£å¦‚æœé€šè¿‡æ³¨è§£å®ç°å¯¹è·¯ç”±ä¸­çš„è·¯å¾„è¿›è¡Œè‡ªå®šä¹‰ç¼–ç 
============================

### èƒŒæ™¯

è¿‘æœŸç”±äºé¡¹ç›®ä¸­éœ€è¦ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡Feignå°è£…ä¸€ä¸ªå¯¹Harboræ“ä½œçš„sdkä¿¡æ¯ã€‚  
åœ¨è°ƒç”¨çš„è¿‡ç¨‹ä¸­å‘ç°ï¼Œå½“è¯·æ±‚å‚æ•°ä¸­å¸¦æœ‰"/"æ—¶ï¼ŒFeigné»˜è®¤ä¼šå°†"/"å½“æˆè·¯å¾„å»è§£æï¼Œè€Œä¸æ˜¯å½“æˆå®Œæ•´çš„ä¸€ä¸ªå‚æ•°è§£æï¼Œå®ä¾‹å¦‚ä¸‹  
è¯·æ±‚è·¯å¾„ä¸ºï¼šapi/v2.0/projects/{projectName}/repositories  
æ³¨è§£å‚æ•°ä¸ºï¼š@PathVariable("projectName")  
æ­£å¸¸è¯·æ±‚ä¸ºï¼šapi/v2.0/projects/test/repositories  
å¼‚å¸¸è·¯å¾„ä¸ºï¼šapi/v2.0/projects/test/pro/repositories  
ç›¸ä¿¡ç»†å¿ƒçš„åŒå­¦å·²ç»å‘ç°ä¸Šé¢çš„å·®å¼‚äº†ï¼Œæ­£å¸¸çš„{projectName}ä¸­å¯¹åº”çš„å€¼ä¸ºtestï¼Œè€Œå¼‚å¸¸çš„å´å¯¹åº”ä¸ºtest/proï¼Œæ‰€ä»¥å½“å¼‚å¸¸çš„è¯·æ±‚æ‰“åˆ°harborçš„æœºå™¨æ—¶ï¼Œè¢«è§£æä¸ºapi/v2.0/projects/test/pro/repositoriesï¼Œæ‰€ä»¥ä¼šç›´æ¥è¿”å›404  
ä»¥ä¸Šå°±æ˜¯èƒŒæ™¯äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºä¸€ä¸‹è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ

é¦–å…ˆæˆ‘ä»¬çŸ¥é“springbootä¸­é»˜è®¤æ˜¯å¸¦æœ‰å‡ ç§æ³¨é‡Šå‚æ•°å¤„ç†å™¨çš„

    @MatrixVariableParameterProcessor
    @PathVariableParameterProcessor
    @QueryMapParameterProcessor
    @RequestHeaderParameterProcessor
    @RequestParamParameterProcessor
    @RequestPartParameterProcessor
    

å› ä¸ºæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°æ˜¯åœ¨è·¯å¾„ä¸­çš„ï¼Œæ‰€ä»¥é»˜è®¤æˆ‘ä»¬ä¼šä½¿ç”¨@PathVariableParameterProcessoræ¥æ ‡è¯†è·¯å¾„å‚æ•°ï¼Œè€Œæˆ‘ä»¬éœ€è¦è½¬ä¹‰çš„å‚æ•°å…¶å®ä¹Ÿæ˜¯åœ¨è·¯å¾„ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹@PathVariableParameterProcessoræ˜¯å¦‚ä½•å®ç°çš„

    public boolean processArgument(AnnotatedParameterProcessor.AnnotatedParameterContext context, Annotation annotation, Method method) {
            String name = ((PathVariable)ANNOTATION.cast(annotation)).value();
            Util.checkState(Util.emptyToNull(name) != null, "PathVariable annotation was empty on param %s.", new Object[]{context.getParameterIndex()});
            context.setParameterName(name);
            MethodMetadata data = context.getMethodMetadata();
            String varName = '{' + name + '}';
            if (!data.template().url().contains(varName) && !this.searchMapValues(data.template().queries(), varName) && !this.searchMapValues(data.template().headers(), varName)) {
                data.formParams().add(name);
            }
            return true;
        }
    

å…¶å®åœ¨æºç ä¸­ï¼Œspringbootå¹¶æ²¡æœ‰åšä»€ä¹ˆç¥å™¨çš„äº‹æƒ…ï¼Œå°±æ˜¯è·å–ä½¿ç”¨äº†PathVariableæ³¨è§£çš„å‚æ•°ï¼Œç„¶åå†å°†å…¶æ·»åŠ åˆ°fromParamsä¸­å°±å¯ä»¥ã€‚  
çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æƒ³åˆ°ï¼Œæ—¢ç„¶åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æ‹¿åˆ°å¯¹åº”çš„å‚æ•°äº†ï¼Œé‚£æƒ³åšä»€ä¹ˆäº‹æƒ…ä¸éƒ½æ˜¯ç”±æˆ‘ä»¬è‡ªå·±æ¥å†³å®šäº†ï¼Œæ¥ä¸‹æ¥è¯´å¹²å°±å¹²ï¼Œ  
é¦–å…ˆæˆ‘ä»¬å£°æ˜ä¸€ä¸ªå±äºè‡ªå·±çš„æ³¨è§£ï¼Œ

    import org.springframework.core.annotation.AliasFor;
    
    import java.lang.annotation.*;
    
    /**
      * @CreateAt: 2022/6/11 0:46
     * @ModifyAt: 2022/6/11 0:46
     * @Version 1.0
     */
    @Target(ElementType.PARAMETER)
    @Retention(RetentionPolicy.RUNTIME)
    @Documented
    public @interface SlashPathVariable {
    
        /**
         * Alias for {@link #name}.
         */
        @AliasFor("name")
        String value() default "";
    
        /**
         * The name of the path variable to bind to.
         * @since 4.3.3
         */
        @AliasFor("value")
        String name() default "";
    
        /**
         * Whether the path variable is required.
         * <p>Defaults to {@code true}, leading to an exception being thrown if the path
         * variable is missing in the incoming request. Switch this to {@code false} if
         * you prefer a {@code null} or Java 8 {@code java.util.Optional} in this case.
         * e.g. on a {@code ModelAttribute} method which serves for different requests.
         * @since 4.3.3
         */
        boolean required() default true;
    }
    

å£°æ˜å®Œæ³¨è§£åï¼Œæˆ‘ä»¬å°±éœ€è¦æ¥è‡ªå®šä¹‰è‡ªå·±çš„å‚æ•°è§£æå™¨äº†ï¼Œé¦–å…ˆç»§æ‰¿AnnotatedParameterProcessor

    import feign.MethodMetadata;
    import feign.Util;
    import lombok.Data;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.cloud.openfeign.AnnotatedParameterProcessor;
    import org.springframework.web.bind.annotation.PathVariable;
    
    import java.lang.annotation.Annotation;
    import java.lang.reflect.AnnotatedType;
    import java.lang.reflect.Method;
    import java.net.URLEncoder;
    import java.nio.charset.Charset;
    import java.util.Collection;
    import java.util.Iterator;
    import java.util.List;
    import java.util.Map;
    import java.util.stream.Collectors;
    
    /**
     * @CreateAt: 2022/6/11 0:36
     * @ModifyAt: 2022/6/11 0:36
     * @Version 1.0
     */
    public class SlashPathVariableParameterProcessor implements AnnotatedParameterProcessor {
    
        private  static  final Class<SlashPathVariable> ANNOTATION=SlashPathVariable.class;
        @Override
        public Class<? extends Annotation> getAnnotationType() {
            return (Class<? extends Annotation>) ANNOTATION;
        }
    
        @Override
        public boolean processArgument(AnnotatedParameterContext context, Annotation annotation, Method method) {
            MethodMetadata data = context.getMethodMetadata();
            String name = ANNOTATION.cast(annotation).value();
            Util.checkState(Util.emptyToNull(name) != null, "SlashPathVariable annotation was empty on param %s.", new Object[]{context.getParameterIndex()});
            context.setParameterName(name);
            data.indexToExpander().put(context.getParameterIndex(),this::expandMap);
            return true;
        }
    
        private String expandMap(Object object) {
            String encode = URLEncoder.encode(URLEncoder.encode(object.toString(), Charset.defaultCharset()), Charset.defaultCharset());
            return encode;
        }
    }
    

å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬è·å–åˆ°è‡ªå®šä¹‰æ³¨è§£çš„å‚æ•°åï¼Œå°†å½“å‰å‚æ•°æ·»åŠ æ‰“Paramåï¼Œå¹¶ä¸”ä¸ºå½“å‰å‚æ•°æŒ‡å®šè‡ªå®šä¹‰çš„ç¼–ç æ ¼å¼ã€‚  
æœ€åï¼Œæˆ‘ä»¬å†é€šè¿‡Beançš„å½¢å¼å°†å¯¹åº”çš„æ³¨è§£æ·»åŠ åˆ°å®¹å™¨ä¸­

    import feign.Contract;
    import org.springframework.cloud.openfeign.AnnotatedParameterProcessor;
    import org.springframework.cloud.openfeign.support.SpringMvcContract;
    import org.springframework.context.annotation.Bean;
    import org.springframework.stereotype.Component;
    
    import java.util.ArrayList;
    import java.util.List;
    
    /**
     * @CreateAt: 2022/6/11 0:48
     * @ModifyAt: 2022/6/11 0:48
     * @Version 1.0
     */
    @Component
    public class SlashBean {
    
        @Bean
        public Contract feignContract(){
            List<AnnotatedParameterProcessor> processors=new ArrayList<>();
            processors.add(new SlashPathVariableParameterProcessor());
            return new SpringMvcContract(processors);
        }
    }
    

æœ€åæˆ‘ä»¬å°†ä¸Šé¢çš„å‚æ•°æ³¨è§£PathVariableæ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„@SlashPathVariableï¼Œå°±å¤§åŠŸå‘Šæˆäº†

### æœ€å

é€šè¿‡ä»¥ä¸Šçš„å½¢å¼è¿›è¡Œæ³¨å…¥çš„è¯ï¼Œä¼šæ³¨å…¥åˆ°Springå…¨å±€ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘æ˜¯å¦ç¬¦åˆåœºæ™¯

> å¦‚æœ‰å“ªé‡Œè®²å¾—ä¸æ˜¯å¾ˆæ˜ç™½æˆ–æ˜¯æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£  
> å¦‚æ‚¨å–œæ¬¢çš„è¯ä¸å¦¨ç‚¹ä¸ªèµæ”¶è—ä¸€ä¸‹å§ğŸ™‚