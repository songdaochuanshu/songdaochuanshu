---
layout: post
title: "CSAPP - BombLab"
date: "2022-10-23T08:28:38.860Z"
---
CSAPP - BombLab
===============

### Bomb Lab

å¼•è¨€ï¼šä¸»è¦ä»»åŠ¡æ˜¯â€œæ‹†ç‚¸å¼¹â€ã€‚æ‰€è°“ç‚¸å¼¹ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œè¦æ±‚è¾“å…¥å…­ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå­—ç¬¦ä¸²å¯¹åº”ä¸€ä¸ªphaseã€‚å¦‚æœå­—ç¬¦ä¸²è¾“å…¥é”™è¯¯ï¼Œç³»ç»Ÿå°±ä¼šæç¤º`BOOM!!!`è§£å†³è¿™æ¬¡å®éªŒéœ€è¦å°†äºŒè¿›åˆ¶æ–‡ä»¶åæ±‡ç¼–ï¼Œé€šè¿‡è§‚å¯Ÿç†è§£æ±‡ç¼–è¯­è¨€æè¿°çš„ç¨‹åºè¡Œä¸ºæ¥çŒœæµ‹ç¬¦åˆæ¡ä»¶çš„å­—ç¬¦ä¸²ã€‚å¯ä»¥çœ‹å‡ºè¯¥å¯æ‰§è¡Œç¨‹åºè¦æ±‚ä»å‘½ä»¤è¡Œæˆ–è€…æ–‡ä»¶ä»¥ è¡Œ ä¸ºå•ä½è¯»å…¥å­—ç¬¦ä¸²ï¼Œæ¯è¡Œå­—ç¬¦ä¸²å¯¹åº”ä¸€ä¸ªphaseçš„è¾“å…¥ã€‚å¦‚æœphaseæ‰§è¡Œå®Œæ¯•ï¼Œä¼šè°ƒç”¨phase\_defused å‡½æ•°è¡¨æ˜è¯¥ phase æˆåŠŸæå®šã€‚å®éªŒå…±æœ‰6ä¸ª phaseï¼Œéš¾åº¦æ˜¯é€çº§æå‡ï¼Œè€ƒç‚¹ä¹Ÿä¸å°½ç›¸åŒã€‚é¦–å…ˆæ‰§è¡Œå‘½ä»¤`objdump -d bomb > bomb.txt`å¾—åˆ°åæ±‡ç¼–ä»£ç ã€‚

#### Phase1

> è€ƒå¯Ÿç‚¹ï¼šå­—ç¬¦ä¸²çš„ä¼ é€’æ–¹å¼

æŸ¥çœ‹`bomb.txt`æ–‡ä»¶çš„åæ±‡ç¼–ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œé¦–å…ˆæ ˆé¡¶æŒ‡é’ˆå‘ä¸‹ç§»åŠ¨äº†8ä¸ªå­—èŠ‚ï¼Œåœ¨64ä½æœºå™¨ä¸‹å°±æ˜¯ä¸€æ ¼ï¼Œç„¶åå°†`0x402400`ä¼ é€’ç»™äº†`esi`å¯„å­˜å™¨ï¼ˆä¿å­˜å‡½æ•°å‚æ•°çš„å¯„å­˜å™¨ï¼‰ï¼Œåœ¨`0x400ee9`å¤„è°ƒç”¨äº†`string_not_equal`å‡½æ•°ï¼Œè°ƒç”¨è¿”å›åå¦‚æœ`eax`å¯„å­˜å™¨çš„å€¼ä¸º0çš„è¯ï¼Œæˆ‘ä»¬å°±ä¼šè·³è½¬åˆ°`phase_1 + 0x17 = 400ef7`çš„ä½ç½®ï¼Œå¦åˆ™çš„è¯è°ƒç”¨`explode_bomb`å‡½æ•°å°±å¤±è´¥äº†ï¼Œæ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦è®©å…¶åˆ¤æ–­ç›¸ç­‰ï¼Œåˆ©ç”¨`gdb`æŸ¥çœ‹`0x402400`å¤„çš„å­—ç¬¦ä¸²ï¼Œ

    0000000000400ee0 <phase_1>:
      400ee0:       48 83 ec 08             sub    $0x8,%rsp
      400ee4:       be 00 24 40 00          mov    $0x402400,%esi
      400ee9:       e8 4a 04 00 00          callq  401338 <strings_not_equal>
      400eee:       85 c0                   test   %eax,%eax
      400ef0:       74 05                   je     400ef7 <phase_1+0x17>
      400ef2:       e8 43 05 00 00          callq  40143a <explode_bomb>
      400ef7:       48 83 c4 08             add    $0x8,%rsp
      400efb:       c3                      retq
    

![image-20221020190902442](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020190902.png)

æˆ‘ä»¬æŒ‰ s å•æ­¥æ‰§è¡Œæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°è¿™ä¸ªå­—ç¬¦ä¸²

![image-20221020191004747](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020191004.png)

æˆ‘ä»¬`gdb bomb`æ—¶ï¼Œå°†ä¸Šé¢çš„å­—ç¬¦ä¸²è¾“å…¥ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€å…³å°±è¿‡äº†ï¼Œ`Border relations with Canada have never been better.`

![image-20221020191159666](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020191159.png)

#### Phase2

> è€ƒå¯Ÿç‚¹ï¼šæ±‡ç¼–ä»£ç ä¸­æ•°ç»„çš„è¡¨ç¤º

è¿˜æ˜¯é¦–å…ˆæŸ¥çœ‹æ±‡ç¼–ä»£ç 

    0000000000400efc <phase_2>:
    400efc:       55                      push   %rbp                      	# ä¿å­˜rbp
    400efd:       53                      push   %rbx				 	  # ä¿å­˜rbx
    400efe:       48 83 ec 28             sub    $0x28,%rsp				   # æ‰©å¤§æ ˆç©ºé—´ï¼Œæ‰©å¤§0x28å³40ä¸ªå­—èŠ‚ 
    400f02:       48 89 e6                mov    %rsp,%rsi				   # ä¿å­˜æ ˆé¡¶å…ƒç´ åˆ°rsiå¯„å­˜å™¨
    # å¯¹åº”çš„Cè¯­è¨€æ ¼å¼æ±‡ç¼–ä»£ç 
    rsi = rsp;
    callq read_six_number;
    if (*rsp == 1)
    	goto 400f30;
    else 
    	callq explode_bomb;
    goto 400f30;
    400f05:       e8 52 05 00 00          callq  40145c <read_six_numbers>     # è¯»å…¥å…­ä¸ªæ•°å­—
    400f0a:       83 3c 24 01             cmpl   $0x1,(%rsp)				  # æ¯”è¾ƒrspå¿…é¡»ä¸º1
    400f0e:       74 20                   je     400f30 <phase_2+0x34>		# å¦‚æœm[rsp] = 1åˆ™è·³è½¬åˆ°0x400f30
    400f10:       e8 25 05 00 00          callq  40143a <explode_bomb>		# æ˜¾ç„¶ä¸èƒ½æ‰§è¡Œè¿™æ¡æŒ‡ä»¤
    400f15:       eb 19                   jmp    400f30 <phase_2+0x34>  
    400f17:       8b 43 fc                mov    -0x4(%rbx),%eax   # ä¸‹é¢æ˜¯ä¸€æ®µå¾ªç¯  eax = M[rbx - 4]
    # 400f17 - 400f25:
    eax = *(rbx-4);  # æ¯æ¬¡å–å‡ºM[rbx - 4]çš„å€¼ç»™eax
    eax += eax;      # eaxæ¯æ¬¡éƒ½ä¼šå˜ä¸º *(ebx - 4)çš„äºŒå€
    if (eax == *rbx) # rbxä¸ºå­˜æ”¾çš„ç¬¬äºŒä¸ªå…ƒç´ çš„å€¼  å³ä¸Šä¸€ä¸ªå…ƒç´ çš„äºŒå€å¿…é¡»ç­‰äºä¸‹ä¸€ä¸ªå…ƒç´ çš„å€¼
    	goto 400f25;
    else 
    	callq explode_bomb;
    400f1a:       01 c0                   add    %eax,%eax         # eax = eax + eax 
    400f1c:       39 03                   cmp    %eax,(%rbx)		 # if (eax == m[rbx]) goto 0x400f25
    400f1e:       74 05                   je     400f25 <phase_2+0x29> # è·³è¿‡ä¸‹é¢çš„bomb  æ˜¾ç„¶æˆ‘ä»¬éœ€è¦è®©eax = m[rbx]
    400f20:       e8 15 05 00 00          callq  40143a <explode_bomb>
    400f25:       48 83 c3 04             add    $0x4,%rbx        # rbx = rbx + 4
    # 400f25 - 400f2e:
    rbx += 4;			# ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œä¸‹ä¸€æ¬¡çš„ rbx - 4å°±ç›¸å½“äºè¿™ä¸€æ¬¡çš„rbxäº†
    # ä¸éš¾çœ‹å‡ºï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä»¥rbxä¸ºæœç´¢æŒ‡é’ˆï¼Œä»¥rbpä¸ºç»“å°¾ä¿¡å·çš„å¾ªç¯
    if (rbx != rbp)     # åªè¦rbxè¿˜æ²¡æœ‰åˆ°rbp   rbxå…¶å®å°±ç›¸å½“äºforå¾ªç¯çš„i  rbpä¸º6 
    	goto 400f17;	# å¾ªç¯
    else 
    	goto 400f3c;
    400f29:       48 39 eb                cmp    %rbp,%rbx        # if (rbx-rbp!=0) goto 0x400f17ï¼Œå›åˆ°å¾ªç¯å¼€å§‹
    400f2c:       75 e9                   jne    400f17 <phase_2+0x1b>
    400f2e:       eb 0c                   jmp    400f3c <phase_2+0x40> # rbx==rbpçš„è¯å°±ä¼šåˆ°è¿™é‡Œ  0x400f3c
    400f30:       48 8d 5c 24 04          lea    0x4(%rsp),%rbx   # rbx = rsp + 4  leaæŒ‡ä»¤ä¼ é€’çš„æ˜¯å¯„å­˜å™¨çš„å†…å®¹
    400f35:       48 8d 6c 24 18          lea    0x18(%rsp),%rbp  # rbp = rsp + 24
    400f3a:       eb db                   jmp    400f17 <phase_2+0x1b> # æ¥ç€å¾ªç¯
    400f3c:       48 83 c4 28             add    $0x28,%rsp
    400f40:       5b                      pop    %rbx
    400f41:       5d                      pop    %rbp
    400f42:       c3                      retq
    # å…­ä¸ªæ•°åˆ†åˆ«å­˜æ”¾åˆ° rsp rsp+0x4  rsp+0x8  rsp+0xc  rsp+0x
    # read_six_numbersä»£ç   éœ€è¦æˆ‘ä»¬è¾“å…¥6ä¸ªæ•°å­—ç„¶åè¿›è¡Œæ¯”è¾ƒè¿™é‡Œè¿˜æœ‰å¦‚æœæ•°å­—ä¸æ»¡è¶³6ä¸ªçš„å¥å£®æ€§åˆ¤æ–­  æ³¨æ„rdiå’Œrsiå¯„å­˜å™¨å·²ç»è¢«ç”¨æ¥ä¿å­˜read_six_numbersçš„ä¸¤ä¸ªå‚æ•°äº†ï¼Œ
    000000000040145c <read_six_numbers>:
    40145c:       48 83 ec 18             sub    $0x18,%rsp  # 6ä¸ªæ•°ï¼Œ 4 * 6 = 24 = 0x18
    401460:       48 89 f2                mov    %rsi,%rdx   # åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­æˆ‘ä»¬å°†rspå­˜å‚¨åˆ°äº†rsiä¸­
    401463:       48 8d 4e 04             lea    0x4(%rsi),%rcx  # rsp + 4çš„åœ°å€ï¼Œå­˜æ”¾è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°
    401467:       48 8d 46 14             lea    0x14(%rsi),%rax # ç”¨raxæš‚å­˜è¾“å…¥çš„ç¬¬å…­ä¸ªæ•°(rsp + 0x14)
    40146b:       48 89 44 24 08          mov    %rax,0x8(%rsp)  # rsp + 8 = rax = rsi(ä¹‹å‰çš„rsp) + 0x14  
    401470:       48 8d 46 10             lea    0x10(%rsi),%rax # å­˜æ”¾ç¬¬äº”ä¸ªæ•°ï¼Œå­˜æ”¾åˆ°äº†raxå¯„å­˜å™¨ä¸­
    401474:       48 89 04 24             mov    %rax,(%rsp) 	   # rsp = rsi(ä¹‹å‰çš„rsp) + 0x10(å¤šçš„å‚æ•°å­˜åˆ°å†…å­˜)
    401478:       4c 8d 4e 0c             lea    0xc(%rsi),%r9   # å­˜æ”¾ç¬¬å››ä¸ªæ•°   è¿™æ—¶å€™å…­ä¸ªå¯„å­˜å™¨å·²ç»ç”¨å®Œäº†
    40147c:       4c 8d 46 08             lea    0x8(%rsi),%r8   # å­˜æ”¾ç¬¬ä¸‰ä¸ªæ•°  
    401480:       be c3 25 40 00          mov    $0x4025c3,%esi  # ç»™rsi èµ‹å€¼ä¸º 0x4025c3
    401485:       b8 00 00 00 00          mov    $0x0,%eax
    40148a:       e8 61 f7 ff ff          callq  400bf0 <__isoc99_sscanf@plt>  # è°ƒç”¨ sscanf å‡½æ•°è¯»å–è¾“å…¥
    40148f:       83 f8 05                cmp    $0x5,%eax # æ¯”è¾ƒä¸Šé¢å‡½æ•°çš„è¿”å›å€¼  å¦‚æœå¤§äº5ï¼Œè¯´æ˜è¯»å–çš„åˆæ³•
    401492:       7f 05                   jg     401499 <read_six_numbers+0x3d>
    401494:       e8 a1 ff ff ff          callq  40143a <explode_bomb>  # å¦åˆ™æ‰§è¡Œç‚¸å¼¹bomb
    401499:       48 83 c4 18             add    $0x18,%rsp  # æ¢å¤å †æ ˆ
    40149d:       c3                      retq
    

è¿™æ¬¡æ±‡ç¼–ä»£ç æ¯”è¾ƒé•¿äº†ï¼Œåˆ†æçš„ç»“æœéƒ½å†™åœ¨æ³¨é‡Šé‡Œäº†ï¼Œä¸‹é¢é€šè¿‡`gdb`åŠ¨æ€è°ƒè¯•ä¸€ä¸‹ï¼Œé¦–å…ˆ`b phase_2`ç„¶å`run`ï¼Œå¯ä»¥çœ‹åˆ°å››ä¸ªå¯„å­˜å™¨å‡ä¿å­˜äº†æˆ‘ä»¬çš„è¾“å…¥

![image-20221020222529333](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020222529.png)

æŸ¥çœ‹å¯„å­˜å™¨çš„å†…å®¹`i reg`æˆ–è€…`p $eax`ï¼Œæ¥ç€æŸ¥çœ‹å†…å­˜ä¸­è¯¥åœ°å€çš„å†…å®¹ï¼Œ/sè¡¨ç¤ºä»¥å­—ç¬¦å½¢å¼æ˜¾ç¤ºã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¾“å…¥çš„å†…å®¹éƒ½æ˜¯ä»¥å­—ç¬¦ä¸²æ ¼å¼å…ˆä¿å­˜çš„ï¼Œç„¶åé€šè¿‡`sscanf`æ ¼å¼åŒ–è¾“å‡ºä¸ºäº†6ä¸ªæ•´æ•°

![image-20221020211142721](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020211142.png)

![image-20221020222606108](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020222606.png)

æ‰§è¡Œåˆ°è°ƒç”¨`read_six_numbers`å‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™äº†`rdi`ï¼Œå³æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œç„¶åå°†`rsi`å¯„å­˜å™¨ç½®ä¸º0ï¼Œæ³¨æ„è¿™é‡Œçš„åæ±‡ç¼–ç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯ç›®çš„æ“ä½œæ•°ï¼Œ`rsi`ä¿å­˜çš„æ˜¯æå‡å †æ ˆåçš„`rsp`çš„å€¼ï¼Œç”¨æ¥ä¿å­˜æ•°ç»„çš„èµ·å§‹åœ°å€ã€‚

![image-20221020222653690](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020222653.png)

ä½¿ç”¨ f å¯ä»¥æŸ¥çœ‹å½“å‰æ ˆä¿¡æ¯ï¼Œåˆ©ç”¨ `bt` æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆä¹‹é—´çš„å…³ç³»

![image-20221020214339314](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020214339.png)

ä¸€æ­¥æ­¥æ‰§è¡Œä¸‹å»ï¼Œç›´åˆ°ä¸Šé¢ä¸æ˜¯å¾ˆæ‡‚çš„`mov $0x4025c3, %esi`æŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°è¯¥åœ°å€çš„å†…å®¹å¦‚ä¸‹ï¼Œå…¶å®å°±æ˜¯ä½œä¸º`sscanf`å‡½æ•°çš„å‚æ•°ï¼Œ`rdi`å¯„å­˜å™¨çš„å†…å®¹å§‹ç»ˆéƒ½æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºç«¯å€ªï¼Œè¾“å…¥çš„å­—ç¬¦ä¸²ä¿å­˜åœ¨`rdi`ä¸­ï¼Œæ­¤æ—¶ä½œä¸º`sscanf`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°

![image-20221020214013511](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020214013.png)

![image-20221020214546574](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020214546.png)

è°ƒç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°å°†`rax`å¯„å­˜å™¨çš„å€¼è®¾ç½®ä¸º6ï¼Œä»è€Œå¯ä»¥ä¸‹é¢å¯ä»¥`cmp $0x5, %eax`ä½¿`eax`çš„å€¼å¤§äº5ï¼Œç›´æ¥è·³è½¬å›`phase_2`å‡½æ•°ã€‚å›åˆ°`phase_2`å‡½æ•°ï¼Œä¹‹åæ‰§è¡Œçš„å°±æ˜¯ä¸€ä¸ªå¾ªç¯åˆ¤æ–­äº†ï¼Œåˆ¤æ–­å­˜è¿›å»çš„æ•°æ˜¯å¦æ»¡è¶³åä¸€ä¸ªæ•°æ˜¯å‰ä¸€ä¸ªæ•°çš„äºŒå€ï¼Œ`rbx`ä¿å­˜çš„åœ°å€æ˜¯ä»2å¼€å§‹çš„ï¼Œæ ¼å¼åŒ–åçš„6ä¸ªæ•°å­—å­˜å‚¨åˆ°äº†ä»`ebp`å¼€å§‹çš„è¿ç»­çš„å†…å­˜ç©ºé—´ï¼ŒæŸ¥çœ‹å¯è§ä¸‹å›¾

![image-20221020223141926](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020223141.png)

è¿™é‡Œçš„æ±‡ç¼–ä»£ç æ¯”è¾ƒå¥½ç†è§£ï¼Œç¬¬ä¸€è¡Œ`rbx = rsp + 4`ï¼Œç¬¬äºŒè¡Œ`rbp = rsp + 0x18`ï¼Œä¿å­˜å¾ªç¯ç»“æŸä½ç½®(6ä¸ªæ•°ï¼Œæ¯ä¸ªæ•°4å­—èŠ‚ï¼Œå…±16+8=24å­—èŠ‚)ï¼Œå°†`M[rbx - 4]èµ‹å€¼ç»™eax`ï¼Œæ­¤æ—¶`eax`ä¿å­˜çš„å³ä¸ºè¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•° 1ï¼Œç„¶å`add eax, eax`æ˜¯`eax`ä¿å­˜çš„æ•°å˜ä¸ºåŸæ¥çš„äºŒå€ï¼Œæ¥ç€æ¯”è¾ƒ`eax`ä¿å­˜çš„å€¼ä¸å½“å‰å†…å­˜ä¸­`M[rbx]`æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰çš„è¯æ¥ä¸‹æ¥è®©`rbx + 4`(è¿™é‡Œçš„+4å…¶å®å°±å¯¹åº”æ•°ç»„å…ƒç´ çš„+1)ï¼Œçœ‹æ˜¯å¦æ»¡è¶³å¾ªç¯ç»ˆæ­¢æ¡ä»¶ï¼Œä¸æ»¡è¶³å°±è·³åˆ°ä¸Šé¢`phase_2+27`ç»§ç»­æ‰§è¡Œã€‚

![image-20221020220540839](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020220540.png)

åŠ¨æ€æ‰§è¡Œå®Œåå°±å¯ä»¥çœ‹åˆ°è¿‡æ‰äº†

![image-20221020223615620](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221020223615.png)

#### Phase3

> è€ƒå¯Ÿç‚¹ï¼šswitchè¯­å¥ï¼Œç´¢å¼•è¡¨çš„æ±‡ç¼–è¡¨ç¤º

    0000000000400f43 <phase_3>:
    400f43:       48 83 ec 18             sub    $0x18,%rsp					; é¦–å…ˆæå‡å †æ ˆ	
    400f47:       48 8d 4c 24 0c          lea    0xc(%rsp),%rcx				; rcx = rsp + 0xc
    400f4c:       48 8d 54 24 08          lea    0x8(%rsp),%rdx				; rdx = rsp + 0x8  ä¿å­˜çš„æ˜¯å‚æ•° 
    400f51:       be cf 25 40 00          mov    $0x4025cf,%esi 			; çŒœæµ‹è¿™é‡Œä¸ä¸Šé¢ä¸€æ · æ˜¯sscanfç”¨åˆ°çš„å‚æ•° %%
    400f56:       b8 00 00 00 00          mov    $0x0,%eax					; ç”¨ä½œè¿”å›å€¼
    400f5b:       e8 90 fc ff ff          callq  400bf0 <__isoc99_sscanf@plt> ;è¿™ä¸ªå‡½æ•°ä¸ä¸Šé¢çš„ä¸€æ ·ï¼Œå…ˆè¾“å…¥å­—ç¬¦ä¸²å†æ ¼å¼åŒ–
    400f60:       83 f8 01                cmp    $0x1,%eax					; ä¸Šé¢çš„å‡½æ•°è¿”å›å€¼
    400f63:       7f 05                   jg     400f6a <phase_3+0x27>		  ; 0x400f6a è·³è¿‡çˆ†ç‚¸çš„å‡½æ•°ï¼Œè¿”å›å€¼éœ€è¦å¤§äº1
    400f65:       e8 d0 04 00 00          callq  40143a <explode_bomb>		  
    400f6a:       83 7c 24 08 07          cmpl   $0x7,0x8(%rsp)				# rsp + 8å­˜å‚¨ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œrsp+cå­˜å‚¨ç¬¬äºŒä¸ª
    400f6f:       77 3c                   ja     400fad <phase_3+0x6a>;0x400fad ä¼šçˆ†ç‚¸ï¼Œæ‰€ä»¥rsp+8<7ï¼Œç”¨jaå½“a[0]<0æ˜¯ä¹Ÿno
    400f71:       8b 44 24 08             mov    0x8(%rsp),%eax				; eax = rsp + 8 < 7  å°†ç¬¬ä¸€ä¸ªæ•°å­˜åˆ°eax
    400f75:       ff 24 c5 70 24 40 00    jmpq   *0x402470(,%rax,8)			; è·³è½¬åˆ° M[0x402470+rax*8] å¤„å…¶å®å°±æ˜¯400fb9
    400f7c:       b8 cf 00 00 00          mov    $0xcf,%eax
    400f81:       eb 3b                   jmp    400fbe <phase_3+0x7b>
    400f83:       b8 c3 02 00 00          mov    $0x2c3,%eax
    400f88:       eb 34                   jmp    400fbe <phase_3+0x7b>
    400f8a:       b8 00 01 00 00          mov    $0x100,%eax
    400f8f:       eb 2d                   jmp    400fbe <phase_3+0x7b>
    400f91:       b8 85 01 00 00          mov    $0x185,%eax
    400f96:       eb 26                   jmp    400fbe <phase_3+0x7b>
    400f98:       b8 ce 00 00 00          mov    $0xce,%eax
    400f9d:       eb 1f                   jmp    400fbe <phase_3+0x7b>
    400f9f:       b8 aa 02 00 00          mov    $0x2aa,%eax
    400fa4:       eb 18                   jmp    400fbe <phase_3+0x7b>
    400fa6:       b8 47 01 00 00          mov    $0x147,%eax
    400fab:       eb 11                   jmp    400fbe <phase_3+0x7b>
    400fad:       e8 88 04 00 00          callq  40143a <explode_bomb>
    400fb2:       b8 00 00 00 00          mov    $0x0,%eax
    400fb7:       eb 05                   jmp    400fbe <phase_3+0x7b>
    400fb9:       b8 37 01 00 00          mov    $0x137,%eax  ; å¦‚æœ a[0]=1æ—¶ä¼šè·³è½¬åˆ°è¿™é‡Œ  eax=0x137
    400fbe:       3b 44 24 0c             cmp    0xc(%rsp),%eax ; æ¯”è¾ƒç¬¬äºŒä¸ªå‚æ•°ä¸eaxçš„å€¼æ˜¯å¦ç›¸åŒ ç›¸åŒçš„è¯å°±è¿‡äº†
    400fc2:       74 05                   je     400fc9 <phase_3+0x86>
    400fc4:       e8 71 04 00 00          callq  40143a <explode_bomb>
    400fc9:       48 83 c4 18             add    $0x18,%rsp
    400fcd:       c3                      retq
    

ä¸‹é¢åˆ©ç”¨`gdb`åŠ¨æ€è°ƒè¯•ï¼Œåœ¨è¿›å…¥`sscanf`å‡½æ•°ä¹‹å‰ï¼ŒæŸ¥çœ‹`0x4025cf`å¤„å­˜å‚¨çš„è¦ä¼ å…¥`sscanf`çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“`sscanf`è¿™æ¬¡è¦è¯»å–çš„æ˜¯ä¸¤ä¸ªæ•´æ•°ï¼Œä¸ç”¨è·Ÿè¿›å»çŒœæµ‹`sscanf`çš„ä½œç”¨å°±çŸ¥é“ï¼Œå®ƒå°†è¾“å…¥çš„æ ‡å‡†å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºäº†ä¸¤ä¸ªæ•´æ•°ï¼Œ

![image-20221021143641675](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021143648.png)

ä¸€æ­¥ä¸€æ­¥æ‰§è¡Œä¸‹å»ï¼ŒçŸ¥é“è¿›å…¥`sscanf`å‡½æ•°ä¹‹å‰ï¼Œå¯ä»¥çœ‹åˆ°ä¸è¯¥å‡½æ•°æœ‰å…³çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š

![image-20221021144749548](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021144749.png)

é€€å‡º`sscanf`å‡½æ•°åï¼Œå¯ä»¥æŸ¥çœ‹è¯¥å‡½æ•°å°†æ ¼å¼åŒ–åçš„æ•°å­—å­˜å‚¨åˆ°äº†å“ªé‡Œï¼Œå…¶ä¸­`0x7fffffffe3d0`ä¸ºæ ˆæŒ‡é’ˆ`rsp`çš„åœ°å€ï¼Œ`rsp + 4`å­˜å‚¨è¿”å›åœ°å€ï¼Œ`rsp + 8`å­˜å‚¨è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°ï¼Œ`rsp + c`å­˜æ”¾è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°ï¼Œ

![image-20221021145501463](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021145501.png)

    è¯»å–å †æ ˆçš„æ•°æ® --ä¸¤ç§æ–¹å¼  å…¥æ ˆ(edxä¸ºæ ˆé¡¶ï¼Œebxä¸ºæ ˆåº•) 
    1ã€baseåŠ åç§»  æ ˆåº•ä¸ºé«˜åœ°å€
    è¯»ç¬¬ä¸€ä¸ªå‹å…¥çš„æ•°æ®ï¼šmov esi,dword ptr ds:[ebx-4]
    è¯»ç¬¬å››ä¸ªå‹å…¥çš„æ•°æ®ï¼šmov esi,dword ptr ds:[ebx-0x10]
    2.topåŠ åç§»    æ ˆé¡¶ä¸ºä½åœ°å€
    è¯»ç¬¬äºŒä¸ªå‹å…¥çš„æ•°æ®ï¼šmov edi,dword ptr ds:[edx+8]    
    è¯»ç¬¬ä¸‰ä¸ªå‹å…¥çš„æ•°æ®ï¼šmov edi,dword ptr ds:[edx+4]
    

`rspå’Œrbp`å¯„å­˜å™¨ä¸ç”¨æˆ‘ä»¬æŒ‡å®šå†…å®¹ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨ç¡®å®šçš„ï¼Œæ¥ä¸‹æ¥æ˜¯æ¯”è¾ƒ`rsp + 8 å’Œ 0x7`çš„å¤§å°ï¼Œéœ€è¦æ»¡è¶³`rsp + 8 < 0x7`ï¼Œå³ç¬¬ä¸€ä¸ªå‚æ•°å°äº7ï¼Œ æ³¨æ„è¿™é‡Œçš„`ja`æŒ‡ä»¤å¯ä»¥åŒæ—¶å¤„ç†è¾“å…¥çš„`a[0] > 7`å’Œ`a[0] < 0`çš„æƒ…å†µï¼Œä¹‹åä¼šåšä¸€ä¸ªæ— æ¡ä»¶çš„`jmp *0x402470(,%rax,8)`ï¼Œæ ¹æ®`rax`çš„å€¼å»æ‰¾å¯¹åº”çš„è¯­å¥ï¼ŒçŒœæµ‹æ˜¯ä¸€ä¸ªä»¥`rax`ä¸ºç´¢å¼•çš„ç´¢å¼•è¡¨ï¼Œç±»æ¯”`switch`è¯­å¥ï¼Œå¯¹äºæˆ‘ä»¬è¾“å…¥çš„æ¯ä¸€å¯¹æ•°ï¼Œéƒ½ä¼šæ ¹æ®ç¬¬ä¸€ä¸ªæ•°çš„å€¼å»ç¡®å®šç¬¬äºŒä¸ªæ•°çš„å€¼ã€‚æŸ¥çœ‹ä»¥åœ°å€`0x402470`ä¸ºåŸºå€çš„ç´¢å¼•è¡¨çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬è¾“å…¥çš„æ˜¯1ï¼Œæ‰€ä»¥å–`0x400fb9`çš„åœ°å€å¯»æ‰¾

![image-20221021151450464](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021151450.png)

å½“æˆ‘ä»¬è·³è½¬åˆ°æŒ‡å®šåœ°å€åå¯ä»¥çœ‹åˆ°ï¼ˆè¿™é‡Œè¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º1ï¼‰ï¼Œå°†`eax`èµ‹å€¼ä¸º`0x137`ï¼Œç„¶åæ¯”è¾ƒæˆ‘ä»¬è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°ä¸è¿™ä¸ªæ•°æ˜¯å¦ç›¸ç­‰ï¼Œå³æˆ‘ä»¬å¯ä»¥è¾“å…¥çš„æœ‰1 311æˆ–è€…å…¶ä»–å…­ç§å…¶ä»–çš„æ•°ã€‚

![image-20221021151834957](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021151835.png)

å¯¹åº”çš„Cå½¢å¼çš„ä¼ªä»£ç å°±å¦‚ä¸‹æ‰€ç¤ºï¼š

    void phase_3(char* output)
    {
        int x, y;
        if(sscanf(output, "%d %d", &x, &y) <= 1)
            explode_bomb();
        if(x > 7)
            explode_bomb();
        int num;
        switch(x) {
        case 0:
            num = 207;
        	break;
        case 1:
            num = 311;
            break;
        case 2:
            num = 707;
            break;
        case 3:
            num = 256;
            break;
        case 4:
            num = 389;
            break;
        case 5:
            num = 206;
            break;
        case 6:
            num = 682;
    		break;
        case 7:
            num = 327;
        }
        if (num != y)
            explode_bomb();
        return;
    }
    

#### Phase4

> è€ƒå¯Ÿç‚¹ï¼šé€’å½’å‡½æ•°çš„å‚æ•°åŠè¿”å›å€¼

    000000000040100c <phase_4>:
    40100c:       48 83 ec 18             sub    $0x18,%rsp
    401010:       48 8d 4c 24 0c          lea    0xc(%rsp),%rcx
    401015:       48 8d 54 24 08          lea    0x8(%rsp),%rdx
    40101a:       be cf 25 40 00          mov    $0x4025cf,%esi
    40101f:       b8 00 00 00 00          mov    $0x0,%eax
    401024:       e8 c7 fb ff ff          callq  400bf0 <__isoc99_sscanf@plt>  # åŒæ ·è°ƒç”¨äº†sscanfè¿™ä¸ªå‡½æ•°
    401029:       83 f8 02                cmp    $0x2,%eax		# å¦‚æœä¸Šé¢å‡½æ•°çš„è¿”å›å€¼ä¸2ä¸ç›¸ç­‰çš„è¯å°±bombäº†
    40102c:       75 07                   jne    401035 <phase_4+0x29>  # è·³åˆ° 0x401035 å³bombå‡½æ•°
    40102e:       83 7c 24 08 0e          cmpl   $0xe,0x8(%rsp)		# è¿™é‡Œéœ€è¦æ»¡è¶³ M[rsp+8] <= 0xe è¿™æ ·æ‰èƒ½è·³è¿‡bomb
    401033:       76 05                   jbe    40103a <phase_4+0x2e>  # jbeæ˜¯å°äºç­‰äº 
    401035:       e8 00 04 00 00          callq  40143a <explode_bomb>
    40103a:       ba 0e 00 00 00          mov    $0xe,%edx   # edx = 0xe   ä¸‹é¢ä¸‰è¡Œåº”è¯¥éƒ½æ˜¯ func4å‡½æ•°çš„å‚æ•°
    40103f:       be 00 00 00 00          mov    $0x0,%esi   # esi = 0x0
    401044:       8b 7c 24 08             mov    0x8(%rsp),%edi # edi = a[0](æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼)
    401048:       e8 81 ff ff ff          callq  400fce <func4> # è¿™é‡Œåˆè°ƒç”¨äº†ä¸€ä¸ªå‡½æ•°
    40104d:       85 c0                   test   %eax,%eax		# åˆ¤æ–­ eax æ˜¯å¦ä¸º0ï¼Œå³func4å‡½æ•°çš„è¿”å›å€¼æ˜¯å¦ä¸º0
    40104f:       75 07                   jne    401058 <phase_4+0x4c> # å¦‚æœä¸ä¸º0çš„è¯è·³è½¬åˆ° bombï¼Œæ‰€ä»¥éœ€è¦ä½¿eaxä¸º0
    401051:       83 7c 24 0c 00          cmpl   $0x0,0xc(%rsp)  # æ¯”è¾ƒè¾“å…¥çš„ç¬¬äºŒä¸ªæ•°å’Œ0æ˜¯å¦ç›¸ç­‰  ä¸ç›¸ç­‰ä¼šbomb
    401056:       74 05                   je     40105d <phase_4+0x51>
    401058:       e8 dd 03 00 00          callq  40143a <explode_bomb>
    40105d:       48 83 c4 18             add    $0x18,%rsp
    401061:       c3                      retq
    
    ; func4å‡½æ•°
    0000000000400fce <func4>:
    400fce:       48 83 ec 08             sub    $0x8,%rsp   # æ ˆç©ºé—´æ‰©å¤§8ä¸ªå­—èŠ‚ è¿™é‡Œçš„ 0x1å°±ä»£è¡¨åœ°å€ç©ºé—´å¯ä»¥å¤šå­˜å‚¨ä¸€ä¸ªå­—èŠ‚
    400fd2:       89 d0                   mov    %edx,%eax   # eaxä½œä¸ºsscanfçš„è¿”å›å€¼ä¸€ç›´æ²¡æœ‰ä¿®æ”¹  edxä¸ºç¬¬ä¸‰ä¸ªå‚æ•°0xe
    400fd4:       29 f0                   sub    %esi,%eax   # eax = eax - esi = 0xe - 0 = 0xe
    400fd6:       89 c1                   mov    %eax,%ecx   # ecx = eax = 0xe
    400fd8:       c1 e9 1f                shr    $0x1f,%ecx  # shré€»è¾‘å³ç§»æŒ‡ä»¤ ecx = ecx >> 0x1f = 0
    400fdb:       01 c8                   add    %ecx,%eax   # eax = eax + ecx = 0xe
    400fdd:       d1 f8                   sar    %eax  # sar ç®—æœ¯å³ç§»æŒ‡ä»¤ çœç•¥äº†ä¸€ä¸ªæ“ä½œæ•°  gdbä¸­æ˜¾ç¤ºä¸º 1 1110>> 1 =111=7
    åˆ°è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºç«¯å€ªäº†ï¼šeax = (eax + eax >> 0x1f) >> 1   å…¶ä¸­ eax = edx - esi = 0xe
    400fdf:       8d 0c 30                lea    (%rax,%rsi,1),%ecx # ecx = rax + rsi * 1 = 7 + 0 = 7
    400fe2:       39 f9                   cmp    %edi,%ecx   # å°†æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ 7 æ¯”è¾ƒ
    400fe4:       7e 0c                   jle    400ff2 <func4+0x24> # å¦‚æœ7 <= a[0] è·³è½¬åˆ° 0x400ff2 æ‰§è¡Œ
    400fe6:       8d 51 ff                lea    -0x1(%rcx),%edx # å¦åˆ™ a[0] < 7  edx = rcx - 1 = 6
    400fe9:       e8 e0 ff ff ff          callq  400fce <func4>  # é€’å½’è°ƒç”¨ func4 å‡½æ•°
    400fee:       01 c0                   add    %eax,%eax		# 2 * func()
    400ff0:       eb 15                   jmp    401007 <func4+0x39>
    400ff2:       b8 00 00 00 00          mov    $0x0,%eax  # eax = 0
    400ff7:       39 f9                   cmp    %edi,%ecx  # if(ecx(7) >= edi(a[0])) goto 401007; else func4();
    400ff9:       7d 0c                   jge    401007 <func4+0x39>
    400ffb:       8d 71 01                lea    0x1(%rcx),%esi
    400ffe:       e8 cb ff ff ff          callq  400fce <func4> # è¿™é‡Œå¦‚æœ a[0] > 7çš„è¯ä¹Ÿä¼šè¿›è¡Œé€’å½’  a[0] = 7å°±æ˜¯è¾¹ç•Œæ¡ä»¶
    401003:       8d 44 00 01             lea    0x1(%rax,%rax,1),%eax  # eax = rax + rax + 1 é€’å½’è°ƒç”¨
    401007:       48 83 c4 08             add    $0x8,%rsp
    40100b:       c3                      retq
    é€’å½’å‡½æ•°å…¶å®å°±æ˜¯
    int func(int x, int a, int b)  (edi esi edx)
    {
    	int c = b - a;(cå­˜å‚¨åœ¨ ecx   båœ¨edxé‡Œ)
    	c = (c + c >> 31) >> 1;  è¿™é‡Œcåˆå­˜å‚¨åˆ°äº† eax é‡Œ
    	int d = c + a; (rax + rsi(ç”¨æ¥ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°))  d å­˜å‚¨åœ¨ ecx
    	if (d <= x)  goto 0x400ff2
    	{
    		if (d >= x) return 0;
    		; é€’å½’è°ƒç”¨ æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°å˜äº†  lea  0x1(%rcx),%esi  esi = d + 1
    		return 2 * func4(x, d + 1, b) + 1
    	}
    	goto 0x400fe6  lea  -0x1(%rcx),%edx  b = b - 1
    	return 2 * func(x, a, b - 1);  åªæœ‰ç¬¬ä¸‰ä¸ªå‚æ•°å˜äº†  åˆ«çš„éƒ½æ²¡å˜
    }
    

ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œè¾“å…¥çš„ç¬¬äºŒä¸ªæ•°ä¸€å®šä¸º0ï¼Œç¬¬ä¸€ä¸ªæ•°ä½œä¸º`func4`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è¿›è¡Œäº†è¿ç®—ï¼Œéœ€è¦æ»¡è¶³`func4`å‡½æ•°çš„è¿”å›å€¼ä¸º0ã€‚ä¸‹é¢åˆ©ç”¨`gdb`åŠ¨æ€è°ƒè¯•ï¼Œå¯ä»¥çœ‹åˆ°åœ°å€`0x4025cf`å¤„å­˜å‚¨çš„æ˜¯`% %`ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦è¾“å…¥çš„å‚æ•°ä¸ªæ•°æ˜¯ä¸¤ä¸ª

![image-20221021184432913](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021184432.png)

ç”±ä¸Šé¢æ±‡ç¼–çš„åˆ†æå¯çŸ¥ï¼Œæˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å°äºç­‰äº14ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸€å®šä¸º0ã€‚æ‰§è¡Œåˆ°è°ƒç”¨`func4`å‡½æ•°æ—¶ç•Œé¢å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°`func4`å‡½æ•°æœ‰å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°ã€‚åˆ†æå¯çŸ¥ï¼Œ`func4`å‡½æ•°æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œé€’å½’ç»ˆæ­¢æ¡ä»¶ä¸º `a[0] >=7`ï¼Œä¸”ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªåˆ¤æ–­å¦‚æœ`a[0] > 7`ä¹Ÿä¼šé€’å½’è°ƒç”¨å‡½æ•°`func4`ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¤ç¬¬ä¸€ä¸ªå‚æ•°ä¸º7å³å¯ï¼Œå¦‚ç¬¬äºŒå¼ å›¾ã€‚

![image-20221021185851957](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021185852.png)

![image-20221021192523619](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221021192523.png)

ä»”ç»†åˆ†æåå¯ä»¥å¾—çŸ¥ï¼Œ`func4`å‡½æ•°è¿™ä¸ªé€’å½’å‡½æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º

    int func4(int x, int a, int b)
    {
        int num = b - a;
        num = (num + num >> 31) / 2;  // 31å°±æ˜¯ 0x1f
        int c = num + a;
        if (c <= x) {
        	if (c >= x) return 0;
            return 2 * func4(x, num+1, b) + 1;
        }
        return 2 * func4(x, a, num-1);
    }
    

#### Phase5

> è€ƒå¯Ÿç‚¹ï¼šå­—ç¬¦æ•°ç»„ï¼Œå¾ªç¯ï¼ŒASCIIï¼Œä¸è¿ç®—

    0000000000401062 <phase_5>:
    401062:       53                      push   %rbx
    401063:       48 83 ec 20             sub    $0x20,%rsp		# å¼€è¾Ÿ 32 å­—èŠ‚çš„æ ˆç©ºé—´
    401067:       48 89 fb                mov    %rdi,%rbx		# rbx = rsi
    40106a:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax	# %fs:0x28ä¿å­˜çš„æ˜¯ è¾“å…¥çš„å€¼ 
    401071:       00 00
    401073:       48 89 44 24 18          mov    %rax,0x18(%rsp) # rsp + 0x18 = rax(å­˜æ”¾çš„æ˜¯æˆ‘ä»¬è¾“å…¥çš„å‚æ•°)
    401078:       31 c0                   xor    %eax,%eax	# eax = 0
    40107a:       e8 9c 02 00 00          callq  40131b <string_length> # è·å–è¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦(åŒ…æ‹¬ç©ºæ ¼)
    40107f:       83 f8 06                cmp    $0x6,%eax	# å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²é•¿åº¦ä¸ä¸º6  ä¼šçˆ†ç‚¸
    401082:       74 4e                   je     4010d2 <phase_5+0x70> # è·³è½¬åˆ° 0x4010d2
    401084:       e8 b1 03 00 00          callq  40143a <explode_bomb>
    401089:       eb 47                   jmp    4010d2 <phase_5+0x70>
    ; ä¸‹é¢è¿™æ®µæŒ‡ä»¤çš„å«ä¹‰ï¼šéå†è¾“å…¥å­—ç¬¦ä¸²çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åé€æ¬¡å°†æ¯ä¸ªå­—ç¬¦ä¸0xfä¸æ“ä½œï¼Œå¾—åˆ°çš„å€¼åšä¸º0x4024b0å¤„å­—ç¬¦ä¸²çš„ä¸‹æ ‡
    40108b:       0f b6 0c 03             movzbl (%rbx,%rax,1),%ecx # movzblé›¶æ‰©å±•æŒ‡ä»¤ move zero byte to double word
    ; raxæ­¤æ—¶ä¸º0  ecx = rax + rbx (é›¶æ‰©å±•åå†ä¼ é€)  ä¸€èˆ¬ç”¨äºä½¿ç”¨å°å­—èŠ‚å˜é‡ç»™å¤§å­—èŠ‚å˜é‡èµ‹å€¼
    40108f:       88 0c 24                mov    %cl,(%rsp)  # M[rsp] = cl(ecxçš„ä½8ä½) = 0x31(1çš„ASCIIç )
    401092:       48 8b 14 24             mov    (%rsp),%rdx # rdx = M[rsp] = 0x31
    401096:       83 e2 0f                and    $0xf,%edx   # edx = edx & 1111 = 110001 & 1111 = 1
    401099:       0f b6 92 b0 24 40 00    movzbl 0x4024b0(%rdx),%edx # edx = M[rdx + 0x4024b0] æ ¹æ®ä¸Šé¢ä¸çš„ç»“æœå»å†…å­˜å¯»æ‰¾
    4010a0:       88 54 04 10             mov    %dl,0x10(%rsp,%rax,1) # å°†edxçš„ç¬¬å…«ä½å­˜åˆ°åé¢æŒ‡å®šçš„å†…å­˜åœ°å€
    4010a4:       48 83 c0 01             add    $0x1,%rax	# rax = rax + 1
    4010a8:       48 83 f8 06             cmp    $0x6,%rax  # if(rax!=6) goto 40108b; else goto 4010ae  éœ€è¦æ‰§è¡Œ6æ¬¡
    4010ac:       75 dd                   jne    40108b <phase_5+0x29> # å›åˆ°ä¸Šé¢ç»§ç»­å¾ªç¯
    4010ae:       c6 44 24 16 00          movb   $0x0,0x16(%rsp) # 6æ¬¡å¾ªç¯ç»“æŸå  æ‰§è¡Œåˆ°è¿™é‡Œ M[rsp+0x16] = 0
    4010b3:       be 5e 24 40 00          mov    $0x40245e,%esi  # å‡½æ•°çš„å‚æ•°
    4010b8:       48 8d 7c 24 10          lea    0x10(%rsp),%rdi
    4010bd:       e8 76 02 00 00          callq  401338 <strings_not_equal>
    4010c2:       85 c0                   test   %eax,%eax
    4010c4:       74 13                   je     4010d9 <phase_5+0x77>
    4010c6:       e8 6f 03 00 00          callq  40143a <explode_bomb>
    4010cb:       0f 1f 44 00 00          nopl   0x0(%rax,%rax,1)
    4010d0:       eb 07                   jmp    4010d9 <phase_5+0x77>
    4010d2:       b8 00 00 00 00          mov    $0x0,%eax  # eax = 0
    4010d7:       eb b2                   jmp    40108b <phase_5+0x29> # åˆè·³è½¬åˆ°ä¸Šé¢äº†
    4010d9:       48 8b 44 24 18          mov    0x18(%rsp),%rax
    4010de:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax
    4010e5:       00 00
    4010e7:       74 05                   je     4010ee <phase_5+0x8c>
    4010e9:       e8 42 fa ff ff          callq  400b30 <__stack_chk_fail@plt>
    4010ee:       48 83 c4 20             add    $0x20,%rsp
    4010f2:       5b                      pop    %rbx
    4010f3:       c3                      retq
    

æ‰“å¼€`gdb`è¿›è¡ŒåŠ¨æ€è°ƒè¯•ï¼Œé¦–å…ˆçœ‹åˆ°æˆ‘ä»¬è¾“å…¥çš„é•¿åº¦ä¸º6çš„å­—ç¬¦ä¸²å¦‚ä¸‹æ‰€ç¤º

![image-20221022085546280](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022085553.png)

å‰é¢çš„æŒ‡ä»¤éƒ½å¾ˆç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹`movzbl`è¿™æ¡æŒ‡ä»¤ï¼Œæ˜¯ä¸€ä¸ªå¸¦é›¶æ‰©å±•çš„æ•°æ®ä¼ é€æŒ‡ä»¤ï¼Œåœ¨`gdb`ä¸­æŸ¥çœ‹è¯¥æŒ‡ä»¤æ˜¯å¦‚ä¸‹å½¢å¼ï¼Œæ˜ç¡®ç»™å‡ºäº†`byte`ç±»å‹ï¼Œæ­¤æ—¶`rax = 0`ï¼Œ`rbx = 0x6038c0(æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²çš„åœ°å€)`ï¼Œæ‰§è¡Œå®Œè¿™æ¡æŒ‡ä»¤å`rcx = 0x31 = 49(1çš„ASCIIç )`ï¼Œ

![image-20221022090910626](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022090910.png)

å¯ä»¥çœ‹åˆ°`0x6038c0`å¤„å­˜å‚¨çš„å†…å®¹å¦‚ä¸‹ï¼Œå­˜å‚¨çš„æ˜¯æˆ‘ä»¬è¾“å…¥çš„`123456`çš„ASCIIç ï¼Œ

![image-20221022091517491](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022091517.png)

è¿™é‡Œè¿˜å‘ç°äº†`python`ä¸­å¯¹å˜é‡åš`and`è¿ç®—æ—¶çš„ä¸€äº›æœ‰æ„æ€çš„ç‚¹ï¼Œ`python`ä¸­æ‰€æœ‰å˜é‡çš„ä½æ“ä½œéƒ½æ˜¯é€šè¿‡å¼ºåˆ¶è½¬æ¢æˆ`bool`å®ç°çš„ï¼Œä¸¥æ ¼éµå¾ªçŸ­è·¯é€»è¾‘ï¼Œåªæœ‰`and`ï¼Œå¦‚æœæ¯ä¸ªè¡¨è¾¾å¼éƒ½ä¸ä¸ºå‡ï¼Œè¿”å›ç¬¬äºŒä¸ªï¼Œåªæœ‰`or`ï¼Œä»å·¦å¾€å³æœ‰ä¸€ä¸ªä¸ä¸ºå‡å°±è¿”å›è¿™ä¸ªå€¼ã€‚

![image-20221022092546230](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022092546.png)

ä¸‹ä¸€æ¡æŒ‡ä»¤`mov %cl,(%rsp)`æ˜¯å°†`ecx`å¯„å­˜å™¨çš„ä½å…«ä½èµ‹å€¼ç»™`M[rsp]`ï¼Œå­˜æ”¾åˆ°æ ˆæŒ‡é’ˆæŒ‡å‘çš„åœ°å€ï¼Œ`0x7f`å¼€å¤´çš„å¾€å¾€å°±æ˜¯æ ˆæ‰€åœ¨åœ°å€

![image-20221022092742223](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022092742.png)

ä¸­é—´ç»è¿‡ä¸€äº›å¤„ç†åæ­¤æ—¶`rdx = 49 & 0xf = 1`ï¼Œç„¶ååˆæ˜¯ä¸€æ¡é›¶æ‰©å±•æŒ‡ä»¤`movzbl 0x4024b0(%rdx),%edx`ï¼Œæ ¹æ®ä¸Šé¢ç›¸ä¸çš„ç»“æœå–å†…å­˜ä¸­å¯»æ‰¾å¯¹åº”çš„å€¼èµ‹å€¼ç»™`edx`ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯`0x61`ï¼Œå¯ä»¥çœ‹åˆ°å†…å­˜ä¸­å­˜å‚¨çš„å­—ç¬¦ä¸²ä¸ºä¸‹é¢çš„`maduiersnfotvbyl`

![image-20221022093111895](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022093111.png)

![image-20221022094539847](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022094539.png)

æ¥ä¸‹æ¥`gdb`ä¸­çš„æŒ‡ä»¤æ›´å®¹æ˜“ç†è§£ï¼Œ`mov byte ptr [rsp + rax + 0x10], dl`ï¼Œå°†`0x61`å­˜å‚¨åˆ°`rsp+0x10`å¼€å§‹çš„å†…å­˜åœ°å€ï¼ˆ**å³å­˜å‚¨å˜åŒ–åçš„å­—ç¬¦åˆ°ä¸€ä¸ªæ ˆä¸­æ–°å¼€è¾Ÿçš„å­—ç¬¦æ•°ç»„é‡Œ**ï¼‰ï¼Œ`rax`æ­¤æ—¶ä»ä¸º0ï¼Œå…ˆæŸ¥çœ‹æœªæ‰§è¡Œå‰ï¼Œè¯¥åœ°å€å­˜å‚¨çš„æ•°ä¸ºï¼š`0x10`ï¼Œæ‰§è¡Œä¹‹åå°±å˜æˆäº†äº†`0x61`ï¼Œ

![image-20221022093507081](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022093507.png)

ä¸‹é¢é¦–å…ˆ`rax = rax + 1`ï¼Œç„¶ååˆ¤æ–­`rax != 6`çš„è¯å›åˆ°ä¸Šé¢å¾ªç¯ä¹‹å‰çš„æ“ä½œï¼Œå¯çŸ¥è¿™é‡Œæ˜¯ä¸€ä¸ª6æ¬¡çš„å¾ªç¯ï¼Œä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œ`rbx`å­˜å‚¨çš„è¿˜æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²çš„åœ°å€ï¼Œä½†æ˜¯`rax`å°±å˜æˆ1äº†ï¼Œå–åˆ°çš„å­—ç¬¦ç”±ä¹‹å‰çš„`0x31`å˜ä¸ºäº†`0x32`ï¼Œç›´åˆ°éå†å®Œ6ä¸ªé•¿åº¦çš„å­—ç¬¦ä¸²

![image-20221022093726972](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022093727.png)

æ€»ç»“ä¸€ä¸‹ï¼Œè¿™ä¸€æ®µå¾ªç¯çš„æ„ä¹‰æ˜¯éå†è¾“å…¥çš„æ¯ä¸€ä¸ªå­—ç¬¦ï¼Œå°†æ¯ä¸€ä¸ªå­—ç¬¦çš„ASCIIç ä¸`0xf`ç›¸ä¸ï¼Œä¸åçš„ç»“æœä½œä¸ºç´¢å¼•å»æŒ‡å®šå†…å­˜åœ°å€`0x4024b0`å¤„æ‰¾å¯¹åº”çš„å­—ç¬¦å­˜å‚¨èµ·æ¥ã€‚å¾ªç¯ç»“æŸåï¼Œæˆ‘ä»¬å†å¾€ä¸‹çœ‹ï¼Œä¸‹é¢å°±æ˜¯ä¼ é€’å‚æ•°ï¼Œç„¶åè°ƒç”¨äº†`strings_not_equal`è¿™ä¸ªå‡½æ•°

![](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022100044.png)

è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²çš„æ¯ä¸€ä¸ªå­—ç¬¦ä¸ä¸Š`0xf`åä½œä¸ºç´¢å¼•å»å†…å­˜ä¸­æ‰¾åˆ°çš„`maduiersnfotvbyl`è¿™ä¸ªå­—ç¬¦ä¸²çš„å­ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå†…å­˜ä¸­å­˜å‚¨çš„æ­£ç¡®ç»“æœ`flyers`ï¼Œæ˜¾ç„¶æˆ‘ä»¬éœ€è¦è®©è¿™ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸ç­‰ï¼Œè¿™æ ·è¿™ä¸ªå‡½æ•°æ‰ä¼šè¿”å›0ï¼Œæ‰ä¼šè·³è¿‡ä¸‹é¢çš„`explode_bomb`ä¸‹é¢è¦åšçš„å°±å¾ˆæ¸…æ™°äº†ï¼Œæ‰¾åˆ°æ‰€æœ‰ä¸ä¸Š`0xf`åçš„ç´¢å¼•ä¸º`flyers`åœ¨`0x4024b0`ä¸ºèµ·å§‹åœ°å€çš„ç´¢å¼•è¡¨ä¸­çš„ä½ç½®å³å¯ï¼Œç´¢å¼•ä¾æ¬¡ä¸º`9 15 14 5 6 7`ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Š`0xf`åä¸ºä»¥ä¸Šç´¢å¼•çš„å­—ç¬¦ï¼Œ`x & 1111 = 1001 x = 1001001æˆ–è€…111001æˆ–è€…1111001`ï¼Œå¯ä»¥çœ‹å‡ºåå››ä½å³ä¸ºç´¢å¼•ï¼Œæˆ‘ä»¬å…ˆå°è¯•ç¬¬ä¸€ä¸ª`1001001(73)`ï¼Œå¯¹åº”çš„è¾“å…¥ä¸º`IONEFG`ï¼Œç¬¬äºŒç§ï¼Œå¯¹åº”çš„è¾“å…¥ä¸º`9?>567`ï¼Œç¬¬ä¸‰ç§è¾“å…¥`y(112+15=127)`ä¸æ˜¯å¯æ‰“å°å­—ç¬¦ã€‚

å› æ­¤ï¼Œå…³é”®æ­¥éª¤ç”¨Cè¯­è¨€æ¥å†™å°±æ˜¯

    const char g_str[16] = "maduiersnfotvbyl";
    void phase_5(char* input)
    {
        char str[7];
    	if (string_length(input) != 6) {
    		explode_bomb();
    	}
             // x & 0xf =  9 15 14 5 6 7
        	// I O N E F G æˆ– 9 ? > 5 6 7
    	for (int i = 0; i != 6; i++) {
            str[i] = g_str[input[i] & 0xf];
    	}
        str[7] = '\0';
        if(string_not_equal(str, "flyers") != 0) {
            explode_bomb();
        }
    }
    

è‡³æ­¤ï¼Œç¬¬äº”å…³ä¹Ÿå°±è¿‡äº†

![image-20221022102306862](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022102306.png)

#### Phase6

> è€ƒå¯Ÿç‚¹ï¼šå¤šé‡å¾ªç¯ï¼Œé“¾è¡¨ï¼Œç»“æ„ä½“ï¼Œ`eax`æ¯”è¾ƒæ•°å€¼æ—¶åªä¼šæ¯”è¾ƒä½32ä½ï¼Œå†—é•¿çš„æ±‡ç¼–

    00000000004010f4 <phase_6>:
    4010f4:       41 56                   push   %r14		
    4010f6:       41 55                   push   %r13
    4010f8:       41 54                   push   %r12
    4010fa:       55                      push   %rbp
    4010fb:       53                      push   %rbx
    ; ä¼ å…¥å‚æ•°  ä¸ºread_six_numbersåšå‡†å¤‡
    4010fc:       48 83 ec 50             sub    $0x50,%rsp  # æä¾›80å­—èŠ‚çš„æ ˆç©ºé—´
    401100:       49 89 e5                mov    %rsp,%r13   # r13 = rsp
    401103:       48 89 e6                mov    %rsp,%rsi   # rsi = rsp  ç¬¬äºŒä¸ªå‚æ•°
    401106:       e8 51 03 00 00          callq  40145c <read_six_numbers> # è¯»å–å…­ä¸ªæ•°å­—ï¼Œè¿™ä¸ªå‡½æ•°åœ¨ p2 è§è¿‡
    40110b:       49 89 e6                mov    %rsp,%r14  # r14 = rsp æ­¤æ—¶rspæ ¹è¿›å»ä¹‹å‰å…¶å®è¿˜æ˜¯ä¸€æ ·çš„  æ‰€ä»¥r14=r13
    40110e:       41 bc 00 00 00 00       mov    $0x0,%r12d # r12d = 0
    401114:       4c 89 ed                mov    %r13,%rbp  # rbp = r13 = rsp
    401117:       41 8b 45 00             mov    0x0(%r13),%eax # eax = M[r13] = M[rsp]  M[rsp]=0x200000001 å› ä¸ºeaxä¸º32ä½å¯„å­˜å™¨ï¼Œåªèƒ½å­˜å‚¨ä¸‹æ¥ 0x200000001 çš„ä½4å­—èŠ‚ å³ 00000001  æ‰€ä»¥æ­¤æ—¶ eax = 0x1
    40111b:       83 e8 01                sub    $0x1,%eax # eax = eax - 1
    40111e:       83 f8 05                cmp    $0x5,%eax # eaxéœ€è¦ < 5
    401121:       76 05                   jbe    401128 <phase_6+0x34>
    401123:       e8 12 03 00 00          callq  40143a <explode_bomb>
    401128:       41 83 c4 01             add    $0x1,%r12d # r12d += 1  æ¯æ¬¡å¾ªç¯åŠ 1
    40112c:       41 83 fc 06             cmp    $0x6,%r12d # å¾ªç¯ç»ˆæ­¢æ¡ä»¶ r12d = 6
    401130:       74 21                   je     401153 <phase_6+0x5f>
    401132:       44 89 e3                mov    %r12d,%ebx # rbx = r12d  å¾ªç¯å˜é‡æš‚å­˜åˆ°rbxä¸­
    401135:       48 63 c3                movslq %ebx,%rax # ç¬¦å·ä½æ‰©å±•,l->q å­—åˆ°åŒå­—ï¼Œ rax = ebx(ç¬¦å·ä½æ‰©å±•) æ­£æ•°ç”¨0
    401138:       8b 04 84                mov    (%rsp,%rax,4),%eax
    40113b:       39 45 00                cmp    %eax,0x0(%rbp)  
    40113e:       75 05                   jne    401145 <phase_6+0x51>  # *rbp ä¸èƒ½ç­‰äº eax
    401140:       e8 f5 02 00 00          callq  40143a <explode_bomb>
    401145:       83 c3 01                add    $0x1,%ebx
    401148:       83 fb 05                cmp    $0x5,%ebx
    40114b:       7e e8                   jle    401135 <phase_6+0x41>  # ebx <= 5 ç»§ç»­å¾ªç¯
    40114d:       49 83 c5 04             add    $0x4,%r13
    401151:       eb c1                   jmp    401114 <phase_6+0x20>
    ; ä¸Šé¢æ˜¯ä¸€ä¸ªå¾ªç¯
    phase_6(rdi)  ; æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ä¼ å…¥åˆ° rdi ä¸­
    {
    	r13 = rsp;
    	rsi = rsp;
    	read_six_numbers(rdi, rsi);  rdi ä¸ºæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œ  rsiä¸º %%%%%%
    	r14 = rsp;
    	for (r12 = 0  r12 != 6  r12++) 
    	{
    		rbp = r13;
    		eax = *r13;  å»å†…å­˜ä¸­æ‰¾
    		eax -= 1;
    		if (eax > 5)
    			explode_bomb();
    		for (ebx = r12 + 1  ebx <= 5  ebx++)
    		{
    			rax = ebx;  ç¬¦å·ä½æ‰©å±•  e->r  ebxä¸ºæ­£æ•°ç”¨0å¡«å……é«˜ä½   ä¸ºè´Ÿæ•°ç”¨1å¡«å……é«˜ä½
    			eax = *(rsp + rax * 44);
    			if (*rbp == eax)
    				explode_bomb();
    		}
    		r13 += 4;
    	}
    }
    401153:       48 8d 74 24 18          lea    0x18(%rsp),%rsi
    401158:       4c 89 f0                mov    %r14,%rax
    40115b:       b9 07 00 00 00          mov    $0x7,%ecx
    401160:       89 ca                   mov    %ecx,%edx
    401162:       2b 10                   sub    (%rax),%edx
    401164:       89 10                   mov    %edx,(%rax)
    401166:       48 83 c0 04             add    $0x4,%rax
    40116a:       48 39 f0                cmp    %rsi,%rax  # rax != rsi çš„è¯ç»§ç»­å¾ªç¯
    40116d:       75 f1                   jne    401160 <phase_6+0x6c>
    ; è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªå¾ªç¯  å•ç‹¬å†™åœ¨è¿™é‡Œ  
    rsi = rsp + 0x18;
    rax = r14;
    ecx = 0x7;
    for (rax = r14  rax != rsi  rax += 4)
    {
    	edx = ecx;
    	edx = edx - *rax;
    	*rax = edx;
    }
    40116f:       be 00 00 00 00          mov    $0x0,%esi
    401174:       eb 21                   jmp    401197 <phase_6+0xa3>
    401176:       48 8b 52 08             mov    0x8(%rdx),%rdx
    40117a:       83 c0 01                add    $0x1,%eax
    40117d:       39 c8                   cmp    %ecx,%eax
    40117f:       75 f5                   jne    401176 <phase_6+0x82>
    401181:       eb 05                   jmp    401188 <phase_6+0x94>
    401183:       ba d0 32 60 00          mov    $0x6032d0,%edx # ebx = 0x6032d0
    401188:       48 89 54 74 20          mov    %rdx,0x20(%rsp,%rsi,2) # *(rsp + rsi*2) = rdx
    40118d:       48 83 c6 04             add    $0x4,%rsi  # rsi += 4
    401191:       48 83 fe 18             cmp    $0x18,%rsi 
    401195:       74 14                   je     4011ab <phase_6+0xb7> # rsi = 0x18çš„è¯ å°±è·³åˆ°ä¸‹é¢äº†
    ;	å› ä¸ºè¿™æ˜¯æœ€å¤–å±‚å¼€å§‹çš„å¾ªç¯  æ‰€ä»¥ä¹Ÿå¯ä»¥é€šè¿‡è¿™æ¡è¯­å¥è·³è½¬åˆ°çš„åœ°å€ç¡®å®šæœ¬æ¬¡å¾ªç¯çš„å±‚æ•°ï¼Œå³æœ€å†…å±‚å¾ªç¯çš„è¯­å¥åœ¨å“ªé‡Œç»“æŸ
    401197:       8b 0c 34                mov    (%rsp,%rsi,1),%ecx
    40119a:       83 f9 01                cmp    $0x1,%ecx  # ecx <= 1
    40119d:       7e e4                   jle    401183 <phase_6+0x8f>
    40119f:       b8 01 00 00 00          mov    $0x1,%eax
    4011a4:       ba d0 32 60 00          mov    $0x6032d0,%edx
    4011a9:       eb cb                   jmp    401176 <phase_6+0x82>
    ; å°tips  æ€ä¹ˆçœ‹å¾ªç¯åˆ°å“ªé‡Œç»“æŸå‘¢    æ‰¾ä¸‹é¢æœ€è¿œçš„è·³åˆ°ä¸Šé¢çš„æŒ‡ä»¤å¾€å¾€å°±æ˜¯æœ€å†…å±‚å¾ªç¯
    for (esi = 0  rsi != 0x18  rsi += 4)
    {
    	ecx = *(rsp + rsi);
    	if (ecx <= 1)
    	{
    		edx = 0x6032d0;
    		*(rsp + rsi * 2 + 0x20) = rdx;  è¿™å¥è¯ä¸¤ä¸ªåˆ†æ”¯ éƒ½ä¼šè·³è½¬åˆ°é‚£é‡Œæ‰§è¡Œ
    	}
    	else 
    	{
    		edx = 0x6032d0;
    		for (eax = 1  eax != ecx  eax++)
    		{
    			rdx = *(rdx + 8);
    		}
    		*(rsp + rsi * 2 + 0x20) = rdx;
    	}
    }
    4011ab:       48 8b 5c 24 20          mov    0x20(%rsp),%rbx
    4011b0:       48 8d 44 24 28          lea    0x28(%rsp),%rax
    4011b5:       48 8d 74 24 50          lea    0x50(%rsp),%rsi
    4011ba:       48 89 d9                mov    %rbx,%rcx
    4011bd:       48 8b 10                mov    (%rax),%rdx
    4011c0:       48 89 51 08             mov    %rdx,0x8(%rcx)
    4011c4:       48 83 c0 08             add    $0x8,%rax
    4011c8:       48 39 f0                cmp    %rsi,%rax
    4011cb:       74 05                   je     4011d2 <phase_6+0xde>
    4011cd:       48 89 d1                mov    %rdx,%rcx
    4011d0:       eb eb                   jmp    4011bd <phase_6+0xc9>
    ; åˆæ˜¯ä¸€ä¸ªå¾ªç¯
    rbx = *(rsp + 0x20);
    rsi = rsp + 0x50;
    rcx = rbx;
    for (rax = rsp + 0x28  rax != rsi  rax += 8)
    {
    	rdx = *rax;
    	*(rcx + 0x8) = rdx;
    	rcx = rdx;
    }
    4011d2:       48 c7 42 08 00 00 00    movq   $0x0,0x8(%rdx)
    4011d9:       00
    4011da:       bd 05 00 00 00          mov    $0x5,%ebp
    4011df:       48 8b 43 08             mov    0x8(%rbx),%rax
    4011e3:       8b 00                   mov    (%rax),%eax
    4011e5:       39 03                   cmp    %eax,(%rbx)  # *rbx éœ€è¦å¤§äº eax 
    4011e7:       7d 05                   jge    4011ee <phase_6+0xfa>
    4011e9:       e8 4c 02 00 00          callq  40143a <explode_bomb>
    4011ee:       48 8b 5b 08             mov    0x8(%rbx),%rbx
    4011f2:       83 ed 01                sub    $0x1,%ebp
    4011f5:       75 e8                   jne    4011df <phase_6+0xeb>
    4011f7:       48 83 c4 50             add    $0x50,%rsp
    4011fb:       5b                      pop    %rbx
    4011fc:       5d                      pop    %rbp
    4011fd:       41 5c                   pop    %r12
    4011ff:       41 5d                   pop    %r13
    401201:       41 5e                   pop    %r14
    401203:       c3                      retq
    *(rdx + 0x8) = 0;
    for (ebp = 0x5  ebp != 0x1  ebp -= 1)
    {
    	rax = *(rbx + 0x8);
    	eax = *rax;
    	if (*rbx < eax)
    		explode_bomb();
    	rbx = *(rbx + 0x8);
    }
    

ä»£ç å¤ªé•¿ï¼Œè¿™é‡Œæˆ‘è€ƒè™‘ç›´æ¥ç”¨`gdb`åˆ†æï¼Œå‰é¢å…¥æ ˆçš„å…­ä¸ªå¯„å­˜å™¨çš„å€¼å¦‚ä¸‹å›¾æ‰€ç¤º

![image-20221022165542351](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022165542.png)

å‰é¢çš„æŒ‡ä»¤æ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ³¨æ„æ­¤æ—¶`r13`å’Œ`rsi`ä¸­ä¿å­˜çš„éƒ½æ˜¯æ ˆæŒ‡é’ˆ`rsp`çš„å†…å®¹ï¼Œè°ƒè¯•åˆ°è°ƒç”¨`read_six`ä¹‹å‰ï¼Œè¿™ä¸ªå‡½æ•°éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå­˜å‚¨åœ¨å¯„å­˜å™¨`rdi`ä¸­ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼çš„6ä¸ª`int`å‹å…ƒç´ æ•°ç»„çš„é¦–åœ°å€ï¼Œå­˜å‚¨åœ¨å¯„å­˜å™¨`rsi`ä¸­ï¼Œ

![image-20221022170328819](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022170328.png)

è¿™ä¸ªå‡½æ•°å†…éƒ¨åŒæ ·è°ƒç”¨äº†`sscanf`,åœ¨æ¬¡å°±ä¸å†è¯¦ç»†å±•å¼€

![image-20221022170245086](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022170245.png)

ä»è¯¥å‡½æ•°é€€å‡ºä¹‹åï¼Œ`mov r14, rsp`å°†`rsp`çš„å€¼åˆèµ‹ç»™äº†`r14`ï¼Œæ³¨æ„`rsp`è¿›å…¥`read_six`å‡½æ•°ä¹‹ååˆå›æ¥æ ˆæ˜¯è¢«å¹³è¡¡äº†çš„ï¼Œæ‰€ä»¥æ­¤æ—¶ `r13 = r14 = rsp`ï¼Œä¸‹ä¸€æ­¥æ˜¯`mov r12d, 0`,å¾ˆæœ‰æ„æ€,`r12d`æ˜¯`r12`å¯„å­˜å™¨çš„ï¼Ÿï¼Ÿï¼Œæ¥ç€å°†`r13`ä¸­ä¿å­˜çš„`rsp`åœ°å€åˆä¼ ç»™äº†`rbp`ï¼Œå°†`M[rsp]`ä¼ ç»™äº†`eax`ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼Œ`M[rsp] = 0x200000001`ï¼Œä½†æ˜¯`eax`å¯„å­˜å™¨æ˜¯32ä½å¯„å­˜å™¨ï¼Œåªèƒ½å­˜å‚¨ä½å››ä¸ªå­—èŠ‚ï¼Œå³`0x00000001`ï¼Œä¹‹å`eax -= 1 å˜æˆäº†0`ï¼Œ

æ•´ç†ä¸€ä¸‹æ±‡ç¼–ä»£ç ï¼Œå…¶å¯¹åº”çš„Cé£æ ¼å¦‚ä¸‹ï¼Œåˆ†æˆäº†ä»¥ç©ºè¡Œé—´éš”çš„äº”æ®µä»£ç ï¼Œ

    phase_6(rdi)  //  æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ä¼ å…¥åˆ° rdi ä¸­
    {
    	r13 = rsp;
    	rsi = rsp;
    	read_six_numbers(rdi, rsi); //  rdi ä¸ºæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œ  rsiä¸º %%%%%%
    	r14 = rsp;
        // æ€»ç»“ä¸€ä¸‹  è¿™ä¸ªå¾ªç¯çš„å«ä¹‰ï¼šè¾“å…¥6ä¸ª1-6çš„æ•°ï¼Œä¸”ä¸èƒ½é‡å¤
    	for (r12 = 0;  r12 != 6;  r12++)   // r12dçŒœæµ‹åº”è¯¥æ˜¯ r12 çš„ä½32ä½
    	{
    		rbp = r13; // è¿™é‡Œ rbp = r13 =rsp  rsp å­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–åçš„æ•°å­—
    		eax = *r13;  // å»å†…å­˜ä¸­æ‰¾  ç¬¬ä¸€æ¬¡ eax = 1  ç¬¬äºŒæ¬¡eax= 2
    		eax -= 1;  // eax -= 1 = 0   è¿™é‡Œé™åˆ¶äº†è¾“å…¥çš„æ•°å­—å¿…é¡»ä¸º 1-6
    		if (eax > 5)
    			explode_bomb();
    		for (ebx = r12 + 1;  ebx <= 5;  ebx++)  // åˆå§‹ ebx = r12+1 = 1
    		{
    			rax = ebx;  // ç¬¦å·ä½æ‰©å±•  e->r  ebxä¸ºæ­£æ•°ç”¨0å¡«å……é«˜ä½   ä¸ºè´Ÿæ•°ç”¨1å¡«å……é«˜ä½  rax = ebx è¿™é‡Œæ˜¯æ•´æ•° rax = 0x1
    			eax = *(rsp + rax * 44);  // eax = *(rsp + i * 4)  ä¾æ¬¡éå† 1 2 3 4 5 6  åˆå§‹rax=1 æ‰€ä»¥eax = 2
               // ä¹‹å *rbp æ˜¯ä¸å˜çš„ï¼Œå§‹ç»ˆæ˜¯1  ä½†æ˜¯ eax ä¼šä¾æ¬¡éå†æ‰€æœ‰ 2 3 4 5 6  éƒ½ä¸ä¼šç›¸ç­‰ æ‰€ä»¥æœ€ç»ˆebx = 5  eax=6é€€å‡ºå¾ªç¯
    			if (*rbp == eax)   // 2 != 1(*rbp)
    				explode_bomb();
    		}
    		r13 += 4; // r13 = rsp + 4   ç›¸å½“äºä¸‹ä¸€æ¬¡å¾ªç¯ rbp + 4    å–ä¸‹ä¸€ä¸ªæ•°åˆ¤æ–­æ˜¯å¦æœ‰ä¸å®ƒç›¸åŒçš„æ•°
    	}
        // ä¸‹é¢è¿™æ®µå¾ªç¯çš„å«ä¹‰ï¼šå°† a[i] å˜ä¸º 7 - a[i] å­˜å‚¨åˆ°åŸå…ˆa[i]æ‰€åœ¨çš„ä½ç½®  å³ esp + 4*i
        rsi = rsp + 0x18;  // åˆšå¥½æ˜¯æˆ‘ä»¬è¾“å…¥çš„6ä¸ªå­—ç¬¦çš„ä¸‹ä¸€ä¸ªä½ç½®   24ä¸ªå­—èŠ‚   å…¶å®æ˜¯æˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦æ•°ç»„çš„ '\0'
        rax = r14;  // rax = r14 = rsp
        ecx = 0x7;
        for (rax = r14;  rax != rsi;  rax += 4)  // éå†æ‰€æœ‰å­—ç¬¦æ•°ç»„
        {
            edx = ecx;               // edx = 7
            edx = edx - *rax;		// edx = 7 - a[i]   åŒæ ·ä¹Ÿæ˜¯ 1-6 çš„æ•°
            *rax = edx;				// *rax = rdx  å­˜å›å†…å­˜   
        }
        // ä¸‹é¢å«ä¹‰ï¼š
        for (esi = 0; rsi != 0x18;  rsi += 4)  // éå†æ‰€æœ‰å­—ç¬¦æ•°ç»„   0x18å¾ˆæ˜æ˜¾ éå†7æ¬¡ åˆšå¥½åˆ°'\0'ç»“æŸå¾ªç¯
        {
            ecx = *(rsp + rsi);  // å–å‡ºå¯¹åº”çš„å­—ç¬¦æ•°ç»„çš„å€¼  è¾“å…¥çš„æ˜¯123456  ç»è¿‡ä¸Šé¢å˜æ¢åæˆäº† 654321
            if (ecx <= 1) // åªæœ‰ è¾“å…¥çš„ä¸º 6 æ—¶æ‰ä¼šæ‰§è¡Œ
            {
                edx = 0x6032d0;  // æ­¤åœ°å€å¤„æ˜¯ä¸€ä¸ªç»“æ„ä½“
                // ä¸‹é¢çš„å«ä¹‰ï¼šå°†edxå­˜å‚¨çš„ç»“æ„ä½“ä¿¡æ¯  å­˜å‚¨åˆ°rsp + rsi * 2 + 0x20 å¤„çš„åœ°å€  å°±æ˜¯ rsp + 8*i + 0x20
                //*(rsp + rsi * 2 + 0x20) = rdx;  // è¿™å¥è¯  æ— è®ºè¿›å…¥å“ªä¸ªåˆ†æ”¯éƒ½ä¼šè·³è½¬åˆ°é‚£é‡Œæ‰§è¡Œ  å¯ä»¥å†™åˆ°å¤–é¢
            }
            else  // åªè¦ è¾“å…¥çš„ ä¸ä¸º6
            {
                edx = 0x6032d0;  // ä¸ä¸Šé¢ä¸€æ ·
                for (eax = 1;  eax != ecx;  eax++) // ç¬¬ä¸€ä¸ª ecx = 6 å¾ªç¯6æ¬¡ æœ€ç»ˆ7 - 1å­˜å‚¨åˆ°äº† node6
                {  // å¾ªç¯ä¸€æ¬¡  å¯¹åº”node1   å¾ªç¯ä¸¤æ¬¡ å¯¹åº”node2  å³  node{7-a[i]}
                    rdx = *(rdx + 8);  // ä» 6032d0(node1) -> 6032e0(node2) 
                }
                //*(rsp + rsi * 2 + 0x20) = rdx;  
            }
            *(rsp + rsi * 2 + 0x20) = rdx; // ç¬¬ä¸€æ¬¡  rcx=7-1=6  rdxæŒ‡å‘node6  rsp+0x20 = node6
        }
        // è¿™æ®µå¥½åƒæ²¡ä»€ä¹ˆç”¨
        rbx = *(rsp + 0x20);  // è·ç¦»æ ˆæŒ‡é’ˆæœ€è¿‘çš„ node  å¯¹åº”è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°  nodeçš„ç¼–å·å³ä¸º 7-a[i]  node6
        rsi = rsp + 0x50; // node çš„ç»“æŸåœ°å€
        rcx = rbx;  // ä¿å­˜è¾“å…¥
        for (rax = rsp + 0x28;  rax != rsi;  rax += 8)  // rax ä» ç¬¬äºŒä¸ªnode å¼€å§‹éå†    node5 
        {
            // å…¸å‹çš„äº¤æ¢æ“ä½œ
            rdx = *rax; // æš‚å­˜éå†åˆ°çš„node  rdx = node5    rdx = node4
            *(rcx + 0x8) = rdx; 		// node5 = node6  node4=node5
            rcx = rdx;				    // node6 = node5
        }
        // åˆ†æï¼š node[7-input[i]]->data >= node[7-input[i+1]]->data
        *(rdx + 0x8) = 0; // æ­¤æ—¶ rdx ä¿å­˜æœ€åä¸€ä¸ªnode 
        for (ebp = 0x5;  ebp != 0x1;  ebp -= 1) // å¾ªç¯5æ¬¡
        {
            rax = *(rbx + 0x8); // rbx ä»æŒ‡å‘è·ç¦»æ ˆæŒ‡é’ˆæœ€è¿‘çš„node   rax = node
            eax = *rax; // å–å‡ºnodeçš„å€¼(æ³¨æ„eaxï¼Œå–å¾—æ˜¯ä½32ä½)   åªçœ‹ä½32ä½ nodeçš„å¤§å°é¡ºåºä¸º 3 4 5 6 1 2
            if (*rbx < eax) // å¦‚æœç¬¬ä¸€ä¸ªnodeçš„å€¼å°äºä¸‹ä¸€ä¸ª  å°±ä¼šçˆ†ç‚¸  æ‰€ä»¥éœ€è¦ä¿è¯è¾“å…¥çš„æ•°å¯¹åº”çš„nodeæ˜¯é™åºæ’åˆ—åœ¨æ ˆä¸­çš„
            // å³ node6 node5 .. node1  åªçœ‹ä½32ä½ nodeçš„å¤§å°é¡ºåºä¸º 3 4 5 6 1 2  æ‰€ä»¥æˆ‘ä»¬è¾“å…¥çš„åº”è¯¥ä¸º 4 3 2 1 6 5 (7-a)
                explode_bomb();
            rbx = *(rbx + 0x8);
        }
    }
    

é¦–å…ˆç¡®è®¤æˆ‘ä»¬è¾“å…¥çš„æ•°æ®çš„ä½ç½®ï¼Œå¯ä»¥çœ‹åˆ°åœ¨`rsp rsp + 4`å¤„ä¾æ¬¡å­˜æ”¾ç€æ ¼å¼åŒ–åçš„æ•°å­— 1 2 ..ï¼Œç„¶åæ ¹æ®`gdb`çœ‹ä¸Šé¢çš„åˆ†æå³å¯

![image-20221022203539484](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022203539.png)

åˆ°ç¬¬ä¸‰æ®µä»£ç æ—¶ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºä¼šå°†`edx` è®¾ç½®ä¸º`0x6032d0`ï¼ŒæŸ¥çœ‹è¯¥åœ°å€å¤„ä¿¡æ¯å¯çŸ¥ï¼ŒçŒœæµ‹è¿™é‡Œåº”è¯¥æ˜¯ä¸€ä¸ªç»“æ„ä½“`node1`ï¼Œåœ¨`gdb`ä¸­ä¹Ÿæ˜ç¡®åœ°å‘Šè¯‰äº†æˆ‘ä»¬

![image-20221022212435575](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022212435.png)

![image-20221022213252560](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022213252.png)

æ‰§è¡Œå®Œ`mov rdx, qword ptr [rdx + 8]`è¿™æ¡æŒ‡ä»¤åï¼Œ`rdx`å­˜å‚¨çš„å†…å®¹ç”± `node1`å˜æˆäº†`node2`ï¼Œæ¥ç€å¾ªç¯åˆä¼šå˜æˆ`node3`ã€`node4`ä¸€ç›´åˆ°`node`ï¼Œç„¶åæ‰§è¡Œ`qword ptr [rsp + rsi*2 + 0x20], rdx`æŒ‡ä»¤ï¼Œå°†`node6`å­˜å‚¨åˆ°äº†æ ˆä¸Šæˆ‘ä»¬è¾“å…¥çš„å­—ç¬¦ä¸²çš„ä¸Šé¢ã€‚åŒæ ·ï¼Œå¾ªç¯6æ¬¡ï¼Œæ‰¾åˆ°æ¯ä¸€ä¸ªå˜åŒ–åçš„ 7- a\[i\] å¯¹åº”çš„nodeï¼Œå¹¶å­˜å‚¨åˆ°æ ˆçš„å¯¹åº”ä½ç½®ã€‚

![image-20221022214023503](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022214023.png)

å¾ªç¯ç»“æŸåï¼Œå¯ä»¥çœ‹åˆ°æ ˆçš„æƒ…å†µï¼ˆå³ä¾§çš„æ•°å­—å³ä¸º`node->data`ï¼‰ï¼š

![image-20221022214652857](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022214652.png)

æŸ¥çœ‹å…­ä¸ª`node`ç»“æ„ä½“çš„ä¿¡æ¯

![image-20221022221221892](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022221221.png)

ç»è¿‡åˆ†æï¼Œå¾—çŸ¥æœ€åä¸€æ®µä»£ç çš„ä½œç”¨æ˜¯å°†ç»“æ„ä½“çš„`data`æŒ‰éå‡åºæ’åˆ—ï¼Œæ¯ä¸€ä¸ªnodeçš„dataå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ³¨æ„æˆ‘ä»¬æ¯”è¾ƒæ—¶ç”¨çš„æ˜¯`eax`æ¥å­˜å‚¨ç»“æ„ä½“`node->data`ï¼Œåªèƒ½å­˜å‚¨ä½32ä½ï¼Œæ‰€ä»¥æŒ‰`node->data`çš„ä½32ä½æ’åºï¼Œå¯ä»¥å¾—åˆ°é™åºæ’åˆ—ä¸º`node 3,4,5,6,1,2`ï¼Œè€Œ`7-input[i]`åˆšå¥½ä¸`node`çš„ç¼–å·æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è¾“å…¥ä¸º`4 3 2 1 6 5`ã€‚ ç»ˆäºå®Œæˆäº†ğŸš©

![image-20221022222615380](https://picgo-1.oss-cn-hangzhou.aliyuncs.com/picgo/20221022222615.png)