---
layout: post
title: "Monaco Editor ä¸­çš„ Keybinding æœºåˆ¶"
date: "2022-09-29T13:53:44.195Z"
---
Monaco Editor ä¸­çš„ Keybinding æœºåˆ¶
==============================

ä¸€ã€å‰è¨€
----

å‰æ®µæ—¶é—´ç¢°åˆ°äº†ä¸€ä¸ª Keybinding ç›¸å…³çš„é—®é¢˜ï¼Œäºæ˜¯æ¢ç©¶äº†ä¸€ç•ªï¼Œé¦–å…ˆå¤§å®¶å¯èƒ½ä¼šæœ‰ä¸¤ä¸ªé—®é¢˜ï¼šMonaco Editor æ˜¯å•¥ï¼ŸKeybinding åˆæ˜¯å•¥ï¼Ÿ

*   **Monaco Editor**ï¼š  
    å¾®è½¯å¼€æºçš„ä¸€ä¸ªä»£ç ç¼–è¾‘å™¨ï¼Œä¸º VS Code çš„ç¼–è¾‘å™¨æä¾›æ”¯æŒï¼ŒMonaco Editor æ ¸å¿ƒä»£ç ä¸ VS Code æ˜¯å…±ç”¨çš„ï¼ˆéƒ½åœ¨ VS Code github ä»“åº“ä¸­ï¼‰ã€‚
*   **Keybinding**ï¼š  
    Monaco Editor ä¸­å®ç°å¿«æ·é”®åŠŸèƒ½çš„æœºåˆ¶ï¼ˆå…¶å®å‡†ç¡®æ¥è¯´ï¼Œåº”è¯¥æ˜¯éƒ¨åˆ†æœºåˆ¶ï¼‰ï¼Œå¯ä»¥ä½¿å¾—é€šè¿‡å¿«æ·é”®æ¥æ‰§è¡Œæ“ä½œï¼Œä¾‹å¦‚æ‰“å¼€å‘½ä»¤é¢æ¿ã€åˆ‡æ¢ä¸»é¢˜ä»¥åŠç¼–è¾‘å™¨ä¸­çš„ä¸€äº›å¿«æ·æ“ä½œç­‰ã€‚

æœ¬æ–‡ä¸»è¦æ˜¯**é’ˆå¯¹ Monaco Editor çš„ Keybinding** æœºåˆ¶è¿›è¡Œä»‹ç»ï¼Œç”±äºæºç å®Œæ•´çš„é€»è¾‘æ¯”è¾ƒåºæ‚ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸­çš„å±•ç¤ºçš„æºç ä»¥åŠæµç¨‹ä¼šæœ‰ä¸€å®šçš„ç®€åŒ–ã€‚

æ–‡ä¸­ä½¿ç”¨çš„ä»£ç ç‰ˆæœ¬ï¼š

Monaco Editorï¼š0.30.1

VS Codeï¼š1.62.1

äºŒã€ä¸¾ä¸ªğŸŒ°
------

è¿™é‡Œä½¿ç”¨ monaco-editor åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œåæ–‡ä¼šåŸºäºè¿™ä¸ªä¾‹å­æ¥è¿›è¡Œä»‹ç»ã€‚

    import React, { useRef, useEffect, useState } from "react";
    import * as monaco from "monaco-editor";
    import { codeText } from "./help";
    
    const Editor = () => {
        const domRef = useRef<HTMLDivElement>(null);
        const [actionDispose, setActionDispose] = useState<monaco.IDisposable>();
    
        useEffect(() => {
            const editorIns = monaco.editor.create(domRef.current!, {
                value: codeText,
                language: "typescript",
                theme: "vs-dark",
            });
            const action = {
                id: 'test',
                label: 'test',
                precondition: 'isChrome == true',
                keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyL],
                run: () => {
                    window.alert('chrome: cmd + k');
                },
            };
    
            setActionDispose(editorIns.addAction(action));
            editorIns.focus();
    
            return () => {
                editorIns.dispose();
            };
        }, []);
    
        const onClick = () => {
            actionDispose?.dispose();
            window.alert('å·²å¸è½½');
        };
    
        return (
            <div>
                <div ref={domRef} className='editor-container' />
                <button className='cancel-button' onClick={onClick}>å¸è½½keybinding</button>
            </div>
        );
    };
    
    export default Editor;
    

ä¸‰ã€åŸç†æœºåˆ¶
------

### 1\. æ¦‚è§ˆ

æ ¹æ®ä¸Šé¢çš„ä¾‹å­ï¼ŒKeybinding æœºåˆ¶çš„æ€»ä½“æµç¨‹å¯ä»¥ç®€å•çš„åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

*   åˆå§‹åŒ–ï¼šä¸»è¦æ˜¯åˆå§‹åŒ–æœåŠ¡ä»¥åŠç»™ dom æ·»åŠ ç›‘å¬äº‹ä»¶
*   æ³¨å†Œï¼šæ³¨å†Œ keybinding å’Œ command
*   æ‰§è¡Œï¼šé€šè¿‡æŒ‰å¿«æ·é”®è§¦å‘æ‰§è¡Œå¯¹åº”çš„ keybinding å’Œ command
*   å¸è½½ï¼šæ¸…é™¤æ³¨å†Œçš„ keybinding å’Œ command

### 2\. åˆå§‹åŒ–

å›åˆ°ä¸Šé¢ä¾‹å­ä¸­åˆ›å»º editor çš„ä»£ç ï¼š

    const editorIns = monaco.editor.create(domRef.current!, {
        value: codeText,
        language: "typescript",
        theme: "vs-dark",
    });
    

åˆå§‹åŒ–è¿‡ç¨‹å¦‚ä¸‹ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202209/2332333-20220929192120597-715157029.png)

åˆ›å»º editor ä¹‹å‰ä¼šå…ˆåˆå§‹åŒ– servicesï¼Œé€šè¿‡å®ä¾‹åŒ– DynamicStandaloneServices ç±»åˆ›å»ºæœåŠ¡ï¼š

    let services = new DynamicStandaloneServices(domElement, override);
    

åœ¨ constructor å‡½æ•°ä¸­ä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç æ³¨å†Œ keybindingServiceï¼š

    let keybindingService = ensure(IKeybindingService, () =>
        this._register(
            new StandaloneKeybindingService(
                contextKeyService,
                commandService,
                telemetryService,
                notificationService,
                logService,
                domElement
            )
        )
    );
    

å…¶ä¸­ this.\_register æ–¹æ³•å’Œ ensure æ–¹æ³•ä¼šåˆ†åˆ«å°† StandaloneKeybindingServices å®ä¾‹ä¿å­˜åˆ° disposable å¯¹è±¡ï¼ˆç”¨äºå¸è½½ï¼‰å’Œ this.\_serviceCollection ä¸­ï¼ˆç”¨äºæ‰§è¡Œè¿‡ç¨‹æŸ¥æ‰¾keybindingï¼‰ã€‚

å®ä¾‹åŒ– StandaloneKeybindingServiceï¼Œåœ¨ constructor å‡½æ•°ä¸­æ·»åŠ  DOM ç›‘å¬äº‹ä»¶ï¼š

    this._register(
        dom.addDisposableListener(
            domNode,
            dom.EventType.KEY_DOWN,
            (e: KeyboardEvent) => {
                const keyEvent = new StandardKeyboardEvent(e);
                const shouldPreventDefault = this._dispatch(
                    keyEvent,
                    keyEvent.target
                );
                if (shouldPreventDefault) {
                    keyEvent.preventDefault();
                    keyEvent.stopPropagation();
                }
            }
        )
    );
    

ä»¥ä¸Šä»£ç ä¸­çš„ dom.addDisposableListener æ–¹æ³•ï¼Œä¼šé€šè¿‡ addEventListener çš„æ–¹å¼ï¼Œåœ¨ domNode ä¸Šæ·»åŠ ä¸€ä¸ª keydown äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ª DomListener çš„å®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«ä¸€ä¸ªç”¨äºç§»é™¤äº‹ä»¶ç›‘å¬çš„ dispose æ–¹æ³•ã€‚ç„¶åé€šè¿‡ this.\_register æ–¹æ³•å°† DomListener çš„å®ä¾‹ä¿å­˜èµ·æ¥ã€‚

### 3\. æ³¨å†Œ keybindings

å›åˆ°ä¾‹å­ä¸­çš„ä»£ç ï¼š

    const action = {
        id: 'test',
        label: 'test',
        precondition: 'isChrome == true',
        keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyL],
        run: () => {
            window.alert('chrome: cmd + k');
        },
    };
    setActionDispose(editorIns.addAction(action));
    

æ³¨å†Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202209/2332333-20220929192120761-346728915.png)

å½“é€šè¿‡ editorIns.addAction æ¥æ³¨å†Œ keybinding æ—¶ï¼Œä¼šè°ƒç”¨ StandaloneKeybindingServices å®ä¾‹çš„ addDynamicKeybinding æ–¹æ³•æ¥æ³¨å†Œ keybindingã€‚

    public addDynamicKeybinding(
        commandId: string,
        _keybinding: number,
        handler: ICommandHandler,
        when: ContextKeyExpression | undefined
    ): IDisposable {
        const keybinding = createKeybinding(_keybinding, OS);
        const toDispose = new DisposableStore();
        
        if (keybinding) {
            this._dynamicKeybindings.push({
                keybinding: keybinding.parts,
                command: commandId,
                when: when,
                weight1: 1000,
                weight2: 0,
                extensionId: null,
                isBuiltinExtension: false,
            });
            
            toDispose.add(
                toDisposable(() => {
                    for (let i = 0; i < this._dynamicKeybindings.length; i++) {
                        let kb = this._dynamicKeybindings[i];
                        if (kb.command === commandId) {
                            this._dynamicKeybindings.splice(i, 1);
                            this.updateResolver({
                                source: KeybindingSource.Default,
                            });
                            return;
                        }
                    }
                })
            );
        }
        
        toDispose.add(CommandsRegistry.registerCommand(commandId, handler));
        this.updateResolver({ source: KeybindingSource.Default });
        
        return toDispose;
    }
    

ä¼šå…ˆæ ¹æ®ä¼ å…¥çš„ \_keybinding åˆ›å»º keybinding å®ä¾‹ï¼Œç„¶åè¿åŒ commandã€when ç­‰å…¶ä»–ä¿¡æ¯å­˜å…¥\_dynamicKeybindings æ•°ç»„ä¸­ï¼ŒåŒæ—¶ä¼šæ³¨å†Œå¯¹åº”çš„ commandï¼Œå½“åé¢è§¦å‘ keybinding æ—¶ä¾¿æ‰§è¡Œå¯¹åº”çš„ commandã€‚è¿”å›çš„ toDispose å®ä¾‹åˆ™ç”¨äºå–æ¶ˆå¯¹åº”çš„ keybinding å’Œ commandã€‚

å›åˆ°ä¸Šé¢ä»£ç ä¸­åˆ›å»º keybinding å®ä¾‹çš„åœ°æ–¹ï¼ŒcreateKeybinding æ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„ \_keybinding æ•°å­—å’Œ OS ç±»å‹å¾—åˆ°å®ä¾‹ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼ˆå·²çœç•¥éƒ¨åˆ†å±æ€§ï¼‰ï¼š

    {
        parts: [
            {
                ctrlKey: boolean,
                shiftKey: boolean,
                altKey: boolean,
                metaKey: boolean,
                keyCode: KeyCode,
            }
        ],
    }
    

é‚£ä¹ˆï¼Œæ˜¯æ€ä¹ˆé€šè¿‡ä¸€ä¸ª number å¾—åˆ°æ‰€æœ‰æŒ‰é”®ä¿¡æ¯çš„å‘¢ï¼Ÿå¾€ä¸‹çœ‹â†“â†“â†“

### 4\. keyçš„è½¬æ¢

å…ˆçœ‹çœ‹ä¸€å¼€å§‹ä¼ å…¥çš„ keybinding æ˜¯ä»€ä¹ˆï¼š

    const action = {
        id: 'test',
        label: 'test',
        precondition: 'isChrome == true',
        keybindings: [monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyL],
        run: () => {
            window.alert('chrome: cmd + k');
        },
    };
    

ä¼ å…¥çš„ keybinding å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„ keybindings æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œmonaco.KeyMod.CtrlCmd = 2048ï¼Œmonaco.KeyCode.KeyL = 42ï¼Œå¯¹åº”çš„æ•°å­—æ˜¯ monaco-editor ä¸­å®šä¹‰çš„æšä¸¾å€¼ï¼Œä¸çœŸå®çš„ keyCode å­˜åœ¨å¯¹åº”å…³ç³»ã€‚æ‰€ä»¥æ³¨å†Œæ—¶ä¼ å…¥çš„ keybinding å‚æ•°ä¸ºï¼š 2048 | 42 = 2090

å…ˆç®€å•äº†è§£ä¸‹ JS ä¸­çš„ä½è¿ç®—ï¼ˆæ“ä½œçš„æ˜¯32ä½å¸¦ç¬¦å·çš„äºŒè¿›åˆ¶æ•´æ•°ï¼Œä¸‹é¢ä¾‹å­ä¸­åªç”¨8ä½ç®€å•è¡¨ç¤ºï¼‰ï¼š

**æŒ‰ä½ä¸ï¼ˆANDï¼‰&**

å¯¹åº”çš„ä½éƒ½ä¸º1åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0

ä¾‹å¦‚ï¼š

00001010 // 10

00000110 // 6

\------

00000010 // 2

**æŒ‰ä½æˆ–ï¼ˆORï¼‰|**

å¯¹åº”çš„ä½ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸º1åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0

00001010 // 10

00000110 // 6

\-------

00001110 // 14

**å·¦ç§»ï¼ˆLeft shiftï¼‰<<**

å°†äºŒè¿›åˆ¶æ•°æ¯ä¸€ä½å‘å·¦ç§»åŠ¨æŒ‡å®šä½æ•°ï¼Œå·¦ä¾§ç§»å‡ºçš„ä½èˆå¼ƒï¼Œå³ä¾§è¡¥0

00001010 // 10

\------- // 10 << 2

00101000 // 40

**å³ç§» >>**

å°†äºŒè¿›åˆ¶æ•°æ¯ä½å‘å³ç§»åŠ¨æŒ‡å®šä½æ•°ï¼Œå³ä¾§ç§»å‡ºçš„ä½èˆå¼ƒï¼Œå·¦ä¾§ç”¨åŸæ¥æœ€å·¦è¾¹çš„æ•°è¡¥é½

00001010 // 10

\------- // 10 >> 2

00000010 // 2

**æ— ç¬¦å·å³ç§» >>>**

å°†äºŒè¿›åˆ¶æ•°æ¯ä½å‘å³ç§»åŠ¨æŒ‡å®šä½æ•°ï¼Œå³ä¾§ç§»å‡ºçš„ä½èˆå¼ƒï¼Œå·¦ä¾§è¡¥0

00001010 // 10

\------- // 10 >> 2

00000010 // 2

æ¥ä¸‹æ¥çœ‹ä¸‹æ˜¯æ€ä¹ˆæ ¹æ®ä¸€ä¸ªæ•°å­—ï¼Œåˆ›å»ºå‡ºå¯¹åº”çš„ keybinding å®ä¾‹ï¼š

    export function createKeybinding(keybinding: number, OS: OperatingSystem): Keybinding | null {
        if (keybinding === 0) {
            return null;
        }
        const firstPart = (keybinding & 0x0000FFFF) >>> 0;
        // å¤„ç†åˆ†ä¸¤æ­¥çš„keybindingï¼Œä¾‹å¦‚ï¼šshift shiftï¼Œè‹¥æ— ç¬¬äºŒéƒ¨åˆ†ï¼Œåˆ™chordPart = 0
        const chordPart = (keybinding & 0xFFFF0000) >>> 16;
        if (chordPart !== 0) {
            return new ChordKeybinding([
                createSimpleKeybinding(firstPart, OS),
                createSimpleKeybinding(chordPart, OS)
            ]);
        }
        return new ChordKeybinding([createSimpleKeybinding(firstPart, OS)]);
    }
    

çœ‹ä¸‹ createSimpleKeybinding æ–¹æ³•åšäº†ä»€ä¹ˆ

    const enum BinaryKeybindingsMask {
        CtrlCmd = (1 << 11) >>> 0, // 2048
        Shift = (1 << 10) >>> 0,   // 1024
        Alt = (1 << 9) >>> 0,      // 512
        WinCtrl = (1 << 8) >>> 0,  // 256
        KeyCode = 0x000000FF       // 255
    }
    
    export function createSimpleKeybinding(keybinding: number, OS: OperatingSystem): SimpleKeybinding {
        const ctrlCmd = (keybinding & BinaryKeybindingsMask.CtrlCmd ? true : false);
        const winCtrl = (keybinding & BinaryKeybindingsMask.WinCtrl ? true : false);
        const ctrlKey = (OS === OperatingSystem.Macintosh ? winCtrl : ctrlCmd);
        const shiftKey = (keybinding & BinaryKeybindingsMask.Shift ? true : false);
        const altKey = (keybinding & BinaryKeybindingsMask.Alt ? true : false);
        const metaKey = (OS === OperatingSystem.Macintosh ? ctrlCmd : winCtrl);
        const keyCode = (keybinding & BinaryKeybindingsMask.KeyCode);
    
        return new SimpleKeybinding(ctrlKey, shiftKey, altKey, metaKey, keyCode);
    }
    

æ‹¿ä¸Šé¢çš„ä¾‹å­ï¼škeybinding = monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyLï¼Œå³ keybinding = 2048 | 42 = 2090ï¼Œç„¶åçœ‹ä¸Šé¢ä»£ç ä¸­çš„ï¼š

const ctrlCmd = (keybinding & BinaryKeybindingsMask.CtrlCmd ? true : false);

è¿ç®—å¦‚ä¸‹ï¼š

100000101010 // 2090 -> keybinding

100000000000 // 2048 -> CtrlCmd

\----------- // &

100000000000 // 2048 -> CtrlCmd

å†çœ‹keyCodeçš„è¿ç®—ï¼š

const keyCode = (keybinding & BinaryKeybindingsMask.KeyCode)

100000101010 // 2090 -> keybinding

000011111111 // 255 -> KeyCode

\----------- // &

000000101010 // 42 -> KeyL

äºæ˜¯ä¾¿å¾—åˆ°äº† ctrlKeyï¼ŒshiftKeyï¼ŒaltKeyï¼ŒmetaKeyï¼ŒkeyCode è¿™äº›å€¼ï¼Œæ¥ä¸‹æ¥ä¾¿ç”±è¿™äº›å€¼ç”ŸæˆSimpleKeybindingå®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«äº†ä¸Šé¢çš„è¿™äº›æŒ‰é”®ä¿¡æ¯ä»¥åŠä¸€äº›æ“ä½œæ–¹æ³•ã€‚

è‡³æ­¤ï¼Œå·²ç»å®Œæˆäº† keybinding çš„æ³¨å†Œï¼Œå°† keybinding å®ä¾‹åŠç›¸å…³ä¿¡æ¯å­˜å…¥äº† StandaloneKeybindingService å®ä¾‹çš„ \_dynamicKeybindings æ•°ç»„ä¸­ï¼Œå¯¹åº”çš„ command ä¹Ÿæ³¨å†Œåˆ°äº† CommandsRegistry ä¸­ã€‚

### 5.æ‰§è¡Œ

å½“ç”¨æˆ·åœ¨é”®ç›˜ä¸ŠæŒ‰ä¸‹å¿«æ·é”®æ—¶ï¼Œä¾¿ä¼šè§¦å‘ keybinding å¯¹åº” command çš„æ‰§è¡Œï¼Œæ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202209/2332333-20220929192120930-1976075174.png)

å›åˆ° StandaloneKeybindingServices åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåœ¨ domNode ä¸Šç»‘å®šäº† keydown äº‹ä»¶ç›‘å¬å‡½æ•°ï¼š

    (e: KeyboardEvent) => {
        const keyEvent = new StandardKeyboardEvent(e);
        const shouldPreventDefault = this._dispatch(keyEvent, keyEvent.target);
        if (shouldPreventDefault) {
            keyEvent.preventDefault();
            keyEvent.stopPropagation();
        }
    };
    

å½“ keydown äº‹ä»¶è§¦å‘åï¼Œä¾¿ä¼šæ‰§è¡Œè¿™ä¸ªç›‘å¬å‡½æ•°ï¼Œé¦–å…ˆä¼šå®ä¾‹åŒ–ä¸€ä¸ª StandardKeyboardEvent å®ä¾‹ï¼Œè¯¥å®ä¾‹åŒ…å«äº†ä¸€äº›æŒ‰é”®ä¿¡æ¯å’Œæ–¹æ³•ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼ˆå·²çœç•¥éƒ¨åˆ†å±æ€§ï¼‰ï¼š

    {
        target: HTMLElement,
        ctrlKey: boolean,
        shiftKey: boolean,
        altKey: boolean,
        metaKey: boolean,
        keyCode: KeyCode,
    }
    

å…¶ä¸­ keyCode æ˜¯ç»è¿‡å¤„ç†åå¾—åˆ°çš„ï¼Œç”±åŸå§‹é”®ç›˜äº‹ä»¶çš„ keyCode è½¬æ¢ä¸º monoco-editor ä¸­çš„ keyCodeï¼Œè½¬æ¢è¿‡ç¨‹ä¸»è¦å°±æ˜¯å…¼å®¹ä¸€äº›ä¸åŒçš„æµè§ˆå™¨ï¼Œå¹¶æ ¹æ®æ˜ å°„å…³ç³»å¾—åˆ°æœ€ç»ˆçš„ keyCodeã€‚å‡†æ¢æ–¹æ³•å¦‚ä¸‹ï¼š

    function extractKeyCode(e: KeyboardEvent): KeyCode {
        if (e.charCode) {
            // "keypress" events mostly
            let char = String.fromCharCode(e.charCode).toUpperCase();
            return KeyCodeUtils.fromString(char);
        }
        
        const keyCode = e.keyCode;
        
        // browser quirks
        if (keyCode === 3) {
            return KeyCode.PauseBreak;
        } else if (browser.isFirefox) {
            if (keyCode === 59) {
                return KeyCode.Semicolon;
            } else if (keyCode === 107) {
                return KeyCode.Equal;
            } else if (keyCode === 109) {
                return KeyCode.Minus;
            } else if (platform.isMacintosh && keyCode === 224) {
                return KeyCode.Meta;
            }
        } else if (browser.isWebKit) {
            if (keyCode === 91) {
                return KeyCode.Meta;
            } else if (platform.isMacintosh && keyCode === 93) {
                // the two meta keys in the Mac have different key codes (91 and 93)
                return KeyCode.Meta;
            } else if (!platform.isMacintosh && keyCode === 92) {
                return KeyCode.Meta;
            }
        }
        
        // cross browser keycodes:
        return EVENT_KEY_CODE_MAP[keyCode] || KeyCode.Unknown;
    }
    

å¾—åˆ°äº† keyEvent å®ä¾‹å¯¹è±¡åï¼Œä¾¿é€šè¿‡ this.\_dispatch(keyEvent, keyEvent.target) æ‰§è¡Œã€‚

    protected _dispatch(
        e: IKeyboardEvent,
        target: IContextKeyServiceTarget
    ): boolean {
        return this._doDispatch(
            this.resolveKeyboardEvent(e),
            target,
            /*isSingleModiferChord*/ false
        );
    }
    

ç›´æ¥è°ƒç”¨äº† this.\_doDispatch æ–¹æ³•ï¼Œé€šè¿‡ this.resolveKeyboardEvent(e) æ–¹æ³•å¤„ç†ä¼ å…¥çš„ keyEventï¼Œå¾—åˆ°ä¸€ä¸ªåŒ…å«äº†è®¸å¤š keybinding æ“ä½œæ–¹æ³•çš„å®ä¾‹ã€‚

æ¥ä¸‹æ¥ä¸»è¦çœ‹ä¸‹ \_doDispatch æ–¹æ³•ä¸»è¦å¹²äº†å•¥ï¼ˆä»¥ä¸‹ä»…å±•ç¤ºäº†éƒ¨åˆ†ä»£ç ï¼‰ï¼š

    private _doDispatch(
        keybinding: ResolvedKeybinding,
        target: IContextKeyServiceTarget,
        isSingleModiferChord = false
    ): boolean {
    
        const resolveResult = this._getResolver().resolve(
            contextValue,
            currentChord,
            firstPart
        );
    
        if (resolveResult && resolveResult.commandId) {
            if (typeof resolveResult.commandArgs === 'undefined') {
                this._commandService
                    .executeCommand(resolveResult.commandId)
                    .then(undefined, (err) =>
                        this._notificationService.warn(err)
                    );
            } else {
                this._commandService
                    .executeCommand(
                        resolveResult.commandId,
                        resolveResult.commandArgs
                    )
                    .then(undefined, (err) =>
                        this._notificationService.warn(err)
                    );
            }
        }
    }
    

ä¸»è¦æ˜¯æ‰¾åˆ° keybinding å¯¹åº”çš„ command å¹¶æ‰§è¡Œï¼Œ\_getResolver æ–¹æ³•ä¼šæ‹¿åˆ°å·²æ³¨å†Œçš„ keybindingï¼Œç„¶åé€šè¿‡ resolve æ–¹æ³•æ‰¾åˆ°å¯¹åº”çš„ keybinding åŠ command ä¿¡æ¯ã€‚è€Œæ‰§è¡Œ command åˆ™ä¼šä» CommandsRegistry ä¸­æ‰¾åˆ°å¯¹åº”å·²æ³¨å†Œçš„ commandï¼Œç„¶åæ‰§è¡Œ command çš„ handler å‡½æ•°ï¼ˆå³keybinding çš„å›è°ƒå‡½æ•°ï¼‰ã€‚

### 6.å¸è½½

å…ˆçœ‹çœ‹ä¸€å¼€å§‹çš„ä¾‹å­ä¸­çš„ä»£ç ï¼š

    const onClick = () => {
        actionDispose?.dispose();
        window.alert('å·²å¸è½½');
    };
    

å¸è½½è¿‡ç¨‹å¦‚ä¸‹ï¼š

![file](https://img2022.cnblogs.com/other/2332333/202209/2332333-20220929192121101-764964805.png)

å›åˆ°åˆšå¼€å§‹æ³¨å†Œæ—¶ï¼šsetActionDispose(editorIns.addAction(action))ï¼ŒaddAction æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª disposable å¯¹è±¡ï¼ŒsetActionDispose å°†è¯¥å¯¹è±¡ä¿å­˜äº†èµ·æ¥ã€‚é€šè¿‡è°ƒç”¨è¯¥å¯¹è±¡çš„ dispose æ–¹æ³•ï¼šactionDispose.dispose()ï¼Œä¾¿å¯å¸è½½è¯¥ actionï¼Œå¯¹åº”çš„ command å’Œ keybinding ä¾¿éƒ½ä¼šè¢«å¸è½½ã€‚

å››ã€ç»“è¯­
----

å¯¹ Monaco Editor çš„ Keybinding æœºåˆ¶è¿›è¡Œç®€å•æè¿°ï¼Œå°±æ˜¯é€šè¿‡ç›‘å¬ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ï¼Œæ‰¾åˆ°å¯¹åº”æ³¨å†Œçš„ keybinding å’Œ commandï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å›è°ƒå‡½æ•°ã€‚ä½†ä»”ç»†æ¢ç©¶çš„è¯ï¼Œæ¯ä¸ªè¿‡ç¨‹éƒ½æœ‰å¾ˆå¤šå¤„ç†é€»è¾‘ï¼Œæœ¬æ–‡ä¹Ÿåªæ˜¯å¯¹å…¶åšäº†ä¸€ä¸ªå¤§ä½“çš„ä»‹ç»ï¼Œå®é™…ä¸Šè¿˜æœ‰è®¸å¤šç›¸å…³çš„ç»†èŠ‚æ²¡æœ‰è®²åˆ°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æ¢ç´¢æ¢ç´¢ã€‚