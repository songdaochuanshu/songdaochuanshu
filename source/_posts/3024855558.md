---
layout: post
title: "éœ‡æƒŠ--Nginxçš„mapæŒ‡ä»¤è¿˜èƒ½è¿™æ ·ç”¨"
date: "2022-05-08T20:19:50.907Z"
---
éœ‡æƒŠ--Nginxçš„mapæŒ‡ä»¤è¿˜èƒ½è¿™æ ·ç”¨
====================

mapæŒ‡ä»¤ç®€å•ä»‹ç»
---------

å½“ç„¶è¿™é‡Œå†™çš„éƒ½æ˜¯å®˜æ–¹æ–‡æ¡£æ˜¯å·²ç»å†™è¿‡çš„ï¼Œæˆ‘ç®€å•æŠ„ä¸€ä¸‹å“ˆã€‚

mapæŒ‡ä»¤æ¥è‡ªäº [ngx\_http\_map\_module](http://nginx.org/en/docs/http/ngx_http_map_module.html) æ¨¡å—ï¼Œæä¾›çš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ åŸºäºä¸€ä¸ªå˜é‡åˆ›å»ºä¸€ä¸ªæ–°å˜é‡ï¼Œå¤§æ¦‚æ˜¯è¿™æ„æ€ã€‚

    è¯­æ³•: åªèƒ½é…ç½®åœ¨httpå—å†…
    map string $variable {...}
    

ç›´æ¥çœ‹è¿™ä¸ªè¯­æ³•å¥½åƒçœ‹ä¸å‡ºæ¥å®ƒèƒ½å¹²ä»€ä¹ˆï¼Œæ‰€ä»¥å®˜æ–¹æ–‡æ¡£ä¸Šç»™äº†å‡ ä¸ªä¾‹å­:

    map $http_host $name {
        hostnames;
    
        default       0;
    
        example.com   1;
        *.example.com 1;
        example.org   2;
        *.example.org 2;
        .example.net  3;
        wap.*         4;
    }
    

è§£æä¸€ä¸‹ä¸Šé¢ğŸ‘†è¿™ä¸ªä¾‹å­çš„æ„æ€ğŸ‘‡:

    map: å…³é”®å­—ï¼Œå¼€è¾Ÿä¸€æ®µå†…å­˜ç©ºé—´å£°æ˜ä¸€ä¸ªmap
    
    $http_host: è·å–hostè¯·æ±‚å¤´ï¼šeg: www.baidu.com
    
    $name: æ–°å˜é‡ï¼Œå…·ä½“å–å€¼æ˜¯ä»€ä¹ˆå–å†³äºç»“æ„ä½“å†…çš„æ˜ å°„å…³ç³»
    
    ç»“æ„ä½“å†…çš„æ•°æ®è§£æ:
        hostnames:
        - å®˜æ–¹æ–‡æ¡£ç»™å‡ºçš„è§£é‡Šæ˜¯ï¼šå…è®¸ç”¨å‰ç¼€æˆ–è€…åç¼€æ©ç æŒ‡å®šåŸŸåä½œä¸ºæºå˜é‡å€¼ã€‚è¿™ä¸ªå‚æ•°å¿…é¡»å†™åœ¨å€¼æ˜ å°„åˆ—è¡¨çš„æœ€å‰é¢ã€‚
    
        è¯»éƒ½èƒ½è¯»çš„æ‡‚ï¼Œå­—ä¹Ÿéƒ½è®¤è¯†ï¼Œä½†æ˜¯æ€ä¹ˆæ„Ÿè§‰å¥½åƒè¿˜æ˜¯ä¸å¤ªæ‡‚å‘¢ï¼Œåˆæ²¡æœ‰åŒæ„Ÿï¼Ÿäºæ˜¯æˆ‘æµ‹è¯•äº†ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯ä½ æƒ³ç”¨ä¸‹é¢é‚£ç§æ³›åŸŸåæ¥åŒ¹é…hostçš„è¯å°±åŠ ä¸€ä¸‹è¿™ä¸ªå‚æ•°ï¼Œ å¦åˆ™æ˜¯è¾¾ä¸åˆ°é¢„æœŸæ•ˆæœçš„ã€‚
    
        default 0; :åŒ¹é…ä¸åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®æ—¶ åˆ™$name è¿™ä¸ªå˜é‡å°±å–é»˜è®¤å€¼ 0
    

çŸ¥é“äº†è¿™ä¹‹åæˆ‘èƒ½ç”¨å®ƒæ¥åšä»€ä¹ˆå‘¢ï¼Ÿçœ‹å®é™…åº”ç”¨çš„ä¾‹å­

mapæŒ‡ä»¤çš„å®è·µä½¿ç”¨
----------

### 1\. åŸºäºcookieåšå¤šç¯å¢ƒåˆ†æµ

ä¸€èˆ¬ä¸­å¤§å‹å…¬å¸éƒ½ä¼šæœ‰å¤šå¥—æµ‹è¯•ç¯å¢ƒï¼Œå¯¹äºå¤šç¯å¢ƒçš„è®¿é—®å¯èƒ½æœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯å¯¹åº”å¤šä¸ªåŸŸåï¼Œè¿™æ–¹æ³•å½“ç„¶å¯ä»¥ï¼Œä½†æ˜¯ä¸ä¼˜é›…ï¼Œç»´æŠ¤å¤šä¸ªåŸŸåå¤ªç´¯ã€‚ä¸ºäº†å·æ‡’ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ªåŸŸåï¼Œä½¿ç”¨ä¸åŒçš„cookieæ¥è½¬å‘ç›¸åº”çš„æµé‡åˆ°ç›¸åº”çš„ç¯å¢ƒã€‚

å¦‚ä½•å®ç°ï¼Ÿ

        map $cookie_cl_env_num $cl_backend_map {
            default   1.1.1.1:80;
            dev-01    upstream_dev-01;
            dev-02    upstream_dev-02;
            dev-03    upstream_dev-03;
            test-01   upstream_test-01;
            test-02   upstream_test-02;
            test-03   upstream_test-03;
            test-04   upstream_test-04;
            test-05   upstream_test-05;
            test-06   upstream_test-06;
            test-07   upstream_test-07;
            test-08   upstream_test-08;
            test-09   upstream_test-09;
            test-10   upstream_test-10;
            test-11   upstream_test-11;
            test-12   upstream_test-12;
            test-13   upstream_test-13;
            test-14   upstream_test-14;
            test-15   upstream_test-15;
        }
    
        # éšä¾¿å†™ä¸€ä¸ª
        upstream upstream_test-14 {
            server 2.2.2.2:80;
        }
    
        # å±€éƒ¨å®ç°å†™ä¸€ä¸‹
        location / {
            pass_pass http://$cl_backend_map;
        }
    
        # è¯·æ±‚
        curl --cookie "cl_env_num=test-15" a.test.com/api/v1/hahaha
    

è¿™ä¸å°±å®ç°äº†å˜›ï¼Œå¾ˆæ–¹ä¾¿å“ˆã€‚ä»…æä¾›æ€è·¯ï¼å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–å˜é‡æ¥åˆ†æµ UA|args ...

### 2\. åšå®‰å…¨çš„å¤šåŸŸåè·¨åŸŸè®¿é—®

è·¨åŸŸè®¿é—®ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¼šç›´æ¥è®¾ç½® \* å…è®¸æ‰€æœ‰è·¨åŸŸè®¿é—®ã€‚ä½†æ˜¯éš¾å…ä¼šæœ‰ä¸€äº›å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„ä¸šåŠ¡ä¸å…è®¸è¿™æ ·ï¼Œé‚£ä¹ˆå¯¹äºåŸŸåæ¯”è¾ƒå¤šçš„å®‰å…¨è·¨åŸŸé…ç½®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨mapæ¥å®ç°ã€‚

    map $http_origin $allow_origin {
        ~http://www.baidu.com http://www.baidu.com;
        ~http://m.baidu.com   http://m.baidu.com;
        ~http://a.baidu.com   http://a.baidu.com;
        default               deny;
    }
    
    server {
        listen 80;
        server_name www.baidu.com;
    
        location / {
            ...
            add_header Access-Control-Allow-Origin $allow_origin;
            ...
        }
    }
    

ä»…æä¾›æ€è·¯å“ˆï¼Œå…·ä½“æƒ…å†µå¯ä»¥å†ä¼˜åŒ–

æ€»ç»“
--

å½“ç„¶è¿˜æœ‰å¾ˆå¤šåœºæ™¯éƒ½å¯ä»¥ç”¨åˆ°ï¼Œ æ— æ³•ä¸€ä¸€åˆ—ä¸¾ï¼Œ è‡ªå·±èƒ½å¤Ÿæ ¹æ®éœ€æ±‚å’Œåœºæ™¯çµæ´»è¿ç”¨æ˜¯æœ€å¥½çš„ã€‚