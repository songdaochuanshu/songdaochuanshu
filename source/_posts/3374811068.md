---
layout: post
title: "Liquibase-æ•°æ®åº“è„šæœ¬ç‰ˆæœ¬ç®¡ç†æ§åˆ¶"
date: "2022-09-10T14:18:32.045Z"
---
Liquibase-æ•°æ®åº“è„šæœ¬ç‰ˆæœ¬ç®¡ç†æ§åˆ¶
=====================

1\. ç®€ä»‹
------

[Liquibase](https://www.liquibase.com/)æ˜¯ä¸€ä¸ªç”¨äºè·Ÿè¸ªã€ç®¡ç†å’Œåº”ç”¨æ•°æ®åº“å˜åŒ–çš„å¼€æºçš„æ•°æ®åº“é‡æ„å·¥å…·ã€‚å®ƒå°†æ‰€æœ‰æ•°æ®åº“çš„å˜åŒ–ï¼ˆåŒ…æ‹¬ç»“æ„å’Œæ•°æ®ï¼‰éƒ½ä¿å­˜åœ¨XMLæ–‡ä»¶ä¸­ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶ã€‚

Liquibaseä½¿å‚ä¸åº”ç”¨ç¨‹åºå‘å¸ƒè¿‡ç¨‹çš„ä»»ä½•äººéƒ½å¯ä»¥è½»æ¾åœ°ï¼š

*   ä¸ä¾èµ–äºç‰¹å®šçš„æ•°æ®åº“ï¼ŒLiquibaseä¼šè‡ªåŠ¨é€‚é…ç›®æ ‡æ•°æ®åº“è¿›è¡Œè„šæœ¬åˆå§‹åŒ–ï¼Œç›®å‰æ”¯æŒè‡³å°‘30ç§ä¸»æµæ•°æ®åº“ã€‚
*   æä¾›æ•°æ®åº“æ¯”è¾ƒåŠŸèƒ½ï¼Œæ¯”è¾ƒç»“æœä¿å­˜åœ¨XMLä¸­ï¼ŒåŸºäºè¯¥XMLå¯ä»¥ç”¨Liquibaseè½»æ¾éƒ¨ç½²æˆ–å‡çº§æ•°æ®åº“ã€‚
*   ä»¥XMLè®°å½•/å­˜å‚¨æ•°æ®åº“å˜åŒ–ï¼Œå…¶ä¸­ä»¥`author`å’Œ`id`å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå˜åŒ–ï¼ˆChangSetï¼‰ï¼Œæ”¯æŒæ•°æ®åº“å˜åŒ–çš„åˆå¹¶ï¼Œå› æ­¤æ”¯æŒå¤šå¼€å‘äººå‘˜åŒæ—¶å·¥ä½œã€‚
*   åœ¨æ•°æ®åº“ä¸­ä¿å­˜æ•°æ®åº“ä¿®æ”¹å†å²ï¼ˆDatabaseChangeHistoryï¼‰ï¼Œåœ¨æ•°æ®åº“å‡çº§æ—¶è‡ªåŠ¨è·³è¿‡å·²åº”ç”¨çš„å˜åŒ–ï¼ˆChangSetï¼‰ã€‚
*   æä¾›å˜åŒ–åº”ç”¨çš„å›æ»šåŠŸèƒ½ï¼Œå¯æŒ‰æ—¶é—´ã€æ•°é‡æˆ–æ ‡ç­¾ï¼ˆtagï¼‰å›æ»šå·²åº”ç”¨çš„å˜åŒ–ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¼€å‘äººå‘˜å¯è½»æ˜“çš„è¿˜åŸæ•°æ®åº“åœ¨ä»»ä½•æ—¶é—´ç‚¹çš„çŠ¶æ€ã€‚
*   å¯ç”Ÿæˆæ•°æ®åº“ä¿®æ”¹æ–‡æ¡£ï¼ˆHTMLæ ¼å¼ï¼‰
*   æä¾›æ•°æ®é‡æ„çš„ç‹¬ç«‹çš„IDEå’ŒEclipseæ’ä»¶
*   å°†æ‰€æœ‰å˜åŒ–ï¼ˆåŒ…æ‹¬ç»“æ„å’Œæ•°æ®ï¼‰å­˜åœ¨XMLæ–‡ä»¶ä¸­ï¼Œä¾¿äºç‰ˆæœ¬æ§åˆ¶çš„å·¥å…·  
    springbootæ”¯æŒï¼Œåªéœ€è¦å¯¼å…¥ä¾èµ–ã€‚  
    application.ymlé…ç½®ï¼ˆå¯é€‰ï¼‰  
    ä¸é…ç½®ï¼Œé»˜è®¤å»resource/db/changelogä¸‹æ‰¾db.changelog-mastert.ymlæ–‡ä»¶

2\. Quick Start
---------------

**ä½¿ç”¨æ­¥éª¤**

*   step1: åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å˜æ›´æ—¥å¿—(change log)æ–‡ä»¶ã€‚
*   step2: åœ¨å˜æ›´æ—¥å¿—æ–‡ä»¶å†…éƒ¨åˆ›å»ºä¸€ä¸ªå˜æ›´é›†(change set)ã€‚
*   step3: é€šè¿‡å‘½ä»¤è¡Œæˆ–æ„å»ºè„šæœ¬å¯¹æ•°æ®åº“è¿›è¡Œå˜æ›´é›†ã€‚
*   step4: æ£€éªŒæ•°æ®åº“ä¸­çš„å˜æ›´

> é¢å‘springå¼€å‘ğŸ˜‰ï¼Œé€šè¿‡springboot æ•´åˆ liquibase äº†è§£å…¶ä½œç”¨ã€‚

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145723448-985450665.png)

### 2.1 æ·»åŠ mavenä¾èµ–

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.3.9.RELEASE</version>
        <relativePath/> <!-- lookup parent from repository -->
    </parent>
    
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        
        <dependency>
            <groupId>org.liquibase</groupId>
            <artifactId>liquibase-core</artifactId>
            <version>4.8.0</version>
        </dependency>
        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
        
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
    </dependencies>
    

### 2.2 application.yaml

    spring:
      datasource:
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://localhost:3306/test?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true
        username: root
        password: 123456
      liquibase:
        # æŒ‡å®šé…ç½®æ–‡ä»¶è·¯å¾„
        change-log: classpath:db/db.changelog-master.xml
        # è¦†ç›–æœ¬åœ° ddl dml
        drop-first: true
        # æ˜¯å¦å¯ç”¨
        enabled: true
        # è®°å½•ç‰ˆæœ¬æ—¥å¿—è¡¨
        database-change-log-table: databasechangelog
        # è®°å½•ç‰ˆæœ¬æ”¹å˜lockè¡¨
        database-change-log-lock-table: databasechangeloglock
    

### 2.3 æ·»åŠ  liquibase xml

`db.changelog-master.xml`

> liquibase é…ç½®æ–‡ä»¶å…¥å£ï¼Œä¸»è¦ç”¨æ¥å¼•ç”¨å…¶ä»–çš„`changelog.xml`ï¼Œå¦‚ä¸‹é…ç½®æ–‡ä»¶ä¸­çš„`include`ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨`includeAll`æ¥å¼•ç”¨æ•´ä¸ªç›®å½•

    <?xml version="1.0" encoding="UTF-8"?>
    <databaseChangeLog
            xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">
        <include file="classpath:db/changelog/changelog-init-0.0.1.xml"/>
    </databaseChangeLog>
    

`changelog-init-0.0.1.xml`

> ä¸»è¦è®°å½•äº†`ddl`çš„å˜åŒ–ä¿¡æ¯ï¼Œæ¯”å¦‚ å¦‚ä¸‹é…ç½®æ–‡ä»¶ä¸­åˆ›å»ºäº†ä¸¤ä¸ªè¡¨`role`å’Œ`user`

    <?xml version="1.1" encoding="UTF-8" standalone="no"?>
    <databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext" xmlns:pro="http://www.liquibase.org/xml/ns/pro" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-4.6.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">
        <changeSet author="ludangxin" id="1662615627445-2">
            <createTable tableName="role" remarks="è§’è‰²ä¿¡æ¯è¡¨">
                <column name="name" remarks="è§’è‰²åç§°" type="VARCHAR(255)"/>
                <column name="role_key" remarks="è§’è‰²key" type="VARCHAR(255)"/>
            </createTable>
        </changeSet>
        
        <changeSet author="ludangxin" id="1662615627445-3">
            <createTable tableName="user" remarks="ç”¨æˆ·ä¿¡æ¯è¡¨">
                <column name="id" type="INT" remarks="ä¸»é”®">
                    <constraints nullable="false" primaryKey="true"/>
                </column>
                <column name="username" type="VARCHAR(255)" remarks="ç”¨æˆ·åç§°"/>
                <column name="password" type="VARCHAR(255)" remarks="å¯†ç "/>
                <column name="age" type="INT" remarks="æ€§åˆ«"/>
                <column name="sex" type="VARCHAR(255)" remarks="æ€§åˆ«"/>
                <column name="role" type="VARCHAR(255)" remarks="è§’è‰²"/>
                <column name="create_time" type="DATETIME" defaultValueComputed="NOW()" remarks="åˆ›å»ºæ—¶é—´"/>
            </createTable>
        </changeSet>
    </databaseChangeLog>
    

### 2.4 å¯åŠ¨æµ‹è¯•

é¡¹ç›®å¯åŠ¨å®Œæˆåï¼ŒæŸ¥çœ‹æ•°æ®åº“å¦‚ä¸‹å›¾ï¼Œæˆ‘ä»¬åœ¨`changelog-init-0.0.1.xml`æ–‡ä»¶ä¸­å®šä¹‰çš„è„šæœ¬åˆå§‹åŒ–åˆ°äº†æ•°æ®åº“ä¸­

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145745505-501744643.png)

é€šè¿‡è¯¥demoå¿«é€Ÿçš„å®Œæˆäº†springboot é›†æˆ liquibaseï¼Œä¸”å®Œæˆæ•°æ®åº“çš„åˆå§‹åŒ–ã€‚

### 2.5 æµ‹è¯•changesetç‰ˆæœ¬æ§åˆ¶

> å‰ææ˜¯æˆ‘ä»¬å°†`application.yml`ä¸­çš„`drop-first`ç½®ä¸º`false`ï¼Œå› ä¸º`drop-first=true`ç›¸å½“äºæ¯æ¬¡éƒ½é‡ç½®æ•°æ®åº“

æ­¤æ—¶æˆ‘ä»¬æƒ³åœ¨userè¡¨ä¸­æ–°å¢ä¸€ä¸ª`create_by`å­—æ®µï¼Œä¾¿ç›´æ¥åœ¨ä¹‹å‰çš„changesetä¸­æ·»åŠ äº†å­—æ®µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç„¶åå¯åŠ¨é¡¹ç›®çœ‹ç»“æœ

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145820287-1147418847.png)

å¯åŠ¨æ—¶æ§åˆ¶å°æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š

> æŠ¥é”™ä¿¡æ¯æ˜¯æˆ‘ä»¬ç›´æ¥ä¿®æ”¹äº†changesetåå¯¼è‡´md5å€¼ä¸ä¹‹å‰çš„ä¸åŒ¹é…ï¼ˆç›´æ¥åœ¨ä¹‹å‰çš„changesetä¸­åšäº†ä¿®æ”¹ï¼‰

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145839040-1864870455.png)

ğŸ¤” liquibaseå¦‚ä½•åˆ¤æ–­ æ˜¯åŒä¸€changesetçš„ï¼Ÿ

â€‹ `author`å’Œ`id`å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå˜åŒ–ï¼ˆChangSetï¼‰

ğŸ¤” liquibaseæ˜¯å¦‚ä½•è¿›è¡Œchangesetç‰ˆæœ¬æ§åˆ¶çš„ï¼Ÿ

â€‹ `Liquibase`ä¼šå¯¹å·²ç»æ‰§è¡Œçš„`changelog`çš„æ¯ä¸€ä¸ª`changeSet`çš„å†…å®¹è¿›è¡Œ`md5`è®¡ç®—ï¼Œç”Ÿæˆçš„å€¼æ˜¯`databasechanglog`è¡¨çš„`MD5SUM`å­—æ®µã€‚

â€‹ å½“é‡æ–°å¯åŠ¨`Liquibase`æ—¶ï¼Œä¼šå¯¹æ¯ä¸ª`changeSet`è¿›è¡Œ`md5`å€¼è®¡ç®—ï¼Œä¸`databasechanglog`è¡¨ä¸­çš„`MD5SUM`å­—æ®µè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜`changeSet`å€¼å·²ç»è¢«ä¿®æ”¹ï¼Œæ— æ³•å¯åŠ¨æˆåŠŸã€‚

3\. DDLæ“ä½œ
---------

### 3.1 åˆ›å»ºè¡¨

    <changeSet author="ludangxin" id="20220908-1">
        <createTable tableName="order" remarks="è®¢å•ä¿¡æ¯è¡¨">
            <column name="id" remarks="ä¸»é”®" type="BIGINT">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="order_number" remarks="è®¢å•ç¼–å·" type="VARCHAR(255)"/>
            <column name="user_id" remarks="ç”¨æˆ·id" type="BIGINT"/>
        </createTable>
    </changeSet>
    

### 3.2 åˆ é™¤è¡¨

    <changeSet author="ludangxin" id="20220908-2">
        <dropTable tableName="order"/>
    </changeSet>
    

### 3.3 ä¿®æ”¹è¡¨

#### 3.3.1 æ·»åŠ å­—æ®µ

    <changeSet author="ludangxin" id="20220908-3">
        <addColumn tableName="order">
            <column name="status" remarks="è®¢å•çŠ¶æ€" type="INT" defaultValue="0"/>
        </addColumn>
    </changeSet>
    

#### 3.3.2 åˆ é™¤å­—æ®µ

    <changeSet author="ludangxin" id="20220908-4">
        <dropColumn tableName="order" columnName="order_number"/>
    </changeSet>
    

#### 3.3.3 ä¿®æ”¹å­—æ®µ

    <changeSet author="ludangxin" id="20220908-5">
        <renameColumn tableName="order" oldColumnName="status" newColumnName="state" columnDataType="VARCHAR(10)" remarks="è®¢å•çŠ¶æ€"/>
    </changeSet>
    

> ä¿®æ”¹å­—æ®µç±»å‹ ä¸å»ºè®®ä½¿ç”¨ å› ä¸ºä¼šæŠŠå­—æ®µçš„å…¶ä»–ä¿¡æ¯æä¸¢ï¼Œæ¯”å¦‚å­—æ®µæ³¨é‡Š

    <changeSet author="ludangxin" id="20220908-7">
        <modifyDataType tableName="order" columnName="state" newDataType="INT" />
    </changeSet>
    

4\. DMLæ“ä½œ
---------

4.1 æ•°æ®åˆå§‹åŒ–
---------

> é¡¹ç›®éƒ¨ç½²éš¾å…ä¼šæœ‰ç³»ç»Ÿå†…ç½®çš„æ•°æ®ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨liquibaseè¿›è¡Œåˆå§‹åŒ–

æ–°å»ºcsvæ–‡ä»¶`user-init-0.0.1.csv`

    "id","username","password","age","sex","role","create_time","create_by"
    "111","å¼ ä¸‰","222","23","1","admin","2022-09-08 14:22:33","system"
    "112","æå››","333","26","1","admin","2022-09-08 14:22:33","system"
    "113","ç‹äº”","444","25","1","admin","2022-09-08 14:22:33","system"
    

ä½¿ç”¨`loadData`æ ‡ç­¾è¿›è¡Œæ•°æ®çš„åˆå§‹åŒ–

    <changeSet author="ludangxin" id="20220908-8">
        <loadData tableName="user" file="data/user-init-0.0.1.csv" 
                  separator="," 
                  encoding="UTF-8" 
                  relativeToChangelogFile="true"/>
    </changeSet>
    

### 4.2 æ–°å¢æ•°æ®

    <changeSet author="ludangxin" id="20220908-6">
        <insert tableName="order">
            <column name="id" valueNumeric="666"/>
            <column name="user_id" value="2222"/>
            <column name="state" value="2"/>
        </insert>
        <insert tableName="order">
            <column name="id" valueNumeric="888"/>
            <column name="user_id" value="3333"/>
            <column name="state" value="1"/>
        </insert>
    </changeSet>
    

### 4.3 åˆå§‹åŒ–æ€»æ˜¯å˜åŠ¨çš„æ•°æ®

ä½¿ç”¨ä¸Šè¿°çš„`loadData`æ ‡ç­¾åŠ è½½æ•°æ®ï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œç›´æ¥ä¿®æ”¹csvæ–‡ä»¶è¿›è¡Œå‘å¸ƒæ—¶ï¼Œä¼šæŠ¥é”™ç‰ˆæœ¬ä¸ä¸€è‡´ã€‚

è¿™æ—¶å¯ä»¥ä½¿ç”¨`loadUpdateData`æ ‡ç­¾è¿›è¡Œå¤„ç†ï¼Œæ³¨æ„çš„æ˜¯`changeset`ä¸Šéœ€è¦åŠ å‚æ•°`runOnChange="true"`(å½“æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶ä¸å»æ ¡éªŒmd5)å¦‚ä¸‹

    <changeSet author="ludangxin" id="20220908-9" runOnChange="true">
        <loadUpdateData tableName="user" file="data/user-init-0.0.1.csv"
                  primaryKey="id"
                  separator=","
                  encoding="UTF-8"
                  relativeToChangelogFile="true"/>
    </changeSet>
    

5\. é›†æˆmaven
-----------

> ä½¿ç”¨mavené›†æˆliquibaseå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡liquibase maven plauginå®ç°å¾ˆå¤šåŠŸèƒ½ã€‚ä¾‹å¦‚ï¼šè„šæœ¬è¿è¡Œï¼Œç”Ÿæˆæ–‡æ¡£ï¼Œæ•°æ®åº“å·®å¼‚æ¯”è¾ƒç­‰

### 5.1 æ·»åŠ  properties

> æ·»åŠ properties æ–‡ä»¶ç”¨æ¥é…ç½®liquibase pluginçš„é…ç½®ä¿¡æ¯ã€‚ä¾‹å¦‚ æ•°æ®åº“çš„é“¾æ¥ä¿¡æ¯ï¼Œé…ç½®æ–‡ä»¶è·¯å¾„çš„é…ç½®ç­‰

`liquibase.properties`

    -- æ•°æ®åº“è¿æ¥ä¿¡æ¯
    driver=com.mysql.cj.jdbc.Driver
    url=jdbc:mysql://localhost:3306/test2?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true
    username=root
    password=123456
    -- liquibseç³»ç»Ÿè¡¨ è¡¨åç§°é…ç½®
    databaseChangeLogTableName=databasechangelog
    databaseChangeLogLockTableName=databasechangeloglock
    -- è¾“å‡ºæ–‡ä»¶è·¯å¾„é…ç½®
    outputChangeLogFile=src/main/resources/db/changelog/changelog-output-0.0.1.xml
    -- liuquibase xmlæ–‡ä»¶è·¯å¾„æŒ‡å®š
    changeLogFile=src/main/resources/db/db.changelog-master.xml
    

### 5.2 ä¿®æ”¹pom

    <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
        <modelVersion>4.0.0</modelVersion>
    
        <parent>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-parent</artifactId>
            <version>2.3.9.RELEASE</version>
            <relativePath/> <!-- lookup parent from repository -->
        </parent>
        
        <groupId>org.example</groupId>
        <artifactId>liquibase-demo2</artifactId>
        <version>1.0-SNAPSHOT</version>
    
        <properties>
            <liquibase.version>4.8.0</liquibase.version>
        </properties>
        
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-web</artifactId>
            </dependency>
    
            <dependency>
                <groupId>org.liquibase</groupId>
                <artifactId>liquibase-core</artifactId>
                <version>${liquibase.version}</version>
            </dependency>
    
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-jdbc</artifactId>
            </dependency>
    
            <dependency>
                <groupId>mysql</groupId>
                <artifactId>mysql-connector-java</artifactId>
            </dependency>
        </dependencies>
        
        <build>
            <pluginManagement>
                <plugins>
                    <plugin>
                        <groupId>org.liquibase</groupId>
                        <artifactId>liquibase-maven-plugin</artifactId>
                        <version>${liquibase.version}</version>
                    </plugin>
                </plugins>
            </pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.liquibase</groupId>
                    <artifactId>liquibase-maven-plugin</artifactId>
                    <configuration>
                        <!--propertiesæ–‡ä»¶è·¯å¾„ï¼Œè¯¥æ–‡ä»¶è®°å½•äº†æ•°æ®åº“è¿æ¥ä¿¡æ¯ç­‰-->
                     <propertyFile>src/main/resources/db/liquibase.properties</propertyFile>
                        <propertyFileWillOverride>true</propertyFileWillOverride>
                    </configuration>
                </plugin>
            </plugins>
        </build>
    </project>
    

6\. plugin-é€†å‘ç”Ÿæˆxml
------------------

> é€šè¿‡liquibase maven æ’ä»¶ï¼Œä»å·²æœ‰çš„æ•°æ®åº“ç”Ÿæˆxmlé…ç½®ä¿¡æ¯

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145857558-1312541440.png)

é€šè¿‡ideaçš„mavenåŠŸèƒ½ï¼Œæ‰¾åˆ° liquibase pluginï¼ŒåŒå‡»å¦‚å›¾`liquibase:generateChangeLog`é€‰é¡¹ï¼Œæ‰§è¡Œå®Œæˆä¹‹åå°±ä¼šåœ¨`properties`æ–‡ä»¶ä¸­é…ç½®çš„`outputChangeLogFile`è·¯å¾„ç”Ÿæˆå¯¹åº”çš„xmlæ–‡ä»¶ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145917602-1709465670.png)

7\. plugin-ç”Ÿæˆæ•°æ®åº“ä¿®æ”¹æ–‡æ¡£
--------------------

åŒå‡»liquibase pluginé¢æ¿ä¸­çš„`liquibase:dbDoc`é€‰é¡¹ï¼Œä¼šç”Ÿæˆæ•°æ®åº“ä¿®æ”¹æ–‡æ¡£ï¼Œé»˜è®¤ä¼šç”Ÿæˆåˆ°`target`ç›®å½•ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145935059-2067745518.png)

è®¿é—®`index.html`ä¼šå±•ç¤ºå¦‚ä¸‹é¡µé¢ï¼Œç®€ç›´åº”æœ‰å°½æœ‰

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910145953061-410172191.png)

8\. plugin-å‘å¸ƒchangelog
----------------------

> ä¹‹å‰æˆ‘ä»¬å¯¹changelogçš„ç¼–è¾‘éƒ½éœ€è¦é€šè¿‡å¯åŠ¨é¡¹ç›®æ¥è¿è¡Œchangelogï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½æƒ³ä¸é‡å¯é¡¹ç›®ä¾¿èƒ½å°†ä¿®æ”¹å‘å¸ƒè¿è¡Œåˆ°æ•°æ®åº“ä¸­

åŒå‡»liquibase pluginé¢æ¿ä¸­çš„`liquibase:update`é€‰é¡¹ï¼Œä¾¿å¯ä»¥å°†ä¿®æ”¹åŒæ­¥åˆ°æ•°æ®åº“ä¸­

**æ³¨ï¼š**è¿™é‡Œæœ‰ä¸ªbugï¼ˆä¹Ÿå¯èƒ½ä¸æ˜¯bugï¼Œæˆ‘ç›®å‰è¿˜æ²¡æ‰¾åˆ°å¯¹åº”çš„è§£å†³åŠæ³•ï¼Œå¦‚æœæ‚¨æœ‰è§£å†³æ–¹æ¡ˆï¼ŒğŸ™ï¼‰ï¼Œé€šè¿‡`plugin`å‘å¸ƒ`changelog`æ—¶ï¼Œç”±äºæˆ‘ä»¬åœ¨`db.changelog-master`ä¸­`include`çš„æ˜¯`classpath`è·¯å¾„ï¼Œä½†æ˜¯é€šè¿‡`plugin`å‘å¸ƒæ—¶ä¼šæŠ¥é”™æ‰¾ä¸åˆ°`include`çš„xmlæ–‡ä»¶ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®ç›¸å¯¹è·¯å¾„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚`<include file="classpath:changelog/changelog-init-0.0.1.xml" relativeToChangelogFile="true"/>`ï¼Œç„¶è€Œè¿™åˆå¼•å‘äº†å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œ`plugin`å’Œç›´æ¥å¯åŠ¨springbooté¡¹ç›®ç”Ÿæˆçš„`databasechangelogè¡¨ä¸­çš„filenameå­—æ®µå€¼`ä¸åŒï¼Œå¯¼è‡´è¿è¡Œ`changelog`æ—¶æŠ¥é”™ï¼Œå› ä¸ºliquibaseé»˜è®¤ä¼šæ¯”è¾ƒåŒä¸€`filename`ä¸‹çš„`changeset`

9\. plugin-æ¯”è¾ƒæ•°æ®åº“å·®å¼‚
------------------

é¦–å…ˆä½¿ç”¨liquibase diff åŠŸèƒ½å‰ï¼Œæˆ‘ä»¬åœ¨propertiesä¸­åŠ å…¥`å‚è€ƒçš„æ•°æ®åº“ test3`é…ç½®ä¿¡æ¯

> ç”¨äºå·®å¼‚æ¯”è¾ƒçš„æ•°æ®åº“ï¼Œä»¥æ­¤æ•°æ®åº“ä¸ºå‡†ï¼Œç”Ÿæˆdiff xml

    # å¯¹æ¯”å‚è€ƒçš„æ•°æ®åº“ä¿¡æ¯ ï¼ˆç”¨äºplugin-diffï¼‰        
    referenceUrl=jdbc:mysql://localhost:3306/test3?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true
    referenceDriver=com.mysql.cj.jdbc.Driver
    referenceUsername=root
    referencePassword=123456
    # ç”Ÿæˆçš„å·®å¼‚æ¯”è¾ƒxmlçš„è¾“å‡ºè·¯å¾„
    diffChangeLogFile=src/main/resources/db/changelog/changelog-diff-0.0.1.xml
    

æˆ‘ä»¬å…ˆè§‚å¯Ÿä¸‹ä¸¤ä¸ªæ•°æ®åº“æœ‰ä»€ä¹ˆæ ·çš„å·®å¼‚ï¼Œå†éªŒè¯ç”Ÿæˆçš„diff xml

ä¸¤ä¸ªæ•°æ®åº“å¦‚ä¸‹ï¼Œå·®å¼‚éƒ½ç”¨çº¢è‰²æ¡†èµ·æ¥äº†ã€‚

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910150006977-1569734449.png)

ç„¶åå†ç”¨liquibaseæ’ä»¶çœ‹ä¸‹ç”Ÿæˆçš„ diff xmlä¿¡æ¯

åŒå‡»liquibase pluginé¢æ¿ä¸­çš„`liquibase:diff`é€‰é¡¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910150023500-2079560836.png)

æ‰§è¡Œå®Œæ¯•åï¼ŒæŸ¥çœ‹diff xml å†…å®¹å¦‚ä¸‹ï¼š

> ç”Ÿæˆçš„xmlæ–‡ä»¶ç¬¦åˆé¢„æœŸï¼Œå°†ä¸test3æ•°æ®åº“çš„å·®å¼‚éƒ½ç”Ÿæˆåˆ°äº†diff xmlä¸­

![](https://img2022.cnblogs.com/blog/1759273/202209/1759273-20220910150041538-709594558.png)