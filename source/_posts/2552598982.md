---
layout: post
title: "HCNP Routing&Switching之DHCP中继"
date: "2022-07-24T19:15:53.941Z"
---
HCNP Routing&Switching之DHCP中继
=============================

![HCNP Routing&amp;Switching之DHCP中继](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724152028642-1508267631.png) DHCP中继，顾名思义就是中继DHCP服务，使得DHCP能够跨多个广播域进行ip地址分配；我们知道DHCP默认是工作在一个广播域内，为一个广播域内的主机进行ip地址分配；DHCP信息以广播为主，路由器默认就是不转发广播，所以我们想要实现跨多个广播域或者路由器使用DHCP分配ip地址，我们就必须要在路由器或三层设备上开启dhcp中继；这里的DHCP中继就有点类似中间商代理；其主要作用就是代理dhcp，实现dhcp能够工作在更多的广播域，为更多网段的主机分配ip地址；

　　前文我们聊了下BFD相关话题，回顾请参考[https://www.cnblogs.com/qiuhom-1874/p/16487842.html](https://www.cnblogs.com/qiuhom-1874/p/16487842.html)；今天来聊一聊DHCP中继相关话题；

　　DHCP的作用

　　DHCP（Dynamic Host Configure Protocol，动态主机配置协议）是应用层协议，使用UDP封装，服务端工作在UDP的67号端口，客户端工作在68号端口；它是BOOTP（Bootstrap Protocol）协议发展而来；主要作用是动态分配TCP/IP信息（ip地址，子网掩码，网关，DNS等等），减轻管理员管理ip地址的工作；

　　DHCP中继的作用

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724150750070-691785837.png)

　　提示：随着网络规模的扩大，网络中就会出现用户处于不断网段的情况，那么不同网段的主机怎么来分配ip地址呢？上述两个方式DHCP部署方式都可以实现，但推荐使用第二种DHCP 中继；第一种方式虽然可以，但是很浪费服务器，没有必要；

　　DHCP中继，顾名思义就是中继DHCP服务，使得DHCP能够跨多个广播域进行ip地址分配；我们知道DHCP默认是工作在一个广播域内，为一个广播域内的主机进行ip地址分配；DHCP信息以广播为主，路由器默认就是不转发广播，所以我们想要实现跨多个广播域或者路由器使用DHCP分配ip地址，我们就必须要在路由器或三层设备上开启dhcp中继；这里的DHCP中继就有点类似中间商代理；其主要作用就是代理dhcp，实现dhcp能够工作在更多的广播域，为更多网段的主机分配ip地址；

　　DHCP Relay基本工作原理

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724151148768-529573985.png)

　　提示：DHCP客户端到dhcp中继的过程，同我们之前学习的DHCP客户端到dhcp服务器的过程一样；有了dhcp中继，此时客户端和服务器的通信都会经过中继来进行转发；我们可以理解为DHCP中继就是dhcp服务器的反向代理（个人理解），即客户端向中继发送请求，就相当于在像DHCP服务器发送请求一样；中继到服务器之间的通信全是单播；有关DHCP通信过程的描述，请参考本人博客[https://www.cnblogs.com/qiuhom-1874/p/15147870.html](https://www.cnblogs.com/qiuhom-1874/p/15147870.html)；

　　DHCP Relay配置

 　　实验

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724153525356-625962167.png)

　　环境说明，用一个路由器来模拟DHCP服务器，现网中如果网络规模较大建议使用专用的服务器搭建DHCP服务；用一个三层交换机来中继DHCP；中继到服务器中间使用192.168.12.0/24网段，客户端有两个VLAN，分别是vlan10，分配地址为172.16.10.0/24和vlan20，分配172.16.20.0/24；

　　DHCP服务器的配置

　　1、在R1上配置相关接口ip地址，并全局开启dhcp服务

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724153858628-990951715.png)

 　　2、创建全局地址池

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724160323353-464936679.png)

　　3、关联接口和全局地址池

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724154700380-345285624.png)

　　提示：这里必须选择全局地址池，不能关联接口；

　　除了上述正常配置dhcp服务以外，我们这里还需要新建两条静态路由（服务器到分配出去的地址的路由）

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724155104751-1062360519.png)

　　ok，到此dhcp服务器的配置就完成了；接下来配置交换机

　　配置交换机的基本vlan，ip地址

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724160554758-780119678.png)

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724160739371-1389412443.png)

　　验证：ping dhcp服务器看看能不能正常ping通？

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724160806577-1805456194.png)

　　提示：可以看到现在交换机和路由器是通了；

　　路由器ping 交换机vlanif10 和vlanif20的地址，看看是否通？

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724160942319-1893984562.png)

　　提示：可以看到都可以正常通信；

　　在交换机上配置DHCP中继

 　　1、全局开启dhcp功能

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724161445419-1507596130.png)

　　2、创建dhcp服务器组

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724161601053-1806448449.png)

　　3、在服务器组里添加服务器

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724161655733-2072484795.png)

　　提示：这里的服务器可以添加多个，后面的ip地址就是服务器的ip地址；

　　4、开启DHCP中继功能，并选择对应服务器组

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724162316124-1158876751.png)

　　提示：这里选择服务器组就是我们之前建立的组名即可；到此dhcp中继就配置完毕了；

　　验证：在vlan10的主机上抓包，获取ip

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724162619662-1696803777.gif)

　　提示：可以看到现在vlan10的主机能够正常获取到vlan10地址池里的ip地址以及我们指定的网关；

　　在交换机上抓包，开启vlan20里主机dhcp获取ip地址

![](https://img2022.cnblogs.com/blog/1503305/202207/1503305-20220724163608535-408442997.gif)

　　提示：可以看到vlan20里的主机首先将discrover信息广播发送出去，然后再又vlanif20接口将对应信息转发给dhcp服务器；同样的道理服务器的offer信息也会经由对应的vlanif 20接口再转发给客户端；客户端的request消息和服务器的ack消息都会经由中继然后传达给对方；在客户端看来中继就好比服务器，在服务器看来中继就好比客户端；

　　验证：在服务器上查看已分配的ip地址

<R1>dis ip pool name vlan10 used 
  Pool-name      : vlan10
  Pool-No        : 0
  Lease          : 1 Days 0 Hours 0 Minutes
  Domain-name    : -
  DNS-server0    : -               
  NBNS-server0   : -               
  Netbios-type   : -               
  Position       : Local           Status           : Unlocked
  Gateway-0      : 172.16.10.254   
  Mask           : 255.255.255.0
  VPN instance   : --
 -----------------------------------------------------------------------------
         Start           End     Total  Used  Idle(Expired)  Conflict  Disable
 -----------------------------------------------------------------------------
     172.16.10.1   172.16.10.254   253     1        252(0)         0        0
 -----------------------------------------------------------------------------

  Network section : 
  --------------------------------------------------------------------------
  Index              IP               MAC      Lease   Status  
  --------------------------------------------------------------------------
    252   172.16.10.253    5489-98dd-05a8       1039   Used       
  --------------------------------------------------------------------------
                                          
<R1>dis ip pool name vlan20 used 
  Pool-name      : vlan20
  Pool-No        : 1
  Lease          : 1 Days 0 Hours 0 Minutes
  Domain-name    : -
  DNS-server0    : -               
  NBNS-server0   : -               
  Netbios-type   : -               
  Position       : Local           Status           : Unlocked
  Gateway-0      : 172.16.20.254   
  Mask           : 255.255.255.0
  VPN instance   : --
 -----------------------------------------------------------------------------
         Start           End     Total  Used  Idle(Expired)  Conflict  Disable
 -----------------------------------------------------------------------------
     172.16.20.1   172.16.20.254   253     1        252(0)         0        0
 -----------------------------------------------------------------------------

  Network section : 
  --------------------------------------------------------------------------
  Index              IP               MAC      Lease   Status  
  --------------------------------------------------------------------------
    252   172.16.20.253    5489-98b9-365e        453   Used       
  --------------------------------------------------------------------------
                                          
<R1>

　　提示：可以看到在服务端能够正常看到对应地址池中分配出去的ip地址；

作者：[Linux-1874](https://www.cnblogs.com/qiuhom-1874/)

出处：[https://www.cnblogs.com/qiuhom-1874/](https://www.cnblogs.com/qiuhom-1874/)

本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.