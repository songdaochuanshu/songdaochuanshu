---
layout: post
title: "express ä¸ºæ‰€æœ‰è·¯ç”±æ·»åŠ  405 method not allowd å“åº”"
date: "2022-12-07T13:23:47.404Z"
---
express ä¸ºæ‰€æœ‰è·¯ç”±æ·»åŠ  405 method not allowd å“åº”
========================================

![express ä¸ºæ‰€æœ‰è·¯ç”±æ·»åŠ  405 method not allowd å“åº”](https://img2023.cnblogs.com/blog/1043209/202212/1043209-20221207205908732-1201930963.png) Expressjs å†…ç½®ä¸æ”¯æŒ HTTP 405 å“åº”ï¼Œè¯¥å¦‚ä½•ä¸ºè·¯ç”±æ·»åŠ è¿™ä¸€ä¸ªæ”¯æŒå‘¢...

èƒŒæ™¯çŸ¥è¯†
----

### HTTP Status Code `405`

> 405 Method not allowed  
> The resource was requested using a method that is not allowed. For example, requesting a resource via a POST method when the resource only supports the GET method.

`405` å“åº”æ„å‘³ç€è¿™ä¸ªè·¯ç”±å­˜åœ¨ï¼Œä½†æ˜¯è¯·æ±‚çš„æ–¹æ³•ä¸æ”¯æŒã€‚

### HTTP Response Header `Allow`

> Valid actions for a specified resource. To be used for a 405 Method not allowed  
> Allow: GET, HEAD

HTTP å“åº”å¤´ `Allow` ä¸»è¦æ˜¯é…åˆ `405` å“åº”ä¸€èµ·ä½¿ç”¨ï¼Œç”¨äºå‘Šè¯‰å®¢æˆ·ç«¯æ­¤è·¯ç”±æ”¯æŒçš„ HTTP æ–¹æ³•ã€‚

èµ·å› 
--

æœ€è¿‘åœ¨ä½¿ç”¨ [Expressjs](https://expressjs.com/) å¼€å‘ Restful APIï¼Œå‘ç°å…¶å†…ç½®æ²¡æœ‰å¯¹ HTTP 405 å“åº”çš„æ”¯æŒï¼Œå¯¹äºæœ‰è·¯ç”±ä½†æœªå®šä¹‰çš„ ç›¸åº” HTTP method å¤„ç†æ–¹æ³•çš„è¯·æ±‚å…¶ä¼šå“åº” 404 é”™è¯¯(express-generator ç”Ÿæˆçš„ä»£ç é»˜è®¤è¡Œä¸ºæ˜¯è¿™æ ·)ï¼Œè¿™æ˜¾ç„¶ä¸åˆ©äºæˆ‘ä»¬æ’é”™ï¼Œä¹Ÿä¸ç¬¦åˆ HTTP çŠ¶æ€ç çš„è¯­ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ºå…¶å¢åŠ  HTTP å“åº” `405` æ”¯æŒã€‚

é’ˆå¯¹å•ä¸ª router çš„å¿«é€Ÿå®ç°
-----------------

å¯¹äºæŸä¸€ä¸ª routerï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°åœ¨è·¯ç”±å¤„ç†æ–¹æ³•æœ€åå¢åŠ ä¸€ä¸ªæ–¹æ³•æ¥æ”¯æŒ 405 å“åº”ï¼Œå®ç°æ¯”è¾ƒç®€å•ï¼š

    import { Router } from 'express'
    
    const router = new Router()
    const getAll = (req, res, next) => {}
    const createNew = (req, res, next) => {}
    
    router.route('/resource')
      .get(getAll)
      .post(createNew)
      .all(function support405Response (req, res, next) {
        res.set('Allow', 'GEt, POST')
        res.status(405).send('Method Not Allowed')
      })
    

å®ç°ä¸€ä¸ªé€šç”¨æ–¹æ¡ˆ
--------

### router çš„ç»“æ„

ä¸ºæŸä¸€ä¸ª router å¢åŠ  `405` å“åº”æ”¯æŒå¾ˆç®€å•ï¼Œä½†æ˜¯è‹¥æœ‰å¾ˆå¤šä¸ª routerï¼Œæ¯ä¸ªéƒ½å»æ‰‹åŠ¨æ’°å†™å¤ªéº»çƒ¦äº†ï¼Œæœ€å¥½æ˜¯æœ‰ä¸ªæ–¹æ³•èƒ½è‡ªåŠ¨åŒ…è£…ã€‚  
å¯ä»¥å°† router æ‰“å°å‡ºæ¥ï¼Œåˆ†æä¸€ä¸‹ router çš„ç»“æ„ï¼Œè¿™é‡Œä»¥å¦‚ä¸‹ router å®šä¹‰ä¸ºä¾‹ï¼š

    // çœç•¥æ— å…³ä»£ç ...
    const router = new Router()
    
    router.route('/')
      .get(getAll)
      .post(createNew)
    
    router.route('/:id')
      .get(getOne)
      .patch(updateOne)
      .delete(deleteOne)
    

ä¸Šé¢ router çš„æ‰“å°ç»“æœå¦‚ä¸‹ï¼š

    {
      params: {},
      _params: [],
      caseSensitive: undefined,
      mergeParams: undefined,
      strict: undefined,
      stack: [
        Layer {
          handle: [Function: bound dispatch],
          name: 'bound dispatch',
          params: undefined,
          path: undefined,
          keys: [],
          regexp: /^\/?$/i,
          route: [Route]
        },
        Layer {
          handle: [Function: bound dispatch],
          name: 'bound dispatch',
          params: undefined,
          path: undefined,
          keys: [Array],
          regexp: /^\/(?:([^\/]+?))\/?$/i,
          route: [Route]
        }
      ]
    }
    

### router.stack ä¸‹ layer çš„ route

è§‚å¯Ÿå‘ç°ï¼Œ`stack` å±æ€§æ•°ç»„ä¸‹æ¯ä¸ª Layer æœ‰ä¸å°‘ä¿¡æ¯ï¼Œä½†æœ‰å¸®åŠ©çš„è¿˜æ˜¯å¤ªå°‘ã€‚å†æŠŠæ¯ä¸ª Layer çš„ route æ‰“å°å‡ºæ¥çœ‹çœ‹ï¼š

    [
      Route {
        path: '/',
        stack: [ [Layer], [Layer] ],
        methods: { get: true, post: true }
      },
      Route {
        path: '/:id',
        stack: [ [Layer], [Layer], [Layer], [Layer], [Layer] ],
        methods: { _all: true, get: true, patch: true, delete: true }
      }
    ]
    

å—¯å—¯ï¼Œè¿™ä¸‹æœ‰ä¸å°‘æœ‰ç”¨çš„å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ä¿¡æ¯ã€‚å¼€å§‹ç€æ‰‹å®ç°ä¸€ä¸ªé€šç”¨çš„ä¸ºæ‰€æœ‰ router å¢åŠ  `405` å“åº”çš„æ–¹æ³•ã€‚

### ä¸ºæ‰€æœ‰ router æ·»åŠ  405 å“åº”

    export default function add405ResponseToRouter (router) {
      const routes = router.stack.map(layer => layer.route)
    
      for (const route of routes) {
        const {
          path,
          methods
        } = route
    
        router.route(path)
          .all(function methodNotAllowed (req, res, next) {
            res.set('Allow', Object.keys(methods).filter(method => method !== '_all').map(method => method.toUpperCase()).join(', '))
            res.status(405).send('Method Not Allowed')
          })
      }
    
      return router
    }
    

ç”¨ä¸Šé¢å®ç°çš„è¿™ä¸ªæ–¹æ³•å»åŒ…è£…æˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ routerï¼Œè¯·æ±‚ `/:id` çš„å®é™…æ•ˆæœï¼š  
![image](https://img2023.cnblogs.com/blog/1043209/202212/1043209-20221207210628863-2143191858.png)

* * *

![image](https://img2023.cnblogs.com/blog/1043209/202212/1043209-20221207205921527-608083237.jpg)

æ–‡å®Œæ’’èŠ±ğŸ‰ï¼æ„Ÿè°¢è§‚çœ‹ğŸ‘ï¼