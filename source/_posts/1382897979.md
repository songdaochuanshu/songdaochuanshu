---
layout: post
title: "6 分钟看完 BGP 协议。"
date: "2022-07-04T07:20:12.473Z"
---
6 分钟看完 BGP 协议。
==============

上一篇文章见 [万字长文爆肝路由协议！](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247496972&idx=1&sn=fa73c2e35ae34f3e0a8f0055cd78825c&chksm=e99a001edeed890883feda823a31dbb537461de86f33b14a00c271a1b0bf097ead0905e5fe0a&token=1487155626&lang=zh_CN#rd)

上面我们聊 RIP 、OSPF 协议都是基于 AS 即自治系统内的协议，可以把它们认为是域内路由协议；而下面我们要聊的就是 AS 之间的协议了，这也叫做**域间路由协议**，或者叫做外部网关协议，其最著名的一个协议就是 **BGP**协议，目前使用最多的协议版本就是 BGP 的第四个版本 BGP - 4，简称为 BGP ( Border Gateway Protocol )。

在 RIP 和 OSPF 这些协议中，是由 IP 的网络地址进行路由控制，而 BGP 协议则需要通过整个互联网进行路由控制，范围要大很多。

BGP 的环境与 RIP、OSPF 的环境不一样，主要在于互联网的规模过于庞大， 使得自治系统之间的路由选择比较困难。互联网上的路由器对任何 IP 地址都能通过路由表找到它的目的网络。这是一个非常庞大的集合，如果使用链路状态协议 RIP 和 OSPF 的话，必须要维护一个非常大的了路由集合，一方面路由表检索起来效率很低，而且如此庞大的数据项也不方便维护。还有一点是每个路由器的 metric 不一样，有可能这个 metric 是经过了 100 个路由，而那个链路到达 100 个路由可能就直接报错了。

而且自治系统间的路由选择必须考虑策略问题，这些策略需要把政治、地缘、安全或者经济方面考虑在内。

由于上面这些特殊情况的存在，BGP 协议只是满足选择一条到达目的网络比较好的路由，而非选择一条最佳路由，BGP 采用了**路径向量路由选择协议**，它与 RIP 和 OSPF 有很大的差别。

在 BGP 协议中，每个 AS 自治系统内部都有许多 **BGP 边界路由器**，这个 BGP 边界路由器就相当是自治系统内部的发言人。不同 AS 之间的 BGP 边界路由器如果要交换路由信息的话，就需要先建立 TCP 连接，然后在此连接上交换 BGP 报文以建立 BGP 会话，通过 TCP 能够提供可靠的服务。两个交换报文的 BGP 边界路由器都被称为彼此的临站（天使）或者对等站。

下图是一个使用了 BGP 边界路由器和 AS 的关系示意图：

![image-20220607204710359](https://tva1.sinaimg.cn/large/e6c9d24ely1h2zyxwt68ej21820u0did.jpg)

图 14-18

BGP 所交换的网络可达性信息就是要到达某个网络所要经过的一系列的路由。当各个 BGP 边界路由器一旦交换了可达性信息之后，就会选择出来一条到达各个 AS 比较好的路由路径。

BGP 支持无分类域间路由选择 CIDR，因此 BGP 的路由表也就应当包括当前目的网络前缀、下一跳路由器，以及到达目的网络所经过的 AS 。

在 BGP 刚刚运行时，BGP 的临站是交换整个 BGP 路由表，以后只要在发生变化时更新有新变化的部分即可。这样对节省网络带宽和减少路由器开销有很大好处，这个特性和 OSPF 非常相似。

BGP - 4 主要有下面几类报文类型：

*   OPEN ( 打开 )报文，用来和相邻的 BGP 区域边界路由器建立关系，进行通信初始化。
*   UPDATE ( 更新 ) 报文，用来通告路由信息，以及列出需要更新的多条路由。
*   KEEPALIVE ( 保活 ) 报文，用来周期性的证实临站的连通性。
*   NOTIFICATION ( 通知 ) 报文，用来发送检测到的差错。

如果两个临站属于两个不同的自治系统，而且其中一个临站打算和其他临站进行路由交换的时候，这时候应当有一个路由商量的过程。商量的过程包括临站路由器是否还能够接受额外的路由信息。因此一开始进行商谈的时候应该要先发送 OPEN 报文，如果临站可以接受这种关系，就用 KEEPALIVE 报文响应。响应完成后，两个临站就算是建立关系了。

关系建立之后，是需要相互维持的，这就和情侣之间确定关系之后，你作为老爷们总不能三天两头不搭理人家吧？俗话说的好，感情是需要维持的，那么这个路由关系也是需要维持的。通信双方中的每一方都需要确信对方是否已经存在，因此两个 BGP 边界路由器需要定期交换 KEEPALIVE 报文，一般这个定期的时间就是 30 s。

BGP 边界路由器可以使用 UPDATE 报文来更新路由：包括撤掉以前通知过的路由和增加新的路由。撤销路由时一次可以撤销多条，但是新增路由一个 UPDATE 报文只能增加一条。

当然在 BGP 中不存在 "好消息传播的快坏消息传播慢" 的问题( 感觉 RIP 的这个问题被玩出梗了 )。因为 BGP 边界路由器不只有一个，而且当某个路由器或者链路出现故障时，由于 BGP 边界路由器可以不止从一个临站获得路由信息，因此很容易选出新的路由。

下面是 BGP 的报文格式：

![image-20220607204724906](https://tva1.sinaimg.cn/large/e6c9d24ely1h2zyy4ebivj214e0u075y.jpg)

图 14-19

上面介绍的四种报文类型它们具有通用的报文首部，首部为 19 字节，通用首部主要分为三个字段。

*   标记 marker 字段为 16 字节长，用来鉴别收到的 BGP 报文，如果不使用鉴别，标记字段要置为全 1。
*   长度字段指出包括通用首部在内的整个 BGP 报文的长度，以字节为单位，最小值是 19，最大值是 4096.
*   类型字段的值为 1 到 4，分别对应上面报文的介绍顺序。

**OPEN**报文共有 6 个字段，如下图抓包所示

![image-20220605080629139](https://picturesforarticle.oss-cn-beijing.aliyuncs.com/img/image-20220605080629139.png)

图 14-20

前三个字段是 BGP 通用报文首部，下面的几个字段依次是 Version 版本 ( 1 字节，值为 4 )， My AS 本自治系统号( 2 字节，使用的是全球唯一的 16 位系统号 ) ， Hold Time 保持时间 ( 2 字节，以秒计算的保持为临站关系的时间 )，BGP Identifier BGP 标识符 ( 4 字节，路由器的 IP 地址 )，下面是可选长度和可选参数。

**KEEPALIVE** 报文只有 BGP 19 字节的通用首部。

![image-20220605080701943](https://picturesforarticle.oss-cn-beijing.aliyuncs.com/img/image-20220605080701943.png)

图 14-21

**UPDATE** 报文有五个字段，如下图所示

![image-20220605080906081](https://picturesforarticle.oss-cn-beijing.aliyuncs.com/img/image-20220605080906081.png)

图 14-22

报文中的 Unfeasible routes length 表示不可行路由长度，后面有个字段报文没有列出来，就是 Withdrawn Routes ，要撤销的路由列表，后面的 Total Path Attribute Length 表示路径属性总长度，后面的 Path attributes 就表示路径属性，最后的 NLRI 标识发出这个报文的网络。

**NOTIFICATION** 报文有三个字段，如下图所示

![image-20220605080711723](https://picturesforarticle.oss-cn-beijing.aliyuncs.com/img/image-20220605080711723.png)

图 14-23

主要包括差错代码 ( 1 字节 )，差错子代码 ( 1 字节 ) ，后面还有差错数据。

原文链接：[6 分钟看完 BGP 协议。](https://mp.weixin.qq.com/s?__biz=MzI0ODk2NDIyMQ==&mid=2247497363&idx=1&sn=76c8fda967d4035cf97223cf313069b0&chksm=e99a0381deed8a97db6586c26c3ac8e1e9fbc7ac8e35f0b2786263c9e91796ef8d9389c08d52&token=1487155626&lang=zh_CN#rd)

作者：[cxuan](https://www.cnblogs.com/cxuanBlog/)  
出处：[https://www.cnblogs.com/cxuanBlog/](https://www.cnblogs.com/cxuanBlog/)  
本文版权归作者和博客园共有，未经作者允许不能转载，转载需要联系微信: becomecxuan，否则追究法律责任的权利。  
如果文中有什么错误，欢迎指出。以免更多的人被误导。