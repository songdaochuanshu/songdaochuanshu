---
layout: post
title: "ç»†èŠ.Net Coreä¸­IServiceScopeçš„å·¥ä½œæ–¹å¼"
date: "2022-10-17T06:54:23.676Z"
---
ç»†èŠ.Net Coreä¸­IServiceScopeçš„å·¥ä½œæ–¹å¼
==============================

### å‰è¨€

Â Â Â Â è‡ªä».Net Coreå¼•å…¥IOCç›¸å…³çš„ä½“ç³»ä¹‹åï¼Œå…³äºå®ƒçš„è®¨è®ºå°±ä»æ¥æ²¡æœ‰åœæ­¢è¿‡ï¼Œå› ä¸ºå®ƒæ˜¯.Net Coreä½“ç³»çš„åº•å±‚æ¡†æ¶ï¼Œä½ åªè¦ä½¿ç”¨äº†.Net Coreçš„æ—¶å€™å°±å¿…ç„¶ä¼šç”¨åˆ°å®ƒã€‚å½“ç„¶å…³äºä½¿ç”¨å®ƒçš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„é—®é¢˜ä¹Ÿä»æ¥æ²¡åœæ­¢è¿‡ã€‚æˆ‘å¯¹å¾…é—®é¢˜çš„æ€åº¦å‘æ¥éƒ½æ˜¯ï¼Œå¦‚æœä½ è¸©åˆ°äº†å‘ï¼Œè¯´æ˜ä½ è¿˜æ²¡æœ‰è¶³å¤Ÿäº†è§£å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹å®ƒè®¤çŸ¥çš„çªç ´ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯é‡åˆ°äº†é—®é¢˜å¹¶è§£å†³äº†é—®é¢˜ã€‚ä»Šå¤©çš„è¯é¢˜å‘¢ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç¾¤å‹åœ¨ç ”ç©¶.Net Coreä½œç”¨åŸŸçš„è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ç–‘é—®ï¼Œåšä¸»å‘¢å¯¹è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆæœ‰å…´è¶£ï¼Œå°±å€Ÿæ­¤æœºä¼šæ¢ç©¶äº†ä¸€ä¸‹ï¼ŒæŠŠè‡ªå·±ç ”ç©¶ç»“æœåˆ†äº«ç»™å¤§å®¶ã€‚

### ç®€å•æ¼”ç¤º

åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­ä½¿ç”¨`CreateScope()`æˆ–`CreateAsyncScope()`çš„åœºæ™¯å¯èƒ½æ²¡æœ‰é‚£ä¹ˆå¤šï¼Œä½†æ˜¯åœ¨ASP.NET Coreåº•å±‚çš„è¯è¿™æ˜¯æ ¸å¿ƒè®¾è®¡ï¼Œåœ¨ä¸Šç¯‡æ–‡ç« [<è§£å†³ASP.NET Coreåœ¨Taskä¸­ä½¿ç”¨IServiceProviderçš„é—®é¢˜>](https://www.cnblogs.com/wucy/p/16566495.html)ä¸­æåˆ°è¿‡ï¼ŒASP.NET Coreä¼šä¸ºæ¯æ¬¡è¯·æ±‚åˆ›å»ºä¸€ä¸ª`Scope`,ä¹Ÿå°±æ˜¯å’±ä»¬è¿™æ¬¡æåˆ°çš„ä½œç”¨åŸŸã€‚ä½¿ç”¨çš„æ–¹æ³•æœ‰å¾ˆç®€å•ï¼Œæœ¬è´¨å°±æ˜¯`IServiceProvider`çš„ä¸€ä¸ªæ‰©å±•æ–¹æ³•ã€‚å’±ä»¬ä»Šå¤©ä¸»è¦è¯´çš„å°±æ˜¯`ServiceLifetime.Scoped`è¿™ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ç”Ÿå‘½å‘¨æœŸï¼Œåœ¨Scopeå†…æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ŒåŸå§‹ç‚¹çš„å†™æ³•å…¶å®å°±æ˜¯

    IServiceCollection services = new ServiceCollection();
    services.AddScoped<Person>(provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" });
    
    IServiceProvider serviceProvider = services.BuildServiceProvider();
    using (IServiceScope serviceScope = serviceProvider.CreateScope())
    {
        var personOne = serviceScope.ServiceProvider.GetService<Person>();
        Console.WriteLine(person.Name);
    }
    

å¦‚æœåœ¨ASP.NET Coreæ¡†æ¶é‡Œé‚£ç©æ³•å°±å¤šäº†ï¼Œåªè¦æœ‰`IServiceProvide`çš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨`CreateScope()`æˆ–`CreateAsyncScope()`æ–¹æ³•ï¼Œç®€å•æ¼”ç¤ºä¸€ä¸‹ï¼Œä½†æ˜¯å¦‚æœæ„Ÿè§‰è‡ªå·±æŠŠæ¡ä¸ä½çš„è¯è¿˜æ˜¯æå‰è‡ªå·±è¯•éªŒä¸€ä¸‹

    [HttpGet]
    public async Task<object> JudgeScope([FromServices]IServiceProvider scopeProvider)
    {
        using IServiceScope scope = HttpContext.RequestServices.CreateScope();
        Person person = scope.ServiceProvider.GetService<Person>();
    
        await using (AsyncServiceScope scope2 = scopeProvider.CreateAsyncScope())
        {
            Person person2 = scope2.ServiceProvider.GetService<Person>();
        }
        return person;
    }
    

### æºç æ¢ç©¶

é€šè¿‡ä¸Šé¢çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®å…³äº`IServiceScope`çš„æ“ä½œéƒ¨åˆ†å°±æ˜¯ä¸‰ä¸ªæ ¸å¿ƒã€‚

*   é€šè¿‡`CreateScope()`æˆ–`CreateAsyncScope()`æ–¹æ³•åˆ›å»ºæœåŠ¡ä½œç”¨åŸŸã€‚
*   ä½¿ç”¨`GetService`ç›¸å…³çš„æ–¹æ³•åˆ›å»ºéœ€è¦çš„å¯¹è±¡å®ä¾‹ã€‚
*   ç”¨å®Œäº†ä½œç”¨åŸŸä¹‹åé€šè¿‡ä½¿ç”¨`Dispose()`æˆ–è€…`DisposeAsync()`æ–¹æ³•(usingçš„æ–¹å¼åŒç†)é‡Šæ”¾ä½œç”¨åŸŸã€‚

#### å…ˆè¯´AsyncServiceScope

ä¸ºäº†æ€•å¤§å®¶å¿ƒé‡Œæœ‰ç–‘è™‘ï¼Œå› ä¸ºä½¿ç”¨`CreateScope()`æ–¹æ³•åˆ›å»ºå‡ºæ¥çš„æ˜¯`IServiceScope`å®ä¾‹ï¼Œä½¿ç”¨`CreateAsyncScope`æ–¹æ³•åˆ›å»ºçš„æ˜¯`AsyncServiceScope`å®ä¾‹ã€‚å’±ä»¬è¿™é‡Œå…ˆæ¥è¯´ä¸€ä¸‹`AsyncServiceScope`å’Œ`IServiceScope`çš„å…³ç³»ï¼Œçœ‹äº†ä¹‹åå¤§å®¶å°±ä¸ç”¨æƒ¦è®°å®ƒäº†,å…ˆæ¥çœ‹ä¸€ä¸‹`CreateAsyncScope()`æ–¹æ³•çš„å®šä¹‰\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection.Abstractions/src/ServiceProviderServiceExtensions.cs#L134)\]

    public static AsyncServiceScope CreateAsyncScope(this IServiceProvider provider)
    {
        return new AsyncServiceScope(provider.CreateScope());
    }
    

æ–¹æ³•å°±æ˜¯è¿”å›`AsyncServiceScope`å®ä¾‹,æ¥ä¸‹æ¥æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„å®šä¹‰\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection.Abstractions/src/AsyncServiceScope.cs)\]

    public readonly struct AsyncServiceScope : IServiceScope, IAsyncDisposable
    {
        private readonly IServiceScope _serviceScope;
    
        public AsyncServiceScope(IServiceScope serviceScope)
        {
            //AsyncServiceScopeä¹Ÿæ˜¯IServiceScopeå®ä¾‹æ„å»ºèµ·æ¥çš„
            _serviceScope = serviceScope ?? throw new ArgumentNullException(nameof(serviceScope));
        }
    
        //ServiceProviderä¹Ÿæ˜¯ç›´æ¥åœ¨IServiceScopeå®ä¾‹ä¸­ç›´æ¥è·å–çš„
        public IServiceProvider ServiceProvider => _serviceScope.ServiceProvider;
    
        //åŒæ­¥é‡Šæ”¾
        public void Dispose()
        {
            _serviceScope.Dispose();
        }
    
        //å¼‚æ­¥é‡Šæ”¾
        public ValueTask DisposeAsync()
        {
            //å› ä¸ºIAsyncDisposableçš„ServiceProviderèƒ½ç»§ç»­åˆ›å»ºä½œç”¨åŸŸ
            //ä½¿ç”¨CreateScopeæˆ–CreateAsyncScopeæ–¹æ³•
            if (_serviceScope is IAsyncDisposable ad)
            {
                return ad.DisposeAsync();
            }
            _serviceScope.Dispose();
    
            return default;
        }
    }
    

é€šè¿‡æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`AsyncServiceScope`æœ¬èº«æ˜¯åŒ…è£…äº†`IServiceScope`å®ä¾‹ï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯å®ç°äº†`IServiceScope`æ¥å£å¹¶ä¸”åŒæ—¶`IAsyncDisposable`æ¥å£ä»¥ä¾¿å¯ä»¥å¼‚æ­¥è°ƒç”¨é‡Šæ”¾ã€‚ç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“ï¼Œå®ç°äº†`IDispose`æ¥å£å¯ä»¥ä½¿ç”¨`using IServiceScope scope = HttpContext.RequestServices.CreateScope()`çš„æ–¹å¼ï¼Œå®ƒç¼–è¯‘å®Œä¹‹åå…¶å®æ˜¯

    IServiceScope scope = HttpContext.RequestServices.CreateScope();
    try
    {
      //å…·ä½“æ“ä½œ
    }
    finally
    {
        scope.Dispose();
    }
    

å®ç°äº†`IAsyncDisposable`æ¥å£å¯ä»¥ä½¿ç”¨`await using (AsyncServiceScope scope2 = scopeProvider.CreateAsyncScope())`çš„æ–¹å¼ï¼Œå®ƒç¼–è¯‘å®Œçš„ä»£ç åˆ™æ˜¯

    AsyncServiceScope scope2 = scopeProvider.CreateAsyncScope();
    try
    {
      //å…·ä½“æ“ä½œ
    }
    finally
    {
        await scope2.DisposeAsync();
    }
    

æ‰“æ¶ˆäº†è¿™ä¸ªç–‘è™‘ï¼Œç›¸ä¿¡å¤§å®¶å¯¹å®ƒä»¬çš„å…³ç³»æœ‰äº†äº†è§£ï¼Œæœ¬è´¨å°±æ˜¯åŒ…è£…äº†ä¸€ä¸‹`IServiceScope`å®ä¾‹ã€‚

#### ç”±åˆ›å»ºå¼€å§‹

æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥ä¸“å¿ƒçš„çœ‹ä¸€ä¸‹`IServiceScope`ç›¸å…³çš„å®ç°ï¼Œ`IServiceScope`çš„åˆ›å»ºåˆ™æ˜¯æ¥è‡ª`IServiceProvider`çš„æ‰©å±•æ–¹æ³•`CreateScope()`ï¼Œé¦–å…ˆçœ‹ä¸‹å®ƒçš„å®šä¹‰\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection.Abstractions/src/ServiceProviderServiceExtensions.cs#L124)\]

    public static IServiceScope CreateScope(this IServiceProvider provider)
    {
        return provider.GetRequiredService<IServiceScopeFactory>().CreateScope();
    }
    

å¥½å§ï¼ŒçŸ­çŸ­çš„ä¸€è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¿¡æ¯

*   é¦–å…ˆè·å–åˆ°çš„`IServiceScopeFactory`å®ä¾‹ï¼Œçœ‹è¿‡ä¸Šç¯‡æ–‡ç« çš„å¯ä»¥çŸ¥é“ï¼Œé»˜è®¤æƒ…å†µé€šè¿‡`IServiceScopeFactory`å®ä¾‹è·å–çš„æ˜¯`æ ¹å®¹å™¨`çš„å®ä¾‹ã€‚
*   å…¶æ¬¡`IServiceProvider`çš„CreateScopeæ‰©å±•æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯è°ƒç”¨çš„`IServiceScopeFactory`çš„`CreateScope`æ–¹æ³•ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬å°±çœ‹çœ‹ä¸‹IServiceScopeFactoryé»˜è®¤å®ç°ç±»ä¸­å…³äº`CreateScope()`æ–¹æ³•çš„å®šä¹‰ï¼Œåœ¨`ServiceProviderEngineScope`ç±»ä¸­\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/ServiceProviderEngineScope.cs#L49)\]

    internal ServiceProvider RootProvider { get; }
    public IServiceScope CreateScope() => RootProvider.CreateScope();
    

è¿™é‡Œæ¯«æ— ç–‘é—®äº†`RootProvider`å±æ€§é‡Œçš„å®ä¾‹éƒ½æ˜¯æ¥è‡ªæ ¹å®¹å™¨ï¼Œè€Œ`CreateScope()`æ–¹æ³•åˆ™æ˜¯è°ƒç”¨çš„`ServiceProvider`çš„`CreateScope()`æ–¹æ³•ã€‚çœ‹ä¸‹`ServiceProvider`ç±»çš„CreateScopeæ–¹æ³•å®šä¹‰  
\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceProvider.cs#L182)\]

    private bool _disposed;
    internal IServiceScope CreateScope()
    {
        //åˆ¤æ–­å½“å‰ServiceProvideræ˜¯å¦è¢«é‡Šæ”¾
        if (_disposed)
        {
            //å¦‚æœå·²ç»é‡Šæ”¾åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸
            ThrowHelper.ThrowObjectDisposedException();
        }
        //åˆ›å»ºServiceProviderEngineScopeå®ä¾‹
        return new ServiceProviderEngineScope(this, isRootScope: false);
    }
    

é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`CreateScope()`æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯åˆ›å»ºäº†ä¸€ä¸ª`ServiceProviderEngineScope`æ–¹æ³•å®ä¾‹ã€‚é€šè¿‡åˆ›å»ºçš„è¿™ä¸€è¡Œä»£ç ï¼Œå¥½å·§ä¸å·§åˆå¯ä»¥å¾—åˆ°ä¸¤ä¸ªé‡è¦çš„ä¿¡æ¯ã€‚

*   ä¸€æ˜¯ServiceProviderEngineScopeæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¼ é€’çš„æ˜¯å½“å‰çš„ServiceProviderå®ä¾‹ã€‚
*   äºŒæ˜¯ServiceProviderEngineScopeæ„é€ å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å«`isRootScope`å€¼ç»™çš„æ˜¯`false`ï¼Œè¯´æ˜å½“å‰ServiceProviderEngineScopeå®ä¾‹ä¸æ˜¯æ ¹ä½œç”¨åŸŸï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„å­ä½œç”¨åŸŸã€‚

å¤§è‡´çœ‹ä¸€ä¸‹ServiceProviderEngineScopeæ„é€ å‡½æ•°çš„å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/ServiceProviderEngineScope.cs#L19)\]

    internal sealed class ServiceProviderEngineScope : IServiceScope, IServiceProvider, IAsyncDisposable, IServiceScopeFactory
    {
        internal Dictionary<ServiceCacheKey, object> ResolvedServices { get; }
        internal object Sync => ResolvedServices;
        internal ServiceProvider RootProvider { get; }
        public bool IsRootScope { get; }
        //IServiceProviderçš„ServiceProviderå±æ€§åˆ™æ˜¯èµ‹å€¼çš„å½“å‰å®ä¾‹
        public IServiceProvider ServiceProvider => this;
        public ServiceProviderEngineScope(ServiceProvider provider, bool isRootScope)
        {
            //ç”¨æ¥å­˜å‚¨å½“å‰ä½œç”¨åŸŸç®¡ç†çš„å¯¹è±¡å®ä¾‹
            ResolvedServices = new Dictionary<ServiceCacheKey, object>();
            //åˆ›å»ºå½“å‰å®ä¾‹çš„æ ¹å®¹å™¨
            RootProvider = provider;
            //æ ‡è¯†å½“å‰ä½œç”¨åŸŸæ˜¯å¦æ˜¯æ ¹å®¹å™¨
            IsRootScope = isRootScope;
        }
    }
    

ä¸‹å¤§è‡´çœ‹ä¸€ä¸‹ï¼Œå› ä¸ºæ¥ä¸‹æ¥ä¼šæ¶‰åŠåˆ°`ServiceProviderEngineScope`è¿™ä¸ªç±»ã€‚åˆ°ç›®å‰ä¸ºæ­¢æ¶‰åŠåˆ°äº†ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»`ServiceProvider`å’Œ`ServiceProviderEngineScope`ï¼Œå®ƒä»¬éƒ½æ˜¯å®ç°äº†`IServiceProvider`æ¥å£ã€‚çœ‹èµ·æ¥æœ‰ç‚¹ä¹±çš„æ ·å­ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥å§‘ä¸”è¿™ä¹ˆç†è§£ã€‚ServiceProvideræ˜¯IServiceProviderçš„ç›´ç³»å®ç°ç±»ï¼Œä½œä¸ºIServiceProvideræ ¹å®¹å™¨çš„å®ç°ã€‚ServiceProviderEngineScopeæ˜¯ç”¨äºï¼Œé€šè¿‡IServiceProvideråˆ›å»ºä½œç”¨åŸŸæ—¶è¡¨ç°å‡ºæ¥çš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯éæ ¹å®¹å™¨çš„å®ä¾‹ã€‚

#### æ¢ç©¶è·å–æ–¹æ³•

å…³äºä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å…¶å®æ¢ç©¶äº†ä¸€ç‚¹`serviceProvider.CreateScope()`,æ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦çœ‹ä¸€ä¸‹å…³äºè·å–çš„ç›¸å…³æ“ä½œï¼Œä¹Ÿå°±æ˜¯`GetService`æ–¹æ³•ç›¸å…³ï¼Œå®ƒçš„ä½¿ç”¨å½¢å¼æ˜¯`serviceScope.ServiceProvider.GetService<T>()`ã€‚ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡`ServiceProviderEngineScope`çš„`ServiceProvider`å±æ€§å®ä¾‹åˆ™æ˜¯å½“å‰ServiceProviderEngineScopeçš„å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥å»çœ‹`ServiceProviderEngineScope`çš„`GetService`æ–¹æ³•\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/ServiceProviderEngineScope.cs#L37)\]

    internal sealed class ServiceProviderEngineScope : IServiceScope, IServiceProvider, IAsyncDisposable, IServiceScopeFactory
    {
        private bool _disposed;
        internal ServiceProvider RootProvider { get; }
        public object GetService(Type serviceType)
        {
            //åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦é‡Šæ”¾
            if (_disposed)
            {
                //å¦‚æœå·²ç»é‡Šæ”¾åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸
                ThrowHelper.ThrowObjectDisposedException();
            }
    
            return RootProvider.GetService(serviceType, this);
        }
    }
    

çœ‹ç€æŒºä¹±çš„ï¼Œå„ç§è·³è½¬å„ç§è°ƒç”¨ã€‚ä¸è¿‡æœ¬è´¨åªè®¾è®¡åˆ°ä¸¤ä¸ªç±»`ServiceProvider`å’Œ`ServiceProviderEngineScope`ï¼Œå…ˆè¯´æ˜ä¸€ä¸‹ï¼Œçœçš„å¤§å®¶çœ‹ç€æ•´è’™åœˆäº†ã€‚é€šè¿‡æœ€åä¸€å¥ä»£ç ï¼Œæˆ‘ä»¬åˆèƒ½å¾—åˆ°ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ä¿¡æ¯ã€‚

*   ServiceProviderEngineScopeçš„GetServiceæ–¹æ³•ï¼Œæœ¬è´¨æ˜¯åœ¨è°ƒç”¨RootProviderçš„GetServiceæ–¹æ³•ã€‚é€šè¿‡å‰é¢å’±ä»¬çš„æºç åˆ†æå¯ä»¥çŸ¥é“`RootProvider`å±æ€§çš„å€¼æ˜¯`ServiceProvider`å®ä¾‹ä¹Ÿå°±æ˜¯ä»£è¡¨çš„æ ¹å®¹å™¨ã€‚
*   è°ƒç”¨RootProviderçš„GetServiceæ–¹æ³•çš„æ—¶å€™ä¼ é€’äº†å½“å‰ServiceProviderEngineScopeå®ä¾‹ã€‚

æ¥ä¸‹æ¥å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°ServiceProviderçš„GetServiceæ–¹æ³•äº†ï¼Œçœ‹ä¸€ä¸‹é‡Œé¢çš„å…·ä½“ç›¸å…³å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceProvider.cs#L120)\]

    public sealed class ServiceProvider : IServiceProvider, IDisposable, IAsyncDisposable
    {
        private bool _disposed;
        private ConcurrentDictionary<Type, Func<ServiceProviderEngineScope, object>> _realizedServices;
        private readonly Func<Type, Func<ServiceProviderEngineScope, object>> _createServiceAccessor;
        internal ServiceProviderEngine _engine;
    
        internal ServiceProvider()
        {
          _createServiceAccessor = CreateServiceAccessor;
          _realizedServices = new ConcurrentDictionary<Type, Func<ServiceProviderEngineScope, object>>();
        }
    
        internal object GetService(Type serviceType, ServiceProviderEngineScope serviceProviderEngineScope)
        {
            //åˆ¤æ–­å½“å‰å®ä¾‹æ˜¯å¦é‡Šæ”¾
            if (_disposed)
            {
                ThrowHelper.ThrowObjectDisposedException();
            }
            //ç¼“å­˜è·å–æœåŠ¡å®ä¾‹å§”æ‰˜çš„å­—å…¸ï¼Œå€¼ä¸ºè¦è·å–å®ä¾‹çš„ç±»å‹ï¼Œå€¼æ˜¯åˆ›å»ºå®ä¾‹çš„å§”æ‰˜
            //_createServiceAccessoræœ¬è´¨æ˜¯CreateServiceAccessoræ–¹æ³•å§”æ‰˜
            Func<ServiceProviderEngineScope, object> realizedService = _realizedServices.GetOrAdd(serviceType, _createServiceAccessor);
            OnResolve(serviceType, serviceProviderEngineScope);
            DependencyInjectionEventSource.Log.ServiceResolved(this, serviceType);
            //æ‰§è¡ŒrealizedServiceå§”æ‰˜ï¼Œä¼ é€’çš„æ˜¯ServiceProviderEngineScopeå®ä¾‹
            var result = realizedService.Invoke(serviceProviderEngineScope);
            System.Diagnostics.Debug.Assert(result is null || CallSiteFactory.IsService(serviceType));
            return result;
        }
    
        private Func<ServiceProviderEngineScope, object> CreateServiceAccessor(Type serviceType)
        {
            //è·å–ServiceCallSiteï¼Œå…¶å®å°±æ˜¯è·å–è¦è§£æå¯¹è±¡çš„å®ä¾‹ç›¸å…³ä¿¡æ¯
            ServiceCallSite callSite = CallSiteFactory.GetCallSite(serviceType, new CallSiteChain());
            if (callSite != null)
            {
                DependencyInjectionEventSource.Log.CallSiteBuilt(this, serviceType, callSite);
                OnCreate(callSite);
                //å’±ä»¬å½“å‰è®¨è®ºçš„æ˜¯Scopeå‘¨æœŸå¯¹è±¡çš„é—®é¢˜ï¼Œè¿™ä¸ªæ–¹æ³•æè¿°çš„æ˜¯ç”Ÿå‘½å‘¨æœŸä¸ºServiceLifetime.Singletonçš„æƒ…å†µï¼Œå¯ä»¥è·³è¿‡è¿™ä¸ªé€»è¾‘
                //å¦‚æœæ˜¯å•ä¾‹æƒ…å†µï¼Œåˆ™ç›´æ¥åœ¨æ ¹å®¹å™¨ä¸­ç›´æ¥å»æ“ä½œå¯¹è±¡å®ä¾‹ï¼Œå’Œå½“å‰çš„ServiceProviderEngineScopeæ— å…³
                if (callSite.Cache.Location == CallSiteResultCacheLocation.Root)
                {
                    object value = CallSiteRuntimeResolver.Instance.Resolve(callSite, Root);
                    return scope => value;
                }
                //è§£æServiceCallSiteé‡Œçš„ä¿¡æ¯
                return _engine.RealizeService(callSite);
            }
    
            return _ => null;
        }
    }
    

è¿™é‡Œæˆ‘ä»¬çœ‹ä¸‹`CallSiteFactory.GetCallSite`æ–¹æ³•ï¼Œå…ˆæ¥è¯´ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•æ˜¯åšå•¥çš„ã€‚æˆ‘ä»¬è¦è·å–æŸä¸ªç±»å‹çš„å®ä¾‹(å¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬æ¼”ç¤ºç¤ºä¾‹é‡Œçš„Personç±»)ï¼Œä½†æ˜¯æˆ‘ä»¬æ³¨å†Œç±»ç›¸å…³çš„ä¿¡æ¯çš„æ—¶å€™(æ¯”å¦‚ä¸Šé¢çš„`services.AddScoped<Person>(provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" })`)æ¶‰åŠåˆ°å‡ ç§æ–¹å¼ï¼Œæ¯”å¦‚`AddScoped<T>`å’Œ`Add<T>(Func<IServiceProvider,object>)`ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“åˆ›å»ºç±»å‹å®ä¾‹çš„æ—¶å€™ä½¿ç”¨å“ªç§æ–¹å¼(æ¯”å¦‚æˆ‘ä»¬çš„Personæ˜¯ä½¿ç”¨å§”æ‰˜çš„è¿™ç§æ–¹å¼)ï¼ŒServiceCallSiteæ­£æ˜¯å­˜å‚¨çš„ç±»å‹å’Œå¦‚ä½•åˆ›å»ºè¿™ä¸ªç±»å‹çš„å·¥å‚ç›¸å…³çš„ä¿¡æ¯ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`GetCallSite`æ–¹æ³•çš„æ ¸å¿ƒæ“ä½œ\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/CallSiteFactory.cs#L313)\]

    private readonly ConcurrentDictionary<ServiceCacheKey, ServiceCallSite> _callSiteCache = new ConcurrentDictionary<ServiceCacheKey, ServiceCallSite>();
    
    private ServiceCallSite TryCreateExact(ServiceDescriptor descriptor, Type serviceType, CallSiteChain callSiteChain, int slot)
    {
        if (serviceType == descriptor.ServiceType)
        {
            //è¦è·å–çš„ç±»å‹ä¼šè¢«åŒ…è£…æˆServiceCacheKey
            ServiceCacheKey callSiteKey = new ServiceCacheKey(serviceType, slot);
            //åœ¨ç¼“å­˜ä¸­è·å–ServiceCallSiteå®ä¾‹ï¼Œå¯ä»¥ç†è§£ä¸ºè®¾è®¡æ¨¡å¼ä¸­çš„äº«å…ƒæ¨¡å¼
            if (_callSiteCache.TryGetValue(callSiteKey, out ServiceCallSite serviceCallSite))
            {
                return serviceCallSite;
            }
    
            ServiceCallSite callSite;
            //æ ¹æ®ServiceDescriptor.LifetimeåŒ…è£…ResultCache
            var lifetime = new ResultCache(descriptor.Lifetime, serviceType, slot);
            //ServiceDescriptorå°±æ˜¯æˆ‘ä»¬æ·»åŠ åˆ°IServiceCollectionçš„æœ€ç»ˆå½¢å¼
            //æˆ‘ä»¬æ³¨å†ŒæœåŠ¡çš„æ—¶å€™æœ¬è´¨å°±æ˜¯åœ¨IServiceCollectioné‡Œæ·»åŠ ServiceDescriptorå®ä¾‹
    
            //AddScope<T>()è¿™ç§å½¢å¼
            if (descriptor.ImplementationInstance != null)
            {
                callSite = new ConstantCallSite(descriptor.ServiceType, descriptor.ImplementationInstance);
            }
            //AddScope(Func<IServiceProvider,object>)å½¢å¼
            else if (descriptor.ImplementationFactory != null)
            {
                callSite = new FactoryCallSite(lifetime, descriptor.ServiceType, descriptor.ImplementationFactory);
            }
            //AddScope<T,TImpl>()å½¢å¼
            else if (descriptor.ImplementationType != null)
            {
                callSite = CreateConstructorCallSite(lifetime, descriptor.ServiceType, descriptor.ImplementationType, callSiteChain);
            }
            else
            {
                throw new InvalidOperationException(SR.InvalidServiceDescriptor);
            }
            //å°†åˆ›å»ºçš„ServiceCallSiteç¼“å­˜èµ·æ¥
            return _callSiteCache[callSiteKey] = callSite;
        }
        return null;
    }
    

è€Œè§£æ`ServiceCallSite`å®ä¾‹çš„æ–¹æ³•`RealizeService(ServiceCallSite)`åˆ™æ˜¯åœ¨`ServiceProviderEngine`ç±»ä¸­ï¼Œçœ‹ä¸€ä¸‹ç›¸å…³å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/DynamicServiceProviderEngine.cs#L19)\]

     public override Func<ServiceProviderEngineScope, object> RealizeService(ServiceCallSite callSite)
    {
        int callCount = 0;
        return scope =>
        {
            //æ ¸å¿ƒä»£ç æ˜¯Resolveæ–¹æ³•,è¿™é‡Œçš„scopeåˆ™æ˜¯ServiceProviderEngineScope
            //å³æˆ‘ä»¬ä¸Šé¢é€šè¿‡CreateScope()åˆ›å»ºçš„å®ä¾‹
            var result = CallSiteRuntimeResolver.Instance.Resolve(callSite, scope);
            if (Interlocked.Increment(ref callCount) == 2)
            {
                _ = ThreadPool.UnsafeQueueUserWorkItem(_ =>
                {
                    try
                    {
                        _serviceProvider.ReplaceServiceAccessor(callSite, base.RealizeService(callSite));
                    }
                    catch (Exception ex)
                    {
                       //çœç•¥æ‰éæ ¸å¿ƒä»£ç 
                    }
                },
                null);
            }
            return result;
        };
    }
    

ä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„`RealizeService()`æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªå§”æ‰˜ï¼Œè€Œè°ƒç”¨è¿™ä¸ªå§”æ‰˜çš„åœ°æ–¹åˆ™æ˜¯ä¸Šé¢æºç ä¸­çœ‹åˆ°çš„`realizedService.Invoke(serviceProviderEngineScope)`ï¼Œæ ¸å¿ƒæ“ä½œåœ¨`CallSiteRuntimeResolver.Instance.Resolve()`æ–¹æ³•ï¼ŒResolveæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘åœ¨`VisitCallSite()`æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹å®ƒçš„å®ç°æ–¹å¼\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/CallSiteVisitor.cs#L17)\]

    protected virtual TResult VisitCallSite(ServiceCallSite callSite, TArgument argument)
    {
        if (!_stackGuard.TryEnterOnCurrentStack())
        {
            return _stackGuard.RunOnEmptyStack((c, a) => VisitCallSite(c, a), callSite, argument);
        }
    
        switch (callSite.Cache.Location)
        {
            //ServiceLifetime.Singletonå•ä¾‹æƒ…å†µ
            case CallSiteResultCacheLocation.Root:
                return VisitRootCache(callSite, argument);
            //ServiceLifetime.Scopedä½œç”¨åŸŸæƒ…å†µï¼Œä¹Ÿå°±æ˜¯å’±ä»¬å…³æ³¨çš„æƒ…å†µ
            case CallSiteResultCacheLocation.Scope:
                return VisitScopeCache(callSite, argument);
            //ServiceLifetime.Transientç¬æ—¶æƒ…å†µ
            case CallSiteResultCacheLocation.Dispose:
                return VisitDisposeCache(callSite, argument);
            case CallSiteResultCacheLocation.None:
                return VisitNoCache(callSite, argument);
            default:
                throw new ArgumentOutOfRangeException();
        }
    }
    

å› ä¸ºæˆ‘ä»¬å…³æ³¨çš„æ˜¯`CallSiteResultCacheLocation.Scope`è¿™ç§æƒ…å†µæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯`VisitScopeCache()`è¿™æ®µæ–¹æ³•é€»è¾‘ï¼ŒCallSiteRuntimeResolverçš„`VisitCache()`æ–¹æ³•\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/CallSiteRuntimeResolver.cs#L111)\]

    protected override object VisitScopeCache(ServiceCallSite callSite, RuntimeResolverContext context)
    {
        //å’±ä»¬å…³æ³¨çš„æ˜¯Scopeçš„æƒ…å†µï¼Œæ‰€ä»¥é‡ç‚¹åœ¨VisitCacheæ–¹æ³•
        return context.Scope.IsRootScope ?
            VisitRootCache(callSite, context) :
            VisitCache(callSite, context, context.Scope, RuntimeResolverLock.Scope);
    }
    
    //è¿™é‡Œçš„serviceProviderEngineå‚æ•°å°±æ˜¯æˆ‘ä»¬ä¼ é€’è¿›æ¥çš„ServiceProviderEngineScopeå®ä¾‹
    private object VisitCache(ServiceCallSite callSite, RuntimeResolverContext context, ServiceProviderEngineScope serviceProviderEngine, RuntimeResolverLock lockType)
    {
        bool lockTaken = false;
        //è·å–ServiceProviderEngineScopeçš„Syncå±æ€§
        object sync = serviceProviderEngine.Sync;
        //è·å–ServiceProviderEngineScopeçš„ResolvedServiceså±æ€§
        Dictionary<ServiceCacheKey, object> resolvedServices = serviceProviderEngine.ResolvedServices;
        //åŠ é”
        if ((context.AcquiredLocks & lockType) == 0)
        {
            Monitor.Enter(sync, ref lockTaken);
        }
    
        try
        {
            //åˆ¤æ–­ServiceProviderEngineScopeçš„ResolvedServicesçš„å±æ€§é‡Œæ˜¯å¦åŒ…å«è¯¥ç±»å‹å®ä¾‹
            //å½“å‰ä½œç”¨åŸŸå†…åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œæ‰€ä»¥ç¼“å­˜èµ·æ¥
            if (resolvedServices.TryGetValue(callSite.Cache.Key, out object resolved))
            {
                return resolved;
            }
            
            //å½“å‰Scopeæ²¡åˆ›å»ºè¿‡å®ä¾‹çš„è¯åˆ™åˆ›å»º
            resolved = VisitCallSiteMain(callSite, new RuntimeResolverContext
            {
                Scope = serviceProviderEngine,
                AcquiredLocks = context.AcquiredLocks | lockType
            });
            //åˆ¤æ–­å½“å‰ç±»å‹å®ä¾‹æ˜¯å¦æ˜¯IDisposeæƒ³å®ä¾‹
            serviceProviderEngine.CaptureDisposable(resolved);
            //ç»™ServiceProviderEngineScopeçš„ResolvedServicesçš„å±æ€§æ·»åŠ ç¼“å­˜å®ä¾‹
            resolvedServices.Add(callSite.Cache.Key, resolved);
            return resolved;
        }
        finally
        {
            if (lockTaken)
            {
                Monitor.Exit(sync);
            }
        }
    }
    
    protected virtual TResult VisitCallSiteMain(ServiceCallSite callSite, TArgument argument)
    {
        //æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢çš„services.AddScoped<Person>(provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" })
        //å¯¹åº”çš„Kindåˆ™æ˜¯CallSiteKind.Factory
        switch (callSite.Kind)
        {
            case CallSiteKind.Factory:
                //è°ƒç”¨äº†VisitFactoryæ–¹æ³•
                return VisitFactory((FactoryCallSite)callSite, argument);
            case  CallSiteKind.IEnumerable:
                return VisitIEnumerable((IEnumerableCallSite)callSite, argument);
            case CallSiteKind.Constructor:
                return VisitConstructor((ConstructorCallSite)callSite, argument);
            case CallSiteKind.Constant:
                return VisitConstant((ConstantCallSite)callSite, argument);
            case CallSiteKind.ServiceProvider:
                return VisitServiceProvider((ServiceProviderCallSite)callSite, argument);
            default:
                throw new NotSupportedException(SR.Format(SR.CallSiteTypeNotSupported, callSite.GetType()));
        }
    }
    
    protected override object VisitFactory(FactoryCallSite factoryCallSite, RuntimeResolverContext context)
    {
      //è°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„services.AddScoped<Person>(provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" })
      //FactoryCallSiteçš„Factoryå³æ˜¯provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" }
      //context.Scopeåˆ™æ˜¯æˆ‘ä»¬é€šè¿‡CreateScopeåˆ›å»ºçš„å®ä¾‹
      //è¿”å›çš„ç»“æœå°±æ˜¯è°ƒç”¨å½“å‰å§”æ‰˜å¾—åˆ°çš„å®ä¾‹å³æˆ‘ä»¬å®ä¾‹ä¸­çš„Personå®ä¾‹
      return factoryCallSite.Factory(context.Scope);
    }
    

å›è¿‡å¤´æ¥è¯´ä¸€ä¸‹å’±ä»¬ä¸Šé¢å±•ç¤ºçš„ä»£ç ï¼Œè¢«è°ƒç”¨æ‰§è¡Œçš„åœ°æ–¹å°±æ˜¯`GetService`æ–¹æ³•é‡Œçš„`realizedService.Invoke(serviceProviderEngineScope)`çš„è¿™æ®µä»£ç ã€‚ä¸Šé¢çš„æ‰§è¡Œé€»è¾‘é‡Œæ¶‰åŠåˆ°äº†`ServiceProviderEngineScope`é‡Œçš„å‡ ä¸ªæ“ä½œï¼Œæ¯”å¦‚`ResolvedServices`å±æ€§å’Œ`CaptureDisposable()`æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹ç›¸å…³çš„ä»£ç 

    internal sealed class ServiceProviderEngineScope : IServiceScope, IServiceProvider, IAsyncDisposable, IServiceScopeFactory
    {
        internal IList<object> Disposables => _disposables ?? (IList<object>)Array.Empty<object>();
        private bool _disposed;
        private List<object> _disposables;
        internal Dictionary<ServiceCacheKey, object> ResolvedServices { get; }
        public ServiceProviderEngineScope(ServiceProvider provider, bool isRootScope)
        {
            ResolvedServices = new Dictionary<ServiceCacheKey, object>();
        }
    
        internal object CaptureDisposable(object service)
        {
            //åˆ¤æ–­å®ä¾‹æ˜¯å¦å®ç°äº†IDisposableæˆ–IAsyncDisposableæ¥å£ï¼Œå› ä¸ºè¿™ç§éœ€è¦åœ¨å½“å‰ä½œç”¨åŸŸæ˜¯å¦çš„æ—¶å€™ä¸€èµ·é‡Šæ”¾
            if (ReferenceEquals(this, service) || !(service is IDisposable || service is IAsyncDisposable))
            {
                return service;
            }
    
            bool disposed = false;
            lock (Sync)
            {
                //åˆ¤æ–­å½“å‰ä½œç”¨åŸŸæ˜¯å¦é‡Šæ”¾
                if (_disposed)
                {
                    disposed = true;
                }
                else
                {   //å¦‚æœæ»¡è¶³åˆ™æ·»åŠ åˆ°_disposableså¾…é‡Šæ”¾é›†åˆï¼Œä»¥ä¾¿ä½œç”¨åŸŸé‡Šæ”¾çš„æ—¶å€™ä¸€èµ·é‡Šæ”¾
                    _disposables ??= new List<object>();
                    _disposables.Add(service);
                }
            }
            
            //å¦‚æœå½“å‰ä½œç”¨åŸŸå·²ç»è¢«é‡Šæ”¾åˆ™ç›´æ¥é‡Šæ”¾å½“å‰å®ä¾‹
            if (disposed)
            {
                //å‰ææ˜¯æœåŠ¡å®ä¾‹æ˜¯å®ç°IDisposableæˆ–IAsyncDisposableæ¥å£çš„
                if (service is IDisposable disposable)
                {
                    disposable.Dispose();
                }
                else
                {
                    Task.Run(() => ((IAsyncDisposable)service).DisposeAsync().AsTask()).GetAwaiter().GetResult();
                }
    
                ThrowHelper.ThrowObjectDisposedException();
            }
    
            return service;
        }
    }
    

ä¸Šé¢å…³äº`ServiceProviderEngineScope`ç±»ä¸­æ¶‰åŠåˆ°`GetService()`æ–¹æ³•çš„ç›¸å…³é€»è¾‘å·²ç»å±•ç¤ºçš„å·®ä¸å¤šäº†ï¼Œæ¶‰åŠåˆ°çš„æ¯”è¾ƒå¤šï¼Œè€Œä¸”çœ‹ç€æ¯”è¾ƒä¹±ã€‚ä¸è¿‡å¦‚æœç†è§£äº†æ€è·¯è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå’±ä»¬æ¥åšä¸€ä¸‹ä¸€ä¸ªå¤§æ¦‚çš„æ€»ç»“ã€‚

*   é¦–å…ˆï¼Œéœ€è¦è·å–ServiceCallSiteï¼Œåœ¨æ–¹æ³•`GetCallSite()`ä¸­ï¼Œå…¶å®å°±æ˜¯è·å–è¦è§£æå¯¹è±¡çš„å®ä¾‹ç›¸å…³ä¿¡æ¯ã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“åˆ›å»ºç±»å‹å®ä¾‹çš„æ—¶å€™ä½¿ç”¨å“ªç§æ–¹å¼(æ¯”å¦‚æˆ‘ä»¬çš„Personæ˜¯ä½¿ç”¨å§”æ‰˜çš„è¿™ç§æ–¹å¼)ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬è¯¥å¯¹è±¡åˆ›å»ºçš„ç±»å‹ã€åˆ›å»ºå·¥å‚ã€ç”Ÿå‘½å‘¨æœŸç±»å‹ã€‚
*   ç„¶åï¼Œå¾—åˆ°ServiceCallSiteå®ä¾‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å®ä¾‹åˆ›å»ºçš„ä¿¡æ¯å»åˆ›å»ºä¿¡æ¯ï¼Œåœ¨æ–¹æ³•`RealizeService()`é‡Œã€‚æ ¹æ®ä¸åŒç±»å‹åˆ›å»ºæ–¹å¼å’Œç”Ÿå‘½å‘¨æœŸï¼Œåˆ¤æ–­å¦‚ä½•åˆ›å»ºå¯¹è±¡ï¼Œå³å¯¹è±¡å­˜æ”¾ä½ç½®ã€‚
*   æœ€åï¼Œå¦‚æœæ˜¯å•ä¾‹æ¨¡å¼ï¼Œåˆ™åœ¨æ ¹å®¹å™¨ä¸­è§£æè¿™ä¸ªå¯¹è±¡ï¼Œä½ç½®å½“ç„¶ä¹Ÿæ˜¯å­˜å‚¨åœ¨æ ¹å®¹å™¨ä¸­ï¼Œå…¨å±€å”¯ä¸€ã€‚å¦‚æœæ˜¯ç¬æ—¶æ¨¡å¼ï¼Œåˆ™ç›´æ¥è¿”å›åˆ›å»ºçš„å¯¹è±¡å®ä¾‹ï¼Œä¸è¿›è¡Œä»»ä½•å­˜å‚¨ï¼Œä½†æ˜¯éœ€è¦åˆ¤æ–­å®ä¾‹æ˜¯å¦å®ç°äº†IDisposableæˆ–IAsyncDisposableæ¥å£ï¼Œå¦‚æœæ˜¯åˆ™åŠ å…¥å½“å‰ServiceProviderEngineScopeå®ä¾‹çš„\_disposablesé›†åˆã€‚å¦‚æœæ˜¯Scopeæ¨¡å¼å°±æ¯”è¾ƒç‰¹æ®Šäº†ï¼Œå› ä¸ºScopeéœ€è¦åœ¨å½“å‰ServiceProviderEngineScopeä¸­å­˜å‚¨ä¿è¯å½“å‰ä½œç”¨åŸŸå”¯ä¸€ï¼Œåˆ™éœ€è¦æ·»åŠ åˆ°ResolvedServiceså±æ€§çš„å­—å…¸é‡Œï¼ŒåŒæ—¶ä¹Ÿéœ€è¦åˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ åˆ°\_disposablesé›†åˆé‡Œã€‚

è¿™å°±å¯ä»¥è§£é‡ŠServiceProviderEngineScopeé’ˆå¯¹ä¸åŒç”Ÿå‘½å‘¨æœŸçš„å­˜å‚¨æ–¹å¼äº†ï¼Œå•ä¾‹çš„æƒ…å†µåˆ›å»ºå’Œå­˜å‚¨éƒ½æ˜¯åœ¨æ ¹å®¹å™¨ä¸­ï¼Œç¬æ—¶çš„æƒ…å†µä¸‹åˆ™æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„å®ä¾‹ä¸”ä¸è¿›è¡Œå­˜å‚¨ï¼ŒScopeçš„æƒ…å†µä¸‹åˆ™æ˜¯å­˜å‚¨åœ¨å½“å‰çš„ResolvedServicesä¸­äº«å…ƒèµ·æ¥å¯ä»¥åœ¨å½“å‰ä½œç”¨åŸŸå†…é‡å¤ä½¿ç”¨ã€‚

#### å…³äºç»“æŸé‡Šæ”¾

å‰é¢å’±ä»¬çœ‹äº†ä¸‹å…³äºä½œç”¨åŸŸåˆ›å»ºï¼Œåœ¨åšç”¨æˆ·è·å–å¯¹è±¡çš„ç›¸å…³é€»è¾‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸‰ä»¶å¥—çš„æœ€åä¸€ä¸ªæ­¥éª¤ï¼Œé‡Šæ”¾é€»è¾‘ç›¸å…³çš„ã€‚è¿™ä¸ªé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸Šé¢å’±ä»¬æˆ–å¤šæˆ–å°‘çš„ä¹Ÿè¯´è¿‡äº†ä¸€ç‚¹ï¼Œé‡Šæ”¾åˆ†ä¸ºåŒæ­¥é‡Šæ”¾å’Œå¼‚æ­¥é‡Šæ”¾ä¸¤ç§æƒ…å†µï¼Œå’±ä»¬çœ‹ä¸€ä¸‹åŒæ­¥é‡Šæ”¾çš„ç›¸å…³å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/runtime/blob/v6.0.10/src/libraries/Microsoft.Extensions.DependencyInjection/src/ServiceLookup/ServiceProviderEngineScope.cs#L92)\]

    internal Dictionary<ServiceCacheKey, object> ResolvedServices { get; }
    internal object Sync => ResolvedServices;
    private bool _disposed;
    private List<object> _disposables;
    public void Dispose()
    {
        List<object> toDispose = BeginDispose();
    
        if (toDispose != null)
        {
            for (int i = toDispose.Count - 1; i >= 0; i--)
            {   
                //æ¨¡ä»¿æ ˆæ¨¡å¼ï¼Œæœ€ååˆ›å»ºçš„æœ€å…ˆé‡Šæ”¾
                if (toDispose[i] is IDisposable disposable)
                {
                    //é‡Šæ”¾çš„æ­£å¼å®ç°äº†IDisposableæ¥å£çš„å¯¹è±¡
                    disposable.Dispose();
                }
                else
                {
                    throw new InvalidOperationException(SR.Format(SR.AsyncDisposableServiceDispose, TypeNameHelper.GetTypeDisplayName(toDispose[i])));
                }
            }
        }
    }
    
    private List<object> BeginDispose()
    {
        //æœ¬è´¨å°±æ˜¯é”ä½å½“å‰å­˜å‚¨å¯¹è±¡çš„é›†åˆï¼Œä¸å…è®¸è¿›è¡Œä»»ä½•æ“ä½œ
        lock (Sync)
        {
            //å¦‚æœå·²ç»é‡Šæ”¾è¿‡äº†åˆ™ç›´æ¥è¿”å›
            if (_disposed)
            {
                return null;
            }
    
            DependencyInjectionEventSource.Log.ScopeDisposed(RootProvider.GetHashCode(), ResolvedServices.Count, _disposables?.Count ?? 0);
            //å…ˆæŠŠé‡Šæ”¾æ ‡è¯†è®¾ç½®äº†
            _disposed = true;
    
        }
        //åˆ¤æ–­æ˜¯å¦æ˜¯æ ¹å®¹å™¨é‡Šæ”¾
        if (IsRootScope && !RootProvider.IsDisposed())
        {
            RootProvider.Dispose();
        }
    
        return _disposables;
    }
    

å…¶å®ä¸»è¦é€»è¾‘å°±æ˜¯å¾ªç¯é‡Šæ”¾`_disposables`é‡Œçš„æ‰€æœ‰å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å®ç°äº†`IDisposable`æ¥å£çš„å¯¹è±¡ã€‚æ¥ä¸‹æ¥å’±ä»¬å†æ¥çœ‹ä¸€ä¸‹å¼‚æ­¥é‡Šæ”¾çš„ç›¸å…³é€»è¾‘ã€‚

    public ValueTask DisposeAsync()
    {
        List<object> toDispose = BeginDispose();
    
        if (toDispose != null)
        {
            try
            {
                for (int i = toDispose.Count - 1; i >= 0; i--)
                {
                    object disposable = toDispose[i];
                    //åˆ¤æ–­æ˜¯å¦æ˜¯å®ç°äº†IAsyncDisposableæ¥å£çš„å¯¹è±¡
                    if (disposable is IAsyncDisposable asyncDisposable)
                    {
                        //è·å–DisposeAsyncæ–¹æ³•è¿”å›å€¼ä¹Ÿå°±æ˜¯ValueTask
                        ValueTask vt = asyncDisposable.DisposeAsync();
                        if (!vt.IsCompletedSuccessfully)
                        {
                            return Await(i, vt, toDispose);
                        }
                        //é˜»å¡ç­‰å¾…DisposeAsyncæ‰§è¡Œå®Œæˆ
                        vt.GetAwaiter().GetResult();
                    }
                    else
                    {
                        ((IDisposable)disposable).Dispose();
                    }
                }
            }
            catch (Exception ex)
            {
                return new ValueTask(Task.FromException(ex));
            }
        }
    
        return default;
    
        static async ValueTask Await(int i, ValueTask vt, List<object> toDispose)
        {
            //ç­‰å¾…DisposeAsyncæ–¹æ³•é‡Œçš„é€»è¾‘æ‰§è¡Œå®Œæˆ
            await vt.ConfigureAwait(false);
            i--;
    
            for (; i >= 0; i--)
            {
                object disposable = toDispose[i];
    
                if (disposable is IAsyncDisposable asyncDisposable)
                {
                    //ç­‰å¾…DisposeAsyncæ‰§è¡Œå®Œæˆ
                    await asyncDisposable.DisposeAsync().ConfigureAwait(false);
                }
                else
                {
                    ((IDisposable)disposable).Dispose();
                }
            }
        }
    }
    

å…¶å®æ ¸å¿ƒé€»è¾‘å’ŒåŒæ­¥é‡Šæ”¾æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯`IAsyncDisposable`æ¥å£ä¸­çš„`DisposeAsync()`æ–¹æ³•è¿”å›çš„å¼‚æ­¥ç›¸å…³çš„ValueTaskæ‰€ä»¥éœ€è¦è¿›è¡Œä¸€äº›ç­‰å¾…ç›¸å…³çš„æ“ä½œã€‚ä¸è¿‡æœ¬è´¨éƒ½æ˜¯å¾ªç¯é‡Šæ”¾`_disposables`é‡Œçš„æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®æ­£æ˜¯å½“å‰ä½œç”¨åŸŸé‡Œé‡Œå®ç°äº†IDisposableæˆ–IAsyncDisposableæ¥å£çš„å®ä¾‹ã€‚

> ä½¿ç”¨`CreateScope()`æˆ–`GetService()`æ–¹æ³•çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ¤æ–­å½“å‰ä½œç”¨åŸŸæ˜¯å¦é‡Šæ”¾ï¼Œè€Œè¿™ä¸ªæ ‡è¯†æ­£æ˜¯åœ¨`Dispose()`æˆ–`DisposeAsync()`ç½®ä¸º`true`çš„ã€‚æˆ‘ä»¬ä¸Šé¢æ–‡ç« ä¸­çš„é‚£ä¸ªå¼‚å¸¸çš„å¼•å‘ç‚¹ä¹Ÿæ­£æ˜¯è¿™é‡Œï¼Œä¹Ÿæ­£æ˜¯å› ä¸ºä½œç”¨åŸŸè¢«é‡Šæ”¾äº†è¡¨ç¤ºä¸ºç½®ä¸º`true`äº†ï¼Œæ‰€ä»¥GetServiceæ‰ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

### ç¾¤å‹é—®é¢˜è§£ç­”

å…³äº`ServiceProviderEngineScope`é‡è¦çš„ç›¸å…³å®ç°ï¼Œå’±ä»¬ä¸Šé¢å·²ç»å¤§è‡´çš„è®²è§£è¿‡äº†ã€‚å…¶å®æ¢ç´¢å®ƒçš„åŸåŠ¨åŠ›å°±æ˜¯å› ä¸ºç¾¤å‹é‡åˆ°çš„ä¸€äº›å…³äºè¿™æ–¹é¢çš„ç–‘é—®ï¼Œå¦‚æœäº†è§£äº†å®ƒçš„å®ç°çš„è¯ä¾¿èƒ½è½»æ¾çš„è§£é™¤å¿ƒä¸­çš„ç–‘é—®ï¼Œè¿˜åŸä¸€ä¸‹å½“æ—¶æœ‰ç–‘é—®çš„ä»£ç 

    IServiceCollection services = new ServiceCollection();
    services.AddScoped<Person>(provider => new() { Id = 1, Name = "yiå¿µä¹‹é—´", Sex = "Man" });
    
    IServiceProvider serviceProvider = services.BuildServiceProvider();
    Person person = null;
    using (IServiceScope serviceScope = serviceProvider.CreateScope())
    {
        person = serviceScope.ServiceProvider.GetService<Person>();
        Console.WriteLine(person.Name);
    }
    if (person == null)
    {
        Console.WriteLine("Personè¢«å›æ”¶äº†");
    }
    

ä»£ç å¤§è‡´æè¿°çš„å°±æ˜¯å½“æ—¶çš„è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼Œè¿™é‡Œæ¯«æ— ç–‘é—®å“ˆï¼Œå®Œå…¨åˆ¤æ–­ä¸å‡ºæ¥Personæ˜¯å¦å·²ç»è¢«å›æ”¶ã€‚é€šè¿‡ä¸Šé¢çš„æºç å’±ä»¬å°±å¯ä»¥çŸ¥é“ï¼Œæ— è®ºæ˜¯æ‰ç”¨`ServiceProviderEngineScope`çš„æ˜¯`Dispose()`æˆ–`DisposeAsync()`æ–¹æ³•(usingä¸Šé¢å’±ä»¬è¯´è¿‡äº†å°±æ˜¯è¯­æ³•ç³–)ï¼Œå…¶å®éƒ½æ˜¯è°ƒç”¨äº†å½“å‰ä½œç”¨åŸŸå†…å®ç°äº†`IDisposable`æˆ–`IAsyncDisposable`æ¥å£çš„å®ä¾‹é‡Œçš„`Dispose()`æˆ–`DisposeAsync()`æ–¹æ³•ã€‚

*   å³ä½¿å½“å‰å®ä¾‹å®ç°äº†`IDisposable`æˆ–`IAsyncDisposable`æ¥å£ï¼Œä¸”è°ƒç”¨äº†å®ä¾‹å†…çš„`Dispose()`æˆ–`DisposeAsync()`æ–¹æ³•ï¼Œä¹Ÿä¸æ„å‘³ç€å½“å‰å¯¹è±¡å·²ç»è¢«é‡Šæ”¾äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨Disposeæ–¹æ³•é‡Œå¤šåŠæ˜¯è¿™ä¸ªå¯¹è±¡é‡Œå¼•ç”¨çš„éæ‰˜ç®¡ä»£ç çš„é‡Šæ”¾å·¥ä½œï¼Œå¹¶ä¸æ„å‘³è¿™å½“å‰å¯¹è±¡è¢«é‡Šæ”¾äº†ã€‚
*   `IServiceScope`å®ç°ç±»`ServiceProviderEngineScope`é‡ŒResolvedServiceså±æ€§äº«å…ƒçš„å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå‘½å‘¨æœŸä¸º`ServiceLifetime.Scoped`çš„å®ä¾‹ã€‚è¿™äº›å®ä¾‹ä½•æ—¶è¢«å›æ”¶æ˜¯å–å†³äºä¸¤ç‚¹ï¼Œä¸€æ˜¯å½“å‰å®ä¾‹çš„è®¿é—®æ˜¯å¦è¶…å‡ºå½“å‰ä½œç”¨åŸŸï¼ŒäºŒæ˜¯å½“å‰å¯¹è±¡æ˜¯å¦æœ‰è¢«å¼•ç”¨ã€‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­`IServiceScope`å®ä¾‹è™½ç„¶å·²ç»è¶…å‡ºä½œç”¨äº†(å› ä¸ºåœ¨usingæ‹¬å·ä¹‹å¤–äº†)ï¼Œä½†æ˜¯Personå¤–å‡ºçš„æ ˆé‡Œè¿˜å¼•ç”¨ç€ResolvedServiceså­—å…¸é‡ŒPersonå¯¹è±¡çš„å®ä¾‹ï¼Œæ‰€ä»¥`GC`å³åƒåœ¾å›æ”¶æœºåˆ¶å¹¶ä¸ä¼šå›æ”¶è¿™ä¸ªå®ä¾‹ï¼Œå› ä¸ºå®ƒè¿˜åœ¨è¢«å¼•ç”¨ã€‚é‚£å°±æ„å‘³ç€å®ƒä¸èƒ½è¢«é‡Šæ”¾ï¼Œä¹Ÿå°±ä¸å­˜åœ¨Personå®ä¾‹è¢«å›æ”¶è¿™ä¹ˆä¸€è¯´äº†ã€‚

æ‰€ä»¥ï¼Œä¸Šé¢çš„é—®é¢˜è¯´èµ·æ¥å°±æ˜¯IServiceScopeä¸»è¦è§£å†³çš„æ˜¯å¯¹è±¡å–çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ç”¨æˆ‘çš„å­—å…¸å±æ€§ä¿ç•™äº†éœ€è¦ä¿ç•™çš„å¯¹è±¡å®ä¾‹ï¼Œå¯ä»¥é‡Šæ”¾è¢«å£°æ˜å¯ä»¥é‡Šæ”¾çš„æ“ä½œ(æ¯”å¦‚éæ‰˜ç®¡èµ„æºçš„é‡Šæ”¾)ã€‚ä½†æ˜¯ä½œç”¨åŸŸæœ¬èº«çš„å›æ”¶å’Œå†…éƒ¨ç®¡ç†çš„å¯¹è±¡çš„å›æ”¶æ˜¯äº¤ç»™`GC`æ¥è´Ÿè´£çš„ã€‚

> ç»†æƒ³ä¸€ä¸‹å°±ä¼šæ˜ç™½äº†ï¼Œæ‰˜ç®¡å¯¹è±¡çš„å›æ”¶æœ¬èº«å°±æ˜¯åƒåœ¾å›æ”¶å¤„ç†çš„ï¼Œå°±å’Œä½ è‡ªå·±å†™å•ä¾‹æ¨¡å¼æˆ–è€…ç›´æ¥newä¸€ä¸ªå¯¹è±¡å®ä¾‹çš„æ—¶å€™ï¼Œä½ ä¹Ÿæ²¡è€ƒè™‘å¯¹è±¡çš„å›æ”¶é—®é¢˜ï¼Œå› ä¸ºåƒåœ¾å›æ”¶æœºåˆ¶å·²ç»å¸®ä½ å¤„ç†äº†ã€‚

### æ€»ç»“

Â Â Â Â åœ¨.Net Coreä½“ç³»ä¸­IOCä¸€ç›´æ˜¯æ ¸å¿ƒæ¨¡å—ï¼Œä¸”å…³äºScopeçš„ä½œç”¨åŸŸçš„é—®é¢˜ï¼Œä¸€ç›´ä¼šæœ‰äººäº§ç”Ÿç–‘é—®ï¼Œæƒ³æ›´æ·±åˆ»çš„äº†è§£ä¸€ä¸‹è¿˜æ˜¯å¾—å¤šæ‹¿ä¸€äº›æ—¶é—´ç ”ç©¶ä¸€ä¸‹ã€‚æœ‰äº›çŸ¥è¯†ä¸æ˜¯é ä¸€æ—¶åŠä¼šçš„å­¦å°±èƒ½ç‰¢ç‰¢åœ°æŒæ¡ï¼Œéœ€è¦æ—¥å¸¸ä¸æ–­çš„ç§¯ç´¯å’Œä¸æ–­çš„è§£å†³é—®é¢˜ï¼Œæ‰èƒ½æŒæ¡çš„æ›´å¤šã€‚å› ä¸ºè®¾è®¡åˆ°çš„æºç æ¯”è¾ƒå¤šï¼Œè€Œä¸”ä¸ç†Ÿæ‚‰çš„è¯å¯èƒ½ä¸æ˜¯å¾ˆå¥½ç†è§£ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¹³æ—¶çš„ç§¯ç´¯ï¼Œç§¯ç´¯çš„è¶Šå¤šèƒ½è§£å†³çš„é—®é¢˜è¶Šå¤šï¼Œæ‰èƒ½é¿å…å…¥å‘ã€‚å¥½äº†å¤§è‡´æ€»ç»“ä¸€ä¸‹

*   å½“æˆ‘ä»¬ä½¿ç”¨`CreateScope()`æˆ–`CreateAsyncScope()`åˆ›å»ºå‡º`ServiceProviderEngineScope`æˆ–`AsyncServiceScope`å®ä¾‹çš„æ—¶å€™ï¼Œå³æˆ‘ä»¬é€šå¸¸æè¿°çš„ä½œç”¨åŸŸã€‚è¿™ä¸ªå®ä¾‹é‡ŒåŒ…å«äº†`ResolvedServices`å±æ€§å’Œ`Disposables`å±æ€§ï¼Œåˆ†åˆ«ä¿å­˜å½“å‰ä½œç”¨åŸŸå†…å³ç”Ÿå‘½å‘¨æœŸä¸º`ServiceLifetime.Scoped`å®ä¾‹å’Œå®ç°äº†`IDisposable`æˆ–`IAsyncDisposable`æ¥å£çš„å®ä¾‹ã€‚
*   ä½¿ç”¨`GetService()`æ–¹æ³•åœ¨å½“å‰ä½œç”¨åŸŸå†…è·å–å®ä¾‹çš„æ—¶å€™ï¼Œä¼šæ ¹æ®æœåŠ¡æ³¨å†Œæ—¶ä½¿ç”¨çš„ç”Ÿå‘½å‘¨æœŸåˆ¤æ–­æ˜¯å¦åŠ å…¥åˆ°å½“å‰ä½œç”¨åŸŸé‡Œäº«å…ƒçš„å®ä¾‹ã€‚å…¶ä¸­å•ä¾‹æ¥è‡ªäºæ ¹å®¹å™¨ï¼Œç¬æ—¶çš„æ¯æ¬¡éƒ½éœ€è¦åˆ›å»ºæ–°çš„å®ä¾‹æ‰€ä»¥ä¸éœ€è¦ä¿å­˜ï¼Œåªæœ‰ç”Ÿå‘½å‘¨æœŸä¸º`ServiceLifetime.Scoped`æ‰ä¿å­˜ã€‚ç¬æ—¶çš„å’ŒScopeçš„å¯¹è±¡åˆ›å»ºå‡ºæ¥çš„æ—¶å€™éƒ½ä¼šåˆ¤æ–­æ˜¯å¦å®ç°äº†`IDisposable`æˆ–`IAsyncDisposable`æ¥å£ï¼Œå¦‚æœæ˜¯åˆ™åŠ å…¥åˆ°`Disposables`å±æ€§çš„é›†åˆé‡Œç”¨äºé‡Šæ”¾ã€‚
*   å½“å‰ä½œç”¨åŸŸè¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œå³è°ƒç”¨`IServiceScope`å®ä¾‹`Dispose()`ç›¸å…³æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šéå†`Disposables`é›†åˆé‡Œçš„å¯¹è±¡è¿›è¡ŒDisposeç›¸å…³æ–¹æ³•è°ƒç”¨ï¼Œå¹¶ä¸æ˜¯å›æ”¶æ‰˜ç®¡åˆ°å½“å‰ä½œç”¨åŸŸå†…çš„å¯¹è±¡ï¼Œå› ä¸ºå¯¹è±¡ä½•æ—¶è¢«å›æ”¶å–å†³äº`GC`å³åƒåœ¾å›æ”¶æœºåˆ¶ã€‚

å¥½äº†åˆ°è¿™é‡Œå·®ä¸å¤šï¼Œæ¬¢è¿å¤§å®¶å¤šå¤šäº¤æµã€‚å¯’å†¬å·²è‡³ï¼Œå¸Œæœ›å¤§å®¶éƒ½æœ‰å¾¡å¯’çš„æ–¹æ³•ã€‚åˆ†äº«ä¸€ä¸‹çœ‹åˆ°è¿‡çš„ä¸€å¥è¯ã€‚ä½ èƒ½å¾—åˆ°çš„æœ€ç‰¢é çš„ä¸€å®šå¾—æ˜¯ä¾é ä½ è‡ªèº«å®åŠ›å»ºç«‹èµ·æ¥çš„ï¼Œè€Œä¸æ˜¯ä½ æ‰€å¤„çš„å¹³å°å»ºç«‹èµ·æ¥çš„ï¼Œå› ä¸ºä¾èµ–å¹³å°å»ºç«‹èµ·æ¥çš„ï¼Œç¦»å¼€è¿™ä¸ªå¹³å°ä¼šæ‰“æŠ˜ã€‚  
  

ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡ ![](https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png)