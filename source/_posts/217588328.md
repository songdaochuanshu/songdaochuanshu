---
layout: post
title: "你听说过OTA吗?"
date: "2022-11-17T20:19:40.989Z"
---
你听说过OTA吗?
=========

![你听说过OTA吗?](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022300630-1590541852.png) 我在这里和大家聊聊关于OTA的那些事儿，就以扫地机器人或者类似的其他电子产品为例吧。希望和同行多多交流，或许我所说的都是错的。

_以下内容为本人的学习笔记，如需要转载，请声明原文链接 [微信公众号「englyf」](https://mp.weixin.qq.com/s/M660Sc4ey1SxCpRT6vcM9g)[https://mp.weixin.qq.com/s/M660Sc4ey1SxCpRT6vcM9g](https://mp.weixin.qq.com/s/M660Sc4ey1SxCpRT6vcM9g)_

* * *

what？
=====

不知有多少朋友玩过或者接触过新能源车，虽然新能源囊括的范围很广，不过这里指的新能源车特指电动汽车，比如特斯拉等车企生产的电动车。

特斯拉车主应该对车载软件的自动更新功能很熟悉了，特斯拉会不定期通过wifi或者蜂窝网络(比如4G、5G信号网)，向车主推送最新的车载软件升级包，里边既可能包含有新功能的添加，也可能包括有对现有功能的完善补丁，这里所用的技术就是OTA。

OTA, 英文全称Over-the-air，直译成中文就是无线升级的意思。OTA执行过程，是不需要设备生产厂家或者专业人士携带专用工具对目标产品执行软件更新的。需要的条件是，让设备接入网络，自动接收软件更新包后，在设备所有者的同意下执行升级操作。

好了，这就是所谓的OTA。

why ?
=====

以往的电子产品，从设计阶段就会把整个产品的功能安排得明明白白，虽然也会预留OTA的升级功能，不过，仅是为了修补已有软件漏洞。

但是埃隆·马斯克就把互联网的产品思维引入汽车行业，不断开发迭代新软件功能，比如特斯拉一再宣称领先于同行的自动驾驶导航算法就不断地推出升级版本，甚至还有车载游戏推出，然后通过OTA的方式推送给特斯拉的客户。

以前的汽车，消费者更愿意把它当作出行工具，可能一买就是十年八载的事了。而现在的智能汽车除了不失出行的功能，更像是一件不断迭代变化的电子玩物工作站，随着新功能的不断推送，于是消费者更愿意提高消费频率为新功能埋单。

马斯克的造车思维开启了现代智能汽车时代，也对特斯拉的成就功不可没。这里边用到的OTA的技术就是必要的桥梁了。

how ？
=====

好了，上面都是在费口水，下面把电动车换成扫地机，就以扫地机器人为例，让我们来探讨一下怎么玩OTA升级。

推送的更新包从哪来？
----------

设备维护厂家负责跟踪对外已销售的产品质量反馈，及时收集客户的诉求，然后组织项目团队评估可行性和细节，再给研发团队制定目标并及时输出软件更新包，最后厂家还要负责把更新包发布到云端，并指定更新策略。

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022459857-905445807.jpg)

怎样开始推送呢？
--------

假设扫地机器人已经和云端绑定上，云端查询后台推送开关已打开则通过网络通知APP--设备有软件更新包可用，然后APP提示客户是否需要此次更新。一旦同意，APP则请求云端把更新包的下载链接发送给设备，接着设备进入下载软件更新包的流程，下载完成后再执行升级的具体操作。

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022512284-542039483.jpg)

升级过程在做什么？
---------

### 扫地机主机的升级

机器人从云端接收完软件更新包后，更新包暂存在内存中。为了避免升级过程中出现电量供应不足而中途关机的尴尬，升级开始之前，需要对机器的电量状态或者是否正在充电中进行自检，根据自检状态判断机器当前是否适合开始执行升级动作。

自检通过后，先对更新包文件做校验，以确保文件没有损坏或者被插入恶意文件信息，然后备份更新包文件(备份包的用处稍后解释)，解压更新包提取里边的各个软件资源，逐一执行升级，同时每完成一步操作需要向云端报告进度，直到最后所有解压所得的资源都被升级利用完毕。

如果其中任何一步出错需要中止升级流程，机器人都需要向云端报告状态，由云端提示APP结束OTA升级流程。升级完成后，所有软件都需重启，所有重启完成后需向云端报告软件当前的新版本号，APP再根据新版本号判断升级目标是否达成。无论升级是否成功，机器人都需要在最后把已备份的更新包从机器内部清理掉，以清除未升级结束的标志。

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022523791-67093359.jpg)

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022529239-297502513.jpg)

如果升级过程中途断电了，那么重启后，可以依据备份的更新包文件是否存在来判断是否需要重新进入升级流程。

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022538474-712789436.jpg)

### 基站的升级

最近主流的扫地机都已经进化到配备有清洗基站了，何为清洗基站？

这个基站的工作目标是为了给扫地机器人自动清理尘盒和拖布等污损组件，尽量做到避免购买扫地机的消费者介入扫地机的清扫工作过程中，减轻消费者的不必要负担，进一步满足消费者的舒适需求。

以往的扫地机给普通消费者的体验就是，工作过程中，需要人工不断介入，帮助清理机器的污损组件，否则机器就不能好好连续工作。为了解决这些痛点，基站的诞生和功能迭代就势不可挡了。

鉴于主机已经带有wifi模组可以和云端直接通信，而且与云端正常通信之前必须经过绑定的过程，为了简化功能设计，基站其实可以通过主机和云端通信，所以没有必要在基站也配置wifi模组了。

那么，主机(扫地机器人主体)怎么和基站协同工作呢？它们之间靠什么来互通有无呢？

目前行业内的基站通信方案绝大部分都采用433的无线通信协议与扫地机主机通信，但是433的通信丢包率实际上是很高的，导致在OTA升级这种高要求的使用场景下，通信环节要格外关注通信质量的问题，因此应用层通信协议必须包含容错的重发机制。

![1.JPG](https://img2022.cnblogs.com/blog/2962155/202211/2962155-20221118022547329-171128534.jpg)