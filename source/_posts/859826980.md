---
layout: post
title: "node.jsï¼šã€Šæ¥å£å®ç°æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‹"
date: "2022-10-29T10:21:56.181Z"
---
node.jsï¼šã€Šæ¥å£å®ç°æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½ã€‹
======================

ä½¿ç”¨node.jså†™ä¸Šä¼ æ–‡ä»¶å’Œä¸‹è½½æ–‡ä»¶çš„æ¥å£
----------------------

### **ä¸Šä¼ æ¥å£ï¼š**

å¼€å§‹å†™æ¥å£å‰ï¼Œæˆ‘ä»¬å…ˆå®‰è£…ä¸€ä¸ªä¸Šä¼ æ–‡ä»¶çš„æ’ä»¶ï¼š**npm install multer**

å®‰è£…æˆåŠŸåœ¨package.jsonæˆ–package-lock.jsonåŒ…ä¸­èƒ½çœ‹åˆ°

![](https://img2022.cnblogs.com/blog/2533283/202210/2533283-20221029144132886-1064700844.png)

åœ¨ä¸»æ–‡ä»¶å¼•å…¥æ¨¡å—ï¼š

    //é…ç½®æ–‡ä»¶ä¸Šä¼ ä¸´æ—¶ç›®å½•
    const upload = multer({
    Â  Â  dest:'./public/upload/temp'//ä¸´æ—¶å­˜æ”¾è·¯å¾„
    })

é…ç½®æ‰€æœ‰æ¥å£å¯ä¸‹è½½

    //è®¾ç½®æ‰€æœ‰æ¥å£éƒ½å…è®¸ä¸Šä¼ åŠŸèƒ½
    uploadFile.use(upload.any())

ç„¶ååœ¨è·¯ç”±ä¸­å¼•å…¥fsæ¨¡å—ï¼Œå†™ä¸€ä¸ªä¸Šä¼ åŠŸèƒ½çš„æ¥å£

    const fs = require("fs");//é‡æ–°å®šä¹‰æ–‡ä»¶æ¨¡å—
    
    router.post('/upload', (req, res) => {
        //æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
        if (!req.files) {//å¦‚æœreqæ˜¯ç©º è¿”å›400
            res.send({
                code: 400,
                msg: 'ä¸Šä¼ æ–‡ä»¶ä¸èƒ½ä¸ºç©º',
            });
            return;
        }
    
            //ä¿å­˜æ–‡ä»¶
            let files = req.files; //å°†è·å–çš„æ–‡ä»¶æ”¾åˆ°files
            let ret_files = []; //å®šä¹‰ä¸€ä¸ªç©ºæ•°ç»„
            for (let file of files) {//å°†fileså¾ªç¯æˆå•ä¸ª
                //è·å–åå­—åç¼€
                let file_ext = file.originalname.substring(file.originalname.lastIndexOf('.') + 1);
                //å°†æ–‡ä»¶åæ”¹ä¸ºæ—¶é—´æˆ³
                let file_name = new Date().getTime() + '.' + file_ext
                //ç§»åŠ¨æ–‡ä»¶å¹¶ä¸”ä¿®æ”¹æ–‡ä»¶åå­— 
                fs.renameSync(
                    process.cwd() + "/public/upload/temp/" + file.filename,//file.filenameï¼šæ–‡ä»¶æœ€åˆåå­—  /public/upload/temp/ä½œä¸ºä¸­è½¬ç«™
                    process.cwd() + "/public/upload/" + file_name, //file_nameï¼šæ—¶é—´æˆ³æ–°èµ·çš„åå­—
                );
                //å°†æ”¹å®Œçš„æ–‡ä»¶å†™è¿›ç©ºæ•°ç»„
                ret_files.push("./public/upload/" + file_name)
            }
    
            res.send({
                code: 200,
                msg: 'OK',
                data: ret_files //è¿”å›dataç»™å‰ç«¯é¢„è§ˆ
            })
    })

æµ‹è¯•ï¼š

![](https://img2022.cnblogs.com/blog/2533283/202210/2533283-20221029145434333-539991256.png)

åœ¨â€œ/public/upload/â€ä¸‹å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå·²ç»æœ‰ä¸€ä¸ªä»¥æ—¶é—´æˆ³å‘½åçš„æ–‡ä»¶äº†

![](https://img2022.cnblogs.com/blog/2533283/202210/2533283-20221029145626216-1353595464.png)

#### ä¸‹è½½æ¥å£ï¼š

    //ä¸‹è½½æ¥å£
    router.get('/download',async(req,res)=>{
        let file_name = req.query.file_name;
        let file_path = process.cwd()+'/public/upload/'+file_name;
        res.download(file_path);
    })

å®Œæ•´ä»£ç ï¼š

**uploadFile.js**

    const  express = require('express')//å¼•å…¥æ¨¡å—
    const uploadFile = express()//å®ä¾‹åŒ–
    const multer = require('multer')//å¼•å…¥å®ä¾‹åŒ–ä¸Šä¼ æ–‡ä»¶æ¨¡å—
    const port = 8080 //ç«¯å£
    
    //é…ç½®æ–‡ä»¶ä¸Šä¼ ä¸´æ—¶ç›®å½•
    const upload = multer({
        dest:'./public/upload/temp'//ä¸´æ—¶å­˜æ”¾è·¯å¾„
    })
    //è®¾ç½®æ‰€æœ‰æ¥å£éƒ½å…è®¸ä¸Šä¼ åŠŸèƒ½
    uploadFile.use(upload.any())
    
    //å¼•å…¥è·¯ç”±--æ¥å…¥å…¶ä»–æ¥å£
    uploadFile.use('/route',require("./router/fileRouter"))//é€šè¿‡è·¯ç”±çš„æ–¹å¼å°†ä¸Šä¼ å’Œä¸‹è½½æ¥å£å¼•å…¥
    
    //ç›‘å¬
    uploadFile.listen(port, () => {
        //ç›‘å¬æˆåŠŸæ‰“å°ä»¥ä¸‹è¯­å¥
        console.log(`Example app listening on port ${port}`)
    })

#### Â fileRouter.js:

    const express = require("express");
    const fs = require("fs");
    var router = express.Router();
    
    
    //postè¯·æ±‚ å†™ä¸ªæ¥å£æµ‹è¯•ä¸€ä¸‹è·¯ç”±ä¼šä¸ä¼šæŠ¥é”™ 
    // router.post('/test',function(req,res){
    //     // res.send(req.body)
    //     res.send('ok')
    // })
    
    //å†™ä¸Šä¼ æ¥å£
    router.post('/upload', (req, res) => {
        //æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
        if (!req.files) {//å¦‚æœreqæ˜¯ç©º è¿”å›400
            res.send({
                code: 400,
                msg: 'ä¸Šä¼ æ–‡ä»¶ä¸èƒ½ä¸ºç©º',
            });
            return;
        }
    
            //ä¿å­˜æ–‡ä»¶
            let files = req.files; //å°†è·å–çš„æ–‡ä»¶æ”¾åˆ°files
            let ret_files = []; //å®šä¹‰ä¸€ä¸ªç©ºæ•°ç»„
            for (let file of files) {//å°†fileså¾ªç¯æˆå•ä¸ª
                //è·å–åå­—åç¼€
                let file_ext = file.originalname.substring(file.originalname.lastIndexOf('.') + 1);
                //å°†æ–‡ä»¶åæ”¹ä¸ºæ—¶é—´æˆ³
                let file_name = new Date().getTime() + '.' + file_ext
                //ç§»åŠ¨æ–‡ä»¶å¹¶ä¸”ä¿®æ”¹æ–‡ä»¶åå­—
                fs.renameSync(
                    process.cwd() + "/public/upload/temp/" + file.filename,//file.filenameï¼šæ–‡ä»¶æœ€åˆåå­—
                    process.cwd() + "/public/upload/" + file_name, //file_nameï¼šæ—¶é—´æˆ³æ–°èµ·çš„åå­—
                );
                //å°†æ”¹å®Œçš„æ–‡ä»¶å†™è¿›ç©ºæ•°ç»„
                ret_files.push("./public/upload/" + file_name)
            }
    
            res.send({
                code: 200,
                msg: 'OK',
                data: ret_files //è¿”å›dataç»™å‰ç«¯é¢„è§ˆ
            })
    })
    
    //ä¸‹è½½æ¥å£
    router.get('/download',async(req,res)=>{
        let file_name = req.query.file_name;
        let file_path = process.cwd()+'/public/upload/'+file_name;
        res.download(file_path);
    })
    
    
    //3ã€æŠŠå®ƒåŠ åˆ°æ¨¡å—ä¸Š
    module.exports = router;

**ğŸ˜œå–œæ¬¢æ–‡ç« æˆ–æ–‡ç« å†…å®¹æœ‰å¸®åŠ©çš„è¯ç•™ä¸‹è¶³è¿¹é¼“åŠ±ä¸€ä¸‹åšä¸»å§~**