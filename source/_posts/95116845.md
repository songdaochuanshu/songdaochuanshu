---
layout: post
title: "SpringBootâ€”â€”è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®ä¸èµ·æ­¥ä¾èµ–"
date: "2023-03-18T01:10:28.726Z"
---
SpringBootâ€”â€”è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®ä¸èµ·æ­¥ä¾èµ–
========================

SpringBootâ€”â€”è‡ªå®šä¹‰è‡ªåŠ¨é…ç½®ä¸èµ·æ­¥ä¾èµ–
========================

SpringBootä¸ºæˆ‘ä»¬æä¾›äº†çµæ´»å¼ºå¤§çš„è‡ªåŠ¨é…ç½®ä¸èµ·æ­¥ä¾èµ–åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å‚è€ƒå…¶å®ç°åŸç†ï¼Œå®ç°ä¸“å±äºæˆ‘ä»¬è‡ªå·±çš„è‡ªåŠ¨é…ç½®ä¸èµ·æ­¥ä¾èµ–ã€‚  
ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯¹å…¶ç¨ä½œä¿®æ”¹ï¼Œè®©å®ƒé€‚ç”¨äºéSpringBootç¯å¢ƒï¼Œç”šè‡³æ˜¯ä½ç‰ˆæœ¬çš„Spring Frameworkç¯å¢ƒ

1è‡ªåŠ¨é…ç½®
-----

åœ¨ç¼–å†™è‡ªå·±çš„è‡ªåŠ¨é…ç½®ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹SpringBootè‡ªåŠ¨é…ç½®ç±»çš„å®ç°åŸç†ã€‚

SpringBootå¯ä»¥æ ¹æ®CLASSPATHã€é…ç½®é¡¹ç­‰æ¡ä»¶è‡ªåŠ¨è¿›è¡Œå¸¸è§„é…ç½®ï¼Œçœå»äº†æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨æŠŠä¸€æ¨¡ä¸€æ ·çš„é…ç½®å¤åˆ¶æ¥å¤åˆ¶å»çš„éº»çƒ¦ã€‚è¿™æ ·å¤§å¤§æå‡äº†å¼€å‘æ•ˆç‡ï¼  
åœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°è¿‡@SpringBootApplicationæ³¨è§£äº†ï¼ŒæŸ¥çœ‹è¿™ä¸ªæ³¨è§£ï¼Œå¯ä»¥å‘ç°å®ƒä¸Šé¢æ·»åŠ äº†ä¸€ä¸ª@EnableAutoConfigurationï¼ŒåŸºäºè¿™ä¸ªæ³¨è§£å°±å¯ä»¥å¼€å¯è‡ªåŠ¨é…ç½®åŠŸèƒ½ã€‚  
è¿™ä¸¤ä¸ªæ³¨è§£ä¸Šéƒ½æœ‰excludeå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å…¶ä¸­æ’é™¤ä¸€äº›ä¸æƒ³å¯ç”¨çš„è‡ªåŠ¨é…ç½®ç±»ã€‚  
å¦‚æœä¸æƒ³å¯ç”¨è‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼Œä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®**spring.boot.enableautoconfiguration=false**ï¼Œå…³é—­è¯¥åŠŸèƒ½ã€‚

### 1.1è‡ªåŠ¨é…ç½®çš„å®ç°åŸç†

è‡ªåŠ¨é…ç½®ç±»å…¶å®å°±æ˜¯æ·»åŠ äº†@Configurationçš„æ™®é€šJavaé…ç½®ç±»ï¼Œå®ƒåˆ©ç”¨Spring Framework 4.0åŠ å…¥çš„æ¡ä»¶æ³¨è§£**@Conditional**æ¥å®ç°**â€œæ ¹æ®ç‰¹å®šæ¡ä»¶å¯ç”¨ç›¸å…³é…ç½®ç±»â€**ï¼Œæ³¨è§£ä¸­ä¼ å…¥çš„Conditionç±»å°±æ˜¯ä¸åŒæ¡ä»¶çš„åˆ¤æ–­é€»è¾‘ã€‚SpringBootå†…ç½®äº†å¾ˆå¤šæ¡ä»¶æ³¨è§£ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š

æ¡ä»¶æ³¨è§£

ç”Ÿæ•ˆæ¡ä»¶

@ConditionalOnBean

å­˜åœ¨ç‰¹å®šåç§°ã€ç‰¹å®šç±»å‹ã€ç‰¹å®šæ³›å‹å‚æ•°æˆ–å¸¦æœ‰ç‰¹å®šæ³¨è§£çš„Bean

@ConditionalOnMissingBean

ä¸å‰è€…ç›¸åï¼Œä¸å­˜åœ¨ç‰¹å®šçš„Bean

@ConditionalOnClass

å­˜åœ¨ç‰¹å®šçš„ç±»

@ConditionalOnMissingClass

ä¸å‰è€…ç›¸åï¼Œä¸å­˜åœ¨ç‰¹å®šç±»

@ConditionalOnCloudPlatform

è¿è¡Œåœ¨ç‰¹å®šçš„äº‘å¹³å°ä¸Šï¼Œæˆªæ­¢2.6.3ç‰ˆæœ¬ï¼Œä»£è¡¨äº‘å¹³å°çš„æšä¸¾ç±»æ”¯æŒæ— äº‘å¹³å°ï¼Œå¯ä»¥é€šè¿‡spring.main.cloud-platformé…ç½®å¼ºåˆ¶ä½¿ç”¨çš„äº‘å¹³å°

@ConditionalOnExpression

æŒ‡å®šçš„SpELè¡¨è¾¾å¼ä¸ºçœŸ

@ConditionalOnJava

è¿è¡Œåœ¨æ»¡è¶³æ¡ä»¶çš„Javaä¸Šï¼Œå¯ä»¥æ¯”æŒ‡å®šç‰ˆæœ¬æ–°ï¼Œä¹Ÿå¯ä»¥æ¯”æŒ‡å®šç‰ˆæœ¬æ—§

@ConditionalOnJndi

æŒ‡å®šçš„JNDIä½ç½®å¿…é¡»å­˜åœ¨ä¸€ä¸ªï¼Œå¦‚æ²¡æœ‰æŒ‡å®šï¼Œåˆ™éœ€è¦å­˜åœ¨InitalContext

@ConditionalOnProperty

å±æ€§å€¼æ»¡è¶³ç‰¹å®šæ¡ä»¶ï¼Œæ¯”å¦‚ç»™å®šçš„å±æ€§å€¼éƒ½ä¸èƒ½ä¸ºfalse

@ConditionalOnResource

å­˜åœ¨ç‰¹å®šèµ„æº

@ConditionalOnSingleCandidate

å½“å‰ä¸Šä¸‹æ–‡ä¸­ï¼Œç‰¹å®šç±»å‹çš„Beanæœ‰ä¸”ä»…æœ‰ä¸€ä¸ª

@ConditionalOnWarDeployment

åº”ç”¨ç¨‹åºæ˜¯é€šè¿‡ä¼ ç»Ÿçš„Waræ–¹å¼éƒ¨ç½²çš„ï¼Œè€Œéå†…åµŒå®¹å™¨

@ConditionalOnWebApplication

åº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åº

@ConditionalOnNotWebApplication

ä¸å‰è€…ç›¸åï¼Œåº”ç”¨ç¨‹åºä¸æ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åº

ğŸ‘‡æ›´å¤šå¦‚å›¾æ‰€ç¤ºï¼Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†ï¼š  
![image](https://img2023.cnblogs.com/blog/3036686/202303/3036686-20230317215754434-1018878919.png)

ä»¥@ConditionalOnClassæ³¨è§£ä¸ºä¾‹ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹æ‰€ç¤ºï¼Œ@TargetæŒ‡æ˜è¯¥æ³¨è§£å¯ç”¨äºç±»å‹å’Œæ–¹æ³•å®šä¹‰ï¼Œ@RetentionæŒ‡æ˜æ³¨è§£çš„ä¿¡æ¯åœ¨è¿è¡Œæ—¶ä¹Ÿèƒ½è·å–åˆ°ï¼Œè€Œå…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯OnClassConditionæ¡ä»¶ç±»ï¼Œé‡Œé¢æ˜¯å…·ä½“çš„æ¡ä»¶è®¡ç®—é€»è¾‘ï¼š

    @Target({ ElementType.TYPE, ElementType.METHOD })
    @Retention(RetentionPolicy.RUNTIME)
    @Documented
    @Conditional(OnClassCondition.class)
    public @interface ConditionalOnClass {
    
    	/**
    	 * The classes that must be present. Since this annotation is parsed by loading class
    	 * bytecode, it is safe to specify classes here that may ultimately not be on the
    	 * classpath, only if this annotation is directly on the affected component and
    	 * <b>not</b> if this annotation is used as a composed, meta-annotation. In order to
    	 * use this annotation as a meta-annotation, only use the {@link #name} attribute.
    	 * @return the classes that must be present
    	 */
    	Class<?>[] value() default {};
    
    	/**
    	 * The classes names that must be present.
    	 * @return the class names that must be present.
    	 */
    	String[] name() default {};
    
    }
    

äº†è§£äº†æ¡ä»¶æ³¨è§£åï¼Œå†æ¥çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•ä¸é…ç½®ç±»ç»“åˆä½¿ç”¨çš„ã€‚ä»¥JdbcTemplateAutoConfigurationä¸ºä¾‹ï¼š

    
    @AutoConfiguration(after = DataSourceAutoConfiguration.class)
    @ConditionalOnClass({ DataSource.class, JdbcTemplate.class })
    @ConditionalOnSingleCandidate(DataSource.class)
    @EnableConfigurationProperties(JdbcProperties.class)
    @Import({ DatabaseInitializationDependencyConfigurer.class, JdbcTemplateConfiguration.class,
    		NamedParameterJdbcTemplateConfiguration.class })
    public class JdbcTemplateAutoConfiguration {
    }
    

å¯ä»¥çœ‹åˆ°è¿™ä¸ªé…ç½®ç±»çš„ç”Ÿæ•ˆæ¡ä»¶æ˜¯å­˜åœ¨DataSourceå’ŒJdbcTemplateç±»ï¼Œä¸”åœ¨ä¸Šä¸‹æ–‡ä¸­åªèƒ½æœ‰ä¸€ä¸ªDataSourceã€‚æ­¤å¤–ï¼Œè¿™ä¸ªè‡ªåŠ¨é…ç½®éœ€è¦åœ¨DataSourceAutoConfigurationä¹‹åå†é…ç½®ï¼ˆå¯ä»¥ç”¨@AutoConfigureBeforeã€@AutoConfigureAfterå’Œ@AutoConfigureOrderæ¥æ§åˆ¶è‡ªåŠ¨é…ç½®çš„é¡ºåºï¼‰

2ç¼–å†™è‡ªå·²çš„è‡ªåŠ¨é…ç½®
----------

æ ¹æ®ä¸Šé¢çš„æè¿°ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œè¦ç¼–å†™è‡ªå·±çš„è‡ªåŠ¨é…ç½®ï¼Œåªéœ€è¦ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š  
ï¼ˆ1ï¼‰ç¼–å†™å¸¸è§„çš„é…ç½®ç±»  
ï¼ˆ2ï¼‰ä¸ºé…ç½®ç±»å¢åŠ ç”Ÿæ•ˆæ¡ä»¶ä¸é¡ºåº  
ï¼ˆ3ï¼‰åœ¨/META-INF/spring.factoriesæ–‡ä»¶ä¸­æ·»åŠ è‡ªåŠ¨é…ç½®ç±»

### 2.1åˆ›å»ºé¡¹ç›®

åœ¨Spring Initializrä¸­ï¼Œåˆ›å»ºä¸€ä¸ªMavenå·¥ç¨‹ï¼Œæ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

        <dependencies>
            <!--    æ·»åŠ è‡ªåŠ¨é…ç½®æ‰€ä½¿ç”¨çš„åŒ…    -->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-autoconfigure</artifactId>
            </dependency>
            <!--    ç”¨æˆ·åœ¨å†™é…ç½®æ–‡ä»¶æ—¶ï¼Œä¼šæœ‰æç¤ºæ•ˆæœ    -->
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-configuration-processor</artifactId>
            </dependency>
    
            <dependency>
                <groupId>org.projectlombok</groupId>
                <artifactId>lombok</artifactId>
                <optional>true</optional>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-test</artifactId>
                <scope>test</scope>
            </dependency>
        </dependencies>
    

### 2.2ç¼–å†™ä¸€ä¸ªç®€å•çš„MyAutoConfigureç±»å’Œé…ç½®ç±»Bean

ç¼–å†™ä¸€ä¸ªç®€å•çš„MyAutoConfigureç±»ï¼Œä¸Šé¢å¢åŠ äº†@Configurationæ³¨è§£ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼Œè¿™ä¸ªé…ç½®ç±»çš„ç”Ÿæ•ˆæ¡ä»¶æ˜¯myconfig.readyå±æ€§çš„å€¼ä¸ºtrueï¼Œé™¤æ­¤ä¹‹å¤–çš„å€¼æˆ–è€…ä¸å­˜åœ¨è¯¥å±æ€§æ—¶MyAutoConfigureéƒ½ä¸ä¼šç”Ÿæ•ˆã€‚

    /**
     * TODO 1ã€ç¼–å†™é…ç½®ç±»å¹¶æŒ‡å®šæ–‡ä»¶
     *
     * @author ss_419
     * @version 1.0
     * @date 2023/3/17 21:24
     */
    @Configuration
    
    @EnableConfigurationProperties(CommonBean.class)
    @ConditionalOnProperty(name = "myconfig.ready",havingValue = "true")
    public class MyAutoConfigure {
    }
    
    

    /**
     * TODO 2ã€åˆ›å»ºé…ç½®ç±»Bean
     *
     * @author ss_419
     * @version 1.0
     * @date 2023/3/17 22:40
     */
    @ConfigurationProperties("myconfigbean")
    @Data
    public class MyConfigBean {
        private boolean ready;
        private String info;
    }
    

### 2.3é…ç½®spring.factoriesæ–‡ä»¶

ä¸ºäº†è®©SpringBootèƒ½æ‰¾åˆ°æˆ‘ä»¬å†™çš„è¿™ä¸ªé…ç½®ç±»ï¼Œæˆ‘ä»¬éœ€è¦åœ¨src/resourcesç›®å½•ä¸­åˆ›å»ºMETA-INF/spring.factoriesæ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š

    org.springframework.boot.autoconfigure.EnableAutoConfiguration=org.pp.myspringbootstart.beans.MyAutoConfigure
    

### 2.4æµ‹è¯•è‡ªåŠ¨é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

    @SpringBootTest
    public class MyConfigurationEnableTest {
    
        @Autowired
        private ApplicationContext applicationContext;
    
        @Test
        void testPropertiesBeanAvailableTest() throws Exception {
            assertNotNull(applicationContext.getBean(MyConfigBean.class));
            assertTrue(applicationContext.containsBean("org.pp.myspringbootstart.beans.MyConfigBean"));
        }
    
        @Test
        void testPropertyValues(){
            MyConfigBean bean = applicationContext.getBean(MyConfigBean.class);
            assertTrue(bean.isReady());
            assertEquals("hello", bean.getInfo());
        }
    }