---
layout: post
title: "åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šåŒæ­¥å¹¶è¡ŒSGDç®—æ³•çš„å®ç°ä¸å¤æ‚åº¦åˆ†æï¼ˆPySparkï¼‰"
date: "2022-06-26T04:31:15.950Z"
---
åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šåŒæ­¥å¹¶è¡ŒSGDç®—æ³•çš„å®ç°ä¸å¤æ‚åº¦åˆ†æï¼ˆPySparkï¼‰
===================================

![åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šåŒæ­¥å¹¶è¡ŒSGDç®—æ³•çš„å®ç°ä¸å¤æ‚åº¦åˆ†æï¼ˆPySparkï¼‰](https://img2022.cnblogs.com/blog/1784958/202206/1784958-20220626112341463-761303010.png) å…¶ä¸­ï¼ŒSSGDç®—æ³•æ¯æ¬¡ä¾æ®æ¥è‡ª ğ¾ä¸ªä¸åŒçš„å·¥ä½œèŠ‚ç‚¹ä¸Šçš„æ ·æœ¬çš„æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹ï¼Œè®¾æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šçš„å°æ‰¹é‡å¤§å°ä¸º ğ‘ï¼Œåˆ™è¯¥ç®—æ³•ç­‰ä»·äºæ‰¹é‡å¤§å°ä¸º ğ‘ğ¾ çš„å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ³•ã€‚å°½ç®¡æ¢¯åº¦çš„è®¡ç®—å¯ä»¥è¢«åˆ†æ‘Šåˆ°ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œç„¶è€Œæ¢¯åº¦ä¸‹é™çš„è¿­ä»£æ˜¯ä¸²è¡Œçš„ã€‚æ¯è½®è¿­ä»£ä¸­ï¼ŒSparkä¼šæ‰§è¡ŒåŒæ­¥å±éšœ(synchronization barrier)æ¥ç¡®ä¿åœ¨å„workerå¼€å§‹ä¸‹ä¸€è½®è¿­ä»£å‰wå·²è¢«æ›´æ–°å®Œæ¯•ã€‚å¦‚æœå­˜åœ¨æ‰é˜Ÿè€…(stragglers)ï¼Œå…¶å®ƒworkerå°±ä¼šç©ºé—²(idle)ç­‰å¾…ï¼Œç›´åˆ°ä¸‹ä¸€è½®è¿­ä»£ã€‚

1 åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ æ¦‚è¿°
-----------

å¤§è§„æ¨¡æœºå™¨å­¦ä¹ è®­ç»ƒå¸¸é¢ä¸´è®¡ç®—é‡å¤§ã€è®­ç»ƒæ•°æ®å¤§ï¼ˆå•æœºå­˜ä¸ä¸‹ï¼‰ã€æ¨¡å‹è§„æ¨¡å¤§çš„é—®é¢˜ï¼Œå¯¹æ­¤åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚

1ï¼‰å¯¹äºè®¡ç®—é‡å¤§çš„é—®é¢˜ï¼Œåˆ†å¸ƒå¼å¤šæœºå¹¶è¡Œè¿ç®—å¯ä»¥åŸºæœ¬è§£å†³ã€‚ä¸è¿‡éœ€è¦ä¸ä¼ ç»ŸHPCä¸­çš„å…±äº«å†…å­˜å¼çš„å¤šçº¿ç¨‹å¹¶è¡Œè¿ç®—ï¼ˆå¦‚OpenMPï¼‰ä»¥åŠCPU-GPUè®¡ç®—æ¶æ„åšåŒºåˆ†ï¼Œè¿™ä¸¤ç§å•æœºçš„è®¡ç®—æ¨¡å¼æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸º**è®¡ç®—å¹¶è¡Œ**ï¼‰ã€‚

2ï¼‰å¯¹äºè®­ç»ƒæ•°æ®å¤§çš„é—®é¢˜ï¼Œéœ€è¦å°†æ•°æ®è¿›è¡Œåˆ’åˆ†å¹¶åˆ†é…åˆ°å¤šä¸ªå·¥ä½œèŠ‚ç‚¹(Worker)ä¸Šè¿›è¡Œè®­ç»ƒï¼Œè¿™ç§æŠ€å·§ä¸€èˆ¬è¢«ç§°ä¸º**æ•°æ®å¹¶è¡Œ**ã€‚æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¼šæ ¹æ®å±€éƒ¨æ•°æ®è®­ç»ƒå‡ºä¸€ä¸ªæœ¬åœ°æ¨¡å‹ï¼Œå¹¶ä¸”ä¼šæŒ‰ç…§ä¸€å®šçš„è§„å¾‹å’Œå…¶ä»–å·¥ä½œèŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼ˆé€šä¿¡å†…å®¹ä¸»è¦æ˜¯æœ¬åœ°æ¨¡å‹å‚æ•°æˆ–è€…å‚æ•°æ›´æ–°ï¼‰ï¼Œä»¥ä¿è¯æœ€ç»ˆå¯ä»¥æœ‰æ•ˆæ•´åˆæ¥è‡ªå„ä¸ªå·¥ä½œèŠ‚ç‚¹çš„è®­ç»ƒç»“æœå¹¶å¾—åˆ°å…¨å±€çš„æœºå™¨å­¦ä¹ æ¨¡å‹ã€‚

![NLPå¤šä»»åŠ¡å­¦ä¹ ](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2052664/o_211211083948_%E6%95%B0%E6%8D%AE%E5%B9%B6%E8%A1%8C.png)

> å¦‚æœæ˜¯è®­ç»ƒæ•°æ®çš„æ ·æœ¬é‡æ¯”è¾ƒå¤§ï¼Œåˆ™éœ€è¦å¯¹æ•°æ®æŒ‰ç…§æ ·æœ¬è¿›è¡Œåˆ’åˆ†ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ•°æ®æ ·æœ¬åˆ’åˆ†â€ï¼ŒæŒ‰å®ç°æ–¹æ³•å¯åˆ†ä¸ºâ€œéšæœºé‡‡æ ·æ³•â€å’Œâ€œç½®ä¹±åˆ‡åˆ†æ³•â€ã€‚æ ·æœ¬åˆ’åˆ†çš„åˆç†æ€§åœ¨äºæœºå™¨å­¦ä¹ ä¸­çš„ç»éªŒé£é™©å‡½æ•°å…³äºæ ·æœ¬æ˜¯å¯åˆ†çš„ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªå­é›†ä¸Šçš„å±€éƒ¨æ¢¯åº¦å¹³å‡ï¼Œä»å¯å¾—åˆ°æ•´ä¸ªç»éªŒé£é™©å‡½æ•°çš„æ¢¯åº¦ã€‚

> å¦‚æœè®­ç»ƒæ•°æ®çš„ç»´åº¦è¾ƒé«˜ï¼Œè¿˜å¯å¯¹æ•°æ®æŒ‰ç…§ç»´åº¦è¿›è¡Œåˆ’åˆ†ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œæ•°æ®ç»´åº¦åˆ’åˆ†â€ã€‚å®ƒç›¸è¾ƒæ•°æ®æ ·æœ¬åˆ’åˆ†è€Œè¨€ï¼Œä¸æ¨¡å‹æ€§è´¨å’Œä¼˜åŒ–æ–¹æ³•çš„è€¦åˆåº¦æ›´é«˜ã€‚å¦‚ç¥ç»ç½‘ç»œä¸­å„ç»´åº¦é«˜åº¦è€¦åˆï¼Œå°±éš¾ä»¥é‡‡ç”¨æ­¤æ–¹å¼ã€‚ä¸è¿‡ï¼Œå†³ç­–æ ‘å¯¹ç»´åº¦çš„å¤„ç†ç›¸å¯¹ç‹¬ç«‹å¯åˆ†ï¼Œå°†æ•°æ®æŒ‰ç»´åº¦åˆ’åˆ†åï¼Œå„èŠ‚ç‚¹å¯ç‹¬ç«‹è®¡ç®—å±€éƒ¨ç»´åº¦å­é›†ä¸­å…·æœ‰æœ€ä¼˜ä¿¡æ¯å¢ç›Šçš„ç»´åº¦ï¼Œç„¶åè¿›è¡Œæ±‡æ€»ã€‚æ­¤å¤–ï¼Œåœ¨çº¿æ€§æ¨¡å‹ä¸­ï¼Œæ¨¡å‹å‚æ•°ä¸æ•°æ®ç»´åº¦æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ•…æ•°æ®ç»´åº¦åˆ’åˆ†å¸¸ä¸ä¸‹é¢æåˆ°çš„æ¨¡å‹å¹¶è¡Œç›¸äº’ç»“åˆã€‚

3ï¼‰å¯¹äºæ¨¡å‹è§„æ¨¡å¤§çš„é—®é¢˜ï¼Œåˆ™éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œåˆ’åˆ†ï¼Œå¹¶ä¸”åˆ†é…åˆ°ä¸åŒçš„å·¥ä½œèŠ‚ç‚¹ä¸Šè¿›è¡Œè®­ç»ƒï¼Œè¿™ç§æŠ€å·§ä¸€èˆ¬è¢«ç§°ä¸º**æ¨¡å‹å¹¶è¡Œ**ã€‚ä¸æ•°æ®å¹¶è¡Œä¸åŒï¼Œæ¨¡å‹å¹¶è¡Œçš„æ¡†æ¶ä¸‹å„ä¸ªå­æ¨¡å‹ä¹‹é—´çš„ä¾èµ–å…³ç³»éå¸¸å¼ºï¼Œå› ä¸ºæŸä¸ªå­æ¨¡å‹çš„è¾“å‡ºå¯èƒ½æ˜¯å¦å¤–ä¸€ä¸ªå­æ¨¡å‹çš„è¾“å…¥ï¼Œå¦‚æœä¸è¿›è¡Œä¸­é—´è®¡ç®—ç»“æœçš„é€šä¿¡ï¼Œåˆ™æ— æ³•å®Œæˆæ•´ä¸ªæ¨¡å‹è®­ç»ƒã€‚å› æ­¤ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œæ¨¡å‹å¹¶è¡Œç›¸æ¯”æ•°æ®å¹¶è¡Œå¯¹é€šä¿¡çš„è¦æ±‚æ›´é«˜ã€‚

![NLPå¤šä»»åŠ¡å­¦ä¹ ](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2052664/o_211211083912_%E6%A8%A1%E5%9E%8B%E5%B9%B6%E8%A1%8C.png)

è¿™é‡Œæä¸€ä¸‹æ•°æ®æ ·æœ¬åˆ’åˆ†ä¸­çš„å‡ ç§åˆ’åˆ†æ–¹å¼ã€‚ç»™å®š\\(n\\)ä¸ª\\(d\\)ç»´æ ·æœ¬å’Œ\\(K\\)ä¸ªå·¥ä½œèŠ‚ç‚¹ï¼Œæ•°æ®æ ·æœ¬åˆ’åˆ†éœ€è¦å®Œæˆçš„ä»»åŠ¡æ˜¯å°†\\(n\\)ä¸ªæ ·æœ¬ä»¥æŸç§å½¢å¼åˆ†é…åˆ°\\(K\\)ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šã€‚

éšæœºé‡‡æ ·æ³•ä¸­æˆ‘ä»¬ç‹¬ç«‹åŒåˆ†å¸ƒåœ°ä»\\(n\\)ä¸ªæ ·æœ¬ä¸­æœ‰æ”¾å›éšæœºé‡‡æ ·ï¼Œæ¯æŠ½å–ä¸€ä¸ªæ ·æœ¬å°†å…¶åˆ†é…åˆ°ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ªè¿‡ç¨‹ç­‰ä»·äºå…ˆéšæœºé‡‡\\(n\\)ä¸ªæ ·æœ¬ï¼Œç„¶åå‡ç­‰åœ°åˆ’åˆ†ä¸º\\(K\\)ä»½ã€‚

éšæœºé‡‡æ ·æ³•ä¾¿äºç†è®ºåˆ†æï¼Œä½†åŸºäºå®ç°éš¾åº¦çš„è€ƒè™‘ï¼Œåœ¨å·¥ç¨‹ä¸­æ›´å¤šé‡‡ç”¨çš„æ˜¯åŸºäºç½®ä¹±åˆ‡åˆ†çš„åˆ’åˆ†æ–¹æ³•ã€‚å³ç°å°†\\(n\\)ä¸ªæ ·æœ¬éšæœºç½®ä¹±ï¼Œå†æŠŠæ•°æ®å‡ç­‰åœ°åˆ‡åˆ†ä¸º\\(K\\)ä»½ï¼Œå†åˆ†é…åˆ°\\(K\\)ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œè®­ç»ƒã€‚ç½®ä¹±åˆ‡åˆ†ç›¸å½“äºæ— æ”¾å›é‡‡æ ·ï¼Œæ¯ä¸ªæ ·æœ¬éƒ½ä¼šå‡ºç°åœ¨æŸä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œæ¯ä¸ªå·¥ä½œèŠ‚ç‚¹çš„æœ¬åœ°æ•°æ®æ²¡æœ‰é‡å¤ï¼Œæ•…è®­ç»ƒæ•°æ®çš„ä¿¡æ¯é‡ä¸€èˆ¬ä¼šæ›´å¤§ã€‚æˆ‘ä»¬ä¸‹é¢çš„åˆ’åˆ†æ–¹å¼éƒ½é»˜è®¤é‡‡å–ç½®ä¹±åˆ‡åˆ†çš„æ–¹æ³•ã€‚

æˆ‘ä»¬åœ¨åé¢çš„åšå®¢ä¸­ä¼šä¾æ¬¡ä»‹ç»é’ˆå¯¹æ•°æ®å¹¶è¡Œå’Œæ¨¡å‹å¹¶è¡Œè®¾è®¡çš„å„ç§åˆ†å¸ƒå¼ç®—æ³•ã€‚æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬å…ˆçœ‹æ•°æ®å¹¶è¡Œä¸­æœ€å¸¸ç”¨çš„åŒæ­¥å¹¶è¡ŒSGDç®—æ³•ï¼ˆä¹Ÿç§°SSGDï¼‰æ˜¯å¦‚ä½•åœ¨Sparkå¹³å°ä¸Šå®ç°çš„ã€‚

2 åŒæ­¥å¹¶è¡ŒSGDç®—æ³•æè¿°ä¸å®ç°
----------------

SSGD\[1\]å¯¹åº”çš„ä¼ªä»£ç å¯ä»¥è¡¨è¿°å¦‚ä¸‹ï¼š

![](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2074226/o_2cf77529.png
)

å…¶ä¸­ï¼ŒSSGDç®—æ³•æ¯æ¬¡ä¾æ®æ¥è‡ª\\(K\\)ä¸ªä¸åŒçš„å·¥ä½œèŠ‚ç‚¹ä¸Šçš„æ ·æœ¬çš„æ¢¯åº¦æ¥æ›´æ–°æ¨¡å‹ï¼Œè®¾æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šçš„å°æ‰¹é‡å¤§å°ä¸º\\(b\\)ï¼Œåˆ™è¯¥ç®—æ³•ç­‰ä»·äºæ‰¹é‡å¤§å°ä¸º\\(bK\\)  
çš„å°æ‰¹é‡éšæœºæ¢¯åº¦ä¸‹é™æ³•ã€‚

æˆ‘ä»¬ä»¤\\(f\\)ä¸ºé€»è¾‘å›å½’é—®é¢˜çš„æ­£åˆ™åŒ–ç»éªŒé£é™©ã€‚è®¾\\(w\\)ä¸ºæƒå€¼(æœ€åä¸€ç»´ä¸ºåç½®)ï¼Œæ ·æœ¬æ€»æ•°ä¸º\\(n\\)ï¼Œ\\(\\{(x\_i, y\_i)\\}\_{i=1}^n\\)ä¸ºè®­ç»ƒæ ·æœ¬é›†ã€‚æ ·æœ¬ç»´åº¦ä¸º\\(d\\)ï¼Œ\\(x\_i\\in \\mathbb{R}^{d+1}\\)ï¼ˆæœ€åä¸€ç»´æ‰©å……ï¼‰ï¼Œ\\(y\_i\\in\\{0, 1\\}\\)ã€‚åˆ™\\(f\\)è¡¨ç¤ºä¸ºï¼š

\\\[f(w) = \\frac{1}{n} \\sum\_{i=1}^{n}\\left\[y\_{i} \\log \\pi\_{w}\\left(x\_{i}\\right)+\\left(1-y\_{i}\\right) \\log \\left(1-\\pi\_w\\left(x\_{i}\\right)\\right)\\right\] + \\lambda R(w) \\\]

è¿™é‡Œ

\\\[\\begin{aligned} \\pi\_w(x) = p(y=1 \\mid x; w) =\\frac{1}{1+\\exp \\left(-w^{T} x\\right)} \\end{aligned} \\\]

å…¶æ¢¯åº¦è¡¨ç¤ºå¦‚ä¸‹ï¼š

\\\[\\nabla f{(w)} = -\\sum\_{i=1}^n(y\_i - \\frac{1}{\\exp(-w^Tx)+1})x\_i + \\lambda\\nabla R(w) \\\]

è¿™é‡Œæ­£åˆ™é¡¹çš„æ¢¯åº¦\\(\\nabla R(w)\\)è¦åˆ†æƒ…å†µè®¨è®ºï¼š

**(1) ä¸ä½¿ç”¨æ­£åˆ™åŒ–**

æ­¤æ—¶æ˜¾ç„¶\\(\\nabla R(w)=0\\)ã€‚

**(2) L2æ­£åˆ™åŒ–(\\(\\frac{1}{2}\\lVert w\\rVert^2\_2\\))**

æ­¤æ—¶\\(\\nabla R(w)=w\\)ã€‚

**(3) L1æ­£åˆ™åŒ–(\\(\\lVert w \\rVert\_1\\))**

è¯¥å‡½æ•°ä¸æ˜¯åœ¨æ¯ä¸ªç”µéƒ½å¯¹\\(w\\)å¯å¯¼ï¼Œåªæ¥é‡‡ç”¨å‡½æ•°çš„æ¬¡æ¢¯åº¦(subgradient)æ¥è¿›è¡Œæ¢¯åº¦ä¸‹é™ã€‚\\(\\lVert w \\rVert\_1\\)çš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æ¬¡æ¢¯åº¦ä¼°è®¡æ˜¯\\(\\text{sign}(w)\\)ã€‚ç›¸æ¯”äºæ ‡å‡†çš„æ¢¯åº¦ä¸‹é™ï¼Œæ¬¡æ¢¯åº¦ä¸‹é™æ³•ä¸èƒ½ä¿è¯æ¯ä¸€è½®è¿­ä»£éƒ½ä½¿ç›®æ ‡å‡½æ•°å˜å°ï¼Œæ‰€ä»¥å…¶æ”¶æ•›é€Ÿåº¦è¾ƒæ…¢ã€‚

**(4) Elastic netæ­£åˆ™åŒ–(\\(\\alpha \\lVert w \\rVert\_1 + (1-\\alpha)\\frac{1 }{2}\\lVert w\\rVert^2\_2\\))**

å¯¹\\(\\lVert w\\rVert\_1\\)ä½¿ç”¨æ¬¡æ¢¯åº¦è®¡ç®—å¼ï¼Œ\\(\\frac{1}{2}\\lVert w\\rVert\_2^2\\)ä½¿ç”¨å…¶æ¢¯åº¦è®¡ç®—å¼ï¼Œå¾—æœ€ç»ˆçš„æ¢¯åº¦è®¡ç®—å¼ä¸º\\(\\alpha \\text{sign}(w) + (1-\\alpha) w\\)ã€‚

æˆ‘ä»¬çº¦å®šè®¡ç®—ç¬¬\\(K\\)ä¸ªèŠ‚ç‚¹å°æ‰¹é‡\\(\\mathcal{I\_k}\\)çš„ç»éªŒé£é™©çš„æ¢¯åº¦\\(\\nabla f\_{\\mathcal{I\_k}}(x)\\)æ—¶ä¸åŒ…å«æ­£åˆ™é¡¹çš„æ¢¯åº¦ï¼Œæœ€ç»ˆå°†\\(K\\)ä¸ªèŠ‚ç‚¹èšåˆåå†åŠ ä¸Šæ­£åˆ™é¡¹æ¢¯åº¦ã€‚

ç”¨PySparkå¯¹ä¸Šè¿°ç®—æ³•å®ç°å¦‚ä¸‹ï¼š

    from sklearn.datasets import load_breast_cancer
    import numpy as np
    from pyspark.sql import SparkSession
    from operator import add
    from sklearn.model_selection import train_test_split
    from sklearn.metrics import accuracy_score
    
    n_slices = 3  # Number of Slices
    n_iterations = 300  # Number of iterations
    eta = 10  # iteration step_size, because gradient sum is divided by minibatch size, it shoulder be larger
    mini_batch_fraction = 0.1 # the fraction of mini batch sample 
    lam = 0.001 # coefficient of regular term
    
    def logistic_f(x, w):
        return 1 / (np.exp(-x.dot(w)) + 1)
    
    
    def gradient(point: np.ndarray, w: np.ndarray):
        """ Compute linear regression gradient for a matrix of data points
        """
        y = point[-1]    # point label
        x = point[:-1]   # point coordinate
        # For each point (x, y), compute gradient function, then sum these up
        # notice thet we need to compute minibatch size, so return(g, 1)
        return - (y - logistic_f(x, w)) * x
    
    
    def reg_gradient(w, reg_type="l2", alpha=0):
        """ gradient for reg_term
        """ 
        assert(reg_type in ["none", "l2", "l1", "elastic_net"])
        if reg_type == "none":
            return 0
        elif reg_type == "l2":
            return w
        elif reg_type == "l1":
            return np.sign(w)
        else:
            return alpha * np.sign(w) + (1 - alpha) * w
        
    
    if __name__ == "__main__":
    
        X, y = load_breast_cancer(return_X_y=True)
    
        D = X.shape[1]
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.3, random_state=0, shuffle=True)
        n_train, n_test = X_train.shape[0], X_test.shape[0]
    
        spark = SparkSession\
            .builder\
            .appName("SGD")\
            .getOrCreate()
    
        matrix = np.concatenate(
            [X_train, np.ones((n_train, 1)), y_train.reshape(-1, 1)], axis=1)
    
        points = spark.sparkContext.parallelize(matrix, n_slices).cache()
    
        # Initialize w to a random value
        w = 2 * np.random.ranf(size=D + 1) - 1
        print("Initial w: " + str(w))
    
        
        for t in range(n_iterations):
            print("On iteration %d" % (t + 1))
            w_br = spark.sparkContext.broadcast(w)
            
            (g, mini_batch_size) = points.sample(False, mini_batch_fraction, 42 + t)\
                .map(lambda point: gradient(point, w_br.value))\
                .treeAggregate(
                    (0.0, 0),\
                        seqOp=lambda res, g: (res[0] + g, res[1] + 1),\
                            combOp=lambda res_1, res_2: (res_1[0] + res_2[0], res_1[1] + res_2[1])
                )
    
            w -= eta * g/mini_batch_size + lam * reg_gradient(w, "l2")
            
            y_pred = logistic_f(np.concatenate(
                [X_test, np.ones((n_test, 1))], axis=1), w)
            pred_label = np.where(y_pred < 0.5, 0, 1)
            acc = accuracy_score(y_test, pred_label)
            print("iterations: %d, accuracy: %f" % (t, acc))
    
        print("Final w: %s " % w)
        print("Final acc: %f" % acc)
    
        spark.stop()
    

æˆ‘ä»¬å°è¯•ä»¥\\(L2\\)æ­£åˆ™åŒ–ã€0.001çš„æ­£åˆ™ç³»æ•°è¿è¡Œã€‚åˆå§‹æƒé‡å¦‚ä¸‹ï¼š

    Initial w: [ 0.09802896  0.92943671 -0.04964225  0.63915174 -0.61839489  0.86300117
     -0.04102299 -0.01428918  0.84966149  0.50712175  0.10373804 -0.00943291
      0.47526645 -0.19537069 -0.17958274  0.67767599  0.24612002  0.55646197
     -0.76646105  0.86061735  0.48894574  0.87838804  0.05519216 -0.14911865
      0.78695568  0.26498925  0.5789493  -0.20118555 -0.79919906 -0.79261251
     -0.77243226]
    

æœ€ç»ˆçš„æ¨¡å‹æƒé‡ä¸åœ¨æµ‹è¯•é›†ä¸Šçš„å‡†ç¡®ç‡ç»“æœå¦‚ä¸‹ï¼š

    Final w: [ 2.22381079e+03  4.00830646e+03  1.34874211e+04  1.38842558e+04
      2.19902064e+01  5.08904164e+00 -1.79005399e+01 -8.85669497e+00
      4.28643902e+01  1.74744234e+01  2.24167323e+00  2.89804554e+02
     -1.05612399e+01 -5.93151080e+03  1.60754311e+00  2.92290287e+00
      2.46318238e+00  1.51092034e+00  4.23645852e+00  1.38371670e+00
      2.20694252e+03  5.18743708e+03  1.32612364e+04 -1.39388946e+04
      3.03078787e+01  4.41094696e+00 -2.24172172e+01 -5.27976054e+00
      6.10623037e+01  1.83347648e+01  2.78974813e+02] 
    Final acc: 0.912281
    

ä»£ç ä¸­æœ‰ä¸¤ä¸ªå…³é”®ç‚¹ï¼Œä¸€ä¸ªæ˜¯`points.sample(False, mini_batch_fraction, 42 + t)`ã€‚å‡½æ•°`sample`è´Ÿè´£è¿”å›å½“å‰RDDçš„ä¸€ä¸ªéšæœºé‡‡æ ·å­é›†ï¼ˆåŒ…å«æ‰€æœ‰åˆ†åŒºï¼‰ï¼Œå…¶åŸå‹ä¸ºï¼š

    RDD.sample(withReplacement: bool, fraction: float, seed: Optional[int] = None) â†’ pyspark.rdd.RDD[T]
    

å‚æ•°`withReplacement`çš„å€¼ä¸º`True`è¡¨ç¤ºé‡‡æ ·æ˜¯æœ‰æ”¾å›(with Replacement, å³replace when sampled out)ï¼Œä¸º`False`åˆ™è¡¨ç¤ºæ— æ”¾å› (without Replacement)ã€‚å¦‚æœæ˜¯æœ‰æ”¾å›ï¼Œå‚æ•°`fraction`è¡¨ç¤ºæ¯ä¸ªæ ·æœ¬çš„æœŸæœ›è¢«é‡‡æ¬¡æ•°ï¼Œfractionå¿…é¡»è¦æ»¡è¶³\\(\\geqslant0\\)ï¼›å¦‚æœæ˜¯æ— æ”¾å›ï¼Œå‚æ•°`fraction`è¡¨ç¤ºæ¯ä¸ªæ ·æœ¬è¢«é‡‡çš„æ¦‚ç‡ï¼Œfractionå¿…é¡»è¦æ»¡è¶³ä½äº\\(\[0, 1\]\\)åŒºé—´å†…ã€‚

è¿˜æœ‰ä¸€ä¸ªå…³é”®ç‚¹æ˜¯

    .treeAggregate(
                    (0.0, 0),\
                        seqOp=lambda res, g: (res[0] + g, res[1] + 1),\
                            combOp=lambda res_1, res_2: (res_1[0] + res_2[0], res_1[1] + res_2[1])
                )
    

è¯¥å‡½æ•°è´Ÿè´£å¯¹RDDä¸­çš„å…ƒç´ è¿›è¡Œæ ‘å½¢èšåˆï¼Œå®ƒåœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ¯”`reduce`æ›´é«˜æ•ˆã€‚è¯¥å‡½æ•°çš„åŸå‹ä¸º

    RDD.treeAggregate(zeroValue: U, seqOp: Callable[[U, T], U], combOp: Callable[[U, U], U], depth: int = 2) â†’ U[source]
    

å…¶ä¸­`zeroValue`ä¸ºèšåˆç»“æœçš„åˆå§‹å€¼ï¼Œ`seqOp`å‡½æ•°ç”¨äºå®šä¹‰å•åˆ†åŒº(partition)åšèšåˆæ“ä½œçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºèšåˆç»“æœï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºåˆ†åŒºä¸­çš„æ•°æ®å˜é‡ï¼Œè¿”å›æ›´æ–°åçš„èšåˆç»“æœã€‚`combOp`å®šä¹‰å¯¹åˆ†åŒºä¹‹é—´åšèšåˆçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç¬¬äºŒä¸ªå‚æ•°éƒ½ä¸ºèšåˆç»“æœï¼Œè¿”å›ç´¯åŠ åçš„èšåˆç»“æœã€‚`depth`ä¸ºèšåˆæ ‘çš„æ·±åº¦ã€‚

æˆ‘ä»¬è¿™é‡Œ`treeAggregate`æƒ³è¦èšåˆå¾—åˆ°ä¸€ä¸ªå…ƒç»„`(g, mini_batch_size)`ï¼Œ`g`ä¸ºæ‰€æœ‰èŠ‚ç‚¹æ ·æœ¬çš„éšæœºæ¢¯åº¦å’Œï¼Œ`mini_batch_size`ä¸ºæ‰€æœ‰èŠ‚ç‚¹æ‰€é‡‡çš„å°æ‰¹é‡æ ·æœ¬ä¹‹å’Œï¼Œæ•…æˆ‘ä»¬å°†èšåˆç»“æœçš„åˆå§‹å€¼`zeroVlue`åˆå§‹åŒ–ä¸º`(0,0, 0)`ã€‚å…·ä½“çš„èšåˆè¿‡ç¨‹æè¿°å¦‚ä¸‹ï¼š

1.  å¯¹æ¯ä¸ªpartitionï¼š  
    a. åˆå§‹åŒ–èšåˆç»“æœä¸º`(0.0, 0)`ã€‚  
    b. å¯¹å½“å‰partitionçš„åºåˆ—å…ƒç´ ï¼Œä¾æ¬¡æ‰§è¡Œèšåˆæ“ä½œ`seqOp`ã€‚  
    c. å¾—åˆ°å½“å‰partitionçš„èšåˆç»“æœ`(partition_sum, partition_count)`ã€‚
    
2.  å¯¹æ‰€æœ‰partitionï¼š  
    a. æŒ‰ç…§æ ‘è¡Œæ¨¡å¼åˆå¹¶å„partitionçš„èšåˆç»“æœï¼Œåˆå¹¶æ–¹æ³•ä¸º`combOp`ã€‚  
    b. å¾—åˆ°åˆå¹¶ç»“æœ`(total_sum, total_count)`ã€‚
    

å½¢è±¡åŒ–åœ°è¡¨ç¤ºè¯¥èšåˆè¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://images.cnblogs.com/cnblogs_com/blogs/538207/galleries/2074226/o_8fe640f6.png
)

3 ç®—æ³•æ”¶æ•›æ€§åŠå¤æ‚åº¦åˆ†æ
-------------

### 3.1 æ”¶æ•›æ€§å’Œè®¡ç®—å¤æ‚åº¦

æˆ‘ä»¬åœ¨åšå®¢[ã€Šæ•°å€¼ä¼˜åŒ–ï¼šç»å…¸éšæœºä¼˜åŒ–ç®—æ³•åŠå…¶æ”¶æ•›æ€§ä¸å¤æ‚åº¦åˆ†æã€‹](https://www.cnblogs.com/orion-orion/p/16403084.html)ä¸­è¯´è¿‡ï¼Œå‡è®¾ç›®æ ‡å‡½æ•°\\(f: \\mathbb{R}^d\\rightarrow \\mathbb{R}\\)æ˜¯\\(\\alpha\\)\-å¼ºå‡¸å‡½æ•°ï¼Œå¹¶ä¸”\\(\\beta\\)å…‰æ»‘ï¼Œå¦‚æœéšæœºæ¢¯åº¦çš„äºŒé˜¶çŸ©æœ‰ä¸Šç•Œï¼Œå³\\(\\mathbb{E}\_{i^t}{\\lVert\\nabla f\_{i^t}(w^t) \\rVert^2\\leqslant G^2}\\)ï¼Œå½“æ­¥é•¿\\(\\eta^t = \\frac{1}{\\alpha t}\\)æ—¶ï¼Œå¯¹äºç»™å®šçš„è¿­ä»£æ­¥æ•°\\(T\\)ï¼ŒSGDå…·æœ‰\\(\\mathcal{O}(\\frac{1}{T})\\)çš„æ¬¡çº¿æ€§æ”¶æ•›é€Ÿç‡ï¼š

\\\[\\mathbb{E}\[ f(w^T) - f(w^\*) \] \\leqslant \\frac{2\\beta G^2}{\\alpha^2T} \\\]

è€Œè¿™æ„å‘³ç€SGDçš„è¿­ä»£æ¬¡æ•°å¤æ‚åº¦ä¸º\\(\\mathcal{O}(\\frac{1}{\\varepsilon})\\)ï¼Œä¹Ÿå³\\(\\mathcal{O}(\\frac{1}{\\varepsilon})\\)è½®è¿­ä»£åä¼šå–å¾—\\(\\varepsilon\\)çš„ç²¾åº¦ã€‚

å°½ç®¡æ¢¯åº¦çš„è®¡ç®—å¯ä»¥è¢«åˆ†æ‘Šåˆ°ä¸ªè®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œç„¶è€Œæ¢¯åº¦ä¸‹é™çš„è¿­ä»£æ˜¯ä¸²è¡Œçš„ã€‚æ¯è½®è¿­ä»£ä¸­ï¼ŒSparkä¼šæ‰§è¡ŒåŒæ­¥å±éšœ(synchronization barrier)æ¥ç¡®ä¿åœ¨å„workerå¼€å§‹ä¸‹ä¸€è½®è¿­ä»£å‰\\(w\\)å·²è¢«æ›´æ–°å®Œæ¯•ã€‚å¦‚æœå­˜åœ¨æ‰é˜Ÿè€…(stragglers)ï¼Œå…¶å®ƒworkerå°±ä¼šç©ºé—²(idle)ç­‰å¾…ï¼Œç›´åˆ°ä¸‹ä¸€è½®è¿­ä»£ã€‚æ•…ç›¸æ¯”æ¢¯åº¦çš„è®¡ç®—ï¼Œå…¶è¿­ä»£è®¡ç®—çš„â€œæ·±åº¦â€(depth)æ˜¯å…¶è®¡ç®—ç“¶é¢ˆã€‚

### 3.2 é€šä¿¡å¤æ‚åº¦

mapè¿‡ç¨‹æ˜¾ç„¶æ˜¯å¹¶è¡Œçš„ï¼Œå¹¶ä¸éœ€è¦é€šä¿¡ã€‚broadcastè¿‡ç¨‹éœ€è¦ä¸€å¯¹å¤šé€šä¿¡ï¼Œå¹¶ä¸”reduceè¿‡ç¨‹éœ€è¦å¤šå¯¹ä¸€é€šä¿¡ï¼ˆéƒ½æŒ‰ç…§æ ‘å½¢ç»“æ„ï¼‰ã€‚æ•…å¯¹äºæ¯è½®è¿­ä»£ï¼Œæ€»é€šä¿¡æ—¶é—´æŒ‰

\\\[2\\text{log}\_2(p)(L + \\frac{m}{B}) \\\]

å¢é•¿ã€‚  
è¿™é‡Œ\\(p\\)ä¸ºé™¤å»driverèŠ‚ç‚¹çš„è¿ç®—èŠ‚ç‚¹ä¸ªæ•°ï¼Œ\\(L\\)æ˜¯èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å»¶è¿Ÿã€‚\\(B\\)æ˜¯èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å¸¦å®½ã€‚\\(M\\)æ˜¯æ¯è½®é€šä¿¡ä¸­èŠ‚ç‚¹é—´ä¼ è¾“çš„ä¿¡æ¯å¤§å°ã€‚æ•…æ¶ˆæ¯èƒ½å¤Ÿå¤Ÿä»¥\\(\\mathcal{O}(\\text{log}p)\\)çš„é€šä¿¡è½®æ•°åœ¨æ‰€æœ‰èŠ‚ç‚¹é—´ä¼ é€’ã€‚

å‚è€ƒ
--

*   \[1\]  
    Zinkevich M, Weimer M, Li L, et al. Parallelized stochastic gradient descent\[J\]. Advances in neural information processing systems, 2010, 23.
*   \[2\] [PySparkæ–‡æ¡£ï¼špyspark.RDD.sampleå‡½æ•°](https://spark.apache.org/docs/3.3.0/api/python/reference/api/pyspark.RDD.sample.html?highlight=sample#pyspark.RDD.sample)
*   \[3\] [PySparkæ–‡æ¡£ï¼špyspark.RDD.treeAggregateå‡½æ•°](https://spark.apache.org/docs/3.3.0/api/python/reference/api/pyspark.RDD.treeAggregate.html?highlight=rdd%20treeaggregate#pyspark.RDD.treeAggregate)
*   \[4\] åˆ˜æµ©æ´‹ï¼Œæˆ·å°†ç­‰. æœ€ä¼˜åŒ–ï¼šå»ºæ¨¡ã€ç®—æ³•ä¸ç†è®º\[M\]. é«˜æ•™å‡ºç‰ˆç¤¾, 2020.
*   \[5\] åˆ˜é“å²©ï¼Œé™ˆè–‡ç­‰. åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ ï¼šç®—æ³•ã€ç†è®ºä¸å®è·µ\[M\]. æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾, 2018.
*   \[6\] [Stanford CME 323: Distributed Algorithms and Optimization (Lecture 7)](https://stanford.edu/~rezab/classes/cme323/S17/)

æ•°å­¦æ˜¯ç¬¦å·çš„è‰ºæœ¯ï¼ŒéŸ³ä¹æ˜¯ä¸Šç•Œçš„è¯­è¨€ã€‚