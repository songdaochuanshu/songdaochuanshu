---
layout: post
title: "HCNP Routing&Switching之链路聚合"
date: "2022-05-17T03:26:17.042Z"
---
HCNP Routing&Switching之链路聚合
===========================

![HCNP Routing&amp;Switching之链路聚合](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516231559615-2083251627.png) 链路聚合是链路高可用的一种方式，它不仅可以有冗余备份的链路来提高链路的可靠性，同时也可以将多个链路聚合在一起，使得链路的带宽增加；我们知道随着网络规模不断扩大，用户对骨干链路的带宽和可靠性提出了越来越高的要求；在传统技术中，常用更换更高速率的接口板或更换支持高速率接口板的设备的方式来增加带宽，但这种方案需要付出额外的费用，而且不够灵活；采用链路聚合技术可以在不进行硬件升级的条件下，通过将多个物理接口捆绑为一个逻辑接口，来达到增加链路带宽的目的；在实现增大带宽目的的同时，链路聚合采用备份链路的机制，可以有效提高设备之间链路的可靠性；

　　前文我们了解了MSTP相关话题，回顾清参考[https://www.cnblogs.com/qiuhom-1874/p/16268682.html](https://www.cnblogs.com/qiuhom-1874/p/16268682.html)；今天我们来聊一聊链路聚合相关话题；

　　链路聚合是链路高可用的一种方式，它不仅可以有冗余备份的链路来提高链路的可靠性，同时也可以将多个链路聚合在一起，使得链路的带宽增加；我们知道随着网络规模不断扩大，用户对骨干链路的带宽和可靠性提出了越来越高的要求；在传统技术中，常用更换更高速率的接口板或更换支持高速率接口板的设备的方式来增加带宽，但这种方案需要付出额外的费用，而且不够灵活；采用链路聚合技术可以在不进行硬件升级的条件下，通过将多个物理接口捆绑为一个逻辑接口，来达到增加链路带宽的目的；在实现增大带宽目的的同时，链路聚合采用备份链路的机制，可以有效提高设备之间链路的可靠性；

　　组网经常遇到的问题

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516222731766-594071588.png)

　　提示：如上图所示，接入层到汇聚层都是单链路，如果链路故障，那么最直接的就是对应区域的终端将无法正常和其他区域终端通信；虽然汇聚到核心层是双链路，但是由于链路带宽太小，满足不了使用；如果使用三层，每增加一条链路，则对应链路有需要分配IP地址，造成ip地址浪费；那该怎么办才能满足既不升级物理硬件，又不浪费ip地址空间，同时又能避免单链路故障呢？答案是链路聚合技术；

　　链路聚合应用场景

　　在企业网络中，所有设备的流量在转发到其他网络前都会汇聚到核心层，再由核心层设备转发到其他网络，或者转发到外网；因此在核心设备负责数据告诉交换时，容易发生拥塞；为了避免核心层数据交换发生拥塞，我们通常把链路聚合部署在核心层上，用来提升整个网络的数据吞吐量；

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516223801804-278631700.png)

　　提示：链路聚合一般部署在核心节点上，提升核心层带宽，从而实现提升整个网络数据吞吐量；

　　链路聚合概述

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516224236633-1688500310.png)

　　提示：所谓链路聚合就是把两台设备之间的多条物理链路聚合在一起，当做一条逻辑链路使用；两台设备可以是一对路由器，一对交换机，也可以是一台路由器和一条交换机；一条聚合的链路可以包含多条成员链路，华为的ARG3系列路由器和X7系列交换机上默认最多一条聚合链路可以捆绑8条成员链路；链路聚合有调高链路带宽，链路的可靠性，同时实现流量的负载均衡；

　　链路聚合模式

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516224821398-603499734.png)

　　1、手工负载分担：该模式下所有的成员链路都是活动链路，所有成员链路都会参与数据转发，平均分担流量；

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516224926129-891608314.png)

　　提示：手工负载分担模式，主要用在当两台设备中至少有一台设备不支持LACP的场景；或者网络拓扑相对简单的环境；手工模式所有成员链路都是活动链路，都会参与数据的转发，没有非活动链路；如果一条成员链路宕掉以后，对应流量会被其他活动链路分担；

　　2、LACP：该模式是通过LACP报文进行协商，确定活动接口和非活动接口；

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516225206259-576339594.png)

　　提示：LACP模式，可以人工手动配置一些链路充当备份链路，也叫M:N模式；M代表活动的成员链路数量，用于负载均衡模式中转发数据；N代表非活动链路数，主要用来冗余备份活动链路的；如果有活动成员链路宕掉以后，对应备份链路会顶替上去接替宕掉的链路；

　　手动负载分担模式和LACP模式对比

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516225544276-1611992026.jpg)

　　提示：跨设备链路聚合是指三台以上设备做链路聚合；

　　LACP模式活动链路的选取

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516225921647-1242239264.png)

　　提示：首先设备间会先发送LACP报文，确定下设备优先级，通过比较设备优先级取定谁是主动端；然后主动端通过比较接口优先级确定活动链路；简单讲就是先确定设备优先级，然后主动端通过比较接口优先级确定活动链路；

　　LACP模式的抢占机制

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516230340733-812469071.png)

　　提示：我们知道在LACP模式下，如果有活动链路宕掉后，对应备份链路会顶替上去成为活动链路；那么对于宕掉的链路如果恢复正常，它是否会抢占之前的顶替它的活动链路呢？这个取决主动端是否开启了抢占，如果没有开启抢占，则不会抢占；如果开启抢占，它也不是立刻马上就抢占，而是等待抢占延时超时后，才会进行抢占；

　　链路聚合条件

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516230757282-595876434.png)

　　提示：设备间实现链路聚合，首先链路两端相连的接口数量、速率、双工方式、流控方式必须保持一致，其次接口VLAN、Trunk、Hybird配置一致；

　　链路聚合负载分担类型（以下这些算法都是基于数据流，而非数据包，所谓数据流是指源目IP、源目MAC、端口相同的数据包成为一组数据流）

　　1、根据源MAC地址进行负载分担；

　　2、根据目标MAC地址进行负载分担；

　　3、根据源ip地址进行负载分担；

　　4、根据目标ip地址进行负载分担；

　　5、根据源MAC和目的MAC地址进行负载分担；

　　6、根据源IP和目的IP地址进行负载分担；

　　7、根据VLAN、源物理端口等L2、IPV4、IPV6和MPLS报文进行增强型负载分担；

　　链路聚合配置

　　1、手工负载分担模式

　　创建聚合逻辑接口

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516232538304-139689658.png)

　　将物理接口加入到聚合接口

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516232734408-1174802706.png)

　　提示：先进对应物理接口，然后在接口模式下使用eth-trunk 编号，命令将对应物理接口加入到聚合接口；

　　查看成员信息

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516232915173-1057564775.png)

　　提示：上述两条命令都可以查看成员信息，不同之处加上interface 对应显示的信息要全面些；

　　以上表示创建二层聚合接口，对端配置和上面一样，如果我们需要创建三层聚合接口我们只需要在对应接口下使用命令undo portswitch命令即可

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516233627462-576422111.png)

　　提示：华为模拟器虽然支持undo portswitch命令，但后续不支持ip 命令添加ip地址；有些型号的真机是支持的；

　　路由器上创建聚合接口的方式和上述交换机创建聚合接口命令一样，不同之处在于物理接口加入到聚合接口前，首先要将eth-trunk 接口从而层变为三层接口后才能加入，如下

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516234729812-611100513.png)

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516234852696-2139001706.png)

　　提示：对端配置方式和本端配置类似；在路由器上eth-trunk接口变成三层接口后，是支持ip add命令添加ip地址；如下

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516235102007-1268674787.png)

　　2、LACP模式

　　创建聚合接口的方式和手工模式创建聚合接口一样

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516235434000-1114557136.png)

　　更改模式为LACP

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516235512601-750294166.png)

　　提示：默认不更改模式就是manual 手工模式；

　　配置最大活动链路数量

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516235644491-1516259361.png)

　　提示：配置最大活动链路数量，如果活动数量小于成员链路总数，剩下的链路数量就是备份链路；

　　开启抢占模式

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220516235824999-1915613161.png)

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517000226937-506397576.png)

　　提示：默认开启了抢占模式以后，对应抢占延时时长为30秒；如果没有开启抢占模式，对应preempt delay time是disabled；

　　配置抢占延迟时长

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517000334357-1260608924.png)

　　提示：抢占延时时长的范围是10-180秒；

　　配置负载分担算法

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517000638643-1490378357.png)

　　提示：默认是负载分担的算法是异或 源目ip；

　　配置LACP接口优先级

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517004033600-1574773964.png)

　　提示：接口优先级需要先将对应物理接口加入到聚合接口里以后才能进行修改；修改时需要进入到对应物理接口模式下；

　　配置LACP设备优先级

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517000932070-333932180.png)

　　提示：优先级数字越小，优先级就越优先；默认优先级为32768；

　　物理接口加入到聚合接口和配置交换机命令一样

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517001904577-1102088948.png)

　　提示：可以看到我们只配置了本端后，对应聚合接口并没有起来；使用lacp模式后，只有两端都配置了以后，对应接口才会起来；

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517001736045-1849405714.png)

　　提示：可以看到我们把两端都配置好以后，对应聚合接口就起来了，并且只有两个活动的接口；

　　测试：现在我们把g0/0/1口down掉，看看g0/0/3口是否会顶替上去？

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517002156045-1602282554.png)

　　提示：可以看到g0/0/1down掉以后，对应备份链路会立刻顶替上去；

　　恢复g0/0/1看看对应链路是否会抢占呢？

![](https://img2022.cnblogs.com/blog/1503305/202205/1503305-20220517002631608-1426819121.gif)

　　提示：可以看到当我们恢复g0/0/1以后，对应并没有立即抢占，这是因为开启抢占模式以后，对应需要等到抢占延时时长超时以后，对应接口才会成为活动接口；

作者：[Linux-1874](https://www.cnblogs.com/qiuhom-1874/)

出处：[https://www.cnblogs.com/qiuhom-1874/](https://www.cnblogs.com/qiuhom-1874/)

本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.