---
layout: post
title: "Jetpackæ¶æ„ç»„ä»¶å­¦ä¹ (3)â€”â€”Activity Results APIä½¿ç”¨"
date: "2022-06-11T23:16:59.009Z"
---
Jetpackæ¶æ„ç»„ä»¶å­¦ä¹ (3)â€”â€”Activity Results APIä½¿ç”¨
========================================

> åŸæ–‡åœ°å€:[Jetpackæ¶æ„ç»„ä»¶å­¦ä¹ (3)â€”â€”Activity Results APIä½¿ç”¨ - Stars-Oneçš„æ‚è´§å°çª](https://stars-one.site/2022/06/11/jetpack-study-3)

æŠ€æœ¯ä¸æ—¶ä¿±è¿›,é¡µé¢è·³è½¬ä¼ å€¼ä¸€ç›´ä½¿ç”¨çš„æ˜¯`startActivityForResult`æ–¹æ³•,å¦‚ä»Šæœ‰äº†æ–°çš„APIå®ç°æ–¹å¼,å­¦ä¹ å¹¶ç¨å¾®æ€»ç»“ä¸‹ ğŸ˜„

startActivityForResultå¤ä¹ 
------------------------

**MainActivityä»£ç :**

![](https://img2022.cnblogs.com/blog/1210268/202206/1210268-20220611154931233-1868122845.png)

**Main2Activityä»£ç :**

![](https://img2022.cnblogs.com/blog/1210268/202206/1210268-20220611155009088-1498008042.png)

**æ•ˆæœ:**

![](https://img2022.cnblogs.com/blog/1210268/202206/1210268-20220611155141577-1728189031.gif)

ä¸Šé¢çš„ä»£ç åº”è¯¥æ˜¯æ¯”è¾ƒåŸºç¡€çš„ä»£ç ,è¿™é‡Œæˆ‘å°±ä¸å†èµ˜è¿°äº†

ä¸»è¦è¯´äº›ç¼ºç‚¹

æ‰€æœ‰é€»è¾‘éƒ½åœ¨`onActivityResult()`æ–¹æ³•é‡Œè¿›è¡Œåˆ¤æ–­,æ ¹æ®`requestCode`å’Œ`resultCode`è¿›è¡Œåˆ¤æ–­

å¦‚æœå•ä¸ªè¿˜å¥½è¯´,ä½†æ˜¯å¦‚æœæœ‰å¤šä¸ªçš„,å°±ä¼šçœ‹è§`onActivityResult()`é‡Œä¸€å †çš„ifé€»è¾‘,é˜…è¯»èµ·æ¥å°±ååˆ†ç¹ç,ä¸”ç»´æŠ¤å›°éš¾

è°·æ­Œå®˜æ–¹ä¹Ÿæ˜¯è€ƒè™‘åˆ°äº†è¿™ä¸ª,äºæ˜¯ä¾¿æ˜¯åœ¨æ–°ç‰ˆæœ¬æ¨å‡ºäº†ä¸ªActivity Results APIå»æ›¿ä»£äº†ä¸Šé¢æ‰€è¿°çš„æ–¹å¼,ä¸‹é¢å°±ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨

ç®€å•ä½¿ç”¨
----

### 1.å¼•å…¥ä¾èµ–

é¦–å…ˆ,éœ€è¦æˆ‘ä»¬å¼•å…¥ä¾èµ–:

    implementation 'androidx.appcompat:appcompat:1.3.1'
    

> PS: è¯·ä½¿ç”¨1.3.1ä»¥ä¸Šç‰ˆæœ¬,ä½ç‰ˆæœ¬æ²¡æœ‰è¿™ä¸ªæšä¸¾ç±»`ActivityResultContracts`

æˆ‘ä»¬å…ˆä»¥ä¸Šé¢çš„ä¾‹å­,ä½¿ç”¨Activity Results API

`Main2Acitivity`ä»£ç ä¸ç”¨åŠ¨,æˆ‘ä»¬åªéœ€è¦è°ƒæ•´`MainActivity`æ–‡ä»¶é‡Œä»£ç ,å¦‚ä¸‹æ‰€ç¤º:

### 2.åˆ›å»ºå¥‘çº¦

    val contract = ActivityResultContracts.StartActivityForResult()
    

contractå˜é‡çš„å¯¹è±¡ç±»åä¸º`ActivityResultContract`

`ActivityResultContracts`ç›¸å½“äºä¸€ä¸ªæšä¸¾ç±»,æ˜¯è°·æ­Œå®˜æ–¹è´´å¿ƒå°è£…çš„,é‡Œé¢æä¾›äº†ä¸€äº›å¸¸ç”¨çš„`ActivityResultContract`ç±»å¯¹è±¡ä¾›æˆ‘ä»¬ä½¿ç”¨

åƒæ‹ç…§,ç”³è¯·æƒé™çš„ç­‰æ“ä½œ,ä»ä»£ç æç¤ºå°±å¯ä»¥çœ‹åˆ°äº†,å¦‚ä¸‹å›¾æ‰€ç¤º:

![](https://img2022.cnblogs.com/blog/1210268/202206/1210268-20220611162244988-1811144160.png)

è¿™é‡Œæˆ‘ä»¬é€‰ç”¨`StartActivityForResult()`,å­—é¢æ„æ€åº”è¯¥å¾ˆå¥½ç†è§£,å°±æ˜¯åº”ç”¨åœ¨å°±æ˜¯é¡µé¢è·³è½¬å¹¶è¿”å›æ•°æ®çš„æƒ…æ™¯

> PS:æ ¹æ®æˆ‘ä»¬é€‰ç”¨çš„ActivityResultContracts,ä¼šå½±å“ç¬¬4æ­¥ä¸­çš„ä¼ å‚ç±»å‹

ä¸‹é¢è¡¥å……ä¸‹å¯¹åº”çš„é€‰æ‹©è¯´æ˜:

*   `StartActivityForResult`: é€šç”¨çš„Contract,ä¸åšä»»ä½•è½¬æ¢ï¼ŒIntentä½œä¸ºè¾“å…¥ï¼ŒActivityResultä½œä¸ºè¾“å‡ºï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªåå®šã€‚
*   `CreateDocument`: æç¤ºç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæ–‡æ¡£ï¼Œè¿”å›ä¸€ä¸ª(file:/http:/content:)å¼€å¤´çš„Uriã€‚
*   `GetContent`: æç¤ºç”¨é€‰æ‹©ä¸€æ¡å†…å®¹ï¼Œè¿”å›ä¸€ä¸ªé€šè¿‡ContentResolver#openInputStream(Uri)è®¿é—®åŸç”Ÿæ•°æ®çš„Uriåœ°å€ï¼ˆcontent://å½¢å¼ï¼‰ ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå¢åŠ äº† Intent#CATEGORY\_OPENABLE, è¿”å›å¯ä»¥è¡¨ç¤ºæµçš„å†…å®¹ã€‚
*   `GetMultipleContents`:è·å–å¤šæ¡å†…å®¹
*   `OpenDocument`: æç¤ºç”¨æˆ·é€‰æ‹©æŒ‡å®šç±»å‹æ–‡ä»¶(è¾“å…¥å‚æ•°ä¸ºmimeType),è¿”å›ç”¨æˆ·æ‰€é€‰æ–‡ä»¶Uri
*   `OpenDocumentTree`: æç¤ºç”¨æˆ·é€‰æ‹©ä¸€ä¸ªç›®å½•ï¼Œå¹¶è¿”å›ç”¨æˆ·é€‰æ‹©çš„ä½œä¸ºä¸€ä¸ªUriè¿”å›ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥å®Œå…¨ç®¡ç†è¿”å›ç›®å½•ä¸­çš„æ–‡æ¡£ã€‚
*   `OpenMultipleDocuments`: æç¤ºç”¨æˆ·é€‰æ‹©æ–‡æ¡£ï¼ˆå¯ä»¥é€‰æ‹©å¤šä¸ªï¼‰ï¼Œåˆ†åˆ«è¿”å›å®ƒä»¬çš„Uriï¼Œä»¥Listçš„å½¢å¼ã€‚
*   `PickContact`: ä»é€šè®¯å½•APPè·å–è”ç³»äºº
*   `RequestMultiplePermissions`ï¼šç”¨äºè¯·æ±‚ä¸€ç»„æƒé™
*   `RequestPermission`: ç”¨äºè¯·æ±‚å•ä¸ªæƒé™
*   `TakePicturePreview`: è°ƒç”¨`MediaStore.ACTION_IMAGE_CAPTURE`æ‹ç…§ï¼Œè¿”å›å€¼ä¸ºBitmapå›¾ç‰‡
*   `TakePicture`: è°ƒç”¨`MediaStore.ACTION_IMAGE_CAPTURE`æ‹ç…§ï¼Œå¹¶å°†å›¾ç‰‡ä¿å­˜åˆ°ç»™å®šçš„Uriåœ°å€ï¼Œè¿”å›trueè¡¨ç¤ºä¿å­˜æˆåŠŸã€‚
*   `TakeVideo`: è°ƒç”¨`MediaStore.ACTION_VIDEO_CAPTURE` æ‹æ‘„è§†é¢‘ï¼Œä¿å­˜åˆ°ç»™å®šçš„Uriåœ°å€ï¼Œè¿”å›ä¸€å¼ ç¼©ç•¥å›¾ã€‚

å…·ä½“å‚æ•°å’Œè¯´æ˜å¯ä»¥ä½¿ç”¨çš„æ—¶å€™æŸ¥çœ‹æ–‡æ¡£å“¦~

å®é™…ä¸Š,å¦‚æœä¸Šé¢æ‰€åˆ—è¿˜ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚,é‚£ä¹ˆæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å¥‘çº¦æ“ä½œ,åœ¨æ–‡ç« ä¸‹é¢å†è¿›è¡Œè¡¥å……è¯´æ˜,è¿™é‡Œå°±å…ˆä¸è¿›è¡Œæ‰©å±•äº†

### 3.å»ºç«‹å¥‘çº¦(æ³¨å†ŒContact)

    //æ³¨å†ŒActivityResultContract
    val myLauncher = registerForActivityResult(contract){
        if (it.resultCode==2) {
            val data = it.data
            if (data != null) {
                val resultData = data.getStringExtra("mydata")
                Toast.makeText(this, resultData, Toast.LENGTH_SHORT).show()
            }
        }
    }
    

ä½¿ç”¨Activityç±»ä¸­`registerForActivityResult()`æ–¹æ³•,è¿›è¡Œå¥‘çº¦çš„æ³¨å†Œ,å®é™…ä¸Šå°±æ˜¯ç›¸å½“äºæ³¨å†Œäº†ä¸€ä¸ªç›‘å¬,ä¹‹åä»Main2Activityé¡µé¢è¿”å›MainActivityé¡µé¢,ä¼šå›è°ƒè¿™ä¸ªé‡Œé¢çš„æ–¹æ³•

> æ³¨æ„: **æ­¤`registerForActivityResult`æ–¹æ³•éœ€è¦åœ¨Activityçš„ç”Ÿå‘½å‘¨æœŸçš„`onStart()`ä¹‹å‰å‰è¿›è¡Œè°ƒç”¨!!**

### 4.å‘èµ·é¡µé¢è·³è½¬

    val intent = Intent(this, Main2Activity::class.java)
    myLauncher.launch(intent)
    

è°ƒç”¨myLauncherå¯¹è±¡çš„`launch()`æ–¹æ³•,å°†intentå¯¹è±¡ä¼ é€’å³å¯å®ç°é¡µé¢è·³è½¬çš„æ“ä½œ

> PS: è¿™é‡Œè¿˜æ˜¯åœ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶é‡Œ,æ–¹ä¾¿é˜…è¯»å°±çœç•¥äº†

ä¹‹åä»Main2Activityé¡µé¢è¿”å›ä¹‹å,ä¼šå›è°ƒç¬¬äºŒæ­¥ä¸­çš„æ“ä½œ,æ•ˆæœä¸ä¸Šé¢çš„åŠ¨å›¾æ¼”ç¤ºä¸€è‡´,è¿™é‡Œå°±ä¸å†é‡æ–°è´´ä¸ªå›¾äº†

è‡ªå®šä¹‰ActivityResultContract
-------------------------

`ActivityResultContract`å®é™…ä¸Šè¿˜åŒ…å«ä¸¤ä¸ªæ³›å‹,å®Œæ•´åº”è¯¥æ˜¯è¿™æ ·`ActivityResultContract<I,O>`

*   `I`ä¸ºinputçš„æ„æ€,æ„ä¸º**è¾“å…¥å‚æ•°ç±»å‹**
*   `O`ä¸ºoutputçš„æ„æ€,æ„ä¸º**è¾“å‡ºå‚æ•°ç±»å‹**

`ActivityResultContract<I,O>`æ˜¯ä¸ªæŠ½è±¡ç±»,æˆ‘ä»¬æƒ³è¦å®ç°è‡ªå®šä¹‰,é‚£ä¹ˆå°±ç›´æ¥ç»§æ‰¿å®ƒ

    class MyContract: ActivityResultContract<String, String>() {
    
        override fun createIntent(context: Context, input: String?): Intent {
            //è¿™é‡Œinputçš„ç±»å‹,å°±æ˜¯ä¸Šæ–‡è¯´åˆ°çš„I
        }
    
        override fun parseResult(resultCode: Int, intent: Intent?): String {
            //è¿™é‡Œæ–¹æ³•è¿”å›çš„ç»“æœç±»å‹,å°±æ˜¯ä¸Šæ–‡è¯´åˆ°çš„O
            
        }
    
    }
    

ç»§æ‰¿å‘ç°,éœ€è¦æˆ‘ä»¬å®ç°ä¸¤ä¸ªæ–¹æ³•,`createIntent()`å’Œ`parseResult()`

ä¸€çœ¼è¿‡å»å…¶å®å¾ˆå¥½ç†è§£,`createIntent()`å°±æ˜¯åˆ›å»ºä¸€ä¸ªintentå¯¹è±¡,è°ƒç”¨`launch()`æ–¹æ³•çš„æ—¶å€™(ä¸Šé¢ä½¿ç”¨çš„ç¬¬4æ­¥æ“ä½œ),é‡Œé¢å°±ä¼šæ ¹æ®æ­¤intentè¿›è¡Œé¡µé¢çš„è·³è½¬æ“ä½œ

è€Œ`parseResult()`æ–¹æ³•,åˆ™æ˜¯å»ºç«‹å¥‘çº¦é‚£æ­¥,é‡Œé¢å›è°ƒçš„æ•°æ®ç±»å‹

æˆ‘ä»¬ä»¥ä¸Šé¢çš„ä¾‹å­,å‘ç°æˆ‘ä»¬è¿˜å¾—å£°æ˜ä¸€ä¸ªIntentå¯¹è±¡ä¼ é€’,ä»¥åŠå›ä¼ çš„æ—¶å€™è¿˜å¾—é€šè¿‡intentå¯¹è±¡å»è·å–æ•°æ®,æœ‰äº›ç¹ç,æœ‰äº›ä»£ç å¯ä»¥å°è£…æˆé€šç”¨çš„

ç…§ç€è¿™ä¸ªæƒ³æ³•,æˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ª**è‡ªå®šä¹‰ActivityResultContract,ä¼ é€’é¡µé¢å‚æ•°å³å¯æ‹¿åˆ°Main2Activityè¿”å›çš„æ•°æ®**,ä»£ç å¦‚ä¸‹æ‰€ç¤º:

    class MyContract: ActivityResultContract<KClass<out Activity>, String>() {
        
        override fun parseResult(resultCode: Int, intent: Intent?): String? {
            if (resultCode == 2 && intent!=null) {
                return intent.getStringExtra("mydata")
            }
            return null
        }
    
        override fun createIntent(context: Context, input: KClass<out Activity>?): Intent {
            val intent = Intent(context,input?.java)
            return intent
        }
    
    }
    

**ä½¿ç”¨:**

    //1.åˆ›å»ºå¥‘çº¦
    val contract = MyContract()
    
    //2.æ³¨å†ŒActivityResultContract
    val myLauncher = registerForActivityResult(contract){
        Toast.makeText(this, it, Toast.LENGTH_SHORT).show()
    }
    
    btnGo.setOnClickListener {
        //2.å‘èµ·é¡µé¢è·³è½¬
        myLauncher.launch(Main2Activity::class)
    }
    

å½“ç„¶,è¿™é‡Œè¿˜å¯ä»¥ä¼˜åŒ–,å¦‚æˆ‘ä»¬è®©MyContractå¤šä¸ªæ„é€ å‡½æ•°,è¿™æ ·å–å€¼çš„keyä¹Ÿå¯ä»¥é€šè¿‡æ­¤è¿›è¡Œå®šä¹‰

    class MyContract(val key: String) : ActivityResultContract<KClass<out Activity>, String>() {
    
        override fun parseResult(resultCode: Int, intent: Intent?): String? {
            if (resultCode == 2 && intent != null) {
                return intent.getStringExtra(key)
            }
            return null
        }
    
        override fun createIntent(context: Context, input: KClass<out Activity>?): Intent {
            val intent = Intent(context, input?.java)
            return intent
        }
    
    }
    

**ä½¿ç”¨:**

    //åˆ›å»ºå¥‘çº¦é‡Œä¼ å‚å³å¯
    val contract = MyContract("mydata")
    

å‚è€ƒ
--

*   [å†è§ï¼onActivityResultï¼ä½ å¥½ï¼ŒActivity Results APIï¼ - æ˜é‡‘](https://juejin.cn/post/6887743061309587463#heading-7)
*   [Activity Result Api çš„ä½¿ç”¨\_Sz\_pineçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/Sz_pine/article/details/121554412)

* * *

æé—®ä¹‹å‰ï¼Œè¯·å…ˆçœ‹[æé—®é¡»çŸ¥](https://www.cnblogs.com/stars-one/p/12500031.html) ç‚¹å‡»å³ä¾§å›¾æ ‡å‘èµ·æé—® [![è”ç³»æˆ‘](http://wpa.qq.com/pa?p=2:1053894518:52 "è”ç³»æˆ‘")](http://wpa.qq.com/msgrd?v=3&uin=1053894518&site=qq&menu=yes) æˆ–è€…åŠ å…¥QQç¾¤ä¸€èµ·å­¦ä¹  [![Stars-Oneå®‰å“å­¦ä¹ äº¤æµç¾¤](//pub.idqqimg.com/wpa/images/group.png "Stars-Oneå®‰å“å­¦ä¹ äº¤æµç¾¤")](//shang.qq.com/wpa/qunwpa?idkey=6ca8d206ad4466e4675efa436df96c0837047da959c3fa550a1c568dc8c1fb6a) TornadoFxå­¦ä¹ äº¤æµç¾¤:1071184701 ![](https://img2020.cnblogs.com/blog/1210268/202003/1210268-20200316120825333-1551152974.png) ![](https://img2018.cnblogs.com/blog/1210268/201905/1210268-20190508151523126-971809604.gif)