---
layout: post
title: "ã€å¼€æºæ‰“å°ç»„ä»¶ã€‘vue-plugin-hiprintåˆä½“éªŒ"
date: "2022-09-12T18:26:32.939Z"
---
ã€å¼€æºæ‰“å°ç»„ä»¶ã€‘vue-plugin-hiprintåˆä½“éªŒ
=============================

æœ¬æ–‡ä»‹ç»å¯¹vue-plugin-hiprintéƒ¨åˆ†é‡è¦ä»£ç çš„è§£æï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€æºæ’ä»¶ï¼Œèƒ½å¤Ÿè‡ªå·±è‡ªå®šä¹‰æ‰“å°æ¨¡æ¿ï¼Œé€šè¿‡åç«¯ä¼ æ¥çš„æ•°æ®è¿›è¡Œæ¸²æŸ“æ‰“å°ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†è®¸å¤šçš„apiä¾›å¼€å‘è€…ä½¿ç”¨ã€‚ç•Œé¢é‡‡ç”¨äº†antdesignã€‚å®ç°äº†å…é¢„è§ˆçš„ç›´æ¥æ‰“å°ã€‚

vue-plugin-hiprintçš„å­¦ä¹ ä¸åº”ç”¨
========================

> ğŸ˜„ ç”Ÿå‘½ä¸æ¯ï¼Œå†™ä½œä¸æ­¢  
> ğŸ”¥ ç»§ç»­è¸ä¸Šå­¦ä¹ ä¹‹è·¯ï¼Œå­¦ä¹‹åˆ†äº«ç¬”è®°  
> ğŸ‘Š æ€»æœ‰ä¸€å¤©æˆ‘ä¹Ÿèƒ½åƒå„ä½å¤§ä½¬ä¸€æ ·  
> ğŸ† [ä¸€ä¸ªæœ‰æ¢¦æœ‰æˆçš„äºº](https://blog.csdn.net/qq_43843951) [@æ€’æ”¾å§å¾·å¾·](https://www.cnblogs.com/lyd-code/)  
> ğŸŒåˆ†äº«å­¦ä¹ å¿ƒå¾—ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ æˆé•¿ï¼

ç”Ÿå‘½ä¸æ¯ï¼Œå†™ä½œä¸æ­¢ï¼Œå…»æˆè‰¯å¥½çš„å­¦ä¹ ç²¾ç¥ï¼

ç›®å½•

*   [vue-plugin-hiprintçš„å­¦ä¹ ä¸åº”ç”¨](#vue-plugin-hiprintçš„å­¦ä¹ ä¸åº”ç”¨)
    *   [ç®€ä»‹](#ç®€ä»‹)
    *   [å¼•å…¥æ’ä»¶ï¼š](#å¼•å…¥æ’ä»¶)
    *   [ä»£ç ç®€å•ä»‹ç»](#ä»£ç ç®€å•ä»‹ç»)
        *   [é¢æ¿](#é¢æ¿)
        *   [åˆå§‹åŒ–](#åˆå§‹åŒ–)
        *   [é¢„è§ˆ](#é¢„è§ˆ)
        *   [ç›´æ¥æ‰“å°](#ç›´æ¥æ‰“å°)
        *   [æ‰¹é‡æ‰“å°](#æ‰¹é‡æ‰“å°)
        *   [ä¿å­˜JSONæ•°æ®](#ä¿å­˜jsonæ•°æ®)
        *   [è‡ªå®šä¹‰ç»„ä»¶](#è‡ªå®šä¹‰ç»„ä»¶)

ç®€ä»‹
--

> æœ¬æ–‡ä»‹ç»å¯¹vue-plugin-hiprintéƒ¨åˆ†é‡è¦ä»£ç çš„è§£æï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€æºæ’ä»¶ï¼Œèƒ½å¤Ÿè‡ªå·±è‡ªå®šä¹‰æ‰“å°æ¨¡æ¿ï¼Œé€šè¿‡åç«¯ä¼ æ¥çš„æ•°æ®è¿›è¡Œæ¸²æŸ“æ‰“å°ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†è®¸å¤šçš„apiä¾›å¼€å‘è€…ä½¿ç”¨ã€‚ç•Œé¢é‡‡ç”¨äº†antdesignã€‚å®ç°äº†å…é¢„è§ˆçš„ç›´æ¥æ‰“å°ã€‚

githubï¼š[https://github.com/CcSimple/vue-plugin-hiprint](https://github.com/CcSimple/vue-plugin-hiprint)  
print.ioå®˜ç½‘ï¼š[http://hiprint.io/demo](http://hiprint.io/demo)

å¼•å…¥æ’ä»¶ï¼š
-----

![image](https://img2022.cnblogs.com/blog/1954113/202209/1954113-20220912225326022-91686818.png)

jsbarcodeï¼š

    npm install jsbarcode --save
    

socket.ioï¼š

    npm install socket.io
    

jspdfï¼š

    npm install jspdf --save
    

ä»£ç ç®€å•ä»‹ç»
------

### é¢æ¿

åˆ†åˆ«æ˜¯ï¼šæ‹–æ‹½ç»„ä»¶ã€ç”»å¸ƒã€å±æ€§æ 

    <a-row :gutter="[8,0]">
      <a-col :span="4">
        <a-card style="height: 100vh">
          <a-row>
            <a-col :span="24" class="rect-printElement-types hiprintEpContainer">
            </a-col>
          </a-row>
        </a-card>
      </a-col>
      <a-col :span="14">
        <a-card class="card-design">
          <div id="hiprint-printTemplate" class="hiprint-printTemplate"></div>
        </a-card>
      </a-col>
      <a-col :span="6" class="params_setting_container">
        <a-card>
          <a-row class="hinnn-layout-sider">
            <div id="PrintElementOptionSetting"></div>
          </a-row>
        </a-card>
      </a-col>
    </a-row>
    

### åˆå§‹åŒ–

åœ¨æŒ‚è½½ä¸­è°ƒç”¨åˆå§‹åŒ–

    mounted() {
      this.init()
      this.otherPaper()
    },
    

å…¶ä¸­åˆå§‹åŒ–æ–¹æ³•ï¼š

    init() { // å·¦è¾¹è®¾è®¡æ¨¡æ¿çš„é€‰æ‹©
      this.modeList = providers.map((e) => {
        return {type: e.type, name: e.name, value: e.value}
      })
      this.changeMode()
    },
    changeMode() { // æ•°æ®æ¸²æŸ“
      let {mode} = this
      let provider = providers[mode]
      console.log("provider", provider)
      hiprint.init({
        providers: [provider.f]
      });
      $('.hiprintEpContainer').empty()
      hiprint.PrintElementTypeManager.build('.hiprintEpContainer', provider.value);
      $('#hiprint-printTemplate').empty()
      let templates = this.$ls.get('KEY_TEMPLATES', {}) // ä»æœ¬åœ°è·å–æ•°æ®
      console.log("getTemplates", templates)
      let template = templates[provider.value] ? templates[provider.value] : {}
      hiprintTemplate = new hiprint.PrintTemplate({
        template: template, // panels: [{...}]
        dataMode: 1, // 1:getJson å…¶ä»–ï¼šgetJsonTid é»˜è®¤1
        history: true, // æ˜¯å¦éœ€è¦ æ’¤é”€é‡åšåŠŸèƒ½
        onDataChanged: (type, json) => {
          console.log(type); // æ–°å¢ã€ç§»åŠ¨ã€åˆ é™¤ã€ä¿®æ”¹(å‚æ•°è°ƒæ•´)ã€å¤§å°ã€æ—‹è½¬
          console.log(json); // è¿”å› template
          // æ›´æ–°æ¨¡æ¿
          hiprintTemplate.update(json)
          // console.log(hiprintTemplate.historyList)
        },
        settingContainer: '#PrintElementOptionSetting',
        paginationContainer: '.hiprint-printPagination'
      });
      hiprintTemplate.design('#hiprint-printTemplate');
      console.log('hiprintTemplate', hiprintTemplate);
      // è·å–å½“å‰æ”¾å¤§æ¯”ä¾‹, å½“zoomæ—¶ä¼ true æ‰ä¼šæœ‰
      this.scaleValue = hiprintTemplate.editingPanel.scale || 1;
    },
    

è®¾ç½®çº¸å¼ å¤§å°

    otherPaper() {
      let value = {}
      value.width = this.paperWidth
      value.height = this.paperHeight
      this.paperPopVisible = false
      this.setPaper('other', value)
    },
    /**
     * è®¾ç½®çº¸å¼ å¤§å°
     * @param type [A3, A4, A5, B3, B4, B5, other]
     * @param value {width,height} mm
     */
    setPaper(type, value) {
      try {
        if (Object.keys(this.paperTypes).includes(type)) {
          this.curPaper = {type: type, width: value.width, height: value.height}
          hiprintTemplate.setPaper(value.width, value.height)
        } else {
          this.curPaper = {type: 'other', width: value.width, height: value.height}
          hiprintTemplate.setPaper(value.width, value.height)
        }
      } catch (error) {
        this.$message.error(`æ“ä½œå¤±è´¥: ${error}`)
      }
    },
    

é€šè¿‡ç”Ÿå‘½å‘¨æœŸactivatedæ¥è§£å†³åˆ‡æ¢æ¨¡æ¿çš„æ—¶å€™è¿˜èƒ½æ‹–æ‹½ï¼Œå¹¶ä¸”ä¸ä¼šè¢«æ¸…é™¤

    activated() {
      // é‡æ–°å†å®ä¾‹åŒ–, å¤„ç†åˆ‡æ¢demo, æ— æ³•æ‹–æ‹½é—®é¢˜
      if (this.deactivated) {
        this.changeMode();
        this.deactivated = false;
      }
    },
    deactivated() {
      this.deactivated = true;
    },
    

### é¢„è§ˆ

å°è£…çš„é¢„è§ˆvueç•Œé¢  
å°†æ¨¡æ¿å’Œæ•°æ®ç”¨HTMLçš„æ–¹æ³•è½¬åŒ–èµ‹å€¼ **$('#preview\_content\_custom').html(hiprintTemplate.getHtml(printData))**

    <template>
      <a-modal :visible="visible" :maskClosable="false"
               @cancel="hideModal" :width="width+'mm'">
        <a-spin :spinning="spinning" style="min-height: 100px">
          <div id="preview_content_custom"></div>
        </a-spin>
        <template slot="title">
          <a-space>
            <div style="margin-right: 20px">æ‰“å°é¢„è§ˆ</div>
            <a-button :loading="waitShowPrinter" type="primary" icon="printer" @click.stop="print">æ‰“å°</a-button>
            <a-button type="primary" icon="printer" @click.stop="toPdf">pdf</a-button>
          </a-space>
        </template>
        <template slot="footer">
          <a-button key="close" type="info" @click="hideModal">
            å…³é—­
          </a-button>
        </template>
      </a-modal>
    </template>
    
    <script>
    export default {
      name: "printPreview",
      props: {},
      data() {
        return {
          visible: false,
          spinning: true,
          waitShowPrinter: false,
          // çº¸å¼ å®½ mm
          width: 0,
          // æ¨¡æ¿
          hiprintTemplate: {},
          // æ•°æ®
          printData: {}
        }
      },
      computed: {},
      watch: {},
      created() {
      },
      mounted() {
      },
      methods: {
        hideModal() {
          this.visible = false
        },
        show(hiprintTemplate, printData, width = '210') {
          this.visible = true
          this.spinning = true
          this.width = width
          this.hiprintTemplate = hiprintTemplate
          this.printData = printData
          setTimeout(() => {
            // eslint-disable-next-line no-undef
            $('#preview_content_custom').html(hiprintTemplate.getHtml(printData))
            this.spinning = false
          }, 500)
        },
        print() {
          this.waitShowPrinter = true
          this.hiprintTemplate.print(this.printData, {}, {
            callback: () => {
              this.waitShowPrinter = false
            }
          })
        },
        toPdf() {
          this.hiprintTemplate.toPdf(this.printData, 'æ‰“å°é¢„è§ˆpdf');
        },
      }
    }
    
    </script>
    <style lang="less" scoped>
    
    /deep/ .ant-modal-body {
      padding: 0px;
    }
    
    /deep/ .ant-modal-content {
      margin-bottom: 24px;
    }
    </style>
    

### ç›´æ¥æ‰“å°

ç›´æ¥æ‰“å°éœ€è¦å®‰è£…æ¡Œé¢æ’ä»¶ï¼Œwindow.hiwebSocket.openedæ˜¯ä¸ºäº†åˆ¤æ–­socketIoæ˜¯å¦æ‰“å¼€ï¼ŒhiprintTemplateä¸­çš„print2æ˜¯ç›´æ¥æ‰“å°ï¼Œprintæ˜¯ä¼šæ˜¾ç¤ºé¢„è§ˆçš„æ‰“å°ã€‚ç›´æ¥æ‰“å°åœ¨printIoåº•å±‚ä¼šè‡ªåŠ¨å»è¿æ¥å®¢æˆ·ç«¯ï¼Œä»¥åŠä¼ è¾“æ•°æ®ã€‚

    print() {
      if (window.hiwebSocket.opened) {
        const printerList = hiprintTemplate.getPrinterList();
        console.log(printerList) // æ‰“å°æœºåˆ—è¡¨æ•°æ®
        console.log('printData', printData) // æ•°æ®æº
        hiprintTemplate.print2(printData, {printer: '', title: 'hiprintæµ‹è¯•ç›´æ¥æ‰“å°'});
        return
      }
      this.$message.error('å®¢æˆ·ç«¯æœªè¿æ¥,æ— æ³•ç›´æ¥æ‰“å°')
    },
    

### æ‰¹é‡æ‰“å°

æ‰¹é‡æ‰“å°å°±æ˜¯é‡‡ç”¨é˜Ÿåˆ—æ‰“å°çš„æ–¹å¼ï¼Œé€šè¿‡TaskRunner ä»»åŠ¡è¿›ç¨‹ç®¡ç†ï¼Œåœ¨é€šè¿‡forå¾ªç¯æ”¶é›†æ•°æ®å»æ‰“å°ã€‚

    batPrint() { // æ‰¹é‡æ‰“å°
      if (window.hiwebSocket.opened) {
        const printerList = hiprintTemplate.getPrinterList();
        console.log(printerList) // æ‰“å°æœºåˆ—è¡¨
        this.tasksPrint()
        return
      }
      this.$message.error('å®¢æˆ·ç«¯æœªè¿æ¥,æ— æ³•ç›´æ¥æ‰“å°')
    },
    tasksPrint() { // é˜Ÿåˆ—æ‰“å°
      const runner = new TaskRunner();
      runner.setConcurrency(1); // åŒæ—¶æ‰§è¡Œæ•°é‡
      const task = []
      let that = this
      const tasksKey = `open${Date.now()}`;
      for (let i = 0; i < testDatas.table.length; i++) { // å¾ªç¯æ•°æ®
        // done -> ä»»åŠ¡å®Œæˆå›è°ƒ
        let key = `task${i}`;
        task.push(done => {
          let printData = {
            testChinese: testDatas.table[i].testChinese,
            testEnglish: testDatas.table[i].testEnglish
          } // åŠ¨æ€æ•°æ®
          console.log('printData', printData)
          that.realPrint(runner, done, key, i, printData, tasksKey)
        })
      }
      runner.addMultiple(task)
      this.openNotification(runner, tasksKey)
    },
    realPrint(runner, done, key, i, printData, tasksKey) {
      let that = this
      that.$notification.info({
        key: key,
        placement: 'topRight',
        duration: 2.5,
        message: `æ­£åœ¨å‡†å¤‡æ‰“å°ç¬¬ ${i} å¼ `,
        description: 'é˜Ÿåˆ—è¿è¡Œä¸­...',
      });
      let template = that.$ls.get('KEY_TEMPLATES', {}) // å¤–å±¤é‚„æœ‰å€‹æ¨¡æ¿ååŒ…è£¹
      let hiprintTemplate = new hiprint.PrintTemplate({
        template: template.aProviderModule,
      });
      hiprintTemplate.print2(printData, {printer: '', title: key});
      hiprintTemplate.on('printSuccess', function () {
        let info = runner.tasks.list.length > 1 ? 'å‡†å¤‡æ‰“å°ä¸‹ä¸€å¼ ' : 'å·²å®Œæˆæ‰“å°'
        that.$notification.success({
          key: key,
          placement: 'topRight',
          message: key + ' æ‰“å°æˆåŠŸ',
          description: info,
        });
        done()
        if (!runner.isBusy()) {
          that.$notification.close(tasksKey)
        }
      })
      hiprintTemplate.on('printError', function () {
        that.$notification.close(key)
        done()
        that.$message.error('æ‰“å°å¤±è´¥ï¼Œå·²åŠ å…¥é‡è¯•é˜Ÿåˆ—ä¸­')
        runner.add(that.realPrint(runner, done, key, i, printData))
      })
    },
    openNotification(runner, tasksKey) {
      let that = this;
      that.$notification.open({
        key: tasksKey,
        message: 'é˜Ÿåˆ—è¿è¡Œä¸­...',
        duration: 0,
        placement: 'topLeft',
        description: 'ç‚¹å‡»å…³é—­æ‰€æœ‰ä»»åŠ¡',
        btn: h => {
          return h(
              'a-button',
              {
                props: {
                  type: 'danger',
                  size: 'small',
                },
                on: {
                  click: () => {
                    that.$notification.close(tasksKey);
                    // è¯¦æƒ…è¯·æŸ¥é˜…æ–‡æ¡£
                    runner.removeAll();
                    that.$message.info('å·²ç§»é™¤æ‰€æœ‰ä»»åŠ¡');
                  },
                },
              },
              'å…³é—­ä»»åŠ¡',
          );
        },
      });
    }
    

### ä¿å­˜JSONæ•°æ®

åªè¦è°ƒç”¨apihiprintTemplate.getJson()

    saveJson() {
      if (hiprintTemplate) {
        const jsonOut = JSON.stringify(hiprintTemplate.getJson() || {})
        console.log(jsonOut)
      }
    },
    

### è‡ªå®šä¹‰ç»„ä»¶

å°è£…jsä¸­ï¼Œä½¿ç”¨addPrintElementTypesæ–¹æ³•æ·»åŠ è‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œå¯ä»¥æŸ¥çœ‹print.ioå®˜æ–¹æ–‡æ¡£æ¥é…ç½®å‚æ•°ã€‚é€šè¿‡æ§åˆ¶å°è¾“å…¥window.HIPRINT\_CONFIGå¯ä»¥æŸ¥çœ‹é…ç½®å‚æ•°åã€‚

    new hiprint.PrintElementTypeGroup("è‡ªå®šä¹‰è¡¨æ ¼1", [
      {
        tid: 'aProviderModule.customText1',
        title: 'è¡¨æ ¼æ ‡é¢˜',
        customText: 'è‡ªå®šä¹‰æ–‡æœ¬',
        custom: true,
        width: 120,
        type: 'text',
        options: {
          height: 31.5,
          hideTitle: true,
          field: 'testEnglish',
          fontSize: 20.25,
          color: '#000000',
          backgroundColor: '#ffffff',
          textAlign: 'center',
          textContentVerticalAlign: 'middle',
          lineAlign: 'center',
          borderLeft: 'solid',
          borderTop: 'solid',
          borderRight: 'solid',
          borderBottom: 'solid'
        }
      },
      {
        tid: 'aProviderModule.customText2',
        title: 'è¡¨æ ¼å†…å®¹',
        customText: 'è‡ªå®šä¹‰æ–‡æœ¬',
        custom: true,
        width: 120,
        type: 'text',
        options: {
          hideTitle: true,
          field: 'testChinese',
          height: 31.5,
          fontSize: 20.25,
          color: '#000000',
          backgroundColor: '#ffffff',
          textAlign: 'center',
          textContentVerticalAlign: 'middle',
          lineAlign: 'center',
          borderLeft: 'solid',
          borderTop: 'solid',
          borderRight: 'solid',
          borderBottom: 'solid'
        }
      },
    ]),
    

ğŸ‘åˆ›ä½œä¸æ˜“ï¼Œå¦‚æœ‰é”™è¯¯è¯·æŒ‡æ­£ï¼Œæ„Ÿè°¢è§‚çœ‹ï¼è®°å¾—ç‚¹ä¸ªèµå“¦ï¼ğŸ‘