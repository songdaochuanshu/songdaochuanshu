---
layout: post
title: "Springå¾ªç¯ä¾èµ–"
date: "2022-12-04T05:14:27.800Z"
---
Springå¾ªç¯ä¾èµ–
==========

è¯´æ˜:

â€ƒâ€ƒ1. æœ¬æ–‡åŸºäºSpring-Framework 5.1.xç‰ˆæœ¬è®²è§£

â€ƒâ€ƒ2. å»ºè®®è¯»è€…å¯¹åˆ›å»ºå¯¹è±¡éƒ¨åˆ†æºç æœ‰ä¸€å®šäº†è§£

æ¦‚è¿°
--

è¿™ç¯‡è®²è®²Springå¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œç½‘ä¸Šè®²å¾ªç¯ä¾èµ–çš„å¸–å­å¤ªå¤šå¤ªå¤šäº†ï¼Œç›¸ä¿¡å¾ˆå¤šäººä¹Ÿå¤šå¤šå°‘å°‘äº†è§£ä¸€ç‚¹ï¼Œé‚£æˆ‘è¿˜æ˜¯æŠŠè¿™ä¸ªé—®é¢˜è‡ªå·±æ¢³ç†ä¸€éï¼Œä¸»è¦æ˜¯åŸºäºä»¥ä¸‹å‡ºå‘ç‚¹ï¼š

1\. Springåˆ°åº•å¦‚ä½•è§£å†³çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œæœ‰æ²¡æœ‰â€™é»‘ç§‘æŠ€â€˜ï¼›

2\. æœ‰æ—¶é¡¹ç›®ä¼šå› ä¸ºå¾ªç¯ä¾èµ–é—®é¢˜å¯¼è‡´å¯åŠ¨å¤±è´¥ï¼Œç”±äºä¸äº†è§£å…¶æœºåˆ¶ï¼Œæ’æŸ¥è€—è´¹æ—¶é—´

3\. ç½‘ä¸Šä¼—è¯´é£äº‘ï¼Œæ²¡æœ‰å½¢æˆè‡ªå·±çš„æ€è€ƒ

è¿˜æœ‰å…¶ä»–æ–‡ç« è¯´Springä½¿ç”¨ä¸‰çº§ç¼“å­˜æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä¸ºäº†è§£å†³ä»£ç†ä¸‹çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼ŸÂ  é‚£åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥å¼€å§‹å§

å¾ªç¯ä¾èµ–ç®€ä»‹
------

å¾ªç¯ä¾èµ–çš„å«ä¹‰ï¼š BeanAä¾èµ–BeanBï¼ŒBeanBåˆä¾èµ–BeanA ï¼Œ å¦‚ä¸‹å›¾

![](https://img2023.cnblogs.com/blog/2095882/202212/2095882-20221203222939473-812825056.png)

è¿™å°±æ˜¯å¾ªç¯ä¾èµ–ï¼Œ æˆ‘ä»¬æ¥åˆ†æä¸‹ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ

1\. å®ä¾‹åŒ–BeanA

2\. BeanAåœ¨å±æ€§æ³¨å…¥é˜¶æ®µä»å®¹å™¨é‡Œé¢æ‰¾BeanB

3\. å¦‚æœBeanBå·²ç»åœ¨å®¹å™¨é‡Œé¢åˆ›å»ºå¥½ï¼Œé‚£ä¸‡äº‹å¤§å‰ï¼Œæ²¡å¾ªç¯ä¾èµ–çš„é—®é¢˜

4\. å¦‚æœBeanBè¿˜æ²¡æœ‰åœ¨å®¹å™¨é‡Œé¢åˆ›å»ºå¥½ï¼Œè¿™æ—¶å€™Springä¼šåˆ›å»ºBeanB

5\. åˆ›å»ºBeanBçš„æ—¶å€™åˆå‘ç°ä¾èµ–BeanAï¼Œä½†æ­¤æ—¶BeanAä¹Ÿæ²¡æœ‰åˆ›å»ºå®Œï¼Œåœ¨æ²¡æœ‰å¼€å¯å¾ªç¯ä¾èµ–å¼€å…³çš„æƒ…å†µä¸‹å°±ä¼šæŠ¥é”™ï¼šRequested bean is currently in creation: Is there an unresolvable circular reference?

ä»è½¯ä»¶ä»£ç åˆ†å±‚ç»“æ„æ¥è®²ï¼Œå¦‚æœåˆ†å±‚åˆç†ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬å¯ä»¥é¿å…æ‰ï¼Œä½†æ˜¯é¿å…ä¸äº†åŒä¸€ä¸ªå±‚æ¬¡ä¸­çš„Beanäº’ç›¸å¼•ç”¨ï¼Œå¥½é‚£æ—¢ç„¶å¾ªç¯ä¾èµ–è‚¯å®šä¼šå‡ºç°ï¼Œæˆ‘ä»¬è‡ªå·±å…ˆæ¥æ€è€ƒä¸‹ï¼Œå¦‚æœæ˜¯æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªIOCå®¹å™¨ï¼Œè¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ

å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–ï¼Ÿ
---------

ä»ä¸Šé¢çš„4æ­¥å¯ä»¥çœ‹å‡ºæ¥ï¼Œé—®é¢˜æ‰€åœ¨å°±æ˜¯BeanBåœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæ— æ³•æ‰¾åˆ°æ­£åœ¨åˆ›å»ºä¸­çš„BeanAï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æ‰¾ä¸€ä¸ªåœ°æ–¹æŠŠæ­£åœ¨åˆ›å»ºçš„BeanA(ä¸ºäº†è¡Œæ–‡æ–¹ä¾¿ï¼ŒæŠŠBeanæ­£åœ¨åˆ›å»ºä¸­çš„çŠ¶æ€ç§°ä¸º_åŠçŠ¶æ€_)å…ˆç»™ä¿å­˜èµ·æ¥ï¼Œç­‰BeanBç”¨åˆ°çš„æ—¶å€™èµ‹å€¼ç»™å®ƒä¸å°±è¡Œäº†ï¼Œè¿™æ—¶å€™æ­¥éª¤å¦‚ä¸‹ï¼š

1\. å®ä¾‹åŒ–BeanA

2\. BeanAåœ¨å±æ€§æ³¨å…¥ä¹‹å‰å…ˆæŠŠè‡ªå·±æ”¾åˆ°ä¸€ä¸ªMapé‡Œé¢(æ­¤æ—¶BeanAä¸ºåŠçŠ¶æ€)

3\. BeanAåœ¨å±æ€§æ³¨å…¥é˜¶æ®µä»å®¹å™¨é‡Œé¢æ‰¾BeanB

4\. å¦‚æœBeanBè¿˜æ²¡æœ‰åœ¨å®¹å™¨é‡Œé¢åˆ›å»ºå¥½ï¼Œè¿™æ—¶å€™Springä¼šåˆ›å»ºBeanB

5\. åˆ›å»ºBeanBçš„æ—¶å€™åˆå‘ç°ä¾èµ–BeanAï¼Œç”±äºBeanAå·²ç»åœ¨Mapé‡Œé¢äº†(è™½ç„¶æ˜¯åŠçŠ¶æ€ï¼Œä½†ä¸å½±å“æœ€ç»ˆä½¿ç”¨ï¼Œåæ­£ç°åœ¨åˆä¸æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨) ï¼Œæ‰€ä»¥æ³¨å…¥æˆåŠŸï¼ŒBeanBåˆ›å»ºå®Œæˆ

6\. ç”±äºBeanBå·²åˆ›å»ºå®Œæˆï¼Œæ„å‘³ç€BeanAæ³¨å…¥BeanBæˆåŠŸï¼Œæ­¤æ—¶ä»Mapä¸­ç§»é™¤BeanAçš„åŠçŠ¶æ€

7\. å®¹å™¨åˆå§‹åŒ–å®Œæˆ

åˆ°è¿™é‡Œæœ‰ä»€ä¹ˆå¤§çš„é—®é¢˜æ²¡æœ‰ï¼ŸÂ  å…¶å®æ˜¯æ²¡æœ‰çš„ï¼ŒBeanç¡®å®ä¼šåˆ›å»ºæˆåŠŸ ï¼Œ å®¹å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨å®Œæˆã€‚ é‚£æˆ‘ä»¬åœ¨æ¥çœ‹ä¸‹å¯ç”¨åŠ¨æ€ä»£ç†æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€ä¸ªMap(ä¸€çº§ç¼“å­˜)ä¼šä¸ä¼šæœ‰é—®é¢˜? ä¸ºäº†è¯´æ˜ç®€å•ï¼Œæˆ‘ä»¬åªç”ŸæˆBeanAçš„ä»£ç†å¯¹è±¡BeanA\_Proxy,BeanBæ— éœ€åˆ›å»ºï¼š

1\. å®ä¾‹åŒ–BeanAï¼Œå¹¶ç”ŸæˆBeanAçš„ä»£ç†å¯¹è±¡BeanA\_Proxy ï¼Œæ­¤æ—¶ä¸Šä¸‹æ–‡ä¸­æœ‰BeanAã€BeanA\_Proxyä¸¤ä¸ªå¯¹è±¡

2\. BeanAåœ¨å±æ€§æ³¨å…¥ä¹‹å‰å…ˆæŠŠä»£ç†å¯¹è±¡BeanA\_Proxyæ”¾åˆ°Mapé‡Œé¢

3\. BeanAåœ¨å±æ€§æ³¨å…¥é˜¶æ®µä»å®¹å™¨é‡Œé¢æ‰¾BeanB

4\. å¦‚æœBeanBè¿˜æ²¡æœ‰åœ¨å®¹å™¨é‡Œé¢åˆ›å»ºå¥½ï¼Œè¿™æ—¶å€™Springä¼šåˆ›å»ºBeanB

5\. åˆ›å»ºBeanBçš„æ—¶å€™åˆå‘ç°ä¾èµ–BeanAï¼Œç”±äºBeanAçš„ä»£ç†å¯¹è±¡BeanA\_Proxyå·²ç»åœ¨Mapé‡Œé¢äº†ï¼Œæ‰€ä»¥æŠŠBeanA\_Proxyæ³¨å…¥BeanBï¼Œæ­¤æ—¶BeanBåˆ›å»ºå®Œæˆ

6\. ç”±äºBeanBå·²åˆ›å»ºå®Œæˆï¼Œæ„å‘³ç€BeanAæ³¨å…¥BeanBæˆåŠŸï¼Œæ­¤æ—¶ä»Mapä¸­ç§»é™¤BeanA\_Proxy

7\. å®¹å™¨æŠŠBeanA\_Proxyæš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œå¹¶åˆå§‹åŒ–å®Œæˆ

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œå³ä½¿ä½¿ç”¨ä»£ç†çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ä¸€ä¸ªMap(ä¸€çº§ç¼“å­˜)æ¥è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

ä¸ºä»€ä¹ˆæ˜¯ä¸‰çº§ç¼“å­˜ï¼Ÿ
---------

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒæŠŠåŠçŠ¶æ€çš„Beanæˆ–è€…ä»£ç†å¯¹è±¡æ— è„‘çš„æ”¾å…¥ä¸€çº§ç¼“å­˜ä¹‹åï¼Œç¡®å®å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œé‚£ä¸ºä»€ä¹ˆSpringè¦ä½¿ç”¨ä¸‰çº§ç¼“å­˜æ¥è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼ŸÂ  è®©æˆ‘ä»¬æ¥å›å¿†ä¸‹[Beançš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸ](https://www.cnblogs.com/linyigg/p/16948294.html "Spring Beançš„ç”Ÿå‘½å‘¨æœŸ ")ï¼š 1. å®ä¾‹åŒ–Bean 2. å±æ€§æ³¨å…¥ 3. åˆå§‹åŒ–Bean ã€‚ è¿™æ˜¯åˆ›å»ºä¸€ä¸ªBeanå¿…ç»çš„å‡ ä¸ªæ­¥éª¤ï¼Œè€Œæˆ‘ä»¬ä¸Šé¢æ˜¯ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜è€Œå¼ºè¡ŒåŠ äº†ä¸€ä¸ªå¾€ä¸€çº§ç¼“å­˜é‡Œé¢æ”¾å¯¹è±¡çš„æ­¥éª¤ï¼Œè€Œå¯¹äºä¸å­˜åœ¨å¾ªç¯ä¾èµ–çš„å¯¹è±¡ï¼Œè¿™ä¸€æ­¥æ— ç–‘æ˜¯å¤šä½™çš„ï¼›è¿˜æœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼š æŠŠåŠçŠ¶æ€çš„Beanå’Œåˆ›å»ºå®Œæˆçš„Beanå¯¹è±¡æ”¾å…¥åŒä¸€ä¸ªç¼“å­˜é‡Œé¢ä¹Ÿä¸å¤ªå¥½ç®¡ç†ï¼Œè¿èƒŒå•ä¸€èŒèƒ½åŸåˆ™

æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦è§£å†³2ä¸ªé—®é¢˜ï¼š

1\. è§£å†³å¾ªç¯ä¾èµ–çš„ä»£ç (ä¹Ÿå°±è¯´ç”ŸæˆåŠçŠ¶æ€å¯¹è±¡çš„è¿‡ç¨‹)ä¸èƒ½æ”¾åˆ°åˆ›å»ºBeançš„ä¸»æµç¨‹ä¸­ï¼›

2\. åŠçŠ¶æ€çš„å¯¹è±¡éœ€è¦ä¸åˆ›å»ºå®Œæˆçš„å¯¹è±¡æ‰€åœ¨çš„å®¹å™¨éš”ç¦»å¼€ã€‚

ä¸ºäº†è§£å†³é—®é¢˜ä¸€æˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨æ£€æµ‹åˆ°æœ‰å¾ªç¯ä¾èµ–çš„æ—¶å€™æ‰æŠŠåŠçŠ¶æ€å¯¹è±¡æš´éœ²ç»™BeanBä½¿ç”¨ï¼Œå°±æ˜¯è¯´è¯´BeanBå‘ç°BeanAæ­£åœ¨åˆ›å»ºçš„æ—¶å€™ï¼Œåœ¨æŠŠåŠçŠ¶æ€BeanAèµ‹å€¼ç»™BeanBã€‚ ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼šè¿™ä¸ªåŠå¯¹è±¡BeanAå“ªæ¥çš„ï¼Ÿ è°åˆ›å»ºå‡ºæ¥çš„ï¼ŸÂ  è¿™æ— ç–‘å˜æˆäº†è›‹å’Œé¸¡çš„é—®é¢˜ï¼Œ æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯è¦åœ¨åˆšå¼€å§‹åˆ›å»ºBeanAçš„æ—¶å€™ä»¥æœ€å°çš„ä»£ä»·(è¿™é‡ŒæŒ‡æ‰§è¡Œæ—¶é—´æœ€çŸ­) æŠŠåŠå¯¹è±¡ç»™ä¿å­˜èµ·æ¥ï¼ŒBeanBæ£€æµ‹åˆ°å¾ªç¯ä¾èµ–çš„æ—¶å€™ï¼Œåœ¨æŠŠBeanAç»™å–å‡ºæ¥ã€‚é‚£Springå…¶å®å°±æ˜¯ä½¿ç”¨å¦ä¸€ä¸ªMapä¿å­˜åŒ¿åå‡½æ•°çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œ å› ä¸ºä½ è¦è€ƒè™‘ç›´æ¥æš´éœ²BeanAçš„ä»£ä»·(æ¯”å¦‚è¯´æš´éœ²ç»™BeanBæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œé‚£è¦è€ƒè™‘åˆ›å»ºBeanAä»£ç†å¯¹è±¡çš„æ‰§è¡Œæˆæœ¬)ã€‚ è¿™é‡Œæˆ‘ä»¬ç®€å•è´´ä¸‹Springçš„æºç :

    /**
      * å®é™…ç”ŸæˆBeançš„æ ¸å¿ƒæ–¹æ³•
      */
    protected Object doCreateBean(String beanName, RootBeanDefinition mbd, @Nullable Object[] args)
    			throws BeanCreationException {
        
        // çœç•¥ä¸Šä¸‹æ–‡ä¸­å…¶ä»–ä¸é‡è¦çš„ä»£ç 
        
        
        // è¿™é‡Œæ³¨å†Œä¸€ä¸ªåŒ¿åå‡½æ•°,æŠŠåŒ¿åå‡½æ•°æ”¾åˆ°ä¸€ä¸ªä¸´æ—¶ç¼“å­˜é‡Œé¢(å…¶å®å°±æ˜¯æ‰€è°“çš„ä¸‰çº§ç¼“å­˜)
        addSingletonFactory(beanName, () -> getEarlyBeanReference(beanName, mbd, bean));
    }
    
    /**
     * ä½œç”¨ï¼š è·å–æå‰è¦æš´éœ²ç»™å…¶ä»–Beançš„å¼•ç”¨
     * è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨Springæ£€æµ‹åˆ°æœ‰å¾ªç¯å¼•ç”¨çš„æƒ…å†µä¸‹æ‰ä¼šè°ƒè¿›æ¥
     */
    protected Object getEarlyBeanReference(String beanName, RootBeanDefinition mbd, Object bean) {
    	Object exposedObject = bean;
    	for (BeanPostProcessor bp : getBeanPostProcessors()) {
    		if (bp instanceof SmartInstantiationAwareBeanPostProcessor) {
    			SmartInstantiationAwareBeanPostProcessor ibp = (SmartInstantiationAwareBeanPostProcessor) bp;
                   // è·å–è¦æå‰æš´éœ²çš„å¯¹è±¡,è¿™é‡Œæœ‰å¯èƒ½äº§ç”Ÿä»£ç†å¯¹è±¡ä»¥åŠå…¶ä»–éå…¥å‚Beançš„å¯¹è±¡
    			exposedObject = ibp.getEarlyBeanReference(exposedObject, beanName);
    		}
    	}
    	return exposedObject;
    }

å¥½ï¼Œçœ‹åˆ°è¿™é‡Œå…¶å®æˆ‘ä»¬å·²ç»é¡ºä¾¿æŠŠä¸Šè¿°ç¬¬äºŒä¸ªé—®é¢˜ä¹Ÿä¸€èµ·è§£å†³æ‰äº†ï¼Œå› ä¸ºä¿å­˜åŒ¿åå‡½æ•°çš„Mapå’Œæœ€ç»ˆä¿å­˜å¯¹è±¡å®ä¾‹çš„Mapä¸æ˜¯åŒä¸€ä¸ªï¼Œè€Œä¸”ä¿å­˜åŒ¿åå‡½æ•°çš„Mapåœ¨è§£å†³å®Œå¾ªç¯ä¾èµ–é—®é¢˜ä¹‹åä¼šæ¸…ç©ºæ‰ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä»¥_å»¶è¿ŸåŠ è½½_çš„æ–¹å¼è§£å†³æ‰å¾ªç¯ä¾èµ–çš„é—®é¢˜ã€‚ é‚£åœ¨BeanAä¼šäº§ç”Ÿä»£ç†çš„æƒ…å†µä¸‹ä¼šä¸ä¼šæœ‰é—®é¢˜ï¼Ÿï¼Ÿï¼Ÿ è¯·ä½ è‡ªå·±æ€è€ƒä¸‹

ä½†è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè€ƒè™‘ä¸‹é¢ä¸€ç§åœºæ™¯ï¼š

![](https://img2023.cnblogs.com/blog/2095882/202212/2095882-20221204100859806-918273011.png)

BeanAä¸BeanBã€BeanCçš„å…³ç³»æ˜¯äº’ç›¸å¼•ç”¨ï¼Œ å¥—ç”¨æˆ‘ä»¬ä¸Šé¢çš„ç†è®ºï¼Œ åœ¨åˆ›å»ºBeanAçš„ä¸»æµç¨‹ä¸­æˆ‘ä»¬åªæ˜¯æ’å…¥äº†ä¸€ä¸ªè·å–åŠçŠ¶æ€å¯¹è±¡çš„åŒ¿åå‡½æ•°ï¼Œè€Œä¸æ˜¯è¦æš´éœ²ç»™å¤–éƒ¨çš„æœ€ç»ˆå¯¹è±¡ï¼Œå½“BeanCä¹Ÿéœ€è¦æ³¨å…¥BeanAçš„æ—¶å€™ï¼Œè¿˜æ˜¯è¦æ‰§è¡Œä¸€æ¬¡åŒ¿åå‡½æ•°æ¥è·å–æœ€ç»ˆæš´éœ²çš„å¯¹è±¡ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š

1\. åŒ¿åå‡½æ•°é‡å¤æ‰§è¡Œï¼Œå…¶å®æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚

2\. æ›´ä¸ºä¸¥é‡çš„æ˜¯ï¼Œæœ‰å¯èƒ½æ¯æ¬¡è°ƒç”¨å‡½æ•°è¿”å›çš„æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ³¨å…¥ç»™BeanBå’ŒBeanCçš„å¯¹è±¡ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯å¤§é—®é¢˜äº†ã€‚ (é‚£æœ‰äººä¼šé—®å¦‚æœä¿è¯è·å–æœ€ç»ˆæš´éœ²å¯¹è±¡çš„æ¥å£`SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference`ä¸­è¿”å›åŒä¸€ä¸ªå¯¹è±¡ä¸å°±è¡Œäº†? ç«™åœ¨è§£å†³é—®é¢˜çš„è§’åº¦ç¡®å®æ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯ç«™åœ¨å®¹å™¨çš„è§’åº¦æ¥è®²å°±ä¸ä¸€æ ·äº†ï¼Œæ¥å£åªæ˜¯ä¸€ä¸ªæ‹“å±•ç‚¹ï¼Œä»–çš„æ‰§è¡Œé€»è¾‘æ˜¯ä¸å¯æ§çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åœ¨å®¹å™¨çº§åˆ«æ¥è§£å†³è¿™ä¸ªé—®é¢˜)

ä¸ºäº†è§£å†³ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ï¼ŒSpringé‡‡ç”¨äº†ç¬¬ä¸‰ä¸ªç¼“å­˜ï¼ŒæŠŠå·²ç»æš´éœ²å‡ºå»çš„å¯¹è±¡ç»™ç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·é—®é¢˜å°±å®Œç¾è§£å†³ä»¥ä¸Šä¸¤ä¸ªé—®é¢˜ã€‚

getEarlyBeanReference
---------------------

åœ¨ä¸Šé¢æˆ‘ä»¬å·²ç»è§£é‡Šäº†ä¸ºä»€ä¹ˆè¦ç”¨ä¸‰çº§ç¼“å­˜æ¥è§£å†³å¾ªç¯ä¾èµ–çš„é—®é¢˜ï¼Œæˆ‘ä»¬åœ¨ç®€å•è¯´ä¸‹`SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference`æ¥å£ï¼Œå…¶å®è¿™ä¸ªæ¥å£æ²¡æœ‰ä»€ä¹ˆé«˜æ·±çš„åœ°æ–¹ï¼Œåªæ˜¯ä¸ºäº†è·å–å¾ªç¯ä¾èµ–ä¸‹éœ€è¦æå‰æš´éœ²ç»™å…¶ä»–Beançš„å¯¹è±¡ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼šä»…ä»…åœ¨æ£€æµ‹åˆ°æœ‰å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹æ‰ä¼šè°ƒè¿›æ¥ï¼Œæˆ‘ä»¬çœ‹ä¸‹æ¥å£å®šä¹‰

    /**
     * Extension of the {@link InstantiationAwareBeanPostProcessor} interface,
     * adding a callback for predicting the eventual type of a processed bean.
     *
     * <p><b>NOTE:</b> This interface is a special purpose interface, mainly for
     * internal use within the framework. In general, application-provided
     * post-processors should simply implement the plain {@link BeanPostProcessor}
     * interface or derive from the {@link InstantiationAwareBeanPostProcessorAdapter}
     * class. New methods might be added to this interface even in point releases.
     *
     * @author Juergen Hoeller
     * @since 2.0.3
     * @see InstantiationAwareBeanPostProcessorAdapter
     */
    public interface SmartInstantiationAwareBeanPostProcessor extends InstantiationAwareBeanPostProcessor {
        
    	default Object getEarlyBeanReference(Object bean, String beanName) throws BeansException {
    		return bean;
    	}
    }

ä»ç±»æ³¨é‡Šä¸­â€This interface is a special purpose interface, mainly for internal use within the frameworkâ€œå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªæ¥å£ä»…ä»…æ˜¯Springå†…éƒ¨ä¸ºäº†è§£å†³æŸäº›é—®é¢˜æä¾›çš„æ¥å£ï¼Œå¹¶ä¸å¸Œæœ›æš´éœ²ç»™ä¸Šå±‚ç”¨æˆ·ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®é™…å·¥ä½œä¸­ä¸€èˆ¬ç”¨ä¸åˆ°çš„

ä½†æ˜¯æˆ‘ä»¬è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸ªå‘ï¼š æˆ‘ä»¬çŸ¥é“åœ¨Beanåç½®å¤„ç†æ¥å£`BeanPostProcessor`ä¸­ä¹Ÿæœ‰å¯èƒ½è¿”å›ä»£ç†å¯¹è±¡ï¼Œå¦‚æœè¿™é‡Œè¿”å›çš„å¯¹è±¡å’Œå¾ªç¯ä¾èµ–æš´éœ²å‡ºå»çš„å¯¹è±¡ä¸ä¸€è‡´çš„è¯å°±ä¼šæŠ¥ä»¥ä¸‹é”™è¯¯ï¼š

    Error creating bean with name 'serviceA': Bean with name 'serviceA' has been injected into other beans [serviceB] in its raw version as part of a circular reference, but has eventually been wrapped. This means that said other beans do not use the final version of the bean. This is often the result of over-eager type matching - consider using 'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.
    org.springframework.beans.factory.BeanCurrentlyInCreationException: Error creating bean with name 'serviceA': Bean with name 'serviceA' has been injected into other beans [serviceB] in its raw version as part of a circular reference, but has eventually been wrapped. This means that said other beans do not use the final version of the bean. This is often the result of over-eager type matching - consider using 'getBeanNamesForType' with the 'allowEagerInit' flag turned off, for example.
    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:622)
    	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:514)
    	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:321)
    	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
    	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:319)
    	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:199)
    	at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:866)
    	at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:878)
    	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:550)
    	at test.circle_ref.CircleRefTests.run(CircleRefTests.java:13)

ä»é€»è¾‘ä¸Šæ¥è®²æŠ¥é”™ä¹Ÿæ˜¯åˆç†çš„ï¼Œå› ä¸ºæ—¢ç„¶æå‰æš´éœ²å‡ºå»çš„Beanï¼Œåƒæ˜¯ä¸€ç§æ‰¿è¯ºï¼Œåç»­å°±ä¸èƒ½ä¿®æ”¹äº†ï¼Œä¿®æ”¹æ„å‘³ç€Springå®¹å™¨ä¸­Beançš„â€™çŠ¶æ€â€˜æ˜¯ä¸ä¸€è‡´çš„ã€‚ æ‰€ä»¥åœ¨æœ‰å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹ï¼Œä¸€å®šè¦ä¿è¯`getEarlyBeanReference`å’Œ`BeanPostProcessor` è¿”å›çš„Beanæ˜¯åŒä¸€ä¸ªã€‚

å°ç»“
--

æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†Springä¸ºä»€ä¹ˆç”¨ä¸‰çº§ç¼“å­˜æ‰è§£å†³å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå¹¶ä¸”ä»‹ç»äº†`SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference`æ¥å£çš„å«ä¹‰ä»¥åŠåœ¨å®é™…æƒ…å†µä¸­å¯èƒ½é‡åˆ°çš„å‘ï¼Œé‚£æˆ‘ä»¬æ€»ç»“ä¸‹Springçš„ä¸‰çº§ç¼“å­˜çš„ä½œç”¨ï¼š

ä¸€çº§ç¼“å­˜: ä¿å­˜å·²ç»åˆ›å»ºå®Œçš„Beanå¯¹è±¡ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„BeanFactory#getBeanæ–¹æ³•å°±æ˜¯ä»è¿™é‡Œè·å–ï¼›

äºŒçº§ç¼“å­˜: ç¼“å­˜åœ¨å¾ªç¯ä¾èµ–ä¸­æš´éœ²ç»™å…¶ä»–Beançš„åŠçŠ¶æ€å¯¹è±¡ï¼Œé˜²æ­¢æ³¨å…¥å¯¹è±¡ä¸ä¸€è‡´çš„é—®é¢˜ï¼›

ä¸‰çº§ç¼“å­˜: ç¼“å­˜è·å–æå‰æš´éœ²çš„Beançš„åŒ¿åå‡½æ•° ï¼Œä¸ºçš„æ˜¯ä»¥æœ€å°çš„ä»£ä»·å‡å°‘å¯¹Springåˆ›å»ºå¯¹è±¡ä¸»å¹²æµç¨‹çš„å½±å“

å…³äºå¾ªç¯ä¾èµ–çš„é—®é¢˜å°±ä»‹ç»åˆ°è¿™ï¼Œä¸å¾—ä¸è¯´Springè€ƒè™‘é—®é¢˜çœŸæ˜¯çš„éå¸¸å…¨é¢ï¼Œè®¾è®¡ç›¸å½“åˆç†ã€‚å¦‚æœ‰ç–‘é—®ï¼Œæ¬¢è¿äº¤æµğŸ˜‰

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[æ—ä¸€gg](https://www.cnblogs.com/linyigg/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/linyigg/p/16949517.html](https://www.cnblogs.com/linyigg/p/16949517.html)