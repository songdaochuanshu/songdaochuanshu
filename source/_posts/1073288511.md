---
layout: post
title: "ç›‘æ§Kubernetesé›†ç¾¤è¯ä¹¦è¿‡æœŸæ—¶é—´çš„ä¸‰ç§æ–¹æ¡ˆ"
date: "2022-12-08T03:19:21.453Z"
---
ç›‘æ§Kubernetesé›†ç¾¤è¯ä¹¦è¿‡æœŸæ—¶é—´çš„ä¸‰ç§æ–¹æ¡ˆ
=========================

å‰è¨€
--

Kubernetes ä¸­å¤§é‡ç”¨åˆ°äº†è¯ä¹¦, æ¯”å¦‚ caè¯ä¹¦ã€ä»¥åŠ kubeletã€apiserverã€proxyã€etcdç­‰ç»„ä»¶ï¼Œè¿˜æœ‰ kubeconfig æ–‡ä»¶ã€‚

å¦‚æœè¯ä¹¦è¿‡æœŸï¼Œè½»åˆ™æ— æ³•ç™»å½• Kubernetes é›†ç¾¤ï¼Œé‡åˆ™æ•´ä¸ªé›†ç¾¤å¼‚å¸¸ã€‚

ä¸ºäº†è§£å†³è¯ä¹¦è¿‡æœŸçš„é—®é¢˜ï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š

1.  å¤§å¹…å»¶é•¿è¯ä¹¦æœ‰æ•ˆæœŸï¼ŒçŸ­åˆ™ 10å¹´ï¼Œé•¿åˆ™ 100 å¹´ï¼›
2.  è¯ä¹¦å¿«è¿‡æœŸæ˜¯è‡ªåŠ¨è½®æ¢ï¼Œå¦‚ Rancher çš„ K3sï¼ŒRKE2 å°±é‡‡ç”¨è¿™ç§æ–¹å¼ï¼›
3.  å¢åŠ è¯ä¹¦è¿‡æœŸçš„ç›‘æ§ï¼Œä¾¿äºææ—©å‘ç°è¯ä¹¦è¿‡æœŸé—®é¢˜å¹¶äººå·¥ä»‹å…¥

æœ¬æ¬¡ä¸»è¦ä»‹ç»å…³äº Kubernetes é›†ç¾¤è¯ä¹¦è¿‡æœŸçš„ç›‘æ§ï¼Œè¿™é‡Œæä¾› 3 ç§ç›‘æ§æ–¹æ¡ˆï¼š

1.  ä½¿ç”¨ [Blackbox Exporter](https://ewhisper.cn/posts/26225/) é€šè¿‡ Probe ç›‘æ§ Kubernetes apiserver è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼›
2.  ä½¿ç”¨ [kube-prometheus-stack](https://ewhisper.cn/posts/3988/) é€šè¿‡ apiserver å’Œ kubelet ç»„ä»¶ç›‘æ§è·å–ç›¸å…³è¯ä¹¦è¿‡æœŸæ—¶é—´;
3.  ä½¿ç”¨ [enix çš„ x509-certificate-exporter](https://github.com/enix/x509-certificate-exporter/)ç›‘æ§é›†ç¾¤æ‰€æœ‰nodeçš„ `/etc/kubernetes/pki` å’Œ `/var/lib/kubelet` ä¸‹çš„è¯ä¹¦ä»¥åŠ kubeconfig æ–‡ä»¶

æ–¹æ¡ˆä¸€: Blackbox Exporter ç›‘æ§ Kubernetes apiserver è¯ä¹¦è¿‡æœŸæ—¶é—´
-----------------------------------------------------

Blackbox Exporter ç”¨äºæ¢æµ‹ HTTPSã€HTTPã€TCPã€DNSã€ICMP å’Œ grpc ç­‰ Endpointã€‚åœ¨ä½ å®šä¹‰ Endpoint åï¼ŒBlackbox Exporter ä¼šç”ŸæˆæŒ‡æ ‡ï¼Œå¯ä»¥ä½¿ç”¨ Grafana ç­‰å·¥å…·è¿›è¡Œå¯è§†åŒ–ã€‚Blackbox Exporter æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯æµ‹é‡ Endpoint çš„å¯ç”¨æ€§ã€‚

å½“ç„¶, Blackbox Exporter æ¢æµ‹ HTTPS åå°±å¯ä»¥è·å–åˆ°è¯ä¹¦çš„ç›¸å…³ä¿¡æ¯, å°±æ˜¯åˆ©ç”¨è¿™ç§æ–¹å¼å®ç°å¯¹ Kubernetes apiserver è¯ä¹¦è¿‡æœŸæ—¶é—´çš„ç›‘æ§.

### é…ç½®æ­¥éª¤

1.  è°ƒæ•´ Blackbox Exporter çš„é…ç½®, å¢åŠ  `insecure_tls_verify: true`, å¦‚ä¸‹:  
    ![è°ƒæ•´ Blackbox Exporter é…ç½®](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104340630-1578950483.jpg)
    
2.  é‡å¯ blackbox exporter: `kubectl rollout restart deploy ...`
    
3.  å¢åŠ å¯¹ Kubernetes APIServer å†…éƒ¨ç«¯ç‚¹[https://kubernetes.default.svc.cluster.local/readyz](https://kubernetes.default.svc.cluster.local/readyz)çš„ç›‘æ§.
    
    1.  å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨ Prometheus Operator, ä½¿ç”¨çš„æ˜¯åŸç”Ÿçš„ Prometheus, åˆ™éœ€è¦ä¿®æ”¹ Prometheus é…ç½®æ–‡ä»¶çš„ configmap æˆ– secret, æ·»åŠ  scrape config, ç¤ºä¾‹å¦‚ä¸‹:
        
        ![Prometheus å¢åŠ  scrape config](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104341371-532035668.png)
        
    2.  å¦‚æœåœ¨ä½¿ç”¨ Prometheus Operator, åˆ™å¯ä»¥å¢åŠ å¦‚ä¸‹ Probe CRD, Prometheus Operator ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢å¹¶ merge åˆ° Prometheus ä¸­.
        

    apiVersion: monitoring.coreos.com/v1
    kind: Probe
    metadata:
      name: kubernetes-apiserver
    spec:
      interval: 60s
      module: http_2xx
      prober:
        path: /probe
        url: monitor-prometheus-blackbox-exporter.default.svc.cluster.local:9115
      targets:
        staticConfig:
          static:
          - https://kubernetes.default.svc.cluster.local/readyz
    

æœ€å, å¯ä»¥å¢åŠ  Prometheus å‘Šè­¦ Rule, è¿™é‡Œå°±ç›´æ¥ç”¨ Prometheus Operator åˆ›å»º PrometheusRule CRD åšç¤ºä¾‹äº†, ç¤ºä¾‹å¦‚ä¸‹:

    apiVersion: monitoring.coreos.com/v1
    kind: PrometheusRule
    metadata:
      name: prometheus-blackbox-exporter
    spec:
      groups:
      - name: prometheus-blackbox-exporter
        rules:
        - alert: BlackboxSslCertificateWillExpireSoon
          expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 30
          for: 0m
          labels:
            severity: warning
        - alert: BlackboxSslCertificateWillExpireSoon
          expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 14
          for: 0m
          labels:
            severity: critical
        - alert: BlackboxSslCertificateExpired
          annotations:
            description: |-
              SSL certificate has expired already
                VALUE = {{ $value }}
                LABELS = {{ $labels }}
            summary: SSL certificate expired (instance {{ $labels.instance }})
          expr: probe_ssl_earliest_cert_expiry - time() <= 0
          for: 0m
          labels:
            severity: emergency
    

### æ•ˆæœ

![Probe æŸ¥è¯¢è¯ä¹¦è¿‡æœŸæ—¶é—´](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104341577-299296949.png)

æ–¹æ¡ˆäºŒ: kube-prometheus-stack é€šè¿‡ apiserver å’Œ kubelet ç»„ä»¶ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´
------------------------------------------------------------

è¿™é‡Œå¯ä»¥å‚è€ƒæˆ‘çš„æ–‡ç« :[Prometheus Operator ä¸ kube-prometheus ä¹‹äºŒ - å¦‚ä½•ç›‘æ§ 1.23+ kubeadm é›†ç¾¤](https://ewhisper.cn/posts/3988/), å®‰è£…å®Œæˆå, å¼€ç®±å³ç”¨.

å¼€ç®±å³ç”¨å†…å®¹åŒ…æ‹¬:

1.  æŠ“å– apiserver å’Œ kubelet æŒ‡æ ‡;(å³ serviceMonitor)
2.  é…ç½®è¯ä¹¦è¿‡æœŸæ—¶é—´çš„ç›¸å…³å‘Šè­¦; (å³ PrometheusRule)

è¿™é‡Œç”¨åˆ°çš„æŒ‡æ ‡æœ‰:

1.  apiserver
    1.  `apiserver_client_certificate_expiration_seconds_count`
    2.  `apiserver_client_certificate_expiration_seconds_bucket`
2.  kubelet
    1.  `kubelet_certificate_manager_client_expiration_renew_errors`
    2.  `kubelet_server_expiration_renew_errors`
    3.  `kubelet_certificate_manager_client_ttl_seconds`
    4.  `kubelet_certificate_manager_server_ttl_seconds`

### ç›‘æ§æ•ˆæœ

å¯¹åº”çš„ Prometheus å‘Šè­¦è§„åˆ™å¦‚ä¸‹:

![è¯ä¹¦è¿‡æœŸæ—¶é—´ç›¸å…³ PrometheusRule](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104341752-671305501.png)

æ–¹æ¡ˆä¸‰: ä½¿ç”¨ enix çš„ x509-certificate-exporter
----------------------------------------

### ç›‘æ§æ‰‹æ®µ

è¯¥ Exporter æ˜¯é€šè¿‡ç›‘æ§é›†ç¾¤æ‰€æœ‰nodeçš„æŒ‡å®šç›®å½•æˆ– path ä¸‹çš„è¯ä¹¦æ–‡ä»¶ä»¥åŠ kubeconfig æ–‡ä»¶æ¥è·å–è¯ä¹¦ä¿¡æ¯.

å¦‚æœæ˜¯ä½¿ç”¨ kubeadm æ­å»ºçš„ Kubernetes é›†ç¾¤, åˆ™å¯ä»¥ç›‘æ§å¦‚ä¸‹åŒ…å«è¯ä¹¦çš„æ–‡ä»¶å’Œ kubeconfig:

    watchFiles:
    - /var/lib/kubelet/pki/kubelet-client-current.pem
    - /etc/kubernetes/pki/apiserver.crt
    - /etc/kubernetes/pki/apiserver-etcd-client.crt
    - /etc/kubernetes/pki/apiserver-kubelet-client.crt
    - /etc/kubernetes/pki/ca.crt
    - /etc/kubernetes/pki/front-proxy-ca.crt
    - /etc/kubernetes/pki/front-proxy-client.crt
    - /etc/kubernetes/pki/etcd/ca.crt
    - /etc/kubernetes/pki/etcd/healthcheck-client.crt
    - /etc/kubernetes/pki/etcd/peer.crt
    - /etc/kubernetes/pki/etcd/server.crt
    watchKubeconfFiles:
    - /etc/kubernetes/admin.conf
    - /etc/kubernetes/controller-manager.conf
    - /etc/kubernetes/scheduler.conf
    

### å®‰è£…é…ç½®

ç¼–è¾‘ values.yaml:

    kubeVersion: ''
    extraLabels: {}
    nameOverride: ''
    fullnameOverride: ''
    imagePullSecrets: []
    image:
      registry: docker.io
      repository: enix/x509-certificate-exporter
      tag:
      pullPolicy: IfNotPresent
    psp:
      create: false
    rbac:
      create: true
      secretsExporter:
        serviceAccountName:
        serviceAccountAnnotations: {}
        clusterRoleAnnotations: {}
        clusterRoleBindingAnnotations: {}
      hostPathsExporter:
        serviceAccountName:
        serviceAccountAnnotations: {}
        clusterRoleAnnotations: {}
        clusterRoleBindingAnnotations: {}
    podExtraLabels: {}
    podAnnotations: {}
    exposePerCertificateErrorMetrics: false
    exposeRelativeMetrics: false
    metricLabelsFilterList: null
    secretsExporter:
      enabled: true
      debugMode: false
      replicas: 1
      restartPolicy: Always
      strategy: {}
      resources:
        limits:
          cpu: 200m
          memory: 150Mi
        requests:
          cpu: 20m
          memory: 20Mi
      nodeSelector: {}
      tolerations: []
      affinity: {}
      podExtraLabels: {}
      podAnnotations: {}
      podSecurityContext: {}
      securityContext:
        runAsUser: 65534
        runAsGroup: 65534
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
      secretTypes:
        - type: kubernetes.io/tls
          key: tls.crt
      includeNamespaces: []
      excludeNamespaces: []
      includeLabels: []
      excludeLabels: []
      cache:
        enabled: true
        maxDuration: 300
    hostPathsExporter:
      debugMode: false
      restartPolicy: Always
      updateStrategy: {}
      resources:
        limits:
          cpu: 100m
          memory: 40Mi
        requests:
          cpu: 10m
          memory: 20Mi
      nodeSelector: {}
      tolerations: []
      affinity: {}
      podExtraLabels: {}
      podAnnotations: {}
      podSecurityContext: {}
      securityContext:
        runAsUser: 0
        runAsGroup: 0
        readOnlyRootFilesystem: true
        capabilities:
          drop:
            - ALL
      watchDirectories: []
      watchFiles: []
      watchKubeconfFiles: []
      daemonSets:
        cp:
          nodeSelector:
            node-role.kubernetes.io/master: ''
          tolerations:
            - effect: NoSchedule
              key: node-role.kubernetes.io/master
              operator: Exists
          watchFiles:
            - /var/lib/kubelet/pki/kubelet-client-current.pem
            - /etc/kubernetes/pki/apiserver.crt
            - /etc/kubernetes/pki/apiserver-etcd-client.crt
            - /etc/kubernetes/pki/apiserver-kubelet-client.crt
            - /etc/kubernetes/pki/ca.crt
            - /etc/kubernetes/pki/front-proxy-ca.crt
            - /etc/kubernetes/pki/front-proxy-client.crt
            - /etc/kubernetes/pki/etcd/ca.crt
            - /etc/kubernetes/pki/etcd/healthcheck-client.crt
            - /etc/kubernetes/pki/etcd/peer.crt
            - /etc/kubernetes/pki/etcd/server.crt
          watchKubeconfFiles:
            - /etc/kubernetes/admin.conf
            - /etc/kubernetes/controller-manager.conf
            - /etc/kubernetes/scheduler.conf
        nodes:
          watchFiles:
            - /var/lib/kubelet/pki/kubelet-client-current.pem
            - /etc/kubernetes/pki/ca.crt
    rbacProxy:
      enabled: false
    podListenPort: 9793
    hostNetwork: false
    service:
      create: true
      port: 9793
      annotations: {}
      extraLabels: {}
    prometheusServiceMonitor:
      create: true
      scrapeInterval: 60s
      scrapeTimeout: 30s
      extraLabels: {}
      relabelings: {}
    prometheusPodMonitor:
      create: false
    prometheusRules:
      create: true
      alertOnReadErrors: true
      readErrorsSeverity: warning
      alertOnCertificateErrors: true
      certificateErrorsSeverity: warning
      certificateRenewalsSeverity: warning
      certificateExpirationsSeverity: critical
      warningDaysLeft: 30
      criticalDaysLeft: 14
      extraLabels: {}
      alertExtraLabels: {}
      rulePrefix: ''
      disableBuiltinAlertGroup: false
      extraAlertGroups: []
    extraDeploy: []
    

é€šè¿‡ Helm Chart å®‰è£…:

    helm repo add enix https://charts.enix.io
    helm install x509-certificate-exporter enix/x509-certificate-exporter
    

é€šè¿‡è¿™ä¸ª Helm Chart ä¹Ÿä¼šè‡ªåŠ¨å®‰è£…:

*   ServiceMonitor
*   PrometheusRule

å…¶ç›‘æ§æŒ‡æ ‡ä¸º:

*   `x509_cert_not_after`

### ç›‘æ§æ•ˆæœ

è¯¥ Exporter è¿˜æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒèŠ±å“¨çš„ Grafana Dashboard, å¦‚ä¸‹:

![x509 Exporter Grafana Dashboard](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104341948-760671619.jpg)

Alert Rules å¦‚ä¸‹:

![x509 Exporter Prometheus Rule](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221208104342135-94187918.png)

æ€»ç»“
--

ä¸ºäº†ç›‘æ§ Kubernetes é›†ç¾¤çš„è¯ä¹¦è¿‡æœŸæ—¶é—´, æˆ‘ä»¬æä¾›äº† 3 ç§æ–¹æ¡ˆ, å„æœ‰ä¼˜åŠ£:

1.  ä½¿ç”¨ [Blackbox Exporter](https://ewhisper.cn/posts/26225/) é€šè¿‡ Probe ç›‘æ§ Kubernetes apiserver è¯ä¹¦è¿‡æœŸæ—¶é—´ï¼›
    1.  ä¼˜åŠ¿: å®ç°ç®€å•;
    2.  åŠ£åŠ¿: åªèƒ½ç›‘æ§ https çš„è¯ä¹¦;
2.  ä½¿ç”¨ [kube-prometheus-stack](https://ewhisper.cn/posts/3988/) é€šè¿‡ apiserver å’Œ kubelet ç»„ä»¶ç›‘æ§è·å–ç›¸å…³è¯ä¹¦è¿‡æœŸæ—¶é—´;
    1.  ä¼˜åŠ¿: å¼€ç®±å³ç”¨, å®‰è£… kube-prometheus-stack åæ— éœ€é¢å¤–å®‰è£…å…¶ä»– exporter
    2.  åŠ£åŠ¿: åªèƒ½ç›‘æ§ apiserver å’Œ kubelet çš„è¯ä¹¦;
3.  ä½¿ç”¨ [enix çš„ x509-certificate-exporter](https://github.com/enix/x509-certificate-exporter/)ç›‘æ§é›†ç¾¤æ‰€æœ‰nodeçš„ `/etc/kubernetes/pki` å’Œ `/var/lib/kubelet` ä¸‹çš„è¯ä¹¦ä»¥åŠ kubeconfig æ–‡ä»¶
    1.  ä¼˜åŠ¿: å¯ä»¥ç›‘æ§æ‰€æœ‰ node, æ‰€æœ‰ kubeconfig æ–‡ä»¶, ä»¥åŠ æ‰€æœ‰ tls æ ¼å¼çš„ secret è¯ä¹¦, å¦‚æœè¦ç›‘æ§ Kubernetes é›†ç¾¤ä»¥å¤–çš„è¯ä¹¦, ä¹Ÿå¯ä»¥å¦‚æ³•ç‚®åˆ¶; èŒƒå›´å¹¿è€Œå…¨;
    2.  éœ€è¦é¢å¤–å®‰è£…: x509-certificate-exporter, å¯¹åº”æœ‰ 1 ä¸ª Deployment å’Œ å¤šä¸ª DaemonSet, å¯¹ Kubernetes é›†ç¾¤çš„èµ„æºæ¶ˆè€—ä¸å°‘.

å¯ä»¥æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µçµæ´»è¿›è¡Œé€‰æ‹©.

ğŸ‰ğŸ‰ğŸ‰

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [å¦‚ä½•ä½¿ç”¨ Blackbox Exporter ç›‘æ§ URL? - ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ (ewhisper.cn)](https://ewhisper.cn/posts/26225/)
*   [Prometheus Operator ä¸ kube-prometheus ä¹‹äºŒ - å¦‚ä½•ç›‘æ§ 1.23+ kubeadm é›†ç¾¤ - ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ (ewhisper.cn)](https://ewhisper.cn/posts/3988/)
*   [x509-certificate-exporter/deploy/charts/x509-certificate-exporter at master Â· enix/x509-certificate-exporter (github.com)](https://github.com/enix/x509-certificate-exporter/tree/master/deploy/charts/x509-certificate-exporter)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.