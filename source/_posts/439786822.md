---
layout: post
title: "面试突击：MVCC 和间隙锁有什么区别？"
date: "2023-03-27T01:07:14.909Z"
---
面试突击：MVCC 和间隙锁有什么区别？
====================

MVCC 和间隙锁是两种完全不同的机制，但它们的目的都是相同的，都是用来保证数据库并发访问的，我们先来看二者的定义。

MVCC 定义
-------

MVCC 是多版本并发控制（Multi-Version Concurrency Control）的缩写，是一种并发控制的方法。

在 MVCC 中，每个读操作会看到一个固定版本的数据库记录，即使在并发环境中，也不会出现读取到了其他事务还未提交的数据的情况。

MVCC 通过保存数据在某个时间点的快照来实现这一点。在读取数据时，只会读取在该时间点之前提交的数据。在写入数据时，会为每个写入操作创建一个新版本的数据，而不是直接覆盖原有的数据。这样，读操作就可以读取旧版本的数据，而写操作则可以写入新版本的数据，从而实现了并发控制。

在 MySQL 中，InnoDB 存储引擎就是使用 MVCC 来实现并发控制的。

间隙锁定义
-----

间隙锁是一种锁定索引范围而非实际数据的锁，它可以锁定一个范围，防止其他事务在这个范围内插入数据，从而保证了范围内的数据的唯一性。在 MySQL 中，InnoDB 存储引擎支持间隙锁。当使用 SELECT ... FOR UPDATE 或 SELECT ... LOCK IN SHARE MODE 语句时，InnoDB 存储引擎会自动使用间隙锁来锁定索引范围。

如果一个事务在一个间隙上持有了锁，那么其他事务就不能在这个间隙上插入数据，但是可以在这个间隙之前或之后的位置插入数据。

为什么要有 MVCC？
-----------

既然已经有锁可以防止并发访问了，那为什么还需要 MVCC 呢？

MVCC 的诞生主要是出于性能的考虑，因为 MVCC 中没有用到锁，它是通过多版本并发控制的手段来实现数据库并发访问的，这样相比于加锁性能就会好很多。

MVCC 实现原理
---------

MVCC 竟然这么强，那它是怎么实现的呢？  
简单来说 MVCC 是通过以下 3 大组件实现的：

1.  隐藏字段：每个执行的 SQL 命令都有几个隐藏的字段，其中有一个事务 ID 字段，很重要。
2.  undo log（回滚日志）：里面记录了 SQL 命令执行的历史数据。
3.  Read View（读视图）：包含快照读（一个快照，保存了数据库某个时刻的数据）和一些重要的属性。

它的实现原理简单来说，是通过 SQL 中隐藏的字段事务 ID（自己的版本号）和 Read View 中的属性版本号进行对比，对比之后决定使用 Read View 中的快照或 undo log 中的历史数据（对比的规则是 MVCC 机制的规定，本文不展开讨论），最后再将符合的数据返回。

MVCC 可以解决幻读吗？
-------------

> 幻读是指在一个事务中，第一次查询某个范围的数据时，发现有一些数据符合条件，但是当再次查询同样的范围时，却发现多了一些或者少了一些数据。这种情况就被称为幻读。幻读是由于并发事务中的数据修改操作导致的，比如在一个事务中，另一个事务插入了一条符合条件的数据，导致第二次查询时多了一条数据。

**MVCC 机制可以解决部分幻读问题**，MVCC 是通过保存数据在某个时间点的快照来实现来解决（部分）幻读问题的，在读取数据时，MVCC 会根据快照来确定可见的数据版本。这样，即使其他事务在读取数据时进行了修改，也不会影响当前事务的读取结果。

因此，MVCC 可以有效地解决这部分幻读问题。但需要注意的是，MVCC 只能解决读取数据时的幻读问题，对于写入数据时的幻读问题，还需要配合锁机制或使用更高的事务隔离级别（串行化）来解决。

也就是说，想要彻底解决 MySQL InnoDB 中 RR（REPEATABLE READ，可重复读）事务隔离级别的幻读问题，需要使用 MVCC + 锁机制共同来实现。

锁分类
---

在 MySQL InnoDB 中的锁机制不止有间隙锁，还有行锁和临建锁等。

行锁、间隙锁和临建锁有什么区别？
----------------

行锁、间隙锁和临建锁都是 MySQL 中的锁机制，它们的区别如下：

*   行锁是针对某一行数据进行的锁定，可以防止其他事务修改该行数据。
*   间隙锁是针对某一范围的数据进行的锁定，可以防止其他事务在该范围内插入数据。
*   临建锁是行锁和间隙锁的组合，可以理解为一种特殊的间隙锁，它等于行锁+间隙锁，除了锁住记录本身，还会锁住索引之间的间隙，即锁定一段左开右闭的索引区间。

小结
--

MVCC 和锁机制解决了 MySQL InnoDB 中 RR 事务隔离级别的幻读问题，而 MySQL 中的锁类型又有很多种，如行锁、间隙锁、临建锁等。

> 本文已收录到 Gitee 开源仓库《Java 面试突击》，其中包含的内容有：Redis、JVM、并发、并发、MySQL、Spring、Spring MVC、Spring Boot、Spring Cloud、MyBatis、设计模式、消息队列等模块。Java 面试有它就够了：[最全 Java 面试题库(2023版)，持续更新...](https://gitee.com/mydb/interview)

关注下面二维码，订阅更多精彩内容。  
![](https://images.cnblogs.com/cnblogs_com/vipstone/848916/o_211225130402_gognzhonghao.jpg)

![](http://icdn.apigo.cn/gitchat/rabbitmq.png?imageView2/0/w/500/h/400)

![微信打赏](http://icdn.apigo.cn/myinfo/wchat-pay.png "微信打赏")  

关注公众号（加好友）： ![](http://icdn.apigo.cn/gongzhonghao2.png?imageView2/0/w/120/h/120)

  
作者： [王磊的博客](http://vipstone.cnblogs.com/)  
出处： [http://vipstone.cnblogs.com/](http://vipstone.cnblogs.com/)