---
layout: post
title: "SpringBootæºç 2â€”â€”SpringBoot x Mybatis åŸç†è§£æï¼ˆå¦‚ä½•æ•´åˆï¼Œäº‹åŠ¡å¦‚ä½•äº¤ç”±springç®¡ç†ï¼Œmybatiså¦‚ä½•è¿›è¡Œæ•°æ®åº“æ“ä½œï¼‰"
date: "2022-12-11T17:14:09.609Z"
---
SpringBootæºç 2â€”â€”SpringBoot x Mybatis åŸç†è§£æï¼ˆå¦‚ä½•æ•´åˆï¼Œäº‹åŠ¡å¦‚ä½•äº¤ç”±springç®¡ç†ï¼Œmybatiså¦‚ä½•è¿›è¡Œæ•°æ®åº“æ“ä½œï¼‰
==============================================================================

    é˜…è¯»æœ¬æ–‡éœ€è¦springæºç çŸ¥è¯†ï¼Œå’Œspringbootç›¸å…³æºç çŸ¥è¯†
    å¯¹äºspringboot æ•´åˆmybatisï¼Œä»¥åŠmybatisæºç å…³ç³»ä¸å¯†åˆ‡çš„çŸ¥è¯†ï¼Œæœ¬æ–‡å°†ç®€å•å¸¦è¿‡
    

[ç³»åˆ—æ–‡ç« ç›®å½•å’Œå…³äºæˆ‘](https://www.cnblogs.com/cuzzz/p/16609728.html)

*   æ¶‰åŠåˆ°spring iocåŸç†ï¼Œå¯ç§»æ­¥å­¦ä¹ ï¼š[Springæºç å­¦ä¹ ç¬”è®°12â€”â€”æ€»ç»“ç¯‡IOCï¼ŒBeançš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸‰å¤§æ‰©å±•ç‚¹](https://www.cnblogs.com/cuzzz/p/16662905.html)
*   æ¶‰åŠspring aopåŸç†ï¼Œå¯å‚è€ƒ [Spring æºç å­¦ä¹ ç¬”è®°10â€”â€”Spring AOP](https://www.cnblogs.com/cuzzz/p/16621320.html)
*   æ¶‰åŠspring ç”³æ˜å¼äº‹åŠ¡ï¼Œå¯å‚è€ƒ [pring æºç å­¦ä¹ ç¬”è®°11â€”â€”Springäº‹åŠ¡](https://www.cnblogs.com/cuzzz/p/16633523.html)
*   æ¶‰åŠåˆ°springbootè‡ªåŠ¨è£…é…çš„åŸç†ï¼Œå¯å‚è€ƒï¼š[SpringBootæºç å­¦ä¹ 1â€”â€”SpringBootè‡ªåŠ¨è£…é…æºç è§£æ+Springå¦‚ä½•å¤„ç†é…ç½®ç±»çš„](https://www.cnblogs.com/cuzzz/p/16705188.html)

ä¸€ä¸¶ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹â€”â€”è¯»å·²æäº¤æƒ…å†µä¸‹mybatisä¸€çº§ç¼“å­˜é€ æˆçš„é—®é¢˜
----------------------------------

![image-20221204165445817](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204165447965-431336720.png)

ä¸Šå›¾ä¸­ï¼Œå·²çŸ¥é“users1çš„sizeä¸º5ï¼Œé‚£ä¹ˆusers2çš„å¤§å°ä¸ºå¤šå°‘æ˜µï¼Ÿ

æˆ‘ä»¬æš‚ä¸”æŠ›å¼ƒmybatisæ¡†æ¶ä¸­çš„çŸ¥è¯†ï¼Œä»mysqläº‹åŠ¡éš”ç¦»çº§åˆ«è¿›è¡Œåˆ†æï¼Œtestæ–¹æ³•ç¬¬ä¸€æ¬¡æŸ¥è¯¢åˆ°æ€»æ•°ï¼Œç„¶å**é‡æ–°å¼€å¯ä¸€ä¸ªäº‹åŠ¡æ’å…¥äº†ä¸€æ¡**ï¼ˆrequire\_newçš„ä¼ æ’­çº§åˆ«ï¼‰ï¼Œåç»­addOneæ–¹æ³•å°†ç«‹å³æäº¤ï¼Œå†æ¬¡æŸ¥è¯¢çš„æ—¶å€™ï¼Œtestæ–¹æ³•åº”è¯¥å¯ä»¥ç«‹é©¬æŸ¥è¯¢åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œåº”è¯¥æ¯”ç¬¬ä¸€æ¬¡è¾“å‡ºçš„åº”è¯¥å¤š1ï¼Œè¿™æ˜¯äº‹åŠ¡éš”ç¦»çº§åˆ«æŒ‡å¯¼æˆ‘ä»¬åšå‡ºçš„åˆ¤æ–­

ä½†æ˜¯äº‹å®ä¸Šæ˜¯users1å¤§å°å’Œ users2ä¸€æ ·å¤§ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆæ˜µï¼Ÿ

æˆ‘ä»¬çœ‹ä¸‹æ§åˆ¶å°

![image-20221204165622947](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204165625229-1653738528.png)

å‘ç°mybatiså¹¶æ²¡æœ‰è¿›è¡Œç¬¬äºŒæ¬¡æ•°æ®åº“çš„æŸ¥è¯¢ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥æ„è¯†åˆ°`mybatis`å…·å¤‡ç¼“å­˜ï¼Œä»è€Œå¯¼è‡´ç¬¬äºŒæ¬¡æŸ¥è¯¢å¹¶æ²¡æœ‰è®¿é—®æ•°æ®åº“

ä¹Ÿå°±æ˜¯è¯´ **`è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«ä¸‹ï¼Œmybatiså¦‚æœä¸å…³é—­ç¼“å­˜å°†å­˜åœ¨é”™è¯¯`**ï¼ˆè¿™é‡Œçš„ç¼“å­˜æŒ‡çš„ä¸€çº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜æ™®éæ˜¯ä¸å¼€çš„ï¼‰

å…·ä½“åŸç†ï¼Œç¬”è€…æ­¤æ–‡è®²åˆ°mybatisç¼“å­˜åå°†è¿›è¡Œè§£è¯»ï¼Œä¸‹é¢æˆ‘ä»¬ä»springboot å’Œ mybatisæ•´åˆï¼Œåˆ°mybatisæ‰§è¡ŒåŸç†å±•å¼€è®²mybatisçš„åŸç†

äºŒä¸¶mybatis-springboot-starterçš„è‡ªåŠ¨è£…é…
---------------------------------

é€šå¸¸springbootæ•´åˆmybatisåªéœ€è¦å¼•å…¥å¦‚ä¸‹ä¾èµ–

![image-20221204170322472](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204170324563-1491108560.png)

ç®€å•æè¿°å°±æ˜¯`SpringBootå¯åŠ¨çš„æ—¶å€™ä¼šè¯»å–META-INF/spring.factoriesä¸­è‡ªåŠ¨é…ç½®çš„ç±»ï¼ŒåŠ å…¥åˆ°å®¹å™¨ä¸­ï¼Œåç»­springbootä¼šå°†è¿™äº›ç±»å½“ä½œé…ç½®ç±»è¿›è¡Œè§£æ`

![image-20221204170738122](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204170740872-966217798.png)

ä¸Šå›¾æ˜¯mybatis-spring-starterçš„`META-INF/spring.factories`,å…¶ä¸­å…³é”®çš„æ˜¯`MybatisAutoConfiguration`

### 1.å¯¼å…¥SqlSessionTemplateï¼ŒSqlSessionFactory

![image-20221204171347652](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204171350206-2075532013.png)

è¿™é‡Œå¯ä»¥çœ‹åˆ°å½“å®¹å™¨ä¸­æ²¡æœ‰`SqlSessionFactory`çš„æ—¶å€™ï¼Œ`MybatisAutoConfiguration`ä¼šä¸ºæˆ‘ä»¬æ³¨å…¥ä¸€ä¸ª`SqlSessionFactory`ï¼Œ`SqlSessionTemplate`åŒæ ·å¦‚æ­¤ã€‚

è¿™é‡Œæˆ‘ä»¬ç®€å•æä¸€ä¸‹`SqlSessionFactory`å’Œ`SqlSessionTemplate`çš„ä½œç”¨

#### 1.1.mybatisä¸­çš„`SqlSessionFactory`

æ•…åæ€æ„ï¼Œå®ƒæ˜¯åˆ›å»º`SqlSession`çš„å·¥å‚

![image-20221204171832751](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204171834876-581685410.png)

è¿™é‡ŒSpringæ„å»ºSqlSessionFactoryï¼Œä½¿ç”¨äº†`SqlSessionFactoryBean#getObject`

![image-20221205061620302](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205061622035-1905374025.png)

å®ƒå®ç°äº†`InitializingBean`,ä½†æ˜¯ç”±äºæ²¡æœ‰è¢«æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œæ‰€ä»¥å…¶`#afterProperties`å¹¶ä¸ä¼šè¢«springå®¹å™¨å›è°ƒï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ä¼šè°ƒç”¨`buildSqlSessionFactory` è¿›è¡Œåˆ«åæ‰«æï¼Œ`TypeHandler`æ³¨å†Œï¼Œxmlè§£æï¼ˆè°ƒç”¨`XMLMapperBuilder#parse`ï¼‰ï¼Œæ‹¦æˆªå™¨æ³¨å†Œï¼Œå¹¶ä¸”æŒ‡å®šäº‹åŠ¡å·¥å‚ä½¿ç”¨`SpringManagedTransactionFactoryï¼ˆmybatisï¼Œspringäº‹åŠ¡ç»“åˆçš„å…³é”®ï¼Œåç»­è¯¦ç»†è§£æï¼‰`ç­‰å·¥ä½œ

é‚£ä¹ˆä»€ä¹ˆæ˜¯`SqlSession`?

#### 1.2.mybatisä¸­çš„`SqlSession`

`SqlSession`æ˜¯mybatisæ“ä½œæ•°æ®åº“æŠ½è±¡å‡ºæ¥çš„æ¥å£ï¼Œå®ƒå¯ä»¥æ‰§è¡Œå¢åˆ æ”¹æŸ¥ï¼Œæäº¤äº‹åŠ¡ï¼Œå›æ»šäº‹åŠ¡ï¼Œåˆ›å»ºmapperã€‚æˆ‘ä»¬å¹³æ—¶ä¾èµ–æ³¨å…¥çš„mapperï¼Œå…¶å®ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œå…¶åº•å±‚å…¶å®æ˜¯è°ƒç”¨`SqlSession`è¿›è¡Œçš„æ•°æ®åº“æ“ä½œ

#### 1.3.mybatis-springä¸­çš„`SqlSessionTemplate`

è¿™ä¸ªç±»å’Œä¸Šé¢ä¸¤ä¸ªç±»éƒ½ä¸åŒï¼Œå®ƒæ˜¯`org.mybatis.spring`è¿™ä¸ªåŒ…ä¸‹é¢çš„ï¼Œä¸€èˆ¬æ˜¯`mybatis-spring`è¿™ä¸ªä¾èµ–ä¼šå¼•å…¥çš„ç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯`SqlSessionï¼Œä¸Springäº‹åŠ¡ç®¡ç†ä¸€èµ·å·¥ä½œï¼Œä»¥ç¡®ä¿å®é™…ä½¿ç”¨çš„SqlSessionä¸å½“å‰Springäº‹åŠ¡å…³è”ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜ç®¡ç†ä¼šè¯ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ ¹æ®Springäº‹åŠ¡é…ç½®åœ¨å¿…è¦æ—¶å…³é—­ã€æäº¤æˆ–å›æ»šä¼šè¯ã€‚`

å®ƒæ˜¯springäº‹åŠ¡å’Œmybatisäº‹åŠ¡ç»“åˆçš„å…³é”®ï¼Œåé¢ç”¨åˆ°äº†æˆ‘ä»¬å†è¯¦ç»†å” å” 

### 2.æ³¨å…¥`AutoConfiguredMapperScannerRegistrar`

![image-20221204172653799](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204172656257-1776608733.png)

è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚æœæ²¡æœ‰`MapperFactoryBean`å’Œ`MapperScannerConfigurer`è¿™ä¸¤ä¸ªbean ï¼Œé‚£ä¹ˆä¼šimportä¸€ä¸ª`AutoConfiguredMapperScannerRegistrar`ï¼Œæˆ‘ä»¬ç®€å•è¯´ä¸‹è¿™ä¸‰ä¸ªç±»çš„ä½œç”¨ï¼Œåç»­ç”¨åˆ°äº†è¯¦ç»†è§£æå…¶åŸç†

#### 2.1`MapperFactoryBean`

MapperFactoryBean æ˜¯ä¸€ä¸ªFactoryBeanï¼Œ`FactoryBean`ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•å«`getObject`è´Ÿè´£åˆ›å»ºä¸€ä¸ªå¯¹è±¡äº¤ç»™springå®¹å™¨ç®¡ç†ï¼Œé€šå¸¸æˆ‘ä»¬å®šä¹‰çš„Controllerï¼ŒServiceéƒ½å…·å¤‡å®ç°ç±»ï¼Œè€Œéä¸€ä¸ªæ¥å£ï¼Œspringå¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªserviceçš„å®ç°ï¼Œä½†æ˜¯mybatisä¸­çš„mapperå¾€å¾€æ˜¯ä¸€ä¸ªæ¥å£ï¼Œspringä¸çŸ¥é“å¦‚ä½•å®ä¾‹åŒ–è¿™ä¸ªmapperï¼Œè¿™æ—¶å€™å‘ç°mapperçš„`BeanDefinition`ä¸­æ ‡è®°äº†è¿™ä¸ªclassæ˜¯`MapperFactoryBean` å°±ä¼šè°ƒç”¨`MapperFactoryBean#getObject`å®ä¾‹åŒ–ä¸€ä¸ªmapperï¼Œè¿™ä¸ªmapperä¾¿æ˜¯æˆ‘ä»¬æ³¨å…¥åˆ°serviceä¸­ä½¿ç”¨çš„mapperï¼Œå®ƒæ˜¯æºmapperçš„åŠ¨æ€ä»£ç†å®ç°ç±»ï¼Œä»è€Œåœ¨ä»£ç†ç±»ä¸­è°ƒç”¨`Sqlsesession`æ‰§è¡Œå¯¹åº”çš„sqlæ“ä½œ  
![image-20221204173306273](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204173308384-1519910653.png)

#### 2.2`AutoConfiguredMapperScannerRegistrar`

åœ¨æ²¡æœ‰`MapperScannerConfigurer`,mybatisè‡ªåŠ¨è£…é…ä¼šä¸ºæˆ‘ä»¬æ³¨å…¥å®ƒï¼Œå®ƒæ˜¯ä¸€ä¸ª`ImportBeanDefinitionRegistrar`

![image-20221204173438149](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204173440176-1985058493.png)

springè§£æé…ç½®ç±»çš„æ—¶å€™ï¼Œè‹¥å‘ç°ä¸€ä¸ªbeanæ˜¯`ImportBeanDefinitionRegistrar`çš„å®ç°ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨å…¶`registerBeanDefinitions`æ–¹æ³•ï¼Œä»è€Œæ³¨å…¥å…¶ä»–beançš„`BeanDefinition`ï¼Œè¿™é‡Œbeanä¾¿æ˜¯`MapperScannerConfigurer`ï¼ˆImportBeanDefinitionRegistraræ³¨å…¥çš„`MapperScannerConfigurer`æ‰«æçš„æ—¶å€™è¦æ±‚mapperæ ‡æ³¨@Mapperæ³¨è§£ï¼‰

#### 2.3 `MapperScannerConfigurer`

`MapperScannerConfigurer`è¿˜å¯ä»¥ä½¿ç”¨`@MapperScan`æˆ–è€…`@MapperScans`æ³¨è§£ï¼Œè¿›è¡Œå¼•å…¥ï¼Œè‹¥æˆ‘ä»¬ä½¿ç”¨äº†`@MapperScan`æˆ–è€…`@MapperScans`,ä¸Šé¢çš„`AutoConfiguredMapperScannerRegistrar`å°†ä¸ä¼šè¢«Importï¼Œ`AutoConfiguredMapperScannerRegistrar`çš„ä½œç”¨ä¾¿æ˜¯é»˜è®¤é…ç½®ä¸€ä¸ª`MapperScannerConfigurer`æ˜¯ä¸€ä¸ª`BeanDefinitionRegistryPostProcessor`

![image-20221204174053767](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204174056044-141761052.png)

springå®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå›è°ƒå®ƒçš„`postProcessBeanDefinitionRegistry`åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ä¼šæ‰«ææ‰€æœ‰çš„mapperæ¥å£ï¼ŒæŒ‡å®šå…¶classä¸º`MapperFactoryBean`,ä»è€Œåœ¨åç»­çš„å®ä¾‹åŒ–ä¸­ï¼Œè°ƒç”¨`MapperFactoryBean#getObject`ç”Ÿæˆmapperæ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡

ä¸‰ä¸¶mybatisæ‰«æmapperæ¥å£ï¼Œæ³¨å†Œmapperçš„Beanfinition
-----------------------------------------

### 1.MapperScannerConfigureræ˜¯å¦‚ä½•è¢«æ³¨å†Œåˆ°springå®¹å™¨ä¸­çš„

ä¸Šæ–‡ä¸­ï¼Œæˆ‘ä»¬è¯´åˆ°ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨`@MapperScan`æˆ–è€…`@MapperScans`æ³¨è§£æ ‡æ³¨åœ¨é…ç½®ç±»ä¸Šé¢ï¼Œé‚£ä¹ˆä¼šé»˜è®¤æ·»åŠ ä¸€ä¸ª`MapperScannerConfigurer`,è¿›è¡Œmapperæ¥å£çš„æ‰«ææ³¨å†Œå·¥ä½œ

![image-20221204174455872](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204174458229-1001413194.png)

é€šå¸¸å¯åŠ¨ç±»éƒ½æœ‰è¿™æ ·çš„@MapperScan

![image-20221204174516319](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204174518520-1197585719.png)

@MapperScanä¸Šé¢å­˜åœ¨@Importï¼Œä¼šå¯¼å…¥ä¸€ä¸ª`MapperScannerRegistrar`,è¿™æ˜¯ä¸€ä¸ª`ImportBeanDefinitionRegistrar`ä¼šåœ¨è¿™é‡Œæ³¨å†Œ`MapperScannerConfigurer`çš„beanå®šä¹‰ä¿¡æ¯

å…¶å®å°±æ˜¯æŠŠ@MapperScanæ³¨è§£ä¸Šçš„é…ç½®ï¼Œç»‘å®šåˆ°`MapperScannerConfigurer`çš„å±æ€§ä¸Š,

@MapperScanæ³¨è§£ï¼Œå¯ä»¥æŒ‡å®šmapperåœ¨çš„åŒ…ï¼Œmapperæ¥å£å¿…é¡»æ ‡æ³¨çš„æ³¨è§£ï¼ŒMapperæ¥å£åŠ¨æ€ä»£ç†å¯¹è±¡ç”Ÿæˆä½¿ç”¨çš„`MapperFactoryBean`ç­‰

### 2.MapperScannerConfigurer å¦‚ä½•è¿›è¡Œæ‰«ææ³¨å†Œmapperçš„

![image-20221204175221106](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204175223482-435334874.png)

å…¶å®æ‰«ææ³¨å†Œçš„å·¥ä½œå§”æ‰˜ç»™äº†`ClassPathMapperScanner`,è°ƒç”¨`scan`æ–¹æ³•è¿›è¡Œæ‰«ææ³¨å†Œ

![image-20221204175417187](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204175419482-879921288.png)

å®ƒæ˜¯ä¸€ä¸ª`ClassPathBeanDefinitionScanner`çš„å­ç±»ï¼ŒClassPathBeanDefinitionScannerå°±æ˜¯è´Ÿè´£åŒ…è·¯å¾„æ‰«æï¼Œæ³¨å†ŒBeanDefinitionçš„

![image-20221204175608720](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204175610714-712334976.png)

è¿™é‡Œçš„æ‰«æè°ƒç”¨äº†`ClassPathBeanDefinitionScanner`çš„doScanæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®åŒ…è·¯å¾„è§£ææˆ`Resouce`å¯¹è±¡ï¼Œç„¶åæ ¹æ®è·¯å¾„ä¸‹çš„ç±»åŒ…è£…æˆ`BeanDefinitionï¼ˆScannedGenericBeanDefinitionï¼‰`

é‡ç‚¹çœ‹ä¸‹`processBeanDefinitions`

![image-20221204180002627](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204180004908-1594693639.png)

è¿™é‡Œæœ€å…³é”®çš„æ˜¯`definition.setBeanClass(this.mapperFactoryBeanClass)`ï¼Œå³å°†mapperæ¥å£çš„BeanDefinitionç±»å‹æŒ‡å®šä¸º`MapperFactoryBean`,è¿™æ ·åœ¨springåç»­å®ä¾‹åŒ–mapperçš„æ—¶å€™å°±è°ƒç”¨`MapperFactoryBean#getObject`æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–äº†

è‡³æ­¤æˆ‘ä»¬å­¦ä¹ äº†SpringBootæ˜¯å¦‚ä½•å’Œmybatisè¿›è¡Œç»“åˆçš„ï¼Œä¸‹é¢æ€»ç»“æˆä¸€å›¾

![image-20221205063340713](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205063344606-167792567.png)

å››ä¸¶Mapper beançš„å®ä¾‹åŒ–
-----------------

å½“æˆ‘ä»¬ä¸€ä¸ªServiceéœ€è¦æ³¨å…¥ä¸€ä¸ªmapperçš„æ—¶å€™ï¼Œä¼šä»Springå®¹å™¨ä¸­æ‰¾å¯¹åº”çš„å®ä¾‹ï¼Œè¿™æ—¶å€™è¾¹ä¼šæ¶‰åŠåˆ°è¿™ä¸ªmapperçš„å®ä¾‹åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬mapperæ˜æ˜æ˜¯ä¸€ä¸ªæ¥å£å‘€ï¼Œå¦‚ä½•å®ä¾‹åŒ–æ˜µï¼Ÿ

è™½ç„¶æˆ‘ä»¬mapperæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯æ³¨å…¥åˆ°serviceå±æ€§ä¸Šçš„æ˜¯è¿™ä¸ªæ¥å£çš„å®ç°ç±»ï¼Œå®ƒæ˜¯mybatisåŠ¨æ€ä»£ç†åç”Ÿæˆçš„å¯¹è±¡ã€‚

è¿™ä¸ªå®ä¾‹åŒ–çš„å…¥å£ä¾¿æ˜¯`AbstractBeanFactory#getBean`æ–¹æ³•

### 1.è·å–mapperå¯¹åº”çš„BeanDefinition

è¿™é‡Œè·å–çš„beanDefinitionä¾¿æ˜¯æºè‡ª`ClassPathMapperScanner` æ³¨å†Œåˆ°å®¹å™¨ä¸­çš„

### 2.å®ä¾‹åŒ–MapperFactoryBean

æˆ‘ä»¬ä¸Šé¢è¯´åˆ°è¿‡ï¼Œå®ä¾‹åŒ–mapperéœ€è¦è°ƒç”¨`MapperFactoryBean#getObject`ï¼Œé‚£ä¹ˆé¦–å…ˆéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªMapperFactoryBean

![image-20221204225703939](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204225707354-669660343.png)

è¿™é‡Œå®ä¾‹åŒ–MapperFactoryBeanè¾¹æ˜¯ä½¿ç”¨çš„`createBean`æ–¹æ³•ï¼Œç„¶åSpringä¼šä½¿ç”¨åå°„è°ƒç”¨æ„é€ æ–¹æ³•å®ä¾‹åŒ–å‡ºMapperFactoryBeanï¼ˆSpringè¿˜å­˜åœ¨ä½¿ç”¨CGLIBç”Ÿæˆå­ç±»ç„¶åå®ä¾‹åŒ–çš„æ–¹å¼ï¼‰ï¼Œå…¶ä¸­è°ƒç”¨çš„æ˜¯

![image-20221204230443642](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204230446238-1164098847.png)

è¿™ä¸ªæ„é€ æ–¹æ³•éœ€è¦ä¸€ä¸ªå…¥å‚ï¼Œè¡¨ç¤ºMapperæ¥å£ç±»å‹ï¼Œé‚£ä¹ˆè¿™ä¸ªmapperInterfaceå…¥å‚æ¥è‡ªé‚£ä¹ˆæ˜µï¼ŸClassPathMapperScanneræ‰«æå®Œmapperæ¥å£ï¼Œç”ŸæˆBeanDefinitionåï¼Œè¿˜ä¼šåœ¨BeanDefinitionä¸­è®°å½•å…¨é™å®šç±»å‹ï¼Œè¿™ä¸ªå…¨é™å®šç±»åå°†ä½œä¸ºMapperFactoryBeançš„æ„é€ å™¨å…¥å‚

![image-20221204231236586](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221204231239302-1720702699.png)

### 3.MapperFactoryè¿›è¡Œå±æ€§æ³¨å…¥

ä¸Šé¢æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªMapperFactoryBeanï¼Œä½†æ˜¯å®ƒæ„é€ å‡ºä¸€ä¸ªmapperéœ€è¦å€ŸåŠ©SqlSessionï¼Œè¿™é‡Œä½¿ç”¨çš„SqlSessionå…¶å®æ˜¯`SqlSessionTemplate`,æˆ‘ä»¬æŒ‡å¯¼MybatisAutoConfigurationä¼šè®©å®¹å™¨ä¸­æ³¨å…¥ä¸€ä¸ª`SqlSessionTemplate`ï¼Œé‚£ä¹ˆspringæ˜¯å¦‚ä½•æŠŠè¿™ä¸ª`SqlSessionTemplate`è®¾ç½®åˆ°mapperFactoryBeançš„å±æ€§ä¸Šçš„æ˜µï¼Ÿ

è¿™ä¸€æ­¥å°±å‘ç”Ÿåœ¨`populateBean`æ–¹æ³•ä¸­ï¼Œå…¶ä¼šè°ƒç”¨`applyPropertyValues`,å®ƒä¼šæ ¹æ®javaBeançš„å†…çœï¼Œè·å–å…¶éœ€è¦SqlSessionFactoryå’ŒSqlSessionTemplateï¼Œç„¶åä»å®¹å™¨ä¸­è·å–`MybatisAutoConfiguration`æ³¨å…¥çš„å®ä¾‹ï¼Œè¿›è¡Œåå°„è°ƒç”¨Setæ–¹æ³•æ³¨å…¥

### 4.MapperFactoryçš„åˆå§‹åŒ–

MapperFactoryçš„çˆ¶ç±»`SqlSessionDaoSupport`ç»§æ‰¿è‡ª`DaoSupport()`,å…¶ä¸­`DaoSupport`åˆå®ç°äº†`InitializingBean`,åœ¨Springå®ä¾‹åŒ–MapperFactoryï¼Œå®Œæˆä¾èµ–æ³¨å…¥åå°†å›è°ƒ`InitializingBean#afterPropertiesSet`

![image-20221205055735702](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205055737816-1401577125.png)

å…¶ä¸­`checkDaoConfig`æ–¹æ³•è¢«MapperFactoryBeané‡å†™

![image-20221205055947092](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205055949442-1351146267.png)

è¿™é‡Œä¼šè°ƒç”¨`configuration.addMapper`è§£æxmlå’Œmybaitsç›¸å…³çš„æ³¨è§£ï¼Œç„¶åè¿›è¡Œæ³¨å†Œå’Œæ¥å£è¿›è¡Œç»‘å®šï¼Œä½†æ˜¯è¿™ä¸€æ­¥è§£æxmlæ“ä½œé€šå¸¸ä¸ä¼šçœŸæ­£è¿›è¡Œï¼Œå› ä¸ºåœ¨åˆ›å»ºSqlSessionFactoryçš„æ—¶å€™å·²ç»è¿›è¡Œäº†

### 5.è°ƒç”¨MapperFactory#getObjectå®ä¾‹åŒ–å‡ºä¸€ä¸ªmapper

![image-20221205063504160](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205063507222-1564068001.png)

å®ä¾‹åŒ–å‡ºä¸€ä¸ªMapperæ¥å£çš„åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯`SqlSessesionTemplate#getMapper`

![image-20221205064437028](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205064440161-93763391.png)

é‚£ä¹ˆåˆ°åº•mapperæ–¹æ³•è°ƒç”¨çš„æ—¶æ˜¯å¦‚ä½•æ“ä½œæ•°æ®åº“çš„æ˜µï¼Ÿè¿™ä¸€ç‚¹æˆ‘ä»¬åé¢ç»§ç»­è¯´

è‡³æ­¤æˆ‘ä»¬çŸ¥é“äº†æˆ‘ä»¬serviceæ³¨å…¥çš„mapperå…¶å®æ˜¯mybatisä½¿ç”¨åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å¯¹è±¡ï¼Œè¡¨é¢æ˜¯ä¸€ä¸ªä»€ä¹ˆæ–¹æ³•å®ç°éƒ½æ²¡æœ‰çš„æ¥å£ï¼Œå…¶å®æ˜¯åŠ¨æ€ä»£ç†"è´Ÿé‡å‰è¡Œ"ï¼Œä¸‹å›¾å±•ç¤ºäº†ä¸€ä¸ªmapperè¢«åˆ›é€ å‡ºæ¥çš„å…¨æµç¨‹

![image-20221205070231918](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205070236734-588567916.png)

äº”ä¸¶Mybatis å’Œspringäº‹åŠ¡çš„ç»“åˆ
----------------------

ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†xxMapperå…¶å®æ˜¯ä¸€ä¸ªjdkåŠ¨æ€ä»£ç†ç”Ÿæˆçš„å¯¹è±¡ ï¼Œå…¶`InvocationHandler`æ˜¯`MapperProxy`

![image-20221205070556722](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205070602651-739453986.png)

å½“mapperè¢«è°ƒç”¨å…¶æ¥å£ä¸­å£°æ˜çš„æ–¹æ³•çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨åˆ°`InvocationHandler#invoke`è¿™æ—¶å€™MapperProxyå°±ä¼šå¤§æ˜¾èº«æ‰‹

### 1.MapperProxy#invoke

![image-20221205071325979](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205071331384-814852413.png)

MapperProxyå†…éƒ¨ä½¿ç”¨äº†ä¸€ä¸ªMapç¼“å­˜æ–¹æ³•å’Œå¯¹åº”çš„æ‰§è¡Œå™¨ï¼ˆ`MapperMethodInvoker`ï¼‰ï¼Œè¿™ä¸ªmapé€šå¸¸æ¥è‡ªMapperProxyFactoryçš„ConcurrentHashMapå±æ€§ã€‚è€ŒçœŸæ­£æ–¹æ³•çš„è°ƒç”¨åˆå§”æ‰˜ç»™äº†`MapperMethod#execute`,MapperMethodæ ¹æ®æ–¹æ³•è°ƒç”¨çš„ç±»å‹ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰è°ƒç”¨MapperProxyä¸­çš„å±æ€§SqlSessionï¼ˆspringç¯å¢ƒä¸‹çš„sqlSessionå®ç°ç±»æ˜¯SqlSessionTemplateï¼‰\`å¯¹åº”çš„æ–¹æ³•

![image-20221205072013759](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221205072017282-1638660892.png)

### 2.SqlSessionTemplate ä¸mybatis springäº‹åŠ¡

![image-20221207193657612](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207193704945-59564245.png)

SqlSessionTemplateå®ç°äº†`SqlSession`æ¥å£ï¼Œä½†æ˜¯çœŸæ­£è¿›è¡Œæ•°æ®åº“æ“ä½œçš„æ—¶å€™ï¼Œéƒ½æ˜¯å§”æ‰˜ç»™å±æ€§`SqlSessionProxy`ï¼Œ`SqlSessionTemplate`å­˜åœ¨çš„æ„ä¹‰åœ¨äº`"æ¨¡æ¿"`â€”â€”å¤ç”¨SqlSessionï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦å¤ç”¨ï¼Œä¸ºä½•è¦å¤ç”¨ï¼Ÿæˆ‘ä»¬æ¥ç€çœ‹ä¸‹å®ƒçš„æ„é€ æ–¹æ³•

![image-20221207193835760](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207193838352-1487224481.png)

å¯ä»¥çœ‹åˆ°ï¼Œå…¶å†…éƒ¨çš„`sqlSessionProxy`æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ï¼Œæˆ‘ä»¬çœ‹ä¸‹`SqlSessionInterceptor`,å®ƒæ˜¯ä¸€ä¸ª`InvocationHandler`

![image-20221207222821878](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207222825737-1370427044.png)

#### 2.1 mybatis å’Œ springç»“åˆåå³ä½¿æ²¡æœ‰å¼€å¯äº‹åŠ¡ä¹Ÿèƒ½è‡ªåŠ¨æäº¤çš„åŸå› 

ä¸Šå›¾å¯ä»¥çœ‹åˆ°å¦‚æœäº‹åŠ¡å¹¶éäº¤ç»™springç®¡ç†ï¼ˆè°ƒç”¨mapperæ‰§è¡Œå•æ¡å¢åˆ æ”¹æŸ¥çš„æ•°æ®åº“æ“ä½œï¼Œä¼šè‡ªåŠ¨æäº¤äº‹åŠ¡ï¼‰åœ¨åå°„è°ƒç”¨sqlsessionæ–¹æ³•åï¼Œä¼šè¿›è¡Œäº‹åŠ¡æäº¤ã€‚

    //ä¸Šé¢æ— äº‹åŠ¡æ³¨è§£ ä¸‹é¢è¿™æ¡è¯­å¥ä¼šè°ƒç”¨åˆ°sqlsessionçš„åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œè¿›è¡Œè‡ªåŠ¨æäº¤
    public void test(){
     
     	xxxMapper.insertOne(xx);
     }
    

ç¬”è€…æ ¡æ‹›çš„æ—¶å€™ï¼Œé¢è¯•å®˜é—®è¿‡è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å°¼ç›æ‰¯åˆ°äº†mysqlçš„è‡ªåŠ¨æäº¤ğŸ˜‚

`åŸç”Ÿmybatisä½¿ç”¨sqlsessionæ‰§è¡Œæ•°æ®åº“æ“ä½œåï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨å…¶commitæ–¹æ³•ã€‚springç¯å¢ƒçš„mybatisä¼šè‡ªåŠ¨æäº¤ï¼Œä¾¿æ˜¯ç”±äºsqlsessionTemplateå¤ç”¨çš„sqlsessionï¼Œå…¶å®æ˜¯`DefaultSqlsession`çš„ä»£ç†ç±»ï¼Œåœ¨æ‰§è¡Œæ•°æ®åº“æ“ä½œåï¼Œå‘ç°äº‹åŠ¡æ²¡æœ‰è¢«springç®¡ç†ä¾¿è¿›è¡Œè‡ªåŠ¨æäº¤`

#### 2.2ä½¿ç”¨mapperæ‰§è¡Œå¤šä¸ªæ•°æ®åº“ä¿®æ”¹æ“ä½œï¼Œå…·å¤‡äº‹åŠ¡çš„åŸå› 

    @Transactional
    public void test(){
       xxxmapper.insert1();
        xxxmapper.insert2();
    }
    

ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸Šé¢è¿™ä¸ªæ–¹æ³•springå®¹å™¨ä¸­çš„beanæ‰§è¡Œæ˜¯å…·å¤‡äº‹åŠ¡çš„ï¼Œé‚£ä¹ˆä¸ºå•¥å…·å¤‡äº‹åŠ¡æ˜µï¼Ÿ

ä½ å¯èƒ½ä¼šå›ç­”ï¼Œå®¹å™¨ä¸­çš„beanæ˜¯è¢«`BeanPostProcesser`åœ¨beanå®Œæˆå®ä¾‹åŒ–ï¼Œä¾èµ–æ³¨å…¥ï¼Œåä¼šè¢«`BeanPostProcessor`åç½®å¤„ç†å™¨ï¼Œä¾æ¬¡è¿›è¡Œå¤„ç†ï¼Œç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå…¶ä¸­å­˜åœ¨`AnnotationAwareAspectJAutoProxyCreatorï¼ˆ@Aspectï¼Œ@Beforeç­‰æ³¨è§£æ„ŸçŸ¥èƒ½åŠ›çš„BeanPostProcessorï¼Œä¼šå°†@Aspectæ ‡è®°çš„beanä¸­çš„æ–¹æ³•è§£ææˆAdivorç„¶åä½¿ç”¨ProxyFactoryç”Ÿæˆå…¶ä»£ç†å¯¹è±¡ï¼‰`æˆ–è€…è¯´ä»»ä½•`AbstractAdvisorAutoProxyCreator`ï¼Œå®ƒä¼šå°†ä½¿ç”¨Advisor å¹¶åŸºäºCGLIBï¼Œæˆ–è€…javaæ¥å£åŠ¨æ€ä»£ç†ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå…¶ä¸­ä¾¿æœ‰`BeanFactoryTransactionAttributeSourceAdvisor`ï¼ˆä¸€ä¸ªAdviorï¼ŒçœŸæ­£äº‹åŠ¡ä»£ç†çš„é€»è¾‘åœ¨TransactionInterceptor(ä¸€ä¸ªAdviseï¼Œå®ç°äº‹åŠ¡å¼€å¯ï¼Œäº‹åŠ¡æäº¤ï¼Œå›æ»šç­‰é€»è¾‘)\]ä¸­ï¼Œä»¥åŠTransactionAttributeSource(ç”¨äºè§£æäº‹åŠ¡æ³¨è§£ï¼Œåˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦å¼€å¯äº‹åŠ¡ï¼ŒTransactionAttributeSourcePointcutè¿™ä¸ªpointcut ä¾¿æ˜¯ä½¿ç”¨å®ƒè¿›è¡Œåˆ¤æ–­æ–¹æ³•æ˜¯å¦éœ€è¦è¢«äº‹åŠ¡ä»£ç†ï¼‰å®ƒå®ç°è§£æäº‹åŠ¡æ³¨è§£åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåŠ¨æ€ä»£ç†ï¼Œå®ç°äº‹åŠ¡åŠŸèƒ½

**ä½†æ˜¯è¿™ä¸ªé—®é¢˜å½’æ ¹ç»“åº•è¿˜æ˜¯æ²¡æœ‰è¯´æ˜ï¼Œä¸ºä»€ä¹ˆmapperå¤šæ¬¡æ•°æ®åº“ä¿®æ”¹æ“ä½œï¼Œå…·å¤‡äº‹åŠ¡ã€‚**

å…·å¤‡äº‹åŠ¡çš„å‰ææ˜¯ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ï¼Œè¿™æ ·æ‰èƒ½connection.commitæäº¤äº‹åŠ¡ï¼Œconnnection.rollbackï¼Œå›æ»šäº‹åŠ¡ï¼Œæ ¹æœ¬åŸç†å°±åœ¨SqlSessionTemplateï¼Œå¯¹SqlSessionçš„å¤ç”¨ä¸­

![image-20221207230830963](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207230833663-1109437654.png)

ä¸Šå›¾å±•ç¤ºäº†mybatisåœ¨ç»“åˆspringåï¼Œæ˜¯å¦‚ä½•è®©è‡ªå·±çš„sqlsessionå¤ç”¨çš„ï¼Œå­˜äºäº‹åŠ¡ç®¡ç†å™¨ä¸­ï¼ˆåŸºäºThreadLocalï¼Œå­˜å‚¨äº‹åŠ¡ä¿¡æ¯ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºå•¥å¤šçº¿ç¨‹æƒ…å†µä¸‹äº‹åŠ¡æ•ˆçš„åŸå› ï¼‰ä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è¯´æ˜ä¸ºå•¥å¤ç”¨äº†åŒä¸€ä¸ªconnection

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ä½¿ç”¨`SqlSessionFactoryï¼ˆmybatisè‡ªåŠ¨é…ç½®ç±»æ³¨å…¥çš„DefaultSqlSessionFactoryï¼‰`å¼€å¯ä¸€ä¸ªsqlsessionçš„é€»è¾‘

![image-20221207231343614](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207231346580-594332229.png)

é¦–å…ˆè·å–`TransactionFactory`äº‹åŠ¡å·¥å‚ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`SpringManagedTransactionFactory`![image-20221209074945974](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221209074949547-1782573532.png)

å®ƒè¿”å›çš„äº‹åŠ¡æ˜¯`SpringManagedTransaction`,ç„¶ååˆ›å»ºä¸€ä¸ª`Executor`ï¼Œç„¶åå°è£…æˆä¸€ä¸ª`DefaultSqlSession`è¿”å›ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹`SpringManagedTransaction`  
![image-20221209075312815](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221209075314868-1667518581.png)

è¿™é‡Œ`Connection`çš„è·å–ä¾¿æ˜¯ä»äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨çš„ThreadLocalä¸­è·å–ï¼Œå¦‚æœæ²¡æœ‰connectionä¸€èˆ¬æ˜¯ç¬¬ä¸€æ¬¡æ•°æ®åº“æ“ä½œï¼Œé‚£ä¹ˆè¿™é‡Œä¼š`dataSource.getConnection()`å¼€å¯ä¸€ä¸ªè¿æ¥ï¼Œç„¶åäº¤ç”±äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨å¤„ç†ï¼Œåç»­ä¾¿ä¼šå¤ç”¨æ­¤è¿æ¥ã€‚

#### 2.3 springç®¡ç†mybatisäº‹åŠ¡çš„æ—¶å€™ï¼Œäº‹åŠ¡ä½•æ—¶æäº¤

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°æ•°æ®åº“æ“ä½œéƒ½äº¤ç”±`DefaultSqlSession`å¤„ç†ï¼Œ`DefaultSqlSession`æ˜¯ä¸€ä¸ªé—¨é¢ï¼Œå…¶æäº¤äº‹åŠ¡ï¼Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨åˆ°äº†`SpringManagedTransaction`çš„`commit`æ–¹æ³•

![image-20221209075843770](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221209075846012-1393478098.png)

è¿™é‡Œå¯ä»¥çœ‹åˆ°`SpringManagedTransaction#commit`åªæœ‰è¿æ¥æ²¡æœ‰äº¤ç»™springç®¡ç†ï¼Œå¹¶ä¸”è¿æ¥å¹¶éè‡ªåŠ¨æäº¤æ‰ä¼šç”Ÿæ•ˆï¼ŒåŸºæœ¬ä¸Šè°ƒç”¨è¿™é‡Œçš„æäº¤ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœã€‚

ä¸Šé¢æˆ‘ä»¬è¯´åˆ°SqlSessionTemplateå§”æ‰˜åŠ¨æ€ä»£ç†åçš„SqlSessionæ‰§è¡Œæ“ä½œçš„æ—¶å€™ï¼Œä¼šä»äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸­è·å–SqlSessionï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆnewä¸€ä¸ªç„¶åæ³¨å†Œåˆ°äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸­

![image-20221211151107855](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211151110388-228488097.png)

äº‹åŠ¡æäº¤çš„å¥¥ç§˜å°±åœ¨`registerSessionHolder`ä¸­

![image-20221211151350532](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211151354868-461739141.png)

è¿™é‡Œçš„`SqlSessionSynchronization`æ˜¯ä¸€ä¸ª`TransactionSynchronization`å¯¹è±¡ï¼Œ`TransactionSynchronization`æ¥å£æä¾›äº†å¤šä¸ªæ–¹æ³•åœ¨äº‹åŠ¡ä¸åŒçš„æ—¶æœŸä¼šåœ¨ä»£ç†å¯¹è±¡@Transactionalæ ‡æ³¨çš„æ–¹æ³•ä¸­è¿›è¡Œå›è°ƒ

![image-20221211151453417](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211151455600-870584280.png)

å…¶ä¸­beforeCommitæ–¹æ³•ä¼šåœ¨@Transactionalæ ‡æ³¨çš„ä»£ç†å¯¹è±¡å…¶ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå®Œæˆåï¼Œå¦‚æœéœ€è¦æäº¤äº‹åŠ¡ï¼Œä¼šè¢«å›è°ƒåˆ°ï¼Œè¿™æ—¶å€™å°±ä¼šè°ƒç”¨SqlSessionçš„commitæ–¹æ³•è¿›è¡Œæäº¤äº‹åŠ¡

æäº¤äº‹åŠ¡ä¼šç»§ç»­å§”æ‰˜ç»™SpringManagedTransaction,å¯æ˜¯å…¶commitæ–¹æ³•åªä¼šåœ¨äº‹åŠ¡ä¸è¢«springç®¡ç†çš„æ—¶å€™è¿›è¡Œæäº¤ï¼Œå¦‚æœäº‹åŠ¡è¢«springç®¡ç†ï¼Œ@Transactionalæ³¨è§£æ ‡æ³¨çš„ä»£ç†å¯¹è±¡æ–¹æ³•æ‰§è¡Œåä¼šè°ƒç”¨`PlatformTransactionManager#commit`ï¼Œè¿™é‡Œä¼šè°ƒç”¨åˆ°`DataSourceTransactionManager`(å¦‚æœæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡é‚£ä¹ˆæ˜¯å…¶ä»–çš„å®ç°ç±»ï¼ŒåŸºäºæ•°æ®æºçš„äº‹åŠ¡éƒ½æ˜¯è°ƒç”¨æ­¤ç±»)å®ƒä¼šè°ƒç”¨`connection.commit` æäº¤äº‹åŠ¡

![image-20221211153450112](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211153453068-925500365.png)

#### 2.4ä¸åŠ äº‹åŠ¡æ³¨è§£çš„mapperè¿›è¡Œæ•°æ®åº“æ“ä½œï¼Œäº‹åŠ¡ä½•æ—¶æäº¤

sqlSessionTemplate ä¸­çš„SqlSessionInterceptorï¼Œåœ¨åˆ›å»ºå‡ºSqlSessionæ‰§è¡Œå®Œæ•°æ®åº“æ“ä½œçš„æ—¶å€™ï¼Œå‘ç°äº‹åŠ¡æ²¡æœ‰è¢«Springç®¡ç†ï¼Œæ­¤æ—¶ä¾¿ä¼šç«‹å³æäº¤äº‹åŠ¡

![image-20221211153837823](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211153841687-205369929.png)

ä¸”`getSqlsession`æ— æ³•ä»äº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸­å¤ç”¨SqlSessionï¼Œæ¯æ¬¡éƒ½æ˜¯newå‡ºä¸€ä¸ªSqlSession å› ä¸ºå½“å‰æ–¹æ³•æ— äº‹åŠ¡æ³¨è§£ï¼Œäº‹åŠ¡åŒæ­¥ç®¡ç†å™¨ä¸ä¼šå¤„äºæ´»è·ƒçŠ¶æ€ã€‚æäº¤äº‹åŠ¡ä¼šè°ƒç”¨åˆ°`SpringManagedTransaction`å…¶commitæ–¹æ³•ä¸­åˆ¤æ–­å¾—åˆ°äº‹åŠ¡æ²¡æœ‰è¢«springç®¡ç†ï¼Œä¾¿ä¼šè°ƒç”¨connection.commitæäº¤äº‹åŠ¡

#### 2.5ä¸åŠ äº‹åŠ¡æ³¨è§£ä½¿ç”¨mapperæ‰§è¡Œå¤šæ¡æ•°æ®åº“ä¿®æ”¹æ“ä½œï¼Œä¼šæ²¡æœ‰äº‹åŠ¡çš„åŸå› 

    public void test(){
       xxxmapper.insert1();
       xxxmapper.insert2();
    }
    

2.4ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`insert1`å’Œ`insert2`çš„æ‰§è¡Œï¼Œå…¶å®æ¯æ¬¡éƒ½ä¼šnewå‡ºä¸€ä¸ªæ–°çš„sqlsessionï¼Œæ¯ä¸€ä¸ªsqlsessionå¯¹åº”ä¸€ä¸ª`SpringManagedTransaction`ï¼Œæ¯ä¸€æ¬¡æ‰§è¡Œç»“æŸåéƒ½ä¼šç«‹é©¬æäº¤äº‹åŠ¡ï¼Œæ‰€æœ‰ä¸å…·å¤‡äº‹åŠ¡ã€‚æ‰€æœ‰é‚£æ€•`test`æ–¹æ³•æœ€åæŠ›å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¹Ÿä¼šæäº¤ã€‚

å…­ä¸¶Mybatisæ“ä½œæ•°æ®åº“
--------------

![image-20221207193406603](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221207193409030-690946712.png)

ä¸Šé¢æˆ‘ä»¬ç ”ç©¶äº†mybatisäº‹åŠ¡å’Œspringäº‹åŠ¡çš„ç»“åˆï¼Œå¹¶æ²¡æœ‰å…³æ³¨mybatisæ˜¯å¦‚ä½•è¿›è¡Œæ•°æ®åº“æ“ä½œçš„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹mybatisæ˜¯æ€ä¹ˆæ‹¿åˆ°xmlä¸­çš„ä¸€æ¡sqlï¼ŒæŠŠæˆ‘ä»¬å…¥å‚ä¸­çš„å¯¹è±¡æ˜ å°„åˆ°sqlä¸­çš„å ä½ç¬¦ï¼Œæ‰§è¡Œsqlç„¶åå°†ç»“æœé›†è§£æä¸ºmapperæ–¹æ³•çš„å‡ºå‚ç±»å‹å¯¹è±¡çš„ã€‚

å‰é¢å‡ èŠ‚çš„çŸ¥è¯†ä¸­æåˆ°ï¼ŒDefaultSqlSessionæ˜¯mybatisæ“ä½œæ•°æ®åº“çš„é—¨é¢ï¼Œå¢åˆ æ”¹æŸ¥éƒ½æ˜¯äº¤ç”±å®ƒæ¥å®ç°

å…¶ä¸­æ‰€æœ‰çš„æŸ¥è¯¢æ“ä½œéƒ½æ˜¯è°ƒç”¨`select`æˆ–è€…`selectList`æ–¹æ³•,æ‰€æœ‰çš„æ–°å¢ï¼Œæ›´æ–°ï¼Œåˆ é™¤éƒ½æ˜¯è°ƒç”¨`update`ï¼ˆè¿™äº›éƒ½æ˜¯æ•°æ®åº“å˜æ›´æ“ä½œï¼‰æ–¹æ³•ï¼Œæˆ‘ä»¬ä»¥æŸ¥è¯¢æ“ä½œä¸ºä¾‹

![image-20221211160240777](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211160243983-1724854518.png)

å¯ä»¥çœ‹åˆ°æŸ¥è¯¢çš„æ“ä½œæœ€ç»ˆå§”æ‰˜ç»™äº†Executorå¯¹è±¡

### 1.Executor

![image-20221211160536499](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211160538810-1591203254.png)

#### 1.1.Executoræ¥å£

*   è¯¥æ¥å£æä¾›äº†æ”¹å’ŒæŸ¥çš„åŸºæœ¬åŠŸèƒ½ï¼ˆæ•°æ®åº“çš„åˆ é™¤æ’å…¥æœ¬è´¨ä¹Ÿæ˜¯æ›´æ–°ï¼‰
*   æäº¤å’Œå›æ»š
*   ç¼“å­˜ç›¸å…³æ–¹æ³•
*   æ‰¹å¤„ç†åˆ·æ–°
*   æ‰§è¡Œå™¨å…³é—­
*   å»¶è¿ŸåŠ è½½

#### 1.2.BaseExecutor

â€‹ å¯¹Executorä¸­çš„æ¥å£ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•è¿›è¡Œäº†é€šç”¨çš„å®ç°ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶ï¼Œæˆ–è€…æ‰‹åŠ¨æŒ‡å®šæ‰§è¡Œå™¨ç±»å‹æ¥è®©mybatisä½¿ç”¨å…·ä½“æ‰§è¡Œå™¨å®ç°ï¼ˆè¿™é‡Œè¯´çš„å®ç°åªæœ‰BatchExcutorï¼ŒSimpleExecutorï¼ŒReuseExcutorï¼‰ï¼Œè¿˜æä¾›äº†ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼ˆå¦‚ä¸‹ï¼‰è®©å­ç±»å®ç°

*   doUpdate
*   doFlushStatements
*   doQuery

#### 1.3.SimpleExecutor

ç®€å•æ‰§è¡Œå™¨ï¼Œæ˜¯ MyBatis ä¸­é»˜è®¤ä½¿ç”¨çš„æ‰§è¡Œå™¨ï¼Œå¯¹BaseExecutorä¸­çš„æ–¹æ³•è¿›è¡Œäº†ç®€å•çš„å®ç°ï¼Œï¼ˆæ ¹æ®é…ç½®è·å–è¿æ¥ï¼Œæ ¹æ®è¿æ¥è·å–Statementï¼Œæ‰§è¡Œsqlï¼Œç»“æœé›†æ˜ å°„ï¼‰æ¯æ‰§è¡Œä¸€æ¬¡ update æˆ– selectï¼Œå°±å¼€å¯ä¸€ä¸ª Statement å¯¹è±¡ï¼Œç”¨å®Œå°±ç›´æ¥å…³é—­ Statement å¯¹è±¡

#### 1.4.BatchExecutor

ä¸»è¦åº”å¯¹æ‰¹é‡æ›´æ–°ï¼Œæ’å…¥ï¼Œåˆ é™¤ï¼Œä¸€æ¬¡å‘æ•°æ®åº“å‘é€å¤šä¸ªSQLè¯­å¥ä»è€Œå‡å°‘é€šä¿¡å¼€é”€ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚ï¼ˆå¯¹æŸ¥æ‰¾ä¸ç”Ÿæ•ˆï¼‰

    æ‰¹é‡å¤„ç†å…è®¸å°†ç›¸å…³çš„SQLè¯­å¥åˆ†ç»„åˆ°æ‰¹å¤„ç†ä¸­ï¼Œå¹¶é€šè¿‡å¯¹æ•°æ®åº“çš„ä¸€æ¬¡è°ƒç”¨æ¥æäº¤å®ƒä»¬ï¼Œä¸€æ¬¡æ‰§è¡Œå®Œæˆä¸æ•°æ®åº“ä¹‹é—´çš„äº¤äº’ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šJDBCä¸­çš„æ‰¹å¤„ç†åªæ”¯æŒ insertã€update ã€delete ç­‰ç±»å‹çš„SQLè¯­å¥ï¼Œä¸æ”¯æŒselectç±»å‹çš„SQLè¯­å¥ã€‚
    

#### 1.5.ReuseExecutor

    ReuseExecutor ä¸åŒäº SimpleExecutor çš„åœ°æ–¹åœ¨äº ReuseExecutor ç»´æŠ¤äº† Statement ç¼“å­˜
    

ReuseExecutoré¡¾åæ€ä¹‰å°±æ˜¯é‡å¤ä½¿ç”¨æ‰§è¡Œï¼Œå…¶å®šä¹‰äº†ä¸€ä¸ªMap<String, [Statement](https://so.csdn.net/so/search?q=Statement&spm=1001.2101.3001.7020)\>ï¼Œå°†æ‰§è¡Œçš„sqlä½œä¸ºkeyï¼Œå°†æ‰§è¡Œçš„Statementä½œä¸ºvalueä¿å­˜ï¼Œè¿™æ ·æ‰§è¡Œç›¸åŒçš„sqlæ—¶å°±å¯ä»¥ä½¿ç”¨å·²ç»å­˜åœ¨çš„Statementï¼Œå°±ä¸éœ€è¦æ–°åˆ›å»ºäº†ï¼Œä»è€Œé¿å…SimpleExecutorè¿™æ ·å¤šæ¬¡è¿›è¡Œå‚æ•°æ‹¼æ¥ç”Ÿæˆstatementä»¥æé«˜æ€§èƒ½

#### 1.6.CachingExecutor

CachingExecutoræ²¡æœ‰ç»§æ‰¿BaseExecutorï¼Œ`CachingExecutor` ä¸å…·å¤‡ `Executor` æ‰§è¡Œå™¨åŠŸèƒ½ï¼Œ`CachingExecutor` æ˜¯ä¸€ä¸ªè£…é¥°å™¨ï¼Œ Mybatis é‡‡ç”¨è£…é¥°è€…æ¨¡å¼å¯¹ `Executor` æ‰§è¡Œå™¨æä¾›äº†åŠŸèƒ½å¢å¼ºã€‚CachingExecutor`è£…é¥°å™¨èƒ½å¤Ÿä½¿å¾—è¢«è£…é¥°çš„`Executor å…·å¤‡äºŒçº§ç¼“å­˜åŠŸèƒ½

ä¸‹å›¾æ˜¯Configurationåˆ›å»ºExecutorçš„æµç¨‹ï¼Œå¦‚æœå…¨å±€é…ç½®æŒ‡å®šäº†cachEnableï¼Œé‚£ä¹ˆä¼šä½¿ç”¨CachingExcutorè¿›è¡Œè£…é¥°ï¼Œå¹¶ä¸”mybatisæ’ä»¶å¯ä»¥ä½œç”¨äºExcutorï¼Œ

![image-20221211161625786](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211161629566-1665304780.png)

#### 1.7 Executoræ‰§è¡Œæ•°æ®åº“æ“ä½œæµç¨‹

![img](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821115356801-2001785787.png)

##### 1.7.1 CachingExcutorè£…é¥°å™¨æ¨¡å¼å®ç°äºŒçº§ç¼“å­˜

![image-20221211163258104](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211163302284-475666793.png)

![image-20221211163342469](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211163345225-607037533.png)

å…¶è£…é¥°çš„ä½œç”¨å°±æ˜¯è®©è¢«è£…é¥°çš„Executorå…·å¤‡äºŒçº§ç¼“å­˜çš„èƒ½åŠ›ï¼Œåœ¨æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ›´æ”¹ç­‰æ“ä½œçš„æ—¶å€™ä¼šç»´æŠ¤äºŒçº§ç¼“å­˜ï¼Œç”±äºäºŒçº§ç¼“å­˜å¹¶ä¸å¸¸ç”¨ï¼ˆå› ä¸ºæˆ‘ä»¬åŸºæœ¬ä¸Šéƒ½æ˜¯å¾®æœåŠ¡å¤šå®ä¾‹ï¼Œä¸€ä¸ªå®ä¾‹æ›´æ–°äº†äºŒçº§ç¼“å­˜ï¼Œå¦‚ä½•åŒæ­¥åˆ°å…¶ä»–å®ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå·±å®ç°cacheï¼Œè¿™æœ‰å¸¦æ¥ä¸€è‡´æ€§ç­‰é—®é¢˜ï¼Œä¸€èˆ¬æ˜¯ä¸å¼€å¯äºŒçº§ç¼“å­˜çš„ï¼‰æˆ‘ä»¬ä¸ç»§ç»­æ·±ç©¶äºŒçº§ç¼“å­˜çš„åŸç†

##### 1.7.2 BaseExcutoræ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼

BaseExcutorå®šä¹‰äº†åŸºæœ¬çš„æµç¨‹ï¼Œå¯¹äºå­ç±»å…·å¤‡å·®å¼‚çš„åœ°æ–¹ï¼Œç•™ç»™å­ç±»è‡ªå·±å»å®ç°ï¼Œä»è€Œè¾¾åˆ°é«˜å†…èšçš„ç›®çš„ã€‚ä»¥æŸ¥è¯¢ä¸ºä¾‹ï¼Œä¸€çº§ç¼“å­˜çš„åˆ·æ–°ç”±BaseExecutoråœ¨åˆé€‚çš„æ—¶æœºè°ƒç”¨ï¼Œé¦–å…ˆä»ä¸€çº§ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœç¼“å­˜ä¸­å­˜åœ¨ï¼Œé‚£ä¹ˆä¸ä¼šè¿›è¡Œæ•°æ®åº“æŸ¥è¯¢æ“ä½œï¼Œåä¹‹è°ƒç”¨`queryFromDatabase`æŸ¥è¯¢æ•°æ®åº“ï¼Œ`queryFromDatabase`ä¼šè°ƒç”¨åˆ°`doQuery`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”±å­ç±»è‡ªå·±å®ç°

![image-20221211164845234](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211164849959-1754906038.png)

è‡³æ­¤æˆ‘ä»¬å¯ä»¥è§£ç­”ä¸‹ **ä¸€ä¸¶ä»ä¸€ä¸ªé—®é¢˜å¼€å§‹â€”â€”è¯»å·²æäº¤æƒ…å†µä¸‹mybatisä¸€çº§ç¼“å­˜é€ æˆçš„é—®é¢˜**ï¼Œå‡ºç°çš„åŸå› ä¾¿æ˜¯ä¸€çº§ç¼“å­˜ç¼“å­˜äº†ä¸Šä¸€æ¬¡çš„æŸ¥è¯¢ç»“æœï¼Œç”±äºæˆ‘ä»¬æ‰§è¡Œçš„æ˜¯åŒä¸€ä¸ªæŸ¥è¯¢ï¼ŒmapperStatementï¼ˆmapperæ–¹æ³•å…¨é™å®šï¼‰ä¸€è‡´ï¼Œå…¥å‚ä¹Ÿæ ·ä¸€è‡´ï¼Œä¹Ÿæ²¡æœ‰å†…å­˜åˆ†é¡µçš„å†…å®¹ï¼Œå‚æ•°æ˜ å°„ç­‰å†…å®¹ä¹Ÿä¸€è‡´ï¼Œä¾¿ä¼šå‘½ä¸­ç¼“å­˜ï¼Œæ‰€ä»¥è¯»å·²æäº¤çš„éš”ç¦»çº§åˆ«ï¼Œè¢«mybatis ç ´å

ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¸åŠ äº‹åŠ¡ç›´æ¥ï¼Œä¾¿ä¸ä¼šå¦‚æ­¤ï¼Œå› ä¸ºä¸åŠ äº‹åŠ¡ç›´æ¥ï¼Œæ¯ä¸€æ¬¡æŸ¥è¯¢æ“ä½œéƒ½æ˜¯newå‡ºçš„sqlsessionï¼Œéƒ½ä¼šè°ƒç”¨åˆ°ä¸åŒçš„Executorï¼Œä¸€çº§ç¼“å­˜æ˜¯å’ŒEexcutorä¸­çš„ä¸€ä¸ªå±æ€§ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªmapï¼‰è¿™æ ·ä¸€çº§ç¼“å­˜ä¾¿æ˜¯ä¸åŒçš„å¯¹è±¡ï¼Œä¾¿ä¸ä¼šå‘½ä¸­ç¼“å­˜ã€‚

##### 1.7.3 SimpleExecutor å¦‚ä½•æŸ¥è¯¢æ•°æ®åº“

    è¿™é‡Œæˆ‘ä»¬æ²¡æœ‰ç ”ç©¶ReuseExecutorå¦‚ä½•å¤ç”¨ï¼Œå…¶å®ä½¿ç”¨mapï¼ˆkeyæ˜¯æ‰§è¡ŒæŸ¥è¯¢çš„sqlï¼Œvalueæ˜¯statementï¼‰è¾¾åˆ°å¤ç”¨çš„ç›®çš„
    ä¹Ÿæ²¡æœ‰ç ”ç©¶BatchExecutorï¼Œæœ¬è´¨æ˜¯æ‰§è¡Œæ›´æ”¹æ“ä½œçš„æ—¶å€™è°ƒç”¨çš„æ˜¯statement#addBatchï¼Œæ‰¹é‡æ‰§è¡Œsqlè¯­å¥ï¼Œ
    äºŒè€…ä½¿ç”¨çš„éƒ½å¾ˆå°‘ï¼Œå°†ä¸åšè¿‡å¤šèµ˜è¿°äº†
    

![image-20221211165947489](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211165953329-418596078.png)

å¯ä»¥çœ‹åˆ°SimpleExcutoræ‰§è¡ŒæŸ¥è¯¢å§”æ‰˜ç»™äº†StatementHandlerï¼Œå®ƒä¼šç”¨StatmentHandleråˆ›å»ºstatementï¼Œç„¶åæ‰§è¡ŒæŸ¥è¯¢

æˆ‘ä»¬æ€»ç»“ä¸‹è‡³æ­¤çš„æ‰§è¡Œæµç¨‹ï¼Œå¦‚ä¸‹å›¾

![Mybatisæ‰§è¡Œè¿‡ç¨‹](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211170730579-1266266637.jpg)

æ¥ä¸‹æ¥æˆ‘ä»¬æ¢ç©¶ä¸‹StatmentHandleræ˜¯å¦‚ä½•è¿›è¡Œå‚æ•°æ˜ å°„ï¼Œä½¿ç”¨Statmentæ‰§è¡Œæ•°æ®æ“ä½œï¼Œå¹¶å¤„ç†è¿”å›ç»“æœé›†çš„

### 2.StatmentHandleræ“ä½œæ•°æ®åº“

![image-20220315191852140](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120039292-684797592.png)

#### 2.1.StatemenHanlderæ¥å£

å®šä¹‰äº†StatementHandlerçš„åŸºæœ¬åŠŸèƒ½

*   å‡†å¤‡è¯­å¥ å­ç±»å¯ä»¥å®ç°è¿”å›ä¸åŒçš„Statementå­ç±»
*   å‚æ•°æ˜ å°„
*   æ›´æ–°æ“ä½œ
*   æŸ¥è¯¢æ“ä½œ

#### 2.2BaseStatementHandler

æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œæå–å…¬å…±çš„æ“ä½œåˆ°çˆ¶ç±»ï¼Œå­ç±»å…·å¤‡å·®å¼‚çš„åœ°æ–¹ä½¿ç”¨æŠ½è±¡æ–¹æ³•ï¼Œäº¤ç”±å­ç±»å®ç°

#### 2.2RoutingStatementHandler

ä¸»è¦æ˜¯é€‚é…å¤šä¸ªStatmentHandlerçš„å®ç°ï¼Œæœ‰ç‚¹è£…é¥°å™¨é€‚é…å™¨çš„æ„æ€

![image-20220315202641508](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211210043126-1873247268.png)

åç»­å…·ä½“æ–¹æ³•çš„å®ç°éƒ½æ˜¯è°ƒç”¨delegateå¯¹åº”çš„æ–¹æ³•ï¼Œç›¸å½“äºRoutingStatementHandler åªæ˜¯åšäº†ä¸€ä¸ªæ ¹æ®MappedStatementä¸­çš„StatementTypeé…ç½®åˆ›å»ºä¸åŒçš„StatmentHandler

#### 2.3PrepareStatementHandler

é¢„å¤„ç†Statementçš„handlerï¼Œå¤„ç†å¸¦å‚æ•°å…è®¸çš„SQLï¼Œ å¯¹åº”JDBCçš„PreparedStatementï¼ˆé¢„ç¼–è¯‘å¤„ç†ï¼‰

#### 2.4 SimpleStatementHandler

æœ€ç®€å•çš„StatementHandlerï¼Œå¤„ç†ä¸å¸¦å‚æ•°è¿è¡Œçš„SQLï¼Œå¯¹åº”JDBCçš„Statement

#### 2.5 CallableStatementHandler

å­˜å‚¨è¿‡ç¨‹çš„Statementçš„handlerï¼Œå¤„ç†å­˜å‚¨è¿‡ç¨‹SQLï¼Œå¯¹åº”JDBCçš„CallableStatementï¼ˆå­˜å‚¨è¿‡ç¨‹å¤„ç†ï¼‰

ä¸‹å›¾æ˜¯mybatisåˆ›å»ºä¸€ä¸ªstatementHandlerï¼Œé»˜è®¤æ˜¯RoutingStatementHandlerï¼Œæ­£åœ¨æ“ä½œæ•°æ®åº“çš„ä¸€èˆ¬æ˜¯PrepareStatmentHandlerï¼Œå¹¶ä¸”mybatisæ’ä»¶ä¼šå‘æŒ¥ä½œç”¨

![image-20220315205525024](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120052623-1005441296.png)

#### 2.6 PrepareStatementHandler å¦‚ä½•åˆ›å»ºä¸€ä¸ªStatementï¼Œå¹¶è®¾ç½®å‚æ•°ï¼Œæ‰§è¡ŒæŸ¥è¯¢çš„

##### 2.6.1 prepare

![image-20221211211616126](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211211628948-958768475.png)

æœ€ç»ˆåˆå§‹åŒ–ä¸€ä¸ªstatementæ˜¯ç”±å­ç±»PrepareStatementHandlerè°ƒç”¨`connection.prepareStatement`å®ç°

##### 2.6.2 å‚æ•°æ˜ å°„

![image-20221211212010457](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211212013217-1115029711.png)

å¯ä»¥çœ‹åˆ°å‚æ•°æ˜ å°„çš„å·¥ä½œï¼Œäº¤ç»™äº†`ParameterHandler`ï¼ˆå”¯ä¸€çš„å®ç°ç±»æ˜¯`DefaultParameterHandler`ï¼‰å…·ä½“è®¾ç½®å‚æ•°çš„æµç¨‹å¦‚ä¸‹

    //è®¾ç½®å‚æ•°
    @Override
    public void setParameters(PreparedStatement ps) throws SQLException {
        ErrorContext.instance().activity("setting parameters").object(mappedStatement.getParameterMap().getId());
        //1.è·å–sqlè¯­å¥çš„å‚æ•°ï¼ŒParameterMappingé‡Œé¢åŒ…å«å‚æ•°çš„åç§°ç±»å‹ç­‰è¯¦ç»†ä¿¡æ¯ï¼Œè¿˜åŒ…æ‹¬ç±»å‹å¤„ç†å™¨
        List<ParameterMapping> parameterMappings = boundSql.getParameterMappings();
        if (parameterMappings != null) {
            //2.éå†ä¾æ¬¡å¤„ç†
            for (int i = 0; i < parameterMappings.size(); i++) {
                ParameterMapping parameterMapping = parameterMappings.get(i);
                //3.OUTç±»å‹å‚æ•°ä¸å¤„ç†
                if (parameterMapping.getMode() != ParameterMode.OUT) {
                    Object value;
                    //4.è·å–å‚æ•°åç§°
                    String propertyName = parameterMapping.getProperty();
                    //5.å¦‚æœpropertyNameæ˜¯åŠ¨æ€å‚æ•°ï¼Œå°±ä¼šä»åŠ¨æ€å‚æ•°ä¸­å–å€¼ã€‚(å½“ä½¿ç”¨<foreach>çš„æ—¶å€™ï¼ŒMyBatisä¼šè‡ªåŠ¨ç”Ÿæˆé¢å¤–çš„åŠ¨æ€å‚æ•°)
                    if (boundSql.hasAdditionalParameter(propertyName)) { // issue #448 ask first for additional params
                        value = boundSql.getAdditionalParameter(propertyName);
                    } else if (parameterObject == null) {
                        //6.å¦‚æœå‚æ•°æ˜¯nullï¼Œä¸ç®¡å±æ€§åæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¼šè¿”å›nullã€‚
                        value = null;
                    } else if (typeHandlerRegistry.hasTypeHandler(parameterObject.getClass())) {
                        //7.åˆ¤æ–­ç±»å‹å¤„ç†å™¨æ˜¯å¦æœ‰å‚æ•°ç±»å‹,å¦‚æœå‚æ•°æ˜¯ä¸€ä¸ªç®€å•ç±»å‹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæ³¨å†Œäº†typeHandlerçš„å¯¹è±¡ç±»å‹ï¼Œå°±ä¼šç›´æ¥ä½¿ç”¨è¯¥å‚æ•°ä½œä¸ºè¿”å›å€¼ï¼Œå’Œå±æ€§åæ— å…³ã€‚
                        value = parameterObject;
                    } else {
                        //8.è¿™ç§æƒ…å†µä¸‹æ˜¯å¤æ‚å¯¹è±¡æˆ–è€…Mapç±»å‹ï¼Œé€šè¿‡åå°„æ–¹ä¾¿çš„å–å€¼ã€‚é€šè¿‡MetaObjectæ“ä½œ
                        MetaObject metaObject = configuration.newMetaObject(parameterObject);
                        value = metaObject.getValue(propertyName);
                    }
                    TypeHandler typeHandler = parameterMapping.getTypeHandler();
                    //9.è·å–å¯¹åº”çš„æ•°æ®åº“ç±»å‹
                    JdbcType jdbcType = parameterMapping.getJdbcType();
                    //ç©ºç±»å‹
                    if (value == null && jdbcType == null) {
                        jdbcType = configuration.getJdbcTypeForNull();
                    }
                    //10.å¯¹PreparedStatementçš„å ä½ç¬¦è®¾ç½®å€¼(ç±»å‹å¤„ç†å™¨å¯ä»¥ç»™PreparedStatementè®¾å€¼)
                    try {
                        typeHandler.setParameter(ps, i + 1, value, jdbcType);
                    } catch (TypeException e) {
                        throw new TypeException("Could not set parameters for mapping: " + parameterMapping + ". Cause: " + e, e);
                    } catch (SQLException e) {
                        throw new TypeException("Could not set parameters for mapping: " + parameterMapping + ". Cause: " + e, e);
                    }
                }
            }
        }
    }
    

å¯ä»¥çœ‹åˆ°æœ€ç»ˆä½¿ç”¨TypeHandlerè®¾ç½®å‚æ•°ï¼Œä¼šè°ƒç”¨åˆ°`prepareStatement#setxxx`æ–¹æ³•è®¾ç½®å‚æ•°

##### 2.6.3 æŸ¥è¯¢æ•°æ®åº“ï¼Œå¹¶è½¬æ¢ç»“æœé›†

![image-20221211213542314](https://img2023.cnblogs.com/blog/2605549/202212/2605549-20221211213546912-1406400548.png)

æŸ¥è¯¢æ•°æ®åº“çš„æ“ä½œå§”æ‰˜ç»™äº†`ResultSetHandler`çš„å®ç°ç±»`DefaultResultSetHandler`

*   å¤„ç†å¤šç»“æœé›†

å­˜å‚¨è¿‡ç¨‹å­˜åœ¨å¤šç»“æœé›†çš„æƒ…å†µï¼Œ

![image-20220501121329328](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120234944-1117885921.png)

*   å¤„ç†ä¸€è¡Œç»“æœé›†

![image-20220501121738175](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120237080-729500302.png)

![image-20220501121927782](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120239785-244686834.png)

ä¸å­˜åœ¨åµŒå¥—å­æŸ¥è¯¢çš„æ—¶å€™ï¼Œä½¿ç”¨handleRowValuesForSimpleResultMap

![image-20220501122810392](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120243025-878634092.png)

è¿™é‡Œå‡ºç°ä¸€ä¸ªç±»DefaultResultContextï¼Œå®ç°äº†ResultContextï¼Œè¿™æ˜¯ç»“æœä¸Šä¸‹æ–‡ï¼Œä¸»è¦çš„èŒè´£æ˜¯æ§åˆ¶å¤„ç†ç»“æœè¡Œçš„åœæ­¢ï¼Œé…åˆrowBoundså®ç°å†…å­˜åˆ†é¡µï¼Œåé¢çš„storeObjectå°±æ˜¯å°†ä¸€è¡Œå¯¹åº”çš„å¯¹è±¡å­˜åœ¨listï¼ˆä¼¼ä¹å¯¹mapè¿™ç§å‡ºæƒ¨æœ‰ç‰¹æ®Šå¤„ç†ï¼Œå¯¹äºåµŒå¥—å­æŸ¥è¯¢ä¹Ÿæœ‰ç‰¹æ®Šå¤„ç†ï¼‰

![image-20220501123831384](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120246361-743557175.png)

è¿™é‡Œçš„è‡ªåŠ¨æ˜ å°„åº”è¯¥æ˜¯å¤„ç†ï¼Œæ²¡æœ‰æŒ‡å®šresultMap å‡­å€Ÿå¯¹è±¡å±æ€§å’Œæ•°æ®åº“åˆ—åè¿›è¡Œæ˜ å°„çš„æƒ…å†µ ï¼Œåé¢applyPropertyMappings å¤„ç†æŒ‡å®šresultMap ä¸­columnå’Œ propertyçš„æƒ…å†µï¼Œå¯¹äºæŒ‡å®šäº†TypeHandlerçš„åˆ—ï¼Œä¼šä½¿ç”¨TypeHandlerè¿›è¡Œè®¾ç½®ï¼ˆè°ƒç”¨`TypeHandler#getResult`ï¼‰,è‡ªåŠ¨æ˜ å°„çš„ç±»ä½¿ç”¨MetaObject#setValueå¤„ç†ï¼ˆåå°„è®¾ç½®å±æ€§ï¼‰

ä¸ƒä¸¶mybatisæ’ä»¶å®ç°åŸç†
---------------

### 1.æ‹¦æˆªå™¨æ¥å£

    public interface Interceptor {
    
        //æ‹¦æˆª        Invocation ï¼šå½“å‰è¢«æ‹¦æˆªå¯¹è±¡ å‚æ•° å’Œè¢«æ‹¦æˆªæ–¹æ³•
      Object intercept(Invocation invocation) throws Throwable;
    
      //åŠ¨æ€ä»£ç† 
      default Object plugin(Object target) {
        return Plugin.wrap(target, this);
      }
    
      default void setProperties(Properties properties) {
        // NOP  å¯ä»¥åœ¨è¿™é‡Œç»™æ‹¦æˆªå™¨èµ‹å€¼ä¸€äº›å±æ€§ 
      }
    
    }
    

### 2.Plugin.wrap(target, this)æ–¹æ³•å¦‚ä½•å®ç°æ‹¦æˆª

*   Plugin å®ç°äº†InvocationHandlerâ€”â€”åŸºäºJDKåŠ¨æ€ä»£ç†

![image-20220501125328505](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120257862-250475420.png)

![image-20220501125402309](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120300371-1809940545.png)

*   è¯»å–æ³¨è§£ä¿¡æ¯ï¼Œè·å–å½“å‰æ‹¦æˆªå™¨è¦æ‹¦æˆªä»€ä¹ˆç±»çš„ä»€ä¹ˆæ–¹æ³•

![image-20220501125734412](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120303567-488054249.png)

æ³¨æ„è·å–æ–¹æ³•çš„æ–¹å¼

    Method method = sig.type().getMethod(sig.method(), sig.args());
    

getMethodæ–¹æ³•æ˜¯æ²¡æœ‰åŠæ³•è·å–åˆ°ç§æœ‰æ–¹æ³•çš„ï¼Œæ‰€æœ‰æ— æ³•æ‹¦æˆªä¸€ä¸ªç§æœ‰æ–¹æ³•

*   è·å–è¢«ä»£ç†ç±»çš„æ¥å£

![image-20220501133755874](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120306977-576580126.png)

*   åŠ¨æ€ä»£ç†å¯¹è±¡ç”Ÿæˆ

![image-20220501133853692](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120308471-814064686.png)

![image-20220501133944011](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120310160-479092840.png)

### 3.åŠ¨æ€ä»£ç†ç”Ÿæˆçš„å¯¹è±¡æ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„

å¦‚ä¸Šæˆ‘ä»¬çŸ¥é“äº†mybatis æ˜¯æ€ä¹ˆæ”¯æŒæ’ä»¶çš„ï¼Œæ ¹æ®æ‹¦æˆªå™¨ä¸Šçš„ä¿¡æ¯ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ï¼ŒåŠ¨æ€ä»£ç†å¯¹è±¡åœ¨æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™ä¼šè¿›å…¥æ‹¦æˆªå™¨çš„interceptæ‹¦æˆªæ–¹æ³•ï¼Œé‚£ä¹ˆåŠ¨æ€ä»£ç†çš„ç”Ÿæˆçš„å¯¹è±¡åœ¨å“ªé‡Œè¢«ä½¿ç”¨åˆ°æ˜µ

*   Configuration ç±» ä¹Ÿå°±æ˜¯mybatisçš„å¤§ç®¡å®¶ï¼Œåœ¨newä¸€äº›mybatiså››å¤§å¯¹è±¡çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°æ’ä»¶
    
    ![image-20220501134455505](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120314269-265065120.png)
    
    ![image-20220501134505350](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120316564-102610454.png)
    
    ![image-20220501134505350](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120316564-102610454.png)
    
    ![image-20220501134540586](https://img2022.cnblogs.com/blog/2605549/202208/2605549-20220821120325149-139899626.png)
    
        ä¹Ÿå°±æ˜¯è¯´mybatis åªæ”¯æŒæ‹¦æˆªParmeterHandler,ResultSetHandler,StatementHandler,Excutorè¿™å››ç§å¯¹è±¡
        
    
    åœ¨mybatisæ‰§è¡Œä¸­çš„ä½¿ç”¨çš„å››å¤§å¯¹è±¡å…¶å®æ˜¯è¢«åŠ¨æ€ä»£ç†åçš„å¯¹è±¡ï¼Œä»è€Œè°ƒç”¨åˆ°æ’ä»¶åŠŸèƒ½