---
layout: post
title: "C#è¯­æ³•ç³–ç³»åˆ— â€”â€” ç¬¬äºŒç¯‡ï¼šèŠèŠ refï¼Œin ä¿®é¥°ç¬¦åº•å±‚ç©æ³•"
date: "2022-04-25T03:13:29.884Z"
---
C#è¯­æ³•ç³–ç³»åˆ— â€”â€” ç¬¬äºŒç¯‡ï¼šèŠèŠ refï¼Œin ä¿®é¥°ç¬¦åº•å±‚ç©æ³•
================================

è‡ªä» C# 7.3 æ”¾å¼€ ref ä¹‹åï¼Œè¿™ç©æ³•å°±å¤ªèŠ±å“¨äº†ï¼Œä¹Ÿè®© C# è¿™é—¨è¯­è¨€å˜å¾—è¶Šæ¥è¶Šå¤šèŒƒå¼ï¼Œè¶Šæ¥è¶Šé‡ï¼Œè¿™ç¯‡æˆ‘ä»¬å°±æ¥èŠèŠ refï¼Œæœ¬è´¨ä¸Šæ¥è¯´ ref çš„æ”¾å¼€å°±æ˜¯æŠŠ C/C++ æŒ‡é’ˆçš„é‚£ä¸€å¥—åˆæ‹¿å›æ¥äº†ï¼Œè€Œä¸”è¿˜å°è£…æˆä¸€å¥—è‡ªå·±çš„ç©æ³•ï¼Œä¸‹é¢ä¸€ä¸€è§£è¯»ä¸‹ã€‚

ä¸€ï¼šæ–¹æ³•å‚æ•°ä¸Šçš„ ref
------------

æˆ‘æƒ³è®¾è®¡è€…çš„åˆå¿ƒæŠŠ ref çš„åŠŸèƒ½é™åˆ¶çš„æ­»æ­»çš„ï¼Œå¯èƒ½ä¹Ÿè€ƒè™‘åˆ° C# æ˜¯ä¸€é—¨é¢å‘ä¸šåŠ¡å¼€å‘çš„è¯­è¨€ï¼Œè®²ç©¶çš„æ˜¯åšé¡¹ç›®å¿«ç‹ å‡†ï¼Œæ€§èƒ½åè€Œä¸æ˜¯ç¬¬ä¸€è¦ç´ ï¼Œè¿™ä¸ªæ—¶å€™çš„ ref å¾ˆç®€å•ï¼Œçœ‹ä¸€ä¸‹ä»£ç ï¼š

    
        class Program
        {
            static void Main(string[] args)
            {
                long price = 0;
    
                GetPrice(ref price);
    
                Console.WriteLine($"output: price={price}");
            }
    
            public static void GetPrice(ref long price)
            {
                price = 10;
            }
        }
    
    output: price=10
    
    

æˆ‘ç›¸ä¿¡å¾ˆæœ‰æœ‹å‹éƒ½çŸ¥é“ï¼Œæ–¹æ³•å‚æ•°ä¸­çš„ `ref long price` æ‹¿çš„æ˜¯æ ˆåœ°å€ï¼Œå¯¹æ ˆåœ°å€ä¸Šçš„å€¼è¿›è¡Œä¿®æ”¹ï¼Œè‡ªç„¶å°±ä¿®æ”¹äº†æŒ‡å‘è¿™äº›åœ°å€ä¸Šçš„å˜é‡ï¼Œå’Œå¼•ç”¨ç±»å‹åŸç†ä¸€è‡´ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä»æ±‡ç¼–è§’åº¦å»éªŒè¯ï¼Œåœ¨ Price æ–¹æ³•ä¸Šä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚

    
    D:\net5\ConsoleApp4\ConsoleApp3\Program.cs @ 16:
    026b048e 8d4dec          lea     ecx,[ebp-14h]
    026b0491 ff15a0ebc800    call    dword ptr ds:[0C8EBA0h] (ConsoleApp3.Program.GetPrice(Int64 ByRef), mdToken: 06000002)
    026b0497 90              nop
    0:000> bp 026b0491
    0:000> g
    Breakpoint 1 hit
    ChangeEngineState
    eax=00000000 ebx=0057f354 ecx=0057f2d4 edx=783aaa50 esi=02979e7c edi=0057f2dc
    eip=026b0491 esp=0057f2c4 ebp=0057f2e8 iopl=0         nv up ei pl zr na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246
    026b0491 ff15a0ebc800    call    dword ptr ds:[0C8EBA0h] ds:002b:00c8eba0=00c2be10
    
    

ä»æ±‡ç¼–çš„ `lea ecx,[ebp-14h]` å°±èƒ½çœ‹åˆ°ï¼Œå°† `ebp-14` è¿™ä¸ªå•å…ƒçš„å†…å­˜åœ°å€ç»™äº† ecxï¼Œè¿™ä¸ª ecx ä¹Ÿå°±æ˜¯ä½œä¸ºå‚æ•°ä¼ é€’ç»™äº† `Price` æ–¹æ³•ï¼Œåç»­çš„èµ‹å€¼å°†ä¼šå½±å“è¿™ä¸ª`æ ˆä½ç½®` ä¸Šçš„å†…å®¹ã€‚

2\. æ–¹æ³•è¿”å›å€¼ä¸Šçš„ ref
---------------

è¿™å°±æœ‰æ„æ€äº†ï¼Œè¿›å…¥çš„æ—¶å€™ä¼ åœ°å€ï¼Œå›æ¥çš„æ—¶å€™ä¹Ÿæƒ³ä¼ åœ°å€ï¼Œå¾ˆæ˜¾ç„¶`æ–¹æ³•çº¿ç¨‹æ ˆ`ä¸Šçš„ `å€¼ç±»å‹` æ˜¯ä¼ ä¸å‡ºå»çš„ï¼Œæ¯•ç«Ÿæ–¹æ³•è¿”å›åï¼Œesp,ebp æ‰€æ§åˆ¶çš„æ–¹æ³•æ ˆå¸§ç©ºé—´æ˜¯è¦é”€æ¯çš„ï¼Œæ‰€ä»¥åªèƒ½æ˜¯å †ä¸Šå¯¹è±¡æ‰èƒ½å®ç°ã€‚

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œçœ‹å¦‚ä¸‹ä»£ç ï¼š

    
        class Program
        {
            static void Main(string[] args)
            {
                ref long price = ref GetCurrentPrice();
    
                price = 12;
    
                Console.WriteLine($"output: price={price}");
            }
    
            public static ref long GetCurrentPrice()
            {
                long[] nums = { 10, 20, 30 };
    
                return ref nums[1];
            }
        }
    
    output: price=12
    
    

å¯ä»¥çœ‹åˆ°å½“å‰çš„ `price=12`,åŒæ—¶ `nums` è¿™ä¸ªæ•°ç»„ä¹Ÿè¢«ä¿®æ”¹äº†ï¼Œå¯ä»¥ç”¨ windbg éªŒè¯ä¸€ä¸‹ã€‚

    
    0:000> !dumpheap  -type System.Int64[] 
     Address       MT     Size
    027ca7b0 04c39d00       36     
    
    Statistics:
          MT    Count    TotalSize Class Name
    04c39d00        1           36 System.Int64[]
    Total 1 objects
    0:000> dq 027ca7b0 L4
    027ca7b0  00000003`04c39d00 00000000`0000000a
    027ca7c0  00000000`0000000c 00000000`0000001e
    
    

å¯ä»¥çœ‹åˆ°ä¸Šé¢çš„ `000000000000000c` è¢«ä¿®æ”¹æˆ `price=12` ï¼Œè¿™æ—¶å€™æœ‰äººå°±ä¸çˆ½äº†ï¼Œæˆ‘ä¸å¸Œæœ›å¤–é¢çš„ä»£ç èƒ½ä¿®æ”¹ price å†…å®¹ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ è¿˜å¾—åœ¨ `ref` åé¢åŠ ä¸Š `readonly` ï¼Œæ”¹é€ åå¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f0a42ff523714ad5bca176e83f70a898~tplv-k3u1fbpfcp-zoom-1.image)

åˆ°æ­¤æ—¶å†™æ³•å°±æœ‰ç‚¹ç–¯ç‹‚äº†ï¼Œå¯¹ C# å¼€å‘è€…æ¥è¯´å¾ˆéš¾ç†è§£ï¼Œå¯¹ç†Ÿæ‚‰ C/C++ æŒ‡é’ˆçš„æœ‹å‹æ¥è¯´åˆå¾ˆä¸ä¹ æƒ¯ï¼Œå¤ªçº ç»“äº†ï¼Œä¸‹é¢æ˜¯ä¸€æ®µç¿»è¯‘è¿‡æ¥çš„ `C/C++æŒ‡é’ˆä»£ç ` ã€‚

    
    const long long* getcurrentprice();
    
    int main()
    {
    	int i = 0;
    
    	const long long* price = getcurrentprice();
    
    	price = 12;
    
    	printf("num=%d, price=%d \n", i, *price);
    
    }
    
    const long long* getcurrentprice() {
    
    	long long* num = new long long[3]{ 10,20,30 };
    	return num + 1;
    }
    
    

è¯´å®è¯ï¼Œè¿™ä»£ç çœ‹èµ·æ¥å°±æ¸…çˆ½å¤šäº†ã€‚

2\. å¯¹ ref å˜é‡çš„ in æ“ä½œ
-------------------

è¿™åˆæ˜¯ä¸€å¥— C/C++ çš„ç©æ³•ï¼Œæœ‰æ—¶å€™ä¸å¸Œæœ›æŸä¸€ä¸ªæ–¹æ³•å¯¹ ref å˜é‡è¿›è¡Œä¿®æ”¹ï¼Œæ³¨æ„ï¼šæ˜¯ä¸å¸Œæœ›æŸä¸€ä¸ªæ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼Œå…¶ä»–æ–¹æ³•æ˜¯å¯ä»¥çš„ï¼Œé‚£è¿™ä¸ªæ€ä¹ˆå®ç°å‘¢ï¼Ÿè¿™å°±éœ€è¦åœ¨å…¥å‚ä¸ŠåŠ  `in` å‰ç¼€ï¼ŒæŠŠä»£ç ä¿®æ”¹ä¸€ä¸‹ã€‚

    
        class Program
        {
            static void Main(string[] args)
            {
                ref long price = ref GetCurrentPrice();
    
                ModifyPrice(in price);
    
                Console.WriteLine($"output: price={price}");
            }
    
            public static ref long GetCurrentPrice()
            {
                long[] nums = { 10, 20, 30 };
    
                return ref nums[1];
            }
    
            public static void ModifyPrice(in long price)
            {
                price = 12;
                Console.WriteLine(price);
            }
        }
    
    

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/20f0c5fc314f4c8c80f5c972ebb922ba~tplv-k3u1fbpfcp-zoom-1.image)

å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ—¶å€™æŠ¥é”™äº†ï¼Œå¦‚æœæ¢æˆ C++ å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦åœ¨å‚æ•°ä¸ŠæŠŠ in æ”¹æˆ const å³å¯ã€‚

    
    void modifyprice(const long long* price) {
    	*price = 12;
    	printf("%d", *price);
    }
    
    

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3fc1df2395d7489ababdbe39afe2dbf2~tplv-k3u1fbpfcp-zoom-1.image)

æ€»çš„æ¥è¯´ï¼Œref è¿™ä¸€å¥—ç©æ³•å¤ªå¦ç±»äº† ğŸ¤£ğŸ¤£ğŸ¤£

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)