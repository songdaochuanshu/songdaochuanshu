---
layout: post
title: "PowerUsageSummary.javaæºç åˆ†æ"
date: "2023-01-11T15:30:47.297Z"
---
PowerUsageSummary.javaæºç åˆ†æ
==========================

åœ¨åœ¨çº¿ç½‘ç«™http://androidxref.com/ä¸Šå¯¹Androidç‰ˆæœ¬6.0.1\_r10æºç è¿›è¡Œåˆ†æ

å®˜æ–¹æ‰‹æœºçš„åº”ç”¨è€—ç”µæ’è¡Œå…·ä½“å®ç°ä½ç½®åœ¨ï¼š/[packages](http://androidxref.com/6.0.1_r10/xref/packages/)/[apps](http://androidxref.com/6.0.1_r10/xref/packages/apps/)/[Settings](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/)/[src](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/)/[com](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/com/)/[android](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/com/android/)/[settings](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/com/android/settings/)/[fuelgauge](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/com/android/settings/fuelgauge/)/[PowerUsageSummary.java](http://androidxref.com/6.0.1_r10/xref/packages/apps/Settings/src/com/android/settings/fuelgauge/PowerUsageSummary.java)

`PowerUsageSummary`ç±»çš„ä½œç”¨æ˜¯ç­›é€‰è€—ç”µé‡æœ€å¤šçš„å‰åä¸ªåº”ç”¨å¹¶ä¸”å±•ç¤º

    PowerUsageSummary`ç±»ç»§æ‰¿è‡ª `PowerUsageBase
    

å¼€å§‹çš„ä¸€éƒ¨åˆ†çš„UIç•Œé¢çš„åˆ›å»ºå’Œä¸€äº›å¸¸é‡çš„å®šä¹‰ï¼Œæ¯”å¦‚ï¼š

*   `USE_FAKE_DATA`ï¼Œå®šä¹‰æ˜¯å¦è¦ä½¿ç”¨å‡æ•°æ®ï¼›
*   `private BatteryHistoryPreference mHistPref;`BatteryHistoryPreferenceç±»è·å–è€—ç”µé‡å†å²æ•°æ®ï¼ˆè¯»å–spæ–‡ä»¶ï¼‰

spæ–‡ä»¶æ•°æ®æ¥è‡ª`power_usage_summary.xml`æ–‡ä»¶

*   `PreferenceGroup`ç±»ï¼šç»Ÿè®¡æ‰€æœ‰APPè€—ç”µé‡

ä¸»è¦ç›®å…‰æ”¾åœ¨`refreshStats`æ–¹æ³•é‡Œ

    super.refreshStats();
    

è·Ÿè¿›çˆ¶ç±»æ–¹æ³•

    protected void refreshStats() {
        mStatsHelper.refreshStats(BatteryStats.STATS_SINCE_CHARGED, mUm.getUserProfiles());
    }
    

`BatteryStats.STATS_SINCE_CHARGED`ä¼ å…¥çš„æ˜¯æˆ‘ä»¬çš„è®¡ç®—è§„åˆ™

*   STATS\_SINCE\_CHARGED ä¸Šæ¬¡å……æ»¡ç”µåæ•°æ®
*   STATS\_SINCE\_UNPLUGGED æ‹”æ‰USBçº¿åçš„æ•°æ®

`mUm.getUserProfiles()` æ˜¯ä¼ å…¥çš„å¤šç”¨æˆ·

    mUm = (UserManager) activity.getSystemService(Context.USER_SERVICE);
    

è¿™ä¹Ÿæ˜¯ç”±Androidçš„å®‰å…¨æœºåˆ¶å¯¼è‡´çš„ï¼Œå³å¤šç”¨æˆ·ä¸‹çš„å¤šåº”ç”¨

`mStatsHelper.refreshStats`æ–¹æ³•ç°åœ¨æˆ‘ä»¬åªè¦çŸ¥é“æ˜¯åˆ·æ–°å½“å‰çš„ç”µé‡ç»Ÿè®¡çš„å°±è¡Œ

ç„¶åæ˜¯ä¸€äº›UIçš„åˆ·æ–°ï¼Œè¯¥éƒ¨åˆ†ç•¥è¿‡

    final PowerProfile powerProfile = mStatsHelper.getPowerProfile();
    final BatteryStats stats = mStatsHelper.getStats();
    final double averagePower = powerProfile.getAveragePower(PowerProfile.POWER_SCREEN_FULL);
    

å¯ä»¥çœ‹åˆ°`mStatsHelper`æ— å¤„ä¸åœ¨ï¼Œå®é™…ä¸Šç”µé‡ç»Ÿè®¡çš„æ ¸å¿ƒå®ç°å°±æ˜¯è¯¥éƒ¨åˆ†å®ç°çš„

`mStatsHelper.getPowerProfile()`è·å–ç”µæºçš„é…ç½®ä¿¡æ¯ï¼Œæµ…è·Ÿè¿›ä¸€ä¸‹

    public PowerProfile getPowerProfile() {
        return mPowerProfile;
    }
    

åˆå§‹åŒ–æ˜¯åœ¨è¿™é‡Œ

    public void create(BatteryStats stats) {
        mPowerProfile = new PowerProfile(mContext);
        mStats = stats;
    }
    

æŒç»­è·Ÿè¿›

    public PowerProfile(Context context) {
        // Read the XML file for the given profile (normally only one per
        // device)
        if (sPowerMap.size() == 0) {
            readPowerValuesFromXml(context);
        }
        initCpuClusters();
    }
    

å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€æ®µæ³¨é‡Šï¼š Read the XML file for the given profile (normally only one perdevice

è·Ÿè¿›`readPowerValuesFromXml`æ–¹æ³•ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥è§£æ`power_profile.xml`æ–‡ä»¶çš„ï¼Œè¯¥æ–‡ä»¶åœ¨æºç ä¸­çš„ä½ç½®ä¸º `/frameworks/base/core/res/res/xml/power_profile.xml`ï¼Œ`power_profile.xml`æ˜¯ä¸€ä¸ªå¯é…ç½®çš„åŠŸè€—æ•°æ®æ–‡ä»¶

    private void readPowerValuesFromXml(Context context) {
        int id = com.android.internal.R.xml.power_profile;
        final Resources resources = context.getResources();
        XmlResourceParser parser = resources.getXml(id);
        boolean parsingArray = false;
        ArrayList<Double> array = new ArrayList<Double>();
        String arrayName = null;
    
        try {
            // ....
    

![](https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20230111211426.png)

åœ¨è¿™é‡Œéœ€è¦æä¸€ä¸‹Androidä¸­å¯¹äºåº”ç”¨å’Œç¡¬ä»¶çš„è€—ç”µé‡è®¡ç®—æ–¹å¼ï¼š

æœ‰ä¸€å¼ â€œä»·æ ¼è¡¨â€ï¼Œè®°å½•æ¯ç§ç¡¬ä»¶1ç§’é’Ÿè€—å¤šå°‘ç”µã€‚æœ‰ä¸€å¼ â€œè´­ç‰©æ¸…å•â€ï¼Œè®°å½•apkä½¿ç”¨äº†å“ªå‡ ç§ç¡¬ä»¶ï¼Œæ¯ç§ç¡¬ä»¶ç”¨äº†å¤šé•¿æ—¶é—´ã€‚å‡è®¾æŸä¸ªåº”ç”¨ç´¯è®¡ä½¿ç”¨äº†60ç§’çš„cpuï¼Œcpu1ç§’é’Ÿè€—1mAhï¼Œé‚£è¿™ä¸ªåº”ç”¨å°±æ¶ˆè€—äº†60mAhçš„ç”µ

è¿™é‡Œçš„ä»·æ ¼è¡¨å°±æ˜¯æˆ‘ä»¬æ‰¾åˆ°çš„`power_profile.xml`æ–‡ä»¶ï¼Œæ‰‹æœºçš„ç¡¬ä»¶æ˜¯å„ä¸ç›¸åŒçš„ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¾æ‰‹æœºéƒ½ä¼šæœ‰ä¸€å¼ è‡ªå·±çš„"ä»·æ ¼è¡¨"ï¼Œè¿™å¼ è¡¨çš„å‡†ç¡®æ€§ç”±æ‰‹æœºå‚å•†è´Ÿè´£ã€‚

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç¢°åˆ°è¯»å–xmlæ–‡ä»¶çš„æ—¶å€™æ³¨é‡Šé‡Œé¢ä¼šæœ‰`normally only one perdevice`

å¦‚æœæˆ‘ä»¬æƒ³è¦çœ‹è‡ªå·±æ‰‹æœºçš„power\_profile.xmlæ–‡ä»¶å’‹åŠï¼Œå®ƒä¼šå­˜å‚¨åœ¨æ‰‹æœºçš„`/system/framework/framework-res.apk`è·¯å¾„ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒpullå‡ºæ¥ï¼Œé€šè¿‡åç¼–è¯‘çš„æ‰‹æ³•è·å¾—`power_profile.xml`æ–‡ä»¶

`mStatsHelper.getStats()`è¿”å›`BatteryStats`å¯¹è±¡ï¼Œè·Ÿè¿›å¯ä»¥å‘ç°å®é™…ä¸Šè¿”å›çš„æ˜¯`BatteryStatsImpl`ï¼Œå®ƒæè¿°äº†æ‰€æœ‰ä¸ç”µé‡æ¶ˆè€—æœ‰å…³çš„ä¿¡æ¯

    final double averagePower = powerProfile.getAveragePower(PowerProfile.POWER_SCREEN_FULL);
    

è§åçŸ¥æ„ï¼Œè·å–è®¾å¤‡çš„å¹³å‡è€—ç”µé‡ï¼Œç”¨äºä¸é˜ˆå€¼è¿›è¡Œå¯¹æ¯”

è¿™éƒ¨åˆ†çœ‹ä¸Šå»æ˜¯ç•Œé¢å’Œä¸»é¢˜çš„æ˜¾ç¤º

    TypedValue value = new TypedValue();
    getContext().getTheme().resolveAttribute(android.R.attr.colorControlNormal, value, true);
    int colorControl = getContext().getColor(value.resourceId);
    

æ£€æŸ¥æ¶ˆè€—çš„ç”µé‡æ˜¯å¦å¤§äºé˜ˆå€¼ï¼Œä»¥åŠæ˜¯å¦ä½¿ç”¨å‡æ•°æ®ï¼Œå¦åˆ™ä¸æ˜¾ç¤ºåº”ç”¨è€—ç”µé‡

    if (averagePower >= MIN_AVERAGE_POWER_THRESHOLD_MILLI_AMP || USE_FAKE_DATA) {
    

æ ¹æ®UIDè¿›è¡Œåˆå¹¶åˆ†ç»„

    final List<BatterySipper> usageList = getCoalescedUsageList(USE_FAKE_DATA ? getFakeStats() : mStatsHelper.getUsageList());
    

å…¶ä¸­`getCoalescedUsageList`æ–¹æ³•å¯¹UIDè¿›è¡Œåˆ†ç»„

`getFakeStats()`æ–¹æ³•è¿”å›ä¸€å †å‡æ•°æ®

    private static List<BatterySipper> getFakeStats() {
        ArrayList<BatterySipper> stats = new ArrayList<>();
        float use = 5;
        for (DrainType type : DrainType.values()) {
            if (type == DrainType.APP) {
                continue;
            }
            stats.add(new BatterySipper(type, null, use));
            use += 5;
        }
        stats.add(new BatterySipper(DrainType.APP,
                                    new FakeUid(Process.FIRST_APPLICATION_UID), use));
        stats.add(new BatterySipper(DrainType.APP,
                                    new FakeUid(0), use));
    
        // Simulate dex2oat process.
        BatterySipper sipper = new BatterySipper(DrainType.APP,
                                                 new FakeUid(UserHandle.getSharedAppGid(Process.FIRST_APPLICATION_UID)), 10.0f);
        sipper.packageWithHighestDrain = "dex2oat";
        stats.add(sipper);
    
        sipper = new BatterySipper(DrainType.APP,
                                   new FakeUid(UserHandle.getSharedAppGid(Process.FIRST_APPLICATION_UID + 1)), 10.0f);
        sipper.packageWithHighestDrain = "dex2oat";
        stats.add(sipper);
    
        sipper = new BatterySipper(DrainType.APP,
                                   new FakeUid(UserHandle.getSharedAppGid(Process.LOG_UID)), 9.0f);
        stats.add(sipper);
    
        return stats;
    }
    

`mStatsHelper.getUsageList()`è¿”å›BatterySipperæ•°ç»„ï¼Œæ¯ä¸ªBatterySipperä»£è¡¨ä¸€ä¸ªåº”ç”¨ï¼ˆuidï¼‰çš„æ¶ˆè€—çš„ç”µé‡ä¿¡æ¯

åœ¨`BatteryStatsHelper.java`ä¸­çš„`refreshStats`æ–¹æ³•ä¸­å¯¹`mUsageList`è¿›è¡Œäº†èµ‹å€¼ï¼Œè¿™éƒ¨åˆ†çš„å…·ä½“æ“ä½œåœ¨åˆ†æ`BatteryStatsHelper.java`çš„æ—¶å€™å†æ

    final int dischargeAmount = USE_FAKE_DATA ? 5000
                        : stats != null ? stats.getDischargeAmount(mStatsType) : 0;
    

è¿™é‡Œçš„`mStatsType`å€¼ä¸º

    private int mStatsType = BatteryStats.STATS_SINCE_CHARGED;
    

è¿™é‡Œæˆ‘ä»¬å‰é¢æè¿‡ï¼Œå«ä¹‰æ˜¯

*   STATS\_SINCE\_CHARGED ä¸Šæ¬¡å……æ»¡ç”µåæ•°æ®
*   STATS\_SINCE\_UNPLUGGED æ‹”æ‰USBçº¿åçš„æ•°æ®

æ‰€ä»¥è¿™æ®µçš„å«ä¹‰æ˜¯è·å–ä¸Šæ¬¡å……æ»¡ç”µä¹‹åçš„ç”µé‡æ¶ˆè€—

    stats.getDischargeAmount(mStatsType)
    

æ¥ä¸‹æ¥éå†BatterySipperï¼Œå¯¹æ¯ä¸€ä¸ªUIDä»£è¡¨çš„APPçš„è€—ç”µé‡è¿›è¡Œè¿‡æ»¤

    final int numSippers = usageList.size();
    for (int i = 0; i < numSippers; i++) {
        final BatterySipper sipper = usageList.get(i);
        if ((sipper.totalPowerMah * SECONDS_IN_HOUR) < MIN_POWER_THRESHOLD_MILLI_AMP) {
            continue;
        }
        double totalPower = USE_FAKE_DATA ? 4000 : mStatsHelper.getTotalPower();
        final double percentOfTotal =
            ((sipper.totalPowerMah / totalPower) * dischargeAmount);
        if (((int) (percentOfTotal + .5)) < 1) {
            continue;
        }
    

å¦‚æœè€—ç”µåŠŸç‡å°äºé˜ˆå€¼åˆ™ä¸è¿›è¡Œæ˜¾ç¤º

    if ((sipper.totalPowerMah * SECONDS_IN_HOUR) < MIN_POWER_THRESHOLD_MILLI_AMP) {
    

è·å–è®¾å¤‡æ€»è€—ç”µé‡

    double totalPower = USE_FAKE_DATA ? 4000 : mStatsHelper.getTotalPower();
    

è®¡ç®—å ç”¨æ€»è€—ç”µé‡çš„ç™¾åˆ†æ¯”

    final double percentOfTotal =
                            ((sipper.totalPowerMah / totalPower) * dischargeAmount);
    

å¦‚æœæ¯”ä¾‹å°äº0.5ï¼Œåˆ™ä¸è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œ

    if (((int) (percentOfTotal + .5)) < 1) {
                        continue;
                    }
    

å¯¹æŸäº›æƒ…å†µè¿›è¡Œè¿‡æ»¤

    if (sipper.drainType == BatterySipper.DrainType.OVERCOUNTED) {
        // Don't show over-counted unless it is at least 2/3 the size of
        // the largest real entry, and its percent of total is more significant
        if (sipper.totalPowerMah < ((mStatsHelper.getMaxRealPower()*2)/3)) {
            continue;
        }
        if (percentOfTotal < 10) {
            continue;
        }
        if ("user".equals(Build.TYPE)) {
            continue;
        }
    }
    if (sipper.drainType == BatterySipper.DrainType.UNACCOUNTED) {
        // Don't show over-counted unless it is at least 1/2 the size of
        // the largest real entry, and its percent of total is more significant
        if (sipper.totalPowerMah < (mStatsHelper.getMaxRealPower()/2)) {
            continue;
        }
        if (percentOfTotal < 5) {
            continue;
        }
        if ("user".equals(Build.TYPE)) {
            continue;
        }
    }
    

è¿›è¡ŒUIç•Œé¢çš„æ›´æ–°ï¼Œå…¶ä¸­ä¹ŸåŒ…å«äº†è·å–åº”ç”¨çš„iconå›¾æ ‡

    final UserHandle userHandle = new UserHandle(UserHandle.getUserId(sipper.getUid()));
    final BatteryEntry entry = new BatteryEntry(getActivity(), mHandler, mUm, sipper);
    final Drawable badgedIcon = mUm.getBadgedIconForUser(entry.getIcon(),
                                                         userHandle);
    final CharSequence contentDescription = mUm.getBadgedLabelForUser(entry.getLabel(),
                                                                      userHandle);
    final PowerGaugePreference pref = new PowerGaugePreference(getActivity(),
                                                               badgedIcon, contentDescription, entry);
    

è·å–å½“å‰åº”ç”¨çš„æœ€å¤§ç™¾åˆ†æ¯”ï¼Œä»¥åŠå æ€»æ•°çš„ç™¾åˆ†æ¯”

    final double percentOfMax = (sipper.totalPowerMah * 100)
                            / mStatsHelper.getMaxPower();
    sipper.percent = percentOfTotal;
    

UIæ›´æ–°

    pref.setTitle(entry.getLabel());
    pref.setOrder(i + 1);
    pref.setPercent(percentOfMax, percentOfTotal);
    if (sipper.uidObj != null) {
        pref.setKey(Integer.toString(sipper.uidObj.getUid()));
    }
    if ((sipper.drainType != DrainType.APP || sipper.uidObj.getUid() == 0)
        && sipper.drainType != DrainType.USER) {
        pref.setTint(colorControl);
    }
    addedSome = true;
    mAppListGroup.addPreference(pref);
    if (mAppListGroup.getPreferenceCount() > (MAX_ITEMS_TO_LIST + 1)) {
        break;
    }
    

å…¶ä¸­è¿™é‡Œå¯¹æ˜¾ç¤ºçš„æ•°é‡è¿›è¡Œäº†é™åˆ¶

    if (mAppListGroup.getPreferenceCount() > (MAX_ITEMS_TO_LIST + 1)) {
        break;
    }
    

`MAX_ITEMS_TO_LIST`çš„èµ‹å€¼

    private static final int MAX_ITEMS_TO_LIST = USE_FAKE_DATA ? 30 : 10;
    

å¾ªç¯å¤–æœ‰å¯¹`addedSome`çš„åˆ¤æ–­

    if (!addedSome) {
        addNotAvailableMessage();
    }
    

å®é™…ä¸Šå°±æ˜¯åˆ¤æ–­æ˜¯ä¸æ˜¯æœ‰ç¬¦åˆè¦æ±‚çš„è€—ç”µåº”ç”¨ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±æ˜¾ç¤ºä¸€æ¡æç¤ºä¿¡æ¯

    private void addNotAvailableMessage() {
        Preference notAvailable = new Preference(getActivity());
        notAvailable.setTitle(R.string.power_usage_not_available);
        mAppListGroup.addPreference(notAvailable);
    }
    

è¿™éƒ¨åˆ†å°±æ˜¯`PowerUsageSummary.java`æ–‡ä»¶è·å–Settingsç”µæ± ä¸­æ˜¾ç¤ºçš„åº”ç”¨è€—ç”µé‡ä¿¡æ¯ï¼Œæ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„åˆ†æï¼Œå®é™…ä¸Šæ§åˆ¶ä¸Šé¢çš„continueå°±èƒ½è·å–å…¨éƒ¨å·²å®‰è£…åº”ç”¨çš„è€—ç”µé‡ã€‚åœ¨Androidçš„ä¸åŒAPIç‰ˆæœ¬ä¸­ï¼Œä¼šæœ‰ä¸€äº›é€‚é…çš„å·¥ä½œé‡

å…³äºç”³è¯·æƒé™ï¼Œæ™®é€šåº”ç”¨æ˜¯æ²¡æœ‰åŠæ³•è·å–åˆ°åº”ç”¨è€—ç”µé‡ä¿¡æ¯çš„ï¼Œç³»ç»Ÿä¼šæŠ›å‡ºå¼‚å¸¸

java.lang.SecurityException: uid 10089 does not have android.permission.BATTERY\_STATS.

å¦‚æœæƒ³è¦è¿›è¡Œç›¸å…³APIçš„è°ƒç”¨ï¼Œé¦–å…ˆåº”ç”¨éœ€è¦é…ç½®`android.uid.system`æˆä¸ºç³»ç»Ÿåº”ç”¨ï¼Œå¹¶ä¸”è¿›è¡Œç³»ç»Ÿç­¾åï¼Œæ‰èƒ½å¤Ÿæ‹¥æœ‰ç›¸å…³æƒé™ï¼Œæœ¬åœ°ç¼–è¯‘çš„è¯éœ€è¦è°ƒç”¨Androidçš„`internal`æ¥å£ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯æ›¿æ¢æœ¬åœ°android.jaræ‰å¯ä»¥æ­£å¸¸æ‰“åŒ…å‡ºapkæ–‡ä»¶

æœ¬åœ°ç¼–å†™äº†ä¸€ä¸ªè·å–Androidåº”ç”¨è€—ç”µé‡çš„demoï¼Œè¿è¡Œæˆªå›¾å¦‚ä¸‹

![](https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20230111211449.png)

END
---

å»ºäº†ä¸€ä¸ªå¾®ä¿¡çš„å®‰å…¨äº¤æµç¾¤ï¼Œæ¬¢è¿æ·»åŠ æˆ‘å¾®ä¿¡å¤‡æ³¨`è¿›ç¾¤`ï¼Œä¸€èµ·æ¥èŠå¤©å¹æ°´å“‡ï¼Œä»¥åŠä¸€ä¸ªä¼šå‘å¸ƒå®‰å…¨ç›¸å…³å†…å®¹çš„å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ ğŸ˜ƒ

![GIF](https://springbird.oss-cn-beijing.aliyuncs.com/img/mmqrcode1632325540724.png) ![GIF](https://springbird.oss-cn-beijing.aliyuncs.com/img/qrcode_for_gh_cead8e1080d6_344.jpg)