---
layout: post
title: "aspnetcore åŸç”Ÿ DI å®ç°åŸºäº key çš„æœåŠ¡è·å–"
date: "2023-02-22T01:12:28.361Z"
---
aspnetcore åŸç”Ÿ DI å®ç°åŸºäº key çš„æœåŠ¡è·å–
===============================

ä½ å¯èƒ½æƒ³é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…å…¶ä»–çš„ç±»å‹æ¥è·å–ä¸€ä¸ªå…·ä½“çš„æœåŠ¡å®ç°ï¼Œé‚£ä¹ˆåœ¨ aspnetcore åŸç”Ÿçš„ MSDI ä¸­ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡è‡ªå®šä¹‰å·¥å‚æ¥å®ç°ã€‚

ä½ å¯èƒ½æƒ³é€šè¿‡ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…å…¶ä»–çš„ç±»å‹æ¥è·å–ä¸€ä¸ªå…·ä½“çš„æœåŠ¡å®ç°ï¼Œé‚£ä¹ˆåœ¨ aspnetcore åŸç”Ÿçš„ MSDI ä¸­ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡è‡ªå®šä¹‰å·¥å‚æ¥å®ç°ã€‚

æˆ‘ä»¬ç°åœ¨æ°å¥½æœ‰åŸºäº Json å’Œ MessagePack çš„ä¸¤ç§åºåˆ—åŒ–å™¨
------------------------------------

æœ‰ä¸€ä¸ªæ¥å£æ˜¯è¿™æ ·çš„

    public interface ISerializer
    {
        byte[] Serialize<T>(T obj);
        T Deserialize<T>(ReadOnlySpan<byte> data);
    }
    

å¹¶ä¸”ç”±ä¸¤ä¸ªä¸åŒçš„å®ç°

    // Json
    public class MyJsonSerializer : ISerializer
    {
        public byte[] Serialize<T>(T obj)
        {
            throw new NotImplementedException();
        }
    
        public T Deserialize<T>(ReadOnlySpan<byte> data)
        {
            throw new NotImplementedException();
        }
    }
    
    // MessagePack
    public class MyMessagePackSerializer : ISerializer
    {
        public byte[] Serialize<T>(T obj)
        {
            throw new NotImplementedException();
        }
    
        public T Deserialize<T>(ReadOnlySpan<byte> data)
        {
            throw new NotImplementedException();
        }
    }
    

æˆ‘æœ‰ä¸€ä¸ªæœåŠ¡ï¼Œéœ€è¦ä½¿ç”¨è¿™ä¸¤ç§åºåˆ—åŒ–å™¨ä¸­çš„ä¸€ç§ã€‚

    public class MyService
    {
        public object DoSomething(string dataType, ReadOnlySpan<byte> data)
        {
            // æ ¹æ® dataType æ¥å†³å®šä½¿ç”¨å“ªç§åºåˆ—åŒ–å™¨
        }
    }
    

ä½¿ç”¨å§”æ‰˜æ¥å®šä¹‰è·å–æœåŠ¡çš„æ–¹æ³•
--------------

æˆ‘ä»¬å¯ä»¥é€šè¿‡å§”æ‰˜æ¥å®šä¹‰è·å–æœåŠ¡çš„æ–¹æ³•ï¼Œå¦‚ä¸‹

    public delegate ISerializer SerializerFactory(string dataType);
    

ç„¶ååœ¨ `ConfigureServices` æ–¹æ³•ä¸­æ³¨å†Œ

    services.AddSingleton<MyJsonSerializer>();
    services.AddSingleton<MyMessagePackSerializer>();
    services.AddSingleton<SerializerFactory>(sp =>
    {
        return dataType =>
        {
            switch (dataType)
            {
                case "json":
                    return sp.GetRequiredService<MyJsonSerializer>();
                case "msgpack":
                    return sp.GetRequiredService<MyMessagePackSerializer>();
                default:
                    throw new NotSupportedException();
            }
        };
    });
    

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ `MyService` ä¸­é€šè¿‡å§”æ‰˜æ¥è·å–æœåŠ¡äº†

    public class MyService
    {
        private readonly SerializerFactory _serializerFactory;
    
        public MyService(SerializerFactory serializerFactory)
        {
            _serializerFactory = serializerFactory;
        }
    
        public object DoSomething(string dataType, ReadOnlySpan<byte> data)
        {
            var serializer = _serializerFactory(dataType);
            return serializer.Deserialize<object>(data);
        }
    }
    

åŸºäºé…ç½®æ¥æ”¹å˜å·¥å‚
---------

å› ä¸ºæœ¬è´¨æ˜¯é€šè¿‡å§”æ‰˜æ¥è·å–æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥æ”¹å˜å§”æ‰˜çš„è¡Œä¸ºï¼Œå¦‚ä¸‹

    public static class SerializerFactoryExtensions
    {
        public static SerializerFactory CreateSerializerFactory(this IServiceProvider sp)
        {
            // get mapping from configuration
            var mapping = sp.GetRequiredService<IConfiguration>()
                          .GetSection("SerializerMapping")
                          .Get<Dictionary<string, string>>();
            return dataType =>
            {
                var serializerType = mapping[dataType];
                return (ISerializer)sp.GetRequiredService(Type.GetType(serializerType));
            };
        }
    }
    

ç„¶ååœ¨ `appsettings.json` ä¸­é…ç½®

    {
      "SerializerMapping": {
        "json": "WebApplication1.MyJsonSerializer",
        "msgpack": "WebApplication1.MyMessagePackSerializer"
      }
    }
    

ç„¶ååœ¨ `ConfigureServices` æ–¹æ³•ä¸­æ³¨å†Œ

    services.AddSingleton<MyJsonSerializer>();
    services.AddSingleton<MyMessagePackSerializer>();
    services.AddSingleton(SerializerFactoryExtensions.CreateSerializerFactory);
    

æ€»ç»“
--

æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†å¦‚ä½•é€šè¿‡è‡ªå®šä¹‰å·¥å‚æ¥å®ç°åŸºäº key çš„æœåŠ¡è·å–ï¼Œè¿™ç§æ–¹å¼åœ¨ aspnetcore åŸç”Ÿçš„ DI ä¸­æ˜¯åŸç”Ÿæ”¯æŒçš„ã€‚

å‚è€ƒ
--

*   [Dependency injection guidelines](https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection-guidelines?WT.mc_id=DX-MVP-5003606)1

æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœè§‰å¾—æœ¬æ–‡æœ‰ç”¨ï¼Œä¸å¦¨ç‚¹å‡»æ¨èğŸ‘æˆ–è€…åœ¨è¯„è®ºåŒºç•™ä¸‹ Markï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°ã€‚

> æ¬¢è¿å…³æ³¨ä½œè€…çš„å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€ï¼Œè·å–æ›´å¤šæŠ€æœ¯å†…å®¹ã€‚ ![å…³æ³¨å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€](https://www.newbe.pro/images/weixin_public_qrcode.png)

*   æœ¬æ–‡ä½œè€…ï¼š [newbe36524](https://www.newbe.pro/)
*   æœ¬æ–‡é“¾æ¥ï¼š [https://www.newbe.pro/Others/0x023-aspnetcore-natively-implements-key-based-service-resolving/](https://www.newbe.pro/Others/0x023-aspnetcore-natively-implements-key-based-service-resolving/)
*   ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼

* * *

1.  https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection-guidelines?WT.mc\_id=DX-MVP-5003606â†©