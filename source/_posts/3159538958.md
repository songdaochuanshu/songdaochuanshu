---
layout: post
title: "网络协议之:sctp流控制传输协议"
date: "2022-05-16T12:37:38.674Z"
---
网络协议之:sctp流控制传输协议
=================

目录

*   [简介](#简介)
*   [TCP有什么不好](#tcp有什么不好)
*   [sctp的特点](#sctp的特点)
*   [总结](#总结)

简介
==

要讲网络协议，肯定离不开OSI（Open System Interconnection）的七层模型。 我们一般关注的是网络层之上的几层，比如IPV4 IPV6所在的网络层，TCP UDP所在的传输层,HTTP FTP所在的应用层等。

今天要讲的sctp协议，全称是Stream Control Transmission Protocol,翻译成中文就是流控制传输协议。是由IETF在RFC 4960中提出的。

传输层已经有广泛被使用的TCP和UDP协议，那么为什么还要发明一个SCTP协议呢？

很明显SCTP协议是对TCP和UDP协议的提升，具体而言SCTP协议既提供了UDP协议的面向消息的特性，同时又具有TCP协议的可靠性、顺序传输和拥塞控制的功能，并且还提供了多宿主和冗余路径的功能，从而提高弹性和可靠性。

本文将会详细讲解SCTP的实现原理和协议详情。

TCP有什么不好
========

TCP有什么不好呢？TCP当然好，我们知道UDP是不可靠的消息传输方式，而TCP是可靠的消息传输方式。

UDP和TCP已经被应用在非常广泛的应用场景中。但是一个产品或者协议不可能十全十美，肯定会有一些缺点，我们来看看TCP的缺点有哪些。

TCP和UDP最大的不同是TCP是可靠的，也就是说TCP提供了通过 Internet 可靠地传输数据的方法。

但是TCP为了保证可靠的数据传输，对传输做了一些限制。

比如说，TCP为了保证数据传输的可靠性，需要严格要求数据传输的顺序。比如一个数据包被分拆成了三份分别标号为A，B，C。那么对于接收方来说，则必须先接受数据包A，然后是B和C。如果先接受到的B，那么接收方就会需要让发送发重发数据包。

在这种严格要求数据包顺序的情况下，可能会造成不必要的数据延迟和消息阻塞。

因为TCP是面向数据流的，为了标记数据流中的不同记录，TCP中的数据需要额外添加一些标记或者编码来对记录进行区分。

另外，为了提升传输效率，避免发送多个小数据包的情况，TCP还可能会对其进行优化，也就是说等等多个小的数据包将其合并为一个大的数据包。如果不希望这样的优化，那么需要在TCP数据包中设置PSH标志，明确该请求是无延迟的传输请求。

最后TCP还容易收到DOS(denial-of-service)攻击。

sctp的特点
=======

既然TCP还有诸多的缺点，那么新的SCTP协议又有什么特点呢？

SCTP主要有两大特点，第一个特点就是Message-based,也就是说SCTP是面向消息的。SCTP传输的是一系列的消息，一个消息是一组字节。

相比之下TCP传输的是字节流。

SCTP中的一条消息可以拆分成为多个数据块，每个数据块中的所有数据都来自同一个用户。当这些数据需要在IP中进行传输的时候，SCTP会将这些数据包打包成为SCTP packets,每个SCTP packet,都包含一个packet header，如果需要的话还可以包含控制块，最后跟着的是数据块。

怎么理解TCP包和SCTP包的不同呢？

举个例子，当客户端以TCP协议向服务器端发送多条消息的时候，如果消息非常短，为了提升传输效率，TCP可能会将这些不同作用的小的数据放到同一个TCP包中。在服务器端接收的过程中也是一次收取这个TCP包中的所有数据，然后由应用程序本身来进行TCP包中底层数据的拆分。

对于SCTP包来说，一个SCTP包中可以包含多个data chunks，不同的data chunks可以包含不同用户的不同消息，因为SCTP包已经对不同的消息进行了区分，所以对于服务器端的读取来说就相对容易很多。

下面是一个SCTP包的基本结构：

![](https://img-blog.csdnimg.cn/192ac8b9bc5d4a2c99283b1a2d8d5de6.png)

从上图可以看出，前面的蓝色部分的12个字节是SCTP包的包头，其中前面的两个字节是源端口号，接着的两个字节是目标端口号，然后4个字节是验证标记，最后的4个直接是校验位，总共12个字节。

header后面就是data chunks,也就是数据块，每个chunk都包含一个类型位，flags位和长度位，后面跟着的是chunk的具体数据。

SCTP的另外一个特点就是multi-streaming,多流指的是SCTP能够并行传输多个独立的数据流，比如在访问网页的时候可以同时传输网页中的图像和网页的文本。

为什么可以这样操作呢？这也是由SCTP数据包的结构来决定的，我们可以看到SCTP的数据包中可以包含多个data chunks,这些data chunks可以包含不同的数据流过来的数据，所以面向消息的SCTP可以实现并行传输不同数据源数据的功能。

SCTP的另外一个特性就是Multihoming,Multihoming是multiple+homing的合成词，字面上的意思就是多个home。

这是什么意思呢？

我们知道对于TCP协议来说，客户端和服务器端都只有一个，属于一对一进行连接的情况，如果这个连接两端的而任何一个IP或者端口不可以，那么整个TCP的连接就崩溃了。

那么TCP可不可以发展为类似LSB负载均衡的模式呢？如果一个IP不可以，自动重连到备用的IP地址。

SCTP就是TCP协议的升级版本，它在增强可靠性方面做了优化。

具体而言，每个SCTP的节点都会使用心跳的机制定时检查远程节点的主IP地址和备用的冗余IP地址的可达性。在SCTP中一个节点可以绑定多个IP地址。

SCTP节点将会根据收到的远程节点的心跳返回值来确认具体的访问信息。

因为客户端节点和服务器端节点的个数可能是不同的，所以SCTP可以分为对称的multihoming和非对称的multihoming。

下面三个图分别是对称multihoming和两个非对称multihoming的情况：

![](https://img-blog.csdnimg.cn/e36a2c996bd640fc89ea4f670e4d3992.png)

![](https://img-blog.csdnimg.cn/0d2cd08177314198895ed0f8f0eaee76.png)

![](https://img-blog.csdnimg.cn/33092b1062f74fb6a99e9b605254bad3.png)

最后，SCTP的安全性也有所提升。相较于TCP的三次握手相比，SCTP具有四次握手。

TCP的三次握手可能导致SYN攻击。

什么是SYN攻击呢？我们回顾一下TCP的三次握手流程，首先客户端发送一个SYN A请求给服务器端，服务器端在收到这个SYN请求之后，会将SYN请求缓存起来，然后向客户端返回SYN B，ACK A+1, 客户端在收到回复之后，校验ACK的值，然后再次发送ACK B+1到服务器端。服务器端收到B+1请求之后，最终确认客户端的身份，连接建立完成。

上面的流程中因为服务器端需要缓存TCP客户端的SYN消息，所以如果服务器收到大量SYN消息的话，就造成了SYN攻击。

相较而言，SCTP在收到客户端的连接请求之后，并不会立即分配内存缓存起来，而是返回一个COOKIE给客户端。客户端再次请求的时候，需要带上这个COOKIE信息，服务器端通过COOKIE校验，确认客户端的身份之后,才会最终建立连接。从而避免TCP的SYN攻击。

总结
==

综上所述，SCTP可以保证有序和无数数据流的可靠传输，可以支持Multihoming，每个节点都可以包含多个IP地址，从而实现冗余网络路径之间的透明故障转移。并提升了验证和确认机制，可以防止SYN攻击。

SCTP是一个非常优秀的协议。对于常用的操作系统而言，在特定的版本也提供了对SCTP的支持。比如在linux中，内核2.4版本之上都支持SCTP协议。

如果在windows或者MAC上，需要额外安装第三方驱动，其中windows的驱动叫做SctpDrv kernel driver,MAC上的驱动叫做SCTP Network Kernel Extension for Mac OS X。

> 本文已收录于 [http://www.flydean.com/21-sctp/](http://www.flydean.com/21-sctp/)
> 
> 最通俗的解读，最深刻的干货，最简洁的教程，众多你不知道的小技巧等你来发现！
> 
> 欢迎关注我的公众号:「程序那些事」,懂技术，更懂你！