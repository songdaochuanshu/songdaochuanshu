---
layout: post
title: "Java åŠ¨æ€ä»£ç†åŸç†å›¾è§£ (é™„ï¼š2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)"
date: "2022-10-31T05:35:07.385Z"
---
Java åŠ¨æ€ä»£ç†åŸç†å›¾è§£ (é™„ï¼š2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)
============================

â€‹

Â ![JavaåŠ¨æ€ä»£ç†åŸç†å›¾è§£(é™„2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)-mikechençš„äº’è”ç½‘æ¶æ„](https://static.mikechen.cc/wp-content/uploads/2022/06/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86.png)

åŠ¨æ€ä»£ç†åœ¨ Java ä¸­æœ‰ç€å¹¿æ³›çš„åº”ç”¨ï¼Œä¾‹å¦‚ï¼šSpring AOP é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ŒHibernate æ•°æ®æŸ¥è¯¢ã€ä»¥åŠ RPC Dubbo è¿œç¨‹è°ƒç”¨ç­‰ï¼Œéƒ½æœ‰éå¸¸å¤šçš„å®é™…åº”ç”¨@[mikechen](https://mikechen.cc/)

ç›®å½•

*   [Java åŠ¨æ€ä»£ç†åŸç†](https://mikechen.cc/14899.html#Java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86)
*   [JDK åŸç”ŸåŠ¨æ€ä»£ç†](https://mikechen.cc/14899.html#JDK%E5%8E%9F%E7%94%9F%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86)
*   [CGLib åŠ¨æ€ä»£ç†å®ç°](https://mikechen.cc/14899.html#CGLib%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0)
*   [JDK åŠ¨æ€ä»£ç†ä¸ CGLib çš„åŒºåˆ«](https://mikechen.cc/14899.html#JDK%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8ECGLib%E7%9A%84%E5%8C%BA%E5%88%AB)

Java åŠ¨æ€ä»£ç†åŸç†
-----------

**æŒ‰ç…§ä»£ç†çš„åˆ›å»ºæ—¶æœŸï¼Œä»£ç†ç±»å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š**

![JavaåŠ¨æ€ä»£ç†åŸç†å›¾è§£(é™„2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)-mikechençš„äº’è”ç½‘æ¶æ„](https://static.mikechen.cc/wp-content/uploads/2022/06/Java-Dynamic-Proxy-01.png)

*   é™æ€ä»£ç†ï¼šç”±ç¨‹åºå‘˜åˆ›å»ºæˆ–ç‰¹å®šå·¥å…·è‡ªåŠ¨ç”Ÿæˆæºä»£ç ï¼Œå†å¯¹å…¶ç¼–è¯‘ï¼Œåœ¨ç¨‹åºè¿è¡Œå‰ï¼Œä»£ç†ç±»çš„ .class æ–‡ä»¶å°±å·²ç»å­˜åœ¨äº†ã€‚
*   åŠ¨æ€ä»£ç†ï¼šåœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œå¯ä»¥è¿ç”¨åå°„æœºåˆ¶åŠ¨æ€åˆ›å»ºä»£ç†ç±»çš„ .class æ–‡ä»¶ã€‚

**åŠ¨æ€ä»£ç†ç±»ä¸é™æ€ä»£ç†ç±»æœ€ä¸»è¦çš„ä¸åŒç‚¹**æ˜¯ï¼šä»£ç†ç±»çš„å­—èŠ‚ç ä¸æ˜¯åœ¨ç¨‹åºè¿è¡Œå‰ç”Ÿæˆçš„ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶å†è™šæ‹Ÿæœºä¸­ç¨‹åºè‡ªåŠ¨åˆ›å»ºçš„ã€‚

**åŠ¨æ€ä»£ç†çš„å®ç°æ–¹å¼å¾ˆå¤šã€‚**ä¾‹å¦‚ï¼šJDK è‡ªèº«æä¾›çš„åŠ¨æ€ä»£ç†ï¼Œå°±åˆ©ç”¨äº†ä¸Šé¢æåˆ°çš„åå°„æœºåˆ¶ã€‚é™¤äº†åå°„ï¼ŒåŠ¨æ€ä»£ç†è¿˜å¯ä»¥é€šè¿‡ CGLib æ¥å®ç°ï¼Œè€Œ CGLib æ˜¯åŸºäº ASMï¼ˆä¸€ä¸ª Java å­—èŠ‚ç æ“ä½œæ¡†æ¶ï¼‰è€Œéåå°„å®ç°çš„ã€‚

ç®€å•æ¥è¯´ï¼ŒåŠ¨æ€ä»£ç†æ˜¯ä¸€ç§è¡Œä¸ºæ–¹å¼ï¼Œè€ŒÂ **åå°„**æˆ– **ASM** åªæ˜¯å®ƒçš„ä¸€ç§å®ç°æ‰‹æ®µè€Œå·²ã€‚

æœ¬æ–‡æˆ‘ä¸»è¦è¯¦è§£ Java åŠ¨æ€ä»£ç†çš„ 2 ç§ä¸»æµç°æ–¹å¼ï¼š**JDK åŸç”ŸåŠ¨æ€ä»£ç†**ä¸ **CGLib** ã€‚

![JavaåŠ¨æ€ä»£ç†åŸç†å›¾è§£(é™„2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)-mikechençš„äº’è”ç½‘æ¶æ„](https://static.mikechen.cc/wp-content/uploads/2022/06/Java-Dynamic-Proxy-02.png)

JDK åŸç”ŸåŠ¨æ€ä»£ç†
----------

JDK Proxy åŠ¨æ€ä»£ç†çš„å®ç°æ— éœ€å¼•ç”¨ç¬¬ä¸‰æ–¹ç±»ï¼Œåªéœ€è¦å®ç° InvocationHandler æ¥å£ï¼Œé‡å†™ invoke() æ–¹æ³•å³å¯ï¼Œæ•´ä¸ªå®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼šã€

    import java.lang.reflect.InvocationHandler;
    import java.lang.reflect.InvocationTargetException;
    import java.lang.reflect.Method;
    import java.lang.reflect.Proxy;
    Â 
    /**
    * JDK Proxy ç›¸å…³ç¤ºä¾‹
    */
    public class ProxyExample {
    static interface Car {
    void running();
    }
    Â 
    static class Bus implements Car {
    @Override
    public void running() {
    System.out.println("The bus is running.");
    }
    }
    Â 
    static class Taxi implements Car {
    @Override
    public void running() {
    System.out.println("The taxi is running.");
    }
    }
    Â 
    /**
    * JDK Proxy
    */
    static class JDKProxy implements InvocationHandler {
    private Object target; // ä»£ç†å¯¹è±¡
    Â 
    // è·å–åˆ°ä»£ç†å¯¹è±¡
    public Object getInstance(Object target) {
    this.target = target;
    // å–å¾—ä»£ç†å¯¹è±¡
    return Proxy.newProxyInstance(target.getClass().getClassLoader(),
    target.getClass().getInterfaces(), this);
    }
    Â 
    /**
    * æ‰§è¡Œä»£ç†æ–¹æ³•
    * @param proxy ä»£ç†å¯¹è±¡
    * @param method ä»£ç†æ–¹æ³•
    * @param args æ–¹æ³•çš„å‚æ•°
    * @return
    * @throws InvocationTargetException
    * @throws IllegalAccessException
    */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args)
    throws InvocationTargetException, IllegalAccessException {
    System.out.println("åŠ¨æ€ä»£ç†ä¹‹å‰çš„ä¸šåŠ¡å¤„ç†.");
    Object result = method.invoke(target, args); // æ‰§è¡Œè°ƒç”¨æ–¹æ³•ï¼ˆæ­¤æ–¹æ³•æ‰§è¡Œå‰åï¼Œå¯ä»¥è¿›è¡Œç›¸å…³ä¸šåŠ¡å¤„ç†ï¼‰
    return result;
    }
    }
    Â 
    public static void main(String[] args) {
    // æ‰§è¡Œ JDK Proxy
    JDKProxy jdkProxy = new JDKProxy();
    Car carInstance = (Car) jdkProxy.getInstance(new Taxi());
    carInstance.running();

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

ä»¥ä¸Šç¨‹åºçš„æ‰§è¡Œç»“æœæ˜¯ï¼š

åŠ¨æ€ä»£ç†ä¹‹å‰çš„ä¸šåŠ¡å¤„ç†ã€‚

    Â The taxi is running.

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

å¯ä»¥çœ‹å‡ºï¼Œ JDK Proxy å®ç°åŠ¨æ€ä»£ç†çš„æ ¸å¿ƒæ˜¯å®ç° Invocation æ¥å£ï¼Œæˆ‘ä»¬æŸ¥çœ‹ Invocation çš„æºç ï¼Œä¼šå‘ç°é‡Œé¢å…¶å®åªæœ‰ä¸€ä¸ª invoke() æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š

    public interface InvocationHandler {
    public Object invoke(Object proxy, Method method, Object[] args)
    throws Throwable;
    }

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

è¿™æ˜¯å› ä¸ºåœ¨åŠ¨æ€ä»£ç†ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯ä»£ç†å™¨ï¼Œå®ƒç”¨äºç»Ÿä¸€ç®¡ç†è¢«ä»£ç†çš„å¯¹è±¡ï¼Œæ˜¾ç„¶ InvocationHandler å°±æ˜¯è¿™ä¸ªä»£ç†å™¨ã€‚è€Œ invoke() æ–¹æ³•ï¼Œåˆ™æ˜¯è§¦å‘ä»£ç†çš„æ‰§è¡Œæ–¹æ³•ï¼Œæˆ‘ä»¬é€šè¿‡å®ç° Invocation æ¥å£æ¥æ‹¥æœ‰åŠ¨æ€ä»£ç†çš„èƒ½åŠ›ã€‚

CGLib åŠ¨æ€ä»£ç†å®ç°
------------

**CGLIB (Code Generation Library)** æ˜¯ä¸€ä¸ªåŸºäº ASM çš„å­—èŠ‚ç ç”Ÿæˆåº“ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ã€å’ŒåŠ¨æ€ç”Ÿæˆ CGLIB é€šè¿‡ç»§æ‰¿æ–¹å¼å®ç°ä»£ç†ã€‚

![JavaåŠ¨æ€ä»£ç†åŸç†å›¾è§£(é™„2ç§å®ç°æ–¹å¼è¯¦ç»†å¯¹æ¯”)-mikechençš„äº’è”ç½‘æ¶æ„](https://static.mikechen.cc/wp-content/uploads/2022/06/Java-Dynamic-Proxy-03.png)

åœ¨ä½¿ç”¨ CGLib ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆåœ¨é¡¹ç›®ä¸­å¼•å…¥ CGLib æ¡†æ¶ï¼Œ**åœ¨ pom.xml ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®**ï¼š

    <dependency>
    <groupId>cglib</groupId>
    <artifactId>cglib</artifactId>
    <version>3.3.0</version>
    </dependency>

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

**CGLib çš„å®ç°ä»£ç ï¼š**

    package com.mikechen.proxydemo;
    Â 
    import net.sf.cglib.proxy.Enhancer;
    import net.sf.cglib.proxy.MethodInterceptor;
    import net.sf.cglib.proxy.MethodProxy;
    Â 
    import java.lang.reflect.Method;
    Â 
    public class CGLibExample {
    Â 
    static class Car {
    public void running() {
    System.out.println("The car is running.");
    }
    }
    Â 
    /**
    * CGLib ä»£ç†ç±»
    */
    static class CGLibProxy implements MethodInterceptor {
    private Object target; // ä»£ç†å¯¹è±¡
    Â 
    public Object getInstance(Object target) {
    this.target = target;
    Enhancer enhancer = new Enhancer();
    // è®¾ç½®çˆ¶ç±»ä¸ºå®ä¾‹ç±»
    enhancer.setSuperclass(this.target.getClass());
    // å›è°ƒæ–¹æ³•
    enhancer.setCallback(this);
    // åˆ›å»ºä»£ç†å¯¹è±¡
    return enhancer.create();
    }
    Â 
    @Override
    public Object intercept(Object o, Method method,
    Object[] objects, MethodProxy methodProxy) throws Throwable {
    System.out.println("æ–¹æ³•è°ƒç”¨å‰ä¸šåŠ¡å¤„ç†.");
    Object result = methodProxy.invokeSuper(o, objects); // æ‰§è¡Œæ–¹æ³•è°ƒç”¨
    return result;
    }
    }
    Â 
    // æ‰§è¡Œ CGLib çš„æ–¹æ³•è°ƒç”¨
    public static void main(String[] args) {
    // åˆ›å»º CGLib ä»£ç†ç±»
    CGLibProxy proxy = new CGLibProxy();
    // åˆå§‹åŒ–ä»£ç†å¯¹è±¡
    Car car = (Car) proxy.getInstance(new Car());
    // æ‰§è¡Œæ–¹æ³•
    car.running();

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

ä»¥ä¸Šç¨‹åºçš„æ‰§è¡Œç»“æœæ˜¯ï¼š

æ–¹æ³•è°ƒç”¨å‰ä¸šåŠ¡å¤„ç†ã€‚

    The car is running.

![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif)![](https://img2022.cnblogs.com/blog/1459045/202210/1459045-20221031095539220-1665583008.gif "ç‚¹å‡»å¹¶æ‹–æ‹½ä»¥ç§»åŠ¨")

å¯ä»¥çœ‹å‡ºï¼š

CGLib å’Œ JDK Proxy çš„å®ç°ä»£ç æ¯”è¾ƒç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡å®ç°ä»£ç†å™¨çš„æ¥å£ï¼Œå†è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•å®ŒæˆåŠ¨æ€ä»£ç†çš„ã€‚

å”¯ä¸€ä¸åŒçš„æ˜¯ï¼ŒCGLib åœ¨åˆå§‹åŒ–è¢«ä»£ç†ç±»æ—¶ï¼Œæ˜¯é€šè¿‡ Enhancer å¯¹è±¡æŠŠä»£ç†å¯¹è±¡è®¾ç½®ä¸ºè¢«ä»£ç†ç±»çš„å­ç±»ï¼Œæ¥å®ç°åŠ¨æ€ä»£ç†çš„ã€‚

å› æ­¤ï¼Œè¢«ä»£ç†ç±»ä¸èƒ½è¢«å…³é”®å­— final ä¿®é¥°ï¼Œå¦‚æœè¢« final ä¿®é¥°ï¼Œå†ä½¿ç”¨ Enhancer è®¾ç½®çˆ¶ç±»æ—¶ä¼šæŠ¥é”™ï¼ŒåŠ¨æ€ä»£ç†çš„æ„å»ºä¼šå¤±è´¥ã€‚

JDK åŠ¨æ€ä»£ç†ä¸ CGLib çš„åŒºåˆ«
-------------------

**1.Â  JDK åŠ¨æ€ä»£ç†å…·ä½“å®ç°åŸç†**

*   é€šè¿‡å®ç° InvocationHandler æ¥å£ï¼Œåˆ›å»ºè‡ªå·±çš„è°ƒç”¨å¤„ç†å™¨ï¼›
*   é€šè¿‡ä¸º Proxy ç±»æŒ‡å®š ClassLoader å¯¹è±¡å’Œä¸€ç»„ interface ï¼Œæ¥åˆ›å»ºåŠ¨æ€ä»£ç†ï¼›
*   é€šè¿‡åå°„æœºåˆ¶è·å–åŠ¨æ€ä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œå…¶å”¯ä¸€å‚æ•°ç±»å‹å°±æ˜¯è°ƒç”¨å¤„ç†å™¨æ¥å£ç±»å‹ï¼›
*   é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹ï¼Œæ„é€ æ—¶è°ƒç”¨å¤„ç†å™¨å¯¹è±¡ä½œä¸ºå‚æ•°å‚å…¥ã€‚

**2.Â  CGLib åŠ¨æ€ä»£ç†**

CGLib æ˜¯ä¸€ä¸ªå¼ºå¤§ã€é«˜æ€§èƒ½çš„ Code ç”Ÿäº§ç±»åº“ï¼Œå¯ä»¥å®ç°è¿è¡ŒæœŸåŠ¨æ€æ‰©å±• java ç±»ï¼ŒSpring åœ¨è¿è¡ŒæœŸé—´é€šè¿‡ CGlib ç»§æ‰¿è¦è¢«åŠ¨æ€ä»£ç†çš„ç±»ï¼Œé‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå®ç° AOP é¢å‘åˆ‡é¢ç¼–ç¨‹ã€‚

**3.Â  ä¸¤è€…å¯¹æ¯”**

*   JDK åŠ¨æ€ä»£ç†æ˜¯é¢å‘æ¥å£çš„ã€‚
*   CGLib åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡å­—èŠ‚ç åº•å±‚ç»§æ‰¿è¦ä»£ç†ç±»æ¥å®ç°ï¼ˆå¦‚æœè¢«ä»£ç†ç±»è¢« final å…³é”®å­—æ‰€ä¿®é¥°ï¼Œä¼šå¤±è´¥ï¼‰ã€‚

**4.Â  æ€§èƒ½å¯¹æ¯”**

*   CGLib æ‰€åˆ›å»ºçš„åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œåœ¨å®é™…è¿è¡Œæ—¶å€™çš„æ€§èƒ½è¦æ¯” JDK åŠ¨æ€ä»£ç†é«˜ä¸å°‘ï¼Œæœ‰ç ”ç©¶è¡¨æ˜ï¼Œå¤§æ¦‚è¦é«˜å‡º10å€ï¼›
*   CGLib åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Œæ¯” JDK åŠ¨æ€ä»£ç†è¦å¤šå¾ˆå¤šï¼Œæœ‰ç ”ç©¶è¡¨æ˜ï¼Œå¤§æ¦‚è¦é«˜å‡º8å€ã€‚

å› æ­¤ï¼Œå¯¹äº singleton çš„ä»£ç†å¯¹è±¡æˆ–è€…å…·æœ‰å®ä¾‹æ± çš„ä»£ç†ï¼Œå› ä¸ºæ— éœ€é¢‘ç¹çš„åˆ›å»ºä»£ç†å¯¹è±¡ï¼Œæ›´é€‚åˆé‡‡ç”¨ CGLib åŠ¨æ€ä»£ç†ï¼Œåä¹‹ï¼Œåˆ™æ¯”è¾ƒé€‚ç”¨ JDK åŠ¨æ€ä»£ç†ã€‚

ä»¥ä¸Šï¼Œæ˜¯å…³äº Java åŠ¨æ€ä»£ç†åŸç†ã€ä»¥åŠåŠ¨æ€ä»£ç†2 ç§å®ç°æ–¹å¼çš„è§£æã€‚

å¸Œæœ›æœ‰æ‰€å¸®åŠ©ï¼Œè°¢è°¢ã€**å…³æ³¨+****ç‚¹èµ+****è½¬å‘ã€‘**æ”¯æŒã€‚

ä½œè€…ç®€ä»‹
----

é™ˆç¿ |Â [mikechen](https://mikechen.cc/)Â , 10å¹´+å¤§å‚æ¶æ„ç»éªŒ,ã€Œmikechen çš„äº’è”ç½‘æ¶æ„ã€ç³»åˆ—æ–‡ç« ä½œè€…ï¼Œä¸“æ³¨äºäº’è”ç½‘æ¶æ„æŠ€æœ¯ã€‚

**ğŸ‘‡é˜…è¯»ã€Œmikechen çš„äº’è”ç½‘æ¶æ„ã€40W å­—æŠ€æœ¯æ–‡ç« åˆé›†ğŸ‘‡**

**[Javaå¹¶å‘](https://mikechen.cc/8225.html)Â |Â [JVM](https://mikechen.cc/8280.html)Â |Â [MySQL](https://mikechen.cc/14759.html)Â |Â [Spring](https://mikechen.cc/14223.html)Â |Â [Redis](https://mikechen.cc/14356.html)Â |Â [åˆ†å¸ƒå¼](https://mikechen.cc/15795.html)Â |Â [é«˜å¹¶å‘](https://mikechen.cc/16650.html)**

\--- **end** ---

â€‹