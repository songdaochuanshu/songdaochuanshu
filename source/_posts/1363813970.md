---
layout: post
title: "Spring Cloud Consul å…¥é—¨æŒ‡å¼•"
date: "2022-10-04T06:34:34.910Z"
---
Spring Cloud Consul å…¥é—¨æŒ‡å¼•
========================

**1 æ¦‚è¿°**
--------

[Spring Cloud Consul](https://cloud.spring.io/spring-cloud-consul/) é¡¹ç›®ä¸º Spring Boot åº”ç”¨ç¨‹åºæä¾›äº†ä¸ Consul çš„è½»æ¾é›†æˆã€‚

[Consul](https://www.consul.io/intro/) æ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå®ƒæä¾›ç»„ä»¶æ¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­ä¸€äº›æœ€å¸¸è§çš„æŒ‘æˆ˜ï¼š

*   æœåŠ¡å‘ç°â€”â€”è‡ªåŠ¨æ³¨å†Œå’Œæ³¨é”€æœåŠ¡å®ä¾‹çš„ç½‘ç»œä½ç½®
*   å¥åº·æ£€æŸ¥â€”â€”æ£€æµ‹æœåŠ¡å®ä¾‹ä½•æ—¶å¯åŠ¨å¹¶è¿è¡Œ
*   åˆ†å¸ƒå¼é…ç½®â€”â€”ç¡®ä¿æ‰€æœ‰æœåŠ¡å®ä¾‹ä½¿ç”¨ç›¸åŒçš„é…ç½®

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•é…ç½® Spring Boot åº”ç”¨ç¨‹åºä»¥ä½¿ç”¨è¿™äº›åŠŸèƒ½ã€‚

**2 å‰ææ¡ä»¶**
----------

é¦–å…ˆï¼Œå»ºè®®å¿«é€Ÿæµè§ˆ [Consul](https://www.consul.io/intro/) åŠå…¶æ‰€æœ‰åŠŸèƒ½ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åœ¨ _localhost:8500_ ä¸Šè¿è¡Œçš„ Consul ä»£ç†ã€‚æœ‰å…³å¦‚ä½•å®‰è£… Consul å’Œè¿è¡Œä»£ç†çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…æ­¤ [é“¾æ¥](https://learn.hashicorp.com/tutorials/consul/get-started-install)ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ  \[spring-cloud-starter-consul-all\]([https://search.maven.org/classic/#search|ga|1|a%3A"spring-cloud-starter-](https://search.maven.org/classic/#search%7Cga%7C1%7Ca%3A%22spring-cloud-starter-) consul-all%22) çš„ _pom.xml_ çš„ä¾èµ–ï¼š

    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-consul-all</artifactId>
        <version>3.1.1</version>
    </dependency>
    

**3 æœåŠ¡å‘ç°**
----------

è®©æˆ‘ä»¬ç¼–å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ª Spring Boot åº”ç”¨ç¨‹åºå¹¶è¿æ¥æ­£åœ¨è¿è¡Œçš„ Consul ä»£ç†ï¼š

    @SpringBootApplication
    public class ServiceDiscoveryApplication {
    
        public static void main(String[] args) {
            new SpringApplicationBuilder(ServiceDiscoveryApplication.class)
              .web(true).run(args);
        }
    }
    

**é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Boot å°†å°è¯•è¿æ¥åˆ° _localhost:8500_ çš„ Consul ä»£ç†ã€‚** è¦ä½¿ç”¨å…¶ä»–è®¾ç½®ï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–° _application.yml_ æ–‡ä»¶ï¼š

    spring:
      cloud:
        consul:
          host: localhost
          port: 8500
    

ç„¶åï¼Œå¦‚æœæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—® Consul ä»£ç†çš„ç«™ç‚¹ _[http://localhost:8500](http://localhost:8500)_ ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²åœ¨ Consul ä¸­æ­£ç¡®æ³¨å†Œï¼Œæ ‡è¯†ç¬¦æ¥è‡ª _"${spring.application.name}ï¼š ${ç”¨é€—å·åˆ†éš”çš„é…ç½®æ–‡ä»¶}ğŸ˜’{server.port}"_.

è¦è‡ªå®šä¹‰æ­¤æ ‡è¯†ç¬¦ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªè¡¨è¾¾å¼æ›´æ–°å±æ€§ _spring.cloud.discovery.instanceId_ï¼š

    spring:
      application:
        name: myApp
      cloud:
        consul:
          discovery:
            instanceId: ${spring.application.name}:${random.value}
    

å¦‚æœæˆ‘ä»¬å†æ¬¡è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å®ƒæ˜¯ä½¿ç”¨æ ‡è¯†ç¬¦ _"MyApp"_ åŠ ä¸Šä¸€ä¸ªéšæœºå€¼æ³¨å†Œçš„ã€‚æˆ‘ä»¬éœ€è¦å®ƒæ¥åœ¨æœ¬åœ°æœºå™¨ä¸Šè¿è¡Œåº”ç”¨ç¨‹åºçš„å¤šä¸ªå®ä¾‹ã€‚

æœ€åï¼Œ**è¦ç¦ç”¨æœåŠ¡å‘ç°ï¼Œæˆ‘ä»¬éœ€è¦å°†å±æ€§ _spring.cloud.consul.discovery.enabled_ è®¾ç½®ä¸º _false_ã€‚**

### **3.1 æŸ¥æ‰¾æœåŠ¡**

æˆ‘ä»¬å·²ç»åœ¨ Consul ä¸­æ³¨å†Œäº†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¦‚ä½•æ‰¾åˆ°æœåŠ¡ç«¯ç‚¹ï¼Ÿæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‘ç°å®¢æˆ·ç«¯æœåŠ¡æ¥ä» Consul è·å¾—æ­£åœ¨è¿è¡Œä¸”å¯ç”¨çš„æœåŠ¡ã€‚

\*\*Spring ä¸ºæ­¤æä¾›äº†ä¸€ä¸ª _DiscoveryClient API_ \*\*ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ _@EnableDiscoveryClient_ æ³¨é‡Šæ¥å¯ç”¨å®ƒï¼š

    @SpringBootApplication
    @EnableDiscoveryClient
    public class DiscoveryClientApplication {
        // ...
    }
    

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å°† _DiscoveryClient_ bean æ³¨å…¥æˆ‘ä»¬çš„æ§åˆ¶å™¨å¹¶è®¿é—®å®ä¾‹ï¼š

    @RestController
    public class DiscoveryClientController {
     
        @Autowired
        private DiscoveryClient discoveryClient;
    
        public Optional<URI> serviceUrl() {
            return discoveryClient.getInstances("myApp")
              .stream()
              .findFirst() 
              .map(si -> si.getUri());
        }
    }
    

æœ€åï¼Œæˆ‘ä»¬å°†å®šä¹‰æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç«¯ç‚¹ï¼š

    @GetMapping("/discoveryClient")
    public String discoveryPing() throws RestClientException, 
      ServiceUnavailableException {
        URI service = serviceUrl()
          .map(s -> s.resolve("/ping"))
          .orElseThrow(ServiceUnavailableException::new);
        return restTemplate.getForEntity(service, String.class)
          .getBody();
    }
    
    @GetMapping("/ping")
    public String ping() {
        return "pong";
    }
    

_"myApp/ping"_ è·¯å¾„æ˜¯å¸¦æœ‰æœåŠ¡ç«¯ç‚¹çš„ Spring åº”ç”¨ç¨‹åºåç§°ã€‚ Consul å°†æä¾›æ‰€æœ‰å¯ç”¨çš„åä¸º _"myApp"._ çš„åº”ç”¨ç¨‹åº

**4 å¥åº·æ£€æŸ¥**
----------

Consul ä¼šå®šæœŸæ£€æŸ¥æœåŠ¡ç«¯ç‚¹çš„å¥åº·çŠ¶å†µã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œ\*\*Spring å®ç°å¥åº·ç«¯ç‚¹ä»¥åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶è¿”å› _200 OK_ \*\*ã€‚å¦‚æœæˆ‘ä»¬æƒ³è‡ªå®šä¹‰ç«¯ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»æ›´æ–° _application.yml:_

    spring:
      cloud:
        consul:
          discovery:
            healthCheckPath: /my-health-check
            healthCheckInterval: 20s
    

å› æ­¤ï¼ŒConsul å°†æ¯ 20 ç§’è½®è¯¢ä¸€æ¬¡ _"/my-health-check"_ ç«¯ç‚¹ã€‚

è®©æˆ‘ä»¬å®šä¹‰æˆ‘ä»¬çš„è‡ªå®šä¹‰å¥åº·æ£€æŸ¥æœåŠ¡ä»¥è¿”å› _FORBIDDEN_ çŠ¶æ€ï¼š

    @GetMapping("/my-health-check")
    public ResponseEntity<String> myCustomCheck() {
        String message = "Testing my healh check function";
        return new ResponseEntity<>(message, HttpStatus.FORBIDDEN);
    }
    

å¦‚æœæˆ‘ä»¬è®¿é—® Consul ä»£ç†ç«™ç‚¹ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå¤±è´¥äº†ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œ_"/my-health-check"_ æœåŠ¡åº”è¿”å› HTTP _200 OK_ çŠ¶æ€ä»£ç ã€‚

**5 åˆ†å¸ƒå¼é…ç½®**
-----------

æ­¤åŠŸèƒ½**å…è®¸åœ¨æ‰€æœ‰æœåŠ¡ä¹‹é—´åŒæ­¥é…ç½®**ã€‚ Consul å°†ç›‘è§†ä»»ä½•é…ç½®æ›´æ”¹ï¼Œç„¶åè§¦å‘æ‰€æœ‰æœåŠ¡çš„æ›´æ–°ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ [spring-cloud-starter-consul-config](https://search.maven.org/classic/#search%7Cga%7C1%7Ca%3A%22spring-cloud-starter-consul-config%22) çš„ _pom.xml_ çš„ä¾èµ–ï¼š

    <dependence>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-consul-config</artifactId>
        <version>3.1.1</version>
    </dependence>
    

æˆ‘ä»¬è¿˜éœ€è¦å°† Consul å’Œ Spring åº”ç”¨ç¨‹åºåç§°çš„è®¾ç½®ä» _application.yml_ æ–‡ä»¶ç§»åŠ¨åˆ° Spring é¦–å…ˆåŠ è½½çš„ _bootstrap.yml_ æ–‡ä»¶ä¸­ã€‚

ç„¶åï¼Œæˆ‘ä»¬éœ€è¦å¯ç”¨ Spring Cloud Consul Configï¼š

    spring:
      application:
        name: myApp
      cloud:
        consul:
          host: localhost
          port: 8500
          config:
            enabled: true
    

Spring Cloud Consul Config å°†åœ¨ Consul ä¸­çš„ _"/config/myApp"_ ä¸­æŸ¥æ‰¾å±æ€§ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªåä¸º _"my.prop"_ çš„å±æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ Consul ä»£ç†ç«™ç‚¹ä¸­åˆ›å»ºæ­¤å±æ€§ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡è½¬åˆ° _"KEY/VALUE"_ éƒ¨åˆ†æ¥åˆ›å»ºå±æ€§ï¼Œç„¶ååœ¨ _"Create Key"_ è¡¨å•ä¸­è¾“å…¥ _"/config/myApp/my/prop"_ å’Œ _"Hello World"_ ä½œä¸ºå€¼.æœ€åï¼Œå•å‡»_â€œåˆ›å»ºâ€_ æŒ‰é’®ã€‚

è¯·è®°ä½ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Spring é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†é…ç½®æ–‡ä»¶é™„åŠ åˆ° Spring åº”ç”¨ç¨‹åºåç§°æ—è¾¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ _dev_ é…ç½®æ–‡ä»¶ï¼ŒConsul ä¸­çš„æœ€ç»ˆè·¯å¾„å°†æ˜¯ _"/config/myApp,dev"._

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¸¦æœ‰æ³¨å…¥å±æ€§çš„æ§åˆ¶å™¨æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼š

    @RestController
    public class DistributedPropertiesController {
    
        @Value("${my.prop}")
        String value;
    
        @Autowired
        private MyProperties properties;
    
        @GetMapping("/getConfigFromValue")
        public String getConfigFromValue() {
            return value;
        }
    
        @GetMapping("/getConfigFromProperty")
        public String getConfigFromProperty() {
            return properties.getProp();
        }
    }
    

å’Œ _MyProperties_ ç±»ï¼š

    @RefreshScope
    @Configuration
    @ConfigurationProperties("my")
    public class MyProperties {
        private String prop;
    
        // standard getter, setter
    }
    

å¦‚æœæˆ‘ä»¬è¿è¡Œåº”ç”¨ç¨‹åºï¼Œå­—æ®µ _value_ å’Œ _properties_ å…·æœ‰æ¥è‡ª Consul çš„ç›¸åŒ _"Hello World"_ å€¼ã€‚

### **5.1 æ›´æ–°é…ç½®**

åœ¨ä¸é‡å¯ Spring Boot åº”ç”¨ç¨‹åºçš„æƒ…å†µä¸‹æ›´æ–°é…ç½®æ€ä¹ˆåŠï¼Ÿ

å¦‚æœæˆ‘ä»¬å›åˆ° Consul ä»£ç†ç«™ç‚¹å¹¶ç”¨å¦ä¸€ä¸ªå€¼æ›´æ–°å±æ€§ _"/config/myApp/my/prop"_ ï¼Œä¾‹å¦‚ _"New Hello World"_ ï¼Œé‚£ä¹ˆå­—æ®µ _value_ ä¸ä¼šæ”¹å˜å¹¶ä¸”å­—æ®µ_properties_ å°†æŒ‰é¢„æœŸæ›´æ–°ä¸º _"New Hello World"_ã€‚

è¿™æ˜¯å› ä¸ºå­—æ®µ _properties_ æ˜¯ _MyProperties_ ç±»å…·æœ‰ _@RefreshScope_ æ³¨é‡Šã€‚ **æ‰€æœ‰å¸¦æœ‰ _@RefreshScope_ æ³¨é‡Šçš„ bean éƒ½å°†åœ¨é…ç½®æ›´æ”¹ååˆ·æ–°ã€‚**

åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç›´æ¥åœ¨ Consul ä¸­æ‹¥æœ‰è¿™äº›å±æ€§ï¼Œè€Œæ˜¯åº”è¯¥å°†å®ƒä»¬æŒä¹…åœ°å­˜å‚¨åœ¨æŸä¸ªåœ°æ–¹ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Config Server](https://www.baeldung.com/spring-cloud-configuration) æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

**6 ç»“è®º**
--------

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†å¦‚ä½•è®¾ç½® Spring Boot åº”ç”¨ç¨‹åºä»¥ä¸ Consul ä¸€èµ·å·¥ä½œä»¥å®ç°æœåŠ¡å‘ç°ã€è‡ªå®šä¹‰å¥åº·æ£€æŸ¥è§„åˆ™å¹¶å…±äº«åˆ†å¸ƒå¼é…ç½®ã€‚

æˆ‘ä»¬è¿˜ä¸ºå®¢æˆ·ç«¯å¼•å…¥äº†è®¸å¤šæ–¹æ³•æ¥è°ƒç”¨è¿™äº›æ³¨å†Œçš„æœåŠ¡ã€‚

åƒå¾€å¸¸ä¸€æ ·ï¼Œå¯ä»¥[åœ¨ GitHub ä¸Š](https://github.com/eugenp/tutorials/tree/master/spring-cloud-modules/spring-cloud-consul) æ‰¾åˆ°æºä»£ç ã€‚