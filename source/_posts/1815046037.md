---
layout: post
title: "Grafana ç³»åˆ—æ–‡ç« ï¼ˆåäº”ï¼‰ï¼šExemplars"
date: "2023-02-12T13:20:03.893Z"
---
Grafana ç³»åˆ—æ–‡ç« ï¼ˆåäº”ï¼‰ï¼šExemplars
==========================

Exemplars ç®€ä»‹
------------

Exemplar æ˜¯ç”¨ä¸€ä¸ªç‰¹å®šçš„ traceï¼Œä»£è¡¨åœ¨ç»™å®šæ—¶é—´é—´éš”å†…çš„åº¦é‡ã€‚Metrics æ“…é•¿ç»™ä½ ä¸€ä¸ªç³»ç»Ÿçš„ç»¼åˆè§†å›¾ï¼Œè€Œ traces ç»™ä½ ä¸€ä¸ªå•ä¸€è¯·æ±‚çš„ç»†ç²’åº¦è§†å›¾ï¼›Exemplar æ˜¯è¿æ¥è¿™ä¸¤è€…çš„ä¸€ç§æ–¹å¼ã€‚

å‡è®¾ä½ çš„å…¬å¸ç½‘ç«™æ­£ç»å†ç€æµé‡çš„æ¿€å¢ã€‚è™½ç„¶è¶…è¿‡ç™¾åˆ†ä¹‹å…«åçš„ç”¨æˆ·èƒ½å¤Ÿåœ¨ä¸¤ç§’å†…è®¿é—®ç½‘ç«™ï¼Œä½†æœ‰äº›ç”¨æˆ·çš„å“åº”æ—¶é—´è¶…è¿‡äº†æ­£å¸¸æ°´å¹³ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä½³ã€‚

ä¸ºäº†ç¡®å®šé€ æˆå»¶è¿Ÿçš„å› ç´ ï¼Œä½ å¿…é¡»å°†å¿«é€Ÿå“åº”çš„ trace ä¸ç¼“æ…¢å“åº”çš„ trace è¿›è¡Œæ¯”è¾ƒã€‚é‰´äºå…¸å‹ç”Ÿäº§ç¯å¢ƒä¸­çš„å¤§é‡æ•°æ®ï¼Œè¿™å°†æ˜¯éå¸¸è´¹åŠ›å’Œè€—æ—¶çš„å·¥ä½œã€‚

ä½¿ç”¨ Exemplar æ¥å¸®åŠ©éš”ç¦»ä½ çš„æ•°æ®åˆ†å¸ƒä¸­çš„é—®é¢˜ï¼Œæ–¹æ³•æ˜¯åœ¨ä¸€ä¸ªæ—¶é—´é—´éš”å†…æ‰¾å‡ºè¡¨ç°å‡ºé«˜å»¶è¿Ÿçš„æŸ¥è¯¢ç—•è¿¹ã€‚ä¸€æ—¦ä½ æŠŠå»¶è¿Ÿé—®é¢˜å®šä½åˆ°å‡ ä¸ªç¤ºèŒƒè·Ÿè¸ªï¼Œä½ å°±å¯ä»¥æŠŠå®ƒä¸å…¶ä»–åŸºäºç³»ç»Ÿçš„ä¿¡æ¯æˆ–ä½ç½®å±æ€§ç»“åˆèµ·æ¥ï¼Œæ›´å¿«åœ°è¿›è¡Œæ ¹æœ¬åŸå› åˆ†æï¼Œä»è€Œå¿«é€Ÿè§£å†³æ€§èƒ½é—®é¢˜ã€‚

å¯¹ Exemplar çš„æ”¯æŒ**ä»…é€‚ç”¨äº Prometheus**æ•°æ®æºã€‚ä¸€æ—¦ä½ å¯ç”¨è¯¥åŠŸèƒ½ï¼ŒExemplar æ•°æ®é»˜è®¤æ˜¯å¯ç”¨çš„ã€‚

Grafana åœ¨ "Explore" è§†å›¾å’Œä»ªè¡¨ç›˜ä¸­ä¸æŒ‡æ ‡ä¸€èµ·æ˜¾ç¤º Exemplar ã€‚æ¯ä¸ª Exemplar æ˜¾ç¤ºä¸ºé«˜äº®çš„æ˜Ÿæ˜Ÿã€‚ä½ å¯ä»¥å°†å…‰æ ‡æ‚¬åœåœ¨ Exemplar ä¸Šï¼ŒæŸ¥çœ‹å”¯ä¸€çš„ traceIDï¼Œå®ƒæ˜¯ä¸€ä¸ªé”®å€¼å¯¹çš„ç»„åˆã€‚è¦è¿›ä¸€æ­¥åˆ†æï¼Œè¯·ç‚¹å‡» "traceID "å±æ€§æ—è¾¹çš„è“è‰²æŒ‰é’®ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

![æˆªå›¾æ˜¾ç¤ºäº†ä¸€ä¸ª exemplar çš„è¯¦ç»†çª—å£](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111924841-1335145479.png)

èƒŒæ™¯
--

Exemplars æ˜¯æœ€è¿‘å¯è§‚å¯Ÿæ€§é¢†åŸŸçš„ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œè¿™æ˜¯æœ‰åŸå› çš„ã€‚

ä¸ [Prometheus](https://grafana.com/oss/prometheus/) å¦‚ä½•åœ¨ 2012 å¹´å¼€å§‹ç ´è€Œåç«‹äº†å¤§è§„æ¨¡å­˜å‚¨æŒ‡æ ‡çš„æˆæœ¬ç»“æ„ï¼Œå¹¶åœ¨ 2015 å¹´çœŸæ­£å®ç°ï¼Œä»¥åŠ [Grafana Loki](https://grafana.com/oss/loki/) å¦‚ä½•åœ¨ 2018 å¹´ç ´è€Œåç«‹äº†å¤§è§„æ¨¡å­˜å‚¨æ—¥å¿—çš„æˆæœ¬ç»“æ„ç±»ä¼¼ï¼ŒExemplar ä¹Ÿåœ¨å¯¹ trace åšåŒæ ·çš„äº‹æƒ…ã€‚ä¸ºäº†äº†è§£åŸå› ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹äº‘åŸç”Ÿç”Ÿæ€ç³»ç»Ÿä¸­å¯è§‚å¯Ÿæ€§çš„å†å²ï¼Œä»¥åŠ Exemplar èƒ½å¤Ÿå®ç°å“ªäº›ä¼˜åŒ–ã€‚

æ ¸å¿ƒæ˜¯ï¼ŒExemplar æ˜¯ä¸€ç§é€šè¿‡ ID ä»æœ‰æ„ä¹‰çš„æŒ‡æ ‡å’Œæ—¥å¿—è·³åˆ°è¿½è¸ªçš„æ–¹å¼ã€‚[Grafana Tempo](https://grafana.com/oss/tempo/)ï¼ŒGrafana Labs çš„ [å¼€æºã€å¤§è§„æ¨¡åˆ†å¸ƒå¼è·Ÿè¸ªåç«¯](https://grafana.com/blog/2020/10/27/announcing-grafana-tempo-a-massively-scalable-distributed-tracing-system/)ï¼Œå°±æ˜¯å›´ç»•è¿™ä¸ªæƒ³æ³•å»ºç«‹çš„ï¼Œå› ä¸º Exemplar ä½¿åˆ†å¸ƒå¼è·Ÿè¸ªçš„æˆæœ¬å’Œæ€§èƒ½ç‰¹å¾å˜å¾—å¥½äº†ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä½ æ°¸è¿œä¸éœ€è¦å¯¹ä½ çš„è¿½è¸ªè¿›è¡Œé‡‡æ ·ï¼Œè€Œ Tempo è®©è¿™æˆä¸ºç°å®ã€‚

### Prometheus

æš‚æ—¶å¿½ç•¥ Prometheus å‡ºè‰²çš„å¯æ‰©å±•æ€§ã€å‹ç¼©æ€§å’Œæ€§èƒ½ï¼Œè®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›æ”¾åœ¨æ ‡ç­¾é›†ä¸Šã€‚å®ƒä»¬æ˜¯å…³äºä½ çš„æ—¶é—´åºåˆ—çš„å…ƒæ•°æ®ã€‚æ˜¯ä»€ä¹ˆé›†ç¾¤ã€ä»€ä¹ˆæœåŠ¡ã€å“ªä¸ªå®¢æˆ·ã€ä»€ä¹ˆéƒ¨ç½²çº§åˆ«ç­‰ç­‰éƒ½å¯ä»¥ç”¨éå±‚æ¬¡çš„é”®å€¼å¯¹æ¥ç¼–ç ã€‚å¦‚æœä½ æ­£åœ¨è¯»è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å¾ˆå¯èƒ½ä¸éœ€è¦è¯´æœä½ è¿™ä¸ªè¡Œä¸šçš„å˜åŒ–æœ‰å¤šå¤§çš„é¢ è¦†æ€§ã€å½±å“åŠ›å’ŒæŒä¹…æ€§ï¼›æˆ‘åªæ˜¯æƒ³æé†’ä½ ï¼Œå› ä¸ºå®ƒä¸æ–‡æœ¬çš„å…¶ä½™éƒ¨åˆ†æœ‰å…³ã€‚

è¿™åœ¨å‡ å¹´å‰æ˜¯é©å‘½æ€§çš„ï¼š

    acme_http_router_request_seconds_sum{path="/api/v1",method="GET"} 9036.32
    acme_http_router_request_seconds_count{path="/api/v1",method="GET"} 807283.0
    acme_http_router_request_seconds_sum{path="/api/v2",method="POST"} 479.3
    acme_http_router_request_seconds_count{path="/api/v2",method="POST"} 34.0
    

### OpenMetrics

æ—©åœ¨ 2015-2016 å¹´ï¼Œç›¸å…³å¼€å‘è€…å°±è®¡åˆ’åŒæ ·çš„æ ‡ç­¾é›†ä¹Ÿåº”ç”¨äºæ—¥å¿—å’Œè¿½è¸ªã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ [OpenMetrics](https://openmetrics.io/) è‡ª 2017 å¹´ä»¥æ¥ä¸€ç›´å¤„åœ¨ä¸€ä¸ªå«åš [OpenObservability](https://github.com/OpenObservability) çš„ GitHub ç»„ç»‡ä¸­ï¼Œè€Œä¸æ˜¯ "ä»…ä»… "ä¸€ä¸ªå«åš OpenMetrics çš„ç»„ç»‡ã€‚

### Grafana Loki

æœ‰äº† Lokiï¼Œè¿™ä¸ªæ¢¦æƒ³åœ¨ 2018 å¹´å®ç°äº†ã€‚åœ¨ä½ çš„æŒ‡æ ‡å’Œæ—¥å¿—ä¹‹é—´æ— ç¼ç§»åŠ¨ï¼Œæ²¡æœ‰é—®é¢˜ã€‚è¿™å°±æ˜¯ "Like Prometheus but for logs"çš„æ ‡è¯­çš„ç”±æ¥ã€‚

è¿™è®©æˆ‘ä»¬ä¸å¾—ä¸å°†æ ‡ç­¾é›†åº”ç”¨äº traceï¼Œå¯¹å—ï¼Ÿ

### OpenMetrics & OpenCensus

2017 å¹´ï¼ŒOpenMetrics å’Œ OpenCensus å¼€ä¼šï¼Œè¯•å›¾çœ‹çœ‹è¿™ä¸¤ä¸ªé¡¹ç›®æ˜¯å¦å¯ä»¥åˆå¹¶ã€‚è™½ç„¶ç”±äºè®¾è®¡ç›®æ ‡ã€è¿è¥æ¨¡å¼å’Œæ•°æ®æ¨¡å‹çš„ä¸å…¼å®¹è€Œæ²¡æœ‰æˆåŠŸï¼Œä½†è¿™æ¬¡ä¼šè®®è¿˜æ˜¯æ”¹å˜äº† OpenMetrics å’Œ Prometheus çš„å‘½è¿ï¼Œä¹Ÿæ˜¯å¼•å‡ºäº† Grafana Tempo çš„æ ¸å¿ƒè®¾è®¡ã€‚

Exemplars è®¾è®¡æ€è·¯
--------------

æœ¬è´¨ä¸Šï¼ŒExemplar å°±æ˜¯ä»¥ä¸‹ä¸‰ä¸ªæƒ³æ³•ï¼š

1.  å°† trace ä¸å…¶ä»–å¯è§‚å¯Ÿæ€§æ•°æ®ç´§å¯†ç»“åˆã€‚
2.  åªé€šè¿‡ ID è·³å…¥ traceã€‚
3.  åªæœ‰å½“ä½ çŸ¥é“å¯¹å“ªä¸ª trace æ„Ÿå…´è¶£ï¼Œä»¥åŠä¸ºä»€ä¹ˆæ„Ÿå…´è¶£çš„æ—¶å€™ï¼Œæ‰è·³å…¥è¯¥ traceã€‚é¿å… "é¢‘ç¹è·³å…¥è·³å‡º"ã€‚

### ç´§å¯†ç»“åˆ

é€šè¿‡ exemplars å°† trace ID é™„åŠ åˆ°æŒ‡æ ‡ä¸Šæ˜¯éå¸¸ç®€å•çš„ã€‚åœ¨ä½ çš„åº¦é‡å€¼ï¼ˆå¯èƒ½è¿˜æœ‰æ—¶é—´æˆ³ï¼‰åé¢åŠ ä¸€ä¸ª "#"ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ª exemplars å­˜åœ¨ï¼Œç„¶åæ·»åŠ ä½ çš„æ•°æ®ã€‚

å€Ÿç”¨ [OpenMetrics è§„èŒƒ](https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#exemplars-1) ä¸­çš„ä¾‹å­ï¼š

    # TYPE foo histogram
    foo_bucket{le="0.01"} 0
    foo_bucket{le="0.1"} 8 # {} 0.054
    foo_bucket{le="1"} 11 # {trace_id="KOO5S4vxi0o"} 0.67
    foo_bucket{le="10"} 17 # {trace_id="oHg5SJYRHA0"} 9.8 1520879607.789
    foo_bucket{le="+Inf"} 17
    foo_count 17
    foo_sum 324789.3
    foo_created  1520430000.123
    

å¦‚æœ`trace_id`æ ‡ç­¾çš„åç§°å’Œå€¼è®©ä½ æƒ³èµ· [W3C åˆ†å¸ƒå¼è·Ÿè¸ªå·¥ä½œç»„](https://www.w3.org/2018/distributed-tracing/) æå‡ºçš„è§„èŒƒï¼Œé‚£å°±ä¸æ˜¯å·§åˆäº†ã€‚æˆ‘ä»¬ç‰¹æ„é‡‡çº³äº† W3C çš„è§„èŒƒï¼ŒåŒæ—¶æ²¡æœ‰å¼ºåˆ¶è¦æ±‚å®ƒã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ç°æœ‰çš„è§„èŒƒå·¥ä½œçš„åŸºç¡€ä¸Šï¼ŒåŒæ—¶åœ¨åˆ†å¸ƒå¼è·Ÿè¸ªé¢†åŸŸç¨³å®šä¸‹æ¥ä¹‹å‰ä¸æŠŠ OpenMetrics æ†ç»‘èµ·æ¥ã€‚

è®©æˆ‘ä»¬çœ‹çœ‹é‡Œé¢çš„å®é™…èŒƒä¾‹ï¼š

æ˜¾ç¤ºå»¶è¿Ÿå°äº 1 ç§’çš„ç›´æ–¹å›¾æ¡¶æœ‰ä¸€ä¸ªè¿è¡Œæ—¶é—´ä¸º 0.67 ç§’ã€ID ä¸º`KOO5S4vxi0o`çš„ traceã€‚

æ˜¾ç¤º 10 ç§’ä»¥ä¸‹å»¶è¿Ÿçš„ç›´æ–¹å›¾æ¡¶æœ‰ä¸€ä¸ªè¿è¡Œæ—¶é—´ä¸º 9.8 ç§’çš„ traceï¼Œæ—¶é—´ä¸º`1520879607.789`ï¼ŒID ä¸º`oHg5SJYRHA0`ã€‚

å°±æ˜¯è¿™æ ·ï¼

### ä»…é™ ID

ç´¢å¼•æ˜¯æ˜‚è´µçš„ã€‚æŠŠå®Œæ•´çš„ä¸Šä¸‹æ–‡å’Œå…ƒæ•°æ®æ”¾åœ¨ trace ä¸Šæ„å‘³ç€ä½ éœ€è¦é€šè¿‡å®ƒä»¬æ¥æœç´¢ traceï¼Œè¿™å°±æ„å‘³ç€å¯¹å®ƒä»¬è¿›è¡Œç´¢å¼•ã€‚ä½†æ˜¯ä½ æƒ³åœ¨ä½ çš„æŒ‡æ ‡ã€æ—¥å¿—å’Œ traceï¼ˆä»¥åŠ [conprof](https://github.com/conprof/conprof)ã€crashdumps ç­‰ï¼‰ä¸Šæœ‰ç›¸åŒçš„æ ‡ç­¾ã€‚ä½†æ˜¯ï¼Œç”±äºä½ åœ¨å…¶ä»–æ•°æ®ä¸Šå·²ç»æœ‰äº†è¿™äº›å…ƒæ•°æ®ï¼Œé‡ç”¨ç›¸åŒçš„ç´¢å¼•ä»¥èŠ‚çœæˆæœ¬å’Œæ—¶é—´å¦‚ä½•ï¼Ÿ

é€šè¿‡åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´ç‚¹ä¸Šå°† trace é™„åœ¨ä¸€ä¸ªç‰¹å®šçš„æ—¶é—´åºåˆ—æˆ–æ—¥å¿—ä¸Šï¼Œä½ å°±å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚å¯¹äº trace æœ¬èº«ï¼Œä½ åªéœ€å¯¹ ID è¿›è¡Œç´¢å¼•ï¼Œå°±å¯ä»¥äº†ã€‚

### ä»…é™æ„Ÿå…´è¶£çš„ traces

è‡ªåŠ¨è·Ÿè¸ªåˆ†ææ˜¯ä¸€ä¸ªå¹¿æ³›çš„é¢†åŸŸï¼›å¤§é‡ç²¾æ¹›çš„å·¥ç¨‹åŠ›é‡è¢«ç”¨äºä½¿è¿™ä¸ªå¹²è‰å †å¯è¢«æœç´¢ã€‚

å¦‚æœæœ‰ä¸€ä¸ªæ›´ä¾¿å®œã€æ›´æœ‰æ•ˆçš„æ–¹æ³•å‘¢ï¼Ÿ

æ—¥å¿—å·²ç»å¯ä»¥å‘Šè¯‰ä½ ä¸€ä¸ªé”™è¯¯çŠ¶æ€æˆ–ç±»ä¼¼çš„æƒ…å†µã€‚ä½ ä¸éœ€è¦åˆ†æ trace æ¥æ‰¾åˆ°é‚£ä¸ªé”™è¯¯ã€‚

æŒ‡æ ‡ä¸­çš„è®¡æ•°å™¨ã€ç›´æ–¹å›¾ç­‰å·²ç»æ˜¯ä¸€ç§é«˜åº¦æµ“ç¼©å’Œä¼˜åŒ–çš„æ•°æ®å½¢å¼ï¼Œè¢«æç‚¼æˆåœ¨è¿™ç§æƒ…å†µä¸‹é‡è¦çš„ä¸œè¥¿ã€‚ä½ ä¸éœ€è¦åˆ†ææ‰€æœ‰çš„ trace æ¥æ‰¾åˆ°é‚£ä¸ªæ˜¾ç¤ºé«˜å»¶è¿Ÿçš„ traceã€‚

ä½ çš„æ—¥å¿—å’Œä½ çš„æŒ‡æ ‡å·²ç»å‘Šè¯‰ä½ _ä¸ºä»€ä¹ˆ_ä¸€ä¸ª trace æ˜¯éœ€è¦æ·±å…¥è°ƒæŸ¥çš„ã€‚ä½ çš„æ ‡ç­¾ç»™äº†ä½ å¦‚ä½•å’Œåœ¨å“ªé‡Œäº§ç”Ÿ trace çš„èƒŒæ™¯ã€‚åœ¨è·³å…¥ trace çš„æ—¶å€™ï¼Œä½ å·²ç»çŸ¥é“ä½ åœ¨å¯»æ‰¾ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆã€‚è¿™å°±å¤§å¤§åŠ å¿«äº†å‘ç°çš„é€Ÿåº¦ã€‚

Prometheus å¯ç”¨ Exemplar storage Feature
--------------------------------------

> ğŸ“šï¸ **Reference:**  
> [Exemplars storage | Prometheus Doc](https://prometheus.io/docs/prometheus/latest/feature_flags/#exemplars-storage)

    --enable-feature=exemplar-storage
    

[OpenMetrics](https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#exemplars) ä»‹ç»äº†åˆ®å‰Šç›®æ ‡ä¸ºæŸäº›åº¦é‡æ ‡å‡†æ·»åŠ  Exemplars çš„èƒ½åŠ›ã€‚å…¸å‹åº”ç”¨åœºæ™¯æ˜¯å¯¹ MetricSet ä¹‹å¤–çš„æ•°æ®çš„å¼•ç”¨ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨ä¾‹æ˜¯ trace IDã€‚

Exemplar å­˜å‚¨æ˜¯ä½œä¸ºä¸€ä¸ªå›ºå®šå¤§å°çš„åœ†å½¢ç¼“å†²åŒºå®ç°çš„ï¼Œå®ƒå°†æ‰€æœ‰ç³»åˆ—çš„ exemplar å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚å¯ç”¨æ­¤åŠŸèƒ½å°†ä½¿ Prometheus åˆ®å‰Šæ¥çš„ exemplar çš„å­˜å‚¨æˆä¸ºå¯èƒ½ã€‚é…ç½®æ–‡ä»¶å— [storage](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#configuration-file)/[exemplars](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#exemplars) å¯ä»¥ç”¨æ¥æ§åˆ¶å¾ªç¯ç¼“å†²åŒºçš„å¤§å°ã€‚ä¸€ä¸ªåªæœ‰`traceID=<jaeger-trace-id>`çš„ exemplar é€šè¿‡å†…å­˜ä¸­çš„ exemplar å­˜å‚¨å¤§çº¦ä½¿ç”¨ 100 å­—èŠ‚çš„å†…å­˜ã€‚å¦‚æœ exemplar å­˜å‚¨è¢«å¯ç”¨ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°† exemplar è¿½åŠ åˆ° WAL ä¸­è¿›è¡Œæœ¬åœ°æŒä¹…åŒ–ï¼ˆåœ¨ WAL æŒç»­æ—¶é—´å†…ï¼‰ã€‚

åœ¨ Prometheus æ•°æ®æºä¸­é…ç½® Exemplar
----------------------------

> ğŸ“šï¸ **Reference:**
> 
> æœ‰å…³ Exemplar é…ç½®å’Œå¦‚ä½•å¯ç”¨ Exemplar çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… [åœ¨ Prometheus æ•°æ®æºä¸­é…ç½® Exemplar](https://grafana.com/docs/grafana/latest/datasources/prometheus/#configuring-exemplars)

> ğŸ“ **Notes:**
> 
> è¯¥åŠŸèƒ½åœ¨ Prometheus 2.26+ å’Œ Grafana 7.4+ ä¸Šå¯ç”¨ã€‚

Grafana 7.4 åŠä»¥åçš„ç‰ˆæœ¬èƒ½å¤Ÿåœ¨ Explore å’Œä»ªè¡¨ç›˜ä¸­æ˜¾ç¤ºä¸æŒ‡æ ‡ç›¸å…³çš„ Exemplar æ•°æ®ã€‚Exemplar æ•°æ®æ˜¯ä¸€ç§å°†ç‰¹å®šäº‹ä»¶ä¸­çš„é«˜æƒé‡å…ƒæ•°æ®ä¸ä¼ ç»Ÿæ—¶é—´åºåˆ—æ•°æ®è”ç³»èµ·æ¥çš„æ–¹å¼ã€‚

é€šè¿‡æ·»åŠ å¤–éƒ¨æˆ–å†…éƒ¨é“¾æ¥ï¼Œåœ¨æ•°æ®æºè®¾ç½®ä¸­é…ç½® Exemplarsã€‚

![Exemplars é…ç½®æˆªå›¾](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111925051-1460183039.png)

æŸ¥çœ‹ Exemplar æ•°æ®
--------------

> ğŸ“šï¸ **Reference:**
> 
> è¯·å‚è€ƒ [æŸ¥çœ‹ exemplar æ•°æ®](https://grafana.com/docs/grafana/latest/basics/exemplars/view-exemplars/), äº†è§£å¦‚ä½•ä»æŒ‡æ ‡å’Œæ—¥å¿—ä¸­é’»å–å’ŒæŸ¥çœ‹ Exemplar trace ç»†èŠ‚ã€‚

å½“ prometheus æ•°æ®æºå¯ç”¨å¯¹ exemplar æ”¯æŒæ—¶ï¼Œä½ å¯ä»¥åœ¨ Explore è§†å›¾æˆ–ä» Loki æ—¥å¿—ç»†èŠ‚ä¸­æŸ¥çœ‹ exemplar æ•°æ®ã€‚

### Explore

Explore å°† exemplar çš„è·Ÿè¸ªæ•°æ®å¯è§†åŒ–ä¸ºé«˜äº®çš„æ˜Ÿæ˜Ÿå’ŒæŒ‡æ ‡æ•°æ®ã€‚å…³äº Explore å¦‚ä½•å°†è·Ÿè¸ªæ•°æ®å¯è§†åŒ–çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ [Explore ä¸­çš„è·Ÿè¸ª](https://grafana.com/docs/grafana/latest/explore/trace-integration/)ã€‚

è¦æ£€æŸ¥ exemplar è·Ÿè¸ªçš„ç»†èŠ‚ã€‚

1.  å°†ä½ çš„å…‰æ ‡æ”¾åœ¨ä¸€ä¸ª exemplar ï¼ˆçªå‡ºæ˜¾ç¤ºçš„æ˜Ÿæ˜Ÿï¼‰ä¸Šã€‚æ ¹æ®ä½ çš„åç«¯ trace æ•°æ®æºï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªè“è‰²çš„æŒ‰é’®ï¼Œæ ‡ç­¾æ˜¯ `Query with <DataSource Name>`ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼ŒTrace çš„æ•°æ®æºæ˜¯ Tempoã€‚
    
    ![æ˜¾ç¤º Exemplar details çš„æˆªå›¾](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111925316-1421416223.png)
    
2.  ç‚¹å‡» traceID å±æ€§æ—è¾¹çš„ Query with Tempo é€‰é¡¹ã€‚Trace çš„ç»†èŠ‚ï¼ŒåŒ…æ‹¬ trace ä¸­çš„ span éƒ½åˆ—åœ¨å³è¾¹çš„ç‹¬ç«‹é¢æ¿ä¸­ã€‚
    
    ![å¸¦æœ‰æ˜¾ç¤º trace ç»†èŠ‚é¢æ¿çš„ Explore è§†å›¾](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111925641-1482485440.png)
    

### Logs

ä½ ä¹Ÿå¯ä»¥åœ¨ Explore ä¸­æŸ¥çœ‹ Loki æ—¥å¿—ä¸­çš„ exemplar è·Ÿè¸ªç»†èŠ‚ã€‚åœ¨ Loki çš„ Derived fields é“¾æ¥ä¸­ä½¿ç”¨ regex æ¥æå– traceID ä¿¡æ¯ã€‚ç°åœ¨å½“ä½ å±•å¼€ Loki æ—¥å¿—æ—¶ï¼Œä½ å¯ä»¥åœ¨**æ£€æµ‹å­—æ®µ**éƒ¨åˆ†çœ‹åˆ° traceID å±æ€§ã€‚è¦äº†è§£æ›´å¤šå…³äºå¦‚ä½•å°†æ—¥å¿—ä¿¡æ¯çš„ä¸€éƒ¨åˆ†æå–åˆ°å†…éƒ¨æˆ–å¤–éƒ¨é“¾æ¥ä¸­ï¼Œè¯·å‚è€ƒ [åœ¨ Loki ä¸­ä½¿ç”¨è¡ç”Ÿå­—æ®µ](https://grafana.com/docs/grafana/latest/explore/logs-integration/)ã€‚

è¦æŸ¥çœ‹ exemplar è·Ÿè¸ªçš„ç»†èŠ‚ï¼š

1.  å±•å¼€ä¸€ä¸ªæ—¥å¿—è¡Œï¼Œå‘ä¸‹æ»šåŠ¨åˆ° "æ£€æµ‹åˆ°çš„å­—æ®µ "éƒ¨åˆ†ã€‚æ ¹æ®ä½ çš„åç«¯è·Ÿè¸ªæ•°æ®æºï¼Œä½ ä¼šçœ‹åˆ°ä¸€ä¸ªè“è‰²çš„æŒ‰é’®ï¼Œæ ‡ç­¾æ˜¯`<æ•°æ®æºåç§°>`ã€‚
    
2.  ç‚¹å‡»`traceID`å±æ€§æ—è¾¹çš„è“è‰²æŒ‰é’®ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ƒå°†æœ‰åç«¯æ•°æ®æºçš„åç§°ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œè¿½è¸ªçš„æ•°æ®æºæ˜¯ Tempoã€‚è¿½è¸ªçš„ç»†èŠ‚ï¼ŒåŒ…æ‹¬è¿½è¸ªä¸­çš„ span éƒ½åˆ—åœ¨å³è¾¹çš„ç‹¬ç«‹é¢æ¿ä¸­ã€‚
    

![å¸¦æœ‰æ˜¾ç¤ºè·Ÿè¸ªç»†èŠ‚é¢æ¿çš„ Explore è§†å›¾](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111926123-1300649123.png)

æ€»ç»“
--

Exemplars å°±æ˜¯è¿™æ ·çš„ã€‚å·¥ç¨‹è®¾è®¡å§‹ç»ˆæ˜¯ä¸ºäº†é€‚åº”è®¾è®¡ç›®æ ‡å’Œçº¦æŸæ¡ä»¶è€Œè¿›è¡Œçš„æƒè¡¡ã€‚

Prometheus å°†æ•´ä¸ªè¡Œä¸šè½¬ç§»åˆ°ä¸€å¥—æ–°çš„æƒè¡¡æ ‡å‡†ï¼Œåˆ›é€ äº†äº‘åŸç”Ÿè§‚å¯Ÿèƒ½åŠ›çš„åŸºçŸ³ã€‚Grafana Loki ä¹Ÿåœ¨åšåŒæ ·çš„æ—¥å¿—å·¥ä½œã€‚Grafana Tempo æ­£åœ¨é€šè¿‡ exemplars çš„åŠ›é‡ä¸ºåˆ†å¸ƒå¼è¿½è¸ªåšè¿™ä»¶äº‹ã€‚

Tempo çš„å·¥ä½œæ˜¯å­˜å‚¨å¤§é‡çš„è·Ÿè¸ªï¼ŒæŠŠå®ƒä»¬æ”¾åœ¨å¯¹è±¡å­˜å‚¨ä¸­ï¼Œå¹¶é€šè¿‡ ID æ¥æ£€ç´¢å®ƒä»¬ã€‚ç”±äºæ‰€æœ‰è¿™äº›éƒ½éµå¾ªä¸€ä¸ªæ•´ä½“è®¾è®¡ï¼Œåœ¨æŒ‡æ ‡ã€æ—¥å¿—å’Œè¿½è¸ªä¹‹é—´çš„æ— ç¼ç§»åŠ¨å·²ç»æˆä¸ºå¯èƒ½ï¼Œè€Œä¸”æ˜¯çœŸæ­£çš„äº‘åŸç”Ÿè§„æ¨¡ã€‚

![Metrics logs  traces æ— ç¼ç§»åŠ¨çš„å…·ä½“è½¯ä»¶å®ç°](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111926397-1779041231.jpg)

![Metrics logs  traces æ— ç¼ç§»åŠ¨çš„å…·ä½“æŠ€æœ¯ç»†èŠ‚å®ç°](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230212111926685-1199988126.png)

Exemplars å·²ç» [ä» 7.4 å¼€å§‹åœ¨ Grafana ä¸­å¾—åˆ°æ”¯æŒ](https://grafana.com/blog/2021/02/04/grafana-7.4-released-next-generation-graph-panel-with-30-fps-live-streaming-prometheus-exemplar-support-trace-to-logs-and-more/)ã€‚

å‚è€ƒæ–‡æ¡£
----

*   [Exemplars ä»‹ç»ï¼Œå®ç° Grafana Tempo çš„å¤§è§„æ¨¡åˆ†å¸ƒå¼è¿½è¸ª](https://grafana.com/blog/2021/03/31/intro-to-exemplars-which-enable-grafana-tempos-distributed-tracing-at-massive-scale/)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.