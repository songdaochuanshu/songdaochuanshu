---
layout: post
title: "Qtæºç é˜…è¯»(ä¸‰) å¯¹è±¡æ ‘ç®¡ç†"
date: "2023-03-30T01:10:18.895Z"
---
Qtæºç é˜…è¯»(ä¸‰) å¯¹è±¡æ ‘ç®¡ç†
===============

å¯¹è±¡æ ‘ç®¡ç†
=====

> ä¸ªäººç»éªŒæ€»ç»“ï¼Œå¦‚æœ‰é”™è¯¯æˆ–é—æ¼ï¼Œæ¬¢è¿å„ä½å¤§ä½¬æŒ‡æ­£ ğŸ˜ƒ

@

ç›®å½•

*   [å¯¹è±¡æ ‘ç®¡ç†](#å¯¹è±¡æ ‘ç®¡ç†)
    *   [è®¾ç½®çˆ¶å¯¹è±¡çš„ä½œç”¨](#è®¾ç½®çˆ¶å¯¹è±¡çš„ä½œç”¨)
    *   [è®¾ç½®çˆ¶å¯¹è±¡(setParent)](#è®¾ç½®çˆ¶å¯¹è±¡setparent)
        *   [å®Œæ•´æºç ](#å®Œæ•´æºç )
        *   [ç‰‡æ®µåˆ†æ](#ç‰‡æ®µåˆ†æ)
    *   [å¯¹è±¡çš„åˆ é™¤](#å¯¹è±¡çš„åˆ é™¤)
    *   [å¤¹å¸¦ç§è´§æ—¶é—´](#å¤¹å¸¦ç§è´§æ—¶é—´)

è®¾ç½®çˆ¶å¯¹è±¡çš„ä½œç”¨
--------

ä¼—æ‰€å‘¨çŸ¥ï¼ŒQtä¸­ï¼Œæœ‰ä¸ºå¯¹è±¡è®¾ç½®çˆ¶å¯¹è±¡çš„æ–¹æ³•â€”â€”`setParent`ã€‚

è€Œè®¾ç½®çˆ¶å¯¹è±¡çš„ä½œç”¨ä¸»è¦æœ‰ï¼Œ**åœ¨çˆ¶å¯¹è±¡ææ„çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å»ææ„å…¶å­å¯¹è±¡ã€‚å¦‚æœæ˜¯ä¸€ä¸ªçª—å£å¯¹è±¡ï¼Œå¦‚æœå…¶çˆ¶å¯¹è±¡è®¾ç½®äº†æ ·å¼è¡¨(Style Sheet)ï¼Œå­å¯¹è±¡ä¹Ÿä¼šç»§æ‰¿çˆ¶å¯¹è±¡çš„æ ·å¼**ã€‚

æ‰€ä»¥ï¼Œè¿™ç¯‡æ–‡ç« ï¼Œå’±ä»¬ä¸»è¦çœ‹ä¸€ä¸‹`setParent`çš„æºç ä»¥åŠ`QObject`æ˜¯æ€ä¹ˆè¿›è¡Œå¯¹è±¡ç®¡ç†çš„ã€‚

è®¾ç½®çˆ¶å¯¹è±¡(setParent)
----------------

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`setParent`è¿™ä¸ªå‡½æ•°å°±æ˜¯è°ƒç”¨äº†`QObjectPrivate`ç±»çš„`setParent_helper`è¿™ä¸ªå‡½æ•°ã€‚

    void QObject::setParent(QObject *parent)
    {
        Q_D(QObject);
        Q_ASSERT(!d->isWidget);
        d->setParent_helper(parent);
    }
    

æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥åˆ†æ`setParent_helper`è¿™ä¸ªå‡½æ•°

### å®Œæ•´æºç 

    void QObjectPrivate::setParent_helper(QObject *o)
    {
        Q_Q(QObject);
    	// ä¸èƒ½æŠŠè‡ªå·±è®¾ä¸ºçˆ¶å¯¹è±¡
        Q_ASSERT_X(q != o, Q_FUNC_INFO, "Cannot parent a QObject to itself");
    #ifdef QT_DEBUG
    	// æ£€æŸ¥å¯¹è±¡æ ‘çš„å¾ªç¯
        const auto checkForParentChildLoops = qScopeGuard([&](){
            int depth = 0;
            auto p = parent;
            while (p) {
                if (++depth == CheckForParentChildLoopsWarnDepth) {
                    qWarning("QObject %p (class: '%s', object name: '%s') may have a loop in its parent-child chain; "
                             "this is undefined behavior",
                             q, q->metaObject()->className(), qPrintable(q->objectName()));
                }
                p = p->parent();
            }
        });
    #endif
    
    	// å¦‚æœè¦è®¾ç½®çš„çˆ¶å¯¹è±¡å°±æ˜¯å½“å‰çš„çˆ¶å¯¹è±¡ï¼Œç›´æ¥è¿”å›
        if (o == parent)
            return;
    
        if (parent) {
            QObjectPrivate *parentD = parent->d_func();
            if (parentD->isDeletingChildren && wasDeleted
                && parentD->currentChildBeingDeleted == q) {
                // don't do anything since QObjectPrivate::deleteChildren() already
                // cleared our entry in parentD->children.
            } else {
                const int index = parentD->children.indexOf(q);
                if (index < 0) {
                    // we're probably recursing into setParent() from a ChildRemoved event, don't do anything
                } else if (parentD->isDeletingChildren) {
                    parentD->children[index] = 0;
                } else {
    				// å¦‚æœå¯¹è±¡å·²ç»å­˜åœ¨çˆ¶å¯¹è±¡çš„åˆ—è¡¨ä¸­ï¼Œå°†åŸå…ˆå­˜åœ¨çš„å¯¹è±¡åˆ é™¤ï¼Œå¹¶å‘é€äº‹ä»¶
                    parentD->children.removeAt(index);
                    if (sendChildEvents && parentD->receiveChildEvents) {
                        QChildEvent e(QEvent::ChildRemoved, q);
                        QCoreApplication::sendEvent(parent, &e);
                    }
                }
            }
        }
    	// è®¾ç½®çˆ¶å¯¹è±¡
        parent = o;
        if (parent) {
            // object hierarchies are constrained to a single thread
            if (threadData != parent->d_func()->threadData) {
                qWarning("QObject::setParent: Cannot set parent, new parent is in a different thread");
                parent = nullptr;
                return;
            }
    		// çˆ¶å¯¹è±¡æ·»åŠ å­å¯¹è±¡ï¼Œå¹¶å‘é€äº‹ä»¶
            parent->d_func()->children.append(q);
            if(sendChildEvents && parent->d_func()->receiveChildEvents) {
                if (!isWidget) {
                    QChildEvent e(QEvent::ChildAdded, q);
                    QCoreApplication::sendEvent(parent, &e);
                }
            }
        }
        if (!wasDeleted && !isDeletingChildren && declarativeData && QAbstractDeclarativeData::parentChanged)
            QAbstractDeclarativeData::parentChanged(declarativeData, q, o);
    }
    

### ç‰‡æ®µåˆ†æ

1.  ä¸€äº›å…ˆå†³æ¡ä»¶çš„åˆ¤æ–­
    
    *   åˆ¤æ–­è®¾ç½®çš„çˆ¶å¯¹è±¡æ˜¯å¦æ˜¯è‡ªå·±
        
            	// ä¸èƒ½æŠŠè‡ªå·±è®¾ä¸ºçˆ¶å¯¹è±¡ 
            	Q_ASSERT_X(q != o, Q_FUNC_INFO, "Cannot parent a QObject to itself"); 
            	/*...*/ 
            	// å¦‚æœè¦è®¾ç½®çš„çˆ¶å¯¹è±¡å°±æ˜¯å½“å‰çš„çˆ¶å¯¹è±¡ï¼Œç›´æ¥è¿”å› 
            	if (o == parent)    return;
            
        
    *   åˆ¤æ–­åŸæ¥çš„çˆ¶å¯¹è±¡æ˜¯å¦å¤„äºæ­£åœ¨åˆ é™¤å­å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸”å½“å‰å¯¹è±¡å·²ç»è¢«åˆ é™¤äº†ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä»€ä¹ˆéƒ½ä¸åšï¼ˆæœ‰ç‚¹è¿·æƒ‘ï¼‰
        
            	if (parentD->isDeletingChildren && wasDeleted            
            		&& parentD->currentChildBeingDeleted == q) {
            	            // don't do anything since QObjectPrivate::deleteChildren() 
            	            //already  cleared our entry in parentD->children.
            	 }
            
        
    *   åˆ¤æ–­æ˜¯ä¸æ˜¯é€šè¿‡ä»`ChildRemoved`äº‹ä»¶é€’å½’åˆ°`setParent()`
        
            if (index < 0) {                
            	// we're probably recursing into setParent() from a ChildRemoved event,
            	// don't do anything 
            } else if (parentD->isDeletingChildren) {    
            	parentD->children[index] = 0; 
            }
            
        
    *   åˆ¤æ–­å¯¹è±¡æ˜¯ä¸æ˜¯å·²å­˜åœ¨çˆ¶å¯¹è±¡çš„åˆ—è¡¨ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±å°†å¯¹è±¡åˆ é™¤ï¼Œå¹¶å‘é€äº‹ä»¶
        
            else { 			
            // å¦‚æœå¯¹è±¡å·²ç»å­˜åœ¨çˆ¶å¯¹è±¡çš„åˆ—è¡¨ä¸­ï¼Œå°†åŸå…ˆå­˜åœ¨çš„å¯¹è±¡åˆ é™¤ï¼Œå¹¶å‘é€äº‹ä»¶                
            	parentD->children.removeAt(index);                
            	if (sendChildEvents && parentD->receiveChildEvents) {                    
            		QChildEvent e(QEvent::ChildRemoved, q);
            		QCoreApplication::sendEvent(parent, &e);                
            	}            
            }
            
        
2.  è®¾ç½®çˆ¶å¯¹è±¡ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶ï¼Œå°±æ˜¯**æ–°è®¾ç½®çš„çˆ¶å¯¹è±¡ï¼Œå¿…é¡»å’Œå½“å‰å¯¹è±¡åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™ä¸èƒ½è®¾ç½®**ã€‚
    
        // è®¾ç½®çˆ¶å¯¹è±¡
            parent = o;
            if (parent) {
                // object hierarchies are constrained to a single thread
                if (threadData != parent->d_func()->threadData) {
                    qWarning("QObject::setParent: Cannot set parent, \
                     new parent is in a different thread");
                    parent = nullptr;
                    return;
                }
        		// çˆ¶å¯¹è±¡æ·»åŠ å­å¯¹è±¡ï¼Œå¹¶å‘é€äº‹ä»¶
                parent->d_func()->children.append(q);
                if(sendChildEvents && parent->d_func()->receiveChildEvents) {
                    if (!isWidget) {
                        QChildEvent e(QEvent::ChildAdded, q);
                        QCoreApplication::sendEvent(parent, &e);
                    }
                }
            }
        
    

å¯¹è±¡çš„åˆ é™¤
-----

â€ƒâ€ƒç„¶åå°±æ˜¯å¯¹è±¡çš„ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯åœ¨**çˆ¶å¯¹è±¡ææ„çš„æ—¶å€™ï¼Œè‡ªåŠ¨ææ„æ‰æ‰€æœ‰çš„å­å¯¹è±¡**ã€‚è¿™ä¸€ä¸ªåœ¨æˆ‘ä»¬ä½¿ç”¨çª—å£éƒ¨ä»¶çš„æ—¶å€™å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºä¸€ä¸ªç•Œé¢å¯èƒ½æœ‰å¾ˆå¤šä¸ªå­æ§ä»¶ï¼Œæ¯”å¦‚æŒ‰é’®ã€labelç­‰ï¼Œè¿™æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªå°çª—å£è¢«å…³é—­ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦ä¸€ä¸ªä¸€ä¸ªçš„å»ææ„ï¼Œç”±Qtçš„å¯¹è±¡æ ‘å»è¿›è¡Œææ„å°±å¥½äº†ã€‚

    QObject::~QObject()
    {
       /*...*/
    
    	// åˆ é™¤å­å¯¹è±¡
        if (!d->children.isEmpty())
            d->deleteChildren();
    
    #if QT_VERSION < 0x60000
        qt_removeObject(this);
    #endif
        if (Q_UNLIKELY(qtHookData[QHooks::RemoveQObject]))
            reinterpret_cast<QHooks::RemoveQObjectCallback>(qtHookData[QHooks::RemoveQObject])(this);
    
        Q_TRACE(QObject_dtor, this);
    
        if (d->parent)        // remove it from parent object
            d->setParent_helper(nullptr);
    }
    

å°†æ‰€æœ‰çš„å­å¯¹è±¡è¿›è¡Œåˆ é™¤ï¼Œéå†å®¹å™¨ï¼Œ**æŒ‰ç…§å­å¯¹è±¡æ‰€åŠ å…¥è¿›æ¥çš„é¡ºåºè¿›è¡Œææ„**ã€‚

    void QObjectPrivate::deleteChildren()
    {
    	// æ¸…ç©ºå­å¯¹è±¡
        Q_ASSERT_X(!isDeletingChildren, "QObjectPrivate::deleteChildren()", "isDeletingChildren already set, did this function recurse?");
        isDeletingChildren = true;
        // delete children objects
        // don't use qDeleteAll as the destructor of the child might
        // delete siblings
        for (int i = 0; i < children.count(); ++i) {
            currentChildBeingDeleted = children.at(i);
            children[i] = 0;
            delete currentChildBeingDeleted;
        }
        children.clear();
        currentChildBeingDeleted = nullptr;
        isDeletingChildren = false;
    }
    

å¤¹å¸¦ç§è´§æ—¶é—´
------

åœ¨ä½¿ç”¨Qtçš„å¯¹è±¡æ ‘è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸€ç§é—®é¢˜ï¼Œä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼šå°±æ˜¯æ‰‹åŠ¨çš„ç®¡ç†(ä¹Ÿå°±æ˜¯ç›´æ¥delete)ä¸€ä¸ªæœ‰çˆ¶å¯¹è±¡çš„`QObject`ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µå‘¢ï¼Œ**å› ä¸ºï¼Œä½ åœ¨deleteå­å¯¹è±¡ä¹‹åï¼Œå¹¶æ²¡æœ‰æŠŠè¿™ä¸ªå¯¹è±¡ä»çˆ¶å¯¹è±¡çš„å¯¹è±¡æ ‘é‡Œç§»é™¤ã€‚åœ¨çˆ¶å¯¹è±¡è¿›è¡Œææ„çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šå»éå†å­å¯¹è±¡å®¹å™¨ï¼Œä¸€ä¸ªä¸€ä¸ªææ„ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå‡ºç°ï¼Œä¸€ä¸ªå¯¹è±¡æŒ‡é’ˆè¢«åˆ é™¤äº†ä¸¤æ¬¡ï¼Œè‡ªç„¶å°±ä¼šå´©æºƒã€‚**

é‚£ä¹ˆï¼Œå¦‚æœéè¦è‡ªå·±ç®¡ç†è¿™ä¸ªå¯¹è±¡ï¼Œæœ‰ä»€ä¹ˆåŠæ³•å‘¢ï¼Ÿæˆ‘ä»¬ä»å¯¹è±¡æ ‘ä¸‹æ‰‹ï¼Œæœ‰ä¸¤ç§åŠæ³•ï¼š

1.  ä½¿ç”¨`deleteLater`
    
    å°±æ˜¯è°ƒç”¨`QObject`å¯¹è±¡çš„`deleteLater`å‡½æ•°ï¼Œæ¥å®ç°åˆ é™¤ã€‚å…³äº`deleteLater`çš„åˆ†æï¼Œå¯ä»¥çœ‹è¿™ä¸ªå¤§ä½¬çš„æ–‡ç« [Qt ä¸­ deleteLater() å‡½æ•°çš„ä½¿ç”¨](https://blog.csdn.net/tax10240809163com/article/details/117968680)
    
        QObject *object = new QObject();
        QObject *m_child = new QObject(object);
        
        // éœ€è¦æ‰‹åŠ¨åˆ é™¤çš„æ—¶å€™
        m_child->deleteLater();
        
    
2.  å…ˆå°†çˆ¶å¯¹è±¡è®¾ç½®ä¸ºç©ºï¼Œå†ç›´æ¥delete
    
        QObject *object = new QObject();
        QObject *m_child = new QObject(object);
        
        // éœ€è¦æ‰‹åŠ¨åˆ é™¤çš„æ—¶å€™
        m_child->setParent(nullptr);
        delete m_child;
        m_child = nullptr;
        
    
3.  å…ˆå°†çˆ¶å¯¹è±¡è®¾ç½®ä¸ºç©ºï¼Œå†ç›´æ¥delete
    
        QObject *object = new QObject();
        QObject *m_child = new QObject(object);
        
        // éœ€è¦æ‰‹åŠ¨åˆ é™¤çš„æ—¶å€™
        m_child->setParent(nullptr);
        delete m_child;
        m_child = nullptr;
        
    

**ä¸ªäººå»ºè®®ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨**`deleteLater`