---
layout: post
title: "ã€æ·±å…¥æµ…å‡º Yarn æ¶æ„ä¸å®ç°ã€‘3-3 Yarn Application Master ç¼–å†™"
date: "2022-11-18T18:24:54.649Z"
---
ã€æ·±å…¥æµ…å‡º Yarn æ¶æ„ä¸å®ç°ã€‘3-3 Yarn Application Master ç¼–å†™
===============================================

æœ¬ç¯‡æ–‡ç« ç»§ç»­ä»‹ç» Yarn Application ä¸­ ApplicationMaster éƒ¨åˆ†çš„ç¼–å†™æ–¹æ³•ã€‚

æœ¬ç¯‡æ–‡ç« ç»§ç»­ä»‹ç» Yarn Application ä¸­ ApplicationMaster éƒ¨åˆ†çš„ç¼–å†™æ–¹æ³•ã€‚

ä¸€ã€Application Master ç¼–å†™æ–¹æ³•
-------------------------

ä¸Šä¸€èŠ‚è®²äº† Client æäº¤ä»»åŠ¡ç»™ RM çš„å…¨æµç¨‹ï¼ŒRM æ”¶åˆ°ä»»åŠ¡åï¼Œç”± `ApplicationsManager` å‘ NM ç”³è¯· Containerï¼Œå¹¶æ ¹æ® Client æä¾›çš„ `ContainerLaunchContext` å¯åŠ¨ `ApplicationMaster`ã€‚  
**æœ¬ç¯‡ä»£ç å·²ä¸Šä¼  Githubï¼š**  
[Github - MyApplicationMaster](https://github.com/Simon-Ace/hadoop-yarn-study-demo/blob/master/application-service-demo/src/main/java/com/shuofxz/MyApplicationMaster.java)

### ä¸€ï¼‰æ•´ä½“æµç¨‹

![](https://img2022.cnblogs.com/blog/1324217/202211/1324217-20221118204758783-143462346.png)

#### 1&2ã€å¯åŠ¨ NMClient å’Œ RMClient

åœ¨ AM ä¸­éœ€è¦åˆ†åˆ«å¯åŠ¨ NMClient å’Œ RMClient è¿›è¡Œé€šä¿¡ã€‚  
ä¸¤ä¸ªå®¢æˆ·ç«¯ä¸­éƒ½æ³¨å†Œäº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ `eventHandler`ï¼Œå°†ä¼šåœ¨åé¢è¿›è¡Œä»‹ç»ã€‚  
åœ¨ amRMClient ä¸­ä¼šå®šä¹‰ AM å‘ RM å®šæ—¶å‘é€å¿ƒè·³çš„é—´éš”ã€‚ï¼ˆåœ¨ RM ä¸­ä¼šæœ‰å¿ƒè·³å®¹å¿æ—¶é—´ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡ RM é…ç½®çš„æ—¶é—´ï¼‰

    // logInformation();
    Configuration conf = new Configuration();
    
    // 1 create amRMClient
    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¿ƒè·³æ—¶é—´ ms
    amRMClient = AMRMClientAsync.createAMRMClientAsync(1000, new RMCallbackHandler());
    amRMClient.init(conf);
    amRMClient.start();
    
    // 2 Create nmClientAsync
    amNMClient = new NMClientAsyncImpl(new NMCallbackHandler());
    amNMClient.init(conf);
    amNMClient.start();
    

#### 3ã€å‘ RM æ³¨å†Œ ApplicationMaster

    // 3 register with RM and this will heart beating to RM
    RegisterApplicationMasterResponse response = amRMClient
                    .registerApplicationMaster(NetUtils.getHostname(), -1, "");
    

#### 4ã€ç”³è¯· Containers

é¦–å…ˆéœ€è¦ä» response ä¸­ç¡®è®¤èµ„æºæ± å‰©ä½™èµ„æºï¼Œç„¶åå†æ ¹æ®éœ€æ±‚ç”³è¯· container

    // 4 Request containers
    response.getContainersFromPreviousAttempts();
    
    // 4.1 check resource
    long maxMem = response.getMaximumResourceCapability().getMemorySize();
    int maxVCores = response.getMaximumResourceCapability().getVirtualCores();
    
    // 4.2 request containers base on avail resource
    for (int i = 0; i < numTotalContainers.get(); i++) {
        ContainerRequest containerAsk = new ContainerRequest(
                //100*10M + 1vcpu
                Resource.newInstance(100, 1), null, null,
                Priority.newInstance(0));
        amRMClient.addContainerRequest(containerAsk);
    }
    

#### 5ã€è¿è¡Œä»»åŠ¡

å°†åœ¨ `RMCallbackHandler` ä¸­çš„ `onContainersAllocated` å›è°ƒå‡½æ•°ä¸­å¤„ç†ï¼Œå¹¶åœ¨å…¶ä¸­è°ƒç”¨ `NMCallbackHandler` çš„æ–¹æ³•ï¼Œæ‰§è¡Œå¯¹åº”çš„ taskã€‚  
ï¼ˆ`RMCallbackHandler`ã€`NMCallbackHandler`å°†åœ¨åé¢è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ï¼‰

    // RMCallbackHandler
    public void onContainersAllocated(List<Container> containers) {
        for (Container c : containers) {
            log.info("Container Allocated, id = " + c.getId() + ", containerNode = " + c.getNodeId());
            // LaunchContainerTask å®ç°åœ¨ä¸‹é¢
            exeService.submit(new LaunchContainerTask(c));
        }
    }
    
    private class LaunchContainerTask implements Runnable {
        @Override
        public void run() {
            // â€¦â€¦
            // å‘é€äº‹ä»¶äº¤ç»™ nm å¤„ç†
            amNMClient.startContainerAsync(container, ctx);
        }
    }
    

#### 6ã€ç»“æŸä»»åŠ¡

å½“å…¨éƒ¨å­ä»»åŠ¡å®Œæˆåï¼Œéœ€è¦åšæ”¶å°¾å·¥ä½œï¼Œå°† `amNMClient` å’Œ `amRMClient` åœæ­¢ã€‚

    while(numTotalContainers.get() != numCompletedContainers.get()){
        try{
            Thread.sleep(1000);
            log.info("waitComplete" +
                    ", numTotalContainers=" + numTotalContainers.get() +
                    ", numCompletedConatiners=" + numCompletedContainers.get());
        } catch (InterruptedException ex){}
    }
    log.info("ShutDown exeService Start");
    exeService.shutdown();
    log.info("ShutDown exeService Complete");
    amNMClient.stop();
    log.info("amNMClient stop Complete");
    amRMClient.unregisterApplicationMaster(FinalApplicationStatus.SUCCEEDED, "dummy Message", null);
    log.info("unregisterApplicationMaster Complete");
    amRMClient.stop();
    log.info("amRMClient stop Complete");
    

### äºŒï¼‰NMClient å’Œ RMClient Callback Handler ç¼–å†™

#### 1ã€RMCallbackHandler

æœ¬è´¨æ˜¯ä¸ª `eventHandler`ï¼Œå¯¹äº‹ä»¶åº“ä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥ç¿»ä¹‹å‰çš„æ–‡ç« ã€Œ2-3 Yarn åŸºç¡€åº“ - æœåŠ¡åº“ä¸äº‹ä»¶åº“ã€è¿›è¡Œå­¦ä¹ ã€‚  
å…¶ä¼šå¤„ç† Container å¯åŠ¨ã€åœæ­¢ã€æ›´æ–°ç­‰äº‹ä»¶ã€‚  
æ”¶åˆ°ä¸åŒçš„äº‹ä»¶æ—¶ï¼Œä¼šæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚è¿™é‡Œä»…ç»™å‡ºä¸¤ä¸ªå‡½æ•°çš„å®ç°ã€‚

> ğŸ’¡ æ€è€ƒï¼šä¹‹å‰ç‰ˆæœ¬ä¸­ï¼ˆ2.6ä¹‹å‰ï¼‰è¿˜æ˜¯å®ç° CallbackHandler æ¥å£ï¼Œä¸ºä½•åé¢æ”¹ä¸ºäº†æŠ½è±¡ç±»ï¼Ÿ  
> Aï¼šå¯¹åŸæ¥å£æœ‰äº†æ‰©å±•å¢åŠ äº†æ–¹æ³• onContainersUpdatedã€‚æ¨æµ‹æ˜¯å› ä¸ºé¿å…ä½¿ç”¨æ¥å£ç»§æ‰¿ã€‚

    private class RMCallbackHandler extends AMRMClientAsync.AbstractCallbackHandler {
        @Override
        public void onContainersCompleted(List<ContainerStatus> statuses) {
            for (ContainerStatus status : statuses) {
                log.info("Container completed: " + status.getContainerId().toString()
                        + " exitStatus=" + status.getExitStatus());
                if (status.getExitStatus() != 0) {
                    log.error("Container return error status: " + status.getExitStatus());
                    log.warn("Need rerun container!");
                    // do something restart container
                    continue;
                }
                ContainerId containerId = status.getContainerId();
                runningContainers.remove(containerId);
                numCompletedContainers.addAndGet(1);
            }
        }
        
        @Override
        // è¿™é‡Œåœ¨ container ä¸­å¯åŠ¨ç›¸åº”çš„ task
        public void onContainersAllocated(List<Container> containers) {
            for (Container c : containers) {
                log.info("Container Allocated, id = " + c.getId() + ", containerNode = " + c.getNodeId());
                // LaunchContainerTask å®ç°åœ¨ä¸‹é¢
                exeService.submit(new LaunchContainerTask(c));
            }
        }
    	// å…¶ä»–æ–¹æ³•å®ç°â€¦â€¦ 
    }
            
    
    private class LaunchContainerTask implements Runnable {
        Container container;
        public LaunchContainerTask(Container container) {
            this.container = container;
        }
        
        @Override
        public void run() {
            LinkedList<String> commands = new LinkedList<>();
            commands.add("sleep " + sleepSeconds.addAndGet(1));
            ContainerLaunchContext ctx = ContainerLaunchContext.newInstance(null, null, commands, null, null, null);
            // è¿™é‡Œå»æ‰§è¡Œ amNMClient çš„å›è°ƒ
            amNMClient.startContainerAsync(container, ctx);
        }
    }
    

#### 2ã€NMCallbackHandler

å®šä¹‰ nm container éœ€è¦æ‰§è¡Œçš„å„ç§äº‹ä»¶å¤„ç†ã€‚

    private class NMCallbackHandler extends NMClientAsync.AbstractCallbackHandler {
        @Override
        public void onContainerStarted(ContainerId containerId, Map<String, ByteBuffer> allServiceResponse) {
            log.info("Container Stared " + containerId.toString());
        }
        
        // â€¦â€¦
    

### ä¸‰ï¼‰æ¶‰åŠçš„é€šä¿¡åè®®

**AM ä¸ RM**  
![image.png](https://img2022.cnblogs.com/blog/1324217/202211/1324217-20221118204201201-1402021282.png)

**AM ä¸ NM**  
![image.png](https://img2022.cnblogs.com/blog/1324217/202211/1324217-20221118204200583-401160211.png)

äºŒã€å°ç»“
----

è‡³æ­¤æˆ‘ä»¬å­¦ä¹ äº†ç¼–å†™ Yarn Application çš„æ•´ä½“æµç¨‹å’Œå®ç°æ–¹æ³•ï¼Œç›¸ä¿¡å„ä½åŒå­¦å¯¹å…¶æœ‰äº†æ›´æ·±çš„è®¤è¯†ã€‚ä¹‹åå¯ä»¥ä» hadoop æä¾›çš„ `DistributedShell` å…¥æ‰‹ï¼Œå†åˆ°å…¶ä»–æ¡†æ¶ï¼ˆHiveã€Flinkï¼‰ç­‰æ¢ç©¶å·¥ä¸šçº§æ¡†æ¶æ˜¯å¦‚ä½•æäº¤ Application çš„ã€‚

* * *

å‚è€ƒæ–‡ç« ï¼š  
[Hadoop Doc: Writing an ApplicationMaster (AM)](https://hadoop.apache.org/docs/stable/hadoop-yarn/hadoop-yarn-site/WritingYarnApplications.html#Writing_an_ApplicationMaster_.28AM.29)  
ã€ŠHadoop æŠ€æœ¯å†…å¹• - æ·±å…¥è§£æ Yarn ç»“æ„è®¾è®¡ä¸å®ç°åŸç†ã€‹ç¬¬å››ç« 