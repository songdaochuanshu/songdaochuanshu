---
layout: post
title: "ç–¯ç‹‚åæ§½ MAUI ä»¥åŠ MAUI å…¥å‘çŸ¥è¯†ç‚¹"
date: "2023-01-19T06:20:14.699Z"
---
ç–¯ç‹‚åæ§½ MAUI ä»¥åŠ MAUI å…¥å‘çŸ¥è¯†ç‚¹
=======================

ç›®å½•

*   [çª—å£](#çª—å£)
*   [çª—å£ç®¡ç†](#çª—å£ç®¡ç†)
*   [å¦‚ä½•é™åˆ¶ä¸€æ¬¡åªèƒ½æ‰“å¼€ä¸€ä¸ªç¨‹åº](#å¦‚ä½•é™åˆ¶ä¸€æ¬¡åªèƒ½æ‰“å¼€ä¸€ä¸ªç¨‹åº)
*   [MAUI ç¨‹åºå®‰è£…æ¨¡å¼](#maui-ç¨‹åºå®‰è£…æ¨¡å¼)
*   [ä¸º MAUI Blazor è®¾ç½®è¯­è¨€](#ä¸º-maui-blazor-è®¾ç½®è¯­è¨€)
    *   [å‘ â‘ ](#å‘-)
    *   [å‘ â‘¡](#å‘--1)
    *   [å‘ â‘¢](#å‘--2)
*   [é…ç½® MAUI é¡¹ç›®ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¯åŠ¨](#é…ç½®-maui-é¡¹ç›®ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¯åŠ¨)
    *   [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
    *   [å®šåˆ¶ç¼–è¯‘è¿‡ç¨‹](#å®šåˆ¶ç¼–è¯‘è¿‡ç¨‹)
*   [MAUI å®ç°å‰åç«¯åˆ†ç¦»å¼€å‘](#maui-å®ç°å‰åç«¯åˆ†ç¦»å¼€å‘)
    *   [èƒŒæ™¯](#èƒŒæ™¯)
    *   [å…ˆæå‰ç«¯](#å…ˆæå‰ç«¯)
    *   [åˆ›å»º MAUI Blazor é¡¹ç›®](#åˆ›å»º-maui-blazor-é¡¹ç›®)
*   [C# è‡ªåŠ¨åŒ–ç”Ÿæˆè¯ä¹¦ã€æœ¬åœ°å®‰è£…è¯ä¹¦ã€è§£å†³ä¿¡ä»»è¯ä¹¦é—®é¢˜](#c-è‡ªåŠ¨åŒ–ç”Ÿæˆè¯ä¹¦æœ¬åœ°å®‰è£…è¯ä¹¦è§£å†³ä¿¡ä»»è¯ä¹¦é—®é¢˜)
    *   [èƒŒæ™¯](#èƒŒæ™¯-1)
    *   [å†™ä»£ç ](#å†™ä»£ç )
    *   [åœ¨ ASP.NET Core ä¸­ä½¿ç”¨](#åœ¨-aspnet-core-ä¸­ä½¿ç”¨)


è¿™é‡Œæ˜¯ç¬”è€…åœ¨å¼€å‘ MAUI åº”ç”¨æ—¶è¸©çš„å‘ï¼Œä»¥åŠä¸€äº›ç¬”è®°çš„æ±‡æ€»ã€‚

ä¸å¾—ä¸è¯´ MAUI æŒºåƒåœ¾çš„ã€‚

å¦‚æœä¸æ˜¯ Mono é‡‘ç‰åœ¨å‰ï¼Œä¼°è®¡ç¤¾åŒºä¸ä¼šæœ‰å¤šå°‘äººå…³æ³¨è´¥çµ® MAUIã€‚

ç›®å‰ .NET å·²ç»å‡çº§åˆ° 7.0ï¼Œä½†æ˜¯ MAUI è¿˜æ˜¯ä¸€å¦‚æ—¢å¾€çš„æ‹‰è·¨ï¼Œå¦‚æœå¼€å‘è¿‡ MAUIï¼Œåšè¿‡å®šåˆ¶ï¼Œè‡ªå®šä¹‰æ ‡é¢˜æ ä¹‹ç±»çš„ï¼Œä¾¿ä¼šå‘ç° MAUI æœ‰å¤šéš¾å—ã€‚

MAUI ä¸çŸ¥é“è·Ÿ UWP æœ‰å•¥å…³ç³»ï¼Œä½†æ˜¯ MAUI å¾ˆå¤šä¸œè¥¿æ„Ÿè§‰éƒ½æ˜¯åœ¨å»¶ç»­ UWP çš„è®¾è®¡ï¼Œè€Œä¸” MAUI ä¹Ÿå¾ˆå¯èƒ½æ˜¯ä¸‹ä¸€ä¸ª UWPã€‚

å¦‚æœæ˜¯ Windows æˆ–è€… Linux æ¡Œé¢å¼€å‘ï¼Œå»ºè®® WPF æˆ– Avaloniaï¼Œ MAUI çœŸä¸Šä¸æ¥å°é¢ï¼Œåœ¨ WPF ä¸‹é¢å¯ä»¥æ‰¾åˆ° å¥½å¤š API ï¼Œä½†æ˜¯ MAUI éƒ½æ²¡æœ‰ã€‚ã€‚ã€‚  
MAUI Windows åŸºäº WINUI å¼€å‘çš„ï¼Œä½†æ˜¯ä½ æŒ‰ç…§ WINUI å»æ‰¾èµ„æ–™ï¼Œæ‰¾åˆ°çš„ä¸œè¥¿ MAUI åˆç”¨ä¸äº†ã€‚ã€‚ã€‚

> è¿™é‡Œç¬”è€…æ¨èä¸€ä¸ªå¥½ç”¨çš„å‰ç«¯æ‰“åŒ…å®¢æˆ·ç«¯å·¥å…· tauri ï¼Œtauri æ˜¯ç”¨ rust å®ç°çš„ï¼Œç„¶åå¯ä»¥ç»“åˆå…¶å®ƒå‰ç«¯æ¡†æ¶å¼€å‘åº”ç”¨ã€‚
> 
> å…¶å¼€å‘æ¨¡å¼æ¯” MAUI Blazor å¥½å¾ˆå¤šï¼Œå¼€å‘ä½“éªŒä¹Ÿéå¸¸å¥½ï¼Œç”Ÿæˆçš„è½¯ä»¶ä½“ç§¯ä¹Ÿæ˜¯å‡ºå¥‡çš„å°ï¼Œè€Œä¸”ç”Ÿæˆçš„ app è‡ªå¸¦å®‰è£…ç•Œé¢ï¼Œç”Ÿæˆçš„ç¨‹åºå°±æ˜¯å·²ç»æ‰“åŒ…å¥½çš„ï¼Œçœå¾—è‡ªå·±æ‰‹åŠ¨é‡æ–°æ‰“åŒ…ã€‚
> 
> æ–‡ç« ä»‹ç»ï¼š[https://www.whuanle.cn/archives/21062](https://www.whuanle.cn/archives/21062)

ä¸å…¶ä»–æ¡Œé¢å¼€ç›¸æ¯”ï¼Œ MAUI çœŸçš„éå¸¸è‡ƒè‚¿ï¼Œè€Œä¸” MAUI Blazor å¼€å‘å¾—çœŸçš„ä¸çˆ½ï¼ŒåŒ…æ‹¬ Visual Studio æœ¬èº«çš„å¼€å‘ä½“éªŒï¼Œæ¡†æ¶æœ¬èº«çš„ä½¿ç”¨ï¼Œä»¥åŠ Blazor UI æ¡†æ¶ï¼Œä¸‰ä¸ªæ–¹é¢çš„ä½“éªŒéƒ½ä¸å¤Ÿå¥½ã€‚

èƒ½æ‰“çš„ Blazor æ¡†æ¶å°‘ï¼Œå¯ä»¥è½»æ˜“æ‰©å±•å®¹æ˜“æ”¹é€ çš„ UI æ¡†æ¶æ›´åŠ å°‘ï¼Œç›®å‰å‘ç°èƒ½å¤Ÿä½¿ç”¨çš„ Blazor æ¡†æ¶ï¼Œæ¯”è¾ƒå¥½çš„æœ‰ MASA Blazorã€‚

ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œé¦–å…ˆæ˜¯ Blazor ç¼–å†™è¿‡ç¨‹ä¸­ï¼Œç¼–è¾‘å™¨å¯¹ Razor çš„æ”¯æŒä¸å¥½ï¼Œä¼šç»å¸¸å‡ºç°æ²¡æœ‰è¯­æ³•æç¤ºï¼Œä»£ç æœ‰é”™è¯¯ä½†æ˜¯ç¼–è¾‘å™¨æ²¡æœ‰æç¤ºï¼Œç¼–è¾‘å™¨æç¤ºæœ‰é”™è¯¯å®é™…ä¸Šä»£ç æ²¡æœ‰é”™è¯¯ï¼Œç­‰ç­‰ã€‚ã€‚ã€‚

å…¶æ¬¡ï¼Œå…³äº MAUI ä¸‹ Blazor çš„ä½¿ç”¨å’Œ Blazor æ¡†æ¶çš„é€‰å‹ã€‚åœ¨ MAUI ä¸‹ä½¿ç”¨ Blazorï¼Œå¦‚æœä½¿ç”¨ç¬¬ä¸‰æ–¹ UI æ¡†æ¶ï¼Œå¼•å…¥ä¹‹åï¼Œä¼šå‘ç°å…¶å¤©ç„¶æœ‰ä¸€ç§å°é—­æ€§ã€‚  
å¦‚æœä½¿ç”¨çº¯å‰ç«¯æ¡†æ¶å¼€å‘ï¼Œä½ ä¼šå‘ç°ä¾èµ–å¼•ç”¨å…³ç³»å¾ˆæ¸…æ™°ï¼Œéœ€è¦å¼•ç”¨ä»€ä¹ˆåŒ…ï¼Œç¼–è¯‘å™¨ä¼šæç¤ºï¼Œç¼–è¯‘æ—¶ä¼šæç¤ºã€‚

è€Œ Blazor æ¡†æ¶ï¼Œå¾ˆéš¾çŸ¥é“é‡Œé¢ç”¨äº†å“ªäº› jsï¼ŒBlazor dll é‡Œé¢åµŒå¥—äº† js ç­‰æ–‡ä»¶ï¼Œå…¶æœ¬èº«å°±æ˜¯ä¸€ç§å°é—­æ€§ï¼Œè€Œå…³äºå†…éƒ¨çš„æƒ…å†µæ›´åŠ éš¾ä»¥äº†è§£ï¼Œå‡ºç°äº† Bug è°ƒè¯•éš¾ã€‚

è€Œä¸” Blazor æ¡†æ¶å°è£…çš„ä»£ç  æ˜¯ C# + js å†™çš„ï¼Œç”±äº C# ä»£ç ç¼–è¯‘åæ— æ³•ä¿®æ”¹ï¼Œå› æ­¤å¼•ç”¨çš„ Blazor åº“å‡ºé—®é¢˜æ—¶ï¼Œéš¾ä»¥æŸ¥çœ‹è°ƒè¯•æºä»£ç ã€‚è¿˜æœ‰ï¼Œç¬”è€…ä»ç›®å‰çš„ Blazor æ¡†æ¶ä¸­ï¼Œçœ‹åˆ°äº†å¾ˆå¤šæ¡†æ¶æœ¬èº«çš„ä»£ç éå¸¸è‡ƒè‚¿ï¼Œé‡Œé¢çš„è®¾è®¡å’Œé€»è¾‘ä¹Ÿä¸æ¸…æ™°ï¼Œå¾ˆå¤šåœ°æ–¹çš„ä»£ç é™åˆ¶äº†ç»„ä»¶çš„æ‰©å±•ï¼Œå¼€å‘è€…éš¾ä»¥æ›¿æ¢é‡Œé¢çš„å®ç°ã€‚

è¿‡åº¦è®¾è®¡ä¹Ÿæ˜¯ä¸€ç§æ¯›ç—…ï¼Œå› ä¸ºä¸ºäº†æ”¯æŒè€Œæ”¯æŒï¼Œä¸ºäº†çµæ´»è€Œçµæ´»ï¼Œè¿‡å¤šçš„ API è®¾è®¡å’Œè¿‡å¤šçš„å‚æ•°å‘ˆç°ï¼Œè¿‡å¤šçš„é€»è¾‘å°è£…ï¼Œå®é™…ä¸Šä¼šè®©è¿™äº›ç»„ä»¶æ›´åŠ éš¾ç”¨ã€‚

å¤§å¤šæ•° Blazor æ¡†æ¶éƒ½æ˜¯ä¸ªäººä»“åº“ç»´æŠ¤ã€‚è€Œå¸‚é¢ä¸Šç²¾å“çš„å‰ç«¯æ¡†æ¶ï¼Œå‡ ä¹éƒ½æ˜¯æœ‰å¤§å…¬å¸åšèƒŒä¹¦ï¼ŒViewJSã€Ant Design ç­‰ï¼Œå…¶æ¡†æ¶æœ¬èº«æœ‰ä¸“ä¸šå›¢é˜Ÿç»´æŠ¤å’Œå¤§ä½¬å¯¹æ¡†æ¶è¿›è¡Œè®¾è®¡ï¼Œå…±åŒç»´æŠ¤ä¸€ä¸ªç²¾å“ã€‚

ä½†æ˜¯ç›®å‰çš„ Blazorï¼Œæˆ‘è§‰å¾—ï¼Œé™¤äº† MASA åšçš„ï¼Œå…¶å®ƒå¾ˆéš¾æå¾—ä¸Š â€œç²¾å“â€ã€‚

è¦å¤¸ MASA ï¼Œç¬”è€…ä¹Ÿæ˜¯æœ‰ç†ç”±çš„ã€‚

MASA æ˜¯çœŸçš„ç”¨å¿ƒåœ¨åšç”Ÿæ€ï¼Œå¸å¼•äº†å¾ˆå¤šå¼€å‘è€…å’Œç²‰ä¸æ´»è·ƒå‚ä¸ï¼Œå…¶å¼€æºå…±äº«ç²¾ç¥å€¼å¾—æ•¬ä½©ã€‚

å¦‚æœä½ å¯¹ Blazor æœ‰é—®é¢˜ï¼Œå¯¹ MAUI å¼€å‘æœ‰é—®é¢˜ï¼Œå³ä½¿ä½ ç”¨çš„ä¸æ˜¯ MASA æ¡†æ¶ï¼Œä½ ä¹Ÿå¯ä»¥åˆ° MASA ç¾¤ä¼—æé—®ï¼Œä¸ä¼šå‡ºç°ä»˜è´¹è§£ç­”é—®é¢˜ï¼Œä¹Ÿä¸ä¼šæœ‰äººç¬‘ä½ èœï¼Œä¹Ÿä¸ä¼šæœ‰äººç¬‘ä½ è¿™éƒ½ä¸æ‡‚ã€‚å½“ç„¶ç¬”è€…å¹¶ä¸æ˜¯è¯´å¼€æºé¡¹ç›®ä»˜è´¹è§£ç­”æœ‰é—®é¢˜ï¼Œæˆ‘åªæ˜¯ç§°èµ MASA çš„å¼€æºç²¾ç¥ã€‚

> å®˜ç½‘ï¼š[https://www.masastack.com/blazor](https://www.masastack.com/blazor)

æœŸå¾… MASA å›¢é˜Ÿåšå‡ºä¸€ä¸ªç²¾å“å‡ºæ¥ã€‚

ä¸è¿‡å°±ç›®å‰æ¥è¯´ï¼Œ MAUI + Blazor æ¡Œé¢å¼€å‘ï¼Œæ²¡å•¥ä¼˜åŠ¿ã€‚ã€‚ã€‚è¿˜ä¼šå¸¦æ¥å¾ˆå¤šé—®é¢˜ã€‚ã€‚ã€‚

å¦‚æœå¯ä»¥ï¼Œä¸æƒ³å†ç¢° MAUIã€‚

ä¸‹é¢æ¥ä»‹ç»ä¸€äº› MAUI çš„çŸ¥è¯†ç‚¹ã€‚

### çª—å£

é¦–å…ˆï¼Œåˆ›å»ºé¡¹ç›®åï¼Œ APP.cs ä¸­ï¼Œæœ‰ä¸ª `Microsoft.Maui.Controls.Window`ã€‚

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437961-1721694435.png)

MauiProgram.cs ä¸­ï¼Œæœ‰ä¸ª `Microsoft.UI.Xaml.Window` ,ç„¶ååœ¨ Windows ä¸‹ `Microsoft.UI.Xaml.Window` æ˜¯ `Microsoft.Maui.MauiWinUIWindow`ï¼Œ `Microsoft.UI.Xaml.Window` å¤šç§å¹³å°ç»Ÿä¸€çš„æŠ½è±¡ã€‚

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437337-435634261.png)

ç„¶å `Microsoft.UI.Xaml.Window` å¯ä»¥è·å–ä¸€ä¸ª AppWindowã€‚

    AppWindow appWindow = nativeWindow.GetAppWindow()!;


MAUI é‡Œé¢çš„ Window ç±» API å¾ˆæ··ä¹±ï¼Œå¤§å¤šæ•°æ˜¯ä» UWP å†™æ³•ç»§æ‰¿ï¼Œç„¶åæœ‰å¾ˆå¤š API æ˜¯ UWP æœ‰çš„ï¼Œä½†æ˜¯ MAUI æ²¡æœ‰ã€‚

æ··ä¹±ã€‚

å¦‚æœè‡ªå·±å†™äº†ä¸€ä¸ªé¡µé¢ï¼Œè¦å¼¹å‡ºè¿™ä¸ªçª—å£é¡µé¢ï¼Œé‚£ä¹ˆåº”è¯¥ä½¿ç”¨ `Microsoft.Maui.Controls.Window` ï¼Œä½†æ˜¯è‡ªå·±å†™çš„é¡µé¢æ˜¯ ContentPageï¼Œå¹¶ä¸æ˜¯ Windowã€‚

å› æ­¤å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ Windowï¼Œè€Œæ˜¯å°† ContentPage æ”¾åˆ° Window ä¸­ï¼Œç”Ÿæˆ Window åå†æ“ä½œã€‚

            private Microsoft.Maui.Controls.Window BuildUpdateWindow(ContentPage updatePage)
            {
                Window window = new Window(updatePage);
                window.Title = "æ›´æ–°é€šçŸ¥";
                return window;
            }


ç„¶åå¼¹å‡ºè¿™ä¸ªçª—å£ã€‚

    Application.Current!.OpenWindow(updateWindow!);


å¦‚æœè¦å¼‚æ­¥æ‰“å¼€çª—å£ï¼Œè¯·ä½¿ç”¨ `Application.Current!.Dispatcher.DispatchAsync`ã€‚

                await Application.Current!.Dispatcher.DispatchAsync(async () =>
                {
                    try
                    {
                            Application.Current!.OpenWindow(updateWindow!);
                    }
                    catch (Exception ex)
                    {
                        Logger.LogError("æ— æ³•å¯åŠ¨æ›´æ–°çª—å£", ex);
                    }
                });


å¦‚æœæƒ³å…³é—­æ‰€æœ‰çª—å£ï¼š

                await Application.Current!.Dispatcher.DispatchAsync(async () =>
                {
                    var windows = Application.Current!.Windows.ToArray();
                    foreach (var window in windows)
                    {
                        try
                        {
                            Application.Current.CloseWindow(window);
                        }
                        catch (Exception ex)
                        {
                            Debug.Assert(ex != null);
                        }
                    }
                });


è™½ç„¶ä½ è·å¾—äº† `Microsoft.Maui.Controls.Window` ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥ç®¡ç†è¿™ä¸ª Windowï¼Œè€Œæ˜¯åº”è¯¥é€šè¿‡ `Microsoft.UI.Xaml.Window`ï¼Œæˆ– `Microsoft.UI.Windowing.AppWindow` ç®¡ç†ã€‚

ä¹Ÿå°±æ˜¯åœ¨ä¾èµ–æ³¨å…¥é‡Œé¢çš„çª—å£ç”Ÿå‘½å‘¨æœŸç®¡ç†é‡Œé¢å†™ã€‚

æˆ–è€…é™¤éä½ å¯ä»¥æ‹¿åˆ° AppWindow å®ä¾‹ã€‚

é—æ†¾çš„æ˜¯ï¼Œ`Microsoft.Maui.Controls.Window` è½¬ä¸äº† `Microsoft.UI.Xaml.Window` æˆ– `Microsoft.UI.Windowing.AppWindow`ã€‚

ä½ åº”è¯¥è¿™æ ·å†™ï¼š

                builder.ConfigureLifecycleEvents(events =>
                {
                    events.AddWindows(wndLifeCycleBuilder =>
                    {
                        wndLifeCycleBuilder.OnWindowCreated(window =>
                        {
                            var nativeWindow = (window as Microsoft.Maui.MauiWinUIWindow)!;
                            ... ...
                        })
                        .OnActivated((window, args) =>
                        {
                        })
                        .OnClosed((window, args) =>
                        {
                        });
                    });
                });


            private static void MainWindowCreated(MauiWinUIWindow nativeWindow)
            {
                const int width = 1440;
                const int height = 900;
    
                AppWindow appWindow = nativeWindow.GetAppWindow()!;
    
                // æ‰©å±•æ ‡é¢˜æ ï¼Œè¦è‡ªå®šä¹‰æ ‡é¢˜æ é¢œè‰²ï¼Œå¿…é¡» true
    
                nativeWindow.ExtendsContentIntoTitleBar = true;
    
                // è¿™é‡Œå¿…é¡»è®¾ç½®ä¸º Overlappedï¼Œä¹‹åçª—å£ Presenter å°±æ˜¯ OverlappedPresenterï¼Œä¾¿äºæ§åˆ¶
                appWindow.SetPresenter(AppWindowPresenterKind.Overlapped);
    
                //if (appWindow.Presenter is OverlappedPresenter p)
                //{
                //   // p.SetBorderAndTitleBar(hasBorder: false, hasTitleBar: true);
                //}
    
                // é‡æ–°è®¾ç½®é»˜è®¤æ‰“å¼€å¤§å°
                appWindow.MoveAndResize(new RectInt32(1920 / 2 - width / 2, 1080 / 2 - height / 2, width, height));
    
                // çª—å£è°ƒæ•´çš„å„ç±»äº‹ä»¶
                appWindow.Changed += (w, e) =>
                {
                    // ä½ç½®å‘ç”Ÿå˜åŒ–
                    if (e.DidPositionChange) 
                    {
                    }
                    if (e.DidPresenterChange) { }
                    // å¤§å°å‘ç”Ÿå˜åŒ–
                    if (e.DidSizeChange) { }
                    if (e.DidVisibilityChange) { }
                    if (e.DidZOrderChange) { }
                };
                appWindow.Closing += async (w, e) =>
                {
                    try
                    {
                        Environment.Exit(0);
                    }
                    catch (Exception ex)
                    {
                        var log = AppHelpers.LoggerFactory.CreateLogger<AppWindow>();
                        log.LogError(ex, "Can't close WebHost");
                        ProcessManager.ReleaseLock();
                    }
                    finally
                    {
                        ProcessManager.ExitProcess(0);
                    }
                };
                appWindow.MoveInZOrderAtTop();
            }


å…¶æ¬¡ï¼Œä½ æƒ³ç›´æ¥è·å–å½“å‰çš„çª—å£å®ä¾‹ï¼Œä¹Ÿæ˜¯éº»çƒ¦ã€‚

å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è·å–å½“å‰ç¨‹åºæ‰“å¼€çš„æ‰€æœ‰çª—å£ã€‚

    App.Current.Windows
    Application.Current.Windows


å¦‚æœä½ æƒ³è·å–å½“å‰æ­£åœ¨ä½¿ç”¨æˆ–æ¿€æ´»çš„çª—å£ï¼Œç¬”è€…å¹¶ä¸çŸ¥é“æ€ä¹ˆé€šè¿‡é‡Œé¢çš„ API è·å–ã€‚ã€‚ã€‚å¦‚æœç”¨ Win32 é‚£ä¹ˆå€’æ˜¯å¯ä»¥ã€‚

é—®ï¼šæœ‰æ²¡æœ‰ä¸€ç§è¿™æ ·çš„ API å‘¢ï¼Ÿ

    Current.GetWindos()


å¦å¤–ï¼ŒMAUI åšä¸åˆ°è‡ªå®šä¹‰æ ‡é¢˜æ ï¼Œ**å¤©ç‹è€å­æ¥äº†éƒ½ä¸è¡Œã€‚**

ä½ æƒ³ç»™æ ‡é¢˜æ æ”¹ä¸ªèƒŒæ™¯è‰²ï¼Œä¼°è®¡éƒ½å¾—ç´¯æ­»ã€‚

å¦‚æœè¦ä¿®æ”¹çª—å£æ ‡é¢˜ï¼Œåªèƒ½åœ¨çª—å£åˆ›å»ºæ—¶ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ `Microsoft.Maui.Controls.Windows`ï¼Œç”¨ `Microsoft.UI.Xaml.Window`ï¼Œæˆ– `Microsoft.UI.Windowing.AppWindow` éƒ½æ”¹ä¸äº†ã€‚

                Microsoft.Maui.Controls.Window window = base.CreateWindow(activationState);
                window.Title = Constants.Name;


å¦‚æœè¦è·å–åŸç”Ÿçš„ Window å¥æŸ„ï¼Œå¯ä»¥ä½¿ç”¨ï¼š

                var nativeWindow = mauiWindow.Handler.PlatformView;
                IntPtr windowHandle = WinRT.Interop.WindowNative.GetWindowHandle(nativeWindow);


### çª—å£ç®¡ç†

å‰é¢æåˆ°ï¼Œæƒ³ç®¡ç†çª—å£ï¼ŒAPI è¦ç”¨ `Microsoft.UI.Xaml.Window`ï¼Œæˆ– `Microsoft.UI.Windowing.AppWindow` çš„ã€‚

æœ‰äº›åœ°æ–¹åªèƒ½ç”¨åŸç”Ÿçš„ Window çª—å£å¥æŸ„ï¼Œç„¶åç”¨ Win32 æ“ä½œã€‚

è‡ªå®šä¹‰çª—å£ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œä¸€å®šè¦ä½¿ç”¨ï¼š

                // è¿™é‡Œå¿…é¡»è®¾ç½®ä¸º Overlappedï¼Œä¹‹åçª—å£ Presenter å°±æ˜¯ OverlappedPresenterï¼Œä¾¿äºæ§åˆ¶
                appWindow.SetPresenter(AppWindowPresenterKind.Overlapped);


ç„¶åå¸¸ç”¨çš„çª—å£æ–¹æ³•æœ‰ï¼š

        /*
         AppWindow çš„ Presenter ï¼Œä¸€å®šæ˜¯ OverlappedPresenter
         */
    
        public class WindowService : IWindowService
        {
            private readonly AppWindow _appWindow;
            private readonly Window _window;
    
            private WindowService(AppWindow appWindow, Window window)
            {
                _appWindow = appWindow;
                _window = window;
            }
            
            // æ£€æŸ¥å½“å‰çª—å£æ˜¯å¦å…¨å±
            public bool FullScreenState
            {
                get
                {
                    switch (_appWindow.Presenter)
                    {
                        case OverlappedPresenter p:return p.State == OverlappedPresenterState.Maximized;
                        case FullScreenPresenter p:return p.Kind == AppWindowPresenterKind.FullScreen;
                        case CompactOverlayPresenter p: return p.Kind == AppWindowPresenterKind.FullScreen;
                        case AppWindowPresenter p: return p.Kind == AppWindowPresenterKind.FullScreen;
                        default:return false;
                    }
                }
            }
    
            // è®©çª—å£å…¨å±
            public void FullScreen()
            {
                switch (_appWindow.Presenter)
                {
                    case OverlappedPresenter overlappedPresenter:
                        overlappedPresenter.SetBorderAndTitleBar(true, true);
                        overlappedPresenter.Maximize();
                        break;
                }
                // å…¨å±æ—¶å»æ‰ä»»åŠ¡æ 
                // _appWindow.SetPresenter(AppWindowPresenterKind.FullScreen);
            }
    
            // é€€å‡ºå…¨å±
            public void ExitFullScreen()
            {
                switch (_appWindow.Presenter)
                {
                    case OverlappedPresenter p: p.Restore();break;
                    default: _appWindow.SetPresenter(AppWindowPresenterKind.Default); break;
                }
            }
    
            // æœ€å°åŒ–åˆ°ä»»åŠ¡æ 
            public void Minmize()
            {
    #if WINDOWS
                var mauiWindow = App.Current.Windows.First();
                var nativeWindow = mauiWindow.Handler.PlatformView;
                IntPtr windowHandle = WinRT.Interop.WindowNative.GetWindowHandle(nativeWindow);
    
                PInvoke.User32.ShowWindow(windowHandle, PInvoke.User32.WindowShowStyle.SW_MINIMIZE);
    #endif
            }
    
            /// <summary>
            /// æ¿€æ´»å½“å‰çª—å£
            /// </summary>
            public void Active()
            {
                _appWindow.Show(true);
            }
            
            // å…³é—­çª—å£
            public void Exit()
            {
                _window.Close();
            }
    
            public void SetSize(int _X, int _Y, int _Width, int _Height)
            {
                _appWindow.MoveAndResize(new RectInt32(_X, _Y, _Width, _Height));
            }
    
            public (int X, int Y) GetPosition()
            {
                var p = _appWindow.Position;
                return (p.X, p.Y);
            }
    
            public (int X, int Y) Move(int x, int y)
            {
                _appWindow.Move(new PointInt32(x, y));
                return GetPosition();
            }
    
            public (int Width, int Height, int ClientWidth, int ClientHeight) GetSize()
            {
                var size = _appWindow.Size;
                var clientSize = _appWindow.ClientSize;
                return (size.Width, size.Height, clientSize.Width, clientSize.Height);
            }
    
            public (PointInt32 Position, SizeInt32 Size, SizeInt32 ClientSize) GetAppSize()
            {
                return (_appWindow.Position, _appWindow.Size, _appWindow.ClientSize);
            }
        }


è®©çª—å£å…¨å±æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯å…¨å±æ—¶ï¼Œçª—å£æŠŠä»»åŠ¡æ åäº†ï¼ŒçœŸæ­£æ„ä¹‰ä¸Šçš„çš„å…¨å±ï¼Œå¦ä¸€ç§æ˜¯ä¿ç•™ä»»åŠ¡æ ã€‚

                // ä¿ç•™ä»»åŠ¡æ 
                switch (_appWindow.Presenter)
                {
                    case OverlappedPresenter overlappedPresenter:
                        overlappedPresenter.SetBorderAndTitleBar(true, true);
                        overlappedPresenter.Maximize();
                        break;
                }
                // å…¨å±æ—¶å»æ‰ä»»åŠ¡æ 
                // _appWindow.SetPresenter(AppWindowPresenterKind.FullScreen);


æœ€å°åŒ–åªèƒ½é€šè¿‡ Win32 API å¤„ç†ï¼Œä½ è¦å…ˆè·å– `Microsoft.Maui.Controls.Windows`ï¼Œç„¶åè½¬æ¢ä¸º Window å¥æŸ„ã€‚

                var nativeWindow = mauiWindow.Handler.PlatformView;
                IntPtr windowHandle = WinRT.Interop.WindowNative.GetWindowHandle(nativeWindow);
    
                PInvoke.User32.ShowWindow(windowHandle, PInvoke.User32.WindowShowStyle.SW_MINIMIZE);


> æ­¤æ—¶ `Microsoft.UI.Xaml.Window`ï¼Œæˆ– `Microsoft.UI.Windowing.AppWindow` å°±ç”¨ä¸ä¸Šäº†ã€‚

å‰é¢æåˆ°ï¼Œè¦ä½¿ç”¨ `Microsoft.UI.Xaml.Window`ï¼Œæˆ– `Microsoft.UI.Windowing.AppWindow` ï¼Œä¾‹å¦‚åœ¨ MauiProgram.cs é‡Œé¢è®°å½•äº†çª—å£çš„äº‹ä»¶ï¼Œåˆ›å»ºçª—å£æ—¶æ§åˆ¶å¤§å°ã€‚

ä½†æ˜¯ï¼Œçª—å£è¿è¡Œä¸­ï¼Œè¦è®¾ç½®çª—å£å¤§å°æˆ–é™åˆ¶å¤§å°ï¼Œåˆ™æ˜¯è¦é€šè¿‡ `Microsoft.Maui.Controls.Windows`ã€‚

ä¾‹å¦‚ï¼Œæ§åˆ¶ä¸»çª—å£å¤§å°ä¸èƒ½å¤ªå°ï¼Œä¸èƒ½è¢«æ— é™ç¼©å°ï¼Œè¦åœ¨ APP.cs ä¸­è¿™æ ·å†™ï¼š

            protected override Window CreateWindow(IActivationState? activationState)
            {
                Window window = base.CreateWindow(activationState);
                window.Title ="çª—å£æ ‡é¢˜";
    
                var minSize = GetMinSize();
                window.MinimumWidth = minSize.MinWidth;
                window.MinimumHeight = minSize.MinHeight;
    
                // Give the Window time to resize
                window.SizeChanged += (sender, e) =>
                {
                    var minSize = GetMinSize();
                    window.MinimumWidth = minSize.MinWidth;
                    window.MinimumHeight = minSize.MinHeight;
                };
    
                //window.Created += (s, e) =>
                //{
                //};
    
                //window.Stopped += (s, e) =>
                //{
                //};
    
                return window;
                
                (int MinWidth, int MinHeight) GetMinSize()
                {
                    // è·å–å½“å‰å±å¹•çš„é•¿å®½ï¼Œç”¨ Xã€Y è¡¨ç¤ºã€‚
                    var x = PInvoke.User32.GetSystemMetrics(PInvoke.User32.SystemMetric.SM_CXFULLSCREEN);
                    var y = PInvoke.User32.GetSystemMetrics(PInvoke.User32.SystemMetric.SM_CYFULLSCREEN);
                    // è®¾ç½®çª—å£æœ€å°å€¼ï¼Œå¯ä»¥æŒ‰ç…§æ¯”ä¾‹è®¡ç®—ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è®¾ç½®å›ºå®šå¤§å°
                    return (x / 3 * 2, y / 5 * 4);
                }
            }


PSï¼Œåœ¨ AppWindow é‡Œé¢çš„äº‹ä»¶åšå¤§å°é™åˆ¶ï¼Œæ˜¯åšä¸åˆ°çš„ï¼Œè¿™é‡Œä¸»è¦æ˜¯è§‚å¯Ÿï¼Œæƒ³åšçª—å£å¤§å°ç­‰é™åˆ¶æ˜¯ä¸è¡Œçš„ã€‚

                // çª—å£è°ƒæ•´çš„å„ç±»äº‹ä»¶
                appWindow.Changed += (w, e) =>
                {
                    // ä½ç½®å‘ç”Ÿå˜åŒ–
                    if (e.DidPositionChange) 
                    {
    
                    }
                    if (e.DidPresenterChange) { }
                    // å¤§å°å‘ç”Ÿå˜åŒ–
                    if (e.DidSizeChange) { }
                    if (e.DidVisibilityChange) { }
                    if (e.DidZOrderChange) { }
                };


### å¦‚ä½•é™åˆ¶ä¸€æ¬¡åªèƒ½æ‰“å¼€ä¸€ä¸ªç¨‹åº

åœºæ™¯ï¼Œå¦‚æœç¨‹åºD å·²è¢«è¿è¡Œ è¿›ç¨‹ Aï¼Œé‚£ä¹ˆå†æ¬¡å¯åŠ¨ç¨‹åºD è¿è¡Œè¿›ç¨‹ Bï¼ŒB ä¼šè¯†åˆ«åˆ°å·²æœ‰ç›¸åŒçš„è¿›ç¨‹ï¼Œæ­¤æ—¶ B ä¼šå°† A çª—å£æ¿€æ´»å¼¹å‡ºæ¥ï¼Œç„¶å B å†é€€å‡ºã€‚

è¿™æ ·ä¸ä»…å¯ä»¥é™åˆ¶åªèƒ½è¿è¡Œä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œä¸”å¯ä»¥è®©ç”¨æˆ·ä½“éªŒæ›´åŠ å¥½ã€‚

é”å¯ä»¥ä½¿ç”¨ Mutex æ¥å®ç°ï¼Œåœ¨æ•´ä¸ªæ“ä½œç³»ç»Ÿä¸­ï¼Œå¤§å®¶å¯ä»¥è¯†åˆ«åˆ°åŒä¸€ä¸ªé”ã€‚

ç„¶åæ¿€æ´»å¦ä¸€ä¸ªçª—å£ï¼Œå¯ä»¥ä½¿ç”¨ Win32ã€‚

        // è¿›ç¨‹ç®¡ç†å™¨
        internal static class ProcessManager
        {
            private static Mutex ProcessLock;
            private static bool HasLock;
    
            /// <summary>
            /// è·å–è¿›ç¨‹é”
            /// </summary>
            public static void GetProcessLock()
            {
                // å…¨å±€é”
                ProcessLock = new Mutex(false, "Global\\" + "è‡ªå®šä¹‰é”åç§°", out HasLock);
    
                if (!HasLock)
                {
                    ActiveWindow();
                    Environment.Exit(0);
                }
            }
    
            /// <summary>
            /// æ¿€æ´»å½“å‰è¿›ç¨‹å¹¶å°†å…¶çª—å£æ”¾åˆ°å±å¹•æœ€å‰é¢
            /// </summary>
            public static void ActiveWindow()
            {
                string pName = Constants.Name;
                Process[] temp = Process.GetProcessesByName(pName);
                if (temp.Length > 0)
                {
                    IntPtr handle = temp[0].MainWindowHandle;
                    SwitchToThisWindow(handle, true);
                }
            }
    
            /// <summary>
            /// é‡Šæ”¾å½“å‰è¿›ç¨‹çš„é”
            /// </summary>
            /// <remarks>å°å¿ƒä½¿ç”¨</remarks>
            public static void ReleaseLock()
            {
                if (ProcessLock != null && HasLock)
                {
                    ProcessLock.Dispose();
                    HasLock = false;
                }
            }
            
            // å°†å¦ä¸€ä¸ªçª—å£æ¿€æ´»æ”¾åˆ°å‰å°ã€‚
            // Win32 API
            [DllImport("user32.dll")]
            public static extern void SwitchToThisWindow(IntPtr hWnd, bool fAltTab);
        }


ç„¶ååœ¨ç¨‹åºå¯åŠ¨æ—¶ä½¿ç”¨ã€‚

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194436227-297108385.png)

### MAUI ç¨‹åºå®‰è£…æ¨¡å¼

å¦‚æœç›´æ¥ä½¿ç”¨åŸç”Ÿçš„ MAUI ç¨‹åºï¼Œå®‰è£…æ—¶ä¼šç‰¹åˆ«éº»çƒ¦ï¼Œå› ä¸ºè¿™ç§æ–¹å¼å°±æ˜¯ä»¥å‰çš„ UWPã€‚

å› æ­¤ï¼Œå¯ä»¥ä½¿ç”¨é‚£ç§ï¼Œä¸éœ€è¦å®‰è£…ç›´æ¥è¿è¡Œçš„æ–¹å¼ã€‚

ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬è¦äº†è§£ä¸€ä¸‹ä¸¤ç§æ¨¡å¼çš„åŒºåˆ«ã€‚

å¦‚æœä½¿ç”¨åŸç”Ÿ MAUI æ¨¡å¼ï¼Œé‚£ä¹ˆä¼šè¢«ç”Ÿæˆ Windows åº”ç”¨å¸‚åœºåº”ç”¨ï¼Œæ— è®ºæ˜¯å‘å¸ƒã€ä¸Šæ¶ã€å®‰è£…ï¼Œéƒ½æ˜¯éå¸¸éº»çƒ¦çš„ã€‚ä½†æ˜¯å¥½åœ¨å¯ä»¥ä½¿ç”¨å¾ˆå¤š Windows åº”ç”¨çš„ APIã€‚

ä¾‹å¦‚è¦è·å–åº”ç”¨ç¨‹åºå®‰è£…ç›®å½•ï¼š

    ApplicationData appdata = Windows.Storage.ApplicationData.Current


è·å–æœ¬åœ°å­˜å‚¨ç›®å½•å’Œä¸´æ—¶ç›®å½•ï¼š

    var localPath = Windows.Storage.ApplicationData.Current.LocalFolder.Path
    var tempPath = Windows.Storage.ApplicationData.Current.TemporaryFolder.Path


ç›®å½•ä¸€èˆ¬å®‰è£…ä½ç½®ï¼š

    "C:\\Users\\{ç”¨æˆ·å}\\AppData\\Local\\Packages\\{ç¨‹åºGUID}


è¿˜æœ‰å…¶å®ƒä¸€äº›è¯­è¨€å¤„ç†ç­‰ APIï¼Œä½¿ç”¨å•†åœºåº”ç”¨æ¨¡å¼æ˜¯æŒºæ–¹ä¾¿çš„ã€‚

æ¥ä¸‹æ¥è¯´ä¸€ä¸‹è‡ªå®šä¹‰æ‰“åŒ…æ¨¡å¼ï¼Œå°±æ˜¯ç›´æ¥ç¼–è¯‘ç”Ÿæˆä¸€å †æ–‡ä»¶ï¼Œç„¶åç›´æ¥å¯åŠ¨ exe å°±èƒ½è¿è¡Œçš„ï¼Œä¸éœ€è¦å®‰è£…ã€‚å¦‚æœæƒ³åšæˆå®‰è£…åŒ…ï¼Œå¯ä»¥å…ˆå‘å¸ƒï¼Œç„¶åä½¿ç”¨æ‰“åŒ…å·¥å…·æ‰“åŒ…ã€‚

å°±æ˜¯åœ¨é¡¹ç›®æ–‡ä»¶ä¸­åŠ ä¸Šè¿™ä¸¤å¥å³å¯ï¼š

    		<WindowsPackageType>None</WindowsPackageType>
    		<WindowsAppSDKSelfConatined>true</WindowsAppSDKSelfConatined>


ä¹‹åä¼šç›´æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸å†éœ€è¦å®‰è£… MAUI åº”ç”¨æ‰è¡Œè¿è¡Œèµ·æ¥ï¼Œä¹Ÿä¸éœ€è¦è¯ä¹¦æ‰èƒ½è¿è¡Œã€‚

### ä¸º MAUI Blazor è®¾ç½®è¯­è¨€

MAUI Blazor åœ¨ Windows ä¸Šä½¿ç”¨çš„æ˜¯ WebView2ï¼ŒMAUI Blazor è¿è¡Œç¯å¢ƒæ˜¯è·Ÿç¨‹åºæ²¡å…³ç³»çš„ï¼Œå³ä½¿æ˜¯ç³»ç»Ÿè®¾ç½®äº†ä¸­æ–‡è¯­è¨€ï¼Œç¨‹åºé›†è®¾ç½®äº†ä¸­æ–‡ï¼Œæœ¬åœ°æ–‡åŒ–è®¾ç½®äº†ä¸­æ–‡ï¼ŒCultureInfo è®¾ç½®äº†ä¸­æ–‡ï¼Œç»Ÿç»Ÿéƒ½æ²¡æœ‰ç”¨ã€‚

ä½ å¯ä»¥åœ¨ç¨‹åºå¯åŠ¨åï¼ŒæŒ‰ä¸‹ F12ï¼Œç„¶åæ‰§è¡Œ JavaScript ä»£ç ï¼Œæ£€æŸ¥æµè§ˆå™¨çš„è¿è¡Œç¯å¢ƒæ˜¯ä½•ç§è¯­è¨€ï¼š

    navigator.language
    'en-US'


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437818-1515689724.png)

æˆ–è€…ä½¿ç”¨ APIï¼š

    // using Windows.Globalization
    var langs = ApplicationLanguages.Languages.ToList<string>();


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437548-1713893586.png)

#### å‘ â‘ 

é¦–å…ˆï¼Œè®¾ç½® Windows.Globalizationï¼š

                ApplicationLanguages.PrimaryLanguageOverride = "zh-CN";


ç„¶åé‡æ–°å¯åŠ¨ç¨‹åºï¼Œå‘ç°ï¼š

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194436459-1652242874.png)

ä½†æ˜¯æµè§ˆå™¨è¯­è¨€ç¯å¢ƒä¾ç„¶æ²¡æœ‰å˜åŒ–ï¼š  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437818-1515689724.png)

> åŸå› æ˜¯ `Preferences` æ–‡ä»¶éœ€è¦é‡æ–°ç”Ÿæˆæ‰èƒ½èµ·æ•ˆï¼Œåé¢ä¼šæåˆ°ã€‚

#### å‘ â‘¡

ç¨‹åºå¯åŠ¨åï¼Œä¼šåœ¨ `{Windowsç¨‹åºæ•°æ®ç›®å½•}/{ä½ çš„ç¨‹åºID}/LocalState\EBWebView\Default` ä¸‹é¢ç”Ÿæˆä¸€äº› WebView2 çš„æ–‡ä»¶ï¼Œå…¶ä¸­ Preferences æ–‡ä»¶ï¼Œé‡Œé¢é…ç½®äº† WebView2 çš„å‚æ•°ã€‚

æ‰¾åˆ°è‡ªå·±çš„ç¨‹åºæ•°æ®ç›®å½•ï¼š

    var path = Windows.Storage.ApplicationData.Current.LocalFolder.Path;


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194438609-1585219526.png)

å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ‰‹åŠ¨çš„æ–¹å¼ä¿®æ”¹æ–‡ä»¶ï¼Œè®© WebView2 ä½¿ç”¨ä¸­æ–‡ç¯å¢ƒã€‚

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439417-1518611699.png)

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439798-1121533972.png)

    var langs = ApplicationLanguages.Languages.ToList<string>();
    var cultureInfo = CultureInfo.InstalledUICulture;
    var index = langs.FindIndex((lang) => cultureInfo.Equals(CultureInfo.CreateSpecificCulture(lang)));
    if (index > 0)
    {
    	ApplicationLanguages.PrimaryLanguageOverride = cultureInfo.Name;
    	// "...this is immediately reflected in the ApplicationLanguages.Languages property."
    	langs = ApplicationLanguages.Languages.ToList<string>();
    }
    var selectedLangs = string.Join(",", langs);
    // Should check if this is the same as before but...
    var preferences = Windows.Storage.ApplicationData.Current.LocalFolder.Path + "\\EBWebView\\Default\\Preferences";
    if (File.Exists(preferences))
    {
    	var jsonString = File.ReadAllText(preferences);
    	var jsonObject = JObject.Parse(jsonString);    // using Newtonsoft.JSON
    	//var intl = jsonObject["intl"];
    	jsonObject["intl"] = JObject.Parse($@"{{""selected_languages"": ""{selectedLangs}"",""accept_languages"": ""{selectedLangs}""}}");
    	jsonString = JsonConvert.SerializeObject(jsonObject);
            File.WriteAllText(preferences, jsonString);
    }


#### å‘ â‘¢

æœ€åæˆ‘å‘ç°ï¼Œ â‘  çš„æ€è·¯æ˜¯å¯¹çš„ï¼Œä¸èµ·æ•ˆçš„åŸå› æ˜¯ `Preferences` æ–‡ä»¶éœ€è¦åˆ é™¤ç­‰é‡æ–°åˆ›å»ºæ‰è¡Œï¼Œåªè¦åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼ˆWebView å°šæœªå¯åŠ¨ï¼‰ï¼Œè®¾ç½®ä¸­æ–‡å³å¯ã€‚  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439067-1111180504.png)

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194438992-2056247917.png)

æ£€æŸ¥ä»£ç ï¼š

        public static class MauiProgram
        {
            private static void SetWebViewLanguage()
            {
                ApplicationLanguages.PrimaryLanguageOverride = "zh-CN";
    
                var basePath = Windows.Storage.ApplicationData.Current.LocalFolder.Path;
                var preferencesFile = Path.Combine(basePath, "EBWebView/Default/Preferences"); // Preferences
                if (!File.Exists(preferencesFile)) return;
    
                var jsonString = File.ReadAllText(preferencesFile);
                var jsonObject = JsonObject.Parse(jsonString).AsObject();
                var languages = jsonObject["intl"]["selected_languages"].Deserialize<string>() ?? "";
                // "zh-CN,en,en-GB,en-US"
                if (!languages.StartsWith("zh-CN"))
                {
                    // File.Delete(preferencesFile);
                    jsonObject.Remove("intl");
                    jsonObject.Add("intl", JsonObject.Parse("{\"selected_languages\":\"zh-CN,en,en-GB,en-US\"}"));
                    jsonString = JsonSerializer.Serialize(jsonObject);
                    File.WriteAllText(preferencesFile, jsonString);
                }
            }


åœ¨ `public static MauiApp CreateMauiApp()` ä¸­ä½¿ç”¨ï¼š  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194438885-220751311.png)

### é…ç½® MAUI é¡¹ç›®ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¯åŠ¨

#### é—®é¢˜èƒŒæ™¯

åœ¨ Windows ä¸­ï¼Œå¼€å‘çš„åº”ç”¨å¯ä»¥ä½¿ç”¨ `app.manifest` èµ„äº§æ–‡ä»¶é…ç½®ç¨‹åºå¯åŠ¨æ—¶ï¼Œä½¿ç”¨ä½•ç§è§’è‰²æƒé™å¯åŠ¨ã€‚

æ•ˆæœå¦‚ä¸‹ï¼š

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194438930-947438142.png)

æ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ `app.manifest` åŠ ä¸Šä»¥ä¸‹é…ç½®å³å¯ï¼š

> å¦‚æœé¡¹ç›®ä¸­æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­æ–°å»ºé¡¹-æ¸…å•æ–‡ä»¶ã€‚

      <trustInfo xmlns='urn:schemas-microsoft-com:asm.v2'>
        <security>
          <requestedPrivileges xmlns='urn:schemas-microsoft-com:asm.v3'>
            <requestedExecutionLevel level='requireAdministrator' uiAccess='false' />
          </requestedPrivileges>
        </security>
      </trustInfo>


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439653-1859738287.png)

ä½†æ˜¯åœ¨ MAUI åº”ç”¨ä¸­ï¼Œæ˜¯åŠ ä¸ä¸Šå»çš„ï¼Œå¦‚æœåŠ ä¸Šå»ï¼Œå°±ä¼šå‡ºç°æŠ¥é”™ã€‚

    Platforms\Windows\app.manifest : manifest authoring error c1010001: Values of attribute "level" not equal in different manifest snippets. 


å› ä¸º .NET ç¼–è¯‘å™¨ä¸­ï¼Œå·²ç»é»˜è®¤ä¸ºç¨‹åºç”Ÿæˆä¸€ä¸ª `app.manifest` æ–‡ä»¶ï¼Œå…¶æ–‡ä»¶å†…å®¹ä¸­å·²ç»åŒ…å«äº† `trustInfo` é…ç½®ã€‚

å¦‚æœé¡¹ç›®ä¸­å¼€å¯äº† `<WindowsAppSDKSelfConatined>true</WindowsAppSDKSelfConatined>`ï¼Œé‚£ä¹ˆåº”è¯¥æŸ¥çœ‹ `Microsoft.WindowsAppSDK.SelfContained.targets` æ–‡ä»¶ï¼š  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437679-1561700860.png)  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439532-1818878202.png)

æ‰€ä»¥å¦‚æœè¦è‡ªå®šä¹‰ `app.manifest` ï¼Œè¦ä¹ˆå°±æ˜¯æŠŠ Microsoft.WindowsAppSDK.SelfContained.targets æ”¹äº†ï¼Œä½†æ˜¯è¿™æ ·ä¸å¤ªå¥½ã€‚

#### å®šåˆ¶ç¼–è¯‘è¿‡ç¨‹

å¦‚æœè§‚å¯Ÿç¼–è¯‘è¿‡ç¨‹ï¼Œä¼šå‘ç° `manifest` æ–‡ä»¶ä¼šç”Ÿæˆåˆ° `obj` ç›®å½•ã€‚  
![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439208-179469448.png)

å…¶ä¸­ `mergeapp.manifest` ä¾¿æ˜¯é¡¹ç›®ä¸­çš„ `app.manifest` ï¼Œ.NET ç¼–è¯‘çš„æ—¶å€™å°†å¼€å‘è€…çš„æ–‡ä»¶æ”¹åå­—äº†ã€‚

ç¨‹åºç¼–è¯‘æ—¶ï¼Œé¦–å…ˆä» `Microsoft.WindowsAppSDK.SelfContained.targets` ä¸­ç”Ÿæˆé»˜è®¤çš„ `app.manifest`ã€‚  
æ¥ç€å°†å¼€å‘è€…é¡¹ç›®ä¸­çš„ `app.manifest` å¤åˆ¶ä¸º `mergeapp.manifest` æ–‡ä»¶ï¼Œç„¶åå°† `mergeapp.manifest` åˆå¹¶åˆ° `app.manifest`ã€‚

å¦‚æœ `app.manifest` ä¸­å·²ç»å­˜åœ¨é…ç½®ï¼Œé‚£ä¹ˆ `mergeapp.manifest` ä¸­é‡å¤çš„è®°å½•å°±ä¼šå¯¼è‡´ç¼–è¯‘æŠ¥é”™ã€‚

æ—¢ç„¶äº†è§£åˆ°äº†ç¼–è¯‘è¿‡ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­åšæ‰‹è„šã€‚  
æˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘ç”Ÿæˆ `app.manifest` ä½†æ˜¯è¿˜æ²¡æœ‰ç¼–è¯‘ä¸»ç¨‹åºçš„æ—¶å€™ï¼Œå°† `app.manifest` ä¸­çš„é…ç½®æ›¿æ¢æ‰ï¼Œæ›¿æ¢å‘½ä»¤æ˜¯ï¼š

    powershell -Command ";(gc app.manifest) -replace 'level=''asInvoker''', 'level=''requireAdministrator''' | Out-File -encoding ASCII app.manifest";


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439577-1198562873.png)

MSBuild ç¼–è¯‘ä½¿ç”¨åˆ°çš„æ­¥éª¤å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š  
[https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-targets?view=vs-2022](https://learn.microsoft.com/en-us/visualstudio/msbuild/msbuild-targets?view=vs-2022)

åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªé‡è¦çš„ç¯å¢ƒå˜é‡ï¼š  
`_DeploymentManifestFiles` ï¼šæ¸…å•æ–‡ä»¶æ‰€åœ¨ç›®å½•ï¼›  
`ApplicationManifest`ï¼š `app.manifest` æ–‡ä»¶è·¯å¾„ã€‚

å¯ä»¥åœ¨ `.csproj` æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹è„šæœ¬ï¼Œè¿™æ ·ä¼šåœ¨ç¨‹åºç¼–è¯‘æ—¶ï¼Œè‡ªåŠ¨ä¿®æ”¹æ¸…å•æ–‡ä»¶ã€‚

    	<Target Name="RequireAdministrator" BeforeTargets="GenerateManifests" Condition="'$(PublishDir)' != ''">
    		<Exec WorkingDirectory="./" Command="echo $(ApplicationManifest)" />
    		<Exec WorkingDirectory="./" Command="echo $(_DeploymentManifestFiles)" />
    		<Exec WorkingDirectory="$(_DeploymentManifestFiles)" Command="dir" />
    		<Exec WorkingDirectory="$(_DeploymentManifestFiles)" Command="powershell -Command "(gc app.manifest) -replace 'level=''asInvoker''', 'level=''requireAdministrator''' | Out-File -encoding ASCII app.manifest"" />
    	</Target>


`BeforeTargets="GenerateManifests"` è¡¨æ˜åœ¨ GenerateManifests ä¹‹å‰ï¼Œæ‰§è¡Œé‡Œé¢çš„è‡ªå®šä¹‰å‘½ä»¤ã€‚

`Condition="'$(PublishDir)' != ''"` è¡¨ç¤ºè§¦å‘æ¡ä»¶ï¼Œåœ¨ MAUI ä¸­ï¼Œåªæœ‰å‘å¸ƒçš„æ—¶å€™æ‰ä¼šæœ‰è¿™ä¸ªå˜é‡ï¼Œä¹Ÿå¯ä»¥æ”¹æˆ `Condition="'$(Release)' != ''"`ã€‚

æ³¨æ„ï¼Œæœ‰äº›æƒ…å†µä¸‹ `_DeploymentManifestFiles` ç›®å½•ä¼šä¸å­˜åœ¨ï¼Œå› æ­¤å¯ä»¥å¤šæ¬¡æµ‹è¯•ä¸€ä¸‹ã€‚

å½“ç„¶ï¼Œæœ€ä¿é™©çš„æ–¹æ³•ï¼š

    	<Target Name="RequireAdministrator" BeforeTargets="GenerateManifests" Condition="'$(PublishDir)' != ''">
    		<Exec WorkingDirectory="./" Command=" powershell -Command "(gc $(ApplicationManifest)) -replace 'level=''asInvoker''', 'level=''requireAdministrator''' | Out-File -encoding UTF8 $(ApplicationManifest)"" />
    	</Target>




ç¼–è¯‘è¿‡ç¨‹ä¸»è¦åœ¨ä»¥ä¸‹ä¸‰æ­¥ï¼Œå…¶ä¸­åªæœ‰ `GenerateManifests` èƒ½å¤Ÿåœ¨ `.csproj` ä¸­ä½¿ç”¨ã€‚

    <Target Name="GenerateManifests"
            Condition="'$(GenerateClickOnceManifests)'=='true' or '@(NativeReference)'!='' or '@(ResolvedIsolatedComModules)'!='' or '$(GenerateAppxManifest)' == 'true'"
            DependsOnTargets="$(GenerateManifestsDependsOn)"/>
    
    ===================================================
    GenerateApplicationManifest
    Generates a ClickOnce or native application manifest.
    An application manifest specifies declarative application identity, dependency and security information.
    ===================================================
    <Target Name="GenerateApplicationManifest"
            DependsOnTargets="
                    _DeploymentComputeNativeManifestInfo;
                    _DeploymentComputeClickOnceManifestInfo;
                    ResolveComReferences;
                    ResolveNativeReferences;
                    _GenerateResolvedDeploymentManifestEntryPoint"
            Inputs="
                    $(MSBuildAllProjects);
                    @(AppConfigWithTargetPath);
                    $(_DeploymentBaseManifest);
                    @(ResolvedIsolatedComModules);
                    @(_DeploymentManifestDependencies);
                    @(_DeploymentResolvedManifestEntryPoint);
                    @(_DeploymentManifestFiles)"
            Outputs="@(ApplicationManifest)">


èƒ½å¤Ÿæ‹¿åˆ°å‚æ•°ï¼š

                    $(_DeploymentBaseManifest);
                    @(ResolvedIsolatedComModules);
                    @(_DeploymentManifestDependencies);
                    @(_DeploymentResolvedManifestEntryPoint);
                    @(_DeploymentManifestFiles)
    				@(ApplicationManifest)


### MAUI å®ç°å‰åç«¯åˆ†ç¦»å¼€å‘

#### èƒŒæ™¯

æœ€å…ˆé‡‡ç”¨çš„æ˜¯ Maui + Blazor å¼€å‘ï¼Œä½¿ç”¨ç¤¾åŒºçƒ­åº¦æ¯”è¾ƒé«˜çš„ Blazor UI æ¡†æ¶ã€‚

å¯æ˜¯å¼€å‘è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œ Maui å·¨å¤šå‘ï¼ŒBlazor UI æ¡†æ¶ä¹Ÿæ˜¯å·¨å¤šå‘ï¼Œä½¿ç”¨ Blazor UI å†™çš„é¡µé¢å’Œæ ·å¼ï¼Œè¿‡ä¸äº†è®¾è®¡å¸ˆå’Œäº§å“ç»ç†çš„æ˜¯æ³•çœ¼ã€‚

æœ€ç»ˆå†³å®šä½¿ç”¨åŸç”Ÿå‰ç«¯ç»“åˆï¼Œç”Ÿæˆé™æ€å†…å®¹æ”¾åˆ° Maui ä¸­ï¼Œç„¶åå°†ä¸¤è€…ç»“åˆèµ·æ¥æ‰“åŒ…å‘å¸ƒã€‚

#### å…ˆæå‰ç«¯

å¯¹äºå‰ç«¯æ¥è¯´ï¼ŒæŒ‰ç…§æ­£å¸¸çš„å¼€å‘æ¨¡å¼å°±è¡Œï¼Œä¸å¯¹å¯¹å‰ç«¯çš„ä»£ç äº§ç”Ÿæ±¡æŸ“ã€‚

å¯ä»¥ä½¿ç”¨ VS åˆ›å»ºå‰ç«¯é¡¹ç›®ï¼Œå°†å…¶æ”¾åˆ°è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¹Ÿå¯ä»¥å•ç‹¬åˆ›å»ºä¸€ä¸ªç›®å½•ï¼Œå°†å‰ç«¯ä»£ç æ”¾åˆ°é‡Œé¢ã€‚

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439419-1512064700.png)

#### åˆ›å»º MAUI Blazor é¡¹ç›®

åˆ›å»º MAUI Blazor é¡¹ç›®ï¼Œç„¶åè§£å†³æ–¹æ¡ˆå¦‚ä¸‹æ‰€ç¤ºï¼š

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194437496-144878162.png)

é¦–å…ˆå°† `wwwroot/css/app.css` æ–‡ä»¶ç§»å‡ºæ¥ï¼Œæ”¾åˆ° `wwwroot`ä¸­ï¼Œç„¶åæ–°å»ºä¸€ä¸ª `app.js` ä¹Ÿæ˜¯æ”¾åˆ° `wwwroot` ä¸­ã€‚

å°† `app.css` æ–‡ä»¶ä¸­çš„å†…å®¹åˆ é™¤ä¸ Blazor æ— å…³çš„å†…å®¹ï¼Œåªä¿ç•™ä»¥ä¸‹å†…å®¹ï¼š

    #blazor-error-ui {
        background: lightyellow;
        bottom: 0;
        box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
        display: none;
        left: 0;
        padding: 0.6rem 1.25rem 0.7rem 1.25rem;
        position: fixed;
        width: 100%;
        z-index: 1000;
    }
    
    #blazor-error-ui .dismiss {
        cursor: pointer;
        position: absolute;
        right: 0.75rem;
        top: 0.5rem;
    }
    
    .blazor-error-boundary {
        background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTYiIGhlaWdodD0iNDkiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIG92ZXJmbG93PSJoaWRkZW4iPjxkZWZzPjxjbGlwUGF0aCBpZD0iY2xpcDAiPjxyZWN0IHg9IjIzNSIgeT0iNTEiIHdpZHRoPSI1NiIgaGVpZ2h0PSI0OSIvPjwvY2xpcFBhdGg+PC9kZWZzPjxnIGNsaXAtcGF0aD0idXJsKCNjbGlwMCkiIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yMzUgLTUxKSI+PHBhdGggZD0iTTI2My41MDYgNTFDMjY0LjcxNyA1MSAyNjUuODEzIDUxLjQ4MzcgMjY2LjYwNiA1Mi4yNjU4TDI2Ny4wNTIgNTIuNzk4NyAyNjcuNTM5IDUzLjYyODMgMjkwLjE4NSA5Mi4xODMxIDI5MC41NDUgOTIuNzk1IDI5MC42NTYgOTIuOTk2QzI5MC44NzcgOTMuNTEzIDI5MSA5NC4wODE1IDI5MSA5NC42NzgyIDI5MSA5Ny4wNjUxIDI4OS4wMzggOTkgMjg2LjYxNyA5OUwyNDAuMzgzIDk5QzIzNy45NjMgOTkgMjM2IDk3LjA2NTEgMjM2IDk0LjY3ODIgMjM2IDk0LjM3OTkgMjM2LjAzMSA5NC4wODg2IDIzNi4wODkgOTMuODA3MkwyMzYuMzM4IDkzLjAxNjIgMjM2Ljg1OCA5Mi4xMzE0IDI1OS40NzMgNTMuNjI5NCAyNTkuOTYxIDUyLjc5ODUgMjYwLjQwNyA1Mi4yNjU4QzI2MS4yIDUxLjQ4MzcgMjYyLjI5NiA1MSAyNjMuNTA2IDUxWk0yNjMuNTg2IDY2LjAxODNDMjYwLjczNyA2Ni4wMTgzIDI1OS4zMTMgNjcuMTI0NSAyNTkuMzEzIDY5LjMzNyAyNTkuMzEzIDY5LjYxMDIgMjU5LjMzMiA2OS44NjA4IDI1OS4zNzEgNzAuMDg4N0wyNjEuNzk1IDg0LjAxNjEgMjY1LjM4IDg0LjAxNjEgMjY3LjgyMSA2OS43NDc1QzI2Ny44NiA2OS43MzA5IDI2Ny44NzkgNjkuNTg3NyAyNjcuODc5IDY5LjMxNzkgMjY3Ljg3OSA2Ny4xMTgyIDI2Ni40NDggNjYuMDE4MyAyNjMuNTg2IDY2LjAxODNaTTI2My41NzYgODYuMDU0N0MyNjEuMDQ5IDg2LjA1NDcgMjU5Ljc4NiA4Ny4zMDA1IDI1OS43ODYgODkuNzkyMSAyNTkuNzg2IDkyLjI4MzcgMjYxLjA0OSA5My41Mjk1IDI2My41NzYgOTMuNTI5NSAyNjYuMTE2IDkzLjUyOTUgMjY3LjM4NyA5Mi4yODM3IDI2Ny4zODcgODkuNzkyMSAyNjcuMzg3IDg3LjMwMDUgMjY2LjExNiA4Ni4wNTQ3IDI2My41NzYgODYuMDU0N1oiIGZpbGw9IiNGRkU1MDAiIGZpbGwtcnVsZT0iZXZlbm9kZCIvPjwvZz48L3N2Zz4=) no-repeat 1rem/1.8rem, #b32121;
        padding: 1rem 1rem 1rem 3.7rem;
        color: white;
    }
    
    .blazor-error-boundary::after {
        content: "An error has occurred."
    }
    
    .status-bar-safe-area {
        display: none;
    }
    
    @supports (-webkit-touch-callout: none) {
        .status-bar-safe-area {
            display: flex;
            position: sticky;
            top: 0;
            height: env(safe-area-inset-top);
            background-color: #f7f7f7;
            width: 100%;
            z-index: 1;
        }
    
    	.flex-column, .navbar-brand {
    		padding-left: env(safe-area-inset-left);
    	}
    }


â€‹    

æ¥ç€ï¼Œå°†ä»¥ä¸‹ä»£ç æ”¾åˆ° `app.js` ä¸­ï¼Œç”¨äºåŠ¨æ€å¯¼å…¥å‰ç«¯ç”Ÿæˆçš„ css æ–‡ä»¶ã€‚

    function InitializeCss(name) {
        document.getElementById("app-css").innerHTML = '<link rel="stylesheet" href="' + name + '">';
    }


ç„¶ååˆ é™¤ `js`ã€`css` ç›®å½•ã€‚

å‰©ä¸‹çš„æ–‡ä»¶å¦‚å›¾æ‰€ç¤ºï¼š

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439200-1658722071.png)

ç„¶åä¿®æ”¹ `index.html`ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

    <!DOCTYPE html>
    <html lang="en">
    <head>
    	<meta charset="utf-8" />
    	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    	<title>MauiApp3</title>
    	<base href="/" />
    	<link href="/app.css" rel="stylesheet" />
    </head>
    
    <body>
    	<div id="app-css"></div>
    	<div class="status-bar-safe-area"></div>
    	<div id="app">Loading...</div>
    
    	<div id="blazor-error-ui">
    		An unhandled error has occurred.
    		<a href="" class="reload">Reload</a>
    		<a class="dismiss">ğŸ—™</a>
    	</div>
    	<script src="app.js"></script>
    	<script src="_framework/blazor.webview.js" autostart="false"></script>
    
    </body>
    
    </html>


å¢åŠ çš„ `<div id="app-css"></div>`ï¼Œç”¨äºåŠ¨æ€åŠ è½½ css æ–‡ä»¶ã€‚

å…¶å®ƒå†…å®¹åŸºæœ¬ä¸å˜ã€‚

æ‰“å¼€ `MainLayout.razor`ï¼Œè¿™é‡Œè´Ÿè´£åŠ¨æ€åŠ è½½å‰ç«¯æ–‡ä»¶ï¼Œå…¶å†…å®¹å¦‚ä¸‹ï¼š

    @using MauiApp3.Data
    @inherits LayoutComponentBase


â€‹    
    @code {
    
        #region static fields
    
        private static readonly string[] css;
        private static readonly string[] js;
    
        #endregion
    
        #region instance fields
    
        [Inject]
        private IJSRuntime JS { get; set; }
    
        #endregion
    
        static MainLayout()
        {
            var path = Windows.ApplicationÂ­Model.Package.Current.InstalledÂ­Location.Path;
    
            if (Directory.Exists(Path.Combine(path, "wwwroot", "css")))
            {
                var cssList = Directory.GetFiles(Path.Combine(path, "wwwroot", "css"))
                .Where(x => x.EndsWith(".css"))
                .Select(x => Path.GetFileName(x)).ToArray();
                css = cssList;
            }
            else css = Array.Empty<string>();
    
            if (Directory.Exists(Path.Combine(path, "wwwroot", "js")))
            {
                var jsList = Directory.GetFiles(Path.Combine(path, "wwwroot", "js"))
                    .Where(x => x.EndsWith(".js"))
                    .Select(x => Path.GetFileName(x)).ToArray();
                js = jsList;
            }
            else js = Array.Empty<string>();
        }


â€‹    
        protected override async Task OnInitializedAsync()
        {
            await Task.CompletedTask;
        }


â€‹    
        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (firstRender)
            {
                foreach (var item in css)
                {
                    await JS.InvokeVoidAsync("InitializeCss", $"css/{item}");
                }
    
                foreach (var item in js)
                {
                    await JS.InvokeAsync<IJSObjectReference>("import", $"/js/{item}");
                }
            }
        }
    }


ç„¶åä¸ºäº†èƒ½å¤Ÿå°†å‰ç«¯ç”Ÿæˆçš„å†…å®¹è‡ªåŠ¨å¤åˆ¶åˆ° Maui ä¸­ï¼Œå¯ä»¥è®¾ç½®è„šæœ¬ï¼Œåœ¨ Maui çš„ `.csproj` ä¸­ï¼Œå¢åŠ ä»¥ä¸‹å†…å®¹ï¼š

    	<Target Name="ClientBuild"   BeforeTargets="BeforeBuild">
    		<Exec WorkingDirectory="../vueproject1" Command="npm install" />
    		<Exec WorkingDirectory="../vueproject1" Command="npm run build" />
    		<Exec WorkingDirectory="../vueproject1" Command="DEL "dist\index.html"" />
    		<Exec WorkingDirectory="./" Command="RMDIR /s/q "css"" />
    		<Exec WorkingDirectory="./" Command="RMDIR /s/q "js"" />
    		<Exec WorkingDirectory="../vueproject1" Command="Xcopy "dist" "../MauiApp3/wwwroot"  /E/C/I/Y" />
    		<Exec WorkingDirectory="./" Command="RMDIR /s/q "$(LayoutDir)""/>
    	</Target>


![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439907-2011339103.png)

è¿™æ ·å½“å¯åŠ¨ Maui é¡¹ç›®æ—¶ï¼Œä¼šç¼–è¯‘å‰ç«¯é¡¹ç›®ï¼Œç„¶åå°†ç”Ÿæˆçš„æ–‡ä»¶(ä¸åŒ…æ‹¬ index.html) å¤åˆ¶åˆ° wwwroot ç›®å½•ä¸­ã€‚

å¯åŠ¨åï¼š

![file](https://img2023.cnblogs.com/blog/1315495/202301/1315495-20230118194439143-1595621257.png)

### C# è‡ªåŠ¨åŒ–ç”Ÿæˆè¯ä¹¦ã€æœ¬åœ°å®‰è£…è¯ä¹¦ã€è§£å†³ä¿¡ä»»è¯ä¹¦é—®é¢˜

#### èƒŒæ™¯

å› ä¸ºå¼€å‘ Blazor æ—¶ ç¯å¢ƒæ˜¯ `https://0.0.0.0/` ï¼Œä¹Ÿå°±æ˜¯ MAUI Blazor ä¸­åªèƒ½å‘å‡º https è¯·æ±‚ï¼Œæ—¢ä¸èƒ½å‘å‡º http è¯·æ±‚ï¼Œä¹Ÿä¸èƒ½å‘å‡ºä¸å®‰å…¨çš„ https è¯·æ±‚ï¼Œä½†æ˜¯å†…ç½‘çš„ https æ˜¯ä¸å®‰å…¨çš„ httpsã€‚  
äºæ˜¯ï¼Œåªèƒ½å†æœ¬åœ°å®ç°ä¸€ä¸ªä»£ç†æœåŠ¡ï¼Œç„¶åè®©åº”ç”¨é€šè¿‡ https è®¿é—®ï¼Œä¸ºäº†è®© https å®‰å…¨ï¼Œéœ€è¦å®‰è£…è‡ªåŠ¨åŒ–è¯ä¹¦ã€‚

ä¼šå¯¼è‡´ js å‘ä¸å‡ºè¯·æ±‚ã€‚  
ä¸ºäº†è®© https å®‰å…¨ï¼Œè¿™é‡Œå®ç°äº†æœ¬åœ° localhost è‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ä»¥åŠå®‰è£…çš„è¿‡ç¨‹ã€‚

#### å†™ä»£ç 

ç”Ÿæˆè¯ä¹¦ä½¿ç”¨çš„æ˜¯ .NET è‡ªå¸¦çš„åº“ï¼Œä¸éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹åŒ…ã€‚

    using System.Security.Cryptography;
    using System.Security.Cryptography.X509Certificates;
    using System.Text;


ç”Ÿæˆè¯ä¹¦çš„æ–¹æ³•å‚è€ƒ [https://github.com/dotnetcore/FastGithub](https://github.com/dotnetcore/FastGithub) é¡¹ç›®ã€‚

ç¬¬ä¸€æ­¥æ˜¯ç¼–å†™ä¸€ä¸ªè¯ä¹¦ç”Ÿæˆå™¨ï¼Œå…¶ä¸­ï¼Œä»£ç ç›´æ¥ä»è¿™é‡Œå¤åˆ¶ï¼š [https://github.com/dotnetcore/FastGithub/blob/9f9cbce624310c207b01699de2a5818a742e11ca/FastGithub.HttpServer/Certs/CertGenerator.cs](https://github.com/dotnetcore/FastGithub/blob/9f9cbce624310c207b01699de2a5818a742e11ca/FastGithub.HttpServer/Certs/CertGenerator.cs)

ç„¶åï¼Œå®šä¹‰ç®¡ç†ç”Ÿæˆè¯ä¹¦çš„æœåŠ¡ï¼ŒåŸç‰ˆä½œè€…ä½¿ç”¨çš„æ˜¯ .NET 7ï¼Œè€Œä¸”å½“å‰ç¨³å®šç‰ˆæœ¬æ˜¯ .NET 6ï¼Œå¾ˆå¤š API ä¸èƒ½ä½¿ç”¨ï¼Œå› æ­¤éœ€è¦å¯¹å…¶æ”¹é€ ã€‚åŸç‰ˆåœ°å€ï¼š  
[https://github.com/dotnetcore/FastGithub/blob/9f9cbce624310c207b01699de2a5818a742e11ca/FastGithub.HttpServer/Certs/CertService.cs](https://github.com/dotnetcore/FastGithub/blob/9f9cbce624310c207b01699de2a5818a742e11ca/FastGithub.HttpServer/Certs/CertService.cs)

å®šä¹‰è¯ä¹¦ä½ç½®å’Œåç§°ï¼š

            private const string CACERT_PATH = "cacert";
    
            /// <summary>
            /// è·å–è¯ä¹¦æ–‡ä»¶è·¯å¾„
            /// </summary>
            public string CaCerFilePath { get; } = OperatingSystem.IsLinux() ? $"{CACERT_PATH}/https.crt" : $"{CACERT_PATH}/https.cer";
    
            /// <summary>
            /// è·å–ç§é’¥æ–‡ä»¶è·¯å¾„
            /// </summary>
            public string CaKeyFilePath { get; } = $"{CACERT_PATH}/https.key";


è¿™é‡Œæ¶‰åŠåˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œå®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥ã€‚  
`.key` æ˜¯ç§é’¥ï¼Œå¯ä»¥é€šè¿‡ç§é’¥æ¥ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼Œå› æ­¤è¿™é‡Œåªéœ€è¦ä¿å­˜ `.key` ç§é’¥ï¼Œä¸éœ€è¦å¯¼å‡ºæœåŠ¡å™¨è¯ä¹¦ã€‚  
`.csr`ã€`.cer` æ˜¯å®¢æˆ·ç«¯è¯ä¹¦ï¼Œåœ¨ Windows ä¸‹å¯ä»¥ä½¿ç”¨ .`cer` æ ¼å¼ã€‚å¯¼å‡ºå®¢æˆ·ç«¯è¯ä¹¦çš„åŸå› æ˜¯è¦å®‰è£…è¯ä¹¦ï¼Œè€Œä¸”å®‰è£…ä¸€æ¬¡å³å¯ï¼Œä¸éœ€è¦åŠ¨æ€ç”Ÿæˆã€‚

è¯ä¹¦ç®¡ç†æœåŠ¡çš„è§„åˆ™æ˜¯ï¼Œå¦‚æœ `ssl` ç›®å½•ä¸‹æ²¡æœ‰è¯ä¹¦ï¼Œé‚£ä¹ˆå°±ç”Ÿæˆå¹¶å®‰è£…ï¼›å¦‚æœå‘ç°æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™åŠ è½½æ–‡ä»¶åˆ°å†…å­˜ï¼Œä¸ä¼šé‡æ–°å®‰è£…ã€‚

å®Œæ•´ä»£ç å¦‚ä¸‹ï¼š

        /// <summary>
        /// è¯ä¹¦ç”ŸæˆæœåŠ¡
        /// </summary>
        internal class CertService
        {
    
            private const string CACERT_PATH = "cacert";
    
            /// <summary>
            /// è·å–è¯ä¹¦æ–‡ä»¶è·¯å¾„
            /// </summary>
            public string CaCerFilePath { get; } = OperatingSystem.IsLinux() ? $"{CACERT_PATH}/https.crt" : $"{CACERT_PATH}/https.cer";
    
            /// <summary>
            /// è·å–ç§é’¥æ–‡ä»¶è·¯å¾„
            /// </summary>
            public string CaKeyFilePath { get; } = $"{CACERT_PATH}/https.key";
    
            private X509Certificate2? caCert;


â€‹    
            /*
             æœ¬åœ°ä¼šç”Ÿæˆ cer å’Œ key ä¸¤ä¸ªæ–‡ä»¶ï¼Œcer æ–‡ä»¶å¯¼å…¥åˆ° Window è¯ä¹¦ç®¡ç†å™¨ä¸­ã€‚
             key æ–‡ä»¶ç”¨äºæ¯æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆ X509 è¯ä¹¦ï¼Œè®© Web æœåŠ¡ä½¿ç”¨ã€‚
             */
    
            /// <summary>
            /// ç”Ÿæˆ CA è¯ä¹¦
            /// </summary> 
            public bool CreateCaCertIfNotExists()
            {
                if (!Directory.Exists(CACERT_PATH)) Directory.CreateDirectory(CACERT_PATH);
                if (File.Exists(this.CaCerFilePath) && File.Exists(this.CaKeyFilePath))
                {
                    return false;
                }
    
                File.Delete(this.CaCerFilePath);
                File.Delete(this.CaKeyFilePath);
    
                var notBefore = DateTimeOffset.Now.AddDays(-1);
                var notAfter = DateTimeOffset.Now.AddYears(10);
    
                var subjectName = new X500DistinguishedName($"CN=ç—´è€…å·¥è‰¯");
                this.caCert = CertGenerator.CreateCACertificate(subjectName, notBefore, notAfter);
    
                var privateKeyPem = ExportRSAPrivateKeyPem(this.caCert.GetRSAPrivateKey());
                File.WriteAllText(this.CaKeyFilePath, new string(privateKeyPem), Encoding.ASCII);
    
                var certPem = ExportCertificatePem(this.caCert);
                File.WriteAllText(this.CaCerFilePath, new string(certPem), Encoding.ASCII);
    
                return true;
            }
    
            /// <summary>
            /// è·å–é¢å‘ç»™æŒ‡å®šåŸŸåçš„è¯ä¹¦
            /// </summary>
            /// <param name="domain"></param> 
            /// <returns></returns>
            public X509Certificate2 GetOrCreateServerCert(string? domain)
            {
                if (this.caCert == null)
                {
                    using var rsa = RSA.Create();
                    rsa.ImportFromPem(File.ReadAllText(this.CaKeyFilePath));
                    this.caCert = new X509Certificate2(this.CaCerFilePath).CopyWithPrivateKey(rsa);
                }
    
                var key = $"{nameof(CertService)}:{domain}";
                var endCert = GetOrCreateCert();
                return endCert!;
    
                // ç”ŸæˆåŸŸåçš„1å¹´è¯ä¹¦
                X509Certificate2 GetOrCreateCert()
                {
                    var notBefore = DateTimeOffset.Now.AddDays(-1);
                    var notAfter = DateTimeOffset.Now.AddYears(1);
    
                    var extraDomains = GetExtraDomains();
    
                    var subjectName = new X500DistinguishedName($"CN={domain}");
                    var endCert = CertGenerator.CreateEndCertificate(this.caCert, subjectName, extraDomains, notBefore, notAfter);
    
                    // é‡æ–°åˆå§‹åŒ–è¯ä¹¦ï¼Œä»¥å…¼å®¹winå¹³å°ä¸èƒ½ä½¿ç”¨å†…å­˜è¯ä¹¦
                    return new X509Certificate2(endCert.Export(X509ContentType.Pfx));
                }
            }
            private static IEnumerable<string> GetExtraDomains()
            {
                yield return Environment.MachineName;
                yield return IPAddress.Loopback.ToString();
                yield return IPAddress.IPv6Loopback.ToString();
            }
    
            internal const string RasPrivateKey = "RSA PRIVATE KEY";
    
            private static string ExportRSAPrivateKeyPem(RSA rsa)
            {
                var key = rsa.ExportRSAPrivateKey();
                var chars = PemEncoding.Write(RasPrivateKey, key);
                return new string(chars);
            }
    
            private static string ExportCertificatePem(X509Certificate2 x509)
            {
                var chars = PemEncoding.Write(PemLabels.X509Certificate, x509.Export(X509ContentType.Cert));
                return new string(chars);
            }
    
            /// <summary>
            /// å®‰è£…caè¯ä¹¦
            /// </summary>
            /// <exception cref="Exception">ä¸èƒ½å®‰è£…è¯ä¹¦</exception>
            public void Install( )
            {
                var caCertFilePath = CaCerFilePath;
                try
                {
                    using var store = new X509Store(StoreName.Root, StoreLocation.LocalMachine);
                    store.Open(OpenFlags.ReadWrite);
    
                    var caCert = new X509Certificate2(caCertFilePath);
                    var subjectName = caCert.Subject[3..];
                    foreach (var item in store.Certificates.Find(X509FindType.FindBySubjectName, subjectName, false))
                    {
                        if (item.Thumbprint != caCert.Thumbprint)
                        {
                            store.Remove(item);
                        }
                    }
                    if (store.Certificates.Find(X509FindType.FindByThumbprint, caCert.Thumbprint, true).Count == 0)
                    {
                        store.Add(caCert);
                    }
                    store.Close();
                }
                catch (Exception ex)
                {
                    throw new Exception($"è¯·æ‰‹åŠ¨å®‰è£…CAè¯ä¹¦{caCertFilePath}åˆ°â€œå°†æ‰€æœ‰çš„è¯ä¹¦éƒ½æ”¾å…¥ä¸‹åˆ—å­˜å‚¨â€\\â€œå—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„â€" + ex);
                }
            }
        }
    }


â€‹    

#### åœ¨ ASP.NET Core ä¸­ä½¿ç”¨

åœ¨ ASP.NET Core ä¸­åŠ è½½æœåŠ¡ç«¯è¯ä¹¦ï¼ˆæ¯æ¬¡å¯åŠ¨æ—¶ç”Ÿæˆ X509 è¯ä¹¦ï¼‰ã€‚

                var sslService = new CertService();
                if(sslService.CreateCaCertIfNotExists())
                {
                    try
                    {
                        sslService.Install();
                    }
                    catch (Exception)
                    {
    
                    }
                }
    
               var webhost =  WebHost.CreateDefaultBuilder()
                    .UseStartup<Startup>()
                    .UseKestrel(serverOptions =>
                    {
                        serverOptions.ListenAnyIP(39999,
                            listenOptions =>
                            {
                                var certificate = sslService.GetOrCreateServerCert("localhost");
                                listenOptions.UseHttps(certificate);
                            });
                    })
                    .Build();
                await webhost.RunAsync();  


ä¸€ä¸ªé€—é€—çš„å¤§å­¦ç”Ÿ