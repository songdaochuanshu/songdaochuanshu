---
layout: post
title: "è¿™æ ·åœ¨ C# ä½¿ç”¨ LongRunnigTask æ˜¯é”™çš„"
date: "2023-03-06T01:15:09.534Z"
---
è¿™æ ·åœ¨ C# ä½¿ç”¨ LongRunnigTask æ˜¯é”™çš„
============================

Task.Factory.StartNew æœ‰ä¸€ä¸ªé‡è½½ï¼Œæ˜¯æ”¯æŒ TaskCreationOptions.LongRunning å‚æ•°æ¥æŒ‡å®š Task çš„ç‰¹å¾çš„ã€‚ä½†æ˜¯å¯èƒ½åœ¨æ²¡æœ‰æ³¨æ„çš„æƒ…å†µä¸‹ï¼Œä½ å°±ä½¿ç”¨äº†é”™è¯¯çš„ç”¨æ³•ã€‚é‚£ä¹ˆæœ¬æ–‡æˆ‘ä»¬æ¥ç®€å•é˜è¿°ä¸€ä¸‹è¿™ä¸ªå‚æ•°çš„ä½œç”¨ï¼Œå’Œä½¿ç”¨çš„æ³¨æ„è¦ç‚¹ã€‚

Task.Factory.StartNew æœ‰ä¸€ä¸ªé‡è½½ï¼Œæ˜¯æ”¯æŒ TaskCreationOptions.LongRunning å‚æ•°æ¥æŒ‡å®š Task çš„ç‰¹å¾çš„ã€‚ä½†æ˜¯å¯èƒ½åœ¨æ²¡æœ‰æ³¨æ„çš„æƒ…å†µä¸‹ï¼Œä½ å°±ä½¿ç”¨äº†é”™è¯¯çš„ç”¨æ³•ã€‚é‚£ä¹ˆæœ¬æ–‡æˆ‘ä»¬æ¥ç®€å•é˜è¿°ä¸€ä¸‹è¿™ä¸ªå‚æ•°çš„ä½œç”¨ï¼Œå’Œä½¿ç”¨çš„æ³¨æ„è¦ç‚¹ã€‚

è¿™æ ·å…¶å®æ˜¯é”™è¯¯çš„
--------

æœ‰çš„æ—¶å€™ï¼Œä½ å¯èƒ½ä¼šè¿™ä¹ˆå†™ï¼š

    Task.Factory.StartNew(async () =>
    {
        while (true)
        {
            // do something
            await Task.Delay(1000);
        }
    }, TaskCreationOptions.LongRunning);
    

ä½†å…¶å®ï¼Œè¿™æ˜¯ä¸ªé”™è¯¯çš„å†™æ³•ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ LongRunning
-----------------

æˆ‘ä»¬é€šå¸¸ä¸¤ç§æƒ…å†µä¸‹ä¼šæƒ³åˆ°ä½¿ç”¨ TaskCreationOptions.LongRunning å‚æ•°ï¼š

1.  ä½ çš„ä»»åŠ¡éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ªç¯ï¼Œæˆ–è€…ä¸€ä¸ªæ­»å¾ªç¯ã€‚ç”¨æ¥ä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œç„¶åå¤„ç†æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸€äº›å®šæ—¶ä»»åŠ¡ã€‚
2.  ä½ çš„ä»»åŠ¡éœ€è¦å ç”¨å¤§é‡çš„ CPU èµ„æºï¼Œæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å¾ªç¯ï¼Œæ¯”å¦‚è¦éå†ä¸€ä¸ªå¾ˆå¤§çš„æ•°ç»„ï¼Œå¹¶åšä¸€äº›å¤„ç†ã€‚

é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ TaskCreationOptions.LongRunning å‚æ•°æ¥æŒ‡å®š Taskã€‚

å› ä¸ºæˆ‘ä»¬å¯èƒ½å­¦ä¹ åˆ°äº†ï¼ŒTask é»˜è®¤çš„ Scheduler æ˜¯ ThreadPoolï¼Œè€Œ ThreadPool çš„çº¿ç¨‹æ˜¯æœ‰é™çš„ï¼Œå¦‚æœä½ çš„ä»»åŠ¡éœ€è¦é•¿æ—¶é—´è¿è¡Œï¼Œæˆ–è€…æ˜¯éœ€è¦å ç”¨å¤§é‡çš„ CPU èµ„æºï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ ThreadPool çš„çº¿ç¨‹ä¸å¤Ÿç”¨ã€‚å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼Œæˆ–è€…æ˜¯çº¿ç¨‹æ± çš„çº¿ç¨‹è¢«å ç”¨ï¼Œå¯¼è‡´å…¶ä»–çš„ä»»åŠ¡æ— æ³•æ‰§è¡Œã€‚

äºæ˜¯æˆ‘ä»¬å¾ˆèªæ˜çš„å°±æƒ³åˆ°äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ TaskCreationOptions.LongRunning å‚æ•°æ¥æŒ‡å®š Taskï¼Œè¿™æ ·å°±å¯ä»¥é¿å…çº¿ç¨‹é¥¥é¥¿ã€‚

å¼„å·§æˆæ‹™
----

ä½†æ˜¯å®é™…ä¸Šï¼Œå¼€ç¯‡çš„å†™æ³•å¹¶ä¸èƒ½è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥éªŒè¯ä¸€ä¸‹ï¼š

    var task = Task.Factory.StartNew(async () =>
    {
        while (true)
        {
            // do something
            await Task.Delay(1000);
        }
    }, TaskCreationOptions.LongRunning);
    
    Thread.Sleep(3000);
    
    Console.WriteLine($"Task Status: {task.Status}");
    // Task Status: RanToCompletion
    

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒTask çš„çŠ¶æ€æ˜¯å¹¶éæ˜¯ Runningï¼Œè€Œæ˜¯ RanToCompletionã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡åœ¨ 3 ç§’åå°±å·²ç»æ‰§è¡Œå®Œäº†ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„é•¿æ—¶é—´è¿è¡Œã€‚

ç©¶å…¶åŸå› ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬é‡‡ç”¨äº†å¼‚æ­¥çš„æ–¹å¼æ¥æ‰§è¡Œä»»åŠ¡ã€‚è€Œå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œæ˜¯é€šè¿‡ ThreadPool æ¥æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è™½ç„¶æˆ‘ä»¬ä½¿ç”¨äº† TaskCreationOptions.LongRunning å‚æ•°ï¼Œæ¥æƒ³åŠæ³•æŒ‡å®šçº¿ç¨‹æ± å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨ä¸€ä¸ª await ä¹‹åï¼Œæˆ‘ä»¬çš„ä»»åŠ¡è¿˜æ˜¯åœ¨ ThreadPool ä¸­æ‰§è¡Œçš„ã€‚**

è¿™ä¼šå¯¼è‡´ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å®é™…ä¸Šåç»­åˆå›åˆ°äº† ThreadPool ä¸­ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„å•ç‹¬çš„çº¿ç¨‹ã€‚èµ·ä¸åˆ°å•ç‹¬é•¿æœŸè¿è¡Œçš„ä½œç”¨ã€‚

æ­£ç¡®çš„å†™æ³•
-----

å› æ­¤ï¼Œå®é™…ä¸Šå¦‚æœæƒ³è¦ä¿æŒå•ç‹¬çš„çº¿ç¨‹æŒç»­çš„è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç§»é™¤å¼‚æ­¥çš„æ–¹å¼ï¼Œæ”¹ä¸ºåŒæ­¥çš„æ–¹å¼ã€‚

    var task = Task.Factory.StartNew(() =>
    {
        while (true)
        {
            // do something
            Thread.Sleep(1000);
        }
    }, TaskCreationOptions.LongRunning);
    
    Thread.Sleep(3000);
    
    Console.WriteLine($"Task Status: {task.Status}");
    // Task Status: Running
    

è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼ŒTask çš„çŠ¶æ€æ˜¯ Runningï¼Œè€Œä¸æ˜¯ RanToCompletionã€‚æˆ‘ä»¬é€šè¿‡ TaskCreationOptions.LongRunning å‚æ•°ï¼Œå•ç‹¬å¼€å¯çš„çº¿ç¨‹å°±å¯ä»¥ä¸€ç›´è¿è¡Œä¸‹å»ã€‚

å®é™…ä¸Šè¿˜æœ‰å¾ˆå¤šè€ƒé‡
---------

### è¦è€ƒé‡ TaskScheduler çš„å®ç°

æœ¬æ–‡é‡‡ç”¨çš„æ˜¯ aspnetcore çš„å®ç°ï¼Œä½†æ˜¯åœ¨å…¶ä»–çš„å®ç°ä¸­ï¼Œå¯èƒ½ä¼šæœ‰ä¸åŒçš„å®ç°ã€‚ä½ ä¹Ÿå®Œå…¨æœ‰å¯èƒ½å®ç°ä¸€ä¸ª await ä¹‹åï¼Œä¸å›åˆ° ThreadPool çš„å®ç°ã€‚

### LongRunning ä¹Ÿä¸æ˜¯å°±ä¸èƒ½ç”¨å¼‚æ­¥

æ­£å¦‚å¼€ç¯‡æåˆ°çš„ç¬¬äºŒç§åœºæ™¯ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡æ˜¯åœ¨ç¬¬ä¸€ä¸ª await ä¹‹å‰æœ‰å¤§é‡çš„åŒæ­¥ä»£ç ï¼Œé‚£ä¹ˆæ­¤æ—¶å•ç‹¬å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿæ˜¯æœ‰æ„ä¹‰çš„ã€‚

### æˆ‘å°±æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œé‡Œé¢ä¹Ÿæ˜¯å¼‚æ­¥çš„æ€ä¹ˆåŠ

é‚£ä¹ˆä½ å¯ä»¥è€ƒè™‘è®©è¿™ä¸ª LongRuning çš„ Taskï¼Œä¸è¦ awaitï¼Œè€Œæ˜¯é€šè¿‡ Wait() æ¥ç­‰å¾…ã€‚è¿™æ ·å°±å¯ä»¥é¿å… LongRunning çš„ Task ç›´æ¥ç»“æŸã€‚

æ€»ç»“
--

æœ¬æ–‡æˆ‘ä»¬ç®€å•é˜è¿°äº† TaskCreationOptions.LongRunning å‚æ•°çš„ä½œç”¨ï¼Œå’Œä½¿ç”¨çš„æ³¨æ„è¦ç‚¹ã€‚

å‚è€ƒ
--

*   [.NET Task æ­ç§˜ï¼ˆ2ï¼‰ï¼šTask çš„å›è°ƒæ‰§è¡Œä¸ await](https://www.cnblogs.com/eventhorizon/p/15912383.html)1
*   [Task](https://threads.whuanle.cn/3.task/)2
*   [TaskCreationOptions](https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.taskcreationoptions?view=net-7.0&WT.mc_id=DX-MVP-5003606)3

æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœè§‰å¾—æœ¬æ–‡æœ‰ç”¨ï¼Œä¸å¦¨ç‚¹å‡»æ¨èğŸ‘æˆ–è€…åœ¨è¯„è®ºåŒºç•™ä¸‹ Markï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°ã€‚

> æ¬¢è¿å…³æ³¨ä½œè€…çš„å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€ï¼Œè·å–æ›´å¤šæŠ€æœ¯å†…å®¹ã€‚ ![å…³æ³¨å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€](https://www.newbe.pro/images/weixin_public_qrcode.png)

*   æœ¬æ–‡ä½œè€…ï¼š [newbe36524](https://www.newbe.pro/)
*   æœ¬æ–‡é“¾æ¥ï¼š [https://www.newbe.pro/Others/0x026-This-is-the-wrong-way-to-use-LongRunnigTask-in-csharp/](https://www.newbe.pro/Others/0x026-This-is-the-wrong-way-to-use-LongRunnigTask-in-csharp/)
*   ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼

* * *

1.  https://www.cnblogs.com/eventhorizon/p/15912383.htmlâ†©
    
2.  https://threads.whuanle.cn/3.task/â†©
    
3.  https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.taskcreationoptions?view=net-7.0&WT.mc\_id=DX-MVP-5003606â†©