---
layout: post
title: "ç³»ç»Ÿè®¾è®¡ | é™æµç®—æ³•åŠå…¶å‘¨è¾¹"
date: "2022-04-27T21:17:31.042Z"
---
ç³»ç»Ÿè®¾è®¡ | é™æµç®—æ³•åŠå…¶å‘¨è¾¹
===============

æ¦‚è¿°
--

é™æµï¼Œå…¶åŸºç¡€å«ä¹‰ä¸ºå¯¹æµé‡è¿›è¡Œé™åˆ¶ï¼Œå…¶æ—¢åŒ…æ‹¬åœ¨é€Ÿç‡ä¸Šçš„é™åˆ¶ï¼ŒåˆåŒ…æ‹¬åœ¨èµ„æºä¸Šçš„é™åˆ¶ï¼Œè¿™é‡Œä¸»è¦è®¨è®ºçš„æ˜¯å¯¹é€Ÿç‡è¿›è¡Œé™åˆ¶ã€‚

æœ¬æ–‡åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†ä¸­æˆ‘ä»¬å°†è®¨è®ºåœ¨åšé™æµå‰å¿…é¡»è¦å¼„æ¸…çš„é—®é¢˜ï¼š

*   ä¸ºä»€ä¹ˆè¦å»åšé™æµ
    
*   é™æµçš„å…·ä½“å«ä¹‰å’ŒæŒ‡æ ‡
    

ç¬¬äºŒéƒ¨åˆ†å°†å…·ä½“æ¢è®¨äº’è”ç½‘ä¸Šæµè¡Œçš„é™æµç®—æ³•ï¼›å¹¶åœ¨ç¬¬ä¸‰éƒ¨åˆ†ä¸­å­¦ä¹ å®ƒä»¬åœ¨å¸¸ç”¨çš„é™æµä¸­åº“ä¸­çš„é«˜æ•ˆå®ç°ï¼Œæœ€åå†ç®€å•çš„è®¨è®ºä¸‹åˆ†å¸ƒå¼é™æµçš„é—®é¢˜

é˜…è¯»æœ¬æ–‡åªéœ€è¦åŸºç¡€çš„ç³»ç»Ÿå¼€å‘çŸ¥è¯†ï¼Œå¯æ”¾å¿ƒé£Ÿç”¨ : )

  

å†è°ˆé™æµ
----

æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å»åšé™æµï¼Ÿ

å¯¹äºä¸€å°æœºå™¨ (æˆ–ä¸€ä¸ªæœåŠ¡) æ¥è®²ï¼Œå®ƒæä¾›æœåŠ¡çš„èƒ½åŠ›å¿…ç„¶å­˜åœ¨æŸä¸ªé˜ˆå€¼ï¼Œè¿™æ˜¯ç”±äºå…¶ä¼šè¢«å®ƒæœ¬èº«çš„è¿ç®—èƒ½åŠ›ã€å†…å­˜ã€ç‰©ç†å­˜å‚¨ã€ç½‘ç»œèµ„æºä¸å…¶æ‰€ä¾èµ–çš„å¤–éƒ¨æœåŠ¡ç­‰å› ç´ æ‰€é™åˆ¶ã€‚è€Œä¸€æ—¦è¶…è¿‡äº†è¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™å¿…ç„¶æ— æ³•å¯¹è¶…å‡ºé˜ˆå€¼çš„éƒ¨åˆ†æ­£å¸¸æä¾›æœåŠ¡ï¼Œæ•…æ­¤æ—¶æˆ‘ä»¬ä¸å¾—ä¸åšå‡ºä¸€äº›ç­–ç•¥æ¥å¯¹è¿™éƒ¨åˆ†è¿›è¡Œå¤„ç†ã€‚

> å®é™…ä¸Šï¼Œ"ä¸€æ—¦è¶…è¿‡äº†è¿™ä¸ªé˜ˆå€¼ï¼Œåˆ™æ— æ³•å¯¹è¶…å‡ºçš„éƒ¨åˆ†è¿›è¡Œå¤„ç†" ä¸ºä¸€ç§è¾ƒä¸ºä¹è§‚çš„é¢„æœŸã€‚ç°å®ä¸­è¶…å‡ºé˜ˆå€¼åï¼Œå¯èƒ½çš„æƒ…å†µè¿˜æœ‰å¯¹äºå…¶æœ¬æ¥å¯ä»¥å¤„ç†çš„ã€æœªè¶…å‡ºé˜ˆå€¼çš„éƒ¨åˆ†ï¼ŒåŒæ ·ä¹Ÿæ— æ³•è¿›è¡Œå¤„ç†ï¼Œä¸”æœ€åçš„æƒ…å†µç”šè‡³äºå¯¼è‡´æœºå™¨å®•æœºã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œé™æµï¼Œä¸”æœ¬æ–‡ä»‹ç»çš„é™æµç®—æ³•å¤§å¤šè¢«åº”ç”¨åœ¨ OSI æ¨¡å‹çš„ç¬¬ä¸ƒå±‚ä¸­ã€‚

  

æ€æ ·å»åšé™æµçš„å‰ç½®æ¡ä»¶ä¸ºå¼„æ¸…æ¥š"é™æµ"çš„å®šä¹‰ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å»å¼€å¯é™æµåŠŸèƒ½å‰ï¼Œæˆ‘ä»¬å¿…é¡»æ˜ç™½"é™"æ˜¯ä»€ä¹ˆï¼Œ"æµ"åˆæ˜¯ä»€ä¹ˆã€‚

æˆ‘ä»¬åœ¨è®¨è®ºé™æµæ—¶ä¸€èˆ¬å°†å…¶è§£é‡Šä¸ºæµé‡é€Ÿç‡é™åˆ¶ (Rate Limit)ï¼Œå³å¯¹äºä¸€æ®µæ—¶é—´å†…è¶…å‡ºæŒ‡å®šé€šè¿‡é˜ˆå€¼çš„æµé‡è¿›è¡Œæ§åˆ¶ï¼Œè€Œæ ¹æ®æ§åˆ¶æ–¹æ¡ˆçš„ä¸åŒï¼Œåˆå¯åˆ†ä¸ºï¼š

*   æ‹’ç»å¼é™æµï¼šå¯¹äºè¶…å‡ºé˜ˆå€¼çš„æµé‡ï¼Œç›´æ¥æ‹’ç»ï¼Œè¿”å›å¤±è´¥ã€‚ä¾‹å¦‚å¯¹äº HTTP è¯·æ±‚ï¼Œå¯ä»¥ç›´æ¥è¿”å› [429 (Too Many Requests)](https://http.cat/429) ï¼›å¦‚æœåœ¨å¾®æœåŠ¡ä¸­ï¼Œåˆ™å¯èƒ½ä¼šå¯ç”¨é™çº§ç­–ç•¥ã€‚
*   é˜»å¡å¼é™æµï¼šå¯¹äºè¶…å‡ºé˜ˆå€¼çš„æµé‡ï¼Œå¯ä»¥ä»¤å®ƒä»¬é˜»å¡æˆ–å…¥é˜Ÿï¼Œä½¿å¾—è¿™éƒ¨åˆ†çš„è¯·æ±‚é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°å½“å‰ç³»ç»Ÿè¢«ä½¿ç”¨çš„é¢åº¦å›å½’åˆ°é˜ˆå€¼ä»¥ä¸‹ã€‚

å½“æˆ‘ä»¬é€‰å®šäº†æ§åˆ¶æ–¹æ¡ˆåï¼Œå°±ç¡®å®šäº†"é™"å­—çš„å«ä¹‰ã€‚ä½†"æµ"åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ‰€é™åˆ¶çš„æµé‡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

è¢«é™åˆ¶çš„"æµ"åœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ä¸­æœ‰ç€ä¸åŒçš„å«ä¹‰ï¼Œå¦‚ç”¨æˆ·çš„å‘å¸ƒè´´å­çš„é€Ÿç‡ã€åŒæ—¶åœ¨çº¿çš„æˆ¿é—´äººæ•°ã€ç½‘ç›˜çš„ä¸‹è½½é€Ÿç‡ç­‰ã€‚

è€Œä¸ºäº†é™åˆ¶è¿™äº›ä¸åŒçš„"æµ"ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨å¯¹åº”çš„æµé‡æŒ‡æ ‡æ¥ç»Ÿè®¡å®ƒä»¬ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ TPS (Transactions per second) æˆ– QPS (Queries per second) ä½œä¸ºæŒ‡æ ‡ä»¥è¿›è¡Œç»Ÿè®¡ï¼Œå‰è€…ä¸ºæ¯ç§’äº‹åŠ¡æ•°ï¼Œåè€…ä¸ºæ¯ç§’æŸ¥è¯¢æ•°ã€‚è€Œåœ¨"è¯·æ±‚-å“åº”"ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬æ›´å€¾å‘äºä½¿ç”¨ RPS (requests per second) ä½œä¸ºæµé‡é™åˆ¶çš„æŒ‡æ ‡ã€‚

> #### ä¸ºä»€ä¹ˆæˆ‘ä»¬å€¾å‘äº RPS è€Œä¸æ˜¯ TPS ?
> 
> TPS ä»£è¡¨ç€æ¯ç§’çš„äº‹åŠ¡æ•°é‡ï¼Œè€Œäº‹åŠ¡å«ä¹‰ä¸º"ä¸€ä¸ªå®ä½“æ‰§è¡Œçš„åŸå­æ“ä½œ"ï¼ˆè‡³å°‘åœ¨é€»è¾‘ä¸Šéœ€è¦æ˜¯åŸå­çš„ï¼‰ã€‚åœ¨ä¸šåŠ¡ä¸Šï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›çŸ¥é“ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡æ“ä½œçš„ TPSï¼Œä½†åœ¨ä¸šåŠ¡çš„å®Œæˆä¸Šç”±äºç”¨æˆ·è¡Œä¸ºçš„ä¸å¯é¢„çŸ¥ï¼Œä¸€ä¸ªäº‹åŠ¡å®Œæˆçš„å…·ä½“æ¶ˆè€—æ—¶é—´å¾ˆéš¾è¢«å‡†ç¡®çš„æµ‹é‡ã€‚æ‰€ä»¥æˆ‘ä»¬åªå¥½é€€è€Œæ±‚å…¶æ¬¡ï¼Œä½¿ç”¨ç›¸å¯¹å®¹æ˜“è¢«ç›‘æ§ä¸”å‡†ç¡®çš„ RPSã€‚

é™¤äº† TPSã€QPSã€RPS å¤–ï¼Œè¿˜æœ‰äº›å…¶ä»–å¸¸ç”¨çš„æµé‡é™åˆ¶æŒ‡æ ‡ã€‚ä¾‹å¦‚åœ¨æˆ‘ä»¬æåˆ°çš„"æµ"çš„é™åˆ¶ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªä¸šåŠ¡å¯ä»¥ç›´æ¥ä½¿ç”¨ RPS ä½œä¸ºæµé‡é™åˆ¶æŒ‡æ ‡å¤–ï¼Œç¬¬äºŒä¸ªåˆ™éœ€è¦ä»¥åœ¨çº¿IP ä½œä¸ºæŒ‡æ ‡ã€ç¬¬ä¸‰ä¸ªéœ€è¦ä»¥ä¸€æ®µæ—¶é—´å†…çš„ TCP\\UDP çš„æŠ¥æ–‡å¤§å°ä½œä¸ºç›‘æ§æŒ‡æ ‡ï¼Œæ ¹æ®ä¸åŒçš„ä¸šåŠ¡ï¼Œä½ å¯ä»¥é€‰æ‹©ä¸åŒçš„é™æµç®—æ³•æ¥ä½¿ç”¨ä½ é€‰å®šçš„æµé‡ç›‘æ§æŒ‡æ ‡ã€‚

  
  

é™æµç®—æ³•ä»¬
-----

åœ¨ç¡®å®šå¥½æ§åˆ¶ç­–ç•¥å’Œæµé‡ç›‘æµ‹æŒ‡æ ‡åï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è®¨è®ºé™æµçš„åŸºæœ¬ç­–ç•¥äº†ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥æ€è€ƒä¸€ä¸‹æ€ä¹ˆæ ·çš„é™æµç®—æ³•æ‰ç®—æ˜¯ä¸€ä¸ªå¥½çš„é™æµç®—æ³•ï¼Œå¦‚æœç®—æ³•çš„å¥½åæ— æ³•è¯„åˆ¤é‚£ä¹ˆæˆ‘ä»¬å°†æ— æ³•æŒ‘é€‰å‡ºæœ€å¥½çš„ç®—æ³•ã€‚

ä¸€ä¸ªå¥½çš„é™æµç®—æ³•ï¼Œåˆæˆ–è€…è¯´æµé‡æ§åˆ¶ç®—æ³•ï¼Œä¸€æ–¹é¢å¿…é¡»åšåˆ°ä¿æŠ¤èµ„æºï¼Œå¦ä¸€æ–¹é¢åˆåº”è¯¥åšåˆ°**åœ¨ä¿è¯èµ„æºçš„ä½¿ç”¨åœ¨å®‰å…¨é˜ˆå€¼å†…çš„åŒæ—¶ï¼Œæœ€å¤§é™åº¦çš„åˆ©ç”¨èµ„æº**ã€‚åœ¨è®¡ç®—æœºç½‘ç»œä¸­æœ‰ä¸€ä¸ªåè¯å«[æµé‡æ•´å½¢(Traffic Shaping)](https://en.wikipedia.org/wiki/Traffic_shaping)ï¼Œå…¶å«ä¹‰æ˜¯ä½¿éƒ¨åˆ†æ•°æ®æŠ¥è¿›è¡Œç­‰å¾…ï¼Œä½¿å¾—æµé‡æ›²çº¿ç¬¦åˆè®¾å®šçš„æµé‡é…ç½®ã€‚è€Œæˆ‘ä»¬éœ€è¦çš„å°±æ˜¯ä¸€æ¡è¶³å¤Ÿå¹³ç¨³çš„æµé‡æ›²çº¿ï¼Œä½¿å¾—è¢«ä¿æŠ¤çš„èµ„æºèƒ½å¤Ÿæœ€å¤§é™åº¦çš„è¢«ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯è¯´èƒ½å¤Ÿå¯¹æµé‡è¿›è¡Œ"å‰Šå³°å¡«è°·"çš„ç®—æ³•æ˜¯æ¯”è¾ƒå¥½çš„ã€‚

æ•…æˆ‘ä»¬ç†æƒ³ä¸­çš„æµé‡æ›²çº¿åº”è¯¥é•¿ä¸‹é¢è¿™æ ·ï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220425153738.png)

> å›¾ä¸­æœªåˆ°æµé‡é˜ˆå€¼å‰çš„éƒ¨åˆ†ä¸ºé¢„çƒ­æ›²çº¿ï¼Œåé¢ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»

  

### è®¡æ•°çª—å£ç®—æ³•

æˆ‘ä»¬å…ˆä»æœ€å®¹æ˜“æƒ³åˆ°çš„æ€è·¯å¼€å§‹ï¼šç”±äºæˆ‘ä»¬éœ€è¦é™åˆ¶æ¯ç§’çš„è¯·æ±‚é‡ï¼Œæ‰€ä»¥åªéœ€è¦ç»Ÿè®¡æ¯ä¸€ç§’æ”¶åˆ°çš„è¯·æ±‚æ•°é‡ï¼Œè¶…è¿‡åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

ç”¨ä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š

    public void enter() {
      long now = System.currentTimeMillis() % 1000;
      if (lastTime != now) {
        lastTime = now;
        currentReq = 0;
      }
      if (currentReq < maxReq) {
        currentReq++;
      } else {
        throw new RuntimeException("resource out!");
      }
    }
    

> ä¸Šè¿°ä»£ç ä»…ç”¨äºé˜æ˜ç®—æ³•æ€è·¯ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘å¹¶å‘é—®é¢˜ï¼Œå®é™…å®ç°ä¸­ç”±äºéœ€è¦è€ƒè™‘å„ç§ä½é”æˆ–æ— é”çš„å¹¶å‘æ–¹æ¡ˆï¼Œæ•…å¤§æ¦‚ç‡ä¼šä¸ä½¿ç”¨ä»£ç å­˜åœ¨å·®åˆ«

è¿™ä¸ªç®—æ³•è¶³å¤Ÿç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›ç¼ºç‚¹ï¼š

1.  åªæ”¯æŒæ‹’ç»å¼é™æµ
    
    åœ¨æˆ‘ä»¬å¯¹äºé™æµç®—æ³•çš„"å‰Šå³°å¡«è°·"çš„è¦æ±‚ä¸­ï¼Œè¿™é‡Œå·²ç»å®ç°äº†å‰Šå³°ï¼Œä½†å¡«è°·åªæ˜¯äº¤ç»™äº†æœåŠ¡çš„è°ƒç”¨æ–¹ç®€å•çš„è¿›è¡Œé‡è¯•ï¼Œä¸èƒ½å¾ˆå¥½çš„ä¿®æ•´æµé‡æ›²çº¿ã€‚
    
2.  æœ‰è¶…å‡ºè§„å®šå¹¶å‘é‡çš„å¯èƒ½
    
    è¿™ä¸ªç¼ºç‚¹ä¹ä¸€çœ‹æ²¡ä»€ä¹ˆå¯èƒ½å‡ºç°ï¼Œä½†ä»”ç»†ä¸€æƒ³ä¾¿ä¼šå‘ç°ï¼Œæˆ‘ä»¬å¯¹äºä¸€ç§’çš„å®šä¹‰å­˜åœ¨é—®é¢˜ï¼Œæ¯”å¦‚å½“å‰çš„ä¸‹åŠç§’ (500ms-1000ms) å’Œä¸‹ä¸€ç§’çš„ä¸ŠåŠç§’ (1000ms-1500ms) ä¹Ÿèƒ½å¤Ÿè¢«ç§°ä¸ºæ˜¯ä¸€ç§’ã€‚è€Œåœ¨è¯¥ç®—æ³•ä¸­æ˜¯æœ‰å¯èƒ½å‡ºç°ä¾‹å¦‚ 500ms-1000ms æœ‰ 80 ä¸ªè¯·æ±‚ï¼Œ1000ms - 1500ms æœ‰ 90 ä¸ªè¯·æ±‚ï¼Œæ€»è¯·æ±‚é‡è¶…è¿‡é™åˆ¶çš„ä¸€ç§’ 100 çš„è¯·æ±‚æ•°çš„ã€‚
    

ç¬¬ä¸€ä¸ªç¼ºç‚¹è¿˜å¥½ï¼Œä½†ç¬¬äºŒä¸ªå°±çœ‹èµ·æ¥æœ‰ç‚¹éš¾ä»¥å®¹å¿äº†ï¼Œæˆ‘ä»¬å…ˆæ¥ç€æ‰‹è§£å†³ç¬¬äºŒä¸ªé—®é¢˜ã€‚é¦–å…ˆæ¥è€ƒè™‘ç¬¬äºŒä¸ªé—®é¢˜äº§ç”Ÿçš„åŸå› åœ¨å“ªï¼Œè¯¥ç®—æ³•ä¹‹æ‰€ä»¥ä¼šè¶…å‡ºé™åˆ¶ï¼Œæœ€ç›´æ¥çš„åŸå› åœ¨äºæ²¡æœ‰ç»Ÿè®¡"æ•´ä¸ªç§’"ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ 1200ms ä¸­è¿›å…¥çš„è¯·æ±‚ï¼Œåªè€ƒè™‘äº† 1000ms-1200ms ä¹‹é—´çš„è¯·æ±‚ï¼Œè€Œå®é™…ä¸Šæˆ‘ä»¬åº”è¯¥è€ƒè™‘ 200ms-1200msä¹‹é—´çš„è¯·æ±‚ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å°†ç¼ºå°‘çš„é‚£éƒ¨åˆ†çš„è¯·æ±‚ä¹Ÿç»Ÿè®¡è¿›å»ã€‚

  

### æ»‘åŠ¨æ—¥å¿—ç®—æ³•

ç°åœ¨ï¼Œæˆ‘ä»¬ä¸ºäº†å°†ä¸€ç§’å†…æ‰€æœ‰çš„è¯·æ±‚éƒ½è€ƒè™‘åœ¨å†…ï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªé›†åˆï¼Œæ¥å­˜å‚¨æ‰€æœ‰è¿›å…¥çš„è¯·æ±‚çš„æ—¶é—´æˆ³ï¼Œé›†åˆçš„æœ€å¤§å¤§å°ä¸ºå…è®¸é€šè¿‡çš„æœ€å¤§è¯·æ±‚æ•°é‡ï¼Œä¸€æ—¦å‘ç°é›†åˆä¸ºæ»¡ï¼Œåˆ™æ¸…ç†æ‰€æœ‰é›†åˆå†…å°äº (å½“å‰æ—¶é—´æˆ³ - æ—¶é—´çª—å£å¤§å°) çš„å€¼ã€‚

ç®€æ˜“åŠ¨ç”»æ¼”ç¤ºå¦‚ä¸‹ï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419194149.gif)

åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨çº¢é»‘æ ‘æˆ–è·³è¡¨ç­‰ç»“æ„æ¥ä½œä¸ºè¿™ä¸ªé›†åˆï¼Œè¿™æ ·åœ¨ç§»é™¤æ—¶å°±ä¸éœ€è¦çº¿æ€§æ‰«æé›†åˆä¸­æ‰€æœ‰å…ƒç´ ã€‚ä»¥ä¸‹ä¸ºç®€æ˜“çš„ä»£ç è¡¨ç¤ºï¼š

    private void enter() {
      long now = System.currentTimeMillis();
      int currentReq = redBlackTree.size();
      if (currentReq >= maxReq) {
        redBlackTree.headSet(now - windowSize).clear();
        currentReq = redBlackTree.size();
        if (currentReq >= maxReq) {
          throw new RuntimeException("resource out!");
        }
      }
    
      redBlackTree.add(now);
    }
    

è¿™ä¸ªæ–¹æ¡ˆå¾ˆå¥½çš„è§£å†³äº†åœ¨æ—¶é—´åŒºé—´ä¸­æ—¶é—´ç‚¹ä¸è¿ç»­çš„é—®é¢˜ï¼Œä½†éšå³ä¹Ÿå¸¦æ¥äº†æ–°çš„é—®é¢˜ã€‚ä¸€ä¸ªæœ€æ˜¾è€Œæ˜“è§çš„ç¼ºç‚¹å°±æ˜¯æˆ‘ä»¬éœ€è¦å­˜å‚¨æ‰€æœ‰é›†åˆå†…çš„è¯·æ±‚çš„æ—¶é—´æˆ³ï¼Œå¦‚æœé›†åˆè¾ƒå¤§çš„è¯æ¶ˆè€—çš„å†…å­˜ä¹Ÿä¼šæ¯”è¾ƒå¤§ã€‚ä¸”å¦ä¸€æ–¹é¢ï¼Œè¿‡æœŸçš„æ—¶é—´æˆ‘ä»¬è¿˜éœ€è¦ä»é›†åˆä¸­è¿›è¡Œç§»é™¤ï¼Œè€Œå…¶ä¸­ç§»é™¤ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æœ€å°‘ä¸º \\(O(logN)\\) ï¼Œæ‰€ä»¥æ€§èƒ½æ¶ˆè€—ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ã€‚

è¿™æ ·çœ‹æ¥ä¸Šé¢è¿™ä¸ªæ–¹æ¡ˆåœ¨ç”Ÿäº§ä¸­å¹¶ä¸å¯è¡Œï¼Œä¸è¿‡ä¹Ÿç»™æˆ‘ä»¬å¸¦æ¥äº†ä¸€å®šçš„å¯å‘ï¼š

1.  ä½¿ç”¨æ»‘åŠ¨çª—å£çš„æ€æƒ³
    
    åœ¨ä¸Šé¢ä¸­æˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä¸ªçª—å£æ¥å­˜å‚¨æ‰€æœ‰çš„å…ƒç´ ï¼Œçª—å£çš„æ€æƒ³æœ¬èº«å¹¶æ²¡æœ‰é—®é¢˜ï¼Œä½†é—®é¢˜åœ¨äºæˆ‘ä»¬ä¸åº”è¯¥å­˜å‚¨æ‰€æœ‰çš„å…ƒç´ ï¼Œå› ä¸ºè¿™å¯¼è‡´äº†é›†åˆå…ƒç´ è¿‡å¤šå’Œçª—å£ç§»åŠ¨æ•ˆç‡ä½çš„é—®é¢˜ï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ¡¶çš„æ€æƒ³æ¥è§£å†³å­˜å‚¨å…¨éƒ¨å…ƒç´ æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚
    
2.  ä½¿ç”¨æ°åˆ°å¥½å¤„çš„ç²¾åº¦
    
    åœ¨ä¸Šé¢ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»»æ„ç²¾åº¦çš„æ—¶é—´æˆ³æ¥æ§åˆ¶å¹¶å‘é‡ï¼Œåªè¦ä½ æ„¿æ„ç”šè‡³å¯ä»¥ä½¿ç”¨çº³ç§’çš„ç²¾åº¦ã€‚ä½†æˆ‘ä»¬çœŸçš„éœ€è¦è¿™ä¹ˆé«˜çš„ç²¾åº¦å—ï¼Ÿ
    
    å®é™…ä¸Šå¯¹äºé™åˆ¶æ¯”è¾ƒ"è½¯"çš„èµ„æºæ¥è®²ï¼Œè¾ƒé«˜çš„ç²¾åº¦å¸¦æ¥å—ç›Šå¹¶ä¸é«˜ã€‚å¯¹äºè¿™äº›åº”ç”¨ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥é€‚å½“çš„æ”¾å¼ƒä¸€äº›ç²¾åº¦ï¼Œä½¿å¾—å°‘é‡è¯·æ±‚è¢«é”™è¯¯çš„å…è®¸æˆ–æ‹’ç»ï¼Œå¸¦æ¥çš„å½±å“å¹¶ä¸ä¼šå¾ˆé«˜ï¼Œä½†å´å¯ä»¥è·å¾—ä¸é”™çš„æ”¶ç›Šã€‚
    

å¸¦ç€ä»¥ä¸Šä¸¤ç‚¹æ€è€ƒï¼Œæˆ‘ä»¬å†æ¥é‡æ–°è®¾è®¡é™æµç®—æ³•ã€‚

  

### æ»‘åŠ¨çª—å£ç®—æ³•

é¦–å…ˆæ ¹æ®æ¡¶çš„æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤å¤šä¸ªæ¡¶ï¼Œæ¡¶çš„ç²¾åº¦å¯ä»¥é€‚å½“çš„é™ä½ï¼Œä¾‹å¦‚æ¯ 100ms ä¸€ä¸ªæ¡¶ã€‚åŒæ—¶ç»´æŠ¤çª—å£å†…çš„æ‰€æœ‰æ¡¶çš„ç»Ÿè®¡å€¼ï¼Œå½“æ—¶é—´æ¨è¿›ï¼Œç»Ÿè®¡å€¼å‡å»ä»çª—å£å·¦ä¾§ä¸¢å¼ƒçš„æ¡¶ï¼Œä¸€æ—¦å½“å‰çš„ç»Ÿè®¡å€¼è¶…è¿‡é™åˆ¶å€¼ï¼Œåˆ™å¯æ‹’ç»è¯·æ±‚ã€‚

æµç¨‹ç¤ºä¾‹ï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419195132.png)

ç®€æ˜“ä»£ç è¡¨ç¤ºï¼š

    public boolean enter(int count) {
      long now = System.currentTimeMillis();
      syncWindow(now);
    
      if (passSum + count > windowMaxPass) {
        return false;
      }
    
      window[currentIdx] += count;
      passSum += count;
      return true;
    }
    
    private void syncWindow(long now) {
      // æ±‚å‡ºæ¯ä¸ªæ¡¶çš„å¤§å°
      final int bucketSize = this.windowSize / this.window.length;
    
      // çª—å£éœ€è¦ç§»åŠ¨çš„æ ¼æ•°
      int step = (int) ((now - currentTime) / bucketSize);
      if (step == 0) {
        return;
      }
      // å³æŒ‡é’ˆéœ€è¦ç§»åŠ¨åˆ°çš„ä½ç½®
      int nextIdx = (currentIdx + step) % window.length;
    
      // å¦‚æœè¶…è¿‡çª—å£å¤§å°, å¯ä»¥ç›´æ¥æ¸…ç©ºçª—å£
      if (step >= window.length) {
        Arrays.fill(window, 0);
        passSum = 0;
      } else {
        // å¦åˆ™å‘å‰ç§»åŠ¨åˆ°æŒ‡å®šçš„ä½ç½®
        while (currentIdx != nextIdx) {
          currentIdx = (currentIdx + 1) % window.length;
          passSum -= window[currentIdx];
          window[currentIdx] = 0;
        }
      }
    
      // æœ€åæ›´æ–°æ—¶é—´
      this.currentTime = now;
    }
    

å½“ç„¶ï¼Œè¿™ä¸ªç®—æ³•ä»ç„¶æ˜¯å­˜åœ¨ç€è¯¯å·®çš„ï¼Œå®ƒä»ç„¶ä¼šå­˜åœ¨ç€åœ¨è®¡æ•°çª—å£ç®—æ³•ä¸­çš„è¶…å‡ºé™é¢çš„é—®é¢˜ã€‚ä¸è¿‡ç”±äºåœ¨å›¾ç‰‡ç¤ºä¾‹ä¸­æˆ‘ä»¬å°†ç²¾åº¦è®¾ç½®ä¸ºäº† 100msï¼Œæ­¤æ—¶è¶…å‡ºé™é¢çš„æ¦‚ç‡ä¸å¤§å°å·²ç»ç¼©å°äº†ä¸å°‘ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´å°çš„æ¡¶ä»¥è·å¾—æ›´é«˜çš„å‡†ç¡®åº¦ã€‚

  

### æ”¹è¿›çš„è®¡æ•°çª—å£ç®—æ³•

æˆ‘ä»¬è¿˜å¯ä»¥æ¢ä¸ªæ€è·¯ï¼Œæ—¢ç„¶æˆ‘ä»¬ä¸éœ€è¦å¤ªé«˜çš„ç²¾åº¦ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»è®¡æ•°çª—å£çš„æ–¹æ¡ˆä¸­è¿›è¡Œæ”¹è¿›ã€‚

å¦‚æœæˆ‘ä»¬çš„çª—å£å¤§å°ä¸º 1s ï¼Œåˆ™å¯ä»¥ç›´æ¥å­˜æ”¾ä¸Šä¸€ç§’çš„ç»Ÿè®¡å€¼å’Œå½“å‰ç§’çš„ç»Ÿè®¡å€¼ï¼Œç„¶åæ ¹æ®å½“å‰ç§’å†…çš„æ¯«ç§’è¿›è¡Œè®¡ç®—ï¼š

\\\[\\begin{equation} \\begin{aligned} avg\\\_count=\\ &last\\\_secord\\\_request\\\_count\\ \* \\\\ &(1000-current\\\_mill)/1000+current\\\_secord\\\_request\\\_count \\end{aligned} \\end{equation} \\\]

å½“ç„¶ç”±äºæˆ‘ä»¬çš„é‡‡æ ·ä¸ºåŸºäºä¸Šä¸€ä¸ªé‡‡æ ·å‘¨æœŸçš„å¹³å‡å€¼ï¼Œæ‰€ä»¥å®é™…ä¸Šå¾—åˆ°çš„åªæ˜¯å®é™…é€Ÿç‡çš„è¿‘ä¼¼å€¼ã€‚ä¸è¿‡æ ¹æ® [Cloudflare çš„åˆ†ææŠ¥å‘Š](https://blog.cloudflare.com/counting-things-a-lot-of-different-things/) ï¼Œå®é™…ç¯å¢ƒä¸­å››äº¿ä¸ªè¯·æ±‚ä¸­åªæœ‰ 0.003% çš„è¯·æ±‚è¢«é”™è¯¯çš„å…è®¸æˆ–æ‹’ç»ï¼Œå¹¶ä¸”è¯¥æ–¹æ¡ˆçš„å†…å­˜å ç”¨ä¸å®é™…è¿è¡Œæ•ˆç‡éƒ½å¾ˆä¸é”™ï¼Œæ‰€ä»¥ç¡®å®ä¹Ÿå¯ä»¥ä½œä¸ºä¸€ä¸ªè‰¯å¥½çš„é™æµç®—æ³•ã€‚

  

å¦‚æœåªéœ€è¦ç®€å•çš„é™æµï¼Œä»¥ä¸Šç®—æ³•å·²ç»è¶³å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€è¦äº†ï¼Œä½†æ˜¯æˆ‘ä»¬é™æµçš„ç›®çš„ï¼Œé™¤äº†ä¿æŠ¤èµ„æºå¤–ï¼Œè¿˜éœ€è¦èµ·åˆ°"å‰Šå³°å¡«è°·"çš„ä½œç”¨ï¼Œæˆ‘ä»¬ç›®å‰çš„ç®—æ³•å¯¹äºè¶…å‡ºé¢åº¦çš„æµé‡åªèƒ½è¿›è¡Œç®€å•çš„æ‹’ç»ï¼Œè€Œå¯¹äº"å¡«è°·"åˆ™ä¾èµ–äºè°ƒç”¨æ–¹çš„é‡è¯•æ“ä½œï¼Œè¿™æ ·çš„è¯å°±å¾ˆéš¾ä¾æ®æˆ‘ä»¬è‡ªå·±çš„éœ€è¦å»è°ƒæ•´æµé‡æ›²çº¿ï¼Œå®é™…ä¸Šè¿™ä¹Ÿæ˜¯æ‹’ç»å¼é™æµçš„ç¼ºç‚¹ã€‚

å¦‚å›¾ï¼Œæ›²çº¿å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„å¹³æ»‘ï¼Œè¿™æ˜¯å› ä¸ºé‡è¯•çš„æ—¶é—´å—ç½‘ç»œçŠ¶å†µæ‰€å½±å“è€Œå˜å¾—éš¾ä»¥é¢„æµ‹ï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220425170731.png)

ä»æ ¹æœ¬ä¸Šè®²ï¼Œå‡ºç°è¿™æ ·çš„æƒ…å†µæ˜¯å› ä¸ºæˆ‘ä»¬ç›®å‰çš„ç®—æ³•éƒ½åªèƒ½è¿›è¡Œæ‹’ç»å¼é™æµï¼Œè€Œæƒ³è¦ä¿®æ•´å‡ºæ›´åŠ å¹³æ»‘çš„æ›²çº¿åˆ™éœ€è¦é˜»å¡å¼é™æµæ¥è‡ªå®šä¹‰ç­‰å¾…æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦å¯»æ‰¾å…¶ä»–çš„å‡ºè·¯ã€‚

  

### æ¼æ¡¶ç®—æ³•

æƒ³è±¡ä¸€ä¸ªæˆ‘ä»¬æœ‰ä¸€ä¸ªç”¨äºè£…æ°´çš„æ¡¶ï¼Œæ¡¶çš„åº•éƒ¨æœ‰ä¸€ä¸ªæ´ï¼Œæ°´ä¼šä»¥æ’å®šé€Ÿç‡ä»æ´ä¸­æµå‡ºï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜ä¼šå¾€æ¡¶ä¸­æ³¨å…¥æ°´ï¼Œè€Œå½“æ³¨å…¥æ°´çš„é€Ÿåº¦å¤§äºæ°´æµå‡ºçš„é€Ÿåº¦ï¼Œæ¡¶ä¸­çš„æ°´å°†ä¼šå¾ˆå¿«çš„è¶…è¿‡æ¡¶çš„å®¹é‡ï¼Œç„¶åæº¢å‡ºã€‚

åœ¨æ¼æ¡¶ç®—æ³•ä¸­ï¼Œ"æ°´"å°±æ˜¯è¿›æ¥çš„è¯·æ±‚æµé‡ï¼Œ"ä»æ´ä¸­æ¼å‡º"å°±æ˜¯æœåŠ¡å¤„ç†è¯·æ±‚ï¼Œ"æ¡¶"å³ä¸ºå­˜æ”¾ç­‰å¾…è¢«å¤„ç†çš„è¯·æ±‚çš„é›†åˆï¼ŒåŒæ—¶"æ°´ä»æ¡¶ä¸­æº¢å‡º"åˆ™ä»£è¡¨è¶…è¿‡äº†æœ€å¤§çš„å®¹é‡åæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚

è¿™ä¸ªç®—æ³•åŸç†å’Œå®ç°éƒ½æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª FIFO é˜Ÿåˆ—æ¥å­˜æ”¾è¿›æ¥çš„è¯·æ±‚ï¼ŒæœåŠ¡åœ¨å¦ä¸€ç«¯ä»¥æ’å®šçš„é€Ÿç‡å¤„ç†è¯·æ±‚ï¼Œé˜Ÿåˆ—æ»¡åˆ™ä¸¢å¼ƒæ–°è¿›æ¥çš„è¯·æ±‚ã€‚

è¿™ä¸ªç®—æ³•çœ‹èµ·æ¥æŒºç¾å¥½ï¼Œèƒ½å¤Ÿç®€å•çš„å®ç°ç­‰å¾…ç­–ç•¥ï¼Œå¹¶ä¸”é€šè¿‡æ’å®šçš„é€Ÿç‡æµé‡æ›²çº¿èƒ½å¤Ÿè½»æ˜“çš„è¢«ä¿®æ•´ä¸ºè¾ƒç›´çš„æ›²çº¿ï¼Œä½†ä»å…·æœ‰å‡ ä¸ªç¼ºç‚¹ï¼š

1.  å¤§æµé‡æ—¶ä¼šä½¿é˜Ÿåˆ—è¢«æ—§è¯·æ±‚æ‰€å¡«æ»¡ï¼Œè‹¥æ­¤æ—¶å¤„ç†çš„ä¸å¤ŸåŠæ—¶ä¼šå¯¼è‡´æœ€è¿‘çš„è¯·æ±‚ä¸èƒ½è¢«å¤„ç†ã€‚
    
    ä¸è¿‡è¿™ä¸ªç¼ºç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™æ¡¶ä¸­çš„è¯·æ±‚æ·»åŠ  TTL ç­‰æ–¹å¼æ¥åšå¤„ç†ã€‚
    
2.  è¯¥ç®—æ³•æœ‰"æ¡¶çš„å¤§å°"å’Œ"æµå‡ºé€Ÿç‡"ä¸¤ä¸ªå‚æ•°ï¼Œä½†åˆç†çš„è®¾ç½®å®ƒä»¬æ˜¯æœ‰ä¸€å®šéš¾åº¦çš„ï¼Œå¯¹äºæ¡¶çš„å¤§å°ï¼Œè¿‡å¤§æˆ–è¿‡å°éƒ½ä¼šå­˜åœ¨ç€é—®é¢˜ã€‚
    

  

### ä»¤ç‰Œæ¡¶ç®—æ³•

å¹¸è¿çš„æ˜¯æˆ‘ä»¬ç¡®å®æœ‰ä¸€ä¸ªæ›´å®Œç¾çš„ç®—æ³•æ¥æ›¿ä»£å®ƒï¼ŒåŒæ—¶è¿™ä¹Ÿæ˜¯åœ¨é™æµç®—æ³•ä¸­æœ€ä¸ºå¸¸è§çš„ç®—æ³•ï¼Œå®é™…ä¸Šå¤§å¤šæ•°é™æµåº“éƒ½æ˜¯ä½¿ç”¨çš„è¯¥ç®—æ³•ã€‚

æƒ³è±¡æˆ‘ä»¬å…·æœ‰ä¸€ä¸ªè£…ä»¤ç‰Œçš„æ¡¶ï¼Œå½“è¯·æ±‚åˆ°æ¥æ—¶ä¼šå°è¯•ä»æ¡¶ä¸­è·å–ä¸€ä¸ªä»¤ç‰Œï¼Œå¦‚æœä¸ºç©ºåˆ™è¢«æ‹’ç»æˆ–é˜»å¡ç­‰å¾…ï¼›åŒæ—¶æ¯è¿‡æ®µæ—¶é—´å°±å¾€é‡Œé¢æ‰”ä»¤ç‰Œï¼Œä½†æ¡¶æ»¡æ—¶ä»¤ç‰Œå°±ä¼šæº¢å‡ºä¸¢å¼ƒã€‚

ä½ å¯ä»¥åœ¨ä¿¡å·é‡çš„åŸºç¡€ä¸Šç†è§£ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå½“è¿›å…¥çš„æ—¶å€™ä¼šä½¿ç”¨ \\(\\text P\\) æ“ä½œå‡å°‘å€¼ï¼Œä¸€ä½†å€¼ä¸ºé›¶ç›´æ¥æ‹’ç»æˆ–é˜»å¡ï¼Œä¸è¿‡åŒºåˆ«åœ¨äºç¦»å¼€æ—¶ä¸ä¼šè°ƒç”¨ \\(\\text V\\) ï¼Œè€Œæ˜¯å®šæ—¶çš„è°ƒç”¨ \\(\\text V\\) ï¼Œä¸”ä¿¡å·é‡çš„å€¼åˆ°è¾¾ä¸€ä¸ªä¸Šé™åä¸ä¼šå†å¢åŠ ã€‚

è¯¥ç®—æ³•çš„ä¼˜ç‚¹åœ¨äºç®€å•ä¸”é«˜æ•ˆï¼Œæ”¾å…¥ä»¤ç‰Œçš„é€Ÿç‡å¯ä»¥ç®€å•çš„æ ¹æ®å…·ä½“æƒ…å†µæ§åˆ¶ï¼Œå¹¶ä¸”æ€§èƒ½æ¶ˆè€—è¾ƒå°‘ï¼Œå› ä¸ºä½ å¹¶ä¸éœ€è¦çœŸçš„è®¾ç½®ä¸€ä¸ªçº¿ç¨‹å»å®šæ—¶çš„æ”¾å…¥ä»¤ç‰Œï¼Œåªéœ€è¦æ ¹æ®ä¸Šæ¬¡æ”¾å…¥çš„æ—¶é—´æˆ³è¿›è¡Œå¯¹æ¯”å³å¯ï¼Œæ‰€ä»¥å®é™…ä¸Šçš„æ¶ˆè€—ä¹Ÿå°±å‡ ä¸ªå˜é‡çš„ç»´æŠ¤ã€‚

ä»¥ä¸‹ä¸ºç®€æ˜“å®ç°ï¼ˆå¸¦å¹¶å‘ï¼‰ï¼š

    public class TokenBucketRateLimiter {
        private final AtomicInteger tokenCount;
        private final AtomicLong lastAddedTime;
    
        private int bucketSize;
        private double rate;
        private int minimumWaitingTime = 10;
    
        public TokenBucketRateLimiter(int maxToken, double rate) {
            this.bucketSize = maxToken;
    
            this.tokenCount = new AtomicInteger(maxToken);
            this.lastAddedTime = new AtomicLong(System.currentTimeMillis());
            this.rate = rate;
        }
    
        public int get(int accept) {
            int c = tokenCount.get();
            int wait = 0;
            boolean gain = false;
    
            addAndGetTokens: while (!gain) {
                for (;;) {
                    long now = System.currentTimeMillis();
                    long latest = lastAddedTime.get();
    
                    double rate = this.rate;
                    // ä¸Šä¸€æ¬¡æ·»åŠ  Token çš„æ—¶é—´åˆ°å½“å‰æ—¶é—´çš„é—´éš”
                    int interval = (int) (now - latest);
                    // è¯¥é—´éš”æ‰€èƒ½æ·»åŠ çš„ Token çš„æ•°é‡
                    int except = (int) (interval / 1000 * rate);
                    if (except > 0) /* å¦‚æœèƒ½æ·»åŠ çš„ Token å¤§äº 0, åˆ™å…è®¸æ·»åŠ  */ {
                        // é€šè¿‡ CAS æ›´æ”¹æ—¶é—´, å¦‚æœèƒ½å¤ŸæˆåŠŸè¯´æ˜è·å¾—äº†æ·»åŠ  Token çš„æƒåˆ©
                        if (lastAddedTime.compareAndSet(latest, now)) {
                            int sc;
                            do {
                                c = tokenCount.get();
                                // ä¿è¯æ·»åŠ åçš„ Token æ•°é‡ä¸ä¼šè¶…è¿‡ä¸Šé™
                                sc = Math.min(bucketSize, c + except);
                            } while (!tokenCount.compareAndSet(c, sc));
    
                            // æ·»åŠ å®Œæˆå, ç»§ç»­æ‰§è¡Œ Token è·å–çš„æµç¨‹
                            break;
                        } else {
                            Thread.onSpinWait();
                        }
                    } else if (c >= accept) /* å¦‚æœå‰©ä½™çš„ Token æ•°é‡è¶³å¤Ÿä¸”æ— éœ€æ·»åŠ , ä¹Ÿå¯è¿›å…¥ä¸‹ä¸€æ­¥ */ {
                        break;
                    } else /* å¦åˆ™ç›´æ¥è¿”å›ç­‰å¾…æŒ‡å®šæ•°é‡çš„ Token æ‰€éœ€è¦çš„æ—¶é—´(ms) */ {
                        wait = (int) Math.ceil(1000 / rate) * accept - interval;
                        break addAndGetTokens;
                    }
                }
    
                do {
                    c = tokenCount.get();
                } while (c > 0 && !(gain = tokenCount.compareAndSet(c, c - 1)));
            }
    
            return wait;
        }
    }
    
    

  
  

é™æµåº“çš„å®ç°
------

åœ¨äº†è§£å®Œç°åœ¨åœ¨ç½‘ç»œä¸Šæµè¡Œçš„ä¸»æµé™æµç®—æ³•åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹åœ¨å®é™…æ—¶çš„é™æµåº“çš„å®ç°ï¼Œå…¶ä¸­ç”±äºå¾ˆå¤šé™æµåº“ç”¨åˆ°äº†å„ç§æ— é”ç­–ç•¥å’Œä¸“é—¨åšäº†å¯¹"ä¼ªå…±äº«"ã€æƒŠç¾¤æ•ˆåº”ç­‰å¸¸è§å¹¶å‘é—®é¢˜çš„å¤„ç†ï¼Œæ‰€ä»¥ä½ å¯èƒ½ä¼šå¯¹å®ƒä»¬ç¨å¾®æœ‰ç‚¹é™Œç”Ÿã€‚æˆ‘ä»¬å…ˆæ¥çœ‹æœ€æµè¡Œçš„åœ¨ Guava ä¸­çš„é™æµç®—æ³•çš„å®ç°ã€‚

  

### Guava å®ç°

Guava çš„é™æµç®—æ³•ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œä¸”æ”¯æŒé¢„çƒ­åŠŸèƒ½ï¼Œä½¿ç”¨ä¹Ÿååˆ†ç®€å•ã€‚

#### åŸºç¡€ç”¨ä¾‹

    // åˆ›å»ºä¸€ä¸ªé™æµå™¨, å…¶ä¸­æ¯ç§’å¯¹æ¡¶ä¸­æ”¾å…¥ 1000 ä¸ªä»¤ç‰Œ
    RateLimiter limiter = RateLimiter.create(1000);
    // åŒä¸Š, ä½†é¢„çƒ­æ—¶é—´ä¸º 1s
    RateLimiter limiterWithWarmup = RateLimiter.create(1000, Duration.ofSeconds(1));
    
    if (!limiter.tryAcquire(1)) {
      throw new RuntimeException("too fast!");
    }
    // æˆ‘ä»¬å°†ç­‰å¾… 1 ä¸ªä»¤ç‰Œå¯ç”¨
    limiter.acquire(1);   
    

  

#### æ™®é€šæ¨¡å¼å®ç°

æˆ‘ä»¬å…ˆæ¥åˆ†ææ™®é€šæ¨¡å¼ä¸‹çš„å®ç°

    public double acquire(int permits) {
      // è®¡ç®—è·å–æŒ‡å®š permit æ‰€éœ€è¦ç­‰å¾…çš„æ—¶é—´
      long microsToWait = reserve(permits);
      // ç­‰å¾…æŒ‡å®šæ—¶é—´
      stopwatch.sleepMicrosUninterruptibly(microsToWait);
      // è¿”å›ç­‰å¾…çš„æ—¶é—´
      return 1.0 * microsToWait / SECONDS.toMicros(1L);
    }
    

å…¶ä¸­ä¸»è¦è§‚å¯Ÿ `reserve` æ–¹æ³•

    final long reserve(int permits) {
      checkPermits(permits);
      synchronized (mutex()) /* è·å¾—äº’æ–¥é”è¿›è¡ŒåŠ é” */ {
        return reserveAndGetWaitLength(permits, stopwatch.readMicros());
      }
    }
    

è¿™é‡Œä½¿ç”¨çš„æ˜¯å¯¹ä¸€ä¸ª Object å¯¹è±¡ä½¿ç”¨ synchronized çš„æ–¹å¼è¿›è¡ŒåŠ é”ï¼Œæ¥ä¸‹æ¥çœ‹å…·ä½“ä»£ç ï¼š

è¿™æ®µä»£ç çš„å…¥å‚ä¸ºéœ€è¦è·å–çš„ permit æ•°é‡ä¸å½“å‰æ—¶é—´ï¼ŒåŒæ—¶è¿”å›éœ€è¦ç­‰å¾…çš„æ—¶é—´

    final long reserveEarliestAvailable(int requiredPermits, long nowMicros) {
      // é¦–å…ˆå¡«å…… permit çš„æ•°é‡
      resync(nowMicros);
      long returnValue = nextFreeTicketMicros;
      // è®¡ç®—å°†è¦æ¶ˆè€—çš„ permit çš„æ•°é‡
      double storedPermitsToSpend = min(requiredPermits, this.storedPermits);
      // è¿˜éœ€è¦çš„ permit çš„æ•°é‡
      double freshPermits = requiredPermits - storedPermitsToSpend;
      long waitMicros =
        // (é¢„çƒ­æ¨¡å¼ä¸‹å¯ç”¨, å¦åˆ™ä¸º 0)
        storedPermitsToWaitTime(this.storedPermits, storedPermitsToSpend)
        // éœ€è¦çš„ permit æ•°é‡ * è·å–å•ä¸ª permit æ‰€éœ€æ—¶é—´
        + (long) (freshPermits * stableIntervalMicros);
    
      // å°†ä¸Šæ¬¡æ·»åŠ  permit çš„æ—¶é—´åŠ ä¸Šéœ€è¦ç­‰å¾…çš„æ—¶é—´(ç›¸å½“äºé¢„æ”¯äº†è¿™éƒ¨åˆ†çš„ permit, ä¹‹åä¼š sleep è¿™æ®µé¢„æ”¯çš„æ—¶é—´)
      this.nextFreeTicketMicros = LongMath.saturatedAdd(nextFreeTicketMicros, waitMicros);
      // å‡å»æ¶ˆè€—çš„ permit æ•°é‡
      this.storedPermits -= storedPermitsToSpend;
      return returnValue;
    }
    

å…¶ä¸­ `resync` æ–¹æ³•æ˜¯åœ¨è¿›è¡Œè·å–ä»¤ç‰Œå‰æ ¹æ®å½“å‰çš„æ—¶é—´å’Œä¸Šæ¬¡æ·»åŠ æ—¶é—´è¿›è¡Œå›å¡«

    void resync(long nowMicros) {
      // å¦‚æœå½“å‰æ—¶é—´å¤§äºä¸‹ä¸€æ¬¡èƒ½å¤Ÿ permit çš„æ—¶é—´, åˆ™è¿›è¡Œè·å–
      if (nowMicros > nextFreeTicketMicros) {
        // è®¡ç®—èƒ½å¤Ÿæ·»åŠ çš„ permit æ•°é‡ (ç°åœ¨ä¸ä¸Šä¸€æ¬¡è·å–çš„æ—¶é—´çš„é—´éš” / ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œæ‰€éœ€çš„æ—¶é—´)
        double newPermits = (nowMicros - nextFreeTicketMicros) / coolDownIntervalMicros();
        // ä¿è¯ permit å­˜å‚¨æ•°é‡å°äºä¸Šé™çš„æƒ…å†µä¸‹è¿›è¡Œå¢åŠ 
        storedPermits = min(maxPermits, storedPermits + newPermits);
        // åœ¨æ·»åŠ  permit åæ›´æ–°æ—¶é—´
        nextFreeTicketMicros = nowMicros;
      }
    }
    

åŒæ—¶åœ¨è®¾ç½®æ–°çš„ rate çš„æ—¶å€™ä¼šä»¤å½“å‰å­˜å‚¨çš„ permit æ¯”ä¾‹æ”¾å¤§æˆ–ç¼©å°

    storedPermits =
      (oldMaxPermits == 0.0)
      ? 0.0 // initial state
      : storedPermits * maxPermits / oldMaxPermits;
    

  

#### é¢„çƒ­åŠŸèƒ½

Guava çš„ RateLimiter è¿˜åŒ…å«é¢„çƒ­åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®é¢„çƒ­æ—¶é—´å‚æ•°ï¼Œè¿™é€‚ç”¨äºèµ„æºéœ€è¦é¢„çƒ­çš„åœºæ™¯ã€‚ä¾‹å¦‚ç¼“å­˜æ± ï¼Œåœ¨å¼€å§‹æ—¶æˆ–å¾ˆä¹…æ²¡æœ‰è¯·æ±‚æ—¶ç¼“å­˜æ± æ˜¯ç©ºçš„ï¼Œæ­¤æ—¶å¦‚æœå¿½ç„¶æœ‰å¤§é‡è¯·æ±‚æ‰“è¿‡æ¥ï¼Œåˆ™ç”±äºç¼“å­˜æ± ä¸ºç©ºï¼Œåˆ™å¤§é‡è¯·æ±‚ä¼šæ‰“åˆ°æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“å¯èƒ½å‘ç”Ÿå®•æœºï¼›è€Œå¦‚æœæ­¤æ—¶ç›´æ¥ä½¿ç”¨é™æµåŠŸèƒ½ï¼Œè‹¥å…è®¸é€šè¿‡çš„æµé‡è¿‡å°ï¼Œåˆ™å¯¼è‡´ç¼“å­˜æ± åœ¨å¡«å……å®Œæˆåèƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚å¤§äºä¸€å¼€å§‹å…è®¸é€šè¿‡çš„è¯·æ±‚é‡ã€‚é‚£ä¹ˆæ­¤æ—¶å¦‚æœä½¿ç”¨é¢„çƒ­åŠŸèƒ½ï¼Œä½¿å¾—èµ„æºåœ¨é¢„çƒ­é˜¶æ®µåŠ è½½åˆ°ç¼“å­˜ï¼Œåœ¨é¢„çƒ­å®Œæˆåå…è®¸æ›´é«˜çš„æµé‡é€šè¿‡ï¼Œåˆ™å¯ä»¥æœ€å¤§é™åº¦çš„"å‹æ¦¨"æœåŠ¡çš„æ€§èƒ½ã€‚

æˆ‘ä»¬æ¥çœ‹é¢„çƒ­åŠŸèƒ½å…·ä½“çš„å®ç°åŸç†ï¼š

ä»¥ä¸‹ä¸ºå±•ç¤ºé¢„çƒ­åŠŸèƒ½çš„ä¸€å¼ å›¾ï¼Œå…¶ \\(X\\) è½´è¡¨ç¤ºçš„æ˜¯æ¡¶ä¸­å­˜æ”¾çš„ä»¤ç‰Œæ•°é‡ï¼Œ\\(Y\\) è½´ä¸ºä»æ¡¶ä¸­å–å‡ºä¸€ä¸ªä»¤ç‰Œæ‰€éœ€è¦èŠ±è´¹çš„æ—¶é—´ï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419194648.png)

ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå½“ä»¤ç‰Œæ¡¶æ»¡çš„æ—¶å€™ï¼Œå³ permit æ•°é‡ç­‰äº \\(max\\\_permits\\) æ—¶ï¼Œæ­¤æ—¶æ‰€éœ€è¦èŠ±è´¹çš„æ—¶é—´æ˜¯æœ€å¤šçš„ï¼Œä¸º \\(cold\\\_ interval\\) ï¼›ç„¶åæˆ‘ä»¬ä¸æ–­çš„ä»æ¡¶ä¸­å–å‡ºä»¤ç‰Œï¼Œæ­¤æ—¶æ‰€èŠ±è´¹çš„æ—¶é—´è¶Šæ¥è¶Šå°‘ï¼Œç›´åˆ°æ¡¶ä¸­ä»¤ç‰Œæ•°å°äº \\(threshold\\\_permits\\) ï¼Œæ­¤æ—¶å–å‡ºä¸€ä¸ªä»¤ç‰Œæ‰€éœ€çš„æ—¶é—´å°†å›ºå®šä¸º \\(stable\\\_interval\\)ã€‚

ä½ å¯ä»¥å‘ç°ï¼Œå½“ä»¤ç‰Œæ¡¶æ»¡æ—¶ï¼Œæ­¤æ—¶ä¸€èˆ¬ä¸ºè¾ƒé•¿æ—¶é—´æ²¡æœ‰è·å–èµ„æºï¼Œè€Œæ­¤æ—¶å¦‚æœéœ€è¦è·å–åˆ™è¦è¿›è¡Œ"é¢„çƒ­"ï¼Œæˆ‘ä»¬åœ¨è¯¥ç®—æ³•ä¸­åˆšå¥½ä¼šç­‰å¾…è¾ƒé•¿æ—¶é—´ï¼Œè¿™æ­£å¥½ç¬¦åˆäº†æˆ‘ä»¬çš„éœ€æ±‚ï¼æ‰€ä»¥è¯¥ç®—æ³•ç¡®å®å¯ä»¥ä½œä¸ºé¢„çƒ­åŠŸèƒ½çš„å®ç°ã€‚

ç®€å•çš„äº†è§£äº†å®ç°åŸç†åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å­¦ä¹ è¯¥ç®—æ³•çš„å…·ä½“ç»†èŠ‚ï¼ˆåˆ«æ‹…å¿ƒï¼Œåªéœ€è¦åˆä¸­æ•°å­¦æ°´å¹³ğŸ˜‡ï¼‰

é¦–å…ˆï¼Œè¯¥ç®—æ³•å…·æœ‰å‡ ä¸ªé¢„è®¾ï¼š

*   \\(cold\\\_interval=cold\\\_factor\\times stable\\\_interval\\)
*   \\(cold\\\_factor\\) ä¸ºå†·å¯åŠ¨è´Ÿè½½å› å­ï¼Œå…¶å€¼åœ¨ Guava ä¸­ç¡¬ç¼–ç ä¸º \\(3\\)
*   \\(max\\\_permits=threshold\\\_permits\\times2\\)
*   \\(warm\\\_up\\\_period\\) ä¸ºæˆ‘ä»¬è‡ªå·±è®¾ç½®çš„æ—¶é—´ï¼Œå…¶å€¼ä¸ºè¯¥å‡½æ•°ä» \\(max\\\_permits\\) åˆ° \\(threshold\\\_permits\\) çš„ç§¯åˆ†ï¼ˆå°±æ˜¯è¿™å—æ¢¯å½¢çš„é¢ç§¯ï¼‰

åŒæ—¶ç”±äºè¯¥å‡½æ•°çš„æ€§è´¨ï¼Œå½“æˆ‘ä»¬åœ¨ \\(stored\\\_permits\\) ä¸º \\(X\\) æ—¶ï¼Œæƒ³è¦è·å– \\(K\\) ä¸ª permitï¼ˆå…¶ä¸­ \\(K<=X\\)ï¼‰ï¼Œè·å–åè¿˜å‰©ä¸‹ \\(X-K\\) ä¸ª permitï¼Œæ­¤æ—¶æ‰€éœ€è¦æ¶ˆè€—çš„æ—¶é—´ä¸º \\(X-K\\) åˆ° \\(X\\) çš„ç§¯åˆ†ï¼ˆå°±æ˜¯è¿™å—çš„é¢ç§¯ï¼‰ã€‚

æ­¤æ—¶åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419194724.png)

è¿™æ ·å°±å˜æˆåˆä¸­æ•°å­¦é¢˜äº†ï¼Œå³å›¾ä¸­æ‰€æœ‰å˜é‡å·²çŸ¥ï¼Œæ±‚å›¾å½¢ä¸­é˜´å½±çš„é¢ç§¯ï¼Œæ±‚åˆ°çš„é¢ç§¯å€¼ä¸ºéœ€è¦ç­‰å¾…çš„æ—¶é—´ã€‚

æ¥ä¸‹æ¥ä¸ºäº†æ–¹ä¾¿è®¡ç®—ï¼Œæˆ‘ä»¬å¯¹é—®é¢˜è¿›è¡Œç®€åŒ–ï¼Œå¹¶æ¥æ ¹æ®å·²çŸ¥çš„æ¡ä»¶æ¥è®¡ç®—å‡ºè®¡ç®—è¯¥é¢˜éœ€è¦çš„å‚æ•°ã€‚

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419194809.png)

è¿™ä¸‹ä½ å¯èƒ½å°±æ„Ÿè§‰äº²åˆ‡å¤šäº†ï¼Œç„¶åæˆ‘ä»¬å†å°†å·²çŸ¥çš„æ¡ä»¶åˆ—å‡ºæ¥ï¼š

\\\[\\left\\{ \\begin{aligned} y\_2&=3\\cdot y\_1\\\\ x\_2&=2\\cdot x\_1\\\\ S\_1&=y\_1\\cdot x\_1\\\\ S\_2&=\\frac{y\_1+y\_2}{2}\\cdot (x\_2-x\_1) \\end{aligned} \\right. \\\]

å¹¶ä¸”å¯ä»¥è”ç«‹è§£å¾—ï¼š

\\\[S\_2=2\\cdot S\_1 \\\]

æˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡è¿™ä¸ªå…¬å¼ç»§ç»­æ±‚å…¶ä»–å˜é‡ï¼Œé¦–å…ˆæˆ‘ä»¬ç°åœ¨å¯¹å‡½æ•°è¾“å…¥ \\(permmits\\\_per\\\_sercord\\) ä¸ \\(stored\\\_premits\\)ï¼Œå…¶åˆ†åˆ«å¯¹åº” \\(y\_1\\) ä¸ \\(S\_2\\) ï¼Œç„¶åå¥—å…¥æˆ‘ä»¬å…·æœ‰çš„å…¬å¼ã€‚

1.  ç”± \\(y\_2=3\\cdot y\_1\\)ï¼Œå¾—çŸ¥ \\(y\_2\\)
2.  ç”± \\(S\_2=2\\cdot S\_1\\)ï¼Œå¾—çŸ¥ \\(S\_1\\)
3.  ç”± \\(S\_1=y\_1\\cdot x\_1\\)ï¼Œå¾—çŸ¥ \\(x\_1\\)
4.  ç”± \\(S\_2=\\frac{y\_1+y\_2}{2}\\cdot (x\_2-x\_1)\\) ï¼Œå¾—çŸ¥ \\(x\_2\\)

è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“äº†æ‰€æœ‰æ¶‰åŠçš„å˜é‡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å›å»æ¥ç€æ±‚ä¸‰ä¸ªå›¾å½¢çš„é˜´å½±é¢ç§¯å•¦ (æ±‚è¿™å‡ ä¸ªå›¾å½¢çš„é˜´å½±é¢ç§¯åº”è¯¥ä¸éš¾ï¼Œæ•…ä¸è¿›è¡Œè§£é‡Š)ã€‚

  

ç„¶åå†è®©æˆ‘ä»¬å†å›çœ‹é¢„çƒ­åŠŸèƒ½çš„ä»£ç å®ç°ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†ä»£ç éƒ½å’Œæ™®é€šæ¨¡å¼é€šç”¨ï¼Œç¬¬ä¸€ä¸ªä¸åŒåœ¨äºä»¤ç‰Œç”Ÿæˆé—´éš”ï¼Œåœ¨æ™®é€šæ¨¡å¼ä¸‹ç›´æ¥ä¸º \\({1}/{permmits\\\_per\\\_sercord}\\)ï¼Œè€Œåœ¨é¢„çƒ­æ¨¡å¼åˆ™ä¸º \\(warmupPeriod/maxPermits\\) ã€‚å…¶æ¬¡åœ¨äºæˆ‘ä»¬åœ¨è®¡ç®— \\(waitMicros\\) æ—¶ï¼Œéœ€è¦é¢å¤–åŠ å…¥ç­‰å¾…æ—¶é—´ï¼Œè¯¥æ—¶é—´çš„è®¡ç®—æ–¹æ³•å¦‚ä¸‹ï¼š

    @Override
    long storedPermitsToWaitTime(double storedPermits, double permitsToTake) {
      // å·²å­˜å‚¨è®¸å¯å‡å»ç¨³å®šè®¸å¯
      double availablePermitsAboveThreshold = storedPermits - thresholdPermits;
      long micros = 0;
      // å¦‚æœå¤§äº 0, åˆ™éœ€è¦è®¡ç®—æ›²çº¿çš„æ¢¯å½¢éƒ¨åˆ†
      if (availablePermitsAboveThreshold > 0.0) {
        // åœ¨æ¢¯å½¢åŒºåŸŸä¸­æ‰“ç®—å–å‡ºçš„éƒ¨åˆ†
        double permitsAboveThresholdToTake = min(availablePermitsAboveThreshold, permitsToTake);
        // ä½¿ç”¨æ¢¯å½¢é¢ç§¯å…¬å¼è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´ (ä¸Šåº•+ä¸‹åº•)*é«˜/2
        double length =
          permitsToTime(availablePermitsAboveThreshold)
          + permitsToTime(availablePermitsAboveThreshold - permitsAboveThresholdToTake);
        micros = (long) (permitsAboveThresholdToTake * length / 2.0);
        // å‡å»æ¢¯å½¢éƒ¨åˆ†çš„ permit, å‰©ä¸‹é•¿æ–¹å½¢éƒ¨åˆ†
        permitsToTake -= permitsAboveThresholdToTake;
      }
      // åŠ ä¸Šæ›²çº¿çš„é•¿æ–¹å½¢éƒ¨åˆ†
      micros += (long) (stableIntervalMicros * permitsToTake);
      return micros;
    }
    
    private double permitsToTime(double permits) {
      // è®¡ç®—åœ¨ Y è½´ä¸Šçš„å€¼ (slope ä¸ºæ¢¯å½¢ä¸Šæ›²çº¿çš„æ–œç‡)
      return stableIntervalMicros + permits * slope;
    }
    

è¿™æ · Guava åœ¨é¢„çƒ­æ¨¡å¼ä¸‹çš„è¡Œä¸ºæˆ‘ä»¬å°±å¼„æ¸…æ¥šäº†

> ä»¥ä¸‹ä¸º Guava åœ¨ RateLimiter ä¸‹æ–‡æ¡£ç²—ç¿»ï¼Œä½ è‹¥æœ‰å…´è¶£å¯ç®€å•äº†è§£ä¸‹
> 
> ![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220419194911.png)

åœ¨äº†è§£äº†å…¶ä¸­ä¸€ä¸ªç®—æ³•çš„å®ç°åå†é˜…è¯»å…¶ä»–çš„åº“å°±å¥½åŠå¤šäº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥æˆ‘ä»¬å†äº†è§£å…¶ä»–æµè¡Œçš„é™æµåº“ã€‚

  

### Bucket4j å®ç°

Bucket4j åŒæ ·ä½¿ç”¨çš„æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œä¸è¿‡åœ¨è®¾è®¡ä¸Šç›¸æ¯” Guava çš„ RateLimiter ç²¾åº¦æ›´é«˜ã€æ”¯æŒé…ç½®åŠ¨æ€æ›´æ¢ã€æ›´åŠ è‰¯å¥½çš„å¹¶å‘ç­–ç•¥ã€æ›´ä¸°å¯Œçš„ç”¨äºæ—¥å¿—è®°å½•çš„ APIï¼ŒåŒæ—¶æ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜ (è¿™æ˜¯å•¥æˆ‘ä»¬ä¼šåœ¨åé¢å†è®²)ã€‚

#### åŸºç¡€ç”¨ä¾‹

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹ä»–çš„ç®€å•ä½¿ç”¨

    Bandwidth limit = Bandwidth
      // è®¾ç½®æ¯åˆ†é’Ÿåªå…è®¸é€šè¿‡ 1000 ä¸ªè¯·æ±‚
      .simple(1000, Duration.ofMinutes(1));
    Bandwidth limit2 = Bandwidth
      // åŒæ—¶æ¯ç§’ä»…å…è®¸é€šè¿‡ 50 ä¸ªè¯·æ±‚
      .simple(50, Duration.ofSeconds(1))
      // åˆå§‹å®¹é‡, å¦‚æœä¸è¿›è¡Œè®¾ç½®åˆ™ç›´æ¥ä¸ºçª—å£æœ€å¤§å€¼
      .withInitialTokens(Long.MAX_VALUE);
    Bucket bucket = Bucket.builder()
      .addLimit(limit)
      .addLimit(limit2)
      // è®¾ç½®åŒæ­¥ç­–ç•¥: æ”¯æŒæ— é”æ¨¡å¼å’ŒåŠ é”æ¨¡å¼
      .withSynchronizationStrategy(SynchronizationStrategy.LOCK_FREE)
      .build();
    
    // å°è¯•æ¶ˆè´¹ä¸€ä¸ª Token
    bucket.tryConsume(1);
    

å…¶ä¸­å¤šé‡é™åˆ¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå½“æˆ‘ä»¬éœ€è¦æ¯åˆ†é’Ÿåªå…è®¸é€šè¿‡ 1000 ä¸ªè¯·æ±‚ä½†åˆä¸å¸Œæœ›å®ƒåœ¨ä¸€ç§’é’Ÿå†…å…¨éƒ¨ç”¨å®Œï¼Œå°±å¯ä»¥å†è®¾ç½®ä¸€ä¸ªæ¯ç§’åªå…è®¸é€šè¿‡ 50 ä¸ªè¯·æ±‚çš„è§„åˆ™ã€‚

> å½“ç„¶è¿™ä¸ªåŠŸèƒ½åœ¨ Guava ä¹Ÿå­˜åœ¨ï¼Œåªä¸è¿‡éœ€è¦è‡ªè¡Œå®šä¹‰ä¸¤ä¸ªé™æµå™¨æ¥ä¸€èµ·ä½¿ç”¨

  

#### æºç è§£æ

æˆ‘ä»¬æ¥ç€æ¥çœ‹å…·ä½“çš„æºç å®ç°ï¼Œå…¶ä¸­ç”±äºåŠ é”æ¨¡å¼å’Œ Guava çš„æ€è·¯å·®ä¸å¤šï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»æ— é”å¹¶å‘çš„æ¨¡å¼ã€‚

    protected boolean tryConsumeImpl(long tokensToConsume) {
      // ä»åŸå­å¼•ç”¨ä¸­è·å–ä¸Šä¸€ä¸ªæ¡¶å¿«ç…§
      BucketState previousState = stateRef.get();
      // å¤åˆ¶æ¡¶å¿«ç…§
      BucketState newState = previousState.copy();
      long currentTimeNanos = timeMeter.currentTimeNanos();
    
      while (true) {
        // åˆ·æ–°å¤åˆ¶å‡ºæ¥çš„æ¡¶å¿«ç…§çš„ä¸Šæ¬¡ä»¤ç‰Œå¡«å……æ—¶é—´
        newState.refillAllBandwidth(currentTimeNanos);
        long availableToConsume = newState.getAvailableTokens();
        // åˆ·æ–°åä»¤ç‰Œä¹Ÿä¸è¶³, ç›´æ¥æ‹’ç»
        if (tokensToConsume > availableToConsume) {
          return false;
        }
        // å‡å»æ¶ˆè€—çš„ä»¤ç‰Œæ•°é‡
        newState.consume(tokensToConsume);
        // é€šè¿‡ CAS å°†æ—§çš„æ¡¶å¿«ç…§æ›´æ–°
        if (stateRef.compareAndSet(previousState, newState)) {
          return true;
        } else {
          // å¦åˆ™é‡æ–°è·å–å¿«ç…§
          previousState = stateRef.get();
          newState.copyStateFrom(previousState);
        }
      }
    }
    

è¿™é‡Œçš„æ€è·¯ä¸ºé€šè¿‡å­˜å‚¨å¿«ç…§å¹¶è¿›è¡Œ CAS çš„æ–¹å¼æ›´æ–°å¿«ç…§ï¼Œä»è€Œè¾¾åˆ°æ— é”åŒ–çš„å®ç°ï¼Œæ‰€ä»¥æ€§èƒ½ç›¸æ¯”äºéœ€è¦åŠ é”çš„ Guava ä¼šé«˜å‡ºä¸€äº›ï¼ˆåšä¸»åšçš„å¾®åŸºå‡†æµ‹è¯•ä¸­å…·ä½“ä¸ºé«˜å‡ºä¸€å€ï¼‰ã€‚

æ¡¶çš„å¿«ç…§å®é™…ä¸Šä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå…¶æ¯ä¸‰ä¸ªå…ƒç´ è¡¨ç¤ºä¸€ä¸ªé™æµè§„åˆ™ï¼Œä¸€ä¸ªé™æµè§„åˆ™çš„è¡¨ç¤ºä¸º \[ä¸Šæ¬¡æ·»åŠ çš„æ—¶é—´æˆ³ (çº³ç§’ç²¾åº¦) ï¼Œå½“å‰æ¡¶ä¸­çš„å‰©ä½™ä»¤ç‰Œçš„æ•°é‡ï¼Œèˆå…¥è¯¯å·®\]ã€‚

æˆ‘ä»¬æ¥çœ‹ç¤ºä¾‹ä¸­çš„æ¡¶å¿«ç…§è¡¨ç¤ºï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220420112809.png)

> ä½ å¯èƒ½æ³¨æ„åˆ°ç¬¬äºŒä¸ªé™æµè§„åˆ™çš„å‰©ä½™ä»¤ç‰Œæ•°æœ‰å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è®¾ç½®åˆå§‹å®¹é‡çš„æ—¶å€™è®¾ç½®ä¸ºäº† Long.MAX\_VALUEï¼Œä¸€èˆ¬å½“ç„¶ä¸ä¼šè¿™ä¹ˆè®¾ç½®ã€‚

  

### Sentinel å®ç°

æœ€åæˆ‘ä»¬å†æ¥äº†è§£ä¸‹ä¹Ÿç®—æ˜¯è¾ƒä¸ºæµè¡Œçš„é™æµæ¡†æ¶ Sentinelï¼›Sentinel æ”¯æŒæµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€æƒé™æ§åˆ¶ç­‰æ›´åŠ ä¸°å¯Œçš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ€§èƒ½ç›¸æ¯”äºå…¶ä»–é™æµåº“ä¹Ÿæ˜¯ä¸ä½çš„ã€‚

Sentinel çš„æµé‡æ§åˆ¶æœºåˆ¶æ˜¯è¾ƒä¸ºä¸°å¯Œçš„ï¼Œå…¶æ”¯æŒé€šè¿‡ QPS é™æµå’Œçº¿ç¨‹æ•°é™æµã€‚çº¿ç¨‹æ•°é™æµæ¯”è¾ƒç®€å•ï¼Œå³ä¸ºæ§åˆ¶åŒæ—¶æ‰§è¡Œä¸šåŠ¡å•å…ƒçš„æ“ä½œæ•°é‡ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šæ•°é‡åˆ™è¿›è¡Œæ‹’ç» (å¾ˆç®€å•ï¼Œç”¨ä¸€ä¸ªä¿¡å·é‡å³å¯å®ç°)ã€‚

æˆ‘ä»¬ä¸»è¦æ¥å‰–æ QPS é™æµ

    @Override
    public void entry(Context context, ResourceWrapper resourceWrapper, DefaultNode node, int count,
                      boolean prioritized, Object... args) throws Throwable {
      // æ£€æŸ¥æ˜¯å¦è¶…å‡ºæµé‡é™åˆ¶å¹¶å¤„ç†
      checkFlow(resourceWrapper, context, node, count, prioritized);
    	// è¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹(è¿™ä¸æˆ‘ä»¬å…³å¿ƒçš„å†…å®¹æ— å…³)
      fireEntry(context, resourceWrapper, node, count, prioritized, args);
    }
    

å¯¹äº QPS é™æµï¼ŒSentinel æä¾›äº†å››ç§æµé‡æ•´å½¢æ§åˆ¶å™¨ (Traffic Shaping Controller)ï¼š

    /**
     * Rate limiter control behavior.
     * 0. default(reject directly)
     * 1. warm up
     * 2. rate limiter
     * 3. warm up + rate limiter
     */
    private int controlBehavior = RuleConstant.CONTROL_BEHAVIOR_DEFAULT;
    

æˆ‘ä»¬å…ˆæ¥äº†è§£ç¬¬ä¸€ä¸ªæ§åˆ¶è§„åˆ™

    @Override
    public boolean canPass(Node node, int acquireCount, boolean prioritized) {
      // å°†æ¯ä¸ªæ¡¶çš„å¹³å‡ä½¿ç”¨ä»¤ç‰Œé‡ä½œç”¨å½“å‰æ¡¶çš„å·²ä½¿ç”¨ä»¤ç‰Œæ•°é‡
      int curCount = avgUsedTokens(node);
      if (curCount + acquireCount > count) {
        if (prioritized && grade == RuleConstant.FLOW_GRADE_QPS) {
          // è‹¥è¦æ±‚çš„ä»¤ç‰Œè¶…å‡ºäº†æœ€å¤§å…è®¸çš„ä»¤ç‰Œæ•°é‡, å¹¶ä¸”å…è®¸é¢„æ”¯çš„è¯, åˆ™è¿›è¡Œç­‰å¾…
    
          long currentTime;
          long waitInMs;
          currentTime = TimeUtil.currentTimeMillis();
          // è®¡ç®—ç­‰å¾…çª—å£ä¸­çš„ä»¤ç‰Œå¯ç”¨çš„å¿…è¦æ—¶é—´
          waitInMs = node.tryOccupyNext(currentTime, acquireCount, count);
          // åªæœ‰å°äºè®¾å®šçš„æœ€å¤§å€¼æ‰å…è®¸ç­‰å¾…
          if (waitInMs < OccupyTimeoutProperty.getOccupyTimeout()) {
            node.addWaitingRequest(currentTime + waitInMs, acquireCount);
            // æå‰å ç”¨ä»¤ç‰Œ
            node.addOccupiedPass(acquireCount);
            // ç­‰å¾…éœ€è¦çš„ä»¤ç‰Œå¯ç”¨
            sleep(waitInMs);
    
            // PriorityWaitException indicates that the request will pass after waiting for {@link @waitInMs}.
            // é€šè¿‡æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼æ¥é€šçŸ¥ä¸Šå±‚åº”ç”¨ç­‰å¾…ä»¤ç‰Œçš„æ—¶é—´æ¶ˆè€—
            throw new PriorityWaitException(waitInMs);
          }
        }
        return false;
      }
      return true;
    }
    

ç”±äºæˆ‘ä»¬ä¹‹å‰å·²ç»é˜…è¯»äº†å…¶ä»–é™æµæ¡†æ¶çš„æºç ï¼Œè¿™é‡Œçš„å®ç°å½“ç„¶ä¹Ÿä¸åœ¨è¯ä¸‹ã€‚ä¸è¿‡å€¼å¾—æˆ‘ä»¬æ³¨æ„çš„æ˜¯è¿™é‡Œé‡‡ç”¨çš„æ˜¯æ»‘åŠ¨çª—å£ç®—æ³•ï¼Œå…·ä½“è®¡ç®—çš„ä»£ç å¯å’Œä»£ç ä¸‹æ–¹çš„å›¾ä¸€èµ·é£Ÿç”¨ : )

    @Override
    public double passQps() {
      // çª—å£å†…æ‰€æœ‰æ¡¶é€šè¿‡è¯·æ±‚çš„æ€»å’Œ
      return rollingCounterInSecond.pass() /
        // çª—å£çš„å¤§å°(å³ä¸€ä¸ªçª—å£å å¤šå°‘ç§’)
        rollingCounterInSecond.getWindowIntervalInSec();
    }
    
    @Override
    public long pass() {
      // æ ¹æ®æ—¶é—´å®šä½åˆ°å½“å‰æ¡¶
      // (å› ä¸ºæ»‘åŠ¨çª—å£ç®—æ³•å¹¶ä¸ä¼šçœŸçš„æœ‰ä¸€ä¸ªçº¿ç¨‹ä¸€ç›´åœ¨åå°æ¨åŠ¨çª—å£ç§»åŠ¨)
      data.currentWindow();
      long pass = 0;
      // çª—å£å†…æ‰€æœ‰çš„æ¡¶
      List<MetricBucket> list = data.values();
    
      // è®¡ç®—æ‰€æœ‰æ¡¶é€šè¿‡çš„è¯·æ±‚æ•°é‡(ä¹Ÿå°±æ˜¯è¢«å–èµ°çš„ä»¤ç‰Œ)
      for (MetricBucket window : list) {
        pass += window.pass();
      }
      return pass;
    }
    

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220421163533.png)

> å›¾æºè‡ª [Sentinel å®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/basic-implementation.html)

  

æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå·²ä½¿ç”¨çš„ä»¤ç‰Œæ•°æ˜¯ä¸€ä¸ªå¹³å‡å€¼ï¼Œæ‰€ä»¥ç›¸å¯¹äºå®é™…ä¸Šçš„é™åˆ¶è‚¯å®šæœ‰ç€ä¸€å®šçš„å‡ºå…¥ï¼Œä¸è¿‡åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå°±å’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡çš„ä¸€æ ·åå·®å¹¶ä¸ä¼šå¾ˆå¤§ã€‚

ç¬¬äºŒä¸ªæ¨¡å¼ä¸ºé¢„çƒ­æ¨¡å¼ï¼Œå…¶å’Œæˆ‘ä»¬ä¹‹å‰ä»‹ç»è¿‡ç®—æ³•å·®ä¸å¤šï¼Œæ‰€ä»¥å°±ç®€å•çš„äº†è§£ä¸‹å³å¯ï¼š

    public boolean canPass(Node node, int acquireCount, boolean prioritized) {
      long passQps = (long) node.passQps();
    
      // é€šè¿‡ä¸Šä¸€æ¬¡ QPS æ‰æ¥å¡«å……ä»¤ç‰Œæ¡¶
      long previousQps = (long) node.previousPassQps();
      syncToken(previousQps);
    
      long restToken = storedTokens.get();
      if (restToken >= warningToken) /* å½“å½“å‰ä»¤ç‰Œå¤§äºé˜ˆå€¼, åˆ™è¯´æ˜ä¸ºå†·ä»¤ç‰Œ */ {
        long aboveToken = restToken - warningToken;
        // current interval = restToken * slope + 1/count
        double warningQps = Math.nextUp(1.0 / (aboveToken * slope + 1.0 / count));
        if (passQps + acquireCount <= warningQps) {
          return true;
        }
      } else {
        if (passQps + acquireCount <= count) {
          return true;
        }
      }
    
      return false;
    }
    

ç¬¬ä¸‰ä¸ªæ¨¡å¼ä¸ºä½¿ç”¨ä»¤ç‰Œæ¡¶ä½¿ç”¨çš„é™æµç­–ç•¥ï¼Œå…¶ä¸»è¦å®ç°æ€è·¯å’Œæˆ‘ä»¬å­¦ä¹ è¿‡çš„ä»¤ç‰Œæ¡¶å®ç°æ€è·¯å·®ä¸å¤šï¼›ç¬¬å››ä¸ªæ¨¡å¼ä¸ºé¢„çƒ­åŠ ä»¤ç‰Œæ¡¶æ’é˜Ÿï¼Œæ•…éƒ½ä¸å†é‡å¤ä»‹ç»ã€‚

  
  

åˆ†å¸ƒå¼é™æµ
-----

æœ€åæˆ‘ä»¬å†æ¥è°ˆä¸‹åˆ†å¸ƒå¼é™æµï¼Œåˆ†å¸ƒå¼é™æµå¹¶ä¸æ˜¯ä¸€ç§æ–°çš„é™æµç®—æ³•ï¼Œè€Œæ˜¯å¯¹äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¯¹äºå•ä¸ªèµ„æºè¿›è¡Œé™æµçš„é—®é¢˜ã€‚

æƒ³è±¡æˆ‘ä»¬å…·æœ‰ä¸€ä¸ªå¤–éƒ¨ä»˜è´¹ APIï¼Œç”±äºä»»ä½•è¶…å‡ºé¢‘ç‡çš„è¯·æ±‚éƒ½éœ€è¦é¢å¤–ä»˜è´¹ï¼Œæ‰€ä»¥å¿…é¡»è¦ä¿è¯å…¨å±€ç³»ç»Ÿå¯¹äºè¿™ä¸ª API çš„è°ƒç”¨åœ¨æŒ‡å®šé¢‘ç‡ä¸‹ã€‚

ç°åœ¨æˆ‘ä»¬å°±æœ‰è¿™æ ·ä¸€ä¸ªå¾®æœåŠ¡ç³»ç»Ÿï¼š

![](https://enoc-1304077175.cos.ap-beijing.myqcloud.com/pic/20220424154320.png)

å¯¹äºè¿™ä¸ª API æ¥è®²ï¼Œå…¶å…·æœ‰ä¸‰ä¸ª ServiveA çš„å®ä¾‹å’Œä¸¤ä¸ª ServiceB çš„å®ä¾‹ï¼Œå¹¶ä¸”è¯¥ API ä¸­è°ƒç”¨å ServiceA åä¼šä½¿ç”¨åˆ° ServiceBï¼ŒåŒæ—¶è¿™ä¸¤ä¸ª Serivce éƒ½éœ€è¦è°ƒç”¨ä¸€æ¬¡å¤–éƒ¨ APIã€‚

ä¸€ä¸ªè¾ƒä¸ºç›´è§‚çš„æ€è·¯å°±æ˜¯åœ¨ API ç½‘å…³åšé™æµï¼Œå³ç›´æ¥åœ¨ç½‘å…³ç”³è¯·ä¸¤æ¬¡å¤–éƒ¨ API çš„è°ƒç”¨é¢åº¦ï¼Œå¦‚æœç”³è¯·æˆåŠŸæ‰è¿›è¡ŒæœåŠ¡çš„è¿›è¡Œï¼Œå¦åˆ™æ‹’ç»æœåŠ¡ã€‚ä½†è¿™ä¼šå¯¼è‡´å¶å°”çš„è¶…å‡ºé™é¢ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ç”³è¯·åˆ°é¢åº¦åæˆ‘ä»¬å¹¶æ²¡æœ‰ç«‹å³çš„ä½¿ç”¨ï¼Œå®é™…ä¸Šæ—¶å­˜åœ¨ä»ç½‘å…³åˆ°å„ä¸ªå¾®æœåŠ¡çš„ç½‘ç»œå»¶è¿Ÿçš„å¾®æœåŠ¡åˆ°å¾®æœåŠ¡ä¹‹é—´çš„å»¶è¿Ÿï¼Œå¯¼è‡´åœ¨å¤–éƒ¨ API æä¾›æ–¹ç›‘æ§çš„æµé‡æŒ‡æ ‡å’Œæˆ‘ä»¬è¿›è¡Œç›‘æ§çš„æŒ‡æ ‡ä¸åŒã€‚

æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ¥åšåˆ†å¸ƒå¼é™æµã€‚åˆ†å¸ƒå¼é™æµå¬èµ·æ¥é™Œç”Ÿï¼Œä¸è¿‡å®é™…ä¸Šåˆ†å¸ƒå¼é™æµå’Œå•ç‚¹é™æµåœ¨å®ç°ä¸Šæœ¬è´¨çš„åŒºåˆ«åªåœ¨äºæµé‡çš„ç›‘æ§æŒ‡æ ‡çš„å­˜å‚¨ï¼Œå•ç‚¹é™æµåªéœ€è¦å°†ç›‘æ§æŒ‡æ ‡å­˜å‚¨åˆ°å½“å‰æœºå™¨çš„å†…å­˜ä¸­å³å¯ï¼Œè€Œåˆ†å¸ƒå¼é™æµåˆ™éœ€è¦è®©å‚ä¸åˆ†å¸ƒå¼é™æµçš„å„ä¸ªèŠ‚ç‚¹ååŒæ¥è¿›è¡Œé™æµçš„ä»²è£ã€‚æ›´ç®€å•çš„è¯´ï¼Œå•æœºé™æµå’Œåˆ†å¸ƒå¼é™æµçš„ä¸»è¦åŒºåˆ«åœ¨äºä½¿ç”¨ä»£ä»·ä¸åŒï¼Œå‰è€…åªéœ€è¦è¯»å–ä¸€æ¬¡ç¼“å­˜çš„ä»£ä»·ï¼Œåè€…åˆ™éœ€è¦æœ€å°‘ä¸€æ¬¡çš„ç½‘ç»œé€šä¿¡ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å°½å¯èƒ½çš„é€‰ç”¨ç½‘ç»œé€šä¿¡æ¬¡æ•°è¾ƒå°‘çš„é™æµç®—æ³•ã€‚

ä¸€ç§ç®€å•çš„æ€è·¯æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨ Redis é›†ç¾¤æ¥åšé›†ä¸­å¼ç¼“å­˜ï¼Œæ”¶é›†æµé‡çš„ç›‘æ§æŒ‡æ ‡ï¼ŒåŒæ—¶ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•ä½œä¸ºé™æµç®—æ³•ï¼Œåœ¨è·å–ä»¤ç‰Œçš„æ—¶å€™ï¼Œé€šè¿‡ lua è„šæœ¬åŸå­æ‰§è¡Œä»¤ç‰Œçš„å¡«å……ä¸è·å–çš„ä»£ç ã€‚

ä½†å³ä½¿è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æ¯ä¸€ä¸ªè¯·æ±‚çš„åˆ°æ¥ä»ç„¶éœ€è¦ä¸€æ¬¡ç½‘ç»œçš„é€šä¿¡æˆæœ¬ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹ï¼Œåœ¨è·å–ä»¤ç‰Œçš„æ—¶å€™ä¸€æ¬¡æ€§è·å–å¤šä¸ªä»¤ç‰Œï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘é€šä¿¡çš„æˆæœ¬ã€‚ä¸è¿‡éšå³è¿™ä¼šå¸¦æ¥ç›‘æ§æŒ‡æ ‡å¼‚å¸¸çš„é—®é¢˜ï¼Œå› ä¸ºè·å–ä»¤ç‰Œçš„æ—¶é—´å’Œä½¿ç”¨ä»¤ç‰Œçš„æ—¶é—´å¯èƒ½ç›¸å·®æ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºè·å–åˆ°çš„ä»¤ç‰Œéœ€è¦å…·æœ‰è¿‡æœŸæ—¶é—´ï¼Œå¦åˆ™ä¼šå¯¼è‡´å®é™…ä¸Šçš„æŒ‡æ ‡ç›‘æ§å¼‚å¸¸ã€‚

> ä¸è¿‡ï¼Œä½ ä¹Ÿå°†å¤–éƒ¨ API å•ç‹¬åšä¸ºä¸€ä¸ªæœåŠ¡ï¼ŒåŒæ—¶åœ¨è¯¥æœåŠ¡ä¸Šè¿›è¡Œå•æœºé™æµï¼Œè¿™æ ·å¯ä»¥ä»¥è¾ƒä½çš„æˆæœ¬åšåˆ°è¾ƒé«˜çš„ç²¾åº¦ã€‚

ä½†è¿™ç§æ–¹æ¡ˆå¹¶ä¸æ˜¯ä¸‡é‡‘æ²¹ï¼Œå®é™…ä¸Šä½ å¯ä»¥å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬çš„æœåŠ¡åœ¨è°ƒç”¨åˆ°ä¸€åŠçš„æ—¶å€™ä»¤ç‰Œç”¨å°½ï¼Œè¯¥é“¾è·¯å°†æœ€ç»ˆåªèƒ½æ‰§è¡Œåˆ°ä¸€åŠå°±é€€å‡ºï¼Œæ— æ³•å®Œæˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡å®ä½“ã€‚ä½ ä¹Ÿè®¸è§‰å¾—è¿™æ˜¯å‘ç”Ÿæ¦‚ç‡å¾ˆä½çš„äº‹ä»¶ï¼Œä½†æˆ‘ä»¬å¯ä»¥æƒ³è±¡è¿™ä¹ˆä¸€ç§æƒ…å†µï¼šæ­¤æ—¶æœåŠ¡ä¸€å¼€å§‹æ— äººä½¿ç”¨ï¼Œå¿½ç„¶é—´åˆ°è¾¾æŸä¸ªæ—¶é—´ç‚¹ï¼Œæœ‰å¤§é‡è¯·æ±‚åˆ°æ¥ï¼Œä¸”ä»¥å‡ ä¹ä»¥ç›¸åŒçš„æ—¶é—´å®Œæˆäº† ServiceAï¼Œä½†åœ¨ ServiceB çš„æ‰§è¡Œä¸­ç”±äº ServiceA ä½¿ç”¨å®Œäº†æ‰€æœ‰çš„ä»¤ç‰Œï¼Œæ‰€ä»¥æ­¤æ—¶ ServiceB çš„å¤„ç†éœ€è¦ç­‰å¾…ç›´åˆ°æŠ¢åˆ°ä»¤ç‰Œã€‚è€Œä¸€æ—¦å‘ç”Ÿè¿™ç§æƒ…å†µåˆ™å¿…ç„¶å‡ºç°è¶…æ—¶ä»ç„¶æœªæŠ¢åˆ°ä»¤ç‰Œçš„è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å°±ç™½ç™½çš„æµªè´¹äº†ç³»ç»Ÿä¸­ SerivceA æ‰§è¡Œçš„èµ„æºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨ä¸€å¼€å§‹å°±ç”³è¯·å®Œæ‰€éœ€çš„æ‰€æœ‰èµ„æºï¼Œä½†è¿™æ ·ä½ åˆä¼šé‡åˆ°ä¹‹å‰æåˆ°çš„"è·å–ä»¤ç‰Œæ—¶é—´å’Œä½¿ç”¨ä»¤ç‰Œæ—¶é—´ç›¸å·®è¾ƒå¤§"çš„é—®é¢˜ï¼Œå¹¶ä¸”è¿˜ä¼šå¯¼è‡´å¯¹äºä¸šåŠ¡çš„ä¾µå…¥ç¨‹åº¦è¾ƒé«˜ã€‚

æ•…å¯¹äºåˆ†å¸ƒå¼çš„é™æµï¼Œåœ¨ç°å®ç³»ç»Ÿä¸­å¾ˆéš¾å¾—å‡ºä¸€ä¸ªå®Œç¾çš„æ–¹æ¡ˆï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ç›®æ ‡åº”è¯¥æ˜¯æƒè¡¡é™æµå¯¹äºæˆ‘ä»¬çš„ç³»ç»Ÿçš„ä»£ä»·ä¸æ”¶ç›Šï¼Œä»è€Œè®¾è®¡å‡ºä¸€ä¸ªæœ€åˆé€‚çš„æ–¹æ¡ˆã€‚

  
  

> Sourceï¼š[https://www.cnblogs.com/enoc/p/traffic-control-design.html](https://www.cnblogs.com/enoc/p/traffic-control-design.html)