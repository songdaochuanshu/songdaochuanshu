---
layout: post
title: "ES å®¢æˆ·ç«¯ RestHighLevelClient Connection reset by peer äº²æµ‹æœ‰æ•ˆ 2022-11-05"
date: "2022-11-05T23:19:55.543Z"
---
ES å®¢æˆ·ç«¯ RestHighLevelClient Connection reset by peer äº²æµ‹æœ‰æ•ˆ 2022-11-05
===================================================================

å¯¼è¯»
==

ã€€ã€€æœ€æ–°å…¬å¸ESé›†ç¾¤è€å‡ºç°è¿æ¥å…³é—­ï¼Œè¿›è€Œå¯¼è‡´æŸ¥è¯¢|å†™å…¥ESæ—¶æŠ¥é”™ï¼ŒæŠ¥é”™æ—¥å¿—æ˜¾ç¤ºå¦‚ä¸‹

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105192909604-1469273614.png)

\[2m2022-10-23 14:13:10.088\[0;39m - \[31mERROR\[0;39m - \[35m\[NONE\]\[NONE\]\[NONE\]\[0\]\[1584065372948234240\]\[0;39m - \[2m\[XNIO-1 task-3\]\[0;39m - \[36mcom.mall.search.service.EsRestService:235\[0;39m \[2m:\[0;39m æ·»åŠ æ–‡æ¡£å¤±è´¥ï¼š{}

java.io.IOException: Connection reset by peer
    at org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:964)
    at org.elasticsearch.client.RestClient.performRequest(RestClient.java:233)
    at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1448)
    at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1418)
    at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1388)
    at org.elasticsearch.client.RestHighLevelClient.index(RestHighLevelClient.java:836)
    at sun.reflect.GeneratedMethodAccessor117.invoke(Unknown Source)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:190)
    at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:138)
    at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:105)
    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:878)
    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:792)
    at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
    at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1040)
    at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:943)
    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)
    at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:909)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:523)
    at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)
    at javax.servlet.http.HttpServlet.service(HttpServlet.java:590)
    at io.undertow.servlet.handlers.ServletHandler.handleRequest(ServletHandler.java:74)
    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:129)
    at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
    at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
    at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
    at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
    at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:108)
    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
    at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
    at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
    at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)
    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)
    at io.undertow.servlet.handlers.FilterHandler.handleRequest(FilterHandler.java:84)
    at io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:62)
    at io.undertow.servlet.handlers.ServletChain$1.handleRequest(ServletChain.java:68)
    at io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:36)
    at io.undertow.servlet.handlers.RedirectDirHandler.handleRequest(RedirectDirHandler.java:68)
    at io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:132)
    at io.undertow.servlet.handlers.security.ServletAuthenticationCallHandler.handleRequest(ServletAuthenticationCallHandler.java:57)
    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
    at io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:46)
    at io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:64)
    at io.undertow.security.handlers.AuthenticationMechanismsHandler.handleRequest(AuthenticationMechanismsHandler.java:60)
    at io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:77)
    at io.undertow.security.handlers.AbstractSecurityContextAssociationHandler.handleRequest(AbstractSecurityContextAssociationHandler.java:43)
    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)
    at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:269)
    at io.undertow.servlet.handlers.ServletInitialHandler.access$100(ServletInitialHandler.java:78)
    at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:133)
    at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:130)
    at io.undertow.servlet.core.ServletRequestContextThreadSetupAction$1.call(ServletRequestContextThreadSetupAction.java:48)
    at io.undertow.servlet.core.ContextClassLoaderSetupAction$1.call(ContextClassLoaderSetupAction.java:43)
    at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:249)
    at io.undertow.servlet.handlers.ServletInitialHandler.access$000(ServletInitialHandler.java:78)
    at io.undertow.servlet.handlers.ServletInitialHandler$1.handleRequest(ServletInitialHandler.java:99)
    at io.undertow.server.Connectors.executeRootHandler(Connectors.java:376)
    at io.undertow.server.HttpServerExchange$1.run(HttpServerExchange.java:830)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)
Caused by: java.io.IOException: Connection reset by peer
    at sun.nio.ch.FileDispatcherImpl.read0(Native Method)
    at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)
    at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)
    at sun.nio.ch.IOUtil.read(IOUtil.java:197)
    at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:379)
    at org.apache.http.impl.nio.conn.LoggingIOSession$LoggingByteChannel.read(LoggingIOSession.java:204)
    at org.apache.http.impl.nio.reactor.SessionInputBufferImpl.fill(SessionInputBufferImpl.java:231)
    at org.apache.http.impl.nio.codecs.AbstractMessageParser.fillBuffer(AbstractMessageParser.java:136)
    at org.apache.http.impl.nio.DefaultNHttpClientConnection.consumeInput(DefaultNHttpClientConnection.java:241)
    at org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:81)
    at org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:39)
    at org.apache.http.impl.nio.reactor.AbstractIODispatch.inputReady(AbstractIODispatch.java:114)
    at org.apache.http.impl.nio.reactor.BaseIOReactor.readable(BaseIOReactor.java:162)
    at org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvent(AbstractIOReactor.java:337)
    at org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvents(AbstractIOReactor.java:315)
    at org.apache.http.impl.nio.reactor.AbstractIOReactor.execute(AbstractIOReactor.java:276)
    at org.apache.http.impl.nio.reactor.BaseIOReactor.execute(BaseIOReactor.java:104)
    at org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor$Worker.run(AbstractMultiworkerIOReactor.java:591)
    ... 1 common frames omitted

ä¼˜åŒ–&è§£å†³
=====

ã€€ã€€å› ä¸ºè¿™ä¸ªé¡¹ç›®æ˜¯åŠ©å†œappï¼ˆæŠ–éŸ³+æ·˜å®ï¼Œæ‚äº¤ç‰ˆappï¼‰ï¼Œappé¦–é¡µä¸‹æ‹‰è·å–æœ€æ–°æ¨èè§†é¢‘ï¼Œéœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹**æå…‰**æ‹‰å–æ¨èè§†é¢‘ï¼Œå­˜å…¥æœ¬åœ°æ•°æ®åº“mysqlåï¼›ä¸€æ¬¡æ‹‰å–20æ¡ï¼Œç„¶åé€šè¿‡çº¿ç¨‹æ± å¼‚æ­¥å†™å…¥ESï¼Œå¤§æ¦‚æ¶æ„å¦‚ä¸‹

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105194823774-2072910716.png)

ã€€ã€€åˆæ­¥åˆ¤å®šï¼Œå¯èƒ½æ˜¯appéšç€ç”¨æˆ·ä½“é‡ä¸Šå»ï¼Œçº¿ç¨‹æ± å¼‚æ­¥é€æ¡å†™å…¥ESï¼Œé€ æˆESå¤§é‡çš„å†™è¯·æ±‚ï¼Œç„¶åå°†æ¶æ„æ”¹ä¸ºå¦‚å›¾

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105195445943-487342267.png)

ã€€ã€€å°±è¿™æ ·ä»¥ä¸ºé—®é¢˜å°±è§£å†³äº†å‘¢ï¼Œç¬¬äºŒå¤©å»æœåŠ¡å™¨é‡Œæ‹‰ä¸‹æ—¥å¿—ï¼Œå‘ç°ä¹‹å‰çš„é—®é¢˜è¿˜æ˜¯å­˜åœ¨ï¼Œå°±ä¸Šç™¾åº¦ï¼Œgithubï¼ŒESå®˜ç½‘ï¼Œå¾ˆå¤šäººé‡åˆ°ç›¸åŒé—®é¢˜ï¼Œå„ç§è§£å†³æ–¹æ¡ˆï¼Œå¯¹æˆ‘ä»¬è¿™å¥—æ¶æ„æ¥è¯´ï¼Œéƒ½ä¸ç®¡ç”¨ã€‚å¤§æ¦‚æ„æ€æ˜¯ESå®¢æˆ·ç«¯å¦‚æœæ²¡æœ‰è®¾ç½®KeepAliveçš„è¯ï¼Œé»˜è®¤ä¸º-1å°±æ˜¯æ°¸ä¸è¿‡æœŸï¼Œç„¶åå°±è®¾ç½®ESå®¢æˆ·ç«¯çš„KeepAliveæ—¶é—´ï¼Œé—®é¢˜è¿˜æ˜¯å¤ç°ï¼Œè¿™è¾¹æœ€ç»ˆåšäº†å¦‚ä¸‹ä¿®æ”¹ï¼Œä»æ­¤ESå®¢æˆ·ç«¯è¿æ¥å…³é—­é—®é¢˜å°±æ²¡æœ‰å¤ç°è¿‡

ã€€ã€€æˆ‘ä»¬æ˜¯é€šè¿‡Nginxåå‘ä»£ç†ï¼Œæ„å»ºä¸€ä¸ªESé›†ç¾¤ï¼Œæ¶æ„å¦‚ä¸‹

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105200315765-623900963.png)

é—®é¢˜ä¿®å¤
----

### æ­¥éª¤ä¸€

ã€€ã€€ä¿®æ”¹å®¢æˆ·ç«¯tcp keepaliveï¼Œç³»ç»Ÿé»˜è®¤ä¸º7200ï¼Œä¿®æ”¹ä¸º300ï¼ˆå•ä½ç§’ï¼Œ5åˆ†é’Ÿï¼‰

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105200910590-926290879.png)

ä¿®æ”¹ä¸º300

![](https://img2022.cnblogs.com/blog/1504448/202211/1504448-20221105201427254-1190045678.gif)

\[root@ybchen-1 ~\]# cat /proc/sys/net/ipv4/tcp\_keepalive\_time 
7200
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# cat /proc/sys/net/ipv4/tcp\_keepalive\_time 
7200
\[root@ybchen-1 ~\]# echo 300 > /proc/sys/net/ipv4/tcp\_keepalive\_time 
\[root@ybchen-1 ~\]# cat /proc/sys/net/ipv4/tcp\_keepalive\_time 
300
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# 
\[root@ybchen-1 ~\]# 

### æ­¥éª¤äºŒ

ã€€ã€€ä¿®æ”¹ESå®¢æˆ·ç«¯çš„KeepAliveæ—¶é—´ï¼Œå¹¶æ·»åŠ çº¿ç¨‹æ± å¤§å°ç­‰å‚æ•°

\=========ESé…ç½®ç±»-å¼€å§‹=============

@Data
@Component
@ConfigurationProperties(prefix \= "elastic.search")
public class EsConfiguration {
    //ä¸»æœº
    private String host;
    //ç«¯å£
    private int port;
    //é›†ç¾¤åç§°
    private String clusterName;
    //è®¿é—®åè®®ï¼Œå¦‚:http
    private String schema;
    //ç”¨æˆ·å
    private String userName;
    //å¯†ç 
    private String password;
}

\=========ESé…ç½®ç±»-ç»“æŸ=============

============ESå®¢æˆ·ç«¯-å¼€å§‹=======================
    @Autowired
    EsConfiguration esConfiguration;

    private static RestHighLevelClient restHighLevelClient;

    public RestHighLevelClient getRestClient() {

        if (null != restHighLevelClient) {
            return restHighLevelClient;
        }
        List<HttpHost> httpHosts = new ArrayList<>();
        //å¡«å……æ•°æ®
        httpHosts.add(new HttpHost(esConfiguration.getHost(), esConfiguration.getPort()));
        //å¡«å……hostèŠ‚ç‚¹
        RestClientBuilder builder = RestClient.builder(httpHosts.toArray(new HttpHost\[0\]));

        if (StringUtils.isNotBlank(esConfiguration.getUserName()) && StringUtils.isNotBlank(esConfiguration.getPassword())) {
            //å¡«å……ç”¨æˆ·åå¯†ç 
            final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
            credentialsProvider.setCredentials(AuthScope.ANY, new UsernamePasswordCredentials(esConfiguration.getUserName(), esConfiguration.getPassword()));
            //å¼‚æ­¥é“¾æ¥å»¶æ—¶é…ç½®
            builder.setRequestConfigCallback(requestConfigBuilder ->
                    requestConfigBuilder
                            .setConnectTimeout(5000) //5ç§’
                            .setSocketTimeout(5000)
                            .setConnectionRequestTimeout(5000)
            );
            //å¼‚æ­¥é“¾æ¥æ•°é…ç½®
            builder.setHttpClientConfigCallback(httpClientBuilder -> {
                //æœ€å¤§è¿æ¥æ•°100ä¸ª
                httpClientBuilder.setMaxConnTotal(100);
                //æœ€å¤§è·¯ç”±è¿æ¥æ•°
                httpClientBuilder.setMaxConnPerRoute(100);
                httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                // è®¾ç½®KeepAliveä¸º5åˆ†é’Ÿçš„æ—¶é—´ï¼Œä¸è®¾ç½®é»˜è®¤ä¸º-1ï¼Œä¹Ÿå°±æ˜¯æŒç»­è¿æ¥ï¼Œç„¶è€Œè¿™ä¼šå—åˆ°å¤–ç•Œçš„å½±å“æ¯”å¦‚Firewallï¼Œä¼šå°†TCPè¿æ¥å•æ–¹é¢æ–­å¼€ï¼Œä»è€Œä¼šå¯¼è‡´Connection reset by peerçš„æŠ¥é”™
                // å‚è€ƒgithubè§£å†³æ–¹æ¡ˆï¼šhttps://github.com/TFdream/Elasticsearch-learning/issues/30
                httpClientBuilder.setKeepAliveStrategy((response, context) -> TimeUnit.MINUTES.toMillis(3))
                        .setDefaultIOReactorConfig(IOReactorConfig.custom().setIoThreadCount(1).setSoKeepAlive(true).build());
                return httpClientBuilder;
            });
        }

        restHighLevelClient \= new RestHighLevelClient(builder);
        return restHighLevelClient;
    }

\==============ESå®¢æˆ·ç«¯-ç»“æŸ================

========== ESå®¢æˆ·ç«¯ä½¿ç”¨ç¤ºä¾‹ ===============
@Data
@ApiModel("æ–°å¢/æ›´æ–°ESé€šç”¨æ•°æ®ç»“æ„")
public class DocSearchVo implements Serializable {

    @ApiModelProperty(value \= "æ–‡æ¡£ID")
    private String docId;

    @ApiModelProperty(value \= "æ–‡æ¡£JSON")
    private String docStrJson;

}


    /\*\*
     \* æ‰¹é‡æ·»åŠ æ–‡æ¡£
     \*
     \* @param indexName
     \* @param docSearchVoList
     \* @return
     \*/
    public boolean batchIndexDoc(String indexName, List<DocSearchVo> docSearchVoList) {
        RestHighLevelClient client \= getRestClient();
        BulkRequest request \= new BulkRequest();
        for (DocSearchVo docSearchVo : docSearchVoList) {
            IndexRequest indexRequest \= new IndexRequest(indexName).id(docSearchVo.getDocId()).source(docSearchVo.getDocStrJson(), XContentType.JSON);
            request.add(indexRequest);
        }
        client.bulkAsync(request, RequestOptions.DEFAULT, new ActionListener<BulkResponse>() {
            @Override
            public void onResponse(BulkResponse bulkItemResponses) {
                log.debug("å¼‚æ­¥æ‰¹é‡æ·»åŠ æ–‡æ¡£æˆåŠŸï¼ŒindexNameï¼š{}ï¼ŒdocSearchVoListï¼š{}", indexName, docSearchVoList);
            }

            @Override
            public void onFailure(Exception e) {
                log.error("å¼‚æ­¥æ‰¹é‡æ·»åŠ æ–‡æ¡£å¤±è´¥ï¼ŒindexNameï¼š{}ï¼ŒdocSearchVoListï¼š{}ï¼Œé”™è¯¯ä¿¡æ¯ï¼š{}", indexName, docSearchVoList, e);
            }
        });
        return true;
    }

ã€€ã€€**æ³¨ï¼šç»†å¿ƒçš„ç«¥é‹å·²ç»å‘ç°ï¼Œåˆ›å»ºESå®¢æˆ·ç«¯çš„æ—¶å€™ï¼Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼(è¿™å—åˆ«çš„åŒäº‹å†™çš„ï¼Œæˆ‘åªæ˜¯è´Ÿè´£ä¿®æ”¹è¿™ä¸ªbugï¼Œç„¶åå°±æ²¡ç®¡è¿™ä¸ªçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå…¶å®æ˜¯æ¥èƒŒé”…çš„ï¼Œå‘œå‘œå‘œ~~~~~~)**

### æ­¥éª¤ä¸‰

ã€€ã€€æ·»åŠ ESå®¢æˆ·ç«¯å¿ƒè·³æ£€æŸ¥ï¼Œ30ç§’ä¸€æ¬¡

@Component
@Slf4j
public class EsSchedule {
    @Autowired
    EsRestService esRestService;

    /\*\*
     \* 30ç§’ä¸€æ¬¡æ£€æŸ¥esçŠ¶æ€
     \*/
    @Scheduled(fixedRate \= 30 \* 1000)
    public void heartbeatToES() {
        try {
            RequestOptions requestOptions \= RequestOptions.DEFAULT.toBuilder().build();
            boolean result = esRestService.getRestClient().ping(requestOptions);
            log.info("æ£€æŸ¥ESçŠ¶æ€:{}", result);
        } catch (Exception e) {
            log.error("æ£€æŸ¥ESçŠ¶æ€å‘ç”Ÿå¼‚å¸¸ï¼š{}", e);
        }
    }
}

æå®š~

**ä½œè€…ï¼š[é™ˆå½¦æ–Œ](https://www.cnblogs.com/chenyanbin/)**

**å‡ºå¤„ï¼š[https://www.cnblogs.com/chenyanbin/](https://www.cnblogs.com/chenyanbin/)**

**å…³æ³¨ï¼š** [**ç‚¹æˆ‘å“Ÿ(ï¼¾ï¼µï¼¾)ãƒ~ï¼¹ï¼¯**](javascript:void(0))