---
layout: post
title: "æš‘å‡æ‰“å·¥ 2 ä¸ª æœˆï¼Œè®©æˆ‘æ˜ç™½äº† Keepalived é«˜å¯ç”¨çš„ä¸‰ç§è·¯ç”±æ–¹æ¡ˆ"
date: "2022-07-20T04:42:24.805Z"
---
æš‘å‡æ‰“å·¥ 2 ä¸ª æœˆï¼Œè®©æˆ‘æ˜ç™½äº† Keepalived é«˜å¯ç”¨çš„ä¸‰ç§è·¯ç”±æ–¹æ¡ˆ
======================================

æš‘å‡æ‰“å·¥ 2 ä¸ª æœˆï¼Œè®©æˆ‘æ˜ç™½äº† Keepalived é«˜å¯ç”¨çš„ä¸‰ç§è·¯ç”±æ–¹æ¡ˆ
======================================

è¿™æ˜¯æ‚Ÿç©ºçš„ç¬¬ 158 ç¯‡åŸåˆ›æ–‡ç« 

åŸæ–‡é“¾æ¥ï¼š[é¦–å‘æ‚Ÿç©ºèŠæ¶æ„](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451964001&idx=1&sn=9b2562228697b4aa9c4188b10ce4cb8a&chksm=8d1ff9feba6870e8014c54d70733c14168be299aa5b61677fb5da7483d62a4bec6c66c6e697c&token=883180970&lang=zh_CN#rd)

å®˜ç½‘ï¼šwww.passjava.cn

ä½ å¥½ï¼Œæˆ‘æ˜¯æ‚Ÿç©ºã€‚

**å‰è¨€**
------

ä¸Šç¯‡æˆ‘ä»¬è®²äº†[Keepalived åº•å±‚åŸç†ä¸Šç¯‡](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963624&idx=1&sn=298b4917b0782f4c621589ad78f10ac2&chksm=8d1c0777ba6b8e61a8ed45286057c1a2a530f466bd3dfd293a1eb5d1913f819a5713af7c88cb&token=1036865606&lang=zh_CN&scene=21#wechat_redirect)ï¼Œä¸­ç¯‡è¿˜æ˜¯å¾—ç»§ç»­å‘€ï¼Œä½†æ˜¯å‘ç°ä¸­ç¯‡å†…å®¹è¿˜æ˜¯å¾ˆå¤šï¼Œä¸€ç¯‡è®²ä¸å®Œï¼Œæ‰€ä»¥å…ˆè®² Keepalived çš„è·¯ç”±åŸç†ã€‚

åœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°è·¯ç”±åŸç†å…¶å®æŒºæ¯ç‡¥çš„ï¼Œæˆ‘æƒ³æŠŠè¿™ä¸ªä¸»é¢˜ç”¨é€šä¿—æ˜“æ‡‚ã€ä¸”æœ‰è¶£çš„æ–¹å¼è®²è§£å‡ºæ¥ï¼Œä½†æ˜¯ä¸€ç›´æ‰¾ä¸åˆ°åˆé€‚çš„åˆ‡å…¥ç‚¹ï¼Œä¸€æ¬¡å¶ç„¶çš„å¯¹è¯è®©æˆ‘çš„çµæ„Ÿè¿¸å‘ã€‚

è¯è¯´ä¹‹å‰å¤§å­¦æ”¾æš‘å‡çš„æ—¶å€™ï¼Œæˆ‘åˆ°ä¸€ä¸ªé¤å…æ‰“å·¥ä¸¤ä¸ªæœˆï¼ŒTitle æ˜¯`åˆçº§ä¼ èœå‘˜`ã€‚æ­£æ˜¯è¿™æ¬¡æ‰“å·¥ç»éªŒï¼Œä¸ºæˆ‘å¸¦æ¥äº†ä¸€æ³¢æ½œè—å·²ä¹…çš„ç´ æï¼Œè¯·å¬å¬æˆ‘çš„æ•…äº‹å§~

æœ¬æ–‡ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š

![img](https://img-blog.csdnimg.cn/img_convert/0b589b81fcafb780c76cd45ec206b7e6.png)

**ä¸€ã€é¤å…è§’è‰²**
----------

åœ¨é¤å…ä¸»è¦æœ‰è¿™å‡ ç§è§’è‰²ï¼š

*   **æœåŠ¡å‘˜**ï¼šè´Ÿè´£è®°å½•å®¢æˆ·å·²ç‚¹å“ªäº›èœã€ä¸Šèœæ—¶é—´ã€ä¸Šèœã€åˆ’æ‰èœã€‚**å¯ä»¥å°†å¤šä¸ªæœåŠ¡å‘˜éƒ½å½“åšå®¢æˆ·ç«¯**ï¼Œç›¸å¯¹äºä¼ èœå‘˜æ¥è¯´ã€‚
*   **ä¼ èœå‘˜**ï¼šè´Ÿè´£é€šçŸ¥å¨æˆ¿èµ°èœã€åˆ’èœã€ä¼ èœã€‚**å¯ä»¥å°†ä¼ èœå‘˜å½“ä½œ Keepalived ç»„ä»¶**ã€‚
*   **å¨å¸ˆ**ï¼šçƒ¹é¥ªã€è£…ç›˜ã€‚**å¯ä»¥å°†å¨å¸ˆå½“ä½œåå°çœŸå®æœåŠ¡å™¨**ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ä¼ èœå‘˜è¿™ä¸ªè§’è‰²ï¼Ÿæœ‰äº†ä¼ èœå‘˜è¿™ä¸ªè§’è‰²åï¼Œå‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

*   æœåŠ¡å‘˜éœ€è¦æœåŠ¡é¡¾å®¢ï¼Œä¸éœ€è¦ç¦»å¼€åŒ…é—´å»å¨æˆ¿æ‹¿èœã€‚ï¼ˆå•ä¸€èŒè´£ï¼‰
*   æœåŠ¡å‘˜ä¸éœ€è¦å®šæœŸåˆ°å¨æˆ¿è¯¢é—®èœæ˜¯å¦å¥½äº†ã€‚ï¼ˆè§£è€¦ï¼‰

æµç¨‹å›¾å¦‚ä¸‹ï¼š

![img](https://img-blog.csdnimg.cn/img_convert/3f652c4c27a44c334e87800de1bde2cd.png)

â‘  å®¢æˆ·ç‚¹èœä¸‹å•ã€‚

â‘¡ æœåŠ¡å‘˜è®°å½•èœåã€ä¸Šèœæ—¶é—´ã€‚è¿™é‡Œçš„ä¸Šèœæ—¶é—´æ˜¯æŒ‡å®¢æˆ·è¦æ±‚çš„ä¸Šèœæ—¶é—´ï¼Œå› ä¸ºæœ‰äº›å®¢æˆ·å¯èƒ½æƒ³ç­‰æœ‹å‹ä¸€èµ·æ¥äº†å†åƒã€‚

â‘¢ æœåŠ¡å‘˜å°†ä¸€ä»½è®¢å•äº¤ç»™ä¼ èœå‘˜ï¼Œå¦å¤–ä¸€ä»½è®¢å•ç•™åœ¨åŒ…é—´ã€‚

â‘£ ä¼ èœå‘˜å¤§å£°é€šçŸ¥å¤šä½å¨å¸ˆæœ‰å“ªäº›èœè¦åšï¼Œä»€ä¹ˆæ—¶å€™å¼€å§‹ä¸Šèœã€‚

â‘¤ å¨å¸ˆå‡†å¤‡é£Ÿæå’Œçƒ¹é¥ªã€‚å¦‚æœç¼ºå°‘é£Ÿæï¼Œå¨å¸ˆè¿˜ä¼šå‘Šè¯‰ä¼ èœå‘˜ï¼Œç”±ä¼ èœå‘˜è½¬å‘ŠæœåŠ¡å‘˜è¯´è¿™é“èœä¸èƒ½åšã€‚

â‘¥ å¨å¸ˆåšå¥½åå°†èœè£…åœ¨ç›˜å­é‡Œï¼Œç„¶åé€’ç»™ä¼ èœå‘˜ã€‚

â‘¦ ä¼ èœå‘˜å°†è®¢å•ä¸Šå¯¹åº”çš„èœåˆ’æ‰ï¼Œè¡¨ç¤ºå·²ç»åšäº†ã€‚

â‘§ ä¼ èœå‘˜å°†èœç«¯ç»™æœåŠ¡å‘˜ã€‚

â‘¨ æœåŠ¡å‘˜å°†èœä»è®¢å•ä¸Šåˆ’æ‰ã€‚

â‘© æœåŠ¡å‘˜å°†èœç«¯ä¸Šé¤æ¡Œã€‚

è¿™ä¸ªæµç¨‹ç®€å•æ¥è¯´å°±æ˜¯**å®¢æˆ·ä¸‹å•->æœåŠ¡å‘˜ä¼ å•->ä¼ èœå‘˜é€šçŸ¥->å¨å¸ˆçƒ¹é¥ª->ä¼ èœå‘˜ä¼ èœ->æœåŠ¡å‘˜ä¸Šèœã€‚**

ä¸Šé¢çš„æµç¨‹ä¸æ­£æ˜¯æœåŠ¡å‘˜è¯·æ±‚æ•°æ®ï¼Œå°†è¯·æ±‚éƒ½å‘ç»™äº†ä¼ èœå‘˜ï¼Œä¼ èœå‘˜å°†è¯·æ±‚è½¬å‘ç»™äº†å¨å¸ˆï¼Œå¨å¸ˆå¤„ç†å®Œåè¿”å›ç»“æœã€‚å¦™å•Šï¼ï¼

**äºŒã€åˆæ¢ Keepalived çš„è·¯ç”±æ–¹æ¡ˆ**
-------------------------

### 2.1 ä¸ºä»€ä¹ˆéœ€è¦è·¯ç”±æ–¹æ¡ˆ

ä¸Šç¯‡æˆ‘ä»¬è®²åˆ° Keepalived çš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•ï¼Œé€šè¿‡è¿™ä¸ªç®—æ³•é€‰å‡ºæŸå°çœŸå®æœåŠ¡æ¥å¤„ç†æœ¬æ¬¡å®¢æˆ·ç«¯è¯·æ±‚ã€‚

> å°±å¥½æ¯”ä¼ èœå‘˜è¦å°†è¦åšçš„èœï¼Œå‘Šè¯‰å…¶ä¸­ä¸€ä¸ªå¨å¸ˆï¼ˆä¸€èˆ¬æ˜¯å‘Šè¯‰å¤§å¨ï¼‰ã€‚
> 
> è€Œå¦‚ä½•å‘Šè¯‰å¨å¸ˆå‘¢ï¼Ÿæ˜¯ç”¨`å–‡å­`å–Šï¼Œè¿˜æ˜¯`ä¼ å‘¼æœº`ï¼Œè¿˜æ˜¯èµ°åˆ°ä»–æ—è¾¹å‘Šè¯‰ä»–ï¼Ÿ

![img](https://img-blog.csdnimg.cn/img_convert/f947a56138fd7b5dc17143ddeb89a4bc.png)æœåŠ¡å‘˜ä¸å¨å¸ˆå¯¹è¯çš„æ–¹å¼

å¯¹äº Keepalived æ¥è¯´ï¼Œé€‰æ‹©äº†ä¸€ä¸ªçœŸå®æœåŠ¡å™¨åï¼Œ**åç»­è¿˜æœ‰ä¸¤ä¸ªæµç¨‹éœ€è¦æ¢³ç†ä¸‹**ï¼š

*   Keepalived å¦‚ä½•å°†è¯·æ±‚è½¬å‘ç»™è¿™ä¸ªæœåŠ¡å‘¢ï¼Ÿ
*   æœåŠ¡å¤„ç†å®Œè¿™ä¸ªè¯·æ±‚åï¼Œå¦‚ä½•å°†å¤„ç†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Ÿ

ä¸Šé¢ä¸¤ä¸ªæµç¨‹å°±æ˜¯ Keepalived çš„è·¯ç”±æ–¹æ¡ˆè¦åšçš„äº‹ã€‚

Keepalived æœ‰ä¸‰ç§è·¯ç”±æ–¹æ¡ˆï¼šNATã€TUNã€DRã€‚

### 2.2 é…ç½®åœ¨å“ª

å…·ä½“çš„é…ç½®å“ªç§è·¯ç”±æ–¹æ¡ˆåœ¨ keepalived.conf é…ç½®æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ª lb\_kind é…ç½®ï¼Œå¯ä»¥é…ç½®æˆ NATã€DRã€TUN ä¸‰ç§ã€‚ç›®å‰é…ç½®çš„æ˜¯ DR æ¨¡å¼ã€‚

è¿˜æœ‰ä¸€ä¸ªé…ç½® lb\_algoï¼Œè¿™ä¸ªæ˜¯é…ç½®è°ƒåº¦ç®—æ³•çš„ï¼Œæ¯”å¦‚è¿™é‡Œé…ç½®çš„ wrr åŠ æƒè½®è¯¢è°ƒåº¦ç®—æ³•ã€‚

![img](https://img-blog.csdnimg.cn/img_convert/1b1e841e3f24e5f07e123fb431eabd85.png)

### 2.3 LVS çš„ç»“æ„

ä¸Šç¯‡æˆ‘ä»¬è¯´åˆ° Keepalived æ˜¯åˆ©ç”¨äº† LVS æ¨¡å—çš„åŠŸèƒ½æ¥å®ç°è´Ÿè½½å‡è¡¡çš„ã€‚é‚£ä¹ˆ LVS çš„ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ

åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼šå‰ç«¯çš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆLoad Balanceï¼Œç®€ç§° LBï¼‰ï¼Œåç«¯çš„å¤šå°çœŸå®æœåŠ¡å™¨ï¼ˆReal Server, ç®€ç§° RSï¼‰ç»„æˆã€‚LB è´Ÿè´£æµé‡è½¬å‘ï¼ŒRS è´Ÿè´£å¤„ç†è¯·æ±‚ï¼Œç„¶åå°†è¯·æ±‚è¿”å›ã€‚

**ä¸‰ã€æ·±å…¥ç†è§£ Keepalived çš„è·¯ç”±æ–¹æ¡ˆ**
---------------------------

### 3.1 NAT è·¯ç”±æ–¹æ¡ˆ

NAT çš„å…¨ç§°æ˜¯ Network Address Translationï¼Œç½‘ç»œåœ°å€è½¬æ¢ã€‚å®ƒæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼š

*   ä½¿ä¼ä¸šå†…éƒ¨çš„ç§æœ‰ IP å¯ä»¥è®¿é—®å¤–ç½‘ï¼Œ
*   ä½¿å¤–éƒ¨ç”¨æˆ·å¯ä»¥è®¿é—®ä½äºå…¬å¸å†…éƒ¨çš„ç§æœ‰ IP ä¸»æœºã€‚

> å¯¹äº Keepalived æ¥è¯´ï¼Œè¿™ç§æ¨¡å¼å°±å¥½æ¯”é¤å…çš„æ ‡å‡†ä¸‹å•ä¸Šèœæ¨¡å¼ï¼šå¤šä¸ªæœåŠ¡å‘˜å°†è®¢å•æ•°æ®è½¬ç»™ä¼ èœå‘˜ï¼Œä¼ èœå‘˜é€šçŸ¥å¨å¸ˆè¿›è¡Œçƒ¹é¥ªï¼Œå¨å¸ˆæŠŠèœåšå¥½åè½¬ç»™ä¼ èœå‘˜ï¼Œä¼ èœå‘˜è´Ÿè´£æŠŠèœä¼ é€’ç»™æœåŠ¡å‘˜ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒLVS è´Ÿè½½è°ƒåº¦å™¨æœ‰ä¸¤å—ç½‘å¡ï¼Œé…ç½®äº†ä¸åŒçš„ IP åœ°å€ï¼Œç½‘å¡ eth0 è®¾ç½®ä¸ºå…¬ç½‘ VIP ä¸å¤–éƒ¨ç½‘ç»œè¿é€šï¼Œç½‘å¡ eth1 è®¾ç½®ä¸ºç§æœ‰ VIP ä¸å†…éƒ¨ç½‘ç»œé€šè¿‡äº¤æ¢è®¾å¤‡ç›¸äº’è¿æ¥ï¼Œ

ç¤ºä¾‹å¦‚ä¸‹ï¼š

    eth0 ç½‘å¡ -> å…¬ç½‘ VIP -> å¤–éƒ¨ç½‘ç»œ
    eth1 ç½‘å¡ -> ç§æœ‰ VIP -> äº¤æ¢è®¾å¤‡ > å†…ç½‘ç½‘ç»œ
    

åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![img](https://img-blog.csdnimg.cn/img_convert/af047e1f987ce2b0f4185196a4c01721.png)

â‘  æ¯”å¦‚ç°åœ¨ eth0 ç½‘å¡é…ç½®äº†ä¸€ä¸ªå…¬æœ‰ VIP å¦‚ 10.1.2.88ï¼Œå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚éƒ½æ˜¯åˆ°è¿™ä¸ª Public VIPï¼ˆç›®æ ‡åœ°å€ï¼‰ã€‚

â‘¡ ä¸» LVS Router è´Ÿè´£æ¥æ”¶è¯·æ±‚ï¼Œå°†è¯·æ±‚çš„ç›®çš„åœ°å€ï¼ˆPublic VIPï¼‰æ›¿æ¢æˆ NAT VIPï¼ˆ192.168.56.88ï¼‰ã€‚

â‘¢ è¿™ä¸ª NAT VIP å’Œåç«¯æœåŠ¡å™¨åŒå±ä¸€ä¸ªå±€åŸŸç½‘ï¼Œå¯ä»¥ç›¸äº’è®¿é—®ï¼Œè¯·æ±‚ç»è¿‡è´Ÿè½½å‡è¡¡è°ƒåº¦é€‰æ‹©ä¸€ä¸ªçœŸå®æœåŠ¡å™¨ã€‚

â‘£ LVS ä¿®æ”¹æ•°æ®åŒ…ä¸­çš„ç›®æ ‡åœ°å€å’Œç›®æ ‡ç«¯å£ä¸ºçœŸå®æœåŠ¡å™¨çš„ã€‚

â‘¤ çœŸå®æœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚åï¼Œå°†åº”ç­”æ•°æ®è¿”å›ç»™ LVS Routerã€‚

â‘¥ LVS Router å°†åº”ç­”æ•°æ®çš„æº IP åœ°å€ NAT VIP å’Œç«¯å£è½¬æ¢æˆ Public VIP å’Œ LVS çš„ç«¯å£ï¼Œç„¶åè½¬å‘ç»™å¤–éƒ¨ç½‘ç»œçš„å®¢æˆ·ç«¯ã€‚

å¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå®ƒåªå’Œ Public VIP æ‰“äº¤é“ï¼Œå¹¶ä¸çŸ¥é“ NAT VIPï¼Œæ›´ä¸çŸ¥é“çœŸå®æœåŠ¡å™¨çš„ IP åœ°å€ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿç§°ä¸º IP ä¼ªè£…ã€‚

å¯¹äºæœåŠ¡å‘˜ğŸ’ğŸ»æ¥è¯´ï¼Œå¥¹åªå’Œä¼ èœå‘˜æ‰“äº¤é“ï¼Œå¹¶ä¸çŸ¥é“å¨å¸ˆğŸ‘©ğŸ»â€ğŸ³ ã€‚

### 1.2 LVS-TUN è·¯ç”±æ–¹æ¡ˆ

#### 1.2.1 NAT æ–¹æ¡ˆçš„ç“¶é¢ˆ

å¦‚æœé¤å…çš„ç”Ÿæ„éå¸¸ç«çˆ†ï¼Œä¸€ä¸ªä¼ èœå‘˜ä¼šéå¸¸å¿™ï¼Œæœ‰å¯èƒ½å¨å¸ˆå·²ç»æŠŠèœåšå¥½äº†ï¼Œä½†æ˜¯ä¼ èœå‘˜æ²¡æœ‰æ—¶é—´ä¼ ç»™æœåŠ¡å‘˜ï¼Œé‚£ä¹ˆé¤å…çš„ç“¶é¢ˆå°±æ˜¯ä¼ èœå‘˜äº†ã€‚

å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸€ä¸ªä¼ èœå‘˜å¯¹åº”ä¸‰ä¸ªå¨å¸ˆï¼Œè€Œä¸”åšçš„èœå¾ˆå¤šï¼Œéƒ½éœ€è¦ä¼ èœå‘˜å°†èœç«¯ç»™åŒ…é—´å¤–çš„æœåŠ¡å‘˜ã€‚

![img](https://img-blog.csdnimg.cn/img_convert/5da7f436ef37186634e52d7b29029c40.png)

NAT çš„è·¯ç”±æ–¹æ¡ˆå­˜åœ¨ç“¶é¢ˆï¼Œç”±äºæ‰€æœ‰çš„æ•°æ®è¯·æ±‚åŠå“åº”çš„æ•°æ®åŒ…éƒ½éœ€è¦ç»è¿‡ LVS è°ƒåº¦å™¨è½¬å‘ï¼Œå¦‚æœåç«¯æœåŠ¡æ•°é‡å¾ˆå¤šï¼Œå®¢æˆ·ç«¯è®¿é—®æµé‡ä¹Ÿå¾ˆå¤§çš„è¯ï¼Œé‚£ä¹ˆè°ƒåº¦å™¨ä¼šå¿™äºè°ƒåº¦è½¬å‘å’Œåœ°å€æ›¿æ¢ç­‰æ“ä½œã€‚

ä¸ºäº†è§£å†³ NAT çš„æ€§èƒ½é—®é¢˜ï¼ŒTUN è·¯ç”±æ–¹æ¡ˆæ˜¯ä¸ªæ¯”è¾ƒå¥½çš„é€‰æ‹©ã€‚TUN æ–¹æ¡ˆä¸­ï¼ŒçœŸå®æœåŠ¡å™¨å¤„ç†å®Œç»“æœåï¼Œç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä½†æ˜¯è¿™å°±è¦æ±‚çœŸå®æœåŠ¡å™¨èƒ½å¤Ÿä¸å¤–éƒ¨ç½‘ç»œè¿æ¥ã€‚

> ä¹Ÿå°±æ˜¯è¯´å¨å¸ˆåšå¥½èœåï¼Œå¨å¸ˆç›´æ¥æŠŠèœé€’ç»™æœåŠ¡å‘˜ï¼Œä¸éœ€è¦ç»è¿‡ä¼ èœå‘˜ã€‚å¨å¸ˆæ˜¯å¯¹å¤–å¯è§çš„ã€‚

![img](https://img-blog.csdnimg.cn/img_convert/b153958ab33aed60281d4ebf5deba9be.png)

#### 1.2.2 TUN è¯¦è§£

TUN å…¶å®æ˜¯ tunnelingï¼ˆéš§é“ï¼‰çš„ç¼©å†™ï¼Œè€Œ TUN è·¯ç”±æ–¹æ¡ˆå°±æ˜¯åŸºäº IP éš§é“çš„ä¸€ç§æŠ€æœ¯ã€‚

æˆ‘ä»¬ç†ŸçŸ¥çš„ VPN æŠ€æœ¯å°±æ˜¯ IP éš§é“æŠ€æœ¯ã€‚

IP éš§é“å…¶å®æ˜¯ä¸€ç§å°è£…æŠ€æœ¯ï¼Œå°†ä¸€ä¸ª IP æŠ¥æ–‡å°è£…åœ¨å¦ä¸€ä¸ª IP æŠ¥æ–‡ä¸­ã€‚åˆ†ä¸ºå¦‚ä¸‹ä¸¤æ­¥ï¼š

*   â‘  å…ˆå°†åŸå§‹æ•°æ®åŒ…è¿›è¡Œå°è£…ã€‚
*   â‘¡ ç„¶åæ·»åŠ æ–°çš„æºåœ°å€+ç«¯å£ã€æ–°çš„ç›®æ ‡åœ°å€+ç«¯å£ã€‚

å®ƒå¯ä»¥å°†åŸå§‹æ•°æ®åŒ…å°è£…å¹¶æ·»åŠ æ–°çš„åŒ…å¤´ï¼ˆå†…å®¹åŒ…æ‹¬æ–°çš„æºåœ°å€åŠç«¯å£ã€ç›®æ ‡åœ°å€åŠç«¯å£ï¼‰ï¼Œä»è€Œå®ç°å°†ä¸€ä¸ªç›®æ ‡ä¸ºè°ƒåº¦å™¨VIPåœ°å€çš„æ•°æ®åŒ…å°è£…ï¼Œé€šè¿‡éš§é“è½¬å‘ç»™åç«¯çš„çœŸå®æœåŠ¡å™¨ï¼ˆReal Serverï¼‰ï¼Œé€šè¿‡å°†å®¢æˆ·ç«¯å‘å¾€è°ƒåº¦å™¨çš„åŸå§‹æ•°æ®åŒ…å°è£…ï¼Œå¹¶åœ¨å…¶åŸºç¡€ä¸Šæ·»åŠ æ–°çš„æ•°æ®åŒ…å¤´ï¼ˆä¿®æ”¹ç›®æ ‡åœ°å€ä¸ºè°ƒåº¦å™¨é€‰æ‹©å‡ºæ¥çš„çœŸå®æœåŠ¡å™¨çš„IPåœ°å€åŠå¯¹åº”ç«¯å£ï¼‰ï¼ŒLVSï¼ˆTUNï¼‰æ¨¡å¼è¦æ±‚çœŸå®æœåŠ¡å™¨å¯ä»¥ç›´æ¥ä¸å¤–éƒ¨ç½‘ç»œè¿æ¥ï¼ŒçœŸå®æœåŠ¡å™¨åœ¨æ”¶åˆ°è¯·æ±‚æ•°æ®åŒ…åç›´æ¥ç»™å®¢æˆ·ç«¯ä¸»æœºå“åº”æ•°æ®ã€‚

åŸç†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š

![img](https://img-blog.csdnimg.cn/img_convert/848e1141d361095e303364b4a25131ae.png)

TUN æ¨¡å¼çš„ç¼ºç‚¹ï¼š

éš§é“æ¨¡å¼çš„RSèŠ‚ç‚¹éœ€è¦åˆæ³• IPï¼Œè¿™ç§æ–¹å¼éœ€è¦æ‰€æœ‰çš„æœåŠ¡å™¨æ”¯æŒ IP Tunneling åè®®ã€‚

### 1.3 LVS-DR æ¨¡å¼

é‚£ä¹ˆ LVS çš„ TUN è·¯ç”±æ¨¡å¼æœ‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

å› ä¸º TUN çš„æ–¹å¼å¿…é¡»åœ¨ LVS è°ƒåº¦å™¨å’ŒçœŸå®çš„æœåŠ¡å™¨ä¹‹é—´æœ‰ä¸€ä¸ªéš§é“è¿æ¥ï¼Œè¿™ä¸ªåˆ›å»ºéš§é“çš„è¿‡ç¨‹ä¼šå¯¹æœåŠ¡å™¨å¢åŠ è´Ÿæ‹…ã€‚

> åœ¨é¤å…è¿™ç§åœºæ™¯ä¸­ï¼ŒTUN æ¨¡å¼ä¸­ï¼Œå¨å¸ˆæ˜¯å¯¹å¤–å¯è§çš„ï¼Œèœå¥½äº†åç›´æ¥å’ŒæœåŠ¡å‘˜å¯¹æ¥ï¼›è€Œ DR æ¨¡å¼ä¸­ï¼Œå¨å¸ˆä¸å¯è§ï¼Œç»Ÿä¸€è¢«çœ‹æˆæ˜¯ä¼ èœå‘˜ã€‚

DR æ¨¡å¼å’Œ TUN æ¨¡å¼çš„ç›¸åŒä¹‹å¤„ï¼š

*   æ¨¡å¼ä¸­ï¼Œç”¨æˆ·çš„è¯·æ±‚è¢«è°ƒåº¦å™¨è´Ÿè½½å‡è¡¡åˆ°çœŸå®æœåŠ¡å™¨ä¸Šï¼Œç„¶åçœŸå®æœåŠ¡å™¨æŠŠå“åº”ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚
*   å®¢æˆ·ç«¯çš„è¯·æ±‚æ•°æ®åŒ…ä¸­ç›®æ ‡ IP ä¸º LVS çš„ VIPï¼Œæº IP ä¸ºå®¢æˆ·ç«¯ IPã€‚

DR æ¨¡å¼å’Œ TUN æ¨¡å¼ä¸åŒä¹‹å¤„ï¼š

*   DR æ¨¡å¼è¦æ±‚è°ƒåº¦å™¨ä¸åç«¯æœåŠ¡å™¨å¿…é¡»åœ¨ä¸€ä¸ªå±€åŸŸç½‘å†…ã€‚
*   DR æ¨¡å¼ä¸éœ€è¦åˆ›å»º IP éš§é“ã€‚
*   DR æ¨¡å¼ä¸­ï¼ŒVIP éœ€è¦åœ¨ LVS è°ƒåº¦å™¨ä¸åç«¯æ‰€æœ‰çš„æœåŠ¡å™¨é—´å…±äº«ã€‚
*   DR æ¨¡å¼ä¸­ï¼ŒçœŸå®æœåŠ¡å™¨å¤„ç†å®Œç»“æœåï¼Œè¿”å›æ•°æ®åŒ…æ—¶ï¼Œè®¾ç½®æº IP ä¸º VIP åœ°å€ï¼Œç›®æ ‡ IP ä¸ºå®¢æˆ·ç«¯ IPã€‚
*   DR æ¨¡å¼ä¸­ï¼ŒLVS è°ƒåº¦å™¨å’ŒçœŸå®æœåŠ¡å™¨åœ¨åŒä¸€ç‰©ç†ç½‘æ®µä¸Šã€‚åŒä¸€ç½‘æ®µæœºå™¨æ•°é‡æœ‰é™ï¼Œé™åˆ¶äº†å…¶åº”ç”¨èŒƒå›´ã€‚

![img](https://img-blog.csdnimg.cn/img_convert/3c364b59bd00642f924ee79ca6c033df.png)

#### æ›´ç»†èŠ‚çš„å†…å®¹

è´Ÿè½½å‡è¡¡å™¨å’ŒRSéƒ½ä½¿ç”¨åŒä¸€ä¸ªIPå¯¹å¤–æœåŠ¡ä½†åªæœ‰ DRï¼ˆDirector Serverï¼Œå¯ä»¥ç†è§£ä¸º LVS çš„æ ¸å¿ƒï¼‰ å¯¹ ARP è¯·æ±‚è¿›è¡Œå“åº”ï¼Œæ‰€ä»¥ RS ï¼ˆReal Serverï¼ŒçœŸå®æœåŠ¡å™¨ï¼‰å¯¹æœ¬èº«è¿™ä¸ª IP çš„ ARP è¯·æ±‚ä¿æŒé™é»˜ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œç½‘å…³ä¼šæŠŠå¯¹è¿™ä¸ªæœåŠ¡IPçš„è¯·æ±‚å…¨éƒ¨å®šå‘ç»™ DRã€‚è€Œ DR æ”¶åˆ°æ•°æ®åŒ…åæ ¹æ®è°ƒåº¦ç®—æ³•,æ‰¾å‡ºå¯¹åº”çš„ RSï¼ŒæŠŠç›®çš„ MAC åœ°å€æ”¹ä¸º RS çš„ MACï¼ˆå› ä¸º IP ä¸€è‡´ï¼‰å¹¶å°†è¯·æ±‚åˆ†å‘ç»™è¿™å° RS è¿™æ—¶ RS æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…ï¼Œå¤„ç†åç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç”±äºè´Ÿè½½å‡è¡¡å™¨è¦å¯¹äºŒå±‚åŒ…å¤´è¿›è¡Œæ”¹æ¢,æ‰€ä»¥è´Ÿè½½å‡è¡¡å™¨å’ŒRSä¹‹é—´å¿…é¡»åœ¨ä¸€ä¸ªå¹¿æ’­åŸŸï¼Œä¹Ÿå¯ä»¥ç®€å•çš„ç†è§£ä¸ºåœ¨åŒä¸€å°äº¤æ¢æœºä¸Šã€‚

**å››ã€ä¸‰ç§æ¨¡å¼å¯¹æ¯”**
------------

![img](https://img-blog.csdnimg.cn/img_convert/c00dc0e3e10e29a55b2434616aea15cb.png)

æ¨è DR æ¨¡å¼ã€‚

**å½©è›‹ä¸€**
-------

æœ‰ä½è¯»è€…æœ‹å‹å¯¹ä¸Šç¯‡æå‡ºä¸€ä¸ªç–‘é—®ï¼š[Keepalived é«˜å¯ç”¨ä¸Šç¯‡](https://mp.weixin.qq.com/s?__biz=MzAwMjI0ODk0NA==&mid=2451963624&idx=1&sn=298b4917b0782f4c621589ad78f10ac2&chksm=8d1c0777ba6b8e61a8ed45286057c1a2a530f466bd3dfd293a1eb5d1913f819a5713af7c88cb&token=1036865606&lang=zh_CN&scene=21#wechat_redirect)

> ä¸»å‘å¤‡æœºå‘é€çš„åˆ°åº•æ˜¯ VRRP è¿˜æ˜¯ ARP å¹¿æ’­æŠ¥æ–‡ï¼Ÿ

æ›´æ­£å’Œè§£ç­”ä¸Šç¯‡çš„å†…å®¹ï¼š

ï¼ˆ1ï¼‰ä¸»å‘å¤‡æœºå‘é€çš„ VRRP åè®®çš„å¹¿æ’­æŠ¥æ–‡ï¼Œä¼ é€’äº†ä¼˜å…ˆçº§å­—æ®µã€‚ä»æºç è¿™é‡Œå¯ä»¥çœ‹å‡ºã€‚

1.å‘é€ VRRP å¹¿æ’­çš„æ–¹æ³•ï¼Œä¼ å…¥äº†ä¸€ä¸ª vrrp å®ä½“å’Œ prio ä¼˜å…ˆçº§ã€‚

    vrrp.c
    vrrp_send_adv(vrrp_t * vrrp, uint8_t prio)
    

2.è¿™ä¸ªæ–¹æ³• `vrrp_send_adv` æ˜¯åœ¨ä¸‹é¢è¿™ä¸ªåœ°æ–¹è°ƒç”¨çš„ï¼Œprio æ˜¯ vrrp çš„å±æ€§å­—æ®µ effective\_priority ä¼ è¿›å»çš„ã€‚

![img](https://img-blog.csdnimg.cn/img_convert/1992b3b21a6279372fa3b2eab21762f4.png)

ï¼ˆ2ï¼‰ä¸»å‘å±€åŸŸç½‘å†…å¹¿æ’­ ARP è¯·æ±‚åˆ†ç»„ï¼Œå‘Šè¯‰å±€åŸŸç½‘è‡ªå·±çš„ IP åœ°å€å’Œ MAC åœ°å€ã€‚å®¢æˆ·ç«¯å°±çŸ¥é“äº†ä¸»çš„ IP åœ°å€å’Œ MAC åœ°å€ã€‚

ï¼ˆ3ï¼‰å‡å¦‚å‘ç”Ÿäº†ä¸»å¤‡åˆ‡æ¢ï¼Œè™½ç„¶ IP æ²¡å˜ï¼Œè¿˜æ˜¯ VIPï¼Œä½†æ˜¯ MAC åœ°å€å·²ç»å˜äº†ã€‚å®¢æˆ·ç«¯å‘é€ IP æ•°æ®æŠ¥æ—¶ï¼Œä»è‡ªå·±çš„ ARP é«˜é€Ÿç¼“å­˜ä¸­æ‰¾åˆ° VIP å¯¹åº”çš„ MAC åœ°å€ï¼ŒæŠŠ MAC åœ°å€å†™å…¥ MAC å¸§ï¼Œç„¶åé€šè¿‡å±€åŸŸç½‘æŠŠè¯¥ MAC å¸§å‘å¾€æ­¤ç¡¬ä»¶åœ°å€ã€‚

\- END -

**å…³äºæˆ‘**
-------

8 å¹´äº’è”ç½‘å¼€å‘ç»éªŒï¼Œæ“…é•¿å¾®æœåŠ¡ã€åˆ†å¸ƒå¼ã€æ¶æ„è®¾è®¡ã€‚ç›®å‰åœ¨ä¸€å®¶å¤§å‹ä¸Šå¸‚å…¬å¸ä»äº‹åŸºç¡€æ¶æ„å’Œæ€§èƒ½ä¼˜åŒ–å·¥ä½œã€‚

InfoQ ç­¾çº¦ä½œè€…ã€è“æ¡¥ç­¾çº¦ä½œè€…ã€é˜¿é‡Œäº‘ä¸“å®¶åšä¸»ã€51CTO çº¢äººã€‚

æ¬¢è¿åŠ æˆ‘å¥½å‹ passjavaï¼Œæä¾›æŠ€æœ¯è§£ç­”ã€ç®€å†ä¿®æ”¹ã€500äººæŠ€æœ¯äº¤æµç¾¤ã€‚

å‚è€ƒèµ„æ–™

[https://weread.qq.com/web/reader/fae32ef072021a44fae8fe6k9a132c802349a1158154a83](https://weread.qq.com/web/reader/fae32ef072021a44fae8fe6k9a132c802349a1158154a83)

[https://weread.qq.com/web/reader/0e732d007260a7490e70173ke2e329c0261e2ef524fbf75](https://weread.qq.com/web/reader/0e732d007260a7490e70173ke2e329c0261e2ef524fbf75)

[https://weread.qq.com/web/reader/36732010719ecf6b3676799kc8f3245027cc8ffe9a588b8](https://weread.qq.com/web/reader/36732010719ecf6b3676799kc8f3245027cc8ffe9a588b8)

[https://weread.qq.com/web/reader/634329b05930c06341b7d10k98f3284021498f137082c2e](https://weread.qq.com/web/reader/634329b05930c06341b7d10k98f3284021498f137082c2e)

[https://blog.51cto.com/aklaus/1757735](https://blog.51cto.com/aklaus/1757735)