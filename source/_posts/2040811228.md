---
layout: post
title: "时间片差分调度法-充分利用MCU的资源"
date: "2022-12-17T12:27:16.392Z"
---
时间片差分调度法-充分利用MCU的资源
===================

介绍如何基于时间片论法的任务调度模式充分利用MCU的资源

前言
==

通过该篇学习了嵌入式的任务调度（即时间片论法）后，了解到通过以1ms为调度时间单位轮询判断是否需要执行函数任务，那么下面介绍如何基于时间片论法的任务调度模式充分利用MCU的资源，姑且先称这种方式为**时间片差分调度法**。

> 充分利用MCU的资源指的是在不影响原有的函数调度情况下合理进行分配，避免MCU大部分时间处于**空跑状态**（即大部分时间没有调度任何的功能函数，只是在不停地判断时间状态，从而造成的资源浪费），同时提高每个任务的调度周期的**命中率**（按时准点执行）

背景
==

时间片论法不比操作系统，操作系统可以通过任务优先级抢占当前正在执行的低优先级任务，或者高优先级任务主动睡眠释放MCU资源以便低优先级的任务可以正常执行；时间片论法必须等待当前任务执行完成后才能执行下一个任务（中断除外）。  
因此，由于时间片论法的特性，很难保证某些任务能够及时得到调度运行，特别是所需要的调度任务多的情况下，常常出现不能及时调度的问题（虽然整体调度周期不变），从而影响所需要的功能，常见的做法可能通过定时中断触发的方式去执行，可是碰到一些任务函数执行时间稍微长的就会影响中断的响应等。  
可以看下面的函数调度时长图，每个刻度为200us（以下称**节拍**），**调度单位**为1ms（以下称**时间片**），只以200us以上的任务举例，方便进行理解  
![在这里插入图片描述](https://img-blog.csdnimg.cn/cc867a6813c446e2a5f57cbbb93fb76c.png)

从上述图中可知以下信息：

> 1.  图中一共有五个任务函数，每个任务函数的执行时间不定  
>     \- 任务1（黄色）周期为5ms  
>     \- 任务2（红色）周期为6ms  
>     \- 任务5（紫色）周期为5ms  
>     \- 任务4（蓝色）周期为12ms  
>     \- 任务5（绿色）周期为15ms
> 2.  同一时刻触发任务调度的执行时的顺序（调度函数的顺序即可任务默认优先级）：1>2>3>4>5
> 3.  第25ms时任务1的调度慢了一个节拍，原因是任务2和4的调度总时长超过了时间片的时长
> 4.  除了任务1大部分时间都能及时被调度，其他任务并不能被及时调度，虽然周期不变，但命中率不高（甚至等于0）
> 5.  其中存在周期性的几个时间片大部分时间处于空跑状态
> 6.  ...等其他仔细观察的可知信息，这里就不多说了

从获取的信息可知，大部分任务虽然整体周期没变，但是几乎很少有低优先级的任务有较高的命中率，这样就导致某些功能需要较高的命中率同时执行时间相对较长（不能放在中断中的任务函数）就不能正常工作。

如何优化
====

在优化之前，首先看下面这个有一定规律的函数调度时长图  
![](https://img-blog.csdnimg.cn/ea9a4884c7c44068ace861e069730e0b.png)

> 1.  还是五个任务，而规律就是函数任务公约数=最小调度周期任务，即5ms（假设小于5ms的任务大都执行时间非常短，在此可忽略不计）  
>     \- 任务1（黄色）周期为5ms  
>     \- 任务2（红色）周期为10ms  
>     \- 任务5（紫色）周期为20ms  
>     \- 任务4（蓝色）周期为10ms  
>     \- 任务5（绿色）周期为20ms
> 2.  图中所展示的任务调度命中率也不高，也存在周期性的几个时间片大部分时间处于空跑状态

看一下优化前后的对比图，虽然还是存在大部分时间处于空跑状态，但是命中率提高到了100%

> 只要保证每个任务函数耗时小于调度单位，那么就能做到命中率 100%

![在这里插入图片描述](https://img-blog.csdnimg.cn/0075cbcd9c384851b3c34a0dcc768307.png)

**如何实现的？**  
从优化后的图中可以了解到，第一个时刻调度的时候只有任务1，第二个时间调度只有任务2，以此类推，就可以在一定程度上避开同一时刻多个任务需要同时等待调度，从而引发的拥堵。

> 可以通过每个任务计时器的倒计时初值进行调整，从而达到每个时间调度只运行一个任务的目的，提高任务的命中率。

那么接下来按照上面提到的规律去优化刚开始的那个，主要有两点：

1.  在可接受范围内调整任务的周期，尽量保证任务函数任务公约数=最小调度周期任务

> 可以理解称任务公约数等于多少就代表可以在初值上类推多少个任务进行错开初次执行；可以忽略部分函数耗时特别短的任务

2.  调整每个任务倒计时器的初值，尽量错开拥堵时刻

> 任务多的情况下只能够尽量避免，从而提高命中率，通过每个任务调度周期和执行时长进行推算，得到每个任务的最佳的初值

根据以上两点对上述调度任务进行优化如下：

> 五个任务函数在可接受范围内调整任务周期后，同时调整初值  
> \- 任务1（黄色）周期为5ms  
> \- 任务2（红色）周期为5ms  
> \- 任务5（紫色）周期为5ms  
> \- 任务4（蓝色）周期为10ms  
> \- 任务5（绿色）周期为15ms

得到对比图：  
![在这里插入图片描述](https://img-blog.csdnimg.cn/8bdbfebb063441eda6d539ed021b7c67.png)

此次优化将充分地利用了每个时间片的资源，虽然某一段时间内的空跑时间总和一样，但是实际上将空跑的时间进行了分散，提高了资源的使用率，从而让每个任务的命中率提高到100%。

本文来自博客园，作者：[大橙子疯](https://www.cnblogs.com/const-zpc/)，转载请注明原文链接：[https://www.cnblogs.com/const-zpc/p/16988879.html](https://www.cnblogs.com/const-zpc/p/16988879.html)