---
layout: post
title: "ArrayListåˆ†æ2 :Itrã€ListIteratorä»¥åŠSubListä¸­çš„å‘"
date: "2022-07-03T03:38:00.003Z"
---
ArrayListåˆ†æ2 :Itrã€ListIteratorä»¥åŠSubListä¸­çš„å‘
==========================================

ArrayListåˆ†æ2 : `Itr`ã€`ListIterator`ä»¥åŠ`SubList`ä¸­çš„å‘
-------------------------------------------------

è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼š[https://www.cnblogs.com/funnyzpc/p/16409137.html](https://www.cnblogs.com/funnyzpc/p/16409137.html)

### ä¸€.ä¸è®º`ListIterator`è¿˜æ˜¯`SubList`,å‡æ˜¯å¯¹`ArrayList`ç»´æŠ¤çš„æ•°ç»„è¿›è¡Œæ“ä½œ

é¦–å…ˆæˆ‘å¾—è¯´ä¸‹`ListIterator`æ˜¯ä»€ä¹ˆï¼Œ`ListIterator` ä¸`Iterator`å‡æ˜¯è¿­ä»£å™¨æ¥å£ï¼Œå¯¹åº”`ArrayList`ä¸­çš„å®ç°å°±æ˜¯`ListItr`ä¸`Itr`ï¼Œæˆ‘ä»¬ä½¿ç”¨`ListIterator`æˆ–`SubList`çš„è¿‡ç¨‹ä¸­å¾ˆå°‘å¯¹ArrayListçš„æ“ä½œï¼Œå¦‚æœæœ‰é‚£å°±å¾ˆä¸¥é‡äº†ï¼ˆä¸‹é¢ä¼šè¯´çš„ï¼‰ï¼Œå¯¹æºæ•°ç»„è¿›è¡Œæ“ä½œè¿™æ˜¯ä¸€ä¸ªäº‹å®å­˜åœ¨çš„é—®é¢˜ğŸ˜‚ï¼Œå°¤å…¶åœ¨SubListè¡¨ç°çš„å°¤ä¸ºä¸¥é‡ï½  
å…ˆçœ‹çœ‹`ArrayList`çš„`subList`æ–¹æ³•å®šä¹‰:

        public List<E> subList(int fromIndex, int toIndex) {
            subListRangeCheck(fromIndex, toIndex, size);
            return new SubList(this, 0, fromIndex, toIndex);
        }
    

å¯ä»¥çœ‹åˆ°`subList`æ–¹æ³•è¿”å›çš„æ˜¯`SubList`çš„ä¸€ä¸ªå®ä¾‹ï¼Œå¥½ï¼Œç»§ç»­çœ‹æ„é€ å‡½æ•°å®šä¹‰ï¼š

        private class SubList extends AbstractList<E> implements RandomAccess {
            private final AbstractList<E> parent;
            private final int parentOffset;
            private final int offset;
            int size;
            // SubListæ„é€ å‡½æ•°çš„å…·ä½“å®šä¹‰
            SubList(AbstractList<E> parent, int offset, int fromIndex, int toIndex) {
                // ä»offsetå¼€å§‹æˆªå–sizeä¸ªå…ƒç´ 
                this.parent = parent;
                this.parentOffset = fromIndex;
                this.offset = offset + fromIndex;
                this.size = toIndex - fromIndex;
                this.modCount = ArrayList.this.modCount;
            }
    

é¦–å…ˆæˆ‘ä»¬è¦æ¸…æ¥šçš„æ˜¯`subList`å¯¹æºæ•°ç»„(`elementData`)çš„å–ç”¨èŒƒå›´`æ˜¯` fromIndex <=å–ç”¨èŒƒå›´< toIndex`, è¿™é‡Œç”¨`å–ç”¨èŒƒå›´`å…¶å®å¾ˆå‡†ç¡®ï¼Œæ¥ç€çœ‹ï½ å› ä¸º`return new SubList(this, 0, fromIndex, toIndex);`å¯¹åº”æ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°`parent`å…¶å®ä¹Ÿå°±æ˜¯å½“å‰ArrayListçš„å®ä¾‹å¯¹è±¡ï¼Œè¿™æ˜¯å…¶ä¸€ï¼Œè¿˜æœ‰å°±æ˜¯SubListçš„offsetæ˜¯é»˜è®¤çš„`offset+ fromIndex`ï¼Œå–ç”¨çš„èŒƒå›´å°±`size`é™åˆ¶åœ¨`toIndex - fromIndex;`ä»¥å†…ï¼Œä¸ç®¡æ˜¯`ArrayList`è¿˜æ˜¯`SubList`å¯¹æ•°ç»„ï¼ˆ`elementData`ï¼‰çš„åç§»æ“ä½œï¼Œåªä¸è¿‡ä¸€ä¸ªæ˜¯ä»0å¼€å§‹ä¸€ä¸ªæ˜¯ä»` offset + fromIndex;`å¼€å§‹ï½ï¼Œå¦‚æœä½ è¿˜æ˜¯å­˜åœ¨æ€€ç–‘ï¼Œå…ˆçœ‹çœ‹`SubList`ä¸­`get\`æ–¹æ³•ï¼š

            public E get(int index) {
                rangeCheck(index);
                checkForComodification();
                return ArrayList.this.elementData(offset + index);
            }
    

çœ‹åˆ°æ²¡ï¼Œ`get`æ–¹æ³•ä¹Ÿåªç›´æ¥å–ç”¨çš„åŸæ•°ç»„(`elementData`)->`return ArrayList.this.elementData(offset + index);`,å¾ˆæ˜ç™½äº†å§ï¼Œå†çœ‹çœ‹`SubList`ä¸­`remove`æ–¹æ³•è®ºè¯ä¸‹å½“å‰è¿™ä¸ªå°æ ‡é¢˜å“ˆï½

            public E remove(int index) {
                rangeCheck(index);
                checkForComodification();
                E result = parent.remove(parentOffset + index);
                this.modCount = parent.modCount;
                this.size--;
                return result;
            }
    

æˆ‘åœ¨å‰å‰é¢è¯´è¿‡ï¼Œè¿™ä¸ª`parent`å…¶å®ä¹Ÿå°±æ˜¯å½“å‰`ArrayList`çš„ä¸€ä¸ªå¼•ç”¨ï¼Œæ—¢ç„¶æ˜¯å¼•ç”¨ï¼Œè€Œä¸æ˜¯æ·±æ‹·è´ï¼Œé‚£è¿™å¥ `parent.remove(parentOffset + index);`æ“ä½œçš„ä¾ç„¶æ˜¯åŸæ•°ç»„`elementData`,å®æ“ä¸€ä¸‹çœ‹ï¼š

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a"); // 0
            arr.add("b");
            arr.add("c");
            arr.add("d"); // 3
            arr.add("e");
            arr.add("f"); // 4
            List sub_list = arr.subList(0, 3);
            System.out.println(sub_list);// [a, b, c]
            sub_list.remove(0);
            System.out.println(sub_list); // [b, c]
            System.out.println(arr); // [b, c, d, e, f]
        }
    

å‘å§ğŸ˜‚ï¼Œä¸€èˆ¬ç†è§£`subList`è¿”å›çš„æ˜¯ä¸€ä¸ªæ·±åº¦æ‹·è´çš„æ•°ç»„ï¼Œå“ªçŸ¥`SubList`ä¸`ArrayList`å†…éƒ¨éƒ½æ˜¯ä¸€å®¶äºº(`elementData`)ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨`subList`çš„å‡½æ•°æ—¶è¦è°¨è®°è¿™ä¸€ç‚¹ï¼Œå½“ç„¶å’¯ï¼Œæ—¢ç„¶`SubList`ä¹Ÿæ˜¯ç»§æ‰¿è‡ª`AbstractList`ï¼Œ`subList`è¿”å›çš„æ•°ç»„ä¹Ÿèƒ½ç»§ç»­è°ƒç”¨`subList`æ–¹æ³•ï¼Œå†…éƒ¨æ“ä½œçš„æ•°ç»„ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ˜¯ä¸æ˜¯å¾ˆåŠè¯¡ğŸ˜‚ğŸ˜‚ğŸ˜‚

### äºŒ.`ListItr`çš„`previous`æ–¹æ³•ä¸å¤ªå¥½ç”¨

å…¶å®è¿™æ˜¯ä¸ªå°é—®é¢˜ï¼Œæˆ‘æ˜¯åŸºäºä»¥ä¸‹ä¸¤ç‚¹æ¥åˆ¤æ–­çš„.

#### 1.ä½¿ç”¨è¿­ä»£å™¨çš„ä¹ æƒ¯

æˆ‘ä»¬å®é™…ä½¿ç”¨è¿­ä»£å™¨çš„ä¹ æƒ¯æ˜¯ä»å·¦å¾€å³(ä¸€èˆ¬æ•°ç»„ç»“æ„)ï¼Œç´¢å¼•ä»å°åˆ°å¤§(`index`),è¿™æ ·çš„ä¸€ä¸ªä½¿ç”¨ä¹ æƒ¯ï¼š

       public static void main(String[] args) {
           ArrayList arr = new ArrayList();
           arr.add("a"); // 0
           arr.add("b");
           arr.add("c");
           arr.add("d"); // 3
           ListIterator listIterator = arr.listIterator();
           while(listIterator.hasPrevious()){
               Object item = listIterator.next();
               System.out.println(item);
           }
       }
    

ä»¥ä¸Šä»£ç æ˜¯å¸¸è§„çš„ä»£ç é€»è¾‘ï¼Œè€Œä¸”`previous`ä¸€èˆ¬åœ¨`next`æ–¹æ³•ä½¿ç”¨åæ‰å¯ä½¿ç”¨ï¼Œè¿™é‡Œå°±ç‰µå‡ºå¦ä¸€ä¸ªé—®é¢˜äº†ï¼Œå¾€ä¸‹çœ‹ğŸ˜

#### 2.è¿­ä»£å™¨çš„é»˜è®¤æ¸¸æ ‡æ˜¯ä»0å¼€å§‹çš„

å¦‚æœæ‚¨è§‰å¾—1çš„è¯´æ³•ä¸å¤Ÿä¿¡æœçš„è¯ï¼Œé‚£å°±å®æ“ä¸‹çœ‹ï¼š

          public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a"); // 0
            arr.add("b");
            arr.add("c");
            arr.add("d"); // 3
            ListIterator listIterator = arr.listIterator();
            while(listIterator.hasPrevious()){//è¿™é‡Œè¿”å›çš„å§‹ç»ˆæ˜¯falseï¼Œæ‰€ä»¥whileå†…çš„é€»è¾‘æ ¹æœ¬å°±ä¸ä¼šè¢«æ‰§è¡Œ
                Object item = listIterator.previous();
                System.out.println(item); // è¿™é‡Œæ²¡è¾“å‡º
            }
        }
    

å“ˆå“ˆå“ˆ`ğŸ˜‚`ï¼Œçœ‹å‡º`bug`æ‰€åœ¨äº†å˜›ï¼Œå†çœ‹çœ‹`ListItr`çš„æ„é€ å‡½æ•°å§

ï¼ˆ`ArrayList`å‡½æ•°ï¼‰

        public ListIterator<E> listIterator() {
            // å½“å‰æ–¹æ³•åŒä»¥ä¸Šï¼Œåªä¸è¿‡æ˜¯ç›´æ¥ä»0å¼€å§‹ç´¢å¼•å¹¶è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ ,å…·ä½“ä»£ç æ–¹æ³•å†…ä¼šæœ‰è¯´æ˜
            return new ListItr(0);
        }
    

(`ListItr`çš„æ„é€ å‡½æ•°ï¼‰

         private class ListItr extends Itr implements ListIterator<E> {
            ListItr(int index) {
                super();
                cursor = index;
            }
    

ï¼ˆ`ListItr`çš„`hasPrevious`æ–¹æ³•ï¼‰

         public boolean hasPrevious() {
                return cursor != 0;
            }
    

çœ‹å‡ºç—‡ç»“æ‰€åœ¨äº†å§ï¼Œå…¶å®å¾ˆç®€å•ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤`listIterator()`çš„æ„é€ å‡½æ•°ä¼ å…¥çš„æ¸¸æ ‡æ˜¯`0`(`cursor = index;`)å¯¼è‡´çš„ï¼Œå¥½äº†ï¼Œå¯¹äºä¸€ä¸ªæ­£å¸¸çš„`previous`æ–¹æ³•çš„ä½¿ç”¨è¯¥æ€ä¹ˆåŠå‘¢ğŸ¥¹

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a"); // 0
            arr.add("b");
            arr.add("c");
            arr.add("d"); // 3
            ListIterator listIterator = arr.listIterator(arr.size());// ä¿®æ”¹åçš„
            while(listIterator.hasPrevious()){
                Object item = listIterator.previous();
                System.out.println(item);// b a
            }
        }
    

å…¶å®ä¹Ÿå°±æ”¹äº†ä¸€å¥`ListIterator listIterator = arr.listIterator(arr.size());`,æ˜¯ä¸æ˜¯è¶… easyï¼Œæ‰€ä»¥ä½¿ç”¨`previous`çš„æ—¶å€™ä¸€å®šè¦æŒ‡å®šä¸‹`index`(å¯¹åº”`ListIter`çš„å…¶å®å°±æ˜¯æ¸¸æ ‡ï¼š`cursor`) ï¼Œ`çŸ¥å…¶ç—‡ä¹‹æ‰€åœ¨æ–¹èƒ½å¯¹ç—‡ä¸‹è¯`ğŸ˜œ

### ä¸‰.`ListItr`ä¸­çš„`setã€remove`æ–¹æ³•ä¸€èˆ¬åœ¨`next`æˆ–`previous`æ–¹æ³•ä¹‹åè°ƒç”¨æ‰å¯

å¦‚æœçœ‹è¿‡ä¸Šé¢çš„å†…å®¹ï¼Œä¼°è®¡ä½ æ‚¨èƒ½çŒœä¸ªå…«ä¹ï¼Œçº¿ä¸Šèœï¼š

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a");
            arr.add("b");
            arr.add("c");
            arr.add("d");
            System.out.println(arr);
            ListIterator listIterator = arr.listIterator();
            listIterator.set("HELLO"); // throw error
        }
    

æˆ‘è¿˜æ˜¯å»ºè®®æ‚¨å…ˆå°†ä¸Šé¢ä¸€æ®µä»£ç æ‰§è¡Œä¸‹çœ‹ğŸ˜‚ï¼Œè™½ç„¶ç»“æœè¿˜æ˜¯æŠ›é”™ã€‚ã€‚ã€‚  
å¥½å§ï¼Œç…ç…æºç çœ‹ï¼š

    public void set(E e) {
               if (lastRet < 0)
                   throw new IllegalStateException();//å‘ç”Ÿå¼‚å¸¸çš„ä½ç½®
               checkForComodification();
               try {
                   ArrayList.this.set(lastRet, e);
               } catch (IndexOutOfBoundsException ex) {
                   throw new ConcurrentModificationException();
               }
           }
    

å†çœ‹çœ‹`lastRet`å®šä¹‰çš„åœ°æ–¹:

         private class Itr implements Iterator<E> {
           // è¿™ä¸ªå…¶å®é»˜è®¤å°±æ˜¯ i=0;
           int cursor;       // index of next element to return :ä¸‹ä¸€ä¸ªå°†è¦è¿”å›çš„å…ƒç´ ä½ç½®çš„ç´¢å¼•,å…¶å®ä¹Ÿå°±æ˜¯ä¸ªæ¸¸æ ‡
           int lastRet = -1; // index of last element returned; -1 if no such :è¿”å›çš„æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•ï¼› -1 å¦‚æœæ²¡æœ‰
           int expectedModCount = modCount;
    

é¡ºå¸¦å†å›å¤´çœ‹çœ‹æ„é€ æ–¹æ³•:

            ListItr(int index) {
               super();
               cursor = index;
           }
    

æˆ‘å…ˆè§£é‡Šä¸‹lastRetæ˜¯ä»€ä¹ˆï¼Œ`lastRet`å…¶å®æ˜¯`cursor`(ä¿—ç§°æ¸¸æ ‡)çš„å‚ç…§ä½ç½®ï¼Œå…·ä½“çš„è¯´å®ƒæ˜¯æ ‡è¯†å½“å‰å¾ªç¯çš„å…ƒç´ çš„ä½ç½®(`cursor-1`)  
è¿™æ—¶ æ˜¯ä¸æ˜¯è§‰å¾—ç›´æ¥ä½¿ç”¨`ListIter`çš„`set`æ–¹æ³•æ˜¯æ¡æ­»è·¯ğŸ˜‚..., æ—¢ç„¶`lastRet`å¿…é¡»`>=0`æ‰å¯ï¼Œæ‰¾æ‰¾çœ‹å“ªé‡Œæœ‰å˜åŠ¨`lastRet`çš„åœ°æ–¹ï¼š

          @SuppressWarnings("unchecked")
          public E next() {
              checkForComodification();
              int i = cursor;
              if (i >= size)
                  throw new NoSuchElementException();
              Object[] elementData = ArrayList.this.elementData;
              if (i >= elementData.length)
                  throw new ConcurrentModificationException();
              cursor = i + 1;
              return (E) elementData[lastRet = i];
          }
    

          @SuppressWarnings("unchecked")
          public E previous() {
              checkForComodification();
              int i = cursor - 1;
              if (i < 0)
                  throw new NoSuchElementException();
              Object[] elementData = ArrayList.this.elementData;
              if (i >= elementData.length)
                  throw new ConcurrentModificationException();
              cursor = i;
              return (E) elementData[lastRet = i];
          }
    

çœ‹åˆ°æ²¡`lastRet = i`å®ƒè§£é‡Šäº†ä¸€åˆ‡ğŸ¤£  
ç°åœ¨æ¥å°è¯•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸¤ç§æ–¹å¼ï¼š

ï¼ˆæ–¹å¼ä¸€)

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a");
            arr.add("b");
            arr.add("c");
            arr.add("d");
            System.out.println(arr);
            ListIterator listIterator = arr.listIterator();
            listIterator.next();
            listIterator.set("HELLO");
            System.out.println(arr);
        }
    

(æ–¹å¼äºŒï¼‰

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a");
            arr.add("b");
            arr.add("c");
            arr.add("d");
            System.out.println(arr);
            ListIterator listIterator = arr.listIterator(3);
            listIterator.previous();
            listIterator.set("HELLO");
            System.out.println(arr);
        }
    

### å››.`ListItr`ä¸­çš„`previous`ã€`next`ä¸å¯åŒæ—¶ä½¿ç”¨,å°¤å…¶åœ¨å¾ªç¯ä¸­

å…ˆçœ‹ä¸€æ®µä»£ç å§ï¼Œè¯•è¯•çœ‹ä½ ç”µè„‘ä¼šä¸ä¼šç‚¸ğŸ’£

       public static void main(String[] args) {
           ArrayList arr = new ArrayList();
           arr.add("a");
           arr.add("b");
           arr.add("c");
           arr.add("d");
           ListIterator listIterator = arr.listIterator();
           while (listIterator.hasNext()){
               Object item = listIterator.next();
               System.out.println(item);
               if("c".equals(item)){
                   Object previous_item = listIterator.previous(); // c
                   if("b".equals(previous_item)){
                       return;
                   }
               }
           }
       }
    

æ€ä¹ˆæ ·ï¼Œæˆ‘å¤§æ¦‚ä¼šçŒœå‡ºä½ çš„çœ‹æ³•ï¼Œ`previous_item` çš„å€¼ä¸é¢„æœŸçš„å¹¶ä¸ä¸€æ ·ï¼Œå“ˆå“ˆå“ˆï¼Œä¸è§£é‡Šäº†ï¼Œè¿™é‡Œç®€å•çš„è§£å†³åŠæ³•æ˜¯ï¼šå¦‚æœæ˜¯åœ¨å¾ªç¯å†…ï¼Œå°±ä¸è¦å°è¯•`next`ä¸`previous`å¯èƒ½çš„åŒæ—¶è°ƒç”¨äº†ğŸ˜¸ ï¼Œéå¾ªç¯ä¹Ÿä¸å»ºè®®ï¼Œè¿˜æ˜¯ç•™æ„ä¸‹æºç çœ‹(æ­¤å¤„çœç•¥nå¤šå­—ğŸ˜).

### äº”. `Itrã€ListItrã€SubList`ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸å¯ç©¿æ’`ArrayList`çš„ç›¸å…³æ“ä½œ(`removeã€add`ç­‰)ï¼Œå¦åˆ™æŠ›é”™

åºŸè¯æ˜¯å¤šä½™çš„ï¼Œå…ˆç»™ä¸ª`äº‹æ•…ç°åœºğŸ˜‚`ï¼š

        public static void main(String[] args) {
            ArrayList arr = new ArrayList();
            arr.add("a");
            arr.add("b");
            arr.add("c");
            arr.add("d");
            ListIterator listIterator = arr.listIterator();
            arr.add("HELLO");
            listIterator.hasNext();
            listIterator.next(); // throw error
        }
    

ä¸ºäº†æ›´æ¸…æ¥šï¼Œç»™å‡ºå¼‚å¸¸ä¿¡æ¯ï¼š

    Exception in thread "main" java.util.ConcurrentModificationException
    	at com.mee.source.c1.ArrayList$Itr.checkForComodification(ArrayList.java:1271)
    	at com.mee.source.c1.ArrayList$Itr.next(ArrayList.java:1181)
    	at com.mee.source.test.ArrayList_listIterator_Test.main(ArrayList_listIterator_Test.java:208)
    

`next`æ–¹æ³•ï¼š

     @SuppressWarnings("unchecked")
            public E next() {
                checkForComodification(); // 1181è¡Œï¼Œè¿™é‡ŒæŠ›å‡ºé”™è¯¯ï¼
                int i = cursor;
                if (i >= size)
                    throw new NoSuchElementException();
                Object[] elementData = ArrayList.this.elementData;
                if (i >= elementData.length)
                    throw new ConcurrentModificationException();
                cursor = i + 1;
                return (E) elementData[lastRet = i];
            }
    

checkForComodificationæ–¹æ³•ï¼š

    final void checkForComodification() {
                if (modCount != expectedModCount)
                    throw new ConcurrentModificationException();
            }
    

è¿™é‡Œæˆ‘å…ˆå–ä¸ªå…³å­ï¼Œå…·ä½“åŸå› éœ€è¦æ‚¨çœ‹çœ‹ä¸Šä¸€ç¯‡åšå®¢ [ArrayListåˆ†æ1-å¾ªç¯ã€æ‰©å®¹ã€ç‰ˆæœ¬](https://www.cnblogs.com/funnyzpc/p/16407733.html) å…³äºç‰ˆæœ¬çš„éƒ¨åˆ†ğŸ¤©  
è§£å†³æ–¹æ³•å˜›ï¼Œå°æ ‡é¢˜å°±æ˜¯ç»“è®ºä¹Ÿæ˜¯è§„åˆ™ï¼Œç»•ç€èµ°é¿å‘ä¾¿æ˜¯å•¦ğŸ˜Š

funnyzpc@gmail.com