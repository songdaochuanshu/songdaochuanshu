---
layout: post
title: "Goæ­»é”â€”â€”å½“Channelé‡ä¸ŠMutexæ—¶"
date: "2022-07-13T08:24:11.876Z"
---
Goæ­»é”â€”â€”å½“Channelé‡ä¸ŠMutexæ—¶
======================

ç”¨metux lock forå¾ªç¯ï¼Œåœ¨forå¾ªç¯ä¸­åˆ å‘å¸¦ç¼“å†²çš„Channel å†™æ•°æ®æ—¶ï¼Œåƒä¸‡è¦å°å¿ƒæ­»é”ï¼

èƒŒæ™¯
--

> ç”¨metux lock forå¾ªç¯ï¼Œåœ¨forå¾ªç¯ä¸­åˆ å‘å¸¦ç¼“å†²çš„Channel å†™æ•°æ®æ—¶ï¼Œåƒä¸‡è¦å°å¿ƒæ­»é”ï¼

æœ€è¿‘ï¼Œæˆ‘åœ¨æµ‹è¯•wsé•¿é“¾æ¥ç½‘å…³ï¼Œå¹³å‡ä¸€ä¸ªæ˜ŸæœŸä¼šé‡åˆ°ä¸€æ¬¡æœåŠ¡å‡æ­»é—®é¢˜ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰routineè¢«é˜»å¡ï¼Œæ•…runtimeçš„æ£€æŸ¥æ— æ³•è§¦å‘ï¼Œhttp health checkåˆæ˜¯å¦å¼€çš„ä¸€ä¸ªç«¯å£ï¼Œk8sæ£€æŸ¥ä¸åˆ°å¼‚å¸¸ï¼Œæ— æ³•é‡å¯æœåŠ¡ã€‚

ç»è¿‡ä¸€ç•ªæ’æŸ¥è®ºè¯ä¹‹åï¼Œç¡®å®šäº†æ˜¯Â **æ··ç”¨å¸¦ç¼“å†²çš„Channelå’ŒMetuxé€ æˆçš„æ­»é”Â ï¼ˆå…·ä½“åœ¨æ–‡æœ«æ€»ç»“ï¼‰**é—®é¢˜ï¼Œè¯·çœ‹ä¸‹é¢è¯¦ç»†ä»‹ç»ã€‚

**æ­»é”ç°è±¡**
--------

æˆ‘ä»¬ä½¿ç”¨äº†ginæ¡†æ¶ï¼Œé¢„å…ˆæ¥å…¥äº†pprofå°è£…ç»„ä»¶ï¼Œè¿™æ ·é€šè¿‡httpï¼ˆéç”Ÿäº§ï¼‰å°±èƒ½å¾ˆæ–¹ä¾¿çš„æŸ¥çœ‹go runtimeçš„ä¸€äº›ä¿¡æ¯ã€‚

æœä¸å…¶ç„¶ï¼Œæˆ‘ä»¬æ‰“å¼€åå‘ç°äº†å¤§é‡çš„ **goroutineæ³„æ¼**ï¼š

![](https://img2022.cnblogs.com/blog/464967/202207/464967-20220713112929200-649026290.png)

ç‚¹å¼€ full goroutiine stack dumpï¼Œå¯ä»¥çœ‹åˆ°æœ‰å¾ˆå¤šæ­»é”ç­‰å¾…ï¼Œå¯¼è‡´goroutineè¢«é˜»å¡ï¼š

![](https://img2022.cnblogs.com/blog/464967/202207/464967-20220713112929303-1880113018.png)

Â å…¶ä¸­ï¼š

*   **semacquireé˜»å¡**ï¼šæœ‰9261/2 ä¸ª routineÂ 
*   **chan sendé˜»å¡**ï¼šæœ‰9å¤„

Â é—®é¢˜å‡ºåœ¨å“ªé‡Œï¼Ÿ

å¯å‘
--

> æœ‰ä¸€ä¸ªä½œè€…ï¼š[https://wavded.com/post/golang-deadlockish/](https://wavded.com/post/golang-deadlockish/)Â åˆ†äº«äº†ä¸€ä¸ªç±»ä¼¼çš„é—®é¢˜ã€‚
> 
> ä¸‹é¢æ˜¯å¼•ç”¨çš„éƒ¨åˆ†æ­£æ–‡å†…å®¹ã€‚

Â **1ï¼‰Wait your turn**

åœ¨æˆ‘ä»¬ä¸ºåº”ç”¨ç¨‹åºæä¾›çš„ä¸€é¡¹æ”¯æŒæœåŠ¡ä¸­ï¼Œæ¯ä¸ªç»„éƒ½æœ‰è‡ªå·±çš„Roomï¼Œå¯ä»¥è¿™ä¹ˆè¯´ã€‚æˆ‘ä»¬åœ¨å‘æˆ¿é—´å¹¿æ’­æ¶ˆæ¯ä¹‹å‰é”å®šäº†membersåˆ—è¡¨ï¼Œä»¥é¿å…ä»»ä½•æ•°æ®ç«äº‰æˆ–å¯èƒ½çš„å´©æºƒã€‚åƒè¿™æ ·ï¼š

func (r \*Room) Broadcast(msg string) {
        r.membersMx.RLock()
        defer r.membersMx.RUnlock()
        for \_, m := range r.members {
                if err := s.Send(msg); err != nil { // â¶
                       log.Printf("Broadcast: %v: %v", r.instance, err)
                }
        }
}

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ç­‰å¾…â¶ï¼Œç›´åˆ°æ¯ä¸ªæˆå‘˜æ”¶åˆ°æ¶ˆæ¯ï¼Œç„¶åå†ç»§ç»­ä¸‹ä¸€ä¸ªæˆå‘˜ã€‚è¿™å¾ˆå¿«å°±ä¼šæˆä¸ºé—®é¢˜ã€‚

Â **2ï¼‰å¦ä¸€ä¸ªçº¿ç´¢**

æµ‹è¯•äººå‘˜è¿˜æ³¨æ„åˆ°ï¼Œä»–ä»¬å¯ä»¥åœ¨é‡æ–°å¯åŠ¨æœåŠ¡æ—¶è¿›å…¥æˆ¿é—´ï¼Œå¹¶ä¸”äº‹æƒ…ä¼¼ä¹åœ¨ä¸€æ®µæ—¶é—´å†…è¿è¡Œè‰¯å¥½ã€‚ç„¶è€Œï¼Œä»–ä»¬ä¸€ç¦»å¼€åˆå›æ¥ï¼Œåº”ç”¨ç¨‹åºå°±åœæ­¢äº†æ­£å¸¸å·¥ä½œã€‚äº‹å®è¯æ˜ï¼Œä»–ä»¬è¢«è¿™ä¸ªå‘æˆ¿é—´æ·»åŠ æ–°æˆå‘˜çš„åŠŸèƒ½æŒ‚æ–­äº†ï¼š

func (r \*Room) Add(s sockjs.Session) {
        r.membersMx.Lock() // â¶
       r.members = append(r.members, s)
        r.membersMx.Unlock()
}

æˆ‘ä»¬æ— æ³•è·å¾—é”â¶ï¼Œå› ä¸ºæˆ‘ä»¬çš„ Broadcast å‡½æ•°ä»åœ¨ä½¿ç”¨å®ƒæ¥å‘é€æ¶ˆæ¯ã€‚

åˆ†æ
--

å¾—ç›Šäºä¸Šé¢çš„æ€è·¯ï¼Œæˆ‘å‘ç°ç¡®å®æœ‰å¤§é‡çš„æ­»é”å‘ç”Ÿåœ¨ Add ä½ç½®ï¼š

![](https://img2022.cnblogs.com/blog/464967/202207/464967-20220713112929305-917379940.png)

å’ŒÂ wavded ç›´æ¥è°ƒç”¨ Send() ä¸åŒï¼Œæˆ‘ä»¬æ˜¯å¾€ä¸€ä¸ª**å¸¦ç¼“å†²çš„channelä¸­å†™æ•°æ®**ï¼ˆå› ä¸ºä½¿ç”¨äº†Â [github.com/gorilla/websocket](http://github.com/gorilla/websocket)Â åŒ…ï¼Œå®ƒçš„ Writer() å‡½æ•°ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ•…éœ€è¦è‡ªå·±å¼€ä¸€ä¸ªWriter routineæ¥å¤„ç†æ•°æ®çš„å‘é€é€»è¾‘ï¼‰ï¼š

func (ud \*UserDevice) SendMsg(ctx context.Context, msg \*InternalWebsocketMessage) {
   // æ³¨æ„ï¼Œä¸æ˜¯åŸç”Ÿçš„Write
   if err = ud.Conn.Write(data); err != nil {
      ud.L.Debug("Write error", zap.Error(err))
   }
}
 
func (c \*connectionImpl) Write(data \[\]byte) (err error) {
   wsMsgData := &MsgData{
      MessageType: websocket.BinaryMessage,
      Data:        data,
   }
 
   c.writer <- wsMsgData // æ³¨æ„è¿™é‡Œï¼Œwriteræ˜¯æœ‰ç¼“å†²çš„ï¼Œæ•°é‡ç›®å‰æ˜¯10ï¼Œå¦‚æœè¢«å†™æ»¡ï¼Œå°±ä¼šé˜»å¡
   return
}

ç„¶ååœ¨ ç»™roomä¸‹é¢çš„ç”¨æˆ·å¹¿æ’­æ¶ˆæ¯ çš„ä¸šåŠ¡ä»£ç ï¼ˆå®é™…æœ‰åˆ å‡ï¼‰è°ƒç”¨ï¼š

func (m \*userManager) BroadcastMsgToRoom(ctx context.Context, msg \*InternalWebsocketMessage, roomId \[\]int64) {
   // è¿™é‡Œæœ‰äº’æ–¥é”ï¼Œç¡®ä¿mapçš„éå†
   m.RLock()
   defer m.RUnlock()
 
   // m.users æ˜¯ä¸€ä¸ª map\[int64\]Userç±»å‹ 
   for \_, user := range m.users {
      user.SendMsg(ctx, msg)   // â¶
   }
}

**å½“è¿™ä¸ªchannelå†™æ»¡äº†ï¼Œä½ç½®Â â¶ çš„ä»£ç å°±ä¼šè¢«é˜»å¡ï¼Œä»è€Œä¸‹é¢çš„é€»è¾‘ä¹Ÿä¼šé˜»å¡**ï¼ˆå› ä¸ºå®ƒä¸€ç›´åœ¨ç­‰å¾…è¯»é”é‡Šæ”¾ï¼‰ï¼š

func (m \*userManager) Add(device UserDeviceInterface) (User, int) {
   uid := device.UID()
 
   m.Lock() // â¶
   defer m.Unlock()
 
   user, ok := m.users\[uid\]
   if !ok {
      user = NewUser(uid, device.GetLogger())
      m.users\[uid\] = user
   }
 
   remain := user.AddDevice(device)
   return user, remain
}

é‚£ä¹ˆï¼Œå½“ä¸€ä¸ªwsè¿æ¥å»ºç«‹åï¼Œå®ƒå¯¹åº”çš„go routineä¹Ÿå°±ä¸€ç›´é˜»å¡åœ¨ Addä¸­äº†ã€‚

func onWSUpgrade(ginCtx \*gin.Context) {
   // ...
   utils.GoSafe(ctx, func(ctx context.Context) {
      // ...
      userDevice.User, remain = biz.DefaultUserManager.Add(userDevice)
   }, logger)
}

ä½†æ˜¯Â c.writer <- wsMsgDataÂ ä¸ºä»€ä¹ˆä¼šæ»¡äº†å‘¢ï¼Ÿå†ç»§ç»­è·Ÿä»£ç ï¼Œå‘è¿™é‡ŒåŸæ¥æœ‰ä¸ªè¶…æ—¶é€»è¾‘ï¼š

func (c \*connectionImpl) ExecuteLogic(ctx context.Context, device UserDeviceInterface) {
   
   go func() {
      for {
         select {
         case msg, ok := <-c.writer:
            if !ok {
               return
            }
 
            // å†™è¶…æ—¶5ç§’
            \_ = c.conn.SetWriteDeadline(time.Now().Add(types.KWriteWaitTime))
            if err := c.conn.WriteMessage(msg.MessageType, msg.Data); err != nil {
               c.conn.Close()
               c.onWriteError(err, device.UserId(), device.UserId())
               return
            }
         }
      }
   }()
}

è¿™ä¸‹å°±èƒ½è§£é‡Šçš„é€šäº†ï¼

**åˆ«äººæ˜¯å¦‚ä½•è§£å†³çš„ï¼Ÿ**
-------------

æ—¢ç„¶æœ‰äººé‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼Œæˆ‘çŒœä¸€äº›å¼€æºé¡¹ç›®ä¸­å¯èƒ½å°±æœ‰ä¸€äº›ç»†èŠ‚å¤„ç†ï¼Œæ‰“å¼€goimï¼ˆ[https://github.com/Terry-Mao/goim](https://github.com/Terry-Mao/goim)ï¼‰ï¼Œçœ‹åˆ°å¦‚ä¸‹ç»†èŠ‚ï¼š

// Push server push message.
func (c \*Channel) Push(p \*protocol.Proto) (err error) {
    select {
    case c.signal <- p:
    default:
        err = errors.ErrSignalFullMsgDropped
    }
    return
}

æœ‰ä¸€ä¸ªselectï¼Œå‘ç°äº†å—ï¼Ÿå¦‚æœc.signalç¼“å†²åŒºæ»¡ï¼Œè¿™ä¸ªi/oå°±è¢«é˜»å¡ï¼Œselectè½®è¯¢æœºåˆ¶ä¼šæ‰§è¡Œåˆ°defaultï¼Œé‚£ä¹ˆè°ƒç”¨æ–¹åœ¨å¾ªç¯ä¸­è°ƒç”¨Pushçš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šblockäº†ã€‚

ä¿®æ”¹ä¸ºä¸‹é¢ä»£ç ï¼Œé—®é¢˜è§£å†³ï¼š

func (c \*connectionImpl) Write(data \[\]byte) (err error) {
   wsMsgData := &MsgData{
      MessageType: websocket.BinaryMessage,
      Data:        data,
   }
 
   // if buffer full, return error immediate
   select {
   case c.writer <- wsMsgData:
   default:
      err = ErrWriteChannelFullMsgDropped
   }
   return
}

**åè®°**
------

å…¶å®runtimeæ˜¯è‡ªå¸¦æ­»é”æ£€æµ‹çš„ï¼Œåªä¸è¿‡æ¯”è¾ƒä¸¥æ ¼ï¼Œä»…å½“æ‰€æœ‰çš„goroutineè¢«æŒ‚èµ·æ—¶æ‰ä¼šè§¦å‘ï¼š

func main() {
    w := make(chan string, 2)
 
    w <- "1"
    fmt.Println("write 1")
 
    w <- "2"
    fmt.Println("write 2â€)
 
    w <- "3"
}

ä¸Šé¢çš„ä»£ç åˆ›å»ºäº†å¸¦ç¼“å†²çš„channelï¼Œå¤§å°ä¸º2ã€‚ç„¶åå‘å…¶ä¸­å†™å…¥3ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬æ•…æ„æ²¡æœ‰èµ·go routineæ¥æ¥æ”¶æ•°æ®ï¼Œæ¥çœ‹çœ‹æ‰§è¡Œçš„æ•ˆæœï¼š

write 1
write 2
fatal error: all goroutines are asleep - deadlock!
 
goroutine 1 \[chan send\]:
main.main()
        /Users/xu/repo/github/01\_struct\_mutex/main.go:133 +0xdc
exit status 2

è¿™ä¸ªç¨‹åºåªæœ‰ä¸€ä¸ª main routineï¼ˆruntimeåˆ›å»ºï¼‰ï¼Œå½“å®ƒè¢«é˜»å¡æ—¶ï¼Œç›¸å½“äºæ‰€æœ‰çš„go routineè¢«é˜»å¡ï¼Œäºæ˜¯è§¦å‘ deadlock æŠ¥é”™ã€‚

æˆ‘ä»¬æ”¹è¿›ä¸€ä¸‹ï¼Œä½¿ç”¨ select æ¥æ£€æŸ¥ä¸€ä¸‹channelï¼Œå‘ç°æ»¡äº†å°±ç›´æ¥è¿”å›ï¼š

func main() {
    w := make(chan string, 2)
 
    w <- "1"
    fmt.Println("write 1")
 
    w <- "2"
    fmt.Println("write 2")
 
    select {
    case w <- "3":
        fmt.Println("write 3")
    default:
        fmt.Println("msg flll")
    }
}

æ­¤æ—¶ï¼Œä¸ä¼šè§¦å‘æ­»é”ï¼š

write 1
write 2
msg flll

æ€»ç»“
--

ç”¨metux lock forå¾ªç¯ï¼Œåœ¨forå¾ªç¯ä¸­åˆ å‘å¸¦ç¼“å†²çš„Channel å†™æ•°æ®æ—¶ï¼Œåƒä¸‡è¦å°å¿ƒæ­»é”ï¼

Badï¼š

func (r \*Room) Broadcast(msg string) {
        r.mu.RLock()
        defer r.mu.RUnlock()
        for \_, m := range r.members {
            r.writer <- msg // Bad
        }
}

Goodï¼š

func (r \*Room) Broadcast(msg string) {
        r.mu.RLock()
        defer r.mu.RUnlock()
 
        for \_, m := range r.members {
 
           // GoodğŸ‘
           select {
            case c.writer <- wsMsgData:
            default:
               fmt.Println(â€œErrWriteChannelFullMsgDroppedâ€)
            }
        }
}

æœ€åï¼ŒæŠ›å‡º2ä¸ªé—®é¢˜

*   å½“ å¸¦ç¼“å†²çš„channel è¢«å†™æ»¡æ—¶ï¼Œåˆ°åº•æ˜¯åº”è¯¥é˜»å¡å¥½ï¼Ÿè¿˜æ˜¯ä¸¢å¼ƒç«‹å³è¿”å›é”™è¯¯å¥½ï¼Ÿ
*   ä¸ºä»€ä¹ˆä¸ç”¨ len(w) == cap(w) åˆ¤æ–­channelæ˜¯å¦å†™æ»¡å‘¢ï¼Ÿ

ç¬¬1ä¸ªé—®é¢˜ï¼šæˆ‘çš„ç­”æ¡ˆæ˜¯ï¼Œæ ¹æ®å®é™…ä¸šåŠ¡ç‰¹ç‚¹å†³å®šã€‚

ç¬¬2ä¸ªé—®é¢˜ï¼šæˆ‘ä¹Ÿæš‚æ—¶æ— æ³•å›ç­”ã€‚

â€”â€”â€”â€”â€”â€”ä¼ è¯´ä¸­çš„åˆ†å‰²çº¿â€”â€”â€”â€”â€”â€”

å¤§å®¶å¥½ï¼Œæˆ‘ç›®å‰å·²ä»C++åç«¯è½¬å‹ä¸ºGolangåç«¯ï¼Œå¯ä»¥è®¢é˜…å…³æ³¨ä¸‹**ã€ŠGoå’Œåˆ†å¸ƒå¼IMã€‹**å…¬ä¼—å·ï¼Œè·å–ä¸€åè½¬å‹èŒæ–°Gopherçš„å¿ƒè·¯æˆé•¿å†ç¨‹å’Œå‡çº§æ‰“æ€ªæŠ€å·§ã€‚