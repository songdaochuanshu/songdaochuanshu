---
layout: post
title: "CopyOnWriteArrayList æ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ"
date: "2022-11-23T19:14:16.581Z"
---
CopyOnWriteArrayList æ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ
================================

> **æœ¬æ–‡å·²æ”¶å½•åˆ° [AndroidFamily](https://github.com/pengxurui/AndroidFamily)ï¼ŒæŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] æé—®ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

[åœ¨ä¸Šä¸€ç¯‡æ–‡ç« é‡Œ](https://mp.weixin.qq.com/s/bCraj7gn8C1hD4_6GxOsJA)ï¼Œæˆ‘ä»¬èŠåˆ°äº†ArrayList çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå…¶ä¸­æåˆ°äº† CopyOnWriteArrayList çš„è§£å†³æ–¹æ³•ã€‚é‚£ä¹ˆ CopyOnWriteArrayList æ˜¯å¦‚ä½•è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ï¼ŒèƒŒåçš„è®¾è®¡æ€æƒ³æ˜¯ä»€ä¹ˆï¼Œä»Šå¤©æˆ‘ä»¬å°±å›´ç»•è¿™äº›é—®é¢˜å±•å¼€ã€‚

æœ¬æ–‡æºç åŸºäº Java 8 CopyOnWriteArrayListã€‚

* * *

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤å·²ç»å»ºç«‹å•¦ï¼Œæ‰«ææ–‡æœ«äºŒç»´ç è¿›å…¥~

* * *

**æ€ç»´å¯¼å›¾ï¼š**

![](https://files.mdnice.com/user/3257/f1e2eab1-2340-46ec-8051-a5e853b55437.png)

* * *

1\. å›é¡¾ ArrayList
----------------

ArrayList æ˜¯åŸºäºæ•°ç»„å®ç°çš„åŠ¨æ€æ•°æ®ï¼Œæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨éå† ArrayList çš„æ—¶å€™ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹æ•°ç»„ï¼ˆå½“ç„¶ä¹Ÿä¸ä¸€å®šæ˜¯è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼‰ï¼Œåœ¨è¿­ä»£å™¨ä¸­å°±ä¼šè§¦å‘ fail-fast æœºåˆ¶ï¼ŒæŠ›å‡º `ConcurrentModificationException` å¼‚å¸¸ã€‚

`ç¤ºä¾‹ç¨‹åº`

    List<String> list = new ArrayList();
    list.add("xiao");
    list.add("peng");
    list.add(".");
    
    Iterator iterator = list.iterator();
    while (iterator.hasNext()) {
        // å¯èƒ½æŠ›å‡º ConcurrentModificationException å¼‚å¸¸
        iterator.next();
    }
    

è¦å®ç°çº¿ç¨‹å®‰å…¨æœ‰ 3 ç§æ–¹å¼ï¼š

*   **æ–¹æ³• 1 - ä½¿ç”¨ Vector å®¹å™¨ï¼š** Vector æ˜¯çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬çš„æ•°ç»„å®¹å™¨ï¼Œå®ƒä¼šåœ¨æ‰€æœ‰æ–¹æ³•ä¸Šå¢åŠ  synchronized å…³é”®å­—ï¼ˆè¿‡æ—¶ï¼Œäº†è§£å³å¯ï¼‰ï¼›
*   **æ–¹æ³• 2 - ä½¿ç”¨ Collections.synchronizedList åŒ…è£…ç±»**
*   **æ–¹æ³• 3 - ä½¿ç”¨ CopyOnWriteArrayList å®¹å™¨**

Collections.synchronizedList åŒ…è£…ç±»çš„åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨ synchronized åŠ é”ï¼Œæºç æ‘˜è¦å¦‚ä¸‹ï¼š

`Collections.java`

    public static <T> List<T> synchronizedList(List<T> list) {
        return (list instanceof RandomAccess ?
                new SynchronizedRandomAccessList<>(list) :
                new SynchronizedList<>(list));
    }
    
    // ä½¿ç”¨ synchronized å®ç°çº¿ç¨‹å®‰å…¨
    static class SynchronizedList<E> extends SynchronizedCollection<E> implements List<E> {
        final List<E> list;
    
        public boolean equals(Object o) {
            if (this == o) return true;
            synchronized (mutex) {return list.equals(o);}
        }
        public int hashCode() {
            synchronized (mutex) {return list.hashCode();}
        }
    
        public E get(int index) {
            synchronized (mutex) {return list.get(index);}
        }
        public E set(int index, E element) {
            synchronized (mutex) {return list.set(index, element);}
        }
        public void add(int index, E element) {
            synchronized (mutex) {list.add(index, element);}
        }
        public E remove(int index) {
            synchronized (mutex) {return list.remove(index);}
        }
    		...
    }
    

å¦‚æœæˆ‘ä»¬å°† ArrayList æ›¿æ¢ä¸º CopyOnWriteArrayListï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹å¹¶å‘ä¿®æ”¹æ•°ç»„ï¼Œä¹Ÿä¸ä¼šæŠ›å‡º `ConcurrentModificationException` å¼‚å¸¸ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

* * *

2\. CopyOnWriteArrayList çš„ç‰¹ç‚¹
----------------------------

CopyOnWriteArrayList å’Œ ArrayList éƒ½æ˜¯åŸºäºæ•°ç»„çš„åŠ¨æ€æ•°ç»„ï¼Œå°è£…äº†æ“ä½œæ•°ç»„æ—¶çš„æ¬è¿å’Œæ‰©å®¹ç­‰é€»è¾‘ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒCopyOnWriteArrayList è¿˜æ˜¯ç”¨äº†åŸºäºåŠ é”çš„ â€œè¯»å†™åˆ†ç¦»â€ å’Œ â€œå†™æ—¶å¤åˆ¶â€ çš„æ–¹æ¡ˆè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š

*   **æ€æƒ³ 1 - è¯»å†™åˆ†ç¦»ï¼ˆRead/Write Splittingï¼‰ï¼š** å°†å¯¹èµ„æºçš„è¯»å–å’Œå†™å…¥æ“ä½œåˆ†ç¦»ï¼Œä½¿å¾—è¯»å–å’Œå†™å…¥æ²¡æœ‰ä¾èµ–ï¼Œåœ¨ â€œè¯»å¤šå†™å°‘â€ çš„åœºæ™¯ä¸­èƒ½æœ‰æ•ˆå‡å°‘èµ„æºç«äº‰ï¼›
*   **æ€æƒ³ 2 - å†™æ—¶å¤åˆ¶ï¼ˆCopyOnWriteï¼ŒCOWï¼‰ï¼š** åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œä¸ç›´æ¥åœ¨åŸæ•°æ®ä¸Šä¿®æ”¹ï¼Œè€Œæ˜¯å¤åˆ¶ä¸€ä»½æ–°æ•°æ®åå†™å…¥åˆ°æ–°æ•°æ®ï¼Œæœ€åå†æ›¿æ¢åˆ°åŸæ•°æ®çš„å¼•ç”¨ä¸Šã€‚è¿™ä¸ªç‰¹æ€§å„æœ‰ä¼˜ç¼ºç‚¹ï¼š
    *   **ä¼˜ç‚¹ 1 - å»¶è¿Ÿå¤„ç†ï¼š** åœ¨æ²¡æœ‰å†™å…¥æ“ä½œæ—¶ä¸ä¼šå¤åˆ¶ / åˆ†é…èµ„æºï¼Œèƒ½å¤Ÿé¿å…ç¬æ—¶çš„èµ„æºæ¶ˆè€—ã€‚ä¾‹å¦‚æ“ä½œç³»ç»Ÿçš„ fork æ“ä½œä¹Ÿæ˜¯ä¸€ç§å†™æ—¶å¤åˆ¶çš„æ€æƒ³ï¼›
    *   **ä¼˜ç‚¹ 2 - é™ä½é”é¢—ç²’åº¦ï¼š** åœ¨å†™çš„è¿‡ç¨‹ä¸­ï¼Œè¯»æ“ä½œä¸ä¼šè¢«å½±å“ï¼Œè¯»æ“ä½œä¹Ÿä¸éœ€è¦åŠ é”ï¼Œé”çš„é¢—ç²’åº¦ä»æ•´ä¸ªåˆ—è¡¨é™ä½ä¸ºå†™æ“ä½œï¼›
    *   **ç¼ºç‚¹ 1 - å¼±æ•°æ®ä¸€è‡´æ€§ï¼š** åœ¨è¯»çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ•°æ®è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹ï¼Œæ˜¯æ— æ³•å®æ—¶æ„ŸçŸ¥åˆ°æœ€æ–°çš„æ•°æ®å˜åŒ–çš„ï¼›
    *   **ç¼ºç‚¹ 2 - æœ‰å†…å­˜å‹åŠ›ï¼š** åœ¨å†™æ“ä½œä¸­éœ€è¦å¤åˆ¶åŸæ•°ç»„ï¼Œåœ¨å¤åˆ¶çš„è¿‡ç¨‹ä¸­å†…å­˜ä¼šåŒæ—¶å­˜åœ¨ä¸¤ä¸ªæ•°ç»„å¯¹è±¡ï¼ˆåªæ˜¯å¼•ç”¨ï¼Œæ•°ç»„å…ƒç´ çš„å¯¹è±¡è¿˜æ˜¯åªæœ‰ä¸€ä»½ï¼‰ï¼Œä¼šå¸¦æ¥å†…å­˜å ç”¨å’Œåƒåœ¾å›æ”¶çš„å‹åŠ›ã€‚å¦‚æœæ˜¯ â€œå†™å¤šè¯»å°‘â€ çš„åœºæ™¯ï¼Œå°±ä¸é€‚åˆã€‚

æ‰€ä»¥ï¼Œä½¿ç”¨ CopyOnWriteArrayList çš„åœºæ™¯ä¸€å®šè¦ä¿è¯æ˜¯ â€œè¯»å¤šå†™å°‘â€ ä¸”æ•°æ®é‡ä¸å¤§çš„åœºæ™¯ï¼Œè€Œä¸”åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œè¦åšåˆ°æ‰¹é‡æ“ä½œã€‚å¦åˆ™æ¯ä¸ªå†™å…¥æ“ä½œéƒ½ä¼šè§¦å‘ä¸€æ¬¡å¤åˆ¶ï¼Œæƒ³æƒ³å°±å¯æ€•ã€‚ä¸¾ 2 ä¸ªä¾‹å­ï¼š

*   ä¾‹å¦‚æ‰¹é‡å†™å…¥ä¸€ç»„æ•°æ®ï¼Œè¦ä½¿ç”¨ addAll æ–¹æ³• æ‰¹é‡å†™å…¥ï¼›
*   ä¾‹å¦‚åœ¨åšæ’åºæ—¶ï¼Œè¦å…ˆè¾“å‡ºä¸º ArrayListï¼Œåœ¨ ArrayList ä¸Šå®Œæˆæ’åºåå†å†™å› CopyOnWriteArrayListã€‚

* * *

3\. CopyOnWriteArrayList æºç åˆ†æ
-----------------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥åˆ†æ CopyOnWriteArrayList ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

### 3.1 CopyOnWriteArrayList çš„å±æ€§

ArrayList çš„å±æ€§å¾ˆå¥½ç†è§£ï¼Œåº•å±‚æ˜¯ä¸€ä¸ª Object æ•°ç»„ï¼Œæˆ‘è¦ä¸¾æ‰‹æé—® ğŸ™‹ğŸ»â€â™€ï¸ï¼š

*   **ç–‘é—® 1ï¼š** ä¸ºä»€ä¹ˆ array å­—æ®µè¦ä½¿ç”¨ volatile å…³é”®å­—ï¼Ÿ

    // é”
    final transient ReentrantLock lock = new ReentrantLock();
    
    // åœ¨ Java 11 ä¸­ï¼ŒReentrantLock è¢«æ›¿æ¢ä¸º synchronized é”
    // The lock protecting all mutators.  (We have a mild preference for builtin monitors over ReentrantLock when either will do.)
    final transient Object lock = new Object();
    
    // åº•å±‚æ•°ç»„
    // ç–‘é—® 1ï¼šä¸ºä»€ä¹ˆ array è¦ä½¿ç”¨ volatile å…³é”®å­—ï¼Ÿ
    private transient volatile Object[] array;
    

è¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨åˆ†ææºç çš„è¿‡ç¨‹ä¸­å›ç­”ã€‚æœ‰äº† ArrayList çš„åˆ†æåŸºç¡€ï¼Œç–‘é—®ä¹Ÿå˜å°‘äº†ï¼ŒCopyOnWriteArrayList çœŸé¦™ã€‚

### 3.2 CopyOnWriteArrayList çš„æ„é€ æ–¹æ³•

æ„é€ å™¨çš„æºç ä¸éš¾ï¼Œä½†å°æœ‹å‹æ€»æœ‰å¤ªå¤šçš„é—®å·ï¼Œä¸¾æ‰‹æé—® ğŸ™‹ğŸ»â€â™€ï¸ï¼š

*   **ç–‘é—® 2ï¼šä¸ºä»€ä¹ˆ CopyOnWriteArrayList ä¸æä¾›åˆå§‹åŒ–å®¹é‡çš„æ„é€ å™¨ï¼Ÿ**

è¿™æ˜¯å› ä¸º CopyOnWriteArrayList å»ºè®®æˆ‘ä»¬ä½¿ç”¨æ‰¹é‡æ“ä½œå†™å…¥æ•°æ®ã€‚å¦‚æœæä¾›äº†å¸¦åˆå§‹åŒ–å®¹é‡çš„æ„é€ å™¨ï¼Œæ„å‘³ç€å¼€å‘è€…é¢„æœŸä¼šä¸€ä¸ªä¸ªåœ°å†™å…¥æ•°æ®ï¼Œè¿™ä¸ç¬¦åˆ CopyOnWriteArrayList çš„æ­£ç¡®ä½¿ç”¨æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œä¸æä¾›è¿™ä¸ªæ„é€ å™¨æ‰æ˜¯åˆç†çš„ã€‚

*   **ç–‘é—® 3ï¼šä¸ºä»€ä¹ˆè¦æŠŠ E\[\] ç±»å‹çš„å…¥å‚è½¬åŒ–ä¸º Object\[\] ç±»å‹ï¼Ÿ**

å¦‚æœä¸è½¬åŒ–æ•°ç»„ç±»å‹ï¼Œé‚£ä¹ˆåœ¨ toArray() æ–¹æ³•è¿”å›çš„æ•°ç»„ä¸­æ’å…¥ Object ç±»å‹å¯¹è±¡æ—¶ï¼Œä¼šæŠ›å‡º `ArrayStoreException`ã€‚

> **æç¤ºï¼š** è¿™ä¸ªé—®é¢˜ä¸ â€œå¥‡æ€ªâ€ åˆ†æ”¯çš„åŸå› ç›¸åŒï¼Œå…·ä½“åˆ†æå¯ä»¥çœ‹è®² [ã€ŠJava é¢è¯•é¢˜ï¼šArrayList å¯ä»¥å®Œå…¨æ›¿ä»£æ•°ç»„å—ï¼Ÿã€‹](https://mp.weixin.qq.com/s/bCraj7gn8C1hD4_6GxOsJA) çš„æ–‡ç« ä¸­ï¼Œè¿™é‡Œä¸é‡å¤è®²äº†ã€‚

    // ç–‘é—® 2ï¼šä¸ºä»€ä¹ˆ CopyOnWriteArrayList ä¸æä¾›é¢„åˆå§‹åŒ–å®¹é‡çš„æ„é€ å™¨ï¼Ÿ
    
    // æ— å‚æ„é€ æ–¹æ³•
    public CopyOnWriteArrayList() {
        // åˆ›å»ºç©ºæ•°ç»„
        setArray(new Object[0]);
    }
    
    // å¸¦é›†åˆçš„æ„é€ æ–¹æ³•
    public CopyOnWriteArrayList(Collection<? extends E> c) {
        Object[] elements;
        if (c.getClass() == CopyOnWriteArrayList.class)
            elements = ((CopyOnWriteArrayList<?>)c).getArray();
        else {
            elements = c.toArray();
            // è¿™ä¸ªâ€œå¥‡æ€ªâ€çš„åˆ†æ”¯åœ¨ ArrayList æ–‡ç« ä¸­åˆ†æè¿‡ï¼Œå»çœ‹çœ‹
            if (elements.getClass() != Object[].class)
                elements = Arrays.copyOf(elements, elements.length, Object[].class);
        }
        setArray(elements);
    }
    
    // å¸¦æ•°ç»„çš„æ„é€ æ–¹æ³•
    public CopyOnWriteArrayList(E[] toCopyIn) {
        // ç–‘é—® 3ï¼šä¸ºä»€ä¹ˆè¦æŠŠ E[] ç±»å‹çš„å…¥å‚è½¬åŒ–ä¸º Object[] ç±»å‹
        setArray(Arrays.copyOf(toCopyIn, toCopyIn.length, *Object[]*.class));
    }
    
    final Object[] getArray() {
        return array;
    }
    
    final void setArray(Object[] a) {
        array = a;
    }
    
    public Object[] toArray() {
        Object[] elements = getArray();
        return Arrays.copyOf(elements, elements.length);
    }
    

### 3.3 CopyOnWriteArrayList çš„å†™æ–¹æ³•

æˆ‘ä»¬å°† CopyOnWriteArrayList çš„æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹æ–¹æ³•ç»Ÿä¸€ä¸º â€œå†™æ–¹æ³•â€ï¼Œä¸‰ç§å†™æ–¹æ³•çš„æ¨¡æ¿å…¶å®æ˜¯ä¸€æ ·çš„ï¼š

*   1ã€åœ¨å†™å…¥ä¹‹å‰å…ˆè·å–å¯¹è±¡çš„é”ï¼›
*   2ã€å¤åˆ¶æ–°æ•°ç»„ï¼›
*   3ã€åœ¨æ–°æ•°ç»„ä¸Šå®Œæˆå†™å…¥æ“ä½œï¼›
*   4ã€å°†æ–°æ•°ç»„è®¾ç½®ä¸ºåº•å±‚æ•°ç»„ï¼›
*   5ã€é‡Šæ”¾å¯¹è±¡çš„é”ã€‚

å°æœ‹å‹æ€»æ˜¯æœ‰å¤ªå¤šé—®å·ï¼Œä¸¾æ‰‹æé—® ğŸ™‹ğŸ»â€â™€ï¸ï¼š

*   **ç–‘é—® 4ï¼šåœ¨æ·»åŠ æ–¹æ³•ä¸­ï¼Œä¸ºä»€ä¹ˆæ‰©å®¹åªå¢å¤§ 1 å®¹é‡ï¼Œè€Œ ArrayList ä¼šå¢å¤§ 1.5 å€ï¼Ÿ**

è¿™è¿˜æ˜¯å› ä¸º CopyOnWriteArrayList å»ºè®®æˆ‘ä»¬ä½¿ç”¨æ‰¹é‡æ“ä½œå†™å…¥æ•°æ®ã€‚ArrayList é¢å¤–æ‰©å®¹ 1.5 å€æ˜¯ä¸ºäº†é¿å…æ¯æ¬¡ add éƒ½æ‰©å®¹ï¼Œè€Œ CopyOnWriteArrayList å¹¶ä¸å»ºè®®ä¸€ä¸ªä¸ªåœ°æ·»åŠ æ•°æ®ï¼Œè€Œæ˜¯å»ºè®®æ‰¹é‡æ“ä½œå†™å…¥æ•°æ®ï¼Œä¾‹å¦‚ addAll æ–¹æ³•ã€‚æ‰€ä»¥ï¼ŒCopyOnWriteArrayList ä¸é¢å¤–æ‰©å®¹æ‰æ˜¯åˆç†çš„ã€‚

å¦å¤–ï¼Œç½‘ä¸Šæœ‰è§‚ç‚¹çœ‹åˆ° CopyOnWriteArrayList æ²¡æœ‰é™åˆ¶æ•°ç»„æœ€å¤§å®¹é‡ï¼Œå°±è¯´ CopyOnWriteArrayList æ˜¯æ— ç•Œçš„ï¼Œæ²¡æœ‰å®¹é‡é™åˆ¶ã€‚è¿™æ˜¾ç„¶å¤ªè¡¨é¢äº†ã€‚æ•°ç»„çš„é•¿åº¦é™åˆ¶æ˜¯è¢«è™šæ‹Ÿæœºå›ºåŒ–çš„ï¼ŒCopyOnWriteArrayList æ²¡æœ‰é™åˆ¶çš„åŸå› æ˜¯ï¼šå®ƒæ²¡æœ‰åšé¢å¤–æ‰©å®¹ï¼Œè€Œä¸”ä¸é€‚åˆå¤§æ•°æ®çš„åœºæ™¯ï¼Œæ‰€ä»¥æ²¡æœ‰é™åˆ¶çš„å¿…è¦ã€‚

æœ€åè¿˜å‰©ä¸‹ 1 ä¸ªé—®é¢˜ï¼š

*   **ç–‘é—® 1ï¼šä¸ºä»€ä¹ˆ array å­—æ®µè¦ä½¿ç”¨ volatile å…³é”®å­—ï¼Ÿ**

volatile å˜é‡æ˜¯ Java è½»é‡çº§çš„çº¿ç¨‹åŒæ­¥åŸè¯­ï¼Œvolatile å˜é‡çš„è¯»å–å’Œå†™å…¥æ“ä½œä¸­ä¼šåŠ å…¥å†…å­˜å±éšœï¼Œèƒ½å¤Ÿä¿è¯å˜é‡å†™å…¥çš„å†…å­˜å¯è§æ€§ï¼Œä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å†™å…¥èƒ½å¤Ÿè¢«å¦ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿåˆ°ã€‚

`æ·»åŠ æ–¹æ³•`

    // åœ¨æ•°ç»„å°¾éƒ¨æ·»åŠ å…ƒç´ 
    public boolean add(E e) {
        final ReentrantLock lock = this.lock;
        // è·å–é”
        lock.lock();
        // å¤åˆ¶æ–°æ•°ç»„
        Object[] elements = getArray();
        int len = elements.length;
        // ç–‘é—® 4ï¼šåœ¨æ·»åŠ æ–¹æ³•ä¸­ï¼Œä¸ºä»€ä¹ˆæ‰©å®¹åªå¢å¤§ 1 å®¹é‡ï¼Œè€Œ ArrayList ä¼šå¢å¤§ 1.5 å€ï¼Ÿ
        Object[] newElements = Arrays.copyOf(elements, len + 1 /* å®¹é‡ + 1*/);
        // åœ¨æ–°æ•°ç»„ä¸Šæ·»åŠ å…ƒç´ 
        newElements[len] = e;
        // è®¾ç½®æ–°æ•°ç»„
        setArray(newElements);
        // é‡Šæ”¾é”
        lock.unlock();
        return true;
    }
    
    // åœ¨æ•°ç»„å°¾éƒ¨æ·»åŠ å…ƒç´ 
    public void add(int index, E element) {
        // åŸç†ç›¸åŒï¼Œçœç•¥
        ...
    }
    
    // æ‰¹é‡åœ¨æ•°ç»„å°¾éƒ¨æ·»åŠ å…ƒç´ 
    public boolean addAll(Collection<? extends E> c) {
        // åŸç†ç›¸åŒï¼Œçœç•¥
        ...
    }
    

`ä¿®æ”¹æ–¹æ³•`

    // ä¿®æ”¹æ•°ç»„å…ƒç´ 
    public E set(int index, E element) {
        final ReentrantLock lock = this.lock;
        // è·å–é”
        lock.lock();
        // æ—§å…ƒç´ 
        Object[] elements = getArray();
        E oldValue = get(elements, index);
    		
        if (oldValue != element) {
            // å¤åˆ¶æ–°æ•°ç»„
            int len = elements.length;
            Object[] newElements = Arrays.copyOf(elements, len);
            // åœ¨æ–°æ•°ç»„ä¸Šæ·»åŠ å…ƒç´ 
            newElements[index] = element;
            // è®¾ç½®æ–°æ•°ç»„
            setArray(newElements);
        } else {
            // Not quite a no-op; ensures volatile write semantics
            setArray(elements);
        }
        // é‡Šæ”¾é”
        lock.unlock();
        // è¿”å›æ—§æ•°æ®
        return oldValue;
    }
    

`åˆ é™¤æ–¹æ³•`

    // åˆ é™¤æ•°ç»„å…ƒç´ 
    public E remove(int index) {
        final ReentrantLock lock = this.lock;
        // è·å–é”
        lock.lock();
        Object[] elements = getArray();
        int len = elements.length;
        // æ—§å…ƒç´ 
        E oldValue = get(elements, index);
        int numMoved = len - index - 1;
        if (numMoved == 0)
            // åˆ é™¤é¦–ä½å…ƒç´ 
            setArray(Arrays.copyOf(elements, len - 1));
        else {
            // åˆ é™¤ä¸­é—´å…ƒç´ 
            // å¤åˆ¶æ–°æ•°ç»„
            Object[] newElements = new Object[len - 1];
            System.arraycopy(elements, 0, newElements, 0, index);
            System.arraycopy(elements, index + 1, newElements, index, numMoved);
            // è®¾ç½®æ–°æ•°ç»„
            setArray(newElements);
        }
        // é‡Šæ”¾é”
        lock.unlock();
        // è¿”å›æ—§æ•°æ®
        return oldValue;
    }
    

### 3.4 CopyOnWriteArrayList çš„è¯»å–æ–¹æ³•

å¯ä»¥çœ‹åˆ°è¯»å–æ–¹æ³•å¹¶æ²¡æœ‰åŠ é”ã€‚

    private E get(Object[] a, int index) {
        return (E) a[index];
    }
    
    public E get(int index) {
        return get(getArray(), index);
    }
    
    public boolean contains(Object o) {
        Object[] elements = getArray();
        return indexOf(o, elements, 0, elements.length) >= 0;
    }
    

### 3.5 CopyOnWriteArrayList çš„è¿­ä»£å™¨

CopyOnWriteArrayList çš„è¿­ä»£å™¨ `COWIterator` æ˜¯ **â€œå¼±æ•°æ®ä¸€è‡´æ€§çš„â€** ï¼Œæ‰€è°“æ•°æ®ä¸€è‡´æ€§é—®é¢˜è®¨è®ºçš„æ˜¯åŒä¸€ä»½æ•°æ®åœ¨å¤šä¸ªå‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä½ ä¹Ÿå¯ä»¥ç†è§£ä¸ºå¤šä¸ªå‰¯æœ¬çš„çŠ¶æ€ä¸€è‡´æ€§é—®é¢˜ã€‚ä¾‹å¦‚å†…å­˜ä¸å¤šæ ¸å¿ƒ Cache å‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§ï¼Œæˆ–è€…æ•°æ®åœ¨ä¸»ä»æ•°æ®åº“ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚

> **æç¤ºï¼š** å…³äº â€œæ•°æ®ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§â€ çš„åŒºåˆ«ï¼Œåœ¨å°å½­çš„è®¡ç®—æœºç»„æˆåŸç†ä¸“æ è®¨è®ºè¿‡ [ã€Šå·²ç»æœ‰ MESI åè®®ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦ volatile å…³é”®å­—ï¼Ÿã€‹](https://mp.weixin.qq.com/s/u5eW-gAqzUIgJDmPZpT-7g)ï¼Œå»çœ‹çœ‹ã€‚

ä¸ºä»€ä¹ˆæ˜¯ **â€œå¼±â€** çš„å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º `COWIterator` è¿­ä»£å™¨ä¼šæŒæœ‰ CopyOnWriteArrayList **â€œåº•å±‚æ•°ç»„â€** çš„å¼•ç”¨ï¼Œè€Œ CopyOnWriteArrayList çš„å†™å…¥æ“ä½œæ˜¯å†™å…¥åˆ°æ–°æ•°ç»„ï¼Œå› æ­¤ `COWIterator` æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼Œé™¤éé‡æ–°åˆ›å»ºè¿­ä»£å™¨ã€‚

ç›¸è¾ƒä¹‹ä¸‹ï¼ŒArrayList çš„è¿­ä»£å™¨æ˜¯é€šè¿‡æŒæœ‰ **â€œå¤–éƒ¨ç±»å¼•ç”¨â€** çš„æ–¹å¼è®¿é—® ArrayList çš„åº•å±‚æ•°ç»„ï¼Œå› æ­¤åœ¨ ArrayList ä¸Šçš„å†™å…¥æ“ä½œä¼šå®æ—¶è¢«è¿­ä»£å™¨è§‚å¯Ÿåˆ°ã€‚

`CopyOnWriteArrayList.java`

    // æ³¨æ„çœ‹ï¼šæœ‰ static å…³é”®å­—ï¼Œç›´æ¥å¼•ç”¨åº•å±‚æ•°ç»„
    static final class COWIterator<E> implements ListIterator<E> {
        // åº•å±‚æ•°ç»„
        private final Object[] snapshot;
        private int cursor;
    
        private COWIterator(Object[] elements, int initialCursor) {
            cursor = initialCursor;
            snapshot = elements;
        }
    }
    

`ArrayList.java`

    // æ³¨æ„çœ‹ï¼šæ²¡æœ‰ static å…³é”®å­—ï¼Œé€šè¿‡å¤–éƒ¨ç±»å¼•ç”¨æ¥è®¿é—®åº•å±‚æ•°ç»„
    private class Itr implements Iterator<E> {
        int cursor;       // index of next element to return
        int lastRet = -1; // index of last element returned; -1 if no such
        int expectedModCount = modCount;
    
        Itr() {}
        ...
    }
    

### 3.6 CopyOnWriteArraySet çš„åºåˆ—åŒ–è¿‡ç¨‹

ä¸ ArrayList ç±»ä¼¼ï¼ŒCopyOnWriteArraySet ä¹Ÿé‡å†™äº† JDK åºåˆ—åŒ–çš„é€»è¾‘ï¼ŒåªæŠŠ elements æ•°ç»„ä¸­æœ‰æ•ˆå…ƒç´ çš„éƒ¨åˆ†åºåˆ—åŒ–ï¼Œè€Œä¸ä¼šåºåˆ—åŒ–æ•´ä¸ªæ•°ç»„ã€‚

åŒæ—¶ï¼Œ`ReentrantLock` å¯¹è±¡æ˜¯é”å¯¹è±¡ï¼Œåºåˆ—åŒ–æ²¡æœ‰æ„ä¹‰ã€‚åœ¨ååºåˆ—åŒ–æ—¶ï¼Œä¼šé€šè¿‡ `resetLock()` è®¾ç½®ä¸€ä¸ªæ–°çš„ `ReentrantLock` å¯¹è±¡ã€‚

    // åºåˆ—åŒ–è¿‡ç¨‹
    private void writeObject(java.io.ObjectOutputStream s) throws java.io.IOException {
        s.defaultWriteObject();
        Object[] elements = getArray();
        // å†™å…¥æ•°ç»„é•¿åº¦
        s.writeInt(elements.length);
        // å†™å…¥æœ‰æ•ˆå…ƒç´ 
        for (Object element : elements)
            s.writeObject(element);
    }
    
    // ååºåˆ—åŒ–è¿‡ç¨‹
    private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException {
        s.defaultReadObject();
        // è®¾ç½® ReentrantLock å¯¹è±¡
        resetLock();
        // è¯»å–æ•°ç»„é•¿åº¦
        int len = s.readInt();
        SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, len);
        // åˆ›å»ºåº•å±‚æ•°ç»„
        Object[] elements = new Object[len];
        // è¯»å–æ•°ç»„å¯¹è±¡
        for (int i = 0; i < len; i++)
            elements[i] = s.readObject();
        // è®¾ç½®æ–°æ•°ç»„
        setArray(elements);
    }
    
    // ç–‘é—® 5ï¼šresetLock() æ–¹æ³•ä¸å¥½ç†è§£ï¼Œè§£é‡Šä¸€ä¸‹ï¼Ÿ
    private void resetLock() {
        // ç­‰ä»·äºå¸¦ Volatile è¯­ä¹‰çš„ this.lock = new ReentrantLock()
        UNSAFE.putObjectVolatile(this, lockOffset, new ReentrantLock());
    }
    
    // Unsafe API
    private static final sun.misc.Unsafe UNSAFE;
    // lock å­—æ®µåœ¨å¯¹è±¡å®ä¾‹æ•°æ®ä¸­çš„åç§»é‡
    private static final long lockOffset;
    
    static {
        // è¿™ä¸‰è¡Œçš„ä½œç”¨ï¼šlock å­—æ®µåœ¨å¯¹è±¡å®ä¾‹æ•°æ®ä¸­çš„åç§»é‡
        UNSAFE = sun.misc.Unsafe.getUnsafe();
        Class<?> k = CopyOnWriteArrayList.class;
        lockOffset = UNSAFE.objectFieldOffset(k.getDeclaredField("lock"));
    }
    

å°æœ‹å‹åˆæ˜¯æœ‰å¤ªå¤šé—®å·ï¼Œä¸¾æ‰‹æé—® ğŸ™‹ğŸ»â€â™€ï¸ï¼š

*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 5ï¼š`resetLock()` æ–¹æ³•ä¸å¥½ç†è§£ï¼Œè§£é‡Šä¸€ä¸‹ï¼Ÿ**

åœ¨ static ä»£ç å—ä¸­ï¼Œä¼šä½¿ç”¨ Unsafe API è·å– CopyOnWriteArrayList çš„ **â€œ`lock` å­—æ®µåœ¨å¯¹è±¡å®ä¾‹æ•°æ®ä¸­çš„åç§»é‡â€** ã€‚ç”±äºå­—æ®µçš„åç§»æ˜¯å…¨å±€å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™ä¸ªåç§»é‡å¯ä»¥è®°å½•åœ¨ static å­—æ®µ `lockOffset` ä¸­ã€‚

åœ¨ `resetLock()` ä¸­ï¼Œé€šè¿‡ UnSafe API putObjectVolatile å°†æ–°å»ºçš„ ReentrantLock å¯¹è±¡è®¾ç½®åˆ° CopyOnWriteArrayList çš„ lock å­—æ®µä¸­ï¼Œç­‰ä»·äºå¸¦ volatile è¯­ä¹‰çš„ `this.lock = new ReentrantLock()`ï¼Œä¿è¯è¿™ä¸ªå­—æ®µçš„å†™å…¥å…·å¤‡å†…å­˜å¯è§æ€§ã€‚

å­—æ®µçš„åç§»é‡æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œæ™®é€šå¯¹è±¡å’Œ Class å¯¹è±¡çš„å®ä¾‹æ•°æ®åŒºåŸŸæ˜¯ä¸åŒçš„ï¼š

*   **1ã€æ™®é€šå¯¹è±¡ï¼š**Â åŒ…æ‹¬å½“å‰ç±»å£°æ˜çš„å®ä¾‹å­—æ®µä»¥åŠçˆ¶ç±»å£°æ˜çš„å®ä¾‹å­—æ®µï¼Œä¸åŒ…æ‹¬ç±»çš„é™æ€å­—æ®µã€‚UnSafe API objectFieldOffset(Filed) å°±æ˜¯è·å–äº†å‚æ•° Filed åœ¨å®ä¾‹æ•°æ®ä¸­çš„åç§»é‡ï¼Œåç»­å°±å¯ä»¥é€šè¿‡è¿™ä¸ªåç§»é‡ä¸ºå­—æ®µèµ‹å€¼ï¼›
*   **2ã€Class å¯¹è±¡ï¼š**Â åŒ…æ‹¬å½“å‰ç±»å£°æ˜çš„é™æ€å­—æ®µå’Œæ–¹æ³•è¡¨ç­‰ã€‚

`å¯¹è±¡å†…å­˜å¸ƒå±€`

![](https://files.mdnice.com/user/3257/2d5edc04-807c-4631-8384-bd98f3052249.png)

> **æç¤ºï¼š** å…³äºå­—æ®µçš„åç§»é‡ï¼Œæˆ‘ä»¬åœ¨ [ã€Šå¯¹è±¡çš„å†…å­˜åˆ†ä¸ºå“ªå‡ ä¸ªéƒ¨åˆ†ï¼Ÿã€‹](https://mp.weixin.qq.com/s/zuB_lD33TfMUpXIzXCKvaw) è¿™ç¯‡æ–‡ç« é‡Œè®¨è®ºè¿‡ï¼Œå»çœ‹çœ‹ã€‚

### 3.7 CopyOnWriteArraySet çš„ clone() è¿‡ç¨‹

CopyOnWriteArraySet çš„ clone() å¾ˆå·§å¦™ã€‚æŒ‰ç…§æ­£å¸¸çš„æ€ç»´ï¼ŒCopyOnWriteArraySet ä¸­çš„ `array` æ•°ç»„æ˜¯å¼•ç”¨ç±»å‹ï¼Œå› æ­¤åœ¨ clone() ä¸­éœ€è¦å®ç°æ·±æ‹·è´ï¼Œå¦åˆ™åŸå¯¹è±¡ä¸å…‹éš†å¯¹è±¡å°±ä¼šç›¸äº’å½±å“ã€‚ä½†äº‹å®ä¸Šï¼Œ`array` æ•°ç»„å¹¶æ²¡æœ‰è¢«æ·±æ‹·è´ï¼Œå“‡ç‚¹è§£å•Šï¼Ÿ

*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 6ï¼šä¸ºä»€ä¹ˆ array æ•°ç»„æ²¡æœ‰æ·±æ‹·è´ï¼Ÿ**

è¿™å°±æ˜¯å› ä¸º CopyOnWrite å•Šï¼æ²¡æœ‰ Write ä¸ºä»€ä¹ˆè¦ Copy å‘¢ï¼Ÿï¼ˆæˆ‘è§‰å¾—å·²ç»æé†’åˆ°ä½äº†ï¼Œåªè¦ä½ ä»”ç»†é˜…è¯»å‰æ–‡å¯¹ CopyOnWrite çš„è®ºè¯ï¼Œä½ ä¸€å®šä¼šæ‡‚çš„ã€‚è¦æ˜¯æ˜¯åœ¨ä¸æ‡‚ï¼Œç§ä¿¡æˆ‘å§~ï¼‰

    public Object clone() {
        try {
            @SuppressWarnings("unchecked")
            // ç–‘é—® 6ï¼šä¸ºä»€ä¹ˆ array æ•°ç»„æ²¡æœ‰æ·±æ‹·è´ï¼Ÿ
            CopyOnWriteArrayList<E> clone = (CopyOnWriteArrayList<E>) super.clone();
            // è®¾ç½® ReentrantLock å¯¹è±¡ï¼ˆç›¸å½“äº lock å­—æ®µçš„æ·±æ‹·è´ï¼‰
            clone.resetLock();
            return clone;
        } catch (CloneNotSupportedException e) {
            // this shouldn't happen, since we are Cloneable
            throw new InternalError();
        }
    }
    

* * *

4\. CopyOnWriteArraySet æºç åˆ†æ
----------------------------

åœ¨ Java æ ‡å‡†åº“ä¸­ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªä½¿ç”¨ COW æ€æƒ³çš„ Set é›†åˆ â€”â€” CopyOnWriteArraySetã€‚

CopyOnWriteArraySet å’Œ HashSet éƒ½æ˜¯ç»§æ‰¿äº AbstractSet çš„ï¼Œä½† CopyOnWriteArraySet æ˜¯åŸºäº CopyOnWriteArrayList åŠ¨æ€æ•°ç»„çš„ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨å“ˆå¸Œæ€æƒ³ã€‚è€Œ HashSet æ˜¯åŸºäº HashMap æ•£åˆ—è¡¨çš„ï¼Œèƒ½å¤Ÿå®ç° O(1) æŸ¥è¯¢ã€‚

### 4.1 CopyOnWriteArraySet çš„æ„é€ æ–¹æ³•

çœ‹ä¸€ä¸‹ CopyOnWriteArraySet çš„æ„é€ æ–¹æ³•ï¼Œåº•å±‚å°±æ˜¯æœ‰ä¸€ä¸ª CopyOnWriteArrayList åŠ¨æ€æ•°ç»„ã€‚

`CopyOnWriteArraySet.java`

    public class CopyOnWriteArraySet<E> extends AbstractSet<E> implements java.io.Serializable {
        // åº•å±‚å°±æ˜¯ OnWriteArrayList
        private final CopyOnWriteArrayList<E> al;
    
        // æ— å‚æ„é€ æ–¹æ³•
        public CopyOnWriteArraySet() {
            al = new CopyOnWriteArrayList<E>();
        }
    
        // å¸¦é›†åˆçš„æ„é€ æ–¹æ³•
        public CopyOnWriteArraySet(Collection<? extends E> c) {
            if (c.getClass() == CopyOnWriteArraySet.class) {
                // å…¥å‚æ˜¯ CopyOnWriteArraySetï¼Œè¯´æ˜æ˜¯ä¸é‡å¤çš„ï¼Œç›´æ¥æ·»åŠ 
                CopyOnWriteArraySet<E> cc = (CopyOnWriteArraySet<E>)c;
                al = new CopyOnWriteArrayList<E>(cc.al);
            }
            else {
                // ä½¿ç”¨ addAllAbsent æ·»åŠ ä¸é‡å¤çš„å…ƒç´ 
                al = new CopyOnWriteArrayList<E>();
                al.addAllAbsent(c);
            }
        }
    
        public int size() {
            return al.size();
        }
    }
    

### 4.2 CopyOnWriteArraySet çš„æ“ä½œæ–¹æ³•

CopyOnWriteArraySet çš„æ–¹æ³•åŸºæœ¬ä¸Šéƒ½æ˜¯äº¤ç»™ `CopyOnWriteArraySet` ä»£ç†çš„ï¼Œç”±äºæ²¡æœ‰ä½¿ç”¨å“ˆå¸Œæ€æƒ³ï¼Œæ‰€ä»¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ã€‚

`CopyOnWriteArraySet.java`

    public boolean add(E e) {
        return al.addIfAbsent(e);
    }
    
    public boolean contains(Object o) {
        return al.contains(o);
    }
    

`CopyOnWriteArrayList.java`

    public boolean addIfAbsent(E e) {
        Object[] snapshot = getArray();
        return indexOf(e, snapshot, 0, snapshot.length) >= 0 ? false : addIfAbsent(e, snapshot);
    }
    
    public boolean contains(Object o) {
        Object[] elements = getArray();
        return indexOf(o, elements, 0, elements.length) >= 0;
    }
    
    // é€šè¿‡çº¿æ€§æ‰«æåŒ¹é…å…ƒç´ ä½ç½®ï¼Œè€Œä¸æ˜¯è®¡ç®—å“ˆå¸ŒåŒ¹é…ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)
    private static int indexOf(Object o, Object[] elements, int index, int fence) {
        if (o == null) {
            for (int i = index; i < fence; i++)
                if (elements[i] == null) return i;
        } else {
            for (int i = index; i < fence; i++)
                if (o.equals(elements[i])) return i;
        }
        return -1;
    }
    

* * *

5\. æ€»ç»“
------

*   1ã€CopyOnWriteArrayList å’Œ ArrayList éƒ½æ˜¯åŸºäºæ•°ç»„çš„åŠ¨æ€æ•°ç»„ï¼Œå°è£…äº†æ“ä½œæ•°ç»„æ—¶çš„æ¬è¿å’Œæ‰©å®¹ç­‰é€»è¾‘ï¼›
    
*   2ã€CopyOnWriteArrayList è¿˜æ˜¯ â€œè¯»å†™åˆ†ç¦»â€ å’Œ â€œå†™æ—¶å¤åˆ¶â€ çš„æ–¹æ¡ˆè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼›
    
*   3ã€ä½¿ç”¨ CopyOnWriteArrayList çš„åœºæ™¯ä¸€å®šè¦ä¿è¯æ˜¯ â€œè¯»å¤šå†™å°‘â€ ä¸”æ•°æ®é‡ä¸å¤§çš„åœºæ™¯ï¼Œè€Œä¸”åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œè¦åšåˆ°æ‰¹é‡æ“ä½œï¼›
    
*   4ã€CopyOnWriteArrayList çš„è¿­ä»£å™¨æ˜¯ â€œå¼±æ•°æ®ä¸€è‡´æ€§çš„â€ çš„ï¼Œè¿­ä»£å™¨ä¼šæŒæœ‰ â€œåº•å±‚æ•°ç»„â€ çš„å¼•ç”¨ï¼Œè€Œ CopyOnWriteArrayList çš„å†™å…¥æ“ä½œæ˜¯å†™å…¥åˆ°æ–°æ•°ç»„ï¼Œå› æ­¤è¿­ä»£å™¨æ˜¯æ— æ³•æ„ŸçŸ¥åˆ°çš„ï¼›
    
*   5ã€CopyOnWriteArraySet æ˜¯åŸºäº CopyOnWriteArrayList åŠ¨æ€æ•°ç»„çš„ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨å“ˆå¸Œæ€æƒ³ã€‚
    

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤
--------------------

![](https://files.mdnice.com/user/3257/f6f8c422-a362-42ca-bbb9-3c35d2fd95fa.png)