---
layout: post
title: "SpringBoot+MyBatis Pluså¯¹Mapä¸­Dateæ ¼å¼è½¬æ¢çš„å¤„ç†"
date: "2022-10-10T04:45:55.503Z"
---
SpringBoot+MyBatis Pluså¯¹Mapä¸­Dateæ ¼å¼è½¬æ¢çš„å¤„ç†
---------------------------------------

ç°åœ¨çš„å…³ç³»å‹æ•°æ®åº“ä¾‹å¦‚PostgreSQL/MySQL, éƒ½å·²ç»å¯¹ JSON ç±»å‹æä¾›ç›¸å½“ä¸°å¯Œçš„åŠŸèƒ½, é¡¹ç›®ä¸­å¯¹äºä¸éœ€è¦æ£€ç´¢ä½†æ˜¯åˆéœ€è¦ç»“æ„åŒ–çš„å­˜å‚¨, ä¼šåœ¨æ•°æ®åº“ä¸­äº§ç”Ÿå¾ˆå¤š JSON ç±»å‹çš„å­—æ®µ, ä¸ Jackson åšå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–é…åˆéå¸¸æ–¹ä¾¿. å¦‚æœ JSON åœ¨ Java ä»£ç ä¸­æ˜¯å®šä¹‰ä¸ºä¸€ä¸ª Map, ä¾‹å¦‚ Map

åœ¨ SpringBoot é¡¹ç›®ä¸­, å¦‚ä½•ç»Ÿä¸€ JSON æ ¼å¼åŒ–ä¸­çš„æ—¥æœŸæ ¼å¼

é—®é¢˜
==

ç°åœ¨çš„å…³ç³»å‹æ•°æ®åº“ä¾‹å¦‚PostgreSQL/MySQL, éƒ½å·²ç»å¯¹ JSON ç±»å‹æä¾›ç›¸å½“ä¸°å¯Œçš„åŠŸèƒ½, é¡¹ç›®ä¸­å¯¹äºä¸éœ€è¦æ£€ç´¢ä½†æ˜¯åˆéœ€è¦ç»“æ„åŒ–çš„å­˜å‚¨, ä¼šåœ¨æ•°æ®åº“ä¸­äº§ç”Ÿå¾ˆå¤š JSON ç±»å‹çš„å­—æ®µ, ä¸ Jackson åšå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–é…åˆéå¸¸æ–¹ä¾¿.

å¦‚æœ JSON éƒ½æ˜¯ç±»å®šä¹‰çš„, è¿™ä¸ªåºåˆ—åŒ–å’Œååºåˆ—åŒ–å°±éå¸¸é€æ˜ -- ä¸éœ€è¦ä»»ä½•å¹²é¢„, å†™è¿›å»æ˜¯ä»€ä¹ˆ, è¯»å‡ºæ¥å°±æ˜¯ä»€ä¹ˆ. ä½†æ˜¯å¦‚æœ JSON åœ¨ Java ä»£ç ä¸­æ˜¯å®šä¹‰ä¸ºä¸€ä¸ª Map, ä¾‹å¦‚ Map<String, Object> é‚£ä¹ˆå°±æœ‰é—®é¢˜äº†, å¯¹äº Date ç±»å‹çš„æ•°æ®, åœ¨å­˜å…¥ä¹‹å‰æ˜¯ Date, å–å‡ºæ¥ä¹‹åå°±å˜æˆ Long äº†.

    SomePO po = new SomePO();
    //...
    Map<String, Object> map = new HashMap<>();
    map.put("k1", new Date());
    po.setProperties(map);
    //...
    mapper.insert(po);
    //...
    SomePO dummy = mapper.select(po.id);
    // è¿™é‡Œçš„k1å·²ç»å˜æˆäº† Long ç±»å‹
    Object k1 = dummy.getProperties().get("k1");
    

åŸå› 
==

ä¸ç®¡æ˜¯ä½¿ç”¨åŸç”Ÿçš„ MyBatis è¿˜æ˜¯åŒ…è£…åçš„ MyBatis Plus, åœ¨å¯¹ JSON ç±»å‹å­—æ®µè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶, éƒ½éœ€è¦å€ŸåŠ©ç±»å‹åˆ¤æ–­, è°ƒç”¨å¯¹åº”çš„å¤„ç†é€»è¾‘, å¤§éƒ¨åˆ†æƒ…å†µ, ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ Jackson çš„ ObjectMapper, è€Œ ObjectMapper å¯¹ Date ç±»å‹é»˜è®¤çš„åºåˆ—åŒ–æ–¹å¼å°±æ˜¯å–æ—¶é—´æˆ³, å¯¹äºæ—©äº1970å¹´ä¹‹å‰çš„æ—¥æœŸ, ç”Ÿæˆçš„æ˜¯ä¸€ä¸ªè´Ÿçš„é•¿æ•´æ•°, å¯¹äº1970å¹´ä¹‹åçš„æ—¥æœŸ, ç”Ÿæˆçš„æ˜¯ä¸€ä¸ªæ­£çš„é•¿æ•´æ•°.

æŸ¥çœ‹ ObjectMapper çš„æºç , å¯ä»¥çœ‹åˆ°å…¶å¯¹Dateæ ¼å¼çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹å¼è®¾ç½®äº\_serializationConfig å’Œ \_deserializationConfig è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ä¸­, å¯ä»¥é€šè¿‡ setDateFormat() è¿›è¡Œä¿®æ”¹

    public class ObjectMapper extends ObjectCodec implements Versioned, Serializable {
        //...
        protected SerializationConfig _serializationConfig;
        protected DeserializationConfig _deserializationConfig;
        //...
    
        public ObjectMapper setDateFormat(DateFormat dateFormat) {
            this._deserializationConfig = (DeserializationConfig)this._deserializationConfig.with(dateFormat);
            this._serializationConfig = this._serializationConfig.with(dateFormat);
            return this;
        }
    
        public DateFormat getDateFormat() {
            return this._serializationConfig.getDateFormat();
        }
    }
    

é»˜è®¤çš„åºåˆ—åŒ–ååºåˆ—åŒ–é€‰é¡¹, ä½¿ç”¨äº†ä¸€ä¸ªå¸¸é‡ WRITE\_DATES\_AS\_TIMESTAMPS, åœ¨ç±» SerializationConfig ä¸­è¿›è¡Œåˆ¤æ–­, æœªæŒ‡å®šæ—¶ä½¿ç”¨çš„æ˜¯æ—¶é—´æˆ³

    public SerializationConfig with(DateFormat df) {
    	SerializationConfig cfg = (SerializationConfig)super.with(df);
    	return df == null ? cfg.with(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS) : cfg.without(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);
    }
    

å®é™…çš„è½¬æ¢å·¥ä½œåœ¨ SerializerProvider ç±»ä¸­, è½¬æ¢æ–¹æ³•ä¸º

    public final void defaultSerializeDateValue(long timestamp, JsonGenerator gen) throws IOException {
    	if (this.isEnabled(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)) {
    		gen.writeNumber(timestamp);
    	} else {
    		gen.writeString(this._dateFormat().format(new Date(timestamp)));
    	}
    }
    
    public final void defaultSerializeDateValue(Date date, JsonGenerator gen) throws IOException {
    	if (this.isEnabled(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)) {
    		gen.writeNumber(date.getTime());
    	} else {
    		gen.writeString(this._dateFormat().format(date));
    	}
    }
    

è§£å†³
==

å±€éƒ¨æ–¹æ¡ˆ
----

### 1\. å­—æ®µæ³¨è§£

è¿™ç§æ–¹å¼å¯ä»¥ç”¨åœ¨å›ºå®šçš„ç±»æˆå‘˜å˜é‡ä¸Š, ä¸æ”¹å˜æ•´ä½“è¡Œä¸º

    public class Event {
        public String name;
    
        @JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "dd-MM-yyyy hh:mm:ss")
        public Date eventDate;
    }
    

å¦å¤–è¿˜å¯ä»¥è‡ªå®šä¹‰åºåˆ—åŒ–ååºåˆ—åŒ–æ–¹æ³•, å®ç° StdSerializer

    public class CustomDateSerializer extends StdSerializer<Date> {
        //...
    }
    

å°±å¯ä»¥åœ¨ @JsonSerialize æ³¨è§£ä¸­ä½¿ç”¨

    public class Event {
        public String name;
    
        @JsonSerialize(using = CustomDateSerializer.class)
        public Date eventDate;
    }
    

### 2\. ä¿®æ”¹ ObjectMapper

é€šè¿‡ ObjectMapper.setDateFormat() è®¾ç½®æ—¥æœŸæ ¼å¼, æ”¹å˜é»˜è®¤çš„æ—¥æœŸåºåˆ—åŒ–ååºåˆ—åŒ–è¡Œä¸º. è¿™ç§æ–¹å¼åªå¯¹è°ƒç”¨æ­¤ObjectMapperçš„åœºæ™¯æœ‰æ•ˆ

    private static ObjectMapper createObjectMapper() {
    	ObjectMapper objectMapper = new ObjectMapper();
    	SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
    	objectMapper.setDateFormat(df);
    	return objectMapper;
    }
    

å› ä¸º ObjectMapper ä¸€èˆ¬æ˜¯å½“ä½œçº¿ç¨‹å®‰å…¨ä½¿ç”¨çš„, è€Œ SimpleDateFormat å¹¶éçº¿ç¨‹å®‰å…¨, åœ¨è¿™é‡Œä½¿ç”¨æ˜¯å¦ä¼šæœ‰é—®é¢˜? å…³äºè¿™ä¸ªç–‘è™‘, å¯ä»¥æŸ¥çœ‹ [è¿™ä¸ªé“¾æ¥](https://stackoverflow.com/questions/3907929/should-i-declare-jacksons-objectmapper-as-a-static-field)

> @StaxMan: I am a bit concerned if ObjectMapper is still thread-safe after ObjectMapper#setDateFormat() is called. It is known that SimpleDateFormat is not thread safe, thus ObjectMapper won't be unless it clones e.g. SerializationConfig before each writeValue() (I doubt). Could you debunk my fear? â€“ dma\_k Aug 2, 2013 at 12:09

> DateFormat is indeed cloned under the hood. Good suspicion there, but you are covered. ğŸ˜ƒ â€“ StaxMan Aug 2, 2013 at 19:43

### 3\. ä¿®æ”¹ SpringBoot é…ç½®

å¢åŠ é…ç½® `spring.jackson.date-format=yyyy-MM-dd HH:mm:ss`, è¿™ç§é…ç½®, åªå¯¹ Spring BeanFactory ä¸­åˆ›å»ºçš„ Jackson ObjectMapperæœ‰æ•ˆ, ä¾‹å¦‚ HTTP è¯·æ±‚å’Œå“åº”ä¸­å¯¹ Date ç±»å‹çš„è½¬æ¢

    spring:
      ...
      jackson:
        date-format: yyyy-MM-dd HH:mm:ss
    

æ•´ä½“æ–¹æ¡ˆ
----

å›½å†…é¡¹ç›®, å‡ ä¹éƒ½ä¼šå¸Œæœ›è½åº“æ—¶æ—¥æœŸå°±æ˜¯æ—¥æœŸçš„æ ·å­(æ–¹ä¾¿çœ‹æ•°æ®åº“è¡¨), æ‰€è°“æ—¥æœŸçš„æ ·å­å°±æ˜¯`yyyy-MM-dd HH:mm:ss`æ ¼å¼çš„å­—ç¬¦ä¸². å¦‚æœæ€•éº»çƒ¦, å°±é€šé€šéƒ½ç”¨è¿™ä¸ªæ ¼å¼äº†.

è¿™æ ·ç»Ÿä¸€å­˜åœ¨çš„éšæ‚£æ˜¯ä¸¢å¤±æ¯«ç§’éƒ¨åˆ†. è¿™ä¸ªé—®é¢˜ä¸šåŠ¡äººå‘˜åŸºæœ¬ä¸Šæ˜¯ä¸ä¼šå…³å¿ƒçš„. å¦‚æœéœ€è¦, å°±åœ¨æ ¼å¼ä¸­åŠ ä¸Š.

ç¬¬ä¸€æ˜¯ Spring é…ç½®, è¿™æ ·æ‰€æœ‰çš„è¯·æ±‚å“åº”éƒ½ç»Ÿä¸€äº†

    spring:
      ...
      jackson:
        date-format: yyyy-MM-dd HH:mm:ss
    

ç¬¬äºŒæ˜¯å®šä¹‰ä¸€ä¸ªå·¥å…·ç±», æŠŠ ObjectMapper è‡ªå®šä¹‰ä¸€ä¸‹, è¿™æ ·æ‰€æœ‰æ‰‹å·¥è½¬æ¢çš„åœ°æ–¹ä¹Ÿç»Ÿä¸€äº†, æ³¨æ„ç•™ä¸€ä¸ªgetObjectMapper()æ–¹æ³•

    public class JacksonUtil {
        private static final Logger log = LoggerFactory.getLogger(JacksonUtil.class);
        private static final ObjectMapper MAPPER = createObjectMapper();
        private JacksonUtil() {}
    
        private static ObjectMapper createObjectMapper() {
            ObjectMapper objectMapper = new ObjectMapper();
            objectMapper.configure(JsonGenerator.Feature.AUTO_CLOSE_TARGET, false);
            objectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);
            SimpleDateFormat df = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
            objectMapper.setDateFormat(df);
            return objectMapper;
        }
    
        public static ObjectMapper getObjectMapper() {
            return MAPPER;
        }
    }
    

ç¬¬ä¸‰æ˜¯å¯åŠ¨åä¿®æ”¹ MyBatisPlus çš„è®¾ç½®, å³ä¸‹é¢çš„ changeObjectMapper() è¿™ä¸ªæ–¹æ³•, ç›´æ¥æ¢æˆäº†ä¸Šé¢å·¥å…·ç±»ä¸­å®šä¹‰çš„ ObjectMapper, è¿™æ ·åœ¨ MyBatis è¯»å†™æ•°æ®åº“æ—¶çš„æ ¼å¼ä¹Ÿç»Ÿä¸€äº†.

    @Configuration
    @MapperScan(basePackages = {"com.somewhere.commons.impl.mapper"})
    public class MybatisPlusConfig {
    
        @Bean
        public MybatisPlusInterceptor mybatisPlusInterceptor() {
            MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
            interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.POSTGRE_SQL));
            interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
            return interceptor;
        }
    
        @PostConstruct
        public void changeObjectMapper() {
            // This will unify the date format with util methods
            JacksonTypeHandler.setObjectMapper(JacksonUtil.getObjectMapper());
        }
    }
    

å‚è€ƒ
==

*   [https://www.baeldung.com/jackson-serialize-dates](https://www.baeldung.com/jackson-serialize-dates)

posted on 2022-10-10 10:31Â  [Milton](https://www.cnblogs.com/milton/)Â  é˜…è¯»(0)Â  è¯„è®º(0)Â  [ç¼–è¾‘](https://i.cnblogs.com/EditPosts.aspx?postid=16774777)Â  [æ”¶è—](javascript:void(0))Â  [ä¸¾æŠ¥](javascript:void(0))