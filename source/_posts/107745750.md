---
layout: post
title: ".NET Core MongoDBæ•°æ®ä»“å‚¨å’Œå·¥ä½œå•å…ƒæ¨¡å¼å®æ“"
date: "2023-04-11T01:05:03.692Z"
---
.NET Core MongoDBæ•°æ®ä»“å‚¨å’Œå·¥ä½œå•å…ƒæ¨¡å¼å®æ“
==============================

å‰è¨€
--

ã€€ã€€ä¸Šä¸€ç« èŠ‚æˆ‘ä»¬ä¸»è¦è®²è§£äº†MongoDBæ•°æ®ä»“å‚¨å’Œå·¥ä½œå•å…ƒæ¨¡å¼çš„å°è£…ï¼Œè¿™ä¸€ç« èŠ‚ä¸»è¦è®²çš„æ˜¯MongoDBç”¨æˆ·ç®¡ç†ç›¸å…³æ“ä½œå®æ“ã€‚å¦‚ï¼šè·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ã€è·å–ç”¨æˆ·åˆ†é¡µæ•°æ®ã€é€šè¿‡ç”¨æˆ·IDè·å–å¯¹åº”ç”¨æˆ·ä¿¡æ¯ã€æ·»åŠ ç”¨æˆ·ä¿¡æ¯ã€äº‹åŠ¡æ·»åŠ ç”¨æˆ·ä¿¡æ¯ã€ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹ã€ç”¨æˆ·ä¿¡æ¯åˆ é™¤ç­‰å®æˆ˜æ•™ç¨‹ã€‚

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230407222549553-1063502695.png)

MongoDBä»å…¥é—¨åˆ°å®æˆ˜çš„ç›¸å…³æ•™ç¨‹
------------------

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹MongoDBç®€ä»‹ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/16797608.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹MongoDBå¿«é€Ÿå…¥é—¨ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/16804415.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹Dockerå¿«é€Ÿå®‰è£…MongoDBğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/16838976.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹MongoDBå·¥ä½œå¸¸ç”¨æ“ä½œå‘½ä»¤ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/16840085.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹.NET Coreä½¿ç”¨MongoDBå¼€å‘ToDoListç³»ç»Ÿï¼ˆ1ï¼‰-åç«¯é¡¹ç›®æ¡†æ¶æ­å»ºğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/17020707.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹.NET Coreä½¿ç”¨MongoDBå¼€å‘ToDoListç³»ç»Ÿï¼ˆ2ï¼‰-Swaggeræ¡†æ¶é›†æˆğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/17020885.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹.NET Coreä½¿ç”¨MongoDBå¼€å‘ToDoListç³»ç»Ÿï¼ˆ3ï¼‰-ç³»ç»Ÿæ•°æ®é›†åˆè®¾è®¡ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/17033785.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹.NET Coreä½¿ç”¨MongoDBå¼€å‘ToDoListç³»ç»Ÿï¼ˆ4ï¼‰-MongoDBæ•°æ®ä»“å‚¨å’Œå·¥ä½œå•å…ƒæ¨¡å¼å°è£…ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/17157135.html)

[MongoDBä»å…¥é—¨åˆ°å®æˆ˜ä¹‹.NET Coreä½¿ç”¨MongoDBå¼€å‘ToDoListç³»ç»Ÿï¼ˆ5ï¼‰-MongoDBæ•°æ®ä»“å‚¨å’Œå·¥ä½œå•å…ƒæ¨¡å¼å®æ“ğŸ‘‰](https://www.cnblogs.com/Can-daydayup/p/17294749.html)

YyFlight.ToDoListé¡¹ç›®æºç åœ°å€
-----------------------

**æ¬¢è¿å„ä½çœ‹å®˜è€çˆ·reviewï¼Œæœ‰å¸®åŠ©çš„åˆ«å¿˜äº†ç»™æˆ‘ä¸ªStarå“¦ğŸ’–ï¼ï¼ï¼**

> GitHubåœ°å€ï¼š[https://github.com/YSGStudyHards/YyFlight.ToDoList](https://github.com/YSGStudyHards/YyFlight.ToDoList)
> 
> MongoRepositoryåœ°å€ï¼š[https://github.com/YSGStudyHards/YyFlight.ToDoList/tree/main/Repository/Repository](https://github.com/YSGStudyHards/YyFlight.ToDoList/tree/main/Repository/Repository)

MongoDBäº‹åŠ¡ä½¿ç”¨å‰æè¯´æ˜
---------------

[å‚é˜…MongoDBçš„äº‹åŠ¡](https://mongodb.github.io/mongo-csharp-driver/2.12/reference/driver/crud/sessions_and_transactions/)

**è¯´æ˜ï¼š**

> MongoDBå•æœºæœåŠ¡å™¨ä¸æ”¯æŒäº‹åŠ¡ã€ä½¿ç”¨MongoDBäº‹åŠ¡ä¼šæŠ¥é”™ï¼šStandalone servers do not support transactionsã€‘,åªæœ‰åœ¨é›†ç¾¤æƒ…å†µä¸‹æ‰æ”¯æŒäº‹åŠ¡ï¼Œå› ä¸ºåšä¸»æ¥ä¸‹æ¥éƒ½æ˜¯åœ¨å•æœºç¯å¢ƒä¸‹æ“ä½œï¼Œæ‰€ä»¥æ— æ³•æ¥æ¼”ç¤ºMongoäº‹åŠ¡æ“ä½œï¼Œä½†æ˜¯æ–¹æ³•éƒ½å·²ç»æ˜¯å°è£…å¥½äº†çš„ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±æ­å»ºé›†ç¾¤å®æ“ã€‚

**åŸå› ï¼š**

> MongoDBåœ¨ä½¿ç”¨åˆ†å¸ƒå¼äº‹åŠ¡æ—¶éœ€è¦è¿›è¡Œå¤šèŠ‚ç‚¹ä¹‹é—´çš„åè°ƒå’Œé€šä¿¡ï¼Œè€Œå•æœºç¯å¢ƒä¸‹æ— æ³•å®ç°è¿™æ ·çš„åˆ†å¸ƒå¼åè°ƒå’Œé€šä¿¡æœºåˆ¶ã€‚ä½†æ˜¯ï¼Œåœ¨MongoDBéƒ¨ç½²ä¸ºä¸€ä¸ªé›†ç¾¤ï¼ˆclusterï¼‰åï¼Œå°†å¤šä¸ªè®¡ç®—æœºè¿æ¥ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œé€šè¿‡åè°ƒå’Œé€šä¿¡æœºåˆ¶å®ç°äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„æ­£å¸¸ä½¿ç”¨ã€‚ä»æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§çš„è§’åº¦æ¥çœ‹ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å®ç°äº‹åŠ¡å¤„ç†æ˜¯è‡³å…³é‡è¦çš„ã€‚è€Œåœ¨å•æœºç¯å¢ƒä¸‹ä¸æ”¯æŒäº‹åŠ¡ï¼Œåªæœ‰åœ¨é›†ç¾¤æƒ…å†µä¸‹æ‰æ”¯æŒäº‹åŠ¡çš„è®¾è®¡æ–¹å¼æ˜¯ä¸ºäº†ä¿è¯æ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§ï¼Œå¹¶ä¸”ä¹Ÿç¬¦åˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„è®¾è®¡æ€æƒ³ã€‚

åˆ›å»ºEntityBaseå…¬å…±ç±»
---------------

> ä¸€ä¸ªå…¬å…±çš„å…·æœ‰ç›¸åŒç‰¹æ€§å’Œè¡Œä¸ºçš„åŸºç±»ã€‚

    public class EntityBase
    {
        /// <summary>
        /// ä¸»é”®Id
        /// </summary>
        \[BsonId\]
        \[BsonRepresentation(BsonType.ObjectId)\]
        public string Id { get; set; }

        /// <summary>
        /// åˆ›å»ºæ—¶é—´
        /// </summary>
        public DateTime CreateDate { get; set; }

        /// <summary>
        /// æ›´æ–°æ—¶é—´
        /// </summary>
        public DateTime UpdateDate { get; set; }
    }

æ·»åŠ UserInfoç”¨æˆ·è¡¨å®ä½“æ˜ å°„æ¨¡å‹
-------------------

    \[Table("yyflight\_todolist\_user")\]
    public class UserInfo : EntityBase
    {
        /// <summary>
        /// ç™»å½•è´¦å·
        /// </summary>
        public string UserName { get; set; }

        /// <summary>
        /// ç™»å½•å¯†ç 
        /// </summary>

        public string Password { get; set; }

        /// <summary>
        /// ç”¨æˆ·æ˜µç§°
        /// </summary>
        public string NickName { get; set; }

        /// <summary>
        /// ç”¨æˆ·å¤´åƒ
        /// </summary>
        public string HeadPortrait { get; set; }

        /// <summary>
        /// ç”¨æˆ·é‚®ç®±
        /// </summary>
        public string Email { get; set; }

        /// <summary>
        /// ç”¨æˆ·çŠ¶æ€ï¼ˆ0å†»ç»“ï¼Œ1æ­£å¸¸ï¼Œ2æ³¨é”€ï¼‰
        /// </summary>
        public int Status { get; set; }
    }

åœ¨å‰é¢ç±»ä¸­ï¼ŒIdå±æ€§ä¸­çš„ç‰¹æ€§çš„ä½œç”¨ï¼š

*   éœ€è¦ç”¨äºå°†é€šç”¨è¯­è¨€è¿è¡Œæ—¶ï¼ˆCLRï¼‰å¯¹è±¡æ˜ å°„åˆ°MongoDBé›†åˆã€‚
*   ç”¨[\[BsonId\]](https://mongodb.github.io/mongo-csharp-driver/2.14/apidocs/html/T_MongoDB_Bson_Serialization_Attributes_BsonIdAttribute.htm)è¿›è¡Œæ³¨é‡Šï¼Œä½¿è¯¥å±æ€§æˆä¸ºæ–‡æ¡£çš„ä¸»é”®ã€‚
*   ç”¨[\[BsonRepresentation(BsonType.ObjectId)\]](https://mongodb.github.io/mongo-csharp-driver/2.14/apidocs/html/T_MongoDB_Bson_Serialization_Attributes_BsonRepresentationAttribute.htm)è¿›è¡Œæ³¨é‡Šï¼Œä»¥å…è®¸ä»¥å­—ç¬¦ä¸²ç±»å‹è€Œä¸æ˜¯ObjectIdç»“æ„ä¼ é€’å‚æ•°ã€‚Mongoå¤„ç†ä»å­—ç¬¦ä¸²åˆ°ObjectIdçš„è½¬æ¢ã€‚æ²¡æœ‰æ­¤ç‰¹æ€§åºåˆ—åŒ–æ—¶ä¼šæœ‰å¦‚ä¸‹å¼‚å¸¸æç¤ºï¼š

> System.FormatException: An error occurred while deserializing the Id property of class Repository.Domain.User.UserInfo: Cannot deserialize a 'String' from BsonType 'ObjectId'.

#### çŸ¥è¯†æ‹“å±•MongoDB ObjectIdç±»å‹æ¦‚è¿°ï¼š

> æ¯æ¬¡æ’å…¥ä¸€æ¡æ•°æ®ç³»ç»Ÿéƒ½ä¼šè‡ªåŠ¨æ’å…¥ä¸€ä¸ª\_idé”®ï¼Œé”®å€¼ä¸å¯ä»¥é‡å¤ï¼Œå®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨çš„æ’å…¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å®ƒçš„æ•°æ®ç±»å‹æ˜¯ObjectIdï¼Œç”±äºMongoDBåœ¨è®¾è®¡ä¹‹åˆå°±æ˜¯ç”¨ä½œåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œæ‰€ä»¥ä½¿ç”¨ObjectIdå¯ä»¥é¿å…ä¸åŒæ•°æ®åº“ä¸­\_idçš„é‡å¤ï¼ˆå¦‚æœä½¿ç”¨è‡ªå¢çš„æ–¹å¼åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å°±ä¼šå‡ºç°é‡å¤çš„\_idçš„å€¼ï¼‰ã€‚  
> ObjectIdä½¿ç”¨12å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œæ¯ä¸ªå­—èŠ‚å¯ä»¥å­˜å‚¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—ï¼Œæ‰€ä»¥ä¸€å…±å¯ä»¥å­˜å‚¨24ä¸ªåå…­è¿›åˆ¶æ•°å­—ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œåœ¨è¿™24ä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œå‰8ä½è¡¨ç¤ºæ—¶é—´æˆ³ï¼Œæ¥ä¸‹æ¥6ä½æ˜¯ä¸€ä¸ªæœºå™¨ç ï¼Œæ¥ä¸‹æ¥4ä½è¡¨ç¤ºè¿›ç¨‹idï¼Œæœ€å6ä½è¡¨ç¤ºè®¡æ•°å™¨ã€‚

MongoDB é‡‡ç”¨ ObjectId æ¥è¡¨ç¤ºä¸»é”®çš„ç±»å‹ï¼Œæ•°æ®åº“ä¸­æ¯ä¸ªæ–‡æ¡£éƒ½æ‹¥æœ‰ä¸€ä¸ª\_id å­—æ®µè¡¨ç¤ºä¸»é”®ï¼Œ\_id çš„ç”Ÿæˆè§„åˆ™å¦‚ä¸‹ï¼š

> å…¶ä¸­åŒ…æ‹¬4-byte Unix æ—¶é—´æˆ³ï¼Œ3-byte æœºå™¨ IDï¼Œ2-byte è¿›ç¨‹ IDï¼Œ3-byte è®¡æ•°å™¨(åˆå§‹åŒ–éšæœº)

![](https://img2023.cnblogs.com/blog/1336199/202303/1336199-20230327213834087-2092438723.png)

601e2b6b  a3203c  c89f   2d31aa
   â†‘        â†‘       â†‘       â†‘
 æ—¶é—´æˆ³    æœºå™¨ç    è¿›ç¨‹ID   éšæœºæ•°ã€€

åˆ›å»ºç”¨æˆ·Repository
--------------

### åˆ›å»ºç”¨æˆ·IUserRepositoryæ¥å£

    public interface IUserRepository : IMongoRepository<UserInfo>
    {
    }

### åˆ›å»ºç”¨æˆ·UserRepositoryç±»

    public class UserRepository : MongoBaseRepository<UserInfo>, IUserRepository
    {
        public UserRepository(IMongoContext context) : base(context)
        {
        }
    }

åˆ›å»ºç”¨æˆ·ç®¡ç†ä¸šåŠ¡ä»£ç 
----------

### åˆ›å»ºIUserOperationExampleServicesæ¥å£

    public interface IUserOperationExampleServices
    {
        /// <summary>
        /// è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <returns></returns>
        Task<IEnumerable<UserInfo>> GetAllUserInfos();

        /// <summary>
        /// ç”¨æˆ·åˆ†é¡µæ•°æ®è·å–
        /// </summary>
        /// <param name="userInfoByPageListReq">userInfoByPageListReq</param>
        /// <returns></returns>
        Task<IEnumerable<UserInfo>> GetUserInfoByPageList(UserInfoByPageListReq userInfoByPageListReq);

        /// <summary>
        /// é€šè¿‡ç”¨æˆ·IDè·å–å¯¹åº”ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="id">id</param>
        /// <returns></returns>
        Task<UserInfo> GetUserInfoById(string id);

        /// <summary>
        /// æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        Task<UserInfo> AddUserInfo(UserInfoReq userInfo);

        /// <summary>
        /// äº‹åŠ¡æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        Task<UserInfo> AddUserInfoTransactions(UserInfoReq userInfo);

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹
        /// </summary>
        /// <param name="id">id</param>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        Task<UserInfo> UpdateUserInfo(string id, UserInfoReq userInfo);

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯åˆ é™¤
        /// </summary>
        /// <param name="id">id</param>
        /// <returns></returns>
        Task<bool\> Delete(string id);
    }

### åˆ›å»ºUserOperationExampleServicesç±»

    public class UserOperationExampleServices : IUserOperationExampleServices
    {
        private readonly IUnitOfWork \_unitOfWork;
        private readonly IUserRepository \_userRepository;

        /// <summary>
        /// ä¾èµ–æ³¨å…¥
        /// </summary>
        /// <param name="unitOfWork">unitOfWork</param>
        /// <param name="userRepository">userRepository</param>
        public UserOperationExampleServices(IUnitOfWork unitOfWork, IUserRepository userRepository)
        {
            \_unitOfWork \= unitOfWork;
            \_userRepository \= userRepository;
        }

        /// <summary>
        /// è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <returns></returns>
        public async Task<IEnumerable<UserInfo>> GetAllUserInfos()
        {
            var getAllUserInfos = await \_userRepository.GetAllAsync();
            return getAllUserInfos;
        }

        /// <summary>
        /// ç”¨æˆ·åˆ†é¡µæ•°æ®è·å–
        /// </summary>
        /// <param name="userInfoByPageListReq">userInfoByPageListReq</param>
        /// <returns></returns>
        public async Task<IEnumerable<UserInfo>> GetUserInfoByPageList(UserInfoByPageListReq request)
        {
            //åˆ›å»ºæŸ¥è¯¢æ¡ä»¶æ„é€ å™¨
            FilterDefinitionBuilder<UserInfo> buildFilter = Builders<UserInfo>.Filter;
            FilterDefinition<UserInfo> filter = buildFilter.Empty;
            SortDefinition<UserInfo> sort = Builders<UserInfo>.Sort.Ascending(m => m.CreateDate);
            if (!string.IsNullOrEmpty(request.NickName))
            {
                filter \= buildFilter.Eq(m => m.NickName, request.NickName);
            }

            if (!string.IsNullOrEmpty(request.Id))
            {
                filter \= buildFilter.Eq(m => m.Id, request.Id);
            }

            var list = await \_userRepository.FindListByPageAsync(filter, request.PageIndex, request.PageSize, Array.Empty<string\>(), sort);
            return list;
        }

        /// <summary>
        /// é€šè¿‡ç”¨æˆ·IDè·å–å¯¹åº”ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="id">id</param>
        /// <returns></returns>
        public async Task<UserInfo> GetUserInfoById(string id)
        {
            var getUserInfo = await \_userRepository.GetByIdAsync(id);
            return getUserInfo;
        }

        /// <summary>
        /// æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        public async Task<UserInfo> AddUserInfo(UserInfoReq userInfo)
        {
            var addUserInfo = new UserInfo()
            {
                Id \= ObjectId.GenerateNewId().ToString(),
                UserName \= userInfo.UserName,
                Email \= userInfo.Email,
                NickName \= userInfo.NickName,
                Password \= MD5Helper.MDString(userInfo.Password),
                Status \= 1,
                HeadPortrait \= userInfo.HeadPortrait,
                CreateDate \= DateTime.Now,
                UpdateDate \= DateTime.Now,
            };
            await \_userRepository.AddAsync(addUserInfo);
            var queryUserInfo = await \_userRepository.GetByIdAsync(addUserInfo.Id);
            return queryUserInfo;
        }

        /// <summary>
        /// äº‹åŠ¡æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        public async Task<UserInfo> AddUserInfoTransactions(UserInfoReq userInfo)
        {
            using var session = await \_unitOfWork.InitTransaction();
            var addUserInfo = new UserInfo()
            {
                Id \= ObjectId.GenerateNewId().ToString(),
                UserName \= userInfo.UserName,
                Email \= userInfo.Email,
                NickName \= userInfo.NickName,
                Password \= MD5Helper.MDString(userInfo.Password),
                Status \= 1,
                HeadPortrait \= userInfo.HeadPortrait,
                CreateDate \= DateTime.Now,
                UpdateDate \= DateTime.Now,
            };
            await \_userRepository.AddTransactionsAsync(session, addUserInfo);

            //æŸ¥ä¸åˆ°ä»»ä½•ä¿¡æ¯
            var queryUserInfo = await \_userRepository.GetByIdAsync(addUserInfo.Id);

            //æäº¤æ–°å¢ç”¨æˆ·ä¿¡æ¯æ“ä½œ
            await \_unitOfWork.Commit(session);

            //UserInfoåªæœ‰åœ¨æäº¤åæ‰ä¼šè¢«æ·»åŠ 
            queryUserInfo = await \_userRepository.GetByIdAsync(addUserInfo.Id);

            return queryUserInfo;
        }

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹
        /// </summary>
        /// <param name="id">id</param>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        public async Task<UserInfo> UpdateUserInfo(string id, UserInfoReq userInfo)
        {
            #region æŒ‡å®šå­—æ®µå’Œæ¡ä»¶ä¿®æ”¹

            //ä¿®æ”¹æ¡ä»¶
            var list = new List<FilterDefinition<UserInfo>>
            {
                Builders<UserInfo>.Filter.Eq("\_id", new ObjectId(id))
            };
            var filter = Builders<UserInfo>.Filter.And(list);

            //æŒ‡å®šè¦ä¿®æ”¹çš„å­—æ®µå†…å®¹
            //å‚è€ƒæ–‡ç« ï¼šhttps://chsakell.gitbook.io/mongodb-csharp-docs/crud-basics/update-documents
            var updateDefinition = Builders<UserInfo>.Update.
                Set(u \=> u.HeadPortrait, userInfo.HeadPortrait).
                Set(u \=> u.NickName, userInfo.NickName).
                Set(u \=> u.Status, userInfo.Status);

            await \_userRepository.UpdateAsync(filter, updateDefinition);

            #endregion

            #region æŒ‡å®šå¯¹è±¡å¼‚æ­¥ä¿®æ”¹ä¸€æ¡æ•°æ®

            //var updateUserInfo = new UserInfo
            //{
            //    UserName = userInfo.UserName,
            //    Password = MD5Helper.MDString(userInfo.Password),
            //    Status = 1,
            //    HeadPortrait = userInfo.HeadPortrait,
            //    Email = userInfo.Email,
            //    NickName = userInfo.NickName,
            //    UpdateDate = DateTime.Now,
            //};
            //await \_userRepository.UpdateAsync(updateUserInfo, id);

            #endregion

            #region æ•°æ®æ‰¹é‡ä¿®æ”¹ç¤ºä¾‹

            ////1.æ‰¹é‡ä¿®æ”¹çš„æ¡ä»¶(æŠŠåˆ›å»ºæ—¶é—´CreateDateä¸ºè¿‘äº”æ—¥çš„ç”¨æˆ·çŠ¶æ€æ›´æ”¹ä¸º0)
            //var time = DateTime.Now;
            //var list = new List<FilterDefinition<UserInfo>>();
            //list.Add(Builders<UserInfo>.Filter.Gt("CreateDate", time));//å¤§äºå½“å‰æ—¶é—´
            //list.Add(Builders<UserInfo>.Filter.Lt("CreateDate", time.AddDays(5)));//å°äºå½“å‰æ—¶é—´+5day
            //var filter = Builders<UserInfo>.Filter.And(list);

            ////2.è¦ä¿®æ”¹çš„å­—æ®µå†…å®¹
            //var dic = new Dictionary<string, string>
            //{
            //    { "Status", "0" }
            //};

            ////3.æ‰¹é‡ä¿®æ”¹
            //await \_userRepository.UpdateManayAsync(dic, filter);

            #endregion

            return await \_userRepository.GetByIdAsync(id);
        }

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯åˆ é™¤
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public async Task<bool\> Delete(string id)
        {
            await \_userRepository.DeleteAsync(id);
            var testUserInfo = await \_userRepository.GetByIdAsync(id);
            return testUserInfo == null;
        }
    }

UserOperationExampleæ§åˆ¶åˆ›å»º
------------------------

    /// <summary>
    /// MongoDBç”¨æˆ·ç®¡ç†æ“ä½œç¤ºä¾‹
    /// </summary>
    \[ApiController\]
    \[Produces("application/json")\]
    \[Route("api/\[controller\]/\[action\]")\]
    public class UserOperationExampleController : ControllerBase
    {
        private readonly IUserOperationExampleServices \_userOperationExampleServices;

        /// <summary>
        /// ä¾èµ–æ³¨å…¥
        /// </summary>
        /// <param name="userOperationExampleServices">userOperationExampleServices</param>
        public UserOperationExampleController(IUserOperationExampleServices userOperationExampleServices)
        {
            \_userOperationExampleServices \= userOperationExampleServices;
        }

        /// <summary>
        /// è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <returns></returns>
        \[HttpGet\]
        public async Task<ActionResult<IEnumerable<UserInfo>>> GetAllUserInfos()
        {
            var userInfos = await \_userOperationExampleServices.GetAllUserInfos();
            return Ok(userInfos);
        }

        /// <summary>
        /// è·å–ç”¨æˆ·åˆ†é¡µæ•°æ®
        /// </summary>
        /// <param name="userInfoByPageListReq">userInfoByPageListReq</param>
        /// <returns></returns>
        \[HttpPost\]
        public async Task<ActionResult<IEnumerable<UserInfo>>> GetUserInfoByPageList(\[FromBody\] UserInfoByPageListReq userInfoByPageListReq)
        {
            var getUserInfoByPageList = await \_userOperationExampleServices.GetUserInfoByPageList(userInfoByPageListReq);
            return Ok(getUserInfoByPageList);
        }

        /// <summary>
        /// é€šè¿‡ç”¨æˆ·IDè·å–å¯¹åº”ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="id">id</param>
        /// <returns></returns>
        \[HttpGet("{id}")\]
        public async Task<ActionResult<UserInfo>> GetUserInfoById(string id)
        {
            var userInfo = await \_userOperationExampleServices.GetUserInfoById(id);
            return Ok(userInfo);
        }

        /// <summary>
        /// æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        \[HttpPost\]
        public async Task<ActionResult<UserInfo>> AddUserInfo(\[FromBody\] UserInfoReq userInfo)
        {
            var addUserInfo = await \_userOperationExampleServices.AddUserInfo(userInfo);
            return Ok(addUserInfo);
        }

        /// <summary>
        /// äº‹åŠ¡æ·»åŠ ç”¨æˆ·ä¿¡æ¯
        /// </summary>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        \[HttpPost\]
        public async Task<ActionResult<UserInfo>> AddUserInfoTransactions(\[FromBody\] UserInfoReq userInfo)
        {
            //TODO:å•æœºæœåŠ¡å™¨ä¸æ”¯æŒäº‹åŠ¡ä½¿ç”¨ã€ä½¿ç”¨MongoDBäº‹åŠ¡ä¼šæŠ¥é”™ï¼šStandalone servers do not support transactionsã€‘,åªæœ‰åœ¨é›†ç¾¤æƒ…å†µä¸‹æ‰èƒ½ç”¨
            var addUserInfo = await \_userOperationExampleServices.AddUserInfoTransactions(userInfo);
            return Ok(addUserInfo);
        }

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹
        /// </summary>
        /// <param name="id">id</param>
        /// <param name="userInfo">userInfo</param>
        /// <returns></returns>
        \[HttpPut("{id}")\]
        public async Task<ActionResult<UserInfo>> UpdateUserInfo(string id, \[FromBody\] UserInfoReq userInfo)
        {
            var updateUserInfo = await \_userOperationExampleServices.UpdateUserInfo(id, userInfo);
            return Ok(updateUserInfo);
        }

        /// <summary>
        /// ç”¨æˆ·ä¿¡æ¯åˆ é™¤
        /// </summary>
        /// <param name="id">id</param>
        /// <returns></returns>
        \[HttpDelete("{id}")\]
        public async Task<ActionResult> Delete(string id)
        {
            var deleteUser = await \_userOperationExampleServices.Delete(id);
            return Ok(deleteUser);
        }
    }

æ³¨å†Œæ•°æ®åº“åŸºç¡€æ“ä½œå’Œå·¥ä½œå•å…ƒ
--------------

//æ³¨å†Œæ•°æ®åº“åŸºç¡€æ“ä½œå’Œå·¥ä½œå•å…ƒ
builder.Services.AddScoped<IMongoContext, MongoContext>();
builder.Services.AddScoped<IUnitOfWork, UnitOfWork>();
builder.Services.AddScoped<IUserRepository, UserRepository>();

æ³¨å†Œç›¸å…³åº”ç”¨æœåŠ¡
--------

builder.Services.AddScoped<IUserOperationExampleServices, UserOperationExampleServices>();

Swaggerç”¨æˆ·ç®¡ç†æ“ä½œç¤ºä¾‹å±•ç¤º
-----------------

### æ·»åŠ ç”¨æˆ·ä¿¡æ¯

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408120434744-1491332643.png)

Â **æ·»åŠ æˆåŠŸï¼Œè¿”å›æ·»åŠ æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ï¼š**

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408120512409-1982768734.png)

### é€šè¿‡ç”¨æˆ·IDè·å–å¯¹åº”ç”¨æˆ·ä¿¡æ¯

**æ‹¿åˆšæ‰æ·»åŠ æˆåŠŸçš„ç”¨æˆ·IDï¼ŒæŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼š**

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408120726974-1583274111.png)

### è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408120902608-731171977.png)

### ç”¨æˆ·åˆ†é¡µæ•°æ®è·å–

æŸ¥è¯¢ç¬¬1é¡µï¼Œæ˜¾ç¤º10æ¡æ•°æ®ï¼š

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408121533855-194645817.png)

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408121554091-1666337051.png)

æŸ¥è¯¢ç¬¬1é¡µï¼Œæ˜¾ç¤º2æ¡æ•°æ®ï¼š

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408121126893-1440857254.png)

Â ![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408121312356-545452564.png)

### Â ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹

æŒ‡å®šè¦ä¿®æ”¹çš„å­—æ®µå†…å®¹ï¼Œä¿®æ”¹HeadPortraitã€NickNameã€Status  
å‚è€ƒæ–‡ç« ï¼š[https://chsakell.gitbook.io/mongodb-csharp-docs/crud-basics/update-documents](https://chsakell.gitbook.io/mongodb-csharp-docs/crud-basics/update-documents)

Â ![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408122109316-2104963625.png)

Â ä¿®æ”¹æˆåŠŸï¼š

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408122144945-1298530128.png)

### ç”¨æˆ·ä¿¡æ¯åˆ é™¤

è¾“å…¥éœ€è¦åˆ é™¤çš„ç”¨æˆ·IDï¼Œç‚¹å‡»Executeåˆ é™¤ï¼š

![](https://img2023.cnblogs.com/blog/1336199/202304/1336199-20230408122346136-1247492688.png)

> ä½œè€…ï¼š[è¿½é€æ—¶å…‰è€…](https://www.cnblogs.com/Can-daydayup/)
> 
> ä½œè€…ç®€ä»‹ï¼šä¸€ä¸ªçƒ­çˆ±ç¼–ç¨‹ï¼Œå–„äºåˆ†äº«ï¼Œå–œæ¬¢å­¦ä¹ ã€æ¢ç´¢ã€å°è¯•æ–°äº‹ç‰©ï¼Œæ–°æŠ€æœ¯çš„ç¨‹åºçŒ¿ã€‚
> 
> æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…å’Œåšå®¢å›­å…±æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚å¦‚æœè¯¥ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©çš„è¯ï¼Œå¯ä»¥ç‚¹ä¸€ä¸‹å³ä¸‹è§’çš„[ã€â™¥æ¨èâ™¥ã€‘](javascript:void(0))ï¼Œå¸Œæœ›èƒ½å¤ŸæŒç»­çš„ä¸ºå¤§å®¶å¸¦æ¥å¥½çš„æŠ€æœ¯æ–‡ç« ï¼Œæ–‡ä¸­å¯èƒ½å­˜åœ¨æè¿°ä¸æ­£ç¡®æˆ–é”™è¯¯çš„åœ°æ–¹ï¼Œæ¬¢è¿æŒ‡æ­£ã€è¡¥å……ï¼Œä¸èƒœæ„Ÿæ¿€ ï¼