---
layout: post
title: "Blazor ä½¿ç”¨æ‹–æ”¾ï¼ˆdrag and dropï¼‰ä¸Šä¼ æ–‡ä»¶ , ç²˜è´´æ–‡ä»¶ä¸Šä¼ "
date: "2022-04-11T01:23:52.508Z"
---
Blazor ä½¿ç”¨æ‹–æ”¾ï¼ˆdrag and dropï¼‰ä¸Šä¼ æ–‡ä»¶ , ç²˜è´´æ–‡ä»¶ä¸Šä¼ 
=======================================

### åœ¨å¾ˆå¤šä¸Šä¼ æ–‡ä»¶çš„åº”ç”¨å®ä¾‹ä¸­, éƒ½å¯ä»¥çœ‹åˆ°\[æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤ä¸Šä¼ \]è¿™ç§éªšåŠŸèƒ½ ,ä»Šå¤©æˆ‘ä»¬å°±æ¥è¯•è¯•Blazorèƒ½ä¸èƒ½å®Œæˆè¿™ä¸ªæƒ³æ³•.

åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/densen2014/p/16128246.html](https://www.cnblogs.com/densen2014/p/16128246.html)

ç®€è¿°HTML5æ‹–æ”¾
---------

æ‹–æ”¾æ˜¯HTML5æ ‡å‡†çš„ä¸€éƒ¨åˆ†ï¼Œä»»ä½•å…ƒç´ éƒ½èƒ½å¤Ÿæ‹–æ”¾ï¼Œä¹Ÿèƒ½å¤Ÿå°†æœ¬åœ°çš„æ–‡ä»¶æ‹–æ”¾åˆ°é¡µé¢ä¸Šã€‚

### è®¾ç½®å…ƒç´ å¯æ‹–æ”¾

ä¸ºäº†ä½¿å…ƒç´ å¯æ‹–åŠ¨ï¼ŒæŠŠ draggable å±æ€§è®¾ç½®ä¸º true

    <img draggable="true" />
    

### æ‹–æ”¾äº‹ä»¶

æœ‰7ä¸ªæ‹–æ”¾äº‹ä»¶å¯ä»¥æ•è·ï¼Œå¦‚ä¸‹ï¼š

dragstartï¼šå¼€å§‹æ‹–å…ƒç´ è§¦å‘

dragenterï¼šå…ƒç´ æ‹–è¿›å¯dropå…ƒç´ ï¼ˆç»‘å®šdropäº‹ä»¶çš„å…ƒç´ ï¼‰æ—¶è§¦å‘

dragoverï¼šå½“å…ƒç´ æ‹–åŠ¨åˆ°dropå…ƒç´ ä¸Šæ—¶è§¦å‘

dropï¼šå½“å…ƒç´ æ”¾ä¸‹åˆ°dropå…ƒç´ è§¦å‘

dragleave ï¼šå½“å…ƒç´ ç¦»å¼€dropå…ƒç´ æ—¶è§¦å‘

dragï¼šæ¯æ¬¡å…ƒç´ è¢«æ‹–åŠ¨æ—¶ä¼šè§¦å‘

dragendï¼šæ”¾å¼€æ‹–åŠ¨å…ƒç´ æ—¶è§¦å‘

å®Œæˆä¸€æ¬¡æ‹–æ”¾çš„äº‹ä»¶è¿‡ç¨‹æ˜¯ï¼š dragstart â€“> dragenter â€“> dragover â€“> drop â€“> dragend

### æµè§ˆå™¨æ”¯æŒ

Edgeã€Firefoxã€Opera 12ã€Chrome ä»¥åŠ Safari 5 æ”¯æŒæ‹–æ”¾ã€‚

æ‹–æ‹½ä¸Šä¼ å®ç°
------

### 1.æ–°å»ºå·¥ç¨‹n02drag,å°†é¡¹ç›®æ·»åŠ åˆ°è§£å†³æ–¹æ¡ˆä¸­

    dotnet new blazorserver -o n02drag
    dotnet sln add n02drag/n02drag.csproj
    

### 2.åœ¨æ–‡ä»¶å¤¹wwwroot/lib,æ·»åŠ dragå­æ–‡ä»¶å¤¹,æ–°å»ºapp.jsæ–‡ä»¶

å…ˆé˜»æ­¢é¡µé¢é»˜è®¤çš„æ‹–æ”¾è¡Œä¸ºï¼Œä¸ç„¶é¡µé¢ä¼šè¢«æ‹–æ”¾çš„æ–‡ä»¶æ›¿æ¢äº†ã€‚

    //é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
    document.addEventListener( "dragleave", function(e) {
         e.preventDefault();
    }, false);
    document.addEventListener( "drop", function(e) {
         e.preventDefault();
    }, false);
    document.addEventListener( "dragenter", function(e) {
         e.preventDefault();
    }, false);
    document.addEventListener( "dragover", function(e) {
         e.preventDefault();
    }, false);
    

è®¾ç½®dropåŒºåŸŸ

å½“æ–‡ä»¶æ‹–æ”¾åˆ°dropåŒºåŸŸæ—¶ï¼Œå°±èƒ½è§¦å‘ä¸Šä¼ ã€‚

        element.addEventListener("drop", function (e) {
    
            try {
                var fileList = e.dataTransfer.files; //è·å–æ–‡ä»¶å¯¹è±¡
                //æ£€æµ‹æ˜¯å¦æ˜¯æ‹–æ‹½æ–‡ä»¶åˆ°é¡µé¢çš„æ“ä½œ
                if (fileList.length == 0) {
                    return false;
                }
    
                inputFile.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true });
                inputFile.dispatchEvent(event);
            }
            catch (e) {
                wrapper.invokeMethodAsync('DropAlert', e);
            }
        }, false);
    

### 2.åœ¨æ–‡ä»¶Pages/Index.razor,æ·»åŠ ä¸Šä¼ ç»„ä»¶

é¡µé¢

    @implements IAsyncDisposable
    @inject IJSRuntime JS
    
    <div @ref="UploadElement" style="padding: 20px; width: 200px; height: 200px; background-color: cornflowerblue; border: 2px dashed #0087F7; border-radius: 5px; ">
        <p>æ‹–æ”¾ä¸Šä¼ æ–‡ä»¶</p>
         <InputFile OnChange="OnChange" class="form-control" multiple @ref="inputFile"/>
    </div>
    
    <pre>
    <code>
            @uploadstatus
    </code>
    </pre>
    

ä»£ç 

1.  InputFile å¼€å¯ multiple ,æ¥å—å¤šæ–‡ä»¶ä¸Šä¼ 
2.  ä½¿ç”¨JSéš”ç¦»æŠ€æœ¯
3.  Disposeå¤„ç†å›æ”¶

    
    @code{
        [Inject] protected Microsoft.AspNetCore.Hosting.IWebHostEnvironment? HostEnvironment { get; set; } //è·å–IWebHostEnvironment
    
        protected ElementReference UploadElement { get; set; }
        protected InputFile? inputFile { get; set; }
    
        private DotNetObjectReference<Index>? wrapper;
    
        private IJSObjectReference? module;
        private IJSObjectReference? dropInstance;
    
        protected string UploadPath = "";
        protected string? uploadstatus;
        long maxFileSize = 1024 * 1024 * 15;
    
        protected override void OnAfterRender(bool firstRender)
        {
            if (!firstRender) return;
            UploadPath = Path.Combine(HostEnvironment!.WebRootPath, "Upload"); //åˆå§‹åŒ–ä¸Šä¼ è·¯å¾„
            if (!Directory.Exists(UploadPath)) Directory.CreateDirectory(UploadPath); //ä¸å­˜åœ¨åˆ™æ–°å»ºç›®å½•
        }
    
        protected async Task OnChange(InputFileChangeEventArgs e)
        {
            int i = 0;
            var selectedFiles = e.GetMultipleFiles(100);
            foreach (var item in selectedFiles)
            {
                i++;
                await OnSubmit(item);
                uploadstatus += Environment.NewLine + $"[{i}]: " + item.Name;
            }
        }
    
        protected async Task OnSubmit(IBrowserFile efile)
        {
            if (efile == null) return;
            var tempfilename = Path.Combine(UploadPath, efile.Name);
            await using FileStream fs = new(tempfilename, FileMode.Create);
            using var stream = efile.OpenReadStream(maxFileSize);
            await stream.CopyToAsync(fs);
            StateHasChanged();
        }
    
    
        protected override async Task OnAfterRenderAsync(bool firstRender)
        {
            if (!firstRender) return;
    
            module = await JS.InvokeAsync<IJSObjectReference>("import", "./lib/drag/app.js");
            wrapper = DotNetObjectReference.Create(this);
            dropInstance = await module.InvokeAsync<IJSObjectReference>("init", wrapper , UploadElement, inputFile!.Element);
        }
    
        [JSInvokable]
        public void DropAlert(string msg)
        {
            uploadstatus  += Environment.NewLine + $"[!Alert!]: " + msg;
            StateHasChanged();
        }
    
    
        async ValueTask IAsyncDisposable.DisposeAsync()
        {
            if (dropInstance != null)
            {
                await dropInstance.InvokeVoidAsync("dispose");
                await dropInstance.DisposeAsync();
            }
    
            if (wrapper != null)
            {
                wrapper.Dispose();
            }
    
            if (module != null)
            {
                await module.DisposeAsync();
            }
        }
    
    }
    

### 3.å°±è¿™ä¹ˆç®€å•å—?æˆ‘ä»¬è¿˜å¯ä»¥åŠ ä¸Šä¸€äº›éªšåŠŸèƒ½ ğŸ‘ğŸ¼ ç²˜è´´æ–‡ä»¶ä¸Šä¼ 

        element.addEventListener('paste', function (e) {
        
            inputFile.files = e.clipboardData.files;
            const event = new Event('change', { bubbles: true });
            inputFile.dispatchEvent(event);
        }, false);
    

### 4.é™åˆ¶ä¼ è¾“æ ¼å¼

\*æ—¶é—´æœ‰é™,jséƒ¨åˆ†åŒå­¦ä»¬è‡ªå·±å®Œæˆå§,è¿™é‡Œæ˜¯InputFile ä¸Šé™åˆ¶ä¸€ä¸‹

    <div style="padding-top:40px; padding: 20px; width: 200px; height: 200px; background-color: cornflowerblue; border: 2px dashed #0087F7; border-radius: 5px; ">
        ä¸Šä¼ å›¾ç‰‡
        <InputFile OnChange="OnChange" style="max-width: 400px" class="form-control" multiple accept='image/*' />
    </div>
    

### 5.å®Œæ•´JSä»£ç 

    export function init(wrapper, element, inputFile) {
    
        //é˜»æ­¢æµè§ˆå™¨é»˜è®¤è¡Œä¸º
        document.addEventListener("dragleave", function (e) {
            e.preventDefault();
        }, false);
        document.addEventListener("drop", function (e) {
            e.preventDefault();
        }, false);
        document.addEventListener("dragenter", function (e) {
            e.preventDefault();
        }, false);
        document.addEventListener("dragover", function (e) {
            e.preventDefault();
        }, false); 
    
        element.addEventListener("drop", function (e) {
    
            try {
                var fileList = e.dataTransfer.files; //è·å–æ–‡ä»¶å¯¹è±¡
                //æ£€æµ‹æ˜¯å¦æ˜¯æ‹–æ‹½æ–‡ä»¶åˆ°é¡µé¢çš„æ“ä½œ
                if (fileList.length == 0) {
                    return false;
                }
    
                inputFile.files = e.dataTransfer.files;
                const event = new Event('change', { bubbles: true });
                inputFile.dispatchEvent(event);
            }
            catch (e) {
                wrapper.invokeMethodAsync('DropAlert', e);
            }
        }, false);
    
        element.addEventListener('paste', function (e) {
        
            inputFile.files = e.clipboardData.files;
            const event = new Event('change', { bubbles: true });
            inputFile.dispatchEvent(event);
        }, false);
    
        return {
            dispose: () => {
                element.removeEventListener('dragleave', onDragLeave);
                element.removeEventListener("drop", onDrop);
                element.removeEventListener('dragenter', onDragHover);
                element.removeEventListener('dragover', onDragHover);
                element.removeEventListener('paste', handler);
            }
        }
    }
    

![æ‹–æ”¾](https://user-images.githubusercontent.com/8428709/162629129-9088ec23-8b14-4005-b874-7c95c8894ba6.gif)

### å‚è€ƒèµ„æ–™

ç”¨20è¡Œä»£ç å®ç°æ–‡ä»¶ä¸Šä¼ ,æµè§ˆç›®å½•åŠŸèƒ½ (Blazor server) [https://github.com/densen2014/Blazor100/wiki/9.-ç”¨20è¡Œä»£ç å®ç°æ–‡ä»¶ä¸Šä¼ ,æµè§ˆç›®å½•åŠŸèƒ½-(Blazor-server)](https://github.com/densen2014/Blazor100/wiki/9.-%E7%94%A820%E8%A1%8C%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0,%E6%B5%8F%E8%A7%88%E7%9B%AE%E5%BD%95%E5%8A%9F%E8%83%BD-(Blazor-server))

HTML5æ‹–æ”¾ï¼ˆdrag and dropï¼‰ä¸pluploadçš„æ‡’äººä¸Šä¼  [https://www.programminghunter.com/article/31061232701/](https://www.programminghunter.com/article/31061232701/)

#### é¡¹ç›®æºç 

[Github](https://github.com/densen2014/Blazor100) | [Gitee](https://gitee.com/densen2014/Blazor100)

#### çŸ¥è¯†å…±äº«è®¸å¯åè®®

æœ¬ä½œå“é‡‡ç”¨ [çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®](https://creativecommons.org/licenses/by-nc-sa/4.0/) è¿›è¡Œè®¸å¯ã€‚æ¬¢è¿è½¬è½½ã€ä½¿ç”¨ã€é‡æ–°å‘å¸ƒï¼Œä½†åŠ¡å¿…ä¿ç•™æ–‡ç« ç½²åAlexChowï¼ˆåŒ…å«é“¾æ¥ï¼š [https://github.com/densen2014](https://github.com/densen2014) ï¼‰ï¼Œä¸å¾—ç”¨äºå•†ä¸šç›®çš„ï¼ŒåŸºäºæœ¬æ–‡ä¿®æ”¹åçš„ä½œå“åŠ¡å¿…ä»¥ç›¸åŒçš„è®¸å¯å‘å¸ƒã€‚å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·[ä¸æˆ‘è”ç³»](zhouchuanglin@gmail.com) ã€‚