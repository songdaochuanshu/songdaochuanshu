---
layout: post
title: "对进程、线程和协程的理解以及它们的区别"
date: "2022-04-25T19:15:06.413Z"
---
对进程、线程和协程的理解以及它们的区别
===================

一、进程
----

先来了解一下操作系统的进程：

> 操作系统对正在运行程序的抽象，这个就是进程（process）。

比如运行一个 web 浏览器，一个 text 文本，都是运行的一个一个进程。

有的人说：进程是程序运行资源的集合。进程是系统资源分配的最小单位等等。

从静态的角度来说，进程确实是运行程序的各种资源集合。

如果你进一步思考，进程里的各种资源都有哪些呢？如下图所示：

![image-20220425233252807](https://img2022.cnblogs.com/blog/650581/202204/650581-20220426024601666-1538735698.png)

​ （图1：进程资源）

> *   内存管理相关
>     
> *   文件系统
>     
> *   调度相关
>     
> *   信号处理
>     
> *   内核栈
>     
> *   进程各种状态
>     
> *   进程运行时统计信息
>     
> *   进程标识
>     
> 
> 等等。
> 
> 可以看出，进程中的资源是相当多的。
> 
> 从 Linux 操作系统对进程的定义也可以看出。我以前对进程结构 task\_struct 分析文章：[Linux进程: task\_struct结构体成员](https://www.cnblogs.com/jiujuan/p/11715853.html)

多进程：操作系统有多个程序运行，那么就有多个进程，如下所示简图：

![image-20220425183626070](https://img2022.cnblogs.com/blog/650581/202204/650581-20220426024601689-1809452874.png)

​ （图2：多进程简图）

二、线程
----

### 2.1 什么是线程？

《操作系统设计与实现》里说：

在传统操作系统中，每个进程中只存在一个地址空间和一个控制流（thread）。

然后，有些情况下，需要在相同地址空间中有多个控制流并行的运行，就像他们是单独的进程一样（只是他们共享相同的地址空间）。

这些控制流通常被称为线程（thread），有时也称为轻量级进程（lightweight process）。

尽管线程必须在进程中执行，但是线程和进程是可以分别对待处理的两个概念。进程用来集合资源，而线程是 CPU 调度的实体。

线程给进程模型增加的是，允许在同一个进程环境中有多个执行流，这些执行流在很大程度上相对独立。

也即是说，在进程中，程序执行的最小单位（执行流）是线程，可以把线程看作是进程里的一条执行流。

一个进程里可以有一条或多条线程。

![image-20220425204853673](https://img2022.cnblogs.com/blog/650581/202204/650581-20220426024601759-287513339.png)

​ (图3：进程里的线程)

### 2.2 为什么会有多线程？

在一个应用程序执行过程中，应用程序里可能会有多种事件执行。

而有些事件执行一段时间后可能会被阻塞。如果把应用程序执行事件分解成多个并行运行的线程，即可以让程序设计变得简单，如果有阻塞的，

可以把这部分让出行换其他线程执行。

还有一个原因是：

线程比进程更轻量级。所以线程比进程更加容易创建，销毁。

第三个跟第一个有点关系，是关于性能的，若多线程都是 CPU 密集型的，那么不能获取性能上增强。如果有大量计算和大量 I/O 处理，那么

多线程就可以获取性能上的优势，因为允许多线程重叠执行。

多线程的缺点：

> 1.  对于多线程来说，进程中的资源是共享的，所以会产生资源竞争。
> 2.  当进程中的一个线程崩溃了，会导致这个进程里的其他线程也崩溃。所以有时多进程程序更好，一个进程崩溃不会导致其他进程也崩溃。

三、进程与线程区别
---------

从上面进程和线程介绍知道，线程是程序执行流的最小单位，进程是操作系统分配资源的单位。

进程与进程之间关系：

> 进程与进程之间是相互独立的。

线程与进程关系：

> 线程是进程里的执行流，进程里的线程可以是一个，也可以是多个。
> 
> 所有线程共享进程里一些资源，比如代码，数据，地址空间，信号处理，打开文件，全局变量等。
> 
> 同时，线程也有自己的寄存器，程序计数器，堆栈，线程状态等

![image-20220425233616408](https://img2022.cnblogs.com/blog/650581/202204/650581-20220426024601710-843840070.png)

​ （图4：进程与线程关系）

四、协程
----

协程是建立在线程之上，一般是语言级别的 ”多线程“ 模型，比线程更加的轻量级。有的叫它微线程。它是完全运行在用户态里。

协程是在线程之上在进行抽象，它需要线程来承载运行。一个线程可以运行多个协程。

比如 Go 语言的 goroutine，它用一个关键字 `go` 就可以运行一个协程程序。

在 Go 语言里面，协程是由 Go 提供的 runtime 来控制和调度。

协程的优点：

1.  协程栈很小，只有几KB，而线程栈是 1 M，对比起来，创建大量协程需要的内存更少。
    
2.  协程的调度是语言提供的 runtime 来调度，是在用户空间直接调度，不需要在内核空间和用户空间来回切换，浪费效率。
    
3.  能更好的利用 cpu 的多核，提高程序执行性能。
    
4.  避免阻塞，如果协程所在的线程发生了阻塞，那么协程调度器可以把运行在阻塞线程上的协程，调度到其它没有发生阻塞的线程上，继续运行。
    

五：协程与线程区别
---------

1.  协程是运行在线程之上，一个线程可以运行多个协程。就像一个进程里可以有多个线程一样。
2.  协程能更好的利用多核机制。比如 Go 协程可以控制运行在多少个 CPU 的核上。
3.  协程是在用户空间完成调度，由语言提供的 runtime 进行调度完全用户态。线程由内核调度。
4.  协程使用内存更小。

六、参考
----

*   [《操作系统设计与实现》](https://book.douban.com/subject/3108799/)作者: (美)ANDREW S.TANENBAUM / ALBERT S.WOODHULL
*   [https://www.zhihu.com/question/20511233](https://www.zhihu.com/question/20511233) 协程有哪些好处
*   [https://zh.wikipedia.org/wiki/行程](https://zh.wikipedia.org/wiki/%E8%A1%8C%E7%A8%8B) 进程
*   [https://zh.wikipedia.org/wiki/线程](https://zh.wikipedia.org/wiki/%E7%BA%BF%E7%A8%8B) 线程
*   [https://zh.wikipedia.org/wiki/协程](https://zh.wikipedia.org/wiki/%E5%8D%8F%E7%A8%8B) 协程

\== just do it ==