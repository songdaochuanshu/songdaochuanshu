---
layout: post
title: "Docker | redisé›†ç¾¤éƒ¨ç½²å®æˆ˜"
date: "2022-10-20T22:23:50.288Z"
---
Docker | redisé›†ç¾¤éƒ¨ç½²å®æˆ˜
====================

å‰é¢å·²ç»ç®€å•ç†Ÿæ‚‰è¿‡redisçš„ä¸‹è½½å®‰è£…ä½¿ç”¨ï¼Œä»Šå¤©æ¥ç€éƒ¨ç½²redisé›†ç¾¤ï¼ˆclusterï¼‰ï¼Œç®€å•ä½“ä¼šä¸€ä¸‹redisé›†ç¾¤çš„é«˜å¯ç”¨ç‰¹æ€§ã€‚

å‰é¢å·²ç»ç®€å•ç†Ÿæ‚‰è¿‡`redis`çš„ä¸‹è½½å®‰è£…ä½¿ç”¨ï¼Œä»Šå¤©æ¥ç€éƒ¨ç½²`redis`é›†ç¾¤ï¼ˆclusterï¼‰ï¼Œç®€å•ä½“ä¼šä¸€ä¸‹redisé›†ç¾¤çš„é«˜å¯ç”¨ç‰¹æ€§ã€‚

ç¯å¢ƒå‡†å¤‡
====

Redisæ˜¯Cè¯­è¨€å¼€å‘ï¼Œå®‰è£…Rediséœ€è¦å…ˆå°†Redisçš„æºç è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘ä¾èµ–`gcc`ç¯å¢ƒ

å®‰è£…`gcc-c++`
-----------

    yum install gcc-c++
    

æŸ¥çœ‹ç‰ˆæœ¬
----

    [root@--- redis]# gcc -v
    Using built-in specs.
    COLLECT_GCC=gcc
    COLLECT_LTO_WRAPPER=/usr/libexec/gcc/x86_64-redhat-linux/4.8.5/lto-wrapper
    Target: x86_64-redhat-linux
    Configured with: ../configure --prefix=/usr --mandir=/usr/share/man --infodir=/usr/share/info --with-bugurl=http://bugzilla.redhat.com/bugzilla --enable-bootstrap --enable-shared --enable-threads=posix --enable-checking=release --with-system-zlib --enable-__cxa_atexit --disable-libunwind-exceptions --enable-gnu-unique-object --enable-linker-build-id --with-linker-hash-style=gnu --enable-languages=c,c++,objc,obj-c++,java,fortran,ada,go,lto --enable-plugin --enable-initfini-array --disable-libgcj --with-isl=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/isl-install --with-cloog=/builddir/build/BUILD/gcc-4.8.5-20150702/obj-x86_64-redhat-linux/cloog-install --enable-gnu-indirect-function --with-tune=generic --with-arch_32=x86-64 --build=x86_64-redhat-linux
    Thread model: posix
    gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) 
    [root@--- redis]# 
    
    

**Redisçš„å››ç§æ¨¡å¼**

1.  å•æœºæ¨¡å¼
    
2.  master+slave(ä¸»ä»)
    
3.  sentinel(å“¨å…µ)
    
4.  cluster(é›†ç¾¤)
    

åˆ›å»ºredisç½‘å¡
=========

    [root@--- ~]# docker network create redis --subnet 172.38.0.0/16
    0350d84612bef09bc32b39f15ac6b608dae17cbd75d04b282c0bd37c0283bb7c
    [root@iZm5e23n3ueobwkjtfartxZ ~]# docker network ls
    NETWORK ID     NAME           DRIVER    SCOPE
    feafa30d4051   bridge         bridge    local
    e8bf4fced9e2   host           host      local
    0096a971fd2c   mynet          bridge    local
    6263db0933b9   none           null      local
    0350d84612be   redis          bridge    local
    799426d70aa2   test-network   bridge    local
    [root@--- ~]# 
    
    

åˆ›å»º6ä¸ªredisæœåŠ¡
===========

é€šè¿‡ç¼–å†™è„šæœ¬åˆ›å»º6ä¸ªredisæœåŠ¡

*   cluster-enabledï¼šæ˜¯å¦å¯åŠ¨é›†ç¾¤ï¼Œé€‰å€¼ï¼šyes ã€no
*   cluster-config-file é…ç½®æ–‡ä»¶.conf ï¼šæŒ‡å®šèŠ‚ç‚¹ä¿¡æ¯ï¼Œè‡ªåŠ¨ç”Ÿæˆ
*   cluster-node-timeout æ¯«ç§’å€¼ï¼š é…ç½®èŠ‚ç‚¹è¿æ¥è¶…æ—¶æ—¶é—´
*   appendonlyï¼šæ˜¯å¦å¼€å¯æŒä¹…åŒ–ï¼Œé€‰å€¼ï¼šyesã€no
*   daemonize: å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨(åå°å¯åŠ¨)

åœ¨`/var`ç›®å½•ä¸‹åˆ›å»ºè„šæœ¬æ–‡ä»¶`create_redis_script.sh`
----------------------------------------

    touch create_redis_script.sh
    

ç¼–å†™è„šæœ¬å†…å®¹
------

`vim create_redis_script.sh`ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹

    for port in $(seq	1 6); \
    do \
    mkdir -p /var/redisNode/node-${port}/conf
    touch /var/redisNode/node-${port}/conf/redis.conf
    cat << EOF >/var/redisNode/node-${port}/conf/redis.conf
    port 6379
    bind 0.0.0.0
    cluster-enabled yes
    cluster-config-file nodes.conf
    cluster-node-timeout 5000
    cluster-announce-ip 172.38.0.1${port}
    cluster-announce-port 6379
    cluster-announce-bus-port 16379
    appendonly yes
    #daemonize yes
    EOF
    done
    

æŸ¥çœ‹è„šæœ¬æ–‡ä»¶
------

`cat create_redis_script.sh`

èµ‹äºˆ`create_redis_script.sh`æ–‡ä»¶å¯æ‰§è¡Œæƒé™
---------------------------------

    [root@--- ~]# chmod o+x create_redis_script.sh
    

æ‰§è¡Œè„šæœ¬ï¼Œåˆ›å»ºredisæœåŠ¡
--------------

`./create_redis_script.sh`

æŸ¥çœ‹redisèŠ‚ç‚¹
---------

    [root@--- redisNode]# pwd
    /var/redisNode
    [root@--- redisNode]# ls
    node-1  node-2  node-3  node-4  node-5  node-6
    [root@--- redisNode]#
    

æŸ¥çœ‹redis.confé…ç½®æ–‡ä»¶
----------------

![](https://img2022.cnblogs.com/blog/1037867/202210/1037867-20221020170102919-385371558.png)

å¯åŠ¨redisæœåŠ¡
=========

*   \-v æŒ‚è½½æ•°æ®å·
    
*   redis:5.0.9-alpine3.11 redisé•œåƒ
    
*   6379 æ˜¯redisç«¯å£ï¼š æ˜ å°„äº‘æœåŠ¡å™¨ç«¯å£6371 - 6376
    
*   16379 æ˜¯redisé›†ç¾¤TCPç«¯å£ï¼š æ˜ å°„äº‘æœåŠ¡å™¨ç«¯å£16371 - 16376
    
*   \--net ä½¿ç”¨è‡ªå®šä¹‰redisç½‘ç»œ
    
*   \--ip æ˜¯æœ¬å®¹å™¨ç»‘å®šçš„ipï¼š 172.38.0.11 - 16
    
*   \--name å®¹å™¨åå­—ï¼š redis-1 - 6
    
*   redis-server /etc/redis/redis.conf è¿½åŠ å‘½ä»¤ï¼Œé€šè¿‡redis.confå¯åŠ¨
    

å¯åŠ¨æ–¹å¼ä¸€ï¼ˆä¸æ¨èï¼‰ï¼š
-----------

ä¸€ä¸ªä¸€ä¸ªå¯åŠ¨

å¯åŠ¨ç¬¬ä¸€ä¸ªredisèŠ‚ç‚¹

    docker run -p 6371:6379 -p 16371:16379 --name redis-1 \
    -v /var/redisNode/node-1/data:/data \
    -v /var/redisNode/node-1/conf/redis.conf:/etc/redis/redis.conf \
    -d --net redis --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
    

å¦‚ä¸Šï¼Œç±»ä¼¼çš„ï¼Œé€’å¢ipã€portå’Œnameï¼Œå¯åŠ¨å…¶å®ƒäº”ä¸ªredisèŠ‚ç‚¹ï¼Œå¤ªéº»çƒ¦äº†ï¼Œå¯ä»¥é€šè¿‡ç¼–å†™è„šæœ¬æ¥ä¸€æ¬¡å¯åŠ¨6ä¸ªæœåŠ¡

å¯åŠ¨æ–¹å¼äºŒï¼ˆæ¨èï¼‰ï¼š
----------

ç¼–å†™å¯åŠ¨è„šæœ¬ï¼Œ6ä¸ªå…¨éƒ¨å¯åŠ¨

### åˆ›å»º`start_redis_script.sh`æ–‡ä»¶

    touch start_redis_script.sh
    

### ç¼–å†™è„šæœ¬å†…å®¹

`vim start_redis_script.sh`ï¼Œå†™å…¥ä¸‹é¢çš„å†…å®¹

    for port in $(seq	1 6); \
    do \
    echo ${port}
    docker run -p 637${port}:6379 -p 1637${port}:16379 --name redis-${port} \
    -v /var/redisNode/node-${port}/data:/data \
    -v /var/redisNode/node-${port}/conf/redis.conf:/etc/redis/redis.conf \
    -d --net redis --ip 172.38.0.1${port} redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf; \
    done
    

### èµ‹äºˆ`start_redis_script.sh`æ–‡ä»¶å¯æ‰§è¡Œæƒé™

    [root@--- ~]# chmod o+x start_redis_script.sh
    

### æ‰§è¡Œè„šæœ¬ï¼Œå¯åŠ¨rediså®¹å™¨æœåŠ¡

`./start_redis_script.sh`

![](https://img2022.cnblogs.com/blog/1037867/202210/1037867-20221020170103416-308339596.png)

### æŸ¥çœ‹rediså®¹å™¨

    [root@--- var]# docker ps
    CONTAINER ID   IMAGE                    COMMAND                  CREATED              STATUS              PORTS                                              NAMES
    0d3c18b61098   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   2 seconds ago        Up 1 second         0.0.0.0:6376->6379/tcp, 0.0.0.0:16376->16379/tcp   redis-6
    ee896fb093da   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   13 seconds ago       Up 12 seconds       0.0.0.0:6375->6379/tcp, 0.0.0.0:16375->16379/tcp   redis-5
    a83bb7b16dff   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   48 seconds ago       Up 47 seconds       0.0.0.0:6374->6379/tcp, 0.0.0.0:16374->16379/tcp   redis-4
    ffe4c9619bed   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   58 seconds ago       Up 57 seconds       0.0.0.0:6373->6379/tcp, 0.0.0.0:16373->16379/tcp   redis-3
    a316a31e273f   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   About a minute ago   Up About a minute   0.0.0.0:6372->6379/tcp, 0.0.0.0:16372->16379/tcp   redis-2
    71c072f57c29   redis:5.0.9-alpine3.11   "docker-entrypoint.sâ€¦"   9 minutes ago        Up 9 minutes        0.0.0.0:6371->6379/tcp, 0.0.0.0:16371->16379/tcp   redis-1
    [root@--- var]# 
    

åˆ›å»ºé›†ç¾¤
====

è¿›å…¥ä»»æ„ä¸€ä¸ª `Redis` å®ä¾‹

è¿›å…¥redis-1å®¹å™¨
-----------

    docker exec -it redis-1 /bin/sh
    

åˆ›å»ºé›†ç¾¤ä¸»èŠ‚ç‚¹
-------

*   Redis Clusteræœ€ä½è¦æ±‚æ˜¯3ä¸ªä¸»èŠ‚ç‚¹
    
*   \--cluster-replicas å‚æ•°ä¸ºæ•°å­—ï¼Œ1è¡¨ç¤ºæ¯ä¸ªä¸»èŠ‚ç‚¹éœ€è¦1ä¸ªä»èŠ‚ç‚¹ã€‚
    

    # redis-1 å®¹å™¨å†…
    /data # redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1
    

![](https://img2022.cnblogs.com/blog/1037867/202210/1037867-20221020170103948-1800116412.png)

æµ‹è¯•è¿æ¥é›†ç¾¤
======

è¿æ¥é›†ç¾¤ `-c`
---------

    # redis-1 å®¹å™¨å†…
    /data # redis-cli -c
    127.0.0.1:6379>
    

æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ `cluster info`
---------------------

    127.0.0.1:6379> cluster info
    cluster_state:ok
    cluster_slots_assigned:16384
    cluster_slots_ok:16384
    cluster_slots_pfail:0
    cluster_slots_fail:0
    cluster_known_nodes:6
    cluster_size:3
    cluster_current_epoch:6
    cluster_my_epoch:1
    cluster_stats_messages_ping_sent:292
    cluster_stats_messages_pong_sent:307
    cluster_stats_messages_sent:599
    cluster_stats_messages_ping_received:302
    cluster_stats_messages_pong_received:292
    cluster_stats_messages_meet_received:5
    cluster_stats_messages_received:599
    127.0.0.1:6379>
    

æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ `cluster nodes`
----------------------

    127.0.0.1:6379> cluster nodes
    b3f737d0d77b823794087011f1501fd43a2ea316 172.38.0.12:6379@16379 master - 0 1633332452560 2 connected 5461-10922
    506ff2bf1020d468e7d7a81ddbfb616a7e9b7d96 172.38.0.13:6379@16379 master - 0 1633332453000 3 connected 10923-16383
    7f57f8a01493fa9e46e24ad8a9e46995634f7442 172.38.0.15:6379@16379 slave 70ebdca0264c079bb2c33452e6388d37706da282 0 1633332453000 5 connected
    70ebdca0264c079bb2c33452e6388d37706da282 172.38.0.11:6379@16379 myself,master - 0 1633332452000 1 connected 0-5460
    f839b6924977e99d3b74324f2ef70b3678e1a257 172.38.0.14:6379@16379 slave 506ff2bf1020d468e7d7a81ddbfb616a7e9b7d96 0 1633332453762 4 connected
    bbc4dd0639b90e9ddfb5cef278be04a24276cbdb 172.38.0.16:6379@16379 slave b3f737d0d77b823794087011f1501fd43a2ea316 0 1633332453000 6 connected
    127.0.0.1:6379> 
    

![](https://img2022.cnblogs.com/blog/1037867/202210/1037867-20221020170104416-1927086560.png)

æµ‹è¯•ä¸»ä»èŠ‚ç‚¹æ›¿æ¢
========

**éªŒè¯é«˜å¯ç”¨**

setä¸€ä¸ªå€¼ï¼Œç„¶ååœæ‰å¯¹åº”çš„æœåŠ¡ï¼Œå†æ¬¡getï¼ŒéªŒè¯æ˜¯å¦å¯ä»¥å¾—åˆ°å€¼

setå€¼
----

    127.0.0.1:6379> set a b
    -> Redirected to slot [15495] located at 172.38.0.13:6379
    OK
    172.38.0.13:6379>
    

å‘ç°aå€¼è®¾ç½®åœ¨äº†172.38.0.13å®¹å™¨ä¸Šï¼Œç„¶åæˆ‘ä»¬è¯•ç€å»åœæ‰redis-3å®¹å™¨çš„æœåŠ¡ï¼Œç„¶åå†æ¬¡get,çœ‹ä¸€ä¸‹ç»“æœ

getå€¼
----

    172.38.0.13:6379> get a
    "b"
    172.38.0.13:6379>
    

åœæ­¢`redis-3`å®¹å™¨é‡Œçš„redisæœåŠ¡
----------------------

    docker stop redis-3
    

å†æ¬¡å–å€¼
----

    172.38.0.13:6379> get a
    Could not connect to Redis at 172.38.0.13:6379: Host is unreachable
    (34.04s)
    not connected> exit
    # é‡è¿é›†ç¾¤
    /data # redis-cli -c
    127.0.0.1:6379> get a
    -> Redirected to slot [15495] located at 172.38.0.14:6379
    "b"
    172.38.0.14:6379> 
    

å‘ç°`a`å€¼è¢«å­˜å‚¨åˆ°äº†`172.38.0.14`æœºå™¨ä¸Šï¼Œ`172.38.0.14`æ˜¯`172.38.0.13`çš„ä»èŠ‚ç‚¹ï¼Œå½“ä¸»èŠ‚ç‚¹`172.38.0.13`å‘ç”Ÿæ•…éšœæ—¶ï¼Œè‡ªåŠ¨æ›¿æ¢åˆ°`172.38.0.13`ï¼Œè¿™å°±æ˜¯**é«˜å¯ç”¨**

æŸ¥çœ‹redisèŠ‚ç‚¹æœåŠ¡ä¿¡æ¯
-------------

å‘ç°`172.38.0.13`èŠ‚ç‚¹`fail`, `172.38.0.14`å˜æˆ`master`

![](https://img2022.cnblogs.com/blog/1037867/202210/1037867-20221020170105466-232758516.png)

dockeræ­å»ºredisé›†ç¾¤å®ŒæˆğŸˆğŸˆ

* * *

æˆ‘æ˜¯ [**ç”œç‚¹cc**](https://blog.i-xiao.space/)

çƒ­çˆ±å‰ç«¯ï¼Œä¹Ÿå–œæ¬¢ä¸“ç ”å„ç§è·Ÿæœ¬èŒå·¥ä½œå…³ç³»ä¸å¤§çš„æŠ€æœ¯ï¼ŒæŠ€æœ¯ã€äº§å“å…´è¶£å¹¿æ³›ä¸”æµ“åšï¼Œç­‰å¾…ç€ä¸€ä¸ªåˆ›ä¸šæœºä¼šã€‚æœ¬å·ä¸»è¦è‡´åŠ›äºåˆ†äº«ä¸ªäººç»éªŒæ€»ç»“ï¼Œå¸Œæœ›å¯ä»¥ç»™ä¸€å°éƒ¨åˆ†äººä¸€äº›å¾®å°å¸®åŠ©ã€‚

å¸Œæœ›èƒ½å’Œå¤§å®¶ä¸€èµ·åŠªåŠ›è¥é€ ä¸€ä¸ªè‰¯å¥½çš„å­¦ä¹ æ°›å›´ï¼Œä¸ºäº†ä¸ªäººå’Œå®¶åº­ã€ä¸ºäº†æˆ‘å›½çš„äº’è”ç½‘ç‰©è”ç½‘æŠ€æœ¯ã€æ•°å­—åŒ–è½¬å‹ã€æ•°å­—ç»æµå‘å±•åšä¸€ç‚¹ç‚¹è´¡çŒ®ã€‚**æ•°é£æµäººç‰©è¿˜çœ‹ä¸­å›½ã€çœ‹ä»Šæœã€çœ‹ä½ æˆ‘ã€‚**

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ç”œç‚¹cc](https://www.cnblogs.com/all-smile/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/all-smile/p/16810523.html](https://www.cnblogs.com/all-smile/p/16810523.html)