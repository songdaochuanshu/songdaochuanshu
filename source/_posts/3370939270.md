---
layout: post
title: "èŠèŠ C# å’Œ C++ ä¸­çš„ æ³›å‹æ¨¡æ¿ åº•å±‚ç©æ³•"
date: "2022-06-17T10:20:29.253Z"
---
èŠèŠ C# å’Œ C++ ä¸­çš„ æ³›å‹æ¨¡æ¿ åº•å±‚ç©æ³•
========================

æœ€è¿‘åœ¨çœ‹ C++ çš„æ–¹æ³•å’Œç±»æ¨¡æ¿ï¼Œæˆ‘å°±åœ¨æƒ³ C# ä¸­ä¹Ÿæ˜¯æœ‰è¿™ä¸ªæ¦‚å¿µçš„ï¼Œä¸è¿‡å«æ³•ä¸ä¸€æ ·ï¼Œäººå®¶å«**æ¨¡æ¿**ï¼Œæˆ‘ä»¬å«**æ³›å‹**ï¼Œå“ˆå“ˆï¼Œæœ‰ç‚¹æ„æ€ï¼Œè¿™ä¸€ç¯‡æˆ‘ä»¬æ¥èŠèŠå®ƒä»¬åº•å±‚æ˜¯æ€ä¹ˆç©çš„ï¼Ÿ

ä¸€ï¼šC++ ä¸­çš„æ¨¡æ¿ç©æ³•
------------

æ¯•ç«Ÿ C++ æ˜¯å…¼å®¹ C è¯­è¨€ï¼Œè€Œ C æ˜¯è¿‡ç¨‹å¼çš„ç©æ³•ï¼Œæ‰€ä»¥ C++ å°±å‡ºç°äº†ä¸¤ç§æ¨¡æ¿ç±»å‹ï¼Œåˆ†åˆ«ä¸ºï¼š`å‡½æ•°æ¨¡æ¿` å’Œ `ç±»æ¨¡æ¿`ï¼Œä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹ã€‚

### 1\. å‡½æ•°æ¨¡æ¿çš„ç©æ³•

ç©ä¹‹å‰å…ˆçœ‹çœ‹æ ¼å¼ï¼š `template <typename T> rettype funcname (parameter list) { }`ã€‚

è¯´å®è¯ï¼Œæˆ‘æ„Ÿè§‰ C++ è¿™ä¸€ç‚¹å°±åšçš„éå¸¸å¥½ï¼Œäººå®¶åœ¨å¼€å¤´å°±ç‰¹åˆ«å¼ºè°ƒäº†ï¼Œè¿™æ˜¯ä¸€ä¸ª `template`ï¼Œå¤§å®¶ä¸è¦æé”™äº†ï¼ŒæŒ‰ç…§è¿™ä¸ªæ ¼å¼ï¼Œæˆ‘ä»¬æ¥ä¸€ä¸ªç®€å•çš„ `Sum` æ“ä½œï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    #include <iostream>
    
    //æ±‚å’Œå‡½æ•°
    template <typename T> T getsum(T  t1, T  t2) {
    	return t1 + t2;
    }
    
    int main() {
    
    	int sum1 = getsum<int>(10, 10);
    
    	long sum2 = getsum<long>(20, 20);
    
    	printf("output: intï¼šsum=%d, long: sum=%ld", sum1, sum2);
    }
    
    

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6d7f55c0a874a36b074d17dbad18d75~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ä¸‹æ¥æˆ‘å°±å¾ˆå¥½å¥‡ï¼Œè¿™ç§ç©æ³•å’Œ `æ™®é€šæ–¹æ³•` è°ƒç”¨æœ‰ä»€ä¹ˆä¸åŒï¼Œè¦æƒ³æ‰¾åˆ°ç­”æ¡ˆï¼Œå¯ä»¥ç”¨ `IDA` å»çœ‹å®ƒçš„é™æ€æ±‡ç¼–ä»£ç ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7982884cc8fc443fa8c642114f0d0395~tplv-k3u1fbpfcp-zoom-1.image)

ä»é™æ€åæ±‡ç¼–ä»£ç çœ‹ï¼Œå½“å‰ç”Ÿæˆäº†ä¸¤ä¸ªå‡½æ•°ç¬¦å·åˆ†åˆ«ä¸ºï¼š `j_??$getsum@H@@YAHHH@Z` å’Œ `j_??$getsum@J@@YAJJJ@Z`ï¼Œç°åœ¨æˆ‘ä»¬å°±ææ¸…æ¥šäº†ï¼ŒåŸæ¥ä¸€æ—¦ç»™ `æ¨¡æ¿` æŒ‡å®šäº†å…·ä½“ç±»å‹ï¼Œå®ƒå°±ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„å‡½æ•°ç¬¦å·ã€‚

ä¹ä¸€çœ‹è¿™å¥è¯å¥½åƒæ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¦‚æœä½ å¿ƒæ¯”è¾ƒç»†çš„è¯ï¼Œä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘è°ƒç”¨ä¸¤æ¬¡ `getsum<int>` æ–¹æ³•ï¼Œé‚£ä¼šç”Ÿæˆä¸¤ä¸ªå…·ä½“å‡½æ•°å—ï¼Ÿ ä¸ºäº†å¯»æ‰¾ç­”æ¡ˆï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç ï¼š

    
    int main() {
    
    	int sum1 = getsum<int>(10, 10);
    
    	int sum2 = getsum<int>(15, 15);
    }
    
    

ç„¶åå†ç”¨ IDA æŸ¥çœ‹ä¸€ä¸‹ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4bf20d4abf0c43699a3b26fa8a1a51d7~tplv-k3u1fbpfcp-zoom-1.image)

å“ˆå“ˆï¼Œå¯ä»¥å‘ç°è¿™æ—¶å€™å¹¶æ²¡æœ‰ç”Ÿæˆä¸€ä¸ªæ–°çš„`å‡½æ•°ç¬¦å·`ï¼Œå…¶å®å¾€ç»†å¤„è¯´ï¼š`j_??$getsum@H@@YAHHH@Z` æ˜¯`å‡½æ•°ç­¾å`ç»„åˆå‡ºæ¥çš„åå­—ï¼Œå› ä¸ºå®ƒä»¬ç­¾åä¸€è‡´ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå¿…ç„¶å°±ä¸€ä¸ªäº†ã€‚

### 2\. ç±»æ¨¡æ¿çš„ç©æ³•

é¦–å…ˆçœ‹ä¸‹ç±»æ¨¡æ¿çš„æ ¼å¼ï¼š`template <typename T1, typename T2, â€¦> class className { };`

è¿˜æ˜¯é‚£å¥è¯ï¼Œå¼€å¤´ä¸€ä¸ª `template` æš´å‡»ï¼Œå‘Šè¯‰ä½ è¿™æ˜¯ä¸€ä¸ªæ¨¡æ¿ ğŸ˜„ğŸ˜„ğŸ˜„, æ¥ä¸‹æ¥ä¸Šä¸€æ®µä»£ç ï¼š

    
    #include <iostream>
    
    template <typename T> class Calculator
    {
    public:
    	T getsum(T a1, T b1) {
    		return a1 + b1;
    	}
    };
    
    int main() {
    
    	Calculator<int> cal1;
    	int sum1 = cal1.getsum(10, 10);
    
    	Calculator<long> cal2;
    	int sum2 = cal2.getsum(15, 15);
    
    	printf("output: sum1=%d, sum2=%ld", sum1,sum2);
    }
    
    

æ¥ä¸‹æ¥ç›´æ¥çœ‹ IDA ç”Ÿæˆçš„æ±‡ç¼–ä»£ç ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0e2a298278714cd4be60214658acebaf~tplv-k3u1fbpfcp-zoom-1.image)

ä»ä¸Šé¢çš„æ–¹æ³•ç­¾åç»„ç»‡ä¸Šçœ‹ï¼Œæœ‰ç‚¹æ„æ€ï¼Œ`ç±»å+æ–¹æ³•å` æŸ”å’Œåˆ°ä¸€ä¸ªå‡½æ•°ç¬¦å·ä¸Šå»äº†ï¼Œå¯ä»¥çœ‹åˆ°ç¬¦å·ä¸ä¸€æ ·ï¼Œè¯´æ˜ä¹Ÿæ˜¯æ ¹æ®æ¨¡æ¿å®ä¾‹åŒ–å‡ºçš„ä¸¤ä¸ªæ–¹æ³•ã€‚

äºŒï¼šC# ä¸­çš„æ¨¡æ¿ç©æ³•
-----------

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹ C# ä¸­å¦‚ä½•å®ç° getsum æ–¹æ³•ï¼Œå½“æˆ‘æŠŠä»£ç  copy åˆ° C# ä¸­ï¼Œæˆ‘å‘ç°ä¸èƒ½å®ç°ç®€å•çš„ `æ³›å‹å‚æ•°` åŠ å‡ä¹˜é™¤æ“ä½œï¼Œè¿™å°±å¤ªæäº†ï¼Œç½‘ä¸Šæ‰¾äº†ä¸‹å®ç°æ–¹å¼ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è®© T çº¦æŸäº `unmanaged`ï¼Œé‚£å°±å˜æˆæŒ‡é’ˆç©æ³•äº†ã€‚

    
    namespace ConsoleApp1
    {
        internal class Program
        {
            static void Main(string[] args)
            {
                Calculator<int> calculator1 = new Calculator<int>();
                Calculator<long> calculator2 = new Calculator<long>();
    
                int sum1 = calculator1.getsum(10, 10);
    
                long sum2 = calculator2.getsum(15, 15);
    
                Console.WriteLine($"sum={sum1}, sum2={sum2}");
                Console.ReadLine();
            }
        }
    
        public class Calculator<T> where T : struct, IComparable
        {
            public T getsum(T a1, T b1)
            {
                if (typeof(T) == typeof(int))
                {
                    int a = (int)Convert.ChangeType(a1, typeof(int));
                    int b = (int)Convert.ChangeType(b1, typeof(int));
    
                    int c = a + b;
                    return (T)Convert.ChangeType(c, typeof(T));
                }
                else if (typeof(T) == typeof(float))
                {
                    float a = (float)Convert.ChangeType(a1, typeof(float));
                    float b = (float)Convert.ChangeType(b1, typeof(float));
    
                    float c = a + b;
                    return (T)Convert.ChangeType(c, typeof(T));
                }
                else if (typeof(T) == typeof(double))
                {
                    double a = (double)Convert.ChangeType(a1, typeof(double));
                    double b = (double)Convert.ChangeType(b1, typeof(double));
    
                    double c = a + b;
                    return (T)Convert.ChangeType(c, typeof(T));
                }
                else if (typeof(T) == typeof(decimal))
                {
                    decimal a = (decimal)Convert.ChangeType(a1, typeof(decimal));
                    decimal b = (decimal)Convert.ChangeType(b1, typeof(decimal));
    
                    decimal c = a + b;
                    return (T)Convert.ChangeType(c, typeof(T));
                }
    
                return default(T);
            }
        }
    }
    
    

é‚£æ€ä¹ˆå»çœ‹ `Calculator<int>` å’Œ `Calculator<long>` åˆ°åº•å˜æˆå•¥äº†å‘¢ï¼Ÿ å¤§å®¶åº”è¯¥çŸ¥é“ï¼ŒC# å’Œ æ“ä½œç³»ç»Ÿ éš”äº†ä¸€å±‚ C++ï¼Œæ‰€ä»¥ç ”ç©¶è¿™ç§è¿œç¦»æ“ä½œç³»ç»Ÿçš„è¯­è¨€è¿˜æ˜¯æœ‰ä¸€ç‚¹éš¾åº¦çš„ï¼Œä¸è¿‡æ—¢ç„¶éš”äº†ä¸€å±‚ C++ ï¼Œé‚£åœ¨ C++ å±‚é¢ä¸Šå¿…ç„¶ä¼šæœ‰æ‰€ååº”ã€‚

å¦‚æœä½ ç†Ÿæ‚‰ CLR çš„ç±»å‹ç³»ç»Ÿï¼Œåº”è¯¥çŸ¥é“ C# æ‰€æœ‰çš„ ç±» åœ¨å…¶ä¸Šéƒ½æœ‰ä¸€ä¸ª `MethodTable` ç±»æ¥æ‰¿è½½ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯é‰´åˆ«æˆ‘ä»¬æ˜¯å¦ç”Ÿæˆå¤šä¸ªä¸ªä½“çš„ä¾æ®ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ WinDbg æŸ¥çœ‹æ‰˜ç®¡å †ï¼Œçœ‹çœ‹åœ¨å…¶ä¸Šæ˜¯å¦‚ä½•å‘ˆç°çš„ã€‚

    
    0:008> !dumpheap -stat
    Statistics:
                  MT    Count    TotalSize Class Name
    00007ff9d37638e0        1           24 ConsoleApp1.Calculator`1[[System.Int64, System.Private.CoreLib]]
    00007ff9d3763800        1           24 ConsoleApp1.Calculator`1[[System.Int32, System.Private.CoreLib]]             
    
    

ä»è¾“å‡ºä¿¡æ¯çœ‹ï¼ŒC++ å±‚é¢å˜æˆäº†ä¸¤ä¸ª `methodtable` ç±»ï¼Œå¦‚æœä¸ä¿¡çš„åŒ–ï¼Œè¿˜å¯ä»¥åˆ†åˆ«æŸ¥çœ‹ mt ä¸‹çš„æ‰€æœ‰æ–¹æ³•ã€‚

    
    0:008> !dumpmt -md 00007ff9d37638e0
    MethodDesc Table
               Entry       MethodDesc    JIT Name
    ...
    00007FF9D36924E8 00007ff9d37638d0    JIT ConsoleApp1.Calculator`1[[System.Int64, System.Private.CoreLib]]..ctor()
    00007FF9D36924E0 00007ff9d37638c0    JIT ConsoleApp1.Calculator`1[[System.Int64, System.Private.CoreLib]].getsum(Int64, Int64)
    
    0:008> !dumpmt -md 00007ff9d3763800
    --------------------------------------
    MethodDesc Table
               Entry       MethodDesc    JIT Name
    00007FF9D36924D0 00007ff9d37637f0    JIT ConsoleApp1.Calculator`1[[System.Int32, System.Private.CoreLib]]..ctor()
    00007FF9D36924C8 00007ff9d37637e0    JIT ConsoleApp1.Calculator`1[[System.Int32, System.Private.CoreLib]].getsum(Int32, Int32)
    
    

ä»è¾“å‡ºä¿¡æ¯çœ‹ï¼Œ`getsum(Int64, Int64)` å’Œ `getsum(Int32, Int32)` æ–¹æ³•çš„å…¥å£åœ°å€ `Entry` æ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å®ƒä»¬æ˜¯å®Œå…¨ç‹¬ç«‹çš„ä¸ªä½“ã€‚

ä¸‰ï¼šæ€»ç»“
----

å½“çœ‹åˆ° `æ¨¡æ¿` å’Œ `æ³›å‹` ä¸¤ä¸ªè¯ï¼Œæˆ‘æ„Ÿè§‰å‰è€…æ›´ **é€šä¿—æ˜“æ‡‚** ä¸€äº›ï¼Œå½“ç»™`æ¨¡æ¿`èµ‹äºˆä¸åŒç±»å‹æ—¶å°†ä¼šç”Ÿæˆæ–°çš„å®ä¾‹ï¼Œåœ¨ `C/C++` ä¸­ç›´æ¥åŒ–ä¸ºä¸åŒçš„å‡½æ•°ç¬¦å·ï¼Œåœ¨ C# ä¸­ä¼šç”Ÿæˆä¸åŒçš„ `MethodTable`ï¼Œç”±äº C# è¿œç¦»æœºå™¨ï¼Œ æ‰€ä»¥å°½é‡è°ˆåˆ° C++ å±‚é¢å³å¯ ğŸ¤£ğŸ¤£ğŸ¤£

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)