---
layout: post
title: "æ‰‹å†™æ•°æ®åº“è¿æ¥æ± "
date: "2022-06-21T22:17:16.336Z"
---
æ‰‹å†™æ•°æ®åº“è¿æ¥æ± 
========

ğŸ“•æ•°æ®åº“è¿æ¥æ± é¡¹ç›®
==========

### ä¸€ã€é¡¹ç›®æ„ä¹‰

åœ¨è®¾è®¡å‰å…ˆäº†è§£ä¸€ä¸‹æ•°æ®åº“è¿æ¥æ± çš„ä½œç”¨ï¼š

é™¤äº†åœ¨æœåŠ¡å™¨ç«¯å¢åŠ ç¼“å­˜æœåŠ¡å™¨ç¼“å­˜å¸¸ç”¨çš„æ•°æ® ä¹‹å¤–ï¼ˆä¾‹å¦‚redisï¼‰ï¼Œè¿˜å¯ä»¥**å¢åŠ è¿æ¥æ± ï¼Œæ¥æé«˜MySQL Serverçš„è®¿é—®æ•ˆç‡ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œå¤§é‡çš„ TCPä¸‰æ¬¡æ¡æ‰‹ã€MySQL Serverè¿æ¥è®¤è¯ã€MySQL Serverå…³é—­è¿æ¥å›æ”¶èµ„æºå’ŒTCPå››æ¬¡æŒ¥æ‰‹æ‰€è€—è´¹çš„ æ€§èƒ½æ—¶é—´ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå¢åŠ è¿æ¥æ± å°±æ˜¯ä¸ºäº†å‡å°‘è¿™ä¸€éƒ¨åˆ†çš„æ€§èƒ½æŸè€—**ã€‚

### äºŒã€ç¯å¢ƒé…ç½®

**MySQæ•°æ®åº“ç¼–ç¨‹ç¯å¢ƒé…ç½®ï¼š**

åœ¨win10çš„vsé¡¹ç›®ä¸­ç”¨C/C++å®¢æˆ·ç«¯å¼€å‘åŒ…ï¼Œvsåšå¦‚ä¸‹é…ç½®ï¼š

1.å³é”®é¡¹ç›®å±æ€§ - C/C++ - å¸¸è§„ - é™„åŠ åŒ…å«ç›®å½•ï¼Œå¡«å†™mysql.hå¤´æ–‡ä»¶çš„è·¯å¾„

2.å³é”®é¡¹ç›®å±æ€§ - é“¾æ¥å™¨ - å¸¸è§„ - é™„åŠ åº“ç›®å½•ï¼Œå¡«å†™libmysql.libçš„è·¯å¾„

3.å³é”®é¡¹ç›®å±æ€§ - é“¾æ¥å™¨ - è¾“å…¥ - é™„åŠ ä¾èµ–é¡¹ï¼Œå¡«å†™libmysql.libåº“çš„åå­—

4.æŠŠlibmysql.dllåŠ¨æ€é“¾æ¥åº“ï¼ˆLinuxä¸‹åç¼€åæ˜¯.soåº“ï¼‰æ”¾åœ¨å·¥ç¨‹ç›®å½•ä¸‹ï¼›

å¦‚æœè¿è¡Œæ•°æ®åº“è¿æ¥æ–‡ä»¶å‡ºç°ï¼š![image-20220415102021161](https://fastly.jsdelivr.net/gh/little-boy-David/blog-img/images202206212336262.png)

è¯´æ˜ç³»ç»Ÿç¯å¢ƒå˜é‡ä¸­æ²¡æœ‰é…ç½®MySQLç¯å¢ƒï¼Œæ‰¾ä¸åˆ°åŠ¨æ€é“¾æ¥ï¼Œè§£å†³æ–¹æ¡ˆï¼šåœ¨ç³»ç»Ÿç¯å¢ƒå˜é‡æ·»åŠ MySQLçš„binæ–‡ä»¶å¤¹è·¯å¾„ï¼› ä¹Ÿå¯ä»¥åœ¨ å³é”®é¡¹ç›®å±æ€§ - è°ƒè¯• - ç¯å¢ƒï¼Œå¡«å†™ PATH=è‡ªå·±MySQLçš„binæ–‡ä»¶å¤¹è·¯å¾„ï¼›

### ä¸‰ã€é¡¹ç›®è®¾è®¡

æ‰€éœ€è¦å®ç°çš„æ•°æ®åº“è¿æ¥æ± åŠŸèƒ½ï¼šè¿æ¥æ± æœ‰è¿æ¥æ•°é‡çš„èµ·å§‹å€¼å’Œé˜ˆå€¼ï¼›è¿æ¥æ± å¯ä»¥åŠ¨æ€è‡ªåŠ¨ç”Ÿæˆå’Œå›æ”¶è¿æ¥æ± é‡Œé¢çš„èµ„æºï¼›è¿æ¥æ± å’Œæ•°æ®åº“ä¿¡æ¯ç­‰åˆ†ç¦»ï¼Œè¾¾åˆ°å¤ç”¨ç®€å•çš„æ•ˆæœï¼›

â‘ è®¾è®¡ä¸€ä¸ªæ•°æ®åº“çš„çš„åŸºæœ¬æ“ä½œç±»

*   å°è£…æ•°æ®åº“çš„è¿æ¥ã€å¢åˆ æ”¹æŸ¥æ“ä½œï¼›
*   ç»™è¯¥åŸºæœ¬æ“ä½œç±»åŠ ä¸Šå­˜æ´»æ—¶é—´ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•ï¼›

â‘¡æ•°æ®åº“è¿æ¥æ± ç±»

*   å› ä¸ºæ˜¯ä¸€ä¸ªæ± å¯¹åº”å¤šä¸ªèµ„æºï¼ˆå¯¹è±¡ï¼‰çš„å…³ç³»ï¼Œæˆ‘ä»¬ä¹Ÿåªéœ€è¦ä¸€ä¸ªæ± ï¼Œè®¾è®¡æˆå•ä¾‹æ¨¡å¼ï¼›
    
*   ä¿å­˜å«æœ‰åŸºæœ¬æ“ä½œç±»ä¸€ç¾¤å¯¹è±¡èµ„æºï¼›
    
*   æœ‰èµ„æºçš„åˆå§‹åŒ–ã€å¢åŠ ã€é‡Šæ”¾æ“ä½œï¼ˆé‡Šæ”¾å’Œå­˜æ´»æ—¶é—´ç›¸å…³ï¼‰
    

### å››ã€è¯¦ç»†ä»£ç 

ä»£ç ç»“æ„ï¼š

![image-20220621230851817](https://fastly.jsdelivr.net/gh/little-boy-David/blog-img/images202206212336730.png)

â‘ public.hï¼š è¯¥è¿æ¥æ± çš„å…¨å±€æ—¥å¿—è¾“å‡ºï¼Œæ‰“å°ä¸€äº›é”™è¯¯åœ¨logä¸­ï¼›

    #pragma once
    /*
    * å®šä¹‰å®ç­‰å…¨å±€å®šä¹‰
    */
    
    #define LOG(str) \
    	cout << __FILE__ << ":" << __LINE__ << " " << \
    	__TIMESTAMP__ << " : " << str << endl;
    

â‘¡mysql.iniï¼šmysqlçš„è¯¦ç»†ä¿¡æ¯

    #æ•°æ®åº“è¿æ¥æ± çš„é…ç½®æ–‡ä»¶,å’Œå®å®šä¹‰ä¸€æ ·ï¼Œæ³¨æ„è¡Œåé¢ä¸è¦æœ‰ç©ºæ ¼
    ip=127.0.0.1
    port=3306
    username=root
    password=root
    dbname=chat
    initSize=10
    maxSize=1024
    #æœ€å¤§ç©ºé—²æ—¶é—´é»˜è®¤ç§’
    maxIdleTime=60
    #è¿æ¥è¶…æ—¶æ—¶é—´å•ä½æ˜¯æ¯«ç§’
    connectionTimeout=100
    

â‘¢Connection.h å’Œ Connection.cpp ï¼šæ•°æ®åº“æ“ä½œç±» å¤´æ–‡ä»¶å’Œå®ç°ï¼›

Connection.hï¼š

    using namespace std;
    #include "public.h"
    
    // æ•°æ®åº“æ“ä½œç±»
    class Connection
    {
    public:
    	// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    	Connection();
    	// é‡Šæ”¾æ•°æ®åº“è¿æ¥èµ„æº
    	~Connection();
    	// è¿æ¥æ•°æ®åº“
    	bool connect(string ip, unsigned short port, string user, string password, string dbname);
    	// æ›´æ–°æ“ä½œ insertã€deleteã€update
    	bool update(string sql);
    	// æŸ¥è¯¢æ“ä½œ:select;
    	MYSQL_RES* query(string sql);
    
    	//åˆ·æ–°ä¸€ä¸‹è¿æ¥çš„èµ·å§‹ç©ºé—²æ—¶é—´ç‚¹
    	void refreshAliveTime() { _alivetime = clock(); }//clock()å‡½æ•°å½“ä¸‹æ—¶é—´
    	// è¿”å›å­˜æ´»çš„æ—¶é—´
    	clock_t getAliveTime() { return clock() - _alivetime; }
    
    private:
    	MYSQL* _conn; // è¡¨ç¤ºå’ŒMySQL Serverçš„ä¸€æ¡è¿æ¥
    	clock_t _alivetime;// è®°å½•è¿›å…¥ç©ºé—²çŠ¶æ€åçš„å­˜æ´»æ—¶é—´
    };
    

Connection.cppï¼š

    #include "Connection.h"
    #include "public.h"
    
    // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    Connection::Connection()
    {
    	_conn = mysql_init(nullptr);
    }
    // é‡Šæ”¾æ•°æ®åº“è¿æ¥èµ„æº
    Connection::~Connection()
    {
    	if (_conn != nullptr)
    		mysql_close(_conn);
    }
    // è¿æ¥æ•°æ®åº“
    bool Connection::connect(string ip, unsigned short port, string username, string password, string dbname)
    {
    	MYSQL* p = mysql_real_connect(_conn, ip.c_str(), username.c_str(), password.c_str(), dbname.c_str(), port, nullptr, 0);
    	return p != nullptr;
    }
    // æ›´æ–°æ“ä½œ insertã€deleteã€update
    bool Connection::update(string sql)
    {
    	if (mysql_query(_conn, sql.c_str()))//å¦‚æœæŸ¥è¯¢æˆåŠŸï¼Œè¿”å›0ã€‚å¦‚æœå‡ºç°é”™è¯¯ï¼Œè¿”å›é0å€¼ã€‚
    	{
    		LOG("æ›´æ–°å¤±è´¥:" + sql);
    		return false;
    	}
    	return true;
    }
    // æŸ¥è¯¢æ“ä½œ:select;
    MYSQL_RES* Connection::query(string sql)
    {
    	if (mysql_query(_conn, sql.c_str()))
    	{
    		LOG("æŸ¥è¯¢å¤±è´¥:" + sql);
    		return nullptr;
    	}
    	return mysql_use_result(_conn);
    }
    
    

â‘£MySQLConnectionPool.hå’ŒMySQLConnectionPool.cppï¼šè¿æ¥æ± ç±»å¤´æ–‡ä»¶å’Œå®ç°

MySQLConnectionPool.hï¼š

    #pragma once
    #include <iostream>
    #include <string>
    #include <queue>
    #include <mutex>
    #include <condition_variable>
    #include <atomic>
    #include <thread>
    #include <memory>
    #include <functional>
    #include "Connection.h"
    
    using namespace std;
    /*
    * å®ç°è¿æ¥æ± æ¨¡å—
    */
    class ConnectionPool
    {
    public:
    	//è·å–è¿æ¥æ± å¯¹è±¡å®ä¾‹
    	static ConnectionPool* getConnectionPool();
    	// æ¶ˆè´¹è€…çº¿ç¨‹å‡½æ•°ï¼šç»™ç”¨æˆ·è¿æ¥ï¼Œå½’è¿˜æ—¶æ”¾å›è¿æ¥æ± 
    	shared_ptr<Connection> getConnection();
    
    private:
    	//å•ä¾‹#1 æ„é€ å‡½æ•°ç§æœ‰åŒ–
    	ConnectionPool(); 
    
    	//ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½é…ç½®
    	bool loadConfigFile();
    
    	//ç”Ÿäº§è€…çº¿ç¨‹å‡½æ•°ï¼šè¿è¡Œç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œè´Ÿè´£ç”Ÿäº§æ–°è¿æ¥,æ”¾åœ¨ç±»å†…æ–¹ä¾¿è®¿é—®æˆå‘˜å˜é‡
    	void produceConnectionTask();
    
    	//å›æ”¶çº¿ç¨‹å‡½æ•°ï¼šæ‰«æè¶…è¿‡maxIdleTimeæ—¶é—´çš„ç©ºé—²è¿æ¥ï¼Œè¿›è¡Œå¤šä½™çš„è¿æ¥å›æ”¶
    	void scannerConnectionTask();
    
    	string _ip;// mysql ip
    	unsigned short _port; //mysql ç«¯å£ é»˜è®¤3306
    	string _username;// mysql ç”¨æˆ·åï¼›
    	string _password;// mysqlç™»å½•ç§˜å¯†
    	string _dbname; // æ•°æ®åº“åç§°
    	int _initSize;// è¿æ¥æ± çš„åˆå§‹è¿æ¥é‡
    	int _maxSize;// è¿æ¥æ± çš„æœ€å¤§è¿æ¥é‡
    	int _maxIdleTime; //è¿æ¥æ± æœ€å¤§ç©ºé—²æ—¶é—´
    	int _connectionTimeout;//è¿æ¥æ± è·å–è¿æ¥çš„è¶…æ—¶æ—¶é—´
    
    	queue<Connection*> _connectionQue; //å­˜å‚¨mysqlè¿æ¥çš„é˜Ÿåˆ—ï¼Œå¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼›
    	mutex _queueMutex;//ç»´æŠ¤è¿æ¥é˜Ÿåˆ—çš„çº¿ç¨‹å®‰å…¨äº’æ–¥é”
    	atomic_int _connectionCnt;// è®°å½•è¿æ¥æ‰€åˆ›å»ºçš„connectionè¿æ¥çš„æ€»æ•°é‡ï¼Œè€ƒè™‘äº†è¿æ¥ç”Ÿäº§æ¶ˆè´¹æ•°é‡å˜åŒ–çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
    	condition_variable cv; //è®¾ç½®æ¡ä»¶å˜é‡ï¼Œç”¨äºè¿æ¥ ç”Ÿäº§çº¿ç¨‹å’Œæ¶ˆè´¹çº¿ç¨‹çš„é€šä¿¡
    };
    
    
    

MySQLConnectionPool.cppï¼š

    // MySQlConnectionPool.cpp : æ­¤æ–‡ä»¶åŒ…å« "main" å‡½æ•°ã€‚ç¨‹åºæ‰§è¡Œå°†åœ¨æ­¤å¤„å¼€å§‹å¹¶ç»“æŸã€‚
    //é¿å…é‡å¤åŒ…å«å¤´æ–‡ä»¶
    #ifndef __COMPLEX__
    #define __COMPLEX__
    
    #include <iostream>
    #include <string>
    #include "MySQLConnectionPool.h"
    #include "public.h"
    
    #endif;
    // çº¿ç¨‹å®‰å…¨çš„æ‡’æ±‰å•ä¾‹å‡½æ•°æ¥å£
    ConnectionPool* ConnectionPool::getConnectionPool()
    {
    	static ConnectionPool pool; // é™æ€å˜é‡å®ç°lockå’Œunlock,æ‹¿å•ä¾‹çš„çº¿ç¨‹æ± ï¼›
    	return &pool;
    }
    
    // ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½é…ç½®é¡¹
    bool ConnectionPool::loadConfigFile()
    {
    	FILE* pf = fopen("mysql.ini", "r");
    	if (pf == nullptr)
    	{
    		LOG("mysql.ini file is not exist!");
    		return false;
    	}
    
    	while (!feof(pf))//æœ«å°¾æŸ¥ä¸€ä¸‹
    	{
    		char line[1024] = { 0 };
    		fgets(line, 1024, pf);
    		string str = line;
    		int idx = str.find('=', 0);//æ‰¾å‡ºç¬¬ä¸€ä¸ªå‡ºç°=å·çš„ä¸‹æ ‡
    		if (idx == -1)//æ‰¾ä¸åˆ°ï¼Œæ— æ•ˆé…ç½®é¡¹
    		{
    			continue;
    		}
    
    		//å®é™…ä¸­æ˜¯ç”±\nç»“å°¾çš„ï¼Œpassword=root\n
    		int endidx = str.find('\n', idx);
    		string key = str.substr(0, idx); //å‚æ•°æ„ä¹‰ï¼šæˆªå–çš„èµ·ç‚¹ä»¥åŠæˆªå–é•¿åº¦
    		string value = str.substr(idx + 1, endidx - idx - 1);
    
    		//å­˜å€¼
    		if (key == "ip") _ip = value;
    		else if (key == "port") _port = atoi(value.c_str());
    		else if (key == "username") _username = value;
    		else if (key == "password") _password = value;
    		else if (key == "dbname") _dbname = value;
    		else if (key == "initSize") _initSize = atoi(value.c_str());
    		else if (key == "maxSize") _maxSize = atoi(value.c_str());
    		else if (key == "maxIdleTime") _maxIdleTime = atoi(value.c_str());
    		else if (key == "connectionTimeout") _connectionTimeout = atoi(value.c_str());
    
    	}
    }
    
    // è¿æ¥æ± çš„æ„é€ 
    ConnectionPool::ConnectionPool()
    {
    	//åŠ è½½é…ç½®é¡¹
    	if (!loadConfigFile())
    	{
    		return;
    	}
    
    	//åˆ›å»ºåˆå§‹æ•°é‡çš„è¿æ¥
    	for (int i = 0; i < _initSize; ++i)
    	{
    		Connection* p = new Connection();
    		p->connect(_ip, _port, _username, _password, _dbname);
    		p->refreshAliveTime();// åˆ·æ–°ä¸€ä¸‹å¼€å§‹ç©ºé—²èµ·å§‹æ—¶é—´ï¼›
    		_connectionQue.push(p);
    		_connectionCnt++;
    	}
    
    	//éœ€è¦å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œä½œä¸ºè¿æ¥çš„ç”Ÿäº§è€…ï¼ˆç”Ÿäº§è€…çº¿ç¨‹ï¼‰ 
    	//c++çš„çº¿ç¨‹å‡½æ•°åœ¨linuxé‡Œé¢åº•å±‚ä¹Ÿæ˜¯pthread_creat,éœ€è¦ä¼ å…¥cæ¥å£ï¼Œæ‰€ä»¥ä¼ å…¥ç±»æ–¹æ³•éœ€è¦ç»‘å®š
    	thread produce(std::bind(&ConnectionPool::produceConnectionTask, this));
    	produce.detach();
    
    	//å¯åŠ¨ä¸€ä¸ªæ–°çš„å®šæ—¶çº¿ç¨‹ï¼Œæ‰«æè¶…è¿‡maxIdleTimeæ—¶é—´çš„ç©ºé—²è¿æ¥ï¼Œè¿›è¡Œå¤šä½™çš„è¿æ¥å›æ”¶
    	thread scanner(std::bind(&ConnectionPool::scannerConnectionTask, this));
    	scanner.detach();
    }
    
    //ç”Ÿäº§è€…çº¿ç¨‹ï¼šè¿è¡Œç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œè´Ÿè´£ç”Ÿäº§æ–°è¿æ¥,æ”¾åœ¨ç±»å†…æ–¹ä¾¿è®¿é—®æˆå‘˜å˜é‡
    void ConnectionPool::produceConnectionTask()
    {
    	for (;;)
    	{
    		unique_lock<mutex> lock(_queueMutex);
    		while (!_connectionQue.empty())
    		{
    			cv.wait(lock); //é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œæ­¤å¤„ç”Ÿäº§çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€,é‡Šæ”¾é”
    		}
    
    		//å¯ä»¥ç”Ÿäº§æ–°è¿æ¥ï¼Œåˆ›å»ºæ–°è¿æ¥
    		if (_connectionCnt < _maxSize) { 
    			Connection* p = new Connection();
    			p->connect(_ip, _port, _username, _password, _dbname);
    			p->refreshAliveTime();// åˆ·æ–°ä¸€ä¸‹å¼€å§‹ç©ºé—²èµ·å§‹æ—¶é—´ï¼›		
    			_connectionQue.push(p);
    			_connectionCnt++;
    		}
    
    		//é€šçŸ¥æ¶ˆè´¹è€…çº¿ç¨‹å¯ä»¥æ¶ˆè´¹è¿æ¥äº†
    		cv.notify_all();
    	}
    }
    
    // æ¶ˆè´¹è€…çº¿ç¨‹ï¼šç»™ç”¨æˆ·è¿æ¥ï¼Œä»è¿æ¥æ± ä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„ç©ºé—²è¿æ¥
    shared_ptr<Connection> ConnectionPool::getConnection()
    {
    	unique_lock<mutex> lock(_queueMutex);
    	//if (_connectionQue.empty())//ç©ºçš„å°±è®©ç”Ÿäº§è€…ç”Ÿäº§
    	//{
    	//	//ä¸å¯ä»¥ç”¨sleepï¼Œsleepæ˜¯ç›´æ¥ç¡ï¼Œè€Œwait_foræ˜¯è¢«é€šçŸ¥å°±å¯ä»¥é©¬ä¸Šç»§ç»­èµ°
    	//	cv.wait_for(lock, chrono::milliseconds(_connectionTimeout));//æ¯«ç§’ï¼Œè¶…è¿‡æ—¶é—´æ²¡æœ‰è¢«å”¤é†’çš„è¯ä¹Ÿä¼šå‡ºæ¥
    	//	if (_connectionQue.empty())
    	//	{
    	//		LOG("è·å–ç©ºé—²è¿æ¥è¶…æ—¶äº†!!!è·å–è¿æ¥å¤±è´¥");
    	//		return nullptr;
    	//	}
    	//}
    
    	//ä¸Šè¿°æ²¡æœ‰è€ƒè™‘å¥½ï¼Œæœ‰å¯èƒ½ç­‰å¾…è¿‡ç¨‹ä¸­æ˜¯è¢«å”¤é†’çš„ï¼Œä½†æ˜¯æ‹¿é”æ…¢ï¼Œè¿˜æ˜¯è¢«æ‹¿èµ°äº†é”
    	//ä¼˜åŒ–ä¸€ä¸‹ï¼š
    	while (_connectionQue.empty())
    	{
    		if (cv_status::timeout == cv.wait_for(lock, chrono::milliseconds(_connectionTimeout)))
    		{
    			//æ˜¯çœŸçš„è¶…æ—¶äº†ï¼Œ å¹¶ä¸”è¿æ¥æ± ä¸ºç©º
    			if (_connectionQue.empty())
    			{
    				LOG("è·å–ç©ºé—²è¿æ¥è¶…æ—¶äº†!!!è·å–è¿æ¥å¤±è´¥");
    				return nullptr;
    			}			
    		}
    	}
    
    	//æœ‰è¿æ¥åœ¨æ± å­é‡Œ
    	/*
    	shared_ptræ™ºèƒ½æŒ‡é’ˆææ„æ—¶ï¼Œé»˜è®¤ä¼šè°ƒç”¨connectionææ„å‡½æ•°ï¼Œconnectionå°±ä¼šè¢«close
    	è¿™é‡Œå°±éœ€è¦è‡ªå®šä¹‰share_ptrçš„é‡Šæ”¾èµ„æºæ–¹å¼ï¼šæŠŠconnectionç›´æ¥å½’è¿˜åˆ°_connectionQueä¸­ï¼›
    	*/
    	shared_ptr<Connection> sp(_connectionQue.front(),
    		[&](Connection* pcon) {
    			//è¿™é‡Œæ˜¯åœ¨æœåŠ¡å™¨(å¤šçº¿ç¨‹)æ¶ˆè´¹è€…çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œæ¶‰åŠäº†å…±äº«æ•°æ®ï¼Œæ‰€ä»¥ä¸€å®šè¦è€ƒè™‘é˜Ÿåˆ—çš„çº¿ç¨‹å®‰å…¨æ“ä½œ
    			unique_lock<mutex> lock(_queueMutex);
    			pcon->refreshAliveTime();// åˆ·æ–°ä¸€ä¸‹å¼€å§‹ç©ºé—²èµ·å§‹æ—¶é—´ï¼›
    			_connectionQue.push(pcon);
    		});
    	_connectionQue.pop();
    	//if (_connectionQue.empty()) //è¿™æ ·å†™ä¹Ÿå¯ä»¥
    	//{
    	//	cv.notify_all();//æ¶ˆè´¹å®Œè¿æ¥åå‘ç°é˜Ÿåˆ—ä¸ºç©ºï¼Œé€šçŸ¥ç”Ÿäº§è€…çº¿ç¨‹ï¼›
    	//}
    	cv.notify_all();//æ¶ˆè´¹å®Œè¿æ¥åï¼Œé€šçŸ¥ç”Ÿäº§è€…çº¿ç¨‹æ£€æŸ¥çº¿ç¨‹æ± æ˜¯å¦ä¸ºç©ºï¼›
    	return sp;
    }
    
    //å›æ”¶çº¿ç¨‹å‡½æ•°ï¼šæ‰«æè¶…è¿‡maxIdleTimeæ—¶é—´çš„ç©ºé—²è¿æ¥ï¼Œè¿›è¡Œå¤šä½™çš„è¿æ¥å›æ”¶
    void ConnectionPool::scannerConnectionTask()
    {
    	for (;;)
    	{
    		//é€šè¿‡sleepæ¨¡æ‹Ÿå®šæ—¶æ•ˆæœ
    		this_thread::sleep_for(chrono::seconds(_maxIdleTime));
    	
    		// æ‰«ææ•´ä¸ªé˜Ÿåˆ—ï¼Œé‡Šæ”¾å¤šä½™è¿æ¥
    		unique_lock<mutex> lock(_queueMutex);
    		while (_connectionCnt > _initSize)
    		{
    			Connection* p = _connectionQue.front();
    			//è¿™é‡Œéƒ½é‡Šæ”¾ï¼Ÿåº”è¯¥é‡Šæ”¾å¤§äºinitSizeä»¥ä¸Šçš„ï¼Ÿ
    			if (p->getAliveTime() > _maxIdleTime * 1000) //##é˜Ÿå¤´çš„ç©ºé—²æ—¶é—´æ˜¯æœ€é•¿çš„ï¼Œåªç”¨çœ‹é˜Ÿå¤´å°±è¡Œ
    			{
    				_connectionQue.pop();
    				_connectionCnt--;
    				delete p;//è°ƒç”¨connectinææ„å‡½æ•°
    			}
    			else
    			{
    				break;//é˜Ÿå¤´éƒ½å°äºï¼Œåé¢è‚¯å®šå°ï¼›
    			}
    		}
    	}
    }
    

### äº”ã€ä»£ç æµ‹è¯•

è¿›è¡Œå‹åŠ›æµ‹è¯•å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨è¿æ¥æ± å’Œä¸ä½¿ç”¨è¿æ¥æ± çš„æ•ˆæœï¼›

æµ‹è¯•ä»£ç ï¼šmainå‡½æ•°æ‰‹åŠ¨æµ‹è¯•

    #include <iostream>
    #include <thread>
    #include "Connection.h"
    #include "MySQLConnectionPool.h"
    
    
    using namespace std;
    
    
    int main()
    {
    	/*
    	 * æ•°æ®åº“æµ‹è¯•
    	*/
    	//Connection conn;
    	//char sql[1024] = { 0 };
    	//sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//conn.update(sql);
    
    	//å‹åŠ›æµ‹è¯•ï¼š
    	// 
    	//â‘ ä¸ç”¨è¿æ¥æ± ï¼Œå•çº¿ç¨‹,æ›´æ”¹æ•°æ®1000ã€5000ã€10000
    	clock_t begin = clock();
    	for (int i = 0; i < 1000; ++i) {
    		Connection conn;
    		char sql[1024] = { 0 };
    		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    		conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    		conn.update(sql);
    	}
    	clock_t end = clock();
    	cout << end - begin << "ms" << endl;
    
    	//â‘¡ç”¨è¿æ¥æ± å•çº¿ç¨‹ï¼Œæ›´æ”¹æ•°æ®1000ã€5000ã€10000
    	//clock_t begin = clock();
    	//ConnectionPool *cp = ConnectionPool::getConnectionPool();
    	//for (int i = 0; i < 5000; ++i) {
    	//	shared_ptr<Connection> sp= cp->getConnection();
    	//	char sql[1024] = { 0 };
    	//	sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//	sp->update(sql);
    	//}
    	//clock_t end = clock();
    	//cout << end - begin << "ms" << endl;
    
    	//â‘¢ä¸ç”¨è¿æ¥æ± çš„4çº¿ç¨‹
    	//ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸­åŒæ—¶è¿æ¥æ•°æ®åº“ï¼Œæ˜¯éæ³•çš„,éœ€è¦å…ˆåœ¨å¤–é¢å£°æ˜è¿æ¥
    	//Connection conn;
    	//conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//clock_t begin = clock();
    	//thread t1([]() {
    	//	for (int i = 0; i < 250; ++i) {
    	//		Connection conn;
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//		conn.update(sql);
    	//	}
    	//	});
    	//thread t2([]() {
    	//	for (int i = 0; i < 250; ++i) {
    	//		Connection conn;
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//		conn.update(sql);
    	//	}
    	//	});
    	//thread t3([]() {
    	//	for (int i = 0; i < 250; ++i) {
    	//		Connection conn;
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//		conn.update(sql);
    	//	}
    	//	});
    	//thread t4([]() {
    	//	for (int i = 0; i < 250; ++i) {
    	//		Connection conn;
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		conn.connect("127.0.0.1", 3306, "root", "root", "chat");
    	//		conn.update(sql);
    	//	}
    	//	});
    	//t1.join();
    	//t2.join();
    	//t3.join();
    	//t4.join();
    	//clock_t end = clock();
    	//cout << end - begin << "ms" << endl;
    
    	//â‘£ç”¨è¿æ¥æ± çš„4çº¿ç¨‹
    	//clock_t begin = clock();
    	//thread	t1([]() {
    	//	ConnectionPool* cp = ConnectionPool::getConnectionPool();
    	//	for (int i = 0; i < 250; ++i) {
    	//		shared_ptr<Connection> sp = cp->getConnection();
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		sp->update(sql);
    	//	}
    	//	});
    	//thread	t2([]() {
    	//	ConnectionPool* cp = ConnectionPool::getConnectionPool();
    	//	for (int i = 0; i < 250; ++i) {
    	//		shared_ptr<Connection> sp = cp->getConnection();
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		sp->update(sql);
    	//	}
    	//	});
    	//thread	t3([]() {
    	//	ConnectionPool* cp = ConnectionPool::getConnectionPool();
    	//	for (int i = 0; i < 250; ++i) {
    	//		shared_ptr<Connection> sp = cp->getConnection();
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		sp->update(sql);
    	//	}
    	//	});
    	//thread	t4([]() {
    	//	ConnectionPool* cp = ConnectionPool::getConnectionPool();
    	//	for (int i = 0; i < 250; ++i) {
    	//		shared_ptr<Connection> sp = cp->getConnection();
    	//		char sql[1024] = { 0 };
    	//		sprintf(sql, "insert into user(name, age, sex) values ('%s', %d, '%s')", "zhang san", 20, "male");
    	//		sp->update(sql);
    	//	}
    	//	});
    	//t1.join();
    	//t2.join();
    	//t3.join();
    	//t4.join();
    	//clock_t end = clock();
    	//cout << end - begin << "ms" << endl;
    
    	return 0;
    }
    

åˆšå¼€å§‹è¿æ¥é€Ÿåº¦ï¼Œæ’å…¥é€Ÿåº¦ææ…¢çš„åŸå› ï¼š

**æ˜¯å› ä¸º mysql8.0 ä¸€äº›è®¾ç½®æ˜¯é»˜è®¤å¼€å¯çš„(5.7 æ˜¯é»˜è®¤å…³é—­çš„)ï¼Œè€Œè¿™äº›è®¾ç½®å¯èƒ½ä¼šä¸¥é‡å½±å“æ•°æ®åº“æ€§èƒ½**

æ‰§è¡Œä»¥ä¸‹ä¼˜åŒ–ï¼š

*   åœ¨æ–‡ä»¶ my.ini æˆ– /etc/my.cnf ä¸­ï¼Œä¿®æ”¹ **mysqld** èŠ‚ç‚¹çš„å†…å®¹ï¼Œå…³é—­ log-bin åŠŸèƒ½ï¼›
*   \[ä¼˜åŒ–\][https://blog.csdn.net/weixin\_42122881/article/details/113941793](https://blog.csdn.net/weixin_42122881/article/details/113941793))

æœ€åæˆ‘è¿˜æ˜¯æ¢æˆäº†5.7çš„ç‰ˆæœ¬è¿›è¡Œæµ‹è¯•ï¼š

æ•°æ®é‡

æœªä½¿ç”¨è¿æ¥æ± æ‰€è€—æ—¶é—´

ä½¿ç”¨è¿æ¥æ± æ‰€è€—æ—¶é—´

1000

å•çº¿ç¨‹ï¼š1886ms å››çº¿ç¨‹ï¼š495ms

å•çº¿ç¨‹ï¼š1078ms å››çº¿ç¨‹ï¼š406ms

5000

å•çº¿ç¨‹ï¼š10032ms å››çº¿ç¨‹ï¼š2368ms

å•çº¿ç¨‹ï¼š5328ms å››çº¿ç¨‹ï¼š2033ms

10000

å•çº¿ç¨‹ï¼š19407ms å››çº¿ç¨‹ï¼š4579ms

å•çº¿ç¨‹ï¼š10532mså››çº¿ç¨‹ï¼š4041ms

é”»ç‚¼çš„æŠ€æœ¯ç‚¹ï¼šMySQLæ•°æ®åº“ç¼–ç¨‹ã€å•ä¾‹æ¨¡å¼ã€queueé˜Ÿåˆ—å®¹å™¨ã€C++11å¤šçº¿ç¨‹ç¼–ç¨‹ã€çº¿ç¨‹äº’æ–¥ã€çº¿ç¨‹åŒæ­¥é€šä¿¡å’Œ unique\_lockã€åŸºäºCASçš„åŸå­æ•´å½¢ã€æ™ºèƒ½æŒ‡é’ˆshared\_ptrã€lambdaè¡¨è¾¾å¼ã€ç”Ÿäº§è€…-æ¶ˆè´¹è€…çº¿ç¨‹æ¨¡å‹ï¼›