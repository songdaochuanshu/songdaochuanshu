---
layout: post
title: "é£Ÿä¹‹æ— å‘³ï¼ŸApp Startup å¯èƒ½æ¯”ä½ æƒ³è±¡ä¸­è¦ç®€å•"
date: "2022-09-04T22:18:59.514Z"
---
é£Ÿä¹‹æ— å‘³ï¼ŸApp Startup å¯èƒ½æ¯”ä½ æƒ³è±¡ä¸­è¦ç®€å•
===========================

> **è¯·ç‚¹èµå…³æ³¨ï¼Œä½ çš„æ”¯æŒå¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚**
> 
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°å½­ã€‚æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· AndroidFamily](https://github.com/pengxurui/AndroidFamily) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œæœ‰å¿—åŒé“åˆçš„æœ‹å‹ï¼Œå…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] å¸¦ä½ å»ºç«‹æ ¸å¿ƒç«äº‰åŠ›ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

è¿‡å»ä¸¤å¹´ï¼Œæˆ‘ä»¬åœ¨æ˜é‡‘å¹³å°ä¸Šå‘å¸ƒ JetPack ä¸“æ æ–‡ç« ï¼Œå°å½­ä¹Ÿå—åˆ°äº†å¤§å®¶çš„æ„è§å’Œé¼“åŠ±ã€‚æœ€è¿‘ï¼Œå°å½­ä¼šé™†ç»­æ¬è¿åˆ°å…¬ä¼—å·ä¸Šã€‚

2020 å¹´ 10 æœˆ 28 æ—¥ï¼Œ**JetPack | App Startup 1.0.0** ç»ˆäºè¿æ¥æ­£å¼å‘å¸ƒï¼Œæ­£å¥½æœ€è¿‘åœ¨æ€»ç»“ç»„ä»¶åŒ–æ¶æ„ä¸“é¢˜ï¼Œæ‰€ä»¥ä¹Ÿä¸“é—¨å­¦ä¹ ä¸‹ App Startup çš„å·¥ä½œåŸç†ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å°†å¸¦ä½ æ€»ç»“ App Startup çš„ä½¿ç”¨æ–¹æ³• & å®ç°åŸç† & æºç åˆ†æã€‚æœ‰ç”¨è¯·ç‚¹èµç»™ Starï¼Œç»™å°å½­ä¸€ç‚¹åˆ›ä½œçš„åŠ¨åŠ›ï¼Œè°¢è°¢ã€‚

* * *

è¿™ç¯‡æ–‡ç« æ˜¯ Jetpack ç³»åˆ—æ–‡ç« ç¬¬ 13 ç¯‡ï¼Œä¸“æ æ–‡ç« åˆ—è¡¨ï¼š

*   [1ã€Lifecycleï¼šç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹ç»„ä»¶çš„åŸºç¡€](https://juejin.cn/post/7120472134853328909/)
*   [2ã€LiveDataï¼šç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥å‹æ•°æ®å®¹å™¨ï¼ˆæœ¬æ–‡ï¼‰](https://juejin.cn/post/7121621553670225957)
*   3ã€ViewModelï¼šæ•°æ®é©±åŠ¨å‹ç•Œé¢æ§åˆ¶å™¨
*   [4ã€Flowï¼šLiveData çš„æ›¿ä»£æ–¹æ¡ˆ](https://juejin.cn/post/7077149853876224013)
*   [5ã€ä» MVC åˆ° MVPã€MVVMã€MVIï¼šAndroid UI æ¶æ„æ¼”è¿›](https://juejin.cn/post/7072020104212381732)
*   [6ã€ViewBindingï¼šæ–°ä¸€ä»£è§†å›¾ç»‘å®šæ–¹æ¡ˆ](https://juejin.cn/post/6960914424865488932)
*   [7ã€Fragmentï¼šæ¨¡å—åŒ–çš„å¾®å‹ Activity](https://juejin.cn/post/6970998913754988552)
*   8ã€RecyclerViewï¼šå¯å¤ç”¨å‹åˆ—è¡¨è§†å›¾
*   9ã€Navigationï¼šå• Activity å¤š Fragment çš„å¯¼èˆªæ–¹æ¡ˆ
*   [10ã€Dagger2ï¼šä» Dagger2 åˆ° Hilt ç©è½¬ä¾èµ–æ³¨å…¥ï¼ˆä¸€ï¼‰](https://juejin.cn/post/6947655947875516424)
*   11ã€Hiltï¼šä» Dagger2 åˆ° Hilt ç©è½¬ä¾èµ–æ³¨å…¥ï¼ˆäºŒï¼‰
*   [12ã€OnBackPressedDispatcherï¼šå¤„ç†å›é€€äº‹ä»¶çš„æ–°å§¿åŠ¿](https://juejin.cn/post/6967039557220958244)

äºŒã€å…¶ä»–ï¼š

*   [1ã€AppStartupï¼šè½»é‡çº§åˆå§‹åŒ–æ¡†æ¶ï¼ˆæœ¬æ–‡ï¼‰](https://juejin.cn/post/6898738809895125006)
*   2ã€DataStoreï¼šæ–°ä¸€ä»£é”®å€¼å¯¹å­˜å‚¨æ–¹æ¡ˆ
*   3ã€Roomï¼šORM æ•°æ®åº“è®¿é—®æ¡†æ¶
*   4ã€WindowManagerï¼šåŠ å¼ºå¯¹å¤šçª—å£æ¨¡å¼çš„æ”¯æŒ
*   5ã€WorkManagerï¼šåŠ å¼ºå¯¹åå°ä»»åŠ¡çš„æ”¯æŒ
*   6ã€Composeï¼šæ–°ä¸€ä»£è§†å›¾å¼€å‘æ–¹æ¡ˆ

* * *

**å­¦ä¹ è·¯çº¿å›¾ï¼š**

![](https://files.mdnice.com/user/3257/0968b795-b779-4d38-95be-6136b4787ddb.png)

* * *

1\. è®¤è¯† AppStartup
-----------------

### 1.1 App Startup è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

App Startup æ˜¯ Google æä¾›çš„ Android è½»é‡çº§åˆå§‹åŒ–æ¡†æ¶ï¼š

*   ä¼˜ç‚¹ï¼šä½¿ç”¨ App Startup æ¡†æ¶ï¼Œå¯ä»¥ç®€åŒ–å¯åŠ¨åºåˆ—å¹¶æ˜¾å¼è®¾ç½®åˆå§‹åŒ–ä¾èµ–é¡ºåºï¼Œåœ¨ç®€å•ã€é«˜æ•ˆè¿™æ–¹é¢ï¼ŒApp Startup åŸºæœ¬æ»¡è¶³éœ€æ±‚ã€‚
*   ä¸è¶³ï¼šApp Startup æ¡†æ¶çš„ä¸è¶³ä¹Ÿæ˜¯å› ä¸ºå®ƒå¤ªç®€å•äº†ï¼Œæä¾›çš„ç‰¹æ€§å¤ªè¿‡ç®€å•ï¼Œå¾€å¾€å¹¶ä¸èƒ½å®Œç¾å¥‘åˆå•†ä¸šåŒ–éœ€æ±‚ã€‚ä¾‹å¦‚ä»¥ä¸‹ç‰¹æ€§ App Startup å°±æ— æ³•æ»¡è¶³ï¼š
    *   **ç¼ºä¹å¼‚æ­¥ç­‰å¾…ï¼š** åŒæ­¥ç­‰å¾…æŒ‡çš„æ˜¯åœ¨å½“å‰çº¿ç¨‹å…ˆåˆå§‹åŒ–æ‰€ä¾èµ–çš„ç»„ä»¶ï¼Œå†åˆå§‹åŒ–å½“å‰ç»„ä»¶ï¼ŒApp Startup æ˜¯æ”¯æŒçš„ï¼Œä½†æ˜¯å¼‚æ­¥ç­‰å¾…å°±ä¸æ”¯æŒäº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ‰€ä¾èµ–çš„ç»„ä»¶éœ€è¦æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„å¼‚æ­¥ä»»åŠ¡æ‰èƒ½å®Œæˆåˆå§‹åŒ–ï¼Œé‚£ä¹ˆ App Startup å°±æ— æ³•ç­‰å¾…å¼‚æ­¥ä»»åŠ¡è¿”å›ï¼›
    *   **ç¼ºä¹ä¾èµ–å›è°ƒï¼š** å½“å‰ç»„ä»¶æ‰€ä¾èµ–çš„ç»„ä»¶åˆå§‹åŒ–å®Œæˆåï¼Œæœªå‘å‡ºå›è°ƒã€‚

### 1.2 App Startup å¦‚ä½•å®ç°è‡ªåŠ¨åˆå§‹åŒ–ï¼Ÿ

App Startup åˆ©ç”¨äº† ContentProvider åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–çš„ç‰¹æ€§ï¼Œæä¾›äº†ä¸€ä¸ªè‡ªå®šä¹‰ ContentProvider æ¥å®ç°è‡ªåŠ¨åˆå§‹åŒ–ã€‚å¾ˆå¤šåº“éƒ½åˆ©ç”¨äº† ContentProvider çš„å¯åŠ¨æœºåˆ¶ï¼Œæ¥å®ç°æ— ä¾µå…¥åˆå§‹åŒ–ï¼Œä¾‹å¦‚ LeakCanary ç­‰

ä½¿ç”¨ AppStartup è¿˜èƒ½å¤Ÿåˆå¹¶æ‰€æœ‰ç”¨äºåˆå§‹åŒ–çš„ ContentProvider ï¼Œå‡å°‘åˆ›å»º ContentProviderï¼Œå¹¶æä¾›å…¨å±€ç®¡ç†ã€‚

`App Startup ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/ba20f5cf-7917-4686-973c-23ee86b39de8.png)

è¯¦ç»†çš„æºç åˆ†æä¸‹æ–‡å†…å®¹ã€‚

* * *

2\. App Startup ä½¿ç”¨æ–¹æ³•
--------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥æ€»ç»“ App Startup çš„ä½¿ç”¨æ­¥éª¤ã€‚

### 2.1 åŸºæœ¬ç”¨æ³•

*   **1ã€æ·»åŠ ä¾èµ–**

åœ¨æ¨¡å—çº§ `build.gradle` æ·»åŠ ä¾èµ–ï¼š

`æ¨¡å—çº§ build.gradle`

    implementation "androidx.startup:startup-runtime:1.0.0"
    

*   **2ã€å®ç° Initializer æ¥å£**

`Initializer` æ¥å£æ˜¯ App Startup å®šä¹‰ç»„ä»¶æ¥å£ï¼Œç”¨äºæŒ‡å®šç»„ä»¶çš„åˆå§‹åŒ–é€»è¾‘å’Œåˆå§‹åŒ–é¡ºåºï¼ˆä¹Ÿå°±æ˜¯ä¾èµ–å…³ç³»ï¼‰ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š

*   **1ã€create(...) åˆå§‹åŒ–æ“ä½œï¼š** è¿”å›çš„åˆå§‹åŒ–ç»“æœå°†è¢«ç¼“å­˜ï¼Œå…¶ä¸­ `context` å‚æ•°å°±æ˜¯å½“å‰è¿›ç¨‹çš„ `Application` å¯¹è±¡ï¼›
*   **2ã€dependencies() ä¾èµ–å…³ç³»ï¼š** è¿”å›å€¼æ˜¯ä¸€ä¸ªä¾èµ–ç»„ä»¶çš„åˆ—è¡¨ï¼Œå¦‚æœä¸éœ€è¦ä¾èµ–äºå…¶å®ƒç»„ä»¶ï¼Œè¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚App Startup åœ¨åˆå§‹åŒ–å½“å‰ç»„ä»¶æ—¶ï¼Œä¼šä¿è¯æ‰€ä¾èµ–çš„ç»„ä»¶å·²ç»å®Œæˆåˆå§‹åŒ–ã€‚

`Initializer.java`

    public interface Initializer<T> {
    
        // 1ã€åˆå§‹åŒ–æ“ä½œï¼Œè¿”å›å€¼å°†è¢«ç¼“å­˜ï¼Ÿï¼Ÿ
        @NonNull
        T create(@NonNull Context context);
    
        // 2ã€ä¾èµ–å…³ç³»ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªä¾èµ–ç»„ä»¶çš„åˆ—è¡¨
        @NonNull
        List<Class<? extends Initializer<?>>> dependencies();
    }
    

`ç¤ºä¾‹ç¨‹åº`

    // LeakCanary 2.9.1
    internal class AppWatcherStartupInitializer : Initializer<AppWatcherStartupInitializer> {
        override fun create(context: Context) = apply {
            // å®ç°åˆå§‹åŒ–æ“ä½œ
            val application = context.applicationContext as Application
                AppWatcher.manualInstall(application)
            }
    	
        override fun dependencies() = emptyList<Class<out Initializer<*>>>()
    }
    

*   **3ã€é…ç½®**

åœ¨ Manifest æ–‡ä»¶ä¸­å°† Initializer å®ç°ç±»é…ç½®åˆ° `androidx.startup.InitializationProvider` çš„ `<meta-data>` ä¸­ã€‚

`ç¤ºä¾‹ç¨‹åº`

    <!-- LeakCanary 2.9.1 -->
    <provider
        android:name="androidx.startup.InitializationProvider"
        android:authorities="${applicationId}.androidx-startup"
        android:exported="false"
        tools:node="merge">
    
        <meta-data
            android:name="leakcanary.internal.AppWatcherStartupInitializer"
            android:value="androidx.startup"/>
    </provider>
    

è¦ç‚¹å¦‚ä¸‹ï¼š

*   1ã€ç»„ä»¶åå¿…é¡»æ˜¯ `androidx.startup.InitializationProvider`ï¼›
*   2ã€éœ€è¦å£°æ˜ `android:exported="false"`ï¼Œä»¥é™åˆ¶å…¶ä»–åº”ç”¨è®¿é—®æ­¤ç»„ä»¶ï¼›
*   3ã€è¦æ±‚ `android:authorities` è¦æ±‚åœ¨è®¾å¤‡ä¸­å…¨å±€å”¯ä¸€ï¼Œé€šå¸¸ä½¿ç”¨ `${applicationId}` ä½œä¸ºå‰ç¼€ï¼›
*   4ã€éœ€è¦å£°æ˜ `tools:node="merge"`ï¼Œç¡®ä¿ manifest merger tool èƒ½å¤Ÿæ­£ç¡®è§£æå†²çªçš„èŠ‚ç‚¹ï¼›
*   5ã€meta-data `android:name` ä¸ºç»„ä»¶çš„ Initializer å®ç°ç±»çš„å…¨é™å®šç±»åï¼Œ`android:value` å›ºå®šä¸º `androidx.startup`ã€‚

> **æç¤ºï¼š** ä¸ºä»€ä¹ˆè¦å°† `androidx.startup` è®¾ç½®ä¸º valueï¼Œè€Œä¸æ˜¯ nameï¼Ÿå› ä¸ºåœ¨é”®å€¼å¯¹ä¸­ï¼Œname æ˜¯å”¯ä¸€çš„ï¼Œè€Œ value æ˜¯å…è®¸é‡å¤çš„ï¼Œå°† `androidx.startup` æ”¾åˆ° value çš„è¯æ‰èƒ½å…è®¸åŒæ—¶é…ç½®å¤šä¸ªç›¸åŒè¯­ä¹‰çš„ `<meta-data>`ã€‚

è‡³æ­¤ï¼ŒApp Startup åŸºæœ¬çš„ä½¿ç”¨ä¸é…ç½®å®Œæˆï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼ŒApp Startup ä¼šè‡ªåŠ¨æ”¶é›†å„ä¸ªæ¨¡å—é…ç½®çš„ `Initializer` å®ç°ç±»ï¼Œå¹¶æŒ‰ç…§ä¾èµ–é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

### 2.2 è¿›é˜¶ç”¨æ³•

*   **1ã€æ‰‹åŠ¨åˆå§‹åŒ–**

å½“ä½ çš„ç»„ä»¶éœ€è¦è¿›è¡Œæ‰‹åŠ¨åˆå§‹åŒ–ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨åˆå§‹åŒ–æ—¶ï¼ˆä¾‹å¦‚å­˜åœ¨è€—æ—¶ä»»åŠ¡ï¼‰ï¼Œå¯ä»¥è¿›è¡Œæ‰‹åŠ¨åˆå§‹åŒ–ï¼Œè€Œä¸”æ‰‹åŠ¨åˆå§‹åŒ–æ˜¯å¯ä»¥åœ¨å­çº¿ç¨‹è°ƒç”¨çš„ï¼Œè€Œè‡ªåŠ¨åˆå§‹åŒ–å‡æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ã€‚

*   App Startup ä¸­ä¼šç¼“å­˜åˆå§‹åŒ–åçš„ç»“æœï¼Œé‡å¤è°ƒç”¨ `initializeComponent()` ä¹Ÿä¸ä¼šå¯¼è‡´é‡å¤åˆå§‹åŒ–ï¼›
*   è¦æ‰‹åŠ¨åˆå§‹åŒ–çš„ Initializer å®ç°ç±»ä¸èƒ½åœ¨å£°æ˜åˆ° AndroidManifest ä¸­ï¼Œä¹Ÿä¸èƒ½è¢«å…¶å®ƒç»„ä»¶ä¾èµ–ï¼Œå¦åˆ™å®ƒä¾ç„¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–ã€‚

è°ƒç”¨ä»¥ä¸‹æ–¹å³å¯è¿›è¡Œæ‰‹åŠ¨åˆå§‹åŒ–ï¼š

`ç¤ºä¾‹ç¨‹åº`

    AppInitializer.getInstance(context).initializeComponent(ExampleLoggerInitializer::class.java)
    

*   **2ã€å–æ¶ˆè‡ªåŠ¨åˆå§‹åŒ–**

å‡å¦‚æœ‰äº›åº“å·²ç»é…ç½®äº†è‡ªåŠ¨åˆå§‹åŒ–ï¼Œè€Œæˆ‘ä»¬åˆå¸Œæœ›è¿›è¡Œæ‡’åŠ è½½æ—¶ï¼Œå°±éœ€è¦åˆ©ç”¨ `manifest merger tool` çš„åˆå¹¶è§„åˆ™æ¥ç§»é™¤è¿™ä¸ªåº“å¯¹åº”çš„ Initializerã€‚å…·ä½“å¦‚ä¸‹ï¼š

`ç¤ºä¾‹ç¨‹åº`

    <provider
        android:name="androidx.startup.InitializationProvider"
        android:authorities="${applicationId}.androidx-startup"
        android:exported="false"
        tools:node="merge">
        <meta-data
            android:name="com.example.ExampleLoggerInitializer"
            tools:node="remove" />
    </provider>
    

*   **3ã€ç¦ç”¨ App Startup**

å‡å¦‚éœ€è¦å®Œå…¨ç¦ç”¨ App Startup è‡ªåŠ¨åˆå§‹åŒ–ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥åˆ©ç”¨åˆ° `manifest merger tool` çš„åˆå¹¶è§„åˆ™ï¼š

`ç¤ºä¾‹ç¨‹åº`

    <provider
        android:name="androidx.startup.InitializationProvider"
        android:authorities="${applicationId}.androidx-startup"
        tools:node="remove" />
    

* * *

3\. App Startup åŸç†åˆ†æ
--------------------

### 3.1 App Startup å¦‚ä½•å®ç°è‡ªåŠ¨åˆå§‹åŒ–ï¼Ÿ

App Startup åˆ©ç”¨äº† ContentProvider çš„å¯åŠ¨æœºåˆ¶å®ç°è‡ªåŠ¨åˆå§‹åŒ–ã€‚ContentProvider é€šå¸¸çš„ç”¨æ³•æ˜¯ä¸ºå½“å‰è¿›ç¨‹ / è¿œç¨‹è¿›ç¨‹æä¾›å†…å®¹æœåŠ¡ï¼Œå®ƒä»¬ä¼šåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™åˆå§‹åŒ–ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼ŒApp Startup çš„æ–¹æ¡ˆå°±æ˜¯è‡ªå®šä¹‰ä¸€ä¸ª ContentProvider çš„å®ç°ç±» `InitializationProvider`ï¼Œåœ¨ onCreate(â€¦) æ–¹æ³•ä¸­æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘ã€‚

`InitializationProvider.java`

    å·²ç®€åŒ–
    
    public final class InitializationProvider extends ContentProvider {
    
        @Override
        public boolean onCreate() {
            Context context = getContext();
            if (context != null) {
                // åˆå§‹åŒ–
                AppInitializer.getInstance(context).discoverAndInitialize();
            } else {
                throw new StartupException("Context cannot be null");
            }
            return true;
        }
    
        @Override
        public Cursor query(...) {
            throw new IllegalStateException("Not allowed.");
        }
    
        @Override
        public String getType(...) {
            throw new IllegalStateException("Not allowed.");
        }
    
        @Nullable
        @Override
        public Uri insert(...) {
            throw new IllegalStateException("Not allowed.");
        }
    
        @Override
        public int delete(...) {
            throw new IllegalStateException("Not allowed.");
        }
    
        @Override
        public int update(...) {
            throw new IllegalStateException("Not allowed.");
        }
    }
    

ç”±äº ContentProvider çš„å…¶ä»–æ–¹æ³•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ‰€ä»¥éƒ½æŠ›å‡ºäº† `IllegalStateException`ã€‚

### 3.2 è¯´ä¸€ä¸‹ App Startup çš„åˆå§‹åŒ–è¿‡ç¨‹

ä»ä¸Šä¸€èŠ‚å¯ä»¥çœ‹åˆ°ï¼ŒApp Startup åœ¨ `InitializationProvider` ä¸­è°ƒç”¨äº†`AppInitializer#discoverAndInitialize()`æ‰§è¡Œè‡ªåŠ¨åˆå§‹åŒ–ã€‚`AppInitializer`æ˜¯ App StartUp æ¡†æ¶çš„æ ¸å¿ƒç±»ï¼Œæ•´ä¸ª App Startup æ¡†æ¶çš„ä»£ç å…¶å®éå¸¸å°‘ï¼Œå…¶ä¸­å¾ˆå¤§éƒ¨åˆ†æ ¸å¿ƒä»£ç éƒ½åœ¨ AppInitializer ç±»ä¸­ã€‚

æˆ‘å°†æ•´ä¸ªè‡ªåŠ¨åˆå§‹åŒ–è¿‡ç¨‹æ¦‚æ‹¬ä¸º 3 ä¸ªé˜¶æ®µï¼š

*   æ­¥éª¤ **1 - è·å– æ•°æ®ï¼š** æ‰«æ Manifest ä¸­å®šä¹‰åœ¨ InitializationProvider é‡Œé¢çš„ æ•°æ®ï¼Œä»ä¸­ç­›é€‰å‡º Initializer çš„é…ç½®ä¿¡æ¯ï¼›
*   æ­¥éª¤ 2 - é€’å½’æ‰§è¡Œåˆå§‹åŒ–å™¨ï¼š é€šè¿‡ Initializer#create() æ‰§è¡Œæ¯ä¸ªåˆå§‹åŒ–å™¨çš„é€»è¾‘ï¼Œå¹¶ä¸”ä¼šé€šè¿‡ Initializer#dependencies() ä¼˜å…ˆä¿è¯ä¾èµ–é¡¹å·²ç»åˆå§‹åŒ–ï¼›
*   æ­¥éª¤ 3 - ç¼“å­˜åˆå§‹åŒ–ç»“æœï¼š å°†åˆå§‹åŒ–åçš„ç»“æœç¼“å­˜åˆ°æ˜ å°„è¡¨ä¸­ï¼Œé¿å…é‡å¤åˆå§‹åŒ–ã€‚

æºç æ‘˜è¦å¦‚ä¸‹ï¼š

`AppInitializer.java`

    private static final Object sLock = new Object(); // åé¢ä¼šæåˆ°
    
    // è®°å½•æ‰«æ <meta-data> å¾—åˆ°çš„åˆå§‹åŒ–å™¨ï¼ˆå¯ç”¨äºåˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²ç»è‡ªåŠ¨å¯åŠ¨ï¼‰
    final Set<Class<? extends Initializer<?>>> mDiscovered;
    
    // ç¼“å­˜æ¯ä¸ªç»„ä»¶çš„åˆå§‹åŒ–ç»“æœ
    final Map<Class<?>, Object> mInitialized;
    
    void discoverAndInitialize() {
        // 1ã€è·å– androidx.startup.InitializationProvider ç»„ä»¶ä¿¡æ¯
        ComponentName provider = new ComponentName(mContext.getPackageName(), InitializationProvider.class.getName());
        ProviderInfo providerInfo = mContext.getPackageManager().getProviderInfo(provider, GET_META_DATA);
    
        // 2ã€androidx.startup å­—ç¬¦ä¸²
        String startup = mContext.getString(R.string.androidx_startup);
    
        // 3ã€è·å–ç»„ä»¶ä¿¡æ¯ä¸­çš„ meta-data æ•°æ®
        Bundle metadata = providerInfo.metaData;
    
        // 4ã€éå†æ‰€æœ‰ meta-data æ•°æ®
        if (metadata != null) {
            Set<Class<?>> initializing = new HashSet<>();
            Set<String> keys = metadata.keySet();
            for (String key : keys) {
                String value = metadata.getString(key, null);
    
                // 4.1 ç­›é€‰ value ä¸º androidx.startup çš„ meta-data æ•°æ®ä¸­
                if (startup.equals(value)) {
                    Class<?> clazz = Class.forName(key);
    
                    // 4.2 æ£€æŸ¥æŒ‡å®šçš„ç±»æ˜¯ Initializer æ¥å£çš„å®ç°ç±»
                    if (Initializer.class.isAssignableFrom(clazz)) {
                        Class<? extends Initializer<?>> component = (Class<? extends Initializer<?>>) clazz;
    
                        // 4.3 å°† Class æ·»åŠ åˆ° mDiscovered Set ä¸­
                        mDiscovered.add(component);
    
                        // 4.4 åˆå§‹åŒ–æ­¤ç»„ä»¶
                        doInitialize(component, initializing);
                    }
                }
            }
        }
    }
    
    // -> 4.3 mDiscovered ç”¨äºåˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²ç»è‡ªåŠ¨å¯åŠ¨
    public boolean isEagerlyInitialized(@NonNull Class<? extends Initializer<?>> component) {
        return mDiscovered.contains(component);
    }
    
    // -> 4.4 åˆå§‹åŒ–æ­¤ç»„ä»¶ï¼ˆå·²ç®€åŒ–ï¼‰
    <T> T doInitialize(Class<? extends Initializer<?>> component, Set<Class<?>> initializing) {
        // 1ã€å¯¹ sLock åŠ é”ï¼Œæˆ‘åæ–‡å†è¯´ã€‚
    
        Object result;
    
        // 2ã€åˆ¤æ–­ initializing ä¸­å­˜åœ¨å½“å‰ç»„ä»¶ï¼Œè¯´æ˜å­˜åœ¨å¾ªç¯ä¾èµ–
        if (initializing.contains(component)) {
            String message = String.format("Cannot initialize %s. Cycle detected.", component.getName());
            throw new IllegalStateException(message);
        }
    
        // 3ã€æ£€æŸ¥å½“å‰ç»„ä»¶æ˜¯å¦å·²åˆå§‹åŒ–
        if (!mInitialized.containsKey(component)) {
            // 3.1 å½“å‰ç»„ä»¶æœªåˆå§‹åŒ–
    
            // 3.1.1 è®°å½•æ­£åœ¨åˆå§‹åŒ–
            initializing.add(component);
    
            // 3.1.2 é€šè¿‡åå°„å®ä¾‹åŒ– Initializer æ¥å£å®ç°ç±»
            Object instance = component.getDeclaredConstructor().newInstance();
            Initializer<?> initializer = (Initializer<?>) instance;
    
            // 3.1.3 éå†æ‰€ä¾èµ–çš„ç»„ä»¶ï¼ˆå…³é”®ï¼šä¼˜å…ˆå¤„ç†ä¾èµ–çš„ç»„ä»¶ï¼‰
            List<Class<? extends Initializer<?>>> dependencies = initializer.dependencies();
            if (!dependencies.isEmpty()) {
                for (Class<? extends Initializer<?>> clazz : dependencies) {
    
                    // é€’å½’ï¼šå¦‚æœæ‰€ä¾èµ–çš„ç»„ä»¶æœªåˆå§‹åŒ–ï¼Œæ‰§è¡Œåˆå§‹åŒ–
                    if (!mInitialized.containsKey(clazz)) {
                        // æ³¨æ„ï¼šè¿™é‡Œå°† initializing ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œç”¨äºåˆ¤æ–­å¾ªç¯ä¾èµ–
                        doInitialize(clazz, initializing); 
                    }
                }
            }
    
            // 3.1.4 ï¼ˆåˆ°è¿™é‡Œï¼Œæ‰€ä¾èµ–çš„ç»„ä»¶å·²ç»åˆå§‹åŒ–å®Œæˆï¼‰åˆå§‹åŒ–å½“å‰ç»„ä»¶
            result = initializer.create(mContext);
    
            // 3.1.5 ç§»é™¤æ­£åœ¨åˆå§‹åŒ–è®°å½•
            initializing.remove(component);
    
            // 3.1.6 ç¼“å­˜åˆå§‹åŒ–ç»“æœ
            mInitialized.put(component, result);
        } else {
            // 3.2 å½“å‰ç»„ä»¶å·²ç»åˆå§‹åŒ–ï¼Œç›´æ¥è¿”å›
            result = mInitialized.get(component);
        }
         return (T) result;
    }
    

### 3.3 æ‰‹åŠ¨åˆå§‹åŒ–çš„æ‰§è¡Œè¿‡ç¨‹

å‰é¢æˆ‘ä»¬æåˆ°ä½¿ç”¨ `initializeComponent()` æ–¹æ³•å¯ä»¥æ‰‹åŠ¨åˆå§‹åŒ–ï¼Œæˆ‘ä»¬æ¥çœ‹æ‰‹åŠ¨åˆå§‹åŒ–ï¼ˆæ‡’åŠ è½½ï¼‰çš„æºç :

`AppInitializer.java`

    public <T> T initializeComponent(@NonNull Class<? extends Initializer<T>> component) {
        // è°ƒç”¨ doInitialize(...) æ–¹æ³•ï¼š
        return doInitialize(component, new HashSet<Class<?>>());
    }
    

å…¶å®éå¸¸ç®€å•ï¼Œå°±æ˜¯è°ƒç”¨ä¸Šä¸€èŠ‚çš„ `doInitialize(...)` æ‰§è¡Œåˆå§‹åŒ–ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å…è®¸åœ¨å­çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ¢å¥è¯è¯´ï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸æ‰‹åŠ¨åˆå§‹åŒ–æ˜¯å­˜åœ¨çº¿ç¨‹åŒæ­¥é—®é¢˜çš„ï¼Œé‚£ä¹ˆ App Startup æ˜¯å¦‚ä½•è§£å†³çš„å‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬å‰é¢æœ‰ä¸€ä¸ª `sLock` æ²¡æœ‰è¯´å—ï¼Ÿå…¶å®å®ƒå°±æ˜¯ç”¨æ¥ä¿è¯çº¿ç¨‹åŒæ­¥çš„é”ï¼š

`AppInitializer.java`

    <T> T doInitialize(Class<? extends Initializer<?>> component, Set<Class<?>> initializing) {
        // 1ã€å¯¹ sLock åŠ é”
        synchronized (sLock) {
            ...
        }
    }
    

* * *

4\. æ€»ç»“
------

åˆ°è¿™é‡Œï¼ŒApp Startup çš„å†…å®¹å°±è®²å®Œäº†ã€‚å¯ä»¥çœ‹åˆ° App Startup åªæ˜¯ä¸€ä¸ªè½»é‡çº§çš„åˆå§‹åŒ–æ¡†æ¶ï¼Œèƒ½åšçš„äº‹æƒ…æœ‰é™ã€‚å¸‚é¢ä¸Šæœ‰å¼€å‘è€…å¼€æºäº†åŸºäº DAU æœ‰å‘æ— ç¯å›¾çš„åˆå§‹åŒ–æ¡†æ¶ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¸‹æ¬¡å†è¯´ã€‚å…³æ³¨æˆ‘ï¼Œå¸¦ä½ äº†è§£æ›´å¤šã€‚

* * *

#### å‚è€ƒèµ„æ–™

*   [App Startup](https://developer.android.google.cn/topic/libraries/app-startup) â€”â€” Android Developers
*   [åˆå¹¶å¤šä¸ªæ¸…å•æ–‡ä»¶](https://developer.android.google.cn/studio/build/manifest-merge) â€”â€” Android Developers
*   [AndroidX: App Startup](https://proandroiddev.com/androidx-app-startup-698855342f80) â€”â€” Husayn Hakeem è‘—
*   [Jetpackæ–°æˆå‘˜ï¼ŒApp Startup ä¸€ç¯‡å°±æ‡‚](https://mp.weixin.qq.com/s?__biz=MzA5MzI3NjE2MA==&mid=2650251523&idx=1&sn=3409d80cc6c4252cbd4fb0e327eb3dcc&chksm=8863506cbf14d97aa6b640b6794395a158137e97b9db5804e2718b204affa3bb5c2aba8f6676&mpshare=1&scene=24&srcid=08259PAiFnKfqf8selFIZ3qD&sharer_sharetime=1598317827172&sharer_shareid=653d606fda642b58c9d033eeb6c60861#rd) â€”â€” éƒ­éœ– è‘—
*   [æˆ‘ä¸ºä½•å¼ƒç”¨ Jetpack çš„ App Startup?](https://juejin.cn/post/6859500445669752846) â€”â€” åˆåä¸€å°æ†© è‘—
*   [æ›´å¿«ï¼è¿™æ‰æ˜¯æˆ‘æƒ³è¦çš„ Android Startup åº“ï¼](https://mp.weixin.qq.com/s?__biz=MzAxMTI4MTkwNQ==&mid=2650833317&idx=1&sn=2a0dd6775255bf5acca5fa465384d7c7&chksm=80b7553bb7c0dc2d48c7d9c8b23ac57f884e9afe35eb2ecbdb40059f9ba16e29710945641aa1&scene=0&xtrack=1#rd) â€”â€” idisfkj è‘—
*   [ç»„ä»¶åŒ–ï¼šä»£ç éš”ç¦»ä¹Ÿéš¾ä¸å€’ç»„ä»¶çš„æŒ‰åºåˆå§‹åŒ–](https://juejin.cn/post/6884492604370026503) â€”â€” leobert-lan è‘—
*   [ä»æºç çœ‹ Jetpackï¼ˆ5ï¼‰Startup æºç è¯¦è§£](https://juejin.cn/post/6847902224069165070) â€”â€” å¶å¿—é™ˆ è‘—

> **æˆ‘æ˜¯å°å½­ï¼Œå¸¦ä½ æ„å»º Android çŸ¥è¯†ä½“ç³»ã€‚æŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] ç§ä¿¡æˆ‘æé—®ã€‚**