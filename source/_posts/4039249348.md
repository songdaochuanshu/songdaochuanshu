---
layout: post
title: "JDK è‡ªå¸¦çš„æœåŠ¡å‘ç°æ¡†æ¶ ServiceLoader å¥½ç”¨å—ï¼Ÿ"
date: "2022-09-07T10:22:39.743Z"
---
JDK è‡ªå¸¦çš„æœåŠ¡å‘ç°æ¡†æ¶ ServiceLoader å¥½ç”¨å—ï¼Ÿ
================================

> **è¯·ç‚¹èµå…³æ³¨ï¼Œä½ çš„æ”¯æŒå¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚**
> 
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°å½­ã€‚æœ¬æ–‡å·²æ”¶å½•åˆ° [Github Â· AndroidFamily](https://github.com/pengxurui/AndroidFamily) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œæœ‰å¿—åŒé“åˆçš„æœ‹å‹ï¼Œå…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] å¸¦ä½ å»ºç«‹æ ¸å¿ƒç«äº‰åŠ›ã€‚**

* * *

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

è¿‡å»ä¸¤å¹´ï¼Œæˆ‘ä»¬åœ¨æ˜é‡‘å¹³å°ä¸Šå‘å¸ƒè¿‡ä¸€äº›æ–‡ç« ï¼Œå°å½­ä¹Ÿå—åˆ°äº†å¤§å®¶çš„æ„è§å’Œé¼“åŠ±ã€‚æœ€è¿‘ï¼Œå°å½­ä¼šé™†ç»­æ¬è¿åˆ°å…¬ä¼—å·ä¸Šã€‚

**å­¦ä¹ è·¯çº¿å›¾ï¼š**

![](https://files.mdnice.com/user/3257/4d913bb0-d38a-4264-8819-ef4c1a06f2ba.png)

* * *

1\. è®¤è¯†æœåŠ¡å‘ç°ï¼Ÿ
-----------

### 1.1 ä»€ä¹ˆæ˜¯æœåŠ¡å‘ç°

**æœåŠ¡å‘ç°ï¼ˆService Provider Interfaceï¼ŒSPIï¼‰æ˜¯ä¸€ä¸ªæœåŠ¡çš„æ³¨å†Œä¸å‘ç°æœºåˆ¶ï¼Œé€šè¿‡è§£è€¦æœåŠ¡æä¾›è€…ä¸æœåŠ¡ä½¿ç”¨è€…ï¼Œå®ç°äº†æœåŠ¡åˆ›å»º & æœåŠ¡ä½¿ç”¨çš„å…³æ³¨ç‚¹åˆ†ç¦»ã€‚** æœåŠ¡æä¾›æ¨¡å¼å¯ä»¥ä¸ºæˆ‘ä»¬å¸¦æ¥ä»¥ä¸‹å¥½å¤„ï¼š

*   1ã€åœ¨å¤–éƒ¨æ³¨å…¥æˆ–é…ç½®ä¾èµ–é¡¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é‡ç”¨è¿™äº›ç»„ä»¶ã€‚å½“æˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¾èµ–é¡¹çš„å®ç°æ—¶ï¼Œä¸éœ€è¦å¤§é‡ä¿®æ”¹å¾ˆå¤šå¤„ä»£ç ï¼Œåªéœ€è¦ä¿®æ”¹ä¸€å°éƒ¨åˆ†ä»£ç ï¼›
*   2ã€å¯ä»¥æ³¨å…¥ä¾èµ–é¡¹çš„æ¨¡æ‹Ÿå®ç°ï¼Œè®©ä»£ç æµ‹è¯•æ›´åŠ å®¹æ˜“ã€‚

`æœåŠ¡å‘ç°ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/49c787c8-f700-451d-898c-6b9bc4700693.png)

### 1.2 æœåŠ¡å‘ç°å’Œä¾èµ–æ³¨å…¥çš„åŒºåˆ«

**æœåŠ¡å‘ç°å’Œä¾èµ–æ³¨å…¥éƒ½æ˜¯æ§åˆ¶åè½¬ Ioc çš„å®ç°å½¢å¼ä¹‹ä¸€ã€‚** IoC å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯ç”±äºç†è®ºæˆç†Ÿçš„æ—¶é—´ç›¸å¯¹è¾ƒæ™šï¼Œæ‰€ä»¥æ²¡æœ‰åŒ…å«åœ¨ã€Šè®¾è®¡æ¨¡å¼ Â· GoFã€‹ä¹‹ä¸­ï¼Œå³ï¼š **å½“ä¾èµ–æ–¹éœ€è¦ä½¿ç”¨ä¾èµ–é¡¹æ—¶ï¼Œä¸å†ç›´æ¥æ„é€ å¯¹è±¡ï¼Œè€Œæ˜¯ç”±å¤–éƒ¨ IoC å®¹å™¨æ¥åˆ›å»ºå¹¶æä¾›ä¾èµ–ã€‚**

*   **1ã€æœåŠ¡æä¾›æ¨¡å¼ï¼š** ä»å¤–éƒ¨æœåŠ¡å®¹å™¨æŠ“å–ä¾èµ–å¯¹è±¡ï¼Œè°ƒç”¨æ–¹å¯ä»¥ â€œä¸»åŠ¨â€ æ§åˆ¶è¯·æ±‚ä¾èµ–å¯¹è±¡çš„æ—¶æœºï¼›
*   **2ã€ä¾èµ–æ³¨å…¥ï¼š** å¹¶ä»¥å‚æ•°çš„å½¢å¼æ³¨å…¥ä¾èµ–å¯¹è±¡ï¼Œè°ƒç”¨æ–¹ â€œè¢«åŠ¨â€ æ¥æ”¶å¤–éƒ¨æ³¨å…¥çš„ä¾èµ–å¯¹è±¡ã€‚

* * *

2\. JDK ServiceLoader çš„ä½¿ç”¨æ­¥éª¤
---------------------------

åœ¨åˆ†æ ServiceLoader çš„ä½¿ç”¨åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä»‹ç»ä¸‹ ServiceLoader çš„ä½¿ç”¨æ­¥éª¤ã€‚

æˆ‘ä»¬ç›´æ¥ä»¥ JDBC ä½œä¸ºä¾‹å­ï¼Œå…¶ä¸­ã€Œ2ã€è¿æ¥æ•°æ®åº“ã€å†…éƒ¨å°±æ˜¯ç”¨äº† ServiceLoaderã€‚ä¸ºä»€ä¹ˆè¿æ¥æ•°æ®åº“éœ€è¦ä½¿ç”¨ SPI è®¾è®¡æ€æƒ³å‘¢ï¼Ÿå› ä¸ºæ“ä½œæ•°æ®åº“éœ€è¦ä½¿ç”¨å‚å•†æä¾›çš„æ•°æ®åº“é©±åŠ¨ç¨‹åºï¼Œå¦‚æœç›´æ¥ä½¿ç”¨å‚å•†çš„é©±åŠ¨è€¦åˆå¤ªå¼ºäº†ï¼Œè€Œä½¿ç”¨ SPI è®¾è®¡å°±èƒ½å¤Ÿå®ç°æœåŠ¡æä¾›è€…ä¸æœåŠ¡ä½¿ç”¨è€…è§£è€¦ã€‚

ä»¥ä¸‹ä¸ºä½¿ç”¨æ­¥éª¤ï¼Œå…·ä½“åˆ†ä¸º 5 ä¸ªæ­¥éª¤ï¼š

*   1ã€ï¼ˆéå¿…é¡»ï¼‰æ‰§è¡Œæ•°æ®åº“é©±åŠ¨ç±»åŠ è½½ï¼š

    Class.forName("com.mysql.jdbc.driver")
    

*   2ã€è¿æ¥æ•°æ®åº“ï¼š

    DriverManager.getConnection(url, user, password)
    

*   3ã€åˆ›å»ºSQLè¯­å¥ï¼š

    Connection#.creatstatement();
    

*   4ã€æ‰§è¡ŒSQLè¯­å¥å¹¶å¤„ç†ç»“æœé›†ï¼š

    Statement#executeQuery()
    

*   5ã€é‡Šæ”¾èµ„æºï¼š

    ResultSet#close()
    Statement#close()
    Connection#close()
    

ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€æ­¥æ­¥æ‰‹å†™ JDBC ä¸­å…³äº ServiceLoader çš„ç›¸å…³æºç ï¼š

### æ­¥éª¤ 1ï¼šå®šä¹‰æœåŠ¡æ¥å£

å®šä¹‰ä¸€ä¸ªé©±åŠ¨æ¥å£ï¼Œè¿™ä¸ªæ¥å£å°†ç”±æ•°æ®åº“é©±åŠ¨å®ç°ç±»å®ç°ã€‚åœ¨æœåŠ¡å‘ç°æ¡†æ¶ä¸­ï¼Œè¿™ä¸ªæ¥å£å°±æ˜¯æœåŠ¡æ¥å£ã€‚

    public interface Driver {
        // åˆ›å»ºæ•°æ®åº“è¿æ¥
        Connection connect(String url, java.util.Properties info);
        ...
    }
    

### æ­¥éª¤ 2ï¼šå®ç°æœåŠ¡æ¥å£

æ•°æ®åº“å‚å•†æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®ç° Driver æ¥å£çš„é©±åŠ¨å®ç°ç±»ï¼Œä»¥ mysql å’Œ oracle ä¸ºä¾‹ï¼š

*   **mysql**ï¼š`com.mysql.cj.jdbc.Driver.java`

    // å·²ç®€åŒ–
    public class Driver extends NonRegisteringDriver implements java.sql.Driver {
        static {
            // æ³¨å†Œé©±åŠ¨
            java.sql.DriverManager.registerDriver(new Driver());
        }
        ...
    }
    

*   **oracle**ï¼š`oracle.jdbc.driver.OracleDriver.java`

    // å·²ç®€åŒ–
    public class OracleDriver implements Driver {
        private static OracleDriver defaultDriver = null;
        static {
            if (defaultDriver == null) {
                // 1ã€å•ä¾‹
                defaultDriver = new OracleDriver();
                // æ³¨å†Œé©±åŠ¨
                DriverManager.registerDriver(defaultDriver);
            }
        }
        ...
    }
    

### æ­¥éª¤3ï¼šæ³¨å†Œå®ç°ç±»åˆ°é…ç½®æ–‡ä»¶

åœ¨å·¥ç¨‹ç›®å½• `java` çš„åŒçº§ç›®å½•ä¸­æ–°å»ºç›®å½• `resources/META-INF/services` ï¼Œæ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ `java.sql.Driver`ï¼ˆæ–‡ä»¶åä¸ºæœåŠ¡æ¥å£çš„å…¨é™å®šåï¼‰ï¼Œæ–‡ä»¶ä¸­æ¯ä¸€è¡Œæ˜¯å®ç°ç±»çš„å…¨é™å®šåï¼Œä¾‹å¦‚ï¼š

    com.mysql.cj.jdbc.Driver
    

æˆ‘ä»¬å¯ä»¥è§£å‹ `mysql-connector-java-8.0.19.jar` åŒ…ï¼Œæ‰¾åˆ°å¯¹åº”çš„ META-INF æ–‡ä»¶å¤¹ã€‚

### æ­¥éª¤4ï¼šï¼ˆä½¿ç”¨æ–¹ï¼‰åŠ è½½æœåŠ¡

`DriverManaer.java`

    // å·²ç®€åŒ–
    static {
        loadInitialDrivers();
    }
    
    // å…¥å£
    private static void loadInitialDrivers() {
        ...
        // è¯»å– "jdbc.drivers" å±æ€§
        String drivers = System.getProperty("jdbc.drivers");
    
        // 1ã€ä½¿ç”¨ ServiceLoader éå† Driver æœåŠ¡æ¥å£çš„å®ç°ç±»
        ServiceLoader<Driver> loadedDrivers = ServiceLoader.load(Driver.class);
        // 2ã€è·å¾—è¿­ä»£å™¨
        Iterator<Driver> driversIterator = loadedDrivers.iterator();
        // 3ã€è¿­ä»£ï¼ˆServiceLoader å†…éƒ¨ä¼šé€šè¿‡åå°„ï¼‰
        while(driversIterator.hasNext()) {
            driversIterator.next();
        }
        return null;
        ...
    }
    

å¯ä»¥çœ‹åˆ°ï¼ŒDriverManager è¢«ç±»åŠ è½½æ—¶ï¼ˆstatic{}ï¼‰ä¼šè°ƒç”¨ `loadInitialDrivers()` ã€‚è¿™ä¸ªæ–¹æ³•å†…éƒ¨é€šè¿‡ ServiceLoader æä¾›çš„è¿­ä»£å™¨ Iterator éå†äº†æ‰€æœ‰é©±åŠ¨å®ç°ç±»ã€‚é‚£ä¹ˆï¼ŒServiceLoader æ˜¯å¦‚ä½•å®ä¾‹åŒ– Driver æ¥å£çš„å®ç°ç±»çš„å‘¢ï¼Ÿä¸‹ä¸€èŠ‚ï¼Œæˆ‘ä»¬ä¼šæ·±å…¥ ServiceLoader çš„æºç æ¥è§£ç­”è¿™ä¸ªé—®é¢˜ã€‚

* * *

3\. ServiceLoader æºç è§£æ
----------------------

### 3.1 ServiceLoader å…¥å£æ–¹æ³•

ServiceLoader æä¾›äº†ä¸‰ä¸ªé™æ€æ³›å‹å·¥å‚æ–¹æ³•ï¼Œå†…éƒ¨æœ€ç»ˆå°†è°ƒç”¨ `ServiceLoader.load(Class, ClassLoader)`ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯æœåŠ¡æ¥å£çš„ Class å¯¹è±¡ã€‚

`ServiceLoader.java`

    // æ–¹æ³• 1ï¼š
    public static <S> ServiceLoader<S> loadInstalled(Class<S> service) {
        // ä½¿ç”¨ SystemClassLoader ç±»åŠ è½½å™¨
        ClassLoader cl = ClassLoader.getSystemClassLoader();
        ClassLoader prev = null;
        while (cl != null) {
            prev = cl;
            cl = cl.getParent();
        }
        return ServiceLoader.load(service, prev);
    }
    
    // æ–¹æ³• 2ï¼š
    public static <S> ServiceLoader<S> load(Class<S> service) {
        // ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨
        ClassLoader cl = Thread.currentThread().getContextClassLoader();
        return ServiceLoader.load(service, cl);
    }
    
    // æ–¹æ³• 3ï¼ˆæœ€ç»ˆèµ°åˆ°è¿™ä¸ªæ–¹æ³•ï¼‰ï¼š
    public static <S> ServiceLoader<S> load(Class<S> service, ClassLoader loader){
        return new ServiceLoader<>(service, loader);
    }
    

å¯ä»¥çœ‹åˆ°ï¼Œä¸‰ä¸ªæ–¹æ³•ä»…åœ¨ä¼ å…¥çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œæœ€ç»ˆåªæ˜¯è¿”å›äº†ä¸€ä¸ªé¢å‘æœåŠ¡æ¥å£ S çš„ ServiceLoader å¯¹è±¡ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æ„é€ å™¨é‡Œåšäº†ä»€ä¹ˆå·¥ä½œã€‚

### 3.2 ServiceLoader æ„é€ æ–¹æ³•

`ServiceLoader.java`

    // å·²ç®€åŒ–
    private final Class<S> service;
    
    // æœåŠ¡å®ç°ç¼“å­˜
    private LinkedHashMap<String,S> providers = new LinkedHashMap<>();
    
    private ServiceLoader(Class<S> svc, ClassLoader cl) {
        // 1ã€ç±»åŠ è½½å™¨
        loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl;
        // 2ã€æ¸…ç©º providers
        providers.clear();
        // 3ã€å®ä¾‹åŒ– LazyIterator
        lookupIterator = new LazyIterator(service, loader);
    }
    

å¯ä»¥çœ‹åˆ°ï¼ŒServiceLoader çš„æ„é€ å™¨ä¸­ä¸»è¦å°±æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ª `LazyIterator` è¿­ä»£å™¨çš„å®ä¾‹ï¼Œè¿™æ˜¯ä¸€ä¸ªã€Œæ‡’åŠ è½½ã€çš„è¿­ä»£å™¨ã€‚è¿™ä¸ªè¿­ä»£å™¨é‡Œåšäº†ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹

### 3.3 LazyIterator è¿­ä»£å™¨

`ServiceLoader.java`

    // -> 3ã€å®ä¾‹åŒ– LazyIterator
    
    // å‰æ–‡æåˆ°çš„é…ç½®æ–‡ä»¶è·¯å¾„
    private static final String PREFIX = "META-INF/services/";
    
    private class LazyIterator implements Iterator<S> {
    
        // æœåŠ¡æ¥å£ Class å¯¹è±¡
        Class<S> service;
        ClassLoader loader;
        Enumeration<URL> configs = null;
    
        // pendingã€nextNameï¼šç”¨äºè§£æé…ç½®æ–‡ä»¶ä¸­çš„æœåŠ¡å®ç°ç±»å
        Iterator<String> pending = null;
        String nextName = null;
    
        private LazyIterator(Class<S> service, ClassLoader loader) {
            this.service = service;
            this.loader = loader;
        }
    
        // 3.1 åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªæœåŠ¡å®ç°
        @Override
        public boolean hasNext() {
            return hasNextService();
        }
    
        // 3.2 è¿”å›ä¸‹ä¸€ä¸ªæœåŠ¡å®ç°
        @Override
        public S next() {
            return nextService();
        }
    
        @Override
        public void remove() {
            throw new UnsupportedOperationException();
        }
    
        // -> 3.1 åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªæœåŠ¡å®ç°
        private boolean hasNextService() {
            if (nextName != null) {
                return true;
            }
            if (configs == null) {
                // 3.1.1 æ‹¼æ¥é…ç½®æ–‡ä»¶è·¯å¾„ï¼šMETA-INF/services/æœåŠ¡æ¥å£çš„å…¨é™å®šå
                String fullName = PREFIX + service.getName();
                if (loader == null)
                    configs = ClassLoader.getSystemResources(fullName);
                else
                    configs = loader.getResources(fullName);
            }
    
            // 3.1.2 parseï¼šè§£æé…ç½®æ–‡ä»¶èµ„æºçš„è¿­ä»£å™¨
            while ((pending == null) || !pending.hasNext()) {
                if (!configs.hasMoreElements()) {
                    return false;
                }
                pending = parse(service, configs.nextElement());
            }
            // 3.1.3 ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å…¨é™å®šå
            nextName = pending.next();
            return true;
        }
    
        // 3.2 è¿”å›ä¸‹ä¸€ä¸ªæœåŠ¡å®ç°
        private S nextService() {
            if (!hasNextService()) throw new NoSuchElementException();
            String cn = nextName;
            nextName = null;
    
            // 3.2.1 ä½¿ç”¨ç±»åŠ è½½å™¨ loader åŠ è½½
            Class<?> c = Class.forName(cn, false /* ä¸æ‰§è¡Œåˆå§‹åŒ– */, loader);
            if (!service.isAssignableFrom(c)) { 
    						// æ£€æŸ¥æ˜¯å¦å®ç° S æ¥å£
                ClassCastException cce = new ClassCastException(service.getCanonicalName() + " is not assignable from " + c.getCanonicalName());
                fail(service, "Provider " + cn  + " not a subtype", cce);
            }
    
            // 3.2.2 ä½¿ç”¨åå°„åˆ›å»ºæœåŠ¡ç±»å®ä¾‹
            S p = service.cast(c.newInstance());
    
            // 3.2.3 æœåŠ¡å®ç°ç±»ç¼“å­˜åˆ° providers
            providers.put(cn, p);
            return p;
        }
    }
    
    // -> 3.1.2 parseï¼šè§£æé…ç½®æ–‡ä»¶èµ„æºçš„è¿­ä»£å™¨
    private Iterator<String> parse(Class<?> service, URL u) throws ServiceConfigurationError {
        // ä½¿ç”¨ UTF-8 ç¼–ç è¾“å…¥é…ç½®æ–‡ä»¶èµ„æº
        InputStream in = u.openStream();
        BufferedReader r = new BufferedReader(new InputStreamReader(in, "utf-8"));
        ArrayList<String> names = new ArrayList<>();
        int lc = 1;
        while ((lc = parseLine(service, u, r, lc, names)) >= 0);
        return names.iterator();
    }
    

ä»¥ä¸Šä»£ç å·²ç»éå¸¸ç®€åŒ–äº†ï¼ŒLazyIterator çš„è¦ç‚¹å¦‚ä¸‹ï¼š

*   hasNext() åˆ¤æ–­é€»è¾‘ï¼š
    *   3.1.1 æ‹¼æ¥é…ç½®æ–‡ä»¶è·¯å¾„ï¼šã€ŒMETA-INF/services/æœåŠ¡æ¥å£çš„å…¨é™å®šåã€ï¼›
    *   3.1.2 è§£æé…ç½®æ–‡ä»¶èµ„æºçš„è¿­ä»£å™¨ï¼›
    *   3.1.3 æ‰¾åˆ°ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å…¨é™å®šåã€‚
*   next() é€»è¾‘ï¼š
    *   3.2.1 ä½¿ç”¨ç±»åŠ è½½å™¨ loader åŠ è½½ï¼ˆä¸æ‰§è¡Œåˆå§‹åŒ–ï¼‰ï¼›
    *   3.2.2 ä½¿ç”¨åå°„åˆ›å»ºæœåŠ¡ç±»å®ä¾‹ï¼›
    *   3.2.3 æœåŠ¡å®ç°ç±»ç¼“å­˜åˆ° providersã€‚

å°ç»“ä¸€ä¸‹ï¼š **LazyInterator ä¼šè§£æã€ŒMETA-INF/services/æœåŠ¡æ¥å£çš„å…¨é™å®šåã€é…ç½®ï¼Œéå†æ¯ä¸ªæœåŠ¡å®ç°ç±»å…¨é™å®šç±»åï¼Œæ‰§è¡Œç±»åŠ è½½ï¼ˆæœªåˆå§‹åŒ–ï¼‰ï¼Œæœ€åå°†æœåŠ¡å®ç°ç±»ç¼“å­˜åˆ° providersã€‚**

é‚£ä¹ˆï¼Œè¿™ä¸ªè¿­ä»£å™¨åœ¨å“ªé‡Œä½¿ç”¨çš„å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹çœ‹~

### 3.4 åŒ…è£…è¿­ä»£å™¨

å…¶å® ServiceLoader æœ¬èº«å°±æ˜¯å®ç° Iterable æ¥å£çš„ï¼š

`ServiceLoader.java`

    public final class ServiceLoader<S> implements Iterable<S>
    

è®©æˆ‘ä»¬æ¥çœ‹çœ‹ ServiceLoader ä¸­çš„ `Iterable#iterator()` æ˜¯å¦‚ä½•å®ç°çš„ï¼š

    private LazyIterator lookupIterator;
    
    // 4ã€è¿”å›ä¸€ä¸ªæ–°çš„è¿­ä»£å™¨ï¼ŒåŒ…è£…äº† providers å’Œ lookupIterator
    public Iterator<S> iterator() {
        return new Iterator<S>() {
    
            // providers å°±æ˜¯ä¸Šä¸€èŠ‚ next() ä¸­ç¼“å­˜çš„æœåŠ¡å®ç°
            Iterator<Map.Entry<String,S>> knownProviders = providers.entrySet().iterator();
    
            @Override
            public boolean hasNext() {
                // 4.1 ä¼˜å…ˆä» knownProviders å–ï¼Œå†ä» LazyIterator å–
                if (knownProviders.hasNext()) return true;
                return lookupIterator.hasNext();
            }
    
            @Override
            public S next() {
                // 4.2 ä¼˜å…ˆä» knownProviders å–ï¼Œå†ä» LazyIterator å–
                if (knownProviders.hasNext()) return knownProviders.next().getValue();
                return lookupIterator.next();
            }
    
            @Override
            public void remove() {
                throw new UnsupportedOperationException();
            }
        };
    }
    

å¯ä»¥çœ‹åˆ°ï¼ŒServiceLoader é‡Œæœ‰ä¸€ä¸ªæ³›å‹æ–¹æ³• Iterator<S> iterator()ï¼Œå®ƒåŒ…è£…äº† providers é›†åˆè¿­ä»£å™¨å’Œ lookupIterator ä¸¤ä¸ªè¿­ä»£å™¨ã€‚å¯¹äºå·²ç» â€œå‘ç°â€ çš„æœåŠ¡å®ç°ç±»ä¼šè¢«ç¼“å­˜åˆ° providers é›†åˆä¸­ï¼ŒåŒ…è£…ç±»çš„ä½œç”¨å°±æ˜¯ä¼˜å…ˆè¯»å–ç¼“å­˜è€Œå·²ã€‚

* * *

4\. ServiceLoader æºç åˆ†ææ€»ç»“
------------------------

ç†è§£ ServiceLoader æºç ä¹‹åï¼Œæˆ‘ä»¬æ€»ç»“è¦ç‚¹å¦‚ä¸‹ï¼š

### 4.1 çº¦æŸ

1ã€æœåŠ¡å®ç°ç±»å¿…é¡»å®ç°æœåŠ¡æ¥å£ Sï¼ˆ `if (!service.isAssignableFrom(c))` ï¼‰ï¼›  
2ã€æœåŠ¡å®ç°ç±»éœ€åŒ…å«æ— å‚çš„æ„é€ å™¨ï¼ŒLazyInterator æ˜¯åå°„åˆ›å»ºå®ç°ç±»å¸‚é‡Œçš„ï¼ˆ `S p = service.cast(c.newInstance())` ï¼‰ï¼›  
3ã€é…ç½®æ–‡ä»¶éœ€è¦ä½¿ç”¨ UTF-8 ç¼–ç ï¼ˆ `new BufferedReader(new InputStreamReader(in, "utf-8"))` ï¼‰ã€‚

### 4.2 æ‡’åŠ è½½

ServiceLoader ä½¿ç”¨ã€Œæ‡’åŠ è½½ã€çš„æ–¹å¼åˆ›å»ºæœåŠ¡å®ç°ç±»å®ä¾‹ï¼Œåªæœ‰åœ¨è¿­ä»£å™¨æ¨è¿›çš„æ—¶å€™æ‰ä¼šåˆ›å»ºå®ä¾‹ï¼ˆ `nextService()` ï¼‰ã€‚

### 4.3 å†…å­˜ç¼“å­˜

ServiceLoader ä½¿ç”¨ LinkedHashMap ç¼“å­˜åˆ›å»ºçš„æœåŠ¡å®ç°ç±»å®ä¾‹ã€‚

> æç¤ºï¼š LinkedHashMap åœ¨è¿­ä»£æ—¶ä¼šæŒ‰ç…§ Map#put æ‰§è¡Œé¡ºåºéå†ã€‚

### 4.4 æ²¡æœ‰æœåŠ¡æ³¨é”€æœºåˆ¶

æœåŠ¡å®ç°ç±»å®ä¾‹è¢«åˆ›å»ºåï¼Œå®ƒçš„åƒåœ¾å›æ”¶çš„è¡Œä¸ºä¸ Java ä¸­çš„å…¶ä»–å¯¹è±¡ä¸€æ ·ï¼Œåªæœ‰è¿™ä¸ªå¯¹è±¡æ²¡æœ‰åˆ° GC Root çš„å¼ºå¼•ç”¨ï¼Œæ‰èƒ½ä½œä¸ºåƒåœ¾å›æ”¶ã€‚è€Œ ServiceLoader å†…éƒ¨åªæœ‰ä¸€ä¸ªæ–¹æ³•æ¥å®Œå…¨æ¸…é™¤ provices å†…å­˜ç¼“å­˜ã€‚

    public void reload() {
        providers.clear();
        lookupIterator = new LazyIterator(service, loader);
    }
    

### 4.5 æ²¡æœ‰æœåŠ¡ç­›é€‰æœºåˆ¶

å½“å­˜åœ¨å¤šä¸ªæä¾›è€…æ—¶ï¼ŒServiceLoader æ²¡æœ‰æä¾›ç­›é€‰æœºåˆ¶ï¼Œä½¿ç”¨æ–¹åªèƒ½åœ¨éå†æ•´ä¸ªè¿­ä»£å™¨ä¸­çš„æ‰€æœ‰å®ç°ï¼Œä»å‘ç°çš„å®ç°ç±»ä¸­å†³ç­–å‡ºä¸€ä¸ªæœ€ä½³å®ç°ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—ç¬¦é›†çš„è¡¨ç¤ºç¬¦å·æ¥è·å¾—ä¸€ä¸ªå¯¹åº”çš„ Charset å¯¹è±¡ï¼š`Charset.forName(String)`ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢å°±åªä¼šé€‰æ‹©åŒ¹é…çš„ Charaset å¯¹è±¡ã€‚

`CharsetProvider.java`

    æœåŠ¡æ¥å£
    public abstract class CharsetProvider {
        public abstract Charset charsetForName(String charsetName);
        // çœç•¥å…¶ä»–æ–¹æ³•...
    }
    

`Charset.java`

    public static Charset forName(String charsetName) {
        // ä»¥ä¸‹åªæ‘˜è¦ä¸ ServiceLoader æœ‰å…³çš„é€»è¾‘...
    
        ServiceLoader<CharsetProvider> sl = ServiceLoader.load(CharsetProvider.class, cl);
        Iterator<CharsetProvider> i = sl.iterator();
        for (Iterator<CharsetProvider> i = providers(); i.hasNext();) {
            CharsetProvider cp = i.next();
            // æ»¡è¶³åŒ¹é…æ¡ä»¶ï¼Œreturn
            Charset cs = cp.charsetForName(charsetName);
            if (cs != null)
                return cs;
        }
    }
    

* * *

5\. æ€»ç»“
------

*   æœåŠ¡å‘ç° SPI æ˜¯æ§åˆ¶åè½¬ IoC çš„å®ç°æ–¹å¼ä¹‹ä¸€ï¼Œè€Œ ServiceLoader æ˜¯ JDK ä¸­å®ç°çš„ SPI æ¡†æ¶ã€‚ServiceLoader æœ¬èº«å°±æ˜¯ä¸€ä¸ª Iterable æ¥å£ï¼Œè¿­ä»£æ—¶ä¼šä» `META-INF/services` é…ç½®ä¸­è§£ææ¥å£å®ç°ç±»çš„å…¨é™å®šç±»åï¼Œä½¿ç”¨åå°„åˆ›å»ºæœåŠ¡å®ç°ç±»å¯¹è±¡ï¼›
*   ServiceLoader æ˜¯ JDK è‡ªå¸¦çš„æœåŠ¡å‘ç°æ¡†æ¶ï¼ŒåŸç†ä¹Ÿç›¸å¯¹ç®€å•ï¼Œæ¯”å¦‚ Charsetã€AnnocationProcessor ç­‰åŠŸèƒ½éƒ½æ˜¯åŸºäº ServiceLoader å®ç°çš„ã€‚å¦ä¸€æ–¹é¢ï¼ŒServiceLoader æ˜¯ä¸€ä¸ªç›¸å¯¹ç®€æ˜“çš„æ¡†æ¶ï¼Œä¸ºäº†æ»¡è¶³å¤æ‚ä¸šåŠ¡çš„éœ€è¦ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨å…¶ä»–ç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä¾‹å¦‚åå°çš„ Dubboã€å®¢æˆ·ç«¯çš„ ARouter ä¸ WMRouterç­‰ã€‚

* * *

> **æˆ‘æ˜¯å°å½­ï¼Œå¸¦ä½ æ„å»º Android çŸ¥è¯†ä½“ç³»ã€‚æŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] ç§ä¿¡æˆ‘æé—®ã€‚**

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/579a40c6a359479f92dc75abe2a8f580~tplv-k3u1fbpfcp-zoom-1.image)