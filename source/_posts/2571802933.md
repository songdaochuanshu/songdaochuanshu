---
layout: post
title: "å¦‚ä½•ä½¿ç”¨ Yolov4 è®­ç»ƒäººè„¸å£ç½©æ£€æµ‹æ¨¡å‹"
date: "2022-10-06T07:26:55.514Z"
---
å¦‚ä½•ä½¿ç”¨ Yolov4 è®­ç»ƒäººè„¸å£ç½©æ£€æµ‹æ¨¡å‹
======================

å‰è¨€
==

ç–«æƒ…å½“ä¸‹ï¼Œå‡ºå…¥åŒ»é™¢ç­‰å…¬å…±åœºæ‰€éƒ½è¢«è¦æ±‚ä½©æˆ´å£ç½©ã€‚è¿™ç¯‡åšå®¢å°†ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ Yolov4ï¼Œè®­ç»ƒä¸€ä¸ªäººè„¸å£ç½©æ£€æµ‹æ¨¡å‹ï¼ˆä½¿ç”¨ Yolov4 çš„åŸå› æ˜¯ç›®å‰åªå¤ç°åˆ°äº† v4 ğŸ˜‡ï¼‰ï¼Œä»£ç åœ°å€ä¸º [https://github.com/zhiyiYo/yolov4](https://github.com/zhiyiYo/yolov4)ã€‚

Yolov4
======

Yolov4 çš„ç¥ç»ç½‘ç»œç»“æ„ç›¸æ¯” Yolov3 å˜åŒ–ä¸æ˜¯å¾ˆå¤§ï¼Œä¸»è¦æ›´æ¢äº†æ¿€æ´»å‡½æ•°ä¸º Mishï¼Œå¢åŠ äº† SPP å—å’Œ PAN ç»“æ„ï¼ˆå›¾æº [ã€Šyoloç³»åˆ—å­¦ä¹ ç¬”è®°----yolov4ï¼ˆSPPåŸç†ï¼‰ã€‹](https://blog.csdn.net/YOULANSHENGMENG/article/details/121909125)ï¼‰ã€‚

![Yolov4 ç¥ç»ç½‘ç»œç»“æ„](https://img2022.cnblogs.com/blog/2065884/202210/2065884-20221006111420662-130956113.jpg)

æ„Ÿè§‰ Yolov4 æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ä½¿ç”¨äº†ä¸€å¤§å †çš„ Trickï¼Œæ¯”å¦‚æ•°æ®å¢å¼ºæ–¹é¢ä½¿ç”¨äº†é©¬èµ›å…‹æ•°æ®å¢å¼ºã€Mixup æ•°æ®å¢å¼ºï¼Œå°†å®šä½æŸå¤±å‡½æ•°æ›´æ¢ä¸º CIOU æŸå¤±ã€‚è®ºæ–‡ä¸­æåˆ°äº†å¾ˆå¤šçš„ Trickï¼Œæˆ‘çš„ä»£ç ä¸­æ²¡æœ‰å…¨éƒ¨å¤ç°ï¼Œä¸è¿‡åœ¨ VOC2012 æ•°æ®é›†è®­ç»ƒäº† 160 ä¸ª epoch ä¹‹å mAP ä¹Ÿèƒ½è¾¾åˆ° 83%ï¼Œæ•ˆæœè¿˜æ˜¯ä¸é”™çš„ã€‚

å¯ä»¥åœ¨ç»ˆç«¯ä½¿ç”¨ä¸‹è¿°æŒ‡ä»¤ä¸‹è½½ Yolov4 çš„ä»£ç ï¼š

    git clone https://github.com/zhiyiYo/yolov4.git
    

äººè„¸å£ç½©æ•°æ®é›†
=======

ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å¾ˆå¤šäººè„¸å£ç½©æ•°æ®é›†ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ [AIZOOTech](https://github.com/AIZOOTech/FaceMaskDetection) æä¾›çš„æ•°æ®é›†ã€‚ç”±äºè¿™ä¸ªæ•°æ®é›†çš„ç»“æ„å’Œ Pascal VOC æ•°æ®é›†ä¸ä¸€æ ·ï¼Œæ‰€ä»¥é‡æ–°ç»„ç»‡ä¸€ä¸‹æ•°æ®é›†ï¼Œå¹¶ä¸”ä¿®å¤å’Œç§»é™¤äº†æ•°æ®é›†ä¸­çš„éæ³•æ ‡ç­¾ï¼Œå¯ä»¥åœ¨ [Kaggle](https://www.kaggle.com/datasets/zhiyiyo/face-mask-dataset) ä¸Šä¸‹è½½æ­¤æ•°æ®é›†ã€‚ç›®å‰è¿™ä¸ªæ•°æ®é›†åŒ…å« 6130 å¼ è®­ç»ƒå›¾åƒï¼Œ1839 å¼ æµ‹è¯•å›¾åƒï¼Œå¯¹äº Yolov4 çš„è®­ç»ƒæ¥è¯´åº”è¯¥æ˜¯ç»°ç»°æœ‰ä½™çš„ã€‚ä¸‹è½½å®Œæ•°æ®é›†å°†å…¶è§£å‹åˆ° `data` æ–‡ä»¶å¤¹ä¸‹ã€‚

åœ¨è®­ç»ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ K-means èšç±»ç®—æ³•å¯¹è®­ç»ƒé›†ä¸­çš„è¾¹ç•Œæ¡†è¿›è¡Œèšç±»ï¼Œå¯¹äº 416Ã—416 çš„è¾“å…¥å›¾åƒï¼Œèšç±»ç»“æœå¦‚ä¸‹ï¼š

    anchors = [
        [[100, 146], [147, 203], [208, 260]],
        [[26, 43], [44, 65], [65, 105]],
        [[4, 8], [8, 15], [15, 27]]
    ]
    

è®­ç»ƒç¥ç»ç½‘ç»œ
======

è®­ç»ƒç›®æ ‡æ£€æµ‹æ¨¡å‹ä¸€èˆ¬éƒ½éœ€è¦åŠ è½½é¢„è®­ç»ƒçš„ä¸»å¹²ç½‘ç»œçš„æƒé‡ï¼Œå¯ä»¥ä»è°·æ­Œäº‘ç›˜ä¸‹è½½é¢„è®­ç»ƒå¥½çš„æƒé‡ [CSPDarknet53.pth](https://drive.google.com/file/d/12oV8QL937S1JWFQhzLNPoqyYc_bi0lWT/view?usp=sharing) å¹¶å°†å…¶æ”¾åœ¨ `model` æ–‡ä»¶å¤¹ä¸‹ã€‚è¿™é‡Œç»™å‡ºè®­ç»ƒæ‰€ç”¨çš„ä»£ç  `train.py`ï¼Œä½¿ç”¨ `python train.py` å°±èƒ½å¼€å§‹è®­ç»ƒã€‚æ¨¡å‹ä¼šå…ˆå†»ç»“è®­ç»ƒä¸Š 50 ä¸ª epochï¼Œæ¥ç€è§£å†»è®­ç»ƒ 110 ä¸ª epochï¼š

    # coding:utf-8
    from net import TrainPipeline, VOCDataset
    from utils.augmentation_utils import YoloAugmentation, ColorAugmentation
    
    # è®­ç»ƒé…ç½®
    config = {
        "n_classes": len(VOCDataset.classes),
        "image_size": 416,
        "anchors": [
            [[100, 146], [147, 203], [208, 260]],
            [[26, 43], [44, 65], [65, 105]],
            [[4, 8], [8, 15], [15, 27]]
        ],
        "darknet_path": "model/CSPdarknet53.pth",
        "lr": 1e-2,
        "batch_size": 8,
        "freeze_batch_size": 16,
        "freeze": True,
        "freeze_epoch": 50,
        "max_epoch": 160,
        "start_epoch": 0,
        "num_workers": 4,
        "save_frequency": 10,
        "no_aug_ratio": 0
    }
    
    # åŠ è½½æ•°æ®é›†
    root = 'data/FaceMaskDataset/train'
    dataset = VOCDataset(
        root,
        'all',
        transformer=YoloAugmentation(config['image_size']),
        color_transformer=ColorAugmentation(config['image_size']),
        use_mosaic=True,
        use_mixup=True,
        image_size=config["image_size"]
    )
    
    if __name__ == '__main__':
        train_pipeline = TrainPipeline(dataset=dataset, **config)
        train_pipeline.train()
    

æµ‹è¯•ç¥ç»ç½‘ç»œ
======

è®­ç»ƒå®Œä½¿ç”¨ `python evals.py` å¯ä»¥æµ‹è¯•æ‰€æœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œ`evals.py` ä»£ç å¦‚ä¸‹ï¼š

    # coding:utf-8
    import json
    from pathlib import Path
    
    import matplotlib as mpl
    import matplotlib.pyplot as plt
    
    from net import EvalPipeline, VOCDataset
    
    mpl.rc_file('resource/theme/matlab.mplstyle')
    
    
    # è½½å…¥æ•°æ®é›†
    root = 'data/FaceMaskDataset/val'
    dataset = VOCDataset(root, 'all')
    anchors = [
        [[100, 146], [147, 203], [208, 260]],
        [[26, 43], [44, 65], [65, 105]],
        [[4, 8], [8, 15], [15, 27]]
    ]
    
    # åˆ—å‡ºæ‰€æœ‰æ¨¡å‹ï¼Œè®°å¾—ä¿®æ”¹ Yolo æ¨¡å‹æ–‡ä»¶å¤¹çš„è·¯å¾„
    model_dir = Path('model/2022-10-05_22-59-44')
    model_paths = [i for i in model_dir.glob('Yolo_*')]
    model_paths.sort(key=lambda i: int(i.stem.split("_")[1]))
    
    # æµ‹è¯•æ‰€æœ‰æ¨¡å‹
    mAPs = []
    iterations = []
    for model_path in model_paths:
        iterations.append(int(model_path.stem[5:]))
        ep = EvalPipeline(model_path, dataset, anchors=anchors, conf_thresh=0.001)
        mAPs.append(ep.eval()*100)
    
    # ä¿å­˜æ•°æ®
    with open('eval/mAPs.json', 'w', encoding='utf-8') as f:
        json.dump(mAPs, f)
        
    # ç»˜åˆ¶ mAP æ›²çº¿
    fig, ax = plt.subplots(1, 1, num='mAP æ›²çº¿')
    ax.plot(iterations, mAPs)
    ax.set(xlabel='iteration', ylabel='mAP', title='mAP curve')
    plt.show()
    

å¾—åˆ°çš„ mAP æ›²çº¿å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨ç¬¬ 120 ä¸ª epoch è¾¾åˆ°æœ€å¤§å€¼ 94.14%ï¼š

![mAP æ›²çº¿](https://img2022.cnblogs.com/blog/2065884/202210/2065884-20221006115554561-589148662.png)

ä¸‹é¢ä½¿ç”¨ä¸€å¼ çœŸå®å›¾åƒçœ‹çœ‹è®­ç»ƒæ•ˆæœå¦‚ä½•ï¼Œè¿è¡Œ `demo.py`ï¼š

    # coding:utf-8
    from net import VOCDataset
    from utils.detection_utils import image_detect
    
    # æ¨¡å‹æ–‡ä»¶å’Œå›¾ç‰‡è·¯å¾„
    model_path = 'model/Yolo_120.pth'
    image_path = 'resource/image/ä¸‰ä¸Šè€å¸ˆ.jpg'
    
    # æ£€æµ‹ç›®æ ‡
    anchors = [
        [[100, 146], [147, 203], [208, 260]],
        [[26, 43], [44, 65], [65, 105]],
        [[4, 8], [8, 15], [15, 27]]
    ]
    image = image_detect(model_path, image_path, VOCDataset.classes, anchors=anchors, conf_thresh=0.5)
    image.show()
    

ä¸é”™ï¼Œæ•ˆæœéå¸¸å¥½ ğŸ˜Šï¼š

![ä¸‰ä¸Šè€å¸ˆ](https://img2022.cnblogs.com/blog/2065884/202210/2065884-20221006114035207-300097184.jpg)

åè®°
==

è‡³æ­¤ï¼Œä»‹ç»å®Œäº†è®­ç»ƒ Yolov4 äººè„¸å£ç½©æ£€æµ‹æ¨¡å‹çš„è¿‡ç¨‹ï¼Œä»£ç æ”¾åœ¨äº† [https://github.com/zhiyiYo/yolov4](https://github.com/zhiyiYo/yolov4)ï¼Œä»¥ä¸Š~~