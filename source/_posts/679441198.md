---
layout: post
title: "聊聊如何在华为云IoT平台进行产品开发"
date: "2022-04-28T04:25:30.944Z"
---
聊聊如何在华为云IoT平台进行产品开发
===================

> **摘要：**华为云物联网平台承载着南北向数据互通的功能职责。

本文分享自华为云社区《[如何基于华为云IoT物联网平台进行产品开发](https://bbs.huaweicloud.com/blogs/349684?utm_source=cnblog&utm_medium=bbs-ex&utm_campaign=iot&utm_content=content)》，作者： Super.雯 。

华为云物联网平台承载着南北向数据互通的功能职责。在华为云物联网平台基础上实现端到端物联网业务的过程中，开发者需要基于该平台进行二次开发。本文先跟大家一起聊一聊产品开发。

产品开发
----

在物联网平台集成解决方案中，物联网平台作为承上启下的中间部分，向应用服务器开放API接口，向各种协议的设备提供API对接。为了提供更加丰富的设备管理能力，物联网平台需要理解接入设备具备的能力以及设备上报数据的消息格式，因此，用户需要在控制台上完成产品模型和编解码插件的开发。基于IoT平台去实现一个物联网解决方案时，需完成的详细操作如下表所示：

![](https://pic3.zhimg.com/80/v2-d0bab084be1ebe7a4aa26f65f7c0425a_720w.jpg)

开通设备接入服务后，使用设备接入服务的完整流程主要分为产品开发、应用侧开发、设备侧开发和日常管理。

**产品开发：**开发者在进行设备接入前，基于控制台进行相应的开发工作，包括创建产品、创建设备、在线开发产品模型、在线开发插件、在线调试、自助测试和发布产品。

**设备侧开发：**设备侧可以通过集成SDK、模组或者原生协议接入物联网平台。

![](https://pic4.zhimg.com/80/v2-d4515a90c6801da7889642c3dfda8da3_720w.jpg)

**应用侧开发：**通过API的形式对外开放物联网平台丰富的设备管理能力，应用开发人员基于API接口开发所需的行业应用，如智慧城市、智慧园区、智慧工业、车联网等行业应用，满足不同行业的需求

**日常管理：**真实设备接入后，基于控制台或者API接口，进行日常的设备管理。

![](https://pic3.zhimg.com/80/v2-caa6169ee4663278c37cfb4259806b72_720w.jpg)

产品模型介绍
------

产品模型又称Profile，用于定义一款接入设备所具备的属性(如颜色、大小、采集的数据、可识别的指令或者设备上报的事件等信息)，然后通过厂家、设备类型和设备型号，唯一标识一款设备，便于平台识别。产品模型可以在设备接入控制台进行无码化开发。

产品模型是用来描述一款设备“是什么”、“能做什么”以及“如何控制该设备”的文件。开发者通过定义产品模型，在物联网平台构建一款设备的抽象模型，使平台理解该款设备支持的服务、属性、命令等信息，如颜色、开关等。当定义完一款产品模型后，在进行注册设备时，就可以使用在控制台上定义的产品模型。

![](https://pic1.zhimg.com/80/v2-d5f2686ce191bd48b0d0b38ef8eba410_720w.jpg)

在华为云物联网平台中，产品模型是设备接入的关键内容，里面包含了这个设备所提供的能力与服务，同时还包含了设备上下行的数据格式。例如，在设备上报数据到平台时，平台会根据上报数据的关键字进行产品模型匹配，并将数据格式与匹配上的产品模型文件进行校验，只有匹配成功的数据才会在平台上保存。如果匹配不成功，物联网平台会将上报的数据作为非法数据进行抛弃。

**产品信息：**描述一款设备的基本信息，包括厂商ID、厂商名称、设备类型、协议类型。例如：水表的厂商名称为“HZYB”，厂商ID为“TestUtf8ManuId”，设备类型为“WaterMeter”，协议类型为“CoAP”。

**服务能力：**描述设备具备的业务能力。将设备业务能力拆分成若干个服务后，再定义每个服务具备的属性、命令以及命令的参数。以水表为例，水表具有多种能力，如上报水流、告警、电量、连接等各种数据，并且能够接受服务器下发的各种命令。产品模型文件在描述水表的能力时，可以将水表的能力划分五个服务，每个服务都需要定义各自的上报属性或命令。

产品模型案例：智能水表
-----------

![](https://pic4.zhimg.com/80/v2-53b27928638e6058624e0fc2084fc4db_720w.jpg)![](https://pic4.zhimg.com/80/v2-f0581aea56bf9e801ee00730b43340a7_720w.jpg)

华为云物联网平台提供了多种定义产品模型的方法，开发者可以根据自己需求，选择对应的方法定义产品模型：

*   导入库模型(平台预置产品模型)
*   上传模型文件(离线开发)
*   Excel导入
*   自定义功能(在线开发)

设备编解码插件
-------

编解码插件简介
-------

### 什么是编解码插件？

编解码插件能够将终端上报的数据（二进制格式）解码为应用服务器所能“阅读”的数据（JSON格式），将服务器端下行命令数据（JSON格式）编码为终端设备所能“理解执行”的数据（二进制格式）。

### 为什么要使用编解码插件？

NB-IoT设备采用二进制格式或者tlv格式数据。

NB-IoT设备和IoT平台之间采用的是CoAP协议通讯，CoAP消息的payload为应用层协议数据，应用层数据的格式由设备自行定义。鉴于NB-IoT设备一般对省电要求较高，所以应用层数据一般不采用JSON格式数据。

应用服务器端并不理解二进制格式或者tlv格式数据。

### 如何开发编解码插件？

编解码插件的开发手段有图形化开发、离线开发和脚本化开发三种，由于插件离线开发较为复杂，且耗时比较长，推荐使用图形化开发编解码插件。

图形化开发是指在设备接入控制台，通过可视化的方式快速开发一款产品的编解码插件。

离线开发是指使用编解码插件的Java代码Demo进行二次开发，实现编解码功能、完成插件打包和质检等。

脚本化开发是指使用JavaScript脚本实现编解码的功能。

华为云物联网平台图形化编解码插件开发采用了将原有的插件开发代码进行抽象封装技术，开发者无需了解java编程语言，只需在开发界面将设备码流的格式完成定义，并将码流与profile中的属性关系通过拖拽的方式完成映射，点击部署后Portal会根据开发者的设计自动生成插件并打包部署到物联网平台。

对于设备发来的上行消息，首先解析CoAP报文得到应用层数据，然后调用设备厂商提供的插件解码，从而将消息发送到应用平台；对于来自应用平台的下行消息，需要调用设备厂商提供的编解码插件，组装CoAP消息发送到设备，如下图所示。此外编解码插件还负责对平台下发命令和对上报数据的响应进行编码。

![](https://pic4.zhimg.com/80/v2-154a0a03bf651768a9912a8b7a9cfb2b_720w.jpg)

数据上报
----

消息处理流程包括数据上报处理流程和命令下发处理流程，数据上报处理流程如下图所示。

![](https://pic3.zhimg.com/80/v2-3c159da65cb75fc6a2547e4ce4154c16_720w.jpg)

当设备和物联网平台完成对接后，一旦设备上电，设备基于在设备上定义的业务逻辑进行数据采集和上报，可以是基于周期或者事件触发。设备可通过以下方式发送数据到物联网平台：

**设备消息上报：**设备可以通过消息上报接口将设备的自定义数据上报到平台，平台对设备上报的消息不进行解析和存储，通过数据转发规则转发到华为云其他云服务上进行存储和处理，然后通过其他云服务的控制台或者API接口进行进一步的数据处理。

**设备原始数据（二进制）上报：**设备可以通过二进制上报接口上报设备的原始码流，平台通过编解码插件将设备原始数据解析为产品模型定义的JSON格式，解析后的数据上报给设备接入服务进行相关业务处理。

**设备属性上报：**设备通过属性上报接口，将产品模型中定义的属性数据上报给平台，平台解析后的数据上报给设备接入服务进行相关业务处理。

**网关批量属性上报：**网关设备将批量设备的数据一次性上报到平台，平台解析后的数据上报给设备接入服务进行相关业务处理。

在数据上报处理流程中，有两处需要用到编解码插件。

1.  将设备上报的二进制码流的数据解码成JSON格式的数据，发送给应用服务器。
2.  将应用服务器响应的JSON格式数据编码成二进制码流格式的数据，下发给设备。

命令下发
----

命令下发是指平台将命令下发到设备，设备响应并执行命令，从而达到平台到设备远程控制的效果。

这里分别列举了LwM2M/CoAP和MQTT这两种协议的立即下发和缓存下发的流程，如图所示。

![](https://pic2.zhimg.com/80/v2-63dc3ea291120b03d17e2eb69aaa5851_720w.jpg)![](https://pic2.zhimg.com/80/v2-f2a4491e4a54f397225bb8a875243e1d_720w.jpg)

应用下发命令到物联网平台，平台会根据对应的产品信息找到对应的编解码插件，对命令请求进行编码，将命令下发给设备；下发命令成功或失败，会根据下发结果更新命令状态，若设备对命令做出了响应，会将命令状态更新为“执行成功”或“执行失败”。

![](https://pic1.zhimg.com/80/v2-048297adcc1a0c912d11457c89e0987c_720w.jpg)

由于使用MQTT是不需要编解码插件的，直接使用透传的形式，当命令立即下发时，应用下发命令到物联网平台，平台将命令下发至设备，返回执行结果，消息执行结果通知。

![](https://pic4.zhimg.com/80/v2-993ce486eab1f51f5d7c4faa9e911e37_720w.jpg)

应用缓存下发命令，当设备不在线时，将命令写入缓存队列，更新消息状态，直到设备上报数据，设备上线，订阅消息下发Topic，消息下发，更新消息状态。

设备编解码插件示例：

![](https://pic3.zhimg.com/80/v2-30a53eef39fd97ec73ed91790a3a95ae_720w.jpg)

**更多学习内容，[请\[关注IoT物联网社区\]](https://developer.huaweicloud.com/techfield/iot.html?utm_source=blog&utm_medium=&utm_campaign=&utm_content=iot&utm_term=)**

添加华为云IoT小助手微信号（hwc-iot），回复“阅读”获取更多资讯

**[点击关注，第一时间了解华为云新鲜技术~](https://bbs.huaweicloud.com/blogs?utm_source=cnblog&utm_medium=bbs-ex&utm_campaign=iot&utm_content=content)**