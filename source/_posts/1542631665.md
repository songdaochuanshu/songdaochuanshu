---
layout: post
title: "pythonå¸¸è§æ¼æ´æ€»ç»“"
date: "2022-05-01T20:19:29.588Z"
---
pythonå¸¸è§æ¼æ´æ€»ç»“
============

æ€»ç»“ä¸€ä¸‹pythoné‡Œé¢å¸¸è§å®‰å…¨é—®é¢˜ï¼Œæ–‡ç« å¤§éƒ¨åˆ†å†…å®¹æ¥è‡ª`MisakiKata`å¸ˆå‚…çš„[python\_code\_audit](https://github.com/MisakiKata/python_code_audit)é¡¹ç›®ï¼Œå¯¹åŸæ–‡è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œåç»­ä¼šä½¿ç”¨ç¼–å†™äº†è§„åˆ™å¯¹ä»£ç é‡Œé¢æ˜¯å¦ç”¨åˆ°è¿™äº›å±é™©å‡½æ•°è¿›è¡Œç›¸åº”æ£€æµ‹

SQLæ³¨å…¥
-----

SQLæ³¨å…¥æ¼æ´çš„åŸå› æ˜¯ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥åˆ°äº†SQLæŸ¥è¯¢è¯­å¥é‡Œé¢ï¼Œåœ¨`python Web`åº”ç”¨ä¸­ä¸€èˆ¬éƒ½æ˜¯ç”¨ormåº“æ¥è¿›è¡Œæ•°æ®åº“ç›¸å…³æ“ä½œï¼Œæ¯”å¦‚`Flask`å’Œ`Tornado`ç»å¸¸ä½¿ç”¨`Sqlalchemy`ï¼Œè€Œ`Django`æœ‰è‡ªå·±è‡ªå¸¦çš„ormå¼•æ“ã€‚

ä½†æ˜¯å¦‚æœæ²¡æœ‰ä½¿ç”¨ormï¼Œè€Œç›´æ¥æ‹¼æ¥sqlè¯­å¥çš„è¯å°±ä¼šå­˜åœ¨SQLæ³¨å…¥çš„é£é™©

    sql = "SELECT * FROM user WHERE id=%s;" %id
    con.execute(sql)
    

åœ¨Djangoä¸­çš„ç¤ºä¾‹ä»£ç ï¼Œæ­¤å¤„å°±å­˜åœ¨SQLæ³¨å…¥

    username = c.execute('SELECT username FROM auth_user WHERE id = %s;' %str(id)).fetchall()
    

Flaskä¸­ä½¿ç”¨SQLAlchemyè¿›è¡Œæ•°æ®åº“æ“ä½œ

    user = User.query.filter(User.id == id)
    

å¯¹åº”çš„åŸå§‹SQLè¯­å¥å¦‚ä¸‹

    SELECT users.id AS users_id, users.name AS users_name, users.email AS users_email
    FROM users
    WHERE users.id = ?
    

ä¸€èˆ¬æ¥è¯´è¿™ç§æƒ…å†µä¸‹å°±ä¸ä¼šå‡ºç°SQLæ³¨å…¥äº†ï¼Œä½†åœ¨æŸäº›æˆ‘ä»¬æ²¡æœ‰æ­£ç¡®ä½¿ç”¨APIæ“ä½œçš„æ—¶å€™è¿˜æ˜¯ä¼šå­˜åœ¨SQLæ³¨å…¥æ¼æ´ï¼Œä¾‹å¦‚phithonçš„[Pwnhub Webé¢˜Classroomé¢˜è§£ä¸åˆ†æ](https://www.leavesongs.com/PENETRATION/pwnhub-web-classroom-django-sql-injection.html)  
å…¶ä¸­æœ€å…³é”®çš„éƒ¨åˆ†`view.py`çš„ä»£ç å¦‚ä¸‹

    class LoginView(JsonResponseMixin, generic.TemplateView):
        template_name = 'login.html'
    
        def post(self, request, *args, **kwargs):
            data = json.loads(request.body.decode())
            stu = models.Student.objects.filter(**data).first()
            if not stu or stu.passkey != data['passkey']:
                return self._jsondata('è´¦å·æˆ–å¯†ç é”™è¯¯', 403)
            else:
                request.session['is_login'] = True
                return self._jsondata('ç™»å½•æˆåŠŸ', 200) 
    

å¯ä»¥çœ‹åˆ°è¿™ä¸€è¡Œä»£ç `stu = models.Student.objects.filter(**data).first()`

æˆ‘ä»¬ä¼ å…¥çš„dataæ•°æ®ç›´æ¥è¢«å¸¦å…¥äº†`filter`è¯­å¥ï¼Œåœ¨å‰é¢çš„ä»‹ç»ä¸­ï¼Œ`filter`çš„æ“ä½œæ˜¯è¿™æ ·çš„`.filter(User.id == id)`ï¼Œè¿™ä¸¤è€…çš„ä¸åŒä¹‹å¤„åœ¨äºå‰è€…çš„å‚æ•°åè¢«æˆ‘ä»¬æ‰€æ§åˆ¶ï¼Œè¿›è€Œå¯ä»¥æŸ¥è¯¢æˆ‘ä»¬æƒ³è¦çš„æ•°æ®

å¦å¤–è™½ç„¶ORMæ¡†æ¶èƒ½é˜²å¾¡SQLæ³¨å…¥ï¼Œä½†ä½¿ç”¨ä¸å½“çš„æƒ…å†µä¸‹è¿˜ä¼šé€ æˆäºŒæ¬¡æ³¨å…¥ï¼Œä¾‹å¦‚

    def files(request):
        if request.GET.get('url'):
            url = request.GET.get('url')
            File.objects.create(filename=url)
            return HttpResponse('ä¿å­˜æˆåŠŸ')
        else:
            filename = File.objects.get(pk=23).filename
            cur = connection.cursor()
            cur.execute("""select * from code_audit_file where filename='%s'""" %(filename))
            str = cur.fetchall()
            cur.close()
            return HttpResponse(str)
    

å½“æˆ‘ä»¬ä¿å­˜å­—æ®µ`filename`çš„æ—¶å€™ï¼Œå¦‚æœfilenameçš„å€¼æ˜¯`' or '1'='1`ï¼Œåˆ™ä¼šè¢«è½¬ä¹‰ä¸º`\' or \'1\'=\'1`ï¼Œä½†æ˜¯å…¶ä¸­çš„å•å¼•å·å¹¶ä¸ä¼šè¢«å»é™¤ï¼Œè€Œæ˜¯è¢«å½“ä½œå­—ç¬¦ä¸²è¢«ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œåœ¨åç»­çš„è¿‡ç¨‹ä¸­è¢«è§¦å‘SQLæ³¨å…¥æ¼æ´  
`cur.execute("""select * from code_audit_file where filename='%s'""" %(filename))`

å› ä¸ºæ­£åˆ™åŒ¹é…è§„åˆ™çš„æ­»æ¿ï¼ŒäºŒæ¬¡æ³¨å…¥æˆ–è€…`Django`çš„å†å²æ¼æ´æƒ³è¦åœ¨æ­£åˆ™åŒ¹é…ä¸­å†™å‡ºé€šç”¨çš„è§„åˆ™æ˜¯éå¸¸å›°éš¾çš„ï¼Œä¹Ÿéœ€è¦æœ‰åºå¤§çš„è§„åˆ™åº“æ‰èƒ½å®ç°

å€Ÿé‰´\`\`ä»£ç ä¸­`select`æŸ¥è¯¢æ­£åˆ™å¦‚ä¸‹ï¼Œåˆ æ”¹æŸ¥æ“ä½œçš„æ­£åˆ™åŒ¹é…ä¹Ÿç±»ä¼¼  
"select\\s{1,4}.{1,60}from.{1,50}where\\s{1,3}.{1,50}=\["\\s\\.\]{0,10}\\$\\w{1,20}((\\\[\["'\]|\\\[)\\${0,1}\[\\w\\\[\\\]"'\]{0,30}){0,1}"

RCE
---

å¸¸è§çš„æ‰§è¡Œå‘½ä»¤æ¨¡å—å’Œå‡½æ•°æœ‰

*   os
*   subprocess
*   pty
*   codecs
*   popen
*   eval
*   exec
*   ...

åŒ…æ‹¬æˆ‘è‡ªå·±åœ¨æœ€å¼€å§‹å†™çˆ¬è™«çš„æ—¶å€™ä¹Ÿä¼šæœ‰è¿™ç§ä¸è§„èŒƒï¼š

    os.system('python exp.py -u http://evil.com')
    

å¦‚æœååˆ¶çˆ¬è™«çš„URLä¸º`"http://evil.com|rm -rf / &`ï¼Œè¿›ä¸€æ­¥ä¹Ÿå¯ä»¥æ§åˆ¶æœåŠ¡å™¨æƒé™

CTFé¢˜ç›®é‡Œé¢å¸¸è§çš„å‘½ä»¤æ‰§è¡Œæ“ä½œ`ping`

    os.system('ping -n 4 %s' %ip)
    

åŠ¨æ€è°ƒç”¨å®ç°

    oper_type=__import__('os').system('sleep 5')
    

åˆæ¯”å¦‚ä½¿ç”¨`eval`å°†å­—ç¬¦ä¸²è½¬å­—å…¸

    >>> json1="{'a':1}"
    >>> eval(json1)
    {'a': 1}
    

å¦‚æœ`json1`å¯æ§ä¹Ÿä¼šé€ æˆRCE

`subprocess.run`çš„æ¡ˆä¾‹

    def COMMAND(request):
        if request.GET.get('ip'):
            ip = request.GET.get('ip')
            cmd = 'ping -n 4 %s' %shlex.quote(ip)
            flag = subprocess.run(cmd, shell=False, stdout=subprocess.PIPE)
            stdout = flag.stdout
            return HttpResponse('<p>%s</p>' %str(stdout, encoding=chardet.detect(stdout)['encoding']))
        else:
            return HttpResponse('<p>è¯·è¾“å…¥IPåœ°å€</p>')
    

`subprocess`æ˜¯ä¸€ä¸ªä¸ºäº†ä»£æ›¿oså…¶ä¸­çš„å‘½ä»¤æ‰§è¡Œåº“è€Œå‡ºç°çš„ï¼Œpython3.5ä»¥åçš„ç‰ˆæœ¬ï¼Œå»ºè®®æ˜¯ä½¿ç”¨`subprocess.run`æ¥æ“ä½œï¼Œ3.5ä¹‹å‰çš„å¯ä»¥ä½¿ç”¨åº“ä¸­ä½ è®¤ä¸ºåˆé€‚çš„å‡½æ•°ã€‚ä¸è¿‡å®é™…ä¸Šéƒ½æ˜¯åŸºäº`subprocess.Popen`çš„å°è£…å®ç°çš„ï¼Œä¹Ÿå¯ä»¥æ‰§è¡Œä½¿ç”¨`subprocess.Popen`æ¥æ‰§è¡Œè¾ƒå¤æ‚çš„æ“ä½œï¼Œåœ¨`shell=False`çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯åˆ—è¡¨ï¼Œæˆ–è€…ä¼ å…¥å­—ç¬¦ä¸²ã€‚å½“ä½¿ç”¨`shell=True`çš„æ—¶å€™ï¼Œpythonä¼šè°ƒç”¨`/bin/sh`æ¥æ‰§è¡Œå‘½ä»¤ï¼Œå±Šæ—¶ä¼šé€ æˆå‘½ä»¤æ‰§è¡Œã€‚

    cmd = request.values.get('cmd')
    s = subprocess.Popen('ping -n 4 '+cmd, shell=True, stdout=subprocess.PIPE)
    stdout = s.communicate()
    return Response('<p>è¾“å…¥çš„å€¼ä¸ºï¼š%s</p>' %str(stdout[0], encoding=chardet.detect(stdout[0])['encoding']))
    

XSS
---

XSSå’ŒSQLæ³¨å…¥ç›¸åŒç‚¹éƒ½æ˜¯å¯¹ç”¨æˆ·çš„è¾“å…¥å‚æ•°æ²¡æœ‰è¿‡æ»¤å’Œæ­£ç¡®å¼•ç”¨ï¼Œå¯¼è‡´è¾“å‡ºçš„æ—¶å€™é€ æˆä»£ç æ³¨å…¥åˆ°é¡µé¢ä¸Š

ç¤ºä¾‹å¦‚ä¸‹

    name = request.GET.get('name')
    return HttpResponse("<p>name: %s</p>" %name)
    

Djangoä¸Šçš„XSSç¤ºä¾‹

    def XSS(request):
        if request.GET.get('name'):
            name = request.GET.get('name')
            return HttpResponse("<p>name: %s</p>" %name)
    

Flaskä¸Šçš„XSSç¤ºä¾‹

    @app.route('/xss')
    def XSS():
        if request.args.get('name'):
            name = request.args.get('name')
            return Response("<p>name: %s</p>" %name)
    

åœ¨`flask`ä¸­ä½¿ç”¨`render_template`èƒ½å¤Ÿé˜²å¾¡XSSæ¼æ´ï¼Œä½†åœ¨ä½¿ç”¨`safe`è¿‡æ»¤å™¨çš„æƒ…å†µä¸‹è¿˜æ˜¯ä¼šå¯¼è‡´XSS

    return render_template('xss.html', name=name)
    

å‰ç«¯ä»£ç ä¸º

    <h1>Hello {{ name|safe }}!</h1>
    

![](https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220430182946.png)

XXE
---

XMLå¤–éƒ¨å®ä½“æ³¨å…¥ã€‚å½“å…è®¸å¼•ç”¨å¤–éƒ¨å®ä½“æ—¶ï¼Œé€šè¿‡æ„é€ æ¶æ„å†…å®¹ï¼Œå°±å¯èƒ½å¯¼è‡´ä»»æ„æ–‡ä»¶è¯»å–ã€ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œã€å†…ç½‘ç«¯å£æ¢æµ‹ã€æ”»å‡»å†…ç½‘ç½‘ç«™ç­‰å±å®³

åœ¨pythonä¸­æœ‰ä¸‰ç§æ–¹æ³•è§£æXMLï¼š

*   SAX
    *   `xml.sax.parse()`
*   DOM
    *   `xml.dom.minidom.parse()`
    *   `xml.dom.pulldom.parse()`
*   ElementTree
    *   `xml.etree.ElementTree()`

å¦å¤–pythonä¸­ç¬¬ä¸‰æ–¹xmlè§£æåº“ä¹Ÿå¾ˆå¤šï¼Œ`libxml2`æ˜¯ä½¿ç”¨Cè¯­è¨€å¼€å‘çš„xmlè§£æå™¨ï¼Œè€Œ`lxml`æ˜¯pythonåŸºäº`libxml2`å¼€å‘çš„ï¼Œè¯¥åº“å­˜åœ¨XXEæ¼æ´

å­˜åœ¨æ¼æ´çš„ç¤ºä¾‹ä»£ç 

    def xxe():
        # tree = etree.parse('xml.xml')
        # tree = lxml.objectify.parse('xml.xml')
        # return etree.tostring(tree.getroot())
        xml = b"""<?xml version="1.0" encoding="UTF-8"?>
                <!DOCTYPE title [ <!ELEMENT title ANY >
                <!ENTITY xxe SYSTEM "file:///c:/windows/win.ini" >]>
                <channel>
                    <title>&xxe;</title>
                    <description>A blog about things</description>
                </channel>"""
        tree = etree.fromstring(xml)
        return etree.tostring(tree)
    

æ­¤å¤„åˆ©ç”¨`file`åè®®è¯»å–æœåŠ¡å™¨ä¸Šçš„æ•æ„Ÿæ–‡ä»¶ï¼Œæ¼æ´å­˜åœ¨çš„åŸå› æ˜¯`XMLparse`æ–¹æ³•ä¸­`resolve_entities`é»˜è®¤è®¾ç½®ä¸º`True`ï¼Œå¯¼è‡´å¯ä»¥è§£æå¤–éƒ¨å®ä½“

ä¸‹è¡¨æ¦‚è¿°äº†æ ‡å‡†åº“XMLå·²çŸ¥çš„æ”»å‡»ä»¥åŠå„ç§æ¨¡å—æ˜¯å¦å®¹æ˜“å—åˆ°æ”»å‡»ã€‚

ç§ç±»

sax

etree

minidom

pulldom

xmlrpc

billion laughs

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

quadratic blowup

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

**æ˜“å—æ”»å‡»**

external entity expansion

å®‰å…¨ (4)

å®‰å…¨ (1)

å®‰å…¨ (2)

å®‰å…¨ (4)

å®‰å…¨ (3)

[DTD](https://en.wikipedia.org/wiki/Document_type_definition) retrieval

å®‰å…¨ (4)

å®‰å…¨

å®‰å…¨

å®‰å…¨ (4)

å®‰å…¨

decompression bomb

å®‰å…¨

å®‰å…¨

å®‰å…¨

å®‰å…¨

**æ˜“å—æ”»å‡»**

ä¸€äº›ç‰ˆæœ¬æ¯”è¾ƒä½çš„ç¬¬ä¸‰æ–¹è§£æexcelåº“å†…éƒ¨æ˜¯ä½¿ç”¨lxmlæ¨¡å—å®ç°çš„ï¼Œé‡‡ç”¨çš„ä¹Ÿæ˜¯é»˜è®¤é…ç½®ï¼Œå¯¼è‡´å­˜åœ¨XXEæ¼æ´ï¼Œä¾‹å¦‚`openpyxl<=2.3.5`

CSRF
----

å› ä¸º`flask`çš„è®¾è®¡å“²å­¦ï¼Œæ‰€ä»¥åœ¨`flask`ä¸­é»˜è®¤æ²¡æœ‰`csrf`çš„é˜²æŠ¤

    @app.route('/csrf', methods=["GET","POST"])
    def CSRF():
        if request.method == "POST":
            name = request.values.get('name')
            email = request.values.get('email')
    

ä½†æ˜¯ç”¨æˆ·å¯ä»¥è‡ªè¡Œé€‰æ‹©ä½¿ç”¨æ‰©å±•æ’ä»¶`flask_wtf.csrf`å®ç°è®©æ‰€æœ‰æ¨¡å—æ¥å—csrfé˜²æŠ¤

    from flask_wtf.csrf import CSRFProtect
    CSRFPortect(app) #ä¿æŠ¤å…¨éƒ¨è§†å›¾
    

å¦‚æœæƒ³è¦å–æ¶ˆæŸä¸ªè·¯ç”±çš„csrfé˜²æŠ¤ï¼Œåˆ™ä½¿ç”¨è£…é¥°å™¨

    @csrf.exempt
    

Djangoä¸­é»˜è®¤å­˜åœ¨csrfä¸­é—´ä»¶`django.middleware.csrf.CsrfViewMiddleware`ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥é€šè¿‡`@csrf_exempt`è¿›è¡ŒæŸä¸ªè§†å›¾çš„å–æ¶ˆä¿æŠ¤

    @csrf_exempt
    def CSRF(request):
        if request.method == "POST":
    

å¦‚æœè®¾ç½®ä¸­å–æ¶ˆäº†é»˜è®¤çš„ä¸­é—´ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡`@csrf_protect`å¯¹è·¯ç”±è¿›è¡Œtokené˜²æŠ¤

    @csrf_protect
    def CSRF(request):
        if request.method == "POST":
    

SSRF
----

ä»£ç ä¸­å­˜åœ¨ç½‘ç»œè¯·æ±‚çš„æ—¶å€™å°±å¯èƒ½æœ‰SSRFæ¼æ´

pythonçš„å¯ä»¥é€ æˆè¿™ç§é—®é¢˜çš„å¸¸ç”¨è¯·æ±‚åº“ï¼š

*   pycurl
*   urllib
*   urllib3
*   requests

å› ä¸ºæˆ‘ä¸ªäººç”¨`requests`æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä»¥`requests`ä¸ºæ¡ˆä¾‹

    @app.route('/ssrf')
    def SSRF():
        if request.values.get('file'):
            file = request.values.get('file')
            req = requests.get(file)
            return render_template('ssrf.html', file=req.content.decode('utf-8'))
        else:
            return Response('<p>è¯·è¾“å…¥fileåœ°å€</p>')
    

ä¸è¿‡`requests`æœ‰ä¸€ä¸ªAdapterçš„å­—å…¸ï¼Œè¯·æ±‚ç±»å‹ä¸º`http://`æˆ–è€…`https://`ï¼Œåœ¨æŸç§ç¨‹åº¦ä¸Šä¹Ÿç®—æœ‰é™åˆ¶

    self.mount('https://', HTTPAdapter())
    self.mount('http://', HTTPAdapter())
    

è¦æ˜¯éœ€è¦åˆ©ç”¨æ¥è¯»å–æ–‡ä»¶ï¼Œå¯ä»¥é…åˆ`requests_file`æ¥å¢åŠ å¯¹fileåè®®çš„æ”¯æŒã€‚

    from requests_file import FileAdapter
    
    s = requests.Session()
    s.mount('file://', FileAdapter())
    req = s.get(file)
    

pythonä¸­å¦å¤–ä¸¤ä¸ªURLè¯·æ±‚çš„åº“ç›¸æ¯”å°±æ²¡æœ‰è¿™ä¹ˆå¤šé™åˆ¶ï¼Œèƒ½å¤Ÿæ„é€ çš„SSRF payloadå°±æ›´å¤š

å…³äºpython SSRFçš„é˜²å¾¡ï¼ŒPå¸ˆå‚…æ—©å¹´å†™è¿‡ä¸€ç¯‡æ–‡ç« [è°ˆä¸€è°ˆå¦‚ä½•åœ¨Pythonå¼€å‘ä¸­æ‹’ç»SSRFæ¼æ´](https://www.leavesongs.com/PYTHON/defend-ssrf-vulnerable-in-python.html)ï¼Œè™½ç„¶æœ‰çš„æ–¹æ³•ç°åœ¨å·²ç»ä¸é€‚ç”¨äº†ï¼Œä½†å¯ä»¥è¿›è¡Œæ€è·¯ä¸Šçš„å¯å‘

SSTI
----

ä¸åŒè¯­è¨€åœ¨ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™éƒ½æœ‰å¯èƒ½å­˜åœ¨æ¨¡æ¿æ³¨å…¥æ¼æ´ï¼Œpythonä¸­ä»¥flaskä¸ºä¾‹ï¼š

    def ssti():
        if request.values.get('name'):
            name = request.values.get('name')
            template = "<p>%s<p1>" %name
            return render_template_string(template)
            
            #template = Template('<p>%s<p1>' %name)
            #return template.render()
        else:
            return render_template_string('<p>è¾“å…¥nameå€¼</p>')
    

å…¶ä¸­å¤§æ¦‚æœ‰ä¸¤ä¸ªç‚¹æ˜¯å€¼å¾—åœ¨æ„çš„ï¼Œä¸€ä¸ªæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¦ä¸€ä¸ªæ˜¯å‡½æ•°`render_template_string`ã€‚å…¶æ˜¯è¿™ä¸¤ä¸ªæ›´åƒæ˜¯é…åˆåˆ©ç”¨ï¼Œåƒè¿™ä¹ˆä½¿ç”¨å°±ä¸ä¼šæœ‰è¿™ä¸ªé—®é¢˜

    def ssti():
        if request.values.get('name'):
            name = request.values.get('name')
            template = "<p>{{ name }}<p1>"
            return render_template_string(template, name=name)
        else:
            return render_template_string('<p>è¾“å…¥nameå€¼</p>')
    

è¿™ä¹ˆçœ‹çš„è¯ï¼Œé—®é¢˜å‡ºåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸Šé¢ï¼Œè€ŒéæŸä¸ªå‡½æ•°`render_template_string`ä¸Šï¼Œå½“å‰è€…ä¼ å…¥`{{config}}`æ—¶ï¼Œä¼šè¢«æ¨¡æ¿å½“ä½œåˆæ³•è¯­å¥æ¥æ‰§è¡Œï¼Œè€Œåè€…ä¼šæŠŠå‚æ•°å½“ä½œå­—ç¬¦ä¸²å¤„ç†è€Œä¸è¿›è¡Œç›¸å…³è§£æã€‚

ä¸ºäº†å®‰å…¨æ¨¡æ¿å¼•æ“åŸºæœ¬ä¸Šéƒ½æ‹¥æœ‰æ²™ç›’ç¯å¢ƒï¼Œæ¨¡æ¿æ³¨å…¥å¹¶ä¸ä¼šç›´æ¥è§£æpythonä»£ç é€ æˆä»»æ„ä»£ç æ‰§è¡Œï¼Œæ‰€ä»¥æƒ³è¦åˆ©ç”¨SSTIä¸€èˆ¬è¿˜éœ€è¦é…åˆæ²™ç®±é€ƒé€¸ï¼Œä¾‹å¦‚

    ().__class__.__mro__[-1].__subclasses__()[72].__init__.__globals__['os'].system('whoami')
    

æ²™ç®±é€ƒé€¸ä¸æ˜¯æˆ‘ä»¬è¿™é‡Œçš„é‡ç‚¹ï¼Œå°±ä¸è¿›ä¸€æ­¥é˜è¿°äº†ã€‚

åœ¨djangoä¸­ï¼Œä½¿ç”¨ä¸€äº›IDEåˆ›å»ºé¡¹ç›®çš„æ—¶å€™å¯ä»¥å¾ˆæ˜æ˜¾çœ‹åˆ°ï¼Œä½¿ç”¨çš„æ¨¡æ¿æ˜¯`Django`æ¨¡æ¿ï¼Œå½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨jinja2æ¨¡æ¿ï¼Œä¸è¿‡djangoè‡ªå·±çš„æ¨¡æ¿å¹¶æ˜¯å¾ˆå°‘è§è¿‡sstiè¿™ç§é—®é¢˜ï¼Œå€’æ˜¯ç”±äºæ ¼å¼åŒ–å­—ç¬¦ä¸²å¯¼è‡´ä¿¡æ¯æ³„éœ²ï¼Œå¦‚ä¸‹ä½¿ç”¨ä¸¤ç§æ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰é€ æˆé—®é¢˜çš„æƒ…å†µã€‚

    def SSTI(request):
        if request.GET.get('name'):
            name = request.GET.get('name')
            template = "<p>user:{user}, name:%s<p1>" %name
            return HttpResponse(template.format(user=request.user))
        else:
            return HttpResponse('<p>è¾“å…¥nameå€¼</p>')
    

å…¶ä¸­ï¼Œå½“nameä¼ å…¥`{user.password}`ä¼šè¯»å–åˆ°ç™»é™†ç”¨æˆ·çš„å¯†ç ï¼Œæ­¤å¤„ä½¿ç”¨ç®¡ç†å‘˜è´¦å·ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šä¼ å…¥çš„å‚æ•°æ˜¯nameï¼Œè€Œä¸‹é¢è§£æçš„æ—¶å€™è¢«æŒ‰ç…§å˜é‡æ¥è¯»å–äº†ã€‚

ä½¿ç”¨`format`æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¾å®šçš„useræ˜¯ç­‰äº`request.user`ï¼Œè€Œä¼ å…¥çš„æ˜¯`{user.password}`ï¼Œç›¸å½“äºtemplateæ˜¯`<p>user:{user}, name:{user.password}<p1>`ï¼Œè¿™æ ·å†å»æ ¼å¼åŒ–å­—ç¬¦ä¸²å°±å˜æˆäº†ï¼Œ`name:request.user.password`ï¼Œå¯¼è‡´è¢«è¯»å–åˆ°ä¿¡æ¯ã€‚

åœ¨`format`æ ¼å¼ç¬¦çš„æƒ…å†µä¸‹ï¼Œå‡ºç°sstiçš„æƒ…å†µä¹Ÿæå°‘ï¼Œæ¯”å¦‚ä½¿ç”¨å¦‚ä¸‹ä»£ç ï¼Œåªèƒ½è·å¾—ä¸€ä¸ªevalå‡½æ•°è°ƒç”¨ï¼Œ`format`åªèƒ½ä½¿ç”¨ç‚¹å’Œä¸­æ‹¬å·ï¼Œå¯¼è‡´æ‰§è¡Œå—åˆ°äº†é™åˆ¶ã€‚

    {user.__init__.__globals__[__builtins__][eval]}
    

pç‰›ç»™è¿‡ä¸¤ä¸ªä»£ç ç”¨æ¥åˆ©ç”¨djangoè¯»å–ä¿¡æ¯

*   `http://localhost:8000/?email={user.groups.model._meta.app_config.module.admin.settings.SECRET_KEY}`
*   `http://localhost:8000/?email={user.user_permissions.model._meta.app_config.module.admin.settings.SECRET_KEY}`

å†æ‰¾å‡ ä¸ªä¹Ÿå¯ä»¥ä½¿ç”¨çš„ï¼Œä¸Šé¢éƒ½æ˜¯ç›´æ¥ä½¿ç”¨authæ¨¡å—æ¥æ‰§è¡Œï¼Œå› æ­¤å¯ä»¥å…ˆä½¿ç”¨`{user.groups.model._meta.apps.app_configs}`æ‰¾åˆ°åŒ…å«çš„APPã€‚

*   `{user.groups.model._meta.apps.app_configs[auth].module.middleware.settings.SECRET_KEY}`
*   `{user.groups.model._meta.apps.app_configs[sessions].module.middleware.settings.SECRET_KEY}`
*   `{user.groups.model._meta.apps.app_configs[staticfiles].module.utils.settings.SECRET_KEY}`

æ–‡ä»¶æ“ä½œ
----

æ–‡ä»¶æ“ä½œå³æ–‡ä»¶çš„å¢åˆ æŸ¥æ”¹

å¢å’Œæ”¹éƒ½å¯ä»¥åˆ©ç”¨`write`æ–¹æ³•

    fo = open("foo.txt", "a")
    fo.write( "testfile\n")
    fo.close()
    

å½“ä½¿ç”¨`write`çš„æ—¶å€™å°±å®¹æ˜“å‡ºç°ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´

    @app.route('/upload', methods=['GET','POST'])
    def upload():
        if request.files.get('filename'):
            file = request.files.get('filename')
            upload_dir = os.path.join(os.path.dirname(__file__), 'uploadfile')
            dir = os.path.join(upload_dir, file.filename)
            with open(dir, 'wb') as f:
                f.write(file.read())
            # file.save(dir)
            return render_template('upload.html', file='ä¸Šä¼ æˆåŠŸ')
        else:
            return render_template('upload.html', file='é€‰æ‹©æ–‡ä»¶')
    

djangoä¸­çš„ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ æ ·ä¾‹ï¼š

    def UPLOADFILE(request):
        if request.method == 'GET':
            return render(request, 'upload.html', {'file':'é€‰æ‹©æ–‡ä»¶'})
        elif request.method == 'POST':
            dir = os.path.join(os.path.dirname(__file__), '../static/upload')
            file = request.FILES.get('filename')
            name = os.path.join(dir, file.name)
            with open(name, 'wb') as f:
                f.write(file.read())
            return render(request, 'upload.html', {'file':'ä¸Šä¼ æˆåŠŸ'})
    

åœ¨è¿™äº›æ ·ä¾‹ä»£ç ä¸­éƒ½å­˜åœ¨æœªé™åˆ¶æ–‡ä»¶å¤§å°ï¼Œæœªé™åˆ¶æ–‡ä»¶åç¼€ç­‰é—®é¢˜ï¼Œä½†ä¸Šä¼ ä¸Šå»çš„pythonæ–‡ä»¶ä¼šåƒä¾‹å¦‚phpä¸€å¥è¯æœ¨é©¬ä¸€æ ·è¢«è§£æå—

æˆ‘ä»¬çŸ¥é“`flask`,`Django`éƒ½æ˜¯é€šè¿‡è·¯ç”±æ¥è¿›è¡Œè¯·æ±‚ï¼Œå¦‚æœæˆ‘ä»¬å•çº¯ä¸Šä¼ ä¸€ä¸ª`python`æ–‡ä»¶ï¼Œå¹¶ä¸ä¼šé€ æˆå¸¸è§„çš„æ–‡ä»¶ä¸Šä¼ åˆ©ç”¨ï¼Œé™¤éåç»­å¤„ç†ç”¨ä½¿ç”¨äº†`eval`

ä½†å¦‚æœä½¿ç”¨`Apache`å’Œ`python`çš„ç¯å¢ƒå¼€å‘ï¼Œé‚£å°±è·Ÿå¸¸è§„çš„ç½‘ç«™ç±»ä¼¼äº†ï¼Œä¾‹å¦‚åœ¨httpd.confä¸­é…ç½®äº†å¯¹pythonçš„è§£æå­˜åœ¨ä¸€æ®µ`AddHandler mod_python .py`ã€‚é‚£ä¹ˆé€šè¿‡é“¾æ¥è¯·æ±‚çš„æ—¶å€™ï¼Œæ¯”å¦‚`http://www.xxx.com/test.py`ï¼Œpythonæ–‡ä»¶å°±ä¼šè¢«æ­£å¸¸è§£æã€‚

è¿˜æœ‰ä¸€ç§æ˜¯æ–‡ä»¶åçš„æ–‡ä»¶è¦†ç›–ï¼Œä¾‹å¦‚åŠŸèƒ½éœ€è¦æ‰¹é‡ä¸Šä¼ ï¼Œå…è®¸å‹ç¼©åŒ…å½¢å¼ä¸Šä¼ æ–‡ä»¶ï¼Œç„¶åè§£å‹åˆ°ç”¨æˆ·èµ„æºç›®å½•ï¼Œå¦‚æœæ­¤å¤„å­˜åœ¨é—®é¢˜ï¼Œå¯èƒ½ä¼šè¦†ç›–å…³é”®æ–‡ä»¶æ¥é€ æˆä»£ç æ‰§è¡Œã€‚æ¯”å¦‚`__init__.py`æ–‡ä»¶ã€‚

    @app.route('/zip', methods=['GET','POST'])
    def zip():
        if request.files.get('filename'):
            zip_file = request.files.get('filename')
            files = []
            with zipfile.ZipFile(zip_file, "r") as z:
                for fileinfo in z.infolist():
                    filename = fileinfo.filename
                    dat = z.open(filename, "r")
                    files.append(filename)
                    outfile = os.path.join(app.config['UPLOAD_FOLDER'], filename)
                    if not os.path.exists(os.path.dirname(outfile)):
                        try:
                            os.makedirs(os.path.dirname(outfile))
                        except OSError as exc:
                            if exc.errno != errno.EEXIST:
                                print("\n[WARN] OS Error: Race Condition")
                    if not outfile.endswith("/"):
                        with io.open(outfile, mode='wb') as f:
                            f.write(dat.read())
                    dat.close()
            return render_template('upload.html', file=files)
        else:
            return render_template('upload.html', file='é€‰æ‹©æ–‡ä»¶')
    

ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªä¸Šä¼ å‹ç¼©åŒ…å¹¶ä¸”è§£å‹åˆ°ç›®å½•çš„ä»£ç ï¼Œä»–ä¼šæŒ‰ç…§è§£å‹å‡ºæ¥çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶è¿›è¡Œå†™å…¥ç›®å½•ã€‚æ„é€ ä¸€ä¸ªå­˜åœ¨é—®é¢˜çš„å‹ç¼©åŒ…ï¼Œä¸Šä¼ åå¯ä»¥çœ‹åˆ°æ–‡ä»¶å¹¶ä¸åœ¨uploadfileç›®å½•ï¼Œè€Œåœ¨æ ¹ç›®å½•ä¸‹

    >>> z_info = zipfile.ZipInfo(r"../__init__.py")
    >>> z_file = zipfile.ZipFile("C:/Users/user/Desktop/bad.zip", mode="w")
    >>> z_file.writestr(z_info, "print('test')")
    >>> z_file.close()
    

é¡¹ç›®å¦‚æœè¢«é‡æ–°å¯åŠ¨ï¼Œå°±ä¼šçœ‹åˆ°ç•Œé¢è¾“å‡ºäº†testå­—æ®µã€‚

`python`ä¸­ä¹Ÿæä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹æ³•æ¥è§£å‹ï¼Œ\`\`zipfile.extract`æ›¿æ¢`zipfile.ZipFile`ï¼Œä½†æ˜¯å¹¶ä¸ä»£è¡¨`extractall\`ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚

ä½¿ç”¨`os.remove`å¯¹æ–‡ä»¶è¿›è¡Œåˆ é™¤

    import os
    os.remove("test2.txt")
    

ä»»æ„æ–‡ä»¶åˆ é™¤çš„æ¡ˆä¾‹å¦‚ä¸‹ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥åˆ é™¤ä¸ƒå¤©åçš„æ–‡ä»¶ï¼Œé€šè¿‡`django`çš„æ–‡ä»¶ç³»ç»Ÿæ¥è·å–ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œç„¶åæ ¹æ®æ—¶é—´æ¥åˆ é™¤ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯`dir_path`ï¼Œä½†æ˜¯åŸç³»ç»Ÿä¸­ä¸å­˜åœ¨é—®é¢˜ï¼Œåªæ˜¯å› ä¸ºä½¿ç”¨çš„æ—¶å€™è¿™ä¸ªç›®å½•æ˜¯ç¡¬ç¼–ç è¿›å»çš„ã€‚

    def directory_cleanup(dir_path, ndays):
        if not default_storage.exists(dir_path):
            return
    
        foldernames, filenames = default_storage.listdir(dir_path)
        for filename in filenames:
            if not filename:
                continue
            file_path = os.path.join(dir_path, filename)
            modified_dt = default_storage.get_modified_time(file_path)
            if modified_dt + timedelta(days=ndays) < datetime.now():
                # the file is older than ndays, delete it
                default_storage.delete(file_path)
        for foldername in foldernames:
            folder_path = os.path.join(dir_path, foldername)
            directory_cleanup(folder_path, ndays)
    
    

å½“ä¼ å…¥å‚æ•°ä¸º`file`åè®®çš„å½¢å¼å°±å¯ä»¥è¯»å–ç³»ç»Ÿä¸Šä»»æ„æ–‡ä»¶

    @app.route('/read')
    def readfile():
        if request.values.get('file'):
            file = request.values.get('file')
            req = urllib.request.urlopen(file)
            return Response(req.read().decode('utf-8'))
        else:
            return Response('<p>è¯·è¾“å…¥fileåœ°å€</p>')
    

å½“ç„¶ä¹Ÿå¯ä»¥ç”¨åˆšæ‰çš„æ–‡ä»¶è¯»å–æ¨¡å—æ¥è¯»å–

    def READFILE(request):
        if request.GET.get('file'):
            file = request.GET.get('file')
            file = open(file)
            return HttpResponse(file)
        else:
            return HttpResponse('<p>è¯·è¾“å…¥fileåœ°å€</p>')
    

flaskä¸­è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶è¯»å–ä¸‹è½½çš„æ–¹æ³•`send_from_directory`ï¼Œæ“ä½œä¸å½“çš„æ—¶å€™ä¹Ÿèƒ½å¤Ÿè¿›è¡Œæ•æ„Ÿæ–‡ä»¶è¯»å–

    return send_from_directory(os.path.join(os.path.dirname(__file__), 'uploadfile'), file)
    

ååºåˆ—åŒ–
----

Python çš„åºåˆ—åŒ–çš„ç›®çš„ä¹Ÿæ˜¯ä¸ºäº†ä¿å­˜ã€ä¼ é€’å’Œæ¢å¤å¯¹è±¡çš„æ–¹ä¾¿æ€§ï¼Œåœ¨ä¼—å¤šä¼ é€’å¯¹è±¡çš„æ–¹å¼ä¸­ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–å¯ä»¥è¯´æ˜¯æœ€ç®€å•å’Œæœ€å®¹æ˜“å®ç°çš„æ–¹å¼

`Python` ä¸ºæˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„åº“ `pickle` å’Œ `cPickle`ä»¥åŠå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°æ¥å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè¿™é‡Œä»¥`pickle`ä¸ºä¾‹

*   åºåˆ—åŒ–
    *   pickle.dump(æ–‡ä»¶)
    *   pickle.dumps(å­—ç¬¦ä¸²)
*   ååºåˆ—åŒ–
    *   pickle.load(æ–‡ä»¶)
    *   pickle.loads(å­—ç¬¦ä¸²)

å…¶ä¸­å¯é€ æˆå¨èƒçš„ä¸€èˆ¬æ˜¯`pickle.load`å’Œ`pickle.loads`ï¼Œæˆ–è€…é¢å‘å¯¹è±¡çš„ååºåˆ—åŒ–ç±»`pickle.Unpickler`ã€‚

pythonå®˜æ–¹è®¤ä¸ºå¹¶ä¸æ²¡æœ‰ä¹‰åŠ¡ä¿è¯ä½ ä¼ å…¥ååºåˆ—åŒ–å‡½æ•°çš„å†…å®¹æ˜¯å®‰å…¨çš„ï¼Œå®˜æ–¹åªè´Ÿè´£ååºåˆ—åŒ–ï¼Œå¦‚æœä½ ä¼ å…¥ä¸å®‰å…¨çš„å†…å®¹é‚£ä¹ˆè‡ªç„¶å°±æ˜¯ä¸å®‰å…¨çš„

    def ser():
        ser = request.values.get('ser')
        s = pickle.loads(ser)
    

è¿™é‡Œä¸å¾—ä¸æä¸€ä¸‹`__reduce__` é­”æœ¯æ–¹æ³•ï¼š

> å½“åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­ä¸­ç¢°åˆ°ä¸€æ— æ‰€çŸ¥çš„æ‰©å±•ç±»å‹(è¿™é‡ŒæŒ‡çš„å°±æ˜¯æ–°å¼ç±»)çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡ç±»ä¸­å®šä¹‰çš„`__reduce__`æ–¹æ³•æ¥å‘ŠçŸ¥å¦‚ä½•è¿›è¡Œåºåˆ—åŒ–æˆ–è€…ååºåˆ—åŒ–

æˆ‘ä»¬åªè¦åœ¨æ–°å¼ç±»ä¸­å®šä¹‰ä¸€ä¸ª `__reduce__` æ–¹æ³•ï¼Œå°±èƒ½åœ¨åºåˆ—åŒ–çš„ä½¿ç”¨è®©è¿™ä¸ªç±»æ ¹æ®æˆ‘ä»¬åœ¨`__reduce__` ä¸­æŒ‡å®šçš„æ–¹å¼è¿›è¡Œåºåˆ—åŒ–,å½“`__reduce__`è¿”å›å€¼æ˜¯ä¸€ä¸ªå…ƒç¥–çš„æ—¶å€™ï¼Œå¯ä»¥æä¾›2åˆ°5ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ©ç”¨çš„æ˜¯å‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªcallable object(å¯è°ƒç”¨çš„å¯¹è±¡)ï¼Œç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªå…ƒç¥–ä¸ºè¿™ä¸ªå¯è°ƒç”¨å¯¹è±¡æä¾›å¿…è¦çš„å‚æ•°ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹

    import pickle
    import os
    class A(object):
        def __reduce__(self):
            a = 'whoami'
            return (os.system,(a,))
    a = A()
    test = pickle.dumps(a)
    pickle.loads(test)
    

æˆåŠŸæ‰§è¡Œå‘½ä»¤  
![](https://springbird3.oss-cn-chengdu.aliyuncs.com/lianxiang/20220501164030.png)

`Marshal`åº“åºåˆ—åŒ–codeå¯¹è±¡ï¼Œä½¿ç”¨çš„`load`å’Œ`loads`æ–¹æ³•ä¼šå¯¼è‡´é—®é¢˜

    import pickle,builtins,pickletools,base64
    import marshal
    import urllib
    def foo():
        import os
        def fib(n):
            if n <= 2:
                return n
            return fib(n-1) + fib(n-2)
        print (fib(5))
    try:
        pickle.dumps(foo.__code__)
    except Exception as e:
        print(e)
    code_serialized = base64.b64encode(marshal.dumps(foo.__code__))
    code_unserialized = types.FunctionType(marshal.loads(base64.b64decode(code_serialized)), globals(), '')()
    print(code_unserialized)
    

`PyYAML`åº“æ˜¯yamlæ ‡è®°è¯­è¨€çš„pythonå®ç°åº“ï¼Œæ”¯æŒyamlæ ¼å¼çš„è¯­è¨€ï¼Œæœ‰è‡ªå·±çš„å®ç°æ¥è¿›è¡Œyamlæ ¼å¼çš„è§£æã€‚yamlæœ‰ä¸€å¥—å¯¹è±¡è½¬åŒ–è§„åˆ™ï¼Œpyyamlåœ¨è§£ææ•°æ®çš„æ—¶å€™é‡åˆ°ç‰¹å®šæ ¼å¼æ•°æ®ä¼šè‡ªåŠ¨è½¬æ¢ã€‚

æ¯”å¦‚ï¼Œä½¿ç”¨å¦‚ä¸‹è½¬æ¢ï¼Œå®é™…æ˜¯ä½¿ç”¨pythonæ¨¡å—æ‰§è¡Œäº†å‘½ä»¤

    cp = "!!python/object/apply:subprocess.check_output [[ls]]"
    yaml.load(cp)
    

å¯ä»¥æ„é€ å‘½ä»¤çš„pythonè¯­æ³•ï¼Œæœ‰`!!python/object/apply`å’Œ`!!python/object/new`ä¸¤ç§ã€‚`!!python/object`æ¥æ”¶çš„æ˜¯ä¸€ä¸ªdictç±»å‹çš„å¯¹è±¡å±æ€§ã€‚å¹¶ä¸æ¥æ”¶argsçš„åˆ—è¡¨å‚æ•°ã€‚

`jsonpickle`ç”¨äºå°†ä»»æ„å¯¹è±¡åºåˆ—åŒ–ä¸ºJSONçš„Pythonåº“ã€‚è¯¥å¯¹è±¡å¿…é¡»å¯ä»¥é€šè¿‡æ¨¡å—è¿›è¡Œå…¨å±€è®¿é—®ï¼Œå¹¶ä¸”å¿…é¡»ç»§æ‰¿è‡ªå¯¹è±¡ï¼ˆåˆç§°æ–°ç±»ï¼‰ã€‚

åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼š

    class Thing(object):
        def __init__(self, name):
            self.name = name
    
    obj = Thing('Awesome')
    

ä½¿ç”¨`Jsonpickle`å°†å¯¹è±¡è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²ï¼š

    import jsonpickle
    frozen = jsonpickle.encode(obj)
    

ä½¿ç”¨`Jsonpickle`ä»JSONå­—ç¬¦ä¸²é‡æ–°åˆ›å»ºPythonå¯¹è±¡ï¼š

    thawed = jsonpickle.decode(frozen)
    

å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„åˆ©ç”¨æ–¹å¼ï¼š

    >>> class Person(object):
    ...     def __reduce__(self):
    ...          return (__import__('os').system, ('whoami',))
    ...
    >>> admin = Person()
    jsonpickle.encode(admin)
    '{"py/reduce": [{"py/function": "nt.system"}, {"py/tuple": ["whoami"]}]}'
    >>> s = jsonpickle.encode(admin)
    >>> jsonpickle.decode(s)
    misaki\user
    

`Shelve`æ˜¯å¯¹è±¡æŒä¹…åŒ–ä¿å­˜æ–¹æ³•ï¼Œå°†å¯¹è±¡ä¿å­˜åˆ°æ–‡ä»¶é‡Œé¢ï¼Œç¼ºçœï¼ˆå³é»˜è®¤ï¼‰çš„æ•°æ®å­˜å‚¨æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ã€‚

ç”±äºshelveæ˜¯ä½¿ç”¨pickleæ¥åºåˆ—åŒ–æ•°æ®ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨pickleçš„æ–¹å¼æ¥æ‰§è¡Œå‘½ä»¤

    import shelve
    import os
    class exp(object):
        def __reduce__(self):
            return (os.system('whoami'))
    file = shelve.open("test")
    file['exp'] = exp()
    

ä»»æ„URLè·³è½¬
-------

ä»»æ„URLçš„è·³è½¬æ¡ˆä¾‹

    def urlbypass():
        if request.values.get('url'):
            url = request.values.get('url')
            return redirect(url)
    

æ€»ç»“
--

pythoné‡Œé¢çš„å®‰å…¨é—®é¢˜è¿˜æœ‰å¾ˆå¤šï¼Œè¿™é‡Œä¹Ÿåªæ˜¯åˆ—ä¸¾äº†ä¸€äº›å¸¸è§å¹¶ä¸”å±å®³è¾ƒå¤§çš„æ¼æ´ï¼Œè¿˜éœ€è¦åœ¨åç»­ä¸æ–­æ€»ç»“ã€‚å¦‚ä½•åœ¨è‡ªåŠ¨åŒ–ç™½ç›’å®¡è®¡ä¸­æ£€æµ‹åˆ°è¿™äº›æ¼æ´ï¼Ÿä½¿ç”¨ä¼ ç»Ÿçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å±é™©å‡½æ•°å±€é™æ€§éå¸¸å¤§ï¼Œè¯¯æŠ¥å¯¼è‡´ä»£ç å®¡è®¡äººå‘˜èŠ±è´¹å¤§é‡æ—¶é—´å›æº¯å±é™©å‡½æ•°çš„è°ƒç”¨ï¼›åˆ©ç”¨ASTè¯­æ³•æ ‘çš„æ–¹å¼è¾…åŠ©ä»£ç å®¡è®¡ç°åœ¨é€æ­¥æˆä¸ºä¸»æµï¼Œä»¥`CodeQL`ä¸ºä¾‹ï¼Œéœ€è¦è‡ªå·±å…ˆå­¦ä¹ QLè¯­è¨€ï¼Œç„¶åç¼–å†™åŒ¹é…è§„åˆ™ï¼Œä¸åŒè¯­è¨€çš„è§„åˆ™åº“ä¸åŒè¿™äº›é—®é¢˜æ— å½¢ä¹‹ä¸­æ‹‰é«˜äº†å­¦ä¹ é—¨æ§›ï¼Œå…¶æœ¬èº«ä¹Ÿæœ‰æ ‡å‡†åº“è¦†ç›–ä¸å®Œå…¨ç­‰é—®é¢˜

æ‰€ä»¥ç¼–å†™ä¸€ä¸ªpythonçš„ç™½ç›’ä»£ç å®¡è®¡ç³»ç»Ÿå°±æ˜¯åç»­çš„å·¥ä½œå•¦:-)

å‚è€ƒé“¾æ¥
----

*   [https://github.com/bit4woo/python\_sec](https://github.com/bit4woo/python_sec)
*   [http://xxlegend.com/2015/07/30/Pythonå®‰å…¨ç¼–ç å’Œä»£ç å®¡è®¡/](http://xxlegend.com/2015/07/30/Python%E5%AE%89%E5%85%A8%E7%BC%96%E7%A0%81%E5%92%8C%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/)
*   Python\_Hack\_çŸ¥é“åˆ›å®‡\_åŒ—åŒ—(å­™åš)
*   [http://blog.neargle.com/2016/07/22/pythonweb-framework-dev-vulnerable/](http://blog.neargle.com/2016/07/22/pythonweb-framework-dev-vulnerable/)
*   [http://xxlegend.com/2015/07/31/Python evalçš„å¸¸è§é”™è¯¯å°è£…åŠåˆ©ç”¨åŸç†/](http://xxlegend.com/2015/07/31/Python%20eval%E7%9A%84%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%B0%81%E8%A3%85%E5%8F%8A%E5%88%A9%E7%94%A8%E5%8E%9F%E7%90%86/)
*   [https://www.k0rz3n.com/2018/11/12/ä¸€ç¯‡æ–‡ç« å¸¦ä½ ç†è§£æ¼æ´ä¹‹Python ååºåˆ—åŒ–æ¼æ´/](https://www.k0rz3n.com/2018/11/12/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E7%90%86%E8%A7%A3%E6%BC%8F%E6%B4%9E%E4%B9%8BPython%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/)

END
---

å»ºäº†ä¸€ä¸ªå¾®ä¿¡çš„å®‰å…¨äº¤æµç¾¤ï¼Œæ¬¢è¿æ·»åŠ æˆ‘å¾®ä¿¡å¤‡æ³¨`è¿›ç¾¤`ï¼Œä¸€èµ·æ¥èŠå¤©å¹æ°´å“‡ï¼Œä»¥åŠä¸€ä¸ªä¼šå‘å¸ƒå®‰å…¨ç›¸å…³å†…å®¹çš„å…¬ä¼—å·ï¼Œæ¬¢è¿å…³æ³¨ ğŸ˜ƒ

![GIF](https://springbird.oss-cn-beijing.aliyuncs.com/img/mmqrcode1632325540724.png) ![GIF](https://springbird.oss-cn-beijing.aliyuncs.com/img/qrcode_for_gh_cead8e1080d6_344.jpg)