---
layout: post
title: "FreeSql å¯¼å…¥æ•°æ®çš„å„ç§åœºæ™¯æ€»ç»“ [C#.NET ORM]"
date: "2022-09-07T14:27:13.928Z"
---
FreeSql å¯¼å…¥æ•°æ®çš„å„ç§åœºæ™¯æ€»ç»“ \[C#.NET ORM\]
==================================

ğŸ’» å‰è¨€
-----

å¯¼å…¥æ•°æ®è¿™ç§è„æ´»ã€ç´¯æ´»ï¼Œç›¸ä¿¡å¤§å®¶å¤šå¤šå°‘å°‘éƒ½æœ‰ç»å†ï¼Œå¸¸è§çš„åœºæ™¯æœ‰ï¼š

*   åŒæœåŠ¡å™¨ä»Aè¡¨å¯¼æ•°æ®åˆ°Bè¡¨
*   æ‰¹é‡å¯¼å…¥æ–°æ•°æ®
*   æ‰¹é‡æ–°å¢æˆ–æ›´æ–°æ•°æ®
*   è·¨æœåŠ¡å™¨ä»Aè¡¨å¯¼æ•°æ®åˆ°Bè¡¨

æ¯ç§åœºæ™¯æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šæ ¹æ®ç‰¹ç‚¹å®šåˆ¶åšå¯¼å…¥æ•°æ®ä¼˜åŒ–ï¼Œå‡å°‘æ€»ä½“å¯¼å…¥çš„è€—æ—¶ï¼Œæˆ–è€…é¿å…æ•°æ®åº“IO/CPUå ç”¨è¿‡é«˜ï¼Œè€Œå½±å“åˆ°å…¶ä»–æ­£å¸¸ä¸šåŠ¡ã€‚

FreeSql æœ‰å¥½å‡ ä¸ªå®ç”¨åŠŸèƒ½ï¼Œæµå¼è¯»å–æ•°æ®ã€æŸ¥è¯¢å¹¶æ’å…¥ã€æ‰¹é‡å¯¹æ¯”æ›´æ–°ã€æ’å…¥æˆ–ä¿®æ”¹ï¼ˆæ”¯æŒå®ä½“ç±»æˆ–å­—å…¸ï¼‰ï¼Œç”¨å¥½è¿™äº›åŠŸèƒ½å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å„ç§å¯¼å…¥æ•°æ®åœºæ™¯ã€‚å…¶å® FreeSql å¯¹åº”çš„æ–‡æ¡£ä¸€ç›´éƒ½æœ‰ï¼Œåªæ˜¯å†…å®¹ä»‹ç»æ¯”è¾ƒé›¶æ•£ï¼Œè¿™ç¯‡æ–‡ç« å°†é’ˆå¯¹æ•°æ®å¯¼å…¥è¯¦ç»†ä»‹ç»å®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•ï¼Œæ—¢ç„¶ FreeSql bug å°‘é‚£å°±å¤šä¼˜åŒ–ä¸€ä¸‹æ–‡æ¡£å§ï¼

æœ¬æ–‡è®²è§£ä»¥ä¸Šå››ç§å¸¸è§çš„æ•°æ®å¯¼å…¥å®ç°ï¼Œè®©ä½¿ç”¨è€…é«˜æ•ˆè§£å†³å·¥ä½œé—®é¢˜ã€‚å¦‚æœä½ åœ¨ä½¿ç”¨å…¶ä»–æ›´å¥½çš„å¯¼å…¥æ–¹æ¡ˆï¼Œæ¬¢è¿åŠ å…¥è®¨è®ºï¼

* * *

ğŸŒ³ C#.NET ORMæ¦‚å¿µ
---------------

.NET ORM Object Relational Mapping æ˜¯ä¸€ç§ä¸ºäº†è§£å†³é¢å‘å¯¹è±¡ä¸å…³ç³»æ•°æ®åº“å­˜åœ¨çš„äº’ä¸åŒ¹é…çš„ç°è±¡çš„æŠ€æœ¯ã€‚FreeSql .NET ORM æ”¯æŒ .NetFramework4.0+ã€.NetCoreã€Xamarinã€MAUIã€Blazorã€ä»¥åŠè¿˜æœ‰è¯´ä¸å‡ºæ¥çš„è¿è¡Œå¹³å°ï¼Œå› ä¸ºä»£ç **ç»¿è‰²æ— ä¾èµ–**ï¼Œæ”¯æŒæ–°å¹³å°éå¸¸ç®€å•ã€‚ç›®å‰å•å…ƒæµ‹è¯•æ•°é‡ï¼š8500+ï¼ŒNugetä¸‹è½½æ•°é‡ï¼š1M+ã€‚ä½¿ç”¨æœ€å®½æ¾çš„å¼€æºåè®® MIT [https://github.com/dotnetcore/FreeSql](https://github.com/dotnetcore/FreeSql) ï¼Œå¯ä»¥å•†ç”¨ï¼Œæ–‡æ¡£é½å…¨ï¼Œç”šè‡³æ‹¿å»å–é’±ä¹Ÿå¯ä»¥ã€‚

FreeSql ä¸»è¦ä¼˜åŠ¿åœ¨äºæ˜“ç”¨æ€§ä¸Šï¼ŒåŸºæœ¬æ˜¯å¼€ç®±å³ç”¨ï¼Œåœ¨ä¸åŒæ•°æ®åº“ä¹‹é—´åˆ‡æ¢å…¼å®¹æ€§æ¯”è¾ƒå¥½ï¼Œæ•´ä½“çš„åŠŸèƒ½ç‰¹æ€§å¦‚ä¸‹ï¼š

*   æ”¯æŒ CodeFirst å¯¹æ¯”ç»“æ„å˜åŒ–è¿ç§»ã€DbFirst ä»æ•°æ®åº“ç”Ÿæˆå®ä½“ç±»ï¼›
*   æ”¯æŒ ä¸°å¯Œçš„è¡¨è¾¾å¼å‡½æ•°ï¼Œç‹¬ç‰¹çš„è‡ªå®šä¹‰è§£æï¼›
*   æ”¯æŒ æ‰¹é‡æ·»åŠ ã€æ‰¹é‡æ›´æ–°ã€BulkCopyã€å¯¼èˆªå±æ€§ï¼Œè´ªå©ªåŠ è½½ã€å»¶æ—¶åŠ è½½ã€çº§è”ä¿å­˜ã€çº§è”åˆ é™¤ï¼›
*   æ”¯æŒ è¯»å†™åˆ†ç¦»ã€åˆ†è¡¨åˆ†åº“ï¼Œç§Ÿæˆ·è®¾è®¡ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡ï¼›
*   æ”¯æŒ MySql/SqlServer/PostgreSQL/Oracle/Sqlite/Firebird/è¾¾æ¢¦/ç¥é€š/äººå¤§é‡‘ä»“/ç¿°é«˜/Clickhouse/MsAccess Ado.net å®ç°åŒ…ï¼Œä»¥åŠ Odbc çš„ä¸“é—¨å®ç°åŒ…ï¼›

8000+ä¸ªå•å…ƒæµ‹è¯•ä½œä¸ºåŸºè°ƒï¼Œæ”¯æŒ10å¤šæ•°æ•°æ®åº“ï¼Œæˆ‘ä»¬æä¾›äº†é€šç”¨Odbcç†è®ºä¸Šæ”¯æŒæ‰€æœ‰æ•°æ®åº“ï¼Œç›®å‰å·²çŸ¥æœ‰ç¾¤å‹ä½¿ç”¨ FreeSql æ“ä½œåä¸ºé«˜æ–¯ã€mycatã€tidb ç­‰æ•°æ®åº“ã€‚å®‰è£…æ—¶åªéœ€è¦é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“å®ç°åŒ…ï¼š

> dotnet add packages FreeSql.Provider.Sqlite

    static IFreeSql fsql = new FreeSql.FreeSqlBuilder()
        .UseConnectionString(FreeSql.DataType.Sqlite, @"Data Source=db1.db")
        .UseAutoSyncStructure(true) //è‡ªåŠ¨åŒæ­¥å®ä½“ç»“æ„åˆ°æ•°æ®åº“
        .UseNoneCommandParameter(true) //SQLä¸ä½¿ç”¨å‚æ•°åŒ–ï¼Œä»¥ä¾¿è°ƒè¯•
        .UseMonitorCommand(cmd => Console.WriteLine(cmd.CommandText)) //æ‰“å° SQL
        .Build();
    

FreeSql æä¾›å¤šç§ CRUD ä½¿ç”¨ä¹ æƒ¯ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©å›¢é˜Ÿåˆé€‚çš„ä¸€ç§ï¼š

*   è¦ä¹ˆ FreeSqlï¼ŒåŸå§‹ç”¨æ³•ï¼›
*   è¦ä¹ˆ FreeSql.Repositoryï¼Œä»“å‚¨+å·¥ä½œå•å…ƒä¹ æƒ¯ï¼›
*   è¦ä¹ˆ FreeSql.DbContextï¼Œå¾ˆåƒ EFCore çš„ä½¿ç”¨ä¹ æƒ¯ï¼›
*   è¦ä¹ˆ FreeSql.BaseEntityï¼Œå……è¡€æ¨¡å¼ï¼›
*   è¦ä¹ˆ ç›´æ¥åƒ dapper é‚£æ ·ä½¿ç”¨ DbConnection æ‰©å±•æ–¹æ³•ï¼›

* * *

âš¡ åœºæ™¯ä¸€ï¼šåŒæœåŠ¡å™¨ä»Aè¡¨å¯¼æ•°æ®åˆ°Bè¡¨
-------------------

å¯¼å…¥æ•°æ®ï¼Œæ­£å¸¸éœ€è¦æ ¹æ®æºæ•°æ®é‡çš„å¤§å°æ¥è¯„ä¼°ï¼Œè¯„ä¼°è¿‡ç¨‹éœ€è¦åœ¨å®è·µä¸­æ…¢æ…¢ç§¯ç´¯ï¼Œä»¥ä¾¿é€‰æ‹©å¯¹åº”çš„å¯¼å…¥æ–¹æ¡ˆã€‚åŒæœåŠ¡å™¨å¯¼å…¥æ•°æ®çš„æ–¹æ¡ˆæœ‰ï¼š

* * *

1ã€insert into A(field1, field2) select name, code from B where ...

    fsql.Select<B>()
        .Where(b => b.Time > DateTime.Parse("2022-08-01"))
        .InsertInto("A", b => new { b.Name, b.Code });
    

å¦‚æœæ•°æ®æºæ˜¯å¤šä¸ªè¡¨ç»„æˆï¼Œä¹Ÿå¯ä»¥ï¼š

    fsql.Select<B, C>()
        .InnerJoin((b, c) => b.Id == c.Id)
        .Where((b, c) => b.Time > DateTime.Parse("2022-08-01"))
        .InsertInto("A", (b, c) => new { b.Name, c.Code });
    

* * *

2ã€åˆ†æ®µæ’å…¥

FreeSql æä¾›æµå¼åˆ†æ®µè¿”å›æ•°æ®ï¼Œé˜²æ­¢è¯»å–çš„æ•°æ®æºé‡è¿‡å¤šæ—¶å ç”¨å†…å­˜ï¼Œå‡è®¾æ•°æ®è¡¨æœ‰100Wä¸‡è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®æ¯æ¬¡åªè¿”å› 1000 æ¡ã€‚æç¤ºï¼šToChunk åªæ‰§è¡Œäº†ä¸€æ¬¡ SQL æŸ¥è¯¢ã€‚

    fsql.Select<B>()
        .Where(b => b.Time > DateTime.Parse("2022-08-01"))
        .ToChunk(b => new A { field1 = b.Name, field2 = b.Code }, 1000, cb => {
            fsql.Insert(cb.Object).NoneParameter().ExecuteAffrows();
            //å¦‚æœæ•°æ®åº“æ”¯æŒ BulkCopy å¯ä»¥è°ƒç”¨å¯¹åº”çš„ API æ–¹æ³•ï¼Œå¦‚ SqlServerï¼š
            //fsql.Insert(cb.Object).ExecuteSqlBulkCopy();
        });
    

* * *

3ã€åˆ†é¡µæ’å…¥

åˆ©ç”¨åˆ†é¡µå¤šæ¬¡è¯»å–ï¼Œåˆ†é¡µå¯èƒ½é€ æˆæ–°æ—§æ•°æ®é—®é¢˜ï¼Œå°½é‡è®¾ç½®å¥½åˆ†é¡µæ’åºå¹¶è®°å½•å¥½åç§»é‡ï¼Œç¡®ä¿é‡å¤é—®é¢˜ã€‚ï¼ˆä¸æ¨èï¼‰

    var pageNumber = 1;
    while (true)
    {
        var list = fsql.Select<B>()
            .Where(b => b.Time > DateTime.Parse("2022-08-01"))
            .Page(pageNumber++, 1000)
            .OrderBy(b => b.Time)
            .ToList(b => new A { field1 = b.Name, field2 = b.Code }, 1000);
        if (list.Count == 0) break;
    
        fsql.Insert(cb.Object).NoneParameter().ExecuteAffrows();
        //å¦‚æœæ•°æ®åº“æ”¯æŒ BulkCopy å¯ä»¥è°ƒç”¨å¯¹åº”çš„ API æ–¹æ³•ï¼Œå¦‚ SqlServerï¼š
        //fsql.Insert(cb.Object).ExecuteSqlBulkCopy();
    
        //åœé¡¿5ç§’åå†æ’å…¥ï¼Œè¿™ä¸ªå€¼å¯ä»¥æ ¹æ®éœ€è¦è‡ªå·±è°ƒ
        Thread.CurrentThread.Join(TimeSpan.FromSeconds(5));
    }
    

* * *

ğŸ“¯ åœºæ™¯äºŒï¼šæ‰¹é‡å¯¼å…¥æ–°æ•°æ®
--------------

ä» Excel/CVS æ–‡ä»¶æ‰¹é‡å¯¼å…¥æ–°æ•°æ®ï¼Œç¬¬ä¸€æ­¥éœ€è¦å°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º DataTable/List<T> c# å¯¹è±¡ï¼Œè¿™ä¸€æ­¥ç½‘ä¸Šæœ‰å¾ˆå¤šå·¥å…·ç±»ï¼Œåœ¨æ­¤å°±ä¸è®²è§£äº†ã€‚

> æ­¤åœºæ™¯é€‚åˆå¯¼å…¥çš„æ•°æ®æ˜¯å…¨æ–°çš„ã€ä¸å­˜åœ¨äºç›®æ ‡æ•°æ®åº“è¡¨ï¼Œå‡è®¾æˆ‘ä»¬éƒ½å·²ç»å°† Excel/CVS å†…å®¹è½¬æ¢æˆä¸ºäº† List<T>

* * *

1ã€åˆ©ç”¨æ— å‚æ•°åŒ–æ’å…¥

æ‰¹é‡æ’å…¥åˆ©ç”¨æ— å‚æ•°åŒ–ï¼Œä¼šæ¯”å‚æ•°åŒ–æ•ˆç‡æ›´é«˜ï¼Œæ³¨æ„å‚æ•°åŒ–ä¸SQLæ³¨å…¥æ²¡æœ‰å¿…ç„¶è”ç³»ã€‚

    fsql.Insert(list).NoneParameter().ExecuteAffrows();
    

* * *

2ã€åˆ©ç”¨ BulkCopy æ’å…¥

BulkCopy æ˜¯å¤§æ‰¹é‡æ•°æ®æ’å…¥çš„æœ€ä¼˜æ–¹æ¡ˆï¼Œåªå¯æƒœä¸æ˜¯æ¯ç§æ•°æ®åº“éƒ½æ”¯æŒï¼ŒFreeSql æ”¯æŒäº† SqlServer/Oracle/MySql/PostgreSQL/è¾¾æ¢¦ ç­‰æ•°æ®åº“çš„ BulkCopy APIï¼Œå¦‚æœæ˜¯å…¶ä»–æ•°æ®åº“å»ºè®®ä½¿ç”¨æ— å‚æ•°åŒ–æ’å…¥ã€‚

    fsql.Insert(list).ExecuteSqlBulkCopy(); //SqlServer
    fsql.Insert(list).ExecuteOracleBulkCopy(); //Oracle
    fsql.Insert(list).ExecuteMySqlBulkCopy(); //MySql
    fsql.Insert(list).ExecutePgCopy(); //PostgreSQL
    fsql.Insert(list).ExecuteDmBulkCopy(); //è¾¾æ¢¦
    

ä¸ºä»€ä¹ˆä¸ç»Ÿä¸€ APIï¼Ÿ

ç›®å‰æ¯ç§æ•°æ®åº“é©±åŠ¨çš„ BulkCopy API å‚æ•°ä¸ä¸€è‡´ï¼Œè¿™äº›å‚æ•°å¯ä»¥é’ˆå¯¹æ€§çš„è¿›è¡Œè°ƒä¼˜ã€‚

* * *

ğŸš€ åœºæ™¯ä¸‰ï¼šæ‰¹é‡æ–°å¢æˆ–æ›´æ–°æ•°æ®
----------------

ç›¸æ¯”åœºæ™¯äºŒï¼Œåœºæ™¯ä¸‰ä¼šæ›´éº»çƒ¦ï¼Œå› ä¸ºä¸æ˜¯ç®€å•çš„è¿½åŠ æ•°æ®ï¼Œè¿˜è¦å¤„ç†å†å²æ•°æ®çš„æ›´æ–°ï¼Œç”šè‡³å¯¹å†å²æ•°æ®å­˜åœ¨åˆ™å¿½ç•¥ã€‚æ­£å› ä¸ºå¤æ‚æ‰è¡ç”Ÿå‡ºäº†æ›´å¤šçš„æ–¹æ¡ˆï¼Œæ¯ç§æ–¹æ¡ˆéƒ½æœ‰ä¼˜ç¼ºç‚¹ï¼Œéœ€è¦ä½¿ç”¨è€…æ ¹æ®è‡ªèº«å®é™…æƒ…å†µé€‰æ‹©æœ€é€‚åˆçš„ä¸€ç§æ–¹æ³•ã€‚

åŒä¸Šï¼Œæˆ‘ä»¬å‡è®¾å·²ç»å°† Excel/CVS å†…å®¹è½¬æ¢æˆä¸ºäº† List<T>

* * *

1ã€å†…å­˜å¾ªç¯ list æŸ¥è¯¢åˆ¤æ–­ï¼ˆä¸æ¨èï¼‰

    foreach (var item in list)
    {
        if (fsql.Select<T>(item).Any() == false)
            fsql.Insert(item).ExecuteAffrows();
        else
            fsql.Update<T>().SetSource(item).ExecuteAffrows();
    }
    

è¿™ç§æ–¹å¼å®åœ¨ä¸æ¨èä½œä¸ºæ‰¹é‡æ“ä½œï¼Œæ€§èƒ½éå¸¸ä½ã€‚å…¶å® FreeSql.Repository æä¾›äº†ä¸Šè¿°çš„å°è£…ï¼š

    var repo = fsql.GetRepository<T>();
    foreach (var item in list)
        repo.InsertOrUpdate(item);
    

* * *

2ã€åˆ©ç”¨æ•°æ®åº“ MERGE INTO ç‰¹æ€§

IFreeSql å®šä¹‰äº† InsertOrUpdate æ–¹æ³•å®ç°æ·»åŠ æˆ–ä¿®æ”¹çš„åŠŸèƒ½ï¼Œåˆ©ç”¨æ•°æ®åº“ç‰¹æ€§ï¼š

Database

Features

Database

Features

MySql

on duplicate key update

è¾¾æ¢¦

merge into

PostgreSQL

on conflict do update

äººå¤§é‡‘ä»“

on conflict do update

SqlServer

merge into

ç¥é€š

merge into

Oracle

merge into

å—å¤§é€šç”¨

merge into

Sqlite

replace into

MsAccess

ä¸æ”¯æŒ

Firebird

merge into

    fsql.InsertOrUpdate<T>()
      .SetSource(list) //éœ€è¦æ“ä½œçš„æ•°æ®
      //.IfExistsDoNothing() //å¦‚æœæ•°æ®å­˜åœ¨ï¼Œå•¥äº‹ä¹Ÿä¸å¹²ï¼ˆç›¸å½“äºåªæœ‰ä¸å­˜åœ¨æ•°æ®æ—¶æ‰æ’å…¥ï¼‰
      .ExecuteAffrows();
    
    //æˆ–è€…..
    var sql = fsql.Select<T2, T3>()
      .ToSql((a, b) => new
      {
        id = a.id + 1,
        name = "xxx"
      }, FieldAliasOptions.AsProperty);
    
    fsql.InsertOrUpdate<T>()
      .SetSource(sql)
      .ExecuteAffrows();
    

> fsql.InsertOrUpdateDict æ–¹æ³•å¯é’ˆå¯¹éå®ä½“ç±»æ“ä½œï¼ˆå­—å…¸ç±»å‹ï¼‰

é¢˜å¤–è¯ï¼Œæ˜¯å¦è§è¿‡è¿™ç§ SQLï¼š

    insert into T
    select name, code
    from dual
    where not exists(
       select 1 from T where code = dual.code
    )
    

* * *

3ã€åˆ©ç”¨ BeginEdit æ‰¹é‡ç¼–è¾‘

MERGE INTO æ•°æ®åº“ç‰¹æ€§ï¼Œå…¶å®æ€§èƒ½æ˜¯å¾ˆä½çš„ã€‚800ä¸‡è¡Œè®°å½•å¯¼å…¥7000è¡Œå¤§çº¦7ç§’ï¼Œå„æ•°æ®åº“æ€§èƒ½å·®ä¸å¤šã€‚

BeginEdit æ˜¯ FreeSql ç‰¹è‰²åŠŸèƒ½ä¹‹ä¸€ï¼Œéå¸¸å®ç”¨ï¼Œå¯å®ƒå´æ˜¯å°‘æœ‰è¢«å‘æ˜åˆ°çš„åŠŸèƒ½ã€‚åˆ›æ„æºè‡ªäºåŒ»ç–—è½¯ä»¶ï¼Œæ¯”å¦‚æ“ä½œå‘˜ç¼–è¾‘æ¸…å•ï¼Œä¼šæ–°å¢ï¼Œä¼šåˆ é™¤ï¼Œä¼šä¿®æ”¹ï¼Œç­‰æ“ä½œå®Œåå†ç‚¹ä¿å­˜ã€‚

å…¶å®æˆ‘è¿‡å¾€å¼€å‘çš„é¡¹ç›®ä¹Ÿæœ‰è¿‡ç±»ä¼¼éœ€æ±‚ï¼Œæ¯æ­¥æ“ä½œéƒ½è¿›è¡Œæ•°æ®åº“ä¿å­˜ï¼Œæ²¡ä»€ä¹ˆé—®é¢˜å§ï¼Ÿè®©æˆ‘ä»¬çœ‹ä¸‹æœ€åç»Ÿä¸€ä¿å­˜åº”è¯¥æ€ä¹ˆåšã€‚

    //å°† list è¿”å›ç»™ UI ç«¯æ¸²æŸ“
    var list = fsql.Select<T>().Where(a => a.OrderId == 100).ToList();
    
    
    //ç»Ÿä¸€ä¿å­˜
    
    //æ—§æ•°æ®å¯é€šè¿‡æŸ¥è¯¢ï¼Œæˆ–è€…ç”± UI ç«¯æä¾›
    List<T> oldlist = fsql.Select<T>().Where(a => a.OrderId == 100).ToList();
    //æ–°æ•°æ®ç”± UI ç«¯æä¾›
    List<T> newlist = ...;
    
    var repo = fsql.GetRepository<T>();
    repo.BeginEdit(oldlist); //å¼€å§‹è¿›è¡Œç¼–è¾‘
    repo.EndEdit(newlist); //å¯¹æ¯”æ–°æ—§List
    

BeginEdit/EndEdit åªé’ˆå¯¹ oldlist å¯¹æ¯”ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å…¨è¡¨ã€‚åœ¨å†…å­˜ä¸­å¯¹æ¯”è®¡ç®— Insert/Update/Delete æ¯” MERGE INTO æ€§èƒ½å¿«å¾—å¤šï¼Œåˆ©ç”¨è¯¥åŠŸèƒ½å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°æ‰¹é‡å¯¼å…¥æˆ–æ›´æ–°ï¼Œä¾‹å¦‚é‡å¤å¯¼å…¥ä¸€å¤©çš„æ•°æ®ã€‚

åº”å½“æ³¨æ„å½“å¯¼å…¥çš„æ•°æ®é‡è¿‡å¤§æ—¶ï¼Œåº”è¯¥åˆ†æ‰¹è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¯¹æ¯”å…¨éƒ¨ï¼Œå‡è®¾æˆ‘ä»¬æ¯æ‰¹æ‰§è¡Œ 1000æ¡ï¼š

    //æŸ¥è¯¢æ—§æ•°æ®
    var oldlist = fsql.Select<T>().WhereDynamic(list1000).ToList();
    //ä½¿ç”¨ IN æŸ¥è¯¢æ€§èƒ½å¯èƒ½è¾ƒæ…¢ï¼Œå¯ä»¥æŒ‰æ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼Œå¦‚ä¸‹ï¼š
    //var minTime = list1000.Select(a => a.Time).Min();
    //var maxTime = list1000.Select(a => a.Time).Max();
    //var oldlist = fsql.Select<T>().Where(a=> a.Time.Between(minTime, maxTime)).ToList();
    //åœ¨å†…å­˜äºŒæ¬¡è¿‡æ»¤ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–å°† list1000.Any æ”¹æˆå­—å…¸
    //oldlist = oldlist.Where(a=> !list1000.Any(b => b.Id == a.Id)).ToList();
    
    var repo = fsql.GetRepository<T>();
    //è¢«ç¼–è¾‘çš„æ•°æ®
    repo.BeginEdit(oldlist);
    //å°† list1000 ä¸ oldlist è¿›è¡Œå¯¹æ¯”ï¼Œè®¡ç®—å‡º delete/insert/update è¯­å¥æ‰§è¡Œ
    repo.EndEdit(list1000);
    

EndEdit æœ€å¤šæ‰§è¡Œ 3æ¡ SQLï¼Œä»è€Œå¤§å¤§æå‡äº†å‘½ä»¤å¾€è¿”æ—¶é—´æ¶ˆè€—ã€‚ç‰¹åˆ«é€‚åˆå¯¼å…¥å¤§æ‰¹é‡æ•°æ®ï¼Œä¸”å¤§éƒ¨åˆ†æ•°æ®å·²ç»å­˜åœ¨ï¼Œæˆ–è€…æ•°æ®æœªå‘ç”Ÿå˜æ›´çš„åœºæ™¯ã€‚

* * *

4ã€MySql insert ignore into

å¦‚æœåªæ’å…¥ä¸å­˜çš„çš„æ•°æ®ï¼Œå¹¶ä¸”ä½¿ç”¨ MySql æ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

    fsql.Insert<T>().MySqlIgnoreInto().AppendData(list).NoneParameter().ExecuteAffrows();
    ///INSERT IGNORE INTO `T`(...)
    //VALUES(...),(...),(...)
    

* * *

ğŸŒŒ åœºæ™¯å››ï¼šè·¨æœåŠ¡å™¨ä»Aè¡¨å¯¼æ•°æ®åˆ°Bè¡¨
--------------------

ä¸åœºæ™¯ä¸€ç±»ä¼¼ï¼Œè·¨æœåŠ¡å™¨éœ€è¦å®šä¹‰å¤šä¸ª IFreeSql å¯¹è±¡ï¼Œå‡è®¾ Aè¡¨æ‰€åœ¨æœåŠ¡å™¨è®¿é—®å¯¹è±¡æ˜¯ fsql1ï¼ŒBè¡¨ä½¿ç”¨ fsql2

* * *

1ã€åˆ†æ®µæ’å…¥

    fsql2.Select<B>()
        .Where(b => b.Time > DateTime.Parse("2022-08-01"))
        .ToChunk(b => new A { field1 = b.Name, field2 = b.Code }, 1000, cb => {
            fsql1.Insert(cb.Object).NoneParameter().ExecuteAffrows();
            //å¦‚æœæ•°æ®åº“æ”¯æŒ BulkCopy å¯ä»¥è°ƒç”¨å¯¹åº”çš„ API æ–¹æ³•ï¼Œå¦‚ SqlServerï¼š
            //fsql1.Insert(cb.Object).ExecuteSqlBulkCopy();
    
            //è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ BeginEdit è¿›è¡Œæ‰¹é‡ç¼–è¾‘åŠŸèƒ½ï¼Œè§£å†³æ•°æ®é‡å¤é—®é¢˜
        });
    

* * *

2ã€åˆ†é¡µæ’å…¥

åˆ©ç”¨åˆ†é¡µå¤šæ¬¡è¯»å–ï¼Œåˆ†é¡µå¯èƒ½é€ æˆæ–°æ—§æ•°æ®é—®é¢˜ï¼Œå°½é‡è®¾ç½®å¥½åˆ†é¡µæ’åºå¹¶è®°å½•å¥½åç§»é‡ï¼Œç¡®ä¿é‡å¤é—®é¢˜ã€‚ï¼ˆä¸æ¨èï¼‰

    var pageNumber = 1;
    while (true)
    {
        var list = fsql2.Select<B>()
            .Where(b => b.Time > DateTime.Parse("2022-08-01"))
            .Page(pageNumber++, 1000)
            .OrderBy(b => b.Time)
            .ToList(b => new A { field1 = b.Name, field2 = b.Code }, 1000);
        if (list.Count == 0) break;
    
        fsql1.Insert(cb.Object).NoneParameter().ExecuteAffrows();
        //å¦‚æœæ•°æ®åº“æ”¯æŒ BulkCopy å¯ä»¥è°ƒç”¨å¯¹åº”çš„ API æ–¹æ³•ï¼Œå¦‚ SqlServerï¼š
        //fsql1.Insert(cb.Object).ExecuteSqlBulkCopy();
    
        //è¿™é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ BeginEdit è¿›è¡Œæ‰¹é‡ç¼–è¾‘åŠŸèƒ½ï¼Œè§£å†³æ•°æ®é‡å¤é—®é¢˜
    
        //åœé¡¿5ç§’åå†æ’å…¥ï¼Œè¿™ä¸ªå€¼å¯ä»¥æ ¹æ®éœ€è¦è‡ªå·±è°ƒ
        Thread.CurrentThread.Join(TimeSpan.FromSeconds(5));
    }
    

* * *

â›³ ç»“æŸè¯­
-----

FreeSql çš„åŠŸèƒ½å¼ºå¤§ï¼Œä»¥åŠç¨³å®šæ€§ï¼Œæˆ‘ä¸æƒ³å¹ç‰›ï¼Œä¹Ÿä¸å–œæ¬¢å¹ç‰›ï¼Œå¦‚æœå¤§å®¶æœ‰ä»€ä¹ˆå¥½çš„æƒ³æ³•å¯ä»¥ä¸€èµ·è®¨è®ºï¼Œæ¯•ç«Ÿæˆ‘ä»¬åªèƒ½é‡åˆ°æœ‰é™çš„åœºæ™¯ï¼Œè¿˜æœ‰å¾ˆå¤šæˆ‘ä¸çŸ¥é“çš„åœºæ™¯éœ€æ±‚ä¸æ˜¯å—ï¼Ÿ

å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©å¤§å®¶è½»æ¾ç†è§£å¹¶ç†Ÿç»ƒæŒæ¡å®ƒï¼Œå¿«é€Ÿè§£å†³å·¥ä½œä¸­é‡åˆ°çš„æ•°æ®å¯¼å…¥é—®é¢˜ï¼Œä¸ºä¼ä¸šçš„é¡¹ç›®ç ”å‘è´¡çŒ®åŠ›é‡ã€‚

å¼€æºåœ°å€ï¼š[https://github.com/dotnetcore/FreeSql](https://github.com/dotnetcore/FreeSql)

* * *

ä½œè€…æ˜¯ä»€ä¹ˆäººï¼Ÿ

ä½œè€…æ˜¯ä¸€ä¸ªå…¥è¡Œ 18å¹´çš„è€æ‰¹ï¼Œä»–ç›®å‰å†™çš„.net å¼€æºé¡¹ç›®æœ‰ï¼š

å¼€æºé¡¹ç›®

æè¿°

å¼€æºåœ°å€

å¼€æºåè®®

FreeIM

èŠå¤©ç³»ç»Ÿæ¶æ„

[https://github.com/2881099/FreeIM](https://github.com/2881099/FreeIM)

MIT

FreeRedis

Redis SDK

[https://github.com/2881099/FreeRedis](https://github.com/2881099/FreeRedis)

MIT

csredis

[https://github.com/2881099/csredis](https://github.com/2881099/csredis)

MIT

FightLandlord

æ–—DIä¸»ç½‘ç»œç‰ˆ

[https://github.com/2881099/FightLandlord](https://github.com/2881099/FightLandlord)

å­¦ä¹ ç”¨é€”

FreeScheduler

å®šæ—¶ä»»åŠ¡

[https://github.com/2881099/FreeScheduler](https://github.com/2881099/FreeScheduler)

MIT

IdleBus

ç©ºé—²å®¹å™¨

[https://github.com/2881099/IdleBus](https://github.com/2881099/IdleBus)

MIT

FreeSql

ORM

[https://github.com/dotnetcore/FreeSql](https://github.com/dotnetcore/FreeSql)

MIT

FreeSql.Cloud

åˆ†å¸ƒå¼tcc/saga

[https://github.com/2881099/FreeSql.Cloud](https://github.com/2881099/FreeSql.Cloud)

MIT

FreeSql.AdminLTE

ä½ä»£ç åå°ç”Ÿæˆ

[https://github.com/2881099/FreeSql.AdminLTE](https://github.com/2881099/FreeSql.AdminLTE)

MIT

FreeSql.DynamicProxy

åŠ¨æ€ä»£ç†

[https://github.com/2881099/FreeSql.DynamicProxy](https://github.com/2881099/FreeSql.DynamicProxy)

å­¦ä¹ ç”¨é€”

éœ€è¦çš„è¯·æ‹¿èµ°ï¼Œè¿™äº›éƒ½æ˜¯æœ€è¿‘å‡ å¹´çš„å¼€æºä½œå“ï¼Œä»¥å‰æ›´æ—©å†™çš„å°±ä¸å‘äº†ã€‚