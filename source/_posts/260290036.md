---
layout: post
title: "Jmeter-记一次自动化造数引发的BeanShell写入excel实例"
date: "2022-07-22T17:27:38.417Z"
---
Jmeter-记一次自动化造数引发的BeanShell写入excel实例
====================================

一、前言
====

　　最近工作和生活说忙也忙，说不忙也不忙，但就是已经感觉很长时间没有get新的技术技能了，就是一丢丢的那种也没有，哈哈哈，今天就来讲一下最近get到的小技能吧。

　　工作中，由于某个需求需要几百条数据去验证某个接口，肯定不能手动加啦，基于测试周期紧张，直接考虑用jmeter的循环控制器辅助实现。

二、接口背景介绍
========

　　业务说明：点击创建按钮，弹出创建界面，输入必填项后，点击确定，返回创建数据成功。

1、创建接口
------

　　就是需要用该接口创建数据，对于接口的说明如下：

　　1）接口请求方法：PUT

　　2）必传的入参需要变量的字段有：userCode，userId，userName，remarkid 

　　3）其余字段根据实际业务，可以传固定值

思路tip：首先要确认变量字段，其次确认变量字段来源，最后确认如何能获取到变量。当前的实例中，除了remarkid，其余3个变量字段是从另外一个查询接口读取的，详细见第2点。

2、查询用户接口
--------

　　在创建界面，输入用户名称时会调用【查询用户】接口，该接口返回的数据就是【创建】接口中所需要的入参字段，返回的json格式如下：

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722151222526-1014326463.png)

三、Loop Controller介绍
===================

　　很早之前就已经在工作上用到过这个组件，今天突然发现我居然没有针对这个组件写详细的博客，太尴尬了，那现在就简单了解下这个组件的用法吧。

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722154636995-1690336168.png)

 　　Loop Count：循环次数，分为永远、自定义次数——勾选Forever后，自定义次数置灰不允许输入，未勾选，则可以

　　按字面意思，其实它就是循环该控制器下的请求，一般跟计数器配合使用，具体根据实际场景来。

　　如果非常熟悉Jmeter工具的，想必也知道线程组也可以设置循环次数，这两者其实可以理解为父子关系，比如循环控制器设置循环2次，线程组设置循环4次，则执行的结果如下：  线程一共循环运行了4轮，每轮会循环请求接口2次

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722155203074-1250533018.png)

四、方法1— Loop Controller循环调用接口
============================

 1、脚本结构如下
---------

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722163903316-718070261.png)

2、使用强大的JSON提取器，提取返回的字段
----------------------

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722160602894-584081969.png)

3、用户查询接口返回结果如下
--------------

　　在察看结果树的Debug中可以看到提取的userCode，userId，userName，其中userCode\_matchNr表示匹配到的总数

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722161856664-908064365.png)
------------------------------------------------------------------------------------------

 4、创建接口入参使用变量值
--------------

　　查询接口是提取了返回字段的所有值，要引用变量的写法就相当于 ${userCode\_1}，那总不能在入参里写死\_1吧，因为要循环创建的，得想办法让userCode\_x，后面的\_x是可以每次自增的，所以要结合counter计数器函数。

　　而\_\_V就是要把它们嵌套起来，\_\_V属于嵌套函数，有兴趣可以网上百度，如果不懂的话直接复制那串改一下变量就行。

　　remarkid在业务上是不允许重复的，所以这里使用Random函数，即随机数函数，让它随机生成一串数字即可。

"userCode":"${\_\_V(userCode\_${\_\_counter(\\,)},)}","userName":"${\_\_V(username\_${\_\_counter(\\,)},)}","userId":"${\_\_V(userId\_${\_\_counter(\\,)},)}","remarkid":"${\_\_Random(1000,9000,)}"

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722161123803-1970881670.png)
-------------------------------------------------------------------------------------------

5、循环控制器循环次数使用变量值
----------------

　　循环控制器中的自定义次数考虑到灵活性，使用查询接口匹配到的总数（变量\_matchNr），一共提取3个字段，所以用其中任意字段都行，引用格式： ${username\_matchNr}

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722161618491-2074016290.png)

6、执行
----

　　完成以上步骤，就可以执行创建数据啦，执行结果我就不贴了。

五、方法2—Loop Controller循环调用JDBC
=============================

　　跟方法1的步骤是一样的，只是方法2是通过调用jdbc request，即sql循环插入数据，这里就不贴图啦，具体看脚本结构，然后在jdbc里写条insert语句，将相应字段替换成引用变量即可。

　　注：执行insert，Query Type需要选择【Prepared Update Statement】

六、方法3—BeanShell写入excel，手动生成sql语句
================================

1、BeanShell PostProcessor
-------------------------

　　这种其实也是通过sql插入，只不过是手动插入，在用户查询请求下添加BeanShell PostProcessor，脚本如下：

//指定需要写入到哪个文件
FileWriter fs=new FileWriter("C:/Users/13710/Desktop/9000.csv",true);
//创建一个字符缓存输出流
BufferedWriter out = new BufferedWriter(fs);

//另一种获取变量值的写法
//int b = Integer.valueOf("${username\_matchNr}");
//System.out.println("接口返回的总数为："+b);

for(int i=1;i<= ${username\_matchNr};i++){
    username\= vars.get("username\_"+i);
    userId \= vars.get("userId\_"+i);
    userCode \= vars.get("userCode\_"+i);
    out.write(username+","+userCode+","+userId);
    out.write(System.getProperty("line.separator"));
    System.out.println("输出的值是："+username);
    }

out.close();
fs.close();

2、执行后自动生成.csv文件
---------------

　　可以看到excel里有3列，因为beanshell脚本拿到3个变量字段写到了excel里了

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722171005932-37168668.png)

 3、运用强大的excel功能生成sql语句
----------------------

　　D4列是自己先写一条sql哈，写好后往下拖动就会自动生成其他的，其中需要变的均引用表格变量，格式："&A1&"

温馨tip：如果公式中的字符串过长，要用CONCATENATE函数

例子1（这个没超的）：   =CONCATENATE("INSERT INTO contact(name, post,id)VALUES ("&A1&", '"&B1&","&C1&"');")

例子2（分成了4个字符串，因为公式中每一个字符串都不能超过255字符）：

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722172212517-461467707.png)

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722170944212-1598337576.png)

 4、将D4列直接复制到数据库里执行即可
--------------------

![](https://img2022.cnblogs.com/blog/715975/202207/715975-20220722171316832-692696000.png)