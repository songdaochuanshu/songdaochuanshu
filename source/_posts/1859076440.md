---
layout: post
title: "CAP 6.1 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š"
date: "2022-06-10T10:20:20.258Z"
---
CAP 6.1 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š
==============

### å‰è¨€

ä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´å®£å¸ƒ CAP å‘å¸ƒ 6.1 ç‰ˆæœ¬æ­£å¼ç‰ˆï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸»è¦é’ˆå¯¹ç›®å‰å·²ç»å‘ç°çš„å‡ ä¸ªBUGè¿›è¡Œäº†ä¿®å¤äº†ä»¥åŠæ·»åŠ äº†ä¸€äº›å°ç‰¹æ€§ã€‚

é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹å§ã€‚

### æ€»è§ˆ

å¯èƒ½æœ‰äº›äººè¿˜ä¸çŸ¥é“ CAP æ˜¯ä»€ä¹ˆï¼Œè€è§„çŸ©æ¥ä¸€ä¸ªç®€ä»‹ã€‚

[CAP](https://github.com/dotnetcore/CAP) æ˜¯ä¸€ä¸ªç”¨æ¥è§£å†³å¾®æœåŠ¡æˆ–è€…åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ä¸€ä¸ªå¼€æºé¡¹ç›®è§£å†³æ–¹æ¡ˆï¼ˆ[https://github.com/dotnetcore/CAP](https://github.com/dotnetcore/CAP)ï¼‰åŒæ ·å¯ä»¥ç”¨æ¥ä½œä¸º EventBus ä½¿ç”¨ï¼Œè¯¥é¡¹ç›®è¯ç”Ÿäº2016å¹´ï¼Œç›®å‰åœ¨ Github å·²ç»æœ‰è¶…è¿‡ 5500+ Star å’Œ 70+ è´¡çŒ®è€…ï¼Œä»¥åŠåœ¨ NuGetè¶… 250 ä¸‡çš„ä¸‹è½½é‡ï¼Œå¹¶åœ¨è¶Šæ¥è¶Šå¤šå…¬å¸çš„å’Œé¡¹ç›®ä¸­å¾—åˆ°åº”ç”¨ã€‚

å¦‚æœä½ æƒ³å¯¹ CAP æ›´å¤šäº†è§£ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [å®˜æ–¹æ–‡æ¡£](http://cap.dotnetcore.xyz)ã€‚

æœ¬æ¬¡åœ¨ CAP 6.1 ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸»è¦å¸¦æ¥äº†ä»¥ä¸‹æ–°ç‰¹æ€§ï¼š

*   ä¼˜åŒ–é›ªèŠ±ç®—æ³•
*   Dashboard æ”¯æŒè‡ªå®šä¹‰ Authorization Policy
*   Azure Service Bus æ·»åŠ å¯¹å»¶è¿Ÿæ¶ˆæ¯çš„æ”¯æŒ
*   æ”¯æŒé…ç½®å¤±è´¥æ¶ˆæ¯è¿‡æœŸåˆ é™¤æ—¶é—´
*   BUG ä¿®å¤
    *   ä¿®å¤ Dashbaord å¯ç”¨ Challenge éªŒè¯é¡ºåºé—®é¢˜
    *   ä¿®å¤ RabbitMQ åœ¨ç½‘ç»œæŠ–åŠ¨æ—¶å¶å‘å¥åº·æ£€æŸ¥é”™è¯¯çš„é—®é¢˜
    *   ä¿®å¤ MySQL 8.0 é‡è¯•æŸ¥è¯¢æ—¶ SQLæ—¥æœŸæ ¼å¼é”™è¯¯çš„é—®é¢˜
    *   ä¿®å¤ Redis Streams è¯»å–æˆ–åˆ›å»ºæµæ—¶å¹‚ç­‰æ£€æŸ¥çš„é—®é¢˜

### ä¼˜åŒ–é›ªèŠ±ç®—æ³•

åœ¨è¿‡å»æˆ‘ä»¬ä½¿ç”¨æ ‡å‡†ç‰ˆé›ªèŠ±ç®—æ³•ï¼Œä¼šå‡ºç°æ—¶é’Ÿæ•æ„Ÿé—®é¢˜ã€‚

å› ä¸ºIDç”Ÿæˆæ€»æ˜¯å’Œå½“å‰æ“ä½œç³»ç»Ÿçš„æ—¶é—´æˆ³ç»‘å®šçš„ï¼ˆåˆ©ç”¨äº†æ—¶é—´çš„å•è°ƒé€’å¢æ€§ï¼‰ï¼‰ï¼Œå› æ­¤è‹¥æ“ä½œç³»ç»Ÿçš„æ—¶é’Ÿå‡ºç°å›æ‹¨ï¼Œç”Ÿæˆçš„IDå°±ä¼šé‡å¤ï¼Œä¸€èˆ¬ä¸ä¼šäººä¸ºåœ°å»å›æ‹¨æ—¶é’Ÿï¼Œä½†æœåŠ¡å™¨ä¼šæœ‰å¶å‘çš„"æ—¶é’Ÿæ¼‚ç§»"ç°è±¡ã€‚ ä¹Ÿå°±æ˜¯è¯´åœ¨å¤šèŠ‚ç‚¹éƒ¨ç½²æ—¶ï¼Œå¦‚æœæŸäº›æœåŠ¡å™¨æ—¶é—´ä¸å‡†ç¡®ä¼šå¯¼è‡´é‡å¤é”®ç”Ÿæˆè€Œå¯¼è‡´å†™å…¥æ¶ˆæ¯åˆ°æ•°æ®åº“æ—¶æŠ¥é”™ã€‚

åœ¨æœ¬ç‰ˆæœ¬ä¸­ï¼Œè§£é™¤ä¸æ“ä½œç³»ç»Ÿæ—¶é—´æˆ³çš„æ—¶åˆ»ç»‘å®šï¼Œç”Ÿæˆå™¨åªåœ¨åˆå§‹åŒ–æ—¶è·å–äº†ç³»ç»Ÿå½“å‰çš„æ—¶é—´æˆ³ï¼Œä½œä¸ºåˆå§‹æ—¶é—´æˆ³ï¼Œ ä½†ä¹‹åå°±ä¸å†ä¸ç³»ç»Ÿæ—¶é—´æˆ³ä¿æŒåŒæ­¥äº†ã€‚å®ƒä¹‹åçš„é€’å¢ï¼Œåªç”±åºåˆ—å·çš„é€’å¢æ¥é©±åŠ¨ã€‚æ¯”å¦‚åºåˆ—å·å½“å‰å€¼æ˜¯4095ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚è¿›æ¥ï¼Œ åºåˆ—å·+1æº¢å‡º12ä½ç©ºé—´ï¼Œåºåˆ—å·é‡æ–°å½’é›¶ï¼Œè€Œæº¢å‡ºçš„è¿›ä½åˆ™åŠ åˆ°æ—¶é—´æˆ³ä¸Šï¼Œä»è€Œè®©æ—¶é—´æˆ³+1ã€‚

åœ¨æ­¤ç‰ˆæœ¬æ›´æ–°åï¼Œç”Ÿæˆçš„Idå¯èƒ½ä¼šå‡ºç°å’Œä¹‹å‰ç‰ˆæœ¬å‡ºç°è¾ƒå¤§å·®å€¼ï¼Œå¤§å®¶æ³¨æ„ä¸‹å°±è¡Œï¼Œæ²¡å•¥å½±å“ã€‚

æ„Ÿè°¢ [@Allen-dududu](https://github.com/Allen-dududu) å¯¹æ­¤æäº¤çš„PRï¼

### Dashboard æ”¯æŒè‡ªå®šä¹‰ Authorization Policy

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬çš„Dashboard é…ç½®é¡¹ä¸­æ–°å¢äº†ä¸€ä¸ªåä¸º `AuthorizationPolicy` çš„é…ç½®é¡¹ï¼Œç”¨äºæƒ³è¦åœ¨æˆæƒè¿‡ç¨‹ä¸­ä½¿ç”¨ä¾‹å¦‚åŸºäºè§’è‰²çš„æˆæƒéªŒè¯ç­‰åœºæ™¯ã€‚

ç”¨æ³•å¦‚ä¸‹ï¼Œä¸»è¦æ˜¯æœ‰æ³¨é‡Šçš„éƒ¨åˆ†ã€‚

    services.AddAuthorization((options =>
    {
       // only if you want to apply role filter to CAP Dashboard user 
       options.AddPolicy("PolicyCap", policy => policy.RequireRole("admin.events"));
    }))
    .AddAuthentication(options =>
    {
       options.DefaultScheme =  CookieAuthenticationDefaults.AuthenticationScheme;
       options.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
    })
    .AddCookie()
    .AddOpenIdConnect(options =>
    {
       options.Authority = "https://demo.identityserver.io/";
       options.ClientId = "interactive.confidential";
       options.ClientSecret = "secret";
       options.ResponseType = "code";
       options.UsePkce = true;
    
       options.Scope.Clear();
       options.Scope.Add("openid");
       options.Scope.Add("profile");
    });
    
    services.AddCap(cap =>
    {
        cap.UseDashboard(d =>
        {
            d.UseChallengeOnAuth = true;
            d.DefaultChallengeScheme = OpenIdConnectDefaults.AuthenticationScheme;
            d.UseAuth = true;
            // only if you want to apply policy authorization filter to CAP Dashboard user
            d.AuthorizationPolicy = "PolicyCap";
        });
        // ***
    }
    

æ„Ÿè°¢ [@albertopm19](https://github.com/albertopm19) å¯¹æ­¤æäº¤çš„PRï¼

### Azure Service Bus æ·»åŠ å¯¹å»¶è¿Ÿæ¶ˆæ¯çš„æ”¯æŒ

åœ¨ Azure Service Bus ä¸­åŸç”Ÿæä¾›äº†å¯¹å»¶è¿Ÿå‘é€æ¶ˆæ¯çš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨å…¶ ScheduledEnqueueTimeUtc å±æ€§è®¾ç½®ã€‚åœ¨æœ¬ç‰ˆæœ¬ä¸­é€šè¿‡ CAP åœ¨å‘é€è¿‡ç¨‹ä¸­æŒ‡å®šå¤´æ¶ˆæ¯ä»¥åˆ©ç”¨æ­¤ç‰¹æ€§ã€‚

ç¤ºä¾‹å¦‚ä¸‹ï¼š

    [HttpPost("publish")]
    public async Task Publish()
    {
        await _publisher.PublishAsync("demo-publish", string.Empty, new Dictionary<string, string?>
        {
            [AzureServiceBusHeaders.ScheduledEnqueueTimeUtc] = DateTimeOffset.UtcNow.AddSeconds(60).ToString(),
        });
    }
    
    

æ„Ÿè°¢ [@webinex](https://github.com/webinex) å¯¹æ­¤æäº¤çš„PRï¼

é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œæœ‰ä¸€äº›åŒå­¦ä¹‹å‰ä¹Ÿæèµ·äº†åœ¨ RabbitMQ ä¸­å¯¹å»¶è¿Ÿæ¶ˆæ¯çš„æ”¯æŒï¼Œæˆ‘ä»¬ä¸€è‡´æ²¡æœ‰å¯¹å…¶è¿›è¡Œæ”¯æŒï¼Œä¸€æ˜¯å› ä¸ºéœ€è¦å®ƒé…ç½®æ’ä»¶æ‰å¯ä»¥ä¸æ˜¯åŸç”Ÿæ”¯æŒï¼ŒäºŒæ˜¯è¿˜æ˜¯å¸Œæœ›å¤§å®¶èƒ½ä½¿ç”¨è°ƒåº¦å™¨ï¼ˆQuartzï¼ŒHangfireï¼‰ç­‰æ¥åšè¿™ä»¶äº‹æƒ…ï¼Œä¸“ä¸šçš„äº‹æƒ…äº¤ç»™ä¸“ä¸šçš„ç»„ä»¶åšã€‚

### æ”¯æŒé…ç½®å¤±è´¥æ¶ˆæ¯è¿‡æœŸåˆ é™¤æ—¶é—´

æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªé…ç½®é¡¹ `FailedMessageExpiredAfter` ç”¨äºé…ç½®å¤±è´¥çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œåˆ°è¾¾è¿‡æœŸæ—¶é—´åï¼Œæ¶ˆæ¯ä¼šè¢«åˆ é™¤ã€‚ä¹‹å‰è¿™ä¸ªæ˜¯å†™æ­»çš„å€¼ 15 å¤©ï¼Œç°åœ¨ä½ å¯ä»¥åˆ©ç”¨æ­¤é…ç½®é¡¹è¿›è¡Œé…ç½®ã€‚

æ„Ÿè°¢ [@dima-zhemkov](https://github.com/dima-zhemkov) å¯¹æ­¤æäº¤çš„PRï¼

### BUG ä¿®å¤

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä¸€äº›å·²å‘ç°çš„BUGä¿®å¤ï¼Œä¸‹é¢æ˜¯ä¿®å¤çš„å†…å®¹é¡¹ã€‚

*   ä¿®å¤ Dashbaord å¯ç”¨ Challenge éªŒè¯é¡ºåºé—®é¢˜ã€‚
*   ä¿®å¤ RabbitMQ åœ¨ç½‘ç»œæŠ–åŠ¨æ—¶å¶å‘å¥åº·æ£€æŸ¥é”™è¯¯çš„é—®é¢˜ã€‚
*   ä¿®å¤ MySQL 8.0 é‡è¯•æŸ¥è¯¢æ—¶ SQLæ—¥æœŸæ ¼å¼é”™è¯¯çš„é—®é¢˜
*   ä¿®å¤ Redis Streams è¯»å–æˆ–åˆ›å»ºæµæ—¶å¹‚ç­‰æ£€æŸ¥çš„é—®é¢˜

### æ€»ç»“

ä»¥ä¸Šï¼Œå°±æ˜¯æœ¬ç‰ˆæœ¬æˆ‘ä»¬åšå‡ºçš„ä¸€äº›æ”¯æŒå’Œæ”¹åŠ¨ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒï¼Œæˆ‘ä»¬å¾ˆå¼€å¿ƒèƒ½å¤Ÿå¸®åŠ©åˆ°å¤§å®¶ ã€‚å¤§å®¶åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜å¸Œæœ›ä¹Ÿèƒ½å¤Ÿç§¯æçš„åé¦ˆï¼Œå¸®åŠ©CAPå˜å¾—è¶Šæ¥è¶Šå¥½ã€‚ğŸ˜ƒ

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªé¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è¿æ¥ç‚¹å‡» Star ç»™æˆ‘ä»¬æ”¯æŒã€‚

[![GitHub stars](https://img.shields.io/github/stars/dotnetcore/CAP.svg?label=github-cap-stars)](https://github.com/dotnetcore/CAP/stargazers)

å¦‚æœä½ è§‰å¾—æœ¬ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©çš„è¯ï¼Œæ„Ÿè°¢æ‚¨çš„ã€æ¨èã€‘ã€‚

* * *

> æœ¬æ–‡åœ°å€ï¼š[http://www.cnblogs.com/savorboard/p/cap-6-1.html](http://www.cnblogs.com/savorboard/p/cap-6-1.html)  
> ä½œè€…åšå®¢ï¼š[Savorboard](http://www.cnblogs.com/savorboard)  
> æœ¬æ–‡åŸåˆ›æˆæƒä¸ºï¼šç½²å - éå•†ä¸šæ€§ä½¿ç”¨ - ç¦æ­¢æ¼”ç»ï¼Œåè®®[æ™®é€šæ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/) | åè®®[æ³•å¾‹æ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode)