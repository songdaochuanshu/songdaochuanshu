---
layout: post
title: "ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯***å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜"
date: "2022-05-30T15:22:23.002Z"
---
ï¼ˆåäºŒï¼‰.NET6 + React ï¼šå‡çº§ï¼å‡çº§ï¼è¿˜æ˜¯\*\*\*å‡çº§ï¼ï¼ï¼+ IdentityServer4å®æˆ˜
=========================================================

.NET5å‡çº§.NET6 Ant Design Pro V5 IdentityServer4å®æˆ˜ å‰åç«¯åˆ†ç¦» oidc-client-ts .NET6éƒ¨ç½²Linuxäº‘æœåŠ¡ åŸŸå

ä¸€ã€å‰è¨€
----

**æ­¤ç¯‡å†…å®¹è¾ƒå¤šï¼Œæˆ‘æ˜¯ä¸€æ­¥ä¸€ä¸ªè„šå°(å‘)ï¼Œä»¥è‡³äºå†™äº†å¥½ä¹…ï¼Œä¸»è¦æ˜¯è¿™å‡ éƒ¨åˆ†ï¼šåå°å‡çº§ [.NET6](https://dotnet.microsoft.com/zh-cn/download)Â Â [VS2022](https://visualstudio.microsoft.com/zh-hans/downloads/)ã€å‰å°å‡çº§[Ant Design Pro V5](https://pro.ant.design/zh-CN/) ã€å‰åå°è”è°ƒ IdentityServer4 å®æˆ˜ï¼Œä»¥åŠå„éƒ¨åˆ†åœ¨Linuxç¯å¢ƒä¸‹éƒ¨ç½²ç­‰ç­‰ã€‚**

äºŒã€åå°å‡çº§.NET6
-----------

**WebApiå’Œç±»åº“éƒ½å‡çº§åˆ°.NET6ï¼Œä¾èµ–åŒ…éƒ½å‡çº§åˆ°6.0ä»¥ä¸Šæœ€æ–°ï¼Œå¥½åƒæ²¡ä»€ä¹ˆæ„ŸçŸ¥ï¼Œç•¥æ„Ÿeasyã€‚ï¼ˆé™„ä¸€å¼ å†™å®Œåæœ€æ–°çš„é¡¹ç›®ç»“æ„å›¾ï¼‰**  
![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422101400332-1039947071.png)![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220422100156239-58634689.png)![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530121416228-147030239.png)

ä¸‰ã€IdentityServer4å®æˆ˜
-------------------

#### 1ã€ç”¨æˆ·ç®¡ç†

**è¿˜å¥½[ä¸Šç¯‡æŒä¹…åŒ–](https://www.cnblogs.com/WinterSir/p/16087298.html)å·²ç»åšäº†90%çš„å·¥ä½œï¼Œä¸è¿‡æ˜¯åœ¨[Demo](https://github.com/WinterSir/IdentityServer4.GrantTypesDemo)é‡Œé¢ï¼Œç°åœ¨æ¬åˆ°ä¸»é¡¹ç›®é‡Œæ¥ï¼Œç”¨æˆ·éƒ¨åˆ†ã€å®¢æˆ·ç«¯é…ç½®éƒ¨åˆ†æ ¹æ®å®é™…æƒ…å†µç¨åŠ æ”¹åŠ¨ã€‚**

> è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œç”¨æˆ·ã€è§’è‰²ç®¡ç†è¿™å—å¯ä»¥ç”¨Identityè¿›è¡Œç®¡ç†ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ç³»ç»Ÿé‡Œç®¡ç†ï¼Œid4åªåšç™»å½•é‰´æƒï¼Œè¿™é‡Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼ŒApplicationUserç»§æ‰¿IdentityUserï¼Œå®šä¹‰å­—æ®µUserInfoIdå…³è”UserInfoè¡¨ï¼Œå…·ä½“éœ€æ±‚æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µæ¥è®¾è®¡ã€‚

![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220423135935026-1500801190.png)![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528164047845-1795345249.png)![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220423162459503-1228161340.png)

#### 2ã€é…ç½®ä¿®æ”¹

**ç®€åŒ–ã€æˆæƒç æ˜¯ç»™Reactå‰ç«¯ç”¨çš„ï¼Œæ··åˆæ¨¡å¼ç»™ Mvc å®¢æˆ·ç«¯ç”¨çš„ï¼ˆä¸€ä¸ªç©º.NET6 Mvcé¡¹ç›®ï¼Œä¹Ÿæ¬åˆ°ä¸»é¡¹ç›®äº†ï¼Œå…·ä½“çš„å¯ä»¥çœ‹ä»£ç ï¼‰**  
![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528211459000-1170320134.png)

#### 3ã€æ•°æ®è¿ç§»

**ä¾æ¬¡åœ¨ç¨‹åºåŒ…ç®¡ç†å™¨æ§åˆ¶å°è¾“å…¥è¿ç§»å‘½ä»¤ï¼Œå…¶ä»–è¡¨ç»“æ„æ•°æ®ç›¸åŒå°±ä¸è´´äº†ï¼Œ[ä¸Šç¯‡æŒä¹…åŒ–](https://www.cnblogs.com/WinterSir/p/16087298.html)è¿‡ç¨‹éƒ½æœ‰è¯¦ç»†æ­¥éª¤å’Œç»“æœã€‚**  
![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528164605841-112275738.png)

å››ã€å‰å°å‡çº§ Ant Design Pro V5
------------------------

**å‰å°å‡çº§ Ant Design Pro V5ï¼Œ[ä¹‹å‰](https://www.cnblogs.com/WinterSir/p/13979030.html)ç”¨çš„æ˜¯V5é¢„è§ˆç‰ˆï¼Œå·²ç»æ˜¯ä¸€å¹´å‰çš„äº‹æƒ…äº†ã€‚ã€‚ã€‚æˆ‘åæ€ã€‚ã€‚ã€‚ğŸ˜…**

#### 1ã€å®‰è£…ç»„ä»¶ oidc-client

**cnpm install [oidc-client](https://github.com/IdentityModel/oidc-client-js) --saveï¼Œæ–°å»ºè®¤è¯æœåŠ¡ç±» auth.ts ï¼Œè·Ÿåå° IdentityServer4 è®¤è¯æœåŠ¡é…åˆä½¿ç”¨ã€‚**

    import { Log, User, UserManager } from 'oidc-client';
    
    export class AuthService {
        public userManager: UserManager;
        constructor() {
            // const clientRoot = 'http://localhost:8000/';
            const clientRoot = 'https://homejok.wintersir.com/';        
            const settings = {
                authority: 'https://login.wintersir.com',
                //client_id: 'antdview',
                //response_type: 'id_token token',
                client_id: 'antdviewcode',
                client_secret: 'antdviewcode',
                response_type: 'code',
                redirect_uri: `${clientRoot}callback`,
                post_logout_redirect_uri: `${clientRoot}`,
                // silent_redirect_uri: `${clientRoot}silent-renew.html`,
                scope: 'openid profile HomeJokScope'
            };
            this.userManager = new UserManager(settings);
    
            Log.logger = console;
            Log.level = Log.WARN;
        }
    
        public login(): Promise<void> {
            //è®°å½•è·³è½¬ç™»å½•å‰çš„è·¯ç”±
            return this.userManager.signinRedirect({ state: window.location.href });
        }
    
        public signinRedirectCallback(): Promise<User> {
            return this.userManager.signinRedirectCallback();
        }
    
        public logout(): Promise<void> {
            return this.userManager.signoutRedirect();
        }
    
        public getUser(): Promise<User | null> {
            return this.userManager.getUser();
        }
    
        public renewToken(): Promise<User> {
            return this.userManager.signinSilent();
        }
    }
    

#### 2ã€ç™»å½•è®¤è¯è®¾ç½®

**ä¿®æ”¹app.tsxï¼Œåˆå§‹åŒ–è®¤è¯æœåŠ¡ç±»ï¼Œåˆ¤æ–­ç™»å½•çŠ¶æ€ï¼Œè®¾ç½®è¯·æ±‚åå°æ‹¦æˆªå™¨ï¼Œæ·»åŠ  headers å’Œ token**

    import type { Settings as LayoutSettings } from '@ant-design/pro-layout';
    import { PageLoading } from '@/components/PageLoading';
    import type { RequestConfig, RunTimeLayoutConfig } from 'umi';
    import { history, Link } from 'umi';
    import RightContent from '@/components/RightContent';
    import { BookOutlined, LinkOutlined } from '@ant-design/icons';
    import { AuthService } from '@/utils/auth';
    
    const isDev = process.env.NODE_ENV === 'development';
    
    const authService: AuthService = new AuthService();
    
    /** è·å–ç”¨æˆ·ä¿¡æ¯æ¯”è¾ƒæ…¢çš„æ—¶å€™ä¼šå±•ç¤ºä¸€ä¸ª loading */
    export const initialStateConfig = {
        loading: <PageLoading />
    };
    
    /**
     * @see  https://umijs.org/zh-CN/plugins/plugin-initial-state
     * */
    export async function getInitialState(): Promise<{
        settings?: Partial<LayoutSettings>;
    }> {
        const init = localStorage.getItem('init');
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        if (!token && !init && !user) {
            localStorage.setItem('init', 'true');
            authService.login();
        }
        return {
            settings: {}
        };
    }
    
    // ProLayout æ”¯æŒçš„api https://procomponents.ant.design/components/layout
    export const layout: RunTimeLayoutConfig = ({ initialState }) => {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        return {
            rightContentRender: () => <RightContent />,
            disableContentMargin: false,
            waterMarkProps: {
                //content: initialState?.currentUser?.name,
            },
            // footerRender: () => <Footer />,
            onPageChange: () => {
                const { location } = history;
                if (!token && !user && location.pathname != "/callback") {
                    authService.login();
                }
            },
            links: isDev
                ? [
                    <Link to="/umi/plugin/openapi" target="_blank">
                        <LinkOutlined />
                        <span>OpenAPI æ–‡æ¡£</span>
                    </Link>,
                    <Link to="/~docs">
                        <BookOutlined />
                        <span>ä¸šåŠ¡ç»„ä»¶æ–‡æ¡£</span>
                    </Link>,
                ]
                : [],
            menuHeaderRender: undefined,
            // è‡ªå®šä¹‰ 403 é¡µé¢
            // unAccessible: <div>unAccessible</div>,
            ...initialState?.settings,
            //é˜²æ­¢æœªç™»å½•é—ªå±èœå•é—®é¢˜
            pure: token ? false : true 
        }
    };
    
    const authHeaderInterceptor = (url: string, options: RequestOptionsInit) => {
        const token = localStorage.getItem('token');
        const authHeader = { Accept: 'application/json', 'Content-Type': 'application/json', Authorization: 'Bearer ' + token };
        return {
            url: `${url}`,
            options: { ...options, interceptors: true, headers: authHeader },
        };
    };
    export const request: RequestConfig = {
        //timeout: 10000,
        // æ–°å¢è‡ªåŠ¨æ·»åŠ AccessTokençš„è¯·æ±‚å‰æ‹¦æˆªå™¨
        requestInterceptors: [authHeaderInterceptor],
    };
    

#### 3ã€ç™»å½•å›è°ƒã€è·å–ç”¨æˆ·ã€ç™»å‡º

**ï¼ˆ1ï¼‰æ·»åŠ callback.tsxï¼Œè¿™æ˜¯ç™»å½•æˆåŠŸçš„å›è°ƒåœ°å€ï¼Œä¿å­˜ç™»å½•çŠ¶æ€tokenã€userç­‰ï¼Œè·³è½¬é¡µé¢ã€‚**

    import { message, Result, Spin } from 'antd';
    import React, { useEffect, useRef, useState } from 'react';
    import { AuthService } from '@/utils/auth';
    import { useRequest } from 'umi';
    import { login } from '@/services/accountService';
    
    const authService: AuthService = new AuthService();
    
    const callback: React.FC = () => {
        const [msg, setMsg] = useState('ç©å‘½ç™»å½•ä¸­......');
        const authRedirect = useRef("/");
        const { run, loading } = useRequest(login, {
            manual: true,
            onSuccess: (result, params) => {
                if (result && result.responseData) {
                    localStorage.setItem('user', JSON.stringify(result.responseData));
                    window.location.href = authRedirect.current;
                } else {
                    setMsg('ç™»å½•å¤±è´¥ï¼Œå³å°†è·³è½¬é‡æ–°ç™»å½•......');
                    setTimeout(() => {
                        localStorage.removeItem('init');
                        localStorage.removeItem('token');
                        window.location.href = authRedirect.current;
                    }, 3000);
                }
            },
            onError: (error) => {
                message.error(error.message);
            }
        });
        useEffect(() => {
            authService.signinRedirectCallback().then(auth => {
                authRedirect.current = auth.state;
                localStorage.setItem('token', auth.access_token);
                run({ account: auth.profile.sub });
            })
        }, [])
    
        return (
            <>
                <Result status="success" title={<Spin spinning={loading} tip={msg}></Spin>} />
            </>
        )
    };
    
    export default callback;
    

**ï¼ˆ2ï¼‰accountService.tsx [Umi](https://umijs.org/zh-CN)çš„useRequestã€Request é…åˆä½¿ç”¨**

    import { request } from 'umi';
    export async function login(payload: { account: string }, options?: { [key: string]: any }) {
        return request('/api/Account/Login', {
            method: 'POST',
            params: payload,
            ...(options || {}),
        });
    }
    

**AvatarDropdown.tsx ç™»å‡ºæ ¸å¿ƒæ–¹æ³•**

    const onMenuClick = useCallback(
      (event: MenuInfo) => {
        const { key } = event;
        if (key === 'logout') {
          localStorage.removeItem('init');
          localStorage.removeItem('user');
          localStorage.removeItem('token');
          authService.logout();
          return;
        }
        history.push(`/account/${key}`);
      },
      [],
    );
    

#### 4ã€è‡ªå®šä¹‰å…¶ä»–é…ç½®

**å¦‚ï¼šPageLoading ç­‰å¾…æ¡†ç»„ä»¶ã€defaultSettings.ts é¢œè‰²ã€å›¾æ ‡ç­‰é…ç½®é¡¹ã€routes.ts è·¯ç”±ï¼Œè¯¦ç»†è§ä»£ç ã€‚**

äº”ã€LinuxæœåŠ¡å™¨éƒ¨ç½²
------------

#### 1ã€.NET6 ç¯å¢ƒ

**å‘1æœ‰CentOS7å®‰è£….NET6çš„æ­¥éª¤ï¼Œå…¶ä»–linuxç‰ˆæœ¬[å‚è€ƒ](https://docs.microsoft.com/zh-cn/dotnet/core/install/linux)**

#### 2ã€æœåŠ¡èµ„æºåˆ†é…

**å› ä¸ºåªæœ‰ä¸€å°æœåŠ¡å™¨ï¼Œç”¨nginxè¿›è¡Œè½¬å‘ï¼šReactå‰ç«¯ç«¯å£80ï¼ŒIdentityServer4ç«¯å£5000ï¼ŒWebApièµ„æºç«¯å£8000ï¼ŒMvcç½‘ç«™ç«¯å£9000**  
![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530144333924-463697186.png)**å¯åŠ¨å‘½ä»¤åˆ†ä¸¤æ­¥ï¼Œä¸¾ä¸ªæ —å­ï¼š**

    cd /æŒ‡å®šç›®å½•
    nohup dotnet ./BKYL.WEB.API.dll &
    

#### 3ã€nginxé…ç½®https

**å› ä¸ºå…¨éƒ¨ä½¿ç”¨äº†httpsï¼Œæ‰€æœ‰åŸŸåã€äºŒçº§åŸŸåéƒ½æäº†sslè¯ä¹¦ï¼Œä¸€ä¸€å¯¹åº”ï¼Œé€šè¿‡ nginx é…ç½®éƒ¨ç½²ï¼Œè´´ä¸Šnginx.confå…³é”®éƒ¨åˆ†ä»¥ä¾›å‚è€ƒã€‚**

> å¦‚ä½•è®¾ç½®äºŒçº§åŸŸåã€ç”³è¯·sslè¯ä¹¦ã€nginxé…ç½®sslè¯ä¹¦ï¼Œç½‘ä¸Šèµ„æ–™å¾ˆå¤šï¼Œä¸å†èµ˜è¿°ï¼Œæœ‰éœ€è¦çš„å¯ä»¥ç§

    server {
      listen       80;
      server_name  *.wintersir.com;
      
      rewrite ^(.*)$ https://$host$1;
      #charset koi8-r;
      error_page   500 502 503 504  /50x.html;
      location = /50x.html {
          root   html;
      }     
    }
     
    server {
      listen       443 ssl;
      server_name  www.wintersir.com wintersir.com;
      ssl_certificate      /app/nginx/conf/index/cert.pem;
      ssl_certificate_key  /app/nginx/conf/index/cert.key;
      ssl_session_cache    shared:SSL:1m;
      ssl_session_timeout  5m;
      ssl_ciphers  HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers  on;
      location / {
        root   /app/wintersir/index;
        index  index.html index.htm;
      }
    }
    
    server {
      listen       443 ssl;
      server_name  homejok.wintersir.com;
      ssl_certificate      /app/nginx/conf/view/cert.pem;
      ssl_certificate_key  /app/nginx/conf/view/cert.key;
      ssl_session_cache    shared:SSL:1m;
      ssl_session_timeout  5m;
      ssl_ciphers  HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers  on;
      location / {
      
        proxy_set_header X-Forearded-Proto $scheme;
        proxy_set_header Host $http_host;		
        proxy_set_header X-Real-IP $remote_addr;		
        
        add_header 'Access-Control-Allow-Origin' "$http_origin";		
        add_header 'Access-Control-Allow-Credentials' 'true';		
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
      
        root   /app/wintersir/view;
        index  index.html index.htm;
      }
      
      location /api/ {
      
        proxy_set_header X-Forearded-Proto $scheme;
        proxy_set_header Host $http_host;		
        proxy_set_header X-Real-IP $remote_addr;		
        
        add_header 'Access-Control-Allow-Origin' "$http_origin";		
        add_header 'Access-Control-Allow-Credentials' 'true';		
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
        proxy_pass https://www.wintersir.com:8000;
      }
    }
     
    server {
      listen       443 ssl;
      server_name  mvc.wintersir.com;
      ssl_certificate      /app/nginx/conf/mvc/cert.pem;
      ssl_certificate_key  /app/nginx/conf/mvc/cert.key;
      ssl_session_cache    shared:SSL:1m;
      ssl_session_timeout  5m;
      ssl_ciphers  HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers  on;
      location / {
        proxy_set_header X-Forearded-Proto $scheme;
        proxy_set_header Host $http_host;		
        proxy_set_header X-Real-IP $remote_addr;		
        add_header 'Access-Control-Allow-Origin' "$http_origin";		
        add_header 'Access-Control-Allow-Credentials' 'true';		
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
        proxy_pass https://www.wintersir.com:9000/;
      }
    }
    
    server {
      isten       443 ssl;
      server_name  login.wintersir.com;
     
      ssl_certificate      /app/nginx/conf/login/cert.pem;
      ssl_certificate_key  /app/nginx/conf/login/cert.key;
     
      ssl_session_cache    shared:SSL:1m;
      ssl_session_timeout  5m;
     
      ssl_ciphers  HIGH:!aNULL:!MD5;
      ssl_prefer_server_ciphers  on;
     
      location / {
      
        if ($request_method = 'OPTIONS') { 
           add_header 'Access-Control-Allow-Origin' "$http_origin";
           add_header 'Access-Control-Allow-Credentials' 'true';
           add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
           add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
           return 200; 
        }
      
        proxy_set_header X-Forearded-Proto $scheme;
        proxy_set_header Host $http_host;		
        proxy_set_header X-Real-IP $remote_addr;		
        add_header 'Access-Control-Allow-Origin' "$http_origin";		
        add_header 'Access-Control-Allow-Credentials' 'true';		
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
        add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
        proxy_pass https://www.wintersir.com:5000/;
      }
    }
    

å…­ã€æ•ˆæœå›¾
-----

#### 1ã€Reactå‰ç«¯

![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530143323826-348525557.gif)

#### 2ã€Mvcç½‘ç«™æµ‹è¯•

![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220530143329034-2012384505.gif)

ä¸ƒã€å„ç§è¸©å‘
------

#### 1ã€CentOS8ä¸æ”¯æŒ .NET6

**å½“åˆé˜¿é‡Œäº‘è£…äº†CentOS8ï¼Œç°åœ¨æƒ³å“­ï¼Œè¾¹å“­è¾¹è£…CentOS7.9ï¼ŒæŠŠæ•°æ®åº“ã€nginxç­‰ç¯å¢ƒåˆéƒ½è£…ä¸€éï¼ˆå‰å‡ ç¯‡éƒ½æœ‰ï¼‰ğŸ˜‚**  
**CentOS7 å®‰è£… .NET6 [å®˜æ–¹æ•™ç¨‹](https://docs.microsoft.com/zh-cn/dotnet/core/install/linux-centos) ï¼Œåˆ†åˆ«æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä¸­é—´è¾“å…¥äº†ä¸¤æ¬¡y**

    sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm
    sudo yum install dotnet-sdk-6.0
    

#### 2ã€nginxä¼ è¾“æ•°æ®è¿‡å¤§ã€è½¬å‘è·¨åŸŸ

**ç®€å•æ¨¡å¼ token ç­‰ä¿¡æ¯å¸¦åœ¨äº†å›è°ƒé¡µé¢urlé‡Œï¼Œnginx 502 æ— æ³•è·³è½¬ï¼Œè§£å†³[å‚è€ƒ](https://stackoverflow.com/questions/48964429/net-core-behind-nginx-returns-502-bad-gateway-after-authentication-by-identitys)ï¼Œnginx http æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š**  
![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220427224436345-683266032.png)

    proxy_buffer_size   128k;
    proxy_buffers   4 256k;
    proxy_busy_buffers_size   256k;
    large_client_header_buffers 4 16k;
    

**å¤„ç†proxy\_passè½¬å‘ï¼š**

    proxy_set_header X-Forearded-Proto $scheme;
    proxy_set_header Host $http_host;		
    proxy_set_header X-Real-IP $remote_addr;
    add_header 'Access-Control-Allow-Origin' "$http_origin";		
    add_header 'Access-Control-Allow-Credentials' 'true';		
    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';		
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
    

**å¤„ç†OPTIONSé¢„æ£€**

    if ($request_method = 'OPTIONS') { 
      add_header 'Access-Control-Allow-Origin' "$http_origin";
      add_header 'Access-Control-Allow-Credentials' 'true';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since,Content-Type';
      return 200; 
    }
    

#### 3ã€jså®¢æˆ·ç«¯tokenä¼ è¾“ã€æˆæƒ

**jsï¼ˆreactã€vueç­‰ï¼‰å®¢æˆ·ç«¯éœ€è¦åœ¨æˆæƒæœåŠ¡é…ç½®æ—¶ï¼Œè®¾ç½®å…è®¸å°†tokené€šè¿‡æµè§ˆå™¨ä¼ é€’ AllowAccessTokensViaBrowser = trueï¼Œå®¢æˆ·ç«¯è®¾ç½®ç¦ç”¨äº†æˆæƒé¡µé¢ï¼Œç™»å½•é‰´æƒåç›´æ¥è·³å›å¯¹åº” RequireConsent = false**  
![](https://img2022.cnblogs.com/blog/1780813/202204/1780813-20220428093759500-353565832.png)

#### 4ã€å‰ç«¯ç»Ÿä¸€æ¥å£è¿”å›æ ¼å¼

**Umiæ¡†æ¶é»˜è®¤æ ¼å¼ä¸åå°æ¥å£è¿”å›ä¸ä¸€è‡´å°±ä¼šå¯¼è‡´è·å–ä¸åˆ°ï¼Œconfig.ts åŠ ä¸Šä»¥ä¸‹ä»£ç ï¼Œå°±å¯ä»¥ä½¿ç”¨åå°è‡ªå®šä¹‰è¿”å›çš„æ•°æ®æ ¼å¼äº†**

    request: {
        dataField: ""  //å¿½ç•¥æ¡†æ¶å¤„ç†
    }
    

#### 5ã€PostLogoutRedirectUrisæ— æ•ˆ

**æœ¬ä»¥ä¸ºé…ç½®äº†é€€å‡ºè·³è½¬è·¯ç”±å°±OKäº†ï¼Œç»“æœè¿˜æ˜¯å¾—è‡ªå·±åŠ ä»£ç æ‰‹åŠ¨è·³è½¬ï¼Œåœ¨æˆæƒæœåŠ¡ä¸­AccountControllerï¼ŒLogoutæ–¹æ³•**  
![](https://img2022.cnblogs.com/blog/1780813/202205/1780813-20220528221038792-482411485.png)

#### 6ã€EFCoreè¿æ¥æ•°æ®åº“å¶å°”å¼‚å¸¸ï¼šAn exception has been raised that is likely due to a transient failure.

**æŸ¥èµ„æ–™è¯´æ˜¯sslé—®é¢˜ï¼Œè¿æ¥å­—ç¬¦ä¸²serveræ”¹æˆhttpsçš„ï¼Œä¸å¤ªç¡®å®šï¼Œå¤§ä½¬æ‡‚çš„å¯ä»¥è¯´ä¸€ä¸‹**

å…«ã€å‰äººæ ½æ ‘ï¼Œåäººä¹˜å‡‰
-----------

[https://github.com/skoruba/react-oidc-client-js](https://github.com/skoruba/react-oidc-client-js)

ä¹ã€ä»£ç å·²ä¸Šä¼ 
-------

[https://github.com/wintersir](https://github.com/wintersir)

åã€åç»­
----

**åé¢å­¦ä¹ è¦å¾€å®¹å™¨ã€å¾®æœåŠ¡æ–¹å‘èµ°äº†ï¼ŒDockerã€Jenkinsã€DDD ç­‰ç­‰ï¼Œæƒ³å­¦å“ªä¸ªå­¦å“ªä¸ªï¼Œå†™äº†ä¹Ÿä¸ä¸€å®šå­¦ï¼Œå“ˆå“ˆ~~~ï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼š**  
_ï¼ˆä¸ªäººå­¦ä¹ è®°å½•åˆ†äº«ï¼ŒåšæŒæ›´æ–°ï¼Œä¹Ÿæœ‰å¯èƒ½çƒ‚å°¾ï¼Œæœ€ç»ˆè§£é‡Šæƒå½’æœ¬äººæ‰€æœ‰ï¼Œå“ˆå“ˆå“ˆå“ˆï¼Œå—~~~ï¼‰_

å†™åœ¨æœ€å
----

**åšå®¢åï¼šWinterSirï¼Œ[å­¦ä¹ ç›®å½• https://www.cnblogs.com/WinterSir/p/13942849.html](https://www.cnblogs.com/WinterSir/p/13942849.html)**

æµ‹è¯•ç­¾å