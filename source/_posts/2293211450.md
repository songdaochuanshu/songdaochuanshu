---
layout: post
title: "面试官：Zookeeper怎么解决读写、双写并发不一致问题，以及共享锁的实现原理？"
date: "2022-04-05T09:17:38.490Z"
---
面试官：Zookeeper怎么解决读写、双写并发不一致问题，以及共享锁的实现原理？
=========================================

> 哈喽！大家好，我是小奇，一位不靠谱的程序员  
> 小奇打算以轻松幽默的对话方式来分享一些技术，如果你觉得通过小奇的文章学到了东西，那就给小奇一个赞吧  
> 文章持续更新

一、前言
====

> 今天清明假期，赶上北京玉渊潭公园樱花盛开，女朋友非要拉着我去看樱花，我头一天晚上干文章到三点半，我很想睡觉，但是没办法，军令难违呀。

![在这里插入图片描述](https://img-blog.csdnimg.cn/1ec25b0bab2646b58ce66741213eea2f.png#pic_center)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/3be4795fa7ab4cad8206d6cd7c34013a.png#pic_center)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/be4784c8ccf44e97aa7d84fe98ed5a31.png#pic_center)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/578f30dabc7149d1b0574c4a13d2911b.png#pic_center)  
![在这里插入图片描述](https://img-blog.csdnimg.cn/186e8bea6610444cb0c51a0acfce7c7c.png#pic_center)

> 来到这里犹如来到了花的海洋，让我浑身的艺术细菌开始躁动，我忍不住吟诗一首“樱花落尽子规啼、闻道龙标过五溪，我寄愁心与明月、随君直到夜郎西”，啊，美丽的樱花啊。

> 这时旁边的公园管理员满是疑惑的看着我，问我小伙子你的诗背错了吧，不应该是杨花落尽子规啼吗？

> 我只能尴尬的笑笑说，今天应景，我就自己改改词。。。

![在这里插入图片描述](https://img-blog.csdnimg.cn/87d3f6331e7440889f8509266e7a87c5.png#pic_center)

> 就在我尽情展示我浑身的艺术细菌的时候，突然手机响了，我一看是一个北京号码，手机尾号6543，我接通了电话

> 我：哈喽啊

> 对方：喂，是小奇吗？

> 我：正是在下，请问阁下是？

> 对方：我是某某某公司的，我在某某招聘网站上看到了你的简历，请问你还在找工作吗？

> 我：没错，我还在找。

> 对方：那你现在方便进行面试吗？

> 这个时候我看向了我家领导，我家领导满脸嫌弃的说，让你陪我出来逛公园，不是刮风就是下雨，面吧。

二、面试
====

> 我：面试官您好，我现在方便面试。

> **面试官：好，我看你简历上写的是精通zookeeper是吧。**

> 我：不敢当，都是同行们抬爱，实在惭愧（其实心里已经膨胀起来了）。

![在这里插入图片描述](https://img-blog.csdnimg.cn/31242a1f800542919551b8cab7a866a2.png#pic_center)

三、读写、双写不一致问题
============

> **面试官：好，那你说一下并发情况下读写、双写不一致问题是怎么回事呢？**

> 我：读写不一致问题是在并发情况下，多个线程对同一个数据同时进行读取和写入操作，最后导致读写不一致。

![在这里插入图片描述](https://img-blog.csdnimg.cn/7efab401fbb2445383f8fba1836003f4.png)

> 比如这里我线程A查询缓存为空，那么就要查询数据库，查询数据库name为张三，然后我就要去更缓存name为张三。

> 但是这个时候线程B在线程A查询数据库之后，更新缓存之前修改了数据库的数据name为李四，但是缓存name还是张三，这里就出现数据库与缓存不一致的情况了。

> **面试官：嗯，那双写不一致是什么情况呢？**

![在这里插入图片描述](https://img-blog.csdnimg.cn/bbd4e08b31d646e9a8c4162e07dcf431.png)

> 双写不一致就是两个线程都是写的操作，结果还是造成了数据库和缓存不一致的问题。

> 例如线程B在线程A写入数据后、更新缓存前，进行了数据的修改，但是最终修改缓存的还是线程A，所以这时数据库和缓存不一致。

> **面试官：嗯，那怎么解决呢？**

> 我：使用共享锁解决。

四、Zookeeper共享锁的实现原理
===================

> **面试官：嗯，zookeeper怎么实现共享锁呢，它的实现原理是什么？**

> 我：这个讲起来有点复杂，要不我先陪我女朋友逛公园，我们晚上回去再聊吧。

> **面试官：别呀，你现在已经勾起我的兴趣了，我们一下子聊完吧，我们就一面**

> 我：好吧，zookeeper共享锁的实现原理就是如果挨着的线程都是读请求，那么他们共享同一把锁。

![在这里插入图片描述](https://img-blog.csdnimg.cn/9c3d74c2458441019441bce73732afc5.png)

> 这里我们可以看到线程1、2、3是三个连续的读请求的操作，那么他们共享同一把锁A，也就是这个三个线程可以并发的去读取数据。

> 然后我们看到线程4是写请求，那么他只能等前面的所有线程执行完了才能执行自己的写操作。

> 这里线程5也是写请求，那么他只能等他前面的所有线程执行完了才能执行自己的写操作。

> 然后线程6、7、8都是读线程，那么他们获取的是同一把锁，在线程5执行完毕后，线程6、7、8可以一起执行读取操作。

> 这里的监听我们之前说了是为了解决羊群问题的。

> **面试官：小伙子真厉害啊，我这边没有什么要问的了，你还有什么问题要问我的吗**

> 我：额。。。咱们公司加班挺严重的吧。

> **面试官：何以见得呢？你都没来过公司你怎么知道的？**

> 我：因为现在是假期你还在约面试，可想而知公司的加班文化挺浓厚的吧。

> **面试官：嗯~，我们公司其实不提倡加班，但是员工都很爱加班**

> 我：额。。。那我还是考虑两天吧，我感觉我可能有点不合群。。。

> **面试官：那你要是不过来可以帮忙推荐一些其他同学吗**

> 我：那你先好好学学zookeeper的原理吧，不然我推荐一些小奇趣味编程系列的忠实读者的话你肯定招架不住啊。

> **面试官：那我也赶紧看看小奇趣味编程系列，到时候就见招拆招**

> 我：额。。。那样的话两个人都是登峰造极的状态，谁也虐不了谁属实有点尴尬。。。

五、总结
====

> 这里关于zookeeper还没有整理完毕，文章后面持续更新，建议收藏。

> 文章中涉及到的命令大家一定要像我一样每个都敲几遍，只有在敲的过程中才能发现自己对命令是否真正的掌握了。

> 如果觉得我的文章还不错的话就点个赞吧