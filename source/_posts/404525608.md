---
layout: post
title: "Goå¾®æœåŠ¡æ¡†æ¶go-kratoså®æˆ˜03ï¼šä½¿ç”¨ gorm å®ç°å¢åˆ æ”¹æŸ¥æ“ä½œ"
date: "2022-06-02T11:17:43.028Z"
---
Goå¾®æœåŠ¡æ¡†æ¶go-kratoså®æˆ˜03ï¼šä½¿ç”¨ gorm å®ç°å¢åˆ æ”¹æŸ¥æ“ä½œ
=====================================

ä¸€ã€ç®€ä»‹
----

åœ¨ä¸Šä¸€ç¯‡æ–‡ç«  [go-kratoså®æˆ˜02](https://www.cnblogs.com/jiujuan/p/16331967.html) ä¸­ï¼Œè¯¦ç»†ä»‹ç»äº†ç”¨ [kratos](https://github.com/go-kratos/kratos) ç¼–å†™é¡¹ç›®ä»£ç çš„æ­¥éª¤ã€‚è¿™ç¯‡å°±åœ¨ä¸Šç¯‡åŸºç¡€ä¸Šï¼Œå†ç»“åˆ Go æ•°æ®åº“æ“ä½œåº“ [gorm](https://gorm.io/zh_CN/) ä¸€æ­¥ä¸€æ­¥æ¥å®ç°ä¸€ä¸ªç®€å•çš„å¢åˆ æ”¹æŸ¥æ“ä½œã€‚

é¦–å…ˆå‡å®šä½ å·²ç»ä¼šä½¿ç”¨ [gorm](https://gorm.io/zh_CN/) çš„åŸºæœ¬æ“ä½œã€‚

å®‰è£… gormï¼š

    $ go get -u gorm.io/gorm
    go: downloading gorm.io/gorm v1.23.5
    
    ... ...
    

GORM æ–‡æ¡£ï¼š[https://gorm.io/zh\_CN/docs/](https://gorm.io/zh_CN/docs/)

Goï¼Œgorm å’Œ go-kratos ç‰ˆæœ¬ï¼š

> go v1.17.10 windows/amd64
> 
> go-kratos v2.2.1
> 
> gorm v1.23.5

äºŒã€æ–°å»º student é¡¹ç›®
---------------

åœ¨å‰é¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å¯ä»¥ä½¿ç”¨ `kratos new` å‘½ä»¤ï¼Œç”¨ [kratos-layout](https://github.com/go-kratos/kratos-layout) è¿™ä¸ªæ¨¡æ¿å¿«é€Ÿæ–°å»ºå‡ºä¸€ä¸ªé¡¹ç›®ã€‚

    $ kratos new student
    ğŸš€ Creating service student, layout repo is https://github.com/go-kratos/kratos-layout.git, please wait a moment.
    
    From https://github.com/go-kratos/kratos-layout
       cc5192f..6715fbc  main       -> origin/main
     * [new tag]         v2.3.0     -> v2.3.0
     * [new tag]         v2.2.2     -> v2.2.2
     
    ... ... 
    

> å‘ç° `kratos new` å‘½ä»¤æ¯æ¬¡åˆ›å»ºæ–°é¡¹ç›®éƒ½ä¼šä½¿ç”¨æœ€æ–°ç‰ˆ go-kratosã€‚çœ‹ä¸Šé¢çš„ä¿¡æ¯ kratos ç‰ˆæœ¬åˆ°äº† v2.3.0ã€‚
> 
> å‰é¢é¡¹ç›®ç”¨çš„è¿˜æ˜¯ v2.2.1ï¼Œä¸ºäº†å’Œå‰é¢é¡¹ç›®ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼ŒæŠŠ go.mod é‡Œçš„ kratos æ”¹æˆ v2.2.1 ï¼Œç„¶å
> 
> è¿è¡Œ `go mod tidy` å‘½ä»¤ï¼Œé‡æ–°ä¸‹è½½ä¾èµ–åŒ…ã€‚

å› ä¸ºä½¿ç”¨ kratos-layout æ¨¡æ¿æ–°å»ºçš„ student é¡¹ç›®ï¼Œä¸ºäº†ä½¿é¡¹ç›®çœ‹èµ·æ¥å¹²å‡€ç‚¹ï¼Œéœ€è¦ä¿®æ”¹å’Œåˆ é™¤é‡Œé¢çš„æ–‡ä»¶ã€‚

æ¯”å¦‚ proto æ–‡ä»¶ï¼š

![image-20220601182607229](https://img2022.cnblogs.com/blog/650581/202206/650581-20220602163117297-2028139247.png)

ä¸‰ã€æ•´ç† student é¡¹ç›®
---------------

è¿™æ—¶å€™é¡¹ç›®é‡Œçš„å¾ˆå¤šæ–‡ä»¶ï¼Œå˜é‡åç­‰éƒ½æ˜¯ä»¥ greeter ä¸ºåå­—çš„ï¼Œå› ä¸ºè¿™ä¸ªæ˜¯æ¨¡æ¿è‡ªå¸¦çš„ã€‚å…ˆç®€å•æ•´ç†ä¸‹ã€‚

1.  åˆ æ‰ helloworld/v1 æ–‡ä»¶å¤¹ï¼Œæ–°å»º student/v1 æ–‡ä»¶å¤¹
    
2.  åœ¨ internal ç›®å½•ä¸‹çš„ greeter.go æ–‡ä»¶éƒ½å¯ä»¥ä¿®æ”¹ä¸º student.go ï¼Œé‡Œé¢çš„å†…å®¹åé¢åœ¨é€ä¸€ä¿®æ”¹ï¼Œæˆ–è€…ç›´æ¥åˆ æ‰æ–‡ä»¶ååœ¨æ·»åŠ  student.go æ–‡ä»¶ã€‚æˆ‘è¿™é‡Œç›´æ¥ä¿®æ”¹å¥½äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‚è€ƒæ¨¡æ¿ã€‚
    

å››ã€ç¼–å†™é¡¹ç›®ä»£ç 
--------

### 4.1 ç”¨å‘½ä»¤æ–°å»º student.proto

    kratos proto add api/student/v1/student.proto
    

### 4.2 é€šè¿‡ student.proto ç”Ÿæˆä»£ç 

**ç¬¬ä¸€æ­¥**ï¼Œç»™ student.proto æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š

    // å…ˆå¼•å…¥ google/api/annotations.proto
    import "google/api/annotations.proto";
    
    // åœ¨ service Student{} å¢åŠ å¦‚ä¸‹ä»£ç ï¼š
    rpc GetStudent (GetStudentRequest) returns (GetStudentReply) {
    		option (google.api.http) = {
    			get: "/student/{id}",
    		};
    }
    
    message GetStudentRequest {
    	int32 id = 1;
    }
    
    message GetStudentReply {
    	string name   = 1;
    	int32  status = 2;
    	int32  id     = 3;
    }
    

**ç¬¬äºŒæ­¥**ï¼Œé€šè¿‡ `kratos proto client` ç”Ÿæˆ pb ç›¸å…³ä»£ç ï¼š

    kratos proto client api/student/v1/student.proto
    

![image-20220601204724113](https://img2022.cnblogs.com/blog/650581/202206/650581-20220602163117276-1173352802.png)

**ç¬¬ä¸‰æ­¥**ï¼Œé€šè¿‡ student.proto ç”Ÿæˆ Service(æœåŠ¡) ä»£ç ï¼š

    $ kratos proto server api/student/v1/student.proto -t internal/service
    internal/service/student.go
    

ä¿®æ”¹ internal/service/service.go é‡Œä¾èµ–æ³¨å…¥éƒ¨åˆ†:

    var ProviderSet = wire.NewSet(NewStudentService)
    

### 4.3 å®ä¾‹åŒ– HTTP å’Œ gRPC

åœ¨ internal/server ç›®å½•ä¸‹ï¼Œä¿®æ”¹ http.go, grpc.go, server.goã€‚

http.go:

    // ä¸Šé¢ import ä¸­å¼•å…¥çš„ greeter
    import (
    	v1 "student/api/student/v1"
    	
        ... ...
    )
    
    // NewHTTPServer new a HTTP server.
    func NewHTTPServer(c *conf.Server, student *service.StudentService, logger log.Logger) *http.Server {
        ... ...
        
    	srv := http.NewServer(opts...)
    	v1.RegisterStudentHTTPServer(srv, student)
    	return srv
    }
    

grpc.go:

    import (
    	v1 "student/api/student/v1"
    	
        ... ...
    )
    
    // NewGRPCServer new a gRPC server.
    func NewGRPCServer(c *conf.Server, student *service.StudentService, logger log.Logger) *grpc.Server {
    	... ...
        
    	srv := grpc.NewServer(opts...)
    	v1.RegisterStudentServer(srv, student)
    	return srv
    }
    

### 4.4 ç¼–å†™è·å–å­¦ç”Ÿä¿¡æ¯ä»£ç 

ä¸‹é¢ç¼–å†™ç”¨å­¦ç”Ÿ id æ¥è·å–å­¦ç”Ÿä¿¡æ¯ã€‚

**ç¬¬ä¸€æ­¥**ï¼šåœ¨ internal/biz/student.go é‡Œç¼–å†™ä»£ç 

å‰é¢[ç¬¬ä¸€ç¯‡æ–‡ç« ](https://www.cnblogs.com/jiujuan/p/16322725.html)è®²è¿‡ biz ç›®å½•ä½œç”¨ï¼Œèµ·åˆ°ä¸šåŠ¡ç»„è£…ä½œç”¨ï¼Œå®šä¹‰äº† biz çš„ repo æ¥å£ã€‚

å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å°±æ–°å»ºä¸€ä¸ªï¼Œstudent.go ä¸­ä»£ç å¦‚ä¸‹ï¼š

    package biz
    
    import (
    	"context"
    	"time"
    
    	"github.com/go-kratos/kratos/v2/log"
    )
    
    // Student is a Student model.
    type Student struct {
    	ID        int32
    	Name      string
    	Info      string
    	Status    int32
    	UpdatedAt time.Time
    	CreatedAt time.Time
    }
    
    // å®šä¹‰ Student çš„æ“ä½œæ¥å£
    type StudentRepo interface {
    	GetStudent(context.Context, int32) (*Student, error) // æ ¹æ® id è·å–å­¦ç”Ÿä¿¡æ¯
    }
    
    type StudentUsecase struct {
    	repo StudentRepo
    	log  *log.Helper
    }
    
    // åˆå§‹åŒ– StudentUsecase
    func NewStudentUsecase(repo StudentRepo, logger log.Logger) *StudentUsecase {
    	return &StudentUsecase{repo: repo, log: log.NewHelper(logger)}
    }
    
    // é€šè¿‡ id è·å– student ä¿¡æ¯
    func (uc *StudentUsecase) Get(ctx context.Context, id int32) (*Student, error) {
    	uc.log.WithContext(ctx).Infof("biz.Get: %d", id)
    	return uc.repo.GetStudent(ctx, id)
    }
    

ç”¨ wire æ³¨å…¥ä»£ç ï¼Œä¿®æ”¹ internal/biz/biz.go ï¼š

    var ProviderSet = wire.NewSet(NewStudentUsecase)
    

**ç¬¬äºŒæ­¥**ï¼šåœ¨ internal/data/student.go é‡Œç¼–å†™ä»£ç 

å‰é¢[ç¬¬ä¸€ç¯‡æ–‡ç« ](https://www.cnblogs.com/jiujuan/p/16322725.html)å·²ç»è®²è¿‡ data ç›®å½•ä½œç”¨ï¼Œå¯¹æ•°æ®æŒä¹…åŒ–çš„æ“ä½œï¼Œä¸šåŠ¡æ•°æ®è®¿é—®ï¼ŒåŒ…å« DBã€redis ç­‰å°è£…ï¼Œå®ç°äº† biz çš„ repo interfaceã€‚biz é‡Œå®šä¹‰äº† repo interfaceã€‚

å¦‚æœæ²¡æœ‰è¿™ä¸ªæ–‡ä»¶å°±æ–°å»ºä¸€ä¸ªï¼Œstudent.go ä»£ç å¦‚ä¸‹ï¼š

    package data
    
    import (
    	"context"
    
    	"student/internal/biz"
    
    	"github.com/go-kratos/kratos/v2/log"
    )
    
    type studentRepo struct {
    	data *Data
    	log  *log.Helper
    }
    
    // åˆå§‹åŒ– studentRepo
    func NewStudentRepo(data *Data, logger log.Logger) biz.StudentRepo {
    	return &studentRepo{
    		data: data,
    		log:  log.NewHelper(logger),
    	}
    }
    
    func (r *studentRepo) GetStudent(ctx context.Context, id int32) (*biz.Student, error) {
    	var stu biz.Student
    	r.data.gormDB.Where("id = ?", id).First(&stu) // è¿™é‡Œä½¿ç”¨äº† gorm
            r.log.WithContext(ctx).Info("gormDB: GetStudent, id: ", id)
    	return &biz.Student{
    		ID:        stu.ID,
    		Name:      stu.Name,
    		Status:    stu.Status,
    		Info:      stu.Info,
    		UpdatedAt: stu.UpdatedAt,
    		CreatedAt: stu.CreatedAt,
    	}, nil
    }
    

ä¸Šé¢ä»£ç é‡Œæœ‰ä¸ª r.data.gormDB, gormDB è¿™ä¸ªä¸œä¸œä»å“ªé‡Œæ¥ï¼Ÿå°±æ˜¯ä¸‹é¢è¦ç¼–å†™çš„ data/data.goï¼Œè¿æ¥æ•°æ®åº“ã€‚

**ç¬¬ä¸‰æ­¥**ï¼šç¼–å†™ internal/data/data.go:

æ•°æ®åº“çš„å°è£…æ“ä½œä»£ç ã€‚

    // ç¬¬ 1 æ­¥å¼•å…¥ *gorm.DB
    type Data struct {
    	// TODO wrapped database client
    	gormDB *gorm.DB
    }
    
    // ç¬¬ 2 æ­¥åˆå§‹åŒ– gorm
    func NewGormDB(c *conf.Data) (*gorm.DB, error) {
    	dsn := c.Database.Source
    	db, err := gorm.Open(mysql.Open(dsn), &gorm.Config{})
    	if err != nil {
    		return nil, err
    	}
    
    	sqlDB, err := db.DB()
    	if err != nil {
    		return nil, err
    	}
    	sqlDB.SetMaxIdleConns(50)
    	sqlDB.SetMaxOpenConns(150)
    	sqlDB.SetConnMaxLifetime(time.Second * 25)
    	return db, err
    }
    
    // ç¬¬ 3 æ­¥ï¼Œåˆå§‹åŒ– Data
    func NewData(logger log.Logger, db *gorm.DB) (*Data, func(), error) {
    	cleanup := func() {
    		log.NewHelper(logger).Info("closing the data resources")
    	}
    
    	return &Data{gormDB: db}, cleanup, nil
    }
    
    // ç¬¬ 4 æ­¥ï¼Œç”¨ wire æ³¨å…¥ä»£ç ï¼Œä¿®æ”¹ åŸæ¥çš„ NewSet
    var ProviderSet = wire.NewSet(NewData, NewGormDB, NewStudentRepo)
    

ç”Ÿæˆçš„æ¨¡æ¿ä»£ç æ˜¯åœ¨ `NewData` é‡Œåˆå§‹åŒ– dbï¼Œè¿™é‡ŒæŠŠ gormDB ç‹¬ç«‹å°è£…ï¼Œç„¶åç”¨ wire æ³¨å…¥ã€‚

**ç¬¬å››æ­¥**ï¼Œç¼–å†™ internal/service/student.go ä»£ç 

ä¸Šé¢é€šè¿‡ student.proto æ–‡ä»¶ç”Ÿæˆäº†ä¸€ä»½ service/student.go ä»£ç æ¨¡æ¿ï¼Œå…·ä½“ä»£ç è¿˜æ²¡æœ‰ç¼–å†™ï¼Œä¸‹é¢å°±æ¥ç¼–å†™ service ä»£ç ã€‚

    // å¼•å…¥ biz.StudentUsecase
    type StudentService struct {
    	pb.UnimplementedStudentServer
    
    	student *biz.StudentUsecase
    	log     *log.Helper
    }
    // åˆå§‹åŒ–
    func NewStudentService(stu *biz.StudentUsecase, logger log.Logger) *StudentService {
    	return &StudentService{
    		student: stu,
    		log:     log.NewHelper(logger),
    	}
    }
    // è·å–å­¦ç”Ÿä¿¡æ¯
    func (s *StudentService) GetStudent(ctx context.Context, req *pb.GetStudentRequest) (*pb.GetStudentReply, error) {
    	stu, err := s.student.Get(ctx, req.Id)
    
    	if err != nil {
    		return nil, err
    	}
    	return &pb.GetStudentReply{
    		Id:     stu.ID,
    		Status: stu.Status,
    		Name:   stu.Name,
    	}, nil
    }
    

### 4.5 ä¿®æ”¹é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶ student/configs/config.yamlã€‚

ä¿®æ”¹ mysql é…ç½®é¡¹ sourceï¼Œè¿™é‡Œ source è¦ä¿®æ”¹æˆ gorm çš„ dsn æ•°æ®æ ¼å¼ï¼Œdriver ä¸å˜ï¼Œ

    // https://gorm.io/zh_CN/docs/connecting_to_the_database.html#MySQL
    dsn := "user:pass@tcp(127.0.0.1:3306)/dbname?charset=utf8mb4&parseTime=True&loc=Local
    

    data:
      database:
        driver: mysql
        source: root:root@tcp(127.0.0.1:3306)/test?charset=utf8mb4&parseTime=True&loc=Local
    

æˆ‘ä½¿ç”¨çš„æ•°æ®åº“åå°±æ˜¯ testï¼Œæ‰€ä»¥å°±ä¸ç”¨ä¿®æ”¹æ•°æ®åº“åã€‚

æŠŠ server.http.addr ç«¯å£ä¿®æ”¹ä¸º 8000 -> 8080ã€‚

> å¦‚æœä¿®æ”¹äº† conf.protoï¼Œè¯·ä½¿ç”¨ `make config` å‘½ä»¤é‡æ–°ç”Ÿæˆ conf.pb.go æ–‡ä»¶ã€‚æˆ‘è¿™é‡Œæ²¡æœ‰ä¿®æ”¹ï¼Œå°±ä¸éœ€è¦é‡æ–°ç”Ÿæˆã€‚

### 4.6 é‡æ–°ç”Ÿæˆ wire\_gen.go æ–‡ä»¶

è¿›å…¥åˆ° cmd/student ç›®å½•ï¼Œç„¶åç”¨ `wire` å‘½ä»¤é‡æ–°ç”Ÿæˆ wire\_gen.goï¼Œ

    $ cd ./cmd/student
    $ wire
    wire: student/cmd/student: wrote D:\mygo\go-kratos-demos\student\cmd\student\wire_gen.go
    

äº”ã€æ•°æ®åº“
-----

åœ¨ mysql é‡Œåˆ›å»ºä¸€ä¸ªåä¸º test çš„æ•°æ®åº“ï¼Œç„¶åè¿è¡Œä¸‹é¢çš„ sqlï¼Œåˆ›å»ºæ•°æ®è¡¨ students :

    DROP TABLE IF EXISTS `students`;
    CREATE TABLE `students` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `name` varchar(255) CHARACTER SET latin1 DEFAULT NULL,
      `info` varchar(255) CHARACTER SET latin1 DEFAULT NULL,
      `updated_at` datetime DEFAULT NULL,
      `created_at` datetime DEFAULT NULL,
      `status` varchar(255) CHARACTER SET latin1 DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8mb4;
    
    -- ----------------------------
    -- Records of students
    -- ----------------------------
    INSERT INTO `students` VALUES ('1', 'tom', 'a top student', '2022-06-02 15:28:55', '2022-06-02 15:27:01', '1');
    INSERT INTO `students` VALUES ('3', 'jimmy', 'a good student', null, null, '0');
    INSERT INTO `students` VALUES ('4', 'you', 'fea tea', null, null, '1');
    INSERT INTO `students` VALUES ('6', 'ju', '', null, null, '1');
    

å…­ã€è¿è¡Œé¡¹ç›®
------

åœ¨ cmd/student ç›®å½•ï¼Œ è¿è¡Œå‘½ä»¤ `kratos run`

    $ kratos run
    INFO msg=config loaded: config.yaml format: yaml
    INFO msg=[gRPC] server listening on: [::]:9000
    INFO msg=[HTTP] server listening on: 127.0.0.1:8080
    

ä½¿ç”¨ curlie - [https://github.com/rs/curlie](https://github.com/rs/curlie) æµ‹è¯•ï¼š

    $ curlie  http://127.0.0.1:8080/student/1
    HTTP/1.1 200 OK
    {
        "name": "tom",
        "status": 1,
        "id": 1
    }
    Content-Type: application/json
    Date: Thu, 02 Jun 2022 08:04:49 GMT
    Content-Length: 32
    

æµ‹è¯•è¿”å›æˆåŠŸã€‚

å¥½äº†ï¼Œè·å–å­¦ç”Ÿä¿¡æ¯çš„ä»£ç å°±ç¼–å†™å®Œäº†ã€‚

å…¶ä½™éƒ¨åˆ†ï¼Œæ¯”å¦‚å¢åŠ ã€ä¿®æ”¹ç­‰ï¼Œè‡ªå·±å¯ä»¥è¯•ç€å†™ä¸€å†™ï¼Œç†Ÿèƒ½ç”Ÿå·§å˜›ã€‚

ä¸ƒã€é¡¹ç›®ä»£ç åœ°å€
--------

go-kratos student é¡¹ç›®æºä»£ç åœ°å€ï¼š

[go-kratos demoï¼šstudent](https://github.com/jiujuan/go-kratos-demos/tree/master/student)

ä¸Šé¢æ‰€æœ‰ä»£ç ä»¥ github ä¸Šçš„ä»£ç ä¸ºå‡†ã€‚

å…«ã€å‚è€ƒ
----

*   [https://go-kratos.dev/docs/getting-started/start](https://go-kratos.dev/docs/getting-started/start) kratos æ–°å»ºæ¨¡æ¿é¡¹ç›®
*   [https://go-kratos.dev/docs/getting-started/usage](https://go-kratos.dev/docs/getting-started/usage) kratos cli å·¥å…·
*   [https://gorm.io/zh\_CN/docs/connecting\_to\_the\_database.html#MySQL](https://gorm.io/zh_CN/docs/connecting_to_the_database.html#MySQL) gorm mysqlæ•°æ®åº“è¿æ¥
*   [https://gorm.io/zh\_CN/docs/query.html](https://gorm.io/zh_CN/docs/query.html) gorm æŸ¥è¯¢
*   [https://www.cnblogs.com/jiujuan/p/12676195.html](https://www.cnblogs.com/jiujuan/p/12676195.html) gorm åŸºæœ¬æ“ä½œ
*   [https://github.com/rs/curlie](https://github.com/rs/curlie) curlie http è¯·æ±‚

\== just do it ==