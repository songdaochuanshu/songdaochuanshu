---
layout: post
title: "K3Sç³»åˆ—æ–‡ç« -ä½¿ç”¨AutoK3såœ¨è…¾è®¯äº‘ä¸Šå®‰è£…é«˜å¯ç”¨K3Sé›†ç¾¤"
date: "2023-02-26T01:21:26.292Z"
---
K3Sç³»åˆ—æ–‡ç« -ä½¿ç”¨AutoK3såœ¨è…¾è®¯äº‘ä¸Šå®‰è£…é«˜å¯ç”¨K3Sé›†ç¾¤
================================

å¼€ç¯‡
--

*   ã€Š[K3s ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/K3S/)ã€‹
*   ã€Š[Rancher ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Rancher/)ã€‹

æ–¹æ¡ˆ
--

**åœ¨è…¾è®¯äº‘ä¸Šå®‰è£… K3S**

åç»­ä¼šåœ¨è¿™å¥— K3S é›†ç¾¤ä¸Šå®‰è£… Rancher

### æ–¹æ¡ˆç›®æ ‡

1.  é«˜å¯ç”¨
    1.  3 å°master çš„ k3s é›†ç¾¤
2.  æ•°æ®å¤‡ä»½
    1.  k3s æ•°æ®å¤‡ä»½åˆ° è…¾è®¯äº‘å¯¹è±¡å­˜å‚¨ cos
3.  å°½é‡å¤ç”¨å…¬æœ‰äº‘çš„èƒ½åŠ›
    1.  Tencent Cloud Controller Manager (âŒ å› ä¸ºè…¾è®¯äº‘å·²ç»æ”¾å¼ƒç»´æŠ¤ç›¸å…³æºç , æ‰€ä»¥æ— æ³•å¤ç”¨)
    2.  SVC LoadBalancer è°ƒç”¨ CLB (âŒ å› ä¸ºè…¾è®¯äº‘å·²ç»æ”¾å¼ƒç»´æŠ¤ç›¸å…³æºç , æ‰€ä»¥æ— æ³•å¤ç”¨)
    3.  å¤‡ä»½ - ä½¿ç”¨è…¾è®¯äº‘ COS

å‰ææ¡ä»¶
----

1.  æœ‰è…¾è®¯äº‘è´¦æˆ·ï¼Œè´¦æˆ·è‡³å°‘æ‹¥æœ‰å¦‚ä¸‹æƒé™ï¼š[auto k3s å®‰è£… - è®¾ç½® CAM](https://docs.rancher.cn/docs/k3s/autok3s/tencent/_index#%E8%AE%BE%E7%BD%AE-cam) ä»¥åŠè¿™äº›æƒé™:
    
    1.  `QcloudTAGFullAccess`
2.  è¯¥è…¾è®¯äº‘è´¦å·æœ‰å¯¹åº”çš„ API å¯†é’¥ï¼Œåœ°å€ï¼š[è®¿é—®å¯†é’¥ - æ§åˆ¶å° (tencent.com)](https://console.cloud.tencent.com/cam/capi) ï¼Œæˆ–è€…æ‹¥æœ‰ç›¸å…³æƒé™ï¼š`cam:QueryCollApiKey` å’Œ `cam:CreateCollApiKey`
    
3.  ä¸€å° linux æ“ä½œæœºï¼Œç”¨äºéƒ¨ç½² autok3s
    
4.  ä¸€ä¸ªå¯¹è±¡å­˜å‚¨é€š cosï¼Œç”¨äºå¤‡ä»½
    
5.  å·²æœ‰çš„é•œåƒä»“åº“çš„ä¸€äº›è´¦å·å¯†ç æˆ–è®¤è¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼šquayï¼Œdockerï¼Œè…¾è®¯äº‘ ï¼ˆç”¨äºåŠ é€Ÿ pull pushé•œåƒï¼‰
    
    > â„¹ï¸ **Info:**
    > 
    > è…¾è®¯äº‘ tcr å¹¿å· æä¾›å…è´¹ä¸ªäººç‰ˆå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨å¹¶æ·»åŠ ï¼š
    > 
    > [https://ccr.ccs.tencentyun.com](https://ccr.ccs.tencentyun.com)
    

K3S å®‰è£…æ³¨æ„äº‹é¡¹
----------

1.  [é€šè¿‡autok3séƒ¨ç½²](https://docs.rancher.cn/docs/k3s/autok3s/tencent/_index/)
2.  é€šè¿‡ autok3s å®‰è£…å, é»˜è®¤ k8s api é€šè¿‡ å…¬ç½‘ IP è¿›è¡Œé€šä¿¡, éœ€è¦è°ƒæ•´ systemd é…ç½®ä½¿å…¶é€šè¿‡å†…ç½‘è¿›è¡Œé€šä¿¡.
3.  âš ï¸ä»˜è´¹æ¨¡å¼ï¼Œå®‰è£…åå¯æ ¹æ®å…·ä½“æƒ…å†µåœ¨å°†ä»˜è´¹æ¨¡å¼æ§åˆ¶å°æ”¹ä¸ºï¼šåŒ…å¹´åŒ…æœˆ

K3S å®‰è£…å‚æ•°
--------

æœ¬æ¬¡ K3s å®‰è£…å‚æ•°å¦‚ä¸‹ï¼š

1.  Master `3`å°
2.  Worker: `0`
3.  Regionï¼šshanghai ï¼ˆ`ap-shanghai`ï¼‰
4.  zoneï¼šäºŒåŒºï¼ˆ`ap-shanghai-2`ï¼‰
5.  Instance Typeï¼š`S5.MEDIUM8`
6.  Image: `img-22trbn9x` (ubuntu 20.04)
7.  instanceChargeTypeï¼šé»˜è®¤åä»˜è´¹ï¼Œä¸”æ— æ³•è°ƒæ•´ã€‚âš ï¸å®‰è£…åæ§åˆ¶å°æ”¹ä¸ºï¼šPREPAID
8.  Disk: `CLOUD_SSD` (â„¹ï¸ `CLOUD_PREMIUM`(é«˜æ€§èƒ½äº‘ç›˜), `CLOUD_SSD`(SSDäº‘ç¡¬ç›˜))
9.  Disk Size: `50` G
10.  VPC ID: ç©ºï¼ˆautok3s ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
11.  Subnet ID: ç©ºï¼ˆautok3s ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
12.  Internet Max Bandwidth Outï¼š`5` (å¯ä»¥æŒ‰éœ€è°ƒå°)
13.  Security Group Idsï¼šç©º, è®© autok3s è‡ªåŠ¨åˆ›å»º, é›†ç¾¤åˆ›å»ºå¥½ä¹‹åå†è°ƒæ•´å®‰å…¨ç»„, ç¼©å°å…¥å£èŒƒå›´
14.  EIPï¼šæ˜¯å¦ä½¿ç”¨å¼¹æ€§å…¬ç½‘IP `false`
15.  Tags (è§ä¸‹æ–‡)
16.  K3s Version: `v1.21.7+k3s1`
17.  Cluster: `true`
18.  Master Extra Args: è§ä¸‹æ–‡
19.  Clusteræ¨¡å¼: `true`
20.  Registry(è§ä¸‹æ–‡)
21.  UIï¼š`true`

> âš ï¸ **Warning:**
> 
> æ‰§è¡Œ `autok3s` åˆ›å»ºå‰, å¦‚æœé€‰æ‹©å·²æœ‰çš„å®‰å…¨ç»„, é‚£ä¹ˆ CVM å®ä¾‹**è‡³å°‘**éœ€è¦åº”ç”¨ä»¥ä¸‹å®‰å…¨ç»„è§„åˆ™:
> 
>     Rule        Protocol    Port      Source             Description
>     InBound     TCP         22        ALL                SSH Connect Port
>     InBound     TCP         6443      K3s agent nodes    Kubernetes API
>     InBound     TCP         10250     K3s server & agent Kubelet
>     InBound     UDP         8472      K3s server & agent (Optional) Required only for Flannel VXLAN
>     InBound     TCP         2379,2380 K3s server nodes   (Optional) Required only for embedded ETCD
>     OutBound    ALL         ALL       ALL                Allow All
>     
> 
> ç‰¹åˆ«æ˜¯: 22 ç«¯å£å¿…é¡»è¦å¯¹æ“ä½œæœºçš„å…¬ç½‘IP å¼€æ”¾
> 
> åŸå› : autok3s è‡ªåŠ¨éƒ¨ç½²å…¬æœ‰äº‘æ—¶, é€šè¿‡å…¬ç½‘IP ä¸Šä¼  KeyPair, å¦‚æœæ²¡æœ‰ä»¥ä¸Šå®‰å…¨ç»„, `autok3s` ä¼šæ‰§è¡Œå¤±è´¥. æŠ¥é”™å¦‚ä¸‹: (`101.34.46.218` å°±æ˜¯å…¬ç½‘ IP)
> 
>     level=error msg="[ssh-dialer] init dialer [101.34.46.218:22] error: [tencent] calling getInstanceStatus error. region: ap-shanghai, zone: ap-shanghai-2, instanceName: [ins-ggxozpyl ins-cfi2vio1 ins-78rkem0b], message: not `RUNNING` status"
>     

å®‰è£…æ­¥éª¤
----

### AutoK3s

åœ¨æ“ä½œæœºä¸Šå®‰è£…ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š

    curl -sS http://rancher-mirror.cnrancher.com/autok3s/install.sh  | INSTALL_AUTOK3S_MIRROR=cn sh
    

è¿‡ç¨‹å¦‚ä¸‹ï¼š

    Downloading package http://rancher-mirror.rancher.cn/autok3s/v0.4.6/autok3s_linux_amd64 as /tmp/autok3s_linux_amd64
    Download complete.
    
    Running with sufficient permissions to attempt to move autok3s to /usr/local/bin
    New version of autok3s installed to /usr/local/bin
    Version: {"gitVersion":"v0.4.6","gitCommit":"4537e6ee2aea8b204a72f7b6c377edb154f7c058","gitTreeState":"","buildDate":"2021-12-28T04:15:30Z","goVersion":"go1.16.2","compiler":"gc","platform":"linux/amd64"}
    Downloading package http://rancher-mirror.rancher.cn/kube-explorer/v0.2.7/kube-explorer-linux-amd64 as /tmp/kube-explorer-linux-amd64
    Download complete.
    
    Running with sufficient permissions to attempt to move kube-explorer to /usr/local/bin
    New version of kube-explorer installed to /usr/local/bin
    Skipping /usr/local/bin/kubectl symlink to autok3s, already exists
    

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ CLI å‘½ä»¤å¯åŠ¨æœ¬åœ° UIã€‚

    autok3s serve --bind-address 0.0.0.0 --bind-port 8087
    

> âš ï¸ **Warning:**
> 
> é¡µé¢æ— ç™»å½•è®¤è¯ï¼Œç¡®ä¿æœ€å°æƒé™å¼€æ”¾ä»¥åŠç”¨å®ŒååŠæ—¶å…³é—­ã€‚

è¾“å‡ºå¦‚ä¸‹ï¼š

    INFO[0000] run as daemon, listening on 127.0.0.1:8087
    

è®¿é—® UIï¼š`http://<æ“ä½œæœºIP>:8087`

#### AutoK3s UI æ¨¡æ¿

å¦‚æœä»Šåè¦å¤šæ¬¡å®‰è£…ï¼Œå¯ä»¥åœ¨ UI ä¸Šåˆ›å»º**å¯å¤ç”¨**çš„æ¨¡æ¿ï¼Œæ¨¡æ¿åŒ…æ‹¬å¦‚ä¸‹å›ºå®šå‚æ•°ï¼š

1.  Credential Optionsï¼š
    
    1.  è…¾è®¯äº‘ Secret Id
    2.  è…¾è®¯äº‘ Secret Key
2.  Instance Options
    
    1.  Basic
        1.  Regionï¼š`ap-shanghai`
        2.  Zoneï¼š`ap-shanghai-2`
        3.  Instance Type: `S5.MEDIUM8`
        4.  Image: `img-22trbn9x` (ubuntu 20.04)
        5.  Disk Category: `CLOUD_SSD`
        6.  Disk Size: `50` G
    2.  Network
        1.  Internet Max Bandwidth Outï¼š`5`
        2.  EIP: `Disable`
        3.  âš ï¸ æ³¨æ„ï¼šå¦å¤– 3 ä¸ªå‚æ•°ï¼šVPC IDã€SubnetIDã€Security Group Ids æ¯æ¬¡åˆ›å»ºæ—¶éœ€è¦æŒ‰éœ€å¡«å†™æˆ–ç•™ç©º
    3.  SSH Public
        1.  SSH Userï¼š`ubuntu`
        2.  SSH Portï¼š`22`
        3.  Keypair Id : ç•™ç©º(âš ï¸ æ³¨æ„ï¼šå¦‚æœ Keypair Id ç•™ç©ºï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ Keypair)
    4.  SSH Private
        1.  SSH Agent Authï¼š`Disable`
        2.  SSH Key Path: ç•™ç©º(âš ï¸ æ³¨æ„ï¼šå¦‚æœä¸Šé¢é€‰æ‹©äº† Keypair Id, é‚£ä¹ˆå¯¹åº”çš„SSH Key Path ä¹Ÿè¦å¡«å†™)
    5.  Advance
        1.  æ‰“äº† 3 ä¸ª tagsï¼Œæ–¹ä¾¿åç»­ç®¡ç†ï¼š
            1.  `app=rancher`
            2.  `env=prod`
            3.  `provider=k3s`
3.  K3s Options
    
    1.  Basic
        
        1.  K3s Channel: `stable`
        2.  K3s Version: `v1.21.7+k3s1` (â„¹ï¸ Info: 202201 æ ¹æ® suse å®˜ç½‘é€‰å‹çš„æœ€æ–°ç¨³å®šç‰ˆï¼Œk3s v1.21.7+k3s1ï¼Œåé¢ä¼šæŒ‰éœ€è°ƒæ•´ç‰ˆæœ¬)
        3.  Clusterï¼š `Enable`(å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼Œä½¿ç”¨ etcd ç»„æˆé«˜å¯ç”¨é›†ç¾¤)
        4.  K3s Install Scriptï¼š`http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh`
    2.  Master
        
        1.  Master: `3`
            
        2.  Master Extra Argsï¼š
            
                --write-kubeconfig-mode "644" --pause-image registry.cn-hangzhou.aliyuncs.com/rancher/pause:3.6 --etcd-s3 --etcd-snapshot-schedule-cron 0 0 * * * --etcd-s3-endpoint cos.ap-shanghai.myqcloud.com --etcd-s3-access-key <your-cos-access-key> --etcd-s3-secret-key  <your-cos-secret-key> --etcd-s3-bucket  <your-cos-bucket> --etcd-s3-folder /rancher/k3s
                
            
    3.  Worker
        
        1.  Worker: `0`
    4.  Advance: ç•™ç©º
        
    5.  TLS Sans: ç•™ç©º (âš ï¸ å¦‚æœå‰é¢ä¼šä½¿ç”¨ CLB ä½œä¸ºè´Ÿè½½å‡è¡¡ï¼Œé‚£ä¹ˆå»ºè®®å¡«ä¸Š CLB VIP)
        
    6.  Registry, è§ä¸‹é¢`registries.yaml`
        
4.  Additional Options
    
    1.  UI: `explorer`

`registries.yaml`:

    mirrors:
      docker.io:
        endpoint:
          - "https://mirror.ccs.tencentyun.com"
          - "https://registry.cn-hangzhou.aliyuncs.com"
          - "https://docker.mirrors.ustc.edu.cn"
      quay.io:
        endpoint:
          - "https://mirror.ccs.tencentyun.com"    
    configs:
      'ccr.ccs.tencentyun.com':
        auth:
          username: <your-account-id>
          password: <your-registry-password>
    

#### AutoK3s é€šè¿‡ UI åˆ›å»º K3S é›†ç¾¤

è®¿é—® UI ç•Œé¢, ç‚¹å‡» _Quick Start_, _Provider_ é€‰æ‹© _tencent_;

ç„¶ååœ¨ä¸‹æ–¹å¡«å…¥è‡ªå®šä¹‰çš„ä¿¡æ¯, ä¸»è¦æ˜¯å¡«å†™ _Network_ çš„ä¿¡æ¯, å¦‚ä¸‹å›¾:

![](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230225174943483-1203545847.png)

ç‚¹å‡» _Create_, ç­‰å¾…è¿”å›ç»“æœå³å¯.

#### AutoK3s CLI å‘½ä»¤

æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹ CLI åœ¨ è…¾è®¯äº‘ä¸Šå¿«é€Ÿåˆ›å»ºä¸€ä¸ª 3 master, 0 worker èŠ‚ç‚¹çš„ K3s é«˜å¯ç”¨é›†ç¾¤ã€‚

    autok3s create --provider tencent --cluster --enable [ "explorer" ] --k3s-channel stable --k3s-install-mirror INSTALL_K3S_MIRROR=cn --k3s-install-script http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh --k3s-version v1.21.7+k3s1 --master 3 --master-extra-args '--write-kubeconfig-mode "644" --pause-image registry.cn-hangzhou.aliyuncs.com/rancher/pause:3.6 --etcd-s3 --etcd-snapshot-schedule-cron 0 0 * * * --etcd-s3-endpoint cos.ap-shanghai.myqcloud.com --etcd-s3-access-key <your-cos-access-key> --etcd-s3-secret-key <your-cos-secret-key> --etcd-s3-bucket <your-cos-bucket> --etcd-s3-folder /rancher/k3s' --name rancher-1 --ssh-port 22 --ssh-user ubuntu --tls-sans <your-clb-ip> --worker 0 --disk-category CLOUD_SSD --disk-size 50 --image img-22trbn9x --instance-type S5.MEDIUM8 --internet-max-bandwidth-out 5 --keypair-id <your-keypair-id> --region ap-shanghai --secret-id <your-tencent-secret-id> --secret-key <your-tencent-secret-key> --tags 'app=rancher' --tags 'env=prod' --tags 'provider=k3s' --zone ap-shanghai-2 --vpc <your-vpc-id> --subnet <your-subnet-id> --registry /etc/autok3s/registries.yaml
    

å®‰è£…æˆåŠŸæ—¥å¿—æ˜¾ç¤ºå¦‚ä¸‹:

    time="2022-02-12T14:52:16+08:00" level=info msg="[tencent] executing create logic..."
    INFO[0000] [tencent] use existing key pair 
    time="2022-02-12T14:52:16+08:00" level=info msg="[tencent] 3 masters and 0 workers will be added"
    time="2022-02-12T14:52:16+08:00" level=info msg="[tencent] check default security group autok3s in region ap-shanghai"
    time="2022-02-12T14:52:16+08:00" level=info msg="[tencent] create default security group autok3s in region ap-shanghai"
    time="2022-02-12T14:52:16+08:00" level=info msg="[tencent] check rules of security group autok3s"
    time="2022-02-12T14:52:18+08:00" level=info msg="[tencent] 3 number of master instances will be created"
    time="2022-02-12T14:52:23+08:00" level=info msg="[tencent] 3 number of master instances successfully created"
    time="2022-02-12T14:52:23+08:00" level=info msg="[tencent] waiting for the instances [ins-xxxxx] to be in `RUNNING` status..."
    time="2022-02-12T14:52:54+08:00" level=info msg="[tencent] instances [ins-xxxxx] are in `RUNNING` status"
    time="2022-02-12T14:52:54+08:00" level=info msg="[tencent] executing init k3s cluster logic..."
    time="2022-02-12T14:52:54+08:00" level=info msg="[tencent] creating k3s master-1..."
    mirrors:
        docker.io:
            endpoint:
                - https://mirror.ccs.tencentyun.com
                - https://registry.cn-hangzhou.aliyuncs.com
                - https://docker.mirrors.ustc.edu.cn
        quay.io:
            endpoint:
                - https://mirror.ccs.tencentyun.com
    configs:
        ccr.ccs.tencentyun.com:
            auth:
                username: 
                password: 
                auth: ""
                identity_token: ""
            tls: null
    auths: {}
    time="2022-02-12T14:53:26+08:00" level=info msg="[cluster] k3s master command: curl -sLS http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn K3S_TOKEN='xxxxxxx' INSTALL_K3S_EXEC='server  --tls-san xxxxx --tls-san xxxxxxxx --tls-san xxxxxxx --node-external-ip xxxxxx --write-kubeconfig-mode \"644\" --pause-image registry.cn-hangzhou.aliyuncs.com/rancher/pause:3.6 --disable-cloud-controller --cluster-cidr 10.42.0.0/16 --cluster-init' INSTALL_K3S_VERSION='v1.21.7+k3s1' sh -"
    [INFO]  Using v1.21.7+k3s1 as release
    [INFO]  Downloading hash http://rancher-mirror.cnrancher.com/k3s/v1.21.7-k3s1/sha256sum-amd64.txt
    [INFO]  Downloading binary http://rancher-mirror.cnrancher.com/k3s/v1.21.7-k3s1/k3s
    [INFO]  Verifying binary download
    [INFO]  Installing k3s to /usr/local/bin/k3s
    [INFO]  Creating /usr/local/bin/kubectl symlink to k3s
    [INFO]  Creating /usr/local/bin/crictl symlink to k3s
    [INFO]  Creating /usr/local/bin/ctr symlink to k3s
    [INFO]  Creating killall script /usr/local/bin/k3s-killall.sh
    [INFO]  Creating uninstall script /usr/local/bin/k3s-uninstall.sh
    [INFO]  env: Creating environment file /etc/systemd/system/k3s.service.env
    [INFO]  systemd: Creating service file /etc/systemd/system/k3s.service
    [INFO]  systemd: Enabling k3s unit
    [INFO]  systemd: Starting k3s
    time="2022-02-12T14:53:59+08:00" level=info msg="[tencent] successfully created k3s master-1"
    time="2022-02-12T14:53:59+08:00" level=info msg="[tencent] creating k3s master-2..."
    ...
    time="2022-02-12T14:54:35+08:00" level=info msg="[tencent] successfully created k3s master-2"
    time="2022-02-12T14:54:35+08:00" level=info msg="[tencent] creating k3s master-3..."
    ...
    time="2022-02-12T14:55:06+08:00" level=info msg="[tencent] successfully created k3s master-3"
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: ......
        server: https://127.0.0.1:6443
      name: default
    contexts:
    - context:
        cluster: default
        user: default
      name: default
    current-context: default
    kind: Config
    preferences: {}
    users:
    - name: default
      user:
        client-certificate-data: ......
        client-key-data: ......
    time="2022-02-12T14:55:06+08:00" level=info msg="[tencent] deploying additional manifests"
    time="2022-02-12T14:55:06+08:00" level=info msg="[tencent] successfully deployed additional manifests"
    time="2022-02-12T14:55:06+08:00" level=info msg="[tencent] successfully executed init k3s cluster logic"
    ---
    time="2022-02-12T14:55:07+08:00" level=info msg="[tencent] successfully deployed manifests"
    time="2022-02-12T14:55:07+08:00" level=info msg="=========================== Prompt Info ==========================="
    time="2022-02-12T14:55:07+08:00" level=info msg="Use 'autok3s kubectl config use-context prod-ha.ap-shanghai.tencent'"
    time="2022-02-12T14:55:07+08:00" level=info msg="Use 'autok3s kubectl get pods -A' get POD status`"
    
    

ğŸ‰ åˆ°è¿™é‡Œ, K3S é›†ç¾¤åˆ›å»ºå®Œæ¯•.

### K3s é…ç½®è°ƒæ•´

> ğŸš© **Important:**
> 
> å®‰è£…å, é»˜è®¤ k8s api é€šè¿‡ å…¬ç½‘ IP è¿›è¡Œé€šä¿¡, å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œå»ºè®®è°ƒæ•´ systemd é…ç½®ä½¿å…¶é€šè¿‡å†…ç½‘è¿›è¡Œé€šä¿¡.

æ­¥éª¤å¦‚ä¸‹:

ä¿®æ”¹åä¸¤å° master çš„ `/etc/systemd/system/k3s.service.env` çš„ `K3S_URL` ä¸ºç¬¬ä¸€å° master çš„å†…ç½‘åœ°å€

    K3S_URL=https://<master1-internal-ip>:6443
    

ç¬¬ä¸€å° master, ä¿®æ”¹ `/etc/systemd/system/k3s.service` , å¢åŠ :

            '--node-ip' \
            '<master1-internal-ip>' \
            '--advertise-address' \
            '<master1-internal-ip>' \
            
    

å¦å¤–2å°, å¢åŠ åŠä¿®æ”¹å¦‚ä¸‹:

            '--server' \
            'https://<master1-internal-ip>:6443' \
            ...
            '--node-ip' \
            '<other-master-internal-ip>' \
            '--advertise-address' \
            '<other-master-internal-ip>' \
            
    

é‡å¯ç”Ÿæ•ˆ:

    systemctl daemon-reload
    systemctl restart k3s.service
    

**éªŒè¯:**

æŸ¥çœ‹ `kubernetes` çš„ endpoint, ä»å…¬ç½‘åœ°å€å˜ä¸ºå†…ç½‘åœ°å€, å¦‚ä¸‹:

    apiVersion: v1
    kind: Endpoints
    metadata:
      name: kubernetes
      namespace: default
      ...
      labels:
        endpointslice.kubernetes.io/skip-mirror: 'true'
      managedFields:
        - manager: k3s
          operation: Update
          ...
      selfLink: /api/v1/namespaces/default/endpoints/kubernetes
    subsets:
      - addresses:
          - ip: <master2-internal-ip>
          - ip: <master1-internal-ip>
          - ip: <master3-internal-ip>
        ports:
          - name: https
            port: 6443
            protocol: TCP
    
    

æ”¶å°¾å·¥ä½œ
----

### è°ƒæ•´å®‰å…¨ç»„

å…¥ç«™è§„åˆ™:

1.  TCP:22(SSH) ç«¯å£æƒé™æ”¶ç´§
2.  TCP:6443(K8S API) ç«¯å£æƒé™æ”¶ç´§
3.  UDP:8472(K3s vxlan) åªå¼€æ”¾ç»™å†…ç½‘
4.  TCP:10250(kube api-server) åªå¼€æ”¾ç»™å†…ç½‘

æœ€ç»ˆæ•ˆæœå¦‚ä¸‹: (åº”è¯¥å¯ä»¥è¿›ä¸€æ­¥æ”¶ç´§)

![](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230225174943829-2128352449.png)

æ€»ç»“
--

ğŸ‰ğŸ‰ğŸ‰ è‡³æ­¤, å®Œæˆè…¾è®¯äº‘ä¸Š K3S é«˜å¯ç”¨é›†ç¾¤çš„æ­å»º, å¹¶é…ç½®å¤‡ä»½.

ä¸ºåé¢çš„ Rancher æ­å»ºåšå¥½äº†åŸºç¡€ã€‚

ä»¥ä¸‹æ˜¯å®‰è£…åçš„ç›¸å…³è¾“å‡ºä¿¡æ¯:

### K3s

1.  3 ä¸ª Master å’Œ Server hostnameã€å†…å¤–ç½‘IP
    
2.  K3S API Server åœ°å€ï¼š`https://<ä»¥ä¸Š6ä¸ªIPåœ°å€ä»»ä¸€ä¸ªæˆ–CLBçš„IP>:6443`
    
3.  K3S kubeconfig é…ç½®ï¼šä½äº k3s çš„`/etc/rancher/k3s/k3s.yaml` ä»¥åŠæ“ä½œæœºçš„ `/root/.autok3s/.kube/config`
    

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.