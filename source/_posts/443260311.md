---
layout: post
title: "CSAPP ä¹‹ BombLab è¯¦è§£"
date: "2022-05-14T10:21:33.071Z"
---
CSAPP ä¹‹ BombLab è¯¦è§£
==================

å‰è¨€
==

æœ¬ç¯‡åšå®¢å°†ä¼šå±•ç¤º CSAPP ä¹‹ BombLab çš„æ‹†å¼¹è¿‡ç¨‹ï¼Œç²‰ç¢ Dr.Evil çš„é‚ªæ¶é˜´è°‹ã€‚Dr.Evil çš„æ›¿èº«ï¼Œæ€æ‰‹çš‡åï¼Œæ€»å…±è®¾ç½®äº† 6 ä¸ªç‚¸å¼¹ï¼Œæ¯ä¸ªç‚¸å¼¹å¯¹åº”ä¸€ä¸²å­—ç¬¦ä¸²ï¼Œå¦‚æœå­—ç¬¦ä¸²é”™è¯¯ï¼Œç‚¸å¼¹å°±ä¼šè¢«å¼•çˆ†ğŸ’£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç‚¸å¼¹å¼•çˆ†](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220512203008230-1857082143.png)

å­—ç¬¦ä¸²çš„é•¿åº¦æœªçŸ¥ï¼Œæ‰€ä»¥æš´åŠ›ç ´è§£æ˜¯ä¸å¯å–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå®éªŒå°±æ˜¯è¦é€¼ç€æ‹†å¼¹å°åˆ†é˜Ÿå°† `bomb` å¯æ‰§è¡Œæ–‡ä»¶åæ±‡ç¼–ï¼Œæ ¹æ®æ±‡ç¼–ä»£ç æ¨æµ‹å‡ºæ¯ä¸ªç‚¸å¼¹å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚åœ¨ç»ˆç«¯è¾“å…¥ `objdump -d bomb > bomb.asm` ï¼Œå°±å¯ä»¥å°†æ±‡ç¼–ä»£ç å†™å…¥ `bomb.asm` æ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿åç»­åˆ†æã€‚åŒæ—¶ï¼ŒDr.Evil è¿˜æä¾›äº† `bomb.c` æºæ–‡ä»¶ï¼Œé€šè¿‡å®ƒå¯ä»¥çœ‹åˆ°ç‚¸å¼¹ç¨‹åºçš„ä¸»è¦ç»“æ„ï¼Œä»£ç å¦‚ä¸‹ï¼š

    /***************************************************************************
     * Dr. Evil's Insidious Bomb, Version 1.1
     * Copyright 2011, Dr. Evil Incorporated. All rights reserved.
     *
     * LICENSE:
     *
     * Dr. Evil Incorporated (the PERPETRATOR) hereby grants you (the
     * VICTIM) explicit permission to use this bomb (the BOMB).  This is a
     * time limited license, which expires on the death of the VICTIM.
     * The PERPETRATOR takes no responsibility for damage, frustration,
     * insanity, bug-eyes, carpal-tunnel syndrome, loss of sleep, or other
     * harm to the VICTIM.  Unless the PERPETRATOR wants to take credit,
     * that is.  The VICTIM may not distribute this bomb source code to
     * any enemies of the PERPETRATOR.  No VICTIM may debug,
     * reverse-engineer, run "strings" on, decompile, decrypt, or use any
     * other technique to gain knowledge of and defuse the BOMB.  BOMB
     * proof clothing may not be worn when handling this program.  The
     * PERPETRATOR will not apologize for the PERPETRATOR's poor sense of
     * humor.  This license is null and void where the BOMB is prohibited
     * by law.
     ***************************************************************************/
    
    #include <stdio.h>
    #include <stdlib.h>
    #include "support.h"
    #include "phases.h"
    
    /*
     * Note to self: Remember to erase this file so my victims will have no
     * idea what is going on, and so they will all blow up in a
     * spectaculary fiendish explosion. -- Dr. Evil
     */
    
    FILE *infile;
    
    int main(int argc, char *argv[])
    {
        char *input;
    
        /* Note to self: remember to port this bomb to Windows and put a
         * fantastic GUI on it. */
    
        /* When run with no arguments, the bomb reads its input lines
         * from standard input. */
        if (argc == 1) {
    	infile = stdin;
        }
    
        /* When run with one argument <file>, the bomb reads from <file>
         * until EOF, and then switches to standard input. Thus, as you
         * defuse each phase, you can add its defusing string to <file> and
         * avoid having to retype it. */
        else if (argc == 2) {
    	if (!(infile = fopen(argv[1], "r"))) {
    	    printf("%s: Error: Couldn't open %s\n", argv[0], argv[1]);
    	    exit(8);
    	}
        }
    
        /* You can't call the bomb with more than 1 command line argument. */
        else {
    	printf("Usage: %s [<input_file>]\n", argv[0]);
    	exit(8);
        }
    
        /* Do all sorts of secret stuff that makes the bomb harder to defuse. */
        initialize_bomb();
    
        printf("Welcome to my fiendish little bomb. You have 6 phases with\n");
        printf("which to blow yourself up. Have a nice day!\n");
    
        /* Hmm...  Six phases must be more secure than one phase! */
        input = read_line();             /* Get input                   */
        phase_1(input);                  /* Run the phase               */
        phase_defused();                 /* Drat!  They figured it out!
    				      * Let me know how they did it. */
        printf("Phase 1 defused. How about the next one?\n");
    
        /* The second phase is harder.  No one will ever figure out
         * how to defuse this... */
        input = read_line();
        phase_2(input);
        phase_defused();
        printf("That's number 2.  Keep going!\n");
    
        /* I guess this is too easy so far.  Some more complex code will
         * confuse people. */
        input = read_line();
        phase_3(input);
        phase_defused();
        printf("Halfway there!\n");
    
        /* Oh yeah?  Well, how good is your math?  Try on this saucy problem! */
        input = read_line();
        phase_4(input);
        phase_defused();
        printf("So you got that one.  Try this one.\n");
    
        /* Round and 'round in memory we go, where we stop, the bomb blows! */
        input = read_line();
        phase_5(input);
        phase_defused();
        printf("Good work!  On to the next...\n");
    
        /* This phase will never be used, since no one will get past the
         * earlier ones.  But just in case, make this one extra hard. */
        input = read_line();
        phase_6(input);
        phase_defused();
    
        /* Wow, they got it!  But isn't something... missing?  Perhaps
         * something they overlooked?  Mua ha ha ha ha! */
    
        return 0;
    }
    

ä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹è¿°æŒ‡ä»¤åœ¨ç»ˆç«¯æŸ¥çœ‹ `bomb.c`ï¼š

    $ gdb bomb
    (gdb) l
    

å¯ä»¥çœ‹åˆ°å…­ä¸ªç‚¸å¼¹åˆ†åˆ«å¯¹åº”ç€ `phase_1()` åˆ° `phase_6()` å‡½æ•°ï¼Œæœ‰äº†è¿™äº›ä¿¡æ¯å°±å¯ä»¥ç€æ‰‹åˆ†ææ±‡ç¼–ä»£ç äº†ã€‚

æ‹†å¼¹è¿‡ç¨‹
====

ç¬¬ä¸€ç‚¸å¼¹
----

åœ¨æ±‡ç¼–ä»£ç ä¸­æœç´¢ `phase_1`ï¼Œå¯ä»¥çœ‹åˆ° `phase_1` å…±å‡ºç°ä¸‰æ¬¡ï¼Œå·¦ä¾§æ˜¯ `phase_1()` è¢«è°ƒç”¨ï¼Œå³ä¾§æ˜¯ `phase_1()` çš„ä»£ç ï¼š

![phase_1 å‡ºç°çš„åœ°æ–¹](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220512205350003-937195641.png)

å¯ä»¥çœ‹åˆ° `phase_1` ä¸­æŠŠ `$0x402400` å†™åˆ°äº†å¯„å­˜å™¨ `%rsi` ä¸­ï¼Œæ¥ç€è°ƒç”¨äº† `strings_not_equal` å‡½æ•°ï¼Œç›¸å½“äº `strings_not_equal(%rdi, 0x402400)`ï¼Œå¦‚æœå­—ç¬¦ä¸²ä¸ç›¸ç­‰å³ `%rax` ä¸º 1 æ—¶ï¼Œç¬¬ä¸€ç‚¸å¼¹å°±ä¼šè¢«å¼•çˆ†ã€‚å®¹æ˜“çŒœåˆ° `0x402400` åº”è¯¥æ˜¯æ­£ç¡®å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œè€Œ `%rdi` ä¸­å­˜çš„åº”è¯¥æ˜¯æ‹†å¼¹å°åˆ†é˜Ÿè¾“å…¥çš„å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ã€‚å¯ä»¥ä½¿ç”¨ GDB æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªçŒœæƒ³ï¼š

![è¾“å…¥å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220512212725755-5466858.png)

å…ˆåœ¨ `phase_1` çš„ç¬¬ä¸‰è¡Œ `callq 401338 <strings_not_equal>` å¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åè¿è¡Œç¨‹åºå¹¶è¾“å…¥ `zhiyiYo`ï¼Œä½¿ç”¨ `display /x $rdi` æŸ¥çœ‹ `%rdi` çš„å€¼ `0x603780`ï¼Œæœ€åä½¿ç”¨ `x/8c 0x603780` æŸ¥çœ‹ä»è¯¥åœ°å€å¼€å§‹çš„8ä¸ªå­—ç¬¦ï¼Œå‘ç°å’Œæˆ‘ä»¬è¾“å…¥çš„ä¸€æ ·ï¼ˆå¤šäº†ç»“æŸç¬¦ï¼‰ï¼ŒéªŒè¯äº†ä¸Šè¿°çŒœæƒ³ã€‚

ç”±äºæˆ‘ä»¬è¿˜ä¸çŸ¥é“çœŸå®å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ŒåªçŸ¥é“å®ƒçš„èµ·å§‹åœ°å€æ˜¯ `0x402400`ï¼Œæ‰€ä»¥å¯ä»¥è¯•ä¸‹é•¿ä¸€ç‚¹çš„ï¼Œåªè¦çœ‹åˆ° `\000` å°±èƒ½è¯´æ˜å­—ç¬¦ä¸²ç»“æŸäº†ã€‚

    (gdb) x/64c 0x402400
    0x402400:       66 'B'  111 'o' 114 'r' 100 'd' 101 'e' 114 'r' 32 ' '  114 'r'
    0x402408:       101 'e' 108 'l' 97 'a'  116 't' 105 'i' 111 'o' 110 'n' 115 's'
    0x402410:       32 ' '  119 'w' 105 'i' 116 't' 104 'h' 32 ' '  67 'C'  97 'a'
    0x402418:       110 'n' 97 'a'  100 'd' 97 'a'  32 ' '  104 'h' 97 'a'  118 'v'
    0x402420:       101 'e' 32 ' '  110 'n' 101 'e' 118 'v' 101 'e' 114 'r' 32 ' '
    0x402428:       98 'b'  101 'e' 101 'e' 110 'n' 32 ' '  98 'b'  101 'e' 116 't'
    0x402430:       116 't' 101 'e' 114 'r' 46 '.'  0 '\000'        0 '\000'        0 '\000'        0 '\000'
    0x402438:       87 'W'  111 'o' 119 'w' 33 '!'  32 ' '  89 'Y'  111 'o' 117 'u'
    

å°†ä¸Šè¿°å­—ç¬¦è¿æ¥å¾—åˆ° `Border relations with Canada have never been better.`ï¼Œè¿™ä¸ªå°±æ˜¯ç¬¬ä¸€ç‚¸å¼¹çš„æ­£ç¡®ç­”æ¡ˆã€‚

![ç¬¬ä¸€ç‚¸å¼¹è¢«æ‹†é™¤](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220512233006351-933031003.png)

ç¬¬äºŒç‚¸å¼¹ â€”â€” æ¯èç©¿å¿ƒæ”»å‡»
--------------

`phase_2` çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

    0000000000400efc <phase_2>:
      400efc:	55                   	push   %rbp
      400efd:	53                   	push   %rbx
      400efe:	48 83 ec 28          	sub    $0x28,%rsp
      400f02:	48 89 e6             	mov    %rsp,%rsi
      400f05:	e8 52 05 00 00       	callq  40145c <read_six_numbers>
      400f0a:	83 3c 24 01          	cmpl   $0x1,(%rsp)
      400f0e:	74 20                	je     400f30 <phase_2+0x34>
      400f10:	e8 25 05 00 00       	callq  40143a <explode_bomb>
      400f15:	eb 19                	jmp    400f30 <phase_2+0x34>
      400f17:	8b 43 fc             	mov    -0x4(%rbx),%eax
      400f1a:	01 c0                	add    %eax,%eax
      400f1c:	39 03                	cmp    %eax,(%rbx)
      400f1e:	74 05                	je     400f25 <phase_2+0x29>
      400f20:	e8 15 05 00 00       	callq  40143a <explode_bomb>
      400f25:	48 83 c3 04          	add    $0x4,%rbx
      400f29:	48 39 eb             	cmp    %rbp,%rbx
      400f2c:	75 e9                	jne    400f17 <phase_2+0x1b>
      400f2e:	eb 0c                	jmp    400f3c <phase_2+0x40>
      400f30:	48 8d 5c 24 04       	lea    0x4(%rsp),%rbx
      400f35:	48 8d 6c 24 18       	lea    0x18(%rsp),%rbp
      400f3a:	eb db                	jmp    400f17 <phase_2+0x1b>
      400f3c:	48 83 c4 28          	add    $0x28,%rsp
      400f40:	5b                   	pop    %rbx
      400f41:	5d                   	pop    %rbp
      400f42:	c3                   	retq
    

å¯ä»¥çœ‹åˆ° `phase_2` æ˜¾ç¤ºè¿›è¡Œäº†è¢«è°ƒç”¨è€…ä¿æŠ¤ï¼Œç„¶åå°† `%rsp` æ ˆæŒ‡é’ˆå‡å° 28 ä»¥è…¾å‡ºç©ºé—´å¹¶å°† `%rsp` çš„å€¼èµ‹ç»™ `%rsi`ã€‚æ¥ç€è°ƒç”¨äº† `read_six_numbers` å‡½æ•°ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºè¿™ä¸ªå‡½æ•°åº”è¯¥ç”¨æ¥è¯»å…¥ 6 ä¸ªæ•°å­—ï¼Œå…·ä½“ä»£ç ä¸ºï¼š

    000000000040145c <read_six_numbers>:
      40145c:	48 83 ec 18          	sub    $0x18,%rsp
      401460:	48 89 f2             	mov    %rsi,%rdx
      401463:	48 8d 4e 04          	lea    0x4(%rsi),%rcx
      401467:	48 8d 46 14          	lea    0x14(%rsi),%rax
      40146b:	48 89 44 24 08       	mov    %rax,0x8(%rsp)
      401470:	48 8d 46 10          	lea    0x10(%rsi),%rax
      401474:	48 89 04 24          	mov    %rax,(%rsp)
      401478:	4c 8d 4e 0c          	lea    0xc(%rsi),%r9
      40147c:	4c 8d 46 08          	lea    0x8(%rsi),%r8
      401480:	be c3 25 40 00       	mov    $0x4025c3,%esi
      401485:	b8 00 00 00 00       	mov    $0x0,%eax
      40148a:	e8 61 f7 ff ff       	callq  400bf0 <__isoc99_sscanf@plt>
      40148f:	83 f8 05             	cmp    $0x5,%eax
      401492:	7f 05                	jg     401499 <read_six_numbers+0x3d>
      401494:	e8 a1 ff ff ff       	callq  40143a <explode_bomb>
      401499:	48 83 c4 18          	add    $0x18,%rsp
      40149d:	c3                   	retq
    

ä» `read_six_numbers` å¯ä»¥çœ‹å‡ºï¼Œ6ä¸ªæ•°å­—çš„åœ°å€åˆ†åˆ«ä¸º `%rsp`ã€`%rsp+0x4`ã€`%rsp+0x8`ã€`%rsp+0xc`ã€`%rsp+0x10` å’Œ`%rsp+0x14`ã€‚è°ƒç”¨å®Œ `read_six_numbers` ä¹‹åï¼Œ`phase_2` åˆå°† `(%rsp)` å’Œ `0x1` è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰å°±å¼•çˆ†ç¬¬äºŒç‚¸å¼¹ã€‚æ¥ä¸‹æ¥çš„ä»£ç å¯ä»¥ç¿»è¯‘ä¸ºï¼š

    rbx = rsp + 0x4;
    rbp = rsp + 0x18;
    while (rbx != rbp) {
        rax = 2 * M[rbx - 0x4];
        if (rax != M[rbx]) {
            explode_bomb();
        }
        rbx += 0x4;
    }
    

è¯´æ˜è¯»å…¥çš„ 6 ä¸ªæ•°å­—åº”è¯¥æ˜¯ä¸€ä¸ªç­‰æ¯”æ•°åˆ—ï¼Œä¸” `a[n] = 2*a[n-1]`ï¼Œç”±äº `(%rsp)` ä¸º 1ï¼Œåç»­çš„å‡ ä¸ªæ•°å­—å°±æ˜¯ 2ã€4ã€8ã€16 å’Œ 32ã€‚æµ‹è¯•ä¸€ä¸‹å‘ç°ç¬¬äºŒç‚¸å¼¹ç¡®å®è¢«æˆåŠŸæ‹†é™¤äº†ï¼š

![ç¬¬äºŒç‚¸å¼¹è¢«è§£é™¤](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220512232916552-829893125.png)

ç¬¬ä¸‰ç‚¸å¼¹ â€”â€” è´¥è€…é£Ÿå°˜
------------

`phase_3` çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

    0000000000400f43 <phase_3>:
      400f43:	48 83 ec 18          	sub    $0x18,%rsp
      400f47:	48 8d 4c 24 0c       	lea    0xc(%rsp),%rcx
      400f4c:	48 8d 54 24 08       	lea    0x8(%rsp),%rdx
      400f51:	be cf 25 40 00       	mov    $0x4025cf,%esi
      400f56:	b8 00 00 00 00       	mov    $0x0,%eax
      400f5b:	e8 90 fc ff ff       	callq  400bf0 <__isoc99_sscanf@plt>
      400f60:	83 f8 01             	cmp    $0x1,%eax
      400f63:	7f 05                	jg     400f6a <phase_3+0x27>
      400f65:	e8 d0 04 00 00       	callq  40143a <explode_bomb>
      400f6a:	83 7c 24 08 07       	cmpl   $0x7,0x8(%rsp)
      400f6f:	77 3c                	ja     400fad <phase_3+0x6a>
      400f71:	8b 44 24 08          	mov    0x8(%rsp),%eax
      400f75:	ff 24 c5 70 24 40 00 	jmpq   *0x402470(,%rax,8)
      400f7c:	b8 cf 00 00 00       	mov    $0xcf,%eax
      400f81:	eb 3b                	jmp    400fbe <phase_3+0x7b>
      400f83:	b8 c3 02 00 00       	mov    $0x2c3,%eax
      400f88:	eb 34                	jmp    400fbe <phase_3+0x7b>
      400f8a:	b8 00 01 00 00       	mov    $0x100,%eax
      400f8f:	eb 2d                	jmp    400fbe <phase_3+0x7b>
      400f91:	b8 85 01 00 00       	mov    $0x185,%eax
      400f96:	eb 26                	jmp    400fbe <phase_3+0x7b>
      400f98:	b8 ce 00 00 00       	mov    $0xce,%eax
      400f9d:	eb 1f                	jmp    400fbe <phase_3+0x7b>
      400f9f:	b8 aa 02 00 00       	mov    $0x2aa,%eax
      400fa4:	eb 18                	jmp    400fbe <phase_3+0x7b>
      400fa6:	b8 47 01 00 00       	mov    $0x147,%eax
      400fab:	eb 11                	jmp    400fbe <phase_3+0x7b>
      400fad:	e8 88 04 00 00       	callq  40143a <explode_bomb>
      400fb2:	b8 00 00 00 00       	mov    $0x0,%eax
      400fb7:	eb 05                	jmp    400fbe <phase_3+0x7b>
      400fb9:	b8 37 01 00 00       	mov    $0x137,%eax
      400fbe:	3b 44 24 0c          	cmp    0xc(%rsp),%eax
      400fc2:	74 05                	je     400fc9 <phase_3+0x86>
      400fc4:	e8 71 04 00 00       	callq  40143a <explode_bomb>
      400fc9:	48 83 c4 18          	add    $0x18,%rsp
      400fcd:	c3                   	retq
    

å¯ä»¥çœ‹åˆ° `phase_3` å…ˆè¯»å…¥äº†ä¸€ä¸ªæ•°å­—ï¼Œæ¥ç€è·³è½¬åˆ° `0x400f6a`ï¼Œ å°† `(%rsp + 0x8)` å’Œ `0x7` è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ¯”å®ƒå¤§å°±å¼•çˆ†ç‚¸å¼¹ï¼Œå…¶ä¸­ `(%rsp + 0x8)` çš„å€¼å°±æ˜¯æˆ‘ä»¬è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—ã€‚å¯ä»¥è¿è¡Œ GDB æ¥éªŒè¯ä¸€ä¸‹è¿™ä¸ªçŒœæƒ³ï¼Œå°†æ–­ç‚¹æ‰“åœ¨ `0x400f6a` å¤„ï¼Œå¯¹ç¬¬ä¸‰ç‚¸å¼¹è¾“å…¥ `8 9`ï¼Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç¬¬ä¸‰ç‚¸å¼¹å¼•çˆ†](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513103549080-709171178.png)

å¦‚æœè¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—å°äºç­‰äº 7ï¼Œå°±æš‚æ—¶ä¸ä¼šå¼•çˆ†ç‚¸å¼¹ã€‚æ¥ç€è¿è¡Œäº† `jmpq *0x402470(,%rax,8)` æŒ‡ä»¤ï¼Œè¿™ä¸ªæŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯è®©ç¨‹åºè·³è½¬åˆ° `M[0x402470 + %rax * 8]` å¤„ï¼Œæ­¤å¤„ `%rax` å°±æ˜¯è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—ï¼Œç”±äºæ¯ä¸ªåœ°å€ 64 ä½ä¸º 8 ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥å°† `%rax` ä¹˜ä¸Šäº† 8ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†è·³è½¬ä¹‹å‰ `%rax` çš„å€¼å’Œè·³è½¬è¡¨çš„ 8 ä¸ªåœ°å€ï¼š

![ç¬¬ä¸‰ç‚¸å¼¹è·³è½¬è¡¨](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513104636208-1863194096.png)

å¯ä»¥çœ‹åˆ°è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­— 0~7 åˆ†åˆ«å¯¹åº”ç€ï¼š`0x400f7c`ã€`0x400fb9`ã€`0x400f83`ã€`0x400f8a`ã€`0x400f91`ã€`0x400f98`ã€`0x400f9f` å’Œ `0x400fa6`ã€‚åœ¨ `phase_3` ä¸­ï¼Œä¸Šè¿°åœ°å€éƒ½æ˜¯ä¸€æ¡å¯¹ `%rax` è¿›è¡Œèµ‹å€¼çš„æŒ‡ä»¤ï¼Œèµ‹çš„å€¼çš„åè¿›åˆ¶ä¸º 207ã€311ã€707ã€256ã€389ã€206ã€682 å’Œ 327ã€‚æ¥ç€å°† `(%rsp + 0xc)` å’Œ `%rax` è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸ç›¸ç­‰å°±å¼•çˆ†ç‚¸å¼¹ï¼Œå¦åˆ™é€€å‡º `phase_3`ï¼Œè§£é™¤ç‚¸å¼¹ã€‚ä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸‰ç‚¸å¼¹çš„å‰ 2 ä¸ªæ•°å­—å¯¹åº”ç€ 8 ç§æ­£ç¡®ç­”æ¡ˆï¼ˆåé¢çš„å­—ç¬¦ä¸²å°±æ— æ‰€è°“äº†ï¼‰ï¼Œå½“å‰ä¸¤ä¸ªæ•°å­—ä¸º `1 311` æ—¶è¿è¡Œç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç¬¬ä¸‰ç‚¸å¼¹è¢«è§£é™¤](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513105531679-69721022.png)

ç¬¬å››ç‚¸å¼¹
----

`phase_4` çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š

    000000000040100c <phase_4>:
      40100c:	48 83 ec 18          	sub    $0x18,%rsp
      401010:	48 8d 4c 24 0c       	lea    0xc(%rsp),%rcx
      401015:	48 8d 54 24 08       	lea    0x8(%rsp),%rdx
      40101a:	be cf 25 40 00       	mov    $0x4025cf,%esi
      40101f:	b8 00 00 00 00       	mov    $0x0,%eax
      401024:	e8 c7 fb ff ff       	callq  400bf0 <__isoc99_sscanf@plt>
      401029:	83 f8 02             	cmp    $0x2,%eax
      40102c:	75 07                	jne    401035 <phase_4+0x29>
      40102e:	83 7c 24 08 0e       	cmpl   $0xe,0x8(%rsp)
      401033:	76 05                	jbe    40103a <phase_4+0x2e>
      401035:	e8 00 04 00 00       	callq  40143a <explode_bomb>
      40103a:	ba 0e 00 00 00       	mov    $0xe,%edx
      40103f:	be 00 00 00 00       	mov    $0x0,%esi
      401044:	8b 7c 24 08          	mov    0x8(%rsp),%edi
      401048:	e8 81 ff ff ff       	callq  400fce <func4>
      40104d:	85 c0                	test   %eax,%eax
      40104f:	75 07                	jne    401058 <phase_4+0x4c>
      401051:	83 7c 24 0c 00       	cmpl   $0x0,0xc(%rsp)
      401056:	74 05                	je     40105d <phase_4+0x51>
      401058:	e8 dd 03 00 00       	callq  40143a <explode_bomb>
      40105d:	48 83 c4 18          	add    $0x18,%rsp
      401061:	c3                   	retq
    

å¯ä»¥çœ‹åˆ°ï¼Œ`phase_4` è¯»å…¥äº†ä¸¤ä¸ªæ•°å­—ï¼ˆå¹¶ä¸”åªå…è®¸è¾“å…¥ä¸¤ä¸ªï¼‰ï¼Œç„¶ååˆ¤æ–­è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—æ˜¯å¦å°äºç­‰äº 14ï¼Œå¤§äº 14 å°±ä¼šå¼•çˆ†ç‚¸å¼¹ã€‚æ¥ç€è°ƒç”¨äº† `func4(è¾“å…¥çš„ç¬¬ä¸€ä¸ªæ•°å­—, 0, 14)` ã€‚ä» `func4()` è¿”å›ååˆ¤æ–­ `%eax` æ˜¯å¦ä¸º 0ï¼Œä¸ä¸º 0 å°±å¼•çˆ†ç‚¸å¼¹ï¼Œå¦‚æœ `(%rsp + 0xc)` ä¹Ÿå°±æ˜¯è¾“å…¥çš„ç¬¬äºŒä¸ªæ•°å­—ä¸ä¸º 0 ä¹Ÿä¼šå¼•çˆ†ç‚¸å¼¹ã€‚ä¸ºäº†é¡ºåˆ©æ‹†é™¤ç¬¬å››ç‚¸å¼¹ï¼Œæœ‰å¿…è¦åˆ†æä¸€ä¸‹ `func4` çš„æ‰§è¡Œæµç¨‹ã€‚

    0000000000400fce <func4>:
      400fce:	48 83 ec 08          	sub    $0x8,%rsp
      400fd2:	89 d0                	mov    %edx,%eax
      400fd4:	29 f0                	sub    %esi,%eax
      400fd6:	89 c1                	mov    %eax,%ecx
      400fd8:	c1 e9 1f             	shr    $0x1f,%ecx
      400fdb:	01 c8                	add    %ecx,%eax
      400fdd:	d1 f8                	sar    %eax
      400fdf:	8d 0c 30             	lea    (%rax,%rsi,1),%ecx
      400fe2:	39 f9                	cmp    %edi,%ecx
      400fe4:	7e 0c                	jle    400ff2 <func4+0x24>
      400fe6:	8d 51 ff             	lea    -0x1(%rcx),%edx
      400fe9:	e8 e0 ff ff ff       	callq  400fce <func4>
      400fee:	01 c0                	add    %eax,%eax
      400ff0:	eb 15                	jmp    401007 <func4+0x39>
      400ff2:	b8 00 00 00 00       	mov    $0x0,%eax
      400ff7:	39 f9                	cmp    %edi,%ecx
      400ff9:	7d 0c                	jge    401007 <func4+0x39>
      400ffb:	8d 71 01             	lea    0x1(%rcx),%esi
      400ffe:	e8 cb ff ff ff       	callq  400fce <func4>
      401003:	8d 44 00 01          	lea    0x1(%rax,%rax,1),%eax
      401007:	48 83 c4 08          	add    $0x8,%rsp
      40100b:	c3                   	retq
    

`func4` çš„æ“ä½œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç æ¥æè¿°ï¼š

    do {
        rsp -= 0x8;
        rax = rdx;
        rax -= rsi;
        
        // æ¥ä¸‹æ¥çš„ä¸‰è¡Œä»£ç æ„Ÿè§‰æ²¡å•¥å¤§ç”¨ï¼Œå› ä¸ºæ­£æ•°é€»è¾‘å³ç§» 31 ä½ä¹‹åä¸€å®šä¸º 0
        rcx = rax;
        rcx >>= 31 // æ­¤å¤„ä¸ºé€»è¾‘å³ç§»
        rax += rcx;
        
        rax >>= 1; // rax = rax / 2
        rcx = rax + rsi;
        
        if (rcx <= rdi) {
            rax = 0;
            
            // å…¶å®å°±æ˜¯ä¸¤ä¸ªç›¸ç­‰
            if (rcx >= rdi) {
                rsp += 0x8;
                continue;
            }
            
            rsi = rcx + 1;
            // ä¸‹é¢è¿™æ¡è¯­å¥åº”è¯¥åœ¨ rsp -= 0x8 åæ‰§è¡Œ
            // M[rsp] = 0x401003;
        } else {
            rdx = rcx - 1;
            // ä¸‹é¢è¿™æ¡è¯­å¥åº”è¯¥åœ¨ rsp -= 0x8 åæ‰§è¡Œ
            // M[rsp] = 0x400fee;
        }
        
    } while (rsp != 0x40104d)
    

æœ‰ä¸Šè¿°ä¼ªä»£ç å¯ä»¥çœ‹åˆ°ï¼Œè¦æƒ³è¿”å›çš„æ—¶å€™ `%rax` ä¸º 0ï¼Œå°±ä¸€å®šä¸èƒ½èµ°åˆ°ç¬¬ 23 è¡Œï¼Œä¸ç„¶æ‰§è¡Œå®Œ `retq` è¯­å¥åä¼šå°† `M[%rsp]` çš„å€¼ä¹Ÿå°±æ˜¯ `0x401003` é€åˆ° `%rip`ï¼Œç¨‹åºè·³åˆ° `lea 0x1(%rcx),%esi` ç»§ç»­æ‰§è¡Œï¼Œä¹‹å `%rax` ä¸å¯èƒ½å˜æˆ 0ã€‚åœ¨ç¬¬ 23 è¡Œæ²¡è¢«æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œ`%rsi` çš„å€¼ä¸€ç›´éƒ½æ˜¯ 0ï¼Œ`%rcx` çš„å€¼å¯ä»¥ä¸ºä¸‹é¢å‡ ç§ï¼š

*   14/2 = 7ï¼Œå½“ `%rdi = 7` æ—¶å¯ä»¥ç›´æ¥è¿”å› `phase_4` å¹¶è§£é™¤ç‚¸å¼¹
*   (7 - 1) / 2 = 3ï¼Œå½“ `%rdi = 3` æ—¶ä¼šè·³åˆ° `add %eax,%eax` 1 æ¬¡æ‰è¿”å› `phase_4` å¹¶è§£é™¤ç‚¸å¼¹
*   (3 - 1) / 2 = 1ï¼Œå½“ `%rdi = 1` æ—¶ä¼šè·³åˆ° `add %eax,%eax` 2 æ¬¡æ‰è¿”å› `phase_4` å¹¶è§£é™¤ç‚¸å¼¹
*   (1 - 1) / 2 = 0ï¼Œå½“ `%rdi = 0` æ—¶ä¼šè·³åˆ° `add %eax,%eax` 3 æ¬¡æ‰è¿”å› `phase_4` å¹¶è§£é™¤ç‚¸å¼¹

æ¥æµ‹è¯•ä¸€ä¸‹æœ€åä¸€ç§æƒ…å†µï¼Œå› ä¸ºå®ƒæœ€å¤æ‚ï¼š

    (gdb) b *0x40100b
    Breakpoint 1 at 0x40100b
    (gdb) r
    Starting program: /home/zhiyiyo/Documents/CSAPP/bomblab/bomb 
    Welcome to my fiendish little bomb. You have 6 phases with
    which to blow yourself up. Have a nice day!
    Border relations with Canada have never been better.
    Phase 1 defused. How about the next one?
    1 2 4 8 16 32
    That's number 2.  Keep going!
    0 207
    Halfway there!
    0 0
    
    Breakpoint 1, 0x000000000040100b in func4 ()
    (gdb) disassemble
    Dump of assembler code for function func4:
       0x0000000000400fce <+0>:     sub    $0x8,%rsp
       0x0000000000400fd2 <+4>:     mov    %edx,%eax
       0x0000000000400fd4 <+6>:     sub    %esi,%eax
       0x0000000000400fd6 <+8>:     mov    %eax,%ecx
       0x0000000000400fd8 <+10>:    shr    $0x1f,%ecx
       0x0000000000400fdb <+13>:    add    %ecx,%eax
       0x0000000000400fdd <+15>:    sar    %eax
       0x0000000000400fdf <+17>:    lea    (%rax,%rsi,1),%ecx
       0x0000000000400fe2 <+20>:    cmp    %edi,%ecx
       0x0000000000400fe4 <+22>:    jle    0x400ff2 <func4+36>
       0x0000000000400fe6 <+24>:    lea    -0x1(%rcx),%edx
       0x0000000000400fe9 <+27>:    callq  0x400fce <func4>
       0x0000000000400fee <+32>:    add    %eax,%eax
       0x0000000000400ff0 <+34>:    jmp    0x401007 <func4+57>
       0x0000000000400ff2 <+36>:    mov    $0x0,%eax
       0x0000000000400ff7 <+41>:    cmp    %edi,%ecx
       0x0000000000400ff9 <+43>:    jge    0x401007 <func4+57>
       0x0000000000400ffb <+45>:    lea    0x1(%rcx),%esi
       0x0000000000400ffe <+48>:    callq  0x400fce <func4>
       0x0000000000401003 <+53>:    lea    0x1(%rax,%rax,1),%eax
       0x0000000000401007 <+57>:    add    $0x8,%rsp
    => 0x000000000040100b <+61>:    retq   
    End of assembler dump.
    (gdb) si
    0x0000000000400fee in func4 ()
    (gdb) disassemble
    Dump of assembler code for function func4:
       0x0000000000400fce <+0>:     sub    $0x8,%rsp
       0x0000000000400fd2 <+4>:     mov    %edx,%eax
       0x0000000000400fd4 <+6>:     sub    %esi,%eax
       0x0000000000400fd6 <+8>:     mov    %eax,%ecx
       0x0000000000400fd8 <+10>:    shr    $0x1f,%ecx
       0x0000000000400fdb <+13>:    add    %ecx,%eax
       0x0000000000400fdd <+15>:    sar    %eax
       0x0000000000400fdf <+17>:    lea    (%rax,%rsi,1),%ecx
       0x0000000000400fe2 <+20>:    cmp    %edi,%ecx
       0x0000000000400fe4 <+22>:    jle    0x400ff2 <func4+36>
       0x0000000000400fe6 <+24>:    lea    -0x1(%rcx),%edx
       0x0000000000400fe9 <+27>:    callq  0x400fce <func4>
    => 0x0000000000400fee <+32>:    add    %eax,%eax
       0x0000000000400ff0 <+34>:    jmp    0x401007 <func4+57>
       0x0000000000400ff2 <+36>:    mov    $0x0,%eax
       0x0000000000400ff7 <+41>:    cmp    %edi,%ecx
       0x0000000000400ff9 <+43>:    jge    0x401007 <func4+57>
       0x0000000000400ffb <+45>:    lea    0x1(%rcx),%esi
       0x0000000000400ffe <+48>:    callq  0x400fce <func4>
       0x0000000000401003 <+53>:    lea    0x1(%rax,%rax,1),%eax
       0x0000000000401007 <+57>:    add    $0x8,%rsp
       0x000000000040100b <+61>:    retq   
    End of assembler dump.
    (gdb) c
    Continuing.
    
    Breakpoint 1, 0x000000000040100b in func4 ()
    (gdb) c
    Continuing.
    
    Breakpoint 1, 0x000000000040100b in func4 ()
    (gdb) c
    Continuing.
    
    Breakpoint 1, 0x000000000040100b in func4 ()
    (gdb) c
    Continuing.
    So you got that one.  Try this one.
    

å¯ä»¥çœ‹åˆ°å½“è¾“å…¥çš„ç¬¬ä¸€æ•°å­—ä¸º 0 æ—¶ï¼Œç¡®å®è·³è½¬åˆ° `add %eax,%eax` æ‰èƒ½è¿”å›ï¼Œæœ€ç»ˆç¬¬å››ç‚¸å¼¹è¢«æˆåŠŸæ‹†é™¤ã€‚

ç¬¬äº”ç‚¸å¼¹
----

`phase_5` çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

    0000000000401062 <phase_5>:
      401062:	53                   	push   %rbx
      401063:	48 83 ec 20          	sub    $0x20,%rsp
      401067:	48 89 fb             	mov    %rdi,%rbx
      40106a:	64 48 8b 04 25 28 00 	mov    %fs:0x28,%rax
      401071:	00 00
      401073:	48 89 44 24 18       	mov    %rax,0x18(%rsp)
      401078:	31 c0                	xor    %eax,%eax
      40107a:	e8 9c 02 00 00       	callq  40131b <string_length>
      40107f:	83 f8 06             	cmp    $0x6,%eax
      401082:	74 4e                	je     4010d2 <phase_5+0x70>
      401084:	e8 b1 03 00 00       	callq  40143a <explode_bomb>
      401089:	eb 47                	jmp    4010d2 <phase_5+0x70>
      40108b:	0f b6 0c 03          	movzbl (%rbx,%rax,1),%ecx
      40108f:	88 0c 24             	mov    %cl,(%rsp)
      401092:	48 8b 14 24          	mov    (%rsp),%rdx
      401096:	83 e2 0f             	and    $0xf,%edx
      401099:	0f b6 92 b0 24 40 00 	movzbl 0x4024b0(%rdx),%edx
      4010a0:	88 54 04 10          	mov    %dl,0x10(%rsp,%rax,1)
      4010a4:	48 83 c0 01          	add    $0x1,%rax
      4010a8:	48 83 f8 06          	cmp    $0x6,%rax
      4010ac:	75 dd                	jne    40108b <phase_5+0x29>
      4010ae:	c6 44 24 16 00       	movb   $0x0,0x16(%rsp)
      4010b3:	be 5e 24 40 00       	mov    $0x40245e,%esi
      4010b8:	48 8d 7c 24 10       	lea    0x10(%rsp),%rdi
      4010bd:	e8 76 02 00 00       	callq  401338 <strings_not_equal>
      4010c2:	85 c0                	test   %eax,%eax
      4010c4:	74 13                	je     4010d9 <phase_5+0x77>
      4010c6:	e8 6f 03 00 00       	callq  40143a <explode_bomb>
      4010cb:	0f 1f 44 00 00       	nopl   0x0(%rax,%rax,1)
      4010d0:	eb 07                	jmp    4010d9 <phase_5+0x77>
      4010d2:	b8 00 00 00 00       	mov    $0x0,%eax
      4010d7:	eb b2                	jmp    40108b <phase_5+0x29>
      4010d9:	48 8b 44 24 18       	mov    0x18(%rsp),%rax
      4010de:	64 48 33 04 25 28 00 	xor    %fs:0x28,%rax
      4010e5:	00 00
      4010e7:	74 05                	je     4010ee <phase_5+0x8c>
      4010e9:	e8 42 fa ff ff       	callq  400b30 <__stack_chk_fail@plt>
      4010ee:	48 83 c4 20          	add    $0x20,%rsp
      4010f2:	5b                   	pop    %rbx
      4010f3:	c3                   	retq
    

å¯ä»¥çœ‹åˆ° `phase_5` å¼€å¯äº†é‡‘ä¸é›€ä¿æŠ¤æœºåˆ¶ï¼Œç”¨äºé˜²èŒƒç¼“å†²åŒºæº¢å‡ºå¯èƒ½é€ æˆçš„å®‰å…¨é—®é¢˜ã€‚æ¥ç€åˆ¤æ–­è¾“å…¥çš„å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¦‚æœä¸ä¸º 6 å°±å¼•çˆ†ç‚¸å¼¹ã€‚æ¥ä¸‹æ¥çš„ä»£ç å¯ä»¥ç¿»è¯‘ä¸ºï¼š

    rbx = rdi; // %rdi ä¿å­˜äº†è¾“å…¥çš„å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€
    for (rax = 0; rax < 6; rax++) {
        rcx = M[rbx + rax];
        M[rsp] = cl;	// %rcx ä½å…«ä½ï¼Œå°†å€¼é™åˆ¶åœ¨ 0~255 ä¹‹é—´
        rdx = M[rsp];
        rdx &= 0xF;		// å°† %rdx çš„å€¼é™åˆ¶åœ¨ 0~15 ä¹‹é—´
        rdx = M[rdx + 0x4024b0];
        M[rsp + rax + 0x10] = dl; // %rdx çš„ä½å…«ä½
    }
    
    M[rsp + 0x16] = 0;
    rsi = 0x40245e;
    rdi = rsp + 0x10;
    if (strings_not_equal(rdi, rsi)) {
        explode_bomb()
    }
    

æ ¹æ®ç¬¬ä¸€ç‚¸å¼¹çš„å¥—è·¯ï¼Œ`%rsi` ä¸­å­˜çš„åº”è¯¥æ˜¯æ­£ç¡®å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œç”±äºå­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 6ï¼Œæ‰€ä»¥ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç¬¬å››ç‚¸å¼¹çš„](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513190748806-795759589.png)

å¯ä»¥çœ‹åˆ°å­—ç¬¦ä¸²æ˜¯ `flyers`ï¼Œå½“ç„¶ç¬¬äº”ç‚¸å¼¹å¯èƒ½æ²¡æœ‰ç¬¬ä¸€ç‚¸å¼¹é‚£ä¹ˆç®€å•ï¼Œç›´æ¥å°† `flyers` è¾“åˆ°ç»ˆç«¯å°±ä¼å›¾è§£é™¤ç‚¸å¼¹åªä¼šæ— åŠŸè€Œè¿”ï¼Œæ¯•ç«Ÿåœ¨ `strings_not_equal` ä¹‹å‰è¿˜æœ‰ä¸€æ®µå¹²äº†è„æ´»çš„ä»£ç ã€‚å†æ¥è®¤çœŸåˆ†æä¸€ä¸‹ for å¾ªç¯é‡Œé¢éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚

ç”±äº `%rdx` ä¿å­˜äº†è¾“å…¥çš„å­—ç¬¦ä¸²çš„èµ·å§‹åœ°å€ï¼Œæ‰€ä»¥ `M[rbx + rax]` å–å‡ºäº†å­—ç¬¦ä¸²çš„ä¸€ä¸ªå­—ç¬¦ï¼Œåªç•™ä¸‹å­—ç¬¦çš„ä½ 8 ä½å¹¶èµ‹å€¼ç»™ `%rdx`ã€‚`%rdx` æ›´è¿›ä¸€æ­¥ï¼Œåªç•™ä¸‹äº†ä½å››ä½ï¼ˆå–å€¼èŒƒå›´ 0~15ï¼‰ã€‚ä¹‹å `rdx = M[rdx + 0x4024b0]` ä»¥ `0x4024b0` ä¸ºåŸºåœ°å€ï¼ŒåŠ ä¸Š 0~15 çš„åç§»é‡ï¼Œä»å†…å­˜ä¸­å–å‡ºäº†ä¸€ä¸ªå­—ç¬¦å¹¶èµ‹ç»™ `%rdx`ã€‚æœ€åæŠŠ `%rdx` çš„ä½ 8 ä½èµ‹å€¼ç»™ `M[rsp + rax + 0x10]`ï¼Œç”±äºå¾ªç¯è¿›è¡Œäº† 6 æ¬¡ï¼Œæ‰€ä»¥ `strings_not_equal` æ˜¯å°† `%rsp + 0x10` åˆ° `%rsp + 0x15` ç»„æˆçš„å­—ç¬¦ä¸²å’Œ `flyers` è¿›è¡Œæ¯”è¾ƒã€‚

ä¸‹å›¾æ˜¾ç¤ºäº† `0x4024b0` å¼€å§‹çš„ 16 ä¸ªï¼ˆ `rdx &= 0xF` ï¼‰å­—ç¬¦ï¼Œé‡Œé¢å‡ºç°äº† `flyers` æ‰€éœ€çš„ 6 ä¸ªå­—æ¯ï¼š

![0x4024b0 å¼€å§‹çš„ 16 ä¸ªå­—ç¬¦](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513192130093-428319876.png)

åªè¦è®©ç»™ 0x4024b0 åŠ ä¸Š 9 å°±èƒ½å–åˆ° fï¼Œæ‰€ä»¥å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦åº”è¯¥æ˜¯ 9ã€‚è€Œä¸ºäº†å–åˆ° lï¼Œæˆ‘ä»¬åº”è¯¥ç»™ 0x4024b0 åŠ ä¸Š 15ï¼Œä½†æ˜¯è¿™é‡Œå¯¹åº”çš„å­—ç¬¦å°±ä¸è¯¥æ˜¯ 15 çš„åå…­è¿›åˆ¶ Fï¼Œè€Œåº”è¯¥æ˜¯ä½å››ä½å…¨ä¸º 1 çš„æŸä¸ªå­—ç¬¦ï¼Œå­—ç¬¦ `?` çš„çš„äºŒè¿›åˆ¶å€¼ä¸º `0b11111`ï¼Œæ»¡è¶³ä½å››ä½å…¨ 1 çš„æ¡ä»¶ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²çš„ç¬¬äºŒä½å– `?`ã€‚æ ¹æ®è¿™ä¸ªåŸç†å¯ä»¥åˆ†åˆ«ç¡®å®šå‡ºåé¢å‡ ä¸ªå­—ç¬¦ä¸º `>567`ï¼Œæœ€ç»ˆç»“æœæ˜¯ `9?>567`ã€‚

![ç¬¬äº”ç‚¸å¼¹è¢«æ‹†é™¤](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513192928431-393734993.png)

ç¬¬å…­ç‚¸å¼¹
----

`phase_6` çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š

    00000000004010f4 <phase_6>:
      4010f4:	41 56                	push   %r14
      4010f6:	41 55                	push   %r13
      4010f8:	41 54                	push   %r12
      4010fa:	55                   	push   %rbp
      4010fb:	53                   	push   %rbx
      4010fc:	48 83 ec 50          	sub    $0x50,%rsp
      401100:	49 89 e5             	mov    %rsp,%r13
      401103:	48 89 e6             	mov    %rsp,%rsi
      401106:	e8 51 03 00 00       	callq  40145c <read_six_numbers>
      40110b:	49 89 e6             	mov    %rsp,%r14
      40110e:	41 bc 00 00 00 00    	mov    $0x0,%r12d
      401114:	4c 89 ed             	mov    %r13,%rbp
      401117:	41 8b 45 00          	mov    0x0(%r13),%eax
      40111b:	83 e8 01             	sub    $0x1,%eax
      40111e:	83 f8 05             	cmp    $0x5,%eax
      401121:	76 05                	jbe    401128 <phase_6+0x34>
      401123:	e8 12 03 00 00       	callq  40143a <explode_bomb>
      401128:	41 83 c4 01          	add    $0x1,%r12d
      40112c:	41 83 fc 06          	cmp    $0x6,%r12d
      401130:	74 21                	je     401153 <phase_6+0x5f>
      401132:	44 89 e3             	mov    %r12d,%ebx
      401135:	48 63 c3             	movslq %ebx,%rax
      401138:	8b 04 84             	mov    (%rsp,%rax,4),%eax
      40113b:	39 45 00             	cmp    %eax,0x0(%rbp)
      40113e:	75 05                	jne    401145 <phase_6+0x51>
      401140:	e8 f5 02 00 00       	callq  40143a <explode_bomb>
      401145:	83 c3 01             	add    $0x1,%ebx
      401148:	83 fb 05             	cmp    $0x5,%ebx
      40114b:	7e e8                	jle    401135 <phase_6+0x41>
      40114d:	49 83 c5 04          	add    $0x4,%r13
      401151:	eb c1                	jmp    401114 <phase_6+0x20>
      401153:	48 8d 74 24 18       	lea    0x18(%rsp),%rsi
      401158:	4c 89 f0             	mov    %r14,%rax
      40115b:	b9 07 00 00 00       	mov    $0x7,%ecx
      401160:	89 ca                	mov    %ecx,%edx
      401162:	2b 10                	sub    (%rax),%edx
      401164:	89 10                	mov    %edx,(%rax)
      401166:	48 83 c0 04          	add    $0x4,%rax
      40116a:	48 39 f0             	cmp    %rsi,%rax
      40116d:	75 f1                	jne    401160 <phase_6+0x6c>
      40116f:	be 00 00 00 00       	mov    $0x0,%esi
      401174:	eb 21                	jmp    401197 <phase_6+0xa3>
      401176:	48 8b 52 08          	mov    0x8(%rdx),%rdx
      40117a:	83 c0 01             	add    $0x1,%eax
      40117d:	39 c8                	cmp    %ecx,%eax
      40117f:	75 f5                	jne    401176 <phase_6+0x82>
      401181:	eb 05                	jmp    401188 <phase_6+0x94>
      401183:	ba d0 32 60 00       	mov    $0x6032d0,%edx
      401188:	48 89 54 74 20       	mov    %rdx,0x20(%rsp,%rsi,2)
      40118d:	48 83 c6 04          	add    $0x4,%rsi
      401191:	48 83 fe 18          	cmp    $0x18,%rsi
      401195:	74 14                	je     4011ab <phase_6+0xb7>
      401197:	8b 0c 34             	mov    (%rsp,%rsi,1),%ecx
      40119a:	83 f9 01             	cmp    $0x1,%ecx
      40119d:	7e e4                	jle    401183 <phase_6+0x8f>
      40119f:	b8 01 00 00 00       	mov    $0x1,%eax
      4011a4:	ba d0 32 60 00       	mov    $0x6032d0,%edx
      4011a9:	eb cb                	jmp    401176 <phase_6+0x82>
      4011ab:	48 8b 5c 24 20       	mov    0x20(%rsp),%rbx
      4011b0:	48 8d 44 24 28       	lea    0x28(%rsp),%rax
      4011b5:	48 8d 74 24 50       	lea    0x50(%rsp),%rsi
      4011ba:	48 89 d9             	mov    %rbx,%rcx
      4011bd:	48 8b 10             	mov    (%rax),%rdx
      4011c0:	48 89 51 08          	mov    %rdx,0x8(%rcx)
      4011c4:	48 83 c0 08          	add    $0x8,%rax
      4011c8:	48 39 f0             	cmp    %rsi,%rax
      4011cb:	74 05                	je     4011d2 <phase_6+0xde>
      4011cd:	48 89 d1             	mov    %rdx,%rcx
      4011d0:	eb eb                	jmp    4011bd <phase_6+0xc9>
      4011d2:	48 c7 42 08 00 00 00 	movq   $0x0,0x8(%rdx)
      4011d9:	00
      4011da:	bd 05 00 00 00       	mov    $0x5,%ebp
      4011df:	48 8b 43 08          	mov    0x8(%rbx),%rax
      4011e3:	8b 00                	mov    (%rax),%eax
      4011e5:	39 03                	cmp    %eax,(%rbx)
      4011e7:	7d 05                	jge    4011ee <phase_6+0xfa>
      4011e9:	e8 4c 02 00 00       	callq  40143a <explode_bomb>
      4011ee:	48 8b 5b 08          	mov    0x8(%rbx),%rbx
      4011f2:	83 ed 01             	sub    $0x1,%ebp
      4011f5:	75 e8                	jne    4011df <phase_6+0xeb>
      4011f7:	48 83 c4 50          	add    $0x50,%rsp
      4011fb:	5b                   	pop    %rbx
      4011fc:	5d                   	pop    %rbp
      4011fd:	41 5c                	pop    %r12
      4011ff:	41 5d                	pop    %r13
      401201:	41 5e                	pop    %r14
      401203:	c3                   	retq
    

è¿™æ®µä»£ç ä½“ç§¯æœ‰ç‚¹å¤§ï¼Œä¸è¿‡æ‹†å¼¹å°åˆ†é˜Ÿè¿˜æ˜¯å¾—å¿ä¸€ä¸‹ã€‚`phase_6` é¦–å…ˆè¯»å…¥äº† 6 ä¸ªæ•°å­—ï¼Œæ¥ç€ä» `0x40110e` åˆ° `0x401151` çš„ä»£ç å¯ä»¥ç¿»è¯‘ä¸ºï¼š

    r12d = 0;
    while (True) {
        rbp = r13;		// è¾“å…¥çš„æ•°å­—çš„åœ°å€
        rax = M[r13];
        rax -= 1;
        
        // M[r13] çš„å–å€¼èŒƒå›´åœ¨ 1~6 ä¹‹é—´
        if (rax > 5 ) {
            explode_bomb();
        }
        
        r12d += 1;
        if (r12d == 6) break;
        
        for (rbx = r12d; rbx <= 5; rbx++) {
            rax = rbx;
            if (rax == M[rsp]) {
                explode_bomb();
            }
        }
        
        r13 += 4;
    }
    

ä¸Šè¿°ä»£ç ä¸­ `%r13` å­˜å‚¨çš„æ˜¯è¾“å…¥çš„æ•°å­—çš„åœ°å€ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![è¾“å…¥æ•°å­—çš„åœ°å€](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220513234712956-1945196121.png)

æ ¹æ®ä¸Šè¿°ä»£ç å¯ä»¥ç¡®å®šè¾“å…¥çš„æ•°å­—åº”è¯¥åœ¨ 1~6 ä¹‹é—´ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤ï¼Œä¸ç„¶å°±ä¼šå¼•çˆ†ç¬¬å…­ç‚¸å¼¹ã€‚ä» `0x401153` åˆ° `0x40116d` çš„ä»£ç å¯ä»¥ç¿»è¯‘ä¸ºï¼š

    rsi = rsp + 18;
    rax = r14;  // è¾“å…¥æ•°å­—çš„å¼€å§‹åœ°å€
    do {
        rdx = 7 - M[rax];
        M[rax] = rdx;
        rax += 4;
    } while (rsi != rax)
    

æ­¤å¤„ `%r14` å’Œ `%r13` ä¸€æ ·å­˜çš„æ˜¯è¾“å…¥æ•°å­—çš„å¼€å§‹åœ°å€ï¼ˆä¸è´´å›¾äº†ï¼‰ï¼Œè€Œä¸Šè¿°ä»£ç çš„ä½œç”¨å°±æ˜¯ç”¨ 7 å‡å»æ¯ä¸ªè¾“å…¥çš„æ•°å­—å¹¶ä½œä¸ºæ–°å€¼ã€‚æ¥ä¸‹æ¥çš„ä»£ç å°±æœ‰ç‚¹æ··ä¹±äº†ï¼Œåå¤æ¨ªè·³ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆçœ‹ä¸‹æœ€åä¸€æ®µä»£ç  `0x4011da` åˆ° `0x4011f5` çš„ç¿»è¯‘ï¼š

    for (rbp = 5; rbp > 1; rbp--) {
        rax = M[rbx + 8];
        eax = M[rax];		// åªä¿ç•™å››ä¸ªå­—èŠ‚ï¼Œé«˜ä½å¡«å…… 0
        
        if (M[rbx] < eax) {
            explode_bomb();
        }
        
        rbx = M[rbx + 8];	// rbx æ»å rax
    }
    

ç”±æ­¤å¯è§ `%rbx` æ˜¯ä¸€ä¸ªäºŒé‡æŒ‡é’ˆï¼Œéœ€è¦è§£å¼•ç”¨ä¸¤æ¬¡æ‰èƒ½æ‹¿åˆ°æ­£ç¡®çš„å€¼ï¼Œè¿™æ®µä»£ç ç”¨æ¥ç¡®å®šä¸€æ®µå†…å­˜æ˜¯å¦å·²é™åºæ’åˆ—ï¼Œå¦‚æœä¸æ»¡è¶³é™åºæ¡ä»¶å°±ä¼šå¼•çˆ†ç¬¬å…­ç‚¸å¼¹ã€‚å¦‚æœè¾“å…¥çš„ 6 ä¸ªæ•°å­—ä¸º 6~1ï¼Œåœ¨å¼€å§‹æ£€æŸ¥æ˜¯å¦æ»¡è¶³å€’åºæ¡ä»¶ä¹‹å‰æš‚åœç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°å†…å­˜ä¸­ä»¥ `%rbx` ä¸ºèµ·å§‹åœ°å€çš„ 12 ä¸ª 8 å­—èŠ‚æ•°ï¼Œå…¶ä¸­å·¦ä¾§ä¸€åˆ—çš„ä½ 32 ä½ç”¨æ¥æ¯”è¾ƒå¤§å°ï¼Œå³ä¾§ä¸€åˆ—ç”¨æ¥ä½œä¸º `%rax` å’Œä¸‹æ¬¡ `%rbx` å­˜æ”¾çš„åœ°å€ï¼š

![%rbx å¯¹åº”çš„å†…å­˜å†…å®¹](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220514130634265-1589351857.png)

æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œå†æ¥å®¡è§†æ²¡æåŠçš„é‚£ä¸€éƒ¨åˆ†æ±‡ç¼–ä»£ç ï¼Œå…¶å®å°±æ˜¯æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æ•°å­—ï¼Œæ”¹å˜å³ä¾§ä¸€æ çš„åœ°å€å’Œ `%rbx` çš„åˆå§‹å€¼ã€‚å¦‚æœå°† `%rbx` çš„åˆå§‹å€¼è®¾ç½®ä¸º `0x6032f0`ï¼Œæ²¿ç€å·¦ä¾§ä¸€æ å‘ä¸‹ï¼Œåˆ°åº•ä¹‹åå›åˆ° `0x6032d0`ï¼Œä¸€è·¯å¾—åˆ°çš„åºåˆ—å°±æ˜¯é€’å‡çš„ã€‚ç”±æ­¤å¯ä»¥å¾—åˆ°è¾“å…¥çš„æ•°å­—ä¸º `4 3 2 1 6 5`ï¼ˆè¢« 7 å‡è¿‡å¾—åˆ°çš„ï¼‰ã€‚ç»“æœå¦‚ä¸‹ï¼š

![ç¬¬å…­ç‚¸å¼¹è¢«è§£é™¤](https://img2022.cnblogs.com/blog/2065884/202205/2065884-20220514133805489-1371315520.png)

æ€»ç»“
==

é€šè¿‡è¿™æ¬¡å®éªŒï¼Œå¯ä»¥ç†Ÿæ‚‰ GDB è°ƒè¯•å·¥å…·çš„ä½¿ç”¨æ–¹æ³•ï¼ŒåŒæ—¶ä¹Ÿèƒ½çœ‹æ‡‚ä¸€äº›æ±‡ç¼–ä»£ç äº†ï¼ˆä¸è¿‡æœ‰ä¸€è¯´ä¸€ï¼Œç¬¬å…­ç‚¸å¼¹çš„ä»£ç çœŸçš„å°±æ˜¯åˆè‡­åˆé•¿ï¼‰ã€‚æ‹†äº†è¿™ä¹ˆä¹…çš„ç‚¸å¼¹ï¼Œä¸­é—´è¿˜å¤±è´¥è¿‡å¥½å¤šæ¬¡ï¼Œå¸Œæœ›äººè´¨æ²¡äº‹ï¼Œä»¥ä¸Š~~