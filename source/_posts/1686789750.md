---
layout: post
title: "Terraform ç³»åˆ—-Terraform é¡¹ç›®çš„å…¸å‹æ–‡ä»¶å¸ƒå±€"
date: "2023-04-01T01:08:32.145Z"
---
Terraform ç³»åˆ—-Terraform é¡¹ç›®çš„å…¸å‹æ–‡ä»¶å¸ƒå±€
================================

ç³»åˆ—æ–‡ç« 
----

ğŸ‘‰ [Terraform ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Terraform/)

å…¸å‹æ–‡ä»¶å¸ƒå±€
------

    - modules/
        - services/
            - webserver-cluster/
                - examples/
                - main.tf
                - outputs.tf
                - vars.tf
                - user-data.sh
                - README.md
                - [ ] versions.tf
    - stage/
        - vpc/
        - services/
            - frontend-app/
            - backend-app/
                - main.tf
                - outputs.tf
                - vars.tf
                - user-data.sh
                - README.md
                - [ ] provider.tf
                - [ ] versions.tf
                - [ ] terraform.tfvarsï¼ˆor `*.auto.tfvars`)
                - [ ] main.tfvars
        - data-storage/
            - mysql/
            - redis/
    - prod/
        - vpc/
        - services/
            - frontend-app/
            - backend-app/
        - data-storage/
            - mysql/
            - redis/
    - mgmt/
        - vpc/
        - services/
            - bastion-host/
            - jenkins/
    - global/
        - iam/
        - s3/
            - main.tf
            - outputs.tf
            - vars.tf
            - user-data.sh
            - README.md
            - [ ] provider.tf
            - [ ] versions.tf
    

> ğŸ”¥ **æç¤º**ï¼š
> 
> *   `- [ ]` è¡¨ç¤ºè¯¥é¡¹ä¸ºå¯é€‰å†…å®¹
> *   ç¤ºä¾‹å¦‚ `examples/` è¡¨ç¤ºè¯¥é¡¹ä¸ºæ–‡ä»¶å¤¹

è¯¦ç»†è¯´æ˜
----

### é¡¶å±‚æ–‡ä»¶å¤¹

ç”¨äºéš”ç¦»**ç¯å¢ƒ**

*   `modules`ï¼šTerraform ï¼ˆå¯å¤ç”¨ï¼‰æ¨¡å—æ–‡ä»¶å¤¹
*   `stage`ï¼šé¢„å‘å¸ƒ Env
*   `prod`ï¼šç”Ÿäº§ env
*   `mgmt`ï¼šç®¡ç†/DevOps ç¯å¢ƒï¼ˆå¦‚ï¼šå ¡å’æœºã€Jenkins ç­‰ï¼‰
*   `global`ï¼šç”¨äºè¿è¡Œå„ç§ç¯å¢ƒä¸‹éƒ½è¦å…±äº«çš„èµ„æºï¼ˆå¦‚ï¼šTerraform backend - S3ã€IAMï¼‰

### äºŒçº§æ–‡ä»¶å¤¹

ç”¨äºç¯å¢ƒä¸­çš„**ç»„ä»¶**

*   `vpc`ï¼šç½‘ç»œæ‹“æ‰‘
*   `services`ï¼šæ­¤ç¯å¢ƒä¸­è¿è¡Œçš„åº”ç”¨ç¯å¢ƒæˆ–å¾®æœåŠ¡ï¼Œä¾‹å¦‚ NGINX å‰ç«¯æˆ– Java åç«¯ã€‚æ¯ä¸ªåº”ç”¨ç¨‹åºç”šè‡³éƒ½åº”è¯¥é©»ç•™åœ¨å•ç‹¬çš„æ–‡ä»¶å¤¹ä¸­ï¼Œä¸å…¶ä»–åº”ç”¨ç¨‹åºéš”ç¦»
*   `data-storage`ï¼šåœ¨æ­¤ç¯å¢ƒä¸­è¿è¡Œçš„æ•°æ®å­˜å‚¨ï¼Œä¾‹å¦‚ MySQL æˆ– Redisã€‚æ¯ä¸ªæ•°æ®å­˜å‚¨åº”è¯¥é©»ç•™åœ¨å®ƒè‡ªå·±çš„æ–‡ä»¶å¤¹ä¸­ï¼Œä¸å…¶ä»–æ•°æ®å­˜å‚¨éš”ç¦»ã€‚

### æ–‡ä»¶

æ¯ä¸€ä¸ªç»„ä»¶ä¸­ï¼Œéƒ½ä¼šæœ‰ç›¸åº”çš„ Terraform çš„é…ç½®æ–‡ä»¶ï¼Œå…¶å‘½åè§„åˆ™å¦‚ä¸‹ï¼š

*   `vars.tf`: è¾“å…¥å˜é‡
*   `outputs.tf`: è¾“å‡ºå˜é‡
*   `main.tf`: èµ„æºå®šä¹‰
*   `user-data.sh`ï¼šï¼ˆå¯é€‰ï¼‰ï¼Œç”¨æˆ·è‡ªå®šä¹‰è„šæœ¬
*   `README.md`ï¼šè¯´æ˜æ–‡æ¡£
*   `provider.tf`ï¼šï¼ˆå¯é€‰ï¼‰ï¼Œprovider ä¿¡æ¯ï¼Œå…¸å‹å¦‚ï¼šproviderã€regionã€‚ä¸åŒç¯å¢ƒï¼Œç”šè‡³åŒä¸€ç¯å¢ƒçš„ä¸åŒç»„ä»¶çš„ provider å¯èƒ½ä¸åŒã€‚
*   `versions.tf`ï¼šï¼ˆå¯é€‰ï¼‰ï¼ŒTerraform versionã€provider versionã€Terraform backend ä¿¡æ¯ã€‚
*   `terraform.tfvars`ï¼ˆor `*.auto.tfvars`): ï¼ˆå¯é€‰ï¼‰ï¼Œ`terraform plan åŠ apply` é»˜è®¤ä¼šä¼ å…¥è¯¥æ–‡ä»¶ä¸­çš„å˜é‡å€¼
*   `main.tfvars`ï¼šï¼ˆå¯é€‰ï¼‰ï¼Œ`terraform plan åŠ apply`å¯ä»¥é€šè¿‡ `-var-file=filename` æ¥æ‰‹åŠ¨æŒ‡å®šã€‚

### å˜é‡èµ‹å€¼

å¯ä»¥é€šè¿‡å¦‚ä¸‹ 3 ç§æ–¹å¼æŒ‡å®šå˜é‡ï¼š

      -var 'foo=bar'      Set a value for one of the input variables in the root
                          module of the configuration. Use this option more than
                          once to set more than one variable.
    
      -var-file=filename  Load variable values from the given file, in addition
                          to the default files terraform.tfvars and *.auto.tfvars.
                          Use this option more than once to include more than one
                          variables file.
    

1.  å‘½ä»¤è¡Œå‚æ•°ï¼š`-var 'foo=bar'`
    
2.  å‚æ•°æ–‡ä»¶ï¼šé»˜è®¤è¯»å– terraform.tfvarsï¼ˆor `*.auto.tfvars`) æˆ–é€šè¿‡å‘½ä»¤è¡Œ `-var-file=filename` æŒ‡å®š
    
3.  ç¯å¢ƒå˜é‡ï¼šå¯ä»¥é€šè¿‡è®¾ç½®åä¸º`TF_VAR_<NAME>`çš„ç¯å¢ƒå˜é‡ä¸ºè¾“å…¥å˜é‡èµ‹å€¼ï¼Œä¾‹å¦‚ï¼š
    
        $ export TF_VAR_image_id=ami-abc123
        $ terraform plan
        ...
        
    
    ç¯å¢ƒå˜é‡ä¼ å€¼éå¸¸é€‚åˆåœ¨è‡ªåŠ¨åŒ–æµæ°´çº¿ä¸­ä½¿ç”¨ï¼Œå°¤å…¶é€‚åˆç”¨æ¥ä¼ é€’æ•æ„Ÿæ•°æ®ï¼Œç±»ä¼¼å¯†ç ã€è®¿é—®å¯†é’¥ç­‰
    

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.