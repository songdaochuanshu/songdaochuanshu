---
layout: post
title: "WeakHashMap å’Œ HashMap çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶ä½¿ç”¨ï¼Ÿ"
date: "2022-12-03T04:19:51.797Z"
---
WeakHashMap å’Œ HashMap çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶ä½¿ç”¨ï¼Ÿ
==================================

> **æœ¬æ–‡å·²æ”¶å½•åˆ° [AndroidFamily](https://github.com/pengxurui/AndroidFamily)ï¼ŒæŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] æé—®ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

[åœ¨ä¹‹å‰çš„æ–‡ç« é‡Œ](https://juejin.cn/post/7163301919316934693)ï¼Œæˆ‘ä»¬èŠåˆ°äº† Java æ ‡å‡†åº“ä¸­ [HashMap](https://juejin.cn/post/7163985718417555487) ä¸ [LinkedHashMap](https://juejin.cn/post/7164348785512939551) çš„å®ç°åŸç†ã€‚HashMap æ˜¯ä¸€ä¸ªæ ‡å‡†çš„æ•£åˆ—è¡¨æ•°æ®ç»“æ„ï¼Œè€Œ LinkedHashMap æ˜¯åœ¨ HashMap çš„åŸºç¡€ä¸Šå®ç°çš„å“ˆå¸Œé“¾è¡¨ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥è®¨è®º WeakHashMapï¼Œå…¶ä¸­çš„ â€œWeakâ€ æ˜¯æŒ‡ä»€ä¹ˆï¼Œä¸å‰ä¸¤è€…çš„ä½¿ç”¨åœºæ™¯æœ‰ä½•ä¸åŒï¼Ÿæˆ‘ä»¬å°±å›´ç»•è¿™äº›é—®é¢˜å±•å¼€ã€‚

æç¤ºï¼š æœ¬æ–‡æºç åŸºäº JDK 1.2 WeakHashMapã€‚

* * *

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤å·²ç»å»ºç«‹å•¦ï¼Œæ‰«ææ–‡æœ«äºŒç»´ç è¿›å…¥~

* * *

**æ€ç»´å¯¼å›¾ï¼š**

![](https://files.mdnice.com/user/3257/0eef97f5-eaea-4d5d-880f-54f93c88538a.png)

* * *

1\. å›é¡¾ HashMap å’Œ LinkedHashMap
------------------------------

å…¶å®ï¼ŒWeakHashMap ä¸ HashMap å’Œ LinkedHashMap çš„æ•°æ®ç»“æ„å¤§åŒå°å¼‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå›é¡¾åè€…çš„å®ç°åŸç†ã€‚

### 1.1 è¯´ä¸€ä¸‹ HashMap çš„å®ç°ç»“æ„

HashMap æ˜¯åŸºäºåˆ†ç¦»é“¾è¡¨æ³•è§£å†³æ•£åˆ—å†²çªçš„åŠ¨æ€æ•£åˆ—è¡¨ã€‚

*   1ã€HashMap åœ¨ Java 7 ä¸­ä½¿ç”¨çš„æ˜¯ â€œæ•°ç»„ + é“¾è¡¨â€ï¼Œå‘ç”Ÿæ•£åˆ—å†²çªçš„é”®å€¼å¯¹ä¼šç”¨å¤´æ’æ³•æ·»åŠ åˆ°å•é“¾è¡¨ä¸­ï¼›
*   2ã€HashMap åœ¨ Java 8 ä¸­ä½¿ç”¨çš„æ˜¯ â€œæ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘â€ï¼Œå‘ç”Ÿæ•£åˆ—å†²çªçš„é”®å€¼å¯¹ä¼šç”¨å°¾æ’æ³•æ·»åŠ åˆ°å•é“¾è¡¨ä¸­ã€‚å¦‚æœé“¾è¡¨çš„é•¿åº¦å¤§äº 8 æ—¶ä¸”æ•£åˆ—è¡¨å®¹é‡å¤§äº 64ï¼Œä¼šå°†é“¾è¡¨æ ‘åŒ–ä¸ºçº¢é»‘æ ‘ã€‚

`HashMap å®ç°ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/fb9472b7-2069-4914-bfa8-613d9dc01692.png)

### 1.2 è¯´ä¸€ä¸‹ LinkedHashMap çš„å®ç°ç»“æ„

LinkedHashMap æ˜¯ç»§æ‰¿äº HashMap å®ç°çš„å“ˆå¸Œé“¾è¡¨ã€‚

*   1ã€LinkedHashMap åŒæ—¶å…·å¤‡åŒå‘é“¾è¡¨å’Œæ•£åˆ—è¡¨çš„ç‰¹ç‚¹ã€‚å½“ LinkedHashMap ä½œä¸ºæ•£åˆ—è¡¨æ—¶ï¼Œä¸»è¦ä½“ç°å‡º O(1) æ—¶é—´å¤æ‚åº¦çš„æŸ¥è¯¢æ•ˆç‡ã€‚å½“ LinkedHashMap ä½œä¸ºåŒå‘é“¾è¡¨æ—¶ï¼Œä¸»è¦ä½“ç°å‡ºæœ‰åºçš„ç‰¹æ€§ï¼›
*   2ã€LinkedHashMap æ”¯æŒ FIFO å’Œ LRU ä¸¤ç§æ’åºæ¨¡å¼ï¼Œé»˜è®¤æ˜¯ FIFO æ’åºæ¨¡å¼ï¼Œå³æŒ‰ç…§æ’å…¥é¡ºåºæ’åºã€‚Android ä¸­çš„ LruCache å†…å­˜ç¼“å­˜å’Œ DiskLruCache ç£ç›˜ç¼“å­˜ä¹Ÿæ˜¯ç›´æ¥å¤ç”¨ LinkedHashMap æä¾›çš„ç¼“å­˜ç®¡ç†èƒ½åŠ›ã€‚

`LinkedHashMap ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/43b69eeb-1be7-478f-ac5a-cabd7c4a351f.png)

* * *

2\. è®¤è¯† WeakHashMap
------------------

### 2.1 WeakReference å¼±å¼•ç”¨çš„ç‰¹ç‚¹

WeakHashMap ä¸­çš„ â€œWeakâ€ æŒ‡é”® Key æ˜¯å¼±å¼•ç”¨ï¼Œä¹Ÿå«å¼±é”®ã€‚å¼±å¼•ç”¨æ˜¯ Java å››å¤§å¼•ç”¨ç±»å‹ä¹‹ä¸€ï¼Œä¸€å…±æœ‰å››ç§å¼•ç”¨ç±»å‹ï¼Œåˆ†åˆ«æ˜¯å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨å’Œè™šå¼•ç”¨ã€‚æˆ‘å°†å®ƒä»¬çš„åŒºåˆ«æ¦‚æ‹¬ä¸º 3 ä¸ªç»´åº¦ï¼š

*   **ç»´åº¦ 1 - å¯¹è±¡å¯è¾¾æ€§çŠ¶æ€çš„åŒºåˆ«ï¼š** å¼ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ˜¯å¼ºå¯è¾¾çš„ï¼Œåªæœ‰å¼ºå¯è¾¾çš„å¯¹è±¡æ‰ä¼šè®¤ä¸ºæ˜¯å­˜æ´»çš„å¯¹è±¡ï¼Œæ‰èƒ½ä¿è¯åœ¨åƒåœ¾æ”¶é›†çš„è¿‡ç¨‹ä¸­ä¸ä¼šè¢«å›æ”¶ï¼›
*   **ç»´åº¦ 2 - åƒåœ¾å›æ”¶ç­–ç•¥çš„åŒºåˆ«ï¼š** ä¸åŒçš„å¼•ç”¨ç±»å‹çš„å›æ”¶æ¿€è¿›ç¨‹åº¦ä¸åŒï¼Œ
    *   å¼ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ä¸ä¼šè¢«å›æ”¶ï¼›
    *   è½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡åœ¨å†…å­˜å……è¶³æ—¶ä¸ä¼šè¢«å›æ”¶ï¼Œåœ¨å†…å­˜ä¸è¶³æ—¶ä¼šè¢«å›æ”¶ï¼›
    *   å¼±å¼•ç”¨å’Œè™šå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ— è®ºåœ¨å†…å­˜æ˜¯å¦å……è¶³çš„æ—¶å€™éƒ½ä¼šè¢«å›æ”¶ï¼›
*   **ç»´åº¦ 3 - æ„ŸçŸ¥åƒåœ¾å›æ”¶æ—¶æœºï¼š** å½“å¼•ç”¨å¯¹è±¡å…³è”çš„å®é™…å¯¹è±¡è¢«åƒåœ¾å›æ”¶æ—¶ï¼Œå¼•ç”¨å¯¹è±¡ä¼šè¿›å…¥å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ï¼Œç¨‹åºå¯ä»¥é€šè¿‡è§‚å¯Ÿå¼•ç”¨é˜Ÿåˆ—çš„æ–¹å¼ï¼Œæ„ŸçŸ¥å¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„æ—¶æœºã€‚

`æ„ŸçŸ¥åƒåœ¾å›æ”¶ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/ec421542-47cc-4338-aad0-e32390a52c8d.png)

> **æç¤ºï¼š** å…³äº â€œJava å››ç§å¼•ç”¨ç±»å‹â€ çš„åŒºåˆ«ï¼Œåœ¨å°å½­çš„ Java ä¸“æ ä¸­æ·±å…¥è®¨è®ºè¿‡ [ã€Šè¯´ä¸€ä¸‹ Java çš„å››ç§å¼•ç”¨ç±»å‹ã€‹](https://mp.weixin.qq.com/s/PM5HKygFIlBVbYFnH3QUuw)ï¼Œå»çœ‹çœ‹ã€‚

### 2.2 WeakHashMap çš„ç‰¹ç‚¹

**WeakHashMap æ˜¯ä½¿ç”¨å¼±é”®çš„åŠ¨æ€æ•£åˆ—è¡¨ï¼Œç”¨äºå®ç° â€œè‡ªåŠ¨æ¸…ç†â€ çš„å†…å­˜ç¼“å­˜ã€‚**

*   1ã€WeakHashMap ä½¿ç”¨ä¸ Java 7 HashMap ç›¸åŒçš„ â€œæ•°ç»„ + é“¾è¡¨â€ è§£å†³æ•£åˆ—å†²çªï¼Œå‘ç”Ÿæ•£åˆ—å†²çªçš„é”®å€¼å¯¹ä¼šç”¨å¤´æ’æ³•æ·»åŠ åˆ°å•é“¾è¡¨ä¸­ï¼›
    
*   2ã€WeakHashMap ä¾èµ–äº Java åƒåœ¾æ”¶é›†å™¨è‡ªåŠ¨æ¸…ç†ä¸å¯è¾¾å¯¹è±¡çš„ç‰¹æ€§ã€‚å½“ Key å¯¹è±¡ä¸å†è¢«æŒæœ‰å¼ºå¼•ç”¨æ—¶ï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šæŒ‰ç…§å¼±å¼•ç”¨ç­–ç•¥è‡ªåŠ¨å›æ”¶ Key å¯¹è±¡ï¼Œå¹¶åœ¨ä¸‹æ¬¡è®¿é—® WeakHashMap æ—¶æ¸…ç†å…¨éƒ¨æ— æ•ˆçš„é”®å€¼å¯¹ã€‚å› æ­¤ï¼ŒWeakHashMap ç‰¹åˆ«é€‚åˆå®ç° â€œè‡ªåŠ¨æ¸…ç†â€ çš„å†…å­˜æ´»åŠ¨ç¼“å­˜ï¼Œå½“é”®å€¼å¯¹æœ‰æ•ˆæ—¶ä¿ç•™ï¼Œåœ¨é”®å€¼å¯¹æ— æ•ˆæ—¶è‡ªåŠ¨è¢«åƒåœ¾æ”¶é›†å™¨æ¸…ç†ï¼›
    
*   3ã€éœ€è¦æ³¨æ„ï¼Œå› ä¸º WeakHashMap ä¼šæŒæœ‰ Value å¯¹è±¡çš„å¼ºå¼•ç”¨ï¼Œæ‰€ä»¥åœ¨ Value å¯¹è±¡ä¸­ä¸€å®šä¸èƒ½æŒæœ‰ key çš„å¼ºå¼•ç”¨ã€‚å¦åˆ™ï¼Œä¼šé˜»æ­¢åƒåœ¾æ”¶é›†å™¨å›æ”¶ â€œæœ¬è¯¥ä¸å¯è¾¾â€ çš„ Key å¯¹è±¡ï¼Œä½¿å¾— WeakHashMap å¤±å»ä½œç”¨ã€‚
    
*   4ã€ä¸ HashMap ç›¸åŒï¼ŒLinkedHashMap ä¹Ÿä¸è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚å¯ä»¥ä½¿ç”¨ Collections.synchronizedMap åŒ…è£…ç±»ï¼Œå…¶åŸç†ä¹Ÿæ˜¯åœ¨æ‰€æœ‰æ–¹æ³•ä¸Šå¢åŠ  synchronized å…³é”®å­—ã€‚
    

`WeakHashMap ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/61ad6208-47e3-4f15-938f-2dba59a6caed.png)

`è‡ªåŠ¨æ¸…ç†æ•°æ®`

![](https://files.mdnice.com/user/3257/6f27ea66-ae3d-4cfc-af29-2b3019194681.png)

### 2.3 è¯´ä¸€ä¸‹ WeakHashMap ä¸ HashMap å’Œ LinkedHashMap çš„åŒºåˆ«ï¼Ÿ

WeakHashMap ä¸ HashMap éƒ½æ˜¯åŸºäºåˆ†ç¦»é“¾è¡¨æ³•è§£å†³æ•£åˆ—å†²çªçš„åŠ¨æ€æ•£åˆ—è¡¨ï¼Œä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨ **é”® Key çš„å¼•ç”¨ç±»å‹ä¸Šï¼š**

*   HashMap ä¼šæŒæœ‰é”® Key çš„å¼ºå¼•ç”¨ï¼Œé™¤éæ‰‹åŠ¨ç§»é™¤ï¼Œå¦åˆ™é”®å€¼å¯¹ä¼šé•¿æœŸå­˜åœ¨äºæ•£åˆ—è¡¨ä¸­ï¼›
    
*   WeakHashMap åªæŒæœ‰é”® Key çš„å¼±å¼•ç”¨ï¼Œå½“ Key å¯¹è±¡ä¸å†è¢«å¤–éƒ¨æŒæœ‰å¼ºå¼•ç”¨æ—¶ï¼Œé”®å€¼å¯¹ä¼šè¢«è‡ªåŠ¨è¢«æ¸…ç†ã€‚
    

WeakHashMap ä¸ LinkedHashMap éƒ½æœ‰è‡ªåŠ¨æ¸…ç†çš„èƒ½åŠ›ï¼Œä¸¤è€…çš„ä¸»è¦åŒºåˆ«åœ¨äº **æ·˜æ±°æ•°æ®çš„ç­–ç•¥ä¸Šï¼š**

*   LinkedHashMap ä¼šæŒ‰ç…§ FIFO æˆ– LRU çš„ç­–ç•¥ â€œå°è¯•â€ æ·˜æ±°æ•°æ®ï¼Œéœ€è¦å¼€å‘è€…é‡å†™ `removeEldestEntry()` æ–¹æ³•å®ç°æ˜¯å¦åˆ é™¤æœ€æ—©èŠ‚ç‚¹çš„åˆ¤æ–­é€»è¾‘ï¼›
    
*   WeakHashMap ä¼šæŒ‰ç…§ Key å¯¹è±¡çš„å¯è¾¾æ€§æ·˜æ±°æ•°æ®ï¼Œå½“ Key å¯¹è±¡ä¸å†è¢«æŒæœ‰å¼ºå¼•ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ¸…ç†æ— æ•ˆæ•°æ®ã€‚
    

### 2.4 é‡å»º Key å¯¹è±¡ä¸ç­‰ä»·çš„é—®é¢˜

WeakHashMap çš„ Key ä½¿ç”¨å¼±å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯ä»¥ Key ä½œä¸ºæ¸…ç†æ•°æ®çš„åˆ¤æ–­é”šç‚¹ï¼Œå½“ Key å˜å¾—ä¸å¯è¾¾æ—¶ä¼šè‡ªåŠ¨æ¸…ç†æ•°æ®ã€‚æ­¤æ—¶ï¼Œå¦‚æœä½¿ç”¨å¤šä¸ª `equals` ç›¸ç­‰çš„ Key å¯¹è±¡è®¿é—®é”®å€¼å¯¹ï¼Œå°±ä¼šå‡ºç°ç¬¬ 1 ä¸ª Key å¯¹è±¡ä¸å¯è¾¾å¯¼è‡´é”®å€¼å¯¹è¢«å›æ”¶ï¼Œè€Œç¬¬ 2 ä¸ª Key æŸ¥è¯¢é”®å€¼å¯¹ä¸º null çš„é—®é¢˜ã€‚ **è¿™è¯´æ˜ `equals` ç›¸ç­‰çš„ Key å¯¹è±¡åœ¨ HashMap ç­‰æ•£åˆ—è¡¨ä¸­æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯åœ¨ WeakHashMap æ•£åˆ—è¡¨ä¸­æ˜¯ä¸ç­‰ä»·çš„ã€‚**

å› æ­¤ï¼Œå¦‚æœ Key ç±»å‹æ²¡æœ‰é‡å†™ equals æ–¹æ³•ï¼Œé‚£ä¹ˆ WeakHashMap å°±è¡¨ç°è‰¯å¥½ï¼Œå¦åˆ™ä¼šå­˜åœ¨æ­§ä¹‰ã€‚ä¾‹å¦‚ä¸‹é¢è¿™ä¸ª Demo ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†æŒ‡å‘ `image_url1` çš„å›¾ç‰‡ Key1ï¼Œå†é‡å»ºäº†åŒæ ·æŒ‡å‘ `image_url1` çš„å›¾ç‰‡ Key2ã€‚åœ¨ HashMap ä¸­ï¼ŒKey1 å’Œ Key2 ç­‰ä»·ï¼Œä½†åœ¨ WeakHashMap ä¸­ï¼ŒKey1 å’Œ Key2 ä¸ç­‰ä»·ã€‚

`Demo`

    class ImageKey {
        private String url;
    
        ImageKey(String url) {
            this.url = url;
        }
    
        public boolean equals(Object obj) {
            return (obj instanceOf ImageKey) && Objects.equals(((ImageKey)obj).url, this.url);
        }
    }
    
    WeakHashMap<ImageKey, Bitmap> map = new WeakHashMap<>();
    ImageKey key1 = new ImageKey("image_url1");
    ImageKey key2 = new ImageKey("image_url2");
    // key1 equalsTo key3
    ImageKey key3 = new ImageKey("image_url1");
    
    map.put(key1, bitmap1);
    map.put(key2, bitmap2);
    
    System.out.println(map.get(key1)); // è¾“å‡º bitmap1
    System.out.println(map.get(key2)); // è¾“å‡º bitmap2
    System.out.println(map.get(key3)); // è¾“å‡º bitmap1
    
    // ä½¿ key1 ä¸å¯è¾¾ï¼Œkey3 ä¿æŒ
    key1 = null;
    
    // è¯´æ˜é‡å»º Key ä¸åŸå§‹ Key ä¸ç­‰ä»·
    System.out.println(map.get(key1)); // è¾“å‡º null
    System.out.println(map.get(key2)); // è¾“å‡º bitmap2
    System.out.println(map.get(key3)); // è¾“å‡º null
    

é»˜è®¤çš„ `Object#equals` æ˜¯åˆ¤æ–­ä¸¤ä¸ªå˜é‡æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼š

`Object.java`

    public boolean equals(Object obj) {
        return (this == obj);
    }
    

### 2.5 Key å¼±å¼•ç”¨å’Œ Value å¼±å¼•ç”¨çš„åŒºåˆ«

ä¸ç®¡æ˜¯ Key è¿˜æ˜¯ Value ä½¿ç”¨å¼±å¼•ç”¨éƒ½å¯ä»¥å®ç°è‡ªåŠ¨æ¸…ç†ï¼Œè‡³äºä½¿ç”¨å“ªä¸€ç§æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œé€‚ç”¨åœºæ™¯ä¹Ÿä¸åŒã€‚

*   **Key å¼±å¼•ç”¨ï¼š** ä»¥ Key ä½œä¸ºæ¸…ç†æ•°æ®çš„åˆ¤æ–­é”šç‚¹ï¼Œå½“ Key ä¸å¯è¾¾æ—¶æ¸…ç†æ•°æ®ã€‚ä¼˜ç‚¹æ˜¯å®¹å™¨å¤–ä¸éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨ï¼Œç¼ºç‚¹æ˜¯é‡å»ºçš„ Key ä¸åŸå§‹ Key ä¸ç­‰ä»·ï¼Œé‡å»º Key æ— æ³•é˜»æ­¢æ•°æ®è¢«æ¸…ç†ï¼›
    
*   **Value å¼±å¼•ç”¨ï¼š** ä»¥ Value ä½œä¸ºæ¸…ç†æ•°æ®çš„åˆ¤æ–­é”šç‚¹ï¼Œå½“ Value ä¸å¯è¾¾æ—¶æ¸…ç†æ•°æ®ã€‚ä¼˜ç‚¹æ˜¯é‡å»º Key ä¸ä¸åŸå§‹ Key ç­‰ä»·ï¼Œç¼ºç‚¹æ˜¯å®¹å™¨å¤–éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨ã€‚
    

ç±»å‹

ä¼˜ç‚¹

ç¼ºç‚¹

åœºæ™¯

Key å¼±å¼•ç”¨

å¤–éƒ¨ä¸éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨ï¼Œä½¿ç”¨æ›´ç®€å•

é‡å»º Key ä¸ç­‰ä»·

æœªé‡å†™ equals

Value å¼±å¼•ç”¨

é‡å»º Key ç­‰ä»·

å¤–éƒ¨éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨

é‡å†™ equals

**ä¸¾ä¾‹ 1ï¼š** åœ¨ Android Glide å›¾ç‰‡æ¡†æ¶çš„å¤šçº§ç¼“å­˜ä¸­ï¼Œå› ä¸ºå›¾ç‰‡çš„ EngineKey æ˜¯å¯é‡å»ºçš„ï¼Œå­˜åœ¨å¤šä¸ª EngineKey å¯¹è±¡æŒ‡å‘åŒä¸€ä¸ªå›¾ç‰‡ Bitmapï¼Œæ‰€ä»¥ Glide æœ€é¡¶å±‚çš„æ´»åŠ¨ç¼“å­˜é‡‡ç”¨çš„æ˜¯ Value å¼±å¼•ç”¨ã€‚

`EngineKey.java`

    class EngineKey implements Key {
    
        // é‡å†™ equals
        @Override
        public boolean equals(Object o) {
            if (o instanceof EngineKey) {
                EngineKey other = (EngineKey) o;
                return model.equals(other.model)
                    && signature.equals(other.signature)
                    && height == other.height
                    && width == other.width
                    && transformations.equals(other.transformations)
                    && resourceClass.equals(other.resourceClass)
                    && transcodeClass.equals(other.transcodeClass)
                    && options.equals(other.options);
            }
            return false;
        }
    }
    

**ä¸¾ä¾‹ 2ï¼š** åœ¨ ThreadLocal çš„ ThreadLocalMap çº¿ç¨‹æœ¬åœ°å­˜å‚¨ä¸­ï¼Œå› ä¸º ThreadLocal æ²¡æœ‰é‡å†™ equalsï¼Œä¸å­˜åœ¨å¤šä¸ª ThreadLocal å¯¹è±¡æŒ‡å‘åŒä¸€ä¸ªé”®å€¼å¯¹çš„æƒ…å†µï¼Œæ‰€ä»¥ ThreadLocal é‡‡ç”¨çš„æ˜¯ Key å¼±å¼•ç”¨ã€‚

`ThreadLocal.java`

    static class Entry extends WeakReference<ThreadLocal<?>> {
        /** The value associated with this ThreadLocal. */
        Object value;
    
        Entry(ThreadLocal<?> k, Object v) {
            super(k);
            value = v;
        }
        
        // æœªé‡å†™ equals
    }
    

* * *

3\. WeakHashMap æºç åˆ†æ
--------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥åˆ†æ WeakHashMap ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

äº‹å®ä¸Šï¼ŒWeakHashMap å°±æ˜¯ç…§ç€ Java 7 ç‰ˆæœ¬çš„ HashMap ä¾è‘«èŠ¦ç”»ç“¢çš„ï¼Œæ²¡æœ‰æ ‘åŒ–çš„é€»è¾‘ã€‚è€ƒè™‘åˆ°æˆ‘ä»¬å·²ç»å¯¹ HashMap åšè¿‡è¯¦ç»†åˆ†æï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰å¿…è¦é‡å¤åˆ†æ WeakHashMap çš„æ¯ä¸ªç»†èŠ‚ï¼Œè€Œæ˜¯æŠŠé‡å¿ƒæ”¾åœ¨ WeakHashMap ä¸ HashMap ä¸åŒçš„åœ°æ–¹ã€‚

### 3.1 WeakHashMap çš„å±æ€§

å…ˆç”¨ä¸€ä¸ªè¡¨æ ¼æ•´ç† WeakHashMap çš„å±æ€§ï¼š

ç‰ˆæœ¬

æ•°æ®ç»“æ„

èŠ‚ç‚¹å®ç°ç±»

å±æ€§

Java 7 HashMap

æ•°ç»„ + é“¾è¡¨

Entryï¼ˆå•é“¾è¡¨ï¼‰

1ã€tableï¼ˆæ•°ç»„ï¼‰  
2ã€sizeï¼ˆå°ºå¯¸ï¼‰  
3ã€thresholdï¼ˆæ‰©å®¹é˜ˆå€¼ï¼‰  
4ã€loadFactorï¼ˆè£…è½½å› å­ä¸Šé™ï¼‰  
5ã€modCountï¼ˆä¿®æ”¹è®¡æ•°ï¼‰  
6ã€é»˜è®¤æ•°ç»„å®¹é‡ 16  
7ã€æœ€å¤§æ•°ç»„å®¹é‡ 2^30  
8ã€é»˜è®¤è´Ÿè½½å› å­ 0.75

WeakHashMap

æ•°ç»„ + é“¾è¡¨

Entryï¼ˆå•é“¾è¡¨ï¼Œå¼±å¼•ç”¨çš„å­ç±»å‹ï¼‰

9ã€queueï¼ˆå¼•ç”¨é˜Ÿåˆ—ï¼‰

`WeakHashMap.java`

    public class WeakHashMap<K,V> extends AbstractMap<K,V> implements Map<K,V> {
    
        // é»˜è®¤æ•°ç»„å®¹é‡
        private static final int DEFAULT_INITIAL_CAPACITY = 16;
    
        // æ•°ç»„æœ€å¤§å®¹é‡ï¼š2^30ï¼ˆé«˜ä½ 0100ï¼Œä½ä½éƒ½æ˜¯ 0ï¼‰
        private static final int MAXIMUM_CAPACITY = 1 << 30;
    
        // é»˜è®¤è£…è½½å› å­ä¸Šé™ï¼š0.75
        private static final float DEFAULT_LOAD_FACTOR = 0.75f;
    
        // åº•å±‚æ•°ç»„
        Entry<K,V>[] table;
    
        // é”®å€¼å¯¹æ•°é‡
        private int size;
    
        // æ‰©å®¹é˜ˆå€¼ï¼ˆå®¹é‡ * è£…è½½å› å­ï¼‰
        private int threshold;
    
        // è£…è½½å› å­ä¸Šé™
        private final float loadFactor;
    
        // å¼•ç”¨é˜Ÿåˆ—
        private final ReferenceQueue<Object> queue = new ReferenceQueue<>();
    
        // ä¿®æ”¹è®¡æ•°
        int modCount;
    
        // é“¾è¡¨èŠ‚ç‚¹ï¼ˆä¸€ä¸ª Entry ç­‰äºä¸€ä¸ªé”®å€¼å¯¹ï¼‰
        private static class Entry<K,V> extends WeakReference<Object> implements Map.Entry<K,V> {
            // Keyï¼šä¸ HashMap å’Œ LinkedHashMap ç›¸æ¯”ï¼Œå°‘äº† key çš„å¼ºå¼•ç”¨
            // final K key;
            // Valueï¼ˆå¼ºå¼•ç”¨ï¼‰
            V value;
            // å“ˆå¸Œå€¼
            final int hash;
            Entry<K,V> next;
    
            Entry(Object key, V value, ReferenceQueue<Object> queue, int hash, Entry<K,V> next) {
                super(key /*æ³¨æ„ï¼šåªæœ‰ Key æ˜¯å¼±å¼•ç”¨*/, queue);
                this.value = value;
                this.hash  = hash;
                this.next  = next;
            }
        }
    }
    

WeakHashMap ä¸ HashMap çš„å±æ€§å‡ ä¹ç›¸åŒï¼Œä¸»è¦åŒºåˆ«æœ‰ 2 ä¸ªï¼š

*   **1ã€ReferenceQueueï¼š** WeakHashMap çš„å±æ€§é‡Œå¤šäº†ä¸€ä¸ª queue å¼•ç”¨é˜Ÿåˆ—ï¼›
    
*   **2ã€Entryï¼š** `WeakHashMap#Entry` èŠ‚ç‚¹ç»§æ‰¿äº `WeakReference`ï¼Œè¡¨é¢çœ‹æ˜¯ WeakHashMap æŒæœ‰äº† Entry çš„å¼ºå¼•ç”¨ï¼Œå…¶å®ä¸æ˜¯ã€‚æ³¨æ„çœ‹ Entry çš„æ„é€ æ–¹æ³•ï¼ŒWeakReference å…³è”çš„å®é™…å¯¹è±¡æ˜¯ Keyã€‚ **æ‰€ä»¥ï¼ŒWeakHashMap ä¾ç„¶æŒæœ‰ Entry å’Œ Value çš„å¼ºå¼•ç”¨ï¼Œä»…æŒæœ‰ Key çš„å¼±å¼•ç”¨ã€‚**
    

`å¼•ç”¨å…³ç³»ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/c4b03466-1526-4595-8999-91c87989ab86.png)

ä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 1ï¼šè¯´ä¸€ä¸‹ ReferenceQueue queue çš„ä½œç”¨?**

ReferenceQueue ä¸ Reference é…åˆèƒ½å¤Ÿå®ç°æ„ŸçŸ¥å¯¹è±¡è¢«åƒåœ¾å›æ”¶çš„èƒ½åŠ›ã€‚åœ¨åˆ›å»ºå¼•ç”¨å¯¹è±¡æ—¶å¯ä»¥å…³è”ä¸€ä¸ªå®é™…å¯¹è±¡å’Œä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œå½“å®ç°å¯¹è±¡è¢«åƒåœ¾å›æ”¶åï¼Œå¼•ç”¨å¯¹è±¡ä¼šè¢«æ·»åŠ åˆ°è¿™ä¸ªå¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚åœ¨ WeakHashMap ä¸­ï¼Œå°±æ˜¯æ ¹æ®è¿™ä¸ªå¼•ç”¨é˜Ÿåˆ—æ¥è‡ªåŠ¨æ¸…ç†æ— æ•ˆé”®å€¼å¯¹ã€‚

*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 2ï¼šä¸ºä»€ä¹ˆ Key æ˜¯å¼±å¼•ç”¨ï¼Œè€Œä¸æ˜¯ Entry æˆ– Value æ˜¯å¼±å¼•ç”¨ï¼Ÿ**

é¦–å…ˆï¼ŒEntry ä¸€å®šè¦æŒæœ‰å¼ºå¼•ç”¨ï¼Œè€Œä¸èƒ½æŒæœ‰å¼±å¼•ç”¨ã€‚è¿™æ˜¯å› ä¸º Entry æ˜¯ WeakHashMap å†…éƒ¨ç»´æŠ¤æ•°æ®ç»“æ„çš„å®ç°ç»†èŠ‚ï¼Œå¹¶ä¸ä¼šæš´éœ²åˆ° WeakHashMap å¤–éƒ¨ï¼Œå³é™¤äº† WeakHashMap æœ¬èº«ä¹‹å¤–æ²¡æœ‰å…¶å®ƒåœ°æ–¹æŒæœ‰ Entry çš„å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŒæœ‰ Entry çš„å¼±å¼•ç”¨ï¼Œå³ä½¿ WeakHashMap å¤–éƒ¨ä¾ç„¶åœ¨ä½¿ç”¨ Key å¯¹è±¡ï¼ŒWeakHashMap å†…éƒ¨ä¾ç„¶ä¼šå›æ”¶é”®å€¼å¯¹ï¼Œè¿™ä¸é¢„æœŸä¸ç¬¦ã€‚

å…¶æ¬¡ï¼Œä¸ç®¡æ˜¯ Key è¿˜æ˜¯ Value ä½¿ç”¨å¼±å¼•ç”¨éƒ½å¯ä»¥å®ç°è‡ªåŠ¨æ¸…ç†ã€‚è‡³äºä½¿ç”¨å“ªä¸€ç§æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œé€‚ç”¨åœºæ™¯ä¹Ÿä¸åŒï¼Œè¿™ä¸ªåœ¨å‰æ–‡åˆ†æè¿‡äº†ã€‚

### 3.2 WeakHashMap å¦‚ä½•æ¸…ç†æ— æ•ˆæ•°æ®ï¼Ÿ

åœ¨é€šè¿‡ put / get /size ç­‰æ–¹æ³•è®¿é—® WeakHashMap æ—¶ï¼Œå…¶å†…éƒ¨ä¼šè°ƒç”¨ `expungeStaleEntries()` æ–¹æ³•æ¸…ç† Key å¯¹è±¡å·²ç»è¢«å›æ”¶çš„æ— æ•ˆé”®å€¼å¯¹ã€‚å…¶ä¸­ä¼šéå† ReferenceQueue ä¸­æŒæœ‰çš„å¼±å¼•ç”¨å¯¹è±¡ï¼ˆå³ Entry èŠ‚ç‚¹ï¼‰ï¼Œå¹¶å°†è¯¥ç»“ç‚¹ä»æ•£åˆ—è¡¨ä¸­ç§»é™¤ã€‚

    private final ReferenceQueue<Object> queue = new ReferenceQueue<>();
    
    // æ·»åŠ é”®å€¼å¯¹
    public V put(K key, V value) {
        ...
        // é—´æ¥ expungeStaleEntries()
        Entry<K,V>[] tab = getTable();
        ...
    }
    
    // æ‰©å®¹
    void resize(int newCapacity) {
        // é—´æ¥ expungeStaleEntries()
        Entry<K,V>[] oldTable = getTable();
        ...
    }
    
    // è·å–é”®å€¼å¯¹
    public V get(Object key) {
        ...
        // é—´æ¥ expungeStaleEntries()
        Entry<K,V>[] tab = getTable();
        ...
    }
    
    private Entry<K,V>[] getTable() {
        // æ¸…ç†æ— æ•ˆé”®å€¼å¯¹
        expungeStaleEntries();
        return table;
    }
    
    // ->æ¸…ç†æ— æ•ˆé”®å€¼å¯¹
    private void expungeStaleEntries() {
        // éå†å¼•ç”¨é˜Ÿåˆ—
        for (Object x; (x = queue.poll()) != null; ) {
            // ç–‘é—® 3ï¼šæ—¢ç„¶ WeakHashMap ä¸è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œè¦åšåŠ é”ï¼Œå²‚ä¸æ˜¯çªå…€ï¼Ÿ
            synchronized (queue) {
                Entry<K,V> e = (Entry<K,V>) x;
                // æ ¹æ®æ•£åˆ—å€¼å®šä½æ•°ç»„ä¸‹æ ‡
                int i = indexFor(e.hash /*æ•£åˆ—å€¼*/, table.length);
                // éå†æ¡¶å¯»æ‰¾èŠ‚ç‚¹ e çš„å‰é©±ç»“ç‚¹
                Entry<K,V> prev = table[i];
                Entry<K,V> p = prev;
                while (p != null) {
                    Entry<K,V> next = p.next;
                    if (p == e) {
                        // åˆ é™¤èŠ‚ç‚¹ e
                        if (prev == e)					
                            // èŠ‚ç‚¹ e æ˜¯æ ¹èŠ‚ç‚¹
                            table[i] = next;
                        else
                            // èŠ‚ç‚¹ e æ˜¯ä¸­é—´èŠ‚ç‚¹
                            prev.next = next;
                        // Must not null out e.next;
                        // stale entries may be in use by a HashIterator
                        e.value = null; // Help GC
                        size--;
                        break;
                    }
                    prev = p;
                    p = next;
                }
            }
        }
    }
    

* * *

4\. æ€»ç»“
------

*   1ã€WeakHashMap ä½¿ç”¨ä¸ Java 7 HashMap ç›¸åŒçš„ â€œæ•°ç»„ + é“¾è¡¨â€ è§£å†³æ•£åˆ—å†²çªï¼Œå‘ç”Ÿæ•£åˆ—å†²çªçš„é”®å€¼å¯¹ä¼šç”¨å¤´æ’æ³•æ·»åŠ åˆ°å•é“¾è¡¨ä¸­ï¼›
    
*   2ã€WeakHashMap èƒ½å¤Ÿå®ç° â€œè‡ªåŠ¨æ¸…ç†â€ çš„å†…å­˜ç¼“å­˜ï¼Œå…¶ä¸­çš„ â€œWeakâ€ æŒ‡é”® Key æ˜¯å¼±å¼•ç”¨ã€‚å½“ Key å¯¹è±¡ä¸å†è¢«æŒæœ‰å¼ºå¼•ç”¨æ—¶ï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šæŒ‰ç…§å¼±å¼•ç”¨ç­–ç•¥è‡ªåŠ¨å›æ”¶ Key å¯¹è±¡ï¼Œå¹¶åœ¨ä¸‹æ¬¡è®¿é—® WeakHashMap æ—¶æ¸…ç†å…¨éƒ¨æ— æ•ˆçš„é”®å€¼å¯¹ï¼›
    
*   3ã€WeakHashMap å’Œ LinkedHashMap éƒ½å…·å¤‡ â€œè‡ªåŠ¨æ¸…ç†â€ çš„ èƒ½åŠ›ï¼ŒWeakHashMap æ ¹æ® Key å¯¹è±¡çš„å¯è¾¾æ€§æ·˜æ±°æ•°æ®ï¼Œè€Œ LinkedHashMap æ ¹æ® FIFO æˆ– LRU ç­–ç•¥å°è¯•æ·˜æ±°æ•°æ®ï¼›
    
*   4ã€WeakHashMap ä½¿ç”¨ Key å¼±å¼•ç”¨ï¼Œä¼šå­˜åœ¨é‡å»º Key å¯¹è±¡ä¸ç­‰ä»·é—®é¢˜ã€‚
    

* * *

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤
--------------------

![](https://files.mdnice.com/user/3257/4a2e243b-3b26-4c14-9826-cfe3c9cc99a9.png)