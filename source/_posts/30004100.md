---
layout: post
title: "记一次接口分析"
date: "2022-09-22T02:09:02.317Z"
---
记一次接口分析
=======

使用Arthas分析接口

在偶然中发现一个接口耗时有点慢，用了4秒钟  
![](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183414437-1304003325.png)

然后查询了下，这个接口做的事有点多，即有接口调用，又有很多的查询然后保存，所以单看代码或者时序图的话很难看出

然后用了`Arthas`的分析了一下这个接口

[Arthas官网](https://arthas.aliyun.com/)

启动Arthas后选择要分析的项目，然后使用`trace`功能，trace的功能是`输出方法内部调用路径，并输出方法路径上的每个节点上耗时`，很符合我这个场景

> `trace` 命令能主动搜索 `class-pattern`／`method-pattern` 对应的方法调用路径，渲染和统计整个调用链路上的所有性能开销和追踪调用链路

开启trace

    trace com.*** method
    

然后再次调用接口

![image-20220921173414923](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183450128-5369470.png)

就可以看到这个接口下的调用链和耗时，很快就发现了耗时最高的接口，于是继续trace这个接口，重复以上步骤，最终发现耗时的地方

![](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183553258-1460706632.png)  
![](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183913869-1116879323.png)

竟然是两个插入方法耗时最久

看了下表结构也没有很多索引，而且数据量也不大只有几万条，把sql复制到数据库中执行，也是正常的

看了下代码，这两个插入是在循环中的，但是循环只有10多次，在本地测试了一下也是正常的

而且本地的接口总耗时才3537ms

用`Arthas`的`dashboard`看了下项目的资源情况

![](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183634533-148423181.png)

发现堆快满了，而且只有100多m的内存，看了下启动参数，只给这个项目指定了128m的内存。。

又看了下服务器内存，也快被用完了

![](https://img2022.cnblogs.com/blog/2697628/202209/2697628-20220921183658551-1386117962.png)

然后把这个项目移动资源比较足的服务器，并且把内存扩大到256m

再次调用接口只用了1秒多，可看到资源对项目的影响