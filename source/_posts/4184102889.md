---
layout: post
title: "[ä¿å§†çº§æ•™ç¨‹] å¦‚ä½•åœ¨ Linux Kernel (V5.17.7) ä¸­æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆSystem callï¼‰"
date: "2022-05-15T12:36:13.348Z"
---
\[ä¿å§†çº§æ•™ç¨‹\] å¦‚ä½•åœ¨ Linux Kernel (V5.17.7) ä¸­æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆSystem callï¼‰
===========================================================

Â  Â  æœ€è¿‘åœ¨å­¦ä¹  ã€Šlinux Kernel Developmentã€‹ï¼Œæœ¬ä¹¦ç”¨çš„linux kernel æ˜¯v2.6 ç‰ˆæœ¬çš„ã€‚çœ‹å®Œâ€ç³»ç»Ÿè°ƒç”¨â€œä¸€èŠ‚åï¼Œæƒ³å°è¯•æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç„¶åé‡ç¼–ä¸€ä¸ªkernelã€‚ç»è¿‡å‡ ä¸ªå°æ—¶çš„å°è¯•ï¼Œå®ç°äº†è¿™ä¸ªå°åŠŸèƒ½ï¼Œå…¶ä¸­ä¹Ÿé‡åˆ°äº†ä¸å°‘å‘ï¼Œæœ¬æ–‡ä¸»è¦æ˜¯è®°å½•åˆ†äº«ä¸‹å¦‚ä½•åœ¨Linux Kernel (V5.17.7) ä¸­æ·»åŠ ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆSystem callï¼‰ã€‚

Â  Â  Â ç¼–kernelä¹‹å‰éœ€è¦æ³¨æ„ï¼š

Â  Â  Â  Â  Â  Â  Â  Â 1ã€ä¿®æ”¹çš„kernelæ˜¯ç›®å‰æœ€æ–°çš„release ç‰ˆæœ¬(V5.17.7), ä¹¦ä¸­v2.6ç‰ˆæœ¬çš„kernelå¤ªè€äº†ï¼Œgccéœ€è¦é™åˆ°4.8ç‰ˆæœ¬ï¼Œå¦åˆ™æ— æ³•ç¼–è¿‡ã€‚ kernel å‘å¸ƒåœ°å€ï¼šhttps://www.kernel.org/

Â  Â  Â  Â  Â  Â  Â  Â 2ã€éœ€è¦é€‰ç”¨å¤§å†…å­˜ï¼Œå¤šæ ¸çš„æœºå™¨ç¼–kernelï¼Œå¦åˆ™ä¼šå‡ºç°å„ç§å¼‚å¸¸é—®é¢˜ï¼Œè€Œä¸”ç¼–kernel å¾ˆè´¹æ—¶é—´ã€‚15GBå†…å­˜çš„æœºå™¨ï¼Œç¼–ä¸è¿‡kernelã€‚æ¢ç”¨100GBå†…å­˜çš„æœºå™¨å°±å¥½äº†ğŸ˜…

Â  Â  æœ¬æ–‡ä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ç‚¹å†…å®¹ï¼š

Â  Â  Â  Â  Â  Â  Â  Â 1ã€ç¯å¢ƒå‡†å¤‡

Â  Â  Â  Â  Â  Â  Â  Â 2ã€ä¿®æ”¹kernel

Â  Â  Â  Â  Â  Â  Â  Â 3ã€rebuild kernel ä»¥åŠå®‰è£…kernel

Â  Â  Â  Â  Â  Â  Â  Â 4ã€æµ‹è¯•ç»“æœ

1ã€ç¯å¢ƒå‡†å¤‡
======

Â  Â  Â æˆ‘ç¼–kernelçš„æœºå™¨æ˜¯ï¼šUbuntu 20.04.1 LTSï¼Œå†…å­˜180GB,Â  cores: 88

1.1 æ›´æ–°ç³»ç»Ÿçš„æº
----------

    sudo apt update && sudo apt upgrade -y

1.2 å®‰è£…ç¼–è¯‘kernel éœ€è¦çš„ä¾èµ–
--------------------

    sudo apt install build-essential libncurses-dev libssl-dev libelf-dev bison flex -y

æˆ‘è¿™é‡Œç”¨çš„vimï¼Œæ²¡æœ‰çš„è¯ä¹Ÿéœ€è¦å®‰è£…ï¼š

    sudo apt install vim -y

1.3 æ¸…é™¤å·²ç»å®‰è£…çš„packages
-------------------

    sudo apt clean && sudo apt autoremove -y

1.4 ä¸‹è½½kernel code
-----------------

    wget -P ~/ https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.17.7.tar.xz

    tar -xvf ~/linux-5.17.7.tar.xz -C ~/

2ã€ä¿®æ”¹kernel
==========

2.1 æ£€æŸ¥ä½ è‡ªå·±å½“å‰ç³»ç»Ÿçš„kernel ç‰ˆæœ¬
-----------------------

    uname -r

> 5.11.0-36-generic

é‡æ–°å®‰è£…kernelä¹‹åï¼Œè¿™ä¸ªç‰ˆæœ¬å·ä¼šè¢«ä¿®æ”¹ã€‚

2.2 åˆ‡æ¢åˆ°å·¥ä½œç›®å½•ä¸­ï¼Œç„¶ååˆ›å»ºè‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨
------------------------

    cd ~/linux-5.17.7/
    mkdir hello

Â 2.3 åˆ›å»ºè‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨
--------------

    vim hello/hello.c

Â æ·»åŠ ä»£ç ã€‚

    #include <linux/kernel.h>
    #include <linux/syscalls.h>
    
    SYSCALL_DEFINE0(hello)
    
    {
        printk("hello_system_call.\n");
        return 0;
    }

Â 2.4 ä¸ºä½ çš„ç³»ç»Ÿè°ƒç”¨åˆ›å»º Makefile
-----------------------

    vim hello/Makefile

Â æ·»åŠ ä¸‹é¢å†…å®¹ï¼š

    obj-y := hello.o

Â 2.5 å°†ä½ çš„ç³»ç»Ÿè°ƒç”¨æ·»åŠ åˆ°Kernel çš„makefileä¸­
--------------------------------

    vim Makefile

Â æœç´¢ core-yï¼Œ å®Œæˆå¦‚ä¸‹æ·»åŠ ï¼š

Â ![](https://img2022.cnblogs.com/blog/2642361/202205/2642361-20220515162411935-1108056021.png)

Â 2.6 å°†ç³»ç»Ÿè°ƒç”¨çš„ç›¸åº”å‡½æ•°åŸå‹æ·»åŠ åˆ°ç³»ç»Ÿè°ƒç”¨çš„å¤´æ–‡ä»¶ä¸­
-----------------------------

    vim include/linux/syscalls.h

æ·»åŠ ï¼š

    asmlinkage long sys_hello(void);

![](https://img2022.cnblogs.com/blog/2642361/202205/2642361-20220515162600233-1130732972.png)

2.7 åœ¨system\_table ä¸­ä¸ºä½ çš„ç³»ç»Ÿè°ƒç”¨å¼€è¾Ÿä¸€ä¸ªæ–°çš„ç³»ç»Ÿè°ƒç”¨å·ã€‚
---------------------------------------

    vim arch/x86/entry/syscalls/syscall_64.tbl

Â ![](https://img2022.cnblogs.com/blog/2642361/202205/2642361-20220515162819442-2019006145.png)

3ã€ç¼–è¯‘kernel å¹¶å®‰è£…
==============

Â  Â  å‰é¢çš„æ­¥éª¤éƒ½å¾ˆç®€å•ï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šå‡ºç°å„ç§é—®é¢˜ï¼Œè€Œä¸”å¾ˆè€—æ—¶ã€‚

3.1 åˆ›å»ºä½ çš„.config
---------------

Â  Â  è¿™é‡Œä¸€è·¯é»˜è®¤è®¾ç½®å°±å¥½ã€‚

    make menuconfig

3.2 æŸ¥è¯¢ä½ çš„æœºå™¨logicl cores æœ‰å¤šå°‘ä¸ª
---------------------------

    nproc

3.3 ç¼–è¯‘å®‰è£…ä½ çš„kernel
----------------

    make -j32
    echo $?  // make ç»“æŸä¹‹åè®°å¾—æ£€æŸ¥ä¸€ä¸‹ çŠ¶æ€
    ###if output is 0 then
    sudo make modules_install -j32
    echo $? 
    make install -j32

3.4 æŸ¥çœ‹kernel æ˜¯å¦å®‰è£…è¿›å»äº†
--------------------

    sudo update-grub
    sudo reboot

Â ![](https://img2022.cnblogs.com/blog/2642361/202205/2642361-20220515163432013-548984031.png)

4ã€æµ‹è¯•ç»“æœ
======

4.1 é¦–å…ˆcheck ä½ çš„kernel æ¢å¥½æ²¡
------------------------

    uname -r

4.2 ç¼–ä¸€ä¸ªcode è°ƒç”¨ä½ çš„ç³»ç»Ÿè°ƒç”¨
--------------------

Â  ç”±äºç³»ç»Ÿè°ƒç”¨ä¸åƒæ™®é€šå‡½æ•°é‚£æ ·ï¼Œéœ€è¦é€šè¿‡sys\_call ä»¥åŠç³»ç»Ÿè°ƒç”¨å·æ‰èƒ½å®ç°ç³»ç»Ÿè°ƒç”¨ã€‚åˆ›å»ºä¸€ä¸ªtest.c

    #include <linux/kernel.h>
    #include <sys/syscall.h>
    #include <stdio.h>
    #include <unistd.h>
    #include <string.h>
    #include <errno.h>
    #define __NR_hello 451
    
    long hello_syscall(void)
    {
        return syscall(__NR_hello);
    }
    int main(int argc, char *argv[])
    {
        long activity;
        activity = hello_syscall();
        if(activity < 0)
        {
            perror("Sorry, xxx. Your system call appears to have failed.");
        }
        else
        {
            printf("Congratulations, xxx! Your system call is functional. Run the command dmesg in the terminal and find out!\n");
        }
        return 0;
    }

4.3 æµ‹è¯•ç»“æœ
--------

    gcc -o test test.c
    ./test
    dmesg // åé¢ä¹Ÿèƒ½çœ‹åˆ°ç³»ç»Ÿè°ƒç”¨æ‰“å°çš„ä¿¡æ¯

> Â Congratulations, yaran! Your system call is functional. Run the command dmesg in the terminal and find out!