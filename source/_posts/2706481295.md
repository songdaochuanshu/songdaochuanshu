---
layout: post
title: "ä»0å¼€å§‹å†™ä¸€ä¸ªç®€å•çš„vite hmr æ’ä»¶"
date: "2022-10-15T21:20:05.275Z"
---
ä»0å¼€å§‹å†™ä¸€ä¸ªç®€å•çš„vite hmr æ’ä»¶
=====================

ä»0å¼€å§‹å†™ä¸€ä¸ªç®€å•çš„vite hmr æ’ä»¶
=====================

0\. å†™åœ¨å‰é¢
--------

* * *

ğŸ åœ¨æ„å»ºå‰ç«¯é¡¹ç›®çš„æ—¶å€™ï¼Œé™¤å¼€åŸºæœ¬çš„èµ„æºæ ¼å¼ï¼ˆå›¾ç‰‡ï¼Œjsonï¼‰ä»¥å¤–ï¼Œè¿˜å¸¸å¸¸ä¼šéœ€è¦å¯¼å…¥ä¸€äº›å…¶ä»–æ ¼å¼çš„èµ„æºï¼Œè¿™äº›èµ„æºå¦‚æœæ²¡æœ‰ç¬¬ä¸‰æ–¹viteæ’ä»¶çš„æ”¯æŒï¼Œå°±å¾ˆéš¾å¯¼å…¥ï¼Œäº†è§£viteå¯¼å…¥èµ„æºçš„æ–¹å¼å¯ä»¥å¸®åŠ©æˆ‘ä»¬åº”å¯¹å„ç§å¤æ‚çš„èµ„æºï¼Œåªéœ€è¦ä¸€å®šçš„è§£ææ‰‹æ®µï¼Œèµ„æºå¯ä»¥å…¨ç›˜æ¥æ”¶ã€‚

ğŸ æœ¬åšå®¢ä¸­ï¼Œå°†ä¼šä»0å¼€å§‹å†™ä¸€ä¸ªèƒ½å¤Ÿè§£æ(.todo)çš„viteæ’ä»¶ï¼Œ æä¾›æœ€åŸºç¡€çš„HMRåŠŸèƒ½

å” å¨åŠå¤©ï¼Œèµ¶ç´§å¼€å§‹å§

![](https://pic1.imgdb.cn/item/634a74dd16f2c2beb1411d08.png)

1\. åˆå§‹åŒ–é¡¹ç›®
---------

ç”±äºæ˜¯çœŸä»0å¼€å§‹ï¼Œæˆ‘ä»¬è¿™é‡Œä¸é€‰æ‹©viteå®˜æ–¹æä¾›çš„create-viteï¼Œè€Œæ˜¯é€šè¿‡ä¾èµ–å®‰è£…çš„æ–¹å¼ä¸€æ­¥æ­¥æ­å»ºèµ·æ¥ä¸€ä¸ªvite-plugin

æŒ‰ç…§ä½ ä¹ æƒ¯çš„æ–¹å¼åˆå§‹åŒ–é¡¹ç›®

    mkdir vite-plugin-todo
    
    // pnpm
    pnpm init
    
    // yarn 
    yarn init
    
    // npm
    npm init
    
    cd vite-plugin-todo
    

å®‰è£…vite

    // pnpm
    pnpm add vite
    
    // yarn 
    yarn add vite
    
    // npm
    npm add vite
    

åˆå§‹åŒ–é¡¹ç›®ç›®å½•

    // ç”¨æ¥ä½œä¸ºviteçš„å…¥å£ï¼Œä»¥åŠé¡µé¢å±•ç¤º
    touch index.html 
    
    // srcæ–‡ä»¶å¤¹ä»¥åŠmainå…¥å£
    mkdir src
    touch src/main.ts
    
    // pluginsæ–‡ä»¶å¤¹ï¼Œå­˜æ”¾æˆ‘ä»¬çš„viteæ’ä»¶
    mkdir plugins
    
    // åˆ›å»ºviteé…ç½®æ–‡ä»¶, ä»¥åŠviteç¯å¢ƒé…ç½®æ–‡ä»¶
    touch vite.config.ts
    touch src/vite-env.d.ts
    

åœ¨index.html ä¸­æ·»åŠ main.ts å…¥å£

    // index.html
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>vite-hmr-plugin-test</title>
    </head>
    <body>
    		<!--è¿™é‡Œæ·»åŠ main.ts å…¥å£-->
        <script src="/src/main.ts" type="module"></script>
    </body>
    </html>
    

ä¿®æ”¹package.json çš„å‘½ä»¤

    {
      "name": "vite-plugin-todo",
      "version": "1.0.0",
      "description": "",
      "main": "index.js",
      "scripts": {
        "dev": "vite dev"
      },
      "keywords": [],
      "author": "",
      "license": "ISC",
      "dependencies": {
        "@types/node": "^18.8.5",
        "vite": "^3.1.8"
      }
    }
    

ä¸ºäº†ä½¿å¾—typescriptèƒ½å¤Ÿè§£ænodejsæ¨¡å—

    pnpm add @types/nodejs
    
    yarn add @types/nodejs
    
    npm install @types/nodejs
    

å°è¯•ä¸€ä¸‹`pnpm dev` æ²¡æŠ¥é”™çš„è¯å°±OKäº†

é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹

![](https://pic1.imgdb.cn/item/634a74dd16f2c2beb1411cfd.png)

2\. åˆè¯†vite plugin
-----------------

### 2.1 vite æ’ä»¶æ˜¯ä»€ä¹ˆ

ğŸ viteæ’ä»¶æ˜¯ä¸ºäº†ä¸°å¯ŒviteåŠŸèƒ½çš„å¤‡é€‰é¡¹ï¼Œä»viteå®˜ç½‘ä¸Šçœ‹ï¼Œviteåªæä¾›äº†ä¸€äº›æ¯”è¾ƒåŸºæœ¬çš„åŠŸèƒ½ï¼Œæ›´åŠ ä¸°å¯Œçš„åŠŸèƒ½å…¶å®æ˜¯äº¤ç»™å„ä½æ¥å®ç°çš„ï¼Œå¦‚vueçš„viteæ’ä»¶ï¼Œreactçš„viteæ’ä»¶ç­‰ç­‰ã€‚

### 2.2 vite æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

åœ¨è¯´viteæ’ä»¶ç”Ÿå‘½å‘¨æœŸä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆå®Œå–„ä¸€ä¸‹vite.config.ts

    import { defineConfig } from "vite";
    
    export default defineConfig({
        plugins: [
            // Plugins
        ],
        assetsInclude: [
            "src/**/*.todo"
        ]
    })
    

*   å®šä¹‰å¹¶å¯¼å‡ºä¸€ä¸ªé…ç½®
*   `plugins` æ˜¯ç”¨æ¥å­˜æ”¾viteæ’ä»¶å®ä¾‹çš„
*   `assetsInclude` æ˜¯ç”¨æ¥æŒ‡æ˜éœ€è¦è§£æçš„èµ„æºè·¯å¾„çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥`.todo` ä¸ºèµ„æºåç¼€

![](https://pic1.imgdb.cn/item/634a74dd16f2c2beb1411d01.png)

æ’ä»¶ç”Ÿå‘½åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œå¯åŠ¨æ—¶ï¼Œæ¨¡å—ä¼ å…¥æ—¶ï¼ŒæœåŠ¡å™¨å…³é—­æ—¶

å…³äºè¿™å‡ ä¸ªæ¨¡å—çš„å…·ä½“è¯´æ˜è§viteå®˜æ–¹æ–‡æ¡£ã€‚

è¿™é‡Œåªè¯´æˆ‘ä»¬ç”¨åˆ°çš„`transform`

ä»åå­—å¯ä»¥çœ‹å‡ºæ˜¯æœ‰å…³å˜åŒ–çš„å‡½æ•°ï¼Œå®ƒçš„ä½œç”¨æ­£æ˜¯åœ¨æˆ‘ä»¬æ‰§è¡Œå¯¼å…¥çš„æ—¶å€™ï¼Œæä¾›æ£€æµ‹çš„å‡½æ•°ã€‚

![](https://pic1.imgdb.cn/item/634a753f16f2c2beb141c60f.png)

æ¯å½“æ‰§è¡Œå†™ä¸€ä¸ªimportï¼Œviteå°±ä¼šæŠŠè¿™ä¸ªä¿¡æ¯ä¼ é€’åˆ°æ¯ä¸€ä¸ªæ’ä»¶çš„transformä¸­

æ’ä»¶æ ¹æ®æ‰€éœ€è½¬åŒ–è‡ªå·±éœ€è¦çš„.

transformæ¥æ”¶ä¸¤ä¸ªå‚æ•°,srcä¸ºå¯¼å…¥çš„æ–‡æœ¬å†…å®¹ï¼Œå¦å¤–ä¸€ä¸ªidåˆ™æ˜¯æ­¤æ¨¡å—çš„ç»å¯¹è·¯å¾„**ï¼ˆå¯ä»¥é€šè¿‡ç»å¯¹è·¯å¾„è¿›è¡Œæ–‡ä»¶ç±»å‹åˆ¤æ–­ï¼‰**

    transform(src, id) {
    		
    		return {
    				code: "",
    				// ...
    		}
    }
    

### 2.3 vite æ’ä»¶æ˜¯æ€ä¹ˆæä¾›å…¶ä»–èµ„æºå¯¼å…¥çš„åŠŸèƒ½çš„ï¼Ÿ

å‰é¢æåˆ°çš„transformå‡½æ•°æ˜¯ä¸€ä¸ªè§£æå‡½æ•°ï¼Œå½“é€šè¿‡importå¯¼å…¥çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ï¼Œç„¶åç»è¿‡ä¸€å®šå¤„ç†ä¹‹åè¿”å›ã€‚

æ‰€ä»¥ä½ åº”è¯¥æƒ³åˆ°äº†ï¼Œå…¶ä»–çš„èµ„æºåº”è¯¥æ˜¯ä»¥æŸç§ç¬¦åˆjsè¯­æ³•çš„æ–¹æ³•å¯¼å…¥äº†ï¼Œè€Œè¿™ä¸ªå¤„ç†è¿‡ç¨‹transformå®ç°äº†è¿™ä¸ªè¿‡ç¨‹ï¼Œè®©ä¸€ä¸ªåŸæœ¬ä¸ç¬¦åˆjsè¯­æ³•çš„èµ„æºï¼Œå˜çš„åˆæ³•äº†ã€‚

![](https://pic1.imgdb.cn/item/634a753f16f2c2beb141c613.png)

é‚£ä¹ˆè¯´åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ

ç­”ï¼šé€šè¿‡æ³¨å…¥çš„æ–¹æ³•ã€‚

![](https://pic1.imgdb.cn/item/634a753f16f2c2beb141c627.png)

åœ¨æµè§ˆå™¨åŠ è½½ä¹‹å‰ï¼Œviteå…ˆå¸®ä½ æŠŠå„ç§importæ¨¡å—å…¨éƒ¨è½¬æ¢å¥½ï¼Œè½¬æ¢ä¸ºå¦‚ä¸Šçš„å½¢å¼ï¼Œé‚£ä½ è¯´è¿™éƒ½å®šä¹‰æˆå˜é‡äº†ï¼Œæµè§ˆå™¨è‚¯å®šè®¤å•Šï¼Œå¯¹å§ï¼

é‚£ä½ å¯èƒ½ä¼šé—®æˆ‘è¿˜æ˜¯ä¸æ˜ç™½ï¼Œåˆ°åº•æ€ä¹ˆè½¬æ¢çš„ï¼Œå…¶å®å°±æ˜¯é€šè¿‡transformçš„è¿”å›å€¼æ¥è§£æè½¬æ¢çš„ã€‚

    transform(src, id) {
    		// è§£æè¿™ä¸ªæ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯ä½ è¦çš„type
    		// æ‰§è¡Œè½¬æ¢
    		// æŠŠè½¬æ¢çš„ç»“æœå¯ä»¥é€šè¿‡ `` æ’å€¼åˆ°codeé‡Œé¢
    		return {
    				code: "", // è½¬æ¢åçš„ä»£ç 
    				// ...
    		}
    }
    

### 2.4 viteæ’ä»¶é•¿ä»€ä¹ˆæ ·ï¼Ÿ

    export default function todoParser() {
    		// æ’ä»¶åˆ›å»ºä¹‹åˆçš„ä»£ç ï¼Œå¯ä»¥åœ¨è¿™é‡Œé…ç½®æ’ä»¶æ‰€éœ€çš„èµ„æº
    				
    
    		return {
    				name: "todo-parser", // æ’ä»¶å
    				
    				// ç”Ÿå‘½å‘¨æœŸå‡½æ•°
    				
    				transform(src, id) {
    					// è§£æè¿™ä¸ªæ–‡ä»¶ï¼Œæ˜¯ä¸æ˜¯ä½ è¦çš„type
    					// æ‰§è¡Œè½¬æ¢
    					// æŠŠè½¬æ¢çš„ç»“æœå¯ä»¥é€šè¿‡ `` æ’å€¼åˆ°codeé‡Œé¢
    					return {
    							code: "", // è½¬æ¢åçš„ä»£ç 
    							// ...
    					}
    			}
    		}
    }
    

### 2.5 å¦‚ä½•è®©typescriptæ”¯æŒå¯¼å…¥è¿™ä¸ªæ¨¡å—ï¼Ÿ

å›åˆ°ä¹‹å‰ï¼Œæˆ‘ä»¬ä¸æ˜¯è¯´viteæ’ä»¶ä¸­transformèƒ½å¤Ÿä¸°å¯Œèµ„æºçš„å¯¼å…¥ï¼Œ

ä½†æ˜¯è¿™ä¸ä»£è¡¨typescriptå°±è®¤å¯ï¼Œä¸è®¤å¯ä¾ç„¶ä¸èƒ½æä¾›å®Œå¤‡çš„è¡¥å…¨å’Œæ£€æŸ¥ï¼Œ

æ‰€ä»¥ä¸ºäº†è®©typescriptå½»åº•æœæ°”ï¼Œå°±éœ€è¦åœ¨**vite-env.d.ts**ä¸­å†™ä¸€æ®µæ¨¡å—è§£æçš„é…ç½®

    // vite-env.d.ts
    
    declare module '*.todo' {
        export const data: string;
        export function parser(content: string);
    }
    

è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªæ¨¡å—ï¼Œå¹¶å¯¼å‡ºäº†ä¸¤ä¸ªæˆå‘˜

ä¸€ä¸ªå«data, æ˜¯stringç±»å‹çš„èµ„æº

ä¸€ä¸ªå«parserï¼Œæ˜¯ä¸ªè§£æå‡½æ•°ï¼ˆç¨åä¼šä»‹ç»ï¼‰

è¿™æ ·å†™äº†ä¹‹åï¼Œtypescriptå°±ä¼šé»˜è®¤æˆ‘ä»¬èƒ½å¤Ÿå¯¼å…¥`.todo` åç¼€çš„æ–‡ä»¶ï¼Œå¹¶ä¸”è¿™é‡Œé¢æœ‰ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯dataï¼Œä¸€ä¸ªæ˜¯parserã€‚

3\. todoæ’ä»¶ç¼–å†™
------------

ğŸ éœ€æ±‚å¾ˆç®€å•ï¼ŒæŠ›ç –å¼•ç‰~

    O åƒé¥­
    X å–æ°´
    O è·‘æ­¥äº”å…¬é‡Œ
    

è¿™æ ·ä¸€ç§æ–‡æœ¬ï¼ŒOè¡¨ç¤ºæœªå®Œæˆï¼ŒXè¡¨ç¤ºå®Œæˆï¼Œåé¢è¡¨ç¤ºå½“å‰todoçš„ä¿¡æ¯

### 3.1 todoæ’ä»¶

åœ¨pluginsä¸­åˆ›å»ºä¸€ä¸ª`todoParser.ts`

    export default function todoParser(): Plugin {
        let todoFileRegex = /\.(todo)$/;
    		// è§£æ.todo çš„æ­£åˆ™
      
        return {
            name: "todo-parser",
            transformIndexHtml(html) {
                return html.replace(/<title>(.*?)<\/title>/, '<title>TODO Parser</title>');
            },
    
            async transform(src, id) {
                // module inject
                console.log(id);
    						 // çœ‹çœ‹å½“å‰æ–‡ä»¶æ˜¯å¦é€šè¿‡äº†æ­£åˆ™ï¼Œå¦‚æœé€šè¿‡äº†ï¼Œå°±æ‰§è¡Œ
                if (todoFileRegex.test(id)) {  
                    return {
                        // è¿™é‡Œçš„parseræ˜¯è§£æå™¨ï¼Œç¨åä¼šè¯´
                        code: `
                        export let data = "${parser(src)}"
                        export ${parser}
    											`
                    };
                }
            }
        }
    }
    

ç›¸ä¿¡é˜…è¯»äº†å‰é¢æœ‰å…³viteæ’ä»¶çš„ä»‹ç»åº”è¯¥ä¸éš¾ç†è§£

### 3.2 parser

ä¸ºäº†èƒ½å¤Ÿè§£æ.todoæ–‡ä»¶ï¼Œå¹¶ä¸”è¾“å‡ºæˆ‘ä»¬å¸Œæœ›çš„å†…å®¹ï¼Œ

è¿˜éœ€è¦æä¾›è§£æä¸€ä¸ªè§£æå™¨æ¥è§£æã€‚

    // todoParser.ts
    
    function parser(src: string) {
        // è§£æ
        
        const lines = src.split('\n');
        let todoList = "";
        let finishRegex = /^X/;
        let readyRegex = /^O/;
        let content = /\s(.*)$/
        let randomId: string;
        for (let line of lines) {
            randomId = Math.random().toString(32).slice(2);
            let html: string;
            if (finishRegex.test(line)) {
                console.log(line);
                html = `<li><input type='checkbox' checked id='${randomId}'/><label for='${randomId}'>${line.trim().match(content)![1]}</li>`
                console.log("é€šè¿‡",html);        
            } else if (readyRegex.test(line)) {
                html = `<li><input type='checkbox' id='${randomId}'/><label for='${randomId}'>${line.trim().match(content)![1]}</li>`
                console.log("æ‹’ç»",html);        
            }
            todoList += html!;
        }
        return todoList;
    }
    

æˆ‘ä»¬è¿™é‡Œé€šè¿‡æ­£åˆ™è·å–äº†æ¯ä¸€è¡Œæ•°æ®ä¸­è¡¨ç¤ºçŠ¶æ€çš„ OX, ä»¥åŠå…¶å†…å®¹ï¼Œå¹¶ä¸”å°è£…ä¸ºä¸€ç»„checkbox

è¿™äº›æ–‡æœ¬ä¿¡æ¯å¯ä»¥ç›´æ¥æ’å…¥htmlä»¥æ˜¾ç¤ºå…¶å†…å®¹

### 3.3 æ’ä»¶çš„è£…è½½

    import { defineConfig } from "vite";
    import todoParser from './plugins/todoParser';
    
    export default defineConfig({
        plugins: [
            todoParser()
        ],
        assetsInclude: [
            "src/**/*.todo"
        ]
    })
    

å›åˆ°vite.config.tsä¸­ï¼Œåœ¨pluginsæ•°ç»„å†…éƒ¨ç›´æ¥æ‰§è¡ŒtodoParser()ï¼Œå®ç°æ’ä»¶çš„è£…è½½

åœ¨main.ts ä¸­æ¥æ”¶è¿™ä¸ªå¯¼å…¥çš„èµ„æºï¼Œå¹¶ä¸”èµ‹å€¼åˆ°documentä¸­

    import { data } from './assets/journey.todo'
    import './style.css'; // æ ·å¼ï¼Œè¿™é‡Œæ¶ˆé™¤äº†liçš„ä¸€èˆ¬æ ·å¼ list-style: none
    
    console.log(data);
    document.body.innerHTML = data;
    

![](https://pic1.imgdb.cn/item/634a74dd16f2c2beb1411d15.gif)

*   ä¸Šé¢çš„é¢„è§ˆå›¾å¯ä»¥å‘ç°æˆ‘ä»¬å®ç°äº†åŠŸèƒ½ï¼Œä½†æ˜¯æ¯æ¬¡ä¸€å†™å®Œï¼Œæ•´ä¸ªé¡µé¢å°±ä¼šå…¨éƒ¨åˆ·æ–°ï¼Œè¿™å¯ä¸å¤ªå¥½ï¼Œæ‰€ä»¥è¿˜éœ€è¦HMR

4\. HMR å®ç°
----------

ğŸ viteçš„HMRæ˜¯é€šè¿‡viteçš„websocketæ¥å®ç°çš„

![](https://pic1.imgdb.cn/item/634a753f16f2c2beb141c60c.png)

æ³¨æ„ï¼Œviteä¸­serverå’Œclientæ˜¯å¯ä»¥ç›¸äº’é€šä¿¡ï¼è¿™é‡Œåªéœ€è¦serverå‘clientå‘é€æ¶ˆæ¯

### 4.1 server å‘é€

viteæœåŠ¡å™¨å®ä¾‹çš„è·å–æœ‰å¾ˆå¤šç§æ–¹æ³•ï¼š

1.  ç›´æ¥é€šè¿‡viteé’©å­ configureServer(server) {}è·å–
    
    ä¸€èˆ¬ç”¨æ¥ç»™viteæœåŠ¡å™¨æ·»åŠ ä¸­é—´ä»¶
    
2.  é€šè¿‡å¤„ç†æ›´æ–°çš„é’©å­è·å– handleHotUpdate({file, server, modules}){}
    

è¿™é‡Œæˆ‘ä»¬è¦å®ç°çš„æ˜¯çƒ­æ›´æ–°ï¼Œæ‰€ä»¥é‡‡ç”¨handleHotUpdateå°±å¯ä»¥äº†ï¼Œåœ¨æ¨¡å—æ›´æ–°çš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªå‡½æ•°ï¼Œé€šè¿‡serverå‘clientå‘é€æ›´æ–°çš„æ¶ˆæ¯ï¼Œä»¥åŠæ›´æ–°çš„æ•°æ®ï¼Œç„¶åè®©æµè§ˆå™¨åœ¨æœªåˆ·æ–°çš„æƒ…å†µä¸‹ç›´æ¥æ›´æ–°

    async handleHotUpdate({ server, file, modules }) {
        let fileData = await fs.readFile(modules[0].id as string);
        server.ws.send({
            type: 'custom',
            event: 'special-update', // äº‹ä»¶å
            data: {
                msg: "Update from server",
                updateVal: fileData.toString()
            }
        })
        console.log(`${file} should be updated`);
        
        return [];
    }
    

é€šè¿‡nodeçš„fsæ¨¡å—è¯»å–åˆ°äº†æ–‡æœ¬çš„æ•°æ®

éšåé€šè¿‡server.ws.send()å‘clientå‘é€çš„æ•°æ®ï¼Œå…¶ä¸­æ›´æ–°ä¹‹åçš„æ•°æ®å­˜æ”¾åœ¨data.updateValä¸­

### 4.2 client è·å–

åœ¨viteä¸­ï¼Œæ¨¡å—çƒ­æ›´æ–°ä»¥äº‹ä»¶çš„å½¢å¼æŠ›å‡ºï¼Œå…·ä½“æ¥è¯´æ˜¯

    import.meta.hot.on('xxxäº‹ä»¶', () => {} /*äº‹ä»¶å›è°ƒ*/)
    

æˆ‘ä»¬è¿™é‡Œç¼–å†™å¦‚ä¸‹ä»£ç 

    if (import.meta.hot) {
        import.meta.hot.on('special-update', (data) => {
            data = parser(data.updateVal);
            document.body.innerHTML = data;
        })
    }
    

å¦‚æœæ›´æ–°äº†ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œparserï¼Œè§£ææ•°æ®ï¼Œæœ€åæŠŠæ•°æ®èµ‹å€¼åˆ°document.body.innerHtmlä¸Šã€‚

é‚£è¿™ä¸ªä»£ç åº”è¯¥å†™åœ¨å“ªå„¿å‘¢ï¼Ÿ

ç­”åº”è¯¥å†™åœ¨ï¼Œæ¨¡å—å¯¼å…¥çš„æœªçŸ¥ï¼Œä¹Ÿå°±æ˜¯`transform`å‡½æ•°çš„`è¿”å›å€¼`ä¸­

è¿™æ ·æ‰èƒ½ä¿è¯æ¯ä¸€ä¸ª`.todo`æ¨¡å—éƒ½èƒ½å¤Ÿçƒ­æ›´æ–°ï¼

    // å®Œæ•´çš„parser
    export default function todoParser(): Plugin {
        let todoFileRegex = /\.(todo)$/;
    
        // local variable
        function log(msg) {
            console.log(msg);
        }
    
        return {
            name: "todo-parser",
            transformIndexHtml(html) {
                return html.replace(/<title>(.*?)<\/title>/, '<title>TODO Parser</title>');
            },
    
            transform(src, id) {
                // module inject
                console.log(id);
                if (todoFileRegex.test(id)) {  
                    return {
                        code: `
                        export let data = "${parser(src)}"
                        export ${parser}
                        if (import.meta.hot) {
                            import.meta.hot.on('special-update', (data) => {
                                data = parser(data.updateVal);
                                document.body.innerHTML = data;
                            })
                        }
                        `,
                        
                    };
                }
            },
    
            async handleHotUpdate({ server, file, modules }) {
                let fileData = await fs.readFile(modules[0].id as string);
                server.ws.send({
                    type: 'custom',
                    event: 'special-update',
                    data: {
                        msg: "Update from server",
                        updateVal: fileData.toString()
                    }
                })
                console.log(`${file} should be updated`);
                
                return [];
            }
        }
    }
    

![](https://pic1.imgdb.cn/item/634a74dd16f2c2beb1411d24.gif)

*   å¦‚æ­¤ç®€å•çš„HMRå°±å®ç°äº†ï¼Œç”»é¢ä¸ä¼šé‡æ–°åŠ è½½äº†ã€‚

5\. å†™åœ¨æœ€å
--------

HMRæœ€å¥½è¿˜æ˜¯ç²¾ç¡®åˆ°å…ƒç´ ï¼Œæ‰€ä»¥æœ€å¥½ç»™parseræä¾›ä¸€ä¸ªèƒ½å¤Ÿç²¾ç¡®å®šä½åˆ°å…ƒç´ çš„idï¼Œä»¥ä¾¿æ¨¡å—æ›´æ–°çš„æ—¶å€™ï¼Œèƒ½å¤Ÿç²¾ç¡®å®šä½åˆ°å¯¹äºçš„å…ƒç´ ä»¥æ›´æ–°ï¼Œè€Œä¸æ˜¯æŠŠæ‰€æœ‰çš„èµ„æºé‡æ–°åŠ è½½ä¸€éã€‚

6\. æ‹“å±•é˜…è¯»
--------

å¼ºçƒˆå»ºè®®å»é˜…è¯»viteå®˜æ–¹æ–‡æ¡£ï¼Œå†™çš„çœŸçš„å¾ˆè¯¦ç»†ã€‚

å¦å¤–ï¼Œviteçš„æ¨¡å—è§£æï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯é€šè¿‡rollupæ¥å®ç°çš„ï¼Œæ‰€ä»¥å¯ä»¥å»å­¦å­¦rollupçš„è§£æï¼ŒåŠ æ·±ç†è§£ã€‚

7\. ä»£ç 
------

[Mushrr/vite-hmr-plugin-test (github.com)](https://github.com/Mushrr/vite-hmr-plugin-test)