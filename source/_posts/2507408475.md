---
layout: post
title: "CAP 6.2 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š"
date: "2022-09-19T10:25:24.473Z"
---
CAP 6.2 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š
==============

### å‰è¨€

ä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´å®£å¸ƒ CAP å‘å¸ƒ 6.2 ç‰ˆæœ¬æ­£å¼ç‰ˆï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸»è¦åšäº†ä¸€äº›åŠŸèƒ½ä¼˜åŒ–ï¼Œä»¥åŠé’ˆå¯¹ç›®å‰å·²ç»å‘ç°çš„å‡ ä¸ª BUG è¿›è¡Œäº†ä¿®å¤äº†ã€‚

é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹å§ã€‚

### æ€»è§ˆ

å¯èƒ½æœ‰äº›äººè¿˜ä¸çŸ¥é“ CAP æ˜¯ä»€ä¹ˆï¼Œè€è§„çŸ©æ¥ä¸€ä¸ªç®€ä»‹ã€‚

[CAP](https://github.com/dotnetcore/CAP) æ˜¯ä¸€ä¸ªç”¨æ¥è§£å†³å¾®æœåŠ¡æˆ–è€…åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ä¸€ä¸ªå¼€æºé¡¹ç›®è§£å†³æ–¹æ¡ˆï¼ˆ[https://github.com/dotnetcore/CAP](https://github.com/dotnetcore/CAP)ï¼‰åŒæ ·å¯ä»¥ç”¨æ¥ä½œä¸º EventBus ä½¿ç”¨ï¼Œè¯¥é¡¹ç›®è¯ç”Ÿäº2016å¹´ï¼Œç›®å‰åœ¨ Github å·²ç»æœ‰è¶…è¿‡ 5500+ Star å’Œ 70+ è´¡çŒ®è€…ï¼Œä»¥åŠåœ¨ NuGetè¶… 250 ä¸‡çš„ä¸‹è½½é‡ï¼Œå¹¶åœ¨è¶Šæ¥è¶Šå¤šå…¬å¸çš„å’Œé¡¹ç›®ä¸­å¾—åˆ°åº”ç”¨ã€‚

å¦‚æœä½ æƒ³å¯¹ CAP æ›´å¤šäº†è§£ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [å®˜æ–¹æ–‡æ¡£](http://cap.dotnetcore.xyz)ã€‚

æœ¬æ¬¡åœ¨ CAP 6.2 ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸»è¦å¸¦æ¥äº†ä»¥ä¸‹æ–°ç‰¹æ€§ï¼š

*   Dashboard æ·»åŠ ä¸­æ–‡æ”¯æŒ
*   äº‹åŠ¡å¯¹è±¡æ›´å‹å¥½çš„å¯¹æ¥ç¬¬ä¸‰æ–¹ORM
*   æ¶ˆè´¹æ‰§è¡Œæ¶ˆæ¯å¤´è®°å½• InstanceId
*   å¯åŠ¨æ—¶å¯¹ä½äºç›¸åŒç»„çš„è®¢é˜…è€…è¿›è¡Œè­¦å‘Š
*   BUG ä¿®å¤
    *   Snowflake Id ç®—æ³•ç”Ÿæˆæ—¶æ’é™¤è™šæ‹Ÿï¼Œå›ç¯å’Œç¦ç”¨çš„ç½‘å¡
    *   ä¿®å¤ RabbitMQ ä¸¢å¤±è¿æ¥å¹¶å¿«é€Ÿæ¢å¤æ—¶çš„å¥åº·æ£€æµ‹Bugã€‚
    *   ä¿®å¤ Dashboard ä»£ç†æŸ¥è¯¢ç¼ºå¤± QueryString çš„é—®é¢˜ã€‚
    *   ä¿®å¤ MongoDB æŸ¥è¯¢å…ƒç´ æœªæ³¨å†Œä¸è¿”å›ç»“æœçš„Bugã€‚
    *   ä¿®å¤ Scoped ç”Ÿå‘½å‘¨æœŸå·¥å‚æ¨¡å¼æ³¨å†Œçš„è®¢é˜…è€…æŠ¥é”™çš„Bugã€‚

### Dashboard æ·»åŠ ä¸­æ–‡æ”¯æŒ

æˆ‘ä»¬åœ¨ 5.1.1 ç‰ˆæœ¬ä¸­ä½¿ç”¨ Vue é‡æ„äº†æˆ‘ä»¬çš„ Dashboardï¼Œç”±äºæ—¶é—´åŸå› ï¼Œæˆ‘ä»¬çš„æ–°ç‰ˆæœ¬çš„ Dashboard åªå¯¹è‹±æ–‡æä¾›äº†æ”¯æŒã€‚

åœ¨è¯¥ç‰ˆæœ¬ä¸­æˆ‘ä»¬é‡æ–°æä¾›äº†å¯¹ä¸­æ–‡çš„æ”¯æŒï¼Œç›®å‰å¯è‡ªåŠ¨æ ¹æ®ä½ çš„æµè§ˆå™¨æ£€æµ‹ä½¿ç”¨çš„è¯­è¨€å¹¶å±•ç¤ºã€‚

ä½ ä¹Ÿå¯ä»¥åœ¨å³ä¸Šæ–¹è¿›è¡Œæ‰‹åŠ¨åˆ‡æ¢ã€‚

![](https://img2022.cnblogs.com/blog/250417/202209/250417-20220919154625423-1683042435.png)

æ„Ÿè°¢ [@tetris1128](https://github.com/tetris1128) å¯¹æ­¤æäº¤çš„PRï¼

### äº‹åŠ¡å¯¹æ¥ç¬¬ä¸‰æ–¹ ORM æ›´åŠ å‹å¥½

åœ¨ CAP ä¸­ï¼Œäº‹åŠ¡å¯¹è±¡éœ€è¦äº¤ç»™ CAP è¿›è¡Œæäº¤ä»è€Œåœ¨äº‹åŠ¡å®ç°æäº¤åå¯¹ç¼“å­˜æ¶ˆæ¯åˆ° Broker çš„ Flush åŠ¨ä½œï¼Œè€Œç›®å‰çš„Ormå¤§éƒ¨åˆ†éƒ½æœ‰è‡ªå·±çš„äº‹åŠ¡ç®¡ç†å¯¹è±¡è¿›è¡Œäº‹åŠ¡çš„æäº¤ã€‚CAPå®˜æ–¹ç›´æ¥åŸç”Ÿæ”¯æŒä½¿ç”¨ ADO.NET å’Œ EntityFrameworkCore è¿›è¡Œäº‹åŠ¡é›†æˆï¼Œè€Œå¯¹äºç¬¬ä¸‰æ–¹ORMåˆ™éœ€è¦è‡ªè¡Œæ‰©å±•ã€‚

åœ¨æœ¬ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åšäº†ä¸€ä¸ªå°è°ƒæ•´ï¼ˆå°† CapTransactionBase ä¸­çš„ DbTransaction è®¾ç½®ä¸ºäº† Virtualï¼‰ï¼Œæ²¡æƒ³åˆ°è¿™ä¸ªå°è°ƒæ•´è®©æˆ‘ä»¬å¯¹ç¬¬ä¸‰æ–¹ORMçš„å…¼å®¹æ€§å¾—åˆ°äº†å¤§å¤§å¢å¼ºï¼Œç°åœ¨ç¬¬ä¸‰æ–¹ORMå¯ä»¥æ›´åŠ å‹å¥½çš„å¯¹æ¥CAPã€‚

ä»¥ä¸‹æ˜¯2ä¸ªç¬¬ä¸‰æ–¹ORMçš„é›†æˆç¤ºä¾‹ï¼š

*   [FreeSql](https://github.com/dotnetcore/freesql) Repository+UnitOfWork äº‹åŠ¡æ¨¡å¼ å’Œ CAP çš„ é›†æˆ
*   [Chloe Orm](https://github.com/shuxinqin/Chloe/issues/328) å’Œ CAP çš„é›†æˆ

**[FreeSql](https://github.com/dotnetcore/freesql) Repository+UnitOfWork äº‹åŠ¡æ¨¡å¼ å’Œ CAP çš„ é›†æˆç¤ºä¾‹å¦‚ä¸‹ï¼š**

    public class FreeSqlRepositoryPatternTransaction : CapTransactionBase
    {
        public FreeSqlRepositoryPatternTransaction(IDispatcher dispatcher, IUnitOfWork uow) : base(dispatcher)
        {
            Uow = uow;
        }
    
        public IUnitOfWork Uow { get; }
    
        public override object? DbTransaction => Uow.GetOrBeginTransaction();
    
        public override void Commit()
        {
            Uow.Commit();
            Flush();
        }
    
        public override Task CommitAsync(CancellationToken cancellationToken = default)
        {
            throw new NotImplementedException();
        }
    
        public override void Rollback()
        {
            Uow.Rollback();
        }
    
        public override Task RollbackAsync(CancellationToken cancellationToken = default)
        {
            throw new NotImplementedException();
        }
    
        public override void Dispose()
        {
            Uow.Dispose();
        }
    }
    
    public static class Extensions
    {
          // æ³¨æ„ï¼šä½ å¯ä»¥é…Œæƒ…ä¿®æ”¹æ­¤æ‰©å±•ä»¥æ”¯æŒä½ çš„ä½¿ç”¨ä¹ æƒ¯
          public static ICapTransaction BeginTransaction(this IFreeSql freeSql,
              ICapPublisher publisher, out IRepositoryUnitOfWork uow, bool autoCommit = false)
          {
              var dispatcher = publisher.ServiceProvider.GetRequiredService<IDispatcher>();
              uow = freeSql.CreateUnitOfWork();
              var transaction = new FreeSqlRepositoryPatternTransaction(dispatcher, uow)
              {
                  AutoCommit = autoCommit
              };
              return publisher.Transaction.Value = transaction;
          }
    }
    

ä½¿ç”¨å‘é€å¸¦æœ‰äº‹åŠ¡çš„æ¶ˆæ¯ã€‚

    [Route("~/with/test")]
    public IActionResult WithTransaction()
    {
          using (var transaction = _freeSql.BeginTransaction(_capBus, out var uow, false))
          {
              _capBus.Publish("sample.rabbitmq.mysql", DateTime.Now);
    
              var person = _freeSql.GetRepository<Person2>();
              person.UnitOfWork = uow;
              person.Insert(new Person2() { Name = "HelloWorld2" });
    
              transaction.Commit();
          }
    
        return Ok();
    }
    

ä½ å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/dotnetcore/FreeSql/discussions/1202)æŸ¥çœ‹åˆ° FreeSql DbContext äº‹åŠ¡æ¨¡å¼çš„å¯¹æ¥æ–¹å¼ã€‚

**[Chloe Orm](https://github.com/shuxinqin/Chloe/issues/328) å’Œ CAP è¿›è¡Œé›†æˆå¦‚ä¸‹ï¼š**

    public class ChloeTransaction : CapTransactionBase
    {
    
        public ChloeTransaction(IDispatcher dispatcher, IDbSession session) : base(dispatcher)
        {
            DbSession = session;      
        }
    
        public IDbSession DbSession { get; set; }
    
        public override object? DbTransaction => DbSession.CurrentTransaction;
    
        public override void Commit()
        {
            DbSession.CommitTransaction();
            Flush();
        }
    
        public override Task CommitAsync(CancellationToken cancellationToken = default)
        {
            throw new NotImplementedException();
        }
    
        public override void Rollback()
        {
            DbSession.RollbackTransaction();
        }
    
        public override Task RollbackAsync(CancellationToken cancellationToken = default)
        {
            throw new NotImplementedException();
        }
    
        public override void Dispose()
        {
            (DbTransaction as IDisposable)?.Dispose();
        }
    }
    
    
    public static class Extensions
    {
        public static ICapTransaction BeginTransaction(this IDbContext dbContext,
            ICapPublisher publisher, bool autoCommit = false)
        { 
            var dispatcher = publisher.ServiceProvider.GetRequiredService<IDispatcher>();
            dbContext.Session.BeginTransaction();
            var transaction =  new ChloeTransaction(dispatcher,dbContext.Session)
            {
                AutoCommit = autoCommit
            };
            return publisher.Transaction.Value = transaction;
        }
    }
    

å‘é€å¸¦æœ‰äº‹åŠ¡çš„æ¶ˆæ¯ï¼š

    [Route("~/with/test")]
    public IActionResult WithTransaction()
    {
        using (_dbContext.BeginTransaction(_capBus, true))
        {
            _dbContext.Insert(new Person2() { Name = "HelloWorld" });           
            _capBus.Publish("sample.rabbitmq.mysql", DateTime.Now);
        }
        return Ok();
    }
    

ç›¸å…³é“¾æ¥ï¼š  
[https://github.com/shuxinqin/Chloe/issues/328](https://github.com/shuxinqin/Chloe/issues/328)

### æ¶ˆè´¹æ‰§è¡Œæ¶ˆæ¯å¤´è®°å½• InstanceId

æŸå¤©çš„ä¸€ä¸ªä¸‹åˆï¼Œæˆ‘çš„åŒäº‹å‘Šè¯‰æˆ‘ä»–åœ¨ä½¿ç”¨CAPè¿›è¡Œæœ¬åœ°çš„æ¶ˆæ¯è°ƒè¯•çš„æ—¶å€™ï¼Œæ¶ˆæ¯å·²ç»è¢«æ¶ˆè´¹æ‰§è¡Œäº†ï¼Œè€Œä¸”çŠ¶æ€ä¹Ÿå˜æˆæˆåŠŸäº†ï¼Œä½†æ˜¯æ²¡è¿›ä»–çš„VSæ–­ç‚¹ï¼Œä»–åˆè¯´æœ‰æ—¶å€™åˆä¼šè¿›æ–­ç‚¹ï¼Œä»–ä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œäºæ˜¯å°±æŠŠæˆ‘å«è¿‡å»äº†ã€‚

æˆ‘è¿‡å»çœ‹äº†ä¸€ä¸‹ï¼Œå‘ç°å¼€å‘æœåŠ¡å™¨ä¸Šä¹Ÿéƒ¨ç½²çš„æœ‰åº”ç”¨ï¼Œå¹¶ä¸”ä½¿ç”¨çš„åŒä¸€ä¸ªRabbitMQï¼Œä»–çš„æ¶ˆæ¯è¢«çº¿ä¸Šéƒ¨ç½²çš„å…¶ä»–å®ä¾‹ç»™æ¶ˆè´¹æ‰äº†ï¼Œæ‰€ä»¥æ²¡è¿›æ–­ç‚¹ã€‚ä¹‹æ‰€ä»¥æœ‰æ—¶å€™åˆè¿›æ–­ç‚¹åˆ™æ˜¯å› ä¸ºæ¶ˆæ¯æ˜¯è´Ÿè½½æ¶ˆè´¹çš„ï¼Œæ°å¥½åˆè½®åˆ°äº†ä»–æœ¬åœ°ã€‚

åŸºäºä»¥ä¸ŠåŸå› ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åœ¨æ¶ˆè´¹çš„æ¶ˆæ¯å¤´ä¸­è®°å½•äº†æ‰§è¡Œæ‰€åœ¨çš„ InstanceIdï¼Œä¹Ÿå°±æ˜¯æœºå™¨çš„ Hostnameï¼Œè¿™æ ·åœ¨æŸ¥çœ‹æ¶ˆæ¯å°±å¾ˆæ–¹ä¾¿çš„çŸ¥é“æ¶ˆæ¯æ˜¯è¢«å“ªä¸ªå®ä¾‹ç»™æ¶ˆè´¹æ‰äº†ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚

### å¯åŠ¨æ—¶å¯¹ä½äºç›¸åŒç»„çš„è®¢é˜…è€…è¿›è¡Œè­¦å‘Š

æŸå¤©çš„ä¸€ä¸ªä¸‹åˆï¼Œæˆ‘çš„åŒäº‹åˆæ‰¾åˆ°äº†æˆ‘ï¼Œè¯´ä»–åœ¨ä½¿ç”¨CAPè¿›è¡Œæ¶ˆè´¹çš„æ—¶å€™ï¼Œè°ƒè¯•çš„VSæ–­ç‚¹ä¸€ç›´ä¸è¿›å’Œä¸Šæ¬¡ä¸ä¸€æ ·çš„æ˜¯è¿™æ¬¡å§‹ç»ˆè¿›ä¸äº†ï¼Œä½†æ˜¯æ¶ˆæ¯åˆæ¶ˆè´¹æˆåŠŸäº†ï¼Œä»–æ‰¾äº†åŠå¤©ä¹Ÿä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œäºæ˜¯å°±æŠŠæˆ‘åˆå«è¿‡å»äº†ã€‚

æˆ‘è¿‡å»çœ‹äº†ä¸€ä¸‹ï¼Œä»–æ²¡æœ‰çŠ¯å’Œä¸Šæ¬¡ä¸€æ ·çš„é”™è¯¯ã€‚äºæ˜¯æˆ‘æ£€æŸ¥äº†ä¸€ä¸‹ï¼Œå‘ç°ä»–åœ¨ä¸€ä¸ªæœåŠ¡ä¸­å¼„äº†2ä¸ªåç§°ä¸€æ ·çš„è®¢é˜…è€…ï¼Œå¹¶ä¸”ä½¿ç”¨çš„é»˜è®¤ç»„ã€‚ ç”±äº2ä¸ªè®¢é˜…è€…ä½äºä¸åŒçš„ç±»ä¸­ï¼Œæ‰€ä»¥ä»–æ²¡æœ‰å‘ç°ã€‚ ç†Ÿæ‚‰CAPçš„éƒ½çŸ¥é“ï¼ŒCAP åœ¨å¯åŠ¨çš„æ—¶å€™ç”±äºè¿›è¡Œäº†å»é‡å¤„ç†ï¼Œæ‰€ä»¥åªä¼šä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªè®¢é˜…è€…ï¼Œå¯¹äºå¦å¤–ä¸€ä¸ªä¼šå¿½ç•¥æ‰ã€‚

åŸºäºä»¥ä¸ŠåŸå› ï¼Œåœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨çš„æ—¶å€™è¿›è¡Œäº†æ£€æµ‹ï¼Œå¦‚æœå‘ç°åœ¨ä¸€ä¸ªç»„ä¸­æœ‰2ä¸ªä»¥ä¸Šçš„åŒåè®¢é˜…è€…ï¼Œæˆ‘ä»¬ä¼šè¿›è¡Œè­¦å‘Šæ—¥å¿—çš„æ‰“å°è¿›è¡Œæé†’ï¼Œä½†ä¸ä¼šæŠ›å‡ºå¼‚å¸¸æ¥é˜»æ­¢ä½ çš„å¯åŠ¨ã€‚

### BUG ä¿®å¤

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬è¿›è¡Œäº†ä¸€äº›å·²å‘ç°çš„BUGä¿®å¤ï¼Œä¸‹é¢æ˜¯ä¿®å¤çš„å†…å®¹é¡¹ã€‚

*   Snowflake Id ç®—æ³•ç”Ÿæˆæ—¶æ’é™¤è™šæ‹Ÿï¼Œå›ç¯å’Œç¦ç”¨çš„ç½‘å¡
*   ä¿®å¤ RabbitMQ ä¸¢å¤±è¿æ¥å¹¶å¿«é€Ÿæ¢å¤æ—¶çš„å¥åº·æ£€æµ‹Bugã€‚
*   ä¿®å¤ Dashboard ä»£ç†æŸ¥è¯¢ç¼ºå¤± QueryString çš„é—®é¢˜ã€‚
*   ä¿®å¤ MongoDB æŸ¥è¯¢å…ƒç´ æœªæ³¨å†Œä¸è¿”å›ç»“æœçš„Bugã€‚
*   ä¿®å¤ Scoped ç”Ÿå‘½å‘¨æœŸå·¥å‚æ¨¡å¼æ³¨å†Œçš„è®¢é˜…è€…æŠ¥é”™çš„Bugã€‚

### æ€»ç»“

ä»¥ä¸Šï¼Œå°±æ˜¯æœ¬ç‰ˆæœ¬æˆ‘ä»¬åšå‡ºçš„ä¸€äº›æ”¯æŒå’Œæ”¹åŠ¨ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒï¼Œæˆ‘ä»¬å¾ˆå¼€å¿ƒèƒ½å¤Ÿå¸®åŠ©åˆ°å¤§å®¶ ã€‚å¤§å®¶åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜å¸Œæœ›ä¹Ÿèƒ½å¤Ÿç§¯æçš„åé¦ˆï¼Œå¸®åŠ©CAPå˜å¾—è¶Šæ¥è¶Šå¥½ã€‚ğŸ˜ƒ

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªé¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è¿æ¥ç‚¹å‡» Star ç»™æˆ‘ä»¬æ”¯æŒã€‚

[![GitHub stars](https://img.shields.io/github/stars/dotnetcore/CAP.svg?label=github-cap-stars)](https://github.com/dotnetcore/CAP/stargazers)

å¦‚æœä½ è§‰å¾—æœ¬ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©çš„è¯ï¼Œæ„Ÿè°¢æ‚¨çš„ã€æ¨èã€‘ã€‚

* * *

> æœ¬æ–‡åœ°å€ï¼š[http://www.cnblogs.com/savorboard/p/cap-6-2.html](http://www.cnblogs.com/savorboard/p/cap-6-2.html)  
> ä½œè€…åšå®¢ï¼š[Savorboard](http://www.cnblogs.com/savorboard)  
> æœ¬æ–‡åŸåˆ›æˆæƒä¸ºï¼šç½²å - éå•†ä¸šæ€§ä½¿ç”¨ - ç¦æ­¢æ¼”ç»ï¼Œåè®®[æ™®é€šæ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/) | åè®®[æ³•å¾‹æ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode)