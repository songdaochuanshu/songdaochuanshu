---
layout: post
title: "å¦‚ä½•ä½¿ç”¨ Blackbox Exporter ç›‘æ§ URL?"
date: "2022-12-31T05:13:49.941Z"
---
å¦‚ä½•ä½¿ç”¨ Blackbox Exporter ç›‘æ§ URL?
==============================

å¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ Blackbox Exporter ä¸ Prometheus è¿›è¡Œ URL ç›‘æ§é‡‡é›†ã€å±•ç¤ºå’Œå‘Šè­¦ã€‚

å‰è¨€
--

ç›‘æ§åŸŸåå’Œ URL æ˜¯å¯è§‚å¯Ÿæ€§çš„ä¸€ä¸ªé‡è¦æ–¹é¢ï¼Œä¸»è¦ç”¨äºè¯Šæ–­å¯ç”¨æ€§é—®é¢˜ã€‚æ¥ä¸‹æ¥ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•ä½¿ç”¨ Blackbox Exporter å’Œ Prometheus åœ¨ Kubernetes ä¸­å®ç° URL ç›‘æ§ã€‚

Blackbox Exporter ç®€ä»‹
--------------------

Blackbox Exporter æ˜¯ Prometheus çš„ä¸€ä¸ªå¯é€‰ç»„ä»¶ï¼Œåƒå…¶ä»– Exporter ä¸€æ ·ï¼Œ ä¸»è¦ç”¨äºå°†ç›‘æ§æ•°æ®è½¬æ¢ä¸º Prometheus å¯ç†è§£çš„æŒ‡æ ‡æ ¼å¼ï¼Œå³ Prometheus [exposition format](https://prometheus.io/docs/instrumenting/exposition_formats/)ã€‚

### Endpoint ç›‘æ§

Endpoint ç›‘æ§æ˜¯æŒ‡ç›‘æ§å†…éƒ¨å’Œå¤–éƒ¨ Endpointï¼ˆHTTP/Sã€DNSã€TCPã€ICMP å’Œ grpcï¼‰çš„å„ç§å‚æ•°ï¼ŒåŒ…æ‹¬ HTTP å“åº”æ—¶é—´ã€DNS æŸ¥è¯¢å»¶è¿Ÿã€SSL è¯ä¹¦è¿‡æœŸä¿¡æ¯ã€TLS ç‰ˆæœ¬ç­‰ç­‰ã€‚

åœ¨ Kubernetes ä¸­ï¼Œä¸ä»…ä»…æ˜¯å¤–éƒ¨ Endpoint éœ€è¦è¢«ç›‘æ§ï¼Œå†…éƒ¨ Endpoint ä¹Ÿéœ€è¦è¢«ç›‘æ§å“åº”æ—¶é—´å’Œå…¶ä»–å‚æ•°ã€‚è¿™äº›æŒ‡æ ‡æ˜¯åŸºç¡€è®¾æ–½çš„ä¸€ä¸ªé‡è¦éƒ¨åˆ†ï¼Œä»¥ç¡®ä¿æœåŠ¡çš„è¿ç»­æ€§ã€å¯ç”¨æ€§å’Œç¬¦åˆä¸€äº›å®‰å…¨è®¤è¯ã€‚

### ç™½ç›’ï¼ˆWhiteBoxï¼‰ä¸é»‘ç›’ï¼ˆBlackboxï¼‰ç›‘æ§

ç™½ç›’ç›‘æ§æ˜¯æŒ‡å¯¹ç³»ç»Ÿå†…éƒ¨çš„ç›‘æ§ï¼ŒåŒ…æ‹¬åº”ç”¨ loggingã€handlersã€tracing å’Œ metricsã€‚ä¸ä¹‹ç›¸å¯¹ï¼Œé»‘ç›’ç›‘æ§ä¸»è¦ä»å¤–éƒ¨å‘èµ·æ¢æµ‹ï¼Œæ¢æµ‹å½±å“ç”¨æˆ·çš„è¡Œä¸ºï¼Œå¦‚æœåŠ¡å™¨åœæœºã€é¡µé¢ä¸å·¥ä½œæˆ–ç½‘ç«™æ€§èƒ½ä¸‹é™ã€‚

### Blackbox Exporter

Blackbox Exporter ç”¨äºæ¢æµ‹ HTTPSã€HTTPã€TCPã€DNSã€ICMP å’Œ grpc ç­‰ Endpointã€‚åœ¨ä½ å®šä¹‰ Endpoint åï¼ŒBlackbox Exporter ä¼šç”ŸæˆæŒ‡æ ‡ï¼Œå¯ä»¥ä½¿ç”¨ Grafana ç­‰å·¥å…·è¿›è¡Œå¯è§†åŒ–ã€‚Blackbox Exporter æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯æµ‹é‡ Endpoint çš„å¯ç”¨æ€§ã€‚

ä¸‹å›¾æ˜¾ç¤ºäº† Blackbox Exporter ç›‘æ§ä¸€ä¸ª Endpoint çš„æµç¨‹ï¼š

![blackbox exporter æµç¨‹å›¾](http://pic-cdn.ewhisper.cn/img/2022/08/07/3a8aac9195094d4dd586eb0b2c404003-exporter.png)

Blackbox Exporter å®‰è£…å’Œé…ç½®
-----------------------

### ä½¿ç”¨ Helm å®‰è£… Blackbox Exporter

Blackbox Exporter çš„å®‰è£…å¾ˆç®€å•ï¼Œå¯ä»¥é€šè¿‡ Helm Chart å®‰è£…ï¼š

    # æ·»åŠ  repo
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm repo update
    
    # Install chart
    helm install [RELEASE_NAME] prometheus-community/prometheus-blackbox-exporter
    

ğŸ‰

### Blackbox åŸºæœ¬é…ç½®

ä¸‹é¢æ˜¯ Blackbox Exporter é…ç½®ä¸­å®šä¹‰çš„ä¸€ä¸ªé»˜è®¤æ¨¡å—ï¼š

blackbox.yaml:

    modules:
      http_2xx:
        prober: http
        timeout: 15s  
        http:
          fail_if_not_ssl: true
          ip_protocol_fallback: false
          method: GET
          follow_redirects: true
          preferred_ip_protocol: ip4
          valid_http_versions:
            - HTTP/1.1
            - HTTP/2.0
          valid_status_codes:
            - 200
            - 204
    

ä½ å¯ä»¥ç›¸åº”åœ°é…ç½®ä½ è‡ªå·±çš„`blackbox.yml`ï¼Œä½¿æ¢é’ˆ (probe) æ ¹æ®ä½ çš„é…ç½®è¿”å›æˆåŠŸ/å¤±è´¥ã€‚ä»¥ä¸Šé¢é…ç½®ä¸ºä¾‹ï¼Œè¯¦ç»†è¯´æ˜ä¸‹ `module` å’Œ `http` probe çš„é…ç½®ï¼š

*   `prober`: æ¢æµ‹çš„åè®®ï¼ˆå¯ä»¥æ˜¯ï¼šhttp, tcp, dns, icmp, grpcï¼‰ã€‚
*   `timeout`: æ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚
*   `http`: http probe

æ¥ä¸‹æ¥æ˜¯ http probe çš„é…ç½®ï¼š

*   `valid_status_codes: <int>, ... | default = 2xx`: è¯¥ Probe å¯æ¥å—çš„çŠ¶æ€ç ã€‚é»˜è®¤ä¸º 2xxã€‚å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ã€‚
*   `valid_http_versions`: è¯¥ Probe æ¥å—çš„ http ç‰ˆæœ¬ã€‚å¯é€‰å€¼ï¼š`HTTP/1.1` `HTTP/2.0`
*   `method: <string> | default = "GET"`: probe ä½¿ç”¨çš„ http method
*   `headers:` probe ä½¿ç”¨çš„ header, æ¯”å¦‚å¯ä»¥åŠ ä¸€äº› `user-agent` ä¹‹ç±»çš„ header é¿å…è¢« WAF æ‹¦æˆª
*   `body_size_limit: <size> | default = 0` å°†è¢«å¤„ç†çš„æœ€å¤§æœªå‹ç¼©çš„ä¸»ä½“é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ã€‚å€¼ä¸º 0 æ„å‘³ç€æ²¡æœ‰é™åˆ¶ã€‚
*   `compression`: ç”¨äºè§£å‹å“åº”çš„å‹ç¼©ç®—æ³•ï¼ˆgzipã€brã€deflateã€identï¼‰ã€‚
*   `follow_redirects: <boolean> | default = true`: æ˜¯å¦ follow é‡å®šå‘
*   `fail_if_ssl`: å¦‚æœå­˜åœ¨ SSLï¼Œåˆ™æ¢æµ‹å¤±è´¥
*   `fail_if_not_ssl`: å¦‚æœä¸å­˜åœ¨ SSL, åˆ™æ¢æµ‹å¤±è´¥
*   `fail_if_body_matches_regexp`: å¦‚æœè¿”å›çš„ body åŒ¹é…è¯¥æ­£åˆ™åˆ™å¤±è´¥
*   `fail_if_body_not_matches_regexp`: å¦‚æœè¿”å›çš„ body ä¸åŒ¹é…è¯¥æ­£åˆ™åˆ™å¤±è´¥
*   `fail_if_header_matches`: å¦‚æœè¿”å›çš„ header åŒ¹é…è¯¥æ­£åˆ™ï¼Œåˆ™å¤±è´¥ã€‚å¯¹äºæœ‰å¤šä¸ªå€¼çš„ headerï¼Œå¦‚æœ**è‡³å°‘æœ‰ä¸€ä¸ª**ç¬¦åˆï¼Œåˆ™å¤±è´¥ã€‚
*   `fail_if_header_not_matches`: å¦‚æœè¿”å›çš„ header ä¸åŒ¹é…è¯¥æ­£åˆ™ï¼Œåˆ™å¤±è´¥ã€‚
*   `tls_config`: HTTP probe çš„ TLS åè®®é…ç½®ï¼Œå¸¸ç”¨äºç§äººè¯ä¹¦ã€‚
*   `basic_auth`: ç›®æ ‡çš„ HTTP basic auth å‡­è¯ã€‚
*   `bearer_token: <secret>`: æ¨¡æ¿çš„ bearer token.
*   `proxy_url` ç”¨äºè¿æ¥åˆ°ç›®æ ‡çš„ proxy server çš„é…ç½®
*   `skip_resolve_phase_with_proxy` å½“è®¾ç½®äº† HTTP ä»£ç†ï¼ˆproxy\_urlï¼‰æ—¶ï¼Œè·³è¿‡ DNS è§£æå’Œ URL å˜æ›´ã€‚
*   `oauth2` ç”¨äºè¿æ¥åˆ°æ¨¡æ¿çš„ OAuth 2.0 é…ç½®
*   `enable_http2` æ˜¯å¦å¯ç”¨ http2
*   `preferred_ip_protocol` HTTP probe çš„ IP åè®® (ip4, ip6)
*   `ip_protocol_fallback`
*   `body` probe ä¸­ä½¿ç”¨çš„ HTTP è¯·æ±‚çš„ä¸»ä½“ã€‚

ä½ å¯ä»¥æŸ¥çœ‹è¿™ä¸ª [example.yml](https://github.com/prometheus/blackbox_exporter/blob/master/example.yml) ä¸­çš„è¯¦ç»†ä¾‹å­ï¼Œäº†è§£æ›´å¤šæƒ…å†µã€‚å¦å¤–è¿˜éœ€è¦åœ¨ Prometheus åšä¸€äº›é…ç½®ä¸Šçš„æ”¹å˜ï¼ŒBlackbox Exporter æ‰ä¼šå‘é€ä¸åº”ç”¨çš„é…ç½®ç›¸å…³çš„æŒ‡æ ‡ã€‚

### Prometheus ä¸­çš„é…ç½®

éœ€è¦åœ¨ Prometheus é‡Œé…ç½® scrape çš„é…ç½®ï¼Œä»¥åŠ Blackbox ç›¸å…³çš„ Alert Rules.

#### Blackbox çš„ Prometheus Scrape é…ç½®

ç¤ºä¾‹å¦‚ä¸‹ï¼š

    scrape_configs:
      - job_name: blackbox-exporter
        params:
          module:
            - http_2xx
        scrape_interval: 1m
        scrape_timeout: 10s
        metrics_path: /probe
        scheme: http
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: prometheus-blackbox-exporter.monitoring:9115
            action: replace
        static_configs:
          - targets:
              - https://ewhisper.cn
              - https://www.ewhisper.cn
              - https://rancher.ewhisper.cn
            labels:
              domain: ewhisper
              environment: test
              cluster: home-k3s
    

è¿™æ ·ç›´æ¥æ”¹ Prometheus çš„é…ç½®æ˜¯æ¯”è¾ƒå®¹æ˜“å‡ºé”™çš„ï¼Œå¦‚æœä½ å·²ç»å®‰è£…äº† [Prometheus Operator](https://ewhisper.cn/posts/14778/), åˆ™å¯ä»¥ç›´æ¥é€šè¿‡ `probe` CRD æ¥é…ç½®ï¼Œéå¸¸æ–¹ä¾¿ï¼š

    apiVersion: monitoring.coreos.com/v1
    kind: Probe
    metadata:
      name: ewhisper
      namespace: monitoring
    spec:
      jobName: http-get
      interval: 60s
      module: http_2xx
      prober:
        url: prometheus-blackbox-exporter.monitoring:9115
        scheme: http
        path: /probe
      targets:
        staticConfig:
          static:
          - targets:
              - https://ewhisper.cn
              - https://www.ewhisper.cn
              - https://rancher.ewhisper.cn
            labels:
              domain: ewhisper
              environment: test
              cluster: home-k3s
    

Blackbox Exporter æ¢æµ‹åœºæ™¯
----------------------

å•è®º URL, æ€»ç»“èµ·æ¥ï¼ŒBlackbox Exporter æœ‰ä»¥ä¸‹æ¢æµ‹åœºæ™¯ï¼š

1.  æ¢æµ‹å¤–éƒ¨ URL
2.  æ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ service
3.  æ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ Ingress
4.  æ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ Pod

### åœºæ™¯ä¸€ï¼šæ¢æµ‹å¤–éƒ¨ URL

é…ç½® [ä¸Šé¢](#Blackbox-%20%E7%9A%84%20-Prometheus-Scrape-%20%E9%85%8D%E7%BD%AE) å·²ç»æè¿‡ï¼Œè¿™é‡Œå°±ä¸åœ¨èµ˜è¿°ã€‚

### åœºæ™¯äºŒï¼šæ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ service

åœ¨ Kubernetes ç³»ç»Ÿä¸­ï¼Œèµ„æºå’Œ Endpoint ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå‡ºç°å’Œæ¶ˆå¤±ï¼Œå¯ä»¥éå¸¸æœ‰ç”¨çš„æ¢æµ‹æ˜¯å¯¹èµ„æºçš„åŠ¨æ€æ¢æµ‹ï¼ŒåŒ…æ‹¬ podsã€service å’Œ ingressã€‚

åœ¨ Prometheus ä¸­ä½¿ç”¨ Kubernetes æœåŠ¡å‘ç°é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥å®ç° Endpoint çš„åŠ¨æ€æ¢æµ‹ã€‚Kubernetes æœåŠ¡å‘ç°é…ç½®å…è®¸ä» Kubernetes çš„ API ä¸­è·å–åˆ®å‰Šç›®æ ‡ï¼Œå¹¶å§‹ç»ˆä¸é›†ç¾¤çŠ¶æ€ä¿æŒåŒæ­¥ã€‚ä½ å¯ä»¥åœ¨æ–‡æ¡£çš„ [kubernetes\_sd\_config](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config) éƒ¨åˆ†æ‰¾åˆ°å¯ä»¥é…ç½®ä¸ºå‘ç°ç›®æ ‡çš„å¯ç”¨è§’è‰²åˆ—è¡¨ã€‚

    kubernetes_sd_configs:
      - role: service
        metrics_path: /probe
        params:
          module:
          - http_2xx
        relabel_configs:
        - action: keep
          regex: true
          source_labels:
          - __meta_kubernetes_service_annotation_prometheus_io_probe
        - source_labels:
          - __address__
          target_label: __param_target
        - replacement: prometheus-blackbox-exporter.monitoring:9115
          target_label: __address__
        - source_labels:
          - __param_target
          target_label: instance
        - action: labelmap
          regex: __meta_kubernetes_service_label_(.+)
        - source_labels:
          - __meta_kubernetes_namespace
          target_label: kubernetes_namespace
        - source_labels:
          - __meta_kubernetes_service_name
          target_label: kubernetes_name
    

è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`[__meta_kubernetes_service_annotation_prometheus_io_probe]`æ¥åªæ£€æŸ¥é‚£äº›æœ‰`prometheus.io/probe = true`æ³¨é‡Šçš„æœåŠ¡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

    âœ kubectl describe svc nginx
    ...
    Annotations:              prometheus.io/probe: true
    ...
    

### åœºæ™¯ä¸‰ï¼šæ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ Ingress

        - job_name: "blackbox-kubernetes-ingresses"
          metrics_path: /probe
          params:
            module: [http_2xx]
          kubernetes_sd_configs:
          - role: ingress
          relabel_configs:
          # ç¤ºä¾‹é‡æ–°æ ‡è®°ï¼Œåªæ¢æµ‹æœ‰ "prometheus.io/probe = true"æ³¨é‡Šçš„ä¸€äº›æ¥å…¥ç‚¹ã€‚
          #  - source_labels: [__meta_kubernetes_ingess_annotation_prometheus_io_probe]
          #    action: keep
          #    regex: true
            - source_labels:
                [
                  __meta_kubernetes_ingress_scheme,
                  __address__,
                  __meta_kubernetes_ingress_path,
                ]
              regex: (.+);(.+);(.+)
              replacement: ${1}://${2}${3}
              target_label: __param_target
            - target_label: __address__
              replacement: prometheus-blackbox-exporter.monitoring:9115
            - source_labels: [__param_target]
              target_label: instance
            - action: labelmap
              regex: __meta_kubernetes_ingress_label_(.+)
            - source_labels: [__meta_kubernetes_namespace]
              target_label: kubernetes_namespace
            - source_labels: [__meta_kubernetes_ingress_name]
              target_label: ingress_name
    

### åœºæ™¯å››ï¼šæ¢æµ‹ K8S é›†ç¾¤å†…éƒ¨ Pod

        - job_name: "blackbox-kubernetes-pods"
          metrics_path: /probe    
          params:
            module: [http_2xx]
          kubernetes_sd_configs:
          - role: pod        
          relabel_configs:
          # ç¤ºä¾‹é‡æ–°æ ‡è®°ï¼Œåªæ¢æµ‹æœ‰
          # "prometheus.io/probe = true"æ³¨é‡Šçš„ podã€‚
          #  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_probe]
          #    action: keep
          #    regex: true
            - source_labels: [__address__]
              target_label: __param_target
            - target_label: __address__
              replacement:  prometheus-blackbox-exporter.monitoring:9115
            - source_labels: [__param_target]
              replacement: ${1}/health
              target_label: instance          
            - action: labelmap
              regex: __meta_kubernetes_pod_label_(.+)
            - source_labels: [__meta_kubernetes_namespace]
              target_label: kubernetes_namespace
            - source_labels: [__meta_kubernetes_pod_name]
              target_label: kubernetes_pod_name     
    

åœ¨ Prometheus éªŒè¯ç”Ÿæˆçš„æŒ‡æ ‡
--------------------

![Blackbox Alert](https://pic-cdn.ewhisper.cn/img/2022/08/09/f432c413e57ffddd2be7ba03f8e37cfd-621aed18b67e8ff58e8193f66d390b8.jpg)

ä¸€æ—¦æ›´æ”¹è¢« applyï¼ŒBlackbox Exporter çš„èµ„æºè¢«éƒ¨ç½²ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Prometheus ä¸­éªŒè¯ç›®æ ‡çš„çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è·³è½¬åˆ°çŠ¶æ€é€‰é¡¹å¡ï¼Œç„¶ååœ¨ Prometheus UI ä¸­é€‰æ‹© targetsï¼Œæ¥æ£€æŸ¥ Blackbox Exporter æ˜¯å¦ä¸æ³¨å†Œçš„ç›®æ ‡ä¸€èµ·å¯åŠ¨ã€‚

åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä½¿ç”¨`https://rancher.ewhisper.cn`ä½œä¸ºå¤–éƒ¨ç›®æ ‡æ¥å‚è€ƒï¼Œå…¶çŠ¶æ€æ˜¯ 404ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡å¯»æ‰¾ä»¥`probe_`å¼€å¤´çš„æŒ‡æ ‡æ¥æ£€æŸ¥æŒ‡æ ‡æ˜¯å¦è¢«æ”¶é›†ã€‚

![Prometheus probe metrics](http://pic-cdn.ewhisper.cn/img/2022/08/07/1f6db8a1ee744668449754a1b2f882ad-probe_.png)

åœ¨è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ä¸€äº›ç”Ÿæˆçš„`probe_` çš„æŒ‡æ ‡åˆ—è¡¨ã€‚

æŒ‡æ ‡å

åŠŸèƒ½

`probe_duration_seconds`

è¿”å›æ¢é’ˆå®Œæˆçš„æ—¶é—´ï¼ˆç§’ï¼‰ã€‚

`probe_http_status_code`

å“åº” HTTP çŠ¶æ€ä»£ç 

`probe_http_version`

è¿”å›æ¢é’ˆå“åº”çš„ HTTP ç‰ˆæœ¬

`probe_success`

æ˜¾ç¤ºæ¢æµ‹æ˜¯å¦æˆåŠŸ

`probe_dns_lookup_time_seconds`

è¿”å›æ¢æµ‹ DNS çš„æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚

`probe_ip_protocol`

æŒ‡å®šæ¢é’ˆ IP åè®®æ˜¯ IP4 è¿˜æ˜¯ IP6

`probe_ssl_earliest_cert_expiry metric`

è¿”å›ä»¥ unixtime ä¸ºå•ä½çš„æœ€æ—©çš„ SSL è¯ä¹¦åˆ°æœŸæ—¶é—´

`probe_tls_version_info`

åŒ…å«æ‰€ä½¿ç”¨çš„ TLS ç‰ˆæœ¬

`probe_failed_due_to_regex`

è¡¨ç¤ºæ¢æµ‹æ˜¯å¦å›  regex åŒ¹é…è€Œå¤±è´¥

`probe_http_content_length`

HTTP å†…å®¹å“åº”çš„é•¿åº¦

ä½¿ç”¨ Grafana ç›‘æ§é…ç½®çš„ URL
--------------------

å¯ä»¥ç›´æ¥å¤ç”¨ Grafana ä¸Šçš„ä¸€äº› Dashboard, æŸ¥çœ‹ URL çš„æŒ‡æ ‡ï¼š

![dashboard](https://pic-cdn.ewhisper.cn/img/2022/08/08/15322f0dcd2a213e62c391ef9e30019f-20220808141506.png)

![dashboard](https://pic-cdn.ewhisper.cn/img/2022/08/08/c35912bc21a1662538c88d77ba61e162-20220808141513.png)

ç‚¹è¿™é‡ŒğŸ‘‰[Blackbox Grafana](https://grafana.com/grafana/dashboards/?search=blackbox) æœç´¢å’Œä¸‹è½½å¯¹åº”çš„ Grafana Dashboard.

Blackbox çš„ä¼˜åŠ¿æ¢³ç†
--------------

1.  å¼€æºå…è´¹çš„ Blackbox Endpoint ç›‘æ§å·¥å…·ï¼›
2.  é™¤äº† HTTP/S, è¿˜æ”¯æŒ DNSã€TCPã€ICMP å’Œ\*\* grpc\*\*
3.  ä¸°å¯Œçš„ HTTP é»‘ç›’ç›‘æ§é…ç½®ï¼Œå¦‚ Headerã€è®¤è¯ã€ä»£ç†ã€æ­£åˆ™åŒ¹é…ç­‰ã€‚
4.  åˆ©ç”¨ Prometheus + Kubernetes çš„ [kubernetes\_sd\_config](https://prometheus.io/docs/prometheus/latest/configuration/configuration/#kubernetes_sd_config) åŠŸèƒ½åŠ¨æ€åœ°äº§ç”ŸæŒ‡æ ‡ï¼Œå¹¶å¯ç”¨äºåŠ¨æ€ Endpoint ç›‘æ§ã€‚
5.  å¯ä»¥ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´ã€‚

Blackbox Exporter çš„è¡Œä¸šåº”ç”¨åœºæ™¯
-------------------------

**ä¸ºä»€ä¹ˆéœ€è¦ Blackbox Exporter?**

ä»¥æˆ‘æ‰€ç†Ÿæ‚‰çš„ä¿é™©è¡Œä¸šä¸ºä¾‹ï¼Œå¤§ä¸­å‹ä¿é™©å…¬å¸ï¼Œéƒ½æ˜¯é‡‡ç”¨ç±»ä¼¼ï¼š

*   æ€»éƒ¨
*   çœçº§åˆ†å…¬å¸
*   ä¸­å¿ƒæ”¯å…¬å¸
*   ä¸­å…¬å¸
*   è¥ä¸šéƒ¨

è¿™æ ·çš„ç»„ç»‡å½¢å¼ã€‚åˆ†æ”¯æœºæ„å¾€å¾€æ˜¯é€šè¿‡**ä¸“çº¿**å’Œæ€»éƒ¨è¿æ¥ï¼Œå¹¶ä½¿ç”¨æ€»éƒ¨æä¾›çš„å„ç±»ä¿é™©ä¸šåŠ¡ç³»ç»Ÿã€‚

è™½ç„¶å›½å†…å¤–æœ‰å„ç§å·¥å…·å’ŒæœåŠ¡å¯ç”¨äºç›‘æ§åŸŸåå’Œ URL, å¦‚ å¬äº‘ã€Dynatrace ç­‰ã€‚ä½†æ˜¯

*   ä¸€æ–¹é¢ï¼ŒæœåŠ¡æ˜¯æŒ‰æ¢æµ‹æ¬¡æ•°æ”¶è´¹çš„ï¼Œå¦‚æœæ¢æµ‹é¢‘ç‡ã€æ¢æµ‹ URL è¿‡å¤šï¼Œä»·æ ¼ä¸ä½çš„ï¼›
*   å¦ä¸€æ–¹é¢ï¼Œè¿™äº›å•†ä¸šåŒ–æœåŠ¡å¯èƒ½æ— æ³•è¦†ç›–ä¿é™©è¡Œä¸šè¿™ç§è¿‘ä¹**å†…ç½‘**çš„ç½‘ç»œæ¶æ„ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒBlackbox Exporter æ˜¯ç°æœ‰è§£å†³æ–¹æ¡ˆçš„ä¸€ä¸ªå¼€æºæ›¿ä»£å“ï¼Œç”± Prometheus ç¤¾åŒºç»´æŠ¤ã€‚

è€Œä¸”ï¼ŒPrometheus + Blackbox Exporter + Kubernetes åŠ¨æ€å‘ç°ï¼Œå¯ä»¥å¤§å¤§å‡å°‘äººå·¥é…ç½®å¤§é‡ URL æ¢æµ‹çš„å·¥ä½œã€‚

å¦å¤–ï¼Œé’ˆå¯¹ä¸Šé¢æåˆ°çš„æƒ…å†µï¼Œ ä¹Ÿå¯ä»¥ä½¿ç”¨ Prometheus + Blackbox Exporter + è½»é‡çº§ K8s è§£å†³æ–¹æ¡ˆå¦‚ K3sï¼Œ å°† probe èŠ‚ç‚¹éƒ¨ç½²åˆ°å„ä¸ªåˆ†æ”¯æœºæ„ï¼Œå®ç°å’Œåˆ†æ”¯æœºæ„å‘˜å·¥å®Œå…¨ç›¸åŒçš„è®¿é—®è·¯å¾„ã€‚åˆ†æ”¯-æ€»éƒ¨å„ç³»ç»Ÿç½‘ç»œå¯ç”¨æ€§ä¸€ç›®äº†ç„¶ï¼ŒåŠæ—¶å‘ç°åˆ†æ”¯-æ€»éƒ¨å„ç³»ç»Ÿç½‘ç»œé—®é¢˜ã€‚

æ€»ç»“
--

é€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬è®¨è®ºäº†ï¼š

*   ä»€ä¹ˆæ˜¯ Blackbox Exporter
*   å¦‚ä½•å®‰è£…å’Œé…ç½®å®ƒ
*   å‡ ç§å…¸å‹çš„é…ç½®åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯åˆ©ç”¨ Prometheus + Blackbox Exporter + Kubernetes åŠ¨æ€å‘ç°
*   Blackbox Exporter ä¼˜åŠ¿
*   Blackbox Exporter çš„è¡Œä¸šåº”ç”¨åœºæ™¯

å¸Œæœ›å¯¹å„ä½è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚

ğŸ‰ğŸ‰ğŸ‰

ğŸ“šï¸ Reference
-------------

*   [How to Monitor Endpoints in Kubernetes using Blackbox Exporter (infracloud.io)](https://www.infracloud.io/blogs/monitoring-endpoints-kubernetes-blackbox-exporter/)
*   [prometheus/blackbox\_exporter: Blackbox prober exporter (github.com)](https://github.com/prometheus/blackbox_exporter)
*   [Probing Endpoints with Blackbox-Exporter. How ? Why ? | by Yasintahaerol | Trendyol Tech | Medium](https://medium.com/trendyol-tech/probing-endpoints-with-blackbox-exporter-how-why-4417fce0993a)