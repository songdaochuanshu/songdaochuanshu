---
layout: post
title: "èŠä¸€èŠè¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨"
date: "2022-05-09T03:21:33.796Z"
---
èŠä¸€èŠè¿‡æ»¤å™¨ä¸æ‹¦æˆªå™¨
==========

æœ¬æ–‡ä¸»è¦ä»‹ç»è¿‡æ»¤å™¨ Filter å’Œæ‹¦æˆªå™¨ Interceptor çš„å®ç°åŸç†ã€åˆ›å»ºè¿‡ç¨‹ã€åº”ç”¨åœºæ™¯ä»¥åŠä¸»è¦åŒºåˆ«

è¿‡æ»¤å™¨ Filter
----------

> é¢è¯•å®˜ï¼šç”¨è¿‡è¿‡æ»¤å™¨å§ï¼Œä»‹ç»ä¸€ä¸‹è¿‡æ»¤å™¨ã€‚  
> JohnåŒå­¦ï¼ˆå¿ƒä¸­çªƒå–œï¼‰ï¼šç”¨è¿‡ï¼Œæˆ‘ç»å¸¸ç”¨å®ƒæ¥å‡€åŒ–æ°´ ğŸ˜...  
> é¢è¯•å®˜ï¼šä»Šå¤©çš„é¢è¯•åˆ°æ­¤ç»“æŸï¼Œå›å»ç­‰é€šçŸ¥å§ã€‚  
> JohnåŒå­¦ï¼šğŸ™ƒ...

### Filter åŸºæœ¬ä»‹ç»

è¿‡æ»¤å™¨ Filter æ˜¯ Sun å…¬å¸åœ¨ Servlet 2.3 è§„èŒƒä¸­æ·»åŠ çš„æ–°åŠŸèƒ½ï¼Œå…¶ä½œç”¨æ˜¯å¯¹å®¢æˆ·ç«¯å‘é€ç»™ Servlet çš„è¯·æ±‚ä»¥åŠå¯¹ Servlet è¿”å›ç»™å®¢æˆ·ç«¯çš„å“åº”åšä¸€äº›å®šåˆ¶åŒ–çš„å¤„ç†ï¼Œä¾‹å¦‚æ ¡éªŒè¯·æ±‚çš„å‚æ•°ã€è®¾ç½®è¯·æ±‚/å“åº”çš„ Headerã€ä¿®æ”¹è¯·æ±‚/å“åº”çš„å†…å®¹ç­‰ã€‚

Filter å¼•å…¥äº†è¿‡æ»¤é“¾ï¼ˆFilter Chainï¼‰çš„æ¦‚å¿µï¼Œä¸€ä¸ª Web åº”ç”¨å¯ä»¥éƒ¨ç½²å¤šä¸ª Filterï¼Œè¿™äº› Filter ä¼šç»„æˆä¸€ç§é“¾å¼ç»“æ„ï¼Œå®¢æˆ·ç«¯çš„è¯·æ±‚åœ¨åˆ°è¾¾ Servlet ä¹‹å‰ä¼šä¸€ç›´åœ¨è¿™ä¸ªé“¾ä¸Šä¼ é€’ï¼Œä¸åŒçš„ Filter è´Ÿè´£å¯¹è¯·æ±‚/å“åº”åšä¸åŒçš„å¤„ç†ã€‚ Filter çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509083740772-1744957623.jpg)

### AOP ç¼–ç¨‹æ€æƒ³

åœ¨æ·±å…¥ç†è§£ Filter ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠä¸€èŠé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAspect Oriented Programmingï¼ŒAOPï¼‰ã€‚AOP ä¸æ˜¯ä¸€ç§å…·ä½“çš„æŠ€æœ¯ï¼Œè€Œæ˜¯ä¸€ç§ç¼–ç¨‹æ€æƒ³ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨ä¸ä¿®æ”¹æºç çš„åŸºç¡€ä¸Šå®ç°æ–¹æ³•é€»è¾‘çš„å¢å¼ºï¼Œä¹Ÿå°±æ˜¯åœ¨æ–¹æ³•æ‰§è¡Œå‰åæ·»åŠ ä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ã€‚

Filter æ˜¯ AOP ç¼–ç¨‹æ€æƒ³çš„ä¸€ç§ä½“ç°ï¼Œå…¶ä½œç”¨å¯è®¤ä¸ºæ˜¯å¯¹ Servlet åŠŸèƒ½çš„å¢å¼ºã€‚Filter å¯ä»¥å¯¹ç”¨æˆ·çš„è¯·æ±‚åšé¢„å¤„ç†ï¼Œä¹Ÿå¯ä»¥å¯¹è¿”å›çš„å“åº”åšåå¤„ç†ï¼Œä¸”è¿™äº›å¤„ç†é€»è¾‘ä¸ Servlet çš„å¤„ç†é€»è¾‘æ˜¯åˆ†éš”å¼€çš„ï¼Œè¿™ä½¿å¾—ç¨‹åºä¸­å„éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œä»è€Œæé«˜äº†ç¨‹åºçš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

### åˆ›å»º Filter

åˆ›å»º Filter éœ€è¦å®ç° javax.servlet.Filter æ¥å£ï¼Œæˆ–è€…ç»§æ‰¿å®ç°äº† Filter æ¥å£çš„çˆ¶ç±»ã€‚Filter æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š

*   initï¼šåœ¨ Web ç¨‹åºå¯åŠ¨æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºåˆå§‹åŒ– Filterã€‚
    
*   doFilterï¼šåœ¨å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°è¾¾æ—¶è¢«è°ƒç”¨ï¼ŒdoFilter æ–¹æ³•ä¸­å®šä¹‰äº† Filter çš„ä¸»è¦å¤„ç†é€»è¾‘ï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿˜è´Ÿè´£å°†è¯·æ±‚ä¼ é€’ç»™ä¸‹ä¸€ä¸ª Filter æˆ– Servletã€‚
    
*   destroyï¼šåœ¨ Web ç¨‹åºå…³é—­æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºé”€æ¯ä¸€äº›èµ„æºã€‚
    

ä¸‹é¢æˆ‘ä»¬é€šè¿‡å®ç° Filter æ¥å£æ¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ Filterï¼š

    public class TestFilter implements Filter {
        @Override
        public void init(FilterConfig filterConfig) throws ServletException {
            System.out.println(filterConfig.getFilterName() + " è¢«åˆå§‹åŒ–");
        }
    
        @Override
        public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
            HttpServletRequest request = (HttpServletRequest) servletRequest;
            System.out.println("Filter æ‹¦æˆªåˆ°äº†è¯·æ±‚: " + request.getRequestURL());
            System.out.println("Filter å¯¹è¯·æ±‚åšé¢„å¤„ç†...");
            filterChain.doFilter(servletRequest, servletResponse);
            System.out.println("Filter ä¿®æ”¹å“åº”çš„å†…å®¹...");
        }
    
        @Override
        public void destroy() {
            System.out.println("Filter è¢«å›æ”¶");
        }
    }
    

*   init æ–¹æ³•çš„ filterConfig å‚æ•°å°è£…äº†å½“å‰ Filter çš„é…ç½®ä¿¡æ¯ï¼Œåœ¨ Filter åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬å°† Filter çš„åç§°æ‰“å°åœ¨æ§åˆ¶å°ã€‚
    
*   doFilter æ–¹æ³•å®šä¹‰äº† Filter æ‹¦æˆªåˆ°ç”¨æˆ·è¯·æ±‚åçš„å¤„ç†é€»è¾‘ï¼Œ`filterChain.doFilter(servletRequest, servletResponse);` æŒ‡çš„æ˜¯å°†è¯·æ±‚ä¼ é€’ç»™ä¸€ä¸‹ä¸ª Filter æˆ– Servletï¼Œå¦‚æœä¸æ·»åŠ è¯¥è¯­å¥ï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¸ä¼šå‘åä¼ é€’ï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šè¢«å¤„ç†ã€‚åœ¨è¯¥è¯­å¥ä¹‹åï¼Œå¯ä»¥æ·»åŠ å¯¹å“åº”çš„å¤„ç†é€»è¾‘ï¼ˆå¦‚æœè¦ä¿®æ”¹å“åº”çš„ Headerï¼Œå¯ç›´æ¥åœ¨è¯¥è¯­å¥ä¹‹å‰ä¿®æ”¹ï¼›å¦‚æœè¦ä¿®æ”¹å“åº”çš„å†…å®¹ï¼Œåˆ™éœ€è¦åœ¨è¯¥è¯­å¥ä¹‹åï¼Œä¸”éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ª responseï¼‰ã€‚
    
*   destroy æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¾“å‡º "Filter è¢«å›æ”¶" çš„æç¤ºä¿¡æ¯ã€‚
    

### é…ç½® Filter

Spring é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `@Configuration + @Bean + FilterRegistrationBean` å¯¹ Filter è¿›è¡Œé…ç½®ï¼š

    @Configuration
    public class FilterConfig {
        @Bean
        public FilterRegistrationBean<TestFilter> registryFilter() {
            FilterRegistrationBean<TestFilter> registration = new FilterRegistrationBean<>();
            registration.setFilter(new TestFilter());
            registration.addUrlPatterns("/*");
            registration.setName("TestFilter");
            registration.setOrder(0);
            return registration;
        }
    }
    

ä¸Šè¿°ä»£ç ä¸­ï¼ŒsetFilter æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„ç±»å‹ï¼›addUrlPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ‹¦æˆªçš„è§„åˆ™ï¼›setName æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„åç§°ï¼›setOrder æ–¹æ³•ç”¨äºè®¾ç½® Filter çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚

### æµ‹è¯• Filter

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡ï¼Œæµ‹è¯• Filter æ˜¯å¦ç”Ÿæ•ˆï¼š

    @RestController
    public class UserController {
    
        @RequestMapping(path = "/hello", method = RequestMethod.GET)
        public String sayHello() {
            System.out.println("æ­£åœ¨å¤„ç†è¯·æ±‚...");
            System.out.println("è¯·æ±‚å¤„ç†å®Œæˆ~");
            return "I'm fine, thank you.";
        }
    }
    

å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® `localhost:8080/hello`ï¼Œç­‰å¾…è¯·æ±‚å¤„ç†å®Œæˆï¼Œç„¶åå…³é—­é¡¹ç›®ã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ§åˆ¶å°ä¾æ¬¡æ‰“å°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š

![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509083810656-1575923755.jpg)

å¯ä»¥çœ‹åˆ°ï¼Œè‡ªå®šä¹‰çš„ TestFilter å®ç°äº†æ‹¦æˆªè¯·æ±‚ã€å¤„ç†å“åº”çš„ç›®æ ‡ã€‚

### åˆ›å»º Filter çš„å…¶å®ƒæ–¹å¼

**1\. @WebFilter æ³¨è§£ + åŒ…æ‰«æ**

é™¤äº† FilterRegistrationBean å¤–ï¼ŒServlet 3.0 å¼•å…¥çš„æ³¨è§£ @WebFilter ä¹Ÿå¯ç”¨äºé…ç½® Filterã€‚æˆ‘ä»¬åªéœ€è¦åœ¨è‡ªå®šä¹‰çš„ Filter ç±»ä¸Šæ·»åŠ è¯¥æ³¨è§£ï¼Œå°±å¯ä»¥è®¾ç½® Filter çš„åç§°å’Œæ‹¦æˆªè§„åˆ™ï¼š

    @WebFilter(urlPatterns = "/*", filterName = "TestFilter")
    public class TestFilter implements Filter {
        // çœç•¥éƒ¨åˆ†ä»£ç 
    }
    

ç”±äº@WebFilter å¹¶é Spring æä¾›ï¼Œå› æ­¤è‹¥è¦ä½¿è‡ªå®šä¹‰çš„ Filter ç”Ÿæ•ˆï¼Œè¿˜éœ€åœ¨é…ç½®ç±»ä¸Šæ·»åŠ  @ServletComponetScan æ³¨è§£ï¼Œå¹¶æŒ‡å®šæ‰«æçš„åŒ…ï¼š

    @SpringBootApplication
    @ServletComponentScan("com.example.filter")
    public class DemoApplication {
        public static void main(String[] args) {
            SpringApplication.run(DemoApplication.class, args);
        }
    }
    

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**@WebFilter æ³¨è§£å¹¶ä¸å…è®¸æˆ‘ä»¬è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºï¼Œä¸”åœ¨ Filter ç±»ä¸Šæ·»åŠ  @Order æ³¨è§£ä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚å¦‚æœé¡¹ç›®ä¸­æœ‰å¤šä¸ªè¢« @WebFilter ä¿®é¥°çš„ Filterï¼Œé‚£ä¹ˆè¿™äº› Filter çš„æ‰§è¡Œé¡ºåºç”±å…¶ "ç±»åçš„å­—å…¸åº" å†³å®š**ï¼Œä¾‹å¦‚ç±»åä¸º "Axx" çš„ Filter çš„æ‰§è¡Œé¡ºåºè¦å…ˆäºç±»åä¸º "Bxx" çš„ Filterã€‚

> æ·»åŠ äº† @WebFilter æ³¨è§£åå°±ä¸è¦å†æ·»åŠ  @Component æ³¨è§£äº†ï¼Œå¦‚æœéƒ½æ·»åŠ ï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šåˆ›å»ºä¸¤ä¸ª Filterã€‚

**2\. @Component æ³¨è§£**

Spring é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ·»åŠ  @Component æ³¨è§£å°†è‡ªå®šä¹‰çš„ Bean äº¤ç»™ Spring å®¹å™¨ç®¡ç†ã€‚åŒæ ·çš„ï¼Œå¯¹äºè‡ªå®šä¹‰çš„ Filterï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥æ·»åŠ  @Component æ³¨è§£ä½¿å…¶ç”Ÿæ•ˆï¼Œè€Œä¸”è¿˜å¯ä»¥æ·»åŠ  @Order æ³¨è§£æ¥è®¾ç½®ä¸åŒ Filter çš„æ‰§è¡Œé¡ºåºã€‚

    @Component
    @Order(1)
    public class TestFilter implements Filter {
        // çœç•¥éƒ¨åˆ†ä»£ç 
    }
    

æ­¤ç§é…ç½®æ–¹å¼ä¸€èˆ¬ä¸å¸¸ä½¿ç”¨ï¼Œå› ä¸ºå…¶æ— æ³•è®¾ç½® Filter çš„æ‹¦æˆªè§„åˆ™ï¼Œé»˜è®¤çš„æ‹¦æˆªè·¯å¾„ä¸º `/*`ã€‚è™½ç„¶ä¸èƒ½é…ç½®æ‹¦æˆªè§„åˆ™ï¼Œä½†æˆ‘ä»¬å¯ä»¥åœ¨ doFilter æ–¹æ³•ä¸­å®šä¹‰è¯·æ±‚çš„æ”¾è¡Œè§„åˆ™ï¼Œä¾‹å¦‚å½“è¯·æ±‚çš„ URL åŒ¹é…æˆ‘ä»¬è®¾ç½®çš„è§„åˆ™æ—¶ï¼Œç›´æ¥å°†è¯¥è¯·æ±‚æ”¾è¡Œï¼Œä¹Ÿå°±æ˜¯ç«‹å³æ‰§è¡Œ `filterChain.doFilter(servletRequest, servletResponse);`ã€‚

**3\. ç»§æ‰¿ OncePerRequestFilter**

OncePerRequestFilter æ˜¯ä¸€ä¸ªç”± Spring æä¾›çš„æŠ½è±¡ç±»ï¼Œåœ¨é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ç»§æ‰¿ OncePerRequestFilter çš„æ–¹å¼åˆ›å»º Filterï¼Œç„¶åé‡å†™ doFilterInternal æ–¹æ³•å®šä¹‰ Filter çš„å¤„ç†é€»è¾‘ï¼Œé‡å†™ shouldNotFilter æ–¹æ³•è®¾ç½® Filter çš„æ”¾è¡Œè§„åˆ™ã€‚å¯¹äºå¤šä¸ª Filter çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ  @Order æ³¨è§£è¿›è¡Œè®¾ç½®ã€‚å½“ç„¶ï¼Œè‹¥è¦ä½¿ Filter ç”Ÿæ•ˆï¼Œè¿˜éœ€æ·»åŠ  @Component æ³¨è§£å°†å…¶æ³¨å†Œåˆ° Spring å®¹å™¨ã€‚

    @Component
    @Order(1)
    public class CSpringFilter extends OncePerRequestFilter {
        @Override
        protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
            // å¤„ç†é€»è¾‘
        }
    
        @Override
        protected boolean shouldNotFilter(HttpServletRequest request) throws ServletException {
            // æ”¾è¡Œè§„åˆ™
        }
    }
    

å®é™…ä¸Šï¼Œæ–¹å¼ 2 å’Œæ–¹å¼ 3 æœ¬è´¨ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå› ä¸º OncePerRequestFilter åº•å±‚ä¹Ÿæ˜¯é€šè¿‡å®ç° Filter æ¥å£æ¥è¾¾åˆ°è¿‡æ»¤è¯·æ±‚/å“åº”çš„ç›®çš„ï¼Œåªä¸è¿‡ Spring åœ¨ OncePerRequestFilter ä¸­å¸®æˆ‘ä»¬å°è£…äº†è®¸å¤šåŠŸèƒ½ï¼Œå› æ­¤æ›´æ¨èé‡‡ç”¨æ­¤ç§æ–¹å¼åˆ›å»º Filterã€‚

### Filter çš„ä¼˜å…ˆçº§

ä¸Šæ–‡ä¸­æåˆ°ï¼Œä½¿ç”¨é…ç½®ç±»æˆ–æ·»åŠ  @Order æ³¨è§£å¯ä»¥æ˜¾å¼çš„è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºï¼Œä¿®æ”¹ç±»åå¯ä»¥éšå¼çš„è®¾ç½® Filter çš„æ‰§è¡Œé¡ºåºã€‚å¦‚æœé¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ª Filterï¼Œä¸”è¿™äº› Filter ç”±ä¸åŒçš„æ–¹å¼åˆ›å»ºï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œé¡ºåºæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ

èƒ½å¤Ÿç¡®å®šçš„æ˜¯ï¼ŒSpring æ ¹æ® Filter çš„ order å†³å®šå…¶ä¼˜å…ˆçº§ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡é…ç½®ç±»æˆ–è€…é€šè¿‡ @Order æ³¨è§£è®¾ç½®äº† Filter çš„ orderï¼Œé‚£ä¹ˆ **order å€¼è¶Šå°çš„ Filter çš„ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ— è®º Filter ç”±ä½•ç§æ–¹å¼åˆ›å»º**ã€‚å¦‚æœå¤šä¸ª Filter çš„ä¼˜å…ˆçº§ç›¸åŒï¼Œé‚£ä¹ˆæ‰§è¡Œé¡ºåºä¸ºï¼š

1.  é…ç½®ç±»ä¸­é…ç½®çš„ Filter ä¼˜å…ˆæ‰§è¡Œï¼Œå¦‚æœé…ç½®ç±»ä¸­å­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶åœ¨é…ç½®ç±»ä¸­é…ç½®çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚
    
2.  @WebFilter æ³¨è§£ä¿®é¥°çš„ Filter ä¹‹åæ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶ç±»åçš„å­—å…¸åºä¾æ¬¡æ‰§è¡Œã€‚
    
3.  @Component æ³¨è§£ä¿®é¥°çš„ Filter æœ€åæ‰§è¡Œï¼Œå¦‚æœå­˜åœ¨å¤šä¸ª Filterï¼Œé‚£ä¹ˆ Spring æŒ‰ç…§å…¶ç±»åçš„å­—å…¸åºä¾æ¬¡æ‰§è¡Œã€‚
    

æ³¨æ„ï¼Œä»¥ä¸Šä¼˜å…ˆçº§é¡ºåºä»…é€‚ç”¨äº order ç›¸åŒçš„ç‰¹æ®Šæƒ…å†µã€‚å¦‚æœæˆ‘ä»¬ä¸é…ç½® Filter çš„ orderï¼Œé‚£ä¹ˆ Spring é»˜è®¤å°†å…¶ order è®¾ç½®ä¸º `LOWEST_PRECEDENCE = Integer.MAX_VALUE`ï¼Œä¹Ÿå°±æ˜¯æœ€ä½ä¼˜å…ˆçº§ã€‚ç”±äºè¢« @WebFilter æ³¨è§£ä¿®é¥°çš„ Filter æ— æ³•æ˜¾å¼é…ç½®ä¼˜å…ˆçº§ï¼Œå› æ­¤å…¶ order ä¸º Integer.MAX\_VALUEã€‚æœ¬æ–‡æ‰€è¯´çš„ Filter çš„ä¼˜å…ˆçº§æŒ‡çš„æ˜¯ Filter å¯¹è¯·æ±‚åšé¢„å¤„ç†çš„ä¼˜å…ˆçº§ï¼Œå¯¹å“åº”åšåå¤„ç†çš„ä¼˜å…ˆçº§ä¸ä¹‹ç›¸åã€‚

> ä»¥ä¸Šç»“è®ºç”±ç¬”è€…ç»è¿‡æµ‹è¯•ä»¥åŠé˜…è¯»æºç å¾—å‡ºï¼Œå¦‚æœ‰ç†è§£é”™è¯¯ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ ğŸ˜ã€‚å…³äºæºç éƒ¨åˆ†ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥çœ‹çœ‹ ServletContextInitializerBeans ç±»å’Œ AnnotationAwareOrderComparator ç±»çš„æºç ï¼Œç¬”è€…åœ¨è¿™é‡Œå°±ä¸å…·ä½“åˆ†æäº† ğŸ˜ˆã€‚

### Filter çš„åº”ç”¨åœºæ™¯

Filter çš„å¸¸è§åº”ç”¨åœºæ™¯åŒ…æ‹¬ï¼š

*   è§£å†³è·¨åŸŸè®¿é—®ï¼šå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®å¾€å¾€å­˜åœ¨è·¨åŸŸè®¿é—®çš„é—®é¢˜ï¼ŒFilter å…è®¸æˆ‘ä»¬åœ¨ response çš„ Header ä¸­è®¾ç½® "Access-Control-Allow-Origin"ã€"Access-Control-Allow-Methods" ç­‰å¤´åŸŸï¼Œä»¥æ­¤è§£å†³è·¨åŸŸå¤±è´¥é—®é¢˜ã€‚
    
*   è®¾ç½®å­—ç¬¦ç¼–ç ï¼šå­—ç¬¦ç¼–ç  Filter å¯ä»¥åœ¨ request æäº¤åˆ° Servlet ä¹‹å‰æˆ–è€…åœ¨ response è¿”å›ç»™å®¢æˆ·ç«¯ä¹‹å‰ä¸ºè¯·æ±‚/å“åº”è®¾ç½®ç‰¹å®šçš„ç¼–ç æ ¼å¼ï¼Œä»¥è§£å†³è¯·æ±‚/å“åº”å†…å®¹ä¹±ç çš„é—®é¢˜ã€‚
    
*   è®°å½•æ—¥å¿—ï¼šæ—¥å¿—è®°å½• Filter å¯ä»¥åœ¨æ‹¦æˆªåˆ°è¯·æ±‚åï¼Œè®°å½•è¯·æ±‚çš„ IPã€è®¿é—®çš„ URLï¼Œæ‹¦æˆªåˆ°å“åº”åè®°å½•è¯·æ±‚çš„å¤„ç†æ—¶é—´ã€‚å½“ä¸éœ€è¦è®°å½•æ—¥å¿—æ—¶ï¼Œä¹Ÿå¯ä»¥ç›´æ¥å°† Filter çš„é…ç½®æ³¨é‡Šæ‰ã€‚
    
*   æ ¡éªŒæƒé™ï¼šWeb æœåŠ¡ä¸­ï¼Œå®¢æˆ·ç«¯åœ¨å‘é€è¯·æ±‚æ—¶ä¼šæºå¸¦ cookie æˆ–è€… token è¿›è¡Œèº«ä»½è®¤è¯ï¼Œæƒé™æ ¡éªŒ Filter å¯ä»¥åœ¨ request æäº¤åˆ° Servlet ä¹‹å‰å¯¹ cookie æˆ– token è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœç”¨æˆ·æœªç™»å½•æˆ–è€…æƒé™ä¸å¤Ÿï¼Œé‚£ä¹ˆ Filter å¯ä»¥å¯¹è¯·æ±‚åšé‡å®šå‘æˆ–è¿”å›é”™è¯¯ä¿¡æ¯ã€‚
    
*   æ›¿æ¢å†…å®¹ï¼šå†…å®¹æ›¿æ¢ Filter å¯ä»¥å¯¹ç½‘ç«™çš„å†…å®¹è¿›è¡Œæ§åˆ¶ï¼Œé˜²æ­¢è¾“å…¥/è¾“å‡ºéæ³•å†…å®¹å’Œæ•æ„Ÿä¿¡æ¯ã€‚ä¾‹å¦‚åœ¨è¯·æ±‚åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚çš„å†…å®¹è¿›è¡Œè½¬ä¹‰ï¼Œé˜²æ­¢ XSS æ”»å‡»ï¼›åœ¨ Servlet å°†å†…å®¹è¾“å‡ºåˆ° response æ—¶ï¼Œä½¿ç”¨ response å°†å†…å®¹ç¼“å­˜èµ·æ¥ï¼Œç„¶ååœ¨ Filter ä¸­è¿›è¡Œæ›¿æ¢ï¼Œæœ€åå†è¾“å‡ºåˆ°å®¢æˆ·æµè§ˆå™¨ï¼ˆç”±äºé»˜è®¤çš„ response å¹¶ä¸èƒ½ä¸¥æ ¼çš„ç¼“å­˜è¾“å‡ºå†…å®¹ï¼Œå› æ­¤éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªå…·å¤‡ç¼“å­˜åŠŸèƒ½çš„ responseï¼‰ã€‚
    

> Filter åº”ç”¨åœºæ™¯çš„ç›¸å…³å†…å®¹å‚è€ƒè‡ªã€ŠJava Web æ•´åˆå¼€å‘ä¹‹ç‹è€…å½’æ¥ã€‹ï¼Œå¥½ä¸­äºŒçš„ä¹¦å ğŸ¤£ï¼Œå…³äºè‡ªå®šä¹‰å…·å¤‡ç¼“å­˜åŠŸèƒ½çš„ response å¯å‚è€ƒè¯¥ä¹¦çš„ P175ã€‚

æ‹¦æˆªå™¨ Interceptor
---------------

### Interceptor åŸºæœ¬ä»‹ç»

> æœ¬æ–‡æ‰€è¯´çš„æ‹¦æˆªå™¨æŒ‡çš„æ˜¯ Spring MVC ä¸­çš„æ‹¦æˆªå™¨ã€‚

æ‹¦æˆªå™¨ Interceptor æ˜¯ Spring MVC ä¸­çš„é«˜çº§ç»„ä»¶ä¹‹ä¸€ï¼Œå…¶ä½œç”¨æ˜¯æ‹¦æˆªç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å‰ååšä¸€äº›è‡ªå®šä¹‰çš„å¤„ç†ï¼Œå¦‚æ ¡éªŒæƒé™ã€è®°å½•æ—¥å¿—ç­‰ã€‚è¿™ä¸€ç‚¹å’Œ Filter éå¸¸ç›¸ä¼¼ï¼Œä½†ä¸åŒçš„æ˜¯ï¼ŒFilter åœ¨è¯·æ±‚åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œè€Œ Interceptor åˆ™æ˜¯åœ¨è¯·æ±‚åˆ°è¾¾ Controller ä¹‹å‰å¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå“åº”ä¹ŸåŒç†ã€‚

ä¸ Filter ä¸€æ ·ï¼ŒInterceptor ä¹Ÿæ˜¯ AOP ç¼–ç¨‹æ€æƒ³çš„ä½“ç°ï¼Œä¸” Interceptor ä¹Ÿå…·å¤‡é“¾å¼ç»“æ„ï¼Œæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­å¯ä»¥é…ç½®å¤šä¸ª Interceptorï¼Œå½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œæ¯ä¸ª Interceptor æ ¹æ®å…¶å£°æ˜çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

### åˆ›å»º Interceptor

åˆ›å»º Interceptor éœ€è¦å®ç° org.springframework.web.servlet.HandlerInterceptor æ¥å£ï¼ŒHandlerInterceptor æ¥å£ä¸­å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š

*   preHandleï¼šåœ¨ Controller æ–¹æ³•æ‰§è¡Œå‰è¢«è°ƒç”¨ï¼Œå¯ä»¥å¯¹è¯·æ±‚åšé¢„å¤„ç†ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª boolean å˜é‡ï¼Œåªæœ‰å½“è¿”å›å€¼ä¸º true æ—¶ï¼Œç¨‹åºæ‰ä¼šç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚
    
*   postHandleï¼šåœ¨ Controller æ–¹æ³•æ‰§è¡Œç»“æŸï¼ŒDispatcherServlet è¿›è¡Œè§†å›¾æ¸²æŸ“ä¹‹å‰è¢«è°ƒç”¨ï¼Œè¯¥æ–¹æ³•å†…å¯ä»¥æ“ä½œ Controller å¤„ç†åçš„ ModelAndView å¯¹è±¡ã€‚
    
*   afterCompletionï¼šåœ¨æ•´ä¸ªè¯·æ±‚å¤„ç†å®Œæˆï¼ˆåŒ…æ‹¬è§†å›¾æ¸²æŸ“ï¼‰åè¢«è°ƒç”¨ï¼Œé€šå¸¸ç”¨æ¥æ¸…ç†èµ„æºã€‚
    

æ³¨æ„ï¼ŒpostHandle æ–¹æ³•å’Œ afterCompletion æ–¹æ³•æ‰§è¡Œçš„å‰ææ¡ä»¶æ˜¯ preHandle æ–¹æ³•çš„è¿”å›å€¼ä¸º trueã€‚å¦‚æœ Controller æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆ postHandle æ–¹æ³•å°†ä¸ä¼šæ‰§è¡Œï¼ŒafterCompletion æ–¹æ³•åˆ™ä¸€å®šæ‰§è¡Œï¼Œè¯¦è§ DispatcherServlet ç±»ä¸­çš„ doDispatch æ–¹æ³•ã€‚

ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª Interceptorï¼š

    @Component
    public class TestInterceptor implements HandlerInterceptor {
        @Override
        public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
            System.out.println("Interceptor æ‹¦æˆªåˆ°äº†è¯·æ±‚: " + request.getRequestURL());
            return true;
        }
    
        @Override
        public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
    
            System.out.println("Interceptor æ“ä½œ modelAndView...");
        }
    
        @Override
        public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
            System.out.println("Interceptor æ¸…ç†èµ„æº...");
        }
    }
    

### é…ç½® Interceptor

Interceptor éœ€è¦æ³¨å†Œåˆ° Spring å®¹å™¨æ‰èƒ½å¤Ÿç”Ÿæ•ˆï¼Œæ³¨å†Œçš„æ–¹æ³•æ˜¯åœ¨é…ç½®ç±»ä¸­å®ç° WebMvcConfigurer æ¥å£ï¼Œå¹¶é‡å†™ addInterceptors æ–¹æ³•:

    @Configuration
    public class TestInterceptorConfig implements WebMvcConfigurer {
    
        @Autowired
        private TestInterceptor testInterceptor;
    
        @Override
        public void addInterceptors(InterceptorRegistry registry) {
            registry.addInterceptor(testInterceptor)
                    .addPathPatterns("/*")
                    .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                    .order(1);
        }
    }
    

ä¸Šè¿°ä»£ç ä¸­ï¼ŒaddInterceptor æ–¹æ³•ç”¨äºæ³¨å†Œ Interceptorï¼›addPathPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ‹¦æˆªè§„åˆ™ï¼›excludePathPatterns æ–¹æ³•ç”¨äºè®¾ç½®æ”¾è¡Œè§„åˆ™ï¼Œorder æ–¹æ³•ç”¨äºè®¾ç½® Interceptor çš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚

### æµ‹è¯• Interceptor

ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ Web æœåŠ¡ï¼Œæ¥æµ‹è¯• Interceptor æ˜¯å¦ç”Ÿæ•ˆï¼š

    @RestController
    public class UserController {
    
        @RequestMapping(path = "/hello", method = RequestMethod.GET)
        public String sayHello() {
            System.out.println("æ­£åœ¨å¤„ç†è¯·æ±‚...");
            System.out.println("è¯·æ±‚å¤„ç†å®Œæˆ~");
            return "I'm fine, thank you.";
        }
    }
    

å¯åŠ¨é¡¹ç›®ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—® `localhost:8080/hello`ï¼Œè¯·æ±‚å¤„ç†å®Œæˆåï¼Œæ§åˆ¶å°æ‰“å°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š

![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509083837579-142839002.jpg)

å¯ä»¥çœ‹åˆ°ï¼ŒInterceptor æˆåŠŸæ‹¦æˆªåˆ°äº†è®¿é—® Controller çš„ `/hello` è¯·æ±‚å’Œè®¿é—®é™æ€èµ„æºçš„ `/favicon.ico` è¯·æ±‚ï¼Œå¹¶åœ¨è¯·æ±‚å¤„ç†å‰åæ‰§è¡Œäº†ç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚

å½“éœ€è¦è®¾ç½®å¤šä¸ª Interceptor æ—¶ï¼Œå¯ä»¥ç›´æ¥åœ¨é…ç½®ç±»ä¸­æ·»åŠ  Interceptor çš„é…ç½®è§„åˆ™ï¼Œä¾‹å¦‚å¢åŠ  TestInterceptor2ï¼š

    @Configuration
    public class TestInterceptorConfig implements WebMvcConfigurer {
    
        @Autowired
        private TestInterceptor testInterceptor;
    
        @Autowired
        private TestInterceptor2 testInterceptor2;
    
        @Override
        public void addInterceptors(InterceptorRegistry registry) {
            registry.addInterceptor(testInterceptor)
                    .addPathPatterns("/*")
                    .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                    .order(1);
    
            registry.addInterceptor(testInterceptor2)
                    .addPathPatterns("/*")
                    .excludePathPatterns("/**/*.css", "/**/*.js", "/**/*.png", "/**/*.jpg", "/**/*.jpeg")
                    .order(2);
        }
    }
    

**Interceptor çš„æ‰§è¡Œé¡ºåºç”±å…¶é…ç½®çš„ order å†³å®šï¼Œorder è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯ preHandle æ–¹æ³•çš„æ‰§è¡Œé¡ºåºï¼ŒpostHandle å’Œ afterCompletion çš„æ‰§è¡Œé¡ºåºä¸ preHandle ç›¸å**ï¼Œä¾‹å¦‚åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œæ‰§è¡Œé¡ºåºä¸ºï¼š  
![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509083938393-455856581.jpg)

å¦‚æœæˆ‘ä»¬ä¸é…ç½® orderï¼Œé‚£ä¹ˆ Spring é»˜è®¤å°† order è®¾ç½®ä¸º 0ï¼ˆå¯ä»¥æŸ¥çœ‹ InterceptorRegistration ç±»çš„æºç ï¼‰ã€‚**å¦‚æœä¸åŒ Interceptor å…·æœ‰ç›¸åŒçš„ orderï¼Œé‚£ä¹ˆå…¶æ‰§è¡Œé¡ºåºä¸ºé…ç½®ç±»ä¸­çš„æ³¨å†Œé¡ºåº**ã€‚

### Interceptor çš„åº”ç”¨åœºæ™¯

Interceptor çš„åº”ç”¨åœºå¯ä»¥å‚è€ƒä¸Šæ–‡ä¸­ä»‹ç»çš„ Filter çš„åº”ç”¨åœºæ™¯ï¼Œå¯ä»¥è¯´ Filter èƒ½åšåˆ°çš„äº‹ Interceptor éƒ½èƒ½åšã€‚ç”±äº Filter åœ¨ Servlet å‰åèµ·ä½œç”¨ï¼Œè€Œ Interceptor å¯ä»¥åœ¨ Controller æ–¹æ³•å‰åèµ·ä½œç”¨ï¼Œä¾‹å¦‚æ“ä½œ Controller å¤„ç†åçš„ ModelAndViewï¼Œå› æ­¤ Interceptor æ›´åŠ çµæ´»ï¼Œåœ¨ Spring é¡¹ç›®ä¸­ï¼Œå¦‚æœèƒ½ä½¿ç”¨ Interceptor çš„è¯å°½é‡ä½¿ç”¨ Interceptorã€‚

Filter å’Œ Interceptor çš„åŒºåˆ«
------------------------

Filter å’Œ Interceptor éƒ½æ˜¯ AOP ç¼–ç¨‹æ€æƒ³çš„æç°ï¼Œä¸”éƒ½èƒ½å®ç°æƒé™æ£€æŸ¥ã€æ—¥å¿—è®°å½•ç­‰åŠŸèƒ½ï¼Œä½†äºŒè€…ä¹Ÿæœ‰è®¸å¤šä¸åŒä¹‹å¤„ï¼š

**1\. è§„èŒƒä¸åŒ**

Filter åœ¨ Servlet è§„èŒƒä¸­å®šä¹‰ï¼Œä¾èµ–äº Servlet å®¹å™¨ï¼ˆå¦‚ Tomcatï¼‰ï¼›Interceptor ç”± Spring å®šä¹‰ï¼Œä¾èµ–äº Spring å®¹å™¨ï¼ˆIoC å®¹å™¨ï¼‰ã€‚

**2\. é€‚ç”¨èŒƒå›´ä¸åŒ**

Filter ä»…å¯ç”¨äº Web ç¨‹åºï¼Œå› ä¸ºå…¶ä¾èµ–äº Servlet å®¹å™¨ï¼›Interceptor ä¸ä»…å¯ä»¥ç”¨äº Web ç¨‹åºï¼Œè¿˜å¯ä»¥ç”¨äº Applicationã€Swing ç­‰ç¨‹åºã€‚

**3\. å®ç°åŸç†ä¸åŒ**

Filter æ˜¯åŸºäºå‡½æ•°å›è°ƒæ¥å®ç°çš„ï¼ŒInterceptor åˆ™æ˜¯åŸºäº Java çš„åå°„æœºåˆ¶ï¼ˆåŠ¨æ€ä»£ç†ï¼‰æ¥å®ç°çš„ã€‚

> ä¸‹æ–‡ä¸­æˆ‘ä»¬é‡ç‚¹ä»‹ç»ä¸€ä¸‹ Filter çš„å›è°ƒæœºåˆ¶ã€‚

**4\. è§¦å‘æ—¶æœºä¸åŒ**

Filter åœ¨è¯·æ±‚è¿›å…¥ Servlet å®¹å™¨ï¼Œä¸”åˆ°è¾¾ Servlet ä¹‹å‰å¯¹è¯·æ±‚åšé¢„å¤„ç†ï¼›åœ¨ Servlet å¤„ç†å®Œè¯·æ±‚åå¯¹å“åº”åšåå¤„ç†ã€‚

Interceptor åœ¨è¯·æ±‚è¿›å…¥ Servletï¼Œä¸”åˆ°è¾¾ Controller ä¹‹å‰å¯¹è¯·æ±‚åšé¢„å¤„ç†ï¼›åœ¨ Controller å¤„ç†å®Œè¯·æ±‚åå¯¹ ModelAndView åšåå¤„ç†ï¼Œåœ¨è§†å›¾æ¸²æŸ“å®Œæˆåå†åšä¸€äº›æ”¶å°¾å·¥ä½œã€‚

ä¸‹å›¾å±•ç¤ºäº†äºŒè€…çš„è§¦å‘æ—¶æœºï¼š

![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509084017942-1645268363.jpg)

å½“ Filter å’Œ Interceptor åŒæ—¶å­˜åœ¨æ—¶ï¼ŒFilter å¯¹è¯·æ±‚çš„é¢„å¤„ç†è¦å…ˆäº Interceptor çš„ preHandle æ–¹æ³•ï¼›Filter å¯¹å“åº”çš„åå¤„ç†è¦åäº Interceptor çš„ postHandle æ–¹æ³•å’Œ afterCompletion æ–¹æ³•ã€‚

å…³äº Filter å’Œ Interceptor çš„è¡¥å……è¯´æ˜
-----------------------------

**1\. Filter çš„å›è°ƒæœºåˆ¶**

åœ¨ä»‹ç» Filter çš„å›è°ƒæœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹å›è°ƒå‡½æ•°çš„æ¦‚å¿µã€‚å¦‚æœå°†å‡½æ•°ï¼ˆC++ ä¸­çš„å‡½æ•°æŒ‡é’ˆï¼ŒJava ä¸­çš„åŒ¿åå‡½æ•°ã€æ–¹æ³•å¼•ç”¨ç­‰ï¼‰ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¸»æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±ç§°ä¸ºå›è°ƒå‡½æ•°ï¼Œä¸»æ–¹æ³•ä¼šåœ¨æŸä¸€æ—¶åˆ»è°ƒç”¨å›è°ƒå‡½æ•°ã€‚

> ä¸ºäº†ä¾¿äºåŒºåˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨ "ä¸»æ–¹æ³•" å’Œ "å‡½æ•°" æ¥åˆ†è¾¨ä¸»å‡½æ•°å’Œå›è°ƒå‡½æ•°ã€‚

ä½¿ç”¨å›è°ƒå‡½æ•°çš„å¥½å¤„æ˜¯èƒ½å¤Ÿå®ç°å‡½æ•°é€»è¾‘çš„è§£è€¦ï¼Œä¸»æ–¹æ³•å†…å¯ä»¥å®šä¹‰é€šç”¨çš„å¤„ç†é€»è¾‘ï¼Œéƒ¨åˆ†ç‰¹å®šçš„æ“ä½œåˆ™äº¤ç»™å›è°ƒå‡½æ•°æ¥å®Œæˆã€‚ä¾‹å¦‚ Java ä¸­ Arrays ç±»çš„ `sort(T[] a, Comparator<? super T> c)` æ–¹æ³•å…è®¸æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæ¯”è¾ƒå™¨æ¥è‡ªå®šä¹‰æ’åºè§„åˆ™ï¼Œè¿™ä¸ªæ¯”è¾ƒå™¨çš„ compare æ–¹æ³•å°±å±äºå›è°ƒå‡½æ•°ï¼Œsort æ–¹æ³•ä¼šåœ¨æ’åºæ—¶è°ƒç”¨ compare æ–¹æ³•ã€‚

æ¥ä¸‹æ¥ä»‹ç» Filter çš„å›è°ƒæœºåˆ¶ï¼Œä¸Šæ–‡ä¸­æåˆ°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ xxFilter ç±»éœ€è¦å®ç° Filter æ¥å£ï¼Œä¸”éœ€è¦é‡å†™ doFilter æ–¹æ³•ï¼š

    public class TestFilter implements Filter {
        @Override
        public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
            // ...
            filterChain.doFilter(servletRequest, servletResponse);
        }
    }
    

Filter æ¥å£çš„ doFilter æ–¹æ³•æ¥æ”¶ä¸€ä¸ª FilterChain ç±»å‹çš„å‚æ•°ï¼Œè¿™ä¸ª FilterChain å¯¹è±¡å¯è®¤ä¸ºæ˜¯ä¼ é€’ç»™ doFilter æ–¹æ³•çš„å›è°ƒå‡½æ•°ï¼Œä¸¥æ ¼æ¥è¯´åº”è¯¥æ˜¯è¿™ä¸ª FilterChain å¯¹è±¡çš„ doFilter æ–¹æ³•ï¼Œæ³¨æ„è¿™é‡Œæåˆ°äº†ä¸¤ä¸ª doFilter æ–¹æ³•ã€‚Filter æ¥å£çš„ doFilter æ–¹æ³•åœ¨æ‰§è¡Œç»“æŸæˆ–æ‰§è¡Œå®ŒæŸäº›æ­¥éª¤åä¼šè°ƒç”¨ FilterChain å¯¹è±¡çš„ doFilter æ–¹æ³•ï¼Œå³è°ƒç”¨å›è°ƒå‡½æ•°ã€‚

FilterChain å¯¹è±¡çš„å®é™…ç±»å‹ä¸º ApplicationFilterChainï¼Œå…¶ doFilter() æ–¹æ³•çš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼‰ï¼š

    public final class ApplicationFilterChain implements FilterChain {
    
        @Override
        public void doFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
            // ...
            internalDoFilter(request,response);
        }
        
        private void internalDoFilter(ServletRequest request, ServletResponse response) throws IOException, ServletException {
            if (pos < n) {
                // è·å–ç¬¬ pos ä¸ª filter, å³ xxFilter  
                ApplicationFilterConfig filterConfig = filters[pos++];       
                Filter filter = filterConfig.getFilter();
                // ...
                // è°ƒç”¨ xxFilter çš„ doFilter æ–¹æ³•
                filter.doFilter(request, response, this);
            }
        }
    }
    

å¯è§ï¼ŒApplicationFilterChain çš„ doFilter æ–¹æ³•é¦–å…ˆæ ¹æ®ç´¢å¼•æŸ¥è¯¢åˆ°æˆ‘ä»¬å®šä¹‰çš„ xxFilterï¼Œç„¶åè°ƒç”¨ xxFilter çš„ doFilter æ–¹æ³•ï¼Œåœ¨è°ƒç”¨æ—¶ï¼ŒApplicationFilterChain ä¼šå°†è‡ªå·±ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚xxFilter çš„ doFilter æ–¹æ³•æ‰§è¡Œå®ŒæŸäº›æ­¥éª¤åï¼Œä¼šè°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå³ ApplicationFilterChain çš„ doFilter æ–¹æ³•ï¼Œè¿™æ · ApplicationFilterChain å°±å¯ä»¥è·å–åˆ°ä¸‹ä¸€ä¸ª xxFilterï¼Œå¹¶è°ƒç”¨ä¸‹ä¸€ä¸ª xxFilter çš„ doFilter æ–¹æ³•ï¼Œå¦‚æ­¤å¾ªç¯ä¸‹å»ï¼Œç›´åˆ°æ‰€æœ‰çš„ xxFilter å…¨éƒ¨è¢«è°ƒç”¨ã€‚æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://img2022.cnblogs.com/blog/2430605/202205/2430605-20220509084037944-29957109.jpg)

> xxFilter æ‰§è¡Œå›è°ƒå‡½æ•°çš„è¿‡ç¨‹å°±åƒæ˜¯ç»™äº† ApplicationFilterChain ä¸€ä¸ªé€šçŸ¥ï¼Œå³é€šçŸ¥ ApplicationFilterChain å¯ä»¥æ‰§è¡Œä¸‹ä¸€ä¸ª xxFilter çš„å¤„ç†é€»è¾‘äº†ã€‚

**2\. åœ¨ Filter å’Œ Interceptor æ³¨å…¥ Bean çš„æ³¨æ„äº‹é¡¹**

æœ‰äº›æ–‡ç« åœ¨ä»‹ç» Filter å’Œ Interceptor çš„åŒºåˆ«æ—¶å¼ºè°ƒ Filter ä¸èƒ½é€šè¿‡ IoC æ³¨å…¥ Beanï¼Œå¦‚æœæˆ‘ä»¬é‡‡ç”¨æœ¬æ–‡ä¸­çš„ç¬¬ä¸€ç§åˆ›å»º Filterï¼Œé‚£ä¹ˆç¡®å®ä¸èƒ½æ³¨å…¥æˆåŠŸï¼š

    // è‡ªå®šä¹‰çš„ Filter, æœªæ·»åŠ  @Component æ³¨è§£
    public class TestFilter implements Filter {
    
        @Autowired
        private UserService userService;
    
        @Override
        public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
            HttpServletRequest request = (HttpServletRequest) servletRequest;
            System.out.println(userService);
            filterChain.doFilter(servletRequest, servletResponse);
        }
        // ...
    }
    
    // é…ç½®ç±»
    @Configuration
    public class FilterConfig {
        @Bean
        public FilterRegistrationBean<TestFilter> registryFilter() {
            FilterRegistrationBean<TestFilter> registration = new FilterRegistrationBean<>();
            registration.setFilter(new TestFilter());
            registration.addUrlPatterns("/*");
            registration.setName("TestFilter");
            registration.setOrder(0);
            return registration;
        }
    }
    

ä¸Šè¿°ä»£ç æ‰§è¡Œåï¼ŒuserService è¾“å‡ºä¸º nullï¼Œå› ä¸ºæ³¨å†Œåˆ° IoC å®¹å™¨ä¸­çš„æ˜¯ new å‡ºæ¥çš„ä¸€ä¸ª TestFilter å¯¹è±¡ï¼ˆ`registration.setFilter(new TestFilter());`ï¼‰ï¼Œå¹¶ä¸æ˜¯ Spring è‡ªåŠ¨è£…é…çš„ã€‚è‹¥è¦ä½¿ userService æ³¨å…¥æˆåŠŸï¼Œå¯æ”¹ä¸ºå¦‚ä¸‹å†™æ³•ï¼š

    // è‡ªå®šä¹‰çš„ Filter, æœªæ·»åŠ  @Component æ³¨è§£
    @Component
    public class TestFilter implements Filter {
    
        @Autowired
        private UserService userService;
    
        @Override
        public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
            HttpServletRequest request = (HttpServletRequest) servletRequest;
            System.out.println(userService);
            filterChain.doFilter(servletRequest, servletResponse);
        }
        // ...
    }
    
    // é…ç½®ç±»
    @Configuration
    public class FilterConfig {
    
        @Autowired
        private TestFilter testFilter;
    
        @Bean
        public FilterRegistrationBean<TestFilter> registryFilter() {
            FilterRegistrationBean<TestFilter> registration = new FilterRegistrationBean<>();
            registration.setFilter(testFilter);
            registration.addUrlPatterns("/*");
            registration.setName("TestFilter");
            registration.setOrder(0);
            return registration;
        }
    }
    

ä¸ç¬¬ä¸€ç§å†™æ³•çš„åŒºåˆ«åœ¨äºï¼ŒTestFilter ç±»ä¸Šæ·»åŠ äº† @Component æ³¨è§£ï¼Œä¸”é…ç½®ç±»ä¸­é€šè¿‡ @Autowired æ³¨å…¥ TestFilter å¯¹è±¡ã€‚é™¤äº†ä½¿ç”¨é…ç½®ç±»å¤–ï¼Œæœ¬æ–‡ä»‹ç»çš„å…¶å®ƒå‡ ç§æ–¹å¼ï¼ˆæ·»åŠ  @Component æ³¨è§£æˆ– @WebFilter æ³¨è§£ï¼‰éƒ½å¯ä»¥ç›´æ¥æ³¨å…¥ Beanã€‚

> æ‰€ä»¥è¿˜æ˜¯é‡‡ç”¨ç»§æ‰¿ OncePerRequestFilter çš„æ–¹å¼åˆ›å»º Filter æ¯”è¾ƒæ–¹ä¾¿ã€‚

å¦å¤–ï¼Œä½¿ç”¨æœ¬æ–‡ä»‹ç»çš„åˆ›å»º Interceptor çš„å†™æ³•æ˜¯å¯ä»¥ç›´æ¥æ³¨å…¥ Bean çš„ï¼Œè¯¥å†™æ³•ä¹Ÿæ˜¯å…ˆåœ¨è‡ªå®šä¹‰çš„ Interceptor ä¸Šæ·»åŠ  @Component æ³¨è§£ï¼Œç„¶ååœ¨é…ç½®ç±»ä¸­ä½¿ç”¨ @Autowired æ³¨å…¥è‡ªå®šä¹‰çš„ Interceptorã€‚

**3\. Interceptor æ‹¦æˆªé™æ€è¯·æ±‚**

æœ‰æ–‡ç« æåˆ° Interceptor ä¸èƒ½æ‹¦æˆªé™æ€è¯·æ±‚ï¼Œå…¶å®åœ¨ Spring 1.x çš„ç‰ˆæœ¬ä¸­ç¡®å®æ˜¯è¿™æ ·çš„ï¼Œä½† Spring 2.x å¯¹é™æ€èµ„æºä¹Ÿè¿›è¡Œäº†æ‹¦æˆªï¼Œä¾‹å¦‚ä¸Šæ–‡ä¸­æˆ‘ä»¬åœ¨æµ‹è¯• TestInterceptor æ˜¯å¦ç”Ÿæ•ˆæ—¶ï¼Œå‘ç°å…¶æ‹¦æˆªåˆ°äº† `/favicon.ico` è¯·æ±‚ï¼Œè¯¥è¯·æ±‚æ˜¯ä¸€ä¸ªç”±æµè§ˆå™¨è‡ªåŠ¨å‘é€çš„é™æ€è¯·æ±‚ã€‚

å‚è€ƒèµ„æ–™
----

ä¹¦ç±ï¼šã€ŠJava web æ•´åˆå¼€å‘ç‹è€…å½’æ¥ã€‹  
[Spring Boot å®æˆ˜ï¼šæ‹¦æˆªå™¨ä¸è¿‡æ»¤å™¨](https://www.cnblogs.com/paddix/p/8365558.html)  
[è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨çš„ 6 ä¸ªåŒºåˆ«ï¼Œåˆ«å†å‚»å‚»åˆ†ä¸æ¸…äº†](https://juejin.cn/post/6844904179958284301)