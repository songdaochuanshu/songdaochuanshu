---
layout: post
title: "聊聊Vim的工作原理"
date: "2022-10-05T11:20:01.715Z"
---
聊聊Vim的工作原理
==========

聊聊Vim的工作原理
==========

日常里一直在用Vim这个编辑器，前阵子学习关于Linux中的fd（文件描述符）时，发现vim的进程描述符会比上一个自动加一，后续了解到vim的工作原理后，解开了这个疑问，所以记录一下。

梳理
--

![PrDun.png](https://s1.328888.xyz/2022/10/05/PrDun.png)

首先开一个连接，然后在连接1中用`vim vim.txt`搞一个文件出来

![PrFos.png](https://s1.328888.xyz/2022/10/05/PrFos.png)

之后开一个连接2，在目录下输入`ll`，发现没有什么变化，但紧接着输入`ls -la`

![Prulp.png](https://s1.328888.xyz/2022/10/05/Prulp.png)

可以看到有一个名为`.vim.txt.swp`的隐藏文件，而且创建时间和我们输入指令的时间是相同的。如果这时候我们尝试同样输入`vim vim.txt`，会看到如下报错：

![PrGod.png](https://s1.328888.xyz/2022/10/05/PrGod.png)

根据英文的意思我们不难了解，vim会判断当前目录里是不是已经有了`.$文件名.swp`这个文件，如果有，那么就说明有编辑这个文件的进程正在运行，所以我们当前不能再创建一个同名的文件了

而且这个swp文件是一个二进制文件，我们也没法查看他的内容

![Pr74h.png](https://s1.328888.xyz/2022/10/05/Pr74h.png)

这时我们在连接1中用wq保存退出，在连接2中再次查看目录下的文件列表。结果发现swp文件消失了，取而代之的是出现了我们所创建的vim.txt文件

上述情况是正常保存退出的，那如果我们正在写文件，突然断电退出了，会怎么样呢？我们来模拟一下这个情况

![PrDun.png](https://s1.328888.xyz/2022/10/05/PrDun.png)

还是同样在连接1中使用`vim vim.txt`写入文件内容，这时我们不用wq保存退出，而是直接断开连接

![PrH1p.png](https://s1.328888.xyz/2022/10/05/PrH1p.png)

可以看到目录下同样出现了名为`.vim.txt.swp`的隐藏文件，如果我们这时候再次输入`vim vim.txt`就会看到这样的报错

![PrAAN.png](https://s1.328888.xyz/2022/10/05/PrAAN.png)

同样是E325，但实际上详细信息和之前的情况是不同的，这次的详细信息会说，写这个文件内容的vim进程可能是崩溃了，我们可以用:revover或者`vim -r vim.txt`把文件内容给恢复一下，之后把`.vim.txt.swp`删去

那么现在我们就可以清晰的整理一下vim的整个工作流程了

结论
--

![PHmw6.png](https://s1.328888.xyz/2022/10/05/PHmw6.png)

> vim 编辑文件原理：  
> 01.开始利用vim编辑一个文件  
> 02.需要检查是否有该文件的临时隐藏文件  
> 有：会有报错信息  
> 无：进行编辑同时产生一个临时隐藏文件 /test/test.txt.swp  
> 03.在命令模式就会产生临时隐藏文件 /test/test.txt.swp  
> 04.进入编辑模式进行编辑  
> 05.编辑完成，确定是否为正常保存退出  
> 是：正常保存退出，同时将该文件的临时隐藏文件重命名  
> 否：非正常退出，产生一个临时隐藏文件并长期保留，下次进行编辑会报错  
> 解决问题方法：  
> 1)查看文件内容 --- 大写O  
> 2)重新编辑 --- 大写R  
> 3)不恢复进行编辑 --- 大写E  
> 4)将临时文件删除  
> a)按大写字母D  
> b）rm -f /test/test.txt.swp

参考内容
----

[vim工作原理\_奥尔特星云大使的博客-CSDN博客\_vim原理](https://blog.csdn.net/weixin_43535689/article/details/104750148?ops_request_misc=%7B%22request%5Fid%22%3A%22166434937116800180672427%22%2C%22scm%22%3A%2220140713.130102334.pc%5Fblog.%22%7D&request_id=166434937116800180672427&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-104750148-null-null.nonecase&utm_term=vim&spm=1018.2226.3001.4450)