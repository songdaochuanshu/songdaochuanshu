---
layout: post
title: "åœ¨Linuxä¸ŠæŸ¥çœ‹æ´»è·ƒçº¿ç¨‹æ•°ä¸è¿æ¥æ•°"
date: "2023-03-05T01:24:08.735Z"
---
åœ¨Linuxä¸ŠæŸ¥çœ‹æ´»è·ƒçº¿ç¨‹æ•°ä¸è¿æ¥æ•°
==================

> åŸåˆ›ï¼šæ‰£é’‰æ—¥è®°ï¼ˆå¾®ä¿¡å…¬ä¼—å·IDï¼šcodelogsï¼‰ï¼Œæ¬¢è¿åˆ†äº«ï¼Œéå…¬ä¼—å·è½¬è½½ä¿ç•™æ­¤å£°æ˜ã€‚

### ç®€ä»‹

ç°å¦‚ä»Šï¼Œæœ‰ä¸¤ç§å¸¸è§çš„è½¯ä»¶èµ„æºå‡ ä¹æˆäº†Javaåç«¯ç¨‹åºçš„æ ‡é…ï¼Œå³çº¿ç¨‹æ± ä¸è¿æ¥æ± ï¼Œä½†è¿™äº›æ± åŒ–èµ„æºéå¸¸çš„é‡è¦ï¼Œä¸€æ—¦ä¸å¤Ÿç”¨äº†ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºé˜»å¡ã€æ€§èƒ½ä½ä¸‹ï¼Œæ‰€ä»¥æœ‰æ—¶æˆ‘ä»¬éœ€è¦çœ‹çœ‹å®ƒä»¬çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åˆ¤æ–­è¿™é‡Œæ˜¯å¦æ˜¯ç“¶é¢ˆã€‚

### æŸ¥çœ‹æ´»è·ƒçº¿ç¨‹æ•°

åœ¨Linuxä¸Šï¼Œé€šè¿‡`top -H -p 1`å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹javaè¿›ç¨‹çš„çº¿ç¨‹æƒ…å†µï¼Œå…¶ä¸­1æ˜¯javaè¿›ç¨‹å·ï¼Œå¦‚ä¸‹ï¼š  
![image_2023-03-04_20230304140014](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172313018-383921722.png)  
å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°çº¿ç¨‹çš„åç§°ã€CPUä½¿ç”¨ç‡ç­‰ï¼Œå…¶ä¸­`http-nio-8080-e`å°±æ˜¯Tomcatçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼Œtomcatçº¿ç¨‹å…¨åç±»ä¼¼äº`http-nio-8080-exec-20`ï¼Œç”±äºLinuxä¸­çº¿ç¨‹åç§°æœ‰é•¿åº¦é™åˆ¶ï¼Œæ‰€ä»¥è¢«æˆªæ–­äº†ã€‚

> æ³¨ï¼šjdk8çš„è¯ï¼Œéœ€è¦jdk8u222ä»¥ä¸Šç‰ˆæœ¬ï¼Œæ‰èƒ½åœ¨topä¸­çœ‹åˆ°çº¿ç¨‹åç§°ã€‚

æˆ‘ä»¬æ•°ä¸€ä¸‹`http-nio-8080-e`çº¿ç¨‹çš„æ•°é‡ï¼Œå‘ç°å®ƒæœ‰20ä¸ªï¼Œæ­£å¥½å¯¹åº”ä¸Šäº†åœ¨springbootä¸­çš„çº¿ç¨‹é…ç½®ã€‚  
![image_2023-03-04_20230304133328](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172312984-965851098.png)

è¿™æ ·èƒ½é€šè¿‡topå¾—åˆ°çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°é‡äº†ï¼Œä½†å¦‚ä½•äº†è§£çº¿ç¨‹æ± çš„ä½¿ç”¨æƒ…å†µï¼Œå³æ´»è·ƒçº¿ç¨‹æœ‰å¤šå°‘ä¸ªå‘¢ï¼Ÿ

ç»è¿‡æŸ¥çœ‹manæ–‡æ¡£ï¼Œæˆ‘å‘ç°topå‘½ä»¤æœ‰ä¸€ä¸ª`-i`é€‰é¡¹ï¼Œæè¿°å¦‚ä¸‹ï¼š  
![image_2023-03-04_20230304134557](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172312915-1131129625.png)  
æ„æ€å°±æ˜¯`i`æ˜¯ä¸€ä¸ªå¼€å…³é€‰é¡¹ï¼Œé»˜è®¤ä¼šæ˜¾ç¤ºå…¨éƒ¨çº¿ç¨‹ï¼Œè€Œæ‰“å¼€æ­¤é€‰é¡¹ä¹‹åï¼Œå°±åªæ˜¾ç¤ºæ´»è·ƒçº¿ç¨‹äº†ï¼

æ‰€ä»¥ï¼Œåªéœ€è¦åˆ©ç”¨`-i`é€‰é¡¹ï¼Œå†é…åˆsed/awk/uniqç­‰æ–‡æœ¬å¤„ç†å‘½ä»¤ï¼Œå³å¯ä»¥ç»Ÿè®¡å‡ºæ´»è·ƒçº¿ç¨‹æ•°äº†ï¼Œå¦‚ä¸‹ï¼š

    $ top -H -i -b -d 1 -n2 -p 1 | awk -v RS= 'END{print $0}' | awk '$1 ~ /[0-9]+/{print $12}' | sed -E 's/[0-9]+/n/g' | sort | uniq -c
    

![image_2023-03-04_20230304141731](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172312973-1859443984.png)  
å¯ä»¥çœ‹åˆ°ï¼Œ20ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ä¸­ï¼Œåœ¨1ç§’å†…åªæœ‰4ä¸ªçº¿ç¨‹æ˜¯æ´»è·ƒçš„ï¼Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡æ˜¯è¶³å¤Ÿçš„ã€‚

è¿™ä¸ªå‘½ä»¤è„šæœ¬å°±ä¸å±•å¼€è§£é‡Šäº†ï¼Œä¹Ÿä¸å¤æ‚ï¼Œæœ‰linuxå‘½ä»¤åŸºç¡€çš„å°†å‘½ä»¤ä¾æ¬¡æ‹†å¼€æ‰§è¡Œï¼Œåº”è¯¥èƒ½Getåˆ°è„šæœ¬é€»è¾‘ï¼Œæ²¡å­¦è¿‡linuxå‘½ä»¤çš„è¯ï¼Œå°±ç›´æ¥æ‹¿å»ç”¨å§ğŸ˜…

### æŸ¥çœ‹æ´»è·ƒè¿æ¥æ•°

åœ¨Linuxä¸Šï¼Œä½¿ç”¨`ss -natp|grep pid=1`å¯ä»¥æŸ¥çœ‹1å·è¿›ç¨‹çš„TCPè¿æ¥ï¼Œå¦‚ä¸‹ï¼š  
![image_2023-03-04_20230304144050](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172312986-1157780985.png)  
æ¯”å¦‚è‹¥redisæ•°æ®åº“ç«¯å£æ˜¯6379çš„è¯ï¼Œé‚£ä¹ˆå¯è¿™æ ·æŸ¥çœ‹redisè¿æ¥æ± ä¸­è¿æ¥æ•°é‡ï¼Œå¦‚ä¸‹ï¼š

    $ ss -natp | grep pid=1 | awk '$5~/:6379$/' | wc -l
    20
    

å¯è§å½“å‰æœ‰20ä¸ªredisç½‘ç»œè¿æ¥ï¼Œé‚£åŒæ ·çš„ï¼Œå…¶ä¸­æœ‰å¤šå°‘ä¸ªæ˜¯æ´»è·ƒçš„å‘¢ï¼Ÿ

ç»è¿‡æŸ¥çœ‹manæ–‡æ¡£ï¼Œå‘ç°ssä¸­ä¹Ÿæœ‰ä¸€ä¸ª`-i`é€‰é¡¹ï¼Œå¦‚ä¸‹ï¼š  
![image_2023-03-04_20230304145652](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172312979-116787601.png)  
å¯ä»¥å‘ç°ï¼Œæ·»åŠ `-i`é€‰é¡¹åï¼Œssä¼šè¾“å‡ºtcpè¿æ¥ä¸­çš„ä¸€äº›é¢å¤–ä¿¡æ¯ï¼Œå…¶ä¸­lastsndè¡¨ç¤ºæœ€åä¸€æ¬¡å‘é€åŒ…åˆ°å½“å‰æ‰€ç»å†çš„æ¯«ç§’æ•°ï¼Œlastrcvè¡¨ç¤ºæœ€åä¸€æ¬¡æ¥æ”¶åŒ…åˆ°å½“å‰æ‰€ç»å†çš„æ¯«ç§’æ•°ã€‚

æœ‰äº†è¿™ä¸ªä¿¡æ¯åï¼Œå°±å¯ä»¥é€šè¿‡awkè¿‡æ»¤å‡ºlastsndæˆ–lastrcvå°äº1000çš„tcpè¿æ¥ï¼Œè¿™äº›è¿æ¥å³æ˜¯1ç§’å†…æ´»è·ƒè¿‡çš„è¿æ¥äº†ï¼Œå› æ­¤æˆ‘åˆç¼–å†™äº†å¦‚ä¸‹å‘½ä»¤è„šæœ¬ã€‚

    $ ss -natpi | sed '1!{N;s/\n//;}' | grep pid=1 | awk -v t=1000 'match($0,/lastsnd:(\w+) lastrcv:(\w+)/,a) && (a[1]<t || a[2]<t) && match($4,/(.+):(\w+)$/,s) && match($5,/(.+):(\w+)$/,d) && s[2]>=32768{print d[2]}' |sort |uniq -c |sort -nk2
          8 80
          3 3306
          7 3307
          6 6379
          1 7916
    

å¦‚ä¸Šï¼Œå¯ä»¥çœ‹åˆ°å„è¿å‡ºç«¯å£çš„æ´»è·ƒè¿æ¥æƒ…å†µï¼Œå…¶ä¸­80æ˜¯httpè¿æ¥æ± ç«¯å£ï¼Œ3306ä¸3307æ˜¯MySQLä¸»ä»åº“çš„è¿æ¥æ± ç«¯å£ï¼Œ6379æ˜¯redisè¿æ¥æ± çš„ç«¯å£ã€‚

è¿™æ˜¯javaåº”ç”¨ä¸»åŠ¨è¿å‡ºè¿æ¥çš„æ´»è·ƒæƒ…å†µï¼Œé‚£è°ƒç”¨æ–¹è¿å…¥javaåº”ç”¨çš„å‘¢ï¼Ÿ

å…¶å®åªéœ€è¦ç¨å¾®è°ƒæ•´ä¸€ä¸‹awkè„šæœ¬å³å¯ï¼Œå¦‚ä¸‹ï¼š

1.  å°†`s[2]>=32768`è°ƒæ•´ä¸º`s[2]<32768`ï¼Œå…¶ä¸­32768æ˜¯Linuxé»˜è®¤çš„ä¸´æ—¶ç«¯å£å·çš„åˆ†ç•Œçº¿ï¼Œå¯é€šè¿‡`sysctl net.ipv4.ip_local_port_range`æŸ¥è¯¢ï¼Œæœ¬åœ°ç«¯å£å·å¤§äºè¿™ä¸ªå€¼ï¼Œä»£è¡¨æ˜¯è¿å‡ºè¿æ¥.
2.  å°†`print d[2]`è°ƒæ•´ä¸º`print s[2]`ï¼Œå’Œä¸Šé¢æ¡ä»¶è”åˆèµ·æ¥ï¼Œè¾“å‡ºçš„å°±æ˜¯æœ¬åœ°ç›‘å¬ç«¯å£äº†.

è°ƒæ•´åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

    $ ss -natpi | sed '1!{N;s/\n//;}' | grep pid=1 | awk -v t=1000 'match($0,/lastsnd:(\w+) lastrcv:(\w+)/,a) && (a[1]<t || a[2]<t) && match($4,/(.+):(\w+)$/,s) && match($5,/(.+):(\w+)$/,d) && s[2]<32768{print s[2]}' |sort |uniq -c |sort -nk2
         8 8080
    

å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬æœåŠ¡çš„8080ç«¯å£ï¼Œ1ç§’å†…æ´»è·ƒè¿‡çš„è¿æ¥æ•°æ˜¯8ä¸ªã€‚

> æ³¨ï¼šåªæœ‰å½“è°ƒç”¨æ–¹ä¹Ÿä½¿ç”¨è¿æ¥æ± æ—¶ï¼Œè¿™ç§æ–¹æ³•è·å–åˆ°çš„æ´»è·ƒè¿æ¥æ•°æ‰æ˜¯å‡†ç¡®çš„ï¼Œè‹¥è°ƒç”¨æ–¹ä½¿ç”¨çŸ­é“¾æ¥çš„è¯ï¼Œåˆ™ä¸å‡†ç¡®ã€‚

### arthasæŸ¥çœ‹æ´»è·ƒçº¿ç¨‹æ•°ä¸è¿æ¥æ•°

é€šè¿‡ä¸Šé¢çš„æ–¹æ³•ï¼Œå·²ç»å¯ä»¥æŸ¥çœ‹æ´»è·ƒçº¿ç¨‹æ•°ä¸è¿æ¥æ•°äº†ï¼Œä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œä¼šä¸§å¤±ä¸€äº›ç»†èŠ‚ï¼Œå¦‚ä¸‹ï¼š

1.  topä¸­çš„çº¿ç¨‹åä¼šæˆªæ–­ï¼Œå¦‚æœä¸åŒçº¿ç¨‹æ± çš„çº¿ç¨‹åå‰16å­—ç¬¦ä¸€æ ·ï¼Œåˆ™åœ¨topä¸­æ— æ³•åŒºåˆ†ã€‚
2.  ssä¸­æ˜¯é€šè¿‡ç«¯å£æ¥åŒºåˆ†çº¿ç¨‹æ± çš„ï¼Œä½†httpæœåŠ¡çš„ç«¯å£å·åŸºæœ¬éƒ½æ˜¯80æˆ–443ï¼Œæ‰€ä»¥ä¸åŒåŸŸåçš„httpæœåŠ¡çš„è¿æ¥æ± æ— æ³•åŒºåˆ†ã€‚

è‹¥éœ€è¦åˆ†è¾©è¿™äº›ç»†èŠ‚ï¼Œè¿˜æ˜¯è¦æ·±å…¥åˆ°jvmé‡Œé¢æ¥ï¼Œè€Œarthaså°±æ˜¯ä¸€ä¸ªä¸é”™çš„å·¥å…·ï¼Œå®ƒçš„vmtoolå‘½ä»¤èƒ½å¤Ÿè·å–æŒ‡å®šç±»å‹çš„Javaå¯¹è±¡ï¼Œå¹¶ä»Javaå¯¹è±¡ä¸­è·å–ä¿¡æ¯ã€‚

ä»¥springbootä¸ºä¾‹ï¼Œè·å–å†…ç½®tomcatçº¿ç¨‹æ± çš„æ´»è·ƒæƒ…å†µï¼Œå¦‚ä¸‹ï¼š

    # --action getInstancesï¼šè¡¨ç¤ºè·å–å¯¹è±¡å®ä¾‹
    # --classLoaderClassï¼šæŒ‡å®šç±»åŠ è½½å™¨
    # --classNameï¼šæŒ‡å®šè¦è·å–å“ªä¸ªç±»çš„å®ä¾‹
    # --expressï¼šæŒ‡å®šognlè¡¨è¾¾å¼ï¼Œç”¨æ¥ä»å¯¹è±¡ä¸Šè·å–ä¿¡æ¯
    [arthas@1]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.apache.tomcat.util.threads.ThreadPoolExecutor  --express 'instances.{ #{"ActiveCount":getActiveCount(),"LargestPoolSize":getLargestPoolSize(),"CorePoolSize":getCorePoolSize(),"MaximumPoolSize":getMaximumPoolSize(),"QueueSize":getQueue().size(),"ThreadName":getThreadFactory().namePrefix }}' -x 2
    

![image_2023-03-04_20230304155857](https://img2023.cnblogs.com/blog/2792815/202303/2792815-20230304172313154-800629919.png)  
ä¸Šé¢å…¶å®å°±æ˜¯é€šè¿‡vmtoolå·¥å…·ï¼Œè·å–åˆ°äº†tomcatçš„çº¿ç¨‹æ± å¯¹è±¡ï¼Œç„¶åè°ƒç”¨çº¿ç¨‹æ± çš„`getActiveCount()`ç­‰æ–¹æ³•ï¼Œè·å–åˆ°äº†æ´»è·ƒçº¿ç¨‹æ•°ğŸ™„

è¦è·å–è¿æ¥æ± çš„æ´»è·ƒæƒ…å†µï¼Œä¹Ÿä¸€å¹¶å‘ˆä¸Šå§ï¼Œå¦‚ä¸‹ï¼š

    # è·å–druidè¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µ
    [arthas@1]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className com.alibaba.druid.pool.DruidDataSource  --express 'instances.{ #{"url":#this.getUrl().split("\\?")[0], "username":#this.getUsername(),"PoolingCount":#this.getPoolingCount(),"ActiveCount":#this.getActiveCount(),"MaxActive":#this.getMaxActive(),"WaitThreadCount":#this.getWaitThreadCount(),"MaxWaitThreadCount":#this.getMaxWaitThreadCount()} }' -x 2
    
    # è·å–httpclientè¿æ¥æ± çš„ä½¿ç”¨æƒ…å†µ
    [arthas@1]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.apache.http.impl.conn.PoolingHttpClientConnectionManager --express 'instances.{ #pool=#this.pool.routeToPool.values() }' -x2
    

å¯ä»¥çœ‹åˆ°ï¼ŒarthasçœŸçš„å¾ˆæ–¹ä¾¿å®ç”¨ï¼Œå¯¹äºJava Boyæ¥è¯´ï¼Œå€¼å¾—å¥½å¥½ç ”ç©¶ç ”ç©¶ğŸ‘ğŸ‘ğŸ‘