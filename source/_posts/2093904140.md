---
layout: post
title: "ThreadLocal è¶…å¼ºå›¾è§£ï¼Œè¿™æ¬¡ç»ˆäºæ‡‚äº†~"
date: "2023-02-08T18:20:45.824Z"
---
ThreadLocal è¶…å¼ºå›¾è§£ï¼Œè¿™æ¬¡ç»ˆäºæ‡‚äº†~
========================

> **æœ¬æ–‡å·²æ”¶å½•åˆ° [AndroidFamily](https://github.com/pengxurui/AndroidFamily)ï¼ŒæŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] æé—®ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

[åœ¨å‰é¢çš„æ–‡ç« é‡Œ](https://juejin.cn/post/7163301919316934693)ï¼Œæˆ‘ä»¬èŠåˆ°äº†æ•£åˆ—è¡¨çš„å¼€æ”¾å¯»å€æ³•å’Œåˆ†ç¦»é“¾è¡¨æ³•ï¼Œä¹ŸèŠåˆ°äº† [HashMap](https://juejin.cn/post/7163985718417555487)ã€[LinkedHashMap](https://juejin.cn/post/7164348785512939551) å’Œ [WeakHashMap](https://juejin.cn/post/7165044834590261256) ç­‰åŸºäºåˆ†ç¦»é“¾è¡¨æ³•å®ç°çš„æ•£åˆ—è¡¨ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥è®¨è®º Java æ ‡å‡†åº“ä¸­ä¸€ä¸ªä½¿ç”¨å¼€æ”¾å¯»å€æ³•çš„æ•£åˆ—è¡¨ç»“æ„ï¼Œä¹Ÿæ˜¯ Java & Android â€œé¢è¯•å…«è‚¡æ–‡â€ çš„æ ‡å‡†é¢˜åº“ä¹‹ä¸€ â€”â€” ThreadLocalã€‚

æœ¬æ–‡æºç åŸºäº Java 8 ThreadLocalã€‚

* * *

**æ€ç»´å¯¼å›¾ï¼š**

![](https://files.mdnice.com/user/3257/4d31a7e4-07f9-4b83-9246-bcf32645a9cf.jpeg)

* * *

1\. å›é¡¾æ•£åˆ—è¡¨çš„å·¥ä½œåŸç†
--------------

**åœ¨å¼€å§‹åˆ†æ ThreadLocal çš„å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾æ•£åˆ—è¡¨çš„å·¥ä½œåŸç†ã€‚**

æ•£åˆ—è¡¨æ˜¯åŸºäºæ•£åˆ—æ€æƒ³å®ç°çš„ Map æ•°æ®ç»“æ„ï¼Œå°†æ•£åˆ—æ€æƒ³åº”ç”¨åˆ°æ•£åˆ—è¡¨æ•°æ®ç»“æ„æ—¶ï¼Œå°±æ˜¯é€šè¿‡ hash å‡½æ•°æå–é”®ï¼ˆKeyï¼‰çš„ç‰¹å¾å€¼ï¼ˆæ•£åˆ—å€¼ï¼‰ï¼Œå†å°†é”®å€¼å¯¹æ˜ å°„åˆ°å›ºå®šçš„æ•°ç»„ä¸‹æ ‡ä¸­ï¼Œåˆ©ç”¨æ•°ç»„æ”¯æŒéšæœºè®¿é—®çš„ç‰¹æ€§ï¼Œå®ç° O(1) æ—¶é—´çš„å­˜å‚¨å’ŒæŸ¥è¯¢æ“ä½œã€‚

`æ•£åˆ—è¡¨ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/0df93799-90c1-401d-bd03-2ea62e754623.png)

åœ¨ä»é”®å€¼å¯¹æ˜ å°„åˆ°æ•°ç»„ä¸‹æ ‡çš„è¿‡ç¨‹ä¸­ï¼Œæ•£åˆ—è¡¨ä¼šå­˜åœ¨ 2 æ¬¡æ•£åˆ—å†²çªï¼š

*   **ç¬¬ 1 æ¬¡ - hash å‡½æ•°çš„æ•£åˆ—å†²çªï¼š** è¿™æ˜¯ä¸€èˆ¬æ„ä¹‰ä¸Šçš„æ•£åˆ—å†²çªï¼›
*   **ç¬¬ 2 æ¬¡ - æ•£åˆ—å€¼å–ä½™è½¬æ•°ç»„ä¸‹æ ‡ï¼š** æœ¬è´¨ä¸Šï¼Œå°†æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡ä¹Ÿæ˜¯ä¸€æ¬¡ Hash ç®—æ³•ï¼Œä¹Ÿä¼šå­˜åœ¨æ•£åˆ—å†²çªã€‚

äº‹å®ä¸Šï¼Œç”±äºæ•£åˆ—è¡¨æ˜¯å‹ç¼©æ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•é¿å…æ•£åˆ—å†²çªï¼Œåªèƒ½ä¿è¯æ•£åˆ—è¡¨ä¸ä¼šå› ä¸ºæ•£åˆ—å†²çªè€Œå¤±å»æ­£ç¡®æ€§ã€‚å¸¸ç”¨çš„æ•£åˆ—å†²çªè§£å†³æ–¹æ³•æœ‰ 2 ç±»ï¼š

*   **å¼€æ”¾å¯»å€æ³•ï¼š** ä¾‹å¦‚ ThreadLocalMapï¼›
*   **åˆ†ç¦»é“¾è¡¨æ³•ï¼š** ä¾‹å¦‚ HashMapã€‚

**å¼€æ”¾å¯»å€ï¼ˆOpen Addressingï¼‰çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š** åœ¨å‡ºç°æ•£åˆ—å†²çªæ—¶ï¼Œåœ¨æ•°ç»„ä¸Šé‡æ–°æ¢æµ‹å‡ºä¸€ä¸ªç©ºé—²ä½ç½®ã€‚ ç»å…¸çš„æ¢æµ‹æ–¹æ³•æœ‰çº¿æ€§æ¢æµ‹ã€å¹³æ–¹æ¢æµ‹å’ŒåŒæ•£åˆ—æ¢æµ‹ã€‚çº¿æ€§æ¢æµ‹æ˜¯æœ€åŸºæœ¬çš„æ¢æµ‹æ–¹æ³•ï¼Œæˆ‘ä»¬ä»Šå¤©è¦åˆ†æçš„ ThreadLocal ä¸­çš„ ThreadLocalMap æ•£åˆ—è¡¨å°±æ˜¯é‡‡ç”¨çº¿æ€§æ¢æµ‹çš„å¼€æ”¾å¯»å€æ³•ã€‚

* * *

2\. è®¤è¯† ThreadLocal çº¿ç¨‹å±€éƒ¨å­˜å‚¨
-------------------------

### 2.1 è¯´ä¸€ä¸‹ ThreadLocal çš„ç‰¹ç‚¹ï¼Ÿ

**ThreadLocal æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å®‰å…¨æ–¹å¼ã€‚**

ä½¿ç”¨ ThreadLocal æ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡ `ThreadLocal#get` æˆ– `ThreadLocal#set` æ–¹æ³•è®¿é—®èµ„æºåœ¨å½“å‰çº¿ç¨‹çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šä¸å…¶ä»–çº¿ç¨‹äº§ç”Ÿèµ„æºç«äº‰ã€‚è¿™æ„å‘³ç€ ThreadLocal å¹¶ä¸è€ƒè™‘å¦‚ä½•è§£å†³èµ„æºç«äº‰ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ç‹¬ç«‹çš„èµ„æºå‰¯æœ¬ï¼Œä»æ ¹æœ¬ä¸Šé¿å…å‘ç”Ÿèµ„æºå†²çªï¼Œæ˜¯ä¸€ç§æ— é”çš„çº¿ç¨‹å®‰å…¨æ–¹æ³•ã€‚

**ç”¨ä¸€ä¸ªè¡¨æ ¼æ€»ç»“ ThreadLocal çš„ APIï¼š**

public API

æè¿°

set(T)

è®¾ç½®å½“å‰çº¿ç¨‹çš„å‰¯æœ¬

T get()

è·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬

void remove()

ç§»é™¤å½“å‰çº¿ç¨‹çš„å‰¯æœ¬

ThreadLocal<S> withInitial(Supplier<S>)

åˆ›å»º ThreadLocal å¹¶æŒ‡å®šç¼ºçœå€¼åˆ›å»ºå·¥å‚

protected API

æè¿°

T initialValue()

è®¾ç½®ç¼ºçœå€¼

### 2.2 ThreadLocal å¦‚ä½•å®ç°çº¿ç¨‹éš”ç¦»ï¼Ÿï¼ˆé‡ç‚¹ç†è§£ï¼‰

ThreadLocal åœ¨æ¯ä¸ªçº¿ç¨‹çš„ Thread å¯¹è±¡å®ä¾‹æ•°æ®ä¸­åˆ†é…ç‹¬ç«‹çš„å†…å­˜åŒºåŸŸï¼Œå½“æˆ‘ä»¬è®¿é—® ThreadLocal æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨è®¿é—®å½“å‰çº¿ç¨‹çš„ Thread å¯¹è±¡ä¸Šçš„å®ä¾‹æ•°æ®ï¼Œä¸åŒçº¿ç¨‹è®¿é—®çš„æ˜¯ä¸åŒçš„å®ä¾‹æ•°æ®ï¼Œå› æ­¤å®ç°çº¿ç¨‹éš”ç¦»ã€‚

Thread å¯¹è±¡ä¸­è¿™å—æ•°æ®å°±æ˜¯ä¸€ä¸ªä½¿ç”¨çº¿æ€§æ¢æµ‹çš„ ThreadLocalMap æ•£åˆ—è¡¨ï¼ŒThreadLocal å¯¹è±¡æœ¬èº«å°±ä½œä¸ºæ•£åˆ—è¡¨çš„ Key ï¼Œè€Œ Value æ˜¯èµ„æºçš„å‰¯æœ¬ã€‚å½“æˆ‘ä»¬è®¿é—® ThreadLocal æ—¶ï¼Œå°±æ˜¯å…ˆè·å–å½“å‰çº¿ç¨‹å®ä¾‹æ•°æ®ä¸­çš„ ThreadLocalMap æ•£åˆ—è¡¨ï¼Œå†é€šè¿‡å½“å‰ ThreadLocal ä½œä¸º Key å»åŒ¹é…é”®å€¼å¯¹ã€‚

`ThreadLocal.java`

    // è·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬
    public T get() {
        // å…ˆè·å–å½“å‰çº¿ç¨‹å®ä¾‹æ•°æ®ä¸­çš„ ThreadLocalMap æ•£åˆ—è¡¨
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        // é€šè¿‡å½“å‰ ThreadLocal ä½œä¸º Key å»åŒ¹é…é”®å€¼å¯¹
        ThreadLocalMap.Entry e = map.getEntry(this);
        // è¯¦ç»†æºç åˆ†æè§ä¸‹æ–‡ ...
    }
    
    // è·å–çº¿ç¨‹ t çš„ threadLocals å­—æ®µï¼Œå³ ThreadLocalMap æ•£åˆ—è¡¨
    ThreadLocalMap getMap(Thread t) {
        return t.threadLocals;
    }
    
    // é™æ€å†…éƒ¨ç±»
    static class ThreadLocalMap {
        // è¯¦ç»†æºç åˆ†æè§ä¸‹æ–‡ ...
    }
    

`Thread.java`

    // Thread å¯¹è±¡çš„å®ä¾‹æ•°æ®
    ThreadLocal.ThreadLocalMap threadLocals = null;
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    
    // çº¿ç¨‹é€€å‡ºä¹‹å‰ï¼Œä¼šç½®ç©ºthreadLocalså˜é‡ï¼Œä»¥ä¾¿éšåGC
    private void exit() {
        // ...
        threadLocals = null;
        inheritableThreadLocals = null;
        inheritedAccessControlContext = null;
        // ...
    }
    

`ThreadLocal ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/85167778-cb63-454f-b584-8b14747f91b8.png)

### 2.3 ä½¿ç”¨ InheritableThreadLocal ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨

åœ¨ä¸šåŠ¡å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›å­çº¿ç¨‹å¯ä»¥è®¿é—®ä¸»çº¿ç¨‹ä¸­çš„ ThreadLocal æ•°æ®ï¼Œç„¶è€Œ ThreadLocal æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼ŒåŒ…æ‹¬åœ¨çˆ¶å­çº¿ç¨‹ä¹‹é—´ä¹Ÿæ˜¯çº¿ç¨‹éš”ç¦»çš„ã€‚ä¸ºæ­¤ï¼ŒThreadLocal æä¾›äº†ä¸€ä¸ªç›¸ä¼¼çš„å­ç±» `InheritableThreadLocal`ï¼ŒThreadLocal å’Œ InheritableThreadLocal åˆ†åˆ«å¯¹åº”äºçº¿ç¨‹å¯¹è±¡ä¸Šçš„ä¸¤å—å†…å­˜åŒºåŸŸï¼š

*   **1ã€ThreadLocal å­—æ®µï¼š** åœ¨æ‰€æœ‰çº¿ç¨‹é—´éš”ç¦»ï¼›
    
*   **2ã€InheritableThreadLocal å­—æ®µï¼š** å­çº¿ç¨‹ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„ InheritableThreadLocal æ•°æ®ã€‚çˆ¶çº¿ç¨‹åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œä¼šæ‰¹é‡å°†çˆ¶çº¿ç¨‹çš„æœ‰æ•ˆé”®å€¼å¯¹æ•°æ®æ‹·è´åˆ°å­çº¿ç¨‹çš„ InheritableThreadLocalï¼Œå› æ­¤å­çº¿ç¨‹å¯ä»¥å¤ç”¨çˆ¶çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ã€‚
    

åœ¨ InheritableThreadLocal ä¸­ï¼Œå¯ä»¥é‡å†™ `childValue()` æ–¹æ³•ä¿®æ”¹æ‹·è´åˆ°å­çº¿ç¨‹çš„æ•°æ®ã€‚

    public class InheritableThreadLocal<T> extends ThreadLocal<T> {
    
        // å‚æ•°ï¼šçˆ¶çº¿ç¨‹çš„æ•°æ®
        // è¿”å›å€¼ï¼šæ‹·è´åˆ°å­çº¿ç¨‹çš„æ•°æ®ï¼Œé»˜è®¤ä¸ºç›´æ¥ä¼ é€’
        protected T childValue(T parentValue) {
            return parentValue;
        }
    }
    

éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š

*   **æ³¨æ„ 1 - InheritableThreadLocal åŒºåŸŸåœ¨æ‹·è´åä¾ç„¶æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼š** åœ¨å®Œæˆæ‹·è´åï¼Œçˆ¶å­çº¿ç¨‹å¯¹ InheritableThreadLocal çš„æ“ä½œä¾ç„¶æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚å­çº¿ç¨‹å¯¹ InheritableThreadLocal çš„å†™ä¸ä¼šå½±å“çˆ¶çº¿ç¨‹çš„ InheritableThreadLocalï¼Œåä¹‹äº¦ç„¶ï¼›
    
*   **æ³¨æ„ 2 - æ‹·è´è¿‡ç¨‹åœ¨çˆ¶çº¿ç¨‹æ‰§è¡Œï¼š** è¿™æ˜¯å®¹æ˜“æ··æ·†çš„ç‚¹ï¼Œè™½ç„¶æ‹·è´æ•°æ®çš„ä»£ç å†™åœ¨å­çº¿ç¨‹çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä½†æ˜¯ä¾ç„¶æ˜¯åœ¨çˆ¶çº¿ç¨‹æ‰§è¡Œçš„ã€‚å­çº¿ç¨‹æ˜¯åœ¨è°ƒç”¨ start() åæ‰å¼€å§‹æ‰§è¡Œçš„ã€‚
    

`InheritableThreadLocal ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/f93d13cc-edb1-4b08-a417-f3c7c3c6733f.png)

### 2.4 ThreadLocal çš„è‡ªåŠ¨æ¸…ç†ä¸å†…å­˜æ³„æ¼é—®é¢˜

**ThreadLocal æä¾›å…·æœ‰è‡ªåŠ¨æ¸…ç†æ•°æ®çš„èƒ½åŠ›ï¼Œå…·ä½“åˆ†ä¸º 2 ä¸ªé¢—ç²’åº¦ï¼š**

*   **1ã€è‡ªåŠ¨æ¸…ç†æ•£åˆ—è¡¨ï¼š** ThreadLocal æ•°æ®æ˜¯ Thread å¯¹è±¡çš„å®ä¾‹æ•°æ®ï¼Œå½“çº¿ç¨‹æ‰§è¡Œç»“æŸåï¼Œå°±ä¼šè·Ÿéš Thread å¯¹è±¡ GC è€Œè¢«æ¸…ç†ï¼›
    
*   **2ã€è‡ªåŠ¨æ¸…ç†æ— æ•ˆé”®å€¼å¯¹ï¼š** ThreadLocal æ˜¯ä½¿ç”¨å¼±é”®çš„åŠ¨æ€æ•£åˆ—è¡¨ï¼Œå½“ Key å¯¹è±¡ä¸å†è¢«æŒæœ‰å¼ºå¼•ç”¨æ—¶ï¼Œåƒåœ¾æ”¶é›†å™¨ä¼šæŒ‰ç…§å¼±å¼•ç”¨ç­–ç•¥è‡ªåŠ¨å›æ”¶ Key å¯¹è±¡ï¼Œå¹¶åœ¨ä¸‹æ¬¡è®¿é—® ThreadLocal æ—¶æ¸…ç†æ— æ•ˆé”®å€¼å¯¹ã€‚
    

`å¼•ç”¨å…³ç³»ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/c62ac76a-f3a8-4b2c-83e6-2fae732f73e9.png)

**ç„¶è€Œï¼Œè‡ªåŠ¨æ¸…ç†æ— æ•ˆé”®å€¼å¯¹ä¼šå­˜åœ¨ â€œæ»åæ€§â€ï¼Œåœ¨æ»åçš„è¿™æ®µæ—¶é—´å†…ï¼Œæ— æ•ˆçš„é”®å€¼å¯¹æ•°æ®æ²¡æœ‰åŠæ—¶å›æ”¶ï¼Œå°±å‘ç”Ÿå†…å­˜æ³„æ¼ã€‚**

*   **ä¸¾ä¾‹ 1ï¼š** å¦‚æœåˆ›å»º ThreadLocal çš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œæ•´ä¸ªæ•£åˆ—è¡¨çš„æ•°æ®å°±ä¼šä¸€è‡´å­˜åœ¨ã€‚æ¯”å¦‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ï¼ˆå¤§ä½“ï¼‰æ˜¯å¤ç”¨çš„ï¼Œè¿™éƒ¨åˆ†å¤ç”¨çº¿ç¨‹ä¸­çš„ ThreadLocal æ•°æ®å°±ä¸ä¼šè¢«æ¸…ç†ï¼›
*   **ä¸¾ä¾‹ 2ï¼š** å¦‚æœåœ¨æ•°æ®æ— æ•ˆåæ²¡æœ‰å†è®¿é—®è¿‡ ThreadLocal å¯¹è±¡ï¼Œé‚£ä¹ˆè‡ªç„¶å°±æ²¡æœ‰æœºä¼šè§¦å‘æ¸…ç†ï¼›
*   **ä¸¾ä¾‹ 3ï¼š** å³ä½¿è®¿é—® ThreadLocal å¯¹è±¡ï¼Œä¹Ÿä¸ä¸€å®šä¼šè§¦å‘æ¸…ç†ï¼ˆåŸå› è§ä¸‹æ–‡æºç åˆ†æï¼‰ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼šè™½ç„¶ ThreadLocal æä¾›äº†è‡ªåŠ¨æ¸…ç†æ— æ•ˆæ•°æ®çš„èƒ½åŠ›ï¼Œä½†æ˜¯ä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼Œåœ¨ä¸šåŠ¡å¼€å‘ä¸­åº”è¯¥åŠæ—¶è°ƒç”¨ `ThreadLocal#remove` æ¸…ç†æ— æ•ˆçš„å±€éƒ¨å­˜å‚¨ã€‚

### 2.5 ThreadLocal çš„ä½¿ç”¨åœºæ™¯

*   **åœºæ™¯ 1 - æ— é”çº¿ç¨‹å®‰å…¨ï¼š** ThreadLocal æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹å®‰å…¨æ–¹å¼ï¼Œä»æ ¹æœ¬ä¸Šé¿å…èµ„æºç«äº‰ï¼Œä¹Ÿä½“ç°äº†ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ï¼›
    
*   **åœºæ™¯ 2 - çº¿ç¨‹çº§åˆ«å•ä¾‹ï¼š** ä¸€èˆ¬çš„å•ä¾‹å¯¹è±¡æ˜¯å¯¹æ•´ä¸ªè¿›ç¨‹å¯è§çš„ï¼Œä½¿ç”¨ ThreadLocal ä¹Ÿå¯ä»¥å®ç°çº¿ç¨‹çº§åˆ«çš„å•ä¾‹ï¼›
    
*   **åœºæ™¯ 3 - å…±äº«å‚æ•°ï¼š** å¦‚æœä¸€ä¸ªæ¨¡å—æœ‰éå¸¸å¤šåœ°æ–¹éœ€è¦ä½¿ç”¨åŒä¸€ä¸ªå˜é‡ï¼Œç›¸æ¯”äºåœ¨æ¯ä¸ªæ–¹æ³•ä¸­é‡å¤ä¼ é€’åŒä¸€ä¸ªå‚æ•°ï¼Œä½¿ç”¨ä¸€ä¸ª ThreadLocal å…¨å±€å˜é‡ä¹Ÿæ˜¯å¦ä¸€ç§ä¼ é€’å‚æ•°æ–¹å¼ã€‚
    

### 2.6 ThreadLocal ä½¿ç”¨ç¤ºä¾‹

æˆ‘ä»¬é‡‡ç”¨ Android Handler æœºåˆ¶ä¸­çš„ Looper æ¶ˆæ¯å¾ªç¯ä½œä¸º ThreadLocal çš„å­¦ä¹ æ¡ˆä¾‹ï¼š

[android.os.Looper.java](https://links.jianshu.com/go?to=http%3A%2F%2Fandroidxref.com%2F9.0.0_r3%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fos%2FLooper.java)

    // /frameworks/base/core/java/android/os/Looper.java
    
    public class Looper {
    
        // é™æ€ ThreadLocal å˜é‡ï¼Œå…¨å±€å…±äº«åŒä¸€ä¸ª ThreadLocal å¯¹è±¡
        static final ThreadLocal<Looper> sThreadLocal = new ThreadLocal<Looper>();
    
        private static void prepare(boolean quitAllowed) {
            if (sThreadLocal.get() != null) {
                throw new RuntimeException("Only one Looper may be created per thread");
            }
            // è®¾ç½® ThreadLocal å˜é‡çš„å€¼ï¼Œå³è®¾ç½®å½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡
            sThreadLocal.set(new Looper(quitAllowed));
        }
    
        public static Looper myLooper() {
            // è·å– ThreadLocal å˜é‡çš„å€¼ï¼Œå³è·å–å½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡
            return sThreadLocal.get();
        }
    
        public static void prepare() {
            prepare(true);
        }
        ...
    }
    

`ç¤ºä¾‹ä»£ç `

    new Thread(new Runnable() {
        @Override
        public void run() {
            Looper.prepare();
            // ä¸¤ä¸ªçº¿ç¨‹ç‹¬ç«‹è®¿é—®ä¸åŒçš„ Looper å¯¹è±¡
            System.out.println(Looper.myLooper());
        }
    }).start();
    	
    new Thread(new Runnable() {
        @Override
        public void run() {
            Looper.prepare();
            // ä¸¤ä¸ªçº¿ç¨‹ç‹¬ç«‹è®¿é—®ä¸åŒçš„ Looper å¯¹è±¡
            System.out.println(Looper.myLooper());
        }
    }).start();
    

è¦ç‚¹å¦‚ä¸‹ï¼š

*   1ã€Looper ä¸­çš„ ThreadLocal è¢«å£°æ˜ä¸ºé™æ€ç±»å‹ï¼Œæ³›å‹å‚æ•°ä¸º Looperï¼Œå…¨å±€å…±äº«åŒä¸€ä¸ª ThreadLocal å¯¹è±¡ï¼›
*   2ã€`Looper#prepare()` ä¸­è°ƒç”¨ `ThreadLocal#set()` è®¾ç½®å½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ï¼›
*   3ã€`Looper#myLooper()` ä¸­è°ƒç”¨ `ThreadLocal#get()` è·å–å½“å‰çº¿ç¨‹å…³è”çš„ Looper å¯¹è±¡ã€‚

æˆ‘ä»¬å¯ä»¥ç”»å‡º Looper ä¸­è®¿é—® ThreadLocal çš„ Timethreads å›¾ï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒçº¿ç¨‹ç‹¬ç«‹è®¿é—®ä¸åŒçš„ Looper å¯¹è±¡ï¼Œå³çº¿ç¨‹é—´ä¸å­˜åœ¨èµ„æºç«äº‰ã€‚

`Looper ThreadLocal ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/90c04a22-a922-4ca7-a03d-4bde2827758b.png)

### 2.7 é˜¿é‡Œå·´å·´ ThreadLocal ç¼–ç¨‹è§„çº¦

åœ¨ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­ï¼Œäº¦æœ‰å…³äº ThreadLocal API çš„ç¼–ç¨‹è§„çº¦ï¼š

*   **ã€å¼ºåˆ¶ã€‘** SimpleDateFormate æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ç±»ï¼Œä¸€èˆ¬ä¸è¦å®šä¹‰ä¸º static \*\*\*\*å˜é‡ã€‚å¦‚æœå®šä¹‰ä¸º staticï¼Œå¿…é¡»åŠ é”ï¼Œæˆ–è€…ä½¿ç”¨ DateUtils å·¥å…·ç±»ï¼ˆä½¿ç”¨ ThreadLocal åšçº¿ç¨‹éš”ç¦»ï¼‰ã€‚

`DataFormat.java`

    private static final ThreadLocal<DataFormat> df = new ThreadLocal<DateFormat>(){
        // è®¾ç½®ç¼ºçœå€¼ / åˆå§‹å€¼
        @Override
        protected DateFormat initialValue(){
            return new SimpleDateFormat("yyyy-MM-dd");
        }
    };
    
    // ä½¿ç”¨ï¼š
    DateUtils.df.get().format(new Date());
    

*   **ã€å‚è€ƒã€‘** ï¼ˆåŸæ–‡è¿‡äºå•°å—¦ï¼Œä»¥ä¸‹æ˜¯å°å½­ç¿»è¯‘è½¬è¿°ï¼‰ThreadLocal å˜é‡å»ºè®®ä½¿ç”¨ static å…¨å±€å˜é‡ï¼Œå¯ä»¥ä¿è¯å˜é‡åœ¨ç±»åˆå§‹åŒ–æ—¶åˆ›å»ºï¼Œæ‰€æœ‰ç±»å®ä¾‹å¯ä»¥å…±äº«åŒä¸€ä¸ªé™æ€å˜é‡ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Android Looper çš„æ¡ˆä¾‹ä¸­ï¼ŒThreadLocal å°±æ˜¯ä½¿ç”¨ static ä¿®é¥°çš„å…¨å±€å˜é‡ï¼‰ã€‚
*   **ã€å¼ºåˆ¶ã€‘** å¿…é¡»å›æ”¶è‡ªå®šä¹‰çš„ ThreadLocal å˜é‡ï¼Œå°¤å…¶åœ¨çº¿ç¨‹æ± åœºæ™¯ä¸‹ï¼Œçº¿ç¨‹ç»å¸¸è¢«åå¤ç”¨ï¼Œå¦‚æœä¸æ¸…ç†è‡ªå®šä¹‰çš„ ThreadLocal å˜é‡ï¼Œåˆ™å¯èƒ½ä¼šå½±å“åç»­ä¸šåŠ¡é€»è¾‘å’Œé€ æˆå†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚å°½é‡åœ¨ä»£ç ä¸­ä½¿ç”¨ try-finally å—å›æ”¶ï¼Œåœ¨ finally ä¸­è°ƒç”¨ remove() æ–¹æ³•ã€‚

* * *

3\. ThreadLocal æºç åˆ†æ
--------------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥åˆ†æ ThreadLocal ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

### 3.1 ThreadLocal çš„å±æ€§

ThreadLocal åªæœ‰ä¸€ä¸ª `threadLocalHashCode` æ•£åˆ—å€¼å±æ€§ï¼š

*   1ã€threadLocalHashCode ç›¸å½“äº ThreadLocal çš„è‡ªå®šä¹‰æ•£åˆ—å€¼ï¼Œåœ¨åˆ›å»º ThreadLocal å¯¹è±¡æ—¶ï¼Œä¼šè°ƒç”¨ `nextHashCode()` æ–¹æ³•åˆ†é…ä¸€ä¸ªæ•£åˆ—å€¼ï¼›
    
*   2ã€ThreadLocal æ¯æ¬¡è°ƒç”¨ `nextHashCode()` æ–¹æ³•éƒ½ä¼šå°†æ•£åˆ—å€¼è¿½åŠ  `HASH_INCREMENT`ï¼Œå¹¶è®°å½•åœ¨ä¸€ä¸ªå…¨å±€çš„åŸå­æ•´å‹ `nextHashCode` ä¸­ã€‚
    

> **æç¤ºï¼š** ThreadLocal çš„æ•£åˆ—å€¼åºåˆ—ä¸ºï¼š0ã€HASH\_INCREMENTã€HASH\_INCREMENT \* 2ã€HASH\_INCREMENT \* 3ã€â€¦

    public class ThreadLocal<T> {
    
        // ç–‘é—® 1ï¼šOKï¼ŒthreadLocalHashCode ç±»ä¼¼äº hashCode()ï¼Œé‚£ä¸ºä»€ä¹ˆ ThreadLocal ä¸é‡å†™ hashCode()
        // ThreadLocal çš„æ•£åˆ—å€¼ï¼Œç±»ä¼¼äºé‡å†™ Object#hashCode()
        private final int threadLocalHashCode = nextHashCode();
    
        // å…¨å±€åŸå­æ•´å‹ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ nextHashCode() ç´¯åŠ ä¸€æ¬¡
        private static AtomicInteger nextHashCode = new AtomicInteger();
    
        // ç–‘é—®ï¼šä¸ºä»€ä¹ˆ ThreadLocal æ•£åˆ—å€¼çš„å¢é‡æ˜¯ 0x61c88647ï¼Ÿ
        private static final int HASH_INCREMENT = 0x61c88647;
    
        private static int nextHashCode() {
            // è¿”å›ä¸Šä¸€æ¬¡ nextHashCode çš„å€¼ï¼Œå¹¶ç´¯åŠ  HASH_INCREMENT
            return nextHashCode.getAndAdd(HASH_INCREMENT);
        }
    }
    
    static class ThreadLocalMap {
        // è¯¦ç»†æºç åˆ†æè§ä¸‹æ–‡ ...
    }
    

ä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 1ï¼šOKï¼ŒthreadLocalHashCode ç±»ä¼¼äº hashCode()ï¼Œé‚£ä¸ºä»€ä¹ˆ ThreadLocal ä¸é‡å†™ hashCode()ï¼Ÿ**

å¦‚æœé‡å†™ `Object#hashCode()`ï¼Œé‚£ä¹ˆ `threadLocalHashCode` æ•£åˆ—å€¼å°±ä¼šå¯¹æ‰€æœ‰æ•£åˆ—è¡¨ç”Ÿæ•ˆã€‚è€Œ threadLocalHashCode æ•£åˆ—å€¼æ˜¯ä¸“é—¨é’ˆå¯¹æ•°ç»„ä¸º 2 çš„æ•´æ•°å¹‚çš„æ•£åˆ—è¡¨è®¾è®¡çš„ï¼Œåœ¨å…¶ä»–æ•£åˆ—è¡¨ä¸­ä¸ä¸€å®šè¡¨ç°è‰¯å¥½ã€‚å› æ­¤ ThreadLocal æ²¡æœ‰é‡å†™ Object#hashCode()ï¼Œè®© threadLocalHashCode æ•£åˆ—å€¼åªåœ¨ ThreadLocal å†…éƒ¨çš„ ThreadLocalMap ä½¿ç”¨ã€‚

`å¸¸è§„åšæ³•`

    public class ThreadLocal<T> {
    
        // ThreadLocal æœªé‡å†™ hashCode()
        @Override
        public int hashCode() {
            return threadLocalHashCode;
        }
    }
    

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 2ï¼šä¸ºä»€ä¹ˆä½¿ç”¨ ThreadLocal ä½œä¸ºæ•£åˆ—è¡¨çš„ Keyï¼Œè€Œä¸æ˜¯å¸¸è§„æ€ç»´ç”¨ Thread Id ä½œä¸º Keyï¼Ÿ**

å¦‚æœä½¿ç”¨ Thread Id ä½œä¸º Keyï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨æ¯ä¸ª ThreadLocal å¯¹è±¡ä¸­ç»´æŠ¤æ•£åˆ—è¡¨ï¼Œè€Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªæ•£åˆ—è¡¨ã€‚æ­¤æ—¶ï¼Œå½“å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®åŒä¸€ä¸ª ThreadLocal å¯¹è±¡ä¸­çš„æ•£åˆ—è¡¨æ—¶ï¼Œå°±éœ€è¦é€šè¿‡åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚è€Œ ThreadLocal çš„æ–¹æ¡ˆè®©æ¯ä¸ªçº¿ç¨‹è®¿é—®ç‹¬ç«‹çš„æ•£åˆ—è¡¨ï¼Œå°±å¯ä»¥ä»æ ¹æœ¬ä¸Šè§„é¿çº¿ç¨‹ç«äº‰ã€‚

### 3.2 ThreadLocal çš„ API

åˆ†æä»£ç ï¼Œå¯ä»¥æ€»ç»“å‡º ThreadLocal API çš„ç”¨æ³•å’Œæ³¨æ„äº‹é¡¹ï¼š

*   **1ã€ThreadLocal#getï¼š** è·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬ï¼›
*   **2ã€ThreadLocal#setï¼š** è®¾ç½®å½“å‰çº¿ç¨‹çš„å‰¯æœ¬ï¼›
*   **3ã€ThreadLocal#removeï¼š** ç§»é™¤å½“å‰çº¿ç¨‹çš„å‰¯æœ¬ï¼›
*   **4ã€ThreadLocal#initialValueï¼š** ç”±å­ç±»é‡å†™æ¥è®¾ç½®ç¼ºçœå€¼ï¼š
    *   4.1 å¦‚æœæœªå‘½ä¸­ï¼ˆMap å–å€¼ä¸º nulï¼‰ï¼Œåˆ™ä¼šè°ƒç”¨ `initialValue()` åˆ›å»ºå¹¶è®¾ç½®ç¼ºçœå€¼ï¼›
    *   4.2 ThreadLocal çš„ç¼ºçœå€¼åªä¼šåœ¨ç¼“å­˜æœªå‘½ä¸­æ—¶åˆ›å»ºï¼Œå³ç¼ºçœå€¼é‡‡ç”¨æ‡’åˆå§‹åŒ–ç­–ç•¥ï¼›
    *   4.3 å¦‚æœå…ˆè®¾ç½®ååˆç§»é™¤å‰¯æœ¬ï¼Œå†æ¬¡ get è·å–å‰¯æœ¬æœªå‘½ä¸­æ—¶ä¾ç„¶ä¼šè°ƒç”¨ `initialValue()` åˆ›å»ºå¹¶è®¾ç½®ç¼ºçœå€¼ã€‚
*   **5ã€ThreadLocal#withInitialï¼š** æ–¹ä¾¿è®¾ç½®ç¼ºçœå€¼ï¼Œè€Œä¸éœ€è¦å®ç°å­ç±»ã€‚

**åœ¨ ThreadLocal çš„ API ä¼šé€šè¿‡ getMap() æ–¹æ³•è·å–å½“å‰çº¿ç¨‹çš„ Thread å¯¹è±¡ä¸­çš„ threadLocals å­—æ®µï¼Œè¿™æ˜¯çº¿ç¨‹éš”ç¦»çš„å…³é”®ã€‚**

`ThreadLocal.java`

    public ThreadLocal() {
        // do nothing
    }
    
    // å­ç±»å¯é‡å†™æ­¤æ–¹æ³•è®¾ç½®ç¼ºçœå€¼ï¼ˆæ–¹æ³•å‘½åä¸º defaultValue è·å–æ›´è´´åˆ‡ï¼‰
    protected T initialValue() {
        // é»˜è®¤ä¸æä¾›ç¼ºçœå€¼
        return null;
    }
    
    // å¸®åŠ©æ–¹æ³•ï¼šä¸é‡å†™ ThreadLocal ä¹Ÿå¯ä»¥è®¾ç½®ç¼ºçœå€¼
    // supplierï¼šç¼ºçœå€¼åˆ›å»ºå·¥å‚
    public static <S> ThreadLocal<S> withInitial(Supplier<? extends S> supplier) {
        return new SuppliedThreadLocal<>(supplier);
    }
    
    // 1. è·å–å½“å‰çº¿ç¨‹çš„å‰¯æœ¬
    public T get() {
        Thread t = Thread.currentThread();
        // ThreadLocalMap è¯¦ç»†æºç åˆ†æè§ä¸‹æ–‡
        ThreadLocalMap map = getMap(t);
        if (map != null) {
            // å­˜åœ¨åŒ¹é…çš„Entry
            ThreadLocalMap.Entry e = map.getEntry(this);
            if (e != null) {
                T result = (T)e.value;
                return result;
            }
        }
        // æœªå‘½ä¸­ï¼Œåˆ™è·å–å¹¶è®¾ç½®ç¼ºçœå€¼ï¼ˆå³ç¼ºçœå€¼é‡‡ç”¨æ‡’åˆå§‹åŒ–ç­–ç•¥ï¼‰
        return setInitialValue();
    }
    
    // è·å–å¹¶è®¾ç½®ç¼ºçœå€¼
    private T setInitialValue() {
        T value = initialValue();
        // å…¶å®æºç ä¸­æ˜¯å¹¶ä¸æ˜¯ç›´æ¥è°ƒç”¨set()ï¼Œè€Œæ˜¯å¤åˆ¶äº†ä¸€ä»½ set() æ–¹æ³•çš„æºç 
        // è¿™æ˜¯ä¸ºäº†é˜²æ­¢å­ç±»é‡å†™ set() æ–¹æ³•åæ”¹å˜ç¼ºçœå€¼é€»è¾‘
        set(value);
        return value;
    }
      
    // 2. è®¾ç½®å½“å‰çº¿ç¨‹çš„å‰¯æœ¬
    public void set(T value) {
        Thread t = Thread.currentThread();
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            // ç›´åˆ°è®¾ç½®å€¼çš„æ—¶å€™æ‰åˆ›å»ºï¼ˆå³ ThreadLocalMap é‡‡ç”¨æ‡’åˆå§‹åŒ–ç­–ç•¥ï¼‰
            createMap(t, value);
    }
    
    // 3. ç§»é™¤å½“å‰çº¿ç¨‹çš„å‰¯æœ¬
    public void remove() {
        ThreadLocalMap m = getMap(Thread.currentThread());
        if (m != null)
            m.remove(this);
    }
    
    ThreadLocalMap getMap(Thread t) {
        // é‡ç‚¹ï¼šè·å–å½“å‰çº¿ç¨‹çš„ threadLocals å­—æ®µ
        return t.threadLocals;
    }
    
    // ThreadLocal ç¼ºçœå€¼å¸®åŠ©ç±»
    static final class SuppliedThreadLocal<T> extends ThreadLocal<T> {
    
        private final Supplier<? extends T> supplier;
    
        SuppliedThreadLocal(Supplier<? extends T> supplier) {
            this.supplier = Objects.requireNonNull(supplier);
        }
    
        // é‡å†™ initialValue() ä»¥è®¾ç½®ç¼ºçœå€¼
        @Override
        protected T initialValue() {
            return supplier.get();
        }
    }
    

### 3.3 InheritableThreadLocal å¦‚ä½•ç»§æ‰¿çˆ¶çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ï¼Ÿ

çˆ¶çº¿ç¨‹åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œåœ¨å­çº¿ç¨‹çš„æ„é€ æ–¹æ³•ä¸­ä¼šæ‰¹é‡å°†çˆ¶çº¿ç¨‹çš„æœ‰æ•ˆé”®å€¼å¯¹æ•°æ®æ‹·è´åˆ°å­çº¿ç¨‹ï¼Œå› æ­¤å­çº¿ç¨‹å¯ä»¥å¤ç”¨çˆ¶çº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ã€‚

`Thread.java`

    // Thread å¯¹è±¡çš„å®ä¾‹æ•°æ®
    ThreadLocal.ThreadLocalMap threadLocals = null;
    ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;
    
    // æ„é€ æ–¹æ³•
    public Thread() {
        init(null, null, "Thread-" + nextThreadNum(), 0);
    }
    
    private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) {
        ...
        if (inheritThreadLocals && parent.inheritableThreadLocals != null)
            // æ‹·è´çˆ¶çº¿ç¨‹çš„ InheritableThreadLocal æ•£åˆ—è¡¨
            this.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);
        ...
    }
    

`ThreadLocal.java`

    // å¸¦ Map çš„æ„é€ æ–¹æ³•
    static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap) {
        return new ThreadLocalMap(parentMap);
    }
    
    static class ThreadLocalMap {
    
        private ThreadLocalMap(ThreadLocalMap parentMap) {
            // è¯¦ç»†æºç åˆ†æè§ä¸‹æ–‡ ...
            Object value = key.childValue(e.value);
            ...
        }	
    }
    

InheritableThreadLocal åœ¨æ‹·è´çˆ¶çº¿ç¨‹æ•£åˆ—è¡¨çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ `InheritableThreadLocal#childValue()` å°è¯•è½¬æ¢ä¸ºå­çº¿ç¨‹éœ€è¦çš„æ•°æ®ï¼Œé»˜è®¤æ˜¯ç›´æ¥ä¼ é€’ï¼Œå¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ä¿®æ”¹æ‹·è´çš„æ•°æ®ã€‚

`InheritableThreadLocal.java`

    public class InheritableThreadLocal<T> extends ThreadLocal<T> {
    
        // å‚æ•°ï¼šçˆ¶çº¿ç¨‹çš„æ•°æ®
        // è¿”å›å€¼ï¼šæ‹·è´åˆ°å­çº¿ç¨‹çš„æ•°æ®ï¼Œé»˜è®¤ä¸ºç›´æ¥ä¼ é€’
        protected T childValue(T parentValue) {
            return parentValue;
        }
    

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åˆ†æ ThreadLocalMap çš„æºç ã€‚
----------------------------

4\. ThreadLocalMap æºç åˆ†æ
-----------------------

ThreadLocalMap æ˜¯ ThreadLocal å†…éƒ¨ä½¿ç”¨çš„æ•£åˆ—è¡¨ï¼Œä¹Ÿæ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±»ã€‚è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬å°±æ¥åˆ†æ ThreadLocalMap æ•£åˆ—è¡¨ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

### 4.1 ThreadLocalMap çš„å±æ€§

å…ˆç”¨ä¸€ä¸ªè¡¨æ ¼æ•´ç† ThreadLocalMap çš„å±æ€§ï¼š

å±æ€§

æè¿°

Entry\[\] table

åº•å±‚æ•°ç»„

int size

æœ‰æ•ˆé”®å€¼å¯¹æ•°é‡

int threshold

æ‰©å®¹é˜ˆå€¼ï¼ˆæ•°ç»„å®¹é‡çš„ 2/3ï¼‰

int INITIAL\_CAPACITY

é»˜è®¤æ•°ç»„å®¹é‡ï¼ˆ16ï¼‰

å¯ä»¥çœ‹åˆ°ï¼Œæ•£åˆ—è¡¨å¿…å¤‡åº•å±‚æ•°ç»„ tableã€é”®å€¼å¯¹æ•°é‡ sizeã€æ‰©å®¹é˜ˆå€¼ threshold ç­‰å±æ€§éƒ½æœ‰ï¼Œå¹¶ä¸”ä¹Ÿè¦æ±‚æ•°ç»„çš„é•¿åº¦æ˜¯ 2 çš„æ•´æ•°å€ã€‚ä¸»è¦åŒºåˆ«åœ¨äº `Entry` èŠ‚ç‚¹ä¸Šï¼š

*   **1ã€ThreadLocal æœ¬èº«å°±æ˜¯æ•£åˆ—è¡¨çš„é”® Keyï¼›**
*   2ã€æ‰©å®¹é˜ˆå€¼ä¸ºæ•°ç»„å®¹é‡çš„ 2/3ï¼›
*   3ã€ThreadLocalMap#Entry èŠ‚ç‚¹æ²¡æœ‰ `next` æŒ‡é’ˆï¼Œå› ä¸º ThreadLocalMap é‡‡ç”¨çº¿æ€§æ¢æµ‹è§£å†³æ•£åˆ—å†²çªï¼Œæ‰€ä»¥ä¸å­˜åœ¨é“¾è¡¨æŒ‡é’ˆï¼›
*   4ã€ThreadLocalMap#Entry åœ¨é”®å€¼å¯¹çš„ Key ä¸Šä½¿ç”¨å¼±å¼•ç”¨ï¼Œè¿™ä¸ WeakHashMap ç›¸ä¼¼ã€‚

`ThreadLocal.java`

    static class ThreadLocalMap {
    
        // é»˜è®¤æ•°ç»„å®¹é‡ï¼ˆå®¹é‡å¿…é¡»æ˜¯ 2 çš„æ•´æ•°å€ï¼‰
        private static final int INITIAL_CAPACITY = 16;
    
        // åº•å±‚æ•°ç»„
        private Entry[] table;
    
        // æœ‰æ•ˆé”®å€¼å¯¹æ•°é‡
        private int size = 0;
    
        // æ‰©å®¹é˜ˆå€¼
        private int threshold; // Default to 0
    
        private void setThreshold(int len) {
            threshold = len * 2 / 3;
        }
    
        // é”®å€¼å¯¹èŠ‚ç‚¹
        static class Entry extends WeakReference<ThreadLocal<?>> {
            // nextï¼šå¼€æ”¾å¯»å€æ³•æ²¡æœ‰ next æŒ‡é’ˆ
            // Keyï¼šä¸ WeakHashMap ç›¸åŒï¼Œå°‘äº† key çš„å¼ºå¼•ç”¨
            // Hashï¼šä½äº ThreadLocal#threadLocalHashCode
            // Valueï¼šå½“å‰çº¿ç¨‹çš„å‰¯æœ¬
            Object value;
    
            Entry(ThreadLocal<?> k, Object v) {
                super(k/*æ³¨æ„ï¼šåªæœ‰ Key æ˜¯å¼±å¼•ç”¨*/);
                value = v;
            }
        }
    }
    

ä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 3ï¼šä¸ºä»€ä¹ˆ ThreadLocalMap è¦æ±‚æ•°ç»„çš„å®¹é‡æ˜¯ 2 çš„æ•´æ•°å¹‚ï¼Ÿï¼ˆå›ç­”è¿‡å¤šå°‘æ¬¡äº†ï¼ŒæŠŠæ‰‹ç»™æˆ‘æ”¾ä¸‹ï¼‰
    
*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 4ï¼šä¸ºä»€ä¹ˆ Key æ˜¯å¼±å¼•ç”¨ï¼Œè€Œä¸æ˜¯ Entry æˆ– Value æ˜¯å¼±å¼•ç”¨ï¼Ÿ**
    

é¦–å…ˆï¼ŒEntry ä¸€å®šè¦æŒæœ‰å¼ºå¼•ç”¨ï¼Œè€Œä¸èƒ½æŒæœ‰å¼±å¼•ç”¨ã€‚è¿™æ˜¯å› ä¸º Entry æ˜¯ ThreadLocalMap å†…éƒ¨ç»´æŠ¤æ•°æ®ç»“æ„çš„å®ç°ç»†èŠ‚ï¼Œå¹¶ä¸ä¼šæš´éœ²åˆ° ThreadLocalMap å¤–éƒ¨ï¼Œå³é™¤äº† ThreadLocalMap æœ¬èº«ä¹‹å¤–æ²¡æœ‰å…¶å®ƒåœ°æ–¹æŒæœ‰ Entry çš„å¼ºå¼•ç”¨ã€‚æ‰€ä»¥ï¼Œå¦‚æœæŒæœ‰ Entry çš„å¼±å¼•ç”¨ï¼Œå³ä½¿ ThreadLocalMap å¤–éƒ¨ä¾ç„¶åœ¨ä½¿ç”¨ Key å¯¹è±¡ï¼ŒThreadLocalMap å†…éƒ¨ä¾ç„¶ä¼šå›æ”¶é”®å€¼å¯¹ï¼Œè¿™ä¸é¢„æœŸä¸ç¬¦ã€‚

å…¶æ¬¡ï¼Œä¸ç®¡æ˜¯ Key è¿˜æ˜¯ Value ä½¿ç”¨å¼±å¼•ç”¨éƒ½å¯ä»¥å®ç°è‡ªåŠ¨æ¸…ç†ï¼Œè‡³äºä½¿ç”¨å“ªä¸€ç§æ–¹æ³•å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œé€‚ç”¨åœºæ™¯ä¹Ÿä¸åŒã€‚Key å¼±å¼•ç”¨çš„ä¼˜ç‚¹æ˜¯å¤–éƒ¨ä¸éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨ï¼Œç¼ºç‚¹æ˜¯å­˜åœ¨ **â€œé‡å»º Key ä¸ç­‰ä»·â€** é—®é¢˜ã€‚

ç”±äº ThreadLocal çš„åº”ç”¨åœºæ™¯æ˜¯çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼Œæˆ‘ä»¬æ²¡æœ‰é‡å»ºå¤šä¸ª ThreadLocal å¯¹è±¡æŒ‡å‘åŒä¸€ä¸ªé”®å€¼å¯¹çš„éœ€æ±‚ï¼Œä¹Ÿæ²¡æœ‰é‡å†™ `Object#equals()` æ–¹æ³•ï¼Œæ‰€ä»¥ä¸å­˜åœ¨é‡å»º Key çš„é—®é¢˜ï¼Œä½¿ç”¨ Key å¼±å¼•ç”¨æ›´æ–¹ä¾¿ã€‚

ç±»å‹

ä¼˜ç‚¹

ç¼ºç‚¹

åœºæ™¯

Key å¼±å¼•ç”¨

å¤–éƒ¨ä¸éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨ï¼Œä½¿ç”¨æ›´ç®€å•

é‡å»º Key ä¸ç­‰ä»·

æœªé‡å†™ equals

Value å¼±å¼•ç”¨

é‡å»º Key ç­‰ä»·

å¤–éƒ¨éœ€è¦æŒæœ‰ Value çš„å¼ºå¼•ç”¨

é‡å†™ equals

> **æç¤ºï¼š** å…³äº â€œé‡å»º Key å¯¹è±¡ä¸ç­‰ä»·çš„é—®é¢˜â€ çš„æ›´å¤šè¯¦ç»†è®ºè¿°è¿‡ç¨‹ï¼Œæˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« é‡Œè®¨è®ºè¿‡ [ã€ŠWeakHashMap å’Œ HashMap çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œä½•æ—¶ä½¿ç”¨ï¼Ÿã€‹](https://juejin.cn/post/7165044834590261256)ï¼Œå»çœ‹çœ‹ã€‚

### 4.2 ThreadLocalMap çš„æ„é€ æ–¹æ³•

ThreadLocalMap æœ‰ 2 ä¸ªæ„é€ æ–¹æ³•ï¼š

*   **1ã€å¸¦é¦–ä¸ªé”®å€¼å¯¹çš„æ„é€ æ–¹æ³•ï¼š** åœ¨é¦–æ¬¡æ·»åŠ å…ƒç´ æˆ–é¦–æ¬¡æŸ¥è¯¢æ•°æ®ç”Ÿæˆç¼ºçœå€¼æ—¶ï¼Œæ‰ä¼šè°ƒç”¨æ­¤æ„é€ æ–¹æ³•åˆ›å»º ThreadLocalMap å¯¹è±¡ï¼Œå¹¶æ·»åŠ é¦–ä¸ªé”®å€¼å¯¹ï¼›
    
*   **2ã€å¸¦ Map çš„æ„é€ æ–¹æ³•ï¼š** åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œçˆ¶çº¿ç¨‹ä¼šè°ƒç”¨æ­¤æ„é€ æ–¹æ³•åˆ›å»º ThreadLocalMap å¯¹è±¡ï¼Œå¹¶æ·»åŠ æ‰¹é‡çˆ¶çº¿ç¨‹ ThreadLocalMap ä¸­çš„æœ‰æ•ˆé”®å€¼å¯¹ã€‚
    

`ThreadLocal.java`

    // å¸¦é¦–ä¸ªé”®å€¼å¯¹çš„æ„é€ æ–¹æ³•
    void createMap(Thread t, T firstValue) {
        t.threadLocals = new ThreadLocalMap(this, firstValue);
    }
    
    // å¸¦ Map çš„æ„é€ æ–¹æ³•
    static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap) {
        return new ThreadLocalMap(parentMap);
    }
    
    static class ThreadLocalMap {
    
        // -> å¸¦é¦–ä¸ªé”®å€¼å¯¹çš„æ„é€ æ–¹æ³•
        ThreadLocalMap(ThreadLocal<?> firstKey, Object firstValue) {
            // åˆ›å»ºåº•å±‚æ•°ç»„ï¼ˆé»˜è®¤é•¿åº¦ä¸º 16ï¼‰
            table = new Entry[INITIAL_CAPACITY];
            // æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
            int i = firstKey.threadLocalHashCode & (INITIAL_CAPACITY - 1);
            // æ·»åŠ é¦–ä¸ªå…ƒç´ ï¼ˆé¦–ä¸ªå…ƒç´ ä¸€å®šä¸ä¼šå†²çªï¼‰
            table[i] = new Entry(firstKey, firstValue);
            // é”®å€¼å¯¹æ•°é‡
            size = 1;
            // è®¾ç½®æ‰©å®¹é˜ˆå€¼
            setThreshold(INITIAL_CAPACITY);
        }
    
        // -> å¸¦ Map çš„æ„é€ æ–¹æ³•
        private ThreadLocalMap(ThreadLocalMap parentMap) {
            Entry[] parentTable = parentMap.table;
            int len = parentTable.length;
            // è®¾ç½®æ‰©å®¹é˜ˆå€¼
            setThreshold(len);
            // åˆ›å»ºåº•å±‚æ•°ç»„ï¼ˆä½¿ç”¨ parent çš„é•¿åº¦ï¼‰
            table = new Entry[len];
    
            // é€ä¸ªæ·»åŠ é”®å€¼å¯¹
            for (int j = 0; j < len; j++) {
                Entry e = parentTable[j];
                if (e != null) {
                    // å¦‚æœé”®å€¼å¯¹çš„ Key è¢«å›æ”¶ï¼Œåˆ™è·³è¿‡
                    ThreadLocal<Object> key = (ThreadLocal<Object>) e.get();
                    if (key != null) {
                        // æ„é€ æ–°çš„é”®å€¼å¯¹
                        Object value = key.childValue(e.value);
                        Entry c = new Entry(key, value);
                        // æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
                        int h = key.threadLocalHashCode & (len - 1);
                        // å¤„ç†æ•£åˆ—å†²çª
                        while (table[h] != null)
                            // çº¿æ€§æ¢æµ‹
                            h = nextIndex(h, len);
                        table[h] = c;
                        // é”®å€¼å¯¹æ•°é‡
                        size++;
                    }
                }
            }
        }
    }
    

### 4.3 å›é¡¾çº¿æ€§æ¢æµ‹çš„å·¥ä½œåŸç†

ThreadLocalMap åç»­çš„æºç æœ‰éš¾åº¦ï¼Œä¸ºäº†å¸®åŠ©ç†è§£ï¼Œæˆ‘å°†æ–‡ç«  â€œç¬¬ä¸€èŠ‚ Â· å›é¡¾æ•£åˆ—è¡¨çš„å·¥ä½œåŸç†â€ ä¸­æœ‰å…³çº¿æ€§æ¢æµ‹æ–¹æ³•çš„éƒ¨åˆ†ç§»åœ¨è¿™é‡Œã€‚

*   **æ·»åŠ é”®å€¼å¯¹ï¼š** å…ˆå°†æ•£åˆ—å€¼å–ä½™æ˜ å°„åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œç„¶åä»æ•°ç»„ä¸‹æ ‡ä½ç½®å¼€å§‹æ¢æµ‹ä¸ç›®æ ‡ Key ç›¸ç­‰çš„èŠ‚ç‚¹ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåˆ™å°†æ—§ Value æ›¿æ¢ä¸ºæ–° Valueï¼Œå¦åˆ™æ²¿ç€æ•°ç»„é¡ºåºçº¿æ€§æ¢æµ‹ã€‚ç›´åˆ°çº¿æ€§æ¢æµ‹é‡åˆ°ç©ºé—²ä½ç½®ï¼Œåˆ™è¯´æ˜èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œéœ€è¦æ·»åŠ æ–°èŠ‚ç‚¹ã€‚å¦‚æœåœ¨æ·»åŠ é”®å€¼å¯¹åæ•°ç»„æ²¡æœ‰ç©ºé—²ä½ç½®ï¼Œå°±è§¦å‘æ‰©å®¹ï¼›
    
*   **æŸ¥æ‰¾é”®å€¼å¯¹ï¼š** æŸ¥æ‰¾ç±»ä¼¼ã€‚ä¹Ÿæ˜¯å…ˆå°†æ•£åˆ—å€¼æ˜ å°„åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œç„¶åä»æ•°ç»„ä¸‹æ ‡ä½ç½®å¼€å§‹çº¿æ€§æ¢æµ‹ã€‚ç›´åˆ°çº¿æ€§æ¢æµ‹é‡åˆ°ç©ºé—²ä½ç½®ï¼Œåˆ™è¯´æ˜èŠ‚ç‚¹ä¸å­˜åœ¨ï¼›
    
*   **åˆ é™¤é”®å€¼å¯¹ï¼š** åˆ é™¤ç±»ä¼¼ã€‚ç”±äºæŸ¥æ‰¾æ“ä½œåœ¨é‡åˆ°ç©ºé—²ä½ç½®æ—¶ï¼Œä¼šè®¤ä¸ºé”®å€¼å¯¹ä¸å­˜åœ¨äºæ•£åˆ—è¡¨ä¸­ï¼Œå¦‚æœåˆ é™¤æ“ä½œæ—¶ â€œçœŸåˆ é™¤â€ï¼Œå°±ä¼šä½¿å¾—ä¸€ç»„è¿ç»­æ®µäº§ç”Ÿæ–­å±‚ï¼Œå¯¼è‡´æŸ¥æ‰¾æ“ä½œå¤±æ•ˆã€‚å› æ­¤ï¼Œåˆ é™¤æ“ä½œè¦åš â€œå‡åˆ é™¤â€ï¼Œåˆ é™¤æ“ä½œåªæ˜¯å°†èŠ‚ç‚¹æ ‡è®°ä¸º â€œDeletedâ€ï¼ŒæŸ¥æ‰¾æ“ä½œåœ¨é‡åˆ° â€œDeletedâ€ æ ‡è®°çš„èŠ‚ç‚¹æ—¶ä¼šç»§ç»­å‘ä¸‹æ¢æµ‹ã€‚
    

`å¼€æ”¾å¯»å€æ³•ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/b3dc357a-6bd2-4904-98ae-5646fef690f6.png)

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨çº¿æ€§æ¢æµ‹ä¸­çš„ â€œè¿ç»­æ®µâ€ éå¸¸é‡è¦ï¼š **çº¿æ€§æ¢æµ‹åœ¨åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨äºæ•£åˆ—è¡¨æ—¶ï¼Œå¹¶ä¸æ˜¯çº¿æ€§éå†æ•´ä¸ªæ•°ç»„ï¼Œè€Œåªä¼šçº¿æ€§éå†ä»æ•£åˆ—å€¼æ˜ å°„çš„æ•°ç»„ä¸‹æ ‡åçš„è¿ç»­æ®µã€‚**

### 4.4 ThreadLocalMap çš„è·å–æ–¹æ³•

ThreadLocalMap çš„è·å–æ–¹æ³•ç›¸å¯¹ç®€å•ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆåˆ†æï¼ŒåŒºåˆ† 2 ç§æƒ…å†µï¼š

*   1ã€æ•°ç»„ä¸‹æ ‡ç›´æ¥å‘½ä¸­ç›®æ ‡ Keyï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¹Ÿä¸æ¸…ç†æ— æ•ˆæ•°æ®ï¼ˆè¿™å°±æ˜¯å‰æ–‡æåˆ°è®¿é—® ThreadLocal ä¸ä¸€å®šä¼šè§¦å‘æ¸…ç†çš„æºç ä½“ç°ï¼‰ï¼›
*   2ã€æ•°ç»„ä¸‹æ ‡æœªå‘½ä¸­ç›®æ ‡ Keyï¼Œåˆ™å¼€å§‹çº¿æ€§æ¢æµ‹ã€‚æ¢æµ‹è¿‡ç¨‹ä¸­å¦‚æœé‡åˆ° Key == null çš„æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä¼šè°ƒç”¨ `expungeStaleEntry()` æ¸…ç†è¿ç»­æ®µï¼ˆè¯´æ˜å³ä½¿è§¦å‘æ¸…ç†ï¼Œä¹Ÿä¸ä¸€å®šä¼šæ‰«ææ•´ä¸ªæ•£åˆ—è¡¨ï¼‰ã€‚

expungeStaleEntry() æ˜¯ ThreadLocalMap æ ¸å¿ƒçš„è¿ç»­æ®µæ¸…ç†æ–¹æ³•ï¼Œä¸‹æ–‡æåˆ°çš„ replaceStaleEntry() å’Œ cleanSomeSlots() ç­‰æ¸…ç†æ–¹æ³•éƒ½ä¼šç›´æ¥æˆ–é—´æ¥è°ƒç”¨åˆ° expungeStaleEntry()ã€‚ å®ƒçš„é€»è¾‘å¾ˆç®€å•ï¼šå°±æ˜¯çº¿æ€§éå†ä» staleSlot ä½ç½®å¼€å§‹çš„è¿ç»­æ®µï¼š

*   1ã€k == null çš„æ— æ•ˆèŠ‚ç‚¹ï¼š æ¸…ç†ï¼›
*   2ã€k â‰  null çš„æœ‰æ•ˆèŠ‚ç‚¹ï¼Œå†æ•£åˆ—åˆ°æ–°çš„ä½ç½®ä¸Šã€‚

`ThreadLocalMap#getEntry æ–¹æ³•ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/311278ef-4238-4bbb-8d7c-4a143e525283.png)

ä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   ğŸ™‹ğŸ»â€â™€ï¸**ç–‘é—® 5ï¼šæ¸…ç†æ— æ•ˆèŠ‚ç‚¹æˆ‘ç†è§£ï¼Œä¸ºä»€ä¹ˆè¦å¯¹æœ‰æ•ˆèŠ‚ç‚¹å†æ•£åˆ—å‘¢ï¼Ÿ**

çº¿æ€§æ¢æµ‹åªä¼šéå†è¿ç»­æ®µï¼Œè€Œæ¸…ç†æ— æ•ˆèŠ‚ç‚¹ä¼šå¯¼è‡´è¿ç»­æ®µäº§ç”Ÿæ–­å±‚ã€‚å¦‚æœæ²¡æœ‰å¯¹æœ‰æ•ˆèŠ‚ç‚¹åšå†æ•£åˆ—ï¼Œé‚£ä¹ˆæœ‰æ•ˆèŠ‚ç‚¹åœ¨ä¸‹æ¬¡æŸ¥è¯¢æ—¶å°±æœ‰å¯èƒ½æ¢æµ‹ä¸åˆ°äº†ã€‚

`ThreadLocal.java`

    static class ThreadLocalMap {
    		
        // è·å– Key åŒ¹é…çš„é”®å€¼å¯¹
        private Entry getEntry(ThreadLocal<?> key) {
            // æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
            int i = key.threadLocalHashCode & (table.length - 1);
            Entry e = table[i];
            if (e != null && e.get() == key)
                // æ•°ç»„ä¸‹æ ‡ç›´æ¥å‘½ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä¹Ÿä¸æ¸…ç†æ— æ•ˆæ•°æ®
                return e;
            else
                // çº¿æ€§æ¢æµ‹ï¼Œå¹¶ä¸”æ¸…ç†è¿ç»­æ®µä¸­æ— æ•ˆæ•°æ®
                return getEntryAfterMiss(key, i, e);
        }
    
        // -> çº¿æ€§æ¢æµ‹ï¼Œå¹¶ä¸”æ¸…ç†è¿ç»­æ®µä¸­æ— æ•ˆæ•°æ®
        private Entry getEntryAfterMiss(ThreadLocal<?> key, int i, Entry e) {
            Entry[] tab = table;
            int len = tab.length;
    
            while (e != null) {
                ThreadLocal<?> k = e.get();
                if (k == key)
                    // å‘½ä¸­
                    return e;
                if (k == null)
                    // Key å¯¹è±¡è¢«å›æ”¶ï¼Œè§¦å‘è¿ç»­æ®µæ¸…ç†
                    // è¿ç»­æ®µæ¸…ç†åœ¨ä¸€ä¸ª while å¾ªç¯ä¸­åªä¼šè§¦å‘ä¸€æ¬¡ï¼Œå› ä¸ºè¿™ä¸ªæ®µä¸­ k == null çš„èŠ‚ç‚¹éƒ½è¢«æ¸…ç†å‡ºå»äº†
                    // å¦‚æœè¿ç»­æ®µæ¸…ç†åï¼Œi ä½ç½®ä¸º nullï¼Œé‚£ä¹ˆç›®æ ‡èŠ‚ç‚¹ä¸€å®šä¸å­˜åœ¨
                    expungeStaleEntry(i);
                else
                    // æœªå‘½ä¸­ï¼Œæ¢æµ‹ä¸‹ä¸€ä¸ªä½ç½®
                    i = nextIndex(i, len);
                e = tab[i];
            }
            return null;
        }
    
        // -> æ¸…ç†è¿ç»­æ®µä¸­æ— æ•ˆæ•°æ®
        // staleSlotï¼šèµ·ç‚¹
        private int expungeStaleEntry(int staleSlot) {
            Entry[] tab = table;
            int len = tab.length;
    
            // æ¸…ç†æ— æ•ˆèŠ‚ç‚¹ï¼ˆèµ·ç‚¹ä¸€å®šæ˜¯æ— æ•ˆèŠ‚ç‚¹ï¼‰
            tab[staleSlot].value = null;
            tab[staleSlot] = null;
            size--;
    
            // çº¿æ€§æ¢æµ‹ç›´åˆ°é‡åˆ°ç©ºé—²ä½ç½®
            Entry e;
            int i;
            for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
                ThreadLocal<?> k = e.get();
                if (k == null) {
                    // æ¸…ç†æ— æ•ˆèŠ‚ç‚¹
                    e.value = null;
                    tab[i] = null;
                    size--;
                } else {
                    // ç–‘é—® 5ï¼šæ¸…ç†æ— æ•ˆèŠ‚ç‚¹æˆ‘ç†è§£ï¼Œä¸ºä»€ä¹ˆè¦å¯¹æœ‰æ•ˆèŠ‚ç‚¹å†æ•£åˆ—å‘¢ï¼Ÿ
                    // å†æ•£åˆ—æœ‰æ•ˆèŠ‚ç‚¹
                    int h = k.threadLocalHashCode & (len - 1);
                    if (h != i) {
                        tab[i] = null;
                        while (tab[h] != null)
                            h = nextIndex(h, len);
                        tab[h] = e;
                    }
                }
            }
            return i;
        }
    
        // -> çº¿æ€§æ¢æµ‹ä¸‹ä¸€ä¸ªæ•°ç»„ä½ç½®
        private static int nextIndex(int i, int len) {
            return ((i + 1 < len) ? i + 1 : 0);
        }
    }
    

### 4.5 ThreadLocalMap çš„æ·»åŠ æ–¹æ³•

ThreadLocalMap#set çš„æµç¨‹éå¸¸å¤æ‚ï¼Œæˆ‘å°†ä¸»è¦æ­¥éª¤æ¦‚æ‹¬ä¸º 6 æ­¥ï¼š

*   1ã€å…ˆå°†æ•£åˆ—å€¼æ˜ å°„åˆ°æ•°ç»„ä¸‹æ ‡ï¼Œå¹¶ä¸”å¼€å§‹çº¿æ€§æ¢æµ‹ï¼›
*   2ã€å¦‚æœæ¢æµ‹ä¸­é‡åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œåˆ™å°†æ—§ Value æ›´æ–°ä¸ºæ–° Valueï¼›
*   3ã€å¦‚æœæ¢æµ‹ä¸­é‡åˆ°æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä¼šè°ƒç”¨ `replaceStaleEntry()` æ¸…ç†è¿ç»­æ®µå¹¶æ·»åŠ é”®å€¼å¯¹ï¼›
*   4ã€å¦‚æœæœªæ¢æµ‹åˆ°ç›®æ ‡èŠ‚ç‚¹æˆ–æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ æ–°èŠ‚ç‚¹ï¼›
*   5ã€æ·»åŠ æ–°èŠ‚ç‚¹åè°ƒç”¨ `cleanSomeSlots()` æ–¹æ³•æ¸…ç†éƒ¨åˆ†æ•°æ®ï¼›
*   6ã€å¦‚æœæ²¡æœ‰å‘ç”Ÿæ¸…ç†å¹¶ä¸”è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œåˆ™è§¦å‘ `rehash()` æ‰©å®¹ã€‚

**replaceStaleEntry()ï¼š** æ¸…ç†è¿ç»­æ®µä¸­çš„æ— æ•ˆèŠ‚ç‚¹çš„åŒæ—¶ï¼Œå¦‚æœç›®æ ‡èŠ‚ç‚¹å­˜åœ¨åˆ™æ›´æ–° Value åæ›¿æ¢åˆ° staleSlot æ— æ•ˆèŠ‚ç‚¹ä½ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°èŠ‚ç‚¹æ›¿æ¢åˆ° staleSlot æ— æ•ˆèŠ‚ç‚¹ä½ç½®ã€‚

**cleanSomeSlots()ï¼š** å¯¹æ•°å¼æ¸…ç†ï¼Œæ¸…ç†å¤æ‚åº¦æ¯”å…¨æ•°ç»„æ¸…ç†ä½ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µåªä¼šæ‰«æ log(len) ä¸ªå…ƒç´ ã€‚å¦‚æœæ‰«æè¿‡ç¨‹ä¸­é‡åˆ°æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä»è¯¥ä½ç½®æ‰§è¡Œä¸€æ¬¡è¿ç»­æ®µæ¸…ç†ï¼Œå†ä»è¿ç»­æ®µçš„ä¸‹ä¸€ä¸ªä½ç½®é‡æ–°æ‰«æ log(len) ä¸ªå…ƒç´ ï¼Œç›´æ¥ç»“æŸå¯¹æ•°æ‰«æã€‚

`ThreadLocalMap#set ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/3d24e297-e0e8-4718-9a46-a66a516c190f.png)

`ThreadLocal.java`

    static class ThreadLocalMap {
    
        private void set(ThreadLocal<?> key, Object value) {
            Entry[] tab = table;
            int len = tab.length;
            // 1ã€æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
            int i = key.threadLocalHashCode & (len-1);
    
            // çº¿æ€§æ¢æµ‹
            for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {
                ThreadLocal<?> k = e.get();
                if (k == key) {
                    // 2ã€å‘½ä¸­ï¼Œå°†æ—§ Value æ›¿æ¢ä¸ºæ–° Value
                    e.value = value;
                    return;
                }
    
                if (k == null) {
                    // 3ã€æ¸…ç†æ— æ•ˆèŠ‚ç‚¹ï¼Œå¹¶æ’å…¥é”®å€¼å¯¹
                    replaceStaleEntry(key, value, i);
                    return;
                }
            }
    
            // 4ã€å¦‚æœæœªæ¢æµ‹åˆ°ç›®æ ‡èŠ‚ç‚¹æˆ–æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™åˆ›å»ºå¹¶æ·»åŠ æ–°èŠ‚ç‚¹
            tab[i] = new Entry(key, value);
            int sz = ++size;
            // cleanSomeSlotsï¼šæ¸…ç†éƒ¨åˆ†æ•°æ®
            // 5ã€æ·»åŠ æ–°èŠ‚ç‚¹åè°ƒç”¨ cleanSomeSlots() æ–¹æ³•æ¸…ç†éƒ¨åˆ†æ•°æ®
            if (!cleanSomeSlots(i, sz /*æœ‰æ•ˆæ•°æ®ä¸ªæ•°*/) && sz >= threshold)
                // 6ã€å¦‚æœæ²¡æœ‰å‘ç”Ÿæ¸…ç†å¹¶ä¸”è¾¾åˆ°æ‰©å®¹é˜ˆå€¼ï¼Œåˆ™è§¦å‘ rehash() æ‰©å®¹
                rehash();
        }
    
        // -> 3ã€æ¸…ç†æ— æ•ˆèŠ‚ç‚¹ï¼Œå¹¶æ’å…¥é”®å€¼å¯¹
        // key-valueï¼šæ’å…¥çš„é”®å€¼å¯¹
        private void replaceStaleEntry(ThreadLocal<?> key, Object value, int staleSlot) {
            Entry[] tab = table;
            int len = tab.length;
            Entry e;
    
            // slotToExpungeï¼šè®°å½•æ¸…ç†çš„èµ·ç‚¹
            int slotToExpunge = staleSlot;
            // 3.1 å‘å‰æ¢æµ‹æ‰¾åˆ°è¿ç»­æ®µä¸­çš„ç¬¬ä¸€ä¸ªæ— æ•ˆèŠ‚ç‚¹
            for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len))
                if (e.get() == null)
                    slotToExpunge = i;
    
            // 3.2 å‘åæ¢æµ‹ç›®æ ‡èŠ‚ç‚¹
            for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) {
                ThreadLocal<?> k = e.get();
    
                if (k == key) {
                    // 3.2.1 å‘½ä¸­ï¼Œå°†ç›®æ ‡èŠ‚ç‚¹æ›¿æ¢åˆ° staleSlot ä½ç½®
                    e.value = value;
                    tab[i] = tab[staleSlot];
                    tab[staleSlot] = e;
    
                    // 3.2.2 å¦‚æœè¿ç»­æ®µåœ¨ staleSlot ä¹‹å‰æ²¡æœ‰æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä» staleSlot çš„ä¸‹ä¸€ä¸ªæ— æ•ˆèŠ‚ç‚¹å¼€å§‹æ¸…ç†
                    if (slotToExpunge == staleSlot)
                        slotToExpunge = i;
                    // 3.2.3 å¦‚æœè¿ç»­æ®µä¸­è¿˜æœ‰å…¶ä»–æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™æ¸…ç†
                    // expungeStaleEntryï¼šè¿ç»­æ®µæ¸…ç†
                    // cleanSomeSlotsï¼šå¯¹æ•°å¼æ¸…ç†
                    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);
                    return;
                }
    
                // å¦‚æœè¿ç»­æ®µåœ¨ staleSlot ä¹‹å‰æ²¡æœ‰æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™ä» staleSlot çš„ä¸‹ä¸€ä¸ªæ— æ•ˆèŠ‚ç‚¹å¼€å§‹æ¸…ç†
                if (k == null && slotToExpunge == staleSlot)
                    slotToExpunge = i;
            }
    
            // 3.3 åˆ›å»ºæ–°èŠ‚ç‚¹å¹¶æ’å…¥ staleSlot ä½ç½®
            tab[staleSlot].value = null;
            tab[staleSlot] = new Entry(key, value);
    
            // 3.4 å¦‚æœè¿ç»­æ®µä¸­è¿˜æœ‰å…¶ä»–æ— æ•ˆèŠ‚ç‚¹ï¼Œåˆ™æ¸…ç†
            if (slotToExpunge != staleSlot)
                cleanSomeSlots(expungeStaleEntry(slotToExpunge), len /*æ•°ç»„é•¿åº¦*/);
        }
    
        // 5ã€å¯¹æ•°å¼æ¸…ç†
        // iï¼šèµ·ç‚¹
        // nï¼šæ•°ç»„é•¿åº¦æˆ–æœ‰æ•ˆæ•°æ®ä¸ªæ•°
        private boolean cleanSomeSlots(int i, int n) {
            boolean removed = false;
            Entry[] tab = table;
            int len = tab.length;
            do {
                i = nextIndex(i, len);
                Entry e = tab[i];
                if (e != null && e.get() == null) {
                    // å‘ç°æ— æ•ˆèŠ‚ç‚¹ï¼Œé‡æ–°æ¢æµ‹ log2(len)
                    n = len;
                    removed = true;
                    // è¿ç»­æ®µæ¸…ç†
                    i = expungeStaleEntry(i);
                }
            } while ( (n >>>= 1) != 0); // æ¢æµ‹ log2(len)
            return removed;
        }
    }
    

### 4.6 ThreadLocalMap çš„æ‰©å®¹æ–¹æ³•

ThreadLocalMap çš„æ‰©å®¹æ–¹æ³•ç›¸å¯¹äºæ·»åŠ æ–¹æ³•æ¯”è¾ƒå¥½ç†è§£ã€‚åœ¨æ·»åŠ æ–¹æ³•ä¸­ï¼Œå¦‚æœæ·»åŠ é”®å€¼å¯¹åæ•£åˆ—å€¼çš„é•¿åº¦è¶…è¿‡æ‰©å®¹é˜ˆå€¼ï¼Œå°±ä¼šè°ƒç”¨ `rehash()` æ–¹æ³•æ‰©å®¹ï¼Œä¸»ä½“æµç¨‹åˆ†ä¸º 3æ­¥ï¼š

*   1ã€å…ˆå®Œæ•´æ‰«ææ•£åˆ—è¡¨æ¸…ç†æ— æ•ˆæ•°æ®ï¼Œæ¸…ç†åç”¨è¾ƒä½çš„é˜ˆå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼›
*   2ã€åˆ›å»ºæ–°æ•°ç»„ï¼›
*   3ã€å°†æ—§æ•°ç»„ä¸Šæ— æ•ˆçš„èŠ‚ç‚¹å¿½ç•¥ï¼Œå°†æœ‰æ•ˆçš„èŠ‚ç‚¹å†æ•£åˆ—åˆ°æ–°æ•°ç»„ä¸Šã€‚

`ThreadLocaoMap#rehash ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/2f22746f-5281-4e53-abcc-50316e54b0f7.png)

`ThreadLocal.java`

    static class ThreadLocalMap {
    
        // æ‰©å®¹ï¼ˆåœ¨å®¹é‡åˆ°è¾¾ threshold æ‰©å®¹é˜ˆå€¼æ—¶è°ƒç”¨ï¼‰
        private void rehash() {
            // 1ã€å…¨æ•°ç»„æ¸…ç†
            expungeStaleEntries();
    		
            // 2ã€ç”¨è¾ƒä½çš„é˜ˆå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹
            if (size >= threshold - threshold / 4)
                // 3ã€çœŸæ­£æ‰§è¡Œæ‰©å®¹
                resize();
        }
    
        // -> 1ã€å®Œæ•´æ•£åˆ—è¡¨æ¸…ç†
        private void expungeStaleEntries() {
            Entry[] tab = table;
            int len = tab.length;
            for (int j = 0; j < len; j++) {
                Entry e = tab[j];
                if (e != null && e.get() == null)
                    // å¾ˆå¥‡æ€ªä¸ºä»€ä¹ˆä¸ä¿®æ”¹ j æŒ‡é’ˆ
                    expungeStaleEntry(j);
            }
        }
    
        // -> 3ã€çœŸæ­£æ‰§è¡Œæ‰©å®¹
        private void resize() {
            Entry[] oldTab = table;
            // æ‰©å®¹ä¸º 2 å€
            int oldLen = oldTab.length;
            int newLen = oldLen * 2;
            Entry[] newTab = new Entry[newLen];
            int count = 0;
    
            for (int j = 0; j < oldLen; ++j) {
                Entry e = oldTab[j];
                if (e != null) {
                    ThreadLocal<?> k = e.get();
                    if (k == null) {
                        // æ¸…é™¤æ— æ•ˆé”®å€¼çš„ Value
                        e.value = null; // Help the GC
                    } else {
                        // å°†æ—§æ•°ç»„ä¸Šçš„é”®å€¼å¯¹å†æ•£åˆ—åˆ°æ–°æ•°ç»„ä¸Š
                        int h = k.threadLocalHashCode & (newLen - 1);
                        while (newTab[h] != null)
                            h = nextIndex(h, newLen);
                        newTab[h] = e;
                        count++;
                    }
                }
            }
            // è®¡ç®—æ‰©å®¹åçš„æ–°å®¹é‡å’Œæ–°æ‰©å®¹é˜ˆå€¼
            setThreshold(newLen);
            size = count;
            table = newTab;
        }
    }
    

### 4.7 ThreadLocalMap çš„ç§»é™¤æ–¹æ³•

ThreadLocalMap çš„ç§»é™¤æ–¹æ³•æ˜¯æ·»åŠ æ–¹æ³•çš„é€†è¿ç®—ï¼ŒThreadLocalMap ä¹Ÿæ²¡æœ‰åšåŠ¨æ€ç¼©å®¹ã€‚

ä¸å¸¸è§„çš„ç§»é™¤æ“ä½œä¸åŒçš„æ˜¯ï¼ŒThreadLocalMap åœ¨åˆ é™¤æ—¶ä¼šæ‰§è¡Œ expungeStaleEntry() æ¸…é™¤æ— æ•ˆèŠ‚ç‚¹ï¼Œå¹¶å¯¹è¿ç»­æ®µä¸­çš„æœ‰æ•ˆèŠ‚ç‚¹åšå†æ•£åˆ—ï¼Œæ‰€ä»¥ ThreadLocalMap æ˜¯ â€œçœŸåˆ é™¤â€ã€‚

`ThreadLocal.java`

    static class ThreadLocalMap {
    
        // ç§»é™¤
        private void remove(ThreadLocal<?> key) {
            Entry[] tab = table;
            int len = tab.length;
            // æ•£åˆ—å€¼è½¬æ•°ç»„ä¸‹æ ‡
            int i = key.threadLocalHashCode & (len-1);
            // çº¿æ€§æ¢æµ‹
            for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) {
                if (e.get() == key) {
                    // æ¸…é™¤å¼±å¼•ç”¨å…³ç³»
                    e.clear();
                    // æ¸…ç†è¿ç»­æ®µ
                    expungeStaleEntry(i);
                    return;
                }
            }
        }
    }
    

### 4.8 ThreadLocalMap å¤æ‚åº¦åˆ†æ

æ€»ç»“ä¸‹ ThreadLocalMap çš„æ—¶é—´å¤æ‚åº¦ï¼Œä»¥ä¸‹ K ä¸ºè¿ç»­æ®µçš„é•¿åº¦ï¼ŒN æ˜¯æ•°ç»„é•¿åº¦ã€‚

*   **è·å–æ–¹æ³•ï¼š** å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(K)ï¼›
*   **æ·»åŠ æ–¹æ³•ï¼š** å¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(K)ï¼Œåœ¨è§¦å‘æ‰©å®¹çš„æ·»åŠ æ“ä½œä¸­æ—¶é—´å¤æ‚åº¦ä¸º O(N)ï¼ŒåŸºäºæ‘Šè¿˜åˆ†æåæ—¶é—´å¤æ‚åº¦ä¾ç„¶æ˜¯ O(K)ï¼›
*   **ç§»é™¤æ–¹æ³•ï¼š** ç§»é™¤æ˜¯ â€œçœŸåˆ é™¤â€ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º O(K)ã€‚

### 4.9 è®¿é—® ThreadLocal ä¸€å®šä¼šæ¸…ç†æ— æ•ˆæ•°æ®å—ï¼Ÿ

ä¸ä¸€å®šã€‚åªæœ‰æ‰©å®¹ä¼šè§¦å‘å®Œæ•´æ•£åˆ—è¡¨æ¸…ç†ï¼Œå…¶ä»–æƒ…å†µéƒ½ä¸èƒ½ä¿è¯æ¸…ç†ï¼Œç”šè‡³ä¸ä¼šè§¦å‘ã€‚

* * *

5\. æ€»ç»“
------

*   1ã€ThreadLocal æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ— é”çº¿ç¨‹å®‰å…¨æ–¹å¼ï¼Œé€šè¿‡ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ç‹¬ç«‹çš„èµ„æºå‰¯æœ¬ï¼Œä»æ ¹æœ¬ä¸Šé¿å…å‘ç”Ÿèµ„æºå†²çªï¼›
*   2ã€ThreadLocal åœ¨æ‰€æœ‰çº¿ç¨‹é—´éš”ç¦»ï¼ŒInheritableThreadLocal åœ¨åˆ›å»ºå­çº¿ç¨‹æ—¶ä¼šæ‹·è´çˆ¶çº¿ç¨‹ä¸­ InheritableThreadLocal çš„æœ‰æ•ˆé”®å€¼å¯¹ï¼›
*   3ã€è™½ç„¶ ThreadLocal æä¾›äº†è‡ªåŠ¨æ¸…ç†æ•°æ®çš„èƒ½åŠ›ï¼Œä½†æ˜¯è‡ªåŠ¨æ¸…ç†å­˜åœ¨æ»åæ€§ã€‚ä¸ºäº†é¿å…å†…å­˜æ³„æ¼ï¼Œåœ¨ä¸šåŠ¡å¼€å‘ä¸­åº”è¯¥åŠæ—¶è°ƒç”¨ remove æ¸…ç†æ— æ•ˆçš„å±€éƒ¨å­˜å‚¨ï¼›
*   4ã€ThreadLocal æ˜¯é‡‡ç”¨çº¿æ€§æ¢æµ‹è§£å†³æ•£åˆ—å†²çªçš„æ•£åˆ—è¡¨ã€‚

`ThreadLocal æ€ç»´å¯¼å›¾`

![](https://files.mdnice.com/user/3257/7e138d85-cb7c-4e80-8f9e-b63ee226dd98.png)

* * *

### å‚è€ƒèµ„æ–™

*   æ•°æ®ç»“æ„ä¸ç®—æ³•åˆ†æ Â· Java è¯­è¨€æè¿°ï¼ˆç¬¬ 5 ç«  Â· æ•£åˆ—ï¼‰â€”â€” \[ç¾\] Mark Allen Weiss è‘—
*   ç®—æ³•å¯¼è®ºï¼ˆç¬¬ 11 ç«  Â· æ•£åˆ—è¡¨ï¼‰â€”â€” \[ç¾\] Thomas H. Cormen ç­‰ è‘—
*   ã€Šé˜¿é‡Œå·´å·´Javaå¼€å‘æ‰‹å†Œã€‹ æ¨å† å® ç¼–è‘—
*   [æ•°æ®ç»“æ„ä¸ç®—æ³•ä¹‹ç¾ï¼ˆç¬¬ 18~22 è®²ï¼‰](https://time.geekbang.org/column/intro/100017301?tab=catalog) â€”â€” ç‹äº‰ è‘—ï¼Œæå®¢æ—¶é—´ å‡ºå“
*   [ThreadLocal å’Œ ThreadLocalMapæºç åˆ†æ](https://juejin.cn/post/6844904141890781192) â€”â€” KingJack è‘—
*   [Why 0x61c88647?](https://www.javaspecialists.eu/archive/Issue164-Why-0x61c88647.html) â€”â€” Dr. Heinz M. Kabutz è‘—

![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7db0e43b744943f685ad1e3627f1ceb1~tplv-k3u1fbpfcp-watermark.image?)