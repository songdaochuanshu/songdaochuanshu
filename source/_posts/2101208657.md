---
layout: post
title: "Spring异步Async和事务Transactional注解"
date: "2023-02-05T18:18:20.535Z"
---
Spring异步Async和事务Transactional注解
===============================

Spring开发中我们我们常常用到@Transaction和@Async，但这2个注解加在一起很多的开发者不敢用，担心事务不生效。下面我们就仔细讲解一下这2个注解同时运用，文章用3个场景讲述它们之间的运用，相信看完本篇文章你就能灵活运用这2个注解了。

**场景一：@Async + @Transaction放在一个方法中，并且方法有异常发生**

![](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205309887-431673453.png)

进行单元测试如下：

![](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205352785-872243156.png)

运行结果：事务回滚了，user没有新增进入数据库。

**场景二：一个同步的方法，调用异步的方法，同步的方法抛出异常。**

**![](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205453411-412736221.png)**

![图片](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205802061-586695042.png)

然后同样运行上面的单测。PS至于上面为什么用applicationContext获取Bean不在本次讲解的范畴，是属于事务是否生效的知识点，如果想知道为什么后续文章进行讲解，可以点一下关注。

结果：第一个方法数据回滚了，第二个异步的数据保存成功了。

**场景三：一个同步方法，调用2个异步的方法，2个异步的方法都抛出异常。**

![](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205526806-1346127413.png)

同样运行上面的单测。

结论：第一个同步方法保存数据成功，第二个和第三个异步方法保存数据失败。

上面的三个场景大概，概括了我们开发中的使用的场景，由上面的场景也可以得出结论：不同线程之间的事务完全隔离，异步线程内完全可以调用异步线程。

然后我们讲解一下第一种场景为什么事务加异步的方法能生效，大部分的开发者都对此有疑问。因为事务生效只在同一个线程中才能生效而使用异步方法时Sping又新创建了一个线程，以为这个事务不生效的，其实是生效的。我们知道不管是异步还是事务都是Spring运用了它的特性Aop。Aop中切面有一个执行顺序的注解，如下是Spring事务的默认的order

int LOWEST\_PRECEDENCE = Integer.MAX\_VALUE;

![](https://img2023.cnblogs.com/blog/2591839/202302/2591839-20230205205608321-670836889.png)

spring事务切面order为最大的整数值，也就是说它的执行优先级是最低的。所以可以知道Async异步的切面先执行，事务的切面后执行，通俗理解异步包裹了事务的执行，所以可以说事务是在异步的那个线程里面执行的，所以也就理解了为什么事务会生效。

微信公众号搜索：程序员xiaozhang 。如果遇到Spring的问题也可以私信我 能帮忙解决的尽量解决