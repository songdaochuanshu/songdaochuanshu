---
layout: post
title: "Windows ä¸‹å¦‚ä½•è°ƒè¯• PowerShell"
date: "2022-07-16T18:21:43.179Z"
---
Windows ä¸‹å¦‚ä½•è°ƒè¯• PowerShell
========================

èƒŒæ™¯
==

æœ€è¿‘åœ¨ç”¨ PowerShell çš„æ—¶å€™ï¼Œå‘ç°ä¸€äº›åœ°æ–¹ç‰¹åˆ«æœ‰æ„æ€ã€‚äºæ˜¯å°±èŒç”Ÿäº†çœ‹æºä»£ç çš„æƒ³æ³•ï¼Œå•çœ‹è‚¯å®šä¸è¿‡ç˜¾ï¼Œè°ƒè¯•èµ·æ¥æ‰æœ‰æ„æ€ã€‚äºæ˜¯å°±æœ‰äº†è¿™ä¸ªï¼Œè®°å½•ä¸‹ã€‚

è°ƒè¯• PowerShell ä¸»è¦åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼šé€šè¿‡ VS ç›´æ¥ç¼–è¯‘è¿è¡Œæºä»£ç å’Œé€šè¿‡ WinDbg æ¥è°ƒè¯•ã€‚

ç”±äº PowerShell è·¨å¹³å°çš„ç‰¹æ€§ï¼Œç”±äºæˆ‘ç›®å‰åªæœ‰ Windows çš„è¯‰æ±‚ï¼Œæ‰€ä»¥ä»¥ä¸‹å†…å®¹å°†å›´ç»• Windows æ¥è¿›è¡Œã€‚å…¶ä»–å¹³å°å¯ä»¥å‚ç…§å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ï¼š

[PowerShell/docs/building at master Â· PowerShell/PowerShell](https://github.com/PowerShell/PowerShell/tree/master/docs/building)

å‡†å¤‡å·¥ä½œ
====

æ‹‰ä»£ç 
---

ç¬¬ä¸€æ­¥è‡ªç„¶å°±æ˜¯å» github æŠŠä»£ç  clone ä¸‹æ¥äº†ã€‚åœ°å€æ˜¯ï¼š

[https://github.com/PowerShell/PowerShell](https://github.com/PowerShell/PowerShell)

æˆªè‡³åˆ°2022å¹´7æœˆ16æ—¥ï¼Œå»ºè®®ä¸è¦ç›´æ¥ç›´æ¥ç”¨ master åˆ†æ”¯ï¼Œæ ¹æ®æ–‡æ¡£ä»‹ç»ï¼Œmaster åˆ†æ”¯ä¸ºæœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶éç¨³å®šç‰ˆæœ¬ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸çœ‹åˆ°çš„ preview çš„ç‰ˆæœ¬ã€‚è€Œä¸”ï¼Œè¿™é‡Œå¼ºçƒˆå»ºè®®ä¸ç”¨æ˜¯å› ä¸ºç›®å‰ preview çš„ç‰ˆæœ¬å·²ç»åˆ‡æ¢åˆ° .net 7 äº†ï¼Œè€Œ .net 7 çš„ sos æˆ‘æ²¡æ‰¾åˆ°ï¼ˆå¦‚æœçŸ¥é“æ€ä¹ˆæ‰¾åˆ°çš„å°ä¼™ä¼´å¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæ„Ÿè°¢~ï¼‰ã€‚æ‰€ä»¥æˆ‘è¿™é‡Œæ˜¯é‡‡ç”¨æœ€æ–°çš„ç¨³å®šç‰ˆï¼Œä¹Ÿå°±æ˜¯ **7.2.5** ç‰ˆæœ¬çš„æºä»£ç è¿›è¡Œã€‚

å‡†å¤‡ç¯å¢ƒ
----

ç¬¬äºŒæ­¥å°±æ˜¯å‡†å¤‡å¥½ç¼–è¯‘ç¯å¢ƒã€‚å› ä¸º PowerShell å…¨éƒ¨æ˜¯ C# å®ç°çš„ï¼Œè‡ªç„¶å°±æ˜¯ä¾èµ– dotnet ç¯å¢ƒçš„äº†ã€‚

å®˜æ–¹ç»™äº†æˆ‘ä»¬ä¸€ä¸ªéå¸¸å¥½çš„è„šæœ¬ï¼Œéå¸¸ä¾¿åˆ©ï¼Œåœ¨æºä»£ç çš„æ ¹ç›®å½•ä¸‹æ‰§è¡Œï¼š

    Import-Module ./build.psm1
    Start-PSBootstrap
    

æˆ–è€…ç›´æ¥ï¼š

    Install-Dotnet
    

å°±å¯ä»¥å®Œæˆå®‰è£…äº†ã€‚

å¦‚æœåªæ˜¯è¿™æ ·ï¼Œå°±ç»“æŸäº†ï¼Œæ˜¯ä¸æ˜¯è¿‡äºé¡ºåˆ©äº†ï¼Œå°±æ²¡æœ‰è¿™ç¯‡æ–‡ç« çš„å¿…è¦äº†ã€‚

ç”±äºæˆ‘å®‰è£…äº† VS2022 preview çš„ç‰ˆæœ¬ï¼Œå®ƒé¡ºå¸¦å¸®æˆ‘å®‰è£…äº† .net 6.0.400-preview.22330.6 çš„ç‰ˆæœ¬ï¼Œè€Œä¸”è¿˜ä¸è®©å¸è½½ã€‚å› æ­¤æˆ‘æœ€æ–°çš„ç‰ˆæœ¬å§‹ç»ˆæ˜¯ 6.0.400-previewï¼Œåç»­çš„ç¼–è¯‘ï¼Œå®ƒå°±æ­»å‘½å®‰è£…ä¸äº†è¦çš„ç‰ˆæœ¬ã€‚ä¹Ÿå°±æ˜¯ 6.0.203ã€‚

äºæ˜¯å°±åªèƒ½ä» [dot.net](http://dot.net) æ‰‹åŠ¨ä¸‹è½½å®‰è£…äº†ã€‚

æ–¹å¼ä¸€ï¼šé€šè¿‡ WinDbg è°ƒè¯•
----------------

è¿™ç§æ–¹å¼é€‚ç”¨äºä¸æƒ³å®‰è£… VSï¼Œä½†éœ€è¦è¯¦ç»†è°ƒè¯•çš„åŒå­¦ã€‚ï¼ˆä¸è¦é—®æˆ‘ä¸ºå•¥ä¸ç”¨ VSCï¼Œçœ‹ä»£ç  VSC ç¡®å®ä¸é”™ï¼Œä½†è°ƒè¯•ï¼Œè¿˜å¾— WinDbg æ¥ï¼‰

### ç¼–è¯‘ä»£ç 

è¿™é‡Œæˆ‘ä»¬ç›´æ¥é‡‡ç”¨å®˜æ–¹æ¨èçš„æ–¹å¼ï¼š

    Import-Module ./build.psm1
    Start-PSBuild
    

ç„¶åå°±å‡ºç°ä¸‹é¢çš„é”™è¯¯ï¼š

    VERBOSE: In Find-DotNet
    WARNING: The 'dotnet' in the current path can't find SDK version 6.0.203, prepending C:\Users\frend\AppData\Local\Microsoft\dotnet to PATH.
    WARNING: The currently installed .NET Command Line Tools is not the required version.
    
    Installed version: 6.0.400-preview.22330
    Required version: 6.0.203
    
    Fix steps:
    
    1. Remove the installed version from:
        - on windows '$env:LOCALAPPDATA\Microsoft\dotnet'
        - on macOS and linux '$env:HOME/.dotnet'
    2. Run Start-PSBootstrap or Install-Dotnet
    3. Start-PSBuild -Clean
    

å¯æ˜¯æˆ‘æ˜æ˜å®‰è£…äº†çš„å‘€ï¼š

    - dotnet --list-sdks
    6.0.203 [C:\Program Files\dotnet\sdk]
    6.0.302 [C:\Program Files\dotnet\sdk]
    6.0.400-preview.22330.6 [C:\Program Files\dotnet\sdk]
    

äºæ˜¯ï¼Œå°±å»æ‰¾äº†ä¸‹å¯¹åº”çš„è„šæœ¬ã€‚åœ¨ \[ps code root\]/build.psm1 æ–‡ä»¶ä¸­çš„ Start-PSBuild â†’ Find-Dotnet â†’ Get-LatestInstalledSDK

    function Get-LatestInstalledSDK {
        Start-NativeExecution -sb {
            dotnet --list-sdks | Select-String -Pattern '\d*.\d*.\d*(-\w*\.\d*)?' | ForEach-Object { [System.Management.Automation.SemanticVersion]::new($_.matches.value) } | Sort-Object -Descending | Select-Object -First 1
        } -IgnoreExitcode 2> $null
    }
    

å¥½å®¶ä¼™ï¼Œç›´æ¥å°±æ˜¯æ‹¿æœ€æ–°çš„ä½œä¸ºæˆ‘å®‰è£…çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥å¯¼è‡´åŒ¹é…ä¸ä¸Šï¼Œæ— æ³•å¼€å§‹ç¼–è¯‘ã€‚ç”±äºæˆ‘è¿™é‡Œå®‰è£…äº† 6.0.203 çš„ï¼Œæ‰€ä»¥æˆ‘å°±ä¿®æ”¹äº†ä¸‹ã€‚æ ¹æ®æˆ‘çš„å®‰è£…æƒ…å†µï¼Œæ”¹æˆè®©ä»–è¿”å›æˆ‘æƒ³è¦è®©ä»–è¿”å›çš„ç‰ˆæœ¬äº†ï¼ˆå¦‚ä¸‹åŠ ç²—ç‰ˆæœ¬ï¼‰ã€‚**è¿™é‡Œéœ€è¦æ ¹æ®è‡ªå·±å®é™…æƒ…å†µä¿®æ”¹ï¼ï¼ï¼**

    dotnet --list-sdks | Select-String -Pattern '\d*.\d*.\d*(-\w*\.\d*)?' | ForEach-Object { [System.Management.Automation.SemanticVersion]::new($_.matches.value) } | Sort-Object -Descending | Select-Object -First **3 | Sort-Object | Select-Object -First 1**
    

äºæ˜¯æˆ‘ä»¬é‡æ¥ä¸€éå¯¼å…¥ï¼Œç¼–è¯‘ã€‚å°±èƒ½æˆåŠŸå•¦ï¼

ç„¶åå°±èƒ½æ‰¾åˆ°å•¦ ./src/powershell-win-core/bin/Debug/net6.0/win7-x64/publish/pwsh.exe

### è°ƒè¯•ä»£ç 

æ‰“å¼€ WinDbg preview â†’ Launch executable(advanced)

Executable ä¸­å¡«å…¥ä¸Šä¸€æ­¥ç¼–è¯‘å‡ºæ¥çš„åœ°å€ï¼Œæˆ‘çš„æ˜¯è¿™æ ·çš„ï¼šC:\\Users\\frend\\source\\repos\\dotnet\\PowerShell\\src\\powershell-win-core\\bin\\Debug\\net6.0\\win7-x64\\pwsh.exe

Argumentsï¼Œå¡«å…¥ä½ æƒ³è°ƒè¯•çš„å‘½ä»¤å°±å¥½å•¦ã€‚æˆ‘çš„æ˜¯ï¼šex bypass -nop -Command Invoke-webRequest [www.baidu.com](http://www.baidu.com/)

å…¶ä»–å°±å¯ä»¥ä¸ç®¡äº†ã€‚æ¥ï¼Œå¼€å§‹è°ƒè¯•~

ğŸ’¡ è¿™é‡Œå†åºŸè¯ä¸‹ï¼ŒWinDbg éœ€è¦æå‰è®¾ç½®å¥½ Default source path å’Œ Default symbols path ã€‚

ç”±äºæˆ‘ä»¬è¦è°ƒè¯•çš„æ˜¯æ‰˜ç®¡ä»£ç ï¼Œåœ¨å¯åŠ¨ç‚¹æˆ‘ä»¬æ²¡åŠæ³•æ‰“æ–­ç‚¹ï¼Œå¾—å…ˆç­‰ sos å’Œ clr åŠ è½½å¥½äº†ä¹‹åæ‰è¡Œã€‚

è¿™é‡Œæˆ‘å…ˆæ‰“äº†ä¸€ä¸ªclrä¸Šçš„æ–­ç‚¹ï¼š

    bp coreclr!CallDescrWorkerInternal
    

å¾…æ–­ç‚¹æ–­åˆ°äº†ï¼Œå†åŠ ä¸Š PowerShell å¯åŠ¨ä»£ç çš„æ–­ç‚¹ã€‚æ³¨æ„ï¼Œæ‰˜ç®¡ä»£ç éœ€è¦ç”¨ sos çš„ !bpmd æ¥æ‰“æ–­ç‚¹ï¼š

    0:000> !bpmd pwsh Microsoft.PowerShell.ManagedPSEntry.Main
    Adding pending breakpoints...
    0:000> bd 0
    0:000> g
    ModLoad: 00007ff8`d7460000 00007ff8`d7478000   C:\WINDOWS\SYSTEM32\kernel.appcore.dll
    ModLoad: 00000288`fa860000 00000288`fa884000   C:\Users\frend\source\repos\dotnet\PowerShell\src\powershell-win-core\bin\Debug\net6.0\win7-x64\pwsh.dll
    ModLoad: 00000288`fa860000 00000288`fa884000   C:\Users\frend\source\repos\dotnet\PowerShell\src\powershell-win-core\bin\Debug\net6.0\win7-x64\pwsh.dll
    (45e4.6834): CLR notification exception - code e0444143 (first chance)
    ModLoad: 00000288`fa8a0000 00000288`fa8ae000   C:\Users\frend\source\repos\dotnet\PowerShell\src\powershell-win-core\bin\Debug\net6.0\win7-x64\System.Runtime.dll
    (45e4.6834): CLR notification exception - code e0444143 (first chance)
    ModLoad: 00000288`fa8b0000 00000288`fa90e000   C:\Users\frend\source\repos\dotnet\PowerShell\src\powershell-win-core\bin\Debug\net6.0\win7-x64\Microsoft.PowerShell.ConsoleHost.dll
    (45e4.6834): CLR notification exception - code e0444143 (first chance)
    (45e4.6834): CLR notification exception - code e0444143 (first chance)
    JITTED pwsh!Microsoft.PowerShell.ManagedPSEntry.Main(System.String[])
    Setting breakpoint: bp 00007FF7E6F82530 [Microsoft.PowerShell.ManagedPSEntry.Main(System.String[])]
    Breakpoint 1 hit
    *** WARNING: Unable to verify checksum for C:\Users\frend\source\repos\dotnet\PowerShell\src\powershell-win-core\bin\Debug\net6.0\win7-x64\pwsh.dll
    pwsh!Microsoft.PowerShell.ManagedPSEntry.Main:
    00007ff7`e6f82530 55              push    rbp
    

ç„¶åï¼Œå°±å¯ä»¥å‘½ä¸­æ–­ç‚¹äº†ã€‚

è¿™é‡Œå¯èƒ½ä¸ä¼šè‡ªåŠ¨æ‰“å¼€å¹¶ä¸”è·³è½¬åˆ°æºä»£ç ä¸­ï¼Œå† t å‡ ä¸‹ï¼Œå°±ä¼šè‡ªåŠ¨æ‰“å¼€çš„ã€‚æœ€ç»ˆå°±ä¼šå˜æˆè¿™æ ·ã€‚

![](https://img2022.cnblogs.com/blog/917989/202207/917989-20220717000610927-2017557081.png)

äºæ˜¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹é¡ºåˆ©çš„è°ƒè¯•äº†ã€‚

æ–¹å¼äºŒï¼šé€šè¿‡ VS è°ƒè¯•
------------

è¿™ç§æ–¹å¼ç›¸å¯¹å°±æ¯”è¾ƒç®€å•äº†ï¼Œè¿™é‡Œç”¨ VS2022 æ¥åšæ¼”ç¤ºã€‚

è®°å¾—ä¸€å®šè¦å®‰è£…å¯¹åº”çš„ dotnet sdkã€‚å…·ä½“çš„ç‰ˆæœ¬å¯ä»¥åœ¨æºä»£ç æ ¹ç›®å½•çš„ global.json ä¸­æŸ¥çœ‹ã€‚

ç›´æ¥åœ¨æºä»£ç ä¸­æ‰“å¼€ PowerShell.sln æ–‡ä»¶å³å¯æ‰“å¼€ PowerShell é¡¹ç›®ã€‚ç„¶å build ä¸€ä¸‹ï¼Œè®°å¾—ï¼ŒWindows ä¸‹å¯åŠ¨ç›®å½•åº”è¯¥æ˜¯ï¼špowershell-win-core

ç„¶åå°±å¯ä»¥é…ç½®è°ƒè¯•çš„å‚æ•°äº†ï¼š

åœ¨é¡¹ç›® powershell-win-core ä¸Šé¼ æ ‡å³å‡»ï¼Œé€‰æ‹©å±æ€§ â†’ è°ƒè¯• â†’ Open debug launch profiles UI

ç„¶åå°±æ˜¯è·Ÿ WinDbg è°ƒè¯•ç±»ä¼¼çš„å‚æ•°äº†ã€‚å¦‚ä¸‹å›¾ï¼š

![](https://img2022.cnblogs.com/blog/917989/202207/917989-20220717000632505-174899592.png)

ç„¶åï¼Œå†ä½ æƒ³è§‚å¯Ÿçš„ä»£ç å¤„æ‰“ä¸Šæ–­ç‚¹ï¼Œç‚¹å‡»è¿è¡Œå°±å¥½å•¦ã€‚

æ€»ç»“
==

å…¶å®å®˜æ–¹æ–‡æ¡£å·²ç»æ¯”è¾ƒå®Œå–„äº†ã€‚åŸºæœ¬éƒ½æ¯”è¾ƒç®€å•ã€‚ç‰¹åˆ«æ˜¯é€šè¿‡ VSï¼Œç®€ç›´æ–¹ä¾¿çš„ä¸è¦ä¸è¦çš„ã€‚

å¯¹äºåŸºäº dotnet çš„ PowerShellï¼Œè‚¯å®šè¿˜ä¼šé‡åˆ° dotnet ä¸Šçš„é—®é¢˜ï¼Œé‚£æ€ä¹ˆè°ƒè¯• dotnet å‘¢ï¼Ÿ

çœ‹è¿™é‡Œï¼š

[https://github.com/dotnet/runtime](https://github.com/dotnet/runtime)

æ¯å¤©ç¼–ç¨‹ä¸¤å°æ—¶ï¼Œä¸æƒ³å˜å¤§ç‰›éƒ½éš¾ï¼