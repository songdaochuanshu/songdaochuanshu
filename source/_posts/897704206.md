---
layout: post
title: "ä½¿ç”¨ Transformers è¿›è¡Œå›¾åˆ†ç±»"
date: "2023-04-19T01:07:56.175Z"
---
ä½¿ç”¨ Transformers è¿›è¡Œå›¾åˆ†ç±»
=====================

åœ¨ä¹‹å‰çš„ [åšæ–‡](https://huggingface.co/blog/intro-graphml) ä¸­ï¼Œæˆ‘ä»¬æŽ¢è®¨äº†å›¾æœºå™¨å­¦ä¹ çš„ä¸€äº›ç†è®ºçŸ¥è¯†ã€‚è¿™ä¸€ç¯‡æˆ‘ä»¬å°†æŽ¢ç´¢å¦‚ä½•ä½¿ç”¨ Transformers åº“è¿›è¡Œå›¾åˆ†ç±»ã€‚(ä½ ä¹Ÿå¯ä»¥ä»Ž [æ­¤å¤„](https://github.com/huggingface/blog/blob/main/notebooks/graphml-classification.ipynb) ä¸‹è½½æ¼”ç¤º notebookï¼Œè·Ÿç€ä¸€èµ·åšï¼)

ç›®å‰ï¼ŒTransformers ä¸­å”¯ä¸€å¯ç”¨çš„å›¾ transformer æ¨¡åž‹æ˜¯å¾®è½¯çš„ [Graphormer](https://arxiv.org/abs/2106.05234)ï¼Œå› æ­¤æœ¬æ–‡çš„ä¾‹å­å°†ä¼šåŸºäºŽè¯¥æ¨¡åž‹ã€‚æˆ‘ä»¬æœŸå¾…çœ‹åˆ°å¤§å®¶ä¼šä½¿ç”¨å¹¶é›†æˆå“ªäº›å…¶ä»–æ¨¡åž‹è¿› ðŸ¤—ã€‚

è½¯ä»¶
--

è¦å­¦ä¹ æœ¬æ•™ç¨‹ï¼Œéœ€è¦å®‰è£… `datasets` å’Œ `transformers` (ç‰ˆæœ¬å· >= 4.27.2)ï¼Œä½ å¯ä»¥ä½¿ç”¨ `pip install -U datasets transformers` æ¥å®‰è£…ã€‚

æ•°æ®
--

ä½ å¯ä»¥ä½¿ç”¨è‡ªå·±çš„å›¾æ•°æ®é›†ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ [Hub ä¸Šå·²æœ‰çš„æ•°æ®é›†](https://huggingface.co/datasets?task_categories=task_categories:graph-ml&sort=downloads)ã€‚æœ¬æ–‡æˆ‘ä»¬ä¸»è¦ä½¿ç”¨å·²æœ‰çš„æ•°æ®é›†ï¼Œä½ ä¹Ÿå¯ä»¥éšæ—¶ [æ·»åŠ ä½ çš„æ•°æ®é›†](https://huggingface.co/docs/datasets/upload_dataset) åˆ° Hugging Faceï¼

### æ•°æ®åŠ è½½

ä»Ž Hub åŠ è½½å›¾æ•°æ®é›†éžå¸¸ç®€å•ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åŠ è½½ OGB åº“ä¸­çš„ `ogbg-mohiv` æ•°æ®é›† (è¯¥æ•°æ®é›†æ˜¯æ–¯å¦ç¦ [å¼€æ”¾å›¾åŸºå‡† (Open Graph Benchmarkï¼ŒOGB)](https://ogb.stanford.edu/) çš„ä¸€éƒ¨åˆ†):

    from datasets import load_dataset
    
    # There is only one split on the hub
    dataset = load_dataset("OGB/ogbg-molhiv")
    
    dataset = dataset.shuffle(seed=0)
    

è¿™ä¸ªæ•°æ®é›†å«ä¸‰ä¸ªæ‹†åˆ†ï¼Œ`train` ã€`validation` å’Œ `test`ï¼Œæ‰€æœ‰è¿™äº›æ‹†åˆ†æ¯ä¸€è¡Œéƒ½è¡¨ç¤ºä¸€ä¸ªå›¾ï¼Œæ¯ä¸ªå›¾åŒ…å« 5 ä¸ªæ•°æ®åˆ— (`edge_index`ã€`edge_attr`ã€`y`ã€`num_nodes`ã€`node_feat`)ï¼Œä½ å¯ä»¥é€šè¿‡æ‰§è¡Œ `print(dataset)` æ¥æŸ¥çœ‹ã€‚

å¦‚æžœä½ è¿˜å®‰è£…äº†å…¶ä»–å›¾å¤„ç†åº“ï¼Œä½ è¿˜å¯ä»¥ç”¨è¿™äº›åº“æŠŠå›¾å¯è§†åŒ–å‡ºæ¥ï¼Œå¹¶è¿›ä¸€æ­¥æ£€æŸ¥æ•°æ®é›†ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ PyGeometric å’Œ matplotlib:

    import networkx as nx
    import matplotlib.pyplot as plt
    
    # We want to plot the first train graph
    graph = dataset["train"][0]
    
    edges = graph["edge_index"]
    num_edges = len(edges[0])
    num_nodes = graph["num_nodes"]
    
    # Conversion to networkx format
    G = nx.Graph()
    G.add_nodes_from(range(num_nodes))
    G.add_edges_from([(edges[0][i], edges[1][i]) for i in range(num_edges)])
    
    # Plot
    nx.draw(G)
    

### æ ¼å¼

åœ¨ Hub ä¸Šï¼Œå›¾æ•°æ®é›†ä¸»è¦å­˜å‚¨ä¸ºå›¾åˆ—è¡¨å½¢å¼ (ä½¿ç”¨ `jsonl` æ ¼å¼)ã€‚

å•ä¸ªå›¾è¡¨ç¤ºä¸ºä¸€ä¸ªå­—å…¸ï¼Œä»¥ä¸‹æ˜¯æˆ‘ä»¬å›¾åˆ†ç±»æ•°æ®é›†çš„ç†æƒ³æ ¼å¼:

*   `edge_index` åŒ…å«å›¾ä¸Šæ¯æ¡è¾¹å¯¹åº”çš„èŠ‚ç‚¹ IDï¼Œå­˜å‚¨ä¸ºåŒ…å«ä¸¤ä¸ª`èŠ‚ç‚¹åˆ—è¡¨`çš„åˆ—è¡¨ (å³ç”±ä¸€ä¸ªæºèŠ‚ç‚¹åˆ—è¡¨å’Œä¸€ä¸ªç›®çš„èŠ‚ç‚¹åˆ—è¡¨ç»„æˆçš„åˆ—è¡¨)ã€‚
    
    *   **ç±»åž‹**: 2 ä¸ªæ•´æ•°åˆ—è¡¨çš„åˆ—è¡¨ã€‚
    *   **ç¤ºä¾‹**: åŒ…å«å››ä¸ªèŠ‚ç‚¹ (0ã€1ã€2 å’Œ 3) ä¸”è¿žæŽ¥ä¸º 1->2ã€1->3 å’Œ 3->1 çš„å›¾å°†å…·æœ‰ `edge_index = [[1, 1, 3]ã€[2ã€3ã€1]]`ã€‚ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°æ­¤å¤„ä¸å­˜åœ¨èŠ‚ç‚¹ 0ï¼Œå› ä¸ºåœ¨æœ¬æ•°æ®ä¸­å®ƒä¸Žå…¶ä»–èŠ‚ç‚¹æ— è¾¹è¿žæŽ¥ã€‚è¿™å°±æ˜¯ä¸‹ä¸€ä¸ªå±žæ€§å¾ˆé‡è¦çš„åŽŸå› ã€‚
*   `num_nodes` è¡¨ç¤ºå›¾ä¸­å¯ç”¨èŠ‚ç‚¹çš„æ•°ç›® (é»˜è®¤æƒ…å†µä¸‹ï¼Œå‡å®šèŠ‚ç‚¹æŒ‰é¡ºåºç¼–å·)ã€‚
    
    *   **ç±»åž‹**: æ•´æ•°
    *   **ç¤ºä¾‹**: åœ¨ä¸Šä¾‹ä¸­ï¼Œ`num_nodes = 4`ã€‚
*   `y` æ¯ä¸ªå›¾çš„é¢„æµ‹æ ‡ç­¾ (å¯ä»¥æ˜¯ç±»ã€å±žæ€§å€¼æˆ–æ˜¯ä¸åŒä»»åŠ¡çš„å¤šä¸ªäºŒåˆ†ç±»æ ‡ç­¾)ã€‚
    
    *   **Type**: æ•´æ•°åˆ—è¡¨ (ç”¨äºŽå¤šåˆ†ç±») ã€æµ®ç‚¹æ•° (ç”¨äºŽå›žå½’) æˆ– 0/1 åˆ—è¡¨ (ç”¨äºŽäºŒå…ƒå¤šä»»åŠ¡åˆ†ç±»)
    *   **ç¤ºä¾‹**: æˆ‘ä»¬å¯ä»¥é¢„æµ‹å›¾è§„æ¨¡ (å° = 0ï¼Œä¸­ = 1ï¼Œå¤§ = 2)ã€‚æœ¬ä¾‹ä¸­ï¼Œ`y = [0]`ã€‚
*   `node_feat` åŒ…å«å›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å¯ç”¨ç‰¹å¾ (å¦‚æžœå­˜åœ¨)ï¼ŒæŒ‰èŠ‚ç‚¹ ID æŽ’åºã€‚
    
    *   **ç±»åž‹**: æ•´æ•°åˆ—è¡¨çš„åˆ—è¡¨ (å¯é€‰)
    *   **ä¾‹å­**: å¦‚ä¸Šä¾‹ä¸­çš„èŠ‚ç‚¹å¯ä»¥æœ‰ä¸€äº›ç±»åž‹ç‰¹å¾ (å°±åƒåˆ†å­å›¾ä¸­çš„èŠ‚ç‚¹æ˜¯ä¸åŒçš„åŽŸå­ï¼Œä¸åŒçš„åŽŸå­æœ‰ä¸åŒçš„ç±»åž‹ä¸€æ ·)ã€‚æ‰“æ¯”æ–¹ï¼Œæœ¬ä¾‹ä¸­ `node_feat = [[1], [0], [1], [1]]`ã€‚
*   `edge_attr` åŒ…å«å›¾ä¸­æ¯æ¡è¾¹çš„å¯ç”¨å±žæ€§ (å¦‚æžœå­˜åœ¨)ï¼ŒæŒ‰ `edge_index` æŽ’åºã€‚
    
    *   **ç±»åž‹**: æ•´æ•°åˆ—è¡¨çš„åˆ—è¡¨ (å¯é€‰)
    *   **ä¾‹å­**: ä»ä½¿ç”¨ä¸Šä¾‹ï¼Œè¾¹ä¹Ÿå¯ä»¥æœ‰ç±»åž‹ (å¦‚åˆ†å­ä¸­çš„é”®)ï¼Œå¦‚ edge\_attr = \[\[0\], \[1\], \[1\]\]\`ã€‚

### é¢„å¤„ç†

å›¾ transformer æ¡†æž¶é€šå¸¸éœ€è¦æ ¹æ®æ•°æ®é›†è¿›è¡Œç‰¹å®šçš„é¢„å¤„ç†ï¼Œä»¥ç”Ÿæˆæœ‰åŠ©äºŽç›®æ ‡å­¦ä¹ ä»»åŠ¡ (åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ä¸ºåˆ†ç±») çš„ç‰¹å¾å’Œå±žæ€§ã€‚  
åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ `Graphormer` çš„é»˜è®¤é¢„å¤„ç†ï¼Œå®ƒç”Ÿæˆè¿›åº¦/å‡ºåº¦ä¿¡æ¯ã€èŠ‚ç‚¹é—´çš„æœ€çŸ­è·¯å¾„ä»¥åŠæ¨¡åž‹æ„Ÿå…´è¶£çš„å…¶ä»–å±žæ€§ã€‚

    from transformers.models.graphormer.collating_graphormer import preprocess_item, GraphormerDataCollator
    
    dataset_processed = dataset.map(preprocess_item, batched=False)
    

æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ `DataCollator` çš„å‚æ•°ä¸­åŠ¨æ€è¿›è¡Œé¢„å¤„ç† (é€šè¿‡å°† `on_the_fly_processing` è®¾ç½®ä¸º True)ã€‚ä½†å¹¶éžæ‰€æœ‰æ•°æ®é›†éƒ½åƒ `ogbg-molhiv` é‚£æ ·å°ï¼Œå¯¹äºŽå¤§å›¾ï¼ŒåŠ¨æ€é¢„å¤„ç†æˆæœ¬å¤ªé«˜ï¼Œå› æ­¤éœ€è¦é¢„å…ˆè¿›è¡Œé¢„å¤„ç†ï¼Œå¹¶å­˜å‚¨é¢„å¤„ç†åŽçš„æ•°æ®ä¾›åŽç»­è®­ç»ƒå®žéªŒä½¿ç”¨ã€‚

æ¨¡åž‹
--

### æ¨¡åž‹åŠ è½½

è¿™é‡Œï¼Œæˆ‘ä»¬åŠ è½½ä¸€ä¸ªå·²æœ‰çš„é¢„è®­ç»ƒæ¨¡åž‹åŠå…¶ checkpoint å¹¶åœ¨æˆ‘ä»¬çš„ä¸‹æ¸¸ä»»åŠ¡ä¸Šå¯¹å…¶è¿›è¡Œå¾®è°ƒï¼Œè¯¥ä»»åŠ¡æ˜¯ä¸€ä¸ªäºŒåˆ†ç±»ä»»åŠ¡ (å› æ­¤ `num_classes = 2`)ã€‚æˆ‘ä»¬è¿˜å¯ä»¥åœ¨å›žå½’ä»»åŠ¡ (`num_classes = 1`) æˆ–å¤šä»»åŠ¡åˆ†ç±»ä¸Šå¾®è°ƒæˆ‘ä»¬çš„æ¨¡åž‹ã€‚

    from transformers import GraphormerForGraphClassification
    
    model = GraphormerForGraphClassification.from_pretrained(
        "clefourrier/pcqm4mv2_graphormer_base",
        num_classes=2, # num_classes for the downstream task
        ignore_mismatched_sizes=True,
    )
    

æˆ‘ä»¬æ¥çœ‹ä¸‹ç»†èŠ‚ã€‚

åœ¨ä»£ç ä¸­è°ƒç”¨ `from_pretrained` æ–¹æ³•æ¥ä¸‹è½½å¹¶ç¼“å­˜æ¨¡åž‹æƒé‡ã€‚ç”±äºŽç±»çš„æ•°é‡ (ç”¨äºŽé¢„æµ‹) å–å†³äºŽæ•°æ®é›†ï¼Œæˆ‘ä»¬å°†æ–°çš„ `num_classes` å’Œ `ignore_mismatched_sizes` ä¸Ž `model_checkpoint` ä¸€èµ·ä¼ ç»™è¯¥å‡½æ•°ã€‚è¿™ä¼šè§¦å‘å‡½æ•°åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ã€ç‰¹å®šäºŽè¯¥ä¸‹æ¸¸ä»»åŠ¡çš„åˆ†ç±»å¤´ï¼Œè¿™ä¸ªå¤´ä¸ŽåŽŸæ¨¡åž‹ä¸­çš„è§£ç å™¨å¤´å¾ˆå¯èƒ½æ˜¯ä¸åŒçš„ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„éšæœºåˆå§‹åŒ–çš„æ¨¡åž‹æ¥ä»Žå¤´å¼€å§‹è®­ç»ƒï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥å¤ç”¨ç»™å®šæ£€æŸ¥ç‚¹çš„è¶…å‚é…ç½®ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨é€‰æ‹©è¶…å‚é…ç½®ã€‚

### è®­ç»ƒæˆ–å¾®è°ƒ

ä¸ºäº†ç®€åŒ–æ¨¡åž‹è®­ç»ƒï¼Œæˆ‘ä»¬ä½¿ç”¨ `Trainer`ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰è®­ç»ƒç›¸å…³çš„é…ç½®ä»¥åŠè¯„ä¼°æŒ‡æ ‡æ¥å®žä¾‹åŒ– `Trainer`ã€‚æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ `TrainingArguments`ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªåŒ…å«æ‰€æœ‰é…ç½®é¡¹çš„ç±»ï¼Œç”¨äºŽå®šåˆ¶è®­ç»ƒé…ç½®ã€‚æˆ‘ä»¬è¦ç»™å®ƒä¸€ä¸ªæ–‡ä»¶å¤¹åç§°ï¼Œç”¨äºŽä¿å­˜æ¨¡åž‹çš„ checkpointã€‚

    from transformers import TrainingArguments, Trainer
    
    training_args = TrainingArguments(
        "graph-classification",
        logging_dir="graph-classification",
        per_device_train_batch_size=64,
        per_device_eval_batch_size=64,
        auto_find_batch_size=True, # batch size can be changed automatically to prevent OOMs
        gradient_accumulation_steps=10,
        dataloader_num_workers=4, #1,
        num_train_epochs=20,
        evaluation_strategy="epoch",
        logging_strategy="epoch",
        push_to_hub=False,
    )
    

å¯¹äºŽå›¾æ•°æ®é›†ï¼Œè°ƒæ•´ batch size å’Œæ¢¯åº¦ç´¯ç§¯æ­¥æ•°æ¥ä¿è¯æœ‰æ•ˆ batch size å¤Ÿå¤§åŒæ—¶åˆè¦é¿å…å†…å­˜ä¸è¶³ï¼Œè¿™ä»¶äº‹å°¤ä¸ºé‡è¦ã€‚

æœ€åŽä¸€ä¸ªå‚æ•° `push_to_hub` å…è®¸ `Trainer` åœ¨è®­ç»ƒæœŸé—´å®šæœŸå°†æ¨¡åž‹æŽ¨é€åˆ° Hubï¼Œè¿™ä¸ªé€šå¸¸ç”±ä¿å­˜æ­¥é•¿æ¥å†³å®šã€‚

    trainer = Trainer(
        model=model,
        args=training_args,
        train_dataset=dataset_processed["train"],
        eval_dataset=dataset_processed["validation"],
        data_collator=GraphormerDataCollator(),
    )
    
    

åœ¨ç”¨äºŽå›¾åˆ†ç±»çš„ `Trainer` ä¸­ï¼Œå¯¹ç»™å®šçš„å›¾æ•°æ®é›†ä½¿ç”¨æ­£ç¡®çš„æ•°æ®æ•´ç†å™¨ (data collator) å¾ˆé‡è¦ï¼Œè¿™ä¸ªæ•°æ®æ•´ç†å™¨ä¼šå°†å›¾è½¬æ¢ä¸ºç”¨äºŽè®­ç»ƒçš„ batch æ•°æ®ã€‚

    train_results = trainer.train()
    trainer.push_to_hub()
    

è®­ç»ƒå®ŒåŽï¼Œå¯ä»¥ä½¿ç”¨ `push_to_hub` å°†æ¨¡åž‹ä¸Žæ‰€æœ‰å…¶ä»–è®­ç»ƒç›¸å…³ä¿¡æ¯ä¸€èµ·ä¿å­˜åˆ° hubã€‚

ç”±äºŽæ­¤æ¨¡åž‹æ¯”è¾ƒå¤§ï¼Œå› æ­¤åœ¨ CPU (Intel Core i7) ä¸Šè®­ç»ƒ/å¾®è°ƒ 20 ä¸ª epoch å¤§çº¦éœ€è¦ä¸€å¤©æ—¶é—´ã€‚æƒ³è¦æ›´å¿«ç‚¹çš„è¯ï¼Œä½ å¯ä»¥ä½¿ç”¨å¼ºå¤§çš„ GPU å’Œå¹¶è¡ŒåŒ–æ–¹æ³•ï¼Œä½ åªéœ€åœ¨ Colab notebook ä¸­æˆ–ç›´æŽ¥åœ¨ä½ é€‰æ‹©çš„å…¶ä»–é›†ç¾¤ä¸Šå¯åŠ¨ä»£ç å³å¯ã€‚

ç»“æŸè¯­
---

çŽ°åœ¨ä½ å·²ç»çŸ¥é“å¦‚ä½•ä½¿ç”¨ `transformers` æ¥è®­ç»ƒå›¾åˆ†ç±»æ¨¡åž‹ï¼Œæˆ‘ä»¬å¸Œæœ›ä½ å°è¯•åœ¨ Hub ä¸Šåˆ†äº«ä½ æœ€å–œæ¬¢çš„å›¾ transformer æ¨¡åž‹çš„ checkpointsã€æ¨¡åž‹ä»¥åŠæ•°æ®é›†ï¼Œä»¥ä¾›ç¤¾åŒºçš„å…¶ä»–äººä½¿ç”¨ï¼

* * *

> è‹±æ–‡åŽŸæ–‡: [https://hf.co/blog/graphml-classification](https://hf.co/blog/graphml-classification)
> 
> ä½œè€…: ClÃ©m  
> è¯‘è€…: Matrix Yao (å§šä¼Ÿå³°)ï¼Œè‹±ç‰¹å°”æ·±åº¦å­¦ä¹ å·¥ç¨‹å¸ˆï¼Œå·¥ä½œæ–¹å‘ä¸º transformer-family æ¨¡åž‹åœ¨å„æ¨¡æ€æ•°æ®ä¸Šçš„åº”ç”¨åŠå¤§è§„æ¨¡æ¨¡åž‹çš„è®­ç»ƒæŽ¨ç†ã€‚
> 
> æŽ’ç‰ˆ/å®¡æ ¡: zhongdongy (é˜¿ä¸œ)