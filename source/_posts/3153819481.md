---
layout: post
title: "è®°ä¸€æ¬¡ .NET æŸä¼ä¸š ERPç½‘ç«™ç³»ç»Ÿ å´©æºƒåˆ†æ"
date: "2023-03-27T01:07:14.952Z"
---
è®°ä¸€æ¬¡ .NET æŸä¼ä¸š ERPç½‘ç«™ç³»ç»Ÿ å´©æºƒåˆ†æ
=========================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰æ®µæ—¶é—´æ”¶åˆ°äº†ä¸€ä¸ªæœ‹å‹çš„æ±‚åŠ©ï¼Œè¯´ä»–çš„ERPç½‘ç«™ç³»ç»Ÿä¼šå‡ºç°å¶å‘æ€§å´©æºƒï¼Œæ‰¾äº†å¥½ä¹…ä¹Ÿæ²¡æ‰¾åˆ°æ˜¯ä»€ä¹ˆåŸå› ï¼Œè®©æˆ‘å¸®å¿™çœ‹ä¸‹ï¼Œå…¶å®å´©æºƒå¥½è¯´ï¼Œç”¨ procdump è‡ªåŠ¨æŠ“ä¸€ä¸ªå°±å¥½ï¼Œæ‹¿åˆ° dump ä¹‹åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä¸€é¡¿åˆ†æäº†ã€‚

äºŒï¼šWinDbg åˆ†æ
-----------

### 1\. æ˜¯ä»€ä¹ˆå¯¼è‡´çš„å´©æºƒ

windbg æœ‰ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„åˆ†æå‘½ä»¤ `!analyze -v` å¯ä»¥å¸®æˆ‘ä»¬æå‰é¢„è¯Šä¸€ä¸‹ï¼Œå°±å¥½åƒè¿›åŒ»é™¢å…ˆåœ¨é—®è¯¢å°é‚£é‡Œè¿‡ä¸€ä¸‹ã€‚

    
    0:019> !analyze -v
    CONTEXT:  (.ecxr)
    eax=14c9cd00 ebx=00000000 ecx=00000000 edx=00000000 esi=00000000 edi=14c9d664
    eip=682a024a esp=14c9cfd4 ebp=14c9d018 iopl=0         nv up ei pl nz ac po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000212
    msvcr90!fprintf+0x34:
    682a024a 83c414          add     esp,14h
    Resetting default scope
    
    EXCEPTION_RECORD:  (.exr -1)
    ExceptionAddress: 682a024a (msvcr90!fprintf+0x00000034)
       ExceptionCode: c0000417
      ExceptionFlags: 00000001
    NumberParameters: 0
    
    PROCESS_NAME:  w3wp.exe
    
    ERROR_CODE: (NTSTATUS) 0xc0000417 -    C
    
    EXCEPTION_CODE_STR:  c0000417
    
    STACK_TEXT:  
    14c9d018 1766013b     00000000 176d9c60 17def1a8 msvcr90!fprintf+0x34
    WARNING: Stack unwind information not available. Following frames may be wrong.
    14c9d664 454c5153     75636578 203a6574 5332347b satrda!Writer_Write+0x4bb
    000000c8 75636578     203a6574 5332347b 207d3230 0x454c5153
    000000c8 17673623     17d538e8 17ded730 00000001 crypt32!profapi_NULL_THUNK_DATA_DLA <PERF> (crypt32+0x126578)
    00000009 176604b6     14c9d74c 17ded730 17dae9c8 satrda!SATRDA_Proto_UnitTest+0x6c93
    ffffffff 17654012     17dae9c8 17d538e8 17ded730 satrda!Writer_Write+0x836
    17dae9c8 665fe072     14c9d74c 00000001 1765405b satrda!ConfigDSN+0xd0c2
    ...
    160a0000 00000000     00000000 00000000 00000000 0x7071e31
    
    FAULTING_SOURCE_LINE:  f:\dd\vctools\crt_bld\self_x86\crt\src\fprintf.c
    
    FAULTING_SOURCE_FILE:  f:\dd\vctools\crt_bld\self_x86\crt\src\fprintf.c
    
    FAULTING_SOURCE_LINE_NUMBER:  55
    
    FAULTING_SOURCE_CODE:  
    No source found for 'f:\dd\vctools\crt_bld\self_x86\crt\src\fprintf.c'
    
    
    SYMBOL_NAME:  msvcr90!fprintf+34
    
    MODULE_NAME: msvcr90
    
    IMAGE_NAME:  msvcr90.dll
    
    STACK_COMMAND:  ~19s; .ecxr ; kb
    
    FAILURE_BUCKET_ID:  INVALID_CRUNTIME_PARAMETER_c0000417_msvcr90.dll!fprintf
    
    

ä»é”™è¯¯ä¿¡æ¯çœ‹ï¼Œé—®é¢˜æ˜¯å‡ºåœ¨ `satrda.dll` è¿™ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œèµ¶ç´§ç½‘ä¸Šæœä¸€ä¸‹æ˜¯è¿™æ˜¯ä½•æ–¹ç¥åœ£ã€‚

![](https://img2023.cnblogs.com/blog/214741/202303/214741-20230327090029024-733658152.png)

çœ‹æ ·å­æ˜¯ä¸€ä¸ªè¿æ¥æ•°æ®åº“çš„å•†ä¸šç»„ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹ `FAILURE_BUCKET_ID: INVALID_CRUNTIME_PARAMETER_c0000417_msvcr90.dll!fprintf` ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°å› ä¸ºåœ¨è°ƒç”¨ `fprintf` å‡½æ•°æ—¶å‡ºç°äº†å‚æ•°é”™è¯¯ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°†åŒ…å›´åœˆæå¤§çš„æ”¶ç¼©äº†ã€‚

### 2\. ä¸ºä»€ä¹ˆä¼šå‡ºç°å‚æ•°é”™è¯¯

ç†Ÿæ‚‰ C è¯­è¨€ `fprintf` å‡½æ•°çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œå®ƒæ˜¯ç”¨æ¥å‘ `æ–‡ä»¶` å†™å…¥æ•°æ®çš„ï¼Œç±»ä¼¼ C# çš„ `WriteFile`ï¼Œæ—¢ç„¶æŠ¥äº†å‚æ•°å¼‚å¸¸ï¼Œé‚£å°±è¯´æ˜è‚¯å®šåœ¨å‚æ•°ä¸Šå‡ºäº†é—®é¢˜ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹å®ƒçš„ç­¾åã€‚

    
    int fprintf(
       FILE *stream,
       const char *format [,
       argument ]...
    );
    
    

æœ‰äº†è¿™äº›åŸºç¡€ä¹‹ååˆ‡åˆ° `19` å·çº¿ç¨‹è§‚å¯Ÿä¸‹å®ƒçš„è°ƒç”¨æ ˆã€‚

    
    0:019> ~19s; .ecxr ; kb 10
    eax=14c9cd00 ebx=00000000 ecx=00000000 edx=00000000 esi=00000000 edi=14c9d664
    eip=682a024a esp=14c9cfd4 ebp=14c9d018 iopl=0         nv up ei pl nz ac po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000212
    msvcr90!fprintf+0x34:
    682a024a 83c414          add     esp,14h
     # ChildEBP RetAddr      Args to Child              
    00 14c9d018 1766013b     00000000 176d9c60 17def1a8 msvcr90!fprintf+0x34 [f:\dd\vctools\crt_bld\self_x86\crt\src\fprintf.c @ 55] 
    WARNING: Stack unwind information not available. Following frames may be wrong.
    01 14c9d664 454c5153     75636578 203a6574 5332347b satrda!Writer_Write+0x4bb
    02 000000c8 75636578     203a6574 5332347b 207d3230 0x454c5153
    03 000000c8 17673623     17d538e8 17ded730 00000001 crypt32!profapi_NULL_THUNK_DATA_DLA <PERF> (crypt32+0x126578)
    04 00000009 176604b6     14c9d74c 17ded730 17dae9c8 satrda!SATRDA_Proto_UnitTest+0x6c93
    05 ffffffff 17654012     17dae9c8 17d538e8 17ded730 satrda!Writer_Write+0x836
    06 17dae9c8 665fe072     14c9d74c 00000001 1765405b satrda!ConfigDSN+0xd0c2
    07 17ded730 63207463     2c44492e 6f532e63 632c7472 clr!CompressDebugInfo::CompressBoundariesAndVars+0x2d0
    08 656c6573 2c44492e     6f532e63 632c7472 7261502e 0x63207463
    09 656c6573 6f532e63     632c7472 7261502e 49746e65 0x2c44492e
    0a 656c6573 69482e63     6e656464 4c2e632c 6c657665 Microsoft_Build_Tasks_v4_0_ni+0x2f2e63
    0b 2c687461 6e656464     4c2e632c 6c657665 64646948 System_ServiceModel_Web_ni+0xf2e63
    0c 69482e63 4c2e632c     6c657665 64646948 632c6e65 System_Runtime_Serialization_ni+0x226464
    0d 6e656464 6c657665     64646948 632c6e65 6d6f432e 0x4c2e632c
    0e 6e656464 64646948     632c6e65 6d6f432e 656e6f70 System_ServiceModel_ni+0x537665
    0f 6c657665 632c6e65     6d6f432e 656e6f70 632c746e 0x64646948
    
    

ä»çº¿ç¨‹æ ˆæ¥çœ‹ `msvcr90!fprintf` å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°å±…ç„¶æ˜¯ `00000000` ï¼Œä¹Ÿå°±æ˜¯è¯´ `*stream` è¿™ä¸ªå‚æ•°ä¸º NULLï¼Œéš¾æ€ªè¯´å‚æ•°å¼‚å¸¸ï¼

### 3\. ä¸ºä»€ä¹ˆ stream ä¸ºç©º

ç†Ÿæ‚‰ C çš„æœ‹å‹åº”è¯¥çŸ¥é“ `*stream` å‚æ•°æ˜¯é€šè¿‡ `fopen` å‡½æ•°å¾—åˆ°çš„ï¼Œå¯èƒ½æœ‰äº›æœ‹å‹æœ‰ç‚¹æ··ï¼Œè¿™é‡Œå°±å†™ä¸ªç®€å•çš„æ¨¡å‹å§ã€‚

    
    int main()
    {
    	FILE* pFile;
    	int n;
    	char name[100];
    
    	pFile = fopen("D:\\dumps\\myfile2.txt", "w");
    
    	gets_s(name, 100);
    
    	fprintf(pFile, "%s", name);
    
    	fclose(pFile);
    
    	return 0;
    }
    
    

æ¥ä¸‹æ¥æˆ‘ä»¬åˆ° dump ä¸­å¯»æ‰¾ä¸€ä¸‹ `fopen` å‡½æ•°ï¼Œè¿™ä¸ªåœ¨çº¿ç¨‹æ ˆä¸Šæ˜¯æ²¡æœ‰äº†ï¼Œå…ˆæå–å‡º `msvcr90!fprintf+0x34` ä¸­çš„ `RetAddr=1766013b` è¿”å›å€¼åœ°å€åˆ°æ±‡ç¼–çª—å£æŸ¥æ‰¾ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2023.cnblogs.com/blog/214741/202303/214741-20230327090028919-926826827.png)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œesi æ˜¯ eax ç»™çš„ï¼Œè€Œ eax æ˜¯ call è¿”å›å€¼ç»™çš„ï¼Œä¸å‡ºæ„å¤– `176D727Ch` ä¸­å­˜çš„å°±æ˜¯ `fopen` å‡½æ•°ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

    
    0:019> u poi(176D727Ch)
    msvcr90!fopen [f:\dd\vctools\crt_bld\self_x86\crt\src\fopen.c @ 123]:
    682a01a2 8bff            mov     edi,edi
    682a01a4 55              push    ebp
    682a01a5 8bec            mov     ebp,esp
    682a01a7 6a40            push    40h
    682a01a9 ff750c          push    dword ptr [ebp+0Ch]
    682a01ac ff7508          push    dword ptr [ebp+8]
    682a01af e825ffffff      call    msvcr90!_fsopen (682a00d9)
    682a01b4 83c40c          add     esp,0Ch
    
    

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æå– `fopen` ä¸­çš„ä¸¤ä¸ªå‚æ•°ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2023.cnblogs.com/blog/214741/202303/214741-20230327090028931-1807240385.png)

ç¬¬äºŒä¸ªå‚æ•°å¾ˆå¥½è·å–å°±æ˜¯ `176D9C60h` çš„ ascii è¡¨ç¤ºï¼Œç¬¬ä¸€ä¸ªå‚æ•°è·å–èµ·æ¥å°±éº»çƒ¦äº†ï¼Œæˆ‘ä»¬éœ€è¦è¯¦ç»†çš„å¦‚å›¾é‚£æ ·æ¨æµ‹å½“æ—¶çš„ esp æŒ‡å‘çš„ä½ç½®ã€‚

    
    0:019> da 14c9d074
    14c9d074  "0810"
    0:019> da 176D9C64h
    176d9c64  "at++"
    
    

è¿˜åŸæˆ C ä»£ç å¤§æ¦‚å°±æ˜¯ï¼š

    
    FILE*  pFile = fopen("0810", "at++");
    
    

ä»£ç å¤§æ¦‚æ˜¯æ¢å¤å‡ºæ¥äº†ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šæŠ›å¼‚å¸¸å‘¢ï¼Ÿ windbg æœ‰ä¸€ä¸ª `!gle` å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆé”™è¯¯ã€‚

    
    0:019> !gle
    LastErrorValue: (NTSTATUS) 0 (0) - STATUS_SUCCESS
    LastStatusValue: (NTSTATUS) 0xc000003a - {            }       %hs
    
    

æ¥ä¸‹æ¥åˆ°å¾®è½¯çš„å®˜æ–¹æ–‡æ¡£ï¼š`https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55` æ‰¾ä¸€ä¸‹è¿™ä¸ª 3a åˆ°åº•è¡¨ç¤ºå•¥æ„æ€ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2023.cnblogs.com/blog/214741/202303/214741-20230327090028954-1436713049.png)

ä»å›¾ä¸­çœ‹ï¼ŒåŸæ¥æ˜¯è·¯å¾„ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œåº”è¯¥å°±æ˜¯æ²¡æ‰¾åˆ° `0810` è¿™ä¸ªæ–‡ä»¶ã€‚

åˆ°è¿™é‡Œå°±åŸºæœ¬å¼„æ¸…æ¥šäº†æ¥é¾™å»è„‰ï¼Œåº”è¯¥æ˜¯æœ‹å‹çš„æœåŠ¡å™¨æœ‰æ„æˆ–è€…æ— æ„æ¸…ç†äº†ç”± `satrda` ç”Ÿæˆçš„ 0810 æ–‡ä»¶ï¼Œå¼•å‘ `satrda.dll` æ‰¾ä¸åˆ°æ–‡ä»¶è·¯å¾„å¯¼è‡´çš„ç¨‹åºå´©æºƒï¼Œå°†è¿™äº›ä¿¡æ¯æä¾›ç»™æœ‹å‹ä¹‹åï¼Œè®©æœ‹å‹å»æ‰¾ `satrda` å®˜ç½‘å»äº†è§£ä¸‹è¯¦æƒ…ï¼Œæ¯•ç«Ÿå®˜æ–¹æ‰æ˜¯æœ€æ¸…æ¥šçš„ã€‚

ä¸‰ï¼šæ€»ç»“
----

è¿™æ¬¡äº‹æ•…æ˜¯ç”±äº `satrda` å±‚é¢æ‰¾ä¸åˆ°æ–‡ä»¶è·¯å¾„å¯¼è‡´çš„ç¨‹åºå´©æºƒï¼Œæ®æœ‹å‹è¯´åœ¨ C# å±‚é¢æ²¡æ”¶åˆ°è¿™ç§C++å¼‚å¸¸ï¼Œç¡®å®å½“ C# å’Œ C++ äº§ç”Ÿäº¤äº’æ—¶ç»å¸¸ä¼šæœ‰å„ç§å¥‡æ€ªçš„é—®é¢˜ï¼Œæˆ‘æ— æ„åˆ é™¤ä½ çš„ï¼Œä½ æ— æ„å¹²æ‰°æˆ‘çš„ï¼Œå¤§å®¶éƒ½å¥½è‡ªä¸ºä¹‹å§ğŸ˜‚ğŸ˜‚ğŸ˜‚