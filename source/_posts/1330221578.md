---
layout: post
title: "Veleroç³»åˆ—æ–‡ç« ï¼ˆå››ï¼‰ï¼šä½¿ç”¨Veleroè¿›è¡Œç”Ÿäº§è¿ç§»å®æˆ˜"
date: "2022-12-12T11:14:03.723Z"
---
Veleroç³»åˆ—æ–‡ç« ï¼ˆå››ï¼‰ï¼šä½¿ç”¨Veleroè¿›è¡Œç”Ÿäº§è¿ç§»å®æˆ˜
==============================

æ¦‚è¿°
--

### ç›®çš„

é€šè¿‡ **velero** å·¥å…·, å®ç°ä»¥ä¸‹æ•´ä½“ç›®æ ‡:

*   ç‰¹å®š namespace åœ¨B Aä¸¤ä¸ªé›†ç¾¤é—´åšè¿ç§»;

å…·ä½“ç›®æ ‡ä¸º:

1.  åœ¨B Aé›†ç¾¤ä¸Šåˆ›å»º **velero** (åŒ…æ‹¬ **restic** )
2.  å¤‡ä»½ **Bé›†ç¾¤** ç‰¹å®š namespace : `caseycui2020`:
    1.  å¤‡ä»½resources - å¦‚deployments, configmapsç­‰;
        1.  å¤‡ä»½å‰, æ’é™¤ç‰¹å®š`secrets`çš„yaml.
    2.  å¤‡ä»½volumeæ•°æ®; (é€šè¿‡resticå®ç°)
        1.  é€šè¿‡"é€‰æ‹©æ€§å¯ç”¨" çš„æ–¹å¼, åªå¤‡ä»½ç‰¹å®šçš„pod volume
3.  è¿ç§»ç‰¹å®š namespace åˆ° **Aé›†ç¾¤** : `caseycui2020`:
    1.  è¿ç§»resources - é€šè¿‡`include`çš„æ–¹å¼, ä»…è¿ç§»ç‰¹å®šresources;
    2.  è¿ç§»volumeæ•°æ®. (é€šè¿‡restic å®ç°)

å®‰è£…
--

1.  åœ¨æ‚¨çš„æœ¬åœ°ç›®å½•ä¸­åˆ›å»ºç‰¹å®šäºVeleroçš„å‡­è¯æ–‡ä»¶ï¼ˆ`credentials-velero`):
    
    ä½¿ç”¨çš„æ˜¯xskyçš„å¯¹è±¡å­˜å‚¨: (å…¬å¸çš„netappçš„å¯¹è±¡å­˜å‚¨ä¸å…¼å®¹)
    
        [default]
        aws_access_key_id = xxxxxxxxxxxxxxxxxxxxxxxx
        aws_secret_access_key = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
        
    
2.  (openshift) éœ€è¦å…ˆåˆ›å»º namespace : `velero`: `oc new-project velero`
    
3.  é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç»´åº¦çš„openshift namespace ä¸ä¼šåœ¨é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè°ƒåº¦Podã€‚
    
    è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè®¡åˆ’namespaceï¼Œéœ€è¦ä¸€ä¸ªæ³¨é‡Šï¼š
    
        oc annotate namespace velero openshift.io/node-selector=""
        
    
    è¿™åº”è¯¥åœ¨å®‰è£…veleroä¹‹å‰å®Œæˆã€‚
    
4.  å¯åŠ¨æœåŠ¡å™¨å’Œå­˜å‚¨æœåŠ¡ã€‚ åœ¨Veleroç›®å½•ä¸­ï¼Œè¿è¡Œï¼š
    
        velero install \
            --provider aws \
            --plugins velero/velero-plugin-for-aws:v1.0.0 \
            --bucket velero \
            --secret-file ./credentials-velero \
            --use-restic \
            --use-volume-snapshots=true \
            --backup-location-config region="default",s3ForcePathStyle="true",s3Url="http://glacier.ewhisper.cn",insecureSkipTLSVerify="true",signatureVersion="4" \
            --snapshot-location-config region="default"
        
    
    åˆ›å»ºçš„å†…å®¹åŒ…æ‹¬:
    
        CustomResourceDefinition/backups.velero.io: attempting to create resource
        CustomResourceDefinition/backups.velero.io: created
        CustomResourceDefinition/backupstoragelocations.velero.io: attempting to create resource
        CustomResourceDefinition/backupstoragelocations.velero.io: created
        CustomResourceDefinition/deletebackuprequests.velero.io: attempting to create resource
        CustomResourceDefinition/deletebackuprequests.velero.io: created
        CustomResourceDefinition/downloadrequests.velero.io: attempting to create resource
        CustomResourceDefinition/downloadrequests.velero.io: created
        CustomResourceDefinition/podvolumebackups.velero.io: attempting to create resource
        CustomResourceDefinition/podvolumebackups.velero.io: created
        CustomResourceDefinition/podvolumerestores.velero.io: attempting to create resource
        CustomResourceDefinition/podvolumerestores.velero.io: created
        CustomResourceDefinition/resticrepositories.velero.io: attempting to create resource
        CustomResourceDefinition/resticrepositories.velero.io: created
        CustomResourceDefinition/restores.velero.io: attempting to create resource
        CustomResourceDefinition/restores.velero.io: created
        CustomResourceDefinition/schedules.velero.io: attempting to create resource
        CustomResourceDefinition/schedules.velero.io: created
        CustomResourceDefinition/serverstatusrequests.velero.io: attempting to create resource
        CustomResourceDefinition/serverstatusrequests.velero.io: created
        CustomResourceDefinition/volumesnapshotlocations.velero.io: attempting to create resource
        CustomResourceDefinition/volumesnapshotlocations.velero.io: created
        Waiting for resources to be ready in cluster...
        Namespace/velero: attempting to create resource
        Namespace/velero: created
        ClusterRoleBinding/velero: attempting to create resource
        ClusterRoleBinding/velero: created
        ServiceAccount/velero: attempting to create resource
        ServiceAccount/velero: created
        Secret/cloud-credentials: attempting to create resource
        Secret/cloud-credentials: created
        BackupStorageLocation/default: attempting to create resource
        BackupStorageLocation/default: created
        VolumeSnapshotLocation/default: attempting to create resource
        VolumeSnapshotLocation/default: created
        Deployment/velero: attempting to create resource
        Deployment/velero: created
        DaemonSet/restic: attempting to create resource
        DaemonSet/restic: created
        Velero is installed! â›µ Use 'kubectl logs deployment/velero -n velero' to view the status.
        
    
5.  (openshift) å°†`velero` ServiceAccountæ·»åŠ åˆ°`privileged`SCCï¼š
    
        $ oc adm policy add-scc-to-user privileged -z velero -n velero
        
    
6.  (openshift) å¯¹äºOpenShiftç‰ˆæœ¬> = 4.1ï¼Œä¿®æ”¹DaemonSet yamlä»¥è¯·æ±‚`privileged`æ¨¡å¼ï¼š
    
        @@ -67,3 +67,5 @@ spec:
                      value: /credentials/cloud
                    - name: VELERO_SCRATCH_DIR
                      value: /scratch
        +          securityContext:
        +            privileged: true
        
    
    æˆ–:
    
        oc patch ds/restic \
          --namespace velero \
          --type json \
          -p '[{"op":"add","path":"/spec/template/spec/containers/0/securityContext","value": { "privileged": true}}]'
        
    

å¤‡ä»½ - Bé›†ç¾¤
--------

### å¤‡ä»½é›†ç¾¤çº§åˆ«çš„ç‰¹å®šèµ„æº

    velero backup create <backup-name> --include-cluster-resources=true  --include-resources deployments,configmaps
    

æŸ¥çœ‹å¤‡ä»½

    velero backup describe YOUR_BACKUP_NAME
    

### å¤‡ä»½ç‰¹å®š namespace `caseycui2020`

#### æ’é™¤ç‰¹å®šèµ„æº

æ ‡ç­¾ä¸º`velero.io/exclude-from-backup=true`çš„èµ„æºä¸åŒ…æ‹¬åœ¨å¤‡ä»½ä¸­ï¼Œå³ä½¿å®ƒåŒ…å«åŒ¹é…çš„é€‰æ‹©å™¨æ ‡ç­¾ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

é€šè¿‡è¿™ç§æ–¹å¼, ä¸éœ€è¦å¤‡ä»½çš„`secret` ç­‰èµ„æºé€šè¿‡`velero.io/exclude-from-backup=true` æ ‡ç­¾(label)è¿›è¡Œæ’é™¤.

é€šè¿‡è¿™ç§æ–¹å¼æ’é™¤çš„`secret`éƒ¨åˆ†ç¤ºä¾‹å¦‚ä¸‹:

    builder-dockercfg-jbnzr
    default-token-lshh8
    pipeline-token-xt645
    

#### ä½¿ç”¨restic å¤‡ä»½Pod Volume

> ğŸ¾ æ³¨æ„:
> 
> è¯¥ namespace ä¸‹, ä»¥ä¸‹2ä¸ªpod volumeä¹Ÿéœ€è¦å¤‡ä»½, ä½†æ˜¯ç›®å‰è¿˜æ²¡æ­£å¼ä½¿ç”¨:
> 
> *   `mycoreapphttptask-callback`
> *   `mycoreapphttptaskservice-callback`

é€šè¿‡ **"é€‰æ‹©æ€§å¯ç”¨"** çš„æ–¹å¼è¿›è¡Œæœ‰é€‰æ‹©åœ°å¤‡ä»½.

1.  å¯¹åŒ…å«è¦å¤‡ä»½çš„å·çš„æ¯ä¸ªPodè¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    
        oc -n caseycui2020 annotate pod/<mybackendapp-pod-name> backup.velero.io/backup-volumes=jmx-exporter-agent,pinpoint-agent,my-mybackendapp-claim
        oc -n caseycui2020 annotate pod/<elitegetrecservice-pod-name> backup.velero.io/backup-volumes=uploadfile
        
    
    å…¶ä¸­ï¼Œå·åæ˜¯å®¹å™¨ specä¸­å·çš„åç§°ã€‚
    
    ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹podï¼š
    
        apiVersion: v1
        kind: Pod
        metadata:
          name: sample
          namespace: foo
        spec:
          containers:
          - image: k8s.gcr.io/test-webserver
            name: test-webserver
            volumeMounts:
            - name: pvc-volume
              mountPath: /volume-1
            - name: emptydir-volume
              mountPath: /volume-2
          volumes:
          - name: pvc-volume
            persistentVolumeClaim:
              claimName: test-volume-claim
          - name: emptydir-volume
            emptyDir: {}
        
    
    ä½ åº”è¯¥è¿è¡Œ:
    
        kubectl -n foo annotate pod/sample backup.velero.io/backup-volumes=pvc-volume,emptydir-volume
        
    
    å¦‚æœæ‚¨ä½¿ç”¨æ§åˆ¶å™¨æ¥ç®¡ç†æ‚¨çš„podsï¼Œåˆ™ä¹Ÿå¯ä»¥åœ¨pod template specä¸­æä¾›æ­¤æ‰¹æ³¨ã€‚
    

#### å¤‡ä»½åŠéªŒè¯

å¤‡ä»½namespaceåŠå…¶å¯¹è±¡, ä»¥åŠå…·æœ‰ç›¸å…³annotationçš„pod volume:

    # ç”Ÿäº§ namespace 
    velero backup create caseycui2020 --include-namespaces caseycui2020
    

æŸ¥çœ‹å¤‡ä»½

    velero backup describe YOUR_BACKUP_NAME
    velero backup logs caseycui2020
    oc -n velero get podvolumebackups -l velero.io/backup-name=caseycui2020 -o yaml
    

describeæŸ¥çœ‹çš„ç»“æœå¦‚ä¸‹:

    Name:         caseycui2020
    Namespace:    velero
    Labels:       velero.io/storage-location=default
    Annotations:  velero.io/source-cluster-k8s-gitversion=v1.18.3+2cf11e2
                  velero.io/source-cluster-k8s-major-version=1
                  velero.io/source-cluster-k8s-minor-version=18+
    
    Phase:  Completed
    
    Errors:    0
    Warnimybackendapp:  0
    
    Namespaces:
      Included:  caseycui2020
      Excluded:  <none>
    
    Resources:
      Included:        *
      Excluded:        <none>
      Cluster-scoped:  auto
    
    Label selector:  <none>
    
    Storage Location:  default
    
    Velero-Native Snapshot PVs:  auto
    
    TTL:  720h0m0s
    
    Hooks:  <none>
    
    Backup Format Version:  1.1.0
    
    Started:    2020-10-21 09:28:16 +0800 CST
    Completed:  2020-10-21 09:29:17 +0800 CST
    
    Expiration:  2020-11-20 09:28:16 +0800 CST
    
    Total items to be backed up:  591
    Items backed up:              591
    
    Velero-Native Snapshots: <none included>
    
    Restic Backups (specify --details for more information):
      Completed:  3
    
    

### å®šæœŸå¤‡ä»½

ä½¿ç”¨åŸºäºcronè¡¨è¾¾å¼åˆ›å»ºå®šæœŸè®¡åˆ’çš„å¤‡ä»½ï¼š

    velero schedule create caseycui2020-b-daily --schedule="0 3 * * *" --include-namespaces caseycui2020
    

å¦å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›éæ ‡å‡†çš„é€Ÿè®°cronè¡¨è¾¾å¼ï¼š

    velero schedule create test-daily --schedule="@every 24h" --include-namespaces caseycui2020
    

æœ‰å…³æ›´å¤šç”¨æ³•ç¤ºä¾‹ï¼Œè¯·å‚è§[cronè½¯ä»¶åŒ…](https://godoc.org/github.com/robfig/cron)çš„æ–‡æ¡£ã€‚

é›†ç¾¤è¿ç§» - åˆ°Aé›†ç¾¤
-----------

ä½¿ç”¨ _Backups_ å’Œ _Restores_

åªè¦æ‚¨å°†æ¯ä¸ªVeleroå®ä¾‹æŒ‡å‘ç›¸åŒçš„äº‘å¯¹è±¡å­˜å‚¨ä½ç½®ï¼ŒVeleroå°±èƒ½å¸®åŠ©æ‚¨å°†èµ„æºä»ä¸€ä¸ªç¾¤é›†ç§»æ¤åˆ°å¦ä¸€ä¸ªç¾¤é›†ã€‚ æ­¤æ–¹æ¡ˆå‡å®šæ‚¨çš„ç¾¤é›†ç”±åŒä¸€äº‘æä¾›å•†æ‰˜ç®¡ã€‚ è¯·æ³¨æ„ï¼ŒVeleroæœ¬èº«ä¸æ”¯æŒè·¨äº‘æä¾›ç¨‹åºè¿ç§»æŒä¹…å·å¿«ç…§ã€‚ å¦‚æœè¦åœ¨äº‘å¹³å°ä¹‹é—´è¿ç§»å·æ•°æ®ï¼Œè¯·å¯ç”¨resticï¼Œå®ƒå°†åœ¨æ–‡ä»¶ç³»ç»Ÿçº§åˆ«å¤‡ä»½å·å†…å®¹ã€‚

1.  ï¼ˆé›†ç¾¤ Bï¼‰å‡è®¾æ‚¨å°šæœªä½¿ç”¨Velero `schedule` æ“ä½œå¯¹æ•°æ®è¿›è¡Œæ£€æŸ¥ç‚¹æ£€æŸ¥ï¼Œåˆ™éœ€è¦é¦–å…ˆå¤‡ä»½æ•´ä¸ªç¾¤é›†ï¼ˆæ ¹æ®éœ€è¦æ›¿æ¢`<BACKUP-NAME>`ï¼‰ï¼š
    
        velero backup create <BACKUP-NAME>
        
    
    é»˜è®¤å¤‡ä»½ä¿ç•™æœŸé™ä»¥TTLï¼ˆæœ‰æ•ˆæœŸï¼‰è¡¨ç¤ºï¼Œä¸º30å¤©ï¼ˆ720å°æ—¶ï¼‰ï¼› æ‚¨å¯ä»¥ä½¿ç”¨`--ttl <DURATION>`æ ‡å¿—æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ”¹ã€‚ æœ‰å…³å¤‡ä»½åˆ°æœŸçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§[veleroçš„å·¥ä½œåŸç†](https://velero.io/docs/v1.5/how-velero-works/)ã€‚
    
2.  ï¼ˆé›†ç¾¤ Aï¼‰é…ç½®`BackupStorageLocations`å’Œ`VolumeSnapshotLocations`, æŒ‡å‘ _é›†ç¾¤1_ ä½¿ç”¨çš„ä½ç½®, ä½¿ç”¨`velero backup-location create`å’Œ`velero snapshot-location create`. è¦ç¡®ä¿é…ç½®`BackupStorageLocations`ä¸º read-only, é€šè¿‡åœ¨`velero backup-location create`æ—¶ä½¿ç”¨`--access-mode=ReadOnly` flag (å› ä¸ºæˆ‘å°±åªæœ‰ä¸€ä¸ªbucket, æ‰€ä»¥å°±æ²¡æœ‰é…ç½®åªè¯»è¿™ä¸€é¡¹). å¦‚ä¸‹ä¸ºåœ¨Aé›†ç¾¤å®‰è£…, å®‰è£…æ—¶å·²é…ç½®äº†`BackupStorageLocations`å’Œ`VolumeSnapshotLocations`.
    
        velero install \
            --provider aws \
            --plugins velero/velero-plugin-for-aws:v1.0.0 \
            --bucket velero \
            --secret-file ./credentials-velero \
            --use-restic \
            --use-volume-snapshots=true \
            --backup-location-config region="default",s3ForcePathStyle="true",s3Url="http://glacier.ewhisper.cn",insecureSkipTLSVerify="true",signatureVersion="4"\
            --snapshot-location-config region="default"
        
    
3.  ï¼ˆé›†ç¾¤Aï¼‰ç¡®ä¿å·²åˆ›å»ºVelero Backupå¯¹è±¡ã€‚ Veleroèµ„æºä¸äº‘å­˜å‚¨ä¸­çš„å¤‡ä»½æ–‡ä»¶åŒæ­¥ã€‚
    
        velero backup describe <BACKUP-NAME>
        
    
    **æ³¨æ„**ï¼šé»˜è®¤åŒæ­¥é—´éš”ä¸º1åˆ†é’Ÿï¼Œå› æ­¤è¯·ç¡®ä¿åœ¨æ£€æŸ¥ä¹‹å‰ç­‰å¾…ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨VeleroæœåŠ¡å™¨çš„`--backup-sync-period`æ ‡å¿—é…ç½®æ­¤é—´éš”ã€‚
    
4.  ï¼ˆé›†ç¾¤Aï¼‰ä¸€æ—¦ç¡®è®¤ç°åœ¨å­˜åœ¨æ­£ç¡®çš„å¤‡ä»½ï¼ˆ`<BACKUP-NAME>`ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿˜åŸæ‰€æœ‰å†…å®¹ï¼š (å› ä¸º`backup` ä¸­åªæœ‰`caseycui2020`ä¸€ä¸ª namespace , æ‰€ä»¥è¿˜åŸæ˜¯å°±ä¸éœ€è¦`--include-namespaces caseycui2020` è¿›è¡Œè¿‡æ»¤)
    
        velero restore create --from-backup caseycui2020 --include-resources buildconfigs.build.openshift.io,configmaps,deploymentconfigs.apps.openshift.io,imagestreams.image.openshift.io,imagestreamtags.image.openshift.io,imagetags.image.openshift.io,limitranges,namespaces,networkpolicies.networking.k8s.io,persistentvolumeclaims,prometheusrules.monitoring.coreos.com,resourcequotas,rolebindimybackendapp.authorization.openshift.io,rolebindimybackendapp.rbac.authorization.k8s.io,routes.route.openshift.io,secrets,servicemonitors.monitoring.coreos.com,services,templateinstances.template.openshift.io
        
    
    å› ä¸ºåé¢éªŒè¯`persistentvolumeclaims`çš„`restore`æœ‰é—®é¢˜, æ‰€ä»¥åç»­ä½¿ç”¨çš„æ—¶å€™å…ˆæ‹¿æ‰è¿™ä¸ªpvc, åé¢å†æƒ³åŠæ³•è§£å†³:
    
        velero restore create --from-backup caseycui2020 --include-resources buildconfigs.build.openshift.io,configmaps,deploymentconfigs.apps.openshift.io,imagestreams.image.openshift.io,imagestreamtags.image.openshift.io,imagetags.image.openshift.io,limitranges,namespaces,networkpolicies.networking.k8s.io,persistentvolumeclaims,prometheusrules.monitoring.coreos.com,resourcequotas,rolebindimybackendapp.authorization.openshift.io,rolebindimybackendapp.rbac.authorization.k8s.io,routes.route.openshift.io,secrets,servicemonitors.monitoring.coreos.com,services,templateinstances.template.openshift.io
        
    

éªŒè¯2ä¸ªé›†ç¾¤
------

æ£€æŸ¥ç¬¬äºŒä¸ªç¾¤é›†æ˜¯å¦æŒ‰é¢„æœŸè¿è¡Œï¼š

1.  (é›†ç¾¤A)è¿è¡Œ:
    
        velero restore get
        
    
    ç»“æœå¦‚ä¸‹:
    
        NAME                       BACKUP      STATUS            STARTED   COMPLETED   ERRORS   WARNImybackendapp   CREATED                         SELECTOR
        caseycui2020-20201021102342   caseycui2020   Failed            <nil>     <nil>       0        0          2020-10-21 10:24:14 +0800 CST   <none>
        caseycui2020-20201021103040   caseycui2020   PartiallyFailed   <nil>     <nil>       46       34         2020-10-21 10:31:12 +0800 CST   <none>
        caseycui2020-20201021105848   caseycui2020   InProgress        <nil>     <nil>       0        0          2020-10-21 10:59:20 +0800 CST   <none>
        
    
2.  ç„¶åè¿è¡Œ:
    
        velero restore describe <RESTORE-NAME-FROM-GET-COMMAND>
        oc -n velero get podvolumerestores -l velero.io/restore-name=YOUR_RESTORE_NAME -o yaml
        
    
    ç»“æœå¦‚ä¸‹:
    
        Name:         caseycui2020-20201021102342
        Namespace:    velero
        Labels:       <none>
        Annotations:  <none>
        
        Phase:  InProgress
        
        Started:    <n/a>
        Completed:  <n/a>
        
        Backup:  caseycui2020
        
        Namespaces:
          Included:  all namespaces found in the backup
          Excluded:  <none>
        
        Resources:
          Included:        buildconfigs.build.openshift.io, configmaps, deploymentconfigs.apps.openshift.io, imagestreams.image.openshift.io, imagestreamtags.image.openshift.io, imagetags.image.openshift.io, limitranges, namespaces, networkpolicies.networking.k8s.io, persistentvolumeclaims, prometheusrules.monitoring.coreos.com, resourcequotas, rolebindimybackendapp.authorization.openshift.io, rolebindimybackendapp.rbac.authorization.k8s.io, routes.route.openshift.io, secrets, servicemonitors.monitoring.coreos.com, services, templateinstances.template.openshift.io
          Excluded:        nodes, events, events.events.k8s.io, backups.velero.io, restores.velero.io, resticrepositories.velero.io
          Cluster-scoped:  auto
        
        Namespace mappimybackendapp:  <none>
        
        Label selector:  <none>
        
        Restore PVs:  auto
        
    

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ç¡®ä¿Veleroåœ¨ä¸¤ä¸ªç¾¤é›†ä¸­çš„ç›¸åŒnamespaceä¸­è¿è¡Œã€‚

æˆ‘è¿™è¾¹ç¢°åˆ°é—®é¢˜, å°±æ˜¯openshifté‡Œè¾¹, ä½¿ç”¨äº†imagestreamå’Œimagetag, ç„¶åå¯¹åº”çš„é•œåƒæ‹‰ä¸è¿‡æ¥, å®¹å™¨æ²¡æœ‰å¯åŠ¨.

å®¹å™¨æ²¡æœ‰å¯åŠ¨, podvolumeä¹Ÿæ²¡æœ‰æ¢å¤æˆåŠŸ.

    Name:         caseycui2020-20201021110424
    Namespace:    velero
    Labels:       <none>
    Annotations:  <none>
    
    Phase:  PartiallyFailed (run 'velero restore logs caseycui2020-20201021110424' for more information)
    
    Started:    <n/a>
    Completed:  <n/a>
    
    Warnimybackendapp:
      Velero:     <none>
      Cluster:    <none>
      Namespaces:
        caseycui2020:  could not restore, imagetags.image.openshift.io "mybackendapp:1.0.0" already exists. Warning: the in-cluster version is different than the backed-up version.
                    could not restore, imagetags.image.openshift.io "mybackendappno:1.0.0" already exists. Warning: the in-cluster version is different than the backed-up version.
                    ...
    
    Errors:
      Velero:     <none>
      Cluster:    <none>
      Namespaces:
        caseycui2020:  error restoring imagestreams.image.openshift.io/caseycui2020/mybackendapp: ImageStream.image.openshift.io "mybackendapp" is invalid: []: Internal error: imagestreams "mybackendapp" is invalid: spec.tags[latest].from.name: Invalid value: "mybackendapp@sha256:6c5ab553a97c74ad602d2427a326124621c163676df91f7040b035fa64b533c7": error generating tag event: imagestreamimage.image.openshift.io ......
    
    Backup:  caseycui2020
    
    Namespaces:
      Included:  all namespaces found in the backup
      Excluded:  <none>
    
    Resources:
      Included:        buildconfigs.build.openshift.io, configmaps, deploymentconfigs.apps.openshift.io, imagestreams.image.openshift.io, imagestreamtags.image.openshift.io, imagetags.image.openshift.io, limitranges, namespaces, networkpolicies.networking.k8s.io, persistentvolumeclaims, prometheusrules.monitoring.coreos.com, resourcequotas, rolebindimybackendapp.authorization.openshift.io, rolebindimybackendapp.rbac.authorization.k8s.io, routes.route.openshift.io, secrets, servicemonitors.monitoring.coreos.com, services, templateinstances.template.openshift.io
      Excluded:        nodes, events, events.events.k8s.io, backups.velero.io, restores.velero.io, resticrepositories.velero.io
      Cluster-scoped:  auto
    
    Namespace mappimybackendapp:  <none>
    
    Label selector:  <none>
    
    Restore PVs:  auto
    

### è¿ç§»é—®é¢˜æ€»ç»“

ç›®å‰æ€»ç»“é—®é¢˜å¦‚ä¸‹:

1.  `imagestreams.image.openshift.io, imagestreamtags.image.openshift.io, imagetags.image.openshift.io` é‡Œçš„é•œåƒæ²¡æœ‰æˆåŠŸå¯¼å…¥; ç¡®åˆ‡åœ°è¯´æ˜¯`latest`è¿™ä¸ªtagæ²¡æœ‰å¯¼å…¥æˆåŠŸ. `imagestreamtags.image.openshift.io`ç”Ÿæ•ˆä¹Ÿéœ€è¦æ—¶é—´.
    
2.  `persistentvolumeclaims` è¿ç§»è¿‡æ¥åæŠ¥é”™, æŠ¥é”™å¦‚ä¸‹:
    
        phase: Lost
        
    
    åŸå› æ˜¯: A Bé›†ç¾¤çš„StorageClassçš„é…ç½®æ˜¯ä¸åŒçš„, æ‰€ä»¥Bé›†ç¾¤çš„PVC, åœ¨Aé›†ç¾¤æƒ³è¦ç›´æ¥bindingæ˜¯ä¸å¯èƒ½çš„. è€Œä¸”åˆ›å»ºåæ— æ³•ç›´æ¥ä¿®æ”¹, éœ€è¦åˆ æ‰é‡æ–°åˆ›å»º.
    
3.  `Routes` åŸŸå, æœ‰éƒ¨åˆ†åŸŸåæ˜¯ç‰¹å®šäºA Bé›†ç¾¤çš„åŸŸå, å¦‚: `jenkins-caseycui2020.b.caas.ewhisper.cn`è¿ç§»åˆ°Aé›†ç¾¤è°ƒæ•´ä¸º: `jenkins-caseycui2020.a.caas.ewhisper.cn`
    
4.  `podVolume` æ•°æ®æ²¡æœ‰è¿ç§».
    

### `latest`è¿™ä¸ªtagæ²¡æœ‰å¯¼å…¥æˆåŠŸ

æ‰‹åŠ¨å¯¼å…¥, å‘½ä»¤å¦‚ä¸‹: (`1.0.1` ä¸ºImageStreamçš„æœ€æ–°çš„ç‰ˆæœ¬)

    oc tag xxl-job-admin:1.0.1 xxl-job-admin:latest
    

### PVC phase Losté—®é¢˜

å¦‚æœæ‰‹åŠ¨åˆ›å»º, éœ€è¦å¯¹PVC yamlè¿›è¡Œè°ƒæ•´. è°ƒæ•´å‰åPVCå¦‚ä¸‹:

Bé›†ç¾¤åŸYAML:

    kind: PersistentVolumeClaim
    apiVersion: v1
    metadata:
      annotations:
        pv.kubernetes.io/bind-completed: 'yes'
        pv.kubernetes.io/bound-by-controller: 'yes'
        volume.beta.kubernetes.io/storage-provisioner: csi.trident.netapp.io
      selfLink: /api/v1/namespaces/caseycui2020/persistentvolumeclaims/jenkins
      resourceVersion: '77304786'
      name: jenkins
      uid: ffcabc42-845d-4cdf-8c7c-56e97cb5ea82
      creationTimestamp: '2020-10-21T03:05:46Z'
      managedFields:
        - manager: kube-controller-manager
          operation: Update
          apiVersion: v1
          time: '2020-10-21T03:05:46Z'
          fieldsType: FieldsV1
          fieldsV1:
            'f:status':
              'f:phase': {}
        - manager: velero-server
          operation: Update
          apiVersion: v1
          time: '2020-10-21T03:05:46Z'
          fieldsType: FieldsV1
          fieldsV1:
            'f:metadata':
              'f:annotations':
                .: {}
                'f:pv.kubernetes.io/bind-completed': {}
                'f:pv.kubernetes.io/bound-by-controller': {}
                'f:volume.beta.kubernetes.io/storage-provisioner': {}
              'f:labels':
                .: {}
                'f:app': {}
                'f:template': {}
                'f:template.openshift.io/template-instance-owner': {}
                'f:velero.io/backup-name': {}
                'f:velero.io/restore-name': {}
            'f:spec':
              'f:accessModes': {}
              'f:resources':
                'f:requests':
                  .: {}
                  'f:storage': {}
              'f:storageClassName': {}
              'f:volumeMode': {}
              'f:volumeName': {}
      namespace: caseycui2020
      finalizers:
        - kubernetes.io/pvc-protection
      labels:
        app: jenkins-persistent
        template: jenkins-persistent-monitored
        template.openshift.io/template-instance-owner: 5a0b28c3-c760-451b-b92f-a781406d9e91
        velero.io/backup-name: caseycui2020
        velero.io/restore-name: caseycui2020-20201021110424
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      volumeName: pvc-414efafd-8b22-48da-8c20-6025a8e671ca
      storageClassName: nas-data
      volumeMode: Filesystem
    status:
      phase: Lost
    
    

è°ƒæ•´å:

    kind: PersistentVolumeClaim
    apiVersion: v1
    metadata:
      name: jenkins
      namespace: caseycui2020
      labels:
        app: jenkins-persistent
        template: jenkins-persistent-monitored
        template.openshift.io/template-instance-owner: 5a0b28c3-c760-451b-b92f-a781406d9e91
    spec:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 5Gi
      storageClassName: nas-data
      volumeMode: Filesystem
    

### `podVolume` æ•°æ®æ²¡æœ‰è¿ç§»

å¯ä»¥æ‰‹åŠ¨è¿ç§», å‘½ä»¤å¦‚ä¸‹:

    # ç™»å½•Bé›†ç¾¤
    # å…ˆæŠŠB é›†ç¾¤/opt/prometheusæ•°æ®æ‹¿å‡ºæ¥åˆ°å½“å‰æ–‡ä»¶å¤¹
    oc rsync xxl-job-admin-5-9sgf7:/opt/prometheus .
    # ä¸Šè¾¹rsyncå‘½ä»¤ä¼šåˆ›å»ºä¸ªprometheusçš„ç›®å½•
    cd prometheus
    # ç™»å½•Aé›†ç¾¤
    # å†æŠŠæ•°æ®æ‹·è´è¿›å»(æ‹·è´ä¹‹å‰å¾—å…ˆç¡®ä¿è¿™ä¸ªpodå¯åŠ¨èµ·æ¥) (å¯ä»¥å…ˆæŠŠ`JAVA_OPTS`åˆ æ‰)
    oc rsync ./ xxl-job-admin-2-6k8df:/opt/prometheus/
    

æ€»ç»“
--

æœ¬æ–‡å†™çš„æ¯”è¾ƒæ—©, åé¢ OpenShift å‡ºäº†åŸºäº Velero å°è£…çš„ OpenShift ä¸“æœ‰çš„è¿ç§»å·¥å…·, å¯ä»¥ç›´æ¥é€šè¿‡å®ƒæä¾›çš„å·¥å…·è¿›è¡Œè¿ç§».

å¦å¤–, OpenShift é›†ç¾¤ä¸Šé™åˆ¶å¾ˆå¤š, å¦å¤–ä¹Ÿæœ‰å¾ˆå¤šä¸“å±äº OpenShift çš„èµ„æº, æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ä¸Šå’Œæ ‡å‡† K8S çš„å·®åˆ«è¿˜æ˜¯æ¯”è¾ƒå¤§çš„, éœ€è¦ä»”ç»†æ³¨æ„.

æœ¬æ¬¡è™½ç„¶å°è¯•å¤±è´¥, ä½†æ˜¯å…¶ä¸­çš„æ€è·¯è¿˜æ˜¯å¯ä¾›å€Ÿé‰´çš„.

ç³»åˆ—æ–‡ç« 
----

*   [Velero ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Velero/)

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [Velero Docs - Resource filtering](https://velero.io/docs/v1.8/resource-filtering/)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.