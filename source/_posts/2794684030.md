---
layout: post
title: "ä½¿ç”¨ shell è„šæœ¬è‡ªåŠ¨è·å–å‘ç‰ˆæŒ‡æ ‡æ•°æ®"
date: "2022-04-20T04:49:31.154Z"
---
ä½¿ç”¨ shell è„šæœ¬è‡ªåŠ¨è·å–å‘ç‰ˆæŒ‡æ ‡æ•°æ®
=====================

å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ï¼Œå¯¹äºæ¯æ¬¡éƒ½è¦äººå·¥ç»Ÿè®¡çš„å‘ç‰ˆæ•°æ®ï¼Œå—…åˆ°äº†ä¸€ä¸ä¸ä¼˜åŒ–çš„ç©ºé—´â€¦â€¦éš¾å€’æˆ‘çš„ä¸æ˜¯ curl ä½¿ç”¨ cookie è®¿é—® web æœåŠ¡å™¨ï¼Œè€Œæ˜¯å¦‚ä½•è§£æ json ä¸­æ•°ç»„çš„æ•°ç»„â€¦

é—®é¢˜èƒŒæ™¯
----

å¤§ä¸€ç‚¹çš„å…¬å¸éƒ½ä¼šå»ºç«‹ä¸€å¥—è§„ç« æµç¨‹æ¥é¿å…ä½çº§é”™è¯¯ï¼Œä¾‹å¦‚åˆå…¥ä»£ç å‰å¿…éœ€ç»è¿‡åŒè¡Œè¯„å®¡ï¼›ä¸Šçº¿å‰å¿…éœ€ææµ‹ä¸”é€šè¿‡ QA éªŒè¯ï¼›å…¨é‡å‰å¿…éœ€ç»è¿‡ 1%ã€5%ã€10%ã€20%ã€50% çš„ç°åº¦è¿‡ç¨‹ã€‚å°¤å…¶æ˜¯æœ€åä¸€æ­¥ï¼Œéœ€è¦ä¸¥å¯†çš„ç›‘æ§å‘ç‰ˆæŒ‡æ ‡æ¥ä¿è¯æ–°ç‰ˆæœ¬çš„è´¨é‡ï¼Œå¦‚æœä¸ä¸»åŠ›ç‰ˆæœ¬çš„æŒ‡æ ‡ç›¸æ¯”æœ‰å¼‚å¸¸å˜åŠ¨ï¼Œå°±éœ€è¦åŠæ—¶åœæ­¢æ”¾é‡å¹¶åˆ†æåŸå› ã€‚

ä¸€ä¸ªç‰ˆæœ¬çš„é‡ç‚¹è§‚å¯ŸæŒ‡æ ‡ï¼Œé™¤å´©æºƒç‡å¤–æœ‰å° 20 é¡¹ï¼Œåˆ†å¸ƒåœ¨ç³»ç»Ÿçš„ 10 å¤šä¸ªé¡µé¢ï¼Œä¸”æ¯ä¸ªæŒ‡æ ‡å‡éœ€è¦æŒ‡å®šå¤šè¾¾ 6-10 ä¸ªè¿‡æ»¤æ¡ä»¶ï¼Œæœ€å¸¸ç”¨çš„åŒ…æ‹¬ç‰ˆæœ¬å·ã€ç«¯ç±»å‹ (PC/ Mac/Android/iOS/â€¦)ã€ç”¨æˆ·ç±»å‹ (user/vip/svip)ï¼Œæ­¤å¤–è¿˜æœ‰ä¸€äº›å¤æ‚çš„ä¸‹æ‹‰åˆ—è¡¨é€‰é¡¹ï¼Œæ¯æ¬¡éƒ½è®°ä¸ä½ï¼Œéœ€è¦å‚è€ƒæ–‡æ¡£æ‰èƒ½ç¡®å®šé€‰å¯¹äº† ğŸ˜“ï¼›å¦å¤–åƒç‰ˆæœ¬å·è¿™ç§é€‰é¡¹ï¼Œç³»ç»Ÿéœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½åˆ·å‡ºæ¥å…¨éƒ¨ç‰ˆæœ¬åˆ—è¡¨ï¼Œæœ‰æ—¶ç­‰äº†å¾ˆé•¿æ—¶é—´ä¹Ÿå‡ºä¸æ¥ï¼Œè¿˜å¾—æ‰‹åŠ¨åˆ·ä¸€ä¸‹æ‰èƒ½å¥½ï¼›æœ€åï¼Œæœ‰ä¸€äº›æŒ‡æ ‡ç³»ç»Ÿé‡Œæ²¡æœ‰ç›´æ¥ç»™å‡ºï¼Œéœ€è¦ç»¼åˆå¤šä¸ªæŒ‡æ ‡æ•°æ®è¿›è¡Œè®¡ç®—ï¼Œä¾‹å¦‚ç‰ˆæœ¬æµé‡å æ¯”æ˜¯ç”±ç‰ˆæœ¬æµé‡é™¤ä»¥æ€»æµé‡å¾—å‡ºçš„ï¼Œç±»ä¼¼çš„è¿˜æœ‰æ’­æ”¾æµé‡å æ¯”ï¼›å¦å¤–è¿˜æœ‰ä¸€äº›é€šç”¨çš„è®¡ç®—ï¼Œä¾‹å¦‚é€Ÿåº¦çš„å•ä½æ˜¯ B/sï¼Œå®é™…ä¸Šä½¿ç”¨ MB/s æ›´è´´åˆ‡ï¼Œäººå·¥è®°å½•æ•°æ®æ—¶ï¼Œä¸€èˆ¬ç›´æ¥é™¤ä»¥ 1000 æ¥è¿›è¡Œç®€å•ä¼°ç®—ï¼Œä¸é™¤ä»¥ 1024 ç›¸æ¯”è¿˜æ˜¯æœ‰æ¯”è¾ƒå¤§è¯¯åˆ¤çš„ã€‚èµ°ä¸€éå®Œæ•´æµç¨‹ä¸‹æ¥ï¼Œå¿«äº†ä¹Ÿå¾—åŠå°æ—¶ï¼Œæ…¢äº†ä¸€ä¸Šåˆå°±è¿‡å»äº†ã€‚

è§£å†³æ–¹æ¡ˆ
----

å‡¡æ˜¯é‡å¤æ€§çš„åŠ³åŠ¨éƒ½æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œå‡¡æ˜¯æ”¶é›†æ•°æ®çš„å·¥ä½œéƒ½èƒ½ç”¨è„šæœ¬å®Œæˆâ€”â€”æœ¬ç€è¿™ä¸¤ä¸ªåŸåˆ™ï¼Œå°è¯•åšä¸€ä¸ªè‡ªåŠ¨è·å–å‘ç‰ˆæŒ‡æ ‡æ•°æ®çš„ shell è„šæœ¬ã€‚ä¹‹å‰æœ‰ä½¿ç”¨ curl è®¿é—® restful api çš„ç»éªŒ (ç”¨ shell è„šæœ¬åš restful api æ¥å£ç›‘æ§)ï¼Œè¿™æ¬¡è®¿é—® web æœåŠ¡å™¨åŸç†ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé€šè¿‡æµè§ˆå™¨çš„é¡µé¢è°ƒè¯•åŠŸèƒ½ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°ä¸€æ¬¡è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯ï¼š

![](https://img2020.cnblogs.com/blog/1707550/202201/1707550-20220116172859461-1046129476.png)

ä¸»è¦ä½¿ç”¨çš„æ˜¯ http post æ•°æ®ï¼Œæ•°æ®åŸºäº json æ ¼å¼è¿”å›ï¼š

![](https://img2020.cnblogs.com/blog/1707550/202201/1707550-20220116172859676-1693324576.png)

ä¸åŒè¯·æ±‚è¿”å›çš„ json æ ¼å¼ä¸åŒï¼Œä¸è¿‡éƒ½å¯ä»¥ä½¿ç”¨ jq å‘½ä»¤å¤„ç†ã€‚

æ‹‰å–æ•°æ®
----

ç”¨ curl å°è¯•ä¸€ä¸‹ï¼š

    curl -s "http://iyuntu.xxxxx.com/xxxxxx/api/xxxxxxxxxxxxx/" -H "Accept: */*" -H "Connection: keep-alive" 
    -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" -H "Accept-Encoding: gzip, deflate"  
    -d "start=1642137792&end=1642310592&method=p2pflow&version=3.0.0.112&vipLevel=all&clusterItem=cluster_hour&clientType=pc"

æäº¤çš„è¡¨å•æ•°æ®ä¸ web è¯·æ±‚å®Œå…¨ä¸€è‡´ï¼Œç„¶è€Œå¾—åˆ°äº†æœåŠ¡å™¨é”™è¯¯ï¼š

    {"error_code":1006,"message":"userinfo is wrong.","data":[]}

æç¤ºç”¨æˆ·ä¿¡æ¯é”™è¯¯ï¼Œéš¾é“æ˜¯å› ä¸ºæ²¡æœ‰æºå¸¦ç™»å½•ä¿¡æ¯ï¼Ÿå†çœ‹ä¸€ä¸‹æµè§ˆå™¨ä¸­è¯·æ±‚çš„ cookie ä¿¡æ¯ï¼š

![](https://img2020.cnblogs.com/blog/1707550/202201/1707550-20220116172900089-343842097.png)

ç¡®å®ä¸å°‘ï¼Œå°†æ•´ä¸ª cookie æºå¸¦åˆ° curl çš„è¯·æ±‚ä¸­ï¼š

    curl -s "http://iyuntu.baidu.com/clientive" -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" -H "Accept-Encoding: gzip, deflate"  
    -d "start=1642137792&end=1642310592&method=p2pflow&version=3.0.0.112&vipLevel=all&clusterItem=cluster_hour&clientType=pc" 
    --cookie 'XXXXXXX=6955BFF6EBA75EA12FB35312F4B67309:FG=1; UUAP_TRACE_TOKEN=00253a0352ac05ddf2abb3867e1383dc; Hm_lvt_8d2a248ae863804cbd8d4f34ef769db3=1641283185,1641283813,1641780693,1642304682; jsdk-uuid=0c8f1b25-11a8-4b29-9bde-8203c9d92ba6; RT="z=1&dm=baidu.com&si=h7sa38uz0c7&ss=kycewdz5&sl=0&tt=0&bcn=https%3A%2F%2Ffclog.xxxxx.com%2Flog%2Fweirwood%3Ftype%3Dperf&ld=itd&cl=hr8&ul=kzlat&hd=kzlf2"; XXX_X_XXXXX=BppxvwS4efrHrfU1N5YBV52pvnablZcVWysHnik+JuWM8I/Ujn+rS8e2vD2ig3MkYKVYXq326XyE8GeQThgT7g==; XXXXX=GkyaW9RbklUY0VLRWpac3hMUlRsNjh5M25PTlNiZWxGRVdvT1pnWDE3ZXVuUHRoRVFBQUFBJCQAAAAAAAAAAAEAAABjkC9mY2F2ZXBhcGVybWFuAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAK4P1GGuD9RhS; UUAP_P_TOKEN=PT-685223097977524224-iAPxtFmvd3-uuap; jsdk-user=d6zmte6yU7ahGWlxTQZghw==; PHPSESSID=ST-689506677214060545-7KJVo-uuap; Hm_lpvt_8d2a248ae863804cbd8d4f34ef769db3=1642320803'

è¿™æ¬¡ä¸æŠ¥é”™äº†ï¼Œä½†æ˜¯ä¹Ÿæ²¡æœ‰è¯·æ±‚åˆ°ä»»ä½•ç»“æœï¼ŒæŸ¥çœ‹ curl è¿”å›å€¼ï¼š

    $ echo $?
    23

ç™¾åº¦äº†ä¸€ä¸‹ï¼Œcurl 23 é”™è¯¯æ˜¯å†™å¤±è´¥ï¼Œéš¾é“éœ€è¦é‡å®šå‘åˆ°æ–‡ä»¶ï¼Ÿä¸ºä¸Šé¢çš„å‘½ä»¤åŠ å…¥ï¼š

    --output temp.dat

å°†ç»“æœä¿å­˜åœ¨ temp.dat æ–‡ä»¶ä¸­ï¼Œè¿™æ¬¡ curl æ­£å¸¸äº†ï¼Œä½†æŸ¥çœ‹ temp.dat å´æ˜¯ä¸€å›¢ä¹±éº»ï¼š

    $ head -n 1 temp.dat
    ?Ù®?E?E?7?!?b
                A,9p?6
                      ???YuN×®?n ?c?'??n?5????[?????c/?>??_?????????????Ì¥?z_?_??m>~?R?Ê¥??gI?=_????G_????XÅŸ??????9k?5????

éš¾é“æ˜¯è¢«å‹ç¼©äº†ï¼Ÿä½¿ç”¨ gunzip è§£å‹è¯•è¯•ï¼š

    $ cat temp.dat  | gunzip
    {"p2p\u6d41\u91cf":[[1642140000000,28249601382.447],[1642143600000,29701279461.349],[1642147200000,30004732054.571],
    [1642150800000,28226621579.753],[1642154400000,27565004131.18],[1642158000000,30050204384.371],[1642161600000,34357590257.653],
    [1642165200000,37445146977.384],[1642168800000,37507405282.629],â€¦â€¦

ç¡®å®æ˜¯ï¼Œè§£å‹åå¾—åˆ°çš„å°±æ˜¯ json å†…å®¹äº†ï¼Œå†…å®¹è§£ææš‚æ—¶æ”¾ä¸€ä¸‹ï¼Œå…ˆèšç„¦ä¸€ä¸‹ cookie ã€‚

ä½¿ç”¨æµè§ˆå™¨ cookie å¯ä»¥å¾—åˆ°æƒ³è¦çš„ç»“æœï¼Œä½†ä¼šå¯¹æµè§ˆå™¨å½¢æˆä¾èµ–â€”â€”æ¯æ¬¡è·‘è„šæœ¬å‰éœ€è¦ä»æµè§ˆå™¨æŠ“ä¸€ä»½ cookie ä¿å­˜åœ¨æœ¬åœ°ã€‚ç»è¿‡ä¸€ç•ªæ¢ç©¶ï¼Œå‘ç°åªè¦ä¿ç•™ cookie ä¸­çš„è¿™ä¸€æ¡å°±èƒ½è®¿é—®ï¼š

    PHPSESSID=ST-689506677214060545-7KJVo-uuap;

åº”è¯¥æ˜¯ SSO ç™»å½•åçš„è®¿é—®å‡­è¯ã€‚ä»æµè§ˆå™¨å¤åˆ¶ä¸€æ¡ cookie è™½ç„¶æœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œä½†ä¹Ÿä¸æ˜¯ä¸èƒ½æ¥å—ï¼Œç›¸æ¯”æ‰‹å·¥è®°å½•å‘ç‰ˆæŒ‡æ ‡æ•°æ®ï¼Œè¿˜æ˜¯å‹å¥½ä¸å°‘äº†å˜›~

ä¸‹é¢ä»¥æµé‡æŒ‡æ ‡ä¸ºä¾‹ï¼Œä¸²èµ·æ¥ä¸Šé¢çš„ä¸€ç³»åˆ—å‘½ä»¤ï¼š

    
    # @param: starttime
    # @param: endtime
    # @param: version
    # @param: clienttype
    # @param: cookie
    # @param: select-time [option]
    function fetch_flow()
    {
        local starttime="$1"
        local endtime="$2"
        local version="$3"
        local clienttype="$4"
        local cookie="$5"
        local selecttime=""
        if [ $# -gt 5 ]; then 
            selecttime="$6"
        fi
    
        local data="start=${starttime}&end=${endtime}&method=p2pflow&version=${version}&vipLevel=all&clusterItem=cluster_hour&clientType=${clienttype}"
        curl -s "http://${HOST}/client/api/xxxxxxxxxxxx/" -H "Accept: */*" -H "Connection: keep-alive" -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" -H "Accept-Encoding: gzip, deflate" -H "Origin: ${HOST}" -H "Referer: http://${HOST}/stability/main?typeName2=total_flow&typeName2=cluster_hour&typeName2=${clienttype}&datepicker0=${starttime}&datepicker1=${endtime}" -H "X-Requested-With: XMLHttpRequest" --cookie "$cookie"  -d "$data" --output temp.gzip
    
        if [ $? -eq 0 ]; then 
            echo "request flow ok"
            cat temp.gzip | gunzip > temp.txt
            
            # handle data here...
        fi
    }

åšä¸ªç®€å•è¯´æ˜ï¼š

*   ä¸€äº›å‚æ•°æ˜¯ä»å¤–éƒ¨ä¼ å…¥çš„ï¼Œè¯¦è§å‚æ•°å‘½å
*   æå‰æ‹¼æ¥å¥½è¡¨å•æ•°æ®å¤‡ç”¨
*   curl å‘é€è¯·æ±‚ï¼Œå¤šäº†ä¸€äº› http å¤´ï¼Œä¸»è¦æ˜¯å‚è€ƒ web è¯·æ±‚è®¾ç½®çš„ï¼Œå®æµ‹å¯æœ‰å¯æ— 
*   è¯·æ±‚ä¸­æŒ‡å®šçš„ cookie æ˜¯ä»å¤–éƒ¨ä¼ å…¥çš„ï¼Œè¿™ä¸ªå‚æ•°å…¶å®å°±æ˜¯ä»æµè§ˆå™¨å­˜å‚¨åˆ°æ–‡ä»¶åä¼ é€’è¿›æ¥çš„
*   curl å“åº”å­˜æ”¾åœ¨ temp.gzip æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ gunzip è§£å‹ç¼©åˆ° temp.txt æ–‡ä»¶ï¼Œåé¢å°±å¯ä»¥ç”¨ txt è¿›è¡Œæ•°æ®è§£æäº†

å®æµ‹ cookie ä¸­çš„ PHPSESSID å¤±æ•ˆæ—¶é—´éå¸¸çŸ­ï¼Œå¯èƒ½ä¹Ÿå°±åŠä¸ªå°æ—¶ï¼ŒåŸºæœ¬æ¯æ¬¡æ‰§è¡Œè„šæœ¬æ—¶éƒ½éœ€è¦é‡æ–°æŠ“å–ã€‚

è§£ææ•°æ®
----

æœ‰äº† json æ•°æ®ï¼Œå‰©ä¸‹çš„å°±æ˜¯ä»ä¸­å–å¾—å…³å¿ƒçš„éƒ¨åˆ†ã€‚ä»ä¸Šä¸€èŠ‚çš„ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼ŒWeb æ¥å£è¿”å›çš„æ•°æ®éƒ½æ˜¯æŒ‰æ—¶é—´é¡ºåºæ’åˆ—çš„ï¼Œè€Œå‘ç‰ˆæ•°æ®åªè®°å½•æŸä¸€ä¸ªæ–­é¢çš„æŒ‡æ ‡ (ç²¾ç¡®åˆ°å°æ—¶) ï¼Œä¸€èˆ¬æ˜¯é€‰å–æµé‡é«˜å³°æ—¶åˆ»ã€‚ç»“åˆä»¥ä¸Šä¸¤ä¸ªéœ€æ±‚ï¼Œé¦–å…ˆéœ€è¦æŒ‰æ—¶é—´çš„é¡ºåºåˆ—å‡ºæ€»æµé‡çš„åˆ—è¡¨ï¼Œç”¨æˆ·æ ¹æ®è¿™ä¸ªä¿¡æ¯é€‰å–æµé‡é«˜å³°ï¼Œæˆ–è€…é€‰æ‹©æŸä¸ªæ—¶åˆ»ï¼›ç„¶åæ ¹æ®é€‰å–çš„æ—¶åˆ»ï¼Œæ‰€æœ‰æŒ‡æ ‡æ•°æ®å‘è¿™ä¸ªæ—¶åˆ»çœ‹é½ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚

ä¾‹å¦‚å¯¹äºä¸Šä¸€èŠ‚è·å–åˆ°çš„æ•°æ®ï¼Œå¦‚ä½•é€‰å–æ€»æµé‡å‘¢ï¼š

    {
        "p2p\u6d41\u91cf":Array[48],
        "dcdn\u6d41\u91cf":Array[48],
        "third_http\u6d41\u91cf":Array[48],
        "onecloud\u6d41\u91cf":Array[48],
        "relay\u6d41\u91cf":Array[48],
        "\u603b\u6d41\u91cf":Array[48],
        "cdn\u603b\u6d41\u91cf":Array[48],
        "bt\u603b\u6d41\u91cf":Array[48],
        "onecloud-http\u603b\u6d41\u91cf":[
            [
                1642140000000,
                84124693465.349
            ],
            [
                1642143600000,
                90980062017.307
            ],
            [
                1642147200000,
                86051227112.929
            ],
            ...
        ]
    }

æ•´ä¸ª json çš„ç»“æ„æ˜¯è¿™æ ·çš„ï¼š

*   key-value æ„æˆçš„äºŒå€¼æ•°ç»„ (æ›´åƒ pair) æ˜¯æœ€åŸºæœ¬çš„å•ä½ï¼Œä»£è¡¨ä¸€ä¸ªæ—¶åˆ»çš„æµé‡å€¼
*   pair ç»„æˆçš„æ•°ç»„æ„æˆä¸€ä¸ªç»´åº¦ï¼Œä»£è¡¨æŸä¸€åˆ†é‡éšæ—¶é—´å˜åŒ–çš„æ›²çº¿ï¼Œæ¯æ¡æ›²çº¿çš„ç»´åº¦ç”±åç§°ç¡®å®š
*   å¤šä¸ªç»´åº¦ç»„åˆæˆä¸€ä¸ªæœ€ç»ˆçš„ json object

é¦–å…ˆè¦ç¡®è®¤è·å–å“ªä¸ªç»´åº¦ï¼Œjson ä¸­çš„æ±‰å­—ä¼šè¢«è½¬ç ä¸º utf8ï¼Œ"\\u603b\\u6d41\\u91cf" ä»£è¡¨çš„å°±æ˜¯"æ€»æµé‡"äº†ï¼Œåœ¨ jq ä¸­å¯ä»¥ç›´æ¥æŒ‡å®šæ±‰å­—ï¼š

    $ cat temp.txt | jq '."æ€»æµé‡"'
    [
      [
        1642140000000,
        1126527342256.8
      ],
      [
        1642143600000,
        1176541641172.7
      ],
      [
        1642147200000,
        1177760044237.3
      ],
      ...
    ]

Â æ³¨æ„è¿™é‡Œæ±‰å­—å¿…éœ€ç”¨å¼•å·åŒ…è£¹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š

    jq: error: syntax error, unexpected INVALID_CHARACTER (Unix shell quoting issues?) at <top-level>, line 1:
    .æ€»æµé‡ 
    jq: error: try .["field"] instead of .field for unusually named fields at <top-level>, line 1:
    .æ€»æµé‡
    jq: 2 compile errors

æ¥ç€é€šè¿‡æ•°ç»„ç¬¦å°†æ•°æ®ä¸€ç»´åŒ– (å»æ‰æœ€å¤–å±‚æ•°ç»„)ï¼Œæ–¹ä¾¿åç»­å¤„ç†ï¼š

    $ cat temp.txt | jq '."æ€»æµé‡"[]'
    [
      1642140000000,
      1126527342256.8
    ]
    [
      1642143600000,
      1176541641172.7
    ]
    [
      1642147200000,
      1177760044237.3
    ]
    ...

å°† key-value çš„äºŒå€¼æ•°ç»„ä¹Ÿå»æ‰ï¼Œè¿™ä¸ªè´¹äº†å¾ˆå¤§å‘¨æŠ˜ï¼Œä¸è¿‡æ€»ç®—æ‰¾åˆ°äº†çš„åŠæ³•ï¼š

    $ cat temp.txt | jq '."æ€»æµé‡"[]|.[0],.[1]'
    1642140000000
    1126527342256.8
    1642143600000
    1176541641172.7
    1642147200000
    1177760044237.3
    ...

ä½¿ç”¨äº† jq çš„å†…ç½®ç®¡é“ï¼Œåœ¨æ•°ç»„ä¸­æŒ‘é€‰è¦æå–çš„å…ƒç´ ä¸‹æ ‡ï¼Œå…³äº jq è¯­æ³•å¯å‚è€ƒæ–‡æœ«é“¾æ¥ã€‚

ç®€åŒ–ä¸ºè¿™æ ·çš„å½¢å¼ï¼Œå†å±•ç¤ºç»™ç”¨æˆ·å°±æ–¹ä¾¿å¤šäº†ï¼š

    
    # @param data-file
    # @param unit
    # @param select-time [option]
    function pick_time()
    {
        local file="$1"
        local unit="$2"
        local selecttime=""
        if [ $# -gt 2 ]; then 
            selecttime="$3"
        fi
    
        local n=0 
        local m=0
        local line=""
        local stamp=0
        local time=()
        local value=()
        local match=-1
        while read line; do
            if [ "$(($n%2))" -eq 0 ]; then 
                # time field at event line
                stamp=$(($line/1000))
    
                if [ ${is_macos} -eq 1 ]; then 
                    time[$m]=$(date -j -r "$stamp" "+%Y%m%d%H")
                    #time[$m]=$(date -j -f "%Y%m%d%H" -r "$stamp")
                else
                    time[$m]=$(date -d "@$stamp" "+%Y%m%d%H")
                fi
    
                if [ -z "$selecttime" ]; then 
                    if [ ${is_macos} -eq 1 ]; then 
                        # macos builtin echo does not recognize -n
                        #echo "$stamp"
                        /bin/echo -n "$m:    ${time[$m]}    "
                    else 
                        echo -n "$m:    ${time[$m]}    "
                    fi
                else
                    if [ "$selecttime" = "${time[$m]}" ]; then 
                        # match selected time
                        picked_time="$selecttime"
                        match=$m
                    fi
                fi
            else
                # value field at odd line
                value[$m]="$line"
    
                if [ -z "$selecttime" ]; then 
                    if [ "${unit:0:1}" = ' ' ]; then 
                        # unit start with a space means no byte transfer
                        echo "${value[$m]}${unit}"
                    else 
                        # append their unit after B/KB/MB/GB
                        format_bytes "${value[$m]}"
                    fi
                else
                    if [ $match -eq $m ]; then 
                        # the value is what we want
                        picked_value="${value[$m]}"
                        #echo "matched: $picked_value"
                    fi
                fi
                m=$(($m+1))
            fi
            n=$(($n+1))
        done < $file
    
        if [ $n -lt 2 ]; then 
            echo "no data"
            picked_time=0
            picked_value=0
            return 1
        fi
    
        if [ -z "$selecttime" ]; then 
            # only prompt user when:
            #    1. no time provided
            read -p "pick a time to record (-1 to quit): " n
            if [ $n -lt 0 ]; then 
                exit 1
            fi 
    
            picked_time="${time[$n]}"
            picked_value="${value[$n]}"
    
            echo "pick ${picked_time}    ${picked_value}"
        elif [ $match -eq -1 ]; then 
            # only prompt user when:
            #    2. provided time but no match
            #
            # call myself without 2nd parameter to make prompt
            echo "given time ${selecttime} not find"
            pick_time "$file" "$unit"
        else
            echo "pick ${picked_time}    ${picked_value}"
        fi
    }

è„šæœ¬æ¥å—çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼š

*   data-fileï¼šä¸Šé¢ json è¿‡æ»¤æ‰æ‹¬å·åçš„ç»“æœï¼Œkeyã€value äº¤æ›¿å­˜æ”¾ï¼Œkey ä½äºå¥‡æ•°è¡Œï¼Œvalue ä½äºå¶æ•°è¡Œ
*   unitï¼šå±•ç¤ºç»™ç”¨æˆ·çš„æ•°å€¼å•ä½ï¼Œå¦‚ B/KB/MB/GB ...
*   selecttimeï¼šç”¨æˆ·é€‰æ‹©çš„æ—¶åˆ»

pick\_time ç”¨äºä¸‰ä¸ªåœºæ™¯ï¼š

*   æ²¡æœ‰æä¾›ç¬¬ä¸‰ä¸ªå‚æ•° (selecttime) æ—¶ï¼Œå±•ç¤ºæ•´ä¸ªåˆ—è¡¨ï¼Œä¾›ç”¨æˆ·é€‰æ‹©ï¼›
*   æä¾›äº† selecttime ä¸”æœ‰æ•°æ®åŒ¹é…æ—¶ï¼Œè¿”å›åŒ¹é…çš„æ•°æ®ï¼›
*   æä¾›äº† selecttime ä½†æ²¡æœ‰æ•°æ®åŒ¹é…æ—¶ï¼Œå±•ç¤ºæ•´ä¸ªåˆ—è¡¨ï¼Œä¾›ç”¨æˆ·é‡æ–°é€‰æ‹©ï¼›

ç¬¬ä¸€æ¬¡å±•ç¤ºæ—¶èµ°çš„æ˜¯åœºæ™¯ä¸€ï¼›åé¢å†å±•ç¤ºæ—¶èµ°çš„æ˜¯åœºæ™¯ä¸‰ï¼›åœºæ™¯äºŒä¸€èˆ¬ä¸ä¼šå‡ºç°ï¼Œåªæœ‰å½“åå°æœåŠ¡è¿”å›çš„æ•°æ®é›†ç¼ºå¤±äº†æ•°æ®æ—¶æ‰ä¼šå‘½ä¸­ï¼Œå¯ä»¥èµ·åˆ°æé†’ç”¨æˆ·çš„æ•ˆæœï¼Œé¿å…æ•°æ®ä¸ä¸€è‡´ã€‚å¯¹æ•´ä¸ªè„šæœ¬åšä¸ªç®€å•è¯´æ˜ï¼š

*   ä¸»ä½“å°±æ˜¯ä¸€ä¸ªå¾ªç¯éå† json æ•°æ®æº (å»é™¤æ‹¬å·)
*   æ ¹æ®å¥‡å¶è¡Œå°† key å’Œ value åˆ†åˆ«æ”¾å…¥ stamp() å’Œ value() æ•°ç»„
*   æ—¶é—´æˆ³å•ä½ä¸ºæ¯«ç§’ï¼Œéœ€è¦è½¬æ¢åˆ° epoch (æ•´ç‚¹)ï¼Œå†åŸºäº date å‘½ä»¤æŠŠ unix time è½¬æ¢ä¸º YYYYMMDDHH çš„å½¢å¼ï¼Œæ³¨æ„ mac å’Œ linux ä¸Šçš„ date å‘½ä»¤æœ‰å·®å¼‚ï¼Œéœ€è¦åˆ†å¹³å°å¤„ç†
*   æ²¡æœ‰ç»™å®š selecttime æ—¶ï¼Œæ‰“å°è½¬æ¢ä¸ºæ—¶é—´å­—ç¬¦ä¸²çš„ keyï¼Œè¿™é‡Œä½¿ç”¨ echo -n æ¥é¿å…æ¢è¡Œï¼Œå› ä¸ºç´§æ¥ç€è¦æ‰“å° value éƒ¨åˆ†ï¼Œæ³¨æ„ mac å’Œ linux ä¸Šçš„ echo å‘½ä»¤æœ‰å·®å¼‚ï¼Œéœ€è¦åˆ†å¹³å°å¤„ç†Â  (mac ä¸Šçš„ bultin echo ä¸è¯†åˆ« -n å‚æ•°ï¼Œéœ€è¦è°ƒç”¨ echo å‘½ä»¤)
*   å¦‚æœç»™å®šäº† selecttimeï¼Œè¿›è¡Œå¯¹æ¯”ï¼Œè‹¥åŒ¹é…åˆ™è®°å½•ç”¨æˆ·é€‰æ‹©çš„ç´¢å¼•è‡³ match ä¸­ï¼Œç”¨äºç¨åçš„ value åŒ¹é…
*   å¤„ç† value æ—¶ä¹Ÿæ˜¯å·®ä¸å¤šçš„é€»è¾‘ï¼šä¸ç»™å®š selecttime å°±è¾“å‡º value çš„å€¼å’Œå•ä½ï¼›ç»™å®š selecttime ä¸”å½“å‰ç´¢å¼•åŒ¹é… match å€¼ï¼Œåˆ™è®°å½• value è‡³ picked\_valueï¼Œè¿™æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç¨åå¯ä»¥è®©è°ƒç”¨å‡½æ•°å¼•ç”¨æ¥è·å–ç»“æœ
*   å¾ªç¯ç»“æŸåï¼Œè‹¥æœªç»™å®š selecttimeï¼Œè¦æ±‚ç”¨æˆ·è¾“å…¥ç´¢å¼•æ¥é€‰æ‹©ä¸€ä¸ªæ—¶é—´ï¼Œè®°å½•å¯¹åº”çš„ time å’Œ value è‡³ picked\_time ä¸ picked\_value
*   è‹¥ç»™å®š selecttime ä½†æœªèƒ½åŒ¹é…ï¼Œå†æ¬¡è°ƒç”¨ä¸¤å‚æ•°çš„è‡ªå·±ï¼Œæ¥æ‰“å°å…¨éƒ¨æ•°æ®ä¾›ç”¨æˆ·é€‰æ‹©
*   è‹¥ç»™å®š selecttime åŒ¹é…äº†ï¼Œæ‰“å°ç”¨æˆ·é€‰æ‹©æ—¶é—´çš„å¯¹åº”å€¼

ä¸€èˆ¬ value çš„å•ä½æ˜¯å­—èŠ‚ï¼Œé‡åˆ°æµé‡è¿™ç§ä¸Š T çº§åˆ«çš„æ•°æ®ï¼Œç›´æ¥ç»™å±•ç¤ºç»™ç”¨æˆ·ä¸€é•¿ä¸²æ•°æ®éå¸¸æ²¡æœ‰å¯è¯»æ€§ï¼Œé€šè¿‡ format\_bytes å¯ä»¥å°†å­—èŠ‚æŒ‰æ•°é‡è‡ªåŠ¨è½¬æ¢ä¸ºåˆé€‚çš„å•ä½ (B/KB/MB/GB)ï¼š

    # @brief format size into B/KB/MB/GB according to bytes amount
    # @param size
    function format_bytes()
    {
        local size="$1"
        echo "${size}" | awk '{ if ($1 <= 1024) { print $1 " B" } else if ($1 <= 1024*1024) { print $1/1024 " KB" } else if ($1 <= 1024*1024*1024) { print $1/1024/1024 " MB"} else { print $1/1024/1024/1024 " GB"} }'
    }

è¿™æ˜¯ä¸€ä¸ªåŸºäº awk çš„å®ç°ã€‚é™¤äº†å­—èŠ‚å•ä½ï¼Œè¿˜æœ‰ä¸€äº›æ˜¯ç™¾åˆ†æ¯”ï¼Œå¦‚æœå¯¹å®ƒä»¬ä¹Ÿè¿›è¡Œè½¬æ¢å°±é—¹é”™è¯¯äº†ï¼Œå¯ä»¥åœ¨è¿™ç§å•ä½å‰ç»™ä¸€ä¸ªç©ºæ ¼æ¥é¿å…è¿™ç§è½¬æ¢ï¼Œä¾‹å¦‚ " %"ã€‚

æœ€ç»ˆçš„æ•ˆæœå¯ä»¥çœ‹ä¸‹é¢è¿™æ®µè¾“å‡ºï¼š

    $ sh fetch_iyuntu.sh -v '3.0.0.112' -p 'pc'
    request flow ok
    0:    2022011519    1487.74 GB
    1:    2022011520    1563.08 GB
    2:    2022011521    1636.64 GB
    3:    2022011522    1618.64 GB
    4:    2022011523    1443.26 GB
    5:    2022011600    1205.57 GB
    6:    2022011601    1096.95 GB
    7:    2022011602    905.025 GB
    8:    2022011603    654.045 GB
    9:    2022011604    482.283 GB
    10:    2022011605    391.029 GB
    11:    2022011606    355.738 GB
    12:    2022011607    390.631 GB
    13:    2022011608    589.954 GB
    14:    2022011609    827.38 GB
    15:    2022011610    1050.17 GB
    16:    2022011611    1242.52 GB
    17:    2022011612    1348.08 GB
    18:    2022011613    1405.8 GB
    19:    2022011614    1472.75 GB
    20:    2022011615    1492.5 GB
    pick a time to record (-1 to quit): 

è§‚å¯Ÿåˆ—è¡¨ï¼Œå‘ç°æ˜¨å¤©æ™šä¸Š 21 ç‚¹æ˜¯æµé‡é«˜å³°ï¼Œè¾“å…¥ç´¢å¼• 2 æ¥æ”¶é›†å¯¹åº”çš„æŒ‡æ ‡ (åœºæ™¯ä¸€)ï¼›åé¢å°±ä¸éœ€è¦ç”¨æˆ·å†é€‰æ‹©äº†ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åŒ¹é… 2022011521 çš„æ—¶åˆ»å»é€‰æ‹©å…¶å®ƒæŒ‡æ ‡æ•°æ® (åœºæ™¯ä¸‰)ï¼›å¦‚æœæŸä¸ªæŒ‡æ ‡çš„æ•°æ®åˆ—è¡¨æ²¡æœ‰ 2022011521 è¿™ä¸ªæ—¶åˆ»ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨åˆ—å‡ºæŒ‡æ ‡çš„å…¨éƒ¨æ—¶åˆ»ä¾›ç”¨æˆ·é‡æ–°é€‰æ‹© (åœºæ™¯äºŒ)ï¼Œä¸€èˆ¬æ˜¯ç”±äºåå°å‘ç‰ˆæ•°æ®ç¼ºå¤±äº† (æ•°æ®é‡å¤ªå¤§ç®—ä¸è¿‡æ¥ï¼Œå¶å°”å‘ç”Ÿ)ï¼Œä¸€èˆ¬è¾“å…¥ -1 é€€å‡ºè„šæœ¬é‡æ–°é€‰æ‹©ä¸€ä¸ªå…¶å®ƒæ—¶åˆ»å†è·‘ä¸€éã€‚

æŠŠä¸Šé¢çš„éƒ½ç»“åˆåœ¨ä¸€èµ·ï¼Œå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ‹‰å–å’Œè§£ææ€»æµé‡çš„è¿‡ç¨‹å•¦ï¼š

    # @param: starttime
    # @param: endtime
    # @param: version
    # @param: clienttype
    # @param: cookie
    # @param: select-time [option]
    function fetch_flow()
    {
        local starttime="$1"
        local endtime="$2"
        local version="$3"
        local clienttype="$4"
        local cookie="$5"
        local selecttime=""
        if [ $# -gt 5 ]; then 
            selecttime="$6"
        fi
    
        local data="start=${starttime}&end=${endtime}&method=p2pflow&version=${version}&vipLevel=all&clusterItem=cluster_hour&clientType=${clienttype}"
        curl -s "http://${HOST}/client/api/xxxxxxxxxxxx/" -H "Accept: */*" -H "Connection: keep-alive" -H "Content-Type: application/x-www-form-urlencoded; charset=UTF-8" -H "Accept-Encoding: gzip, deflate" -H "Origin: ${HOST}" -H "Referer: http://${HOST}/stability/main?typeName2=total_flow&typeName2=cluster_hour&typeName2=${clienttype}&datepicker0=${starttime}&datepicker1=${endtime}" -H "X-Requested-With: XMLHttpRequest" --cookie "$cookie"  -d "$data" --output temp.gzip
    
        if [ $? -eq 0 ]; then 
            echo "request flow ok"
            cat temp.gzip | gunzip > temp.txt
            # to see if 'null'
            if [ $? -eq 0 -a "$(head -c 4 temp.txt)" != "null" ]; then 
                jq -r '."æ€»æµé‡"[]|.[0],.[1]' temp.txt > data.txt
                pick_time "data.txt" "" "$selecttime"
            else 
                echo "null"
            fi
        else 
            echo "request flow failed"
        fi 
    }

å¢åŠ äº†ä»¥ä¸‹å†…å®¹ï¼š

*   å½“é€‰æ‹©çš„æ—¶é—´èŒƒå›´å†…æ²¡æœ‰ä»»ä½•æ•°æ®æ—¶ï¼Œtemp.txt å°†ä»…åŒ…å«å››ä¸ªå­—ç¬¦ï¼šnullï¼Œè¿™å¯ä»¥é€šè¿‡ head æˆªå–æ¥åˆ¤æ–­ï¼Œæ²¡æœ‰æ•°æ®æ—¶ç›´æ¥è¾“å‡º null å¹¶è·³è¿‡è¿™ä¸ªæŒ‡æ ‡çš„è·å–
*   jq è§£æ"æ€»æµé‡"ç»´åº¦å¹¶å°†æ•°æ®å†™å…¥ data.txt æ–‡ä»¶ä¸­
*   pick\_time ä» data.txt æ–‡ä»¶ä¸­è·å–æ•°æ®ï¼Œç”±äºç¬¬ä¸€æ¬¡è¯·æ±‚æ€»æµé‡ (version=pc-all) æ—¶ selecttime è¿˜ä¸ºç©ºï¼Œæ‰€ä»¥å®ƒä»…å±•ç¤ºåˆ—è¡¨ï¼Œå½“å®ƒè¿”å›åç”¨æˆ·å·²ç»é€‰å¥½äº†æ—¶åˆ»ï¼›å¦‚æœæ˜¯è¯·æ±‚ç‰ˆæœ¬æµé‡ (version=3.0.0.112) selecttime ä¸ä¸ºç©ºï¼Œå°†ç›´æ¥ä» data.txt ä¸­é€‰æ‹©å¯¹åº”æ—¶åˆ»çš„æ•°æ®å¹¶è®°å½•åœ¨ picked\_value ä¸­ï¼Œä¾›åé¢ä½¿ç”¨

è‡³æ­¤ï¼Œå®Œæˆäº†ç¬¬ä¸€ä¸ªæŒ‡æ ‡ä»æ‹‰å–æ•°æ®ã€è§£æå†…å®¹åˆ°è·å–æŒ‡æ ‡æ•°æ®çš„å…¨è¿‡ç¨‹ã€‚

è”æ¥èµ·æ¥
----

æœ‰äº†ç¬¬ä¸€ä¸ªï¼Œç¬¬äºŒã€ç¬¬ä¸‰â€¦â€¦å°±å®¹æ˜“å¤šäº†ï¼Œcopy & paste å†æ”¹æ”¹å°±è¡Œäº†ã€‚æ¥çœ‹ä¸‹è„šæœ¬ main å‡½æ•°æ˜¯å¦‚ä½•è”æ¥å¹¶é©±åŠ¨è¿™ä¸€åˆ‡çš„ï¼š

    function main()
    {
        local version=""
        local endtime=$(date +%s)
        local starttime=0
        local cookiefile="cookie.txt"
        local clienttype="android"
    
        #os="${OSTYPE/"darwin"//}"
        local OSTYPE=$(uname -s)
        local os="${OSTYPE/"Darwin"//}"
        if [ "$os" != "$OSTYPE" ]; then 
            # darwin: macos
            is_macos=1
        fi
    
        while getopts 'hv:p:s:e:c:' flag; do
            case "${flag}" in
                v) 
                    version="${OPTARG}" 
                    ;;
                p)
                    clienttype="${OPTARG}"
                    ;;
                s) 
                    if [ ${is_macos} -eq 1 ]; then 
                        # convert date as some format to stamp only supported on mac
                        starttime=$(date -j -f "%Y%m%d%H" "${OPTARG}" "+%s")
                    else 
                        # date on linux only recongnize date part..
                        # so: 2021090914 = 20210909 + 14 * 3600
                        starttime=$(date -d "$((${OPTARG}/100))" "+%s")
                        starttime=$((${starttime}+${OPTARG}%100*3600))
                    fi
    
                    if [ $? -ne 0 ]; then 
                        echo "convert starttime failed"
                        return 1
                    fi
                    ;;
                e) 
                    if [ ${is_macos} -eq 1 ]; then 
                        # convert date as some format to stamp only supported on mac
                        endtime=$(date -j -f "%Y%m%d%H" "${OPTARG}" "+%s")
                    else
                        # date on linux only recongnize date part..
                        # so: 2021090914 = 20210909 + 14 * 3600
                        endtime=$(date -d "$((${OPTARG}/100))" "+%s")
                        endtime=$((${endtime}+${OPTARG}%100*3600))
                    fi
    
                    if [ $? -ne 0 ]; then 
                        echo "convert endtime failed"
                        return 1
                    fi
                    ;;
                c) 
                    cookiefile="${OPTARG}" 
                    ;;
                h|*) 
                    echo "Usage: sh fetch_iyuntu.sh -v version [-h] [-s starttime(YYYYMMDDHH)] [-e endtime(YYYYMMDDHH)] [-c cookiefile] [-p platform]"
                    return 0
                    ;;
            esac
        done
    
        if [ -z "$version" ]; then 
            echo "no version specified"
            return 1
        fi
    
        echo "query data for platform: ${clienttype}"
        if [ $starttime -eq 0 ]; then 
            starttime=$(($endtime-86400))  # default 1 day ago
        fi
    
        echo "starttime: $starttime, endtime: $endtime"
        if [ "$endtime" -lt "$starttime" ]; then 
            echo "invalid start & end time"
            return 1
        fi
    
        if [ ! -f "${cookiefile}" ]; then 
            echo "cookie file not find: ${cookiefile}"
            return 1
        fi 
    
        local cookie=$(cat ${cookiefile})
        #echo "cookie: $cookie"
    
        # 1. fetch total flow first to determine time
        fetch_flow "$starttime" "$endtime" "${clienttype}-all" "${clienttype}" "$cookie"
        select_time="$picked_time"
        total_flow="$picked_value"
    
        # 2. fetch flow of that version
        fetch_flow "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "$select_time"
        version_flow="$picked_value"
    
        # 3. fetch slow speed ratio
        fetch_slow_speed "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" 
        slow_speed="$picked_value"
    
        # 4. fetch nat connectivity 
        fetch_nat_connectivity "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" 
        nat_connectivity="$picked_value"
    
        # 5. fetch total download speed, 0 - normal user
        fetch_total_download_speed "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "$select_time"
        total_download_speed_for_normal_user="$picked_value"
    
        # 6. fetch total download speed, 2 - svip user
        fetch_total_download_speed "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "$select_time"
        total_download_speed_for_svip_user="$picked_value"
    
        # 7. fetch vod result success, 0 - normal user
        fetch_vod_result_success "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "$select_time"
        vod_result_success_for_normal_user="$picked_value"
    
        # 8. fetch vod result success, 2 - svip user
        fetch_vod_result_success "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "$select_time"
        vod_result_success_for_svip_user="$picked_value"
    
        # 9. fetch vod p2p share ratio, 0 - normal user
        fetch_vod_p2p_share_ratio "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "$select_time"
        vod_p2p_share_ratio_for_normal_user="$picked_value"
    
        #10. fetch vod p2p share ratio, 2 - svip user
        fetch_vod_p2p_share_ratio "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "$select_time"
        vod_p2p_share_ratio_for_svip_user="$picked_value"
    
        if [ "${clienttype}" != "pc" ]; then 
            #11. fetch ts download speed, 0 - normal user
            fetch_ts_download_speed "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "$select_time"
            ts_download_speed_for_normal_user="$picked_value"
    
            #12. fetch ts download speed, 2 - svip user
            fetch_ts_download_speed "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "$select_time"
            ts_download_speed_for_svip_user="$picked_value"
    
            #13. fetch ts result success, 0 - normal user
            fetch_ts_result_success "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "$select_time"
            ts_result_success_for_normal_user="$picked_value"
    
            #14. fetch ts result success, 2 - svip user
            fetch_ts_result_success "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "$select_time"
            ts_result_success_for_svip_user="$picked_value"
    
            #15. fetch ts p2p share ratio, 0 - normal user, 3 - downloading
            fetch_ts_p2p_share_ratio "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "0" "3" "$select_time"
            ts_p2p_share_ratio_for_normal_user="$picked_value"
    
            #16. fetch ts p2p share ratio, 2 - svip user, 3 - downloading
            fetch_ts_p2p_share_ratio "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "3" "$select_time"
            ts_p2p_share_ratio_for_svip_user="$picked_value"
        else 
            # pc use ts playing share ratio instead of ts downloading
            #11. fetch ts p2p share ratio, 2 - svip user, 1 - playing
            fetch_ts_p2p_share_ratio "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "2" "1" "$select_time"
            ts_p2p_share_ratio_for_svip_user="$picked_value"
        fi
    
        #17. fetch ts flow ratio
        fetch_ts_play_flow "$starttime" "$endtime" "$version" "${clienttype}" "$cookie" "$select_time"
        local ts_play_flow_version="$picked_value"
        fetch_ts_play_flow "$starttime" "$endtime" "${clienttype}-all" "${clienttype}" "$cookie" "$select_time"
        local ts_play_flow_all="$picked_value"
        ts_play_flow_ratio=$(echo "${ts_play_flow_version},${ts_play_flow_all}" | awk -F',' '{print $1*100/$2}')
    
        print_statistic "${clienttype}"
    }

åšä¸ªç®€å•è¯´æ˜ï¼š

*   è„šæœ¬å¯ä»¥æ¥æ”¶ 6 ä¸ªå‚æ•°
    *   \-v versionï¼ŒæŒ‡å®šæ”¶é›†æ•°æ®æŒ‡æ ‡çš„ç‰ˆæœ¬
    *   \-p platformï¼ŒæŒ‡å®šæ”¶é›†æ•°æ®çš„ç«¯ï¼Œé»˜è®¤ä¸º androidï¼Œå¯ä»¥æŒ‡å®š pc æˆ–å…¶å®ƒç«¯
    *   \-e endtimeï¼ŒæŒ‡å®šç»“æŸæ—¶é—´ï¼Œæ ¼å¼ä¸º YYYYMMDDHHï¼Œç²¾ç¡®åˆ°å°æ—¶ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ºå½“å‰æ—¶é—´
    *   \-s starttimeï¼ŒæŒ‡å®šå¼€å§‹æ—¶é—´ï¼Œæ ¼å¼åŒä¸Šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ºç»“æŸæ—¶é—´å‰æ¨ 24 å°æ—¶
    *   \-c cookiefileï¼ŒæŒ‡å®š cookie å†…å®¹ï¼Œé»˜è®¤ä¸ºÂ  cookie.txt
    *   \-hï¼Œè¾“å‡º usage
    *   æ³¨ï¼šmac ä¸Šå¯ä»¥ç›´æ¥å°†å­—ç¬¦ä¸² YYYYMMDDHH è½¬æ¢ä¸º unix timeï¼›linux ä¸Šä¸èƒ½ï¼Œéœ€è¦ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥è½¬æ¢ä¸ºåˆ°æ—¥æœŸçš„æ—¶é—´æˆ³ï¼Œç¬¬äºŒæ­¥åŠ ä¸Šå°æ—¶æ•°
*   å®Œæ•´æ€§æ£€æŸ¥ï¼Œæ²¡æœ‰ç‰ˆæœ¬å·ã€cookie æ–‡ä»¶ã€ç»“æŸæ—¶é—´å°äºå¼€å§‹æ—¶é—´ç­‰éƒ½æ˜¯è‡´å‘½é”™è¯¯ï¼Œç›´æ¥é€€å‡º
*   fetch\_flow è·å–æ€»æµé‡ï¼Œè®°å½•ç”¨æˆ·é€‰æ‹©æ—¶é—´ (select\_time) å’Œæ€»æµé‡ (total\_flow)
*   åˆ†åˆ«è·å–å„ä¸ªåˆ†é‡
    *   fetch\_flow è·å–ç‰ˆæœ¬æµé‡ (version\_flow)
    *   fetch\_slow\_speed è·å–æ…¢é€Ÿæ¯” (slow\_speed)
    *   fetch\_nat\_connectivity è·å– NAT è¿é€šç‡ (nat\_connectivity)
    *   fetch\_total\_download\_speed åˆ†åˆ«è·å–æ™®é€š (total\_download\_speed\_for\_normal\_user) å’Œ svip ç”¨æˆ·æ€»é€Ÿåº¦ (total\_download\_speed\_for\_svip\_user)
    *   fetch\_vod\_result\_success åˆ†åˆ«è·å–æ™®é€š (vod\_result\_success\_for\_normal\_user) å’Œ svip ç”¨æˆ·åŸç”»ä¸‹è½½æˆåŠŸç‡ (vod\_result\_success\_for\_svip\_user)
    *   fetch\_vod\_p2p\_share\_ratio åˆ†åˆ«è·å–æ™®é€š (vod\_p2p\_share\_ratio\_for\_normal\_user) å’Œ svip ç”¨æˆ·åŸç”»ä¸‹è½½åˆ†äº«ç‡ (vod\_p2p\_share\_ratio\_for\_svip\_user)
    *   fetch\_ts\_download\_speed åˆ†åˆ«è·å–æ™®é€š (ts\_download\_speed\_for\_normal\_user) å’Œ svip ç”¨æˆ·è½¬ç ä¸‹è½½é€Ÿåº¦ (ts\_download\_speed\_for\_svip\_user)
    *   fetch\_ts\_result\_success åˆ†åˆ«è·å–æ™®é€š (ts\_result\_success\_for\_normal\_user) å’Œ svip ç”¨æˆ·è½¬ç ä¸‹è½½æˆåŠŸç‡ (ts\_result\_success\_for\_svip\_user)
    *   fetch\_ts\_p2p\_share\_ratio åˆ†åˆ«è·å–æ™®é€š (ts\_share\_ratio\_for\_normal\_user) å’Œ svip ç”¨æˆ·è½¬ç ä¸‹è½½åˆ†äº«ç‡ (ts\_share\_ratio\_for\_svip\_user)
    *   fetch\_ts\_play\_slow åˆ†åˆ«è·å–ç‰ˆæœ¬ (ts\_play\_flow\_version) å’Œæ€»çš„è½¬ç æ’­æ”¾æµé‡ (ts\_play\_flow\_all)ï¼Œæœ€åè®¡ç®—å‡ºè½¬ç æ’­æ”¾æµé‡å æ¯” (ts\_play\_flow\_ration)
    *   æ³¨ï¼špc ç«¯è½¬ç æŒ‡æ ‡åªæœ‰ svip è½¬ç æ’­æ”¾åˆ†äº«ç‡ (ts\_share\_ratio\_for\_svip\_user)
*   æœ€åæ‰“å°è·å–åˆ°çš„æŒ‡æ ‡æ•°æ® (print\_statistic)

åœ¨æ¯ä¸ª fetch\_xxx å‡½æ•°è·å–æŒ‡æ ‡æ•°æ®åéƒ½è·Ÿç€ä¸€ä¸ªèµ‹å€¼æ“ä½œï¼Œå°† pick\_value æ”¾å…¥å¯¹åº”çš„å…¨å±€å˜é‡ä¸­ï¼Œåœ¨æœ€åæ‰“å°æŒ‡æ ‡ä¿¡æ¯æ—¶ (print\_statistic) ä¼šç”¨åˆ°å®ƒä»¬ï¼š

    # @param: clienttype
    function print_statistic()
    {
        local clienttype="$1"
        local flow_ratio="0"
        local result_success="0"
        echo "======================================="
        echo "total flow:                       $(format_bytes ${total_flow})"
        echo "version flow:                     $(format_bytes ${version_flow})"
    
        # eat divided by zero error
        flow_ratio=$(echo "${version_flow},${total_flow}" | awk -F',' '{print $1*100/$2}' 2>/dev/null)
        echo "flow ratio:                       ${flow_ratio} %"
        echo "slow speed:                       ${slow_speed} %"
        echo "nat connectivity:                 ${nat_connectivity} %"
        echo "total download speed (normal)     $(format_bytes ${total_download_speed_for_normal_user})/s"
        echo "total download speed (svip)       $(format_bytes ${total_download_speed_for_svip_user})/s"
        result_success=$(echo "${vod_result_success_for_normal_user}" | awk '{print $1*100}')
        echo "vod result success (normal)       ${result_success} %"
        result_success=$(echo "${vod_result_success_for_svip_user}" | awk '{print $1*100}')
        echo "vod result success (svip)         ${result_success} %"
        echo "vod p2p share ratio (normal)      ${vod_p2p_share_ratio_for_normal_user} %"
        echo "vod p2p share ratio (svip)        ${vod_p2p_share_ratio_for_svip_user} %"
    
        # pc has vod downloading & ts playing & NO ts downloading
        if [ "${clienttype}" != "pc" ]; then 
            echo "ts download speed (normal)        $(format_bytes ${ts_download_speed_for_normal_user})/s"
            echo "ts download speed (svip)          $(format_bytes ${ts_download_speed_for_svip_user})/s"
            result_success=$(echo "${ts_result_success_for_normal_user}" | awk '{print $1*100}')
            echo "ts result success (normal)        ${result_success} %"
            result_success=$(echo "${ts_result_success_for_svip_user}" | awk '{print $1*100}')
            echo "ts result success (svip)          ${result_success} %"
            echo "ts p2p share ratio (normal)       ${ts_p2p_share_ratio_for_normal_user} %"
            echo "ts p2p share ratio (svip)         ${ts_p2p_share_ratio_for_svip_user} %"
        else 
            echo "ts play share ratio (svip)        ${ts_p2p_share_ratio_for_svip_user} %"
        fi
    
        echo "ts play flow ratio                ${ts_play_flow_ratio} %"
    }

è¿™ä¸ªå‡½æ•°è¿˜è´Ÿè´£è®¡ç®—ç‰ˆæœ¬æµé‡å æ¯”ï¼Œæ³¨æ„è¿™é‡Œé‡‡ç”¨äº† awk æ¥è¿›è¡Œæµ®ç‚¹è¿ç®—ï¼Œshell å†…å»ºçš„è¿ç®—åªæ”¯æŒæ•´å‹ã€‚

æœ€åæ¥çœ‹ä¸‹è¿è¡Œæ•ˆæœå§ï¼š

    =======================================
    total flow:                       1636.64 GB
    version flow:                     xxxx.xx GB
    flow ratio:                       xx.xxxx %
    slow speed:                       x.xxxxx %
    nat connectivity:                 xx.xxxx %
    total download speed (normal)     x.xxxxx MB/s
    total download speed (svip)       xx.xxxx MB/s
    vod result success (normal)       xx.xxxx %
    vod result success (svip)         xx.xxxx %
    vod p2p share ratio (normal)      xx.xx %
    vod p2p share ratio (svip)        xx.xx %
    ts play share ratio (svip)        xx.xx %
    ts play flow ratio                xx.xxxx %

è‡ªä»æœ‰äº†è¿™ä¸ªè„šæœ¬ï¼Œå¡«ä¸ªç°åº¦å‘ç‰ˆæŒ‡æ ‡å°±æ˜¯åˆ†åˆ†é’Ÿçš„äº‹å„¿äº†ï¼Œç¨‹åºå‘˜çš„æ•ˆç‡åˆæœ‰æå‡ï¼ŒèŠ‚çº¦ä¸‹çš„æ—¶é—´åˆå¯ä»¥æ„‰å¿«çš„æ‘¸é±¼äº†~

ç»“è¯­
--

æœ¬æ–‡ä»‹ç»äº†ä¸€ç§ä½¿ç”¨ shell è„šæœ¬è‡ªåŠ¨è·å–å‘ç‰ˆæŒ‡æ ‡æ•°æ®çš„æ–¹æ³•ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š

*   curl åŸºäºæµè§ˆå™¨ cookie è®¿é—® web æœåŠ¡å™¨è·å–æŒ‡æ ‡æ•°æ®
*   jq è§£æå¤æ‚ json æ ¼å¼æ•°æ®
*   pick\_time ä» key-value åˆ—è¡¨ä¸­æå–æŸä¸ªæ—¶åˆ»çš„æŒ‡æ ‡å€¼

å…¶ä¸­ç¬¬äºŒç‚¹åˆæ˜¯å…³é”®ä¸­çš„å…³é”®ï¼Œä¹‹å‰ä¹Ÿç”¨ jq åšè¿‡ json æ•°æ®çš„è§£æï¼Œä½†å¤„ç†è¿™æ ·å¤æ‚çš„ json å½¢å¼è¿˜æ˜¯å¤´ä¸€é­ï¼Œå½“æ—¶å·®ç‚¹å°±åœ¨è¿™é‡Œå¡å£³äº†ï¼Œå¯¹ jq è¯­æ³•è¿˜éœ€è¦ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹ï¼Œä¸ç„¶é‡åˆ°æ›´å¤æ‚çš„æ•°æ®å½¢å¼ï¼Œå¯èƒ½åˆè¦å¡å£³ ğŸ˜‚ã€‚

è¯´ä¸€ä¸‹å·¥å…·ä¸æ•ˆç‡çš„é—®é¢˜ï¼Œåœ¨æ¯”è¾ƒå¼ºè°ƒæµç¨‹çš„å…¬å¸å¹²æ´»ï¼Œä¸æ–­åœ¨å·¥ä½œä¸­ç§¯ç´¯ä¸€äº›å·¥å…·ã€è„šæœ¬æ˜¯éå¸¸å¿…è¦çš„ï¼Œä¸ç„¶éšç€å·¥ä½œé‡çš„åŠ ç ï¼Œä¸ªäººç²¾åŠ›ä¼šè¢«æ¶ˆè€—åœ¨æ—¥å¸¸é‡å¤å·¥ä½œä¸­ï¼Œå¯¼è‡´æ•ˆç‡é™ä½ã€‚åŒæ ·ä¸€ä»¶äº‹ï¼Œåˆšå…¥èŒæ—¶èŠ±ä¸€ä¸ªå°æ—¶æå®šï¼Œå…¥èŒå‡ å¹´äº†è¿˜éœ€è¦å·®ä¸å¤šçš„æ—¶é—´æ¥æå®šï¼Œç»å¯¹éœ€è¦è€ƒè™‘ä¸‹æœ‰æ²¡æœ‰ä¼˜åŒ–ç©ºé—´ã€‚æŠŠä¸€äº›æµç¨‹åŒ–çš„ã€å¯è‡ªåŠ¨åŒ–çš„å·¥ä½œæç‚¼å‡ºæ¥ç”¨è„šæœ¬ã€å·¥å…·å®Œæˆï¼Œä¼šæå¤§çš„èŠ‚çº¦æ—¶é—´ã€ä¿è¯å‡†ç¡®æ€§å¹¶å°†æ³¨æ„åŠ›é›†ä¸­äºè¯¥é›†ä¸­çš„åœ°æ–¹ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„å·¥æ¬²å–„å…¶äº‹ã€å¿…å…ˆåˆ©å…¶å™¨å§ã€‚

åè®°
--

è¿™ä¸ªè„šæœ¬æ€»ä½“ä¸Šå·²ç»å¾ˆæ–¹ä¾¿äº†ï¼Œç¾ä¸­ä¸è¶³çš„åœ°æ–¹æ˜¯å‰é¢æåˆ°çš„è·å–æµè§ˆå™¨ cookieï¼Œå¦‚ä½•è‡ªåŠ¨ç™»å½• web å¹¶è®°å½• cookieï¼Ÿè¿™ä¸ªæˆ‘åˆæœ‰ä¸€ç³»åˆ—æ¢ç´¢ï¼Œåé¢ä¼šå†™æˆä¸€ç¯‡å•ç‹¬çš„æ–‡ç« åˆ†äº«å‡ºæ¥ã€‚

å‚è€ƒ
--

\[1\]. [Shellï¼šjq å¾ªç¯ json å¯¹è±¡, jq å¾ªç¯ json æ•°ç»„, jq ç”¨æ³•å®è·µ, jq converts a JSON object to key=value, jq parses one field from an JSON array into bash array](https://justcode.ikeepstudying.com/2018/02/shell%ef%bc%9ajq-%e5%be%aa%e7%8e%af-json-%e5%af%b9%e8%b1%a1-jq-%e5%be%aa%e7%8e%af-json-%e6%95%b0%e7%bb%84-jq-converts-json-object-keyvalue-jq-parses-one-field-json-array-bash-arr/)

\[2\].Â [shellç¼–ç¨‹å­¦ä¹ ä¹‹ä½¿ç”¨jqå¯¹jsonæå–](https://www.cnblogs.com/nul1/p/12228785.html)

\[3\].Â [linuxå·¥å…·ä¹‹jq](https://developer.aliyun.com/article/743533)

\[4\]. mac dateå‘½ä»¤

\[5\].Â Linux dateå‘½ä»¤æ—¶é—´æˆ³å’Œæ—¶é—´ä¹‹é—´çš„è½¬æ¢

\[6\]. linux shellå®ç°éšæœºæ•°å¤šç§æ–¹æ³•ï¼ˆdate,random,uuid)