---
layout: post
title: "åˆ¶ä½œ Python Docker é•œåƒçš„æœ€ä½³å®è·µ"
date: "2022-12-15T04:21:01.297Z"
---
åˆ¶ä½œ Python Docker é•œåƒçš„æœ€ä½³å®è·µ
========================

![](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221215103330357-2027299824.png)

æ¦‚è¿°
--

> ğŸ“šï¸**Reference**:
> 
> [åˆ¶ä½œå®¹å™¨é•œåƒçš„æœ€ä½³å®è·µ](https://ewhisper.cn/posts/8023/)

è¿™ç¯‡æ–‡ç« æ˜¯å…³äºåˆ¶ä½œ Python Docker å®¹å™¨é•œåƒçš„æœ€ä½³å®è·µã€‚(2022 å¹´ 12 æœˆæ›´æ–°ï¼‰  
æœ€ä½³å®è·µçš„ç›®çš„ä¸€æ–¹é¢æ˜¯ä¸ºäº†å‡å°é•œåƒä½“ç§¯ï¼Œæå‡ DevOps æ•ˆç‡ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸ºäº†æé«˜å®‰å…¨æ€§ã€‚å¸Œæœ›å¯¹å„ä½æœ‰æ‰€å¸®åŠ©ã€‚

é€šç”¨ Docker å®¹å™¨é•œåƒæœ€ä½³å®è·µ
------------------

è¿™é‡Œä¹Ÿå†æ¬¡ç½—åˆ—ä¸€ä¸‹å¯¹ Python Docker é•œåƒä¹Ÿé€‚ç”¨çš„ä¸€äº›é€šç”¨æœ€ä½³å®è·µã€‚

*   ä½¿ç”¨ `LABEL maintainer`
*   æ ‡è®°é‡è¦ç«¯å£
*   è®¾ç½®ç¯å¢ƒå˜é‡
*   ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨è¿›ç¨‹
*   ä½¿ç”¨ `.dockerignore` æ’é™¤æ— å…³æ–‡ä»¶

### Python é•œåƒæ¨èè®¾ç½®çš„ç¯å¢ƒå˜é‡

Python ä¸­æ¨èçš„å¸¸è§ç¯å¢ƒå˜é‡å¦‚ä¸‹ï¼š

    # è®¾ç½®ç¯å¢ƒå˜é‡
    ENV PYTHONDONTWRITEBYTECODE 1
    ENV PYTHONUNBUFFERED 1
    

1.  `ENV PYTHONDONTWRITEBYTECODE 1`: å»ºè®®æ„å»º Docker é•œåƒæ—¶ä¸€ç›´ä¸º `1`, é˜²æ­¢ python å°† pyc æ–‡ä»¶å†™å…¥ç¡¬ç›˜
2.  `ENV PYTHONUNBUFFERED 1`: å»ºè®®æ„å»º Docker é•œåƒæ—¶ä¸€ç›´ä¸º `1`, é˜²æ­¢ python ç¼“å†² (buffering) stdout å’Œ stderr, ä»¥ä¾¿æ›´å®¹æ˜“åœ°è¿›è¡Œå®¹å™¨æ—¥å¿—è®°å½•
3.  âŒä¸å†å»ºè®®ä½¿ç”¨ `ENV DEBUG 0` ç¯å¢ƒå˜é‡ï¼Œæ²¡å¿…è¦ã€‚

### ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨è¿›ç¨‹

å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæ¨èè¿è¡Œ Python ç¨‹åºå‰ï¼Œåˆ›å»º é root ç”¨æˆ·å¹¶åˆ‡æ¢åˆ°è¯¥ç”¨æˆ·ã€‚

    # åˆ›å»ºä¸€ä¸ªå…·æœ‰æ˜ç¡® UID çš„é root ç”¨æˆ·ï¼Œå¹¶å¢åŠ è®¿é—® /app æ–‡ä»¶å¤¹çš„æƒé™ã€‚
    RUN adduser -u 5678 --disabled-password --gecos "" appuser && chown -R appuser /app
    USER appuser
    

### ä½¿ç”¨ `.dockerignore` æ’é™¤æ— å…³æ–‡ä»¶

éœ€è¦æ’é™¤çš„æ— å…³æ–‡ä»¶ä¸€èˆ¬å¦‚ä¸‹ï¼š

    **/__pycache__
    **/*venv
    **/.classpath
    **/.dockerignore
    **/.env
    **/.git
    **/.gitignore
    **/.project
    **/.settings
    **/.toolstarget
    **/.vs
    **/.vscode
    **/*.*proj.user
    **/*.dbmdl
    **/*.jfm
    **/bin
    **/charts
    **/docker-compose*
    **/compose*
    **/Dockerfile*
    **/node_modules
    **/npm-debug.log
    **/obj
    **/secrets.dev.yaml
    **/values.dev.yaml
    *.db
    .python-version
    LICENSE
    README.md
    

è¿™é‡Œé€‰æ‹©å‡ ä¸ªè¯´æ˜ä¸‹ï¼š

1.  `**/__pycache__`: python ç¼“å­˜ç›®å½•
2.  `**/*venv`: Python è™šæ‹Ÿç¯å¢ƒç›®å½•ã€‚å¾ˆå¤š Python å¼€å‘ä¹ æƒ¯å°†è™šæ‹Ÿç¯å¢ƒç›®å½•åˆ›å»ºåœ¨é¡¹ç›®ä¸‹ï¼Œä¸€èˆ¬å‘½åä¸ºï¼š`.venv` æˆ– `venv`
3.  `**/.env`: Python ç¯å¢ƒå˜é‡æ–‡ä»¶
4.  `**/.git` `**/.gitignore`: git ç›¸å…³ç›®å½•å’Œæ–‡ä»¶
5.  `**/.vscode`: ç¼–è¾‘å™¨ã€IDE ç›¸å…³ç›®å½•
6.  `**/charts`: Helm Chart ç›¸å…³æ–‡ä»¶
7.  `**/docker-compose*`: docker compose ç›¸å…³æ–‡ä»¶
8.  `*.db`: å¦‚æœä½¿ç”¨ sqllite çš„ç›¸å…³æ•°æ®åº“æ–‡ä»¶
9.  `.python-version`: pyenv çš„ .python-version æ–‡ä»¶

ä¸å»ºè®®ä½¿ç”¨ Alpine ä½œä¸º Python çš„åŸºç¡€é•œåƒ
----------------------------

ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå¤§å¤šæ•° Linux å‘è¡Œç‰ˆä½¿ç”¨ GNU ç‰ˆæœ¬ï¼ˆglibcï¼‰çš„æ ‡å‡† C åº“ï¼Œå‡ ä¹æ¯ä¸ª C ç¨‹åºéƒ½éœ€è¦è¿™ä¸ªåº“ï¼ŒåŒ…æ‹¬ Pythonã€‚ä½†æ˜¯ Alpine Linux ä½¿ç”¨ musl, Alpine ç¦ç”¨äº† Linux wheel æ”¯æŒã€‚

ç†ç”±å¦‚ä¸‹ï¼š

*   ç¼ºå°‘å¤§é‡ä¾èµ–
    *   CPython è¯­è¨€è¿è¡Œæ—¶çš„ç›¸å…³ä¾èµ–
    *   openssl ç›¸å…³ä¾èµ–
    *   libffi ç›¸å…³ä¾èµ–
    *   gcc ç›¸å…³ä¾èµ–
    *   æ•°æ®åº“é©±åŠ¨ç›¸å…³ä¾èµ–
    *   pip ç›¸å…³ä¾èµ–
*   æ„å»ºå¯èƒ½æ›´è€—æ—¶
    *   Alpine Linux ä½¿ç”¨ muslï¼Œä¸€äº›äºŒè¿›åˆ¶ wheel æ˜¯é’ˆå¯¹ glibc ç¼–è¯‘çš„ï¼Œä½†æ˜¯ Alpine ç¦ç”¨äº† Linux wheel æ”¯æŒã€‚ç°åœ¨å¤§å¤šæ•° Python åŒ…éƒ½åŒ…æ‹¬ PyPI ä¸Šçš„äºŒè¿›åˆ¶ wheelï¼Œå¤§å¤§åŠ å¿«äº†å®‰è£…æ—¶é—´ã€‚ä½†æ˜¯å¦‚æœä½ ä½¿ç”¨ Alpine Linuxï¼Œä½ å¯èƒ½éœ€è¦ç¼–è¯‘ä½ ä½¿ç”¨çš„æ¯ä¸ª Python åŒ…ä¸­çš„æ‰€æœ‰ C ä»£ç ã€‚
*   åŸºäº Alpine æ„å»ºçš„ Python é•œåƒåè€Œå¯èƒ½æ›´å¤§
    *   ä¹ä¸€å¬ä¼¼ä¹è¿åå¸¸è¯†ï¼Œä½†æ˜¯ä»”ç»†ä¸€æƒ³ï¼Œå› ä¸ºä¸Šé¢ç½—åˆ—çš„åŸå› ï¼Œç¡®å®ä¼šå¯¼è‡´é•œåƒæ›´å¤§çš„æƒ…å†µã€‚

> ğŸ“šï¸**Reference:**
> 
> [Using Alpine can make Python Docker builds 50Ã— slower (pythonspeed.com)](https://pythonspeed.com/articles/alpine-docker-python/)

è¿™é‡Œä»¥è¿™ä¸ª [Demo FastAPI Python ç¨‹åº](https://github.com/east4ming/fastapi-url-shortener) ä¸ºä¾‹ï¼Œå…¶åŸºäº Alpine çš„ Dockerfile åœ°å€æ˜¯è¿™ä¸ªï¼š[https://github.com/east4ming/fastapi-url-shortener/blob/main/Dockerfile.alpine](https://github.com/east4ming/fastapi-url-shortener/blob/main/Dockerfile.alpine)

å› ä¸ºç¼ºå°‘å¾ˆå¤šä¾èµ–ï¼Œæ‰€ä»¥åœ¨ç”¨ pip å®‰è£…ä¹‹å‰ï¼Œå°±éœ€è¦å°½å¯èƒ½å…¨åœ°å®‰è£…ç›¸å…³ä¾èµ–ï¼š

    RUN set -eux \
        && apk add --no-cache --virtual .build-deps build-base \
        openssl-dev libffi-dev gcc musl-dev python3-dev \
        && pip install --upgrade pip setuptools wheel \
        && pip install --upgrade -r /app/requirements.txt \
        && rm -rf /root/.cache/pip
    

è¿™é‡Œä¹Ÿå±•ç¤ºä¸€ä¸‹åŸºäº Alpine æ„å»ºå®Œæˆåçš„ é•œåƒæœªå‹ç¼©å¤§å°ï¼š

![åŸºäº Alpine çš„ Python Demo é•œåƒå¤§å°ï¼š472 MB](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221215103330835-1103341190.png)

â–³ åŸºäº Alpine çš„ Python Demo é•œåƒå¤§å°ï¼š472 MB; ç›¸æ¯”ä¹‹ä¸‹ï¼ŒåŸºäº slim çš„åªæœ‰ 189 MB

åœ¨ä¸Šé¢ä»£ç çš„è¿™ä¸€æ­¥ï¼Œå°±å ç”¨äº†å¤ªå¤šç©ºé—´ï¼š

> ğŸ¤”**æ€è€ƒ**:
> 
> å¯èƒ½ä¸Šé¢ä¸€æ®µå¯ä»¥ç²¾ç®€ï¼Œä½†æ˜¯è¦åˆ¤æ–­å¯¹äºå“ªä¸ª Python é¡¹ç›®ï¼Œå¯ä»¥ç²¾ç®€å“ªäº›åŒ…ï¼Œå®åœ¨æ˜¯å¤ªéš¾äº†ã€‚

    + apk add --no-cache --virtual .build-deps build-base openssl-dev libffi-dev gcc musl-dev python3-dev
    fetch https://dl-cdn.alpinelinux.org/alpine/v3.17/main/x86_64/APKINDEX.tar.gz
    fetch https://dl-cdn.alpinelinux.org/alpine/v3.17/community/x86_64/APKINDEX.tar.gz
    (1/28) Installing libgcc (12.2.1_git20220924-r4)
    (2/28) Installing libstdc++ (12.2.1_git20220924-r4)
    (3/28) Installing binutils (2.39-r2)
    (4/28) Installing libmagic (5.43-r0)
    (5/28) Installing file (5.43-r0)
    (6/28) Installing libgomp (12.2.1_git20220924-r4)
    (7/28) Installing libatomic (12.2.1_git20220924-r4)
    (8/28) Installing gmp (6.2.1-r2)
    (9/28) Installing isl25 (0.25-r0)
    (10/28) Installing mpfr4 (4.1.0-r0)
    (11/28) Installing mpc1 (1.2.1-r1)
    (12/28) Installing gcc (12.2.1_git20220924-r4)
    (13/28) Installing libstdc++-dev (12.2.1_git20220924-r4)
    (14/28) Installing musl-dev (1.2.3-r4)
    (15/28) Installing libc-dev (0.7.2-r3)
    (16/28) Installing g++ (12.2.1_git20220924-r4)
    (17/28) Installing make (4.3-r1)
    (18/28) Installing fortify-headers (1.1-r1)
    (19/28) Installing patch (2.7.6-r8)
    (20/28) Installing build-base (0.5-r3)
    (21/28) Installing pkgconf (1.9.3-r0)
    (22/28) Installing openssl-dev (3.0.7-r0)
    (23/28) Installing linux-headers (5.19.5-r0)
    (24/28) Installing libffi-dev (3.4.4-r0)
    (25/28) Installing mpdecimal (2.5.1-r1)
    (26/28) Installing python3 (3.10.9-r1)
    (27/28) Installing python3-dev (3.10.9-r1)
    (28/28) Installing .build-deps (20221214.074929)
    Executing busybox-1.35.0-r29.trigger
    OK: 358 MiB in 65 packages
    ...
    

å»ºè®®ä½¿ç”¨å®˜æ–¹çš„ python slim é•œåƒä½œä¸ºåŸºç¡€é•œåƒ
----------------------------

ç»§ç»­ä¸Šé¢ï¼Œæ‰€ä»¥æˆ‘æ˜¯å»ºè®®ï¼šä½¿ç”¨å®˜æ–¹çš„ python slim é•œåƒä½œä¸ºåŸºç¡€é•œåƒ

é•œåƒåº“æ˜¯è¿™ä¸ªï¼š[https://hub.docker.com/\_/python](https://hub.docker.com/_/python)

å¹¶ä¸”ä½¿ç”¨ `python:<version>-slim` ä½œä¸ºåŸºç¡€é•œåƒï¼Œèƒ½ç”¨ `python:<version>-slim-bullseye` ä½œä¸ºåŸºç¡€é•œåƒæ›´å¥½ï¼ˆå› ä¸ºæ›´æ–°ï¼Œç›¸å¯¹å°±æ›´å®‰å…¨ä¸€äº›ï¼‰.

è¿™ä¸ªé•œåƒä¸åŒ…å«é»˜è®¤æ ‡ç­¾ä¸­çš„å¸¸ç”¨åŒ…ï¼ŒåªåŒ…å«è¿è¡Œ python æ‰€éœ€çš„æœ€å°åŒ…ã€‚è¿™ä¸ªé•œåƒæ˜¯åŸºäº Debian çš„ã€‚

ä½¿ç”¨å®˜æ–¹ python slim çš„ç†ç”±è¿˜åŒ…æ‹¬ï¼š

*   ç¨³å®šæ€§
*   å®‰å…¨å‡çº§æ›´åŠæ—¶
*   ä¾èµ–æ›´æ–°æ›´åŠæ—¶
*   ä¾èµ–æ›´å…¨
*   Python ç‰ˆæœ¬å‡çº§æ›´åŠæ—¶
*   é•œåƒæ›´å°

> ğŸ“šï¸**Reference:**
> 
> [The best Docker base image for your Python application (Sep 2022) (pythonspeed.com)](https://pythonspeed.com/articles/base-image-python-docker-images/)

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPython é•œåƒæ„å»ºä¸éœ€è¦ä½¿ç”¨"å¤šé˜¶æ®µæ„å»º"
-----------------------------

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPython é•œåƒæ„å»ºä¸éœ€è¦ä½¿ç”¨"å¤šé˜¶æ®µæ„å»º".

ç†ç”±å¦‚ä¸‹ï¼š

*   Python æ²¡æœ‰åƒ Golang ä¸€æ ·ï¼Œå¯ä»¥æŠŠæ‰€æœ‰ä¾èµ–æ‰“æˆä¸€ä¸ªå•ä¸€çš„äºŒè¿›åˆ¶åŒ…
*   Python ä¹Ÿæ²¡æœ‰åƒ Java ä¸€æ ·ï¼Œå¯ä»¥åœ¨ JDK ä¸Šæ„å»ºï¼Œåœ¨ JRE ä¸Šè¿è¡Œ
*   Python å¤æ‚è€Œæ•£è½çš„ä¾èµ–å…³ç³»ï¼Œåœ¨"å¤šé˜¶æ®µæ„å»º"æ—¶ä¼šå¢åŠ å¤æ‚åº¦
*   ...

å¦‚æœæœ‰ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œå¯ä»¥å°è¯•ä½¿ç”¨"å¤šé˜¶æ®µæ„å»º"å‹ç¼©é•œåƒä½“ç§¯ï¼š

*   æ„å»ºé˜¶æ®µéœ€è¦å®‰è£…ç¼–è¯‘å™¨
*   Python é¡¹ç›®å¤æ‚ï¼Œç”¨åˆ°äº†å…¶ä»–è¯­è¨€ä»£ç ï¼ˆå¦‚ C/C++/Rust)

pip å°æŠ€å·§
-------

ä½¿ç”¨ pip å®‰è£…ä¾èµ–æ—¶ï¼Œå¯ä»¥æ·»åŠ  `--no-cache-dir` å‡å°‘é•œåƒä½“ç§¯ï¼š

    # å®‰è£… pip ä¾èµ–
    COPY requirements.txt .
    RUN python -m pip install --no-cache-dir --upgrade -r requirements.txt
    

Python Dockerfile æœ€ä½³å®è·µæ ·ä¾‹
------------------------

æœ€å, å°±æ˜¯åŸºäºä»¥ä¸Šæœ€ä½³å®è·µçš„å®Œæ•´æ ·ä¾‹, ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œæ‰¾åˆ°: [https://github.com/east4ming/fastapi-url-shortener/blob/main/Dockerfile.slim](https://github.com/east4ming/fastapi-url-shortener/blob/main/Dockerfile.slim)

    FROM python:3.10-slim
    
    LABEL maintainer="cuikaidong@foxmail.com"
    
    EXPOSE 8000
    
    # Keeps Python from generating .pyc files in the container
    ENV PYTHONDONTWRITEBYTECODE=1
    
    # Turns off buffering for easier container logging
    ENV PYTHONUNBUFFERED=1
    
    # Install pip requirements
    COPY requirements.txt .
    RUN python -m pip install --no-cache-dir --upgrade -r requirements.txt
    
    WORKDIR /app
    COPY . /app
    
    # Creates a non-root user with an explicit UID and adds permission to access the /app folder
    RUN adduser -u 5678 --disabled-password --gecos "" appuser && chown -R appuser /app
    USER appuser
    
    CMD ["uvicorn", "shortener_app.main:app", "--host", "0.0.0.0"]
    
    

æ€»ç»“
--

åˆ¶ä½œ Python Docker å®¹å™¨é•œåƒçš„æœ€ä½³å®è·µã€‚æœ€ä½³å®è·µçš„ç›®çš„ä¸€æ–¹é¢æ˜¯ä¸ºäº†å‡å°é•œåƒä½“ç§¯ï¼Œæå‡ DevOps æ•ˆç‡ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä¸ºäº†æé«˜å®‰å…¨æ€§.

æœ€ä½³å®è·µå¦‚ä¸‹:

*   æ¨è 2 ä¸ª Python çš„ç¯å¢ƒå˜é‡
    *   `ENV PYTHONDONTWRITEBYTECODE 1`
    *   `ENV PYTHONUNBUFFERED 1`
*   ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œå®¹å™¨è¿›ç¨‹
*   ä½¿ç”¨ `.dockerignore` æ’é™¤æ— å…³æ–‡ä»¶
*   ä¸å»ºè®®ä½¿ç”¨ Alpine ä½œä¸º Python çš„åŸºç¡€é•œåƒ
*   å»ºè®®ä½¿ç”¨å®˜æ–¹çš„ python slim é•œåƒä½œä¸ºåŸºç¡€é•œåƒ
*   ä¸€èˆ¬æƒ…å†µä¸‹, Python é•œåƒæ„å»ºä¸éœ€è¦ä½¿ç”¨"å¤šé˜¶æ®µæ„å»º"
*   pip å°æŠ€å·§: `--no-cache-dir`

å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©.

æœ€åä¹Ÿæ„Ÿå¹ä¸€ä¸‹, åœ¨äº‘åŸç”Ÿæ—¶ä»£, python åœ¨åˆ†å‘è¿™å—, ç‰¹åˆ«æ˜¯é•œåƒæ„å»ºè¿™å—, ç¡®å®ä½“éªŒã€æ•ˆç‡ã€é•œåƒå¤§å°ç­‰æ–¹é¢å·® golang å¤ªå¤šäº†ã€‚ğŸ˜­ğŸ˜­ğŸ˜­

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [Using Alpine can make Python Docker builds 50Ã— slower (pythonspeed.com)](https://pythonspeed.com/articles/alpine-docker-python/)
*   [The best Docker base image for your Python application (Sep 2022) (pythonspeed.com)](https://pythonspeed.com/articles/base-image-python-docker-images/)
*   [Multi-stage builds #2: Python specifics (pythonspeed.com)](https://pythonspeed.com/articles/multi-stage-docker-python/)
*   [åˆ¶ä½œå®¹å™¨é•œåƒçš„æœ€ä½³å®è·µ - ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ (ewhisper.cn)](https://ewhisper.cn/posts/8023/)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.