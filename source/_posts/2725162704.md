---
layout: post
title: "【Azure Redis 缓存】 Python连接Azure Redis, 使用redis.ConnectionPool 出现 "ConnectionResetError: [Errno 104] Connection reset by peer""
date: "2022-05-11T14:18:16.299Z"
---
【Azure Redis 缓存】 Python连接Azure Redis, 使用redis.ConnectionPool 出现 "ConnectionResetError: \[Errno 104\] Connection reset by peer"
==============================================================================================================================

问题描述
====

Python连接Azure Redis, 使用redis.ConnectionPool 出现 "ConnectionResetError: \[Errno 104\] Connection reset by peer" "ConnectionResetError: \[WinError 10054\] An existing connection was forcibly closed by the remote host" 

Traceback (most recent call last):
  File "C:\\Users\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\redis\\connection.py", line 748, in read\_response
    response \= self.\_parser.read\_response()
  File "C:\\Users\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\redis\\connection.py", line 318, in read\_response
    raw \= self.\_buffer.readline()
  File "C:\\Users\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\redis\\connection.py", line 250, in readline
    self.\_read\_from\_socket()
  File "C:\\Users\\AppData\\Local\\Programs\\Python\\Python310\\lib\\site-packages\\redis\\connection.py", line 192, in \_read\_from\_socket
    data \= self.\_sock.recv(socket\_read\_size)
ConnectionResetError: \[WinError 10054\] An existing connection was forcibly closed by the remote host

During handling of the above exception, another exception occurred:
... ... 

连接出错的Python代码为：

import redis

redis\_params \= {
    'host': 'redis-xxxxxx.redis.cache.chinacloudapi.cn',
    'port': 6380,
    'db': 1,
    'password': 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx=',
    'timeout': 5000,
    'ssl': True
}

print('\-----Try # 2------: Redis 使用连接池 ')

print('connected to redis by connection pool ...')
pool \= redis.ConnectionPool( host=redis\_params\['host'\], port=redis\_params\['port'\], db=redis\_params\['db'\], password=redis\_params\['password'\], max\_connections=20)
conn\_pool \= redis.Redis(connection\_pool=pool, socket\_timeout=redis\_params\['timeout'\], ssl=redis\_params\['ssl'\], health\_check\_interval=30)


conn\_pool.set('test03', 'Value 结果显示在此')
data \= conn\_pool.get('test03').decode()
print(data)

print('Connection Pool use Successful')

而在不使用 **ConnectionPool** 的情况下，是能够正常连接的。

print('\-----Try # 1------: Redis 没有使用连接池的情况下: ')
conn \= redis.Redis(host=redis\_params\['host'\], port=redis\_params\['port'\], db=redis\_params\['db'\], password=redis\_params\['password'\], ssl=redis\_params\['ssl'\], socket\_timeout=redis\_params\['timeout'\])
print('connected to redis')
conn.set('test', 'the normal value to set ')
print('set done .... ')

问题解答
====

根据redis.py的源码查看，使用redis.Redis 当ssl为True时，构造函数中为 connection\_class参数 初始化值为 SSLConnection。 而ConnectionPool的构造函数中默认使用的是 connection\_class=Connection。

redis.Redis
-----------

![](https://img2022.cnblogs.com/blog/2127802/202205/2127802-20220511202557588-335948955.png)
--------------------------------------------------------------------------------------------

redis.ConnectionPool
--------------------

![](https://img2022.cnblogs.com/blog/2127802/202205/2127802-20220511202443150-706694566.png)

根据以上分析，要解决Python Redis使用Connection Pool连接，只需要在创建Connection Pool对象时候，为Connection\_class对象赋值为SSLConnection。

修改后的代码为：
--------

import redis

from redis.connection import SSLConnection

redis\_params \= {
    'host': 'redis-xxxxxx.redis.cache.chinacloudapi.cn',
    'port': 6380,
    'db': 1,
    'password': 'xxxxxxxxxxxxxxxxxxx=',
    'timeout': 5000,
    'ssl': True
}

print('\-----Try # 1------: Redis 没有使用连接池的情况下: ')
conn \= redis.Redis(host=redis\_params\['host'\], port=redis\_params\['port'\], db=redis\_params\['db'\], password=redis\_params\['password'\], ssl=redis\_params\['ssl'\], socket\_timeout=redis\_params\['timeout'\])
print('connected to redis')
conn.set('test', 'the normal value to set ')
print('set done .... ')

data \= conn.get('test').decode()
print(str(data))

print('\-----Try # 2------: Redis 使用连接池 ')

print('connected to redis by connection pool ...')
pool \= redis.ConnectionPool(connection\_class= SSLConnection, host=redis\_params\['host'\], port=redis\_params\['port'\], db=redis\_params\['db'\], password=redis\_params\['password'\], max\_connections=20)
conn\_pool \= redis.Redis(connection\_pool=pool, socket\_timeout=redis\_params\['timeout'\], ssl=redis\_params\['ssl'\], health\_check\_interval=30)


conn\_pool.set('test03', 'Value 结果显示在此')
data \= conn\_pool.get('test03').decode()
print(data)

print('Connection Pool use Successful')

for i in range(1,10):
    conn\_pool\_1 \= redis.Redis(connection\_pool=pool, socket\_timeout=redis\_params\['timeout'\], ssl=redis\_params\['ssl'\], health\_check\_interval=30)
    conn\_pool\_1.set('test\_test\_\_'+str(i), 'use conn pool to set value.......')
    print(conn\_pool\_1.client)
 

clist \= conn\_pool.client\_list()
for c in clist:
    print(c)

PS: 添加黄色高亮部分即可。

整体演示动画如下：
---------

![](https://img2022.cnblogs.com/blog/2127802/202205/2127802-20220511204055971-393871917.gif)

_\[END\]_

### 参考资料

无

当在复杂的环境中面临问题，格物之道需：浊而静之徐清，安以动之徐生。 云中，恰是如此!