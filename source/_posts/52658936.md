---
layout: post
title: "redis集群的三种方式"
date: "2022-07-24T14:16:45.319Z"
---
redis集群的三种方式
============

Redis三种集群方式：主从复制，哨兵模式，Cluster集群。

主从复制
====

![](https://img2022.cnblogs.com/blog/1977373/202207/1977373-20220724154444591-655450825.png)

**基本原理**
--------

当新建立一个从服务器时，从服务器将向主服务器发送SYNC命令，接收到SYNC命令后的主服务器会进行一次BGSAVE命令，在执行期间，会将所有命令写入缓冲区中，当BGSAVE命令执行完毕之后会将生成的RDB文件发送给从服务器，从服务器使用这个文件加载数据到内存中，之后主服务器会以Redis命令协议的格式将缓冲区的命令发送给从服务器。此后每次主服务执行命令都会同步给从服务器。即使有多个从服务器向主服务器发送SYNC命令，主服务器也只会执行一个BGSAVE命令，就可以处理接下来的同步请求。一个主服务器可以拥有多个从服务器，而从服务器也可拥有从服务器，从而形成一个图状结构，复制功能不会阻塞主服务器，即使有一个或多个同步请求，主服务器依然能处理命令请求。

持久化开关
-----

当配置了主从复制模式时需要开启主服务器的持久化功能，如果将主服务器的持久化功能关闭，主服务器一旦重启，所有从服务器的数据将会丢失，即使配置了Sentinel模式，如果主服务器自动拉起进程比较快，以至于在Sentinel模式下还未选举出新的主服务器，主服务的启动也会造成子服务器的数据丢失。

配置
--

配置一个主从复制模式，只需要使用Slaveof命令即可，在conf配置文件中添加或者是在redis中执行命令。

SLAVEOF host port 

哨兵模式
====

![](https://img2022.cnblogs.com/blog/1977373/202207/1977373-20220724164515478-1464982463.png)

基本原理
----

Redis的Sentinel系统用于管理多个Redis，主要执行以下三件事：

监控：Sentinel会不断的检查主从服务器运行状态

提醒：当某个Redis服务器出现故障，可通过API或者其他应用程序发送通知

自动故障迁移：当一个主服务器不能正常工作时，Sentinel会进行一次故障自动迁移，会将失效主服务器的从服务器选举出一个新的主服务器，剩下的从服务器将会自动连接复制选举出来的新服务器的数据。

Redis的Sentinel系统是一个分布式的系统，可以在系统中配置一个或多个Sentinel。

启动
--

使用redis-sentinel启动

redis-sentinel sentinel.confy

也可以使用redis-server来启动

redis-server sentinel.conf --sentinelyy

以上两种方式都可以启动sentinel，启动sentinel必须指定配置文件，否则无法启动：

![](https://img2022.cnblogs.com/blog/1977373/202207/1977373-20220724160006712-1439111013.png)

配置
--

一个sentinel.conf文件最少需要一句配置：

sentinel monitor mymaster 127.0.0.1 6379 2

监视一个别名叫做mymaster的主机，地址是127.0.0.1，端口是6379，将这个主服务器判断为失效至少需要2个sentinel同意。

无论设置多少个sentinel同意判断一个主服务器的失效，都需要系统中多个Sentinel支持才能进行故障迁移，而只有少数sentinel正常运行的时候，是无法进行故障迁移。

故障迁移
----

当一个Sentinel发现主服务器下线时，称为主观下线，只有多个Sentinel都发现主服务下线，并相互之间通过命令进行交流判断主服务器下线时，称为客观下线。只有对主服务器进行客观下线时，会选举出领头Sentinel，选举出之后，会进行新的主服务器投票选举，选举出一个从服务器升级为主服务器。并向被选中的从服务器发送Slaveof no one命令，让其变为主服务器，通过发布订阅的功能，将新的配置广播给其他Sentinel进行更新，并向下线的主服务器发送Slaveof命令，让其复制新的主服务器，当所有从服务器都已经开始复制新的主服务器时，领头Sentinel终止本次故障迁移。

> 当一个 Redis 实例被重新配置是，无论是被设置成主服务器、从服务器、又或者被设置成其他主服务器的从服务器 ，Sentinel 都会向被重新配置的实例发送一个 `CONFIG REWRITE` 命令， 从而确保这些配置会持久化在硬盘里。

Cluster集群
=========

![](https://img2022.cnblogs.com/blog/1977373/202207/1977373-20220724170117198-1340046172.png)

之前的主从复制，哨兵模式都难以再现扩容，而Redis cluster集群实现了对Redis的水平扩容，即启动N个Redis节点，每个节点又可以有自己的从服务器，将数据均匀分布的存储在这N个结点上，每个节点存储数据的1/N。Redis cluster集群就是一个可以在多个Redis节点之间进行数据共享的设施；Redis cluster集群采用的是无中心化配置，即节点A无法处理，会将请求转发只节点B进行处理。

键分布模型
-----

Redis集群中的键空间被分割为16384个槽位。每个主节点负责16384中槽位的一部分，Redis使用CRC16 算法进行槽位分配。为了保证高可用，cluster模式也引入了主从复制模式，一个主节点对应一个或多个从节点，当主节点发生宕机时，可进行故障转移，将子节点升级为主节点。

配置cluster集群
-----------

Redis 集群由多个运行在集群模式（cluster mode）下的 Redis 实例组成， 实例的集群模式需要通过配置来开启，以下是一个包含了最少选项的集群配置文件示例：

port 7000
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
appendonly yes

cluster-enabled：打开集群模式  
cluster-config-file：节点配置文件名，无须人为修改， 它由 Redis 集群在启动时创建， 并在有需要时自动进行更新  
cluster-node-timeout：节点失联时间，当超过此毫秒，集群将自动切换主从节点。

要让集群正常运作至少需要三个主节点，而每个主节点都应该正确配置一个或者多个从节点。

启动集群
----

使用redis-cli --cluster create命令将节点合并成一个集群

redis-cli --cluster create --cluster-replicas 1  127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005

　--cluster-replicas 1 这个指的是从机的数量，表示我们希望为集群中的每个主节点创建一个从节点。

进入集群模式只需要使用redis-cli -c命令

redis-cli -c -p 7000

　　无中心话节点，所以进入任意一个端口号的主节点即可。