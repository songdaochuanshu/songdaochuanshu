---
layout: post
title: "MySQL空间暴涨150G导致锁定，发生了什么"
date: "2022-12-08T09:16:16.169Z"
---
MySQL空间暴涨150G导致锁定，发生了什么
=======================

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124138138-472752997.png)

**背景**
------

12月1号中午突然收到大量报警，某客户环境操作数据库大量失败，报错信息如下图所示：

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124211098-139367341.png)

这个报错我是第一次见，一时间有点无所适从，但是从字面意思来看是MySQL目前处于LOCK\_WRITE\_GROWTH状态，拒绝执行当前的语句，一定是MySQL出问题了。

**初定位**
-------

我随即登录阿里云控制台查看MySQL是否有什么异常，果不其然运行状态那里提示“**锁定中（空间不足）**”，我根据提示链接简单阅读了阿里云关于锁定状态的解释说明以及处理措施。

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124259381-1449727170.png)

 以下为阿里云官方内容截取，想了解更多细节的请前往推荐阅读部分第一个链接。

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124314751-640572076.png)

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124320824-1669873184.png)

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124332604-1343491661.png)

 虽说事有蹊跷，但是为了快速恢复服务，来不及深思，立即删除了一部分日志型数据，释放出来10个G左右的空间，几分钟以后数据库状态正常。

**剥茧抽丝**
--------

服务恢复以后我们兵分两路，一方面联系客户扩容数据库，10G估计撑不了多长时间；另一方面我开始剥茧抽丝般的寻找程序上可能的bug，比如新上了什么功能导致存储过多的数据诸如此类。

通过阿里云监控发现11月30的存储空间占用只有300G，到了第二天中午瞬间增长了150G左右，这很不正常，感觉一定是程序的bug，询问一番以后发现昨晚并没有发版，难道是个历史bug？

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124403291-1295081185.png)

 怎么揪出这个bug呢，我首先寻找阿里云控制台是否有表粒度的空间变化趋势图，找了一圈没找到，只有整体空间的变化趋势，似乎对排查不利，但其中一个细节引起了我的注意，请看下图。

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124617249-1249230858.png)

 已总空间≠数据空间+临时空间+日志空间，有150G左右的空间被狗吃了？带着问题我又找到了另一张监控，可以初步解释那150G去哪了。

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124630715-209427208.png)

这张图中多出来一个“mysql.other.size”，有157G左右，和上面被狗吃掉的150多G高度吻合，成功引起了我的注意，但mysql.other.size到底所谓何物？

**真相**
------

接下来我提工单给阿里云工程师询问这一情况，一起看看专业人士的解答。

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124654520-1523429257.png)

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124659224-699775894.png)

慢查居然还能导致数据库空间满，也算是弥补了我数据库知识的又一片空白。

看下官网的一篇“RDS MySQL临时文件导致实例磁盘空间满且出现“锁定中”状态”的相关描述（推荐阅读第二个链接）。

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124709905-1811994426.png)

 ![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124716879-34047394.png)

事后我们重启了数据库，临时表空间释放出来150G，随即叫停了扩容。

接下来需要清理一波慢查，避免悲剧再次发生。

**推荐阅读**
--------

https://help.aliyun.com/document\_detail/410115.html?spm=5176.19907426.help.108.7bba1450IcmI9j

https://help.aliyun.com/document\_detail/101763.html?spm=5176.19907426.help.11.7bba1450IcmI9j#concept-nqk-bh3-3gb

![](https://img2023.cnblogs.com/blog/846817/202212/846817-20221208124750656-632727818.png)