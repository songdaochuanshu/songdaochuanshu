---
layout: post
title: "vue2.0 åŒå‘ç»‘å®šåŸç†åˆ†æåŠç®€å•å®ç°"
date: "2022-07-04T08:25:12.406Z"
---
vue2.0 åŒå‘ç»‘å®šåŸç†åˆ†æåŠç®€å•å®ç°

Vueç”¨äº†æœ‰ä¸€æ®µæ—¶é—´äº†ï¼Œæ¯å½“æœ‰äººé—®åˆ°VueåŒå‘ç»‘å®šæ˜¯æ€ä¹ˆå›äº‹çš„æ—¶å€™ï¼Œæ€»æ˜¯ä¸èƒ½ç»™å¤§å®¶è§£é‡Šçš„å¾ˆæ¸…æ¥šï¼Œæ­£å¥½æœ€è¿‘æœ‰æ—¶é—´æŠŠå®ƒæ¢³ç†ä¸€ä¸‹ï¼Œè®©è‡ªå·±ç†è§£çš„æ›´æ¸…æ¥šï¼Œä¸‹æ¬¡æœ‰äººé—®æˆ‘çš„æ—¶å€™ï¼Œå¯ä»¥ä¾ƒä¾ƒè€Œè°ˆğŸ˜„ã€‚

ä¸€ã€**é¦–å…ˆä»‹ç»Object.defineProperty()æ–¹æ³•**
-----------------------------------

    //ç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å±æ€§ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡
    Object.defineProperty(obj,prop,descriptor)
    

#### å‚æ•°

*   obj éœ€è¦å®šä¹‰å±æ€§çš„å¯¹è±¡ã€‚
*   prop éœ€è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§åã€‚
*   descriptor éœ€è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„æè¿°ç¬¦ã€‚

### 1.1 å±æ€§æè¿°ç¬¦é»˜è®¤å€¼

å±æ€§

é»˜è®¤å€¼

è¯´æ˜

configurable

false

æè¿°å±æ€§æ˜¯å¦å¯ä»¥è¢«åˆ é™¤ï¼Œé»˜è®¤ä¸º false

enumerable

false

æè¿°å±æ€§æ˜¯å¦å¯ä»¥è¢«for...inæˆ–Object.keysæšä¸¾ï¼Œé»˜è®¤ä¸º false

writable

false

æè¿°å±æ€§æ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼Œé»˜è®¤ä¸º false

get

undefined

å½“è®¿é—®å±æ€§æ—¶è§¦å‘è¯¥æ–¹æ³•ï¼Œé»˜è®¤ä¸ºundefined

set

undefined

å½“å±æ€§è¢«ä¿®æ”¹æ—¶è§¦å‘è¯¥æ–¹æ³•ï¼Œé»˜è®¤ä¸ºundefined

value

undefined

å±æ€§å€¼ï¼Œé»˜è®¤ä¸ºundefined

    // Object.defineProperty(å¯¹è±¡ï¼Œå±æ€§ï¼Œå±æ€§æè¿°ç¬¦)
        var obj={}
        console.log('obj:',obj);
    
        Object.defineProperty(obj, 'name', {
            value: 'James'
        });
    
        console.log('objçš„é»˜è®¤å€¼:',obj);
        delete obj.name;
        console.log('objåˆ é™¤å:', obj);
        console.log('objæšä¸¾:', Object.keys(obj));
        obj.name = 'åº“é‡Œ';
        console.log('objä¿®æ”¹å:', obj);
        Object.defineProperty(obj, 'name', {value: 'åº“é‡Œ'});
    

è¿è¡Œç»“æœï¼š

![image-20220625163934226](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdk79umxj20q00cmjst.jpg)

ä»è¿è¡Œç»“æœå¯ä»¥å‘ç°ï¼Œä½¿ç”¨Object.defineProperty()å®šä¹‰çš„å±æ€§ï¼Œé»˜è®¤æ˜¯ä¸å¯ä»¥è¢«ä¿®æ”¹ï¼Œä¸å¯ä»¥è¢«æšä¸¾ï¼Œä¸å¯ä»¥è¢«åˆ é™¤çš„ã€‚å¯ä»¥ä¸å¸¸è§„çš„æ–¹å¼å®šä¹‰å±æ€§å¯¹æ¯”ä¸€ä¸‹ï¼šå¦‚æœä¸ä½¿ç”¨Object.defineProperty()å®šä¹‰çš„å±æ€§ï¼Œé»˜è®¤æ˜¯å¯ä»¥ä¿®æ”¹ã€æšä¸¾ã€åˆ é™¤çš„ï¼š

     const obj = {};
     obj.name = 'James';
     console.log('æšä¸¾ï¼š', Object.keys(obj));
     obj.name = ' åº“é‡Œ';
     console.log('ä¿®æ”¹ï¼š', obj);
     delete obj.name;
     console.log('åˆ é™¤ï¼š', obj);
    

è¿è¡Œç»“æœï¼š

![image-20220625164719361](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdkdsiwgj21bm08gdgc.jpg)

### 1.2 ä¿®æ”¹å±æ€§æè¿°ç¬¦

    const o = {};
      Object.defineProperty(o, 'name', {
        value: 'James',        // nameå±æ€§å€¼
        writable: true,       // å¯ä»¥è¢«ä¿®æ”¹
        enumerable: true,     // å¯ä»¥è¢«æšä¸¾
        configurable: true,   // å¯ä»¥è¢«åˆ é™¤
      });
      console.log(o);
      console.log('æšä¸¾ï¼š', Object.keys(o));
      o.name = 'ç§‘æ¯”';
      console.log('ä¿®æ”¹ï¼š', o);
      Object.defineProperty(o, 'name', {
        value: 'Po'
      });
      console.log('ä¿®æ”¹ï¼š', o);
      delete o.name;
      console.log('åˆ é™¤ï¼š', o);
    

è¿è¡Œç»“æœï¼š

![image-20220628145317071](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdkhlqrrj21ce080aam.jpg)

ç»“æœè¡¨æ˜ï¼Œä¿®æ”¹writableã€enumerableã€configurableè¿™ä¸‰ä¸ªæè¿°ç¬¦ä¸ºtrueæ—¶ï¼Œå±æ€§å¯ä»¥è¢«ä¿®æ”¹ã€æšä¸¾å’Œåˆ é™¤ã€‚

**æ³¨æ„ï¼š**

1ã€**å¦‚æœwritableä¸ºfalseï¼Œconfigurableä¸ºtrueæ—¶ï¼Œé€šè¿‡o.name = "ç§‘æ¯”"æ˜¯æ— æ³•ä¿®æ”¹æˆåŠŸçš„ï¼Œä½†æ˜¯ä½¿ç”¨Object.defineProperty()ä¿®æ”¹æ˜¯å¯ä»¥æˆåŠŸçš„**

2ã€**å¦‚æœwritableå’Œconfigurableéƒ½ä¸ºfalseæ—¶ï¼Œå¦‚æœä½¿ç”¨Object.defineProperty()ä¿®æ”¹å±æ€§å€¼ä¼šæŠ¥é”™ï¼šCannot redefine property: name**

### 1.3 enumerable

    const o = {};
    Object.defineProperty(o, 'name', { value: 'James', enumerable: true });
    Object.defineProperty(o, 'contact', { value: (str) => { return str+' baby' }, enumerable: false });
    Object.defineProperty(o, 'age', { value: '18' });
    o.skill = 'å‰ç«¯';
    console.log('æšä¸¾ï¼š', Object.keys(o));
    console.log('trim: ', o.contact('nihao'))
    console.log(`o.propertyIsEnumerable('name'): `, o.propertyIsEnumerable('name'));
    console.log(`o.propertyIsEnumerable('contact'): `, o.propertyIsEnumerable('contact'));
    console.log(`o.propertyIsEnumerable('age'): `, o.propertyIsEnumerable('age'));
    

è¿è¡Œç»“æœï¼š

![image-20220628151547662](https://tva1.sinaimg.cn/large/e6c9d24ely1h3upcghtfvj21ji06iab1.jpg)

### 1.4 getå’Œset

**æ³¨ï¼šè®¾ç½®setæˆ–è€…getï¼Œå°±ä¸èƒ½åœ¨è®¾ç½®valueå’Œwriableï¼Œå¦åˆ™ä¼šæŠ¥é”™**

    const o = {
        __email: ''
      };
      Object.defineProperty(o, 'email', {
        enumerable: true,
        configurable: true,
        // writable: true,    // å¦‚æœè®¾ç½®äº†getæˆ–è€…setï¼Œwritableå’Œvalueå±æ€§å¿…é¡»æ³¨é‡Šæ‰
        // value: '',         // writableå’Œvalueæ— æ³•ä¸setå’Œgetå…±å­˜
        get: function () {    // å¦‚æœè®¾ç½®äº†get æˆ–è€… set å°±ä¸èƒ½è®¾ç½®writableå’Œvalue
          console.log('get', this);
          return 'My email is ' + this.__email;
        },
        set: function (newVal) {
          console.log('set', newVal);
          this.__email = newVal;
        }
      });
      console.log(o);
      o.email = 'laowang@163.com';
      o.email;
      console.log(o);
      o.email = 'laozhang@163.com';
      console.log(o);
    

è¿è¡Œç»“æœï¼š

![image-20220628153012733](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdkn5vvsj21iq07oab2.jpg)

äºŒã€**åŸç†åˆ†æ**
----------

### 2.1 æœ€ç®€å•çš„åŒå‘ç»‘å®š

    <!DOCTYPE html>
    <head>
        <title>æœ€ç®€å•çš„åŒå‘ç»‘å®š</title>
    </head>
    <body>
        <div>
            <input type="text" name="name" id="name" />
        </div>
    </body>
    <script>
        var data={
            __name:''
        };
    
        Object.defineProperty(data,'name',{
            enumerable: true,
            configurable: true,
            // writable: true,    // å¦‚æœè®¾ç½®äº†getæˆ–è€…setï¼Œwritableå’Œvalueå±æ€§å¿…é¡»æ³¨é‡Šæ‰
            // value: '',         // writableå’Œvalueæ— æ³•ä¸setå’Œgetå…±å­˜
            get: function () {    // å¦‚æœè®¾ç½®äº†get æˆ–è€… set å°±ä¸èƒ½è®¾ç½®writableå’Œvalue
                return this.__name;
            },
            set: function (newVal) {
                this.__name=newVal;                                //æ›´æ–°å±æ€§
                document.querySelector('#name').value = newVal;    //æ›´æ–°è§†å›¾
            }
        });
    		
      	//ç›‘å¬inputäº‹ä»¶ï¼Œæ›´æ–°name
        document.querySelector('#name').addEventListener("input",(event)=>{
            data.name=event.currentTarget.value
        })
    
    </script>
    </html>
    

è¿è¡Œç»“æœï¼š

![image-20220628164512054](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdkrxmtaj21380fkq3w.jpg)

æ–‡æœ¬æ¡†è¾“å…¥"è€ç‹"ï¼ŒæŸ¥çœ‹nameå±æ€§å˜ä¸º"è€ç‹"ï¼›ä¿®æ”¹nameå±æ€§ä¸º"è€å¼ "ï¼Œæ–‡æœ¬æ¡†å˜ä¸ºâ€œè€å¼ â€ï¼›

æœ€ç®€å•çš„åŒå‘ç»‘å®šå®Œæˆäº†ğŸ˜Š

### 2.2 VueåŒå‘ç»‘å®š

vue.js åˆ™æ˜¯é‡‡ç”¨æ•°æ®åŠ«æŒç»“åˆå‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼çš„æ–¹å¼ï¼Œé€šè¿‡Object.defineProperty()æ¥åŠ«æŒå„ä¸ªå±æ€§çš„setterï¼Œgetterï¼Œåœ¨æ•°æ®å˜åŠ¨æ—¶å‘å¸ƒæ¶ˆæ¯ç»™è®¢é˜…è€…ï¼Œè§¦å‘ç›¸åº”çš„ç›‘å¬å›è°ƒã€‚è¯»å®Œè¿™å¥è¯æ˜¯ä¸æ˜¯è¿˜æœ‰50%çš„æ‡µé€¼ï¼Œæ¥ä¸‹æ¥ç»§ç»­åˆ†æã€‚

åŒå‘ç»‘å®šçš„ç»å…¸ç¤ºä¾‹å›¾ï¼Œå„ä½ç»†å“ï¼š

![image-20220628165953973](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdkyf214j21d80r2adj.jpg)

åˆ†ææ¯ä¸ªæ¨¡å—çš„ä½œç”¨ï¼š

Observerï¼šæ•°æ®ç›‘å¬å™¨ï¼Œå¯¹æ¯ä¸ªvueçš„dataä¸­å®šä¹‰çš„å±æ€§å¾ªç¯ç”¨Object.defineProperty()å®ç°æ•°æ®åŠ«æŒï¼Œä»¥ä¾¿åˆ©ç”¨å…¶ä¸­çš„setterå’Œgetterï¼Œç„¶åé€šçŸ¥è®¢é˜…è€…ï¼Œè®¢é˜…è€…ä¼šè§¦å‘å®ƒçš„updateæ–¹æ³•ï¼Œå¯¹è§†å›¾è¿›è¡Œæ›´æ–°

Compileï¼šæŒ‡ä»¤è§£æå™¨ï¼Œå¯¹æ¯ä¸ªå…ƒç´ èŠ‚ç‚¹çš„æŒ‡ä»¤è¿›è¡Œæ‰«æå’Œè§£æï¼Œæ ¹æ®æŒ‡ä»¤æ¨¡æ¿æ›¿æ¢æ•°æ®ï¼Œä»¥åŠç»‘å®šç›¸åº”çš„æ›´æ–°å‡½æ•°

Watcherï¼šä½œä¸ºè¿æ¥Observerå’ŒCompileçš„æ¡¥æ¢ï¼Œèƒ½å¤Ÿè®¢é˜…å¹¶æ”¶åˆ°æ¯ä¸ªå±æ€§å˜åŠ¨çš„é€šçŸ¥ï¼Œæ‰§è¡ŒæŒ‡ä»¤ç»‘å®šçš„ç›¸åº”å›è°ƒå‡½æ•°ï¼Œä»è€Œæ›´æ–°è§†å›¾

Depï¼šä¾èµ–æ”¶é›†ï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªä¾èµ–æ”¶é›†å¯¹è±¡ï¼Œå­˜å‚¨è®¢é˜…è¯¥å±æ€§çš„Watcher

Updaterï¼šæ›´æ–°è§†å›¾

### **ç»“åˆåŸç†ï¼Œè‡ªå®šä¹‰å®ç°Vueçš„åŒå‘ç»‘å®š**

**1ã€é¦–å…ˆåˆ›å»ºindex.html**

    <!DOCTYPE html>
    <html lang="en">
    <head>
      <meta charset="UTF-8">
      <title>2.0åŒå‘ç»‘å®šåŸç†</title>
      <script src="./Dep.js"></script>
      <script src="./MYVM.js"></script>
      <script src="./Observer.js"></script>
      <script src="./Watcher.js"></script>
      <script src="./TemplateCompiler.js"></script>
    </head>
    
    <body>
      <div id="app">
        <!--æ¨¡æ‹ŸvueæŒ‡ä»¤ç»‘å®šnameå±æ€§ -->
        <span v-text="name"></span>
        <!--æ¨¡æ‹ŸvueæŒ‡ä»¤v-modelåŒå‘ç»‘å®š -->
        <input type="text" v-model="name">
        <!-- æ¨¡æ‹Ÿ{{}} -->
        {{name}}
      </div>
      <script>
        //å‡è®¾å·²ç»æœ‰MYVMå¯¹è±¡ï¼Œå®ä¾‹åŒ–è¯¥å¯¹è±¡
        //paramsæ˜¯ä¸€ä¸ªå¯¹è±¡ elæ˜¯è¦æŒ‚è½½çš„dom  dataæ˜¯ä¸€ä¸ªå¯¹è±¡åŒ…å«å“åº”å¼å±æ€§
        var vm = new MYVM({
          el: '#app',
          data: {
            name: 'James'
          }
        })
      </script>
    </body>
    </html>
    

**2ã€åˆ›å»ºMYVM.jsï¼Œä¸»è¦ä½œç”¨æ˜¯è°ƒç”¨Observerè¿›è¡Œæ•°æ®åŠ«æŒå’Œè°ƒç”¨TemplateCompilerè¿›è¡Œæ¨¡æ¿è§£æ**

    function MYVM(options){
         //å±æ€§åˆå§‹åŒ–
         this.$vm=this;
         this.$el=options.el;
         this.$data=options.data;
         
         //è§†å›¾å¿…é¡»å­˜åœ¨
         if(this.$el){
            //æ·»åŠ å±æ€§è§‚å¯Ÿå¯¹è±¡ï¼ˆå®ç°æ•°æ®æŒŸæŒï¼‰
            new Observer(this.$data)
            //åˆ›å»ºæ¨¡æ¿ç¼–è¯‘å™¨ï¼Œæ¥è§£æè§†å›¾
            this.$compiler = new TemplateCompiler(this.$el, this.$vm)
        }
    
    }
    

**3ã€åˆ›å»ºObserver.jsï¼Œå®ç°æ•°æ®åŠ«æŒ**

    //æ•°æ®è§£æï¼Œå®Œæˆå¯¹æ•°æ®å±æ€§çš„åŠ«æŒ
    function Observer(data){
        //åˆ¤æ–­dataæ˜¯å¦æœ‰æ•ˆä¸”dataå¿…é¡»æ˜¯å¯¹è±¡
        if(!data || typeof data !=='object' ){
            return
        }else{
            var keys=Object.keys(data)
            keys.forEach((key)=>{
                this.defineReactive(data,key,data[key])
            })
        }
    }
    Observer.prototype.defineReactive=function(obj,key,val){
        Object.defineProperty(obj,key,{
            //æ˜¯å¦å¯éå†
            enumerable: true,
            //æ˜¯å¦å¯åˆ é™¤
            configurable: false,
    
            //å–å€¼
            get(){
                return val
            },
            //ä¿®æ”¹å€¼
            set(newVal){
                val=newVal
            }
        })
    }
    

ä¸Šé¢ä»£ç å®Œæˆäº†æ•°æ®å±æ€§çš„åŠ«æŒï¼Œè¯»å–å’Œä¿®æ”¹å±æ€§ä¼šæ‰§è¡Œgetã€setï¼Œè¿è¡Œç»“æœï¼š

![image-20220629133722605](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qdl488xjj210s08swev.jpg)

**4ã€ç»™Observer.jså¢åŠ è®¢é˜…å’Œå‘å¸ƒåŠŸèƒ½ï¼Œæ–°å»ºDep.jsï¼Œè¿›è¡Œè®¢é˜…å’Œå‘å¸ƒç®¡ç†**

    //åˆ›å»ºè®¢é˜…å‘å¸ƒè€…
    //1.ç®¡ç†è®¢é˜…
    //2.é›†ä½“é€šçŸ¥
    function Dep(){
        this.subs=[];
    }
    
    //æ·»åŠ è®¢é˜…
    //å‚æ•°subæ˜¯watcherå¯¹è±¡
    Dep.prototype.addSub=(sub)=>{
        this.subs.push(sub)
    }
    
    //é›†ä½“é€šçŸ¥ï¼Œæ›´æ–°è§†å›¾
    Dep.prototype.notify=()=>{
        this.subs.forEach((sub) => {
            sub.update()
          })
    }
    

**5ã€æŠŠDepå®‰è£…åˆ°Observer.jsï¼Œä»£ç å¦‚ä¸‹**

    //æ•°æ®è§£æï¼Œå®Œæˆå¯¹æ•°æ®å±æ€§çš„åŠ«æŒ
    function Observer(data){
        //åˆ¤æ–­dataæ˜¯å¦æœ‰æ•ˆä¸”dataå¿…é¡»æ˜¯å¯¹è±¡
        if(!data || typeof data !=='object' ){
            return
        }else{
            var keys=Object.keys(data)
            keys.forEach((key)=>{
                this.defineReactive(data,key,data[key])
            })
        }
    }
    Observer.prototype.defineReactive=function(obj,key,val){
        //åˆ›å»ºDepå®ä¾‹
        var dep=new Dep();
        Object.defineProperty(obj,key,{
            //æ˜¯å¦å¯éå†
            enumerable: true,
            //æ˜¯å¦å¯åˆ é™¤
            configurable: false,
    
            //å–å€¼
            get(){
                //watcheråˆ›å»ºæ—¶ï¼Œå®Œæˆè®¢é˜…
                //æ£€æŸ¥targetæ˜¯å¦æœ‰watcherï¼Œæœ‰çš„è¯è¿›è¡Œè®¢é˜…
                var watcher = Dep.target;
                watcher && dep.addSub(watcher)
                return val
            },
            //ä¿®æ”¹å€¼
            set(newVal){
                val=newVal
                dep.notify()
            }
        })
    }
    

var dep=new Dep() åˆ›å»ºäº†Depçš„å®ä¾‹

getçš„æ—¶å€™æ£€æŸ¥æ˜¯å¦æœ‰watcherï¼Œæœ‰å°±æ·»åŠ åˆ°è®¢é˜…æ•°ç»„

setçš„æ—¶å€™é€šçŸ¥æ‰€æœ‰çš„è®¢é˜…è€…ï¼Œè¿›è¡Œè§†å›¾æ›´æ–°

**è‡³æ­¤å±æ€§æ•°æ®åŠ«æŒï¼Œè®¢é˜…å’Œå‘å¸ƒå°±å·²ç»å®ç°å®Œäº†**

**6ã€æ¥ä¸‹æ¥å®ç°æ¨¡æ¿ç¼–è¯‘å™¨ï¼Œé¦–å…ˆåˆ›å»ºTemplateCompiler.js**

    // åˆ›å»ºæ¨¡æ¿ç¼–è¯‘å·¥å…·
    // el è¦ç¼–è¯‘çš„domèŠ‚ç‚¹
    // vm MYVMçš„å½“å‰å®ä¾‹
    function TemplateCompiler(el,vm){
        this.el = this.isElementNode(el) ? el : document.querySelector(el);
        this.vm = vm;
        if (this.el) {
            //å°†å¯¹åº”èŒƒå›´çš„htmlæ”¾å…¥å†…å­˜fragment
            var fragment = this.node2Fragment(this.el)
            //ç¼–è¯‘æ¨¡æ¿
            this.compile(fragment)
            //å°†æ•°æ®æ”¾å›é¡µé¢
            this.el.appendChild(fragment)
          }
    }
    
    //æ˜¯å¦æ˜¯å…ƒç´ èŠ‚ç‚¹
    TemplateCompiler.prototype.isElementNode=function(node){
        return node.nodeType===1
    }
    
    //æ˜¯å¦æ˜¯æ–‡æœ¬èŠ‚ç‚¹
    TemplateCompiler.prototype.isTextNode=function(node){
        return node.nodeType===3
    }
    
    //è½¬æˆæ•°ç»„
    TemplateCompiler.prototype.toArray=function(arr){
        return [].slice.call(arr)
    }
    
    //åˆ¤æ–­æ˜¯å¦æ˜¯æŒ‡ä»¤å±æ€§
    TemplateCompiler.prototype.isDirective=function(directiveName){
        return directiveName.indexOf('v-') >= 0;
    }
    
    //è¯»å–domåˆ°å†…å­˜
    TemplateCompiler.prototype.node2Fragment=function(node){
        var fragment=document.createDocumentFragment();
        var child;
        //while(child=node.firstChild)è¿™è¡Œä»£ç ï¼Œæ¯æ¬¡è¿è¡Œä¼šæŠŠfirstChildä»nodeä¸­å–å‡ºï¼ŒæŒ‡å¯¼å–å‡ºæ¥æ˜¯nullå°±ç»ˆæ­¢å¾ªç¯
        while(child=node.firstChild){
            fragment.appendChild(child)
        }
        return fragment;
    }
    
    //ç¼–è¯‘æ¨¡æ¿
    TemplateCompiler.prototype.compile=function(fragment){
        var childNodes = fragment.childNodes;
        var arr = this.toArray(childNodes);
        arr.forEach(node => {
            //åˆ¤æ–­æ˜¯å¦æ˜¯å…ƒç´ èŠ‚ç‚¹
            if(this.isElementNode(node)){
                this.compileElement(node);
            }else{
                //å®šä¹‰æ–‡æœ¬è¡¨è¾¾å¼éªŒè¯è§„åˆ™
                var textReg = /\{\{(.+)\}\}/;
                var expr = node.textContent;
                if (textReg.test(expr)) {
                    //è·å–ç»‘å®šçš„å±æ€§
                    expr = RegExp.$1;
                    //è°ƒç”¨æ–¹æ³•ç¼–è¯‘
                    this.compileText(node, expr)
                }
            }
        });
    }
    
    //è§£æå…ƒç´ èŠ‚ç‚¹
    TemplateCompiler.prototype.compileElement=function(node){
        //è·å–èŠ‚ç‚¹æ‰€æœ‰å±æ€§
        var arrs=node.attributes;
        this.toArray(arrs).forEach(attr => {
            //è·å–å±æ€§åç§°
            var attrName=attr.name;
            if(this.isDirective(attrName)){
                //è·å–v-modalçš„modal
                var type = attrName.split('-')[1]
                //è·å–å±æ€§å¯¹åº”çš„å€¼(ç»‘å®šçš„å±æ€§)
                var expr = attr.value;
                CompilerUtils[type] && CompilerUtils[type](node, this.vm, expr)
            }  
        });
    }
    
     //è§£ææ–‡æœ¬èŠ‚ç‚¹
     TemplateCompiler.prototype.compileText=function(node,expr){
        CompilerUtils.text(node, this.vm, expr)
    }
    

TemplateCompilerçš„ä¸»è¦é€»è¾‘ï¼š

aã€domèŠ‚ç‚¹è¯»å…¥åˆ°å†…å­˜

bã€éå†æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­èŠ‚ç‚¹ç±»å‹ï¼Œå…ƒç´ èŠ‚ç‚¹å’Œæ–‡æœ¬èŠ‚ç‚¹åˆ†åˆ«ä½¿ç”¨ä¸åŒæ–¹æ³•ç¼–è¯‘

cã€å…ƒç´ èŠ‚ç‚¹ç¼–è¯‘ï¼Œéå†æ‰€æœ‰å±æ€§ï¼Œæ ¹æ®æŒ‡ä»¤åç§°ç§°æ‰¾åˆ°CompilerUtilså¯¹åº”çš„æŒ‡ä»¤å¤„ç†æ–¹æ³•ï¼Œæ‰§è¡Œè§†å›¾åˆå§‹åŒ–å’Œè®¢é˜…

dã€æ–‡æœ¬èŠ‚ç‚¹ç¼–è¯‘ï¼Œæ­£åˆ™åŒ¹é…æ‰¾åˆ°ç»‘å®šçš„å±æ€§ï¼Œä½¿ç”¨CompilerUtilsçš„textæ‰§è¡Œåˆå§‹åŒ–å’Œè®¢é˜…

**7ã€åˆ›å»ºCompilerUtilsç¼–è¾‘å·¥å…·å¯¹è±¡ï¼Œå®ç°è§†å›¾åˆå§‹åŒ–å’Œè®¢é˜…**

    //ç¼–è¯‘å·¥å…·
    CompilerUtils = {
      	//å¯¹åº”è§†å›¾v-modalæŒ‡ä»¤ï¼Œä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œè§†å›¾åˆå§‹åŒ–å’Œè®¢é˜…
        //params nodeå½“å‰èŠ‚ç‚¹  vm myvmå¯¹è±¡   exprç»‘å®šçš„å±æ€§
        //modalæ–¹æ³•æ‰§è¡Œä¸€æ¬¡ï¼Œè¿›è¡Œè§†å›¾åˆå§‹åŒ–ã€äº‹ä»¶è®¢é˜…ï¼Œæ·»åŠ è§†å›¾åˆ°æ¨¡å‹çš„äº‹ä»¶
        model(node, vm, expr) {
          	//èŠ‚ç‚¹æ›´æ–°æ–¹æ³•
            var updateFn = this.updater.modelUpdater;
            //åˆå§‹åŒ–ï¼Œæ›´æ–°nodeçš„å€¼
            updateFn && updateFn(node, vm.$data[expr])
    
            //å®ä¾‹åŒ–ä¸€ä¸ªè®¢é˜…è€…ï¼Œæ·»åŠ åˆ°è®¢é˜…æ•°ç»„
            new Watcher(vm, expr, (newValue) => {
                 //å‘å¸ƒçš„æ—¶å€™ï¼ŒæŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼Œå¯¹èŠ‚ç‚¹è¿›è¡Œæ›´æ–°
                 updateFn && updateFn(node, newValue)
            })
    
            //è§†å›¾åˆ°æ¨¡å‹(è§‚å¯Ÿè€…æ¨¡å¼)
            node.addEventListener('input', (e) => {
                //è·å–æ–°å€¼æ”¾åˆ°æ¨¡å‹
                var newValue = e.target.value;
                vm.$data[expr] = newValue;
            })
        },
    
        //å¯¹åº”è§†å›¾v-textæŒ‡ä»¤ï¼Œä½¿ç”¨è¯¥æ–¹æ³•è¿›è¡Œè§†å›¾åˆå§‹åŒ–å’Œè®¢é˜…
        //params nodeå½“å‰èŠ‚ç‚¹  vm myvmå¯¹è±¡   exprç»‘å®šçš„å±æ€§
        //textæ–¹æ³•æ‰§è¡Œä¸€æ¬¡ï¼Œè¿›è¡Œè§†å›¾åˆå§‹åŒ–ã€äº‹ä»¶è®¢é˜…
        text(node, vm, expr) {
            //textæ›´æ–°æ–¹æ³•
            var updateFn = this.updater.textUpdater;
           //åˆå§‹åŒ–ï¼Œæ›´æ–°textçš„å€¼
            updateFn && updateFn(node, vm.$data[expr])
    
            //å®ä¾‹åŒ–ä¸€ä¸ªè®¢é˜…è€…ï¼Œæ·»åŠ åˆ°è®¢é˜…æ•°ç»„
            new Watcher(vm, expr, (newValue) => {
              //å‘å¸ƒçš„æ—¶å€™ï¼ŒæŒ‰ç…§ä¹‹å‰çš„è§„åˆ™ï¼Œå¯¹æ–‡æœ¬èŠ‚ç‚¹è¿›è¡Œæ›´æ–°
              updateFn && updateFn(node, newValue)
            })
        },
    
        updater: {
            //v-textæ•°æ®æ›´æ–°
            textUpdater(node, value) {
              node.textContent = value;
            },
            //v-modelæ•°æ®æ›´æ–°
            modelUpdater(node, value) {
              node.value = value;
            }
        }
    }
    

CompilerUtilsçš„ä¸»è¦é€»è¾‘ï¼š

aã€æ ¹æ®æŒ‡ä»¤å¯¹èŠ‚ç‚¹è¿›è¡Œæ•°æ®åˆå§‹åŒ–ï¼Œå®ä¾‹åŒ–è§‚å¯Ÿè€…Watcheråˆ°è®¢é˜…æ•°ç»„

bã€ä¸åŒçš„æŒ‡ä»¤è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†

**8ã€åˆ›å»ºWatcher.jsï¼Œå®ç°è®¢é˜…è€…é€»è¾‘**

    //å£°æ˜ä¸€ä¸ªè®¢é˜…è€…
    //vm å…¨å±€vmå¯¹è±¡
    //expr å±æ€§åç§°
    //cb å‘å¸ƒæ—¶éœ€è¦æ‰§è¡Œçš„æ–¹æ³•
    function Watcher(vm, expr, cb) {
        //ç¼“å­˜é‡è¦å±æ€§
        this.vm = vm;
        this.expr = expr;
        this.cb = cb;
    
        //ç¼“å­˜å½“å‰å€¼ï¼Œä¸ºæ›´æ–°æ—¶åšå¯¹æ¯”
        this.value = this.get()
      }
      Watcher.prototype.get=function(){
        //è®¾ç½®å…¨å±€Depçš„targetä¸ºå½“å‰è®¢é˜…è€…
        Dep.target = this;
        //è·å–å±æ€§çš„å½“å‰å€¼ï¼Œè·å–æ—¶ä¼šæ‰§è¡Œå±æ€§çš„getæ–¹æ³•ï¼Œgetæ–¹æ³•ä¼šåˆ¤æ–­targetæ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±æ·»åŠ è®¢é˜…è€…
        var value = this.vm.$data[this.expr]
        //æ¸…ç©ºå…¨å±€
        Dep.target = null;
        return value;
      }
      Watcher.prototype.update=function(){
        //è·å–æ–°å€¼
        var newValue = this.vm.$data[this.expr]
        //è·å–è€å€¼
        var old = this.value;
    
        //åˆ¤æ–­å
        if (newValue !== old) {
          //æ‰§è¡Œå›è°ƒ
          this.cb(newValue)
        }
      }
    

Watcherçš„ä¸»è¦é€»è¾‘ï¼š

aã€get æŠŠå½“å‰è®¢é˜…è€…æ·»åŠ åˆ°å±æ€§å¯¹åº”çš„ä¾èµ–æ•°ç»„ï¼Œä¿å­˜å€¼

bã€update å‘å¸ƒçš„æ—¶å€™æ‰§è¡Œï¼Œè¿›è¡Œæ–°è€å€¼å¯¹æ¯”ï¼Œæ›´æ–°èŠ‚ç‚¹å†…å®¹

**åˆ°æ­¤ä¸€ä¸ªç®€å•çš„MVVMæ¡†æ¶å°±å®Œæˆäº†ï¼Œæ•´ä½“è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š**

![iShot_2022-06-30_17.20.49](https://tva1.sinaimg.cn/large/e6c9d24ely1h3qe8q039rg20hw096q61.gif)

æ¢³ç†è¿‡ç¨‹ä¸­å‚è€ƒå¾ˆå¤šå¤§ä½¬æ–‡ç« ï¼Œæ„Ÿè°¢å„ä½ã€‚çœ‹å®ŒåŸºæœ¬èƒ½æŠŠVUE2.0çš„åŒå‘ç»‘å®šåŸç†è®²æ¸…æ¥šäº†ï¼Œå¸Œæœ›èƒ½å¸®åŠ©æœ‰ç¼˜äººï¼ŒğŸ˜„ï¼