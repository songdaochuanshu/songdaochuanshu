---
layout: post
title: "TypeScript  ä¹‹ æ§åˆ¶æµåˆ†æï¼ˆControl Flow Analysisï¼‰"
date: "2022-12-10T07:14:22.716Z"
---
TypeScript ä¹‹ æ§åˆ¶æµåˆ†æï¼ˆControl Flow Analysisï¼‰
=========================================

æ§åˆ¶æµåˆ†æï¼ˆControl Flow Analysisï¼‰
============================

#### æè¿°ï¼š

CFA å‡ ä¹æ€»æ˜¯é‡‡ç”¨è”åˆï¼ŒåŸºäºä»£ç é€»è¾‘å»å‡å°‘è”åˆé‡Œé¢çš„ç±»å‹æ•°é‡ã€‚

å¤§å¤šæ•°æ—¶å€™ï¼ŒCFA åœ¨è‡ªç„¶çš„JavaScriptå¸ƒå°”é€»è¾‘ä¸­å·¥ä½œï¼Œä½†æ˜¯æœ‰ä¸€äº›æ–¹æ³•å¯ä»¥å®šä¹‰ä½ è‡ªå·±çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¼šå½±å“ TypeScript ç¼©å°ç±»å‹çš„æ–¹å¼ã€‚

#### ç®€å•è¯´å°±æ˜¯ï¼šæ ¹æ®ä»£ç ä¸Šä¸‹æ–‡å¯ä»¥æ¨æ–­å‡ºå½“å‰å˜é‡ç±»å‹ã€‚

### if è¯­æ³•ï¼ˆIf Statementsï¼‰

å¤§å¤šæ•°çª„åŒ–æ¥è‡ª if è¯­å¥ï¼Œç”¨ä¸åŒç±»å‹æ“ä½œç¬¦ï¼Œåœ¨æ–°ä½œç”¨åŸŸå†…è¿›è¡Œçª„åŒ–

**typeof (ç”¨æ¥åˆ¤æ–­åŸå§‹ç±»å‹)**

const input = getUserInput()
input // string | number
if (typeof input === "string") {
  input // string
}

**instanceof (åˆ¤æ–­æ„é€ å‡½æ•°)**

const input = getUserInput()
input // string | number\[\]
if (input instanceof Array) {
  input // number\[\]
}

**in (åˆ¤æ–­å±æ€§æ˜¯å¦å±äºå¯¹è±¡)**

const input = getUserInput()
input // string | {error: ...}
if ("error" in input) {
  input // {error: ...}
}

**Array.isArray (åˆ¤æ–­æ˜¯å¦ä¸ºæ•°ç»„)**

const input = getUserInput()
input // number | number\[\]
if (Array.isArray(input)) {
  input // number\[\]
}

### è¡¨è¾¾å¼ï¼ˆExpressionsï¼‰

å½“è¿›è¡Œå¸ƒå°”è¿ç®—æ—¶ï¼Œçª„åŒ–ä¹Ÿå‘ç”Ÿåœ¨ä»£ç çš„åŒä¸€è¡Œ

const input = getUserInput()
input // string | number
const inputLength = (typeof input === "string" && input.length) || input
ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€//&& input: string

### è¯†åˆ«è”åˆï¼ˆDiscriminated Unions ï¼‰

type JSONResponse = {status: 200, data: any}
| {status: 300, to: string}
| {status: 400, error: Error}

æ‰€æœ‰è”åˆæˆå‘˜éƒ½æœ‰ç›¸åŒå±æ€§åç§°ï¼ŒCFA(Control Flow Analysis) èƒ½è¯†åˆ«å¯¹å¾…

const response = getResponse()
response // JSONResponse

switch(response.status) {
  case 200: response.data
  case 400: redirect(response.to)
  case 500: response.error
}

### ç±»å‹ä¿æŠ¤ï¼ˆType Guardsï¼‰ç±»å‹è°“è¯ï¼ˆtype predicatesï¼‰

å®šä¹‰ç”¨æˆ·å®šä¹‰çš„ç±»å‹çš„å®ˆå«ï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªå‡½æ•°è¿”å›ç±»å‹ä¸ºç±»å‹è°“è¯

ä¸‹é¢ä¾‹å­ä¸­ï¼ŒisFish å°±æ˜¯ç±»å‹å®ˆå«

type Fish = { name: string; swim: () => string };
type Bird \= { name: string; fly: () => string };
const fish: Fish \= { name: "sharkey", swim: () => 'asd' }
const bird: Bird \= { name: "noob", fly: () => 'asd' }

// æœªä½¿ç”¨ç±»å‹è°“è¯
function isFish(pet: Fish | Bird) {
  return (pet as Fish).swim !== undefined;
}
const foo: Fish | Bird = Math.random() ? fish : bird;
if (isFish(foo)) {
  // foo: Fish | Bird
  foo.swim() // ä¸èƒ½è°ƒç”¨ï¼Œä¸ç¡®å®šæ˜¯ Fish ç±»å‹
}
// ä½¿ç”¨ç±»å‹è°“è¯
function isFish(pet: Fish | Bird): pet is Fish {
  return (pet as Fish).swim !== undefined;
}
const foo: Fish | Bird = Math.random() ? fish : bird;
if (isFish(foo)) {
  // foo: Fish
  foo.swim() // ok
}
// å¿…é¡»æ˜¯å½“å‰å‡½æ•°ç­¾åä¸­å‚æ•°çš„åç§°ï¼ˆpetï¼‰ã€‚
// å¦‚æœç‰¹å®šç±»å‹ä¸åŸå§‹ç±»å‹å…¼å®¹ï¼ˆFish ä¸ Fish | Birdï¼‰ï¼ŒTypeScript ä¼šå°†è¯¥å˜é‡ç¼©å°ä¸ºè¯¥ç‰¹å®šç±»å‹ï¼Œä¸å…¼å®¹ä¼šæŠ¥é”™

å¯ä»¥ä½¿ç”¨ç±»å‹å®ˆå«ï¼Œè¿‡æ»¤ä¸€ä¸ª Fish | Bird ç±»å‹æ•°ç»„ï¼Œå¹¶è·å¾—ä¸€ä¸ª Fish ç±»å‹æ•°ç»„:

const zoo: (Fish | Bird)\[\] = \[getSmallPet(), getSmallPet(), getSmallPet()\];
const underWater1: Fish\[\] \= zoo.filter(isFish);
// ç›¸å½“äº
const underWater2: Fish\[\] = zoo.filter(isFish) as Fish\[\];

// å¤æ‚çš„ä¾‹å­ï¼Œè°“è¯éœ€è¦é‡å¤
const underWater3: Fish\[\] = zoo.filter((pet): pet is Fish => {
  if (pet.name === "sharkey") return false;
  return isFish(pet);
});

### Â æ–­è¨€å‡½æ•°ï¼ˆAssertion Functionsï¼‰

è°“è¯æ˜¯ï¼Œå‡½æ•°è¿”å› trueï¼Œç„¶åæ ¹æ®ä»£ç é€»è¾‘åœ¨æ–°ä½œç”¨åŸŸä¸­è¡¨ç¤ºç‰¹å®šç±»å‹

æ–­è¨€å‡½æ•°æ˜¯æŠ›å‡ºï¼Œè€Œä¸æ˜¯è¿”å› falseï¼Œç„¶åæ”¹å˜å½“å‰ä½œç”¨åŸŸè¡¨ç¤ºç‰¹å®šç±»å‹

type SuccessResponse = {data: string}
type ErrorResponse \= {msg: string}
class JSONResponse implements SuccessResponse {
  constructor(public data: string) { }
}
function assertResponse(obj: SuccessResponse | ErrorResponse): asserts obj is ErrorResponse {
  if (!(obj instanceof JSONResponse)) {
    throw new Error("Not a success!")
  }
}
const res \= getResponse();
res // SuccessResponse | ErrorResponse
assertResponse(res) // æ–­è¨€å‡½æ•°æ›´æ”¹å½“å‰ä½œç”¨åŸŸ
res // ErrorResponse

### èµ‹å€¼ï¼ˆAssignmentï¼‰

ä½¿ç”¨ "as const" ç¼©å°ç±»å‹

å¯¹è±¡ä¸­çš„å±æ€§è¢«è§†ä¸ºå¯å˜çš„ï¼Œåœ¨èµ‹å€¼è¿‡ç¨‹ä¸­ï¼Œç±»å‹å°†è¢«â€œæ‹“å®½â€ä¸ºéå­—é¢é‡ç±»å‹ã€‚å‰ç¼€â€œas constâ€å°†æ‰€æœ‰ç±»å‹é”å®šä¸ºå®ƒä»¬çš„å­—é¢é‡ç±»å‹ã€‚

const data1 = { name: "Zagreus" }
const data2 \= { name: "Zagreus" } as const
// data1: {name: string}
// data2: { readonly name: "Zagreus"}

è·Ÿè¸ªç›¸å…³å˜é‡

class SuccessResponse { }
const response \= getResponse()
const isSuccessResponse \= response instanceof SuccessResponse
if (isSuccessResponse) {
  response // SuccessResponse
}

é‡æ–°èµ‹å€¼æ›´æ–°ç±»å‹

let data: string | number = Math.random() ? "asd" : 123
data // string | number
data = "hello"
data // string

æ„Ÿè°¢è§‚çœ‹ï¼Œæ¬¢è¿äº’ç›¸è®¨è®ºä¸æŒ‡å¯¼ï¼Œä»¥ä¸‹æ˜¯å‚è€ƒèµ„æ–™é“¾æ¥ğŸ”—

[https://www.typescriptlang.org/static/TypeScript%20Control%20Flow%20Analysis-8a549253ad8470850b77c4c5c351d457.png](https://www.typescriptlang.org/static/TypeScript%20Control%20Flow%20Analysis-8a549253ad8470850b77c4c5c351d457.png)