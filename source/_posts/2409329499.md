---
layout: post
title: "ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLé”æœºåˆ¶ && äº‹åŠ¡"
date: "2022-10-29T07:18:02.658Z"
---
ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLé”æœºåˆ¶ && äº‹åŠ¡
========================

![ã€ŒMySQLé«˜çº§ç¯‡ã€MySQLé”æœºåˆ¶ &amp;&amp; äº‹åŠ¡](https://img2022.cnblogs.com/blog/2334298/202210/2334298-20221029093932321-1525287423.png) â‘ è¡¨çº§é”ï¼šå…¨å±€é”ï¼Œå…ƒæ•°æ®é”ï¼Œæ„å‘é”ï¼ŒAUTO-INCé” â‘¡è¡Œçº§é”ï¼šä¸¤é˜¶æ®µé”åè®®ï¼Œé—´éš™é”ï¼Œä¸´é”®é” â‘¢äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ŒACIDç‰¹æ€§ â‘£æ­»é”ï¼šè§£å†³æ–¹æ¡ˆ

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯meloï¼Œä¸€åå¤§ä¸‰åå°ç»ƒä¹ ç”Ÿï¼Œæœ€è¿‘èµ¶åœ¨æ˜¥æ‹›å‰æ•´ç†æ•´ç†å‘è¿‡çš„åšå®¢~ğŸ¤£ğŸ¤£ğŸ¤£ï¼

ğŸ³å¼•è¨€
====

é”é”é”ï¼Œåˆ°å“ªåˆ°ç¦»ä¸å¼€è¿™æ¡©çäº‹ï¼Œå¹¶å‘çäº‹ï¼Œredisçäº‹ï¼Œå¦‚ä»Šæ˜¯MySQLçäº‹ï¼Œè¿™å…¶ä¸­çäº‹ï¼Œè¿˜è·ŸMySQLå¦ä¸€ä¸ªé‡è¦çš„ä¸œè¥¿--**äº‹åŠ¡**æ¯æ¯ç›¸å…³ã€‚  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dfd3914b8ccb4c0f84a1ca79e9a2fb38~tplv-k3u1fbpfcp-zoom-1.image)  
è¿™ç¯‡å°†ä»ä»¥ä¸‹å‡ ç‚¹ï¼Œå¸¦ä½ è§£å¼€è¿™æŠŠ**çˆ±æƒ…çš„è‹¦é”**ï¼š

ğŸæœ¬ç¯‡é€Ÿè§ˆè„‘å›¾
========

![é”æœºåˆ¶&&äº‹åŠ¡.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40893b28a28b4456b620091e10c88adc~tplv-k3u1fbpfcp-watermark.image?)

ğŸ¯å¸¸è§„è¡¨é”&è¡Œé”
=========

> è¿™ä¸€éƒ¨åˆ†è¾ƒä¸ºå¸¸è§„ï¼Œè‹¥æœ‰å‰ç½®çŸ¥è¯†ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°ä¸‹è¾¹çš„ã€è¡¨çº§é”æ‰©å±•ã€‘éƒ¨åˆ†å¼€å§‹é˜…è¯»  
> å»ºè®®å€ŸåŠ©ä¾§è¾¹æ ï¼Œ**æœ‰emojiè¡¨æƒ…**çš„å±äºé‡ç‚¹

é”æ¦‚è¿°
---

é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ï¼ˆé¿å…äº‰æŠ¢ï¼‰ã€‚

åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚ CPUã€RAMã€I/O ç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œé”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚

é”åˆ†ç±»
---

ä»å¯¹æ•°æ®æ“ä½œçš„ç²’åº¦åˆ† ï¼š

1ï¼‰ è¡¨é”ï¼šæ“ä½œæ—¶ï¼Œä¼šé”å®šæ•´ä¸ªè¡¨ã€‚

2ï¼‰ è¡Œé”ï¼šæ“ä½œæ—¶ï¼Œä¼šé”å®šå½“å‰æ“ä½œè¡Œã€‚

ä»å¯¹æ•°æ®æ“ä½œçš„ç±»å‹åˆ†ï¼š

1ï¼‰ è¯»é”ï¼ˆ**å…±äº«é”**ï¼‰ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ª**è¯»æ“ä½œ**å¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“ã€‚

2ï¼‰ å†™é”ï¼ˆæ’å®ƒé”ï¼‰ï¼šå½“å‰æ“ä½œ**æ²¡æœ‰å®Œæˆä¹‹å‰**ï¼Œå®ƒ**ä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ã€‚**

Mysql é”
-------

ç›¸å¯¹å…¶ä»–æ•°æ®åº“è€Œè¨€ï¼ŒMySQLçš„é”æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œå…¶æœ€æ˜¾è‘—çš„ç‰¹ç‚¹æ˜¯ä¸åŒçš„å­˜å‚¨å¼•æ“æ”¯æŒä¸åŒçš„é”æœºåˆ¶ã€‚ä¸‹è¡¨ä¸­ç½—åˆ—å‡ºäº†å„å­˜å‚¨å¼•æ“å¯¹é”çš„æ”¯æŒæƒ…å†µï¼š

å­˜å‚¨å¼•æ“

è¡¨çº§é”

è¡Œçº§é”

é¡µé¢é”(äº†è§£)

MyISAM

æ”¯æŒ

ä¸æ”¯æŒ

ä¸æ”¯æŒ

InnoDB

æ”¯æŒ

æ”¯æŒ(é»˜è®¤)

ä¸æ”¯æŒ

MEMORY

æ”¯æŒ

ä¸æ”¯æŒ

ä¸æ”¯æŒ

BDB

æ”¯æŒ

ä¸æ”¯æŒ

æ”¯æŒ

MySQLè¿™3ç§é”çš„ç‰¹æ€§å¯å¤§è‡´å½’çº³å¦‚ä¸‹ ï¼š

é”ç±»å‹

ç‰¹ç‚¹

è¡¨çº§é”

åå‘MyISAM å­˜å‚¨å¼•æ“ï¼Œå¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜,å¹¶å‘åº¦æœ€ä½ã€‚

è¡Œçº§é”

åå‘InnoDB å­˜å‚¨å¼•æ“ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œ**å‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½,**å¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚

é¡µé¢é”

å¼€é”€å’ŒåŠ é”æ—¶é—´ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦ç•Œäºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ã€‚

> ç²’åº¦å°ï¼Œè‡ªç„¶å‘ç”Ÿé”å†²çªçš„æ¦‚ç‡å°±ä½

ä»ä¸Šè¿°ç‰¹ç‚¹å¯è§ï¼Œå¾ˆéš¾ç¬¼ç»Ÿåœ°è¯´å“ªç§é”æ›´å¥½ï¼Œåªèƒ½å°±å…·ä½“åº”ç”¨çš„ç‰¹ç‚¹æ¥è¯´å“ªç§é”æ›´åˆé€‚ï¼

ä»…ä»é”çš„è§’åº¦æ¥è¯´ï¼šè¡¨çº§é”æ›´é€‚åˆäºä»¥æŸ¥è¯¢ä¸ºä¸»ï¼Œåªæœ‰å°‘é‡æŒ‰ç´¢å¼•æ¡ä»¶æ›´æ–°æ•°æ®çš„åº”ç”¨ï¼Œå¦‚Web åº”ç”¨ï¼›

è€Œè¡Œçº§é”åˆ™æ›´é€‚åˆäºæœ‰å¤§é‡æŒ‰ç´¢å¼•æ¡ä»¶å¹¶å‘æ›´æ–°å°‘é‡ä¸åŒæ•°æ®ï¼ŒåŒæ—¶åˆæœ‰å¹¶æŸ¥è¯¢çš„åº”ç”¨ï¼Œå¦‚ä¸€äº›åœ¨çº¿äº‹åŠ¡å¤„ç†ï¼ˆOLTPï¼‰ç³»ç»Ÿã€‚

MyISAM è¡¨é”
---------

MyISAM å­˜å‚¨å¼•æ“åªæ”¯æŒè¡¨é”ï¼Œè¿™ä¹Ÿæ˜¯MySQLå¼€å§‹å‡ ä¸ªç‰ˆæœ¬ä¸­å”¯ä¸€æ”¯æŒçš„é”ç±»å‹ã€‚

### å¦‚ä½•åŠ è¡¨é”

MyISAM åœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼ˆSELECTï¼‰å‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„æ‰€æœ‰è¡¨åŠ è¯»é”ï¼Œåœ¨æ‰§è¡Œæ›´æ–°æ“ä½œï¼ˆUPDATEã€DELETEã€INSERT ç­‰ï¼‰å‰ï¼Œä¼šè‡ªåŠ¨ç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ï¼Œè¿™ä¸ªè¿‡ç¨‹å¹¶ä¸éœ€è¦ç”¨æˆ·å¹²é¢„ï¼Œå› æ­¤ï¼Œç”¨æˆ·ä¸€èˆ¬ä¸éœ€è¦ç›´æ¥ç”¨ LOCK TABLE å‘½ä»¤ç»™ MyISAM è¡¨æ˜¾å¼åŠ é”ã€‚

æ˜¾ç¤ºåŠ è¡¨é”è¯­æ³•ï¼š  

    åŠ è¯»é” ï¼š lock table table_name read;
    
    åŠ å†™é” ï¼š lock table table_name writeï¼›
    

### è¯»é”æ¡ˆä¾‹

å‡†å¤‡ç¯å¢ƒ

    create database demo_03 default charset=utf8mb4;
    
    use demo_03;
    
    CREATE TABLE `tb_book` (
      `id` INT(11) auto_increment,
      `name` VARCHAR(50) DEFAULT NULL,
      `publish_time` DATE DEFAULT NULL,
      `status` CHAR(1) DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=myisam DEFAULT CHARSET=utf8 ;
    
    INSERT INTO tb_book (id, name, publish_time, status) VALUES(NULL,'javaç¼–ç¨‹æ€æƒ³','2088-08-01','1');
    INSERT INTO tb_book (id, name, publish_time, status) VALUES(NULL,'solrç¼–ç¨‹æ€æƒ³','2088-08-08','0');
    
    
    
    CREATE TABLE `tb_user` (
      `id` INT(11) auto_increment,
      `name` VARCHAR(50) DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=myisam DEFAULT CHARSET=utf8 ;
    
    INSERT INTO tb_user (id, name) VALUES(NULL,'ä»¤ç‹å†²');
    INSERT INTO tb_user (id, name) VALUES(NULL,'ç”°ä¼¯å…‰');
    

#### è¯»æ“ä½œ

å®¢æˆ·ç«¯ä¸€å¯¹bookè¡¨åŠ äº†é”ï¼Œå¹¶æ‹¿åˆ°äº†bookè¡¨çš„é”ï¼Œåœ¨è¯¥é”æœªé‡Šæ”¾ä¹‹å‰ï¼Œä¸èƒ½å»æŸ¥åˆ«çš„è¡¨ï¼›  
è€Œå®¢æˆ·ç«¯äºŒèƒ½æŸ¥åˆ°bookå’Œå…¶ä»–è¡¨ï¼Œæ˜¯å› ä¸ºè¯»é”æ˜¯å…±äº«é”ï¼Œä»–å¹¶æ²¡æœ‰çœŸæ­£æ‹¿åˆ°è¿™æŠŠé”ï¼Œè‡ªç„¶å¯ä»¥è‚†æ„å¦„ä¸ºï¼Œä¸å—æœªé‡Šæ”¾é”çš„æŸç¼šï¼›  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dfd44173741e44a89cca70f1e7664ecf~tplv-k3u1fbpfcp-zoom-1.image)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bd490a7ad0b044aca4501098bd9b0d59~tplv-k3u1fbpfcp-zoom-1.image)

#### å†™æ“ä½œ

*   å®¢æˆ·ç«¯â‘ ç›´æ¥æŠ¥é”™ï¼Œå› ä¸º**è¯»é”ä¼šæ’æ–¥å†™æ“ä½œ**
*   å®¢æˆ·ç«¯â‘¡é™·å…¥äº†é˜»å¡çŠ¶æ€ï¼Œå¾—ç­‰å¾…å®¢æˆ·ç«¯â‘ é‡Šæ”¾é”

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/43408d50df674f998bbcb7110be135d1~tplv-k3u1fbpfcp-zoom-1.image)

*   unlockåï¼Œå®¢æˆ·ç«¯â‘¡çš„å†™æ“ä½œå°±èƒ½æ­£å¸¸æ‰§è¡Œäº†ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fedeefb3ca1b445d94eedf8db86a6efe~tplv-k3u1fbpfcp-zoom-1.image)

#### æ€»ç»“

*   è¯»é”å¯¹äº**åŠ é”çš„å®¢æˆ·ç«¯**ï¼šä¼šé™åˆ¶å¯¹å…¶ä»–è¡¨çš„æŸ¥è¯¢ä»¥åŠ**å¯¹ä»»ä½•è¡¨çš„å†™æ“ä½œ**
*   è¯»é”å¯¹äº**å…¶ä»–å®¢æˆ·ç«¯**ï¼šä¸ä¼šé™åˆ¶ä»»ä½•æŸ¥è¯¢ï¼Œä½†ä¼šé˜»å¡**å¯¹è¯¥è¡¨çš„å†™æ“ä½œ**  
    

#### ğŸˆåŠ©è®°

è‡ªå·±æ‹¿åˆ°äº†è¯»é”ï¼Œé‚£è‡ªå·±å½“ç„¶ä¸èƒ½å†å»è¯»å…¶ä»–è¡¨ï¼Œè€Œåˆå› ä¸ºè¯»é”ä¸ä¼šå½±å“åˆ°å…¶ä»–å®¢æˆ·ç«¯è¯»çš„ç»“æœï¼Œé‚£å…¶ä»–å®¢æˆ·ç«¯è‡ªç„¶å¯ä»¥ä»»æ„è¯»ã€‚

è€Œå¯¹äºå†™æ“ä½œï¼šè‡ªå·±è¿˜åœ¨è¯»ï¼Œå°±åˆ«æƒ³ç€å»åšå†™æ“ä½œäº†ï¼è€Œå¯¹äºå…¶ä»–å®¢æˆ·ç«¯ï¼Œå¦‚æœå¯¹è¯¥è¡¨å†™æ“ä½œã€‚è‚¯å®šä¼šå½±å“åˆ°å½“å‰å®¢æˆ·ç«¯çš„è¯»å–ç»“æœï¼Œæ‰€ä»¥å…¶ä»–å®¢æˆ·ç«¯ä¸èƒ½å¯¹è¯¥è¡¨è¿›è¡Œå†™æ“ä½œ

*   **ç®€è€Œè¨€ä¹‹**ï¼šè‡ªå·±ä¸èƒ½ä¸‰å¿ƒäºŒæ„ã€æ“ä½œå…¶ä»–è¡¨ã€‘ï¼Œè€Œå¯¹ä»–äººåˆ™è€ƒè™‘è‡ªå·±æ‰€åšçš„æ“ä½œä¼šä¸ä¼šå¯¼è‡´**ä¸¤ä¸ªå®¢æˆ·ç«¯æ‹¿åˆ°ä¸ä¸€è‡´çš„æ•°æ®**ï¼Œä¼šçš„è¯å°±æ˜¯ä¸å…è®¸çš„ã€‚

### å†™é”æ¡ˆä¾‹

å®¢æˆ·ç«¯ ä¸€ :

1ï¼‰è·å¾—tb\_book è¡¨çš„å†™é”

    lock table tb_book write ;
    

2ï¼‰æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ

    select * from tb_book ;
    

3ï¼‰æ‰§è¡Œæ›´æ–°æ“ä½œ

    update tb_book set name = 'javaç¼–ç¨‹æ€æƒ³ï¼ˆç¬¬äºŒç‰ˆï¼‰' where id = 1;
    

æ›´æ–°æ“ä½œæ‰§è¡ŒæˆåŠŸ ï¼›

å®¢æˆ·ç«¯äºŒ :

4ï¼‰æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ

    select * from tb_book ;
    

*   é™·å…¥é˜»å¡çŠ¶æ€ï¼Œå› ä¸ºå†™é”æ˜¯æ’ä»–é”ï¼Œæ’æ–¥å…¶ä»–å®¢æˆ·ç«¯çš„å†™å’Œè¯»æ“ä½œã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a825871472447cb85b3083b66ac49c5~tplv-k3u1fbpfcp-zoom-1.image)

å½“åœ¨å®¢æˆ·ç«¯ä¸€ä¸­é‡Šæ”¾é”æŒ‡ä»¤ unlock tables å ï¼Œ å®¢æˆ·ç«¯äºŒä¸­çš„ select è¯­å¥ å°±ä¼šç«‹å³æ‰§è¡Œ

#### ğŸˆæ€»ç»“

*   å†™çš„ä¼˜å…ˆçº§å¾ˆé«˜ï¼Œå¯¹äºé”å®šçš„è¡¨**å¯å†™å¯è¯»**ï¼Œä½†åŒæ ·ä¸èƒ½ä¸‰å¿ƒäºŒæ„ï¼ï¼ï¼è€Œå…¶ä»–å®¢æˆ·ç«¯**å¯¹äºé”å®šçš„è¡¨å•¥ä¹Ÿå¹²ä¸äº†**

### ç»“è®º

é”æ¨¡å¼çš„ç›¸äº’å…¼å®¹æ€§å¦‚è¡¨ä¸­æ‰€ç¤ºï¼š

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c5c2120064a44d9bbd6bb52ac862698b~tplv-k3u1fbpfcp-zoom-1.image)

ç”±ä¸Šè¡¨å¯è§ï¼š

1ï¼‰ å¯¹MyISAM è¡¨çš„**è¯»æ“ä½œ**ï¼Œä¸ä¼šé˜»å¡**å…¶ä»–ç”¨æˆ·**å¯¹**åŒä¸€è¡¨**çš„è¯»è¯·æ±‚ï¼Œä½†ä¼šé˜»å¡å…¶ä»–ç”¨æˆ·å¯¹**åŒä¸€è¡¨**çš„å†™è¯·æ±‚ï¼›

2ï¼‰ å¯¹MyISAM è¡¨çš„**å†™æ“ä½œ**ï¼Œåˆ™ä¼šé˜»å¡**å…¶ä»–ç”¨æˆ·**å¯¹åŒä¸€è¡¨çš„è¯»å’Œå†™æ“ä½œï¼›

æ­¤å¤–ï¼ŒMyISAM çš„è¯»å†™é”è°ƒåº¦æ˜¯**å†™ä¼˜å…ˆ**ï¼Œè¿™ä¹Ÿæ˜¯MyISAM**ä¸é€‚åˆåšå†™ä¸ºä¸»çš„è¡¨**çš„å­˜å‚¨å¼•æ“çš„åŸå› ã€‚å› ä¸ºå†™é”åï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½åšä»»ä½•æ“ä½œï¼Œå¤§é‡çš„æ›´æ–°ä¼šä½¿æŸ¥è¯¢å¾ˆéš¾å¾—åˆ°é”ï¼Œä»è€Œé€ æˆæ°¸è¿œé˜»å¡ã€‚

### æŸ¥çœ‹é”çš„äº‰ç”¨æƒ…å†µ

    show open tablesï¼›
    

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/67942cbbef1347979234c8d1b9d2c5cc~tplv-k3u1fbpfcp-zoom-1.image)

In\_user : è¡¨å½“å‰è¢«æŸ¥è¯¢ä½¿ç”¨çš„æ¬¡æ•°ã€‚å¦‚æœè¯¥æ•°ä¸ºé›¶ï¼Œåˆ™è¡¨æ˜¯æ‰“å¼€çš„ï¼Œä½†æ˜¯å½“å‰æ²¡æœ‰è¢«ä½¿ç”¨ã€‚

Name\_lockedï¼šè¡¨åç§°æ˜¯å¦è¢«é”å®šã€‚åç§°é”å®šç”¨äºå–æ¶ˆè¡¨æˆ–å¯¹è¡¨è¿›è¡Œé‡å‘½åç­‰æ“ä½œã€‚

    show status like 'Table_locks%';
    

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/63c2eadd9e124a73ad5f70b3a6980c30~tplv-k3u1fbpfcp-zoom-1.image)

Table\_locks\_immediate ï¼š æŒ‡çš„æ˜¯èƒ½å¤Ÿç«‹å³è·å¾—è¡¨çº§é”çš„æ¬¡æ•°ï¼Œæ¯ç«‹å³è·å–é”ï¼Œå€¼åŠ 1ã€‚

Table\_locks\_waited ï¼š æŒ‡çš„æ˜¯ä¸èƒ½ç«‹å³è·å–è¡¨çº§é”è€Œéœ€è¦ç­‰å¾…çš„æ¬¡æ•°ï¼Œæ¯ç­‰å¾…ä¸€æ¬¡ï¼Œè¯¥å€¼åŠ 1ï¼Œæ­¤å€¼é«˜è¯´æ˜å­˜åœ¨ç€è¾ƒä¸ºä¸¥é‡çš„è¡¨çº§é”äº‰ç”¨æƒ…å†µã€‚

InnoDB è¡Œé”
---------

### è¡Œé”ä»‹ç»

è¡Œé”ç‰¹ç‚¹ ï¼šåå‘InnoDB å­˜å‚¨å¼•æ“ï¼Œå¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦ä¹Ÿæœ€é«˜ã€‚

InnoDB ä¸ MyISAM çš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹åŠ¡ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚ï¼ˆä¸¤è€…æ˜¯æ¯æ¯ç›¸å…³çš„ï¼‰

### ğŸˆğŸ‹äº‹åŠ¡

#### äº‹åŠ¡åŠå…¶ACIDå±æ€§

äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒã€‚

äº‹åŠ¡å…·æœ‰ä»¥ä¸‹4ä¸ªç‰¹æ€§ï¼Œç®€ç§°ä¸ºäº‹åŠ¡ACIDå±æ€§ã€‚

ACIDå±æ€§

å«ä¹‰

åŸå­æ€§ï¼ˆAtomicityï¼‰

äº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒï¼Œå…¶å¯¹æ•°æ®çš„ä¿®æ”¹ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

ä¸€è‡´æ€§ï¼ˆConsistentï¼‰

åœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶ï¼Œæ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚

éš”ç¦»æ€§ï¼ˆIsolationï¼‰

æ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ â€œç‹¬ç«‹â€ ç¯å¢ƒä¸‹è¿è¡Œã€‚

æŒä¹…æ€§ï¼ˆDurableï¼‰

äº‹åŠ¡å®Œæˆä¹‹åï¼Œå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…çš„ã€‚

  

#### å¹¶å‘äº‹åŠ¡å¤„ç†å¸¦æ¥çš„é—®é¢˜

é—®é¢˜

å«ä¹‰

ä¸¢å¤±æ›´æ–°ï¼ˆLost Updateï¼‰

å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œæœ€åˆçš„äº‹åŠ¡ä¿®æ”¹çš„å€¼ï¼Œä¼šè¢«**åæäº¤**çš„äº‹åŠ¡ä¿®æ”¹çš„å€¼**è¦†ç›–**ã€‚

è„è¯»ï¼ˆDirty Readsï¼‰

è¯»åˆ°äº†å¦ä¸€ä¸ªäº‹åŠ¡è¿˜æœªæäº¤çš„æ•°æ®

ä¸å¯**é‡å¤**è¯»ï¼ˆNon-Repeatable Readsï¼‰

ä¸€ä¸ªäº‹åŠ¡æ‰§è¡ŒåŒæ ·çš„ä¸¤æ¬¡selectè¯­å¥ï¼Œå‰åæŸ¥è¯¢å‡ºæ¥çš„ç»“æœä¸ä¸€è‡´

å¹»è¯»ï¼ˆPhantom Readsï¼‰

ä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°**å…¶ä»–äº‹åŠ¡**æ’å…¥äº†**æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®**ã€‚

##### å¹»è¯»

å¹»è¯»ï¼šå°±åƒ**å‡ºç°äº†â€œå¹»å½±â€ä¸€èˆ¬**ï¼ŒåŸæœ¬æŸ¥ä¸åˆ°è¿™ä¸ªäººï¼Œç„¶åè¦æ’å…¥çš„æ—¶å€™ï¼Œçªç„¶åˆè¯´è¿™ä¸ªäººå­˜åœ¨

*   åœºæ™¯ï¼šæ³¨å†Œé—®é¢˜å§ï¼ŒæŸ¥è¯¢æŸä¸ªä¸»é”®idæ˜¯å¦å­˜åœ¨ï¼Œç¬¬ä¸€æ¬¡æŸ¥è¯¢ä¸å­˜åœ¨ï¼Œå³å°†æ’å…¥æ–°æ•°æ®æ—¶ã€åˆšå¥½å¦ä¸€ä¸ªäºº**æ’å…¥äº†è¯¥ä¸»é”®id**ã€‘ï¼Œå¯¼è‡´è¿™è¾¹æ³¨å†Œå¤±è´¥

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e49b4c597359493dab03344562b7a358~tplv-k3u1fbpfcp-zoom-1.image)

1.  å¹»è¯»åœ¨â€œ**å½“å‰è¯»**â€ä¸‹æ‰ä¼šå‡ºç°ã€‚
2.  å¹»è¯»ä»…ä¸“æŒ‡â€œ**æ–°æ’å…¥çš„è¡Œ**â€ã€updateçš„ä¸ç®—ã€‘

#### ğŸˆäº‹åŠ¡éš”ç¦»çº§åˆ«

ä¸ºäº†è§£å†³ä¸Šè¿°æåˆ°çš„äº‹åŠ¡å¹¶å‘é—®é¢˜ï¼Œæ•°æ®åº“æä¾›ä¸€å®šçš„äº‹åŠ¡éš”ç¦»æœºåˆ¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»è¶Šä¸¥æ ¼ï¼Œå¹¶å‘å‰¯ä½œç”¨è¶Šå°ï¼Œä½†ä»˜å‡ºçš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§ï¼Œå› ä¸ºäº‹åŠ¡éš”ç¦»å®è´¨ä¸Šå°±æ˜¯ä½¿ç”¨äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œä¸²è¡ŒåŒ–â€ è¿›è¡Œï¼Œè¿™æ˜¾ç„¶ä¸â€œå¹¶å‘â€ æ˜¯çŸ›ç›¾çš„ã€‚

æ•°æ®åº“çš„éš”ç¦»çº§åˆ«æœ‰4ä¸ªï¼Œç”±ä½åˆ°é«˜ä¾æ¬¡ä¸ºRead uncommittedã€Read committedã€Repeatable readã€Serializableï¼Œè¿™å››ä¸ªçº§åˆ«å¯ä»¥é€ä¸ªè§£å†³è„å†™ã€è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»è¿™å‡ ç±»é—®é¢˜ã€‚

éš”ç¦»çº§åˆ«

ä¸¢å¤±æ›´æ–°

è„è¯»

ä¸å¯é‡å¤è¯»

å¹»è¯»

Read uncommitted

Ã—

âˆš

âˆš

âˆš

Read committed

Ã—

Ã—

âˆš

âˆš

Repeatable readï¼ˆé»˜è®¤ï¼‰

Ã—

Ã—

Ã—

âˆš

Serializable(ä¸²è¡ŒåŒ–)

Ã—

Ã—

Ã—

Ã—

> å¤‡æ³¨ ï¼š âˆš ä»£è¡¨å¯èƒ½å‡ºç° ï¼Œ Ã— ä»£è¡¨ä¸ä¼šå‡ºç° ã€‚

1.  è¯»æœªæäº¤ï¼šåˆ«äººä¿®æ”¹äº†æŸè¡Œæ•°æ®ï¼Œ**è¿˜æœªæäº¤**æˆ‘ä»¬å°±èƒ½çœ‹åˆ°ã€‚
2.  è¯»å·²æäº¤ï¼šåˆ«äººä¿®æ”¹äº†æŸè¡Œæ•°æ®ï¼Œ**å¾—ç­‰åˆ°æäº¤å**æˆ‘ä»¬æ‰èƒ½çœ‹åˆ°ã€‚ -- è§£å†³è„è¯»
3.  å¯é‡å¤è¯»ï¼šåˆ«äººä¿®æ”¹äº†æŸè¡Œæ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿä¸å»è¯»é‚£ä¸€è¡Œæ•°æ®ï¼Œè¿˜æ˜¯è¯»æˆ‘ä»¬å½“å‰äº‹åŠ¡**æœ€åˆçš„é‚£ä¸ªæœªè¢«ä¿®æ”¹çš„å€¼**ã€‚ -- è§£å†³ä¸å¯é‡å¤è¯»
4.  ä¸²è¡ŒåŒ–ï¼šå¯¹äºåŒä¸€è¡Œè®°å½•ï¼Œâ€œå†™â€ä¼šåŠ â€œå†™é”â€ï¼Œâ€œè¯»â€ä¼šåŠ â€œè¯»é”â€ã€‚å½“å‡ºç°è¯»å†™é”å†²çªçš„æ—¶å€™ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚

##### ä¾‹å­

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc9388baf5524e00bb56b6204d3b95ca~tplv-k3u1fbpfcp-zoom-1.image)

1.  è¯»æœªæäº¤ï¼šv1=v2=v3=2ï¼›Bè¿˜æœªæäº¤ï¼ŒAå°±å¯ä»¥çœ‹åˆ°äº†ã€‚
2.  è¯»å·²æäº¤ï¼šv1=1ï¼Œv2=v3=2ï¼›ç­‰åˆ°Bæäº¤åï¼ŒAæ‰èƒ½çœ‹åˆ°ã€‚
3.  å¯é‡å¤è¯»ï¼šv1=v2=1ï¼Œv3=2ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€è°“çš„å¯é‡å¤è¯»ï¼Œæ˜¯è¯´åœ¨å½“å‰äº‹åŠ¡æäº¤ä¹‹å‰ï¼Œ**åªä¼šè¯»å–å½“å‰äº‹åŠ¡æœ€åˆçš„å€¼**ï¼Œè€Œä¸å»è¯»å–å…¶ä»–çš„äº‹åŠ¡ï¼›
4.  ä¸²è¡ŒåŒ–ï¼šv1=1ï¼Œv2=1ï¼Œv3=2ï¼›äº‹åŠ¡Aä¸­æŸ¥è¯¢å¾—åˆ°å€¼1çš„æ—¶å€™ï¼Œå°±ä¼šåŠ äº†â€œè¯»é”â€ï¼Œä¼šé˜»å¡å…¶ä»–äº‹åŠ¡å¯¹è¯¥è¡Œçš„å†™æ“ä½œï¼ˆä¸Šæ–‡æˆ‘ä»¬å·²ç»æœ‰æåŠåˆ°ç›¸å…³çš„è¯»é”å’Œå†™é”ï¼Œå¿˜è®°äº†çš„å°ä¼™ä¼´å¯ä»¥ç¿»é˜…ä¸Šæ–‡çœ‹çœ‹ï¼‰æ‰€ä»¥åœ¨äº‹åŠ¡Bæ‰§è¡Œâ€œå°†1æ”¹æˆ2â€çš„æ—¶å€™ï¼Œä¼šè¢«é”ä½ã€‚**ç›´åˆ°äº‹åŠ¡Aæäº¤åï¼Œäº‹åŠ¡Bæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚**

Mysql çš„æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«ä¸º **Repeatable read**ï¼Œ æŸ¥çœ‹æ–¹å¼ï¼š

    show variables like 'tx_isolation';
    

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/380b1ccdeb0241f9b0f697fee566d9f3~tplv-k3u1fbpfcp-zoom-1.image)  

### InnoDB çš„è¡Œé”æ¨¡å¼

InnoDB å®ç°äº†ä»¥ä¸‹ä¸¤ç§ç±»å‹çš„è¡Œé”ã€‚

*   å…±äº«é”ï¼ˆSï¼‰ï¼šåˆç§°ä¸º**è¯»é”**ï¼Œç®€ç§°Sé”ï¼Œå…±äº«é”å°±æ˜¯**å¤šä¸ªäº‹åŠ¡**å¯¹äºåŒä¸€æ•°æ®å¯ä»¥å…±äº«ä¸€æŠŠé”ï¼Œéƒ½èƒ½è®¿é—®åˆ°æ•°æ®ï¼Œä½†æ˜¯**åªèƒ½è¯»ä¸èƒ½ä¿®æ”¹**ã€‚
*   æ’ä»–é”ï¼ˆXï¼‰ï¼šåˆç§°ä¸º**å†™é”**ï¼Œç®€ç§°Xé”ï¼Œæ’ä»–é”å°±æ˜¯ä¸èƒ½ä¸å…¶ä»–é”å¹¶å­˜ï¼Œå¦‚ä¸€ä¸ªäº‹åŠ¡è·å–äº†ä¸€ä¸ªæ•°æ®è¡Œçš„æ’ä»–é”ï¼Œ**å…¶ä»–äº‹åŠ¡å°±ä¸èƒ½å†è·å–è¯¥è¡Œçš„å…¶ä»–é”**ï¼ŒåŒ…æ‹¬å…±äº«é”å’Œæ’ä»–é”ï¼Œä½†æ˜¯è·å–æ’ä»–é”çš„äº‹åŠ¡æ˜¯å¯ä»¥**å¯¹æ•°æ®å°±è¡Œè¯»å–å’Œä¿®æ”¹**ã€‚

`å¯¹äºUPDATEã€DELETEå’ŒINSERTè¯­å¥ï¼ŒInnoDBä¼šè‡ªåŠ¨ç»™æ¶‰åŠæ•°æ®é›†åŠ **æ’ä»–é”**ï¼ˆX)ï¼›`

`å¯¹äºæ™®é€šSELECTè¯­å¥ï¼ŒInnoDBä¸ä¼šåŠ ä»»ä½•é”ï¼›`

å¯ä»¥é€šè¿‡ä»¥ä¸‹è¯­å¥æ˜¾ç¤ºç»™è®°å½•é›†åŠ å…±äº«é”æˆ–æ’ä»–é” ã€‚

    å…±äº«é”ï¼ˆSï¼‰ï¼šSELECT * FROM table_name WHERE ... LOCK IN SHARE MODE
    
    æ’ä»–é”ï¼ˆX) ï¼šSELECT * FROM table_name WHERE ... FOR UPDATE    ï¼ˆæ‚²è§‚é”ï¼‰
    						å³æ‰‹åŠ¨é”å®šä¸€è¡Œ
    

#### æ‚²è§‚é”å’Œä¹è§‚é”

  
æ‚²è§‚é”ï¼šäº‹åŠ¡å¿…é¡»æ’é˜Ÿæ‰§è¡Œã€‚æ•°æ®é”ä½äº†ï¼Œä¸å…è®¸å¹¶å‘ã€‚ï¼ˆè¡Œçº§é”ï¼šselectåé¢æ·»åŠ for updateï¼‰  
  
ä¹è§‚é”ï¼šæ”¯æŒå¹¶å‘ï¼Œäº‹åŠ¡ä¹Ÿä¸éœ€è¦æ’é˜Ÿï¼Œåªä¸è¿‡éœ€è¦ä¸€ä¸ªç‰ˆæœ¬å·ã€‚  
  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/954726d38c4243d0af79f1b545671ce8~tplv-k3u1fbpfcp-zoom-1.image)

#### æ¡ˆä¾‹å‡†å¤‡å·¥ä½œ

    create table test_innodb_lock(
    	id int(11),
    	name varchar(16),
    	sex varchar(1)
    )engine = innodb default charset=utf8;
    
    insert into test_innodb_lock values(1,'100','1');
    insert into test_innodb_lock values(3,'3','1');
    insert into test_innodb_lock values(4,'400','0');
    insert into test_innodb_lock values(5,'500','1');
    insert into test_innodb_lock values(6,'600','0');
    insert into test_innodb_lock values(7,'700','0');
    insert into test_innodb_lock values(8,'800','1');
    insert into test_innodb_lock values(9,'900','1');
    insert into test_innodb_lock values(1,'200','0');
    
    create index idx_test_innodb_lock_id on test_innodb_lock(id);
    create index idx_test_innodb_lock_name on test_innodb_lock(name);
    

#### è¡Œé”åŸºæœ¬æ¼”ç¤º

*   æˆ‘ä»¬é‡‡ç”¨ä¸¤ä¸ªå®¢æˆ·ç«¯ï¼Œé¦–å…ˆè¦å…³é—­æ‰è‡ªåŠ¨æäº¤åŠŸèƒ½ï¼šset autocommit = 0ï¼›
    *   æ™®é€šçš„selectä¸åŠ é”ï¼Œæ²¡æœ‰ä»€ä¹ˆå½±å“
    *   è€Œinsertå’Œupdateå°±ä¸ä¸€æ ·äº†ï¼Œä¼šåŠ æ’å®ƒé”ï¼Œå…¶ä»–å®¢æˆ·ç«¯é™·å…¥é˜»å¡çŠ¶æ€ï¼Œä¸èƒ½å¯¹**è¯¥è¡Œï¼ˆæ³¨æ„å¾—ä¸¤ä¸ªå®¢æˆ·ç«¯æ“ä½œçš„æ˜¯åŒä¸€è¡Œï¼Œæ‰ä¼šé˜»å¡ï¼Œå› ä¸ºæ˜¯è¡Œé”ï¼‰**è¿›è¡Œä¿®æ”¹ï¼Œç›´åˆ°åŠ é”çš„å®¢æˆ·ç«¯**æäº¤å®Œäº‹åŠ¡ï¼ˆç›¸å½“äºé‡Šæ”¾é”ï¼‰**

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c4876d6c68cb437ab966092ef7a72f32~tplv-k3u1fbpfcp-zoom-1.image)

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/060cc4e8b97f48f580f7df80cadb7736~tplv-k3u1fbpfcp-zoom-1.image)

#### æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”

> å¦‚æœä¸é€šè¿‡ç´¢å¼•æ¡ä»¶æ£€ç´¢æ•°æ®ï¼Œé‚£ä¹ˆInnoDBå°†å¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ é”ï¼Œå®é™…æ•ˆæœè·Ÿè¡¨é”ä¸€æ ·ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/83ef9200704a456c817fc5c59665c7dd~tplv-k3u1fbpfcp-zoom-1.image)  
ç”±äº æ‰§è¡Œæ›´æ–°æ—¶ ï¼Œ nameå­—æ®µæœ¬æ¥ä¸ºvarcharç±»å‹ï¼Œ æˆ‘ä»¬æ˜¯ä½œä¸ºæ•°ç»„ç±»å‹ä½¿ç”¨ï¼Œå­˜åœ¨ç±»å‹è½¬æ¢ï¼Œç´¢å¼•å¤±æ•ˆï¼Œæœ€ç»ˆè¡Œé”å˜ä¸ºè¡¨é” ï¼›(å­—ç¬¦ä¸²ç±»å‹ï¼Œåœ¨SQLè¯­å¥ä½¿ç”¨çš„æ—¶å€™æ²¡æœ‰åŠ å•å¼•å·ï¼Œå¯¼è‡´ç´¢å¼•å¤±æ•ˆï¼ŒæŸ¥è¯¢æ²¡æœ‰èµ°ç´¢å¼•ï¼Œè¿›è¡Œå…¨è¡¨æ‰«æï¼Œç´¢å¼•å¤±æ•ˆï¼Œ**è¡Œé”å°±å‡çº§ä¸ºè¡¨é”**)

#### InnoDB è¡Œé”äº‰ç”¨æƒ…å†µ

    show  status like 'innodb_row_lock%';
    

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/23161c8275894a7a8b0cb3e4e68843a8~tplv-k3u1fbpfcp-zoom-1.image)

*   Innodb\_row\_lock\_current\_waits: å½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡
    
*   Innodb\_row\_lock\_time: ä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦
    
*   Innodb\_row\_lock\_time\_avgï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é•¿
    
*   Innodb\_row\_lock\_time\_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´
    
*   **Innodb\_row\_lock\_waits**: ç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°
    

> å½“ç­‰å¾…çš„æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…çš„æ—¶é•¿ä¹Ÿä¸å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœç€æ‰‹åˆ¶å®šä¼˜åŒ–è®¡åˆ’ã€‚

#### æ€»ç»“

InnoDBå­˜å‚¨å¼•æ“ç”±äºå®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢å¸¦æ¥äº†**æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨é”ä¼šæ›´é«˜ä¸€äº›**ï¼Œä½†æ˜¯åœ¨**æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢**è¦è¿œè¿œé«˜äºMyISAMçš„è¡¨é”çš„ã€‚å½“ç³»ç»Ÿå¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™ï¼ŒInnoDBçš„æ•´ä½“æ€§èƒ½å’ŒMyISAMç›¸æ¯”å°±ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿ã€‚

ä½†æ˜¯ï¼ŒInnoDBçš„è¡Œçº§é”åŒæ ·ä¹Ÿæœ‰å…¶è„†å¼±çš„ä¸€é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©InnoDBçš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯”MyISAMé«˜ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´å·®ã€‚

#### ä¼˜åŒ–å»ºè®®

*   å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½èƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é”ã€‚
*   åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´ã€‚
*   å°½å¯èƒ½å‡å°‘ç´¢å¼•æ¡ä»¶ï¼ŒåŠç´¢å¼•èŒƒå›´ï¼Œé¿å…é—´éš™é”ã€‚
*   å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦ã€‚
*   å°½å¯ä½¿ç”¨ä½çº§åˆ«äº‹åŠ¡éš”ç¦»ï¼ˆä½†æ˜¯éœ€è¦ä¸šåŠ¡å±‚é¢æ»¡è¶³éœ€æ±‚ï¼‰

ğŸ¯è¡¨çº§é”æ‰©å±•
=======

å…¨å±€é”
---

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2e5e7fe5db26493b8e0c693ac50258e7~tplv-k3u1fbpfcp-zoom-1.image)  

### ç‰¹ç‚¹

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9f46ce12af84e498fd0a25666697ad5~tplv-k3u1fbpfcp-zoom-1.image)  

### å¤‡ä»½çš„ä¸€è‡´æ€§é—®é¢˜

æ¥çœ‹ä¸‹è¾¹è¿™ä¸ªåœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆ›å»ºçš„è´­ä¹°æ“ä½œï¼Œæ¶‰åŠåˆ°äº†ç”¨æˆ·ä½™é¢è¡¨+è®¢å•è¡¨ï¼Œæµç¨‹é¡ºåºå¦‚ä¸‹ï¼š

1.  å½“å‰æ­£åœ¨å¤‡ä»½ç”¨æˆ·ä½™é¢è¡¨ï¼Œå¤‡ä»½äº†å°æ˜åŒå­¦çš„ä½™é¢æ˜¯100
2.  æ­¤æ—¶å°æ˜åˆšå¥½ä¸‹äº†è®¢å•ï¼Œç†åº”æ‰£å‡50å…ƒ
    1.  ä½†ç”±äºç”¨æˆ·ä½™é¢è¡¨å·²ç»å¤‡ä»½å®Œæ¯•ï¼Œä½™é¢è¡¨ä¸ä¼šå—åˆ°å½±å“
3.  å°æ˜ä¸‹å¥½å•äº†ï¼Œå¦‚ä»Šæ¥å¤‡ä»½è®¢å•è¡¨äº†ï¼Œèƒ½å¤Ÿå¤‡ä»½åˆ°å°æ˜åˆšä¸‹çš„å•

åˆ°è¿™é‡Œæ˜¯å¦å‘ç°é—®é¢˜äº†ï¼Œå°±æ˜¯å¤‡ä»½åçš„ç»“æœæ˜¯ï¼šå°æ˜çš„ä½™é¢æ²¡æ‰£é’±ï¼Œä½†å´æœ‰ç›¸å…³çš„è®¢å•æ•°æ®ï¼Œå‡ºç°äº†æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ

*   _é‚£æˆ‘ä»¬è¯¥å¦‚ä½•è§„é¿è¿™ç§ç°è±¡å‘¢ï¼Ÿ_  
    

#### 1\. åŠ å…¨å±€é”

é€šä¿—æ˜“æ‡‚ï¼Œå°±æ˜¯é”ä½æ•´ä¸ªè¡¨ï¼Œæ­¤æ—¶æ‰€æœ‰**å¯¹æ•°æ®çš„å¢åˆ æ”¹æ“ä½œ**éƒ½ä¼šè¢«é˜»å¡  

#### 2\. ä¸åŠ é”çš„ä¸€è‡´æ€§æ•°æ®å¤‡ä»½

ä¸Šè¾¹æåˆ°ï¼Œå¤‡ä»½æ—¶åŠ ä¸Šå‚æ•° --single-transactionå°±èƒ½å®ç°æ­¤æ•ˆæœï¼Œå…·ä½“æ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ

å¦‚æœæ•°æ®åº“çš„å¼•æ“æ”¯æŒçš„äº‹åŠ¡æ”¯æŒ**å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«**ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æ•°æ®åº“ä¹‹å‰å…ˆå¼€å¯äº‹åŠ¡ï¼Œä¼šå…ˆåˆ›å»º Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´**éƒ½åœ¨ç”¨è¿™ä¸ª Read View**ï¼Œè€Œä¸”ç”±äº MVCC çš„æ”¯æŒï¼Œå¤‡ä»½æœŸé—´ä¸šåŠ¡ä¾ç„¶å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ›´æ–°æ“ä½œã€‚

å³ä½¿å…¶ä»–äº‹åŠ¡æ›´æ–°äº†è¡¨çš„æ•°æ®ï¼Œä¹Ÿä¸ä¼šå½±å“å¤‡ä»½æ•°æ®åº“æ—¶çš„ Read Viewï¼Œè¿™å°±æ˜¯äº‹åŠ¡å››å¤§ç‰¹æ€§ä¸­çš„éš”ç¦»æ€§ï¼Œè¿™æ ·**å¤‡ä»½æœŸé—´å¤‡ä»½çš„æ•°æ®ä¸€ç›´æ˜¯åœ¨å¼€å¯äº‹åŠ¡æ—¶çš„æ•°æ®ã€‚**

> ä¸Šæ–‡ä¹Ÿæåˆ°äº†å¯é‡å¤è¯»ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ï¼Œå¼€å¯äº‹åŠ¡åï¼Œæ— è®ºå…¶ä»–äº‹åŠ¡æ˜¯å¦æ›´æ–°äº†Aæ•°æ®ï¼Œæˆ‘ä»¬æŸ¥åˆ°çš„ä¾æ—§æ˜¯å¼€å§‹äº‹åŠ¡æ—¶çš„åŸå§‹Aæ•°æ®ï¼Œè€Œä¸ä¼šæ˜¯æ›´æ”¹åçš„ï¼Œå› æ­¤èƒ½ä¿è¯åœ¨å¤‡ä»½æœŸé—´ï¼Œå³ä½¿æœ‰åˆ«çš„äº‹åŠ¡æ¥æ›´æ–°ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šå¤‡ä»½åˆ°ã€è¿›è€Œå°±è§„é¿äº†æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‘

å…ƒæ•°æ®é”
----

å½“å­˜åœ¨äº‹åŠ¡ï¼Œåœ¨**å¯¹è¡¨çš„å¢åˆ æŸ¥æ”¹**è¯­å¥æ—¶ï¼Œå…¶ä»–äº‹åŠ¡è‹¥è¦**æ”¹å˜è¡¨ç»“æ„**ï¼Œä¼šè¢«é˜»å¡ã€‚ã€‚  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4cdf5c67fc5e401db8dd771087294325~tplv-k3u1fbpfcp-zoom-1.image)  
å½“æœ‰çº¿ç¨‹åœ¨æ‰§è¡Œ **select è¯­å¥**ï¼ˆ åŠ  **MDL è¯»é”**ï¼‰çš„æœŸé—´ï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹è¦æ›´æ”¹è¯¥è¡¨çš„ç»“æ„ï¼ˆ ç”³è¯· MDL å†™é”ï¼‰ï¼Œé‚£ä¹ˆå°†ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°æ‰§è¡Œå®Œ select è¯­å¥ï¼ˆ é‡Šæ”¾ MDL è¯»é”ï¼‰ã€‚

åä¹‹ï¼Œå½“æœ‰çº¿ç¨‹**å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´**ï¼ˆ åŠ  **MDL å†™é”**ï¼‰çš„æœŸé—´ï¼Œå¦‚æœæœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº† CRUD æ“ä½œï¼ˆ ç”³è¯· MDL è¯»é”ï¼‰ï¼Œé‚£ä¹ˆå°±ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°è¡¨ç»“æ„å˜æ›´å®Œæˆï¼ˆ é‡Šæ”¾ MDL å†™é”ï¼‰ã€‚

> ä¸¤è€…æ˜¯äº’æ–¥çš„ï¼Œè°å…ˆæ¥è°åŠäº‹ï¼Œç›´åˆ°ä¸€æ–¹å‰è€…å¤„ç†å®Œæ¯•

*   _MDL ä¸éœ€è¦æ˜¾ç¤ºè°ƒç”¨ï¼Œé‚£å®ƒæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™é‡Šæ”¾çš„?_

MDL æ˜¯åœ¨äº‹åŠ¡æäº¤åæ‰ä¼šé‡Šæ”¾ï¼Œè¿™æ„å‘³ç€**äº‹åŠ¡æ‰§è¡ŒæœŸé—´ï¼ŒMDL æ˜¯ä¸€ç›´æŒæœ‰çš„**ã€‚

### éšå«é—®é¢˜

é‚£å¦‚æœæ•°æ®åº“æœ‰ä¸€ä¸ªé•¿äº‹åŠ¡ï¼ˆæ‰€è°“çš„é•¿äº‹åŠ¡ï¼Œå°±æ˜¯å¼€å¯äº†äº‹åŠ¡ï¼Œä½†æ˜¯ä¸€ç›´è¿˜æ²¡æäº¤ï¼‰ï¼Œé‚£åœ¨å¯¹è¡¨ç»“æ„åšå˜æ›´æ“ä½œçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ„æƒ³ä¸åˆ°çš„äº‹æƒ…ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªé¡ºåºçš„åœºæ™¯ï¼š

1.  é¦–å…ˆï¼Œçº¿ç¨‹ A å…ˆå¯ç”¨äº†äº‹åŠ¡ï¼ˆä½†æ˜¯ä¸€ç›´ä¸æäº¤ï¼‰ï¼Œç„¶åæ‰§è¡Œä¸€æ¡ select è¯­å¥ï¼Œæ­¤æ—¶å°±å…ˆå¯¹è¯¥è¡¨åŠ ä¸Š MDL è¯»é”ï¼›
2.  ç„¶åï¼Œçº¿ç¨‹ B ä¹Ÿæ‰§è¡Œäº†åŒæ ·çš„ select è¯­å¥ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šé˜»å¡ï¼Œå› ä¸ºã€Œè¯»è¯»ã€å¹¶ä¸å†²çªï¼›
3.  æ¥ç€ï¼Œ**çº¿ç¨‹ C ä¿®æ”¹äº†è¡¨å­—æ®µ**ï¼Œæ­¤æ—¶ç”±äºçº¿ç¨‹ A çš„äº‹åŠ¡å¹¶æ²¡æœ‰æäº¤ï¼Œä¹Ÿå°±æ˜¯ MDL è¯»é”è¿˜åœ¨å ç”¨ç€ï¼Œè¿™æ—¶çº¿ç¨‹ C å°±æ— æ³•ç”³è¯·åˆ° MDL å†™é”ï¼Œå°±ä¼šè¢«é˜»å¡

é‚£ä¹ˆ**åœ¨çº¿ç¨‹ C é˜»å¡åï¼Œåç»­æ‰€æœ‰å¯¹è¯¥è¡¨çš„ select è¯­å¥ï¼Œå°±éƒ½ä¼šè¢«é˜»å¡**ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡è¯¥è¡¨çš„ select è¯­å¥çš„è¯·æ±‚åˆ°æ¥ï¼Œå°±ä¼šæœ‰å¤§é‡çš„çº¿ç¨‹è¢«é˜»å¡ä½ï¼Œè¿™æ—¶æ•°æ®åº“çš„çº¿ç¨‹å¾ˆå¿«å°±ä¼šçˆ†æ»¡äº†ã€‚

*   _ä¸ºä»€ä¹ˆçº¿ç¨‹ C å› ä¸ºç”³è¯·ä¸åˆ° MDL å†™é”ï¼Œè€Œå¯¼è‡´åç»­çš„ç”³è¯·è¯»é”çš„æŸ¥è¯¢æ“ä½œä¹Ÿä¼šè¢«é˜»å¡ï¼Ÿ_

è¿™æ˜¯å› ä¸ºç”³è¯· MDL é”çš„æ“ä½œä¼šå½¢æˆä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­**å†™é”è·å–ä¼˜å…ˆçº§é«˜äºè¯»é”**ï¼Œä¸€æ—¦å‡ºç° MDL å†™é”ç­‰å¾…ï¼Œä¼šé˜»å¡åç»­è¯¥è¡¨çš„æ‰€æœ‰ CRUD æ“ä½œã€‚  

### å¦‚ä½•è§£å†³

1.  è§£å†³é•¿äº‹åŠ¡ã€‚

ä¸ºäº†èƒ½å®‰å…¨çš„å¯¹è¡¨ç»“æ„è¿›è¡Œå˜æ›´ï¼Œåœ¨å¯¹è¡¨ç»“æ„å˜æ›´å‰ï¼Œå…ˆè¦çœ‹çœ‹æ•°æ®åº“ä¸­çš„é•¿äº‹åŠ¡ï¼Œæ˜¯å¦æœ‰äº‹åŠ¡å·²ç»å¯¹è¡¨åŠ ä¸Šäº† MDL è¯»é”ï¼Œå¦‚æœå¯ä»¥è€ƒè™‘ kill æ‰è¿™ä¸ªé•¿äº‹åŠ¡ï¼Œç„¶åå†åšè¡¨ç»“æ„çš„å˜æ›´ã€‚

2.  å¯¹äºçƒ­ç‚¹æ•°æ®çš„è¡¨ã€killæ‰åç«‹é©¬åˆæœ‰é•¿äº‹åŠ¡ã€‘

æ­¤æ—¶å•å•killæ˜¯æ²¡ç”¨äº†ï¼Œæˆ‘ä»¬åªèƒ½ç»™è¿™ä¸ªalterè¯­å¥è®¾ç½®ç­‰å¾…æ—¶é—´ï¼Œè‹¥**è¶…æ—¶æœªæ‹¿åˆ°MDLå†™é”**ï¼Œå°±æ”¾å¼ƒï¼Œä¸é˜»å¡åç»­çš„selectè¯­å¥  

ğŸˆæ„å‘é”
-----

### ä¸ºä»€ä¹ˆè¦å¼•å…¥æ„å‘é”

> æ¯”å¦‚æœ‰ä¸¤ä¸ªäº‹åŠ¡Aè·ŸBï¼Œå’Œä¸€ä¸ªè¡¨G

Aå¯¹Gä¸­çš„æŸä¸€è¡ŒåŠ äº†è¡Œé”ï¼Œä¹‹åBè¦å¯¹GåŠ è¡¨é”çš„æ—¶å€™ï¼Œè¡Œé”è·Ÿè¡¨é”å°±ä¼šäº§ç”Ÿå†²çª

*   ä¸ºäº†è§£å†³å†²çªï¼ŒBå°±éœ€è¦**éå†å…¨è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰è¡Œé”**ï¼Œè¿™æ ·æ•ˆç‡å¤ªä½äº†ï¼Œå› æ­¤å¼•å…¥äº†æ„å‘é”

### å¦‚ä½•è§£å†³

å½“Aå¯¹Gä¸­çš„æŸä¸€è¡Œ**åŠ äº†è¡Œé”å**ï¼Œä¼šé¡ºä¾¿**ç»™è¡¨GåŠ ä¸Šæ„å‘é”**

*   Bè¦å¯¹GåŠ è¡¨é”çš„æ—¶å€™ï¼Œåªéœ€è¦åˆ¤æ–­è¡¨Gçš„æ„å‘é”ï¼Œè·Ÿè‡ªå·±è¦åŠ çš„è¡¨é”æ˜¯å¦å…¼å®¹å³å¯ï¼Œæ— éœ€å†éå†å…¨è¡¨

### æ„å‘é”ç±»å‹

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9f7a5486e1943feb5949ab57c5bcc66~tplv-k3u1fbpfcp-zoom-1.image)  

### æ„å‘é”è·Ÿè¡¨é”çš„å…¼å®¹æ€§

å…±äº«é”çš„è¯ï¼Œè·Ÿè¡¨é”å…±äº«é”å…¼å®¹ï¼Œä½†è·Ÿè¡¨é”æ’å®ƒé”æ˜¯äº’æ–¥çš„  
æ’å®ƒé”ï¼Œè‡ªç„¶éƒ½äº’æ–¥

> æ³¨æ„ï¼Œæ„å‘é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œå¹¶ä¸”æ„å‘é”**ä¸ä¼š**ä¸**è¡Œçº§çš„å…±äº«é”å’Œæ’å®ƒé”äº’æ–¥**

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/69060c1e25c348a69435c310af3ed5a8~tplv-k3u1fbpfcp-zoom-1.image)  

ğŸˆAUTO-INC é”
------------

æ•°æ®åº“çš„**æ•°æ®è‡ªå¢æœºåˆ¶**ï¼Œå°±æ˜¯åŸºäºè¿™ä¸ªé”æœºåˆ¶å®ç°çš„ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨insertçš„æ—¶å€™ï¼Œä¸ç”¨æŒ‡æ˜æ•°æ®çš„å€¼ã€‚

AUTO-INC é”æ˜¯**ç‰¹æ®Šçš„è¡¨é”æœºåˆ¶**ï¼Œé”**ä¸æ˜¯åœ¨ä¸€ä¸ªäº‹åŠ¡æäº¤åæ‰é‡Šæ”¾ï¼Œè€Œæ˜¯åœ¨æ‰§è¡Œå®Œæ’å…¥è¯­å¥åå°±ä¼šç«‹å³é‡Šæ”¾**ã€‚ã€å› æ­¤ä¸éµå¾ªä¸¤é˜¶æ®µé”åè®®ï¼ˆä¸‹æ–‡ä¼šæåŠåˆ°è¯¥åè®®ï¼‰ã€‘

**åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œä¼šåŠ ä¸€ä¸ªè¡¨çº§åˆ«çš„ AUTO-INC é”**ï¼Œç„¶åä¸ºè¢« AUTO\_INCREMENT ä¿®é¥°çš„å­—æ®µèµ‹å€¼é€’å¢çš„å€¼ï¼Œç­‰**æ’å…¥è¯­å¥æ‰§è¡Œå®Œæˆå**ï¼Œæ‰ä¼šæŠŠ AUTO-INC é”é‡Šæ”¾æ‰ã€‚  
é‚£ä¹ˆï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æŒæœ‰ AUTO-INC é”çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä»–äº‹åŠ¡çš„å¦‚æœè¦å‘è¯¥è¡¨æ’å…¥è¯­å¥**éƒ½ä¼šè¢«é˜»å¡**ï¼Œä»è€Œä¿è¯æ’å…¥æ•°æ®æ—¶ï¼Œè¢« AUTO\_INCREMENT ä¿®é¥°çš„å­—æ®µçš„å€¼æ˜¯è¿ç»­é€’å¢çš„ã€‚

*   **å½“ç„¶ï¼Œè¿™æ ·ä¹Ÿæœ‰å¼Šç«¯**

åœ¨å¯¹å¤§é‡æ•°æ®è¿›è¡Œæ’å…¥çš„æ—¶å€™ï¼Œä¼šå½±å“æ’å…¥æ€§èƒ½ï¼Œå› ä¸ºå¦ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ’å…¥ä¼šè¢«é˜»å¡ã€‚

å› æ­¤ï¼Œ åœ¨ MySQL 5.1.22 ç‰ˆæœ¬å¼€å§‹ï¼ŒInnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸€ç§**è½»é‡çº§çš„é”**æ¥å®ç°è‡ªå¢ã€‚

ä¸€æ ·ä¹Ÿæ˜¯åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œä¼šä¸º**è¢« AUTO\_INCREMENT ä¿®é¥°çš„å­—æ®µåŠ ä¸Šè½»é‡çº§é”**ï¼Œ**ç„¶åç»™è¯¥å­—æ®µèµ‹å€¼ä¸€ä¸ªè‡ªå¢çš„å€¼ï¼Œå°±æŠŠè¿™ä¸ªè½»é‡çº§é”é‡Šæ”¾äº†ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªæ’å…¥è¯­å¥æ‰§è¡Œå®Œåæ‰é‡Šæ”¾é”**ã€‚

InnoDB å­˜å‚¨å¼•æ“æä¾›äº†ä¸ª innodb\_autoinc\_lock\_mode çš„ç³»ç»Ÿå˜é‡ï¼Œæ˜¯ç”¨æ¥æ§åˆ¶é€‰æ‹©ç”¨ AUTO-INC é”ï¼Œè¿˜æ˜¯è½»é‡çº§çš„é”ã€‚

*   å½“ innodb\_autoinc\_lock\_mode = 0ï¼Œå°±é‡‡ç”¨ AUTO-INC é”ï¼›
    
*   å½“ innodb\_autoinc\_lock\_mode = 2ï¼Œå°±é‡‡ç”¨è½»é‡çº§é”ï¼›
    
*   å½“ innodb\_autoinc\_lock\_mode = 1ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤å€¼ï¼Œä¸¤ç§é”æ··ç€ç”¨ï¼Œå¦‚æœèƒ½å¤Ÿç¡®å®šæ’å…¥è®°å½•çš„æ•°é‡å°±é‡‡ç”¨è½»é‡çº§é”ï¼Œä¸ç¡®å®šæ—¶å°±é‡‡ç”¨ AUTO-INC é”ã€‚
    
*   è‡ªå¢å€¼ä¸€æ—¦åˆ†é…äº†å°±ä¼šåŠ ä¸€ï¼Œå³ä½¿å›æ»šäº†ï¼Œè‡ªå¢å€¼ä¹Ÿä¸ä¼šå‡ä¸€ï¼Œè€Œæ˜¯ç»§ç»­ä½¿ç”¨ä¸‹ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥è‡ªå¢å€¼æœ‰å¯èƒ½ä¸æ˜¯è¿ç»­çš„ã€‚
    

### æ€»ç»“

1.  å¸¸è§„çš„é”ä½æ•´ä¸ªè¡¨ï¼Œç›´åˆ°æ’å…¥è¯­å¥æ‰§è¡Œå®Œæ¯•åæ‰é‡Šæ”¾
2.  ä¸º**è¢« AUTO\_INCREMENTä¿®é¥°çš„å­—æ®µåŠ ä¸Šçš„è½»é‡çº§é”**æ— éœ€ç­‰åˆ°æ’å…¥è¯­å¥æ‰§è¡Œå®Œæ¯•åæ‰é‡Šæ”¾  
    

ğŸ¯è¡Œçº§é”æ‰©å±•
=======

ğŸˆä¸¤é˜¶æ®µé”åè®®
--------

*   _ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯èƒ½æœ‰å¤šæ¡è¯­å¥ï¼Œæ¯æ¡è¯­å¥å¯èƒ½ä¼šåŠ ä¸Šé”ï¼Œé‚£ä¹ˆè¿™äº›é”æ˜¯ä»€ä¹ˆæ—¶å€™æ‰ä¼šé‡Šæ”¾å‘¢ï¼Ÿ_

ç­”æ¡ˆæ˜¯ï¼šéœ€è¦åœ¨äº‹åŠ¡commitä¹‹åæ‰é‡Šæ”¾ï¼Œæ‰€ä»¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠå°½å¯èƒ½ç²’åº¦å¤§çš„æ“ä½œæ”¾åˆ°åè¾¹ï¼

è¡Œçº§é”åˆ†ç±»
-----

*   è¡Œé”ï¼ˆRecord Lockï¼‰ ï¼šå•ä¸ªè¡Œè®°å½•ä¸Šçš„é”ã€‚
*   é—´éš™é”ï¼ˆGap Lockï¼‰ ï¼šé”å®šä¸€ä¸ªèŒƒå›´ï¼Œ**ä¸åŒ…æ‹¬è®°å½•æœ¬èº«**ã€‚ã€è§£å†³å¹»è¯»ç°è±¡ã€‘
*   ä¸´é”®é”ï¼ˆNext-key Lockï¼‰ ï¼šRecord Lock+Gap Lockã€è¡Œé”+é—´éš™é”ã€‘ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼ŒåŒ…å«è®°å½•æœ¬èº«ã€‚è¡Œé”åªèƒ½é”ä½å·²ç»å­˜åœ¨çš„è®°å½•ï¼Œä¸ºäº†é¿å…æ’å…¥æ–°è®°å½•ï¼Œéœ€è¦ä¾èµ–é—´éš™é”ã€‚

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1ec062081d8a4e7faf3512b8ac0e79a1~tplv-k3u1fbpfcp-zoom-1.image)

ğŸˆé—´éš™é”&&ä¸´é”®é”
----------

### å®šä¹‰

é—´éš™é”ï¼šé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†**ä¸åŒ…å«**æ•°æ®æœ¬èº«  
ä¸´é”®é”ï¼šé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”**åŒ…å«æ•°æ®æœ¬èº«**

> å¯¹è®°å½•åŠ é”æ—¶ï¼Œ**åŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lock**ï¼Œå®ƒæ˜¯ç”±è®°å½•é”å’Œé—´éš™é”ç»„åˆè€Œæˆçš„ï¼Œ**next-key lock æ˜¯å·¦å¼€å³é—­åŒºé—´ï¼Œè€Œé—´éš™é”æ˜¯å·¦å¼€å³å¼€åŒºé—´**ã€‚

å‡è®¾ä¸€ä¸ªç´¢å¼•åŒ…å«å€¼10ã€11ã€13å’Œ20ã€‚æ­¤ç´¢å¼•å¯èƒ½çš„next-keyé”åŒ…æ‹¬ä»¥ä¸‹åŒºé—´:

    (-âˆ, 10]
    
    (10, 11]
    
    (11, 13]
    
    (13, 20]
    
    (20, âˆ ]
    

å¯¹äºæœ€åä¸€ä¸ªé—´éš™ï¼Œâˆä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç´¢å¼•è®°å½•ï¼Œå› æ­¤ï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªnext-keyé”åªé”å®šæœ€å¤§ç´¢å¼•å€¼ä¹‹åçš„é—´éš™ã€‚

### åŠ é”åŸåˆ™

**ä¸¤ä¸ªâ€œåŸåˆ™â€ã€ä¸¤ä¸ªâ€œä¼˜åŒ–â€å’Œä¸€ä¸ªâ€œbugâ€ã€‚**

1.  åŸåˆ™1ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯next-key lockã€‚
2.  åŸåˆ™2ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­**è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚**
3.  ä¼˜åŒ–1ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™**å”¯ä¸€ç´¢å¼•**åŠ é”çš„æ—¶å€™ï¼Œnext-key locké€€åŒ–ä¸ºè¡Œé”ã€‚
4.  ä¼˜åŒ–2ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼**ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶**çš„æ—¶å€™ï¼Œnext-key locké€€åŒ–ä¸ºé—´éš™é”ã€‚
5.  ä¸€ä¸ªbugï¼š**å”¯ä¸€ç´¢å¼•ä¸Š**çš„èŒƒå›´æŸ¥è¯¢ä¼š**è®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚**

### ğŸˆé€€åŒ–é—®é¢˜

ä½†æ˜¯ï¼Œnext-key lock åœ¨ä¸€äº›åœºæ™¯ä¸‹ä¼šé€€åŒ–æˆè®°å½•é”æˆ–é—´éš™é”ã€‚  
![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/35c906bfa137499db614b8a31d7d7d2d~tplv-k3u1fbpfcp-zoom-1.image)  

#### æ¡ˆä¾‹å‡†å¤‡

> ä»¥ä¸‹ä¾‹å­å‡åœ¨ **MySQL** **8.0.23**ç‰ˆæœ¬ä¸‹æµ‹è¯•

    CREATE TABLE `t` (
      `id` int(11) NOT NULL,
      `c` int(11) DEFAULT NULL,
      `d` int(11) DEFAULT NULL,
      PRIMARY KEY (`id`),
      KEY `c` (`c`)
    ) ENGINE=InnoDB;
    
    insert into t values(0,0,0),(5,5,5),
    (10,10,10),(15,15,15),(20,20,20),(25,25,25);
    

**idã€ä¸»é”®ã€‘**

**cã€éå”¯ä¸€ç´¢å¼•ã€‘**

**d**

0

0

0

5

5

5

10

10

10

15

15

15

20

20

20

25

25

25

#### å”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4be8c54ae0d844c9b1cde9ca1bf7b30e~tplv-k3u1fbpfcp-zoom-1.image)

1.  è‹¥æŸ¥è¯¢çš„è®°å½•ã€7ã€‘å­˜åœ¨ï¼Œåˆ™é€€åŒ–ä¸ºè®°å½•é”ï¼Œé”çš„åªæ˜¯idä¸º7è¿™ä¸€ä¸ªç´¢å¼•
2.  è‹¥æŸ¥è¯¢çš„è®°å½•ä¸å­˜åœ¨ï¼š
    1.  åŸåˆ™1ï¼šå…ˆç»Ÿä¸€åŠ ä¸Šnext-key lockï¼Œ**(5,10\]**ï¼›
    2.  å†æ ¹æ®ä¼˜åŒ–2ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢(id=7)ï¼Œéå†åˆ°æœ€åå‘ç°id=10ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œnext-key locké€€åŒ–æˆé—´éš™é”ï¼Œå› æ­¤æœ€ç»ˆåŠ é”çš„èŒƒå›´æ˜¯**(5,10)**ã€‚

##### ğŸˆğŸˆç†è§£

ä¸è¦å¿˜äº†æˆ‘ä»¬å¼•å…¥é—´éš™é”çš„åˆè¡·ï¼Œæ˜¯ä¸ºäº†è§£å†³å¹»è¯»ç°è±¡ï¼Œé‚£è¿™é‡Œæˆ‘ä»¬æ˜¯å”¯ä¸€ç´¢å¼•ï¼š

1.  å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„id=7å·²ç»å­˜åœ¨äº†ï¼Œåˆ™ä¸å¯èƒ½è¿˜ä¼šæœ‰å…¶ä»–äº‹åŠ¡èƒ½å¤Ÿæ’å…¥idä¸º7çš„**å¹»å½±**è¿›æ¥ï¼Œå› ä¸ºæ˜¯å”¯ä¸€ç´¢å¼•å˜›ï¼Œå› æ­¤è‡ªç„¶ä¸éœ€è¦å†é”é—´éš™äº†ï¼Œåªéœ€è¦é”è¿™ä¸€è¡Œå°±å¤Ÿäº†ï¼Œé€€åŒ–ä¸ºè¡Œé”
    
2.  å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„id=7ä¸å­˜åœ¨ï¼Œç›¸å½“äºç´¢å¼•æ ‘é‡Œè¾¹è¿˜æ²¡æœ‰7è¿™ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘ä»¬è¦é”ä½ä»–ï¼Œå°±åªèƒ½é€šè¿‡ä»–çš„ç›¸é‚»èŠ‚ç‚¹5è·Ÿ10ï¼ŒæŠŠè¿™æ®µåŒºé—´é”ä½
    
    1.  åŒæ—¶5è·Ÿ10ç”¨ä¸ç”¨é”å‘¢ï¼Ÿæˆ‘ä»¬è¿™é‡Œæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œè€Œä¸”æ˜¯7ï¼Œä¸ç­‰äº5ä¹Ÿä¸ç­‰äº10ï¼Œæ‰€ä»¥5è·Ÿ10ä¸ä¼šå½±å“åˆ°æˆ‘ä»¬çš„7ï¼Œä¸éœ€è¦é”ï¼Œæ•…åªæ˜¯é”ï¼ˆ5,10ï¼‰

#### éå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3a33bcaeaff841dfae71c6f4749821c7~tplv-k3u1fbpfcp-zoom-1.image)

è¿™é‡Œsession Aè¦ç»™ç´¢å¼•cä¸Šc=5çš„è¿™ä¸€è¡ŒåŠ ä¸Šè¯»é”ã€‚

1.  åŸåˆ™1ï¼Œå…ˆåŠ next-key lockï¼Œå·¦å¼€å³é—­ï¼Œ**(0,5\]**
2.  è¿™é‡Œcæ˜¯æ™®é€šç´¢å¼•ï¼Œä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œæ‰€ä»¥ä¸èƒ½ç¡®ä¿åªæœ‰å½“å‰c=5è¿™ä¸€æ¡è®°å½•ï¼Œè¿˜éœ€è¦é”ä½åè¾¹çš„ã€å› ä¸ºåè¾¹å¯èƒ½è¿˜ä¼šæ’å…¥c=5ã€‘ï¼Œå› æ­¤è¿˜éœ€è¦å‘åéå†ï¼Œç›´åˆ°c=10è¿™æ¡è®°å½•ï¼Œè®¿é—®åˆ°çš„éƒ½è¦åŠ é”ã€**åŸåˆ™2**ã€‘ï¼Œ**(5,10\]**
3.  **ä¼˜åŒ–2**ï¼šç­‰å€¼åˆ¤æ–­ï¼Œå‘å³éå†ï¼Œæœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³c=5è¿™ä¸ªç­‰å€¼æ¡ä»¶ï¼Œå› æ­¤é€€åŒ–æˆé—´éš™é”(5,10)ã€‚

å› æ­¤sessionCçš„æ“ä½œä¼šè¢«é˜»å¡ï¼Œè¿™æ˜¯å¯ä»¥ç†è§£çš„ã€‚é‚£sessionBå‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸ä¼šè¢«é˜»å¡å‘¢ï¼Ÿ

1.  æ ¹æ®åŸåˆ™2 ï¼Œ**åªæœ‰è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”**ï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¹¶ä¸éœ€è¦è®¿é—®ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä¸»é”®ç´¢å¼•ä¸Šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œå› æ­¤sessionCä¸ä¼šè¢«é˜»å¡ã€‚

##### é”çš„æ˜¯ç´¢å¼•

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ**lock in share modeåªé”è¦†ç›–ç´¢å¼•**ï¼Œä½†æ˜¯å¦‚æœæ˜¯**for update**å°±ä¸ä¸€æ ·äº†ã€‚ æ‰§è¡Œ for updateæ—¶ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºä½ æ¥ä¸‹æ¥è¦æ›´æ–°æ•°æ®ï¼Œå› æ­¤ä¼šé¡ºä¾¿**ç»™ä¸»é”®ç´¢å¼•ä¸Šæ»¡è¶³æ¡ä»¶çš„è¡ŒåŠ ä¸Šè¡Œé”ã€‚**

åŒæ—¶ï¼Œå¦‚æœä½ è¦ç”¨lock in share modeæ¥**ç»™è¡ŒåŠ è¯»é”é¿å…æ•°æ®è¢«æ›´æ–°**çš„è¯ï¼Œå°±**å¿…é¡»å¾—ç»•è¿‡è¦†ç›–ç´¢å¼•çš„ä¼˜åŒ–**ï¼Œåœ¨æŸ¥è¯¢å­—æ®µä¸­åŠ å…¥ç´¢å¼•ä¸­ä¸å­˜åœ¨çš„å­—æ®µã€‚  
æ¯”å¦‚ï¼Œå°†session Açš„æŸ¥è¯¢è¯­å¥æ”¹æˆ select d from t where c=5 lock in share modeã€‚

> è¿™æ ·å°±ä¸å¾—ä¸å›è¡¨ï¼Œå°±ä¼šæ¶‰åŠåˆ°ä¸»é”®ç´¢å¼•äº†ã€å…¶å®å°±æ˜¯è®©è¦†ç›–ç´¢å¼•å¤±æ•ˆã€‘

#### å”¯ä¸€ç´¢å¼•èŒƒå›´é”

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2008d50aa8a6485888242d14afcd1d91~tplv-k3u1fbpfcp-zoom-1.image)

1.  ç­‰å€¼æŸ¥è¯¢ï¼Œå…ˆç»™10åŠ ä¸Šé—´éš™é”ï¼Œ(5,10\]
2.  ä¼˜åŒ–1ï¼šé€€åŒ–æˆè¡Œé”ï¼Œåªé”10è¿™ä¸€è¡Œ
3.  ç”±äºæ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œç»§ç»­å¾€åéå†ï¼Œç›´åˆ°15è¿™ä¸€è¡Œåœä¸‹æ¥ï¼Œè®¿é—®åˆ°çš„éƒ½è¦åŠ next-key lockï¼Œ(10,15\]
4.  ç”±äº15ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œæ•…ä¼šé€€åŒ–ä¸ºé—´éš™é”ï¼Œ(10,15)

å› æ­¤æœ€åçš„èŒƒå›´æ˜¯\[10,15)ï¼ŒsessionBçš„ç¬¬äºŒæ¡insertä¼šè¢«é˜»å¡ï¼Œå…¶ä»–éƒ½ä¸ä¼š

#### éå”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/72c64f0d147749e0a1b1049dce3fa8a9~tplv-k3u1fbpfcp-zoom-1.image)

è·Ÿå”¯ä¸€ç´¢å¼•èŒƒå›´é”çš„åŒºåˆ«åœ¨äºï¼Œæ™®é€šç´¢å¼•ä¸­çš„next-key lockä¸ä¼šé€€åŒ–ä¸ºé—´éš™é”å’Œè®°å½•é”

1.  next-key lockï¼Œ**(5,10\]**ï¼Œç”±äºcä¸æ˜¯å”¯ä¸€ç´¢å¼•ï¼Œæ‰€ä»¥ä¸ä¼šé€€åŒ–ä¸ºè¡Œé”
2.  ç»§ç»­å¾€åéå†ï¼Œç›´åˆ°15ï¼Œnext-key lockï¼Œ**(10,15\]**

**å› æ­¤æœ€åçš„èŒƒå›´æ˜¯ï¼š(5,15\]ï¼Œä¸¤æ¡è¯­å¥éƒ½ä¼šè¢«é˜»å¡**

#### ğŸ”éç´¢å¼•æŸ¥è¯¢

å¦‚æœä½¿ç”¨çš„æ˜¯æ²¡æœ‰ç´¢å¼•çš„å­—æ®µï¼Œæ¯”å¦‚update user set age=7 where name=â€˜xxxï¼ˆå³ä½¿æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•æ•°æ®ï¼‰â€™,é‚£ä¹ˆ**ä¼šç»™å…¨è¡¨åŠ å…¥gapé”**ã€‚åŒæ—¶ï¼Œå®ƒä¸èƒ½åƒä¸Šæ–‡ä¸­è¡Œé”ä¸€æ ·ç»è¿‡MySQL Serverè¿‡æ»¤è‡ªåŠ¨è§£é™¤ä¸æ»¡è¶³æ¡ä»¶çš„é”ï¼Œå› ä¸ºæ²¡æœ‰ç´¢å¼•ï¼Œåˆ™è¿™äº›å­—æ®µä¹Ÿå°±æ²¡æœ‰æ’åºï¼Œä¹Ÿå°±æ²¡æœ‰åŒºé—´ã€‚é™¤éè¯¥äº‹åŠ¡æäº¤ï¼Œ**å¦åˆ™å…¶å®ƒäº‹åŠ¡æ— æ³•æ’å…¥ä»»ä½•æ•°æ®ã€‚**

ğŸˆæ­»é”
----

### é—´éš™é”æ­»é”

### é—´éš™é”æ½œåœ¨é—®é¢˜

æ³¨æ„ï¼Œé—´éš™é”ä¸é—´éš™é”ä¹‹é—´æ˜¯ä¸ä¼šå†²çªçš„

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af39731cbbff435d8080f3384fdce9aa~tplv-k3u1fbpfcp-zoom-1.image)

1.  session A æ‰§è¡Œ select â€¦ for update è¯­å¥ï¼Œç”±äº id=9 è¿™ä¸€è¡Œå¹¶ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šåŠ ä¸Šé—´éš™é” (5,10);
2.  session B æ‰§è¡Œ select â€¦ for update è¯­å¥ï¼ŒåŒæ ·ä¼šåŠ ä¸Šé—´éš™é” (5,10)ï¼Œ**é—´éš™é”ä¹‹é—´ä¸ä¼šå†²çª**ï¼Œå› æ­¤è¿™ä¸ªè¯­å¥å¯ä»¥æ‰§è¡ŒæˆåŠŸï¼›
3.  session B è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session A çš„é—´éš™é”æŒ¡ä½äº†ï¼Œåªå¥½è¿›å…¥ç­‰å¾…ï¼›
4.  session A è¯•å›¾æ’å…¥ä¸€è¡Œ (9,9,9)ï¼Œè¢« session B çš„é—´éš™é”æŒ¡ä½äº†ã€‚

*   ä¸¤ä¸ª session è¿›å…¥äº’ç›¸ç­‰å¾…çŠ¶æ€ï¼Œå½¢æˆæ­»é”ã€‚æ­¤æ—¶æˆ‘ä»¬æ¥çœ‹å¦‚ä½•åº”å¯¹æ­»é”...  
    

### è§£å†³æ­»é”æ–¹æ¡ˆ

1.  ç›´æ¥è¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ã€‚è¿™ä¸ªè¶…æ—¶æ—¶é—´å¯ä»¥é€šè¿‡å‚æ•° innodb\_lock\_wait\_timeout æ¥è®¾ç½®ã€‚
2.  å‘èµ·**æ­»é”æ£€æµ‹**ï¼Œå‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚å°†å‚æ•° innodb\_deadlock\_detect è®¾ç½®ä¸º onï¼Œè¡¨ç¤ºå¼€å¯è¿™ä¸ªé€»è¾‘ã€‚

å¦‚æœé€‰ç”¨ç¬¬ä¸€ç§ç­–ç•¥ï¼Œå…¶å®ä¸å¥½ä¼°é‡ï¼Œæˆ‘ä»¬ä¸ç¡®å®šè¿™ä¸ªè¶…æ—¶æ—¶é—´è¦è®¾ç½®ä¸ºå¤šå°‘åˆé€‚ï¼Œå› æ­¤ä¸€èˆ¬ä½¿ç”¨ç¬¬äºŒç§ç­–ç•¥ã€‚

> ä½†æ˜¯å®ƒä¹Ÿæ˜¯æœ‰é¢å¤–è´Ÿæ‹…çš„ã€‚

æ¯å½“ä¸€ä¸ªäº‹åŠ¡è¢«é”çš„æ—¶å€™ï¼Œå°±è¦çœ‹çœ‹å®ƒæ‰€ä¾èµ–çš„çº¿ç¨‹æœ‰æ²¡æœ‰è¢«åˆ«äººé”ä½ï¼Œå¦‚æ­¤å¾ªç¯ï¼Œæœ€ååˆ¤æ–­æ˜¯å¦å‡ºç°äº†**å¾ªç¯ç­‰å¾…ã€æ­»é”äº§ç”Ÿçš„æ¡ä»¶ä¹‹ä¸€ã€‘**ï¼Œä¹Ÿå°±æ˜¯æ­»é”ã€‚

æ¯ä¸ªæ–°æ¥çš„è¢«å µä½çš„çº¿ç¨‹ï¼Œéƒ½è¦åˆ¤æ–­ä¼šä¸ä¼šç”±äºè‡ªå·±çš„åŠ å…¥å¯¼è‡´äº†æ­»é”ï¼Œè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å¤æ‚åº¦æ˜¯ O(n) çš„æ“ä½œã€‚

åœ¨æ“ä½œç³»ç»Ÿé‡Œè¾¹ï¼Œåº”å¯¹æ­»é”çš„æœ€å¥½æ–¹æ³•æ˜¯ï¼šé¢„é˜²æ­»é”çš„äº§ç”Ÿhhhï¼Œè¿™ä¸ªé¢„é˜²ï¼Œå¯èƒ½å¾ˆéš¾è·Ÿæˆ‘ä»¬å¼€å‘å·¥ç¨‹å¸ˆç‰µæ‰¯ä¸Šï¼Œæ›´å¤šæ¶‰åŠåˆ°DBAé‚£è¾¹äº†ã€‚

### å¸¸è§çš„è§£å†³æ­»é”çš„æ–¹æ³•

1ã€å¦‚æœä¸åŒç¨‹åºä¼šå¹¶å‘å­˜å–å¤šä¸ªè¡¨ï¼Œå°½é‡çº¦å®šä»¥ç›¸åŒçš„é¡ºåºè®¿é—®è¡¨ï¼Œå¯ä»¥å¤§å¤§é™ä½æ­»é”æœºä¼šã€‚  
2ã€åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå°½å¯èƒ½åšåˆ°**ä¸€æ¬¡é”å®šæ‰€éœ€è¦çš„æ‰€æœ‰èµ„æº**ï¼Œå‡å°‘æ­»é”äº§ç”Ÿæ¦‚ç‡ï¼›  
3ã€å¯¹äºéå¸¸å®¹æ˜“äº§ç”Ÿæ­»é”çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å‡çº§é”å®šé¢—ç²’åº¦ï¼Œé€šè¿‡è¡¨çº§é”å®šæ¥å‡å°‘æ­»é”äº§ç”Ÿçš„æ¦‚ç‡ï¼›  
å¦‚æœä¸šåŠ¡å¤„ç†ä¸å¥½å¯ä»¥ç”¨åˆ†å¸ƒå¼äº‹åŠ¡é”æˆ–è€…ä½¿ç”¨ä¹è§‚é”  

æ€»ç»“
==

è¿˜æ˜¯é‚£å¼ è„‘å›¾ï¼Œå†çœ‹ä¸€éï¼Œå°è¯•å¤è¿°å‡ºæ¥ï¼Œå°±è¿‡å…³å•¦

![é”æœºåˆ¶&&äº‹åŠ¡.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8a5931d0fc79433fa003e998aafed97d~tplv-k3u1fbpfcp-watermark.image?)

ğŸ’ ä¸‹ç¯‡é¢„å‘Š
======

è¿™ç¯‡æˆ‘ä»¬ä¸»è¦è®²çš„æ˜¯é”ç›¸å…³çš„çŸ¥è¯†ï¼Œäº‹åŠ¡åªæ˜¯å…¥äº†é—¨ï¼Œå…³äº**äº‹åŠ¡èƒŒåçš„åŸç†**ï¼Œä»¥åŠ**MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶**ï¼Œè¿™äº›æˆ‘ä»¬ç•™åˆ°åè¾¹å†æ¥è¯¦è§£ã€‚

ğŸ–¨å‚è€ƒæ–‡çŒ®
======

*   [å°æ—coding](https://xiaolincoding.com/mysql/lock/mysql_lock.html#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81)
*   MySQL45è®²
*   é»‘é©¬MySQLè§†é¢‘

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/338d60ebfd6542e3809c12a0f9b12eba~tplv-k3u1fbpfcp-watermark.image)

> æ”¶è—=ç™½å«–ï¼Œç‚¹èµ+å…³æ³¨æ‰æ˜¯çœŸçˆ±ï¼ï¼ï¼æœ¬ç¯‡æ–‡ç« å¦‚æœ‰ä¸å¯¹ä¹‹å¤„ï¼Œè¿˜è¯·åœ¨è¯„è®ºåŒºæŒ‡å‡ºï¼Œæ¬¢è¿æ·»åŠ æˆ‘çš„å¾®ä¿¡ä¸€èµ·äº¤æµï¼š**Melo\_\_Jun**

ğŸ§¿å‹é“¾
====

*   [MySQLé«˜çº§ç¯‡ä¸“æ ](https://juejin.cn/column/7060377126666502157)
    
*   [ğŸ‰æˆ‘çš„ä¸€å¹´åå°ç»ƒä¹ ç”Ÿæ¶¯](https://juejin.cn/post/7047707966187208711)
    
*   [èŠèŠJava](https://juejin.cn/column/7025173818280771614)
    
*   [åˆ†å¸ƒå¼å¼€å‘å®æˆ˜](https://juejin.cn/column/7019916554053615652)
    
*   [Rediså…¥é—¨ä¸å®æˆ˜](https://juejin.cn/column/7028537737347072037)
    
*   [æ•°æ®ç»“æ„ä¸ç®—æ³•](https://juejin.cn/column/7005759018002186247)