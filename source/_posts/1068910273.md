---
layout: post
title: "SQLSERVER å±…ç„¶ä¹Ÿèƒ½è°ƒ C# ä»£ç  ?"
date: "2023-01-03T10:17:16.865Z"
---
SQLSERVER å±…ç„¶ä¹Ÿèƒ½è°ƒ C# ä»£ç  ?
=======================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰äº›å¤©çœ‹åˆ°ä¸€ä¸ªå¥‡æ€ªçš„ Function å‡½æ•°ï¼Œè°ƒç”¨çš„æ˜¯ C# é“¾æ¥åº“ä¸­çš„ä¸€ä¸ª UserLogin æ–¹æ³•ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    CREATE FUNCTION dbo.clr_UserLogin
    (
        @name	AS  NVARCHAR(100),
        @password AS NVARCHAR(100)
    )
    RETURNS INT 
    AS
    EXTERNAL NAME asmXXX.[xxx.CLRFunctions].UserLogin;
    GO
    
    

è¿™å°±è®©æˆ‘äº§ç”Ÿäº†å¾ˆå¤§çš„å…´è¶£ï¼Œä¼—æ‰€å‘¨çŸ¥ SQLSERVER æ˜¯ C++ å†™çš„ï¼Œé‚£è¿™é‡Œçš„ C++ æ€ä¹ˆå’Œ C# æ‰“é€šå‘¢ï¼Ÿ è€Œä¸” C# æ˜¯ä¸€é—¨æ‰˜ç®¡è¯­è¨€ï¼Œéœ€è¦ JIT å°†å…¶ native åŒ–ï¼Œè¿™ä¸ª JIT åˆåœ¨å“ªé‡Œå‘¢ï¼Ÿ å¸¦ç€è¿™äº›ç–‘é—®ä¸€èµ·ç ”ç©¶ä¸‹å§ã€‚

äºŒï¼šäº’é€šåŸç†ç ”ç©¶
--------

### 1\. ä¸€ä¸ªç®€å•çš„ä¾‹å­

é¦–å…ˆå†™ä¸€æ®µç®€å•çš„ C# ä»£ç ï¼Œç„¶åæŠŠå®ƒç¼–è¯‘æˆ dllã€‚

    
    namespace AQMN.Bussiness
    {
        public class UserFunctions
        {
            public static string UserLogin(string username, string password)
            {
                var random = new Random();
    
                var isSuccess = random.Next() % 2 == 0;
    
                return isSuccess ? "ç™»å½•æˆåŠŸ" : "ç™»å½•å¤±è´¥";
            }
        }
    }
    
    

æ¥ä¸‹æ¥éœ€è¦åšçš„å°±æ˜¯æ•°æ®åº“å‚æ•°é…ç½®ï¼Œå¼€å¯ CLR æ”¯æŒï¼Œå¹¶ä¸”æŒ‡å®šæŸä¸ªæ•°æ®åº“æ”¯æŒ `unsafe` æ¨¡å¼ã€‚

    
    EXEC sp_configure 'clr enabled', 1;
    RECONFIGURE;
    GO
    
    ALTER DATABASE MyTestDB SET TRUSTWORTHY ON;
    GO
    
    

ä¸ºäº†èƒ½å¤Ÿè°ƒåˆ° C# çš„ `UserLogin` æ–¹æ³•ï¼Œéœ€è¦ SQLSERVER å…ˆå¯¼å…¥è¿™ä¸ªç¨‹åºé›†ï¼Œç„¶åå†ä»¥ Function æ˜ å°„å…¶ä¸­æ–¹æ³•å³å¯ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    CREATE ASSEMBLY clr_AQMN_Bussiness
    FROM 'D:\net6\SQLCrawl\AQMN.Bussiness\bin\Debug\AQMN.Bussiness.dll'
    WITH PERMISSION_SET = UNSAFE;
    GO
    
    CREATE FUNCTION dbo.clr_UserLogin
    (
        @username AS NVARCHAR(100),
    	@password AS NVARCHAR(100)
    )
    RETURNS NVARCHAR(100)
    AS
    EXTERNAL NAME clr_AQMN_Bussiness.[AQMN.Bussiness.UserFunctions].UserLogin;
    GO
    
    

åˆ›å»ºå®Œäº†ä¹‹åï¼Œå¯ä»¥è§‚å¯Ÿ `assembly` å¼€å¤´çš„å‡ ä¸ªç³»ç»Ÿè§†å›¾ã€‚

    
    SELECT * FROM sys.assemblies
    SELECT * FROM sys.assembly_files;
    SELECT * FROM sys.assembly_modules;
    
    

![](https://img2023.cnblogs.com/blog/214741/202301/214741-20230103105307010-1793853725.png)

çœ‹èµ·æ¥æ²¡å•¥é—®é¢˜ï¼Œæ¥ä¸‹æ¥è°ƒç”¨ä¸€ä¸‹åˆšæ‰åˆ›å»ºçš„ `clr_UserLogin` å‡½æ•°ã€‚

    
    SELECT dbo.clr_UserLogin(N'jack',N'123456') AS 'State'
    GO 10
    
    

![](https://img2023.cnblogs.com/blog/214741/202301/214741-20230103105306998-1283443285.png)

ä»å›¾ä¸­çœ‹ç™»å½•ç»“æœæ˜¯éšæœºçš„ï¼Œè¯´æ˜ C# çš„ Random å‡½æ•°èµ·åˆ°äº†ä½œç”¨ï¼Œéå¸¸æœ‰æ„æ€ã€‚

### 2\. WinDbg è§‚å¯Ÿ

ä»æ¡ˆä¾‹çš„è¿è¡Œç»“æœçœ‹ï¼Œæ¨æµ‹åœ¨ SQLSERVER ä¸­åº”è¯¥æ‰¿è½½äº†ä¸€ä¸ª CLR è¿è¡Œç¯å¢ƒï¼Œé‚£æ˜¯ä¸æ˜¯è¿™æ ·å‘¢ï¼Ÿå¯ä»¥ç”¨ WinDbg é™„åŠ åˆ° `sqlservr.exe` è¿›ç¨‹ï¼Œç”¨ lm è§‚å¯Ÿä¸‹æ¨¡å—åŠ è½½æƒ…å†µã€‚

    
    0:092> lm
    start             end                 module name
    
    ...
    00007ff8`d3960000 00007ff8`d3aaf000   clrjit     (deferred)    
    00007ff8`de040000 00007ff8`deb02000   clr        (deferred)     
    ...
    
    0:092> !eeversion
    4.8.4300.0 free
    Server mode with 12 gc heaps
    SOS Version: 4.8.4300.0 retail build
    
    

ä»è¾“å‡ºçœ‹æœç„¶åŠ è½½äº† `clr` å’Œ `clrjit` åŠ¨æ€é“¾æ¥åº“ï¼Œå½“å‰è¿˜æ˜¯ `gc server` æ¨¡å¼ï¼ŒğŸ‚å“ˆã€‚

æ¥ä¸‹æ¥å†éªŒè¯ä¸€ä¸ªé—®é¢˜ï¼Œæ—¢ç„¶ `clr_UserLogin` å‡½æ•°ä¼šæ˜¾ç¤º `ç™»å½•æˆåŠŸ/ç™»å½•å¤±è´¥`ï¼Œé‚£å¿…ç„¶ä¼šè°ƒç”¨ C# çš„ `UserLogin` æ–¹æ³•ï¼Œå¯ä»¥åœ¨ `WinDbg` ä¸­å¯¹ `UserLogin` æ–¹æ³•ä¸‹ä¸€ä¸ªæ–­ç‚¹è§‚å¯Ÿä¸€ä¸‹è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹ã€‚

    
    0:090> !name2ee AQMN.Bussiness!AQMN.Bussiness.UserFunctions.UserLogin
    Module:      00007ff87ee37988
    Assembly:    AQMN.Bussiness, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null
    Token:       0000000006000001
    MethodDesc:  00007ff87ee38020
    Name:        AQMN.Bussiness.UserFunctions.UserLogin(System.String, System.String)
    JITTED Code Address: 00007ff87ec560d0
    
    0:090> bp 00007ff87ec560d0
    0:090> g
    
    

ä»è¾“å‡ºä¿¡æ¯çœ‹ UserLogin æ–¹æ³•å·²ç»è¢« JIT è¿‡äº†ï¼Œç”¨ bp ä¸‹å®Œæ–­ç‚¹ä¹‹åï¼Œç»§ç»­ gï¼Œç„¶ååœ¨ SSMS ä¸Šå†æ¬¡æ‰§è¡ŒæŸ¥è¯¢å°±å¯ä»¥æˆåŠŸå‘½ä¸­å•¦ã€‚

    
    0:090> k
     # Child-SP          RetAddr               Call Site
    00 000000df`1557ae48 00007ff8`7ee500b6     0x00007ff8`7ec560d0
    01 000000df`1557ae50 00007ff8`7ec55ef1     0x00007ff8`7ee500b6
    02 000000df`1557aeb0 00007ff8`de04222e     0x00007ff8`7ec55ef1
    03 000000df`1557af00 00007ff8`a2b79ff3     clr!UMThunkStub+0x6e
    04 000000df`1557af90 00007ff8`a2b741bd     sqllang!CallProtectorImpl::CallWithSEH<AppDomainCallTraits,void,FunctionCallBinder_3<void,void (__cdecl*)(void (__cdecl*)(void * __ptr64),void * __ptr64,enum ESqlReturnCode * __ptr64),void (__cdecl*)(void * __ptr64),void * __ptr64,enum ESqlReturnCode * __ptr64> const >+0x23
    05 000000df`1557afc0 00007ff8`a2b6bfc4     sqllang!CallProtectorImpl::CallExternalFull<AppDomainUserCallTraits,void,FunctionCallBinder_3<void,void (__cdecl*)(CXVariant * __ptr64,CXVariant * __ptr64,CClrLobContext * __ptr64),CXVariant * __ptr64,CXVariant * __ptr64,CClrLobContext * __ptr64> const >+0x2dd
    06 000000df`1557b130 00007ff8`a2bda602     sqllang!CAppDomain::InvokeClrFn+0xd4
    07 000000df`1557b1d0 00007ff8`aef51ee7     sqllang!UDFInvokeExternalImpl+0xb72
    08 000000df`1557b7e0 00007ff8`9de52e24     sqlTsEs!CEsExec::GeneralEval4+0xe7
    09 000000df`1557b8b0 00007ff8`9de52d64     sqlmin!CQScanProjectNew::EvalExprs+0x18f
    0a 000000df`1557b920 00007ff8`9ddd8759     sqlmin!CQScanProjectNew::GetRow+0x98
    0b 000000df`1557b970 00007ff8`9ddc73de     sqlmin!CQScanLightProfileNew::GetRow+0x19
    0c 000000df`1557b9a0 00007ff8`a25e51d7     sqlmin!CQueryScan::GetRow+0x80
    0d 000000df`1557b9d0 00007ff8`a32a78b2     sqllang!CXStmtQuery::ErsqExecuteQuery+0x3d8
    0e 000000df`1557bb40 00007ff8`a2bc2451     sqllang!CXStmtSelect::XretDoExecute+0x342
    0f 000000df`1557bc10 00007ff8`a2b733d3     sqllang!UM_LoopbackForStatementExecution+0x191
    10 000000df`1557bd00 00007ff8`de48e940     sqllang!AppDomainCallback<FunctionCallBinder_5<void,void (__cdecl*)(CXStmtQuery * __ptr64,CCompExecCtxtStmt const * __ptr64,CMsqlExecContext * __ptr64,unsigned long * __ptr64,enum ESqlReturnCode * __ptr64),CXStmtQuery * __ptr64,CCompExecCtxtStmt const * __ptr64,CMsqlExecContext * __ptr64,unsigned long * __ptr64,enum ESqlReturnCode * __ptr64> >+0x23
    11 000000df`1557bd40 00007ff8`de48e193     clr!ExecuteInAppDomainHelper+0x40
    12 000000df`1557bd80 00007ff8`a2b79f39     clr!CorHost2::ExecuteInAppDomain+0x3a0
    13 000000df`1557c0a0 00007ff8`a2b73a86     sqllang!CallProtectorImpl::CallWithSEH<AppDomainCallTraits,long,MethodCallBinder_3<long,ICLRRuntimeHost,long (__cdecl ICLRRuntimeHost::*)(unsigned long,long (__cdecl*)(void * __ptr64),void * __ptr64) __ptr64,unsigned long,long (__cdecl*)(void * __ptr64),void * __ptr64> >+0x29
    14 000000df`1557c0d0 00007ff8`a2b6c2d0     sqllang!CallProtectorImpl::CallExternalFull<AppDomainCallTraits,long,MethodCallBinder_3<long,ICLRRuntimeHost,long (__cdecl ICLRRuntimeHost::*)(unsigned long,long (__cdecl*)(void * __ptr64),void * __ptr64) __ptr64,unsigned long,long (__cdecl*)(void * __ptr64),void * __ptr64> >+0x186
    15 000000df`1557c170 00007ff8`a32a72f4     sqllang!CAppDomain::LoopbackForStatementExecution+0x180
    16 000000df`1557c230 00007ff8`a32a79ad     sqllang!CXStmtQuery::XretCLRExecute+0x104
    17 000000df`1557c2a0 00007ff8`a25e4a65     sqllang!CXStmtSelect::XretExecute+0x4a
    18 000000df`1557c370 00007ff8`a25e44a8     sqllang!CMsqlExecContext::ExecuteStmts<1,1>+0x8f2
    19 000000df`1557cf10 00007ff8`a25e3a2c     sqllang!CMsqlExecContext::FExecute+0x936
    1a 000000df`1557def0 00007ff8`a25ee67b     sqllang!CSQLSource::Execute+0xc5c
    1b 000000df`1557e3d0 00007ff8`a25ed815     sqllang!process_request+0xca6
    1c 000000df`1557ead0 00007ff8`a25ed5ef     sqllang!process_commands_internal+0x4b7
    1d 000000df`1557ec00 00007ff8`b1e46523     sqllang!process_messages+0x1d6
    1e 000000df`1557ede0 00007ff8`b1e46e6d     sqldk!SOS_Task::Param::Execute+0x232
    1f 000000df`1557f3e0 00007ff8`b1e46c75     sqldk!SOS_Scheduler::RunTask+0xa5
    20 000000df`1557f450 00007ff8`b1e6b160     sqldk!SOS_Scheduler::ProcessTasks+0x39d
    21 000000df`1557f570 00007ff8`b1e6aa5b     sqldk!SchedulerManager::WorkerEntryPoint+0x2a1
    22 000000df`1557f640 00007ff8`b1e6afa4     sqldk!SystemThreadDispatcher::ProcessWorker+0x3ed
    23 000000df`1557f940 00007ff8`f6d86fd4     sqldk!SchedulerManager::ThreadEntryPoint+0x3b5
    24 000000df`1557fa30 00007ff8`f865cec1     KERNEL32!BaseThreadInitThunk+0x14
    25 000000df`1557fa60 00000000`00000000     ntdll!RtlUserThreadStart+0x21
    
    

æœç„¶æ˜¯ä¸€ä¸ª request è¯·æ±‚ï¼Œç„¶åè¾¾åˆ°äº†æ‰˜ç®¡æ–¹æ³• `UserLogin`ï¼Œé¡¶éƒ¨çš„ä¸‰è¡Œçº¿ç¨‹æ ˆå¯ä»¥ç”¨ `!clrstack` å…·æ„ä¸‹ã€‚

    
    0:090> !clrstack
    OS Thread Id: 0x6df4 (90)
            Child SP               IP Call Site
    000000df1557ae48 00007ff87ec560d0 AQMN.Bussiness.UserFunctions.UserLogin(System.String, System.String)
    000000df1557ae50 00007ff87ee500b6 DynamicClass.SQLCLR_Eval(IntPtr, IntPtr, IntPtr)
    000000df1557aeb0 00007ff87ec55ef1 DomainBoundILStubClass.IL_STUB_ReversePInvoke(Int64, Int64, Int64)
    000000df1557bf18 00007ff8de04222e [ContextTransitionFrame: 000000df1557bf18] 
    
    

ä¸‰ï¼šæ€»ç»“
----

SQLSERVER å†…åµŒäº† CLRï¼Œè®© sqlservr è¿›ç¨‹æˆäº†ä¸€ç§æ‰˜ç®¡å’Œéæ‰˜ç®¡çš„æ··åˆç¯å¢ƒï¼Œä¸çŸ¥é“æ˜¯å¥½äº‹è¿˜æ˜¯åäº‹ï¼Œåœ¨æˆ‘çš„åˆ†ææ—…ç¨‹ä¸­è¿™ç§æ··åˆç¯å¢ƒä¸‹çœ‹è¿‡å¤ªå¤šçš„**å †ç ´å**é—®é¢˜ï¼Œä½†ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæ‰˜ç®¡çš„ C#ï¼ŒVBï¼ŒF# å¯ä»¥åŠ© SQLSERVER æ›´åŠ å¼ºå¤§ã€‚