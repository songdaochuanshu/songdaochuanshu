---
layout: post
title: "å¼‚æ­¥ç¼–æ’ Spring(çº¿ç¨‹æ± )"
date: "2022-11-15T09:19:01.235Z"
---
å¼‚æ­¥ç¼–æ’ Spring(çº¿ç¨‹æ± )
================

ç›®å½•

*   [å¼‚æ­¥ç¼–æ’](#å¼‚æ­¥ç¼–æ’)
    *   [CompletableFuture çš„è¯¦è§£](#completablefuture-çš„è¯¦è§£)
        *   [ä»£ç æµ‹è¯•](#ä»£ç æµ‹è¯•)
            *   [é…ç½®ç±»çš„å¼•å…¥](#é…ç½®ç±»çš„å¼•å…¥)
            *   [Demo1](#demo1)
            *   [Demo2](#demo2)
    *   [CompletableFutureçš„asyncåç¼€å‡½æ•°ä¸ä¸å¸¦asyncçš„å‡½æ•°çš„åŒºåˆ«](#completablefutureçš„asyncåç¼€å‡½æ•°ä¸ä¸å¸¦asyncçš„å‡½æ•°çš„åŒºåˆ«)
    *   [ThreadPoolTaskExecutor å’Œ ThreadPoolExecutor çš„åŒºåˆ«](#threadpooltaskexecutor-å’Œ-threadpoolexecutor-çš„åŒºåˆ«)
*   [Spring çº¿ç¨‹æ± çš„ä½¿ç”¨](#spring-çº¿ç¨‹æ± çš„ä½¿ç”¨)
    *   [ä¸šåŠ¡ä½¿ç”¨å¤šçº¿ç¨‹çš„åŸå› ](#ä¸šåŠ¡ä½¿ç”¨å¤šçº¿ç¨‹çš„åŸå› )
        *   [åœºæ™¯ä¸€:](#åœºæ™¯ä¸€)
        *   [åœºæ™¯äºŒ:](#åœºæ™¯äºŒ)
    *   [FutureTaskä»‹ç»](#futuretaskä»‹ç»)
    *   [çº¿ç¨‹æ± ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é˜»å¡é˜Ÿåˆ—](#çº¿ç¨‹æ± ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é˜»å¡é˜Ÿåˆ—)
    *   [Spring å¸¸ç”¨çš„çº¿ç¨‹æ± çš„ä½¿ç”¨](#spring-å¸¸ç”¨çš„çº¿ç¨‹æ± çš„ä½¿ç”¨)
        *   [åºåˆ—](#åºåˆ—)
        *   [å¸¸è§„ä½¿ç”¨](#å¸¸è§„ä½¿ç”¨)
        *   [å¼‚æ­¥ä½¿ç”¨](#å¼‚æ­¥ä½¿ç”¨)

å¼‚æ­¥ç¼–æ’
====

æºç ä½ç½®ï¼š [GitHub](https://github.com/Rain-with-me/JavaStudyCode/tree/master/09-springboot-async)

  
  

CompletableFuture çš„è¯¦è§£
---------------------

  

ğŸ«Â å®ƒå°±æ˜¯åˆ›å»ºä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œç„¶ååœ¨å¹²ä»€ä¹ˆ,å¯ä»¥ä½¿ç”¨å¤šä»»åŠ¡ç»„åˆ

  

*   åˆ›å»ºä»»åŠ¡çš„æ–¹æ³•

    static CompletableFuture<Void> runAsync(Runnable runnable)
    public static CompletableFuture<Void> runAsync(Runnable runnable, Executor executor)
    public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier)
    public static <U> CompletableFuture<U> supplyAsync(Supplier<U> supplier, Executor executor)
    

  
  

*   ç„¶åç»§ç»­ä¸Šä¸€æ®µçš„ä»»åŠ¡(é‡Œé¢åŒ…å«äº†ä¸²è¡Œï¼ŒANDï¼ŒOR)

ğŸš© ä¸²è¡Œï¼š

    public <U> CompletableFuture<U> thenApply(Function<? super T,? extends U> fn)
    public <U> CompletableFuture<U> thenApplyAsync(Function<? super T,? extends U> fn)
    public <U> CompletableFuture<U> thenApplyAsync(Function<? super T,? extends U> fn, Executor executor)
    
    public CompletionStage<Void> thenAccept(Consumer<? super T> action);
    public CompletionStage<Void> thenAcceptAsync(Consumer<? super T> action);
    public CompletionStage<Void> thenAcceptAsync(Consumer<? super T> action,Executor executor);
    
    public CompletionStage<Void> thenRun(Runnable action);
    public CompletionStage<Void> thenRunAsync(Runnable action);
    public CompletionStage<Void> thenRunAsync(Runnable action,Executor executor);
    

    Function<? super T,? extends U>
    Tï¼šä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›ç»“æœçš„ç±»å‹
    Uï¼šå½“å‰ä»»åŠ¡çš„è¿”å›å€¼ç±»å‹
    

  

å‚æ•°è§£æï¼š

    thenApply æ–¹æ³•ï¼šå½“ä¸€ä¸ªçº¿ç¨‹ä¾èµ–å¦ä¸€ä¸ªçº¿ç¨‹æ—¶ï¼Œè·å–ä¸Šä¸€ä¸ªä»»åŠ¡è¿”å›çš„ç»“æœï¼Œå¹¶è¿”å›å½“å‰ä»»åŠ¡çš„è¿”å›å€¼ã€‚(æ¥æ”¶ä¸Šä¸€é˜¶æ®µä»»åŠ¡ç»“æœ,è¿”å›ç»“æœ)
    
    thenAcceptæ–¹æ³•ï¼šæ¶ˆè´¹å¤„ç†ç»“æœã€‚æ¥æ”¶ä»»åŠ¡çš„å¤„ç†ç»“æœï¼Œå¹¶æ¶ˆè´¹å¤„ç†ï¼Œæ— è¿”å›ç»“æœã€‚  (æ¥æ”¶ä¸Šä¸€é˜¶æ®µä»»åŠ¡ç»“æœ,ä¸è¿”å›ç»“æœ)
    
    thenRunæ–¹æ³•ï¼šä¸æ¥æ”¶ä¸Šä¸€é˜¶æ®µä»»åŠ¡ç»“æœï¼Œå¹¶ä¸”æ— è¿”å›å€¼
    
    å¸¦æœ‰Asyncé»˜è®¤æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚è¿™é‡Œæ‰€è°“çš„å¼‚æ­¥æŒ‡çš„æ˜¯ä¸åœ¨å½“å‰çº¿ç¨‹å†…æ‰§è¡Œã€‚
    

  
  

ğŸš¡ AND

    public <U,V> CompletionStage<V> thenCombineAsync (CompletionStage<? extends U> other,BiFunction<? super T,? super U,? extends V> fn,Executor executor);
    - ä¸Šä¸€é˜¶æ®µä»»åŠ¡ä¸otherä»»åŠ¡å‡æ‰§è¡Œç»“æŸï¼Œæ¥æ”¶ä¸¤ä¸ªä»»åŠ¡çš„ç»“æœï¼Œå¹¶å¯è·å–è¿”å›å€¼
    
    public <U> CompletionStage<U> thenComposeAsync(Function<? super T, ? extends CompletionStage<U>> fn,
             Executor executor);
    - ä½¿ç”¨ä¸Šä¸€é˜¶æ®µä»»åŠ¡çš„ç»“æœï¼Œè¿”å›ä¸€ä¸ªæ–°çš„CompletableFutureå®ä¾‹
    

  

æ›´å¤šçš„å‚æ•°è¯¦è§£ï¼š \[åšå®¢é“¾æ¥\]([CompletableFuture å¼‚æ­¥ç¼–æ’ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7138797715072221220#heading-9))

  

*   å¤šä»»åŠ¡ç»„åˆ

  

    public static CompletableFuture<Void> allOf(CompletableFuture<?>... cfs);
    
    public static CompletableFuture<Object> anyOf(CompletableFuture<?>... cfs);
    

  

### ä»£ç æµ‹è¯•

  

#### é…ç½®ç±»çš„å¼•å…¥

  
  

yml

    thread:
      pool:
        corePoolSize: 4
        maxPoolSize: 8
        workQueue: 25
        keepAliveTime: 30
    

  

config

    import org.springframework.boot.context.properties.ConfigurationProperties;
    import org.springframework.context.annotation.Bean;
    import org.springframework.context.annotation.Configuration;
    import org.springframework.scheduling.annotation.AsyncConfigurer;
    import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
    import java.util.concurrent.Executor;
    import java.util.concurrent.ThreadPoolExecutor;
    
    @Configuration
    @ConfigurationProperties(prefix = "thread.pool")
    public class AsyncConfig{
        //æ ¸å¿ƒçº¿ç¨‹æ•°é‡å¤§å°
        private   int corePoolSize = 4;
        //çº¿ç¨‹æ± æœ€å¤§å®¹çº³çº¿ç¨‹æ•°
        private   int maxPoolSize =8;
        //é˜»å¡é˜Ÿåˆ—
        private   int workQueue = 25;
        //çº¿ç¨‹ç©ºé—²åçš„å­˜æ´»æ—¶é•¿
        private   int keepAliveTime = 30;
    
        @Bean("asyncTaskExecutor")
        public Executor getAsyncExecutor() {
            ThreadPoolTaskExecutor threadPoolTaskExecutor = new ThreadPoolTaskExecutor();
            //æ ¸å¿ƒçº¿ç¨‹æ•°
            threadPoolTaskExecutor.setCorePoolSize(corePoolSize);
            //æœ€å¤§çº¿ç¨‹æ•°
            threadPoolTaskExecutor.setMaxPoolSize(maxPoolSize);
            //ç­‰å¾…é˜Ÿåˆ—
            threadPoolTaskExecutor.setQueueCapacity(workQueue);
            //çº¿ç¨‹å‰ç¼€
            threadPoolTaskExecutor.setThreadNamePrefix("taskExecutor-");
            //çº¿ç¨‹æ± ç»´æŠ¤çº¿ç¨‹æ‰€å…è®¸çš„ç©ºé—²æ—¶é—´,å•ä½ä¸ºç§’
            threadPoolTaskExecutor.setKeepAliveSeconds(keepAliveTime);
            // çº¿ç¨‹æ± å¯¹æ‹’ç»ä»»åŠ¡(æ— çº¿ç¨‹å¯ç”¨)çš„å¤„ç†ç­–ç•¥
            threadPoolTaskExecutor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
            threadPoolTaskExecutor.initialize();
            return threadPoolTaskExecutor;
        }
    }
    

  
  

ğŸ«Â å‚æ•°è¯¦è§£ï¼š å»ºè®®çœ‹çœ‹ä¸‹é¢çš„çº¿ç¨‹æ± å¯¹æ‹’ç»ä»»åŠ¡(æ— çº¿ç¨‹å¯ç”¨)çš„å¤„ç†ç­–ç•¥

        1ã€corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°
            * æ ¸å¿ƒçº¿ç¨‹ä¼šä¸€ç›´å­˜æ´»ï¼ŒåŠæ—¶æ²¡æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œ
            * å½“çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œå³ä½¿æœ‰çº¿ç¨‹ç©ºé—²ï¼Œçº¿ç¨‹æ± ä¹Ÿä¼šä¼˜å…ˆåˆ›å»ºæ–°çº¿ç¨‹å¤„ç†
            * è®¾ç½®allowCoreThreadTimeout=trueï¼ˆé»˜è®¤falseï¼‰æ—¶ï¼Œæ ¸å¿ƒçº¿ç¨‹ä¼šè¶…æ—¶å…³é—­
     
        2ã€queueCapacityï¼šä»»åŠ¡é˜Ÿåˆ—å®¹é‡ï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰
            * å½“æ ¸å¿ƒçº¿ç¨‹æ•°è¾¾åˆ°æœ€å¤§æ—¶ï¼Œæ–°ä»»åŠ¡ä¼šæ”¾åœ¨é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…æ‰§è¡Œ
     
        3ã€maxPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°
            * å½“çº¿ç¨‹æ•°>=corePoolSizeï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡æ—¶ã€‚çº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡
            * å½“çº¿ç¨‹æ•°=maxPoolSizeï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šæ‹’ç»å¤„ç†ä»»åŠ¡è€ŒæŠ›å‡ºå¼‚å¸¸
     
        4ã€ keepAliveTimeï¼šçº¿ç¨‹ç©ºé—²æ—¶é—´
            * å½“çº¿ç¨‹ç©ºé—²æ—¶é—´è¾¾åˆ°keepAliveTimeæ—¶ï¼Œçº¿ç¨‹ä¼šé€€å‡ºï¼Œç›´åˆ°çº¿ç¨‹æ•°é‡=corePoolSize
            * å¦‚æœallowCoreThreadTimeout=trueï¼Œåˆ™ä¼šç›´åˆ°çº¿ç¨‹æ•°é‡=0
     
        5ã€allowCoreThreadTimeoutï¼šå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶
        6ã€rejectedExecutionHandlerï¼šä»»åŠ¡æ‹’ç»å¤„ç†å™¨
            * ä¸¤ç§æƒ…å†µä¼šæ‹’ç»å¤„ç†ä»»åŠ¡ï¼š
                - å½“çº¿ç¨‹æ•°å·²ç»è¾¾åˆ°maxPoolSizeï¼Œåˆ‡é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šæ‹’ç»æ–°ä»»åŠ¡
                - å½“çº¿ç¨‹æ± è¢«è°ƒç”¨shutdown()åï¼Œä¼šç­‰å¾…çº¿ç¨‹æ± é‡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå†shutdownã€‚å¦‚æœåœ¨è°ƒç”¨shutdown()å’Œçº¿ç¨‹æ± çœŸæ­£shutdownä¹‹é—´æäº¤ä»»åŠ¡ï¼Œä¼šæ‹’ç»æ–°ä»»åŠ¡
            * çº¿ç¨‹æ± ä¼šè°ƒç”¨rejectedExecutionHandleræ¥å¤„ç†è¿™ä¸ªä»»åŠ¡ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤æ˜¯AbortPolicyï¼Œä¼šæŠ›å‡ºå¼‚å¸¸
            * ThreadPoolExecutorç±»æœ‰å‡ ä¸ªå†…éƒ¨å®ç°ç±»æ¥å¤„ç†è¿™ç±»æƒ…å†µï¼š
                - AbortPolicy ä¸¢å¼ƒä»»åŠ¡ï¼ŒæŠ›è¿è¡Œæ—¶å¼‚å¸¸ï¼ˆé»˜è®¤ï¼‰
                - CallerRunsPolicy æ‰§è¡Œä»»åŠ¡
                - DiscardPolicy å¿½è§†ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ
                - DiscardOldestPolicy ä»é˜Ÿåˆ—ä¸­è¸¢å‡ºæœ€å…ˆè¿›å…¥é˜Ÿåˆ—ï¼ˆæœ€åä¸€ä¸ªæ‰§è¡Œï¼‰çš„ä»»åŠ¡
            * å®ç°RejectedExecutionHandleræ¥å£ï¼Œå¯è‡ªå®šä¹‰å¤„ç†å™¨
    

  
  

#### Demo1

  

![image-20221115170031342](https://img2022.cnblogs.com/blog/2418351/202211/2418351-20221115170334172-451983912.png)

  
  

            CompletableFuture<String> task1 = CompletableFuture.supplyAsync(() -> {
                System.out.println("æ´—æ°´å£¶");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
                return "æ°´å£¶";
            }).thenApply(e->{
                System.out.println("çƒ§æ°´");
                try {
                    Thread.sleep(5000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
                return "çƒ­æ°´";
            });
            //æ´—æ°´å£¶->æ´—æ°´æ¯->æ‹¿èŒ¶å¶
            CompletableFuture<String> task2 = CompletableFuture.supplyAsync(() -> {
                System.out.println("æ´—èŒ¶å£¶");
                try {
                    Thread.sleep(1000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
                return "èŒ¶å£¶";
            }).thenApply(e->{
                try {
                    Thread.sleep(2000);
                } catch (InterruptedException ex) {
                    ex.printStackTrace();
                }
                System.out.println("æ´—æ°´æ¯");
                return "æ°´æ¯";
            }).thenApply(e->{
                System.out.println("æ‹¿èŒ¶å¶");
                return "èŒ¶å¶";
            });
            //æ³¡èŒ¶
            CompletableFuture<String> task3 = task1.thenCombine(task2, (a, b) -> {
                System.out.println("æ³¡èŒ¶");
                return "èŒ¶";
            });
            String tea = task3.join();
            System.out.println(tea);
    

  

ğŸ« å‚æ•°è§£æï¼š

æ›´å¤šçš„å‚æ•°è¯¦è§£ï¼š \[åšå®¢é“¾æ¥\]([CompletableFuture å¼‚æ­¥ç¼–æ’ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7138797715072221220#heading-9))

  
  

#### Demo2

  

*   è¿™ä¸ªæµ‹è¯•æˆ‘å°±æ²¡æœ‰å†™äº†ï¼Œè‡ªå·±å¯ä»¥çœ‹çœ‹

  
  

é—®é¢˜ï¼šå½“æŸ¥è¯¢æ¥å£è¾ƒå¤æ‚æ—¶å€™ï¼Œæ•°æ®çš„è·å–éƒ½éœ€è¦[è¿œç¨‹è°ƒç”¨](https://so.csdn.net/so/search?q=%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8&spm=1001.2101.3001.7020)ï¼Œå¿…ç„¶éœ€è¦èŠ±è´¹æ›´å¤šçš„æ—¶é—´ã€‚

å‡å¦‚æŸ¥è¯¢æ–‡ç« è¯¦æƒ…é¡µé¢ï¼Œéœ€è¦å¦‚ä¸‹æ ‡æ³¨çš„æ—¶é—´æ‰èƒ½å®Œæˆï¼š

    
    // 1. æŸ¥è¯¢æ–‡ç« è¯¦æƒ… 0.5s
    
    // 2. æŸ¥è¯¢æ–‡ç« åšä¸»ä¸ªäººä¿¡æ¯ 0.5s
    
    // 3. æŸ¥è¯¢æ–‡ç« è¯„è®º 1s
    
    // 4. æŸ¥è¯¢åšä¸»ç›¸å…³æ–‡ç« åˆ†ç±» 1s
    
    // 5. ç›¸å…³æ¨èæ–‡ç«  1s
    
    // ......
    ä¸Šé¢çš„æè¿°åªæ˜¯ä¸¾ä¸ªä¾‹å­ä¸è¦åœ¨æ„è¿™é‡Œçš„æŸ¥è¯¢æè¿°ï¼Œçœ‹å®é™…æƒ…å†µä½¿ç”¨ï¼Œæœ‰äº›ç›¸å…³çš„æŸ¥è¯¢æˆ‘ä»¬å¯ä»¥æ‹†åˆ†æ¥å£å®ç°ï¼Œä¸Šé¢çš„æè¿°åªæ˜¯ä¸ºäº†ä¸¾ä¾‹å­ã€‚
    

  

    @Service
    public class ArticleService {
    	@Autowired
        private ArticleClient articleClient;
        @Autowired
        private UserClient userClient;
        @Autowired
        private ThreadPoolExecutor threadPoolExecutor;
        
     	public ItemVo load(Long id) {
    	// 1. æŸ¥è¯¢æ–‡ç« è¯¦æƒ… 0.5s
    	// ä¸‹é¢çš„æŸ¥è¯¢éœ€è¦ç”¨åˆ°æ–‡ç« å¯¹åº”çš„å‘å¸ƒç”¨æˆ·ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä½¿ç”¨CompletableFuture.supplyAsync
    	CompletableFuture<ArticleEntity> articleCompletableFuture = CompletableFuture.supplyAsync(() -> {
                ResponseVo<ArticleEntity> skuEntityResponseVo = this.articleClient.getArticleById(id);
                ArticleEntity articleEntity = skuEntityResponseVo.getData();
                if (articleEntity == null) {
                    return null;
                }
                itemVo.setId(id);
                itemVo.setTitle(articleEntity.getTitle());
                itemVo.setDefaltImage(articleEntity.getDefaultImage());
                return articleEntity;
            }, threadPoolExecutor);
    	// 2. æŸ¥è¯¢æ–‡ç« åšä¸»ä¸ªäººä¿¡æ¯ 0.5s
    	// è¿™é‡ŒæŸ¥è¯¢éœ€è¦ä¾èµ–æ–‡ç« å…³è”çš„ç”¨æˆ·idï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨articleCompletableFuture.thenAcceptAsync()
        CompletableFuture<Void> userCompletableFuture = articleCompletableFuture.thenAcceptAsync(articleEntity -> {
            ResponseVo<UserEntity> categoryResponseVo = this.userClient.queryUserInfoById(articleEntity.getUserId());
            UserEntity userEntity = categoryResponseVo.getData();
            itemVo.setUserInfo(userEntity);
        }, threadPoolExecutor);    
    	// 3. æŸ¥è¯¢åšä¸»ç›¸å…³æ–‡ç« åˆ†ç±» 1s
    	// è¿™é‡ŒæŸ¥è¯¢éœ€è¦ä¾èµ–æ–‡ç« å…³è”çš„ç”¨æˆ·idï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨articleCompletableFuture.thenAcceptAsync()
        CompletableFuture<Void> userOtherArticleCompletableFuture = articleCompletableFuture.thenAcceptAsync(articleEntity -> {
            ResponseVo<List<UserAuserOtherArticleEntity>> categoryResponseVo = this.articleClient.queryUserAuserOtherArticleById(articleEntity.getUserId());
            UserAuserOtherArticleEntity userAuserOtherArticleEntity = categoryResponseVo.getData();
            itemVo.setUserAuserOtherArticleList(userAuserOtherArticleEntity);
        }, threadPoolExecutor);
        // 4. æŸ¥è¯¢æ–‡ç« è¯„è®º 1s
        // ä¸éœ€è¦ä¾èµ–å…¶ä»–è¯·æ±‚è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨æ–°çš„å¼‚æ­¥å¯¹è±¡ CompletableFuture.runAsync()
        CompletableFuture<Void> commentsCompletableFuture =  CompletableFuture.runAsync(() -> {
            ResponseVo<List<UserArticleCategoryEntity>> userArticleCategoryVo = this.userClient.queryCommentsByArticleId(id);
            UserArticleCategoryEntity userArticleCategoryEntity = userArticleCategoryVo.getData();
            itemVo.setUserArticleCategoryList(userArticleCategoryEntity);
        }, threadPoolExecutor);
    	// 5. ç›¸å…³æ¨èæ–‡ç«  1s
    	// ä¸éœ€è¦ä¾èµ–å…¶ä»–è¯·æ±‚è¿”å›å€¼ï¼Œå¯ä»¥ä½¿ç”¨æ–°çš„å¼‚æ­¥å¯¹è±¡ CompletableFuture.runAsync()
    	CompletableFuture<Void> relatedArticlesCompletableFuture =  CompletableFuture.runAsync(() -> {
            ResponseVo<List<RelatedArticlesEntity>> userArticleCategoryVo = this.articleClient.queryRelatedArticles(id);
            UserArticleCategoryEntity userArticleCategoryEntity = userArticleCategoryVo.getData();
            itemVo.setUserArticleCategoryList(userArticleCategoryEntity);
        }, threadPoolExecutor);
    	}
    	// å¤šä»»åŠ¡æ‰§è¡Œç»„åˆ CompletableFuture.allOf()
    	CompletableFuture.allOf(articleCompletableFuture, userCompletableFuture, userOtherArticleCompletableFuture,
                    commentsCompletableFuture, relatedArticlesCompletableFuture).join();
         return itemVo;
    }
    

  
  

CompletableFutureçš„asyncåç¼€å‡½æ•°ä¸ä¸å¸¦asyncçš„å‡½æ•°çš„åŒºåˆ«
-----------------------------------------

  

å‚è€ƒé“¾æ¥ï¼š \[åšå®¢é“¾æ¥\]([(106æ¡æ¶ˆæ¯) CompletableFutureçš„asyncåç¼€å‡½æ•°ä¸ä¸å¸¦asyncçš„å‡½æ•°çš„åŒºåˆ«\_leon\_wzmçš„åšå®¢-CSDNåšå®¢\_thenacceptasync](https://blog.csdn.net/leon_wzm/article/details/80560081))

  

ğŸ« ç»“è®ºï¼š

    ä¸å¸¦asyncçš„å‡½æ•°çš„åŠ¨ä½œæ¯”è¾ƒå¤æ‚
    
    fçš„whenCompleteçš„å†…å®¹ç”±å“ªä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œå–å†³äºå“ªä¸ªçº¿ç¨‹Xæ‰§è¡Œäº†f.complete()ã€‚ä½†æ˜¯å½“Xçº¿ç¨‹æ‰§è¡Œäº†f.complete()çš„æ—¶å€™ï¼ŒwhenCompleteè¿˜æ²¡æœ‰è¢«æ‰§è¡Œåˆ°çš„æ—¶å€™ï¼ˆå°±æ˜¯äº‹ä»¶è¿˜æ²¡æœ‰æ³¨å†Œçš„æ—¶å€™ï¼‰ï¼Œé‚£ä¹ˆXçº¿ç¨‹å°±ä¸ä¼šå»åŒæ­¥æ‰§è¡ŒwhenCompleteçš„å›è°ƒäº†ã€‚è¿™ä¸ªæ—¶å€™å“ªä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°äº†whenCompleteçš„äº‹ä»¶æ³¨å†Œçš„æ—¶å€™ï¼Œå°±ç”±å“ªä¸ªçº¿ç¨‹è‡ªå·±æ¥åŒæ­¥æ‰§è¡ŒwhenCompleteçš„äº‹ä»¶å†…å®¹ã€‚
    
    è€ŒwhenCompleteAsyncçš„åœºåˆï¼Œå°±ç®€å•å¾ˆå¤šã€‚ä¸€å¥è¯å°±æ˜¯çº¿ç¨‹æ± é‡Œé¢æ‹¿ä¸€ä¸ªç©ºçš„çº¿ç¨‹æˆ–è€…æ–°å¯ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œå›è°ƒã€‚å’Œæ‰§è¡Œf.completeçš„çº¿ç¨‹ä»¥åŠæ‰§è¡ŒwhenCompleteAsyncçš„çº¿ç¨‹æ— å…³ã€‚
    

  
  
  

ThreadPoolTaskExecutor å’Œ ThreadPoolExecutor çš„åŒºåˆ«
-----------------------------------------------

  

å‚è€ƒé“¾æ¥ï¼š \[åšå®¢é“¾æ¥\]([(106æ¡æ¶ˆæ¯) ThreadPoolTaskExecutor å’Œ ThreadPoolExecutor çš„åŒºåˆ«\_PonderYaoçš„åšå®¢-CSDNåšå®¢\_threadpooltaskexecutorå’Œthreadpoolexecutor](https://blog.csdn.net/weixin_50604409/article/details/119224004))

ğŸ« ç»“è®ºï¼š

    å…¶å®æœ€ä¸»è¦çš„åŸå› å¾ˆç›´è§‚ï¼šThreadPoolExecutoræ˜¯ä¸€ä¸ªä¸å—Springç®¡ç†ç”Ÿå‘½å‘¨æœŸã€å‚æ•°è£…é…çš„Javaç±»ï¼Œè€Œæœ‰äº†ThreadPoolTaskExecutorçš„å°è£…ï¼Œçº¿ç¨‹æ± æ‰æœ‰Springâ€œå†…å‘³â€ã€‚
    

  
  
  

Spring çº¿ç¨‹æ± çš„ä½¿ç”¨
=============

  
  

ä¸šåŠ¡ä½¿ç”¨å¤šçº¿ç¨‹çš„åŸå› 
----------

  

*   ç›®çš„æ˜¯é¢å¯¹é«˜å¹¶å‘çš„æ—¶å€™ï¼Œæé«˜è¿è¡Œé€Ÿåº¦

### åœºæ™¯ä¸€:

ä¸€ä¸ªä¸šåŠ¡é€»è¾‘æœ‰å¾ˆå¤šæ¬¡çš„å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯ä¹‹é—´æ²¡æœ‰å½±å“ï¼Œæ¯”å¦‚éªŒè¯1ä¸‡æ¡urlè·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œæ­£å¸¸æƒ…å†µè¦å¾ªç¯1ä¸‡æ¬¡ï¼Œé€ä¸ªå»éªŒè¯æ¯ä¸€æ¡URLï¼Œè¿™æ ·æ•ˆç‡ä¼šå¾ˆä½ï¼Œå‡è®¾éªŒè¯ä¸€æ¡éœ€è¦1åˆ†é’Ÿï¼Œæ€»å…±å°±éœ€è¦1ä¸‡åˆ†é’Ÿï¼Œæœ‰ç‚¹ææ€–ã€‚è¿™æ—¶å¯ä»¥ç”¨å¤šçº¿ç¨‹ï¼Œå°†1ä¸‡æ¡URLåˆ†æˆ50ç­‰ä»½ï¼Œå¼€50ä¸ªçº¿ç¨‹ï¼Œæ²¡ä¸ªçº¿ç¨‹åªéœ€éªŒè¯200æ¡ï¼Œè¿™æ ·æ‰€æœ‰çš„çº¿ç¨‹æ‰§è¡Œå®Œæ˜¯è¿œå°äº1ä¸‡åˆ†é’Ÿçš„ã€‚

  
  

### åœºæ™¯äºŒ:

éœ€è¦çŸ¥é“ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œè¿›åº¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸çœ‹åˆ°çš„**è¿›åº¦æ¡**ï¼Œå®ç°æ–¹å¼å¯ä»¥æ˜¯åœ¨**ä»»åŠ¡ä¸­åŠ å…¥ä¸€ä¸ªæ•´å‹å±æ€§å˜é‡(è¿™æ ·ä¸åŒæ–¹æ³•å¯ä»¥å…±äº«)ï¼Œä»»åŠ¡æ‰§è¡Œä¸€å®šç¨‹åº¦å°±ç»™å˜é‡å€¼åŠ 1ï¼Œå¦å¤–å¼€ä¸€ä¸ªçº¿ç¨‹æŒ‰æ—¶é—´é—´éš”ä¸æ–­å»è®¿é—®è¿™ä¸ªå˜é‡ï¼Œå¹¶åé¦ˆç»™ç”¨æˆ·**ã€‚æ€»ä¹‹ä½¿ç”¨å¤šçº¿ç¨‹å°±æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨cpuçš„èµ„æºï¼Œæé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ï¼Œå½“ä½ å‘ç°ä¸€ä¸ªä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ•ˆç‡ç‰¹åˆ«ä½ï¼Œè€—æ—¶ç‰¹åˆ«é•¿ï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨å¤šçº¿ç¨‹ã€‚

é—®é¢˜ï¼šä¸è¿‡CPUæ‰§è¡Œå“ªä¸ªçº¿ç¨‹çš„æ—¶é—´å’Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œå³ä½¿è®¾ç½®äº†çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå› æ­¤ä½¿ç”¨å¤šçº¿ç¨‹çš„é£é™©ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ï¼Œä¼šå‡ºç°å¾ˆå¤šé¢„æ–™ä¸åˆ°çš„é—®é¢˜ï¼Œä¸€å®šè¦å¤šç†Ÿæ‚‰æ¦‚å¿µï¼Œå¤šæ„é€ ä¸åŒçš„åœºæ™¯å»æµ‹è¯•æ‰èƒ½å¤ŸæŒæ¡!

é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡:

    @Order()
    è®¾ç½®è¿è¡Œçš„ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ï¼Œçº§åˆ«è¶Šé«˜
    

  
  

FutureTaskä»‹ç»
------------

  

ğŸ« å‚è€ƒï¼š \[åšå®¢é“¾æ¥\]([(101æ¡æ¶ˆæ¯) FutureTaskè¯¦è§£\_ç´¢ç ç†çš„åšå®¢-CSDNåšå®¢\_futuretask](https://blog.csdn.net/qq_39654841/article/details/90631795))

çº¿ç¨‹æ± ä¸ºä»€ä¹ˆè¦ä½¿ç”¨é˜»å¡é˜Ÿåˆ—
-------------

    é˜»å¡é˜Ÿåˆ—å¯ä»¥ä¿è¯ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡æ—¶é˜»å¡è·å–ä»»åŠ¡çš„çº¿ç¨‹ï¼Œä½¿å¾—çº¿ç¨‹è¿›å…¥wait çŠ¶æ€ï¼Œé‡Šæ”¾ cpu èµ„æºï¼Œå½“é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡æ—¶æ‰å”¤é†’å¯¹åº”çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œæ‰§è¡Œã€‚
    ä½¿å¾—åœ¨çº¿ç¨‹ä¸è‡³äºä¸€ç›´å ç”¨cpuèµ„æºã€‚ï¼ˆçº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡åé€šè¿‡å¾ªç¯å†æ¬¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼Œä»£ç ç‰‡æ®µå¦‚ï¼šwhile (task != null || (task = getTask()) != null) {}ï¼‰ã€‚
    
    ä¸ç”¨é˜»å¡é˜Ÿåˆ—ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡å®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦è€Œå·²ï¼Œæœ‰å¥½ç”¨çš„ä¸ºå•¥ä¸ç”¨å‘¢
    

  

Spring å¸¸ç”¨çš„çº¿ç¨‹æ± çš„ä½¿ç”¨
----------------

  

### åºåˆ—

Spring é€šè¿‡ä»»åŠ¡æ‰§è¡Œå™¨ï¼ˆTaskExecutorï¼‰æ¥å®ç°å¤šçº¿ç¨‹å’Œå¹¶å‘ç¼–ç¨‹ï¼Œä½¿ç”¨ ThreadPoolTaskExecutor å®ç°ä¸€ä¸ªåŸºäºçº¿ç¨‹æ± çš„TaskExecutorï¼Œ  
è¿˜å¾—éœ€è¦ä½¿ç”¨ @EnableAsync å¼€å¯å¼‚æ­¥ï¼Œå¹¶é€šè¿‡åœ¨éœ€è¦çš„å¼‚æ­¥æ–¹æ³•é‚£é‡Œä½¿ç”¨æ³¨è§£@Asyncå£°æ˜æ˜¯ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡  
Spring å·²ç»å®ç°çš„å¼‚å¸¸çº¿ç¨‹æ± ï¼š

    - SimpleAsyncTaskExecutorï¼šä¸æ˜¯çœŸçš„çº¿ç¨‹æ± ï¼Œè¿™ä¸ªç±»ä¸é‡ç”¨çº¿ç¨‹ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚
    
    - SyncTaskExecutorï¼šè¿™ä¸ªç±»æ²¡æœ‰å®ç°å¼‚æ­¥è°ƒç”¨ï¼Œåªæ˜¯ä¸€ä¸ªåŒæ­¥æ“ä½œã€‚åªé€‚ç”¨äºä¸éœ€è¦å¤šçº¿ç¨‹çš„åœ°æ–¹
    
    - ConcurrentTaskExecutorï¼šExecutorçš„é€‚é…ç±»ï¼Œä¸æ¨èä½¿ç”¨ã€‚å¦‚æœThreadPoolTaskExecutorä¸æ»¡è¶³è¦æ±‚æ—¶ï¼Œæ‰ç”¨è€ƒè™‘ä½¿ç”¨è¿™ä¸ªç±»
    
    - SimpleThreadPoolTaskExecutorï¼šæ˜¯Quartzçš„ SimpleThreadPool çš„ç±»ã€‚çº¿ç¨‹æ± åŒæ—¶è¢«quartzå’Œéquartzä½¿ç”¨ï¼Œæ‰éœ€è¦ä½¿ç”¨æ­¤ç±»
    
    - ThreadPoolTaskExecutor ï¼šæœ€å¸¸ä½¿ç”¨ï¼Œæ¨èã€‚ å…¶å®è´¨æ˜¯å¯¹ java.util.concurrent.ThreadPoolExecutor çš„åŒ…è£…
    

  

ğŸ«Â æ‰©å±•ï¼šç›¸ä¿¡å¤§å®¶åœ¨ Java é‡Œé¢ä¹Ÿå­¦è¿‡ JUC ,é‡Œé¢æœ‰ Java é‡Œé¢çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥ç›´æ¥å»çœ‹çœ‹ ThreadPoolExecutor

è‡³äºä¸ºä»€ä¹ˆæœ‰çº¿ç¨‹æ± ï¼ŒSpring ä¸ºä»€ä¹ˆè¿˜æœ‰åœ¨è‡ªå·±æä¸€ä¸ªï¼Œå¯ä»¥è‡ªå·±å»æ¢ç´¢ï¼ŒSpring çš„åº•å±‚è¿˜æ˜¯ ThreadPoolExecutor ï¼Œåªæ˜¯å®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸å—å®ƒæ§åˆ¶ã€‚

  
  

### å¸¸è§„ä½¿ç”¨

  

    //    çº¿ç¨‹æ± (configé‡Œé¢çš„Bean)
        @Autowired
        private Executor taskExecutor;
        
    Callable<ScyTeacher> scy =()-> scyTeacherMapper.selectOne(new LambdaQueryWrapper<ScyTeacher>()
                                          .eq(ScyTeacher::getUsername,test));
    FutureTask<ScyTeacher> commentCallable = new FutureTask<>(scy);
    Future<Map> submit = executor.submit(commentCallable);
    Map map = submit.get();
    

  

### å¼‚æ­¥ä½¿ç”¨

  

ğŸš© è®°å¾—å¼€å¯å¼‚æ­¥ï¼ˆé…ç½®ç±»æ·»åŠ ï¼‰

    @EnableAsync //å¼€å¯å¼‚æ­¥æ‰§è¡Œ
    

  

    package com.melodyjerry.thread;
    
    import org.springframework.scheduling.annotation.Async;
    import org.springframework.stereotype.Service;
    
    /**
     * @classname AsyncTaskService
     * @description å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œç±»
     */
    @Service
    public class AsyncTaskService {
        @Async //å¼‚æ­¥æ–¹æ³•
        public void executeAsyncTask(Integer i) {
            System.out.javaprintln("æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡: "+i);
        }
    
        @Async //å¼‚æ­¥æ–¹æ³•
        public void executeAsyncTaskPlus(Integer i) {
            System.out.println("æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡+1ï¼š " + (i+1));
        }
    }