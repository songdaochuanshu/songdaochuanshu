---
layout: post
title: "è®°ä¸€æ¬¡ .NET æŸæ•°æ§æœºåºŠæ§åˆ¶ç¨‹åº å¡æ­»åˆ†æ"
date: "2022-09-06T04:51:29.043Z"
---
è®°ä¸€æ¬¡ .NET æŸæ•°æ§æœºåºŠæ§åˆ¶ç¨‹åº å¡æ­»åˆ†æ
=======================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

å‰æ®µæ—¶é—´æœ‰ä½æœ‹å‹å¾®ä¿¡ä¸Šæ‰¾åˆ°æˆ‘ï¼Œè¯´å®ƒçš„ç¨‹åºå‡ºç°äº†å¡æ­»ï¼Œè®©æˆ‘å¸®å¿™çœ‹ä¸‹æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ è¯´æ¥ä¹Ÿå¥‡æ€ªï¼Œé‚£æ®µæ—¶é—´æ±‚åŠ©å¡æ­»ç±»çš„dumpç‰¹åˆ«å¤šï¼Œè¢«è¿«è®­ç»ƒäº†ä¸€ä¸‹å¯¹è¿™ç±»é—®é¢˜çš„æ´å¯ŸåŠ› ğŸ˜„ğŸ˜„ğŸ˜„ï¼Œå†æ¬¡å£°æ˜ä¸€ä¸‹ï¼Œæˆ‘åˆ†æ dump æ˜¯å…è´¹çš„ï¼Œæ²¡æœ‰æŸè½¯é«˜é¢çš„åˆ†æè´¹ç”¨ï¼Œä½ è¦é—®æˆ‘å›¾ä»€ä¹ˆï¼Œå›¾æŠ€æœ¯çš„ç²¾è¿›ã€‚

å›åˆ°æ­£é¢˜ï¼Œå¡æ­»ç±»çš„é—®é¢˜åˆ†æå…¥å£ç‚¹åœ¨äºä¸»çº¿ç¨‹æ­¤æ—¶åœ¨åšä»€ä¹ˆï¼Œå¯¼è‡´å®ƒä¸èƒ½å¤„ç†è‡ªå·±çš„ä»»åŠ¡é˜Ÿåˆ—çš„åŸå› æ˜¯å„ç§å„æ ·çš„ï¼Œæ¥ä¸‹æ¥ä¸Š windbg åˆ†æä¸€ä¸‹ã€‚

äºŒï¼šWinDbg åˆ†æ
-----------

### 1\. ä¸»çº¿ç¨‹æ­¤æ—¶åœ¨åšä»€ä¹ˆ

çœ‹ä¸»çº¿ç¨‹å¾ˆç®€å•ï¼Œç›´æ¥ä¸€ä¸ª `k` å‘½ä»¤æå®šã€‚

    
    0:000> k
     # ChildEBP RetAddr      
    00 00f3ec2c 74ef6439     ntdll!NtWaitForSingleObject+0xc
    01 00f3ec2c 70293370     KERNELBASE!WaitForSingleObjectEx+0x99
    02 00f3ec5c 702933cc     clr!CLREventWaitHelper2+0x33
    03 00f3ecac 70293319     clr!CLREventWaitHelper+0x2a
    04 00f3ece4 7037bbcf     clr!CLREventBase::WaitEx+0x14b
    05 00f3ecfc 70374f08     clr!WKS::GCHeap::WaitUntilGCComplete+0x35
    06 00f3ed44 7032c2a2     clr!Thread::RareDisablePreemptiveGC+0x20b
    07 00f3edc8 6d453712     clr!JIT_RareDisableHelper+0x22
    08 00f3ee4c 6d4530d1     System_Windows_Forms_ni!System.Windows.Forms.Application+ComponentManager.System.Windows.Forms.UnsafeNativeMethods.IMsoComponentManager.FPushMessageLoop(IntPtr, Int32, Int32)$##600550A+0x48e
    09 00f3eea0 6d452f23     System_Windows_Forms_ni!System.Windows.Forms.Application+ThreadContext.RunMessageLoopInner(Int32, System.Windows.Forms.ApplicationContext)$##6005539+0x175
    0a 00f3eecc 6d42b83d     System_Windows_Forms_ni!System.Windows.Forms.Application+ThreadContext.RunMessageLoop(Int32, System.Windows.Forms.ApplicationContext)$##6005538+0x4f
    0b 00f3eee4 02d90c83     System_Windows_Forms_ni!System.Windows.Forms.Application.Run(System.Windows.Forms.Form)$##60005FA+0x35
    ...
    
    

ä»å¦ä¸Šä¿¡æ¯çœ‹ï¼Œä¸»çº¿ç¨‹æ­£åœ¨ç­‰å¾…(WaitUntilGCComplete) GC å¤„ç†å®Œæˆï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹æ˜¯å“ªä¸€ä¸ªçº¿ç¨‹è§¦å‘äº† `GC` æ“ä½œï¼Œå¹¶çœ‹ä¸‹å®ƒæ­£åœ¨ GC ä¸‰é˜¶æ®µçš„å“ªä¸€æ­¥ï¼Ÿ

    
    0:000> !t
    ThreadCount:      33
    UnstartedThread:  3
    BackgroundThread: 29
    PendingThread:    3
    DeadThread:       0
    Hosted Runtime:   no
                                                                             Lock  
           ID OSID ThreadOBJ    State GC Mode     GC Alloc Context  Domain   Count Apt Exception
       0    1 17a0 0113ecd0     26020 Preemptive  00000000:00000000 01139490 0     STA 
       2    2 2074 0114e0e0     2b220 Preemptive  00000000:00000000 01139490 0     MTA (Finalizer) 
       5    3 27f4 011ddaa8   102a220 Preemptive  00000000:00000000 01139490 0     MTA (Threadpool Worker) 
       8    4 2568 05bf0b90   1029220 Cooperative 00000000:00000000 01139490 1     MTA (GC) (Threadpool Worker) 
    
    0:000> ~8s
    eax=00000000 ebx=05bf0b90 ecx=00000000 edx=00000000 esi=00000000 edi=00000f6c
    eip=77e5aa5c esp=098ce03c ebp=098ce0ac iopl=0         nv up ei pl nz na pe nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000206
    ntdll!NtWaitForSingleObject+0xc:
    77e5aa5c c20c00          ret     0Ch
    0:008> k
     # ChildEBP RetAddr      
    00 098ce0ac 74ef6439     ntdll!NtWaitForSingleObject+0xc
    01 098ce0ac 70293370     KERNELBASE!WaitForSingleObjectEx+0x99
    02 098ce0dc 702933cc     clr!CLREventWaitHelper2+0x33
    03 098ce12c 70293319     clr!CLREventWaitHelper+0x2a
    04 098ce164 7029333b     clr!CLREventBase::WaitEx+0x14b
    05 098ce17c 7032a9b7     clr!CLREventBase::Wait+0x1a
    06 098ce1fc 7032a9ef     clr!`anonymous namespace'::CreateSuspendableThread+0x165
    07 098ce378 704322bd     clr!GCToEEInterface::CreateThread+0x15c
    08 098ce3a8 704332e5     clr!WKS::gc_heap::prepare_bgc_thread+0x36
    09 098ce3a8 70378585     clr!WKS::gc_heap::garbage_collect+0x215
    0a 098ce3c8 7037868a     clr!WKS::GCHeap::GarbageCollectGeneration+0x1bd
    0b 098ce3ec 70378703     clr!WKS::gc_heap::trigger_gc_for_alloc+0x1f
    0c 098ce424 70396f6a     clr!WKS::gc_heap::try_allocate_more_space+0x152
    0d 098ce46c 70397311     clr!WKS::gc_heap::allocate_large_object+0x51
    0e 098ce478 702fde2d     clr!WKS::GCHeap::AllocLHeap+0x11
    0f 098ce494 7063f1af     clr!AllocLHeap+0x4b
    10 098ce4e8 7028f598     clr!FastAllocatePrimitiveArray+0xa7
    11 098ce58c 0e2d3fb6     clr!JIT_NewArr1+0x126
    12 098cf26c 6f1f1b5a     0xe2d3fb6
    13 098cf274 6f188604     mscorlib_ni!System.Runtime.CompilerServices.AsyncMethodBuilderCore+MoveNextRunner.InvokeMoveNext(System.Object)$##6006FCB+0x1a
    ...
    
    

ä»å¦ä¸­çš„ `clr!GCToEEInterface::CreateThread` æ–¹æ³•çœ‹ï¼Œå¦‚æœä½ æ²¡æœ‰è¿™æ–¹é¢çš„åˆ†æç»éªŒï¼Œæˆ–è®¸ä½ å·²ç»æ— èƒ½ä¸ºåŠ›äº†ï¼Œä»¥æˆ‘çš„ç»éªŒæ¥è¯´ï¼Œæ—¢ç„¶å¡æ­»ï¼Œé‚£è¿™é‡Œçš„ `CreateThread` è‡ªç„¶æ— æ³•åˆ›å»ºæˆåŠŸï¼Œåˆ›å»ºä¸æˆåŠŸçš„åŸå› åœ¨äº `è¿›ç¨‹åŠ è½½é” LdrpLoaderLock` è¢«åˆ«äººæŒæœ‰äº†ï¼Œå¯¼è‡´å®ƒè·å–ä¸åˆ°è¿™æŠŠé”è€Œä¸€ç›´èŒ«ç„¶ç­‰å¾…ã€‚

### 2\. è°æŒæœ‰äº†åŠ è½½é”

è¦æƒ³æ‰¾åˆ°è°æŒæœ‰äº†åŠ è½½é”ï¼Œå¯ä»¥åœ¨ ntdll ä¸­æœ `LdrpLoaderLock` å­—æ®µï¼Œæ¥ä¸‹æ¥ä½¿ç”¨ x å‘½ä»¤æœç´¢ã€‚

    
    0:008> x ntdll!LdrpLoaderLock
    77f053b8          ntdll!LdrpLoaderLock = <no type information>
    0:008> !cs 77f053b8
    -----------------------------------------
    Critical section   = 0x77f053b8 (ntdll!LdrpLoaderLock+0x0)
    DebugInfo          = 0x77f0573c
    LOCKED
    LockCount          = 0x0
    WaiterWoken        = No
    OwningThread       = 0x00001314
    RecursionCount     = 0x1
    LockSemaphore      = 0x0
    SpinCount          = 0x04000000
    
    

ä»å¦ä¸­çš„ `OwningThread = 0x00001314` è¿¹è±¡çœ‹ï¼Œå½“å‰æ˜¯çº¿ç¨‹ `1314` æŒæœ‰äº†åŠ è½½é”ï¼Œçœ‹æ ·å­æ˜¯è¦ä¸€ç”Ÿä¸€ä¸–çš„æŒæœ‰ã€‚ã€‚ã€‚ã€‚ éš¾æ€ªç¨‹åºä¸å¡æ­»ã€‚ã€‚ã€‚ã€‚ æ¥ä¸‹æ¥åˆ‡åˆ°è¿™ä¸ªçº¿ç¨‹çœ‹çœ‹åˆ°åº•å’‹è¿™ä¹ˆç—´æƒ…ï¼Ÿ

    
    0:043> ~~[1314]s
    eax=00000000 ebx=0589f784 ecx=00000000 edx=00000000 esi=00000000 edi=0589f770
    eip=77e5c6bc esp=0589f72c ebp=0589f748 iopl=0         nv up ei pl nz na po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
    ntdll!NtWaitForAlertByThreadId+0xc:
    77e5c6bc c20800          ret     8
    0:043> kb 
     # ChildEBP RetAddr      Args to Child              
    00 0589f748 77e1336b     0ad114e8 00000000 00000000 ntdll!NtWaitForAlertByThreadId+0xc
    01 0589f748 77e50630     00000000 00000000 ffffffff ntdll!RtlpWaitOnAddressWithTimeout+0x33
    02 0589f78c 77e13299     00000004 00000000 00000000 ntdll!RtlpWaitOnAddress+0xa5
    03 0589f7c8 77e2ed76     00000000 0ad114e0 0ad114e4 ntdll!RtlpWaitOnCriticalSection+0xaf
    04 0589f7f0 77e2ec99     0589f814 0ac5d1b4 0ad114e4 ntdll!RtlpEnterCriticalSectionContended+0xd6
    05 0589f7f8 0ac5d1b4     0ad114e4 00000003 0ac50000 ntdll!RtlEnterCriticalSection+0x49
    06 0589f814 0ac5a890     00001314 0acddd2a 0ac50000 fwlibe1!xxx+0x13e3
    07 0589f83c 77e5a9f6     0ac50000 00000003 00000000 fwlibe1!xxx+0x290
    ...
    
    

ä»å¦ä¸­çœ‹ï¼Œå½“å‰æ˜¯ `fwlibe1` è¿™ä¸ªéæ‰˜ç®¡dll å‡†å¤‡è·å– `ä¸´ç•ŒåŒº` æ—¶å¡æ­»ï¼Œæ¥ä¸‹æ¥å¯ä»¥ç”¨ `!cs` æŠŠ ä¸´ç•ŒåŒºå˜é‡ ç»™æå–å‡ºæ¥çœ‹çœ‹åˆ°åº•è°åœ¨æŒæœ‰è¿™ä¸ª ä¸´ç•ŒåŒºå˜é‡ã€‚

    
    0:043> !cs 0ad114e4
    -----------------------------------------
    Critical section   = 0x0ad114e4 (fwlibe1!xxxx+0x3A1C2)
    DebugInfo          = 0x0ff43360
    LOCKED
    LockCount          = 0x2
    WaiterWoken        = No
    OwningThread       = 0x00002378
    RecursionCount     = 0x1
    LockSemaphore      = 0xFFFFFFFF
    SpinCount          = 0x020007d0
    
    

ä»å¦ä¸­å¯ä»¥æ¸…æ™°çš„çœ‹åˆ°ï¼Œå½“å‰ä¸´ç•ŒåŒºå˜é‡è¢« `2378` å·çº¿ç¨‹æŒæœ‰ï¼Œæ¥ä¸‹æ¥åˆ‡åˆ°è¿™ä¸ªçº¿ç¨‹çœ‹çœ‹åˆ°åº•å•¥æƒ…å†µã€‚

    
    0:043> ~~[2378]s
    eax=00000036 ebx=00002378 ecx=00000400 edx=00000157 esi=0ad114fc edi=0ad114e4
    eip=0ac5cf88 esp=0caddf18 ebp=0cade7fc iopl=0         nv up ei pl nz na po nc
    cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000202
    fwlibe1!xxx+0x11b7:
    0ac5cf88 8d45f0          lea     eax,[ebp-10h]
    
    0:028> k
     # ChildEBP RetAddr      
    WARNING: Stack unwind information not available. Following frames may be wrong.
    00 0cade7fc 0ac5a8df     fwlibe1!xxx+0x11b7
    01 0cade938 0ac5abae     fwlibe1!xxx+0x22
    02 0cadea20 09417ccd     fwlibe1!xxx+0x17
    03 0cadebfc 09412c11     0x9417ccd
    04 0caded2c 6f1f1b5a     0x9412c11
    05 0caded34 6f188604     mscorlib_ni!System.Runtime.CompilerServices.AsyncMethodBuilderCore+MoveNextRunner.InvokeMoveNext(System.Object)$##6006FCB+0x1a
    ...
    
    0:028> !clrstack 
    OS Thread Id: 0x2378 (28)
    Child SP       IP Call Site
    0cade9b4 0ac5cf88 [InlinedCallFrame: 0cade9b4] 
    0cade998 0941a0e9 *** WARNING: Unable to verify checksum for System.Data.ni.dll
    DomainBoundILStubClass.IL_STUB_PInvoke(System.Object, UInt16, Int32, UInt16 ByRef)
    0cade9b4 09417ccd [InlinedCallFrame: 0cade9b4] Focas.xxx(System.Object, UInt16, Int32, UInt16 ByRef)
    
    

ä»å¦ä¸­çœ‹ï¼Œæ‰˜ç®¡å±‚è°ƒç”¨äº† `Focas.xxx` å‡½æ•°è¿›å…¥äº† `fwlibe1.dll` ï¼Œæœ€åæœ‰ä¸€å¥ `WARNING: Stack unwind information not available. Following frames may be wrong.` ï¼Œå¯èƒ½æ˜¯å±•å¼€æœ‰ä¸€å®šçš„é—®é¢˜ï¼Œä¸è¿‡æ’æŸ¥åˆ°è¿™é‡Œï¼Œåº”è¯¥å°±æ˜¯è¿™ä¸ª `Focas.xxx` çš„é—®é¢˜äº†ã€‚

### 3\. çœŸç›¸å¤§ç™½

æ¥ä¸‹æ¥å°†æˆ‘çš„æ’æŸ¥ç»“æœè·Ÿæœ‹å‹åé¦ˆäº†ä¸‹ï¼Œæœ‹å‹æ’æŸ¥ä¸‹æ¥è¯´æ˜¯æœ€è¿‘æ”¹äº†è¿™é‡Œé¢çš„è¿æ¥æ–¹å¼æ‰€è‡´ï¼Œä¿®æ”¹ä¹‹åå°±æå®šäº†ã€‚

![](https://img2022.cnblogs.com/blog/214741/202209/214741-20220906083637743-172222585.png)

ä¸‰ï¼šæ€»ç»“
----

è¿™ä¸ªæ¡ˆä¾‹å‘Šè¯‰æˆ‘ä»¬ï¼šåªè¦ä»£ç è¿˜èƒ½è·‘ï¼Œå°±ä¸è¦åŠ¨å®ƒï¼Œå®ƒè¦æ˜¯ä¸åŠ¨äº†ï¼Œä½ å¾—è¦åšå¥½åŠ¨çš„å‡†å¤‡ã€‚

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)