---
layout: post
title: "Android å†…å­˜ç¼“å­˜æ¡†æ¶ LruCache çš„å®ç°åŸç†ï¼Œæ‰‹å†™è¯•è¯•ï¼Ÿ"
date: "2022-12-03T14:13:45.790Z"
---
Android å†…å­˜ç¼“å­˜æ¡†æ¶ LruCache çš„å®ç°åŸç†ï¼Œæ‰‹å†™è¯•è¯•ï¼Ÿ
===================================

> **æœ¬æ–‡å·²æ”¶å½•åˆ° [AndroidFamily](https://github.com/pengxurui/AndroidFamily)ï¼ŒæŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] æé—®ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

[åœ¨ä¹‹å‰çš„æ–‡ç« é‡Œ](https://juejin.cn/post/7164348785512939551)ï¼Œæˆ‘ä»¬èŠåˆ°äº† LRU ç¼“å­˜æ·˜æ±°ç®—æ³•ï¼Œå¹¶ä¸”åˆ†æ Java æ ‡å‡†åº“ä¸­æ”¯æŒ LUR ç®—æ³•çš„æ•°æ®ç»“æ„ LinkedHashMapã€‚å½“æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ LinkedHashMap å®ç°äº†ç®€å•çš„ LRU Demoã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸ª LRU çš„åº”ç”¨æ¡ˆä¾‹ â€”â€” Android æ ‡å‡†åº“çš„ LruCache å†…å­˜ç¼“å­˜ã€‚

* * *

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤å·²ç»å»ºç«‹å•¦ï¼Œæ‰«ææ–‡æœ«äºŒç»´ç è¿›å…¥~

* * *

**æ€ç»´å¯¼å›¾ï¼š**

![](https://files.mdnice.com/user/3257/b95ef871-9ed1-43ff-af35-10d40bc01dc1.png)

* * *

1\. å›é¡¾ LRU å’Œ LinkedHashMap
--------------------------

åœ¨å…·ä½“åˆ†æ LruCache çš„æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®¨è®ºçš„ LRU ç¼“å­˜ç­–ç•¥ä»¥åŠ LinkedHashMap å®ç°åŸç†ã€‚

LRU ï¼ˆLeast Recently Usedï¼‰æœ€è¿‘æœ€å°‘ç­–ç•¥æ˜¯æœ€å¸¸ç”¨çš„ç¼“å­˜æ·˜æ±°ç­–ç•¥ã€‚LRU ç­–ç•¥ä¼šè®°å½•å„ä¸ªæ•°æ®å—çš„è®¿é—® â€œæ—¶é—´æˆ³â€ ï¼Œæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„æ•°æ®æœ€å…ˆè¢«æ·˜æ±°ã€‚ä¸å…¶ä»–å‡ ç§ç­–ç•¥ç›¸æ¯”ï¼ŒLRU ç­–ç•¥åˆ©ç”¨äº† â€œå±€éƒ¨æ€§åŸç†â€ï¼Œå¹³å‡ç¼“å­˜å‘½ä¸­ç‡æ›´é«˜ã€‚

`FIFO ä¸ LRU ç­–ç•¥`

![](https://files.mdnice.com/user/3257/65523c04-1707-4102-b564-2d1e5a845fed.png)

ç»è¿‡æ€»ç»“ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿçš„åŸºæœ¬æ“ä½œï¼š

*   **æ“ä½œ 1 - æ·»åŠ æ•°æ®ï¼š** å…ˆæŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ æ•°æ®ï¼Œå­˜åœ¨åˆ™æ›´æ–°æ•°æ®ï¼Œå¹¶å°è¯•æ·˜æ±°æ•°æ®ï¼›
*   **æ“ä½œ 2 - åˆ é™¤æ•°æ®ï¼š** å…ˆæŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™åˆ é™¤æ•°æ®ï¼›
*   **æ“ä½œ 3 - æŸ¥è¯¢æ•°æ®ï¼š** å¦‚æœæ•°æ®ä¸å­˜åœ¨åˆ™è¿”å› nullï¼›
*   **æ“ä½œ 4 - æ·˜æ±°æ•°æ®ï¼š** æ·»åŠ æ•°æ®æ—¶å¦‚æœå®¹é‡å·²æ»¡ï¼Œåˆ™æ ¹æ®ç¼“å­˜æ·˜æ±°ç­–ç•¥ä¸€ä¸ªæ•°æ®ã€‚

æˆ‘ä»¬å‘ç°ï¼Œå‰ 3 ä¸ªæ“ä½œéƒ½æœ‰ â€œæŸ¥è¯¢â€ æ“ä½œï¼Œæ‰€ä»¥ç¼“å­˜ç³»ç»Ÿçš„æ€§èƒ½ä¸»è¦å–å†³äºæŸ¥æ‰¾æ•°æ®å’Œæ·˜æ±°æ•°æ®æ˜¯å¦é«˜æ•ˆã€‚ä¸ºäº†å®ç°é«˜æ•ˆçš„ LRU ç¼“å­˜ç»“æ„ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©é‡‡ç”¨åŒå‘é“¾è¡¨ + æ•£åˆ—è¡¨çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå« â€œå“ˆå¸Œé“¾è¡¨â€ï¼Œå®ƒèƒ½å¤Ÿå°†æŸ¥è¯¢æ•°æ®å’Œæ·˜æ±°æ•°æ®çš„æ—¶é—´å¤æ‚åº¦é™ä½ä¸º O(1)ã€‚

*   **æŸ¥è¯¢æ•°æ®ï¼š** é€šè¿‡æ•£åˆ—è¡¨å®šä½æ•°æ®ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼›
*   **æ·˜æ±°æ•°æ®ï¼š** ç›´æ¥æ·˜æ±°é“¾è¡¨å°¾èŠ‚ç‚¹ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚

åœ¨ Java æ ‡å‡†åº“ä¸­ï¼Œå·²ç»æä¾›äº†ä¸€ä¸ªé€šç”¨çš„å“ˆå¸Œé“¾è¡¨ â€”â€” LinkedHashMapã€‚ä½¿ç”¨ LinkedHashMap æ—¶ï¼Œä¸»è¦å…³æ³¨ 2 ä¸ª APIï¼š

*   **`accessOrder` æ ‡è®°ä½ï¼š** LinkedHashMap åŒæ—¶å®ç°äº† FIFO å’Œ LRU ä¸¤ç§æ·˜æ±°ç­–ç•¥ï¼Œé»˜è®¤ä¸º FIFO æ’åºï¼Œå¯ä»¥ä½¿ç”¨ accessOrder æ ‡è®°ä½ä¿®æ”¹æ’åºæ¨¡å¼ã€‚
*   **`removeEldestEntry()` æ¥å£ï¼š** æ¯æ¬¡æ·»åŠ æ•°æ®æ—¶ï¼ŒLinkedHashMap ä¼šå›è°ƒ removeEldestEntry() æ¥å£ã€‚å¼€å‘è€…å¯ä»¥é‡å†™ removeEldestEntry() æ¥å£å†³å®šæ˜¯å¦ç§»é™¤æœ€æ—©çš„èŠ‚ç‚¹ï¼ˆåœ¨ FIFO ç­–ç•¥ä¸­æ˜¯æœ€æ—©æ·»åŠ çš„èŠ‚ç‚¹ï¼Œåœ¨ LRU ç­–ç•¥ä¸­æ˜¯æœ€ä¹…æœªè®¿é—®çš„èŠ‚ç‚¹ï¼‰ã€‚

`LinkedHashMap ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/1467db94-84b5-4032-b2f1-3beaa3da24ea.png)

`LinkedHashMap#put ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/0e353bd3-5ac9-4068-885b-8eb7a6bac749.png)

* * *

2\. å®ç° LRU å†…å­˜ç¼“å­˜éœ€è¦è€ƒè™‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ
------------------------

åœ¨é˜…è¯» LruCache æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå°è¯•æ¨å¯¼ LRU å†…å­˜ç¼“å­˜çš„å®ç°æ€è·¯ï¼Œå¸¦ç€é—®é¢˜å’Œç»“è®ºå»åˆ†ææºç ï¼Œä¹Ÿè®¸æ”¶è·ä¼šæ›´å¤šã€‚

### 2.1 å¦‚ä½•åº¦é‡ç¼“å­˜å•å…ƒçš„å†…å­˜å ç”¨ï¼Ÿ

ç¼“å­˜ç³»ç»Ÿåº”è¯¥å®æ—¶è®°å½•å½“å‰çš„å†…å­˜å ç”¨é‡ï¼Œåœ¨æ·»åŠ æ•°æ®æ—¶å¢åŠ å†…å­˜è®°å½•ï¼Œåœ¨ç§»é™¤æˆ–æ›¿æ¢æ•°æ®æ—¶å‡å°‘å†…å­˜è®°å½•ï¼Œè¿™å°±æ¶‰åŠ â€œå¦‚ä½•åº¦é‡ç¼“å­˜å•å…ƒçš„å†…å­˜å ç”¨â€ çš„é—®é¢˜ã€‚è®¡æ•° or è®¡é‡ï¼Œè¿™æ˜¯ä¸ªé—®é¢˜ã€‚æ¯”å¦‚è¯´ï¼š

*   **ä¸¾ä¾‹ 1ï¼š** å®ç°å›¾ç‰‡å†…å­˜ç¼“å­˜ï¼Œå¦‚ä½•åº¦é‡ä¸€ä¸ªå›¾ç‰‡èµ„æºçš„å†…å­˜å ç”¨ï¼Ÿ
*   **ä¸¾ä¾‹ 2ï¼š** å®ç°æ•°æ®æ¨¡å‹å¯¹è±¡å†…å­˜ç¼“å­˜ï¼Œå¦‚ä½•åº¦é‡ä¸€ä¸ªæ•°æ®æ¨¡å‹å¯¹è±¡çš„å†…å­˜å ç”¨ï¼Ÿ
*   **ä¸¾ä¾‹ 3ï¼š** å®ç°èµ„æºå†…å­˜é¢„è¯»ï¼Œå¦‚ä½•åº¦é‡ä¸€ä¸ªèµ„æºçš„å†…å­˜å ç”¨ï¼Ÿ

æˆ‘å°†è¿™ä¸ªé—®é¢˜æ€»ç»“ä¸º 2 ç§æƒ…å†µï¼š

*   **1ã€èƒ½åŠ›å¤ç”¨ä½¿ç”¨è®¡æ•°ï¼š** è¿™ç±»å†…å­˜ç¼“å­˜åœºæ™¯ä¸»è¦æ˜¯ä¸ºäº†å¤ç”¨å¯¹è±¡èƒ½åŠ›ï¼Œå¯¹è±¡æœ¬èº«æŒæœ‰çš„æ•°æ®å¹¶ä¸å¤šï¼Œä½†æ˜¯å¯¹è±¡çš„ç»“æ„å´æœ‰å¯èƒ½éå¸¸å¤æ‚ã€‚è€Œä¸”ï¼Œå†åŠ ä¸Šå¼•ç”¨å¤ç”¨çš„å› ç´ ï¼Œå¾ˆéš¾ç»Ÿè®¡å¯¹è±¡å®é™…çš„å†…å­˜å ç”¨ã€‚å› æ­¤ï¼Œè¿™ç±»å†…å­˜ç¼“å­˜åœºæ™¯åº”è¯¥ä½¿ç”¨è®¡æ•°ï¼Œåªç»Ÿè®¡ç¼“å­˜å•å…ƒçš„ä¸ªæ•°ï¼Œä¾‹å¦‚å¤ç”¨æ•°æ®æ¨¡å‹å¯¹è±¡ï¼Œèµ„æºé¢„è¯»ç­‰ï¼›
    
*   **2ã€æ•°æ®å¤ç”¨ä½¿ç”¨è®¡é‡ï¼š** è¿™ç±»å†…å­˜ç¼“å­˜åœºæ™¯ä¸»è¦æ˜¯ä¸ºäº†å¤ç”¨å¯¹è±¡æŒæœ‰çš„æ•°æ®ï¼Œæ•°æ®å¯¹å†…å­˜çš„å½±å“è¿œè¿œå¤§äºå¯¹è±¡å†…å­˜ç»“æ„å¯¹å†…å­˜çš„å½±å“ï¼Œæ˜¯å¦åº¦é‡é™¤äº†æ•°æ®å¤–çš„éƒ¨åˆ†å†…å­˜å¯¹ç¼“å­˜å‡ ä¹æ²¡æœ‰å½±å“ã€‚å› æ­¤ï¼Œ è¿™é‡Œå†…å­˜ç¼“å­˜åœºæ™¯åº”è¯¥ä½¿ç”¨è®¡é‡ï¼Œä¸è®¡ç®—ç¼“å­˜å•å…ƒçš„ä¸ªæ•°ï¼Œè€Œæ˜¯è®¡ç®—ç¼“å­˜å•å…ƒä¸­ä¸»æ•°æ®å­—æ®µçš„å†…å­˜å ç”¨é‡ï¼Œä¾‹å¦‚å›¾ç‰‡çš„å†…å­˜ç¼“å­˜å°±åªè®°å½• Bitmap çš„åƒç´ æ•°æ®å†…å­˜å ç”¨ã€‚
    

è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹è±¡å†…å­˜ç»“æ„ä¸­çš„å¯¹è±¡å¤´å’Œå¯¹é½ç©ºé—´éœ€è¦è®¡ç®—åœ¨å†…å—ï¼Ÿä¸€èˆ¬ä¸è€ƒè™‘ï¼Œå› ä¸ºåœ¨å¤§éƒ¨åˆ†ä¸šåŠ¡å¼€å‘åœºæ™¯ä¸­ï¼Œç›¸æ¯”äºå¯¹è±¡çš„å®ä¾‹æ•°æ®ï¼Œå¯¹è±¡å¤´å’Œå¯¹é½ç©ºé—´çš„å†…å­˜å ç”¨å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

åº¦é‡ç­–ç•¥

ä¸¾ä¾‹

è®¡æ•°

1ã€Message æ¶ˆæ¯å¯¹è±¡æ± ï¼šæœ€å¤šç¼“å­˜ 50 ä¸ªå¯¹è±¡  
2ã€OkHttp è¿æ¥æ± ï¼šé»˜è®¤æœ€å¤šç¼“å­˜ 5 ä¸ªç©ºé—²è¿æ¥  
3ã€æ•°æ®åº“è¿æ¥æ± 

è®¡é‡

1ã€å›¾ç‰‡å†…å­˜ç¼“å­˜  
2ã€ä½å›¾æ± å†…å­˜ç¼“å­˜

### 2.2 æœ€å¤§ç¼“å­˜å®¹é‡åº”è¯¥è®¾ç½®å¤šå¤§ï¼Ÿ

ç½‘ä¸Šå¾ˆå¤šèµ„æ–™éƒ½è¯´ä½¿ç”¨æœ€å¤§å¯ç”¨å †å†…å­˜çš„å…«åˆ†ä¹‹ä¸€ï¼Œè¿™æ ·ç¬¼ç»Ÿåœ°è®¾ç½®æ–¹å¼æ˜¾ç„¶å¹¶ä¸åˆç†ã€‚åˆ°åº•åº”è¯¥è®¾ç½®å¤šå¤§çš„ç©ºé—´æ²¡æœ‰ç»å¯¹æ ‡å‡†çš„åšæ³•ï¼Œè€Œæ˜¯éœ€è¦å¼€å‘è€…æ ¹æ®å…·ä½“çš„ä¸šåŠ¡ä¼˜å…ˆçº§ã€ç”¨æˆ·æœºå‹å’Œç³»ç»Ÿå®æ—¶çš„å†…å­˜ç´§å¼ ç¨‹åº¦åšå†³å®šï¼š

*   **ä¸šåŠ¡ä¼˜å…ˆçº§ï¼š** å¦‚æœæ˜¯é«˜ä¼˜å…ˆçº§ä¸”ä½¿ç”¨é¢‘ç‡å¾ˆé«˜çš„ä¸šåŠ¡åœºæ™¯ï¼Œé‚£ä¹ˆæœ€å¤§ç¼“å­˜ç©ºé—´é€‚å½“æ”¾å¤§ä¸€äº›ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ï¼Œåä¹‹å°±è¦è€ƒè™‘é€‚å½“ç¼©å°ï¼›
    
*   **ç”¨æˆ·æœºå‹ï¼š** åœ¨æœ€å¤§å¯ç”¨å †å†…å­˜è¾ƒå°çš„ä½ç«¯æœºå‹ä¸Šï¼Œæœ€å¤§ç¼“å­˜ç©ºé—´åº”è¯¥é€‚å½“ç¼©å°ï¼›
    
*   **å†…å­˜ç´§å¼ ç¨‹åº¦ï¼š** åœ¨ç³»ç»Ÿå†…å­˜å……è¶³çš„æ—¶å€™ï¼Œå¯ä»¥æ”¾å¤§ä¸€äº›ç¼“å­˜ç©ºé—´è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶å†åŠæ—¶é‡Šæ”¾ã€‚
    

### 2.3 æ·˜æ±°ä¸€ä¸ªæœ€æ—©çš„èŠ‚ç‚¹å°±è¶³å¤Ÿå—ï¼Ÿ

æ ‡å‡†çš„ LRU ç­–ç•¥ä¸­ï¼Œæ¯æ¬¡æ·»åŠ æ•°æ®æ—¶æœ€å¤šåªä¼šæ·˜æ±°ä¸€ä¸ªæ•°æ®ï¼Œä½†åœ¨ LRU å†…å­˜ç¼“å­˜ä¸­ï¼Œåªæ·˜æ±°ä¸€ä¸ªæ•°æ®å•å…ƒå¾€å¾€å¹¶ä¸å¤Ÿã€‚ä¾‹å¦‚åœ¨ä½¿ç”¨ â€œè®¡é‡â€ çš„å†…å­˜å›¾ç‰‡ç¼“å­˜ä¸­ï¼Œåœ¨åŠ å…¥ä¸€ä¸ªå¤§å›¾ç‰‡åï¼Œåªæ·˜æ±°ä¸€ä¸ªå›¾ç‰‡æ•°æ®æœ‰å¯èƒ½ä¾ç„¶è¾¾ä¸åˆ°æœ€å¤§ç¼“å­˜å®¹é‡é™åˆ¶ã€‚

å› æ­¤ï¼Œåœ¨å¤ç”¨ LinkedHashMap å®ç° LRU å†…å­˜ç¼“å­˜æ—¶ï¼Œå‰æ–‡æåˆ°çš„ `LinkedHashMap#removeEldestEntry()` æ·˜æ±°åˆ¤æ–­æ¥å£å¯èƒ½å°±ä¸å¤Ÿçœ‹äº†ï¼Œå› ä¸ºå®ƒæ¯æ¬¡æœ€å¤šåªèƒ½æ·˜æ±°ä¸€ä¸ªæ•°æ®å•å…ƒã€‚è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åæ–‡å†çœ‹çœ‹ Android LruCache æ˜¯å¦‚ä½•è§£å†³çš„ã€‚

### 2.4 ç­–ç•¥çµæ´»æ€§

LruCache çš„æ·˜æ±°ç­–ç•¥æ˜¯åœ¨ç¼“å­˜å®¹é‡æ»¡æ—¶æ·˜æ±°ï¼Œå½“ç¼“å­˜å®¹é‡æ²¡æœ‰è¶…è¿‡æœ€å¤§é™åˆ¶æ—¶å°±ä¸ä¼šæ·˜æ±°ã€‚é™¤äº†è¿™ä¸ªç­–ç•¥ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¢åŠ ä¸€äº›è¾…åŠ©ç­–ç•¥ï¼Œä¾‹å¦‚åœ¨ Java å †å†…å­˜è¾¾åˆ°æŸä¸ªé˜ˆå€¼åï¼Œå¯¹ LruCache ä½¿ç”¨æ›´åŠ æ¿€è¿›çš„æ¸…ç†ç­–ç•¥ã€‚

åœ¨ Android Glide å›¾ç‰‡æ¡†æ¶ä¸­å°±æœ‰ç­–ç•¥çµæ´»æ€§çš„ä½“ç°ï¼šGlide é™¤äº†é‡‡ç”¨ LRU ç­–ç•¥æ·˜æ±°æœ€æ—©çš„æ•°æ®å¤–ï¼Œè¿˜ä¼šæ ¹æ®ç³»ç»Ÿçš„å†…å­˜ç´§å¼ ç­‰çº§ `onTrimMemory(level)` åŠæ—¶å‡å°‘ç”šè‡³æ¸…ç©º LruCacheã€‚

`Glide Â· LruResourceCache.java`

    @Override
    public void trimMemory(int level) {
        if (level >= android.content.ComponentCallbacks2.TRIM_MEMORY_BACKGROUND) {
            // Entering list of cached background apps
            // Evict our entire bitmap cache
            clearMemory();
        } else if (level >= android.content.ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN || level == android.content.ComponentCallbacks2.TRIM_MEMORY_RUNNING_CRITICAL) {
            // The app's UI is no longer visible, or app is in the foreground but system is running
            // critically low on memory
            // Evict oldest half of our bitmap cache
            trimToSize(getMaxSize() / 2);
        }
    }
    

### 2.5 çº¿ç¨‹åŒæ­¥é—®é¢˜

ä¸€ä¸ªç¼“å­˜ç³»ç»Ÿå¾€å¾€ä¼šåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œè€Œ LinkedHashMap ä¸ HashMap éƒ½ä¸è€ƒè™‘çº¿ç¨‹åŒæ­¥ï¼Œä¹Ÿä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åæ–‡å†çœ‹çœ‹ Android LruCache æ˜¯å¦‚ä½•è§£å†³çš„ã€‚

* * *

3\. LruCache æºç åˆ†æ
-----------------

è¿™ä¸€èŠ‚ï¼Œæˆ‘ä»¬æ¥åˆ†æ LruCache ä¸­ä¸»è¦æµç¨‹çš„æºç ã€‚

### 3.1 LruCache çš„ API

LruCache æ˜¯ Android æ ‡å‡†åº“æä¾›çš„ LRU å†…å­˜ç¼“å­˜æ¡†æ¶ï¼ŒåŸºäº Java LinkedHashMap å®ç°ï¼Œå½“ç¼“å­˜å®¹é‡è¶…è¿‡æœ€å¤§ç¼“å­˜å®¹é‡é™åˆ¶æ—¶ï¼Œä¼šæ ¹æ® LRU ç­–ç•¥æ·˜æ±°æœ€ä¹…æœªè®¿é—®çš„ç¼“å­˜æ•°æ®ã€‚

**ç”¨ä¸€ä¸ªè¡¨æ ¼æ•´ç† LruCache çš„ APIï¼š**

public API

æè¿°

V get(K)

è·å–ç¼“å­˜æ•°æ®

V put(K,V)

æ·»åŠ  / æ›´æ–°ç¼“å­˜æ•°æ®

V remove(K)

ç§»é™¤ç¼“å­˜æ•°æ®

void evictAll()

æ·˜æ±°æ‰€æœ‰ç¼“å­˜æ•°æ®

void resize(int)

é‡æ–°è®¾ç½®æœ€å¤§å†…å­˜å®¹é‡é™åˆ¶ï¼Œå¹¶è°ƒç”¨ trimToSize()

void trimToSize(int)

æ·˜æ±°æœ€æ—©æ•°æ®ç›´åˆ°æ»¡è¶³æœ€å¤§å®¹é‡é™åˆ¶

Map<K, V> snapshot()

è·å–ç¼“å­˜å†…å®¹çš„é•œåƒ / æ‹·è´

protected API

æè¿°

void entryRemoved()

æ•°æ®ç§»é™¤å›è°ƒï¼ˆå¯ç”¨äºå›æ”¶èµ„æºï¼‰

V create()

åˆ›å»ºæ•°æ®ï¼ˆå¯ç”¨äºåˆ›å»ºç¼ºçœæ•°æ®ï¼‰

Int sizeOf()

æµ‹é‡æ•°æ®å•å…ƒå†…å­˜

### 3.2 LruCache çš„å±æ€§

LruCache çš„å±æ€§æ¯”è¾ƒç®€å•ï¼Œé™¤äº†å¤šä¸ªç”¨äºæ•°æ®ç»Ÿè®¡çš„å±æ€§å¤–ï¼Œæ ¸å¿ƒå±æ€§åªæœ‰ 3 ä¸ªï¼š

*   **1ã€sizeï¼š** å½“å‰ç¼“å­˜å ç”¨ï¼›
*   **2ã€maxSizeï¼š** æœ€å¤§ç¼“å­˜å®¹é‡ï¼›
*   **3ã€mapï¼š** å¤ç”¨ LinkedHashMap çš„ LRU æ§åˆ¶èƒ½åŠ›ã€‚

`LruCache.java`

    public class LruCache<K, V> {
        // LRU æ§åˆ¶
        private final LinkedHashMap<K, V> map;
    
        // å½“å‰ç¼“å­˜å ç”¨
        private int size;
        // æœ€å¤§ç¼“å­˜å®¹é‡
        private int maxSize;
    
        // ä»¥ä¸‹å±æ€§ç”¨äºæ•°æ®ç»Ÿè®¡
    
        // è®¾ç½®æ•°æ®æ¬¡æ•°
        private int putCount;
        // åˆ›å»ºæ•°æ®æ¬¡æ•°
        private int createCount;
        // æ·˜æ±°æ•°æ®æ¬¡æ•°
        private int evictionCount;
        // ç¼“å­˜å‘½ä¸­æ¬¡æ•°
        private int hitCount;
        // ç¼“å­˜æœªå‘½ä¸­æ•°
        private int missCount;
    }
    

### 3.3 LruCache çš„æ„é€ æ–¹æ³•

LruCache åªæœ‰ 1 ä¸ªæ„é€ æ–¹æ³•ã€‚

ç”±äºç¼“å­˜ç©ºé—´ä¸å¯èƒ½è®¾ç½®æ— é™å¤§ï¼Œæ‰€ä»¥å¼€å‘è€…éœ€è¦åœ¨æ„é€ æ–¹æ³•ä¸­è®¾ç½®ç¼“å­˜çš„æœ€å¤§å†…å­˜å®¹é‡ `maxSize`ã€‚

LinkedHashMap å¯¹è±¡ä¹Ÿä¼šåœ¨ LruCache çš„æ„é€ æ–¹æ³•ä¸­åˆ›å»ºï¼Œå¹¶ä¸”ä¼šè®¾ç½® `accessOrder` æ ‡è®°ä½ä¸º `true`ï¼Œè¡¨ç¤ºä½¿ç”¨ LRU æ’åºæ¨¡å¼ã€‚

`LruCache.java`

    // maxSizeï¼šç¼“å­˜çš„æœ€å¤§å†…å­˜å®¹é‡
    public LruCache(int maxSize) {
        if (maxSize <= 0) {
            throw new IllegalArgumentException("maxSize <= 0");
        }
        // ç¼“å­˜çš„æœ€å¤§å†…å­˜å®¹é‡
        this.maxSize = maxSize;
        // åˆ›å»º LinkedHashMap å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ LRU æ’åºæ¨¡å¼
        this.map = new LinkedHashMap<K, V>(0, 0.75f, true /*LRU æ¨¡å¼*/);
    }
    

`ä½¿ç”¨ç¤ºä¾‹`

    private static final int CACHE_SIZE = 4 * 1024 * 1024; // 4Mib
    LruCache bitmapCache = new LruCache(CACHE_SIZE);
    

### 3.4 æµ‹é‡æ•°æ®å•å…ƒçš„å†…å­˜å ç”¨

å¼€å‘è€…éœ€è¦é‡å†™ `LruCache#sizeOf()` æµ‹é‡ç¼“å­˜å•å…ƒçš„å†…å­˜å ç”¨é‡ï¼Œå¦åˆ™ç¼“å­˜å•å…ƒçš„å¤§å°é»˜è®¤è§†ä¸º 1ï¼Œç›¸å½“äº `maxSize` è¡¨ç¤ºçš„æ˜¯æœ€å¤§ç¼“å­˜æ•°é‡ã€‚

`LruCache.java`

    // LruCache å†…éƒ¨ä½¿ç”¨
    private int safeSizeOf(K key, V value) {
        // å¦‚æœå¼€å‘è€…é‡å†™çš„ sizeOf è¿”å›è´Ÿæ•°ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸
        int result = sizeOf(key, value);
        if (result < 0) {
            throw new IllegalStateException("Negative size: " + key + "=" + value);
        }
        return result;
    }
    
    // æµ‹é‡ç¼“å­˜å•å…ƒçš„å†…å­˜å ç”¨
    protected int sizeOf(K key, V value) {
        // é»˜è®¤ä¸º 1
        return 1;
    }
    

`ä½¿ç”¨ç¤ºä¾‹`

    private static final int CACHE_SIZE = 4 * 1024 * 1024; // 4Mib
    LruCache bitmapCache = new LruCache(CACHE_SIZE){
        // é‡å†™ sizeOf æ–¹æ³•ï¼Œç”¨äºæµ‹é‡ Bitmap çš„å†…å­˜å ç”¨
        @Override
        protected int sizeOf(String key, Bitmap value) {
            return value.getByteCount();
        }
    };
    

### 3.5 æ·»åŠ æ•°æ®ä¸æ·˜æ±°æ•°æ®

LruCache æ·»åŠ æ•°æ®çš„è¿‡ç¨‹åŸºæœ¬æ˜¯å¤ç”¨ LinkedHashMap çš„æ·»åŠ è¿‡ç¨‹ï¼Œæˆ‘å°†è¿‡ç¨‹æ¦‚æ‹¬ä¸º 6 æ­¥ï¼š

*   1ã€ç»Ÿè®¡æ·»åŠ è®¡æ•°ï¼ˆputCountï¼‰ï¼›
*   2ã€size å¢åŠ æ–° Value å†…å­˜å ç”¨ï¼›
*   3ã€è®¾ç½®æ•°æ®ï¼ˆLinkedHashMap#putï¼‰ï¼›
*   4ã€size å‡å»æ—§ Value å†…å­˜å ç”¨ï¼›
*   5ã€æ•°æ®ç§»é™¤å›è°ƒï¼ˆLruCache#entryRemovedï¼‰;
*   6ã€è‡ªåŠ¨æ·˜æ±°æ•°æ®ï¼šåœ¨æ¯æ¬¡æ·»åŠ æ•°æ®åï¼Œå¦‚æœå½“å‰ç¼“å­˜ç©ºé—´è¶…è¿‡äº†æœ€å¤§ç¼“å­˜å®¹é‡é™åˆ¶ï¼Œåˆ™ä¼šè‡ªåŠ¨è§¦å‘ `trimToSize()` æ·˜æ±°ä¸€éƒ¨åˆ†æ•°æ®ï¼Œç›´åˆ°æ»¡è¶³é™åˆ¶ã€‚

æ·˜æ±°æ•°æ®çš„è¿‡ç¨‹åˆ™æ˜¯å®Œå…¨è‡ªå®šä¹‰ï¼Œæˆ‘å°†è¿‡ç¨‹æ¦‚æ‹¬ä¸º 5 æ­¥ï¼š

*   1ã€å–æœ€æ‰¾çš„æ•°æ®ï¼ˆLinkedHashMap#eldestï¼‰ï¼›
*   2ã€ç§»é™¤æ•°æ®ï¼ˆLinkedHashMap#removeï¼‰ï¼›
*   3ã€size å‡å»æ—§ Value å†…å­˜å ç”¨ï¼›
*   4ã€ç»Ÿè®¡æ·˜æ±°è®¡æ•°ï¼ˆevictionCountï¼‰ï¼›
*   5ã€æ•°æ®ç§»é™¤å›è°ƒï¼ˆLruCache#entryRemovedï¼‰;
*   é‡å¤ä»¥ä¸Š 5 æ­¥ï¼Œæ»¡è¶³è¦æ±‚æˆ–è€…ç¼“å­˜ä¸ºç©ºï¼Œæ‰ä¼šé€€å‡ºã€‚

é€»è¾‘å¾ˆå¥½ç†è§£ï¼Œä¸è¿‡è¿˜æ˜¯æ‹¦ä¸ä½ä¸€äº›å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 1ï¼šä¸ºä»€ä¹ˆ LruCache ä¸æ”¯æŒ null ä½œä¸º Key æˆ– Valueï¼Ÿ**

å…¶å®å¹¶æ²¡æœ‰ä¸€å®šä¸èƒ½ä¸º null çš„ç†ç”±ï¼Œæˆ‘çš„ç†è§£æ˜¯ Google å¸Œæœ›é™ä½ LruCache çš„ç†è§£æˆæœ¬ã€‚å¦‚æœå…è®¸ Value ä¸º nullï¼Œé‚£ä¹ˆå½“ LruCache éœ€è¦è®¡ç®— Value çš„ size æ—¶ï¼ŒValue ä¸º null é»˜è®¤åº”è¯¥å½“ä½œ 0 è¿˜æ˜¯å½“ä½œ 1å‘¢ï¼Ÿ

å†è€…ï¼Œå¦‚æœä¸šåŠ¡å¼€å‘ç¡®å®æœ‰ Key æˆ– Value çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©é‡å†™ LruCache çš„ç›¸å…³æ–¹æ³•ï¼Œæˆ–è€…ç›´æ¥è‡ªå®ç°ä¸€ä¸ª LruCacheï¼Œè¿™éƒ½æ˜¯å¯ä»¥æ¥å—çš„æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œåœ¨ Android Glide å›¾ç‰‡æ¡†æ¶ä¸­çš„ LruCache å°±æ˜¯è‡ªå®ç°çš„ã€‚

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 2ï¼šä¸ºä»€ä¹ˆ LruCache æ·˜æ±°æ•°æ®æ²¡æœ‰é‡å†™ `LinkedHashMap#removeEldestEntry()` æ¥å£ï¼Ÿ**

è¿™ä¸ªé—®é¢˜å…¶å®è·Ÿä¸Šä¸€èŠ‚çš„ â€œæ·˜æ±°ä¸€ä¸ªæœ€æ—©çš„èŠ‚ç‚¹å°±è¶³å¤Ÿå—ï¼Ÿâ€ é—®é¢˜ç›¸åŒã€‚ç”±äºåªæ·˜æ±°ä¸€ä¸ªæ•°æ®åï¼Œæœ‰å¯èƒ½è¿˜ä¸æ»¡è¶³æœ€å¤§å®¹é‡é™åˆ¶çš„è¦æ±‚ï¼Œæ‰€ä»¥ LruCache ç›´æ¥æ”¾å¼ƒäº† LinkedHashMap#removeEldestEntry() æ¥å£ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº† `trimToSize()` æ·˜æ±°æ–¹æ³•ã€‚

LinkedHashMap#eldest() æ˜¯ Android SDK æ·»åŠ çš„æ–¹æ³•ï¼Œåœ¨ OpenJDK ä¸­æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å› LinkedHashMap åŒå‘é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ LRU æ’åºæ¨¡å¼ï¼Œæ‰€ä»¥å¤´èŠ‚ç‚¹è‡ªç„¶æ˜¯ LRU ç­–ç•¥è¦æ·˜æ±°çš„æœ€ä¹…æœªè®¿é—®çš„èŠ‚ç‚¹ã€‚

åœ¨ `trimToSize()` æ–¹æ³•ä¸­ï¼Œä¼šå¾ªç¯è°ƒç”¨ `LinkedHashMap#eldest()` å–æœ€æ—©çš„èŠ‚ç‚¹ï¼Œç§»é™¤èŠ‚ç‚¹åå†å‡å»èŠ‚ç‚¹å ç”¨çš„å†…å­˜å¤§å°ã€‚æ‰€ä»¥ `trimToSize()` å°†æ·˜æ±°æ•°æ®çš„é€»è¾‘æ”¾åœ¨ while(true) å¾ªç¯ä¸­ï¼Œç›´åˆ°æ»¡è¶³è¦æ±‚æˆ–è€…ç¼“å­˜ä¸ºç©ºï¼Œæ‰ä¼šé€€å‡ºã€‚

`æ·»åŠ æ•°æ®ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/e05001d9-d7bb-455f-8646-3b078c77c862.png)

`LruCache.java`

    public final V put(K key, V value) {
        // ç–‘é—® 1ï¼šä¸æ”¯æŒ null ä½œä¸º Key æˆ– Value
        if (key == null || value == null) {
            throw new NullPointerException("key == null || value == null");
        }
    
        // è¢«æ›¿æ¢çš„æ•°æ®
        V previous;
        synchronized (this) {
            // 1ã€ç»Ÿè®¡æ·»åŠ è®¡æ•°
            putCount++;
            // 2ã€å¢åŠ æ–° Value å†…å­˜å ç”¨
            size += safeSizeOf(key, value);
            // 3ã€è®¾ç½®æ•°æ®
            previous = map.put(key, value);
            // 4ã€å‡å»æ—§ Value å†…å­˜å ç”¨
            if (previous != null) {
                size -= safeSizeOf(key, previous);
            }
        }
        // 5ã€æ•°æ®ç§»é™¤å›è°ƒï¼ˆprevious -> valueï¼‰
        if (previous != null) {
            entryRemoved(false /*éæ·˜æ±°*/, key, previous, value);
        }
        // 6ã€è‡ªåŠ¨æ·˜æ±°æ•°æ®
        trimToSize(maxSize);
        return previous;
    }
    
    // -> 6ã€è‡ªåŠ¨æ·˜æ±°æ•°æ®
    public void trimToSize(int maxSize) {
        // æ·˜æ±°æ•°æ®ç›´åˆ°ä¸è¶…è¿‡æœ€å¤§å®¹é‡é™åˆ¶
        while (true) {
            K key;
            V value;
            synchronized (this) {
                if (size < 0 || (map.isEmpty() && size != 0)) {
                    throw new IllegalStateException(getClass().getName() + ".sizeOf() is reporting inconsistent results!");
                }
    
                // ä¸è¶…è¿‡æœ€å¤§å®¹é‡é™åˆ¶ï¼Œè·³å‡º
                if (size <= maxSize) {
                    break;
                }
    
                // 6.1 å–æœ€æ—©çš„æ•°æ®
                Map.Entry<K, V> toEvict = map.eldest();
                // toEvict ä¸º null è¯´æ˜æ²¡æœ‰æ›´å¤šæ•°æ®
                if (toEvict == null) {
                    break;
                }
    
                key = toEvict.getKey();
                value = toEvict.getValue();
                // 6.2 ç§»é™¤æ•°æ®
                map.remove(key);
                // 6.3 å‡å»æ—§ Value å†…å­˜å ç”¨
                size -= safeSizeOf(key, value);
                // 6.4 ç»Ÿè®¡æ·˜æ±°è®¡æ•°
                evictionCount++;
            }
            // 6.5 æ•°æ®ç§»é™¤å›è°ƒï¼ˆvalue -> nullï¼‰
            entryRemoved(true /*æ·˜æ±°*/, key, value, null);
        }
    }
    

`Android LinkedHashMap.java`

    // æç¤ºï¼šOpenJDK ä¸­æ²¡æœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ˜¯ Android SDK æ·»åŠ çš„
    
    public Map.Entry<K, V> eldest() {
        return head;
    }
    

### 3.6 LruCache çš„è·å–æ–¹æ³•

åœ¨è·å–æ•°æ®æ—¶ï¼ŒLruCache å¢åŠ äº†è‡ªåŠ¨åˆ›å»ºæ•°æ®çš„åŠŸèƒ½ï¼ŒåŒºåˆ† 2 ç§ æƒ…å†µï¼š

*   **1ã€ç¼“å­˜å‘½ä¸­ï¼š** ç›´æ¥è¿”å›ç¼“å­˜çš„æ•°æ®ï¼›
*   **2ã€ç¼“å­˜æœªå‘½ä¸­ï¼š** è°ƒç”¨ `LruCache#create` å°è¯•åˆ›å»ºæ•°æ®ï¼Œå¹¶å°†æ•°æ®è®¾ç½®åˆ°ç¼“å­˜æ± ä¸­ã€‚è¿™æ„å‘³ç€ LruCache ä¸ä»…æ”¯æŒç¼“å­˜æ•°æ®ï¼Œè¿˜æ”¯æŒåˆ›å»ºæ•°æ®ã€‚

    public final V get(K key) {
        // ä¸æ”¯æŒ null ä½œä¸º Key æˆ– Value
        if (key == null) {
            throw new NullPointerException("key == null");
        }
    
        V mapValue;
        synchronized (this) {
            // 1. å°è¯•è·å–ç¼“å­˜çš„æ•°æ®
            // mapValueï¼šæ—§æ•°æ®
            mapValue = map.get(key);
            if (mapValue != null) { // <æ ‡è®°ç‚¹>
                // 1.1 ç¼“å­˜å‘½ä¸­è®¡æ•°
                hitCount++;
                // 1.2 ç¼“å­˜å‘½ä¸­ï¼Œè¿”å›ç¼“å­˜æ•°æ®
                return mapValue;
            }
            missCount++;
        }
    
        // ç–‘é—® 3ï¼šä¸ºä»€ä¹ˆ create(key) è¦æ”¾åœ¨ synchronized å—å¤–éƒ¨ï¼Ÿ
        // 2. å°è¯•è‡ªåŠ¨åˆ›å»ºç¼“å­˜æ•°æ®ï¼ˆç±»ä¼¼å¯¹è±¡æ± ï¼‰
        V createdValue = create(key);
        if (createdValue == null) {
            return null;
        }
    
        synchronized (this) {
            // 3.1 åˆ›å»ºæ•°æ®è®¡æ•°
            createCount++;
            // 3.2 è®¾ç½®åˆ›å»ºçš„ç¼“å­˜æ•°æ®
            // mapValueï¼šæ—§æ•°æ®
            mapValue = map.put(key, createdValue);
    
            // ç–‘é—® 4ï¼šåœ¨ <æ ‡è®°ç‚¹> åˆ¤æ–­ mapValue ä¸º nullï¼Œè¿™é‡Œå†æ¬¡ get åˆæœ‰å¯èƒ½é nullï¼Œå²‚ä¸æ˜¯çŸ›ç›¾ï¼Ÿ
            if (mapValue != null) {
                // 3.3 å¦‚æœ mapValue æ—§æ•°æ®ä¸ä¸º nullï¼Œè¯´æ˜åœ¨è°ƒç”¨ create() çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–çº¿ç¨‹åˆ›å»ºå¹¶æ·»åŠ äº†æ•°æ®
                // é‚£ä¹ˆæ”¾å¼ƒåˆ›å»ºçš„æ•°æ®ï¼Œå°† mapValue é‡æ–°è®¾ç½®å›å»ã€‚ç”±äºå¦ä¸€ä¸ªçº¿ç¨‹åœ¨è®¾ç½®æ—¶å·²ç»ç´¯åŠ  size å†…å­˜å ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä¸ç”¨é‡å¤ç´¯åŠ 
                map.put(key, mapValue);
            } else {
                // 3.4 å¦‚æœ mapValue æ—§æ•°æ®ä¸º nullï¼Œé‚£ä¹ˆç´¯åŠ  createdValue çš„å†…å­˜å ç”¨
                size += safeSizeOf(key, createdValue);
            }
        }
    
        // 4. åå¤„ç†
        if (mapValue != null) {
            // 4.1 æ•°æ®ç§»é™¤å›è°ƒï¼ˆcreatedValue -> mapValueï¼‰
            entryRemoved(false /*éæ·˜æ±°*/, key, createdValue, mapValue);
            return mapValue;
        } else {
            // 4.2 å¢åŠ äº† createdValue åï¼Œéœ€è¦ç¼©å®¹
            trimToSize(maxSize);
            return createdValue;
        }
    }
    
    protected V create(K key) {
        return null;
    }
    

ä¸å‡ºæ„å¤–çš„è¯åˆæœ‰å°æœ‹å‹å‡ºæ¥ä¸¾æ‰‹æé—®äº†**ğŸ™‹ğŸ»â€â™€ï¸**ï¼š

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 3ï¼šä¸ºä»€ä¹ˆ create(key) è¦æ”¾åœ¨ synchronized å—å¤–éƒ¨ï¼Ÿ**

è¿™æ˜¯ä¸ºäº†é™ä½é”çš„é¢—ç²’åº¦ã€‚

ç”±äº create(key) åˆ›å»ºæ•°æ®çš„è¿‡ç¨‹å¯èƒ½æ˜¯è€—æ—¶çš„ï¼Œå¦‚æœå°† create(key) æ”¾åˆ° synchronized åŒæ­¥å—å†…éƒ¨ï¼Œé‚£ä¹ˆåœ¨åˆ›å»ºæ•°æ®çš„è¿‡ç¨‹ä¸­å°±ä¼šé˜»å¡å…¶ä»–çº¿ç¨‹è®¿é—®ç¼“å­˜çš„éœ€æ±‚ï¼Œä¼šé™ä½ç¼“å­˜ç³»ç»Ÿçš„ååé‡ã€‚

*   **ğŸ™‹ğŸ»â€â™€ï¸ç–‘é—® 4ï¼šåœ¨ <æ ‡è®°ç‚¹> åˆ¤æ–­ `mapValue` ä¸º nullï¼Œè¿™é‡Œå†æ¬¡ get åˆæœ‰å¯èƒ½é nullï¼Œå²‚ä¸æ˜¯çŸ›ç›¾ï¼Ÿ**

è¿™ä¸ªé—®é¢˜ä¸ä¸Šä¸€ä¸ªé—®é¢˜æœ‰å…³ã€‚

ç”±äº create(key) æ”¾åœ¨ synchronized å—å¤–éƒ¨ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œ create(key) çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¯èƒ½å…¶ä»–çº¿ç¨‹å·²ç»åˆ›å»ºå¹¶æ·»åŠ äº†ç›®æ ‡æ•°æ®ï¼Œæ‰€ä»¥åœ¨ put(createdValue) çš„æ—¶å€™å°±ä¼šå‡ºç° `mapValue` ä¸ä¸º null çš„æƒ…å†µã€‚

æ­¤æ—¶ï¼Œä¼šå­˜åœ¨ä¸¤ä¸ª Value çš„æƒ…å†µï¼Œåº”è¯¥é€‰æ‹©å“ªä¸€ä¸ª Value å‘¢ï¼ŸLruCache è®¤ä¸ºå…¶ä»–çº¿ç¨‹æ·»åŠ çš„æ•°æ®çš„ä¼˜å…ˆçº§ä¼˜äºé»˜è®¤åˆ›å»ºçš„ç¼ºçœæ•°æ®ï¼Œæ‰€ä»¥åœ¨ 3.3 åˆ†æ”¯æ”¾å¼ƒäº†ç¼ºçœæ•°æ®ï¼Œé‡æ–°å°† `mapValue` è®¾ç½®å›å»ã€‚

`è·å–æ•°æ®ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/6fcf2bd8-10e4-488f-b868-9210415bb98b.png)

### 3.7 LruCache çš„ç§»é™¤æ–¹æ³•

LruCache çš„ç§»é™¤æ–¹æ³•æ˜¯æ·»åŠ æ–¹æ³•çš„é€†è¿ç®—ï¼Œè¿‡ç¨‹æˆ‘æ¦‚æ‹¬ä¸º 3 æ­¥ï¼š

*   1ã€ç§»é™¤èŠ‚ç‚¹ï¼ˆLinkedHashMap#removeï¼‰ï¼›
*   2ã€size å‡å» Value çš„å†…å­˜å ç”¨ï¼›
*   3ã€æ•°æ®ç§»é™¤å›è°ƒï¼ˆLruCache#entryRemovedï¼‰;

    public final V remove(K key) {
        // ä¸æ”¯æŒ null ä½œä¸º Key æˆ– Value
        if (key == null) {
            throw new NullPointerException("key == null");
        }
    
        V previous;
        synchronized (this) {
            // 1. ç§»é™¤æ•°æ®
            previous = map.remove(key);
            // 2. å‡å»ç§»é™¤ Value å†…å­˜å ç”¨
            if (previous != null) {
                size -= safeSizeOf(key, previous);
            }
        }
    
        // 3. æ•°æ®ç§»é™¤å›è°ƒï¼ˆprevious -> nullï¼‰
        if (previous != null) {
            entryRemoved(false, key, previous, null);
        }
    
        return previous;
    }
    

`ç§»é™¤æ•°æ®ç¤ºæ„å›¾`

![](https://files.mdnice.com/user/3257/2f827efc-dc82-4a38-afe1-d75f0a5cc42d.png)

è‡³æ­¤ï¼ŒLruCache æºç åˆ†æç»“æŸã€‚

* * *

4\. æ€»ç»“
------

*   1ã€LruCache æ˜¯ Android æ ‡å‡†åº“æä¾›çš„ LRU å†…å­˜ç¼“å­˜æ¡†æ¶ï¼ŒåŸºäº Java LinkedHashMap å®ç°ï¼Œå½“ç¼“å­˜å®¹é‡è¶…è¿‡æœ€å¤§ç¼“å­˜å®¹é‡é™åˆ¶æ—¶ï¼Œä¼šæ ¹æ® LRU ç­–ç•¥æ·˜æ±°æœ€ä¹…æœªè®¿é—®çš„ç¼“å­˜æ•°æ®ï¼›
    
*   2ã€LruCache éœ€è¦é‡å†™ `sizeOf()` æµ‹é‡ç¼“å­˜å•å…ƒçš„å†…å­˜å ç”¨é‡ï¼Œå¦åˆ™ç¼“å­˜å•å…ƒçš„å¤§å°é»˜è®¤è§†ä¸º 1ï¼Œç›¸å½“äº `maxSize` è¡¨ç¤ºçš„æ˜¯æœ€å¤§ç¼“å­˜æ•°é‡ï¼›
    
*   3ã€LruCache æ”¾å¼ƒäº† `LinkedHashMap#removeEldestEntry()` æ¥å£ï¼Œè€Œæ˜¯è‡ªå·±å®ç°äº† trimToSize() æ·˜æ±°æ–¹æ³•ï¼›
    

ä»Šå¤©ï¼Œæˆ‘ä»¬è®¨è®ºäº† LRU ç¼“å­˜æ·˜æ±°ç­–ç•¥å’Œä¸€äº›å†…å­˜ç¼“å­˜çš„è®¾è®¡é—®é¢˜ï¼Œå¹¶ä¸”åˆ†æäº† Android LruCache æºç ã€‚åœ¨æˆ‘ä»¬ç†Ÿæ‚‰çš„ Glide å›¾ç‰‡æ¡†æ¶ä¸­ï¼Œä¹Ÿæ·±å…¥ä½¿ç”¨äº† LRU å†…å­˜ç¼“å­˜ç­–ç•¥ï¼Œä½ èƒ½è¯´å‡ºå®ƒçš„è®¾è®¡åŸç†å—ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« è®¨è®ºï¼Œè¯·å…³æ³¨ã€‚

* * *

### å‚è€ƒèµ„æ–™

*   [Android å¼€æºæ¡†æ¶æºç é‰´èµï¼šLruCache ä¸ DiskLruCache](https://juejin.cn/post/6844903556705681421) â€”â€” éƒ­å­æ˜Ÿ è‘—
*   [LruCache åœ¨ç¾å›¢ DSP ç³»ç»Ÿä¸­çš„åº”ç”¨æ¼”è¿›](https://tech.meituan.com/2018/12/20/lrucache-practice-dsp.html) â€”â€” ç‹ç²² å´”æ¶› éœœéœœï¼ˆç¾å›¢æŠ€æœ¯å›¢é˜Ÿï¼‰è‘—
*   [LruCache](https://developer.android.google.cn/reference/androidx/collection/LruCache?hl=en) â€”â€” Android å®˜æ–¹æ–‡æ¡£

å°å½­çš„ Android äº¤æµç¾¤ 02 ç¾¤
--------------------

![](https://files.mdnice.com/user/3257/4a2e243b-3b26-4c14-9826-cfe3c9cc99a9.png)