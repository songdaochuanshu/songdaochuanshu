---
layout: post
title: "ã€Springç³»åˆ—ã€‘- æ‰‹å†™æ¨¡æ‹ŸSpringæ¡†æ¶"
date: "2022-11-13T22:19:13.406Z"
---
ã€Springç³»åˆ—ã€‘- æ‰‹å†™æ¨¡æ‹ŸSpringæ¡†æ¶
========================

ä¸Šæ¬¡å·²ç»å­¦ä¹ äº†Javaçš„è®¾è®¡æ¨¡å¼ï¼Œæ¥ä¸‹æ¥å°±å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•æ‰‹å†™æ¨¡æ‹Ÿç®€æ˜“çš„Springï¼Œé€šè¿‡åŠ¨æ‰‹å®è·µï¼Œæ‰ä¼šæ›´å¥½çš„äº†è§£springåº•å±‚åŸç†ï¼Œä»Šå¤©å°±ç®€å•çš„æ¨¡æ‹ŸSpringå®¹å™¨æ˜¯å¦‚ä½•åˆ›å»ºï¼Œbeanåˆæ˜¯å¦‚ä½•æ³¨å…¥çš„ã€‚

ç®€å•æ¨¡æ‹ŸSpring
==========

> ğŸ˜„ç”Ÿå‘½ä¸æ¯ï¼Œå†™ä½œä¸æ­¢  
> ğŸ”¥ ç»§ç»­è¸ä¸Šå­¦ä¹ ä¹‹è·¯ï¼Œå­¦ä¹‹åˆ†äº«ç¬”è®°  
> ğŸ‘Š æ€»æœ‰ä¸€å¤©æˆ‘ä¹Ÿèƒ½åƒå„ä½å¤§ä½¬ä¸€æ ·  
> ğŸ† [ä¸€ä¸ªæœ‰æ¢¦æœ‰æˆçš„äºº](https://blog.csdn.net/qq_43843951) [@æ€’æ”¾å§å¾·å¾·](https://www.cnblogs.com/lyd-code/)  
> ğŸŒåˆ†äº«å­¦ä¹ å¿ƒå¾—ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œå¤§å®¶ä¸€èµ·å­¦ä¹ æˆé•¿ï¼

![spring.jpg](https://ucc.alicdn.com/pic/developer-ecology/ed64a2c628204976b76566eb24049c2d.jpg)

å‰è¨€
--

ä¸Šæ¬¡å·²ç»å­¦ä¹ äº†Javaçš„è®¾è®¡æ¨¡å¼ï¼Œæ¥ä¸‹æ¥å°±å…ˆæ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•æ‰‹å†™æ¨¡æ‹Ÿç®€æ˜“çš„Springï¼Œé€šè¿‡åŠ¨æ‰‹å®è·µï¼Œæ‰ä¼šæ›´å¥½çš„äº†è§£springåº•å±‚åŸç†ï¼Œä»Šå¤©å°±ç®€å•çš„æ¨¡æ‹ŸSpringå®¹å™¨æ˜¯å¦‚ä½•åˆ›å»ºï¼Œbeanåˆæ˜¯å¦‚ä½•æ³¨å…¥çš„ã€‚  
æ¥çœ‹ä¸€ä¸‹æœ¬æ¬¡æ¡ˆä¾‹çš„springç±»å›¾  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/6216ef491db847198683c43d3f0837e2.png)

Springå®¹å™¨
--------

æ¨¡æ‹Ÿspringï¼Œé¦–å…ˆå°±æ˜¯éœ€è¦ä¸€ä¸ªå®¹å™¨ï¼Œæ˜¯Springçš„æ ¸å¿ƒï¼Œä¸€åˆ‡Spring beanéƒ½å­˜å‚¨åœ¨Springå®¹å™¨å†…ï¼Œå¹¶ç”±å…¶é€šè¿‡IoCæŠ€æœ¯ç®¡ç†ã€‚Springå®¹å™¨ä¹Ÿå°±æ˜¯ä¸€ä¸ªbeanå·¥å‚ï¼ˆBeanFactoryï¼‰ã€‚åº”ç”¨ä¸­beançš„å®ä¾‹åŒ–ï¼Œè·å–ï¼Œé”€æ¯ç­‰éƒ½æ˜¯ç”±è¿™ä¸ªbeanå·¥å‚ç®¡ç†çš„ã€‚å°±åƒæˆ‘ä»¬åˆšå¼€å§‹å­¦ä¹ çš„æ—¶å€™æ¥è§¦çš„**ApplicationContext**ï¼Œå°±æ˜¯springçš„å®¹å™¨ï¼Œä»–å°±æ˜¯ä¸ºäº†å®Œæˆå®¹å™¨çš„é…ç½®ï¼Œåˆå§‹åŒ–ï¼Œç®¡ç†beançš„ã€‚å› æ­¤ç¬”è€…è‡ªå·±åˆ›å»ºäº†ä¸€ä¸ª**LydApplicationContext**æ¥æ¨¡æ‹Ÿç®€å•çš„springå®¹å™¨ã€‚

### å¼€å§‹ä½¿ç”¨

é¦–å…ˆé€šè¿‡`new LydApplicationContext(AppConfig.class)`å®ä¾‹åŒ–å¯¹è±¡ï¼Œåœ¨é€šè¿‡`applicationContext.getBean("userService")`å»è·å¾—beanå¯¹è±¡ã€‚ç„¶è€Œåœ¨å®¹å™¨çš„åˆå§‹åŒ–å¯æ˜¯åšäº†è®¸å¤šçš„äº‹æƒ…ï¼ŒåŒ…æ‹¬æ‰«æã€å®ä¾‹åŒ–beanç­‰ç­‰æ“ä½œã€‚  
åˆå§‹å®¹å™¨åˆ›å»ºï¼š

    public class LydApplicationContext {
        private Class configClass; 
        public LydApplicationContext(Class configClass) { // æ„é€ æ–¹æ³•
            this.configClass = configClass;
        }
    }
    

Springæ‰«æåº•å±‚å®ç°
------------

Springå®¹å™¨å»ºå¥½ä¹‹åæˆ‘ä»¬å°±éœ€è¦é€šè¿‡é…ç½®æ–‡ä»¶çš„æ³¨è§£è·å–æ‰«æè·¯å¾„ï¼Œæˆ‘ä»¬éœ€è¦è·å–æ‰€æœ‰çš„beanï¼Œå¹¶ä¸”éœ€è¦å®ä¾‹å¯¹è±¡ã€‚åœ¨æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå°±æ˜¯ä½¿ç”¨`new LydApplicationContext(AppConfig.class)` å®ä¾‹æºå¸¦çš„é…ç½®ç±»ï¼Œå½“ç„¶è¿™é‡Œæœ‰å¥½å¤šçš„å½¢å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šè¿‡xmlæ–‡ä»¶æ¥å¤„ç†ã€‚

### é…ç½®æ–‡ä»¶AppConfig.java

è¿™ä¸ªå°±æ˜¯ä¸ºäº†æä¾›æ‰«æçš„åŒ…è·¯å¾„çš„ï¼Œä¸åšä»»ä½•æ“ä½œï¼Œæ‰€ä»¥ä¸éœ€è¦å…¶ä»–ä»£ç ã€‚

    @ComponentScan("com.lyd.service") // æ‰«æè·¯å¾„ï¼Œæ‰«æè¿™ä¸ªåŒ…ä¸‹çš„
    public class AppConfig {
    }
    

é€šè¿‡æ³¨è§£å­˜æ”¾è¿™ä¸ªåŒ…è·¯å¾„ï¼Œåœ¨åé¢å¯ä»¥é€šè¿‡è¿™ä¸ªæ³¨è§£æ¥è·å–åŒ…è·¯å¾„ï¼Œæ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`ComponentScan`æ³¨è§£ã€‚

### ç¼–å†™ComponentScanæ³¨è§£

è¿™ä¸ªæ³¨è§£æ˜¯ç”¨æ¥springå®¹å™¨æ‰«æåŒ…ä¸ºä¹‹æä¾›åŒ…è·¯å¾„ã€‚

    @Target(ElementType.TYPE)
    @Retention(RetentionPolicy.RUNTIME)
    public @interface ComponentScan {
        // æŒ‡å®šæ‰«æè·¯å¾„
        String value() default "";
    }
    

### ç¼–å†™Componentæ³¨è§£

åœ¨Springä¸­ï¼Œé€šè¿‡`Component`æ³¨è§£å°†beanæ³¨å…¥Springå®¹å™¨ä¸­ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿé‡‡ç”¨é«˜è¿™ä¸ªæ³¨è§£ã€‚

    @Target(ElementType.TYPE)
    @Retention(RetentionPolicy.RUNTIME)
    public @interface Component {
        String value() default "";
    }
    

### è·å–åŒ…è·¯å¾„

æ—¢ç„¶å·²ç»é€šè¿‡æ³¨è§£å°†åŒ…è·¯å¾„å­˜åœ¨é…ç½®ç±»ä¸­ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡è¿™ä¸ªæ³¨è§£æ¥å¾—åˆ°ã€‚ä½†æ˜¯ï¼Œåœ¨è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬æ‰«æçš„å¹¶éæ˜¯javaæºæ–‡ä»¶ï¼Œè€Œæ˜¯ç¼–è¯‘åçš„classæ–‡ä»¶ã€‚æˆ‘ä»¬éœ€è¦åœ¨`LydApplicationContext`çš„æ„é€ æ–¹æ³•ä¸­å»å®ç°ã€‚  
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡isAnnotationPresentæ–¹æ³•å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨`ComponentScan`æ³¨è§£ï¼Œåœ¨é€šè¿‡ç±»çš„`getAnnotation`æ–¹æ³•æ¥å¾—åˆ°æ³¨è§£ã€‚è¿™æ ·å°±å¯ä»¥ç›´æ¥å¾—åˆ°æ³¨è§£ä¸Šçš„å€¼ã€‚è¿™ä¸ªå€¼å°±æ˜¯æˆ‘ä»¬å†™å…¥çš„åŒ…è·¯å¾„ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„è·¯å¾„æ˜¯com.lyd.serviceï¼Œè€Œæˆ‘ä»¬éœ€è¦ç”¨æ›¿æ¢æ–¹æ³•å°†'.'æ›¿æ¢æˆ'/'ï¼Œå› ä¸ºåœ¨åé¢è·å–èµ„æºè·¯å¾„çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯`com/lyd/service`è¿™ç§å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ç›¸å¯¹è·¯å¾„ã€‚  
æ¥ä¸‹æ¥éœ€è¦è·å–èµ„æºè·¯å¾„ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°ç±»åŠ è½½å™¨`LydApplicationContext.class.getClassLoader()`ï¼Œç±»åŠ è½½å™¨ä¸­æœ‰ä¸€ä¸ª`getResource(path)`æ–¹æ³•ï¼Œè¿™ä¸ªå¯ä»¥æ ¹æ®ä¼ å…¥çš„è·¯å¾„è·å–ç›¸åº”çš„èµ„æºï¼Œæœ€åæ˜¯èƒ½å¤Ÿæ‹¼å‡ºæˆ‘ä»¬éœ€è¦çš„ç»å¯¹è·¯å¾„ã€‚

    if (configClass.isAnnotationPresent(ComponentScan.class)) {
        ComponentScan componentScanAnnotation = (ComponentScan) configClass.getAnnotation(ComponentScan.class);
        // 1.1 æ‰«æè·¯å¾„:åªæ˜¯ä¸ªåŒ…å,æ‰«æçš„æ˜¯javaçš„classæ–‡ä»¶ï¼Œè€Œå¹¶éæºæ–‡ä»¶ï¼Œcom.lyd.service
        String path = componentScanAnnotation.value();
        // 1.2 å°†è·¯å¾„æ–‡ä»¶æ›¿æ¢æˆ/çš„å½¢å¼
        path = path.replace(".","/");
        // 1.3 é€šè¿‡ç±»åŠ è½½å™¨è·å–èµ„æºè·¯å¾„
        ClassLoader classLoader = LydApplicationContext.class.getClassLoader();
        URL resource = classLoader.getResource(path);
        // 1.4 è½¬æˆæ–‡ä»¶å½¢å¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†è·å–ä»–çš„ç»å¯¹åœ°å€
        File file = new File(resource.getFile());
        System.out.println(file);
    }
    

é€šè¿‡ç±»åŠ è½½å™¨å¾—åˆ°çš„èµ„æºæœ‰ä¸ªè·å–Fileçš„æ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡`File file = new File(resource.getFile())`;å°†èµ„æºè½¬æˆFileç±»å‹ï¼Œå› ä¸ºä»–å¯ä»¥è¡¨ç¤ºä¸€ä¸ªåœ°å€æˆ–è€…æ˜¯å…·ä½“æ–‡ä»¶ã€‚æ‰«æå°±æ˜¯æ‰«ææ–‡ä»¶è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬å¯ä»¥æ‰“å°çœ‹ä¸€ä¸‹è¿™ä¸ªåœ°å€ï¼š  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/5a278f064c8e40e5ad93628f9d6dc5d5.png)

åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±è·å–é‡Œé¢çš„æ‰€æœ‰æ–‡ä»¶ï¼Œåœ¨é€šè¿‡éå†è¿™äº›æ–‡ä»¶ï¼Œè·å–ç»å¯¹è·¯å¾„ã€‚

    if (file.isDirectory()) { // å¦‚æœæ˜¯æ–‡ä»¶å¤¹
        File[] files = file.listFiles();
        for (File f : files) {
            String absolutePath = f.getAbsolutePath(); // è·å–ç»å¯¹è·¯å¾„
            System.out.println("ç»å¯¹è·¯å¾„ï¼š" + absolutePath);
        }
    }
    

æˆ‘ä»¬å¯ä»¥æ‰“å°å‡ºæ¥çœ‹ä¸€ä¸‹ï¼š  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/1315caa8963346558c9235b27845c758.png)

å› ä¸ºæˆ‘ä»¬è¦çš„æ˜¯ç¼–è¯‘çš„.classæ–‡ä»¶ï¼Œå› æ­¤éœ€è¦åœ¨éå†æ–‡ä»¶çš„æ—¶å€™è¿›è¡Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸º.classæ–‡ä»¶ã€‚ä¸ºäº†æ‹¿åˆ°è¿™ä¸ªç±»ï¼Œéœ€è¦é€šè¿‡å…¨é™å®šåä½¿ç”¨ç±»åŠ è½½å™¨è·å–ç±» ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨åå°„æœºåˆ¶ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œ**spring**æ˜¯é€šè¿‡**Component**æ³¨è§£æ¥å°†**bean**æ³¨å…¥springçš„ï¼Œå› æ­¤æœ€åå°±æ˜¯é€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰è¿™ä¸ªæ³¨è§£æ¥å¾—åˆ°ä¸€ä¸ªbeanã€‚

    for (File f : files) {
    	String absolutePath = f.getAbsolutePath(); // è·å–ç»å¯¹è·¯å¾„
    	System.out.println("ç»å¯¹è·¯å¾„ï¼š" + absolutePath);
    	// 1.5 å¯¹ç¼–è¯‘æ–‡ä»¶è¿›è¡Œå¤„ç†
    	if (absolutePath.endsWith(".class")) { // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¯‘æ–‡ä»¶
    		/**
    		 * éœ€è¦æ‹¿åˆ°çš„æ˜¯ç¼–è¯‘æ–‡ä»¶ï¼Œé€šè¿‡ç±»åŠ è½½å™¨å»è·å–
    		 * éœ€è¦å°†com\lyd\service\UserServiceè½¬æˆcom.lyd.service.UserService
    		 */
    		String className = absolutePath.substring(absolutePath.indexOf("com"), absolutePath.indexOf(".class"));
    		className = className.replace("\\", ".");
    		System.out.println("ç±»åï¼š" + className);
    		try {
    			// 1.6 é€šè¿‡å…¨é™å®šåä½¿ç”¨ç±»åŠ è½½å™¨è·å–ç±» (åˆ©ç”¨åå°„æœºåˆ¶)
    			Class<?> clazz = classLoader.loadClass(className);
    			// 1.7 åœ¨é€šè¿‡è¿™ä¸ªclazzï¼ˆç±»ï¼‰æ¥åˆ¤æ–­æ˜¯å¦æœ‰componentæ³¨è§£ï¼Œæœ‰åˆ™æ˜¯bean
    			if (clazz.isAnnotationPresent(Component.class)) {
    				// åˆ°è¿™é‡Œå°±æ˜¯ä¸€ä¸ªbean
    			}
    		} catch (Exception e) {
    			e.printStackTrace();
    		}
    	}
    }
    

æœ€åæˆ‘ä»¬éœ€è¦çš„åœ°å€å°±æ˜¯å¦‚ä¸‹ï¼š  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/3d7cf8ed1deb4a83a4c76103b3a594a0.png)

Springç”ŸæˆBeanDefinition
----------------------

åœ¨æˆ‘ä»¬Springå®¹å™¨å¯åŠ¨æˆ–è€…æ˜¯æ‰«æçš„æ—¶å€™ï¼Œå¹¶ä¸å»ºè®®ç›´æ¥å®ä¾‹åŒ–beanå¯¹è±¡ï¼Œå› ä¸ºbeanæ˜¯åŒºåˆ†å•ä¾‹å’Œå¤šä¾‹çš„ï¼Œå¤šä¾‹beanæˆ‘ä»¬æ˜¯éœ€è¦ç”¨åˆ°çš„æ—¶å€™å†å»åˆ›å»ºã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”ŸæˆBeanDefinitionï¼Œå³beançš„å®šä¹‰ï¼Œè¿™ä¸ªç±»å­˜å‚¨äº†ç±»å’Œä½œç”¨åŸŸ(å•ä¾‹è¿˜æ˜¯å¤šä¾‹)ã€‚

### å®šä¹‰Scopeæ³¨è§£

é€šè¿‡Scopeè¿™ä¸ªæ³¨è§£æ¥æ ‡æ˜æ˜¯å•ä¾‹beanè¿˜æ˜¯å¤šä¾‹beanã€‚

    @Target(ElementType.TYPE)
    @Retention(RetentionPolicy.RUNTIME)
    public @interface Scope {
        String value() default "";
    }
    

### å®šä¹‰BeanDefinition

åœ¨springä¸­ï¼Œä¸ä¼šåœ¨è·å–beançš„æ—¶å€™å†å»è§£ææ˜¯å¦ä¸ºå•ä¾‹ï¼Œè€Œæ˜¯é€šè¿‡BeanDefinitionç±»æ¥æ“ä½œã€‚å¯¹beançš„å®šä¹‰ï¼Œè®°å½•äº†beanç±»å’Œä½œç”¨åŸŸã€‚

    public class BeanDefinition {
        private Class type;
        private String scope; // å•ä¾‹å¤šä¾‹
        public Class getType() {
            return type;
        }
        public void setType(Class type) {
            this.type = type;
        }
        public String getScope() {
            return scope;
        }
        public void setScope(String scope) {
            this.scope = scope;
        }
    }
    

å› ä¸ºæˆ‘ä»¬æ³¨å…¥**spring**çš„**bean**å¯¹è±¡æ˜¯æœ‰**Component**æ³¨è§£ï¼Œå› æ­¤åœ¨æ‰«æçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡è¿™ä¸ªè·å¾—åˆ°**bean**ï¼Œåœ¨è¿™æ—¶å€™å»åˆ›å»ºBeanDefinitionå¯¹è±¡ã€‚é€šè¿‡åˆ¤æ–­æ³¨è§£ä¸Šçš„å€¼æ¥èµ‹å€¼å…¶ä½œç”¨åŸŸï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå°±é»˜è®¤æ˜¯å•ä¾‹æ¨¡å¼ã€‚  
åˆ›å»ºå¥½çš„beanå¯¹è±¡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†ä»–è¿›è¡Œä¿å­˜èµ·æ¥ï¼Œè¿™ä¸ªå°±éœ€è¦å®šä¹‰`ConcurrentHashMap<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap<>()`;å­˜å‚¨**beanDefinition**ã€‚keyæ˜¯**component**çš„å€¼ï¼Œå¦‚æœ**component**æ²¡æœ‰ä¼ å…¥**beanName**çš„å€¼ï¼Œé‚£å°±ä½¿ç”¨springçš„å‘½åè§„åˆ™ï¼Œé‡‡ç”¨ç±»åé¦–å­—æ¯å°å†™ã€‚

    // 1.7 åœ¨é€šè¿‡è¿™ä¸ªclazzï¼ˆç±»ï¼‰æ¥åˆ¤æ–­æ˜¯å¦æœ‰componentæ³¨è§£ï¼Œæœ‰åˆ™æ˜¯bean
    if (clazz.isAnnotationPresent(Component.class)) {
    	Component annotation = clazz.getAnnotation(Component.class);
    	String beanName = annotation.value();
        // * é»˜è®¤ç”Ÿæˆbeanï¼Œå¦‚æœåªä½¿ç”¨Componentæ³¨è§£ï¼Œæ²¡æœ‰å†™ä¸ŠbeanNameçš„å€¼ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªåŠ¨ç”Ÿæˆ
        if (beanName.equals("")) {
            // é»˜è®¤å¼€å¤´å°å­—æ¯
            beanName = Introspector.decapitalize(clazz.getSimpleName());
        }
    	/**
    	 * é€™å°±æ˜¯ä¸€ä¸ªbeanäº†
    	 * ç„¶è€Œåœ¨è¿™é‡Œå¹¶ä¸æ˜¯ç›´æ¥å°±åˆ›å»ºbeanäº†ï¼Œbeanåˆ†ä¸ºäº†å•ä¾‹beanå’Œå¤šä¾‹bean
    	 */
    	BeanDefinition beanDefinition = new BeanDefinition();
    	beanDefinition.setType(clazz);
    	if (clazz.isAnnotationPresent(Scope.class)) { // åˆ¤æ–­æ˜¯å•ä¾‹è¿˜æ˜¯å¤šä¾‹
    		Scope scope = clazz.getAnnotation(Scope.class);
    		beanDefinition.setScope(scope.value());
    	} else {
    		beanDefinition.setScope("singleton");
    	}
        beanDefinitionMap.put(beanName, beanDefinition);
    }
    

getBeanåº•å±‚
---------

é€šè¿‡ä¼ æ¥ä¸€ä¸ªbeanNameï¼Œé€šè¿‡beanDefinitionMapä¸­è·å–keyä¸ºbeanNameçš„BeanDefinitionå¯¹è±¡ï¼Œè¿›è¡Œåˆ¤ç©ºå¤„ç†ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªBeanDefinitionå¯¹è±¡å»è·å–ä½œç”¨åŸŸï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå•ä¾‹ã€‚

### è·å–bean

åœ¨æ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºå•ä¾‹çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦å°†å•ä¾‹ä¿å­˜èµ·æ¥çš„ï¼Œéœ€è¦å®šä¹‰`ConcurrentHashMap<String, Object> singletonObjects = new ConcurrentHashMap<>()`;å•ä¾‹æ± æ¥ä¿å­˜å•ä¾‹beanã€‚ç„¶ååœ¨getBeançš„æ—¶å€™ï¼Œå¦‚æœæ˜¯å•ä¾‹beanï¼Œå°±å¯ä»¥å…ˆå»å•ä¾‹æ± ä¸­å¯»æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå†å»åˆ›å»ºå¯¹è±¡ã€‚è€Œå¤šä¾‹æ¨¡å¼å°±éœ€è¦æ¯æ¬¡éƒ½å»åˆ›å»ºã€‚

    // è·å–beanå¯¹è±¡
    public Object getBean(String beanName) {
        BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
        if (beanDefinition == null) {
            throw new NullPointerException("æ‰¾ä¸åˆ°beanåå­—ä¸º[" + beanName + "]çš„beanå¯¹è±¡");
        } else { // æ‰¾åˆ°å°±åšç›¸åº”çš„æ“ä½œ
            String scope = beanDefinition.getScope();
            if (scope.equals("singleton")) {
                // é€šè¿‡å•ä¾‹æ± è·å–
                Object bean = singletonObjects.get(beanName);
                if (bean == null) {
                    // å•ä¾‹æ± ä¸­å¦‚æœæ²¡æœ‰beanï¼Œå°±éœ€è¦å»åˆ›å»º
                    bean = createBean(beanName, beanDefinition);
                    singletonObjects.put(beanName, bean);
                }
                return bean;
            } else {
                // å¤šä¾‹çš„å°±ä¸éœ€è¦è®°å½•ï¼Œæ¯æ¬¡éƒ½æ˜¯é€šè¿‡åˆ›å»º
                return createBean(beanName, beanDefinition);
            }
        }
    }
    

### åˆ›å»ºbean

åˆ©ç”¨åå°„æœºåˆ¶ï¼Œé€šè¿‡æ— å‚æ„é€ æ–¹æ³•å»è·å–å®ä¾‹ï¼Œè¿™é‡Œå°±æ˜¯beanå¯¹è±¡å®ä¾‹äº†ã€‚å°±å¯ä»¥ç›´æ¥è¿”å›ã€‚

    // åˆ›å»ºbean
    private Object createBean(String beanName, BeanDefinition definition) {
    	// åˆ©ç”¨åå°„è·å–å®ä¾‹ï¼Œé‡‡ç”¨æ— å‚æ„é€ æ–¹æ³•
    	Class clazz = definition.getType();
    	// é€šè¿‡æ— å‚æ„é€ æ–¹æ³•è·å–å®ä¾‹
    	try {
    		Object instance = clazz.getConstructor().newInstance(); // åˆ°è¿™é‡Œç›´æ¥è¿”å›ï¼Œbeançš„å¯¹è±¡ä¹Ÿå°±åˆ›å»ºå®Œæˆ
    
    		return instance;
    
    	} catch (InstantiationException e) {
    		e.printStackTrace();
    	}
    	return null;
    }
    

åœ¨æ„é€ æ–¹æ³•æ‰«æåè¦æ ¹æ®ç”Ÿæˆçš„beanDefinitionMapå»åˆ›å»ºå•ä¾‹beanå¯¹è±¡ã€‚

    // 2 åˆ›å»ºå•ä¾‹beanå¯¹è±¡
    for (String beanName : beanDefinitionMap.keySet()) {
        BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
        if (beanDefinition.getScope().equals("singleton")) { // é‚£ä¹ˆï¼Œå¦‚ä½•ä¿è¯å•ä¾‹å‘¢ï¼Ÿå°±éœ€è¦æœ‰ä¸ªå•ä¾‹æ± ,singletonObjects
            Object bean = createBean(beanName, beanDefinition);
            singletonObjects.put(beanName, bean); // å°†å•ä¾‹beanå­˜åˆ°å•ä¾‹æ± ä¸­
        }
    }
    

### è¿è¡Œ

    public class Test {
        public static void main(String[] args) {
            LydApplicationContext applicationContext = new LydApplicationContext(AppConfig.class);
            System.out.println(applicationContext.getBean("userService"));
            System.out.println(applicationContext.getBean("userService"));
            System.out.println(applicationContext.getBean("userService"));
            System.out.println(applicationContext.getBean("userService"));
            System.out.println(applicationContext.getBean("userService"));
        }
    }
    

æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨å•ä¾‹æ¨¡å¼è¿›è¡Œæµ‹è¯•ï¼Œæˆ‘ä»¬ä¸åŠ scopeæ³¨è§£ï¼Œå¹¶ä¸”è·å–å¤šä¸ªbeanï¼Œå¯ä»¥çœ‹åˆ°å¾—åˆ°çš„beanå¯¹è±¡æ˜¯åŒä¸€ä¸ªã€‚  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/5715fb980b0b4e8fadf912873da1b479.png)  
å¤šä¾‹çš„æ—¶å€™åœ¨scopeæ ‡ä¸Šå€¼ï¼Œå°±å¯ä»¥çœ‹åˆ°æ¯æ¬¡è·å–çš„beanå¯¹è±¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/d937fd8678914e5b9ae7ba657e0f87d9.png)

Autowiredè‡ªåŠ¨ä¾èµ–æ³¨å…¥
---------------

å½“æˆ‘ä»¬åœ¨UserServiceä¸­ä½¿ç”¨RoleServiceï¼Œæˆ‘ä»¬å°±éœ€è¦é€šè¿‡Autowiredæ³¨è§£è¿›è¡Œä¾èµ–æ³¨å…¥ã€‚å°±æ˜¯éœ€è¦åœ¨createBeanæ–¹æ³•ä¸­ï¼Œåœ¨åˆ›å»ºå®ä¾‹ä¹‹åï¼Œè·å–ç±»ä¸­çš„å­—æ®µï¼Œè¿›è¡Œä¾èµ–æ³¨å…¥ï¼Œè¦é€šè¿‡åˆ¤æ–­Autowriedæ³¨è§£ã€‚é€šè¿‡å­—æ®µçš„setæ–¹æ³•ï¼Œå°†beanå¯¹è±¡æ³¨å…¥ï¼Œè€Œè¿™ä¸ªå¯¹è±¡å¦‚ä½•è·å¾—å‘¢ï¼Ÿé‚£å°±æ˜¯ç”¨è¿‡getBean()æ–¹æ³•ã€‚

    // 3 ä¾èµ–æ³¨å…¥
    for (Field field : clazz.getDeclaredFields()) {
        // åˆ¤æ–­å­—æ®µä¸Šæ˜¯å¦å­˜åœ¨Autowriedæ³¨è§£
        if (field.isAnnotationPresent(Autowired.class)) {
            /**
             * å€¼ä¸º true åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶åº”è¯¥å–æ¶ˆ Java è¯­è¨€è®¿é—®æ£€æŸ¥ã€‚
             * å€¼ä¸º false åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åº”è¯¥å®æ–½ Java è¯­è¨€è®¿é—®æ£€æŸ¥;
             * å®é™…ä¸ŠsetAccessibleæ˜¯å¯ç”¨å’Œç¦ç”¨è®¿é—®å®‰å…¨æ£€æŸ¥çš„å¼€å…³,å¹¶ä¸æ˜¯ä¸ºtrueå°±èƒ½è®¿é—®ä¸ºfalseå°±ä¸èƒ½è®¿é—® ï¼›
             */
            field.setAccessible(true); // åå°„éœ€è¦è®¾ç½®è¿™ä¸ªï¼Œä¸ç„¶æ— æ³•èµ‹å€¼
            // ç”¨å…¶å±æ€§åï¼Œè¿™å°±æ„å‘³ç€private RoleService roleService;roleServiceä¸èƒ½ä¹±å–
            field.set(instance, getBean(field.getName()));
        }
    }
    

Awareå›è°ƒæœºåˆ¶ä¸åˆå§‹åŒ–
-------------

### Awareå›è°ƒ

é‚£å¦‚æœæˆ‘ä»¬éœ€è¦è·å–å½“å‰beançš„åå­—å‘¢ï¼Ÿé‚£å°±å¾—é€šè¿‡Awareå›è°ƒæœºåˆ¶ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª**BeanNameAware**æ¥å£ï¼Œé‡Œé¢æä¾›ä¸€ä¸ªsetBeanNameæ–¹æ³•ã€‚

    public interface BeanNameAware {
        public void setBeanName(String beanName);
    }
    

åœ¨**createBean**æ–¹æ³•ä¸­å»ç¼–å†™å›è°ƒæœºåˆ¶ï¼Œé€šè¿‡åˆ¤æ–­è¿™ä¸ªå®ä¾‹æ˜¯å¦æœ‰**BeanNameAware**è¿™ä¸ªç±»ï¼Œé€šè¿‡**setName**æ–¹æ³•é—´æ¥ä¼ é€’äº†beanNameã€‚

    // 4 Awareå›è°ƒæœºåˆ¶
    if (instance instanceof BeanNameAware) {
        ((BeanNameAware)instance).setBeanName(beanName);
    }
    

åœ¨**UserService**æ–¹æ³•ä¸­å»å®ç°è¿™ä¸ª**BeanNameAware**æ–¹æ³•ï¼Œè¿™å°±èƒ½å¤Ÿåœ¨**UserService**é‡Œçš„**beanName**å­—æ®µä¸­å¾—åˆ°è¿™ä¸ªbeanå¯¹è±¡çš„çœŸå®çš„**beanName**äº†ã€‚

    @Component("userService") // æ³¨å…¥spring
    @Scope("property")
    public class UserService implements BeanNameAware, InitializingBean {
        @Autowired
        private RoleService roleService; // ä¾èµ–æ³¨å…¥ï¼ŒåŠ ä¸Š@Autowiredæ³¨è§£
    
        private String beanName;
    
        @Override
        public void setBeanName(String beanName) {
            this.beanName = beanName;
        }
    
        public void test() {
            System.out.println("RoleService: " + roleService);
        }
    
        @Override
        public void afterPropertiesSet() {
            // ......
            System.out.println("åˆå§‹åŒ–");
        }
    }
    

### åˆå§‹åŒ–

åœ¨springå®¹å™¨ä¸­ï¼Œä¸åªæ˜¯å®Œæˆbeanå¯¹è±¡çš„åˆ›å»ºï¼Œè¿˜éœ€è¦èƒ½å¤Ÿå¯¹beanè¿›è¡Œåˆå§‹åŒ–ã€‚éœ€è¦åˆ›å»º**InitializingBean**æ¥å£ç±»ã€‚

    public interface InitializingBean {
        public void afterPropertiesSet();
    }
    

åœ¨éœ€è¦è¿›è¡Œåˆå§‹åŒ–çš„beanå¯¹è±¡å»å®ç°è¿™ä¸ªæ¥å£çš„æ–¹æ³•ï¼Œè¿™é‡Œmainå¯ä»¥è¿›è¡Œä¸€äº›æ“ä½œã€‚åœ¨**createBean**ä¸­ï¼Œä¼šæ ¹æ®åˆ¤æ–­æ˜¯å¦æœ‰**InitializingBean**ç±»ï¼Œä¼šåœ¨å®ä¾‹åŒ–ä¹‹åè°ƒç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚

    // 5 åˆå§‹åŒ–
    if (instance instanceof InitializingBean) {
        ((InitializingBean)instance).afterPropertiesSet();
    }
    

ç»“æœ  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/c126224120d74e27a504a274fb8988c8.png)

BeanPostProcessor
-----------------

**BeanPostProcessor**å¯ä»¥å¯¹springä¸­beançš„åˆ›å»ºå»åšä¸€äº›æ“ä½œã€‚

### BeanPostProcessoræ¥å£

åœ¨springä¸­å®šä¹‰ä¸€ä¸ª**BeanPostProcessor**æ¥å£ï¼Œé‡Œé¢ä¼šæœ‰åˆå§‹åŒ–å‰åæ“ä½œçš„æ–¹æ³•ï¼Œå¹¶ä¸”å°†**beanName**å’Œ**bean**å¯¹è±¡å¸¦å…¥è¿›è¡Œè‡ªå®šä¹‰çš„æ“ä½œã€‚

    public interface BeanPostProcessor {
        public Object postBeforeProcessor(String beanName, Object bean); // åˆå§‹åŒ–å‰
        public Object postAfterProcessor(String beanName, Object bean); // åˆå§‹åŒ–å
    }
    

### è‡ªå®šä¹‰BeanPostProcessor

è¿™é‡Œå¯ä»¥å®šä¹‰è‡ªå·±çš„ç±»å»å®ç°**spring**ä¸­çš„**BeanPostProcessor**ï¼Œå¯¹åˆå§‹åŒ–è¿›è¡Œä¸€äº›ç›¸åº”æ“ä½œã€‚å¹¶ä¸”èƒ½å¤Ÿæ ¹æ®æŸä¸ªbeanå¯¹è±¡æ¥åšä¸åŒçš„æ“ä½œã€‚åŸç†å°±æ˜¯å°†**MyBeanPostProcessor**æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œåœ¨æ‰«æçš„æ—¶å€™å°†è¿™ä¸ªå¯¹è±¡ä¿å­˜èµ·æ¥ï¼Œåœ¨åˆ›å»ºbeançš„æ—¶å€™å»éå†BeanPostProcessoré›†åˆï¼Œåœ¨å»è°ƒç”¨è¿™ä¸ªå®ä¾‹çš„æ–¹æ³•ã€‚

    @Component // éœ€è¦æ³¨å…¥spring
    public class MyBeanPostProcessor implements BeanPostProcessor {
        @Override
        public Object postBeforeProcessor(String beanName, Object bean) {
            System.out.println("åˆå§‹åŒ–å‰çš„beanï¼š" + beanName + " -- " + bean);
            return bean;
        }
    
        @Override
        public Object postAfterProcessor(String beanName, Object bean) {
            System.out.println("åˆå§‹åŒ–åçš„beanï¼š" + beanName + " -- " + bean);
            return bean;
        }
    }
    

ç„¶è€Œï¼Œåœ¨**spring**æ‰«æçš„æ—¶å€™ä¼šè¿›è¡Œæ“ä½œï¼Œå› ä¸ºè‡ªå·±å®ç°çš„**BeanPostProcessor**æ˜¯é€šè¿‡**Component**æ³¨è§£æ³¨å…¥springå®¹å™¨çš„ã€‚å› æ­¤å¯ä»¥é€šè¿‡åˆ¤æ–­æœ‰**Component**æ³¨è§£æ—¶å€™ï¼Œè¿›è¡Œåˆ¤æ–­æ˜¯å¦å«æœ‰**BeanPostProcessor**ç±»ï¼Œå¦‚æœæœ‰ç”Ÿæˆ**BeanPostProcessor**å¯¹è±¡ï¼Œå¹¶ä¸”å°†å…¶å®ä¾‹æ·»åŠ åˆ°**beanPostProcessorList**å®¹å™¨ä¸­ã€‚åœ¨æ­¤å°±éœ€è¦å®šä¹‰`ArrayList<BeanPostProcessor> beanPostProcessorList = new ArrayList<>()`;æ¥è®°å½•BeanPostProcessorã€‚

    // 6 åˆ¤æ–­æ˜¯å¦æ˜¯å¹¶åŠ å…¥beanPostProcessorList,è¿™é‡Œä¸èƒ½ä½¿ç”¨instanceof
    if (BeanPostProcessor.class.isAssignableFrom(clazz)) {
        // ç›´æ¥ç”Ÿæˆå¯¹è±¡
        BeanPostProcessor instance = (BeanPostProcessor) clazz.newInstance();
        // ç„¶åä¿å­˜è¿›å»
        beanPostProcessorList.add(instance);
    }
    

æ¥ç€å°±å¯ä»¥åœ¨åˆ›å»ºbeanå¯¹è±¡çš„æ—¶å€™ï¼Œåœ¨åˆå§‹åŒ–å‰åå»éå†è¿™ä¸ªBeanPostProcessoré“¾è¡¨ï¼Œè°ƒç”¨ç›¸åº”çš„æ–¹æ³•ï¼Œå°±èƒ½å¤Ÿè°ƒç”¨è‡ªå®šä¹‰çš„**MyBeanPostProcessor**çš„æ–¹æ³•ã€‚

    // 6 BeanPostProcessor åˆå§‹åŒ–å‰ AOP éå†beanPostProcessorList
    for (BeanPostProcessor beanPostProcessor : beanPostProcessorList) {
        instance = beanPostProcessor.postBeforeProcessor(beanName, instance);
    }
    
    // 5 åˆå§‹åŒ–
    if (instance instanceof InitializingBean) {
        ((InitializingBean)instance).afterPropertiesSet();
    }
    
    // 6 BeanPostProcessor åˆå§‹åŒ–å AOP
    for (BeanPostProcessor beanPostProcessor : beanPostProcessorList) {
        instance = beanPostProcessor.postAfterProcessor(beanName, instance);
    }
    

è¿è¡Œç»“æœï¼š.  
![image.png](https://ucc.alicdn.com/pic/developer-ecology/bcdc6cc79ec8418f899212cc461fa5e7.png)

AOPæœºåˆ¶
-----

éœ€è¦é€šè¿‡ä»£ç†å¯¹è±¡ã€‚è¿™æ ·å¦‚æœä¸è¿›è¡Œæ“ä½œï¼Œè¿”å›çš„å¯¹è±¡è¿˜æ˜¯åŸæ¥çš„ï¼Œå¦‚æœæ˜¯é€šè¿‡æ“ä½œäº†ï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯ä»£ç†çš„å¯¹è±¡ã€‚è¿™é‡Œå°±ç®€å•çš„æ‰“å°ä¸€å¥è¯ã€‚åœ¨æ‰«æçš„æ—¶å€™ï¼Œæ‰«åˆ°userServiceè¿™ä¸ªbeançš„æ—¶å€™ï¼Œè¿”å›çš„å®ä¾‹å°±æ˜¯ä»£ç†å¯¹è±¡ã€‚

    @Override
    public Object postAfterProcessor(String beanName, Object bean) {
        System.out.println("åˆå§‹åŒ–åçš„beanï¼š" + beanName + " -- " + bean);
    
        if (beanName.equals("userService")) {
            // åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡, ä»£ç†çš„æ˜¯UserInterfaceè¿™ä¸ª
            Object proxyInstance = Proxy.newProxyInstance(MyBeanPostProcessor.class.getClassLoader(), bean.getClass().getInterfaces(), new InvocationHandler() {
                @Override
                /**
                 * proxyï¼šä»£ç†å¯¹è±¡
                 * methodï¼šä»£ç†å¯¹è±¡å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•
                 */
                public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                    System.out.println("åˆ‡é¢é€»è¾‘");
                    return method.invoke(bean, args);
                }
            });
            return proxyInstance;
        }
        return bean;
    }
    

æºç å¤‡æ³¨
----

### spring

#### LydApplicationContext

    public class LydApplicationContext {
        private Class configClass; // æ³¨å…¥çš„é…ç½®ç±»
        private ConcurrentHashMap<String, BeanDefinition> beanDefinitionMap = new ConcurrentHashMap<>(); // keyæ˜¯componentåå­—
        private ConcurrentHashMap<String, Object> singletonObjects = new ConcurrentHashMap<>(); // å•ä¾‹æ± 
        private ArrayList<BeanPostProcessor> beanPostProcessorList = new ArrayList<>(); // è®°å½•BeanPostProcessorï¼Œåœ¨æ‰«æçš„æ—¶å€™åˆ¤æ–­ï¼Œä½¿ç”¨
    
        public LydApplicationContext(Class configClass) { // æ„é€ æ–¹æ³•
            this.configClass = configClass;
            // springå®¹å™¨åˆ›å»ºä¹‹å
            // 1 æ‰«æ
            // é€šè¿‡é…ç½®æ–‡ä»¶çš„æ³¨è§£è·å–æ‰«æè·¯å¾„
            if (configClass.isAnnotationPresent(ComponentScan.class)) {
                ComponentScan componentScanAnnotation = (ComponentScan) configClass.getAnnotation(ComponentScan.class);
                // 1.1 æ‰«æè·¯å¾„:åªæ˜¯ä¸ªåŒ…å,æ‰«æçš„æ˜¯javaçš„classæ–‡ä»¶ï¼Œè€Œå¹¶éæºæ–‡ä»¶ï¼Œcom.lyd.service
                String path = componentScanAnnotation.value();
                // 1.2 å°†è·¯å¾„æ–‡ä»¶æ›¿æ¢æˆ/çš„å½¢å¼
                path = path.replace(".","/");
                // 1.3 é€šè¿‡ç±»åŠ è½½å™¨è·å–èµ„æºè·¯å¾„
                ClassLoader classLoader = LydApplicationContext.class.getClassLoader();
                URL resource = classLoader.getResource(path);
                // 1.4 è½¬æˆæ–‡ä»¶å½¢å¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†è·å–ä»–çš„ç»å¯¹åœ°å€
                File file = new File(resource.getFile());
    //            System.out.println(file);
                if (file.isDirectory()) { // å¦‚æœæ˜¯æ–‡ä»¶å¤¹
                    File[] files = file.listFiles();
                    for (File f : files) {
                        String absolutePath = f.getAbsolutePath(); // è·å–ç»å¯¹è·¯å¾„
                        System.out.println("ç»å¯¹è·¯å¾„ï¼š" + absolutePath);
                        // 1.5 å¯¹ç¼–è¯‘æ–‡ä»¶è¿›è¡Œå¤„ç†
                        if (absolutePath.endsWith(".class")) { // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–è¯‘æ–‡ä»¶
                            /**
                             * éœ€è¦æ‹¿åˆ°çš„æ˜¯ç¼–è¯‘æ–‡ä»¶ï¼Œé€šè¿‡ç±»åŠ è½½å™¨å»è·å–
                             * éœ€è¦å°†com\lyd\service\UserServiceè½¬æˆcom.lyd.service.UserService
                             */
                            String className = absolutePath.substring(absolutePath.indexOf("com"), absolutePath.indexOf(".class"));
                            className = className.replace("\\", ".");
                            System.out.println("ç±»åï¼š" + className);
                            try {
                                // 1.6 é€šè¿‡å…¨é™å®šåä½¿ç”¨ç±»åŠ è½½å™¨è·å–ç±» (åˆ©ç”¨åå°„æœºåˆ¶)
                                Class<?> clazz = classLoader.loadClass(className);
                                // 1.7 åœ¨é€šè¿‡è¿™ä¸ªclazzï¼ˆç±»ï¼‰æ¥åˆ¤æ–­æ˜¯å¦æœ‰componentæ³¨è§£ï¼Œæœ‰åˆ™æ˜¯bean
                                if (clazz.isAnnotationPresent(Component.class)) {
                                    // 6 åˆ¤æ–­æ˜¯å¦æ˜¯å¹¶åŠ å…¥beanPostProcessorList,è¿™é‡Œä¸èƒ½ä½¿ç”¨instanceof
                                    if (BeanPostProcessor.class.isAssignableFrom(clazz)) {
                                        // ç›´æ¥ç”Ÿæˆå¯¹è±¡
                                        BeanPostProcessor instance = (BeanPostProcessor) clazz.newInstance();
                                        // ç„¶åä¿å­˜è¿›å»
                                        beanPostProcessorList.add(instance);
                                    }
                                    Component annotation = clazz.getAnnotation(Component.class);
                                    String beanName = annotation.value();
                                    // * é»˜è®¤ç”Ÿæˆbeanï¼Œå¦‚æœåªä½¿ç”¨Componentæ³¨è§£ï¼Œæ²¡æœ‰å†™ä¸ŠbeanNameçš„å€¼ï¼Œé‚£ä¹ˆå°±éœ€è¦è‡ªåŠ¨ç”Ÿæˆ
                                    if (beanName.equals("")) {
                                        // é»˜è®¤å¼€å¤´å°å­—æ¯
                                        beanName = Introspector.decapitalize(clazz.getSimpleName());
                                    }
                                    /**
                                     * é€™å°±æ˜¯ä¸€ä¸ªbeanäº†
                                     * ç„¶è€Œåœ¨è¿™é‡Œå¹¶ä¸æ˜¯ç›´æ¥å°±åˆ›å»ºbeanäº†ï¼Œbeanåˆ†ä¸ºäº†å•ä¾‹beanå’Œå¤šä¾‹bean
                                     */
                                    BeanDefinition beanDefinition = new BeanDefinition();
                                    beanDefinition.setType(clazz);
                                    if (clazz.isAnnotationPresent(Scope.class)) { // åˆ¤æ–­æ˜¯å•ä¾‹è¿˜æ˜¯å¤šä¾‹
                                        Scope scope = clazz.getAnnotation(Scope.class);
                                        beanDefinition.setScope(scope.value());
                                    } else {
                                        beanDefinition.setScope("singleton");
                                    }
                                    beanDefinitionMap.put(beanName, beanDefinition);
                                }
                            } catch (Exception e) {
                                e.printStackTrace();
                            }
                        }
                    }
                }
            }
            // 2 åˆ›å»ºå•ä¾‹beanå¯¹è±¡
            for (String beanName : beanDefinitionMap.keySet()) {
                BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
                if (beanDefinition.getScope().equals("singleton")) { // é‚£ä¹ˆï¼Œå¦‚ä½•ä¿è¯å•ä¾‹å‘¢ï¼Ÿå°±éœ€è¦æœ‰ä¸ªå•ä¾‹æ± ,singletonObjects
                    Object bean = createBean(beanName, beanDefinition);
                    singletonObjects.put(beanName, bean); // å°†å•ä¾‹beanå­˜åˆ°å•ä¾‹æ± ä¸­
                }
            }
        }
    
        // åˆ›å»ºbean
        private Object createBean(String beanName, BeanDefinition definition) {
            // åˆ©ç”¨åå°„è·å–å®ä¾‹ï¼Œé‡‡ç”¨æ— å‚æ„é€ æ–¹æ³•
            Class clazz = definition.getType();
            // é€šè¿‡æ— å‚æ„é€ æ–¹æ³•è·å–å®ä¾‹
            try {
                Object instance = clazz.getConstructor().newInstance(); // åˆ°è¿™é‡Œç›´æ¥è¿”å›ï¼Œbeançš„å¯¹è±¡ä¹Ÿå°±åˆ›å»ºå®Œæˆ
    
                // 3 ä¾èµ–æ³¨å…¥
                for (Field field : clazz.getDeclaredFields()) {
                    // åˆ¤æ–­å­—æ®µä¸Šæ˜¯å¦å­˜åœ¨Autowriedæ³¨è§£
                    if (field.isAnnotationPresent(Autowired.class)) {
                        /**
                         * å€¼ä¸º true åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åœ¨ä½¿ç”¨æ—¶åº”è¯¥å–æ¶ˆ Java è¯­è¨€è®¿é—®æ£€æŸ¥ã€‚
                         * å€¼ä¸º false åˆ™æŒ‡ç¤ºåå°„çš„å¯¹è±¡åº”è¯¥å®æ–½ Java è¯­è¨€è®¿é—®æ£€æŸ¥;
                         * å®é™…ä¸ŠsetAccessibleæ˜¯å¯ç”¨å’Œç¦ç”¨è®¿é—®å®‰å…¨æ£€æŸ¥çš„å¼€å…³,å¹¶ä¸æ˜¯ä¸ºtrueå°±èƒ½è®¿é—®ä¸ºfalseå°±ä¸èƒ½è®¿é—® ï¼›
                         */
                        field.setAccessible(true); // åå°„éœ€è¦è®¾ç½®è¿™ä¸ªï¼Œä¸ç„¶æ— æ³•èµ‹å€¼
                        // ç”¨å…¶å±æ€§åï¼Œè¿™å°±æ„å‘³ç€private RoleService roleService;roleServiceä¸èƒ½ä¹±å–
                        field.set(instance, getBean(field.getName()));
                    }
                }
                // * instanceofï¼šæ˜¯é’ˆå¯¹æŸä¸ªå¯¹è±¡å»åˆ¤æ–­æ˜¯å¦å®ç°æŸä¸ªç±»
                // 4 Awareå›è°ƒæœºåˆ¶
                if (instance instanceof BeanNameAware) {
                    ((BeanNameAware)instance).setBeanName(beanName);
                }
    
                // 6 BeanPostProcessor åˆå§‹åŒ–å‰ AOP éå†beanPostProcessorList
                for (BeanPostProcessor beanPostProcessor : beanPostProcessorList) {
                    instance = beanPostProcessor.postBeforeProcessor(beanName, instance);
                }
    
                // 5 åˆå§‹åŒ–
                if (instance instanceof InitializingBean) {
                    ((InitializingBean)instance).afterPropertiesSet();
                }
    
                // 6 BeanPostProcessor åˆå§‹åŒ–å AOP
                for (BeanPostProcessor beanPostProcessor : beanPostProcessorList) {
                    instance = beanPostProcessor.postAfterProcessor(beanName, instance);
                }
    
                return instance;
    
            } catch (InstantiationException e) {
                e.printStackTrace();
            } catch (IllegalAccessException e) {
                e.printStackTrace();
            } catch (InvocationTargetException e) {
                e.printStackTrace();
            } catch (NoSuchMethodException e) {
                e.printStackTrace();
            }
            return null;
        }
    
        // è·å–beanå¯¹è±¡
        public Object getBean(String beanName) {
            BeanDefinition beanDefinition = beanDefinitionMap.get(beanName);
            if (beanDefinition == null) {
                throw new NullPointerException("æ‰¾ä¸åˆ°beanåå­—ä¸º[" + beanName + "]çš„beanå¯¹è±¡");
            } else { // æ‰¾åˆ°å°±åšç›¸åº”çš„æ“ä½œ
                String scope = beanDefinition.getScope();
                if (scope.equals("singleton")) {
                    // é€šè¿‡å•ä¾‹æ± è·å–
                    Object bean = singletonObjects.get(beanName);
                    if (bean == null) {
                        // å•ä¾‹æ± ä¸­å¦‚æœæ²¡æœ‰beanï¼Œå°±éœ€è¦å»åˆ›å»º
                        bean = createBean(beanName, beanDefinition);
                        singletonObjects.put(beanName, bean);
                    }
                    return bean;
                } else {
                    // å¤šä¾‹çš„å°±ä¸éœ€è¦è®°å½•ï¼Œæ¯æ¬¡éƒ½æ˜¯é€šè¿‡åˆ›å»º
                    return createBean(beanName, beanDefinition);
                }
            }
        }
    }
    
    

### service

#### test

    public class Test {
        public static void main(String[] args) {
            LydApplicationContext applicationContext = new LydApplicationContext(AppConfig.class);
    //        UserService userService = (UserService) applicationContext.getBean("userService");
            UserInterface userService = (UserInterface) applicationContext.getBean("userService");
    //        System.out.println(applicationContext.getBean("userService"));
    //        System.out.println(applicationContext.getBean("roleService"));
            userService.test();
        }
    }
    

ğŸ‘åˆ›ä½œä¸æ˜“ï¼Œå¦‚æœ‰é”™è¯¯è¯·æŒ‡æ­£ï¼Œæ„Ÿè°¢è§‚çœ‹ï¼è®°å¾—ç‚¹èµå“¦ï¼ğŸ‘