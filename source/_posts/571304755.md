---
layout: post
title: "å¦‚ä½•åœ¨ K8S é›†ç¾¤èŒƒå›´ä½¿ç”¨ imagePullSecretï¼Ÿ"
date: "2022-11-29T05:16:09.753Z"
---
å¦‚ä½•åœ¨ K8S é›†ç¾¤èŒƒå›´ä½¿ç”¨ imagePullSecretï¼Ÿ
===============================

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ imagePullSecretsã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå¦‚ä½•åœ¨ Kubernetes ä¸­ä½¿ç”¨ imagePullSecretsã€‚

imagePullSecrets ç®€ä»‹
-------------------

Kubernetes åœ¨æ¯ä¸ª Pod æˆ–æ¯ä¸ª Namespace çš„åŸºç¡€ä¸Šä½¿ç”¨ imagePullSecrets å¯¹ç§æœ‰å®¹å™¨æ³¨å†Œè¡¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªç§˜å¯†ä¸å‡­æ®ï¼š

{% note warning %}  
âš ï¸ **è­¦å‘Š**ï¼š

ç°åœ¨éšç€å…¬å…±é•œåƒä»“åº“ï¼ˆå¦‚ï¼šdocker.io ç­‰ï¼‰å¼€å§‹å¯¹åŒ¿åç”¨æˆ·è¿›è¡Œé™æµï¼Œé…ç½®å…¬å…±ä»“åº“çš„èº«ä»½è®¤è¯ä¹Ÿå˜å¾—æœ‰å¿…è¦ã€‚  
{% endnote %}

    kubectl create secret docker-registry image-pull-secret \
      -n <your-namespace> \
      --docker-server=<your-registry-server> \
      --docker-username=<your-name> \
      --docker-password=<your-password> \
      --docker-email=<your-email>
    

ä¾‹å¦‚é…ç½® docker.io çš„ pull secretï¼š

    kubectl create secret docker-registry image-pull-secret-src \
            -n imagepullsecret-patcher \
            --docker-server=docker.io \
            --docker-username=caseycui \
            --docker-password=c874d654-xxxx-40c6-xxxx-xxxxxxxx89c2 \
            --docker-email=cuikaidong@foxmail.com
    

{% note info %}  
â„¹ï¸ **ä¿¡æ¯**ï¼š

å¦‚æœ docker.io å¯ç”¨äº†ã€Œ2 é˜¶æ®µè®¤è¯ã€ï¼Œå¯èƒ½éœ€è¦åˆ›å»º Access Tokenï¼ˆå¯¹åº”ä¸Šé¢çš„ `docker-password`ï¼Œåˆ›å»ºé“¾æ¥åœ¨è¿™é‡Œï¼š[è´¦å· -> å®‰å…¨](https://hub.docker.com/settings/security)  
{% endnote %}

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ª pod ä¸­ä½¿ç”¨è¿™ä¸ª secret æ¥ä¸‹è½½ docker é•œåƒï¼š

    apiVersion: v1
    kind: Pod
    metadata:
      name: busybox
      namespace: private-registry-test
    spec:
      containers:
        - name: my-app
          image: my-private-registry.infra/busybox:v1
      imagePullSecrets:
        - name: image-pull-secret
    

å¦ä¸€ç§æ–¹æ³•æ˜¯å°†å®ƒæ·»åŠ åˆ°å‘½åç©ºé—´çš„é»˜è®¤ ServiceAccount ä¸­ï¼š

    kubectl patch serviceaccount default \
      -p "{\"imagePullSecrets\": [{\"name\": \"image-pull-secret\"}]}" \
      -n <your-namespace>
    

åœ¨ K8S é›†ç¾¤èŒƒå›´ä½¿ç”¨ imagePullSecrets
-----------------------------

æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªå«åš [`imagepullsecret-patch`](https://github.com/titansoft-pte-ltd/imagepullsecret-patcher) çš„å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ä½ æ‰€æœ‰çš„å‘½åç©ºé—´ä¸Šåšè¿™ä¸ªï¼š

    wget https://raw.githubusercontent.com/titansoft-pte-ltd/imagepullsecret-patcher/185aec934bd01fa9b6ade2c44624e5f2023e2784/deploy-example/kubernetes-manifest/1_rbac.yaml
    wget https://raw.githubusercontent.com/titansoft-pte-ltd/imagepullsecret-patcher/master/deploy-example/kubernetes-manifest/2_deployment.yaml
    
    kubectl create ns imagepullsecret-patcher
    

ç¼–è¾‘ä¸‹è½½çš„æ–‡ä»¶ï¼Œä¸€èˆ¬éœ€è¦ä¿®æ”¹`image-pull-secret-src`çš„å†…å®¹ï¼Œè¿™ä¸ª pull secret å°±ä¼šåº”ç”¨åˆ° K8S é›†ç¾¤èŒƒå›´ã€‚

    nano 1_rbac.yaml
    nano 2_deployment.yaml
    kubectl apply -f 1_rbac.yaml
    kubectl apply -f 2_deployment.yaml
    

è¿™é‡ŒèƒŒååˆ›å»ºçš„èµ„æºæœ‰ï¼š

1.  NameSpace
2.  RBAC æƒé™ç›¸å…³ï¼š
    1.  `imagepullsecret-patcher` ServiceAccount
    2.  `imagepullsecret-patcher` ClusterRoleï¼Œå…·æœ‰å¯¹ service account å’Œ secret çš„æ‰€æœ‰æƒé™
    3.  `imagepullsecret-patcher` ClusterRoleBindingï¼Œä¸º `imagepullsecret-patcher` ServiceAccount èµ‹äºˆ `imagepullsecret-patcher` ClusterRole çš„æƒé™ã€‚
3.  å…¨å±€ pull secret `image-pull-secret-src`ï¼Œé‡Œé¢æ˜¯ä½ çš„ K8S å…¨å±€åŒ…å«çš„æ‰€æœ‰çš„é•œåƒåº“åœ°å€å’Œè®¤è¯ä¿¡æ¯ã€‚
4.  Deployment `imagepullsecret-patcher`ï¼ŒæŒ‡å®š ServiceAccount æ˜¯ `imagepullsecret-patcher` å°±æœ‰äº†æ“ä½œ service account å’Œ secret çš„æ‰€æœ‰æƒé™ï¼Œå¹¶å°†ä¸Šé¢çš„ secret æŒ‚è½½åˆ° Deployment pod å†…ã€‚

å¯ä»¥åŒ…å«å¤šä¸ªé•œåƒåº“åœ°å€å’Œè®¤è¯ä¿¡æ¯ï¼Œå¦‚ï¼š

    {
        "auths": {
            "docker.io": {
                "username": "caseycui",
                "password": "c874xxxxxxxxxxxxxxxx1f89c2",
                "email": "cuikaidong@foxmail.com",
                "auth": "Y2FzxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxWMy"
            },
            "quay.io": {
                "auth": "ZWFzdxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxlXWmpNPQ==",
                "email": ""
            }
        }
    }
    

base64 ç¼–ç åå†™åˆ° secret çš„ `.dockerconfigjson` å­—æ®µå³å¯ï¼š

    apiVersion: v1
    kind: Secret
    metadata:
      name: image-pull-secret-src
      namespace: imagepullsecret-patcher
    data:
      .dockerconfigjson: >-
        eyJhdXRocyI6eyJkb2NrZXIuaW8iOnsidXNlcm5hbWUiOiJjYXNleWN1aSIsInB.............................................IiwiZW1haWwiOiIifX19
    type: kubernetes.io/dockerconfigjson
    

å¯åŠ¨åçš„ pod ä¼šåœ¨æ‰€æœ‰ NameSpace ä¸‹åˆ›å»º `image-pull-secret` secretï¼ˆå†…å®¹æ¥è‡ªäº`image-pull-secret-src`) å¹¶æŠŠå®ƒ patch åˆ° `default` service account åŠè¯¥ K8S é›†ç¾¤çš„æ‰€æœ‰ ServiceAccount é‡Œï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š

    time="2022-01-12T16:07:30Z" level=info msg="Application started"
    time="2022-01-12T16:07:30Z" level=info msg="[default] Created secret"
    time="2022-01-12T16:07:30Z" level=info msg="[default] Patched imagePullSecrets to service account [default]"
    time="2022-01-12T16:07:30Z" level=info msg="[kube-system] Created secret"
    time="2022-01-12T16:07:31Z" level=info msg="[kube-system] Patched imagePullSecrets to service account [node-controller]"
    ...
    time="2022-01-12T16:07:37Z" level=info msg="[kube-public] Created secret"
    time="2022-01-12T16:07:37Z" level=info msg="[kube-public] Patched imagePullSecrets to service account [default]"
    time="2022-01-12T16:07:38Z" level=info msg="[kube-node-lease] Created secret"
    time="2022-01-12T16:07:38Z" level=info msg="[kube-node-lease] Patched imagePullSecrets to service account [default]"
    time="2022-01-12T16:07:38Z" level=info msg="[prometheus] Created secret"
    time="2022-01-12T16:07:39Z" level=info msg="[prometheus] Patched imagePullSecrets to service account [default]"
    ...
    time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Created secret"
    time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Patched imagePullSecrets to service account [default]"
    time="2022-01-12T16:07:41Z" level=info msg="[imagepullsecret-patcher] Patched imagePullSecrets to service account [imagepullsecret-patcher]"
    

ä»Šåæˆ‘ä»¬åªéœ€è¦æ›´æ–° `image-pull-secret-src` è¿™ä¸€ä¸ªå³å¯äº†ã€‚ğŸ‘ï¸ğŸ‘ï¸ğŸ‘ï¸

Kyverno policy
--------------

[Kyverno](https://kyverno.io/) policy å¯ä»¥å®ç°åŒæ ·çš„æ•ˆæœ:

    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: sync-secret
    spec:
      background: false
      rules:
      - name: sync-image-pull-secret
        match:
          resources:
            kinds:
            - Namespace
        generate:
          kind: Secret
          name: image-pull-secret
          namespace: "{{request.object.metadata.name}}"
          synchronize: true
          clone:
            namespace: default
            name: image-pull-secret
    ---
    apiVersion: kyverno.io/v1
    kind: ClusterPolicy
    metadata:
      name: mutate-imagepullsecret
    spec:
      rules:
        - name: mutate-imagepullsecret
          match:
            resources:
              kinds:
              - Pod
          mutate:
            patchStrategicMerge:
              spec:
                imagePullSecrets:
                - name: image-pull-secret  ## imagePullSecret that you created with docker hub pro account
                (containers):
                - (image): "*" ## match all container images