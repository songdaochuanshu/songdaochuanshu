---
layout: post
title: "ä½¿ç”¨Prometheusç›‘æ§docker composeæ–¹å¼éƒ¨ç½²çš„ES"
date: "2023-01-06T13:21:57.125Z"
---
ä½¿ç”¨Prometheusç›‘æ§docker composeæ–¹å¼éƒ¨ç½²çš„ES
===================================

éœ€æ±‚
--

æ”¶é›† ES çš„æŒ‡æ ‡, å¹¶è¿›è¡Œå±•ç¤ºå’Œå‘Šè­¦;

ç°çŠ¶
--

1.  ES é€šè¿‡ docker compose å®‰è£…
2.  æ‰€åœ¨ç¯å¢ƒçš„ K8S é›†ç¾¤æœ‰ Prometheus å’Œ AlertManager åŠ Grafana

æ–¹æ¡ˆ
--

å¤ç”¨ç°æœ‰çš„ç›‘æ§ä½“ç³», é€šè¿‡: Prometheus ç›‘æ§ ES.

![Prometheus ç›‘æ§ ES æ¶æ„](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230106110930466-306781123.svg)

å…·ä½“å®ç°ä¸º:

### é‡‡é›†ç«¯ `elasticsearch_exporter`

å¯ä»¥ç›‘æ§çš„æŒ‡æ ‡ä¸º:

Name

Type

Cardinality

Help

elasticsearch\_breakers\_estimated\_size\_bytes

gauge

4

Estimated size in bytes of breaker

elasticsearch\_breakers\_limit\_size\_bytes

gauge

4

Limit size in bytes for breaker

elasticsearch\_breakers\_tripped

counter

4

tripped for breaker

elasticsearch\_cluster\_health\_active\_primary\_shards

gauge

1

The number of primary shards in your cluster. This is an aggregate total across all indices.

elasticsearch\_cluster\_health\_active\_shards

gauge

1

Aggregate total of all shards across all indices, which includes replica shards.

elasticsearch\_cluster\_health\_delayed\_unassigned\_shards

gauge

1

Shards delayed to reduce reallocation overhead

elasticsearch\_cluster\_health\_initializing\_shards

gauge

1

Count of shards that are being freshly created.

elasticsearch\_cluster\_health\_number\_of\_data\_nodes

gauge

1

Number of data nodes in the cluster.

elasticsearch\_cluster\_health\_number\_of\_in\_flight\_fetch

gauge

1

The number of ongoing shard info requests.

elasticsearch\_cluster\_health\_number\_of\_nodes

gauge

1

Number of nodes in the cluster.

...

> å¯ä»¥ç›´æ¥åœ¨ github ä¸Šæ‰¾åˆ°å®Œæ•´çš„

### å±•ç¤ºç«¯ åŸºäºGrafana

> ğŸ“šï¸ **Reference:**
> 
> [ElasticSearch dashboard for Grafana | Grafana Labs](https://grafana.com/grafana/dashboards/6483)

![Grafana ES ä»ªè¡¨æ¿](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230106110930703-1319186919.png)

### å‘Šè­¦æŒ‡æ ‡ åŸºäºprometheus alertmanager

> ğŸ“šï¸ **Reference:**
> 
> ElasticSearchï¼š[https://awesome-prometheus-alerts.grep.to/rules.html#elasticsearch-1](https://awesome-prometheus-alerts.grep.to/rules.html#elasticsearch-1)

![Prometheus ES Alert ç•Œé¢](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230106110930964-699854774.png)

å®æ–½æ­¥éª¤
----

> ä»¥ä¸‹ä¸ºæ‰‹åŠ¨å®æ–½æ­¥éª¤

### Docker Compose

    docker pull quay.io/prometheuscommunity/elasticsearch-exporter:v1.3.0
    

`docker-compose.yml` ç¤ºä¾‹:

> ğŸ¾ **Warning:**
> 
> exporter åœ¨æ¯æ¬¡åˆ®å‰Šæ—¶éƒ½ä¼šä» ElasticSearch é›†ç¾¤ä¸­è·å–ä¿¡æ¯ï¼Œå› æ­¤è¿‡çŸ­çš„åˆ®å‰Šé—´éš”ä¼šç»™ ES ä¸»èŠ‚ç‚¹å¸¦æ¥è´Ÿè½½ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä½¿ç”¨ `--es.all` å’Œ `--es.indices` è¿è¡Œæ—¶ã€‚æˆ‘ä»¬å»ºè®®ä½ æµ‹é‡è·å–`/_nodes/stats`å’Œ`/_all/_stats`å¯¹ä½ çš„ESé›†ç¾¤æ¥è¯´éœ€è¦å¤šé•¿æ—¶é—´ï¼Œä»¥ç¡®å®šä½ çš„åˆ®å‰Šé—´éš”æ˜¯å¦å¤ªçŸ­ã€‚

åŸ ES çš„ `docker-copmose.yml` ç¤ºä¾‹å¦‚ä¸‹:

    version: '3'
    services:
      elasticsearch:
        image: elasticsearch-plugins:6.8.18
        ...
        ports:
          - 9200:9200
          - 9300:9300
        restart: always
    
    

å¢åŠ äº† `elasticsearch_exporter` çš„yamlå¦‚ä¸‹:

    version: '3'
    services:
      elasticsearch:
        image: elasticsearch-plugins:6.8.18
        ...
        ports:
          - 9200:9200
          - 9300:9300
        restart: always
      elasticsearch_exporter:
          image: quay.io/prometheuscommunity/elasticsearch-exporter:v1.3.0
          command: 
          - '--es.uri=http://elasticsearch:9200'
          - '--es.all'
          - '--es.indices'
          - '--es.indices_settings'
          - '--es.indices_mappings'
          - '--es.shards'
          - '--es.snapshots'
          - '--es.timeout=30s'      
          restart: always
          ports:
          - "9114:9114"    
    

### Prometheus é…ç½®è°ƒæ•´

#### prometheus é…ç½®

Prometheus å¢åŠ é™æ€æŠ“å–é…ç½®:

    scrape_configs:
      - job_name: "es"
        static_configs:
          - targets: ["x.x.x.x:9114"]
    
    

**è¯´æ˜:**

x.x.x.x ä¸º ES Exporter IP, å› ä¸º ES Exporter é€šè¿‡ docker compose å’Œ ESéƒ¨ç½²åœ¨åŒä¸€å°æœºå™¨, æ‰€ä»¥è¿™ä¸ª IP ä¹Ÿæ˜¯ ES çš„IP.

#### Prometheus Rules

å¢åŠ  ES ç›¸å…³çš„ Prometheus Rules:

    groups:
      - name: elasticsearch
        rules:
          - record: elasticsearch_filesystem_data_used_percent
            expr: 100 * (elasticsearch_filesystem_data_size_bytes - elasticsearch_filesystem_data_free_bytes)
              / elasticsearch_filesystem_data_size_bytes
          - record: elasticsearch_filesystem_data_free_percent
            expr: 100 - elasticsearch_filesystem_data_used_percent
          - alert: ElasticsearchTooFewNodesRunning
            expr: elasticsearch_cluster_health_number_of_nodes < 3
            for: 0m
            labels:
              severity: critical
            annotations:
              description: "Missing node in Elasticsearch cluster\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
              summary: ElasticSearch running on less than 3 nodes(instance {{ $labels.instance }}, node {{$labels.node}})
          - alert: ElasticsearchDiskSpaceLow
            expr: elasticsearch_filesystem_data_free_percent < 20
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch disk space low (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "The disk usage is over 80%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchDiskOutOfSpace
            expr: elasticsearch_filesystem_data_free_percent < 10
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: Elasticsearch disk out of space (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "The disk usage is over 90%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchHeapUsageWarning
            expr: (elasticsearch_jvm_memory_used_bytes{area="heap"} / elasticsearch_jvm_memory_max_bytes{area="heap"}) * 100 > 80
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch Heap Usage warning (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "The heap usage is over 80%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchHeapUsageTooHigh
            expr: (elasticsearch_jvm_memory_used_bytes{area="heap"} / elasticsearch_jvm_memory_max_bytes{area="heap"}) * 100 > 90
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: Elasticsearch Heap Usage Too High (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "The heap usage is over 90%\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchClusterRed
            expr: elasticsearch_cluster_health_status{color="red"} == 1
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: Elasticsearch Cluster Red (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elastic Cluster Red status\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchClusterYellow
            expr: elasticsearch_cluster_health_status{color="yellow"} == 1
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch Cluster Yellow (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elastic Cluster Yellow status\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchHealthyDataNodes
            expr: elasticsearch_cluster_health_number_of_data_nodes < 3
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: Elasticsearch Healthy Data Nodes (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Missing data node in Elasticsearch cluster\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchRelocatingShards
            expr: elasticsearch_cluster_health_relocating_shards > 0
            for: 0m
            labels:
              severity: info
            annotations:
              summary: Elasticsearch relocating shards (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch is relocating shards\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchRelocatingShardsTooLong
            expr: elasticsearch_cluster_health_relocating_shards > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch relocating shards too long (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch has been relocating shards for 15min\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchInitializingShards
            expr: elasticsearch_cluster_health_initializing_shards > 0
            for: 0m
            labels:
              severity: info
            annotations:
              summary: Elasticsearch initializing shards (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch is initializing shards\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchInitializingShardsTooLong
            expr: elasticsearch_cluster_health_initializing_shards > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch initializing shards too long (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch has been initializing shards for 15 min\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchUnassignedShards
            expr: elasticsearch_cluster_health_unassigned_shards > 0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: Elasticsearch unassigned shards (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch has unassigned shards\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchPendingTasks
            expr: elasticsearch_cluster_health_number_of_pending_tasks > 0
            for: 15m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch pending tasks (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "Elasticsearch has pending tasks. Cluster works slowly.\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
          - alert: ElasticsearchNoNewDocuments
            expr: increase(elasticsearch_indices_docs{es_data_node="true"}[10m]) < 1
            for: 0m
            labels:
              severity: warning
            annotations:
              summary: Elasticsearch no new documents (instance {{ $labels.instance }}, node {{$labels.node}})
              description: "No new documents for 10 min!\n  VALUE = {{ $value }}\n  LABELS = {{ $labels }}"
    
    

å¹¶é‡å¯ç”Ÿæ•ˆ.

> ğŸ¾**Warning:**
> 
> *   `ElasticsearchTooFewNodesRunning` å‘Šè­¦çš„æ¡ä»¶æ˜¯ es é›†ç¾¤çš„node å°‘äº 3ä¸ª, å¯¹äºå•èŠ‚ç‚¹ ES ä¼šè¯¯æŠ¥, æ‰€ä»¥æŒ‰éœ€å¼€å¯ruleæˆ–æŒ‰éœ€å±è”½(slience).
> *   `ElasticsearchHealthyDataNodes` å‘Šè­¦åŒä¸Š.

### AlertManager å‘Šè­¦è§„åˆ™åŠæ”¶ä»¶äººé…ç½®

æŒ‰éœ€è°ƒæ•´, ç¤ºä¾‹å¦‚ä¸‹:

    'global':
      'smtp_smarthost': ''
      'smtp_from': ''
      'smtp_require_tls': false
      'resolve_timeout': '5m'
    'receivers':
      - 'name': 'es-email'
        'email_configs':
          - 'to': 'sfw@example.com,sdfwef@example.com'
            'send_resolved': true
    'route':
      'group_by':
        - 'job'
      'group_interval': '5m'
      'group_wait': '30s'
      'routes':
        - 'receiver': 'es-email'
          'match':
            'job': 'es'
    
    

å¹¶é‡å¯ç”Ÿæ•ˆ.

### Grafana é…ç½®

å¯¼å…¥ json æ ¼å¼çš„ Grafana Dashboard:

    {
        "__inputs": [],
        "__requires": [
            {
                "type": "grafana",
                "id": "grafana",
                "name": "Grafana",
                "version": "5.4.0"
            },
            {
                "type": "panel",
                "id": "graph",
                "name": "Graph",
                "version": "5.0.0"
            },
            {
                "type": "datasource",
                "id": "prometheus",
                "name": "Prometheus",
                "version": "5.0.0"
            },
            {
                "type": "panel",
                "id": "singlestat",
                "name": "Singlestat",
                "version": "5.0.0"
            }
        ],
    ...
    
    

> å¯ä»¥ç›´æ¥åœ¨ Grafana ä¸Šæ‰¾åˆ°å®Œæ•´çš„

ğŸ“šï¸ å‚è€ƒæ–‡æ¡£
--------

*   [prometheus-community/elasticsearch\_exporter: Elasticsearch stats exporter for Prometheus (github.com)](https://github.com/prometheus-community/elasticsearch_exporter#metrics)
*   [ElasticSearch dashboard for Grafana | Grafana Labs](https://grafana.com/grafana/dashboards/6483)
*   [Awesome Prometheus alerts | Collection of alerting rules (grep.to)](https://awesome-prometheus-alerts.grep.to/rules.html#elasticsearch-1)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.