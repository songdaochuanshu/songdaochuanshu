---
layout: post
title: "【面试普通人VS高手系列】说一说Mybatis里面的缓存机制"
date: "2022-05-09T12:35:06.082Z"
---
【面试普通人VS高手系列】说一说Mybatis里面的缓存机制
==============================

> 一个工作了 5年的程序员，在私信里面不断向我诉苦。
> 
> 他说，他用了Mybatis这么久，怎么滴也算是精通Mybatis了吧。
> 
> 结果竟然在Mybatis这个面试题上翻车了！ 真的好烦！
> 
> 好吧，我们今天来看看“Mybatis里面的缓存机制”，普通人和高手的回答。

普通人：
----

嗯。。。。。。。。。

高手：
---

这个问题，有点复杂，我打算从几个方面来说明。

首先，Mybatis里面设计了二级缓存来提升数据的检索效率，避免每次数据的访问都需要去查询数据库。

![image-20220411223435810](https://img2022.cnblogs.com/other/1666682/202205/1666682-20220509153403411-1749032341.png)

一级缓存，是SqlSession级别的缓存，也叫本地缓存，因为每个用户在执行查询的时候都需要使用SqlSession来执行，

为了避免每次都去查数据库，Mybatis把查询出来的数据保存到SqlSession的本地缓存中，后续的SQL如果命中缓存，就可以直接从本地缓存读取了。

如果想要实现跨SqlSession级别的缓存？那么一级缓存就无法实现了，因此在Mybatis里面引入了二级缓存，就是当多个用户

在查询数据的时候，只有有任何一个SqlSession拿到了数据就会放入到二级缓存里面，其他的SqlSession就可以从二级缓存加载数据。

每个一级缓存的具体实现原理是：

![image-20220411224117473](https://img2022.cnblogs.com/other/1666682/202205/1666682-20220509153403611-554783300.png)

在SqlSession 里面持有一个Executor，每个Executor中有一个LocalCache对象。

当用户发起查询的时候，Mybatis会根据执行语句在Local Cache里面查询，如果没命中，再去查询数据库并写入到LocalCache，否则直接返回。

所以，以及缓存的生命周期是SqlSessiion，而且在多个Sqlsession或者分布式环境下，可能会导致数据库写操作出现脏数据。

二级缓存的具体实现原理是：

![image-20220411224448255](https://img2022.cnblogs.com/other/1666682/202205/1666682-20220509153403785-1640315942.png)

使用CachingExecutor装饰了Executor，所以在进入一级缓存的查询流程之前，会先通过CachingExecutor进行二级缓存的查询。

开启二级缓存以后，会被多个SqlSession共享，所以它是一个全局缓存。因此它的查询流程是先查二级缓存，再查一级缓存，最后再查数据库。

另外，MyBatis 的二级缓存相对于一级缓存来说，实现了 SqlSession 之间缓存数据的共享，同时缓存粒度也能够到 namespace 级别，并且还可以通过 Cache 接口实现类不同的组合，对 Cache 的可控性也更强。

以上就是我对这个问题的理解。

总结
--

在实际业务场景中，多级缓存的设计思想，非常值得我们学习和借鉴。

所以我认为这个面试题很不错。

大家要牢记，学习底层技术的目的是为了提高技术思维能力和积累解决方案，为以后更高的职位做好铺垫。

本期的普通人VS高手面试系列就到这里结束了。

有任何不懂的技术面试题，欢迎随时私信我

![file](http://mic-blob-bucket.oss-cn-beijing.aliyuncs.com/27872_80EA2D67B63C48D8BD533FD1EA45EED9)

> 版权声明：本博客所有文章除特别声明外，均采用 CC BY-NC-SA 4.0 许可协议。转载请注明来自 `Mic带你学架构`！  
> 如果本篇文章对您有帮助，还请帮忙点个关注和赞，您的坚持是我不断创作的动力。欢迎关注「跟着Mic学架构」公众号公众号获取更多技术干货！

![](https://img2022.cnblogs.com/other/1666682/202205/1666682-20220509153404402-84253257.png)