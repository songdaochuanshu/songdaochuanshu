---
layout: post
title: "å¦‚ä½•ä½¿ç”¨ ArrayPool"
date: "2023-02-19T01:15:52.211Z"
---
å¦‚ä½•ä½¿ç”¨ ArrayPool
==============

å¦‚æœä¸åœçš„ new æ•°ç»„ï¼Œå¯èƒ½ä¼šé€ æˆ GC çš„å‹åŠ›ï¼Œå› æ­¤åœ¨ aspnetcore ä¸­æ¨èä½¿ç”¨ ArrayPool æ¥é‡ç”¨æ•°ç»„ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ArrayPoolã€‚

å¦‚æœä¸åœçš„ new æ•°ç»„ï¼Œå¯èƒ½ä¼šé€ æˆ GC çš„å‹åŠ›ï¼Œå› æ­¤åœ¨ aspnetcore ä¸­æ¨èä½¿ç”¨ ArrayPool æ¥é‡ç”¨æ•°ç»„ï¼Œæœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ ArrayPoolã€‚

ä½¿ç”¨ ArrayPool
------------

ArrayPool æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå…±äº«çš„æ•°ç»„æ± ï¼Œå¯ä»¥ç”¨æ¥é‡ç”¨æ•°ç»„ã€‚å®ƒå¯ä»¥ç”¨æ¥é¿å…é¢‘ç¹çš„åˆ†é…å’Œå›æ”¶æ•°ç»„ï¼Œä»è€Œå‡å°‘ GC çš„å‹åŠ›ã€‚

ArrayPool çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦è°ƒç”¨å®ƒçš„é™æ€æ–¹æ³• `Rent` å³å¯ã€‚`Rent` æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•°ç»„çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°ç»„çš„æœ€å°é•¿åº¦ã€‚å¦‚æœä½ ä¸çŸ¥é“æ•°ç»„çš„æœ€å°é•¿åº¦ï¼Œå¯ä»¥ä¼ é€’ä¸€ä¸ªé»˜è®¤å€¼ï¼Œæ¯”å¦‚ 16ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ ArrayPool çš„ C# ç¤ºä¾‹ï¼š

    using System;
    using System.Buffers;
    
    class Program
    {
        static void Main(string[] args)
        {
            // åˆ›å»ºä¸€ä¸ªæ•°ç»„æ± 
            var pool = ArrayPool<int>.Shared;
    
            // ä»æ± ä¸­è·å–ä¸€ä¸ªé•¿åº¦ä¸º 10 çš„æ•°ç»„
            int[] array = pool.Rent(10);
            try
            {
                // åœ¨æ•°ç»„ä¸­å¡«å……ä¸€äº›æ•°æ®
                for (int i = 0; i < array.Length; i++)
                {
                    array[i] = i;
                }
    
                // ä½¿ç”¨æ•°ç»„ä¸­çš„æ•°æ®
                foreach (int i in array)
                {
                    Console.WriteLine(i);
                }
            }
            finally
            {
                // å°†æ•°ç»„å½’è¿˜åˆ°æ± ä¸­
                pool.Return(array);
            }
        }
    }
    

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡è°ƒç”¨ ArrayPool.Shared æ¥è·å–ä¸€ä¸ªæ•°ç»„æ± çš„å®ä¾‹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ pool.Rent(10) æ–¹æ³•ä»æ± ä¸­è·å–ä¸€ä¸ªé•¿åº¦ä¸º 10 çš„æ•´æ•°æ•°ç»„ã€‚åœ¨æ•°ç»„ä¸­å¡«å……æ•°æ®åï¼Œæˆ‘ä»¬éå†æ•°ç»„å¹¶è¾“å‡ºå…¶ä¸­çš„å…ƒç´ ã€‚æœ€åï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ pool.Return(array) æ–¹æ³•å°†æ•°ç»„å½’è¿˜åˆ°æ± ä¸­ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨å®Œæ•°ç»„åï¼Œå¿…é¡»å°†å…¶å½’è¿˜åˆ°æ± ä¸­ï¼Œå¦åˆ™è¯¥æ•°ç»„å°†ä¸€ç›´å ç”¨æ± ä¸­çš„å†…å­˜ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼ã€‚

ä½¿ç”¨åœºæ™¯
----

ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯åœ¨é«˜ååé‡çš„ç½‘ç»œåº”ç”¨ç¨‹åºä¸­ï¼Œä¾‹å¦‚ Web æœåŠ¡å™¨æˆ–æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨ä¸­ã€‚è¿™äº›æœåŠ¡å™¨éœ€è¦å¤„ç†å¤§é‡çš„ç½‘ç»œè¯·æ±‚æˆ–æ¶ˆæ¯ï¼Œè¿™äº›è¯·æ±‚æˆ–æ¶ˆæ¯å¯èƒ½æ¶‰åŠåˆ°å¤§é‡çš„å†…å­˜åˆ†é…å’Œé‡Šæ”¾ã€‚å¦‚æœåœ¨æ¯ä¸ªè¯·æ±‚æˆ–æ¶ˆæ¯å¤„ç†æœŸé—´éƒ½éœ€è¦åˆ†é…å’Œé‡Šæ”¾å†…å­˜ï¼Œé‚£ä¹ˆåƒåœ¾å›æ”¶å™¨å°†é¢ä¸´é‡å¤§çš„å‹åŠ›ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ã€‚

ä½¿ç”¨ ArrayPool å¯ä»¥é€šè¿‡æ± åŒ–å†…å­˜ç¼“è§£è¿™ç§æƒ…å†µã€‚è¿™æ ·ï¼Œå½“éœ€è¦åˆ†é…æ•°ç»„æ—¶ï¼Œå¯ä»¥ä»æ± ä¸­è·å–å¯ç”¨çš„æ•°ç»„è€Œä¸æ˜¯åˆ†é…æ–°çš„æ•°ç»„ï¼Œä»è€Œå‡å°‘åƒåœ¾å›æ”¶çš„å‹åŠ›ã€‚ä¸€æ—¦ä½¿ç”¨å®Œæ¯•ï¼Œå°†æ•°ç»„è¿”å›åˆ°æ± ä¸­ï¼Œä»¥ä¾¿å¯ä»¥é‡å¤ä½¿ç”¨ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ª HTTP æœåŠ¡å™¨å¯èƒ½éœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦è¯»å–å’Œå¤„ç†è¯·æ±‚æ­£æ–‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ ArrayPool æ¥æ± åŒ–å†…å­˜ï¼Œä»¥ä¾¿åœ¨æ¯ä¸ªè¯·æ±‚å¤„ç†æœŸé—´é‡å¤ä½¿ç”¨ç›¸åŒçš„ç¼“å†²åŒºã€‚è¿™å°†å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶çš„å¼€é”€ï¼Œä»è€Œæé«˜æœåŠ¡å™¨çš„æ€§èƒ½å’Œååé‡ã€‚

æ€»ç»“
--

ArrayPool æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªå…±äº«çš„æ•°ç»„æ± ï¼Œå¯ä»¥ç”¨æ¥é‡ç”¨æ•°ç»„ã€‚å®ƒå¯ä»¥ç”¨æ¥é¿å…é¢‘ç¹çš„åˆ†é…å’Œå›æ”¶æ•°ç»„ï¼Œä»è€Œå‡å°‘ GC çš„å‹åŠ›ã€‚

å‚è€ƒ
--

*   [ArrayPool](https://learn.microsoft.com/dotnet/api/system.buffers.arraypool-1?view=net-7.0&WT.mc_id=DX-MVP-5003606)1

æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœè§‰å¾—æœ¬æ–‡æœ‰ç”¨ï¼Œä¸å¦¨ç‚¹å‡»æ¨èğŸ¥°æˆ–è€…åœ¨è¯„è®ºåŒºç•™ä¸‹ Markï¼Œè®©æ›´å¤šçš„äººå¯ä»¥çœ‹åˆ°ã€‚

> æ¬¢è¿å…³æ³¨ä½œè€…çš„å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€ï¼Œè·å–æ›´å¤šæŠ€æœ¯å†…å®¹ã€‚ ![å…³æ³¨å¾®ä¿¡å…¬ä¼—å·â€œnewbeæŠ€æœ¯ä¸“æ â€](https://www.newbe.pro/images/weixin_public_qrcode.png)

*   æœ¬æ–‡ä½œè€…ï¼š [newbe36524](https://www.newbe.pro/)
*   æœ¬æ–‡é“¾æ¥ï¼š [https://www.newbe.pro/Others/0x01F-how-to-use-arraypool/](https://www.newbe.pro/Others/0x01F-how-to-use-arraypool/)
*   ç‰ˆæƒå£°æ˜ï¼š æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ BY-NC-SA è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼

* * *

1.  https://learn.microsoft.com/dotnet/api/system.buffers.arraypool-1?view=net-7.0&WT.mc\_id=DX-MVP-5003606â†©