---
layout: post
title: "è®°ä¸€æ¬¡ .NET æŸç‰©ç®¡åå°æœåŠ¡ å¡æ­»åˆ†æ"
date: "2022-06-27T03:51:13.074Z"
---
è®°ä¸€æ¬¡ .NET æŸç‰©ç®¡åå°æœåŠ¡ å¡æ­»åˆ†æ
=====================

ä¸€ï¼šèƒŒæ™¯
----

### 1\. è®²æ•…äº‹

è¿™å‡ ä¸ªæœˆç»å¸¸è¢«æœ‹å‹é—®ï¼Œä¸ºä»€ä¹ˆä¸æ›´æ–°è¿™ä¸ªç³»åˆ—äº†ï¼Œå“ˆå“ˆï¼Œç¡®å®åœäº†å¥½ä¹…ï¼Œä¸»è¦è¿˜æ˜¯æ‰“åŸºç¡€å»äº†ï¼Œåˆ†æ dump çš„èƒ½åŠ›ä¸åœ¨äºä¼šçµæ´»ä½¿ç”¨ windbgï¼Œè€Œæ˜¯å¯¹åº•å±‚çŸ¥è¯†æœ‰ä¸€ä¸ªæ·±åšçš„ç†è§£ï¼Œæ¯”å¦‚ï¼šæ±‡ç¼–ï¼ŒCï¼Œ C++ï¼ŒWin32 Apiï¼Œè™šæ‹Ÿå†…å­˜ï¼ŒWindows ç”¨æˆ·æ€å’Œå†…æ ¸æ€ï¼Œè¿™æ˜¯æˆ‘ä»Šå¹´çœ‹çš„ä¹¦ç»™å¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f9197e6df114cb2b676cbf2aea48113~tplv-k3u1fbpfcp-zoom-1.image)

å‰æ®µæ—¶å€™å¾®ä¿¡ä¸Šæœ‰ä½æœ‹å‹è¯´ä»–çš„ç¨‹åºå‡ºç°äº†å¡æ­»ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å·¥ä½œäº†ï¼Œå¬èµ·æ¥è¿˜æŒºå“äººçš„ï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/19922fea60a54c19aad34beb120c2457~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ä¸‹æ¥ç›´æ¥ä¸Š WinDbg åˆ†æå§ã€‚

äºŒï¼šWindbg åˆ†æ
-----------

### 1\. å¡æ­»åˆ†æ

æ—¢ç„¶è¯´ç¨‹åºæ‰€æœ‰çº¿ç¨‹éƒ½ä¸å·¥ä½œäº†ï¼Œå¤§æ¦‚ç‡åº”è¯¥æ˜¯æ­¤æ—¶ GC è§¦å‘äº†ï¼Œæ›¾ç»çœ‹è¿‡ä¸€ä¸ªdumpä¸­ GC åœ¨åˆ›å»º `background thread` æ—¶ï¼Œç”±äº `dllmain` çš„æ­»é”é€ æˆäº† `background thread` æ— æ³•ç”Ÿæˆå¼•å‘çš„æ­»é”é—®é¢˜ã€‚

æœ‰äº†è¿™ä¸ªæ€è·¯ï¼Œæ¥ä¸‹æ¥ç”¨ `~* k` çœ‹ä¸€ä¸‹æ‰€æœ‰çš„çº¿ç¨‹æ ˆï¼Œæ˜¯å¦æœ‰`GarbageCollectGeneration` å‡½æ•°ï¼Œå› ä¸ºå®ƒæ˜¯ GC è§¦å‘å…¥å£ç‚¹, æœç„¶ä¸å‡ºæ‰€æ–™ï¼Œ46å·çº¿ç¨‹è§¦å‘äº† GC æ“ä½œã€‚

    
      46  Id: 396c.3198 Suspend: 0 Teb: 00007ff6`22646000 Unfrozen
     # Child-SP          RetAddr               Call Site
    00 00000028`d420bc18 00007ffa`8b6b8b61     ntdll!NtWaitForSingleObject+0xa
    01 00000028`d420bc20 00007ffa`8b6b7124     ntdll!RtlpWaitOnCriticalSection+0xe1
    02 00000028`d420bcf0 00000001`8000a725     ntdll!RtlpEnterCriticalSectionContended+0xa4
    03 00000028`d420bd30 00000001`80011773     WiseVectorHelperOne_X64+0xa725
    04 00000028`d420bd90 00007ffa`888faf8f     WiseVectorHelperOne_X64+0x11773
    05 00000028`d420d2d0 00007ffa`79db4d45     KERNELBASE!ResumeThread+0xf
    06 00000028`d420d300 00007ffa`79db8bee     coreclr!Thread::ResumeThread+0x29 [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 466] 
    07 00000028`d420d350 00007ffa`79e13905     coreclr!ThreadSuspend::SuspendRuntime+0x17a [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 4046] 
    08 00000028`d420d420 00007ffa`79db61cf     coreclr!ThreadSuspend::SuspendEE+0x16d [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 6517] 
    09 (Inline Function) --------`--------     coreclr!GCToEEInterface::SuspendEE+0x21 [d:\a\_work\1\s\src\vm\gcenv.ee.cpp @ 25] 
    0a 00000028`d420d5c0 00007ffa`79e325be     coreclr!WKS::GCHeap::GarbageCollectGeneration+0xff [d:\a\_work\1\s\src\gc\gc.cpp @ 36545] 
    0b (Inline Function) --------`--------     coreclr!WKS::gc_heap::trigger_gc_for_alloc+0x12 [d:\a\_work\1\s\src\gc\gc.cpp @ 13832] 
    0c 00000028`d420d610 00007ffa`79e35118     coreclr!WKS::gc_heap::try_allocate_more_space+0x24e [d:\a\_work\1\s\src\gc\gc.cpp @ 13934] 
    0d (Inline Function) --------`--------     coreclr!WKS::gc_heap::allocate_more_space+0x11 [d:\a\_work\1\s\src\gc\gc.cpp @ 14369] 
    0e (Inline Function) --------`--------     coreclr!WKS::gc_heap::allocate+0x58 [d:\a\_work\1\s\src\gc\gc.cpp @ 14400] 
    0f 00000028`d420d690 00007ffa`79dcda8e     coreclr!WKS::GCHeap::Alloc+0x88 [d:\a\_work\1\s\src\gc\gc.cpp @ 35827] 
    
    

ä»çº¿ç¨‹æ ˆçœ‹ï¼Œæµç¨‹å¤§æ¦‚æ˜¯ï¼š C# åˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼Œè§¦å‘äº† GCï¼Œç„¶åæš‚åœäº†æ‰€æœ‰æ‰˜ç®¡çº¿ç¨‹ï¼Œç„¶ååˆæ¢å¤äº†å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ï¼Œåº”è¯¥æ˜¯æ­¤çº¿ç¨‹æ²¡æœ‰åœç•™åœ¨ gc å®‰å…¨ç‚¹ä¸Šï¼Œé‡å¯æ˜¯ä¸ºäº†è®©å®ƒåœ¨å®‰å…¨ç‚¹æš‚åœï¼Œåœ¨ coreclr æºç ä¸Šä¹Ÿèƒ½çœ‹çš„å‡ºæ¥ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/40f98071b637413aa1cf1ba496a75216~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ä¸‹æ¥å°±è¿›å…¥äº† `WiseVectorHelperOne_X64` ç±»åº“ ï¼Œå¾ˆé™Œç”Ÿçš„ä¸€ä¸ª dllï¼Œæœ€åè¿›å…¥äº† `ä¸´ç•ŒåŒº CriticalSection` ï¼Œæ‰€è°“çš„ `ä¸´ç•ŒåŒº` æ˜¯ä¸€ä¸ª win32 å‡½æ•°ï¼Œç”¨æ³•å’Œæˆ‘ä»¬çš„ lock å·®ä¸å¤šï¼Œæœ€åå°±åœç•™åœ¨ ä¸´ç•ŒåŒºï¼Œå…¶å®åˆ°è¿™é‡Œç°è±¡å°±å¾ˆæ˜æœ—äº†ï¼Œæ‰€æœ‰çš„æ‰˜ç®¡çº¿ç¨‹éƒ½æš‚åœäº†ï¼Œä¹Ÿç¬¦åˆæœ‹å‹è¯´çš„ç¨‹åºå¡æ­»ï¼Œæ¥ä¸‹æ¥å°±è¦åˆ†æä¸ºä»€ä¹ˆç¨‹åºé€€ä¸å‡º `ä¸´ç•ŒåŒº` ï¼Ÿ

### 2\. ä¸ºå•¥é€€ä¸å‡º CriticalSection

è¦æƒ³å¯»æ‰¾è¿™ä¸ªç­”æ¡ˆï¼Œå¯ä»¥ç”¨ `!locks` æ¥è§‚å¯Ÿå½“å‰å¤„äº `ä¸´ç•ŒåŒº` çš„çº¿ç¨‹ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š

    
    0:000> !locks
    
    CritSec +63218af0 at 0000002863218af0
    WaiterWoken        No
    LockCount          0
    RecursionCount     1
    OwningThread       3198
    EntryCount         0
    ContentionCount    16d
    *** Locked
    
    CritSec WiseVectorHelperOne_X64+6a9a8 at 000000018006a9a8
    WaiterWoken        No
    LockCount          1
    RecursionCount     1
    OwningThread       3090
    EntryCount         0
    ContentionCount    1
    *** Locked
    
    Scanned 64 critical sections
    
    

æ ¹æ®ç»éªŒï¼Œç¬¬ä¸€ååº”åº”è¯¥æ˜¯ `ä¸´ç•ŒåŒºæ­»é”` äº†ï¼Œç»éªŒå½’ç»éªŒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¾æ¬¡çœ‹ä¸‹ `3198` å’Œ `3090` å„è‡ªéƒ½åœ¨ç­‰ä»€ä¹ˆï¼Ÿ

### 3\. çœŸçš„æ˜¯ä¸´ç•ŒåŒºæ­»é”å—

é¦–å…ˆç”¨å‘½ä»¤åˆ‡åˆ° `3198` çº¿ç¨‹ï¼Œçœ‹çœ‹å®ƒæ­£åœ¨ç­‰å¾…ä»€ä¹ˆèµ„æºï¼Ÿ

    
    0:038>  ~~[3198]s
    ntdll!NtWaitForSingleObject+0xa:
    00007ffa`8b710c8a c3              ret
    0:046> kb
     # RetAddr               : Args to Child                                                           : Call Site
    00 00007ffa`8b6b8b61     : 00000001`8006a9a8 00000000`00000000 00000000`00000000 00000000`00000000 : ntdll!NtWaitForSingleObject+0xa
    01 00007ffa`8b6b7124     : 00000000`00000000 00000000`00000000 00000001`8006a9a8 00000000`00000000 : ntdll!RtlpWaitOnCriticalSection+0xe1
    02 00000001`8000a725     : 00000028`00668230 00000000`00000000 00000028`7fc9d9b0 00000028`00668230 : ntdll!RtlpEnterCriticalSectionContended+0xa4
    03 00000001`80011773     : 00000001`00000aa8 00000000`00000000 00000000`00000000 00000000`00000000 : WiseVectorHelperOne_X64+0xa725
    04 00007ffa`888faf8f     : 00000000`00000aa8 00000028`d420d308 00000000`00000000 00000000`00000000 : WiseVectorHelperOne_X64+0x11773
    05 00007ffa`79db4d45     : 00000000`00000000 00000000`00000000 00000028`04dec6e0 00000001`8000cc3a : KERNELBASE!ResumeThread+0xf
    06 00007ffa`79db8bee     : 00000028`00668230 00000000`00000040 00000000`00000001 00000000`00000000 : coreclr!Thread::ResumeThread+0x29 [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 466] 
    07 00007ffa`79e13905     : 00000000`00000003 00000000`00000001 00000000`00000001 00000000`00000000 : coreclr!ThreadSuspend::SuspendRuntime+0x17a [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 4046] 
    08 00007ffa`79db61cf     : 00000000`00001e73 00000000`00001e01 00000028`7f9f6698 00000000`00000000 : coreclr!ThreadSuspend::SuspendEE+0x16d [d:\a\_work\1\s\src\vm\threadsuspend.cpp @ 6517] 
    09 (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!GCToEEInterface::SuspendEE+0x21 [d:\a\_work\1\s\src\vm\gcenv.ee.cpp @ 25] 
    0a 00007ffa`79e325be     : a2098c12`cdff0000 00007ffa`79e35118 00007ffa`7a28c668 00000000`00000000 : coreclr!WKS::GCHeap::GarbageCollectGeneration+0xff [d:\a\_work\1\s\src\gc\gc.cpp @ 36545] 
    0b (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!WKS::gc_heap::trigger_gc_for_alloc+0x12 [d:\a\_work\1\s\src\gc\gc.cpp @ 13832] 
    0c 00007ffa`79e35118     : 00000028`7fc9da08 00000028`12bba6d8 00000000`00000002 00007ffa`79dbfc9f : coreclr!WKS::gc_heap::try_allocate_more_space+0x24e [d:\a\_work\1\s\src\gc\gc.cpp @ 13934] 
    0d (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!WKS::gc_heap::allocate_more_space+0x11 [d:\a\_work\1\s\src\gc\gc.cpp @ 14369] 
    0e (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!WKS::gc_heap::allocate+0x58 [d:\a\_work\1\s\src\gc\gc.cpp @ 14400] 
    0f 00007ffa`79dcda8e     : 00000000`00000000 00000028`d420daa0 00007ffa`1a908888 00000028`7fc9da08 : coreclr!WKS::GCHeap::Alloc+0x88 [d:\a\_work\1\s\src\gc\gc.cpp @ 35827] 
    10 (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!Alloc+0x18b [d:\a\_work\1\s\src\vm\gchelpers.cpp @ 240] 
    11 (Inline Function)     : --------`-------- --------`-------- --------`-------- --------`-------- : coreclr!AllocateObject+0x22d [d:\a\_work\1\s\src\vm\gchelpers.cpp @ 1209] 
    12 00007ffa`1b3337e2     : 00007ffa`1a908888 00000028`84d75cc0 00000028`12bb9ce0 00000028`64df1360 : coreclr!JIT_New+0x31e [d:\a\_work\1\s\src\vm\jithelpers.cpp @ 2724] 
    ....
    
    

ä»è¾“å‡ºä¿¡æ¯çœ‹: `NtWaitForSingleObject` æ­£åœ¨ç­‰å¾… `000000018006a9a8` ä¸´ç•ŒåŒºèµ„æºï¼Œè€Œè¿™ä¸ªæ­£å¥½æ˜¯ `!locks` çš„ `3090` çº¿ç¨‹æŒæœ‰çš„èµ„æºï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/92a0ea81525f4f3d84aedc5cba600ccb~tplv-k3u1fbpfcp-zoom-1.image)

æ¥ä¸‹æ¥å†çœ‹ä¸‹ `3090` çº¿ç¨‹æ­£åœ¨å¹²ä»€ä¹ˆã€‚

    
    0:038> ~~[3090]s
    WiseVectorHelperOne_X64+0xcc3a:
    00000001`8000cc3a 4889442408      mov     qword ptr [rsp+8],rax ss:00000028`04dec6e8=0000000000000000
    0:038> k
     # Child-SP          RetAddr               Call Site
    00 00000028`04dec6e0 00000001`8000f1cb     WiseVectorHelperOne_X64+0xcc3a
    01 00000028`04dec710 00000001`8000a751     WiseVectorHelperOne_X64+0xf1cb
    02 00000028`04dec7a0 00000001`80011773     WiseVectorHelperOne_X64+0xa751
    03 00000028`04dec800 00007ffa`888faf8f     WiseVectorHelperOne_X64+0x11773
    04 00000028`04dedd40 00007ffa`79e19796     KERNELBASE!ResumeThread+0xf
    05 (Inline Function) --------`--------     coreclr!Thread::StartThread+0x15 [d:\a\_work\1\s\src\vm\threads.cpp @ 528] 
    06 00000028`04dedd70 00007ffa`79eaacea     coreclr!ThreadNative::StartInner+0x35a [d:\a\_work\1\s\src\vm\comsynchronizable.cpp @ 501] 
    07 00000028`04dee010 00007ffa`1b3afc02     coreclr!ThreadNative::Start+0x8a [d:\a\_work\1\s\src\vm\comsynchronizable.cpp @ 387] 
    08 00000028`04dee160 00007ffa`1b3cb018     System_Private_CoreLib!System.Threading.Tasks.Task.ScheduleAndStart+0x102
    09 00000028`04dee1b0 00007ffa`1b40005a     System_Private_CoreLib!System.Threading.Tasks.Task.InternalStartNew+0x78
    0a 00000028`04dee230 00007ffa`1b41f181     System_Private_CoreLib!System.Threading.Tasks.TaskFactory.StartNew+0x5a
    ...
    
    

ä»çº¿ç¨‹æ ˆä¿¡æ¯çœ‹ï¼Œæ‰˜ç®¡å±‚æ‰§è¡Œäº†ä¸€ä¸ª `Task.Start` æ“ä½œï¼Œç„¶åé€šè¿‡ Win32 Api ç”Ÿæˆäº†ä¸€ä¸ª OS çº¿ç¨‹ï¼Œåœ¨å‡†å¤‡è°ƒåº¦ `OSçº¿ç¨‹` çš„æ—¶å€™ï¼Œé‡ä¸Šäº† `WiseVectorHelperOne_X64` ï¼Œæœ€åå°±åœ¨è¿™é‡Œæ— é™æœŸç­‰å¾…ï¼Œtmdçš„çœŸå¥‡æ€ªï¼Œåœ¨ä¸¤ä¸ªçº¿ç¨‹ä¸­éƒ½çœ‹åˆ°äº†è¿™ä¸ªå‡½æ•°ï¼Œå®ƒåˆ°åº•æ˜¯å¹²å˜›å‘¢ï¼Ÿ

### 4\. ç ”ç©¶ WiseVectorHelperOne\_X64

è¿™ä¸ªå¥‡æ€ªçš„ dllï¼Œçœ‹æ ·å­æ¥è€…ä¸å–„ï¼Œä¸Š baidu æŸ¥æŸ¥çœ‹ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2a7f0bb658884a4587bac49195b1380c~tplv-k3u1fbpfcp-zoom-1.image)

æˆ‘å»ï¼ŒåŸæ¥è¢«ä¸€æ¬¾å«åš `æ™ºé‡æ€æ¯’è½¯ä»¶` ç»™åŠ«æŒäº†ã€‚ã€‚ã€‚ å…·ä½“ä»€ä¹ˆåŸå› è¢«åŠ«æŒï¼Œæˆ‘ä¹Ÿä¸æƒ³ç ”ç©¶äº†ï¼Œç„¶åæ‹¿è¿™ä¸ªç»“æœå’Œæœ‹å‹åšäº†ä¸€ä¸‹æ²Ÿé€šï¼Œå°è¯•åœæ‰å®ƒçœ‹çœ‹ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f21d164267842d4a54957eb83adef90~tplv-k3u1fbpfcp-zoom-1.image)

ä¸‰ï¼šæ€»ç»“
----

ç»¼åˆä¸¤å¤„çº¿ç¨‹æ ˆçš„ç‰¹å¾ï¼Œå‘ç°éƒ½æ˜¯Win32 Api åœ¨åš `Thread::ResumeThread` æ—¶è¢«æ€æ¯’è½¯ä»¶åŠ«æŒï¼Œä¸€èˆ¬æ¥è¯´ clr åœ¨å†…éƒ¨ç”Ÿæˆ OS çº¿ç¨‹æ—¶ï¼Œä¼šå…ˆ `Suspended`ï¼Œç„¶åå† `Resume`ï¼Œå‚è€ƒæºç ï¼š

    
    BOOL Thread::CreateNewOSThread(SIZE_T sizeToCommitOrReserve, LPTHREAD_START_ROUTINE start, void* args)
    {
        HANDLE h = NULL;
        DWORD dwCreationFlags = CREATE_SUSPENDED;
    
        dwCreationFlags |= STACK_SIZE_PARAM_IS_A_RESERVATION;
    
        h = ::CreateThread(NULL     /*=SECURITY_ATTRIBUTES*/,
    
                                 sizeToCommitOrReserve,
                                 start,
                                 args,
                                 dwCreationFlags,
                                 &ourId);
    }
    
    

åŠ«æŒçš„åŸå› ï¼Œè¿™ä¸ªåªèƒ½é—®å‚å®¶äº†ï¼Œæˆ‘ä»¬èƒ½åšçš„å°±æ˜¯åœæ‰å®ƒ ğŸ˜„ï¼Œæœ€åæœ‹å‹å¤ªå®¢æ°”äº†ï¼Œå‘äº†ä¸€ä¸ªå¤§çº¢åŒ…ğŸ˜ğŸ˜ğŸ˜

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)