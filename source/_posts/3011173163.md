---
layout: post
title: "Java åŒæ­¥é”ReentrantLockä¸æŠ½è±¡åŒæ­¥é˜Ÿåˆ—AQS"
date: "2022-11-15T04:26:41.003Z"
---
Java åŒæ­¥é”ReentrantLockä¸æŠ½è±¡åŒæ­¥é˜Ÿåˆ—AQS
===============================

AbstractQueuedSynchronizer æŠ½è±¡åŒæ­¥é˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸ªæ¨¡æ¿ç±»æä¾›äº†è®¸å¤šä»¥é”ç›¸å…³çš„æ“ä½œï¼Œå¸¸è¯´çš„AQSæŒ‡çš„å°±æ˜¯å®ƒã€‚AQSç»§æ‰¿äº†`AbstractOwnableSynchronizer`ç±»ï¼ŒAOSç”¨äºä¿å­˜çº¿ç¨‹å¯¹è±¡ï¼Œä¿å­˜ä»€ä¹ˆçº¿ç¨‹å¯¹è±¡å‘¢ï¼Ÿ**ä¿å­˜é”è¢«ç‹¬å çš„çº¿ç¨‹å¯¹è±¡**ã€‚

æŠ½è±¡åŒæ­¥é˜Ÿåˆ—AQSé™¤äº†å®ç°åºåˆ—åŒ–æ ‡è®°æ¥å£ï¼Œå¹¶æ²¡æœ‰å®ç°ä»»ä½•çš„åŒæ­¥æ¥å£ï¼Œè¯¥ç±»æä¾›äº†è®¸å¤šåŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•ç»™è‡ªå®šä¹‰åŒæ­¥å™¨ä½¿ç”¨ï¼Œå¦‚ReentrantLockçš„å†…éƒ¨ç±»Syncã€‚æŠ½è±¡åŒæ­¥é˜Ÿåˆ—æ”¯æŒç‹¬å å¼æˆ–å…±äº«å¼çš„çš„è·å–åŒæ­¥çŠ¶æ€ï¼Œæ–¹ä¾¿å®ç°ä¸åŒç±»å‹çš„è‡ªå®šä¹‰åŒæ­¥å™¨ã€‚ä¸€èˆ¬æ–¹æ³•åå¸¦æœ‰`Shared`çš„ä¸ºå…±äº«å¼ï¼Œæ¯”å¦‚ï¼Œå°è¯•ä»¥å…±äº«å¼çš„è·å–é”çš„æ–¹æ³•`intÂ tryAcquireShared(int)`ï¼Œè€Œç‹¬å å¼è·å–é”æ–¹æ³•ä¸º`booleanÂ tryAcquire(int)`ã€‚

AQSæ˜¯æŠ½è±¡åŒæ­¥é˜Ÿåˆ—ï¼Œå…¶é‡ç‚¹å°±æ˜¯`åŒæ­¥é˜Ÿåˆ—`åŠ`å¦‚ä½•æ“ä½œåŒæ­¥é˜Ÿåˆ—`ã€‚

åŒæ­¥é˜Ÿåˆ—
----

åŒå‘åŒæ­¥é˜Ÿåˆ—ï¼Œé‡‡ç”¨å°¾æ’æ³•æ–°å¢èŠ‚ç‚¹ï¼Œä»å¤´éƒ¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è·å–æ“ä½œèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è‡ªæ—‹è·å–åŒæ­¥é”ï¼Œå®ç°FIFOï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰åŸåˆ™ã€‚

![image](https://img2022.cnblogs.com/blog/1209017/202211/1209017-20221115072503716-205056186.png)

ç†è§£èŠ‚ç‚¹ä¸­çš„å±æ€§å€¼ä½œç”¨

*   prevï¼šå‰é©±èŠ‚ç‚¹ï¼›å³å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹æ‰€ä»¥å«å‰é©±èŠ‚ç‚¹ï¼Œæ˜¯å› ä¸ºå‰ä¸€ä¸ªèŠ‚ç‚¹åœ¨ä½¿ç”¨å®Œé”ä¹‹åä¼šè§£é™¤åä¸€ä¸ªèŠ‚ç‚¹çš„é˜»å¡çŠ¶æ€ï¼›
    
*   nextï¼šåç»§èŠ‚ç‚¹ï¼›å³å½“å‰èŠ‚ç‚¹çš„åä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹‹æ‰€ä»¥å«åç»§èŠ‚ç‚¹ï¼Œæ˜¯å› ä¸ºâ€œåç»§æœ‰äººâ€äº†ï¼Œè¡¨ç¤ºæœ‰â€œä¸‹ä¸€ä»£â€èŠ‚ç‚¹æ‰¿æ¥è¿™ä¸ªç‹¬æœ‰çš„é”ğŸ”’ï¼›
    
*   nextWaiterï¼šè¡¨ç¤ºæŒ‡å‘ä¸‹ä¸€ä¸ª`Node.CONDITION`çŠ¶æ€çš„èŠ‚ç‚¹ï¼ˆæœ¬æ–‡ä¸è®²è¿°Conditioné˜Ÿåˆ—ï¼Œåœ¨æ­¤å¯ä»¥å¿½ç•¥å®ƒï¼‰ï¼›
    
*   threadï¼šèŠ‚ç‚¹å¯¹è±¡ä¸­ä¿å­˜çš„çº¿ç¨‹å¯¹è±¡ï¼ŒèŠ‚ç‚¹éƒ½æ˜¯é…è§’ï¼Œçº¿ç¨‹æ‰æ˜¯ä¸»è§’ï¼›
    
*   waitStatusï¼šå½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çŠ¶æ€ï¼›waitStatus = CANCELLED = 1ï¼Œè¡¨ç¤ºçº¿ç¨‹**å·²ç»å–æ¶ˆ**ï¼ˆè¯¥çŠ¶æ€ä¸‹çš„èŠ‚ç‚¹ä¸ºä½œåºŸèŠ‚ç‚¹ï¼Œå°†ä»é˜Ÿåˆ—ä¸­æ–­å¼€ï¼‰ï¼›
    
    *   waitStatus = SIGNAL = -1ï¼Œè¡¨ç¤ºçº¿ç¨‹å¤„äº**è¯·æ±‚é‡Šæ”¾**çš„çŠ¶æ€ï¼Œåç»§çº¿ç¨‹**éœ€è¦é˜»å¡ç­‰å¾…**ï¼ˆè¯¥çŠ¶æ€ä¸‹çš„èŠ‚ç‚¹çº¿ç¨‹å¤„äºé˜»å¡ç­‰å¾…çŠ¶æ€æˆ–è·å–é”æœªé‡Šæ”¾çŠ¶æ€ï¼‰ï¼›
        
    *   waitStatus = CONDITION = -2ï¼Œè¡¨ç¤ºçº¿ç¨‹**æ­£åœ¨ç­‰å¾…**ï¼›
        
    *   waitStatus = PROPAGATE = -3ï¼Œåœ¨å…±äº«æƒ…å†µä¸‹ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªè¢«è¯·æ±‚çš„sharedåº”è¯¥æ— æ¡ä»¶ä¼ æ’­ï¼›
        
    *   waitStatus = 0ï¼Œè¡¨ç¤ºèŠ‚ç‚¹åˆå§‹åŒ–æ—¶çš„é»˜è®¤å€¼ï¼ˆintç±»å‹æˆå‘˜å˜é‡çš„é»˜è®¤å€¼ï¼‰ã€‚
        
    

æ³¨æ„1ï¼šèŠ‚ç‚¹å¯¹è±¡ä¸­çš„prevã€nextå’ŒnextWaiteréƒ½æ˜¯ä¸€ä¸ª**å®Œæ•´çš„NodeèŠ‚ç‚¹å¯¹è±¡**ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜äº†å‰åèŠ‚ç‚¹çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä¸ºnullã€‚

æ³¨æ„2ï¼š**headèŠ‚ç‚¹æ˜¯ä¸ªè™šèŠ‚ç‚¹**ï¼ˆprev=nullã€thread=nullï¼‰ï¼Œä½†headæœ¬èº«æ˜¯ä¸€ä¸ªå®é™…å­˜åœ¨çš„èŠ‚ç‚¹å¯¹è±¡ï¼Œèµ·åˆ°æ ‡è®°é˜Ÿåˆ—çš„å¼€å¤´ï¼›å°¾èŠ‚ç‚¹tailèŠ‚ç‚¹çš„next=nullï¼Œç­‰å¾…æ–°èŠ‚ç‚¹æ’å…¥ã€‚

### å¤´èŠ‚ç‚¹headä¸ºä»€ä¹ˆæ˜¯è™šèŠ‚ç‚¹

**é‡ç‚¹**ï¼š**å¿…é¡»æ˜ç¡®çŸ¥é“å¤´èŠ‚ç‚¹headä¸ºä»€ä¹ˆæ˜¯è™šèŠ‚ç‚¹**!!!è¿™å¾ˆé‡è¦ã€‚

åŸå› æ˜¯ï¼Œå½“å‰èŠ‚ç‚¹åœ¨è·å–åˆ°é”ğŸ”’ä¹‹åï¼Œå®ƒè¿™ä¸ªçº¿ç¨‹å¯¹è±¡å°±ä¼šè¢«ä¿å­˜åˆ°AOSï¼ˆAbstractOwnableSynchronizerï¼‰ä¸­çš„`exclusiveOwnerThread` å¯¹è±¡ï¼Œï¼ˆä¸€å¼€å¤´å°±æåˆ°è¿‡äº†ï¼Œåœ¨è¿™é‡Œå†å¼ºè°ƒä¸€æ¬¡ï¼‰ï¼Œæ‰€ä»¥åœ¨é˜Ÿåˆ—ä¸­ï¼Œå¤´èŠ‚ç‚¹æ˜¯æ— éœ€å­˜å‚¨Threadå¯¹è±¡çš„äº†ã€‚é‚£ä¸ºä»€ä¹ˆè®¾è®¡æˆè¿™æ ·å‘¢ï¼Ÿå› ä¸ºå­˜åœ¨ä¸´ç•Œæƒ…å†µå°±æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”èµ„æºæ—¶ï¼Œæ— éœ€åˆå§‹åŒ–ç”ŸæˆåŒæ­¥é˜Ÿåˆ—ï¼Œç›´æ¥è·å–åŒæ­¥é”å³å¯ã€‚åªæœ‰å­˜åœ¨é”æœªé‡Šæ”¾åŒæ—¶åˆè¿›æ¥äº†æ–°çš„çº¿ç¨‹æ—¶ï¼Œæ‰ä¼šå»åˆå§‹åŒ–åŒæ­¥é˜Ÿåˆ—ï¼Œå¹¶ä¸ºæœªé‡Šæ”¾é”çš„çº¿ç¨‹å ä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯å¤´èŠ‚ç‚¹headï¼Œè¡¨æ˜å‰é¢è¿˜æœ‰ä¸ªçº¿ç¨‹åœ¨ä½¿ç”¨èµ„æºã€‚

    // åˆå§‹åŒ–é˜Ÿåˆ—çš„æ–¹æ³•private Node enq(final Node node) {
        // æ­»å¾ªç¯
        for (;;) {
            Node t = tail;
            // æ²¡å¤´æ²¡å°¾æ—¶
            if (t == null) { // Must initialize
                // ç”Ÿæˆå¤´èŠ‚ç‚¹ï¼ˆå°¾èŠ‚ç‚¹ï¼‰
                if (compareAndSetHead(new Node()))
                    tail = head;
            } else {
                // æœ‰å¤´æœ‰å°¾åï¼Œæ‰æŠŠéœ€è¦ç­‰å¾…çš„çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ä¸­
                node.prev = t;
                if (compareAndSetTail(t, node)) {
                    t.next = node;
                    return t;
                }
            }
        }
    }
    

åœ¨ç‹¬å çº¿ç¨‹é‡Šæ”¾é”æ—¶ï¼Œåˆ¤æ–­headæ˜¯å¦ä¸ºnullï¼Œå³å¯çŸ¥é“åŒæ­¥é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœåŒæ­¥é˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæ— éœ€æ‰§è¡Œå°è¯•å”¤é†’åç»§èŠ‚ç‚¹é‚£äº›æ“ä½œäº†ã€‚

åœ¨åŒä¸ªæ—¶é—´èŠ‚ç‚¹ä¸­ï¼Œå•ä¸ªçº¿ç¨‹åªéœ€è¦æ“ä½œAOSçš„Threadå¯¹è±¡å’ŒAQSçš„stateçŠ¶æ€å³å¯å®ç°åŒæ­¥é”å’Œé”çš„å¯é‡å…¥æ€§ã€‚

çº¿ç¨‹åŠ å…¥åŒæ­¥é˜Ÿåˆ—çš„è¿‡ç¨‹
-----------

åœ¨é”è¢«å ç”¨æ—¶ï¼Œè·å–é”å¤±è´¥åï¼Œå½“å‰çº¿ç¨‹è¢«å°è£…æˆNodeèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€‚

å³`tryAcquire(arg)`è¿”å›falseæ—¶ï¼Œ

æ‰§è¡Œ`acquireQueued(addWaiter(Node.EXCLUSIVE), arg))`æ“ä½œï¼Œ

è€Œ`addWaiter(Node.EXCLUSIVE)` ä¸ºæ–°å¢èŠ‚ç‚¹åˆ°åŒæ­¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—æœªåˆå§‹åŒ–æ—¶ä¼šæ‰§è¡Œenqå®Œæˆåˆå§‹åŒ–åå†æ–°å¢èŠ‚ç‚¹åˆ°é˜Ÿåˆ—ã€‚

å› æ­¤ï¼Œæ–°å¢èŠ‚ç‚¹åˆ†ä¸ºé¦–æ¬¡ç”ŸæˆåŒæ­¥é˜Ÿåˆ—åŒæ—¶æ–°å¢èŠ‚ç‚¹å’Œåœ¨åŸæœ‰åŒæ­¥é˜Ÿåˆ—ä¸­æ’å…¥æ–°å¢èŠ‚ç‚¹ã€‚

é¦–æ¬¡ç”ŸæˆåŒæ­¥é˜Ÿåˆ—æ–°å¢èŠ‚ç‚¹ï¼šé€šè¿‡`enq(final Node node)`æ–¹æ³•ï¼Œ**å…ˆåˆå§‹åŒ–å¤´èŠ‚ç‚¹ï¼ˆè™šèŠ‚ç‚¹ï¼‰**ï¼Œå†é€šè¿‡åŸå­æ“ä½œ`compareAndSetTail`æ–¹æ³•ä»é˜Ÿåˆ—å°¾éƒ¨æ’å…¥æ–°èŠ‚ç‚¹ã€‚

åœ¨åŸæœ‰åŒæ­¥é˜Ÿåˆ—ä¸­æ–°å¢èŠ‚ç‚¹ï¼šé€šè¿‡åŸå­æ“ä½œ`compareAndSetTail`æ–¹æ³•ä»é˜Ÿåˆ—å°¾éƒ¨æ’å…¥æ–°èŠ‚ç‚¹ã€‚

    public final void acquire(int arg) {
        if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }
    
    private Node addWaiter(Node mode) {
        // ä½¿ç”¨å½“å‰çº¿ç¨‹ç”Ÿæˆæ–°èŠ‚ç‚¹
        Node node = new Node(Thread.currentThread(), mode);
        // è·å–åŒæ­¥å™¨çš„å°¾èŠ‚ç‚¹
        Node pred = tail;
        if (pred != null) {
            // ç¬¬ä¸€æ­¥ï¼šæ–°èŠ‚ç‚¹çš„prevèŠ‚ç‚¹æŒ‡å‘å°¾éƒ¨èŠ‚ç‚¹ï¼ˆpred=tailï¼‰
            node.prev = pred;
            // ç¬¬äºŒéƒ¨ï¼šCASæ¯”è¾ƒå°¾èŠ‚ç‚¹ï¼Œç›¸ç­‰å°±è®©tail=node
            if (compareAndSetTail(pred, node)) {
                // ç¬¬ä¸‰æ­¥ï¼špred=æ—§çš„tailï¼Œå³æ—§çš„å°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹
                pred.next = node;
                return node;
            }
        }
        // å½“tail=null æ—¶æ‰§è¡Œï¼Œé€»è¾‘ç›¸ç±»ä¼¼çš„ï¼›enqåˆå§‹åŒ–çš„headèŠ‚ç‚¹ä¸ºè™šèŠ‚ç‚¹
        enq(node);
        return node;
    }
    
    // å°†èŠ‚ç‚¹æ’å…¥é˜Ÿåˆ—ï¼Œå¿…è¦æ—¶åˆå§‹åŒ–ï¼ˆå³tail=nullæ—¶ï¼Œä¹Ÿå³æ˜¯åŒæ­¥é˜Ÿåˆ—æ²¡æœ‰èŠ‚ç‚¹æ—¶åˆå§‹åŒ–ï¼‰ã€‚private Node enq(final Node node) {
        // æ­»å¾ªç¯
        for (;;) {
            // ç¬¬ä¸€æ¬¡è¿›æ¥tail=nullï¼Œç¬¬äºŒæ¬¡è¿›æ¥tail=head=new Node()
            Node t = tail;
            if (t == null) {
                // åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ä½œä¸ºheadèŠ‚ç‚¹
                if (compareAndSetHead(new Node()))
                    tail = head;
            } else { // ä¸‹é¢å°±æ˜¯æ­£å¸¸çš„å°¾æ’æ³•æ–°å¢èŠ‚ç‚¹
                node.prev = t;
                if (compareAndSetTail(t, node)) {
                    t.next = node;
                    return t;
                }
            }
        }
    }
    

é…åˆæºç å’ŒåŠ¨å›¾ç†è§£ï¼šæ–°å¢é˜Ÿåˆ—èŠ‚ç‚¹è¿‡ç¨‹ï¼ˆä¸‰éƒ¨æ›²ï¼‰

![image](https://img2022.cnblogs.com/blog/1209017/202211/1209017-20221115073030871-632841160.gif)

ä½¿ç”¨å°¾æ’æ³•æ–°å¢åŒæ­¥é˜Ÿåˆ—èŠ‚ç‚¹

*   ç¬¬ä¸€æ­¥ï¼šæ–°å¢èŠ‚ç‚¹çš„prevèŠ‚ç‚¹æŒ‡å‘å°¾èŠ‚ç‚¹tailï¼›
    
*   ç¬¬äºŒæ­¥ï¼šå°¾èŠ‚ç‚¹tail å’Œæ–°èŠ‚ç‚¹åšCASæ“ä½œï¼Œå³compareAndSetTail(pred,node) ,å³åŒæ­¥å™¨çš„tailèŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹ï¼›
    
*   ç¬¬ä¸‰æ­¥ï¼šæ—§çš„å°¾èŠ‚ç‚¹çš„nextèŠ‚ç‚¹æŒ‡å‘æ–°èŠ‚ç‚¹ï¼ˆæ­¤æ—¶çš„æ–°èŠ‚ç‚¹=å°¾èŠ‚ç‚¹tailï¼‰
    

æœ€ç»ˆç»“æœå›¾

![image](https://img2022.cnblogs.com/blog/1209017/202211/1209017-20221115073051387-898162037.png)

æ–°å¢èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ä¹‹åï¼Œåœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çº¿ç¨‹æ€ä¹ˆç­‰å¾…ï¼Ÿçº¿ç¨‹æ€ä¹ˆè·å–é”å‘¢ï¼Ÿ

èŠ‚ç‚¹çº¿ç¨‹è·å–é”
-------

çœ‹ä»£ç å‰å¿…é¡»æ˜ç¡®çŸ¥é“å“ªä¸ªèŠ‚ç‚¹æ˜¯è¦è·å–é”çš„ã€‚å¤´èŠ‚ç‚¹ä¸ºè™šèŠ‚ç‚¹ï¼Œæ ‡è®°é˜Ÿåˆ—çš„å¼€å¤´ï¼ŒçœŸæ­£è¦è·å–é”çš„æ˜¯å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚

### è·å–é”è¿‡ç¨‹

é”åœ¨é‡Šæ”¾æ—¶è°ƒç”¨çš„å…³é”®æµç¨‹ï¼š

ReentrantLock#lock() -> Sync#lock() -> AQS#acquire(1) -> NonfairSync#tryAcquire(1) ã€æˆ–FairSync#tryAcquire(1)ã€‘-> AQS#addWaiter(node) -> AQS#acquireQueued(node,1) -> AQS#selfInterrupt()

å…³é”®ä»£ç ğŸ‘‡

    // java.util.concurrent.locks.AbstractQueuedSynchronizer/**
     * ä»¥ç‹¬å ä¸å¯ä¸­æ–­æ¨¡å¼è·å–å·²åœ¨é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹ã€‚
     */final boolean acquireQueued(final Node node, int arg) {
        // å¼‚å¸¸æ ‡å¿—çŠ¶æ€
        boolean failed = true;
        try {
            // æ˜¯å¦å‘ç”Ÿè¿‡ä¸­æ–­çš„æ ‡å¿—
            boolean interrupted = false;
            // è‡ªæ—‹é”>>>æ­»å¾ªç¯ï¼šæ¯ä¸ªnodeéƒ½ç‹¬ç«‹æ‰§è¡Œç€è¿™ä¸ªæ­»å¾ªç¯ï¼Œç›´è‡³çº¿ç¨‹è¢«é˜»å¡
            for (;;) {
                // è·å–å‰é©±èŠ‚ç‚¹ï¼ˆå½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼‰
                final Node p = node.predecessor();
                // å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ç­‰äºå¤´èŠ‚ç‚¹ï¼ˆè™šèŠ‚ç‚¹ï¼‰ï¼Œç­‰äºå°±ä¼šæ‰§è¡Œå°è¯•è·å–é” tryAcquire(arg)
                if (p == head && tryAcquire(arg)) {
                    setHead(node); // è®¾ç½®å½“å‰èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œåœ¨è·å–é”æˆåŠŸæ—¶ï¼Œthreadå¯¹è±¡å·²ç»ä¿å­˜åˆ°AQSä¸­çš„exclusiveOwnerThreadäº†
                    p.next = null; // å‰é©±èŠ‚ç‚¹çš„nextæŒ‡å‘nullï¼Œæ–­å¼€å‰é©±èŠ‚ç‚¹ï¼ˆæ—§çš„å¤´èŠ‚ç‚¹ï¼‰
                    failed = false; // åªè¦å½“å‰èŠ‚ç‚¹nodeæ­£å¸¸è·å–åˆ°é”ï¼Œå°±ä¸ä¼šæ‰§è¡Œfinallyçš„cancelAcquire(node)
                    return interrupted;
                }
                // å‰é©±èŠ‚ç‚¹çš„waitStatus=-1æ—¶ï¼Œå½“å‰nodeä¼šè¢«é˜»å¡ï¼Œé˜²æ­¢æ— é™å¾ªç¯æµªè´¹èµ„æº
                if (shouldParkAfterFailedAcquire(p, node) &&
                    parkAndCheckInterrupt())
                    interrupted = true;
            }
        } finally {
            /* æ­£å¸¸æƒ…å†µï¼šåªæœ‰returnæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œfinallyä»£ç ï¼Œè€Œåªè¦returnï¼Œfailedéƒ½ç­‰äºfalseï¼Œ
             * æ‰€ä»¥ï¼Œfailed æ˜¯ä¸ºäº†é¿å…èŠ‚ç‚¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œnodeæ²¡æœ‰è¢«é‡Šæ”¾ã€‚
             * æ¯”å¦‚ï¼šnode.predecessor() å¯èƒ½äº§ç”Ÿç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚
             */
            if (failed)
                cancelAcquire(node);
        }
    }
    
    
    // java.util.concurrent.locks.AbstractQueuedSynchronizerprivate void setHead(Node node) {
        head = node;
        node.thread = null;
        node.prev = null;
    }
    

ä¸ºä»€ä¹ˆåœ¨å°è¯•è·å–é”å‰è¦åˆ¤æ–­å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Ÿ

å› ä¸ºé™¤äº†**é˜»å¡è¢«é‡Šæ”¾**ä¼šè®©æ­»å¾ªç¯ç»§ç»­æ‰§è¡Œçš„æƒ…å†µå¤–ï¼Œè¿˜æœ‰**ä¸­æ–­**æŒ‡ä»¤ä¹Ÿä¼šä½¿çº¿ç¨‹ä»é˜»å¡çŠ¶æ€ä¸­**è¢«é‡Šæ”¾**ï¼Œæ‰€ä»¥å­˜åœ¨ä»»æ„èŠ‚ç‚¹æå‰é‡æ–°æ‰§è¡Œâ€œæ­»å¾ªç¯â€å°è¯•è·å–é”çš„æƒ…å†µï¼Œå¦‚æœä¸åˆ¤æ–­è·å–é”èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¦ä¸ºå¤´èŠ‚ç‚¹ï¼Œé‚£å°±ä¼šå‡ºç°æå‰å°è¯•è·å–é”ï¼Œä»è€Œç ´åäº†åŒæ­¥é˜Ÿåˆ—çš„å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰åŸåˆ™ï¼Œè¯´ç™½äº†ï¼Œå°±æ˜¯è¢«æ’é˜Ÿäº†ã€‚

å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¤´èŠ‚ç‚¹æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹ä»£ç 

    // java.util.concurrent.locks.AbstractQueuedSynchronizer
    
    /**
     * æ£€æŸ¥å’Œæ›´æ–°è·å–é”å¤±è´¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ã€‚å¦‚æœçº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œåˆ™è¿”å›trueï¼Œä½¿å…¶æ‰§è¡Œé˜»å¡æ“ä½œã€‚
     */
    private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
        // è·å–å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€
        int ws = pred.waitStatus;
        if (ws == Node.SIGNAL)
            // å› ä¸ºå‰é©±èŠ‚ç‚¹å¤„äºè¯·æ±‚é‡Šæ”¾çš„çŠ¶æ€ï¼Œæ‰€ä»¥å½“å‰èŠ‚ç‚¹éœ€è¦é˜»å¡ç­‰å¾…ï¼Œä¼šè¿”å›trueï¼Œä»è€Œæ‰§è¡Œåç»­æ–¹æ³•è¿›å…¥é˜»å¡çŠ¶æ€
            return true;
        if (ws > 0) {
            // å‰é©±èŠ‚ç‚¹è¢«æ ‡ä¸Šå–æ¶ˆæ ‡å¿—äº†ï¼Œéœ€è¦è·³è¿‡å‰é©±èŠ‚ç‚¹å¹¶ä¸æ–­é‡è¯•
            do {
                // å¾ªç¯å‘å‰æŸ¥æ‰¾å–æ¶ˆèŠ‚ç‚¹ï¼ŒæŠŠå–æ¶ˆèŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­ç§»é™¤
                node.prev = pred = pred.prev;
            } while (pred.waitStatus > 0);
            pred.next = node;
        } else {
            /*
             * waitStatuså¿…é¡»ä¸º0æˆ–ç­‰äºPROPAGATE=-3
             * è¡¨ç¤ºéœ€è¦è®¾ç½®å‰é©±èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ºSIGNALï¼Œ
             * å°†ä¼šåœ¨å¤–å±‚å¾ªç¯å†æ¬¡å°è¯•è·å–é”ï¼Œå¦‚æœå†æ¬¡è·å–é”å¤±è´¥ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡å½“å‰çº¿ç¨‹
             */
            compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
        }
        return false;
    }
    

å½“`shouldParkAfterFailedAcquire(p, node)` è¿”å›trueæ—¶ï¼Œå°†ä¼šæ‰§è¡Œé˜»å¡æ“ä½œ`parkAndCheckInterrupt())`ï¼Œå…¶é€šè¿‡çº¿ç¨‹é˜»å¡å·¥å…·ç±»æ–¹æ³•`LockSupport.park(this)` æ¥é˜»å¡å½“å‰çº¿ç¨‹ã€‚

    private final boolean parkAndCheckInterrupt() {
        // é˜»å¡å½“å‰çº¿ç¨‹çº¿ç¨‹è°ƒåº¦
        LockSupport.park(this);
        // æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œå¹¶è¿”å›ä¸Šä¸€æ¬¡çš„ä¸­æ–­çŠ¶æ€
        return Thread.interrupted();
    }
    

æ³¨æ„ï¼š`LockSupport.park(this)` é˜»å¡åï¼Œéœ€è¦å”¤é†’é˜»å¡æ‰ä¼šæ‰§è¡Œåç»­æ“ä½œï¼Œå¯é€šè¿‡è§£é™¤é˜»å¡`LockSupport.unpark(thread)` æˆ– ä¸­æ–­`thread.interrupt()` æ¥å”¤é†’é˜»å¡ã€‚

åªæœ‰`shouldParkAfterFailedAcquire` å’Œ `parkAndCheckInterrupt`éƒ½è¿”å›trueæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œinterrupted = trueï¼Œå³åªæœ‰æ˜¯ä¸­æ–­å¯¼è‡´é˜»å¡ç»“æŸæ—¶ï¼Œæ‰è¿”å›trueï¼Œæ­¤æ—¶ `selfInterrupt()`é‡æ–°æ‰§è¡Œä¸€æ¬¡ä¸­æ–­æ“ä½œã€‚

    // java.util.concurrent.locks.AbstractQueuedSynchronizer
    final boolean acquireQueued(final Node node, int arg) {
        ......
        if (shouldParkAfterFailedAcquire(p, node) &&
                        parkAndCheckInterrupt())
                        // åªæœ‰æ˜¯ä¸­æ–­å¯¼è‡´é˜»å¡ç»“æŸæ—¶ï¼Œæ‰è¿”å›true
                        interrupted = true;
        ......
    }
    
    public final void acquire(int arg) {
        if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            // ä¸­æ–­å½“å‰çº¿ç¨‹
            selfInterrupt();
    }
    
    static void selfInterrupt() {
        // ä¸­æ–­å½“å‰çº¿ç¨‹
        Thread.currentThread().interrupt();
    }
    

### ä¸ºä»€ä¹ˆéœ€è¦å†ä¸€æ¬¡æ‰§è¡Œä¸­æ–­å‘¢ï¼Ÿ

å› ä¸ºå­˜åœ¨ä¸­æ–­`thread.interrupt()` å”¤é†’è‡ªæ—‹é”é˜»å¡çš„æƒ…å†µï¼Œè€Œ`Thread.interrupted()` è·å–ä¸­æ–­çŠ¶æ€å¹¶æ¸…é™¤å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ‰§è¡Œä¸€æ¬¡ä¸­æ–­æ“ä½œ`selfInterrupt()`ï¼Œå°†ä¸­æ–­æ ‡å¿—ç½®ä¸ºtrueã€‚

è¿™ç§è·å–é”çš„æ–¹å¼æ˜¯`éä¸­æ–­é”`ï¼Œå°±æ˜¯æ— æ³•é€šè¿‡ä¸­æ–­çš„æ–¹å¼**ç»“æŸ**é”çš„è·å–ï¼ŒåŒºåˆ«äº`ä¸­æ–­é”`ï¼Œæ‰€ä»¥è¯¥æ–¹å¼åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå¤„ç†ä¸­æ–­ï¼Œåªæ˜¯è®°å½•ä¸­æ–­çŠ¶æ€ï¼ŒThread.interrupted() è·å–ä¸­æ–­çŠ¶æ€åæ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®¾ç½®ä¸­æ–­æ ‡å¿—ä¸ºtrueã€‚

å¦‚æœä½ æƒ³è¦**å¤„ç†ä¸­æ–­çš„æƒ…å†µ**ï¼Œé‚£æˆ‘ä»¬å¯ä»¥åœ¨acquireQueued(addWaiter(Node.EXCLUSIVE), arg) è¿”å›true çš„æ—¶å€™å»å¤„ç†ã€‚æ¯”å¦‚ï¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚

å¦‚æœä½ éœ€è¦åœ¨**çº¿ç¨‹å‘ç”Ÿä¸­æ–­æ—¶ç»“æŸè·å–é”**ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä½¿ç”¨`lockInterruptibly()`æ¥è·å–é”ã€‚

### ä¸¤ç§æ–¹å¼è·å–é”çš„åŒºåˆ«

`lock()`æ–¹å¼è·å–é”ï¼šè‡ªæ—‹é”åªä¼šåœ¨æ­£å¸¸è·å–åˆ°é”æˆ–å‘ç”Ÿå¼‚å¸¸æ—¶ç»“æŸè‡ªæ—‹é”ï¼ˆæ­»å¾ªç¯ï¼‰ã€‚

`void lockInterruptibly()` æ–¹å¼è·å–é”ï¼šä¼šåœ¨å‘ç”Ÿä¸­æ–­çš„æƒ…å†µä¸‹ï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸`throw new InterruptedException();` ä»è€Œè·³å‡ºè‡ªæ—‹é”ï¼ˆæ­»å¾ªç¯ï¼‰ï¼Œè€Œè°ƒç”¨lockInterruptibly() çš„æ–¹æ³•éœ€è¦æ•è·ä¸­æ–­å¼‚å¸¸ï¼Œåšä¸€äº›å¼‚å¸¸å¤„ç†ã€‚

è·å–é”çš„`lock()`å’Œ`lockInterruptibly()`çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼š**ä¸­æ–­æ˜¯å¦ä¼šç»“æŸé”çš„è·å–**ã€‚

çœ‹çœ‹æºç æ€ä¹ˆå®ç°ä¸­æ–­ç»“æŸé”çš„è·å–

    private void doAcquireInterruptibly(int arg)
     throws InterruptedException {
     final Node node = addWaiter(Node.EXCLUSIVE);
     boolean failed = true;
     try {
      for (;;) {
       final Node p = node.predecessor();
       if (p == head && tryAcquire(arg)) {
        setHead(node);
        p.next = null; // help GC
        failed = false;
        return;
       }
       if (shouldParkAfterFailedAcquire(p, node) &&
        parkAndCheckInterrupt())
        // åªæœ‰æ˜¯ä¸­æ–­å¯¼è‡´é˜»å¡ç»“æŸæ—¶ï¼Œæ‰æŠ›å‡ºä¸­æ–­å¼‚å¸¸
        throw new InterruptedException();
      }
     } finally {
      if (failed)
       cancelAcquire(node);
     }
    }
    

ä¸­æ–­å¼‚å¸¸æŠ›å‡ºåï¼Œå°†ä¼šæ‰§è¡Œfinally ä»£ç å—ï¼Œå–æ¶ˆæ­£åœ¨è¿›è¡Œå°è¯•è·å–é”çš„èŠ‚ç‚¹ã€‚

åˆ°æ­¤ä¸ºæ­¢ï¼Œ**lock()è·å–é”çš„æ¦‚è¦è¿‡ç¨‹**ä¸º

> å…ˆå°è¯•è·å–é”ã€å¤±è´¥å°±å°†çº¿ç¨‹å°è£…æˆèŠ‚ç‚¹å¹¶åŠ å…¥åˆ°é˜Ÿåˆ—å°¾éƒ¨ã€è¿›å…¥è‡ªæ—‹é”ï¼ˆç¬¬ä¸€æ¬¡å°è¯•è·å–é”å¤±è´¥ï¼Œå°†å‰é©±èŠ‚ç‚¹çš„waitStatusæ”¹ä¸º-1ï¼›ç¬¬äºŒæ¬¡å°è¯•è·å–é”å¤±è´¥ï¼Œå› ä¸ºå‰é©±èŠ‚ç‚¹çš„waitStatus=-1ï¼Œæ‰€ä»¥æ‰§è¡Œé˜»å¡å½“å‰çº¿ç¨‹æ“ä½œé¿å…æ­»å¾ªç¯è€—è´¹èµ„æºï¼‰ã€ç­‰å¾…å¤´èŠ‚ç‚¹çº¿ç¨‹é‡Šæ”¾åŒæ­¥çŠ¶æ€ä¹‹åï¼Œå°†å‘èµ·è§£é™¤é˜»å¡æŒ‡ä»¤æˆ–é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­åï¼Œåç»§èŠ‚ç‚¹å†æ¬¡å°è¯•è·å–é”ã€‚

### å–æ¶ˆå¼‚å¸¸èŠ‚ç‚¹

å‰é¢æåˆ°ï¼Œåœ¨AQS#shouldParkAfterFailedAcquire(pred, node) ä¸­è°ˆåˆ°ï¼Œå½“èŠ‚ç‚¹waitStatus>0 æ—¶ï¼Œä¹Ÿå³æ˜¯å¯¹å¸¦æœ‰å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹è¿›è¡Œç§»é™¤ã€‚é‚£ä¹ˆèŠ‚ç‚¹åœ¨ä»€ä¹ˆæ—¶å€™è¢«æ”¹ä¸ºCANCELLED çš„å‘¢ï¼Ÿ

åœ¨AQS#acquireQueued(node, arg)ä¸­ï¼Œæ­£å¸¸è·å–åˆ°é”æ—¶ï¼Œfailedéƒ½ç­‰äºfalseï¼Œåªæœ‰å½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œfailed æ‰ç­‰äºtrueï¼Œä»è€Œæ‰§è¡Œåˆ°AQS#cancelAcquire(node)ã€‚ä¹Ÿå°±æ˜¯è¯´cancelAcquire() æ˜¯ç”¨äºå¤„ç†è·å–é”è¿‡ç¨‹ä¸­ï¼Œå¯¹å‘ç”Ÿå¼‚å¸¸èŠ‚ç‚¹çš„è¿›è¡Œç§»é™¤ã€‚

    final boolean acquireQueued(final Node node, int arg) {
        // æ˜¯å¦å‘ç”Ÿå¼‚å¸¸çš„æ ‡å¿—
        boolean failed = true;
        try {
            ......
            for (;;) {
                final Node p = node.predecessor();
                if (p == head && tryAcquire(arg)) {
                    ......
                    failed = false; // åªè¦å½“å‰èŠ‚ç‚¹nodeæ­£å¸¸è·å–åˆ°é”ï¼Œå°±ä¸ä¼šæ‰§è¡Œfinallyçš„cancelAcquire(node)
                    return interrupted;
                }
                ......
            }
        } finally {
            /* æ­£å¸¸æƒ…å†µï¼šåªæœ‰returnæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œfinallyä»£ç ï¼Œè€Œåªè¦returnï¼Œfailedéƒ½ç­‰äºfalseï¼Œ
             * æ‰€ä»¥ï¼Œfailed æ˜¯ä¸ºäº†é¿å…èŠ‚ç‚¹å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œnodeæ²¡æœ‰è¢«ç§»é™¤ã€‚
             */
            if (failed)
                cancelAcquire(node);
        }
    }
    

è¯¦ç»†çœ‹ä¸‹AQS#cancelAcquire(node) æ˜¯æ€ä¹ˆå¤„ç†çš„

    
    // java.util.concurrent.locks.AbstractQueuedSynchronizer
    /**
     * å–æ¶ˆæ­£åœ¨è¿›è¡Œå°è¯•è·å–é”çš„èŠ‚ç‚¹
     */
    private void cancelAcquire(Node node) {
        // å¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™å¿½ç•¥
        if (node == null)
            return;
        // ä½¿å½“å‰èŠ‚ç‚¹å˜æˆè™šèŠ‚ç‚¹
        node.thread = null;
    
        // è·³è¿‡å¸¦æœ‰â€œå–æ¶ˆçŠ¶æ€â€çš„å‰é©±èŠ‚ç‚¹
        Node pred = node.prev;
        while (pred.waitStatus > 0)
            node.prev = pred = pred.prev;
    
        // predNextèŠ‚ç‚¹
        Node predNext = pred.next;
    
        // ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„waitStatusä¸ºCANCELLED=1
        node.waitStatus = Node.CANCELLED;
    
        // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹tailï¼Œåˆ™åªéœ€è¦ç§»é™¤è‡ªå·±å³å¯ã€‚
        if (node == tail && compareAndSetTail(node, pred)) {
            // predèŠ‚ç‚¹å˜æˆäº†å°¾èŠ‚ç‚¹tailï¼Œæ‰€ä»¥ pred.next=null
            compareAndSetNext(pred, predNext, null);
        } else {
            int ws;
            /* å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¸ä¸ºå¤´èŠ‚ç‚¹ï¼Œåˆ™trueï¼›
             * å‰é©±èŠ‚ç‚¹çš„wsçŠ¶æ€ä¸ºSIGNALï¼Œåˆ™trueï¼›wsä¸ä¸ºSIGNALï¼Œä½†ws<=0æ—¶ï¼ˆå³ä¸æ˜¯å–æ¶ˆçŠ¶æ€ï¼‰ï¼Œåˆ™CASæ“ä½œæ”¹ä¸ºSIGNALï¼Œæ”¹æˆåŠŸåˆ™ä¸ºtrueï¼›
             * å‰é©±èŠ‚ç‚¹ä¸æ˜¯è™šæ¥ç‚¹ï¼Œåˆ™true
             */ 
            if (pred != head
                && ((ws = pred.waitStatus) == Node.SIGNAL || (ws <= 0 && compareAndSetWaitStatus(pred, ws, Node.SIGNAL)))
                && pred.thread != null) {
                /* å¦‚æœä¸Šè¿°éƒ½æ»¡è¶³ï¼Œåˆ™å°†â€œå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹â€æŒ‡å‘â€œå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹â€
                 * è¯´ç™½äº†ï¼ŒèŠ‚ç‚¹çš„nextæŒ‡å‘å°±æ˜¯ç”± A->B->C æ”¹ä¸º A->Cï¼›Bä¸ºå½“å‰èŠ‚ç‚¹ã€‚
                 * å…³äºèŠ‚ç‚¹çš„prevæŒ‡å‘å°±æ²¡æœ‰å˜ A<-B<-C è¿˜æ˜¯ A<-B<-Cï¼Œä¹Ÿå°±æ˜¯è¯´BèŠ‚ç‚¹è¿˜æ²¡çœŸæ­£æ–­å¼€ã€‚
                 * èŠ‚ç‚¹çš„prevæŒ‡å‘çš„ä¿®æ”¹éœ€è¦åˆ¤æ–­wsçŠ¶æ€æ˜¯å¦ä¸ºCANCELLEDåï¼Œæ‰åšä¿®æ”¹ã€‚
                 */
                Node next = node.next;
                if (next != null && next.waitStatus <= 0)
                    compareAndSetNext(pred, predNext, next);
            } else {
                // å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„é˜»å¡çº¿ç¨‹
                unparkSuccessor(node);
            }
            // å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æŒ‡å‘è‡ªå·±
            node.next = node;
        }
    }
    

ä»¥ä¸Šéƒ½æ˜¯å¯¹nextèŠ‚ç‚¹çš„æŒ‡å‘åšä¿®æ”¹ï¼Œå…³äºèŠ‚ç‚¹çš„prevæŒ‡å‘çš„ä¿®æ”¹éœ€è¦åˆ¤æ–­wsçŠ¶æ€æ˜¯å¦ä¸ºCANCELLEDåï¼Œæ‰åšä¿®æ”¹ï¼Œå¾ªç¯å‘å‰æŸ¥æ‰¾å–æ¶ˆèŠ‚ç‚¹ï¼ŒæŠŠå–æ¶ˆèŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­å‰”é™¤ã€‚å…¶å¯¹åº”æºç å¦‚ä¸‹

    private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
        // è·å–å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€
        int ws = pred.waitStatus;
            ......
        if (ws > 0) {
            // å‰é©±èŠ‚ç‚¹è¢«æ ‡ä¸Šå–æ¶ˆæ ‡å¿—äº†ï¼Œéœ€è¦è·³è¿‡å‰é©±èŠ‚ç‚¹å¹¶ä¸æ–­é‡è¯•
            do {
                // å¾ªç¯å‘å‰æŸ¥æ‰¾å–æ¶ˆèŠ‚ç‚¹ï¼ŒæŠŠå–æ¶ˆèŠ‚ç‚¹ä»é˜Ÿåˆ—ä¸­å‰”é™¤
                node.prev = pred = pred.prev;
            } while (pred.waitStatus > 0);
            pred.next = node;
        } else {
            ......
        }
        return false;
    }
    

åœ¨AQS#unparkSuccessor() é€šè¿‡çº¿ç¨‹é˜»å¡å·¥å…·ç±»æ–¹æ³•`LockSupport.unpark(thread)` æ¥å”¤é†’åç»§èŠ‚ç‚¹çš„é˜»å¡çº¿ç¨‹ã€‚`AQS#unparkSuccessor()` é™¤äº†**å–æ¶ˆå¼‚å¸¸èŠ‚ç‚¹**æ—¶ç”¨åˆ°å¤–ï¼Œè¿˜åœ¨**é”çš„é‡Šæ”¾**æ—¶è°ƒç”¨ï¼Œå®ç°åŠŸèƒ½éƒ½æ˜¯--å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„é˜»å¡çº¿ç¨‹ï¼Œåç»§èŠ‚ç‚¹å°±ä¼šç»§ç»­æ‰§è¡Œè‡ªæ—‹é”æ¥å°è¯•è·å–é”ã€‚

    // java.util.concurrent.locks.AbstractQueuedSynchronizer
    
    /**
     * å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„é˜»å¡çº¿ç¨‹(å¦‚æœå­˜åœ¨)
     */
    private void unparkSuccessor(Node node) {
        /*
         * å¦‚æœwaitStatus<0,åˆ™å°†waitStatus ç½®ä¸ºé»˜è®¤å€¼0
         */
        int ws = node.waitStatus;
        if (ws < 0)
            compareAndSetWaitStatus(node, ws, 0);
    
        /*
         * ä½†å¦‚æœä¸ºnull æˆ–ä¸ºå–æ¶ˆçŠ¶æ€ï¼Œåˆ™ä»tailå‘å‰éå†ä»¥æŸ¥æ‰¾åˆ°å®é™…æœªå–æ¶ˆçš„åç»§èŠ‚ç‚¹ã€‚
         */
        Node s = node.next;
        if (s == null || s.waitStatus > 0) {
            s = null;
            for (Node t = tail; t != null && t != node; t = t.prev)
                if (t.waitStatus <= 0)
                    s = t;
        }
        // å¯¹åç»§èŠ‚ç‚¹çš„çº¿ç¨‹é‡Šæ”¾é˜»å¡
        if (s != null)
            LockSupport.unpark(s.thread);
    }
    

èŠ‚ç‚¹çº¿ç¨‹é‡Šæ”¾é”
-------

è·å–é”ææ‡‚åï¼Œé‡Šæ”¾é”å°±æ˜¯å¾ˆç®€å•äº†

**å¤„ç†æµç¨‹**

é”åœ¨é‡Šæ”¾æ—¶è°ƒç”¨çš„å…³é”®æµç¨‹ï¼šReentrantLock#unlock() -> Sync#release(1) -> AQS#tryRelease(1) -> LockSupport#unparkSuccessor(head)

unparkSuccessor(head)æ–¹æ³•åœ¨å‰é¢å·²ç»è®²è¿°è¿‡ä¸å†èµ˜è¿°ï¼Œå‰ä¸‰ä¸ªæ–¹æ³•æºç å¦‚ä¸‹ğŸ‘‡

    // java.util.concurrent.locks.ReentrantLock
    public void unlock() {
        // ReentrantLock API äº¤ç”±åŒæ­¥é˜Ÿåˆ—æ¨¡æ¿æ–¹æ³•å®ç°
        sync.release(1);
    }
    
    // java.util.concurrent.locks.AbstractQueuedSynchronizer
    public final boolean release(int arg) {
        // å°è¯•é‡Šæ”¾é”ï¼ŒæˆåŠŸåˆ™å”¤é†’åç»§èŠ‚ç‚¹
        if (tryRelease(arg)) {
            Node h = head;
            if (h != null && h.waitStatus != 0)
                // å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹çš„é˜»å¡çº¿ç¨‹
                unparkSuccessor(h);
            return true;
        }
        return false;
    }
    
    
    // java.util.concurrent.locks.ReentrantLock.Sync
    protected final boolean tryRelease(int releases) {
        // stateï¼šæ¯é‡Šæ”¾1æ¬¡é”å°±ä¼š-1ï¼ˆç›¸åï¼šé‡å…¥æ€§ï¼Œæ¯è·å–1æ¬¡é”å°±ä¼š+1ï¼‰
        int c = getState() - releases;
        // å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ç‹¬å é”çº¿ç¨‹ï¼Œä¸æ˜¯å°±æŠ›å‡ºå¼‚å¸¸
        if (Thread.currentThread() != getExclusiveOwnerThread())
            throw new IllegalMonitorStateException();
        boolean free = false;
        // å½“state=0æ—¶ï¼Œè¯´æ˜è·å–é”çš„æ¬¡æ•°å·²ç»é‡Šæ”¾å®Œï¼Œå¯ä»¥è§£é™¤ç‹¬å é”çº¿ç¨‹
        if (c == 0) {
            // é”é‡Šæ”¾æˆåŠŸ
            free = true;
            // ç‹¬å é”çº¿ç¨‹ç½®ä¸ºnull
            setExclusiveOwnerThread(null);
        }
        // è®°å½•æ¯æ¬¡stateçš„å˜åŒ–
        setState(c);
        return free;
    }
    
    

æœ€åé™„ä¸Šä»¥ ReentrantLock çš„`lock()`ä¸ºä¾‹ï¼Œé‡Œé¢å‡ ä¹ç”»å‡ºäº†è·å–é”çš„æ‰€æœ‰ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹

![image](https://img2022.cnblogs.com/blog/1209017/202211/1209017-20221115074202979-345209476.png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_gif/6zNMYJFHmvQvfJSAA1waB06NtJup9wm3Dp18fcavQPyMqm3yWcMFRXOqKCgshft5nnYSib3yLCcY0Y4q05vetsw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

[Java å¯é‡å…¥é”çš„é‚£äº›äº‹ï¼ˆä¸€ï¼‰](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485680&idx=1&sn=a2f4118d70ae07a250d92ee9dda18cc6&chksm=ec62c86ddb15417b3bff451cb693ea55345867e1664bdff82679b9b9f37ea0cbdf00596c6854&scene=21#wechat_redirect)

[Javaä¸­çš„çº¿ç¨‹å®‰å…¨ä¸çº¿ç¨‹åŒæ­¥](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485648&idx=1&sn=f40d874a1572242e2f8889e37d6a305a&chksm=ec62c84ddb15415b6cba59fc6c1b0686db7320421241d6c851e2f4b67599588d2d92712095d7&scene=21#wechat_redirect)

[Javaçº¿ç¨‹çŠ¶æ€ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰--ä¸€ç¯‡å…¥é­‚](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485542&idx=1&sn=0772ab488f555b218a81af7a10f1ed11&chksm=ec62c8fbdb1541ed7cfb74ed91d1c2192e9aae3e9b8be6522e439cb585e42f37cd8e260f163e&scene=21#wechat_redirect)

[è‡ªå·±ç¼–å†™å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•ï¼Œå®ç°åå‘ä»£ç†é›†ç¾¤æœåŠ¡çš„å¹³æ»‘åˆ†é…](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485469&idx=1&sn=d81920b2ce30a1d675c95aa881627bd6&chksm=ec62c880db154196d1f37129cb9dc30f107814fa2da2f130f08a207da814fd25eba54ac3c18a&scene=21#wechat_redirect)

[Javaå®ç°å¹³æ»‘åŠ æƒè½®è¯¢ç®—æ³•--é™æƒå’Œææƒ](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485441&idx=1&sn=db09c8d233c743b3a4bdf7f4d2766b81&chksm=ec62c89cdb15418acf590bbe316a3e9cc9420959eac0d57858a5afb825cc45d8c20bafd2e765&scene=21#wechat_redirect)

[Javaå®ç°è´Ÿè½½å‡è¡¡ç®—æ³•--è½®è¯¢å’ŒåŠ æƒè½®è¯¢](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485432&idx=1&sn=81347615fdec6a4e7e2bb2ae74d85f1b&chksm=ec62c765db154e7348c1b34ebeed1e0ec006c68cfbeda17f1321d4e318b155258982d093b898&scene=21#wechat_redirect)

[Javaå…¨æ ˆå­¦ä¹ è·¯çº¿ã€å­¦ä¹ èµ„æºå’Œé¢è¯•é¢˜ä¸€æ¡é¾™](http://mp.weixin.qq.com/s?__biz=MzI5NDM5NDM1NA==&mid=2247485015&idx=1&sn=862bc2b379726b89cdb396ec0d325cc0&chksm=ec62c6cadb154fdc533111a253d72001534ab92de317cbde5c1c9f575548500bc734c3028484&scene=21#wechat_redirect)

æ›´å¤šä¼˜è´¨æ–‡ç« ï¼Œè¯·å…³æ³¨WXå…¬ä¼—å·ï¼šJavaå…¨æ ˆå¸ƒé“å¸ˆ

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz/7Lm51TENjPtrhLVagB55zKY9H6iaD5kKZaPoA0Uts6qCN5FLRUIZHSAamrwXfQNNrAVA87FBoNXGs0g12VwArXg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)