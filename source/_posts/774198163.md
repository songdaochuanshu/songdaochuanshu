---
layout: post
title: "HCNP Routing&Switching之组播技术PIM-SM 稀疏模式"
date: "2022-04-14T03:05:53.775Z"
---
HCNP Routing&Switching之组播技术PIM-SM 稀疏模式
======================================

![HCNP Routing&amp;Switching之组播技术PIM-SM 稀疏模式](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220414001041270-153465082.png) 连接接收者的路由器向组播组对应的RP发送加入报文，该报文被逐跳送达RP，所经过的路径就形成了RPT的分支；组播源如果要想组播组发送组播数据，首先由于组播源侧DR负责向RP进行注册，把注册报文通过单播的方式发送给RP，该报文到达RP后触发构建SPT。之后组播源把组播数据沿着SPT发向RP，但组播数据达到RP后，被复制并沿着RPT发送给接收者；

　　前文我们了解了组播路由协议PIM以及PIM-DM密集模式相关话题，回顾请参考[https://www.cnblogs.com/qiuhom-1874/p/16084310.html](https://www.cnblogs.com/qiuhom-1874/p/16084310.html)；今天我们来聊一聊PIM的另外一种模式SM稀疏模式相关话题；

　　PIM-SM概述

　　PIM-SM（PIM Sparse Mode，协议无关组播-稀疏模式）是组播PIM的另外一种模式稀疏模式，该模式和密集模式相反，使用“拉（pull）”的方式来传输数据；适用于范围较广的大中型网络中，组成员分布相对分散的环境中；

　　PIM-SM工作流程

　　1、邻居发现和DR选举

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413224744496-241975001.png)

　　提示：PIM-SM邻居发现过程和PIM-DM相同，都是通过发送hello包相互建立起邻居；不同的是DM只会在靠近用户侧路由器选一个DR来充当IGMPv1的查询器，v2v3版本不依赖PIM来选举查询器；简单讲就是DM里只会在靠近用户侧侧的路由器上选举一个DR，其作用就仅仅是充当IGMPv1的查询器；而SM模式里DR不但要在靠近接收者侧的路由器上选举DR，在靠近组播源的路由器上也会选择DR，其作用就是作为共享网段中唯一转发组播数据的转发者；

　　DR选举规则

　　1、先比较优先级，优先级高者成为DR；

　　2、如果优先级一样，则比较ip地址，ip地址大者成为DR；

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413225901332-1713038592.png)

　　提示：接收者侧的DR主要负责向RP发送加入报文，组播源侧的DR主要负责向RP发送组成报文；RP就是共享点从源到RP一路建立源树，RP到接收者一路建立共享树；

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413230026926-468191196.png)

　　提示：连接接收者的路由器向组播组对应的RP发送加入报文，该报文被逐跳送达RP，所经过的路径就形成了RPT的分支；组播源如果要想组播组发送组播数据，首先由于组播源侧DR负责向RP进行注册，把注册报文通过单播的方式发送给RP，该报文到达RP后触发构建SPT。之后组播源把组播数据沿着SPT发向RP，但组播数据达到RP后，被复制并沿着RPT发送给接收者；

　　2、用户加入过程

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413231008800-1743478885.png)

　　提示：SM和DM不一样有扩散-剪支-嫁接的过程；SM默认会认为整个网段里没有用户存在，所以它不会一上来就扩散；而是通过接收者DR向RP发起加入消息，该消息沿着每一台路由器都创建（\*,G）表项，形成以RP为根的RPT；也就是说SM模式中只有出现接收者，才会构建组播路由，才会向对应网段转发组播数据；如果有用户离开，则也是用户侧发送剪支消息；加入-剪支是随用户侧的变化而变化；

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413231848712-527058948.png)

　　提示：不管是靠近用户侧还是组播源侧的路由器，都是在共享网段中选举DR，不同共享网段的用户是不同的DR；

　　3、组播源注册过程

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413232619803-525301732.png)

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413234033756-1777109105.png)

　　提示：首先是由DR通过组播报文中封装单播注册消息发送给RP，RP收到组播源的注册消息后，会发送加入消息，从而组播源到RP的路由器建立起SPT；随后在由RP向用户侧DR转发组播数据（通过RPT），最终组播数据送达至用户；

　　注册停止过程

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413234159278-420455879.png)

　　提示：当RP发送加入消息后，对应SPT形成后，RP会向组播源侧DR发送注册停止消息，意思就是告诉组播源你的注册我这边已经收到了，你那边不用一直发送注册消息；你可以停了，类似一个确认消息吧；

　　通过上述过程，我们不难看出从源到RP，然后再从RP到用户侧，这样一条转发路径不一定是最优的，并且如果有多个组播源，此时RP的流量是非常高的，负载也比较重；所以为了避免次优路径和RP的负载，就有了下面的RPT向SPT切换到过程；、

　　4、RPT向SPT切换过程

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413234814171-1315436892.png)

　　提示：这个切换我们可以手动配置是否要切换，这个根据个人的环境来配置，默认情况下华为的模拟器是当接收者收到第一个组播报文后，接受者侧DR发送加入消息，当组播源侧DR收到用户侧DR发送的加入消息后，会随加入消息的路径建立起源树，从而实现RPT向SPT的切换；

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413235351584-1992333225.png)

　　提示：由用户侧DR或上游路由器向RP发送Prune消息，RP向组播源DR发送Prune消息进行多余路径剪支；

![](https://img2022.cnblogs.com/blog/1503305/202204/1503305-20220413235615598-1761244312.png)

　　提示：通过Prune剪支消息去把对应的源树剪掉，从而完成源树切换，最终形成源到接收者之间新的源树；

　　通过上述RPT向SPT的切换，我们可以看到PIM-SM能够以比PIM-DM根经济的方式建立SPT（其原因是SM不用全网扩散，全网扩散会消耗沿路路由器的内存资源、网络带宽等）；

　　PIM-SM中的“Assert”断言机制和PIM-DM中的断言机制一样，没有区别；

作者：[Linux-1874](https://www.cnblogs.com/qiuhom-1874/)

出处：[https://www.cnblogs.com/qiuhom-1874/](https://www.cnblogs.com/qiuhom-1874/)

本文版权归作者和博客园共有，欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则保留追究法律责任的权利.