---
layout: post
title: "å…³äºASP.NET Core WebSocketå®ç°é›†ç¾¤çš„æ€è€ƒ"
date: "2022-11-08T04:44:17.200Z"
---
å…³äºASP.NET Core WebSocketå®ç°é›†ç¾¤çš„æ€è€ƒ
===============================

### å‰è¨€

Â Â Â Â æåˆ°`WebSocket`ç›¸ä¿¡å¤§å®¶éƒ½å¬è¯´è¿‡ï¼Œå®ƒçš„åˆè¡·æ˜¯ä¸ºäº†è§£å†³å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æœåŠ¡ç«¯è¿›è¡ŒåŒå‘é€šä¿¡ï¼Œæ˜¯åœ¨å•ä¸ª`TCP`è¿æ¥ä¸Šè¿›è¡Œå…¨åŒå·¥é€šè®¯çš„åè®®ã€‚åœ¨æ²¡æœ‰WebSocketä¹‹å‰åªèƒ½é€šè¿‡æµè§ˆå™¨åˆ°æœåŠ¡ç«¯çš„è¯·æ±‚åº”ç­”æ¨¡å¼æ¯”å¦‚è½®è¯¢ï¼Œæ¥å®ç°æœåŠ¡ç«¯çš„å˜æ›´å“åº”åˆ°å®¢æˆ·ç«¯ï¼Œç°åœ¨æœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘é€æ•°æ®åˆ°å®¢æˆ·ç«¯æµè§ˆå™¨ã€‚`WebSocket`åè®®å’Œ`Http`åè®®å¹³è¡Œï¼Œéƒ½å±äº`TCP/IPå››å±‚æ¨¡å‹`ä¸­çš„ç¬¬å››å±‚åº”ç”¨å±‚ã€‚ç”±äº`WebSocket`æ¡æ‰‹é˜¶æ®µé‡‡ç”¨`HTTP`åè®®,æ‰€ä»¥ä¹Ÿéœ€è¦è¿›è¡Œè·¨åŸŸå¤„ç†ã€‚å®ƒçš„åè®®æ ‡è¯†æ˜¯`ws`æˆ–`wss`å¯¹åº”äº†å¸¸è§„æ ‡è¯†å’Œå®‰å…¨é€šä¿¡åè®®æ ‡è¯†ã€‚æœ¬æ–‡é‡ç‚¹å¹¶ä¸æ˜¯ä»‹ç»`WebSocket`åè®®ç›¸å…³ï¼Œè€Œæ˜¯æä¾›ä¸€ç§åŸºäºASP.NET CoreåŸç”ŸWebSocketçš„æ–¹å¼å®ç°é›†ç¾¤çš„å®ç°æ€è·¯ã€‚å…³äºè¿™å¥—æ€è·¯å…¶å®å¾ˆæ—©ä¹‹å‰æˆ‘å°±æ„æ€è¿‡äº†ï¼Œåªæ˜¯ä¹‹å‰ä¸€ç›´æ²¡æœ‰ç³»ç»Ÿçš„æ•´ç†å‡ºæ¥ï¼Œæœ¬ç¯‡æ–‡ç« å°±æ¥å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œç”±äºä¸»è¦æ˜¯æä¾›ä¸€ç§æ€è·¯ï¼Œæ‰€ä»¥æ¶‰åŠåˆ°å…·ä½“ç»†èŠ‚æˆ–è€…ä¸šåŠ¡ç›¸å…³çš„å¯èƒ½æ²¡æœ‰ä½“ç°å‡ºæ¥ï¼Œè¿˜æœ›å¤§å®¶ç†è§£ã€‚

### å®ç°

å’±ä»¬çš„é‡ç‚¹å…³é”®å­—å°±æ˜¯ä¸¤ä¸ª`WebSocket`å’Œ`é›†ç¾¤`ï¼Œå®ç°çš„æ¡†æ¶ä¾¿æ˜¯åŸºäº`ASP.NET Core`,æˆ‘ä¹ŸåŸºäº`golang`å®ç°äº†ä¸€å¥—,æœ¬æ–‡æ¶‰åŠåˆ°çš„ç›¸å…³æºç å’Œgolangç‰ˆæœ¬çš„å®ç°éƒ½å·²ä¸Šä¼ è‡³[æˆ‘çš„github](https://github.com/softlgl),å…·ä½“ä»“åº“åœ°å€å¯ä»¥è½¬åˆ°æ–‡æœ«è‡ªè¡Œè·³è½¬åˆ°[#ç¤ºä¾‹æºç ](#%E7%A4%BA%E4%BE%8B%E6%BA%90%E7%A0%81)ä¸­æŸ¥çœ‹ã€‚æ—¢ç„¶æ¶‰åŠåˆ°é›†ç¾¤ï¼Œè¿™é‡Œå’±ä»¬å°±ç”¨`nginx`ä½œä¸ºåå‘ä»£ç†ï¼Œæ¥æ­å»ºä¸€ä¸ªé›†ç¾¤å®ä¾‹ã€‚å¤§è‡´çš„ç¤ºä¾‹ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104112603849-1486592473.png)`redis`åœ¨è¿™é‡Œæ‰®æ¼”çš„è§’è‰²å‘¢ï¼Œæ˜¯ç”¨æ¥å¤„ç†`Server`ç«¯çš„æ¶ˆæ¯ç›¸äº’ä¼ é€’ç”¨çš„ï¼Œä¸»è¦æ˜¯ä½¿ç”¨çš„redisçš„`pub/sub`åŠŸèƒ½æ¥å®ç°çš„ï¼Œè¿™é‡Œä¾¿æ¶‰åŠåˆ°å‡ ä¸ªæ ¸å¿ƒé—®é¢˜

*   é¦–å…ˆï¼Œé›†ç¾¤çŠ¶æ€æ¯ä¸ªç”¨æˆ·è¢«åˆ†å‘åˆ°å…·ä½“çš„å“ªå°æœåŠ¡å™¨ä¸Šæ˜¯ä¸å¾—è€ŒçŸ¥çš„
*   å…¶æ¬¡ï¼Œå¤„åœ¨ä¸åŒ`Server`ç«¯çš„ä¸åŒç”¨æˆ·é—´çš„ç›¸äº’é€šä¿¡æ˜¯éœ€è¦ä¸€ä¸ªä¼ é€’åª’ä»‹
*   æœ€åï¼Œé’ˆå¯¹ä¸åŒçš„åœºæ™¯æ¯”å¦‚å•å‘æ¶ˆæ¯ã€åˆ†ç»„æ¶ˆæ¯ã€å…¨éƒ¨é€šçŸ¥ç­‰è¦æœ‰ä¸åŒçš„å¤„ç†ç­–ç•¥

> è¿™é‡Œéœ€è¦è€ƒè™‘çš„æ˜¯ï¼Œå¦‚æœéœ€è¦æ­å»ºå®æ—¶é€šä¿¡æœåŠ¡å™¨çš„è¯ï¼Œéœ€è¦æ³¨æ„é›†ç¾¤çš„éš”ç¦»æ€§ï¼Œä¸»è¦æ˜¯å’Œæ ¸å¿ƒä¸šåŠ¡è¿›è¡Œéš”ç¦»ï¼Œæ¯•ç«Ÿ`WebSocket`éœ€è¦ä¿æŒé•¿é“¾æ¥ã€ä¸”æ¶ˆæ¯çš„å¤§å°éœ€è¦è¯„ä¼°ã€‚

ä¸Šé¢æåˆ°äº†`redis`çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯ç”¨æ¥ä¼ é€’æ¶ˆæ¯ç”¨çš„ï¼Œæ¯•ç«Ÿæ¯ä¸ªserveræœåŠ¡å™¨æ˜¯æ— çŠ¶æ€çš„ã€‚è¿™å½“ç„¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä»»ä½•å¯ä»¥è¿›è¡Œæ¶ˆæ¯åˆ†å‘çš„ä¸­é—´ä»¶éƒ½å¯ä»¥ï¼Œæ¯”å¦‚æ¶ˆæ¯é˜Ÿåˆ—rabbitmqã€kafkaã€rocketmqã€mqttç­‰ï¼Œç”šè‡³åªè¦èƒ½æŠŠè¦å¤„ç†çš„æ¶ˆæ¯å­˜å‚¨èµ·æ¥éƒ½å¯ä»¥æ¯”å¦‚ç¼“å­˜ç”šè‡³æ˜¯å…³ç³»å‹æ•°æ®åº“ç­‰ç­‰ã€‚è¿™å‹åŠ›ä½¿ç”¨redisä¸»è¦æ˜¯å› ä¸ºæ“ä½œèµ·æ¥ç®€å•ã€è½»é‡çº§ã€çµæ´»ï¼Œè®©å¤§å®¶å…³æ³¨ç‚¹åœ¨æ€è·¯ä¸Šï¼Œè€Œä¸æ˜¯ä½¿ç”¨ä¸­æ¡ˆä»¶çš„ä»£ç ä¸Šã€‚

#### nginxé…ç½®

é€šè¿‡ä¸Šé¢çš„å›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è¿™é‡Œæ„å»ºé›†ç¾¤ç¤ºä¾‹ä½¿ç”¨çš„nginxï¼Œå¦‚æœè®©nginxæ”¯æŒWebSocketçš„è¯ï¼Œéœ€è¦é¢å¤–çš„é…ç½®ï¼Œè¿™ä¸ªåœ¨ç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„æ–‡ç« ä»‹ç»ï¼Œè¿™é‡Œå°±æ¥åˆ—ä¸€ä¸‹å’±ä»¬ç¤ºä¾‹çš„nginxé…ç½®ï¼Œåœ¨é…ç½®æ–‡ä»¶`nginx.conf`é‡Œ

    //ä¸Šæ¸¸æœåŠ¡å™¨åœ°å€ä¹Ÿå°±æ˜¯websocketæœåŠ¡çš„çœŸå®åœ°å€
    upstream wsbackend {
        server 127.0.0.1:5001;
        server 127.0.0.1:5678;
    }
    
    server {
        listen       5000;
        server_name  localhost;
    
        location ~/chat/{
            //upstreamåœ°å€
            proxy_pass http://wsbackend;
            proxy_connect_timeout 60s; 
            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
            //è®°å¾—è½¬å‘é¿å…è¸©å‘
            proxy_set_header Host $host;
            proxy_http_version 1.1; 
            //httpå‡çº§æˆwebsocketåè®®çš„å¤´æ ‡è¯†
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";
        }
    }
    

è¿™å¥—é…ç½®å‘¢ï¼Œåœ¨æœç´¢å¼•æ“ä¸Šèƒ½æ”¶åˆ°å¾ˆå¤šï¼Œä¸è¿‡ä¸å¦¨ç¢æˆ‘æŠŠä½¿ç”¨çš„ç²˜è´´å‡ºæ¥ã€‚è¿™ä¸€å¥—äº²æµ‹æœ‰æ•ˆï¼Œä¹Ÿæ˜¯æˆ‘ä½¿ç”¨çš„é…ç½®ï¼Œè¯·æ”¾å¿ƒä½¿ç”¨ã€‚ä¸ªäººè®¤ä¸ºå¦‚æœæ˜¯çº¿ä¸Šç¯å¢ƒé‡‡ç”¨çš„è´Ÿè½½å‡è¡¡ç­–ç•¥å¯ä»¥é€‰æ‹©`ip_hash`çš„æ–¹å¼ï¼Œä¿è¯åŒä¸€ä¸ªipçš„å®¢æˆ·ç«¯ç”¨æˆ·å¯ä»¥åˆ†å‘åˆ°ä¸€å°WebSocketå®ä¾‹ä¸­å»ï¼Œè¿™æ ·çš„è¯èƒ½å°½é‡é¿å…ä½¿ç”¨redisçš„ç”¨æˆ·é¢‘é“åšæ¶ˆæ¯ä¼ é€’ã€‚å¥½äº†ï¼Œæ¥ä¸‹æ¥å‡†å¤‡å¼€å§‹å±•ç¤ºå…·ä½“å®ç°çš„ä»£ç äº†ã€‚

#### ä¸€å¯¹ä¸€å‘é€

é¦–å…ˆä»‹ç»çš„å°±æ˜¯ä¸€å¯¹ä¸€å‘é€çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æˆ‘æŠŠæ¶ˆæ¯å‘ç»™ä½ ï¼ŒèŠå¤©çš„æ—¶å€™ç§èŠçš„æƒ…å†µã€‚è¿™é‡Œå‘¢æ¶‰åŠåˆ°ä¸¤ç§æƒ…å†µ

*   å¦‚æœä½ éœ€è¦é€šä¿¡çš„å®¢æˆ·ç«¯å’Œä½ è¿æ¥åœ¨ä¸€ä¸ªServerç«¯é‡Œï¼Œè¿™æ ·çš„è¯å¯ä»¥ç›´æ¥åœ¨é“¾æ¥é‡Œæ‰¾åˆ°è¿™ä¸ªç«¯çš„é€šä¿¡å®ä¾‹ç›´æ¥å‘é€ã€‚
*   å¦‚æœä½ éœ€è¦é€šä¿¡çš„å®¢æˆ·ç«¯å’Œä½ ä¸åœ¨ä¸€ä¸ªServerç«¯é‡Œï¼Œè¿™ä¸ªæ—¶å€™å’±ä»¬å°±éœ€è¦å€ŸåŠ©redisçš„`pub/sub`çš„åŠŸèƒ½ï¼ŒæŠŠæ¶ˆæ¯ä¼ é€’ç»™å¦ä¸€ä¸ªServerç«¯ã€‚

å’±ä»¬é€šè¿‡ä¸€å¼ å›¾å¤§è‡´çš„å±•ç¤ºä¸€ä¸‹å®ƒçš„å·¥ä½œæ–¹å¼  
![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104134727664-1919340337.png)  
è§£é‡Šä¸€ä¸‹ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯æ³¨å†Œåˆ°`WebSocket`æœåŠ¡é‡Œçš„æ—¶å€™ä¼šåœ¨redisé‡Œè®¢é˜…ä¸€ä¸ª`user:ç”¨æˆ·å”¯ä¸€æ ‡è¯†`çš„é¢‘é“ï¼Œè¿™ä¸ªé¢‘é“ç”¨äºæ¥æ”¶å’Œå½“å‰WebSocketè¿æ¥ä¸åœ¨ä¸€ä¸ªæœåŠ¡ç«¯çš„å…¶ä»–WebSocketå‘é€è¿‡æ¥çš„æ¶ˆæ¯ã€‚æ¯æ¬¡å‘é€æ¶ˆæ¯çš„æ—¶å€™ä½ ä¼šçŸ¥é“ä½ è¦å‘é€ç»™è°ï¼Œä¸åœ¨å½“å‰æœåŠ¡å™¨çš„è¯åˆ™å‘é€åˆ°redisçš„`user:ç”¨æˆ·å”¯ä¸€æ ‡è¯†`é¢‘é“ï¼Œè¿™æ ·çš„è¯ç›®æ ‡WebSocketå°±èƒ½æ”¶åˆ°æ¶ˆæ¯äº†ã€‚é¦–å…ˆæ˜¯æ³¨å…¥ç›¸å…³çš„ä¾èµ–é¡¹ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„rediså®¢æˆ·ç«¯æ˜¯`freeredis`ï¼Œä¸»è¦æ˜¯å› ä¸ºæ“ä½œèµ·æ¥ç®€å•,å…·ä½“å®ç°ä»£ç å¦‚ä¸‹

    var builder = WebApplication.CreateBuilder(args);
    //æ³¨å†Œfreeredis
    builder.Services.AddSingleton(provider => {
        var logger = provider.GetService<ILogger<WebSocketChannelHandler>>();
        RedisClient cli = new RedisClient("127.0.0.1:6379");
        cli.Notice += (s, e) => logger?.LogInformation(e.Log);
        return cli;
    });
    //æ³¨å†ŒWebSocketå…·ä½“æ“ä½œçš„ç±»
    builder.Services.AddSingleton<WebSocketHandler>();
    builder.Services.AddControllers();
    
    var app = builder.Build();
    
    var webSocketOptions = new WebSocketOptions
    {
        KeepAliveInterval = TimeSpan.FromMinutes(2)
    };
    //æ³¨å†ŒWebSocketä¸­é—´ä»¶
    app.UseWebSockets(webSocketOptions);
    
    app.MapGet("/", () => "Hello World!");
    app.MapControllers();
    
    app.Run();
    

æ¥ä¸‹æ¥æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªControllerç”¨æ¥å¤„ç†WebSocketè¯·æ±‚

    public class WebSocketController : ControllerBase
    {
        private readonly ILogger<WebSocketController> _logger;
        private readonly WebSocketHandler _socketHandler;
    
        public WebSocketController(ILogger<WebSocketController> logger, WebSocketHandler socketHandler, WebSocketChannelHandler webSocketChannelHandler)
        {
            _logger = logger;
            _socketHandler = socketHandler;
        }
        
        //è¿™é‡Œçš„idä»£è¡¨å½“å‰è¿æ¥çš„å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†æ¯”å¦‚ç”¨æˆ·å”¯ä¸€æ ‡è¯†
        [HttpGet("/chat/user/{id}")]
        public async Task ChatUser(string id)
        {
            //åˆ¤æ–­æ˜¯å¦æ˜¯WebSocketè¯·æ±‚
            if (HttpContext.WebSockets.IsWebSocketRequest)
            {
                _logger.LogInformation($"user:{id}-{Request.HttpContext.Connection.RemoteIpAddress}:{Request.HttpContext.Connection.RemotePort} join");
    
                var webSocket = await HttpContext.WebSockets.AcceptWebSocketAsync();
                //å¤„ç†è¯·æ±‚ç›¸å…³
                await _socketHandler.Handle(id, webSocket);
            }
            else
            {
                HttpContext.Response.StatusCode = StatusCodes.Status400BadRequest;
            }
        }
    }
    

è¿™é‡Œçš„WebSocketHandleræ˜¯ç”¨æ¥å¤„ç†å…·ä½“é€»è¾‘ç”¨çš„ï¼Œå’±ä»¬çœ‹ä¸€ä¸‹ç›¸å…³ä»£ç 

    public class WebSocketHandler:IDisposable
    {
        //å­˜å‚¨å½“å‰æœåŠ¡ç”¨æˆ·çš„é›†åˆ
        private readonly UserConnection UserConnection = new();
        //redisé¢‘é“å‰ç¼€
        private readonly string userPrefix = "user:";
        //ç”¨æˆ·å¯¹åº”çš„redisé¢‘é“
        private readonly ConcurrentDictionary<string, IDisposable> _disposables = new();
    
        private readonly ILogger<WebSocketHandler> _logger;
        //rediså®¢æˆ·ç«¯
        private readonly RedisClient _redisClient;
    
        public WebSocketHandler(ILogger<WebSocketHandler> logger, RedisClient redisClient)
        {
            _logger = logger;
            _redisClient = redisClient;
        }
    
        public async Task Handle(string id, WebSocket webSocket)
        {
            //æŠŠå½“å‰ç”¨æˆ·è¿æ¥å­˜å‚¨èµ·æ¥
            _ = UserConnection.GetOrAdd(id, webSocket);
            //è®¢é˜…ä¸€ä¸ªå½“å‰ç”¨æˆ·çš„é¢‘é“
            await SubMsg($"{userPrefix}{id}");
    
            var buffer = new byte[1024 * 4];
            //æ¥æ”¶å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯é˜»å¡çš„ï¼Œå¦‚æœæ²¡æ”¶åˆ°æ¶ˆæ¯åˆ™ä¸€ç›´é˜»å¡
            var receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
            //å¾ªç¯æ¥æ”¶æ¶ˆæ¯
            while (webSocket.State == WebSocketState.Open)
            {
                try
                {
                    //å› ä¸ºç¼“å†²åŒºé•¿åº¦æ˜¯å›ºå®šçš„æ‰€ä»¥è¦è·å–å®é™…é•¿åº¦
                    string msg = Encoding.UTF8.GetString(buffer[..receiveResult.Count]).TrimEnd('\0');
                    //æ¥æ”¶çš„åˆ°æ¶ˆæ¯è½¬æ¢æˆå®ä½“
                    MsgBody msgBody = JsonConvert.DeserializeObject<MsgBody>(msg);
                    //å‘é€åˆ°å…¶ä»–å®¢æˆ·ç«¯çš„æ•°æ®
                    byte[] sendByte = Encoding.UTF8.GetBytes($"user {id} send:{msgBody.Msg}");
                    _logger.LogInformation($"user {id} send:{msgBody.Msg}");
                     
                    //åˆ¤æ–­ç›®æ ‡å®¢æˆ·ç«¯æ˜¯å¦åœ¨å½“å‰å½“å‰æœåŠ¡ï¼Œå¦‚æœåœ¨å½“å‰æœåŠ¡ç›´æ¥æ‰åˆ°ç›®æ ‡è¿æ¥ç›´æ¥å‘é€
                    if (UserConnection.TryGetValue(msgBody.Id, out var targetSocket))
                    {
                        if (targetSocket.State == WebSocketState.Open)
                        {
                            await targetSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), receiveResult.MessageType, true, CancellationToken.None);
                        }
                    }
                    else
                    {
                        //å¦‚æœè¦å‘é€çš„ç›®æ ‡ç«¯ä¸åœ¨å½“å‰æœåŠ¡ï¼Œåˆ™å‘é€ç»™ç›®æ ‡redisç«¯çš„é¢‘é“
                        ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = id, ToId = msgBody.Id, Msg = msgBody.Msg };
                        //ç›®æ ‡çš„redisé¢‘é“
                        _redisClient.Publish($"{userPrefix}{msgBody.Id}", JsonConvert.SerializeObject(channelMsgBody));
                    }
                    
                    //ç»§ç»­é˜»å¡å¾ªç¯æ¥æ”¶æ¶ˆæ¯
                    receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, ex.Message);
                    break;
                }
            }
            
            //å¾ªç¯ç»“æŸæ„å‘³ç€å½“å‰ç«¯å·²ç»é€€å‡º
            //ä»å½“å‰ç”¨æˆ·çš„é›†åˆç§»é™¤å½“å‰ç”¨æˆ·
            _ = UserConnection.TryRemove(id, out _);
            //å…³é—­å½“å‰WebSocketè¿æ¥
            await webSocket.CloseAsync(receiveResult.CloseStatus.Value, receiveResult.CloseStatusDescription, CancellationToken.None);
            //åœ¨å½“å‰è®¢é˜…é›†åˆç§»é™¤å½“å‰ç”¨æˆ·
            _disposables.TryRemove($"{userPrefix}{id}", out var disposable);
            //å…³é—­å½“å‰ç”¨æˆ·çš„é€šé“
            disposable.Dispose();
        }
    
        private async Task SubMsg(string channel)
        {
            //è®¢é˜…å½“å‰ç”¨æˆ·é¢‘é“
            var sub = _redisClient.Subscribe(channel,  async (channel, data) => {
                //æ¥æ”¶è¿‡æ¥å½“å‰é¢‘é“æ•°æ®ï¼Œè¯´æ˜å‘é€ç«¯ä¸åœ¨å½“å‰æœåŠ¡
                ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
                byte[] sendByte = Encoding.UTF8.GetBytes($"user {msgBody.FromId} send:{msgBody.Msg}");
                //åœ¨å½“å‰æœåŠ¡æ‰¾åˆ°ç›®æ ‡çš„WebSocketè¿æ¥å¹¶å‘é€æ¶ˆæ¯
                if (UserConnection.TryGetValue(msgBody.ToId, out var targetSocket))
                {
                    if (targetSocket.State == WebSocketState.Open)
                    {
                        await targetSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                    }
                }
            });
            //æŠŠredisè®¢é˜…é¢‘é“æ·»åŠ åˆ°é›†åˆä¸­
            _disposables.TryAdd(channel, sub);
        }
        
        //ç¨‹åºé€€å‡ºçš„æ—¶å€™å–æ¶ˆå½“å‰æœåŠ¡è®¢é˜…çš„redisé¢‘é“
        public void Dispose()
        {
            foreach (var disposable in _disposables)
            {
                disposable.Value.Dispose();
            }
    
            _disposables.Clear();
        }
    }
    

è¿™é‡Œæ¶‰åŠåˆ°å‡ ä¸ªè¾…åŠ©ç›¸å…³çš„ç±»ï¼Œå…¶ä¸­`UserConnection`ç±»æ˜¯å­˜å‚¨æ³¨å†Œåˆ°å½“å‰æœåŠ¡çš„è¿æ¥ï¼Œ`MsgBody`ç±»ç”¨æ¥æ¥å—å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„æ¶ˆæ¯ï¼Œ`ChannelMsgBody`æ˜¯ç”¨æ¥å‘é€redisé¢‘é“çš„ç›¸å…³æ¶ˆæ¯ï¼Œå› ä¸ºè¦æŠŠç›¸å…³æ¶ˆæ¯é€šè¿‡rediså‘å¸ƒå‡ºå»ï¼Œå’±ä»¬åˆ—ä¸€ä¸‹è¿™å‡ ä¸ªç±»çš„ç›¸å…³ä»£ç 

    //æ³¨å†Œåˆ°å½“å‰æœåŠ¡çš„è¿æ¥
    public class UserConnection : IEnumerable<KeyValuePair<string, WebSocket>>
    {
        //å­˜å‚¨ç”¨æˆ·å”¯ä¸€æ ‡è¯†å’ŒWebSocketçš„å¯¹åº”å…³ç³»
        private ConcurrentDictionary<string, WebSocket> _users = new ConcurrentDictionary<string, WebSocket>();
    
        //å½“å‰æœåŠ¡çš„ç”¨æˆ·æ•°é‡
        public int Count => _users.Count;
    
        public WebSocket GetOrAdd(string userId, WebSocket webSocket)
        {
            return _users.GetOrAdd(userId, webSocket);
        }
    
        public bool TryGetValue(string userId, out WebSocket webSocket)
        {
            return _users.TryGetValue(userId, out webSocket);
        }
    
        public bool TryRemove(string userId, out WebSocket webSocket)
        {
            return _users.TryRemove(userId, out webSocket);
        }
    
        public void Clear()
        {
            _users.Clear();
        }
    
        public IEnumerator<KeyValuePair<string, WebSocket>> GetEnumerator()
        {
            return _users.GetEnumerator();
        }
    
        IEnumerator IEnumerable.GetEnumerator()
        {
            return this.GetEnumerator();
        }
    }
    
    //å®¢æˆ·ç«¯æ¶ˆæ¯
    public class MsgBody
    {
        //ç›®æ ‡ç”¨æˆ·æ ‡è¯†
        public string Id { get; set; }
        //è¦å‘é€çš„æ¶ˆæ¯
        public string Msg { get; set; }
    }
    
    //é¢‘é“è®¢é˜…æ¶ˆæ¯
    public class ChannelMsgBody
    {
        //ç”¨æˆ·æ ‡è¯†
        public string FromId { get; set; }
        //ç›®æ ‡ç”¨æˆ·æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯è¦å‘é€ç»™è°
        public string ToId { get; set; }
        //è¦å‘é€çš„æ¶ˆæ¯
        public string Msg { get; set; }
    }
    

è¿™æ ·çš„è¯å…³äºä¸€å¯¹ä¸€å‘é€æ¶ˆæ¯çš„ç›¸å…³é€»è¾‘å°±å®ç°å®Œæˆäº†ï¼Œå¯åŠ¨ä¸¤ä¸ªServerç«¯ï¼Œç”±äºnginxé»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯è½®è¯¢ï¼Œæ‰€ä»¥æ³¨å†Œä¸¤ä¸ªç”¨æˆ·çš„è¯ä¼šè¢«åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡é‡Œå»![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104145506311-278170758.png)![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104145531159-1580084461.png)ç”¨`Postman`è¿æ¥ä¸‰ä¸ªè¿æ¥å”¯ä¸€æ ‡è¯†åˆ†åˆ«æ˜¯`1ã€2ã€3`ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹æ¶ˆæ¯å‘é€ï¼Œæ•ˆæœå¦‚ä¸‹,å‘é€æ•ˆæœ  
![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104145632247-1480219665.png)æ¥æ”¶æ•ˆæœ![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104145720998-1846447416.png)

#### ç¾¤ç»„å‘é€

ä¸Šé¢æˆ‘ä»¬å±•ç¤ºäº†ä¸€å¯¹ä¸€å‘é€çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œç¾¤ç»„å‘é€çš„æƒ…å†µã€‚ç¾¤ç»„å‘é€çš„è¯å°±æ˜¯åªè¦å¤§å®¶éƒ½åŠ å…¥ä¸€ä¸ªç¾¤ç»„ï¼Œåªè¦å®¢æˆ·ç«¯åœ¨ç¾¤ç»„é‡Œå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™æ³¨å†Œåˆ°å½“å‰ç¾¤ç»„å†…çš„æ‰€æœ‰å®¢æˆ·ç«¯éƒ½å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ã€‚ç›¸å¯¹äºä¸€å¯¹ä¸€çš„æƒ…å†µå°±æ˜¯å¦‚æœå½“å‰WebSocketæœåŠ¡ç«¯å¦‚æœå­˜åœ¨ç”¨æˆ·åŠ å…¥æŸä¸ªç¾¤ç»„ï¼Œåˆ™å½“å‰å½“å‰WebSocketæœåŠ¡ç«¯åˆ™å¯ä»¥è®¢é˜…ä¸€ä¸ª`group:ç¾¤ç»„å”¯ä¸€æ ‡è¯†`çš„redisé¢‘é“ï¼Œé›†ç¾¤ä¸­çš„å…¶ä»–WebSocketæœåŠ¡å™¨é€šè¿‡è¿™ä¸ªredisé¢‘é“æ¥æ”¶ç¾¤ç»„æ¶ˆæ¯ï¼Œé€šè¿‡ä¸€å¼ å›¾æè¿°ä¸€ä¸‹![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104150621209-1181048114.png)ç¾¤ç»„çš„å®ç°æ–¹å¼ç›¸å¯¹äºä¸€å¯¹ä¸€è¦ç®€å•ä¸€ç‚¹

*   å‘é€ç«¯å¯ä»¥ä¸ç”¨è€ƒè™‘å½“å‰æœåŠ¡ä¸­çš„å®¢æˆ·ç«¯è¿æ¥ï¼Œä¸€è‚¡è„‘çš„äº¤ç»™redisæŠŠæ¶ˆæ¯å‘å¸ƒå‡ºå»
*   å¦‚æœæœ‰WebSocketæœåŠ¡ä¸­çš„ç”¨æˆ·è®¢é˜…äº†å½“å‰åˆ†ç»„åˆ™å¯ä»¥æ¥å—æ¶ˆæ¯ï¼Œè·å–ç»„å†…çš„ç”¨æˆ·å¾ªç¯å‘é€æ¶ˆæ¯

å±•ç¤ºä¸€ä¸‹ä»£ç å®ç°çš„æ–¹å¼,é¦–å…ˆæ˜¯å®šä¹‰ä¸€ä¸ªactionç”¨äºè¡¨ç¤ºç¾¤ç»„çš„ç›¸å…³åœºæ™¯

    //åŒ…å«ä¸¤ä¸ªæ ‡è¯†ä¸€ä¸ªæ˜¯ç»„åˆ«æ ‡è¯†ä¸€ä¸ªæ˜¯æ³¨å†Œåˆ°ç»„åˆ«çš„ç”¨æˆ·
    [HttpGet("/chat/group/{groupId}/{userId}")]
    public async Task ChatGroup(string groupId, string userId)
    {
        if (HttpContext.WebSockets.IsWebSocketRequest)
        {
            _logger.LogInformation($"group:{groupId} user:{userId}-{Request.HttpContext.Connection.RemoteIpAddress}:{Request.HttpContext.Connection.RemotePort} join");
    
            var webSocket = await HttpContext.WebSockets.AcceptWebSocketAsync();
            //è°ƒç”¨HandleGroupå¤„ç†ç¾¤ç»„ç›¸å…³çš„æ¶ˆæ¯
            await _socketHandler.HandleGroup(groupId, userId, webSocket);
        }
        else
        {
            HttpContext.Response.StatusCode = StatusCodes.Status400BadRequest;
        }
    }
    

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹HandleGroupçš„ç›¸å…³é€»è¾‘ï¼Œè¿˜æ˜¯åœ¨WebSocketHandlerç±»ä¸­ï¼Œçœ‹ä¸€ä¸‹ä»£ç å®ç°

    public class WebSocketHandler:IDisposable
    {
        private readonly UserConnection UserConnection = new();
        private readonly GroupUser GroupUser = new();
        private readonly SemaphoreSlim _lock = new(1, 1);
        private readonly ConcurrentDictionary<string, IDisposable> _disposables = new();
        private readonly string groupPrefix = "group:";
    
        private readonly ILogger<WebSocketHandler> _logger;
        private readonly RedisClient _redisClient;
    
        public WebSocketHandler(ILogger<WebSocketHandler> logger, RedisClient redisClient)
        {
            _logger = logger;
            _redisClient = redisClient;
        }
    
        public async Task HandleGroup(string groupId, string userId, WebSocket webSocket)
        {
            //å› ä¸ºç¾¤ç»„çš„é›†åˆå¯èƒ½ä¼šå­˜åœ¨å¾ˆå¤šç”¨æˆ·ä¸€èµ·è®¿é—®æ‰€ä»¥é™åˆ¶è®¿é—®æ•°é‡
            await _lock.WaitAsync();
            //åˆå§‹åŒ–ç¾¤ç»„å®¹å™¨ ç¾¤å”¯ä¸€æ ‡è¯†ä¸ºkey ç¾¤å‘˜å®¹å™¨ä¸ºvalue
            var currentGroup = GroupUser.Groups.GetOrAdd(groupId, new UserConnection { });
            //å½“å‰ç”¨æˆ·åŠ å…¥å½“å‰ç¾¤ç»„
            _ = currentGroup.GetOrAdd(userId, webSocket);
            //åªæœ‰æœ‰å½“å‰WebSocketæœåŠ¡çš„ç¬¬ä¸€ä¸ªåŠ å…¥å½“å‰ç»„çš„æ—¶å€™æ‰å»è®¢é˜…ç¾¤ç»„é¢‘é“
            //å¦‚æœä¸é™åˆ¶çš„è¯åˆ™ä¼šå‡ºç°å¦‚æœå½“å‰WebSocketæœåŠ¡æœ‰å¤šä¸ªç”¨æˆ·åœ¨ä¸€ä¸ªç»„å†…åˆ™ä¼šé‡å¤æ”¶åˆ°redisæ¶ˆæ¯
            if (currentGroup.Count == 1)
            {
                //è®¢é˜…redisé¢‘é“
                await SubGroupMsg($"{groupPrefix}{groupId}");
            }
    
            _lock.Release();
    
            var buffer = new byte[1024 * 4];
            //é˜»å¡æ¥æ”¶WebSocketæ¶ˆæ¯
            var receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
            //æœåŠ¡ä¸é€€å‡ºçš„è¯åˆ™ä¸€ç›´ç­‰å¾…æ¥æ”¶
            while (webSocket.State == WebSocketState.Open)
            {
                try
                {
                    string msg = Encoding.UTF8.GetString(buffer[..receiveResult.Count]).TrimEnd('\0');
                    _logger.LogInformation($"group ã€{groupId}ã€‘ user ã€{userId}ã€‘ send:{msg}");
    
                    //ç»„è£…redisé¢‘é“å‘å¸ƒçš„æ¶ˆæ¯ï¼Œç›®æ ‡ä¸ºç¾¤ç»„æ ‡è¯†
                    ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = userId, ToId = groupId, Msg = msg };
                    //é€šè¿‡rediså‘å¸ƒæ¶ˆæ¯
                    _redisClient.Publish($"{groupPrefix}{groupId}", JsonConvert.SerializeObject(channelMsgBody));
    
                    receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, ex.Message);
                    break;
                }
            }
            //å¦‚æœå®¢æˆ·ç«¯é€€å‡ºåˆ™åœ¨å½“å‰ç¾¤ç»„é›†åˆåˆ é™¤å½“å‰ç”¨æˆ·
            _ = currentGroup.TryRemove(userId, out _);
            await webSocket.CloseAsync(receiveResult.CloseStatus.Value, receiveResult.CloseStatusDescription, CancellationToken.None);
        }
    
        private async Task SubGroupMsg(string channel)
        {
            var sub = _redisClient.Subscribe(channel, async (channel, data) => {
                ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
                byte[] sendByte = Encoding.UTF8.GetBytes($"group ã€{msgBody.ToId}ã€‘ user ã€{msgBody.FromId}ã€‘ send:{msgBody.Msg}");
    
                //åœ¨å½“å‰WebSocketæœåŠ¡å™¨æ‰¾åˆ°å½“å‰ç¾¤ç»„é‡Œçš„ç”¨æˆ·
                GroupUser.Groups.TryGetValue(msgBody.ToId, out var currentGroup);
                //å¾ªç¯å½“å‰WebSocketæœåŠ¡å™¨é‡Œçš„ç”¨æˆ·å‘é€æ¶ˆæ¯
                foreach (var user in currentGroup)
                {
                    //ä¸ç”¨ç»™è‡ªå·±å‘é€äº†
                    if (user.Key == msgBody.FromId)
                    {
                        continue;
                    }
    
                    if (user.Value.State == WebSocketState.Open)
                    {
                        await user.Value.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                    }
                }
            });
            //æŠŠå½“å‰é¢‘é“åŠ å…¥è®¢é˜…é›†åˆ
            _disposables.TryAdd(channel, sub);
        }
    }
    

è¿™é‡Œæ¶‰åŠåˆ°äº†`GroupUser`ç±»ï¼Œæ˜¯æ¥å­˜å‚¨ç¾¤ç»„å’Œç¾¤ç»„ç”¨æˆ·çš„å¯¹åº”å…³ç³»çš„ï¼Œå®šä¹‰å¦‚ä¸‹

    public class GroupUser
    {
        //keyä¸ºç¾¤ç»„çš„å”¯ä¸€æ ‡è¯†
        public ConcurrentDictionary<string, UserConnection> Groups = new ConcurrentDictionary<string, UserConnection>();
    }
    

æ¼”ç¤ºä¸€ä¸‹æŠŠä¸¤ä¸ªç”¨æˆ·æ·»åŠ åˆ°ä¸€ä¸ªç¾¤ç»„å†…ï¼Œç„¶åå‘é€æ¥æ”¶æ¶ˆæ¯çš„åœºæ™¯ï¼Œç”¨æˆ·u1å‘é€  
![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104153438475-1223876616.png)ç”¨æˆ·u2æ¥æ”¶![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104153455363-1447488437.png)

#### å‘é€æ‰€æœ‰äºº

å‘é€ç»™æ‰€æœ‰ç”¨æˆ·çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸ç”¨è€ƒè™‘åˆ°ç”¨æˆ·é™åˆ¶ï¼Œåªè¦ç”¨æˆ·è¿æ¥åˆ°äº†WebSocketé›†ç¾¤åˆ™éƒ½å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œå¤§è‡´å·¥ä½œæ–¹å¼å¦‚ä¸‹å›¾æ‰€ç¤º![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221104154355815-1462148144.png)è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå’±ä»¬ç›´æ¥çœ‹å®ç°ä»£ç ï¼Œé¦–å…ˆæ˜¯å®šä¹‰ä¸€ä¸ªåœ°å€ï¼Œç”¨äºå‘å¸ƒæ¶ˆæ¯

    //æŠŠç”¨æˆ·æ³¨å†Œè¿›å»
    [HttpGet("/chat/all/{id}")]
    public async Task ChatAll(string id)
    {
        if (HttpContext.WebSockets.IsWebSocketRequest)
        {
            _logger.LogInformation($"all user:{id}-{Request.HttpContext.Connection.RemoteIpAddress}:{Request.HttpContext.Connection.RemotePort} join");
    
            var webSocket = await HttpContext.WebSockets.AcceptWebSocketAsync();
            await _socketHandler.HandleAll(id, webSocket);
        }
        else
        {
            HttpContext.Response.StatusCode = StatusCodes.Status400BadRequest;
        }
    }
    

å…·ä½“çš„å®ç°é€»è¾‘è¿˜æ˜¯åœ¨HandleGroupç±»é‡Œï¼Œæ˜¯HandleAllæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹å…·ä½“å®ç°

    public class WebSocketHandler:IDisposable
    {
        private readonly UserConnection AllConnection = new();
        private readonly ConcurrentDictionary<string, IDisposable> _disposables = new();
        private readonly string all = "all";
    
        private readonly ILogger<WebSocketHandler> _logger;
        private readonly RedisClient _redisClient;
    
        public WebSocketHandler(ILogger<WebSocketHandler> logger, RedisClient redisClient)
        {
            _logger = logger;
            _redisClient = redisClient;
        }
    
        public async Task HandleAll(string id, WebSocket webSocket)
        {
            await _lock.WaitAsync();
            //æŠŠç”¨æˆ·åŠ å…¥ç”¨æˆ·é›†åˆ
            _ = AllConnection.GetOrAdd(id, webSocket);
            //WebSocketé›†ç¾¤ä¸­çš„æ¯ä¸ªæœåŠ¡åªå®šä¹‰ä¸€æ¬¡
            if (AllConnection.Count == 1)
            {
                await SubAllMsg(all);
            }
    
            _lock.Release();
    
            var buffer = new byte[1024 * 4];
            //é˜»å¡æ¥æ”¶ä¿¡æ¯
            var receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
            while (webSocket.State == WebSocketState.Open)
            {
                try
                {
                    string msg = Encoding.UTF8.GetString(buffer[..receiveResult.Count]).TrimEnd('\0');
                    _logger.LogInformation($"user {id} send:{msg}");
                    //è·å–æ¥æ”¶ä¿¡æ¯
                    ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = id, Msg = msg };
                    //æŠŠæ¶ˆæ¯é€šè¿‡rediså‘å¸ƒåˆ°é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡
                    _redisClient.Publish(all, JsonConvert.SerializeObject(channelMsgBody));
      
                    receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, ex.Message);
                    break;
                }
            }
            //ç”¨æˆ·é€€å‡ºåˆ™åˆ é™¤é›†åˆä¸­çš„å½“å‰ç”¨æˆ·ä¿¡æ¯
            _ = AllConnection.TryRemove(id, out _);
            await webSocket.CloseAsync(receiveResult.CloseStatus.Value, receiveResult.CloseStatusDescription, CancellationToken.None);
        }
    
        private async Task SubAllMsg(string channel)
        {
            var sub = _redisClient.Subscribe(channel, async (channel, data) => {
                ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
                byte[] sendByte = Encoding.UTF8.GetBytes($"user ã€{msgBody.FromId}ã€‘ send all:{msgBody.Msg}");
                //æ¥æ”¶åˆ°æ¶ˆæ¯åéå†ç”¨æˆ·é›†åˆæŠŠæ¶ˆæ¯å‘é€ç»™æ‰€æœ‰ç”¨æˆ·
                foreach (var user in AllConnection)
                {   
                    //å¦‚æœåŒ…å«å½“å‰ç”¨æˆ·è·³è¿‡
                    if (user.Key == msgBody.FromId)
                    {
                        continue;
                    }
    
                    if (user.Value.State == WebSocketState.Open)
                    {
                        await user.Value.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                    }
                }
            });
            _disposables.TryAdd(channel, sub);
        }
    }
    

æ•ˆæœåœ¨è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œå’Œç¾¤ç»„çš„æ•ˆæœæ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯ä¸€ä¸ªæ˜¯éƒ¨åˆ†ç”¨æˆ·ï¼Œä¸€ä¸ªæ˜¯å…¨éƒ¨çš„ç”¨æˆ·ã€‚

### æ•´åˆåˆ°ä¸€èµ·

ä¸Šé¢æˆ‘ä»¬åˆ†åˆ«å±•ç¤ºäº†ä¸€å¯¹ä¸€ã€ç¾¤ç»„ã€æ‰€æœ‰äººçš„åœºæ™¯ï¼Œä½†æ˜¯å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæ¯ä¸ªç”¨æˆ·åªéœ€è¦æ³¨å†Œåˆ°WebSocketé›†ç¾¤ä¸€æ¬¡ä¹Ÿå°±æ˜¯ä¿æŒä¸€ä¸ªè¿æ¥å³å¯ï¼Œè€Œä¸æ˜¯ä¸€å¯¹ä¸€ä¸€ä¸ªè¿æ¥ã€æ³¨å†Œç¾¤ç»„ä¸€ä¸ªè¿æ¥ã€æ‰€æœ‰æ¶ˆæ¯çš„æ—¶å€™ä¸€ä¸ªè¿æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æŠŠä¸Šé¢çš„æ¼”ç¤ºæ•´åˆä¸€ä¸‹ï¼Œä¸€ä¸ªç”¨æˆ·åªéœ€è¦è¿æ¥åˆ°WebSocketé›†ç¾¤ä¸€æ¬¡å³å¯ï¼Œè‡³äºå‘é€ç»™è°ï¼ŒåŠ å…¥ä»€ä¹ˆç¾¤ç»„ï¼Œæ¥æ”¶å…¨éƒ¨æ¶ˆæ¯ç­‰éƒ½æ˜¯è¿æ¥åé€šè¿‡ä¸€äº›æ ‡è¯†åŒºåˆ†çš„ï¼Œè€Œä¸å¿…æ¯ä¸ªç±»å‹çš„æ“ä½œéƒ½æ³¨å†Œä¸€æ¬¡ï¼Œå°±å’Œå¾®ä¿¡å’ŒQQä¸€æ ·æˆ‘åªè¦ç™»å½•äº†å³å¯ï¼Œè‡³äºå…¶ä»–æ“ä½œéƒ½æ˜¯é æ•°æ®æ ‡è¯†åŒºåˆ†çš„ã€‚æ¥ä¸‹æ¥å’±ä»¬å°±æ•´åˆä¸€ä¸‹ä»£ç è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œå¤§è‡´çš„æ€è·¯æ˜¯

*   ç”¨æˆ·è¿æ¥åˆ°WebSocketé›†ç¾¤ï¼ŒæŠŠç”¨æˆ·å’Œè¿æ¥ä¿å­˜åˆ°å½“å‰WebSocketæœåŠ¡å™¨çš„ç”¨æˆ·é›†åˆä¸­å»ã€‚
*   ä¸€å¯¹ä¸€å‘é€çš„æ—¶å€™ï¼Œåªéœ€è¦åœ¨å…·ä½“çš„æœåŠ¡å™¨ä¸­æ‰¾åˆ°å…·ä½“çš„å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
*   ç¾¤ç»„çš„æ—¶å€™ï¼Œå…ˆæŠŠå½“å‰ç”¨æˆ·æ ‡è¯†åŠ å…¥ç¾¤ç»„é›†åˆå³å¯ï¼Œæ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™æ ¹æ®ç¾¤ç»„é›†åˆé‡Œçš„ç”¨æˆ·æ ‡è¯†å»ç”¨æˆ·é›†åˆé‡Œå»æ‹¿å…·ä½“çš„WebSocketè¿æ¥å‘é€æ¶ˆæ¯
*   å…¨å‘˜æ¶ˆæ¯çš„æ—¶å€™ï¼Œç›´æ¥éå†é›†ç¾¤ä¸­çš„æ¯ä¸ªWebSocketæœåŠ¡é‡Œçš„ç”¨æˆ·é›†åˆé‡Œçš„WebSocketè¿æ¥è®­è¯å‘é€æ¶ˆæ¯

è¿™æ ·çš„è¯å°±ä¿è¯äº†æ¯ä¸ªå®¢æˆ·ç«¯ç”¨æˆ·åœ¨é›†ç¾¤ä¸­åªä¼šç»‘å®šä¸€ä¸ªè¿æ¥ï¼Œé¦–å…ˆè¿˜æ˜¯å•ç‹¬å®šä¹‰ä¸€ä¸ªactionï¼Œç”¨äºè®©å®¢æˆ·ç«¯ç”¨æˆ·è¿æ¥ä¸Šæ¥ï¼Œå…·ä½“å®ç°ä»£ç å¦‚ä¸‹æ‰€ç¤º

    public class WebSocketChannelController : ControllerBase
    {
        private readonly ILogger<WebSocketController> _logger;
        private readonly WebSocketChannelHandler _webSocketChannelHandler;
    
        public WebSocketChannelController(ILogger<WebSocketController> logger, WebSocketChannelHandler webSocketChannelHandler)
        {
            _logger = logger;
            _webSocketChannelHandler = webSocketChannelHandler;
        }
    
        //åªéœ€è¦æŠŠå½“å‰ç”¨æˆ·è¿æ¥åˆ°æœåŠ¡å³å¯
        [HttpGet("/chat/channel/{id}")]
        public async Task Channel(string id)
        {
            if (HttpContext.WebSockets.IsWebSocketRequest)
            {
                _logger.LogInformation($"user:{id}-{Request.HttpContext.Connection.RemoteIpAddress}:{Request.HttpContext.Connection.RemotePort} join");
    
                var webSocket = await HttpContext.WebSockets.AcceptWebSocketAsync();
                await _webSocketChannelHandler.HandleChannel(id, webSocket);
            }
            else
            {
                HttpContext.Response.StatusCode = StatusCodes.Status400BadRequest;
            }
        }
    }
    

æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹WebSocketChannelHandlerç±»çš„HandleChannelæ–¹æ³•å®ç°ï¼Œç”¨äºå¤„ç†ä¸åŒçš„æ¶ˆæ¯ï¼Œæ¯”å¦‚ä¸€å¯¹ä¸€ã€ç¾¤ç»„ã€å…¨å‘˜æ¶ˆæ¯ç­‰ä¸åŒç±»å‹çš„æ¶ˆæ¯

    public class WebSocketChannelHandler : IDisposable
    {
        //ç”¨äºå­˜å‚¨å½“å‰WebSocketæœåŠ¡å™¨é“¾æ¥ä¸Šæ¥çš„æ‰€æœ‰ç”¨æˆ·å¯¹åº”å…³ç³»
        private readonly UserConnection UserConnection = new();
        //ç”¨äºå­˜å‚¨ç¾¤ç»„å’Œç”¨æˆ·å…³ç³»ï¼Œç”¨æˆ·é›†åˆé‡‡ç”¨HashSetä¿è¯æ¯ä¸ªç”¨æˆ·åªåŠ å…¥ä¸€ä¸ªç¾¤ç»„ä¸€æ¬¡
        private readonly ConcurrentDictionary<string, HashSet<string>> GroupUser = new ConcurrentDictionary<string, HashSet<string>>();
        private readonly SemaphoreSlim _lock = new(1, 1);
        //å­˜æ”¾redisè®¢é˜…å®ä¾‹
        private readonly ConcurrentDictionary<string, IDisposable> _disposables = new();
    
        //ä¸€å¯¹ä¸€redisé¢‘é“å‰ç¼€
        private readonly string userPrefix = "user:";
        //ç¾¤ç»„redisé¢‘é“å‰ç¼€
        private readonly string groupPrefix = "group:";
        //å…¨å‘˜redisé¢‘é“
        private readonly string all = "all";
    
        private readonly ILogger<WebSocketHandler> _logger;
        private readonly RedisClient _redisClient;
    
        public WebSocketChannelHandler(ILogger<WebSocketHandler> logger, RedisClient redisClient)
        {
            _logger = logger;
            _redisClient = redisClient;
        }
    
        public async Task HandleChannel(string id, WebSocket webSocket)
        {
            await _lock.WaitAsync();
    
            //æ¯æ¬¡è¿æ¥è¿›æ¥å°±æ·»åŠ åˆ°ç”¨æˆ·é›†åˆ
            _ = UserConnection.GetOrAdd(id, webSocket);
            
            //æ¯ä¸ªWebSocketæœåŠ¡å®ä¾‹åªéœ€è¦è®¢é˜…ä¸€æ¬¡å…¨å‘˜æ¶ˆæ¯é¢‘é“
            await SubMsg($"{userPrefix}{id}");
            if (UserConnection.Count == 1)
            {
                await SubAllMsg(all);
            }
    
            _lock.Release();
            var buffer = new byte[1024 * 4];
            //æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
            var receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
    
            while (webSocket.State == WebSocketState.Open)
            {
                try
                {
                    string msg = Encoding.UTF8.GetString(buffer[..receiveResult.Count]).TrimEnd('\0');
                    //è¯»å–å®¢æˆ·ç«¯æ¶ˆæ¯
                    ChannelData channelData = JsonConvert.DeserializeObject<ChannelData>(msg);
                    //åˆ¤æ–­æ¶ˆæ¯ç±»å‹
                    switch (channelData.Method)
                    {
                        //ä¸€å¯¹ä¸€
                        case "One":
                            await HandleOne(id, channelData.MsgBody, receiveResult);
                            break;
                        //æŠŠç”¨æˆ·åŠ å…¥ç¾¤ç»„
                        case "UserGroup":
                            await AddUserGroup(id, channelData.Group, webSocket);
                            break;
                        //å¤„ç†ç¾¤ç»„æ¶ˆæ¯
                        case "Group":
                            await HandleGroup(channelData.Group, id, webSocket, channelData.MsgBody);
                            break;
                        //å¤„ç†å…¨å‘˜æ¶ˆæ¯
                        default:
                            await HandleAll(id, channelData.MsgBody);
                            break;
                    }
    
                    receiveResult = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);
                }
                catch (Exception ex)
                {
                    _logger.LogError(ex, ex.Message);
                    break;
                }
            }
    
            await webSocket.CloseAsync(receiveResult.CloseStatus.Value, receiveResult.CloseStatusDescription, CancellationToken.None);
    
            //åœ¨ç¾¤ç»„ä¸­ç§»é™¤å½“å‰ç”¨æˆ·
            foreach (var users in GroupUser.Values)
            {
                lock (users)
                {
                    users.Remove(id);
                }
            }
            //å½“å‰å®¢æˆ·ç«¯ç”¨æˆ·é€€å‡ºåˆ™ç§»é™¤è¿æ¥
            _ = UserConnection.TryRemove(id, out _);
            //å–æ¶ˆç”¨æˆ·é¢‘é“è®¢é˜…
            _disposables.Remove($"{userPrefix}{id}", out var sub);
            sub?.Dispose();
        }
    
        public void Dispose()
        {
            foreach (var disposable in _disposables)
            {
                disposable.Value.Dispose();
            }
    
            _disposables.Clear();
        }
    }
    

è¿™é‡Œæ¶‰åŠåˆ°äº†`ChannelData`ç±»æ˜¯ç”¨äºæ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯çš„ç±»æ¨¡æ¿ï¼Œå…·ä½“å®šä¹‰å¦‚ä¸‹

    public class ChannelData
    {
        //æ¶ˆæ¯ç±»å‹ æ¯”å¦‚ä¸€å¯¹ä¸€ ç¾¤ç»„ å…¨å‘˜
        public string Method { get; set; }
        //ç¾¤ç»„æ ‡è¯†
        public string Group { get; set; }
        //æ¶ˆæ¯ä½“
        public object MsgBody { get; set; }
    }
    

ç±»ä¸­å¹¶ä¸ä¼šåŒ…å«å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼Œå› ä¸ºè¿æ¥åˆ°å½“å‰æœåŠ¡çš„æ—¶å€™å·²ç»æä¾›äº†å®¢æˆ·ç«¯å”¯ä¸€æ ‡è¯†ã€‚ç»“åˆä¸Šé¢çš„å¤„ç†ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå®¢æˆ·ç«¯ç”¨æˆ·è¿æ¥åˆ°WebSocketå®ä¾‹ä¹‹åï¼Œå…ˆæ³¨å†Œå½“å‰ç”¨æˆ·çš„redisè®¢é˜…é¢‘é“å¹¶ä¸”å½“å‰å®ä¾‹ä»…æ³¨å†Œä¸€æ¬¡å…¨å‘˜æ¶ˆæ¯çš„redisé¢‘é“ï¼Œç”¨äºå¤„ç†éå½“å‰å®ä¾‹æ³¨å†Œå®¢æˆ·ç«¯çš„ä¸€å¯¹ä¸€æ¶ˆæ¯å¤„ç†å’Œå…¨å‘˜æ¶ˆæ¯å¤„ç†ï¼Œç„¶åç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯æ¶ˆæ¯çš„æ¶ˆæ¯ç±»å‹æ¥åˆ¤æ–­æ˜¯è¿›è¡Œä¸€å¯¹ä¸€ã€ç¾¤ç»„ã€æˆ–è€…å…¨å‘˜çš„æ¶ˆæ¯ç±»å‹å¤„ç†ï¼Œå®ƒçš„å·¥ä½œæµç¨‹å…¥ä¸‹å›¾æ‰€ç¤º![](https://img2022.cnblogs.com/blog/2042116/202211/2042116-20221107130718001-40236075.png)ç”±ä»£ç å’Œä¸Šé¢çš„æµç¨‹å›¾å¯çŸ¥ï¼Œå®ƒæ ¹æ®ä¸åŒçš„æ ‡è¯†å»å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æ¯ç§æ¶ˆæ¯ç±»å‹çš„å¤„ç†æ–¹å¼ã€‚

#### ä¸€å¯¹ä¸€å¤„ç†

é¦–å…ˆæ˜¯ä¸€å¯¹ä¸€çš„æ¶ˆæ¯å¤„ç†æƒ…å†µï¼Œçœ‹ä¸€ä¸‹å…·ä½“çš„å¤„ç†é€»è¾‘ï¼Œé¦–å…ˆæ˜¯ä¸€å¯¹ä¸€å‘å¸ƒæ¶ˆæ¯

     private async Task HandleOne(string id, object msg, WebSocketReceiveResult receiveResult)
     {
        MsgBody msgBody = JsonConvert.DeserializeObject<MsgBody>(JsonConvert.SerializeObject(msg));
        byte[] sendByte = Encoding.UTF8.GetBytes($"user {id} send:{msgBody.Msg}");
        _logger.LogInformation($"user {id} send:{msgBody.Msg}");
    
        //åˆ¤æ–­ç›®æ ‡ç”¨æˆ·æ˜¯å¦åœ¨å½“å‰WebSocketæœåŠ¡å™¨
        if (UserConnection.TryGetValue(msgBody.Id, out var targetSocket))
        {
            if (targetSocket.State == WebSocketState.Open)
            {
                await targetSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), receiveResult.MessageType, true, CancellationToken.None);
            }
        }
        else
        {
            //å¦‚æœä¸åœ¨å½“å‰æœåŠ¡å™¨ï¼Œåˆ™ç›´æ¥æŠŠæ¶ˆæ¯å‘å¸ƒåˆ°å…·ä½“çš„ç”¨æˆ·é¢‘é“å»ï¼Œç”±å…·ä½“ç”¨æˆ·å»è®¢é˜…
            ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = id, ToId = msgBody.Id, Msg = msgBody.Msg };
            _redisClient.Publish($"{userPrefix}{msgBody.Id}", JsonConvert.SerializeObject(channelMsgBody));
        }
    }
    

æ¥ä¸‹æ¥æ˜¯ç”¨äºå¤„ç†è®¢é˜…å…¶ä»–ç”¨æˆ·å‘é€è¿‡æ¥æ¶ˆæ¯çš„é€»è¾‘ï¼Œè¿™ä¸ªå’Œæ•´åˆä¹‹å‰çš„é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œåœ¨å½“å‰æœåŠ¡å™¨ä¸­æ‰¾åˆ°ç”¨æˆ·å¯¹åº”çš„è¿æ¥ï¼Œå‘é€æ¶ˆæ¯

    private async Task SubMsg(string channel)
    {
        var sub = _redisClient.Subscribe(channel, async (channel, data) =>
        {
            ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
            byte[] sendByte = Encoding.UTF8.GetBytes($"user {msgBody.FromId} send:{msgBody.Msg}");
            if (UserConnection.TryGetValue(msgBody.ToId, out var targetSocket))
            {
                if (targetSocket.State == WebSocketState.Open)
                {
                    await targetSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                }
                else
                {
                    _ = UserConnection.TryRemove(msgBody.FromId, out _);
                }
            }
        });
        //æŠŠè®¢é˜…å®ä¾‹åŠ å…¥é›†åˆ
        _disposables.TryAdd(channel, sub);
    }
    

å¦‚æœç»™æŸä¸ªç”¨æˆ·å‘é€æ¶ˆæ¯åˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æ¶ˆæ¯æ ¼å¼

    {"Method":"One", "MsgBody":{"Id":"2","Msg":"Hello"}}
    

Methodä¸ºOneä»£è¡¨ç€æ˜¯ç§èŠä¸€å¯¹ä¸€çš„æƒ…å†µï¼Œæ¶ˆæ¯ä½“å†…Idä¸ºè¦å‘é€ç»™çš„å…·ä½“ç”¨æˆ·æ ‡è¯†å’Œæ¶ˆæ¯ä½“ã€‚

#### ç¾¤ç»„å¤„ç†

æ¥ä¸‹æ¥çœ‹ç¾¤ç»„å¤„ç†æ–¹å¼ï¼Œè¿™ä¸ªå’Œä¹‹å‰çš„é€»è¾‘æ˜¯æœ‰å‡ºå…¥çš„ï¼Œé¦–å…ˆæ˜¯ç”¨æˆ·è¦å…ˆåŠ å…¥åˆ°æŸä¸ªç¾¤ç»„ç„¶åæ‰èƒ½æ¥æ”¶ç¾¤ç»„æ¶ˆæ¯æˆ–è€…åœ¨ç¾¤ç»„ä¸­å‘é€æ¶ˆæ¯ï¼Œä¹‹å‰æ˜¯ä¸€ä¸ªç”¨æˆ·å¯¹åº”å¤šä¸ªè¿æ¥ï¼Œæ•´åˆäº†ä¹‹åé›†ç¾¤ä¸­æ¯ä¸ªç”¨æˆ·åªå…³è”å”¯ä¸€çš„ä¸€ä¸ªWebSocketè¿æ¥ï¼Œé¦–å…ˆçœ‹ç”¨æˆ·åŠ å…¥ç¾¤ç»„çš„é€»è¾‘

    private async Task AddUserGroup(string user, string group, WebSocket webSocket)
    {
        //è·å–ç¾¤ç»„ä¿¡æ¯
        var currentGroup = GroupUser.GetOrAdd(group, new HashSet<string>());
    
        lock (currentGroup)
        {
           //æŠŠç”¨æˆ·æ ‡è¯†åŠ å…¥å½“å‰ç»„
            _ = currentGroup.Add(user);
        }
    
        //æ¯ä¸ªç»„çš„redisé¢‘é“ï¼Œåœ¨æ¯å°WebSocketæœåŠ¡å™¨å®ä¾‹åªæ³¨å†Œä¸€æ¬¡è®¢é˜…
        if (currentGroup.Count == 1)
        {
            //è®¢é˜…å½“å‰ç»„æ¶ˆæ¯
            await SubGroupMsg($"{groupPrefix}{group}");
        }
        
        string addMsg = $"user ã€{user}ã€‘ add  to group ã€{group}ã€‘";
        byte[] sendByte = Encoding.UTF8.GetBytes(addMsg);
        await webSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
        //å¦‚æœæœ‰ç”¨æˆ·åŠ å…¥ç¾¤ç»„ï¼Œåˆ™é€šçŸ¥å…¶ä»–ç¾¤æˆå‘˜
        ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = user, ToId = group, Msg = addMsg };
        _redisClient.Publish($"{groupPrefix}{group}", JsonConvert.SerializeObject(channelMsgBody));
    }
    

ç”¨æˆ·æƒ³è¦åœ¨ç¾¤ç»„å†…å‘æ¶ˆæ¯ï¼Œåˆ™å¿…é¡»å…ˆåŠ å…¥åˆ°ä¸€ä¸ªå…·ä½“çš„ç¾¤ç»„å†…ï¼Œå…·ä½“çš„åŠ å…¥ç¾¤ç»„çš„æ ¼å¼å¦‚ä¸‹

    {"Method":"UserGroup", "Group":"g1"}
    

Methodä¸ºUserGroupä»£è¡¨ç€ç”¨æˆ·åŠ å…¥ç¾¤ç»„çš„ä¸šåŠ¡ç±»å‹ï¼ŒGroupä»£è¡¨ç€ä½ è¦åŠ å…¥çš„ç¾¤ç»„å”¯ä¸€æ ‡è¯†ã€‚æ¥ä¸‹æ¥å°±çœ‹ä¸‹ï¼Œç”¨æˆ·å‘é€ç¾¤ç»„æ¶ˆæ¯çš„é€»è¾‘äº†

    private async Task HandleGroup(string groupId, string userId, WebSocket webSocket, object msgBody)
    {
        //åˆ¤æ–­ç¾¤ç»„æ˜¯å¦å­˜åœ¨
        var hasValue = GroupUser.TryGetValue(groupId, out var users);
        if (!hasValue)
        {
            byte[] sendByte = Encoding.UTF8.GetBytes($"groupã€{groupId}ã€‘ not exists");
            await webSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
            return;
        }
    
        //åªæœ‰åŠ å…¥åˆ°å½“å‰ç¾¤ç»„ï¼Œæ‰èƒ½åœ¨ç¾¤ç»„å†…å‘é€æ¶ˆæ¯
        if (!users.Contains(userId))
        {
            byte[] sendByte = Encoding.UTF8.GetBytes($"user ã€{userId}ã€‘ not in ã€{groupId}ã€‘");
            await webSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
            return;
        }
    
        _logger.LogInformation($"group ã€{groupId}ã€‘ user ã€{userId}ã€‘ send:{msgBody}");
    
        //å‘é€ç¾¤ç»„æ¶ˆæ¯
        ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = userId, ToId = groupId, Msg = msgBody.ToString() };
        _redisClient.Publish($"{groupPrefix}{groupId}", JsonConvert.SerializeObject(channelMsgBody));
    }
    

åŠ å…¥ç¾¤ç»„ä¹‹ååˆ™å¯ä»¥å‘é€å’Œæ¥æ”¶ç¾¤ç»„å†…çš„æ¶ˆæ¯äº†ï¼Œç»™ç¾¤ç»„å‘é€æ¶ˆæ¯çš„æ ¼å¼å¦‚ä¸‹

    {"Method":"Group", "Group":"g1", "MsgBody":"Hi All"}
    

Methodä¸ºGroupä»£è¡¨ç€ç”¨æˆ·åŠ å…¥ç¾¤ç»„çš„ä¸šåŠ¡ç±»å‹ï¼ŒGroupåˆ™ä»£è¡¨ä½ è¦å‘é€åˆ°å…·ä½“çš„ç¾¤ç»„çš„å”¯ä¸€æ ‡è¯†ï¼ŒMsgBodyåˆ™æ˜¯å‘é€åˆ°ç¾¤ç»„å†…çš„æ¶ˆæ¯ã€‚æœ€åå†æ¥çœ‹ä¸‹è®¢é˜…ç¾¤ç»„å†…æ¶ˆæ¯çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯å¤„ç†ç¾¤ç»„æ¶ˆæ¯çš„é€»è¾‘

    private async Task SubGroupMsg(string channel)
    {
        var sub = _redisClient.Subscribe(channel, async (channel, data) =>
        {
            //æ¥æ”¶ç¾¤ç»„è®¢é˜…æ¶ˆæ¯
            ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
            byte[] sendByte = Encoding.UTF8.GetBytes($"group ã€{msgBody.ToId}ã€‘ user ã€{msgBody.FromId}ã€‘ send:{msgBody.Msg}");
            
            //è·å–å½“å‰æœåŠ¡å™¨å®ä¾‹ä¸­å½“å‰ç¾¤ç»„çš„æ‰€æœ‰ç”¨æˆ·è¿æ¥
            GroupUser.TryGetValue(msgBody.ToId, out var currentGroup);
            foreach (var user in currentGroup)
            {
                if (user == msgBody.FromId)
                {
                    continue;
                }
                
                //é€šè¿‡ç¾¤ç»„å†…çš„ç”¨æˆ·æ ‡è¯†å»ç”¨æˆ·é›†åˆè·å–ç”¨æˆ·é›†åˆé‡Œçš„ç”¨æˆ·å”¯ä¸€è¿æ¥å‘é€æ¶ˆæ¯
                if (UserConnection.TryGetValue(user, out var targetSocket) && targetSocket.State == WebSocketState.Open)
                {
                    await targetSocket.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                }
                else
                {
                    currentGroup.Remove(user);
                }
            }
        });
        _disposables.TryAdd(channel, sub);
    }
    

#### å…¨å‘˜æ¶ˆæ¯å¤„ç†

å…¨å‘˜æ¶ˆæ¯å¤„ç†ç›¸å¯¹æ¥è¯´æ€è·¯æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºå½“æœåŠ¡å¯åŠ¨çš„æ—¶å€™å°±ä¼šç›‘å¬redisçš„å…¨å‘˜æ¶ˆæ¯é¢‘é“ï¼Œè¿™æ ·çš„è¯å…·ä½“çš„å®ç°ä¹Ÿå°±åªåŒ…å«å‘é€å’Œæ¥æ”¶å…¨å‘˜æ¶ˆæ¯äº†ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹å…¨å‘˜æ¶ˆæ¯å‘é€çš„é€»è¾‘

    private async Task HandleAll(string id, object msgBody)
    {
        _logger.LogInformation($"user {id} send:{msgBody}");
    
        //ç›´æ¥ç»™redisçš„å…¨å‘˜é¢‘é“å‘é€æ¶ˆæ¯
        ChannelMsgBody channelMsgBody = new ChannelMsgBody { FromId = id, Msg = msgBody.ToString() };
        _redisClient.Publish(all, JsonConvert.SerializeObject(channelMsgBody));
    }
    

å…¨å‘˜æ¶ˆæ¯çš„å‘é€æ•°æ®æ ¼å¼å¦‚ä¸‹æ‰€ç¤º

    {"Method":"All", "MsgBody":"Hello All"}
    

Methodä¸ºAllä»£è¡¨ç€å…¨å‘˜æ¶ˆæ¯ç±»å‹ï¼ŒMsgBodyåˆ™ä»£è¡¨ç€å…·ä½“æ¶ˆæ¯ã€‚æ¥æ”¶æ¶ˆæ¯å‡ºé‡ŒåŒæ ·å¾ˆç®€å•ï¼Œè®¢é˜…rediså…¨å‘˜æ¶ˆæ¯é¢‘é“ï¼Œç„¶åéå†å½“å‰WebSocketæœåŠ¡å™¨å®ä¾‹å†…çš„æ‰€æœ‰ç”¨æˆ·è·å–è¿æ¥å‘é€æ¶ˆæ¯ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹

    private async Task SubAllMsg(string channel)
    {
        var sub = _redisClient.Subscribe(channel, async (channel, data) =>
        {
            ChannelMsgBody msgBody = JsonConvert.DeserializeObject<ChannelMsgBody>(data.ToString());
            byte[] sendByte = Encoding.UTF8.GetBytes($"user ã€{msgBody.FromId}ã€‘ send all:{msgBody.Msg}");
            //è·å–å½“å‰æœåŠ¡å™¨å®ä¾‹å†…æ‰€æœ‰ç”¨æˆ·çš„è¿æ¥
            foreach (var user in UserConnection)
            {
                //ä¸ç»™è‡ªå·±å‘é€æ¶ˆæ¯ï¼Œå› ä¸ºå‘é€çš„æ—¶å€™å¯ä»¥é€šè¿‡å…·ä½“çš„ä¸šåŠ¡ä»£ç å¤„ç†
                if (user.Key == msgBody.FromId)
                {
                    continue;
                }
                
                //ç»™æ¯ä¸ªç”¨æˆ·å‘é€æ¶ˆæ¯
                if (user.Value.State == WebSocketState.Open)
                {
                    await user.Value.SendAsync(new ArraySegment<byte>(sendByte, 0, sendByte.Length), WebSocketMessageType.Text, true, CancellationToken.None);
                }
                else
                {
                    _ = UserConnection.TryRemove(user.Key, out _);
                }
            }
        });
        _disposables.TryAdd(channel, sub);
    }
    

### ç¤ºä¾‹æºç 

ç”±äºç¯‡å¹…æœ‰é™ï¼Œæ²¡åŠæ³•è®¾è®¡åˆ°å…¨éƒ¨çš„ç›¸å…³æºç ï¼Œå› æ­¤åœ¨è¿™é‡Œè´´å‡ºæ¥`github`ç›¸å…³çš„åœ°å€ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥çœ‹å’Œè¿è¡Œæºç ã€‚ç›¸å…³çš„æºç æˆ‘è¿™é‡Œå®ç°äº†ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯åŸºäºasp.net coreçš„ç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯åŸºäºgolangçš„ç‰ˆæœ¬ã€‚ä¸¤ä»½æºç çš„å®ç°æ€è·¯æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥è¿™ä¸¤ä»½ä»£ç å¯ä»¥è¿è¡Œåœ¨ä¸€å¥—é›†ç¾¤ç¤ºä¾‹é‡Œï¼Œé…ç½®åœ¨ä¸€å¥—nginxé‡Œï¼Œå¹¶ä¸”è¿æ¥åˆ°åŒä¸€ä¸ªrediså®ä¾‹é‡Œå³å¯

*   `asp.net core`æºç ç¤ºä¾‹ [https://github.com/softlgl/WebsocketCluster](https://github.com/softlgl/WebsocketCluster)
*   `golang`æºç ç¤ºä¾‹ [https://github.com/softlgl/websocket-cluster](https://github.com/softlgl/websocket-cluster)

ä»“åº“é‡Œè¿˜æ¶‰åŠåˆ°æœ¬äººé—²æš‡ä¹‹ä½™å¼€æºçš„å…¶ä»–ä»“åº“ï¼Œç”±äºæœ¬äººèƒ½åŠ›æœ‰é™éš¾ç™»å¤§é›…ä¹‹å ‚ï¼Œå°±ä¸åšå¹¿å‘Šäº†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡Œæµè§ˆä¸€ä¸‹ã€‚

### æ€»ç»“

Â Â Â Â æœ¬æ–‡åŸºäº`ASP.NET Core`æ¡†æ¶æä¾›äº†ä¸€ä¸ªåŸºäº`WebSocket`åšé›†ç¾¤çš„ç¤ºä¾‹ï¼Œç”±äºæ€æƒ³æ˜¯é€šç”¨çš„ï¼Œæ‰€ä»¥åŸºäºè¿™ä¸ªæ€è·¯æ¥¼ä¸»ä¹Ÿå®ç°äº†`golang`ç‰ˆæœ¬ã€‚å…¶å®åœ¨ä¹‹å‰å°±æƒ³è‡ªå·±åŠ¨æ‰‹æä¸€æå…³äºWebSocketé›†ç¾¤æ–¹é¢çš„è®¾è®¡ï¼Œæœ¬ç¯‡æ–‡ç« ç®—æ˜¯å¯¹ä¹‹å‰æƒ³æ³•çš„ä¸€ä¸ªè½åœ°æ“ä½œã€‚å…¶æ ¸å¿ƒæ€è·¯æ–‡ç« å·²ç»åšäº†ç›¸å…³ä»‹ç»ï¼Œç”±äºè¿™äº›åªæ˜¯åšä¸»å…³äºæ„æ€çš„å®ç°ï¼Œå¯èƒ½æœ‰å¾ˆå¤šç»†èŠ‚å°šæœªä½“ç°åˆ°ï¼Œè¿˜å¸Œæœ›å¤§å®¶å¤šå¤šç†è§£ã€‚å…¶æ ¸å¿ƒæ€è·¯æ€»ç»“ä¸€ä¸‹

*   é¦–å…ˆæ˜¯ï¼Œåˆ©ç”¨å¯ä»¥æ„å»ºWebSocketæœåŠ¡çš„æ¡†æ¶ï¼Œåœ¨å½“å‰æœåŠ¡å®ä¾‹ä¸­ä¿å­˜å½“å‰å®¢æˆ·ç«¯ç”¨æˆ·å’ŒWebSocketçš„è¿æ¥å…³ç³»
*   å¦‚æœæ¶ˆæ¯çš„ç›®æ ‡å®¢æˆ·ç«¯ä¸åœ¨å½“å‰æœåŠ¡å™¨ï¼Œå¯ä»¥åˆ©ç”¨redisé¢‘é“ã€æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³ã€ç”šè‡³æ˜¯æ•°æ®åº“ç±»çš„å…±äº«å›è¯å‘é€çš„æ¶ˆæ¯ï¼Œç”±ç›®æ ‡æœåŠ¡å™¨è·å–ç›®æ ‡æ˜¯å¦å±äºè‡ªå·±çš„wsä¼šè¯
*   æœ¬æ–‡è®¾è®¡çš„æ€è·¯ä½¿ç”¨çš„æ˜¯æ— çŠ¶æ€çš„æ–¹å¼ï¼Œå³WebSocketæœåŠ¡å®ä¾‹ä¹‹é—´ä¸å­˜åœ¨ç›´æ¥çš„æ¶ˆæ¯é€šä¿¡å’Œç›¸äº’çš„æœåŠ¡åœ°å€å­˜å‚¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åˆ©ç”¨redisç­‰å­˜å‚¨åœ¨çº¿ç”¨æˆ·ä¿¡æ¯ç­‰ï¼Œè¿™ä¸ªå¯ä»¥å‚è€ƒå…·ä½“ä¸šåŠ¡è‡ªè¡Œè®¾è®¡

è¯»ä¸‡å·ä¹¦,è¡Œä¸‡é‡Œè·¯ã€‚åœ¨è¿™ä¸ªæ—¶åˆ»éƒ½åœ¨å˜åŒ–ç‚¹çš„ç¯å¢ƒé‡Œï¼Œå”¯æœ‰ä¸æ–­çš„è¿›åŒ–è‡ªå·±ï¼Œå¤šæ¥è§¦å¤šå°è¯•ä¸ç”¨çš„äº‹ç‰©ï¼Œå¤šæ‰©å±•è‡ªå·±çš„è®¤çŸ¥æ€ç»´ï¼Œæ–¹èƒ½æ„å»ºè‡ªå·±çš„åº•å±‚é€»è¾‘ã€‚æ¯•ç«Ÿè¶Šåº•å±‚è¶ŠæŠ½è±¡ï¼Œè¶Šé€šç”¨è¶ŠæŠ½è±¡ã€‚é¢å¯¹æœªçŸ¥çš„æŒ‘æˆ˜ï¼Œè‡ªèº«ä½œä¸ºè‡ªå·±åšå¼ºçš„åç›¾ï¼Œå¯èƒ½æ‰ä¼šè®©è‡ªå·±æ›´è¸å®ã€‚  
  

ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡ ![](https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png)