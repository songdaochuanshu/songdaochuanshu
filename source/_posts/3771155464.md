---
layout: post
title: "Velero ç³»åˆ—æ–‡ç« ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€"
date: "2022-12-09T08:21:00.622Z"
---
Velero ç³»åˆ—æ–‡ç« ï¼ˆä¸€ï¼‰ï¼šåŸºç¡€
=================

æ¦‚è¿°
--

![Velero](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221209092017896-735664365.svg)

Velero æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·ï¼Œå¯ä»¥å®‰å…¨åœ°å¤‡ä»½å’Œè¿˜åŸï¼Œæ‰§è¡Œç¾éš¾æ¢å¤ä»¥åŠè¿ç§» Kubernetes é›†ç¾¤èµ„æºå’ŒæŒä¹…å·ã€‚

### ç¾éš¾æ¢å¤

Velero å¯ä»¥åœ¨åŸºç¡€æ¶æ„ä¸¢å¤±ï¼Œæ•°æ®æŸåå’Œ/æˆ–æœåŠ¡ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œå‡å°‘æ¢å¤æ—¶é—´ã€‚

### æ•°æ®è¿ç§»

Velero é€šè¿‡è½»æ¾åœ°å°† Kubernetes èµ„æºä»ä¸€ä¸ªé›†ç¾¤è¿ç§»åˆ°å¦ä¸€ä¸ªé›†ç¾¤æ¥å®ç°é›†ç¾¤å¯ç§»æ¤æ€§

### æ•°æ®ä¿æŠ¤

æä¾›å…³é”®æ•°æ®ä¿æŠ¤åŠŸèƒ½ï¼Œä¾‹å¦‚å®šæ—¶è®¡åˆ’çš„å¤‡ä»½ï¼Œä¿ç•™è®¡åˆ’ä»¥åŠè‡ªå®šä¹‰æ“ä½œçš„å¤‡ä»½å‰æˆ–å¤‡ä»½åé’©å­ã€‚

### å¤‡ä»½é›†ç¾¤

ä½¿ç”¨ namespace resources æˆ– label selector å¤‡ä»½æ•´ä¸ªé›†ç¾¤æˆ–éƒ¨åˆ†é›†ç¾¤çš„ Kubernetes èµ„æºå’Œå·ã€‚

### å®šæœŸå¤‡ä»½

è®¾ç½®è®¡åˆ’ä»¥å®šæœŸé—´éš”è‡ªåŠ¨å¯åŠ¨å¤‡ä»½ã€‚

### å¤‡ä»½é’©å­

é…ç½®å¤‡ä»½å‰å’Œå¤‡ä»½åé’©å­ï¼Œä»¥åœ¨ Velero å¤‡ä»½ä¹‹å‰å’Œä¹‹åæ‰§è¡Œè‡ªå®šä¹‰æ“ä½œã€‚

å®‰è£… - åŸºæœ¬å®‰è£…
---------

### å‰æ

*   åœ¨å¯ç”¨ DNS å’Œå®¹å™¨è”ç½‘çš„æƒ…å†µä¸‹è®¿é—® Kubernetes é›†ç¾¤ v1.16 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
*   `kubectl`æœ¬åœ°å®‰è£…

Velero ä½¿ç”¨å¯¹è±¡å­˜å‚¨æ¥å­˜å‚¨å¤‡ä»½å’Œå…³è”çš„å·¥ä»¶ã€‚ å®ƒè¿˜å¯ä»¥é€‰æ‹©ä¸å—æ”¯æŒçš„å—å­˜å‚¨ç³»ç»Ÿé›†æˆï¼Œä»¥å¯¹æ‚¨çš„æŒä¹…å·è¿›è¡Œå¿«ç…§ã€‚ åœ¨å¼€å§‹å®‰è£…è¿‡ç¨‹ä¹‹å‰ï¼Œæ‚¨åº”è¯¥ä» [å…¼å®¹çš„æä¾›ç¨‹åºåˆ—è¡¨](https://velero.io/docs/v1.8/supported-providers/) ä¸­è¯†åˆ«å°†è¦ä½¿ç”¨çš„å¯¹è±¡å­˜å‚¨æä¾›ç¨‹åºå’Œå¯é€‰çš„å—å­˜å‚¨æä¾›ç¨‹åºã€‚

Velero æ”¯æŒäº‘æä¾›å•†ç¯å¢ƒå’Œæœ¬åœ°ç¯å¢ƒçš„å­˜å‚¨æä¾›å•†ã€‚ æœ‰å…³å†…éƒ¨éƒ¨ç½²æ–¹æ¡ˆçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [å†…éƒ¨éƒ¨ç½²æ–‡æ¡£](https://velero.io/docs/v1.8/on-premises/)

### å®‰è£… CLI

1.  ä¸‹è½½é€‚ç”¨äºæ‚¨çš„å®¢æˆ·ç«¯å¹³å°çš„ [æœ€æ–°ç‰ˆæœ¬](https://github.com/vmware-tanzu/velero/releases/latest) çš„ tarballã€‚
2.  è§£å‹ tarball: `tar -xvf <RELEASE-TARBALL-NAME>.tar.gz`
3.  å°†è§£å‹åçš„`velero`æ”¾åˆ°`$PATH`ï¼ˆä¸€èˆ¬æ˜¯`/usr/local/bin`)

### å®‰è£…é…ç½® server ç«¯ç»„ä»¶

æœ‰ä¸¤ç§æ”¯æŒçš„æ–¹æ³•æ¥å®‰è£… Velero æœåŠ¡å™¨ç»„ä»¶ï¼š

*   `velero install` CLI å‘½ä»¤
*   [Helm Chart](https://vmware-tanzu.github.io/helm-charts/)

Velero ä½¿ç”¨å­˜å‚¨æä¾›ç¨‹åºæ’ä»¶ä¸å„ç§å­˜å‚¨ç³»ç»Ÿé›†æˆï¼Œä»¥æ”¯æŒå¤‡ä»½å’Œå¿«ç…§æ“ä½œã€‚ å®‰è£…å’Œé…ç½® Velero æœåŠ¡å™¨ç»„ä»¶ä»¥åŠç›¸åº”æ’ä»¶çš„æ­¥éª¤ç‰¹å®šäºæ‚¨é€‰æ‹©çš„å­˜å‚¨æä¾›å•†ã€‚ è¦æŸ¥æ‰¾æ‚¨é€‰æ‹©çš„å­˜å‚¨æä¾›å•†çš„å®‰è£…è¯´æ˜ï¼Œè¯·åœ¨ [æ”¯æŒçš„å­˜å‚¨æä¾›å•†](https://velero.io/docs/v1.8/supported-providers/) é¡µé¢ä¸Šè®¿é—®æä¾›å•†çš„æ–‡æ¡£é“¾æ¥ã€‚

> ğŸ“ æ³¨æ„ï¼š
> 
> å¦‚æœæ‚¨çš„å¯¹è±¡å­˜å‚¨æä¾›ç¨‹åºä¸å·å¿«ç…§æä¾›ç¨‹åºä¸åŒï¼Œè¯·é¦–å…ˆæŒ‰ç…§å¯¹è±¡å­˜å‚¨æä¾›ç¨‹åºçš„å®‰è£…è¯´æ˜è¿›è¡Œæ“ä½œï¼Œç„¶åè¿”å›æ­¤å¤„å¹¶æŒ‰ç…§è¯´æ˜æ·»åŠ  [å·å¿«ç…§æä¾›ç¨‹åº](https://velero.io/docs/v1.8/customize-installation/)ã€‚

### å‘½ä»¤è¡Œè‡ªåŠ¨è¡¥å…¨

[https://velero.io/docs/v1.8/customize-installation/#enabling-shell-autocompletion](https://velero.io/docs/v1.8/customize-installation/#enabling-shell-autocompletion)

å®‰è£… - å®šåˆ¶åŒ–å®‰è£…
----------

[https://velero.io/docs/v1.8/customize-installation/](https://velero.io/docs/v1.8/customize-installation/)

å®‰è£… - æä¾›å•†
--------

Velero æ”¯æŒå„ç§å­˜å‚¨æä¾›ç¨‹åºï¼Œä»¥è¿›è¡Œä¸åŒçš„å¤‡ä»½å’Œå¿«ç…§æ“ä½œã€‚ Velero æœ‰ä¸€ä¸ªæ’ä»¶ç³»ç»Ÿï¼Œå®ƒå…è®¸ä»»ä½•äººåœ¨ä¸ä¿®æ”¹ Velero ä»£ç åº“çš„æƒ…å†µä¸‹å¢åŠ å¯¹å…¶ä»–å¤‡ä»½å’Œå·å­˜å‚¨å¹³å°çš„å…¼å®¹æ€§ã€‚

### Velero æ”¯æŒçš„æä¾›å•†

æä¾›å•†

å¯¹è±¡å­˜å‚¨

å·å¿«ç…§

æ’ä»¶æä¾›å•† Repo

å®‰è£…è¯´æ˜

[Amazon Web Services (AWS)](https://aws.amazon.com/)

AWS S3

AWS EBS

[Velero plugin for AWS](https://github.com/vmware-tanzu/velero-plugin-for-aws)

[AWS Plugin Setup](https://github.com/vmware-tanzu/velero-plugin-for-aws#setup)

[Google Cloud Platform (GCP)](https://cloud.google.com/)

Google Cloud Storage

Google Compute Engine Disks

[Velero plugin for GCP](https://github.com/vmware-tanzu/velero-plugin-for-gcp)

[GCP Plugin Setup](https://github.com/vmware-tanzu/velero-plugin-for-gcp#setup)

[Microsoft Azure](https://azure.com/)

Azure Blob Storage

Azure Managed Disks

[Velero plugin for Microsoft Azure](https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure)

[Azure Plugin Setup](https://github.com/vmware-tanzu/velero-plugin-for-microsoft-azure#setup)

[VMware vSphere](https://www.vmware.com/ca/products/vsphere.html)

ğŸš«

vSphere Volumes

[VMware vSphere](https://github.com/vmware-tanzu/velero-plugin-for-vsphere)

[vSphere Plugin Setup](https://github.com/vmware-tanzu/velero-plugin-for-vsphere#velero-plugin-for-vsphere-installation-and-configuration-details)

[Container Storage Interface (CSI)](https://kubernetes.io/blog/2019/01/15/container-storage-interface-ga/)

ğŸš«

CSI Volumes

[Velero plugin for CSI](https://github.com/vmware-tanzu/velero-plugin-for-csi/)

[CSI Plugin Setup](https://github.com/vmware-tanzu/velero-plugin-for-csi#kinds-of-plugins-included)

### ç¤¾åŒºæ”¯æŒçš„æä¾›å•†

Provider

Object Store

Volume Snapshotter

Plugin Documentation

Contact

[AlibabaCloud](https://www.alibabacloud.com/)

Alibaba Cloud OSS

Alibaba Cloud

[AlibabaCloud](https://github.com/AliyunContainerService/velero-plugin)

[GitHub Issue](https://github.com/AliyunContainerService/velero-plugin/issues)

[DigitalOcean](https://www.digitalocean.com/)

DigitalOcean Object Storage

DigitalOcean Volumes Block Storage

[StackPointCloud](https://github.com/StackPointCloud/ark-plugin-digitalocean)

[Hewlett Packard](https://www.hpe.com/us/en/storage.html)

ğŸš«

HPE Storage

[Hewlett Packard](https://github.com/hpe-storage/velero-plugin)

[Slack](https://slack.hpedev.io/), [GitHub Issue](https://github.com/hpe-storage/velero-plugin/issues)

[OpenEBS](https://openebs.io/)

ğŸš«

OpenEBS CStor Volume

[OpenEBS](https://github.com/openebs/velero-plugin)

[Slack](https://openebs-community.slack.com/), [GitHub Issue](https://github.com/openebs/velero-plugin/issues)

[OpenStack](https://www.openstack.org/)

Swift

Cinder

[OpenStack](https://github.com/Lirt/velero-plugin-for-openstack)

[GitHub Issue](https://github.com/Lirt/velero-plugin-for-openstack/issues)

[Portworx](https://portworx.com/)

ğŸš«

Portworx Volume

[Portworx](https://docs.portworx.com/scheduler/kubernetes/ark.html)

[Slack](https://portworx.slack.com/messages/px-k8s), [GitHub Issue](https://github.com/portworx/ark-plugin/issues)

[Storj](https://storj.io/)

Storj Object Storage

ğŸš«

[Storj](https://github.com/storj-thirdparty/velero-plugin)

[GitHub Issue](https://github.com/storj-thirdparty/velero-plugin/issues)

### ä¸ s3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨æä¾›ç¨‹åº

Velero çš„ AWS Object Store æ’ä»¶ä½¿ç”¨ Amazon çš„ Go SDK è¿æ¥åˆ° AWS S3 APIã€‚ ä¸€äº›ç¬¬ä¸‰æ–¹å­˜å‚¨æä¾›ç¨‹åºä¹Ÿæ”¯æŒ S3 APIï¼Œå¹¶ä¸”ç”¨æˆ·æŠ¥å‘Šäº†ä»¥ä¸‹æä¾›ç¨‹åºå¯ç”¨äº Veleroï¼š

_ğŸ“ è¯·æ³¨æ„ï¼ŒVelero å›¢é˜Ÿå¹¶æœªå®šæœŸæµ‹è¯•è¿™äº›å­˜å‚¨æä¾›å•†ã€‚_

*   [IBM Cloud](https://velero.io/docs/v1.8/contributions/ibm-config/)
*   [Oracle Cloud](https://velero.io/docs/v1.8/contributions/oracle-config/)
*   [Minio](https://velero.io/docs/v1.8/contributions/minio/)
*   [DigitalOcean](https://github.com/StackPointCloud/ark-plugin-digitalocean)
*   [NooBaa](http://www.noobaa.com/)
*   [Tencent Cloud](https://velero.io/docs/v1.8/contributions/tencent-config/)
*   Ceph RADOS v12.2.7
*   Quobyte
*   [Cloudian HyperStore](https://www.cloudian.com/)

_æŸäº›å­˜å‚¨æä¾›ç¨‹åºï¼ˆä¾‹å¦‚ Quobyteï¼‰å¯èƒ½éœ€è¦ä¸åŒçš„ç­¾åç®—æ³•ç‰ˆæœ¬ã€‚_

å®‰è£… - å¿«é€ŸéªŒè¯å®‰è£…
-----------

1.  åœ¨æ‚¨çš„æœ¬åœ°ç›®å½•ä¸­åˆ›å»ºç‰¹å®šäº Velero çš„å‡­è¯æ–‡ä»¶ï¼ˆ`credentials-velero`):
    
        [default]
        aws_access_key_id = minio
        aws_secret_access_key = minio123
        
    
2.  å¯åŠ¨æœåŠ¡å™¨å’Œå­˜å‚¨æœåŠ¡ã€‚ åœ¨ Velero ç›®å½•ä¸­ï¼Œè¿è¡Œï¼š
    
        oc apply -f examples/minio/00-minio-deployment.yaml
        velero install \
            --provider aws \
            --plugins velero/velero-plugin-for-aws:v1.4.1 \
            --bucket velero \
            --secret-file ./credentials-velero \
            --use-volume-snapshots=false \
            --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=http://minio.velero.svc:9000 
        
    
    æ­¤ç¤ºä¾‹å‡å®šå®ƒåœ¨æœ¬åœ°ç¾¤é›†ä¸­è¿è¡Œï¼Œè€Œæ²¡æœ‰èƒ½å¤Ÿæä¾›å¿«ç…§çš„å·æä¾›ç¨‹åºï¼Œå› æ­¤ä¸ä¼šåˆ›å»º VolumeSnapshotLocationï¼ˆ\`\`--use-volume-snapshots=false\`ï¼‰ã€‚
    
    æ­¤å¤–ï¼Œæ‚¨å¯ä»¥æŒ‡å®š`--use-restic`å¯ç”¨ RESTIC æ”¯æŒï¼Œå¹¶æŒ‡å®š`--wait`ç­‰å¾…éƒ¨ç½²å‡†å¤‡å°±ç»ªã€‚
    
    å¯¹äºæ›´å¤æ‚çš„å®‰è£…éœ€æ±‚ï¼Œè¯·ä½¿ç”¨ Helm Chartï¼Œæˆ–æ·»åŠ `--dry-run -o yaml`é€‰é¡¹æ¥ç”Ÿæˆå®‰è£…çš„ YAML æ–‡ä»¶ã€‚
    

åˆ›å»ºçš„å†…å®¹åŒ…æ‹¬ï¼š

    CustomResourceDefinition/backups.velero.io: attempting to create resource
    CustomResourceDefinition/backups.velero.io: created
    CustomResourceDefinition/backupstoragelocations.velero.io: attempting to create resource
    CustomResourceDefinition/backupstoragelocations.velero.io: created
    CustomResourceDefinition/deletebackuprequests.velero.io: attempting to create resource
    CustomResourceDefinition/deletebackuprequests.velero.io: created
    CustomResourceDefinition/downloadrequests.velero.io: attempting to create resource
    CustomResourceDefinition/downloadrequests.velero.io: created
    CustomResourceDefinition/podvolumebackups.velero.io: attempting to create resource
    CustomResourceDefinition/podvolumebackups.velero.io: created
    CustomResourceDefinition/podvolumerestores.velero.io: attempting to create resource
    CustomResourceDefinition/podvolumerestores.velero.io: created
    CustomResourceDefinition/resticrepositories.velero.io: attempting to create resource
    CustomResourceDefinition/resticrepositories.velero.io: created
    CustomResourceDefinition/restores.velero.io: attempting to create resource
    CustomResourceDefinition/restores.velero.io: created
    CustomResourceDefinition/schedules.velero.io: attempting to create resource
    CustomResourceDefinition/schedules.velero.io: created
    CustomResourceDefinition/serverstatusrequests.velero.io: attempting to create resource
    CustomResourceDefinition/serverstatusrequests.velero.io: created
    CustomResourceDefinition/volumesnapshotlocations.velero.io: attempting to create resource
    CustomResourceDefinition/volumesnapshotlocations.velero.io: created
    Waiting for resources to be ready in cluster...
    Namespace/velero: attempting to create resource
    Namespace/velero: already exists, proceeding
    Namespace/velero: created
    ClusterRoleBinding/velero: attempting to create resource
    ClusterRoleBinding/velero: created
    ServiceAccount/velero: attempting to create resource
    ServiceAccount/velero: created
    Secret/cloud-credentials: attempting to create resource
    Secret/cloud-credentials: created
    BackupStorageLocation/default: attempting to create resource
    BackupStorageLocation/default: created
    Deployment/velero: attempting to create resource
    Deployment/velero: created
    Velero is installed! â›µ Use 'kubectl logs deployment/velero -n velero' to view the status.
    
    

### å¤‡ä»½

1.  ä¸ºä¸`app=iperf3-server`label selector åŒ¹é…çš„ä»»ä½•å¯¹è±¡åˆ›å»ºå¤‡ä»½ï¼š
    
        velero backup create test-backup --selector app=iperf3-server
        
    
    æˆ–è€…ï¼Œå¦‚æœè¦å¤‡ä»½é™¤åŒ¹é…æ ‡ç­¾`backup=ignore`çš„å¯¹è±¡ä»¥å¤–çš„æ‰€æœ‰å¯¹è±¡ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
    
        velero backup create nginx-backup --selector 'backup!=ignore'
        
    
2.  ï¼ˆå¯é€‰ï¼‰ä½¿ç”¨`app=iperf3-server`label selector åŸºäº cron è¡¨è¾¾å¼åˆ›å»ºå®šæœŸè®¡åˆ’çš„å¤‡ä»½ï¼š
    
        velero schedule create test-daily --schedule="0 1 * * *" --selector app=iperf3-server
        
    
    å¦å¤–ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä¸€äº›éæ ‡å‡†çš„é€Ÿè®° cron è¡¨è¾¾å¼ï¼š
    
        velero schedule create test-daily --schedule="@every 24h" --selector app=iperf3-server
        
    
    æœ‰å…³æ›´å¤šç”¨æ³•ç¤ºä¾‹ï¼Œè¯·å‚è§ [cron è½¯ä»¶åŒ…](https://godoc.org/github.com/robfig/cron) çš„æ–‡æ¡£ã€‚
    

### æ¢å¤

1.  è¿è¡Œï¼š
    
        velero restore create --from-backup test-backup
        
    
2.  è¿è¡Œï¼š
    
        velero restore get
        
    
    æ¢å¤å®Œæˆåï¼Œè¾“å‡ºå¦‚ä¸‹æ‰€ç¤ºï¼š
    
        NAME                          BACKUP         STATUS      WARNINGS   ERRORS    CREATED                         SELECTOR
        nginx-backup-20170727200524   nginx-backup   Completed   0          0         2017-07-27 20:05:24 +0000 UTC   <none>
        
    

å¦‚æœæœ‰é”™è¯¯æˆ–è­¦å‘Šï¼Œåˆ™å¯ä»¥è¯¦ç»†æŸ¥çœ‹å®ƒä»¬ï¼š

    velero restore describe <RESTORE_NAME>
    

### æ¸…ç†

å¦‚æœè¦åˆ é™¤åˆ›å»ºçš„æ‰€æœ‰å¤‡ä»½ï¼ŒåŒ…æ‹¬å¯¹è±¡å­˜å‚¨ä¸­çš„æ•°æ®å’Œæ°¸ä¹…å·å¿«ç…§ï¼Œåˆ™å¯ä»¥è¿è¡Œï¼š

    velero backup delete BACKUP_NAME
    

è¿™è¦æ±‚ Velero æœåŠ¡å™¨åˆ é™¤ä¸`BACKUP_NAME`ç›¸å…³è”çš„æ‰€æœ‰å¤‡ä»½æ•°æ®ã€‚ æ‚¨éœ€è¦å¯¹è¦æ°¸ä¹…åˆ é™¤çš„æ¯ä¸ªå¤‡ä»½æ‰§è¡Œæ­¤æ“ä½œã€‚ Velero çš„æœªæ¥ç‰ˆæœ¬å°†å…è®¸æ‚¨é€šè¿‡åç§°æˆ– label selector åˆ é™¤å¤šä¸ªå¤‡ä»½ã€‚

è¦ä» Kubernetes é›†ç¾¤ä¸­å®Œå…¨å¸è½½ Veleroï¼š

    oc delete namespace/velero clusterrolebinding/velero
    oc delete crds -l component=velero
    

å®‰è£… - Restic é›†æˆ
--------------

Velero æ”¯æŒä½¿ç”¨ç§°ä¸º [restic](https://github.com/restic/restic) çš„å…è´¹å¼€æºå¤‡ä»½å·¥å…·å¤‡ä»½å’Œè¿˜åŸ Kubernetes å·ã€‚ æ­¤æ”¯æŒè¢«è§†ä¸º Beta è´¨é‡ã€‚ è¯·æŸ¥çœ‹ [é™åˆ¶](https://velero.io/docs/v1.8/restic/) åˆ—è¡¨ï¼Œä»¥äº†è§£å®ƒæ˜¯å¦é€‚åˆæ‚¨çš„ç”¨ä¾‹ã€‚

æ·»åŠ äº† Restic é›†æˆï¼Œä¸ºæ‚¨æä¾›äº†ä¸€ä¸ªç°æˆçš„è§£å†³æ–¹æ¡ˆï¼Œç”¨äºå¤‡ä»½å’Œè¿˜åŸå‡ ä¹ä»»ä½•ç±»å‹çš„ Kubernetes å·ã€‚ è¿™ç§é›†æˆæ˜¯ Velero åŠŸèƒ½çš„è¡¥å……ï¼Œè€Œä¸æ˜¯ç°æœ‰åŠŸèƒ½çš„æ›¿ä»£ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨éœ€è¦ä¸ºå­˜å‚¨å¹³å°ä½¿ç”¨å·å¿«ç…§æ’ä»¶ï¼Œæˆ–è€…ä½¿ç”¨çš„æ˜¯ EFSï¼ŒAzureFileï¼ŒNFSï¼ŒemptyDirï¼Œlocal æˆ–ä»»ä½•å…¶ä»–æ²¡æœ‰æœ¬æœºå¿«ç…§æ¦‚å¿µçš„å·ç±»å‹ï¼Œrestic å¯èƒ½é€‚åˆæ‚¨ ã€‚

Restic å¹¶ä¸å±€é™äºç‰¹å®šçš„å­˜å‚¨å¹³å°ï¼Œè¿™æ„å‘³ç€è¯¥é›†æˆè¿˜ä¸ºå°†æ¥å®ç°è·¨å·ç±»å‹æ•°æ®è¿ç§»çš„å·¥ä½œé“ºå¹³äº†é“è·¯ã€‚

> ğŸ¾ æ³¨æ„ï¼š
> 
> ä¸æ”¯æŒ hostPath å·ï¼Œä½†æ˜¯æ”¯æŒ [æœ¬åœ°å·ç±»å‹](https://kubernetes.io/docs/concepts/storage/volumes/#local)ã€‚

### å®‰è£… restic

#### å‰æ

*   äº†è§£ Velero å¦‚ä½• [é€šè¿‡ Restic é›†æˆæ‰§è¡Œå¤‡ä»½](https://velero.io/docs/v1.8/restic/)ã€‚
    
*   [ä¸‹è½½](https://github.com/vmware-tanzu/velero/releases/) æœ€æ–°çš„ Velero ç‰ˆæœ¬ã€‚
    
*   Kubernetes v1.10.0 åŠæ›´é«˜ç‰ˆæœ¬ã€‚ Velero çš„ Restic é›†æˆéœ€è¦ Kubernetes [MountPropagation åŠŸèƒ½](https://kubernetes.io/docs/concepts/storage/volumes/#mount-propagation)ï¼Œè¯¥åŠŸèƒ½åœ¨ Kubernetes v1.10.0 å’Œæ›´é«˜ç‰ˆæœ¬ä¸­é»˜è®¤å¯ç”¨ã€‚
    

#### å®‰è£… restic

è¦å®‰è£… resticï¼Œè¯·ä½¿ç”¨`velero install`å‘½ä»¤ä¸­çš„`--use-restic` æ ‡å¿—ã€‚ æœ‰å…³å®‰è£…å‘½ä»¤çš„å…¶ä»–æ ‡å¿—çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ [å®‰è£…æ¦‚è¿°](https://velero.io/docs/v1.8/customize-installation/)ã€‚

    velero install --use-restic
    

åœ¨ä¸æ”¯æŒå¿«ç…§çš„ Velero æ”¯æŒçš„å­˜å‚¨æä¾›ç¨‹åºä¸Šä½¿ç”¨ Restic æ—¶ï¼Œ`--use-volume-snapshots = false` æ ‡å¿—å¯é˜²æ­¢åœ¨å®‰è£…æ—¶åˆ›å»ºæœªä½¿ç”¨çš„`VolumeSnapshotLocation` ã€‚

#### é…ç½® Restic DaemonSet Spec

å®‰è£…åï¼ŒæŸäº›åŸºäº Kubernetes çš„ PaaS / CaaS å¹³å°ä¹Ÿéœ€è¦ä¿®æ”¹ Restic DaemonSet è§„èŒƒã€‚ ä»…å½“æ‚¨åœ¨ RancherOSï¼ŒOpenShiftï¼ŒVMware Tanzu Kubernetes Grid Integrated Editionï¼ˆä»¥å‰ç§°ä¸º VMware Enterprise PKSï¼‰æˆ– Micrsoft Azure ä¸Šå®‰è£…æ—¶ï¼Œæ‰éœ€è¦æœ¬èŠ‚ä¸­çš„æ­¥éª¤ã€‚

##### OpenShift

è¦å°†æ­£ç¡®çš„ä¸»æœºè·¯å¾„å®‰è£…åˆ° Pod å·ï¼Œè¯·åœ¨`privileged`æ¨¡å¼ä¸‹è¿è¡Œ Restic Podã€‚

1.  å°†`velero` ServiceAccount æ·»åŠ åˆ°`privileged`SCCï¼š
    
        $ oc adm policy add-scc-to-user privileged -z velero -n velero
        
    
2.  å¯¹äº OpenShift ç‰ˆæœ¬> = 4.1ï¼Œä¿®æ”¹ DaemonSet yaml ä»¥è¯·æ±‚`privileged`æ¨¡å¼ï¼š
    
        @@ -67,3 +67,5 @@ spec:
                      value: /credentials/cloud
                    - name: VELERO_SCRATCH_DIR
                      value: /scratch
        +          securityContext:
        +            privileged: true
        
    
    æˆ–ï¼š
    
        oc patch ds/restic \
          --namespace velero \
          --type json \
          -p '[{"op":"add","path":"/spec/template/spec/containers/0/securityContext","value": { "privileged": true}}]'
        
    

å¦‚æœ restic ä¸åœ¨ç‰¹æƒæ¨¡å¼ä¸‹è¿è¡Œï¼Œåˆ™ç”±äºä¸»æœºç³»ç»Ÿçº§åˆ«é…ç½®äº†é»˜è®¤çš„å¼ºåˆ¶å®æ–½ SELinux æ¨¡å¼ï¼Œå®ƒå°†æ— æ³•è®¿é—®å·²æŒ‚è½½çš„ hostpath ç›®å½•å†…çš„ pod å·ã€‚ æ‚¨å¯ä»¥ [åˆ›å»ºè‡ªå®šä¹‰ SCC](https://docs.openshift.com/container-platform/3.11/admin_guide/manage_scc.html) æ¥æ”¾æ¾ç¾¤é›†ä¸­çš„å®‰å…¨æ€§ï¼Œä»¥ä¾¿å…è®¸ Restic Pod ä½¿ç”¨ hostPath å·æ’ä»¶ï¼Œè€Œæ— éœ€æˆäºˆå®ƒä»¬è®¿é—®`privileged`SCC çš„æƒé™ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨æˆ·ç»´åº¦çš„ openshift åç§°ç©ºé—´ä¸ä¼šåœ¨é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šè°ƒåº¦ Podã€‚

è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè®¡åˆ’åç§°ç©ºé—´ï¼Œéœ€è¦ä¸€ä¸ªæ³¨é‡Šï¼š

    oc annotate namespace <velero namespace> openshift.io/node-selector=""
    

è¿™åº”è¯¥åœ¨å®‰è£… velero ä¹‹å‰å®Œæˆã€‚

æˆ–éœ€è¦åˆ é™¤å¹¶é‡æ–°åˆ›å»º dsï¼š

    oc get ds restic -o yaml -n <velero namespace> > ds.yaml
    oc annotate namespace <velero namespace> openshift.io/node-selector=""
    oc create -n <velero namespace> -f ds.yaml
    

### å¤‡ä»½

Velero æ”¯æŒå‘ç°éœ€è¦ä½¿ç”¨ Restic å¤‡ä»½çš„ Pod å·çš„ä¸¤ç§æ–¹æ³•ï¼š

*   é€‰æ‹©æ€§å¯ç”¨æ–¹å¼ï¼šæ¯ä¸ªåŒ…å«è¦ä½¿ç”¨ Restic å¤‡ä»½çš„å·çš„ Pod éƒ½å¿…é¡»æ ‡æœ‰å·çš„åç§°ã€‚
    
*   é€‰æ‹©æ€§é€€å‡ºæ–¹å¼ï¼šä½¿ç”¨ Restic å¤‡ä»½æ‰€æœ‰ Pod å·ï¼Œå¹¶å…·æœ‰é€€å‡ºä»»ä½•ä¸åº”å¤‡ä»½çš„å·çš„åŠŸèƒ½ã€‚
    

ä»¥ä¸‹å„èŠ‚æä¾›äº†æœ‰å…³è¿™ä¸¤ç§æ–¹æ³•çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

#### é€‰æ‹©æ€§é€€å‡ºæ–¹å¼

åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼ŒVelero å°†ä½¿ç”¨ restic å¤‡ä»½æ‰€æœ‰ pod å·ï¼Œä½†ä»¥ä¸‹æƒ…å†µé™¤å¤–ï¼š

*   å®‰è£…é»˜è®¤æœåŠ¡å¸æˆ·ä»¤ç‰Œï¼Œkubernetes secrets å’Œ config maps çš„å·
*   Hostpath å·

ä½¿ç”¨ pod ä¸Šçš„`backup.velero.io/backup-volumes-excludes`æ³¨é‡Šå¯ä»¥æ’é™¤å·ä¸è¢«å¤‡ä»½çš„æƒ…å†µã€‚

ä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œå¤‡ä»½çš„è¯´æ˜å¦‚ä¸‹ï¼š

1.  åœ¨åŒ…å«ä¸åº”ä½¿ç”¨ Restic å¤‡ä»½çš„å·çš„æ¯ä¸ª Pod ä¸Šè¿è¡Œä»¥ä¸‹å‘½ä»¤
    
        kubectl -n YOUR_POD_NAMESPACE annotate pod/YOUR_POD_NAME backup.velero.io/backup-volumes-excludes=YOUR_VOLUME_NAME_1,YOUR_VOLUME_NAME_2,...
        
    
    å…¶ä¸­ï¼Œå·åæ˜¯å®¹å™¨è§„èŒƒä¸­å·çš„åç§°ã€‚
    
    ä¾‹å¦‚ï¼Œåœ¨ä»¥ä¸‹ pod ä¸­ï¼š
    
        apiVersion: v1
        kind: Pod
        metadata:
          name: app1
          namespace: sample
        spec:
          containers:
          - image: k8s.gcr.io/test-webserver
            name: test-webserver
            volumeMounts:
            - name: pvc1-vm
              mountPath: /volume-1
            - name: pvc2-vm
              mountPath: /volume-2
          volumes:
          - name: pvc1-vm
            persistentVolumeClaim:
              claimName: pvc1
          - name: pvc2-vm
              claimName: pvc2
        
    
    è¦æ’é™¤å·`pvc1-vm`çš„ Restic å¤‡ä»½ï¼Œåº”è¿è¡Œï¼š
    
        kubectl -n sample annotate pod/app1 backup.velero.io/backup-volumes-excludes=pvc1-vm
        
    
2.  è¿›è¡Œ Velero å¤‡ä»½ï¼š
    
        velero backup create BACKUP_NAME --default-volumes-to-restic OTHER_OPTIONS
        
    
    ä»¥ä¸Šæ­¥éª¤åœ¨æ¯ä¸ªå¤‡ä»½çš„åŸºç¡€ä¸Šä½¿ç”¨äº†é€‰æ‹©æ€§é€€å‡ºæ–¹æ³•ã€‚
    
    æˆ–è€…ï¼Œå¯ä»¥åœ¨è¿è¡Œå¸¦æœ‰`--default-volumes-to-restic` æ ‡å¿—çš„`velero install`å‘½ä»¤çš„æ‰€æœ‰ velero å¤‡ä»½ä¸Šå¯ç”¨æ­¤è¡Œä¸ºã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [å®‰è£…æ¦‚è¿°](https://velero.io/docs/v1.8/customize-installation/)ã€‚
    
3.  å¤‡ä»½å®Œæˆåï¼ŒæŸ¥çœ‹æœ‰å…³å¤‡ä»½çš„ä¿¡æ¯ï¼š
    
        velero backup describe YOUR_BACKUP_NAME
        kubectl -n velero get podvolumebackups -l velero.io/backup-name=YOUR_BACKUP_NAME -o yaml
        
    

#### é€‰æ‹©æ€§å¯ç”¨æ–¹å¼

é»˜è®¤æƒ…å†µä¸‹ï¼ŒVelero ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥å‘ç°éœ€è¦ä½¿ç”¨ Restic å¤‡ä»½çš„ Pod å·ï¼Œå…¶ä¸­æ¯ä¸ªåŒ…å«è¦ä½¿ç”¨ Restic å¤‡ä»½çš„å·çš„ Pod éƒ½å¿…é¡»æ ‡æœ‰è¯¥å·çš„åç§°ã€‚

ä½¿ç”¨æ­¤æ–¹æ³•è¿›è¡Œå¤‡ä»½çš„è¯´æ˜å¦‚ä¸‹ï¼š

1.  å¯¹åŒ…å«è¦å¤‡ä»½çš„å·çš„æ¯ä¸ª Pod è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    
        kubectl -n YOUR_POD_NAMESPACE annotate pod/YOUR_POD_NAME backup.velero.io/backup-volumes=YOUR_VOLUME_NAME_1,YOUR_VOLUME_NAME_2,...
        
    
    å…¶ä¸­ï¼Œå·åæ˜¯å®¹å™¨ spec ä¸­å·çš„åç§°ã€‚
    
    ä¾‹å¦‚ï¼Œå¯¹äºä»¥ä¸‹ podï¼š
    
        apiVersion: v1
        kind: Pod
        metadata:
          name: sample
          namespace: foo
        spec:
          containers:
          - image: k8s.gcr.io/test-webserver
            name: test-webserver
            volumeMounts:
            - name: pvc-volume
              mountPath: /volume-1
            - name: emptydir-volume
              mountPath: /volume-2
          volumes:
          - name: pvc-volume
            persistentVolumeClaim:
              claimName: test-volume-claim
          - name: emptydir-volume
            emptyDir: {}
        
    
    ä½ åº”è¯¥è¿è¡Œï¼š
    
        kubectl -n foo annotate pod/sample backup.velero.io/backup-volumes=pvc-volume,emptydir-volume
        
    
    å¦‚æœæ‚¨ä½¿ç”¨æ§åˆ¶å™¨æ¥ç®¡ç†æ‚¨çš„ podsï¼Œåˆ™ä¹Ÿå¯ä»¥åœ¨ pod template spec ä¸­æä¾›æ­¤æ‰¹æ³¨ã€‚
    
2.  åšä¸€ä¸ª Velero å¤‡ä»½
    
        velero backup create NAME OPTIONS...
        
    
3.  å¤‡ä»½å®Œæˆåï¼ŒæŸ¥çœ‹æœ‰å…³å¤‡ä»½çš„ä¿¡æ¯ï¼š
    
        velero backup describe YOUR_BACKUP_NAME
        kubectl -n velero get podvolumebackups -l velero.io/backup-name=YOUR_BACKUP_NAME -o yaml
        
    

### æ¢å¤

æ— è®ºå¦‚ä½•ä½¿ç”¨ Restic å‘ç°å·ä»¥è¿›è¡Œå¤‡ä»½ï¼Œè¿˜åŸè¿‡ç¨‹å‡ä¿æŒä¸å˜ã€‚

1.  ä» Velero å¤‡ä»½ä¸­è¿˜åŸï¼š
    
        velero restore create --from-backup BACKUP_NAME OPTIONS...
        
    
2.  è¿˜åŸå®Œæˆåï¼ŒæŸ¥çœ‹æœ‰å…³ Pod å·è¿˜åŸçš„ä¿¡æ¯ï¼š
    
        velero restore describe YOUR_RESTORE_NAME
        kubectl -n velero get podvolumerestores -l velero.io/restore-name=YOUR_RESTORE_NAME -o yaml
        
    

### é™åˆ¶

*   ä¸æ”¯æŒ`hostPath` å·ã€‚ æ”¯æŒ [æœ¬åœ°æŒä¹…å·](https://kubernetes.io/docs/concepts/storage/volumes/#local)ã€‚
*   ç†Ÿæ‚‰ restic çš„äººå¯èƒ½çŸ¥é“å®ƒä¼šåŠ å¯†æ‰€æœ‰æ•°æ®ã€‚ Velero å¯¹å®ƒåˆ›å»ºçš„æ‰€æœ‰ Restic å­˜å‚¨åº“ä½¿ç”¨é™æ€é€šç”¨åŠ å¯†å¯†é’¥ã€‚ è¿™æ„å‘³ç€æœ‰æƒè®¿é—®æ‚¨çš„å­˜å‚¨æ¡¶çš„ä»»ä½•äººéƒ½å¯ä»¥è§£å¯†æ‚¨çš„è¿˜åŸå¤‡ä»½æ•°æ®ã€‚ ç¡®ä¿é€‚å½“é™åˆ¶å¯¹ Restic æ¡¶çš„è®¿é—®ã€‚
*   è·¨ PVC çš„ pod é‡æ–°å®‰æ’å°†ç»´æŠ¤å¢é‡å¤‡ä»½é“¾ã€‚ ä½†æ˜¯ï¼Œå¯¹äºé PVC çš„ pod å·ï¼ˆä¾‹å¦‚`emptyDir` å·ï¼‰ï¼Œå½“åˆ é™¤/é‡æ–°åˆ›å»º podï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ ReplicaSet / Deploymentï¼‰æ—¶ï¼Œè¿™äº›å·çš„ä¸‹ä¸€æ¬¡å¤‡ä»½å°†æ˜¯å®Œæ•´çš„è€Œä¸æ˜¯å¢é‡çš„ï¼Œå› ä¸º pod å·çš„æ˜¯ å‡å®šç”Ÿå‘½å‘¨æœŸç”±å…¶ pod å®šä¹‰ã€‚
*   Restic åœ¨å•ä¸ªçº¿ç¨‹ä¸­æ‰«ææ¯ä¸ªæ–‡ä»¶ã€‚ è¿™æ„å‘³ç€å¤§æ–‡ä»¶ï¼ˆä¾‹å¦‚å­˜å‚¨æ•°æ®åº“çš„æ–‡ä»¶ï¼‰å°†èŠ±è´¹å¾ˆé•¿æ—¶é—´æ‰«æé‡å¤æ•°æ®åˆ é™¤ï¼Œå³ä½¿å®é™…å·®å¼‚å¾ˆå°ã€‚
*   å¦‚æœæ‚¨æ‰“ç®—ä½¿ç”¨ Velero Restic é›†æˆæ¥å¤‡ä»½ 100GB æˆ–æ›´å¤šçš„æ•°æ®ï¼Œåˆ™å¯èƒ½éœ€è¦ [è‡ªå®šä¹‰èµ„æºé™åˆ¶](https://velero.io/docs/v1.8/restic/) ä»¥ç¡®ä¿å¤‡ä»½æˆåŠŸå®Œæˆã€‚
*   Velero çš„ Restic é›†æˆé€šè¿‡è®¿é—®è¿è¡Œ Pod çš„èŠ‚ç‚¹æ–‡ä»¶ç³»ç»Ÿæ¥å¤‡ä»½å·ä¸­çš„æ•°æ®ã€‚ å› æ­¤ï¼ŒRESTIC é›†æˆåªèƒ½å¤‡ä»½ç”± Pod æŒ‚è½½çš„å·ï¼Œè€Œä¸èƒ½ç›´æ¥ä» PVC å¤‡ä»½ã€‚

### è‡ªå®šä¹‰è¿˜åŸåŠ©æ‰‹å®¹å™¨

Velero åœ¨æ‰§è¡Œ Restic è¿˜åŸæ—¶ä½¿ç”¨è¾…åŠ©åˆå§‹åŒ–å®¹å™¨ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å®¹å™¨çš„é•œåƒæ˜¯`velero/velero-restic-restore-helperï¼š<VERSION>` ï¼Œå…¶ä¸­`VERSION` ä¸ä¸» Velero é•œåƒçš„ç‰ˆæœ¬/æ ‡ç­¾åŒ¹é…ã€‚ æ‚¨å¯ä»¥é€šè¿‡åœ¨ Velero å‘½åç©ºé—´ä¸­åˆ›å»ºå¸¦æœ‰å¤‡ç”¨é•œåƒçš„ ConfigMapï¼Œæ¥å®šåˆ¶ç”¨äºæ­¤å¸®åŠ©ç¨‹åºçš„é•œåƒã€‚

ConfigMap å¿…é¡»å¦‚ä¸‹æ‰€ç¤ºï¼š

    apiVersion: v1
    kind: ConfigMap
    metadata:
      # any name can be used; Velero uses the labels (below)
      # to identify it rather than the name
      name: restic-restore-action-config
      # must be in the velero namespace
      namespace: velero
      # the below labels should be used verbatim in your
      # ConfigMap.
      labels:
        # this value-less label identifies the ConfigMap as
        # config for a plugin (i.e. the built-in restic restore
        # item action plugin)
        velero.io/plugin-config: ""
        # this label identifies the name and kind of plugin
        # that this ConfigMap is for.
        velero.io/restic: RestoreItemAction
    data:
      # The value for "image" can either include a tag or not;
      # if the tag is *not* included, the tag from the main Velero
      # image will automatically be used.
      image: myregistry.io/my-custom-helper-image[:OPTIONAL_TAG]
    
      # "cpuRequest" sets the request.cpu value on the restic init containers during restore.
      # If not set, it will default to "100m". A value of "0" is treated as unbounded.
      cpuRequest: 200m
    
      # "memRequest" sets the request.memory value on the restic init containers during restore.
      # If not set, it will default to "128Mi". A value of "0" is treated as unbounded.
      memRequest: 128Mi
    
      # "cpuLimit" sets the request.cpu value on the restic init containers during restore.
      # If not set, it will default to "100m". A value of "0" is treated as unbounded.
      cpuLimit: 200m
    
      # "memLimit" sets the request.memory value on the restic init containers during restore.
      # If not set, it will default to "128Mi". A value of "0" is treated as unbounded.
      memLimit: 128Mi
    
      # "secCtxRunAsUser sets the securityContext.runAsUser value on the restic init containers during restore."
      secCtxRunAsUser: 1001
    
      # "secCtxRunAsGroup sets the securityContext.runAsGroup value on the restic init containers during restore."
      secCtxRunAsGroup: 999
    

### å¤‡ä»½å’Œè¿˜åŸå¦‚ä½•ä¸ Restic ä¸€èµ·å·¥ä½œ

Velero å…·æœ‰ä¸‰ä¸ªè‡ªå®šä¹‰èµ„æºå®šä¹‰å’Œå…³è”çš„æ§åˆ¶å™¨ï¼š

*   `ResticRepository` - ä»£è¡¨/ç®¡ç† Velero [Restic å‚¨å­˜åº“](http://restic.readthedocs.io/en/latest/100_references.html#terminology) çš„ç”Ÿå‘½å‘¨æœŸã€‚ å½“è¯·æ±‚ç¬¬ä¸€ä¸ªåç§°ç©ºé—´çš„ Restic å¤‡ä»½æ—¶ï¼ŒVelero å°†ä¸ºæ¯ä¸ªåç§°ç©ºé—´åˆ›å»ºä¸€ä¸ª Restic å­˜å‚¨åº“ã€‚ æ­¤è‡ªå®šä¹‰èµ„æºçš„æ§åˆ¶å™¨æ‰§è¡Œ restic å­˜å‚¨åº“ç”Ÿå‘½å‘¨æœŸå‘½ä»¤â€“ `restic init`ï¼Œ`restic check`å’Œ`restic prune`ã€‚
    
    æ‚¨å¯ä»¥é€šè¿‡è¿è¡Œ`velero restic repo get` æ¥æŸ¥çœ‹æœ‰å…³ Velero Restic å­˜å‚¨åº“çš„ä¿¡æ¯ã€‚
    
*   `PodVolumeBackup` - è¡¨ç¤ºå®¹å™¨ä¸­å·çš„é™æ€å¤‡ä»½ã€‚å½“æ‰¾åˆ°å¸¦æ³¨é‡Šçš„ pod æ—¶ï¼Œä¸»è¦çš„ Velero å¤‡ä»½è¿‡ç¨‹ä¼šåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª`PodVolumeBackup` ã€‚ç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸ºæ­¤èµ„æºï¼ˆåœ¨ daemonset ä¸­ï¼‰è¿è¡Œä¸€ä¸ªæ§åˆ¶å™¨ï¼Œè¯¥æ§åˆ¶å™¨å¤„ç†è¯¥èŠ‚ç‚¹ä¸Šçš„ Pod çš„`PodVolumeBackups` ã€‚ æ§åˆ¶å™¨æ‰§è¡Œ`restic backup`å‘½ä»¤ä»¥å¤‡ä»½ pod å·æ•°æ®ã€‚
    
*   `PodVolumeRestore` - è¡¨ç¤º pod volume çš„æ¢å¤ã€‚ å½“é‡åˆ°å…·æœ‰å…³è”çš„ Restic å¤‡ä»½çš„ Pod æ—¶ï¼Œä¸»è¦çš„ Velero è¿˜åŸè¿‡ç¨‹ä¼šåˆ›å»ºå…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ª`PodVolumeRestore`ã€‚ ç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸ºæ­¤èµ„æºè¿è¡Œä¸€ä¸ªæ§åˆ¶å™¨ï¼ˆåœ¨ä¸ä¸Šè¿°ç›¸åŒçš„ daemonset ä¸­ï¼‰ï¼Œè¯¥æ§åˆ¶å™¨å¤„ç†è¯¥èŠ‚ç‚¹ä¸Šçš„ Pod çš„`PodVolumeRestores`ã€‚ æ§åˆ¶å™¨æ‰§è¡Œ`restic restore`å‘½ä»¤ä»¥è¿˜åŸ Pod å·æ•°æ®ã€‚
    

#### å¤‡ä»½

1.  æ ¹æ®é…ç½®ï¼Œä¸»è¦çš„ Velero å¤‡ä»½è¿‡ç¨‹ä½¿ç”¨é€‰æ‹©åŠ å…¥æˆ–é€‰æ‹©é€€å‡ºæ–¹æ³•æ¥æ£€æŸ¥è¦å¤‡ä»½çš„æ¯ä¸ª Podï¼Œä»¥ä½¿ç”¨ Restic å¤‡ä»½è¦å¤‡ä»½çš„å·ã€‚
2.  æ‰¾åˆ°åï¼ŒVelero é¦–å…ˆé€šè¿‡ä»¥ä¸‹æ–¹å¼ç¡®ä¿ pod çš„åç§°ç©ºé—´å­˜åœ¨ä¸€ä¸ª Restic å­˜å‚¨åº“ï¼š
    *   æ£€æŸ¥`ResticRepository` è‡ªå®šä¹‰èµ„æºæ˜¯å¦å·²ç»å­˜åœ¨
    *   å¦‚æœæ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ï¼Œç„¶åç­‰å¾…`ResticRepository` æ§åˆ¶å™¨è¿›è¡Œåˆå§‹åŒ–/æ£€æŸ¥ã€‚
3.  ç„¶å Velero ä¸º pod æ³¨é‡Šä¸­åˆ—å‡ºçš„æ¯ä¸ªå·åˆ›å»ºä¸€ä¸ª`PodVolumeBackup` è‡ªå®šä¹‰èµ„æºã€‚
4.  ç°åœ¨ï¼Œä¸»è¦çš„ Velero è¿›ç¨‹ç­‰å¾…`PodVolumeBackup`èµ„æºå®Œæˆæˆ–å¤±è´¥
5.  åŒæ—¶ï¼Œæ¯ä¸ª`PodVolumeBackup` ç”±ç›¸åº”èŠ‚ç‚¹ä¸Šçš„æ§åˆ¶å™¨å¤„ç†ï¼š
    *   å…·æœ‰`/var/lib/kubelet/pods`çš„ hostPath å·æŒ‚è½½ä»¥è®¿é—® Pod å·æ•°æ®
    *   åœ¨ä¸Šè¿°å·ä¸­æ‰¾åˆ° pod å·çš„å­ç›®å½•
    *   è¿è¡Œ`restic backup`
    *   å°†è‡ªå®šä¹‰èµ„æºçš„çŠ¶æ€æ›´æ–°ä¸ºâ€œCompletedâ€æˆ–â€œFailedâ€
6.  æ¯ä¸ª`PodVolumeBackup` å®Œæˆæ—¶ï¼Œä¸» Velero è¿›ç¨‹ä¼šå°†å…¶æ·»åŠ åˆ°åä¸º`<backup-name>-podvolumebackups.json.gz` çš„æ–‡ä»¶ä¸­çš„ Velero å¤‡ä»½ä¸­ã€‚ è¯¥æ–‡ä»¶ä¸å¤‡ä»½ tarball ä¸€èµ·ä¸Šä¼ åˆ°å¯¹è±¡å­˜å‚¨ã€‚ å®ƒå°†ç”¨äºè¿˜åŸï¼Œå¦‚ä¸‹ä¸€èŠ‚æ‰€è¿°ã€‚

#### è¿˜åŸ

1.  Velero çš„ä¸»è¦è¿˜åŸè¿‡ç¨‹å°†æ£€æŸ¥é›†ç¾¤ä¸­æ¯ä¸ªè¦å¤‡ä»½çš„ç°æœ‰`PodVolumeBackup` è‡ªå®šä¹‰èµ„æºã€‚
    
2.  å¯¹äºæ‰¾åˆ°çš„æ¯ä¸ª`PodVolumeBackup` ï¼ŒVelero é¦–å…ˆé€šè¿‡ä»¥ä¸‹æ–¹æ³•ç¡®ä¿è¯¥ pod çš„å‘½åç©ºé—´å­˜åœ¨ä¸€ä¸ª Restic å­˜å‚¨åº“ï¼š
    
    *   æ£€æŸ¥`ResticRepository` è‡ªå®šä¹‰èµ„æºæ˜¯å¦å·²ç»å­˜åœ¨
    *   å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°ä»“åº“ï¼Œç„¶åç­‰å¾…`ResticRepository` æ§åˆ¶å™¨åˆå§‹åŒ–/æ£€æŸ¥å®ƒï¼ˆè¯·æ³¨æ„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®é™…çš„ä»“åº“åº”è¯¥å·²ç»å­˜åœ¨äºå¯¹è±¡å­˜å‚¨ä¸­ï¼Œå› æ­¤ Velero æ§åˆ¶å™¨å°†åªå¯¹å…¶è¿›è¡Œå®Œæ•´æ€§æ£€æŸ¥ï¼‰
3.  Velero å°†ä¸€ä¸ªåˆå§‹åŒ–å®¹å™¨æ·»åŠ åˆ°äº† pod ä¸­ï¼Œè¯¥å®¹å™¨çš„å·¥ä½œæ˜¯ç­‰å¾…æ‰€æœ‰è¿˜åŸæ¢å¤ä»¥å®Œæˆå®¹å™¨ï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»ï¼‰
    
4.  Velero é€šè¿‡å°†å…¶æäº¤åˆ° Kubernetes API æ¥åˆ›å»ºå…·æœ‰æ·»åŠ çš„ init container çš„ pod
    
5.  Velero ä¸ºè¦åœ¨è¢«è¿˜åŸçš„æ¯ä¸ª Pod ä¸­åˆ›å»º`PodVolumeRestore` è‡ªå®šä¹‰èµ„æº
    
6.  ç°åœ¨ï¼Œä¸»è¦çš„ Velero è¿›ç¨‹ç­‰å¾…æ¯ä¸ª`PodVolumeRestore` èµ„æºå®Œæˆæˆ–å¤±è´¥
    
7.  åŒæ—¶ï¼Œæ¯ä¸ª`PodVolumeRestore` ç”±ç›¸åº”èŠ‚ç‚¹ä¸Šçš„æ§åˆ¶å™¨å¤„ç†ï¼š
    
    *   å…·æœ‰`/var/lib/kubelet/pods`çš„ hostPath å·æŒ‚è½½ä»¥è®¿é—® Pod å·æ•°æ®
        
    *   ç­‰å¾… pod è¿è¡Œ init å®¹å™¨
        
    *   åœ¨ä¸Šè¿°å·ä¸­æ‰¾åˆ° pod å·çš„å­ç›®å½•
        
    *   è¿è¡Œ`restic restore`
        
    *   æˆåŠŸåï¼Œå°†æ–‡ä»¶å†™å…¥ Pod å·ä¸­çš„`.velero`å­ç›®å½•ä¸­ï¼Œè¯¥æ–‡ä»¶çš„åç§°æ˜¯æ­¤ Pod å·è¿˜åŸç”¨äºçš„ Velero è¿˜åŸçš„ UIDã€‚
        
    *   å°†è‡ªå®šä¹‰èµ„æºçš„çŠ¶æ€æ›´æ–°ä¸ºâ€œCompletedâ€æˆ–â€œFailedâ€
        
8.  æ·»åŠ åˆ° Pod çš„ init å®¹å™¨æ­£åœ¨è¿è¡Œä¸€ä¸ªè¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¸€ç›´ç­‰åˆ°å®ƒåœ¨æ¯ä¸ªå·²è¿˜åŸå·ä¸­çš„`.velero` ä¸‹æ‰¾åˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶åç§°æ˜¯æ­£åœ¨è¿è¡Œçš„ Velero è¿˜åŸçš„ UID
    
9.  æ‰¾åˆ°æ‰€æœ‰æ­¤ç±»æ–‡ä»¶åï¼Œåˆå§‹åŒ–å®¹å™¨çš„è¿‡ç¨‹å°†æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸” pod å°†ç»§ç»­è¿è¡Œå…¶ä»–åˆå§‹åŒ–å®¹å™¨/ä¸»å®¹å™¨ã€‚
    

### ç¬¬ä¸‰æ–¹æ§åˆ¶å™¨

#### ç›‘æ§å¤‡ä»½æ³¨é‡Š

Velero æ²¡æœ‰æä¾›ä¸€ç§æœºåˆ¶æ¥æ£€æµ‹ç¼ºå°‘ restic å¤‡ä»½æ³¨é‡Šçš„æŒä¹…å·å£°æ˜ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒThomann Bitsï¼†Beats ç¼–å†™äº†ä¸€ä¸ªæ§åˆ¶å™¨ï¼š[`velero-pvc-watcher`](https://github.com/bitsbeats/velero-pvc-watcher)

ä½¿ç”¨ - é›†ç¾¤è¿ç§»
---------

ä½¿ç”¨ _Backups_ å’Œ _Restores_

åªè¦æ‚¨å°†æ¯ä¸ª Velero å®ä¾‹æŒ‡å‘ç›¸åŒçš„äº‘å¯¹è±¡å­˜å‚¨ä½ç½®ï¼ŒVelero å°±èƒ½å¸®åŠ©æ‚¨å°†èµ„æºä»ä¸€ä¸ªç¾¤é›†ç§»æ¤åˆ°å¦ä¸€ä¸ªç¾¤é›†ã€‚ æ­¤æ–¹æ¡ˆå‡å®šæ‚¨çš„ç¾¤é›†ç”±åŒä¸€äº‘æä¾›å•†æ‰˜ç®¡ã€‚ è¯·æ³¨æ„ï¼ŒVelero æœ¬èº«ä¸æ”¯æŒè·¨äº‘æä¾›ç¨‹åºè¿ç§»æŒä¹…å·å¿«ç…§ã€‚ å¦‚æœè¦åœ¨äº‘å¹³å°ä¹‹é—´è¿ç§»å·æ•°æ®ï¼Œè¯·å¯ç”¨ resticï¼Œå®ƒå°†åœ¨æ–‡ä»¶ç³»ç»Ÿçº§åˆ«å¤‡ä»½å·å†…å®¹ã€‚

1.  ï¼ˆé›†ç¾¤ 1ï¼‰å‡è®¾æ‚¨å°šæœªä½¿ç”¨ Velero `schedule` æ“ä½œå¯¹æ•°æ®è¿›è¡Œæ£€æŸ¥ç‚¹æ£€æŸ¥ï¼Œåˆ™éœ€è¦é¦–å…ˆå¤‡ä»½æ•´ä¸ªç¾¤é›†ï¼ˆæ ¹æ®éœ€è¦æ›¿æ¢`<BACKUP-NAME>`ï¼‰ï¼š
    
        velero backup create <BACKUP-NAME>
        
    
    é»˜è®¤å¤‡ä»½ä¿ç•™æœŸé™ä»¥ TTLï¼ˆæœ‰æ•ˆæœŸï¼‰è¡¨ç¤ºï¼Œä¸º 30 å¤©ï¼ˆ720 å°æ—¶ï¼‰ï¼› æ‚¨å¯ä»¥ä½¿ç”¨`--ttl <DURATION>`æ ‡å¿—æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ”¹ã€‚ æœ‰å…³å¤‡ä»½åˆ°æœŸçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [velero çš„å·¥ä½œåŸç†](https://velero.io/docs/v1.8/how-velero-works/)ã€‚
    
2.  ï¼ˆé›†ç¾¤ 2ï¼‰é…ç½®`BackupStorageLocations`å’Œ`VolumeSnapshotLocations`, æŒ‡å‘ _é›†ç¾¤ 1_ ä½¿ç”¨çš„ä½ç½®ï¼Œä½¿ç”¨`velero backup-location create`å’Œ`velero snapshot-location create`. ç¡®ä¿é…ç½®`BackupStorageLocations`ä¸º read-only é€šè¿‡åœ¨`velero backup-location create`æ—¶ä½¿ç”¨`--access-mode=ReadOnly` flag
    
3.  ï¼ˆé›†ç¾¤ 2ï¼‰ç¡®ä¿å·²åˆ›å»º Velero Backup å¯¹è±¡ã€‚ Velero èµ„æºä¸äº‘å­˜å‚¨ä¸­çš„å¤‡ä»½æ–‡ä»¶åŒæ­¥ã€‚
    
        velero backup describe <BACKUP-NAME>
        
    
    **æ³¨æ„**ï¼šé»˜è®¤åŒæ­¥é—´éš”ä¸º 1 åˆ†é’Ÿï¼Œå› æ­¤è¯·ç¡®ä¿åœ¨æ£€æŸ¥ä¹‹å‰ç­‰å¾…ã€‚ æ‚¨å¯ä»¥ä½¿ç”¨ Velero æœåŠ¡å™¨çš„`--backup-sync-period`æ ‡å¿—é…ç½®æ­¤é—´éš”ã€‚
    
4.  ï¼ˆé›†ç¾¤ 2ï¼‰ä¸€æ—¦ç¡®è®¤ç°åœ¨å­˜åœ¨æ­£ç¡®çš„å¤‡ä»½ï¼ˆ`<BACKUP-NAME>`ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è¿˜åŸæ‰€æœ‰å†…å®¹ï¼š
    
        velero restore create --from-backup <BACKUP-NAME>
        
    

### éªŒè¯ 2 ä¸ªé›†ç¾¤

æ£€æŸ¥ç¬¬äºŒä¸ªç¾¤é›†æ˜¯å¦æŒ‰é¢„æœŸè¿è¡Œï¼š

1.  ï¼ˆé›†ç¾¤ 2) è¿è¡Œï¼š
    
        velero restore get
        
    
2.  ç„¶åè¿è¡Œï¼š
    
        velero restore describe <RESTORE-NAME-FROM-GET-COMMAND>
        
    

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·ç¡®ä¿ Velero åœ¨ä¸¤ä¸ªç¾¤é›†ä¸­çš„ç›¸åŒ namespace ä¸­è¿è¡Œã€‚

ä½¿ç”¨ - èµ„æºè¿‡æ»¤
---------

æŒ‰ namespaceã€ç±»å‹æˆ–æ ‡ç­¾ç­›é€‰å¯¹è±¡ã€‚

å½“ä¸ä½¿ç”¨ä»»ä½•ç­›é€‰é€‰é¡¹æ—¶ï¼ŒVelero ä¼šå°†æ‰€æœ‰å¯¹è±¡åŒ…æ‹¬åœ¨å¤‡ä»½æˆ–è¿˜åŸä¸­ã€‚

### Includes

ä»…åŒ…æ‹¬ç‰¹å®šèµ„æºï¼Œä¸åŒ…æ‹¬æ‰€æœ‰å…¶ä»–èµ„æºã€‚

å¦‚æœåŒæ—¶åŒ…å«é€šé…ç¬¦å’Œç‰¹å®šèµ„æºï¼Œåˆ™é€šé…ç¬¦ä¼˜å…ˆã€‚

#### `â€“include-namespaces`

*   å¤‡ä»½ namespace åŠå…¶å¯¹è±¡ã€‚
    
        velero backup create <backup-name> --include-namespaces <namespace>
        
    
*   æ¢å¤ä¸¤ä¸ª namespace åŠå…¶å¯¹è±¡ã€‚
    
        velero restore create <backup-name> --include-namespaces <namespace1>,<namespace2>
        
    

#### `â€“include-resources`

*   å¤‡ä»½é›†ç¾¤ä¸­çš„æ‰€æœ‰ deployments:
    
        velero backup create <backup-name> --include-resources deployments
        
    
*   æ¢å¤é›†ç¾¤ä¸­çš„æ‰€æœ‰ deployments å’Œ configmapsã€‚
    
        velero restore create <backup-name> --include-resources deployments,configmaps
        
    
*   åœ¨ namespace ä¸­å¤‡ä»½ deploymentsã€‚
    
        velero backup create <backup-name> --include-resources deployments --include-namespaces <namespace>
        
    

#### `â€“include-cluster-resources`

æ­¤é€‰é¡¹å¯ä»¥å…·æœ‰ä¸‰ä¸ªå¯èƒ½çš„å€¼ï¼š

*   `true`: åŒ…æ‹¬æ‰€æœ‰ç¾¤é›†èŒƒå›´çš„èµ„æºã€‚
    
*   `false`: ä¸åŒ…æ‹¬ç¾¤é›†èŒƒå›´çš„èµ„æºã€‚
    
*   `nil`("auto"æˆ–ä¸æä¾›ï¼‰:
    
    *   å¤‡ä»½æˆ–è¿˜åŸæ‰€æœ‰ namespace æ—¶ï¼Œå°†åŒ…æ‹¬ç¾¤é›†èŒƒå›´çš„èµ„æºã€‚ é»˜è®¤å€¼ï¼š`true`ã€‚
    *   ä½¿ç”¨ namespace è¿‡æ»¤æ—¶ï¼Œä¸åŒ…æ‹¬ç¾¤é›†èŒƒå›´çš„èµ„æºã€‚ é»˜è®¤å€¼ï¼š`false`
        *   é™¤é`--include-cluster-resources = false`ï¼Œå¦åˆ™å¦‚æœç”±è‡ªå®šä¹‰æ“ä½œï¼ˆä¾‹å¦‚ï¼ŒPVC-> PVï¼‰è§¦å‘æŸäº›ç›¸å…³çš„ç¾¤é›†ä½œç”¨åŸŸèµ„æºï¼Œåˆ™å¯èƒ½ä»ä¼šè¿›è¡Œå¤‡ä»½/è¿˜åŸã€‚
*   å¤‡ä»½æ•´ä¸ªç¾¤é›†ï¼ŒåŒ…æ‹¬ç¾¤é›†èŒƒå›´å†…çš„èµ„æºã€‚
    
        velero backup create <backup-name>
        
    
*   ä»…è¿˜åŸç¾¤é›†ä¸­çš„å‘½åç©ºé—´èµ„æºã€‚
    
        velero restore create <backup-name> --include-cluster-resources=false
        
    
*   å¤‡ä»½ namespace å¹¶åŒ…æ‹¬ç¾¤é›†èŒƒå›´çš„èµ„æºã€‚
    
        velero backup create <backup-name> --include-namespaces <namespace> --include-cluster-resources=true 
        
    

#### `â€“selector`

åŒ…æ‹¬ä¸ label selector åŒ¹é…çš„èµ„æºã€‚

    velero backup create <backup-name> --selector <key>=<value>
    

### Excludes

ä»å¤‡ä»½ä¸­æ’é™¤ç‰¹å®šèµ„æºã€‚

é€šé…ç¬¦æ’é™¤å°†è¢«å¿½ç•¥ã€‚

#### `â€“exclude-namespaces`

*   Exclude `kube-system` from the cluster backup.
    
        velero backup create <backup-name> --exclude-namespaces kube-system
        
    
*   è¿˜åŸæœŸé—´æ’é™¤ä¸¤ä¸ª namespaceã€‚
    
        velero restore create <backup-name> --exclude-namespaces <namespace1>,<namespace2>
        
    

#### `â€“exclude-resources`

*   ä»å¤‡ä»½ä¸­æ’é™¤ secrets:
    
        velero backup create <backup-name> --exclude-resources secrets
        
    
*   æ’é™¤ secrets å’Œ rolebindings:
    
        velero backup create <backup-name> --exclude-resources secrets,rolebindings
        
    

#### `velero.io/exclude-from-backup=true`

æ ‡ç­¾ä¸º`velero.io/exclude-from-backup=true`çš„èµ„æºä¸åŒ…æ‹¬åœ¨å¤‡ä»½ä¸­ï¼Œå³ä½¿å®ƒåŒ…å«åŒ¹é…çš„é€‰æ‹©å™¨æ ‡ç­¾ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

ç³»åˆ—æ–‡ç« 
----

*   [Velero ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Velero/)

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [Velero Docs - Overview](https://velero.io/docs/v1.8/index.html)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.