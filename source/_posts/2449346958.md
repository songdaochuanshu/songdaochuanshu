---
layout: post
title: "如何设计一个秒杀系统？"
date: "2022-06-07T04:29:44.802Z"
---
如何设计一个秒杀系统？
===========

秒杀系统主要是有三个特点**高性能**、**高并发**、**高可用**。

从一次秒杀的流程出发，考虑秒杀系统的三个特点，那么就可以设计一个秒杀系统。

1\. 秒杀页面获取
----------

优化方案：

1.  动静分离。将页面的静态资源等部署到Nginx或者CDN，这样可以加快秒杀页面获取。
2.  静态资源合并获取。通过将多个请求合并为单个请求，一次获取多个静态资源，这样可以加快秒杀页面获取。
3.  服务降级。秒杀页面做服务降级处理，将商品推荐列表、评论等做降级处理，少显示或者不显示。秒杀页面需要登录才能查看，对未登录用户直接返回登录界面。
4.  服务监控。对流量进行监控，使用令牌桶算法等限流算法对流量进行控制。有必要时将部分任务进行熔断。
5.  页面数据缓存。将页面数据缓存到Redis中，减少数据库操作。
6.  秒杀连接加盐。使URL动态化，可以减少非法用户操作。

2\. 商品下单
--------

优化方案：

1.  前端/后端限流。前端/客户端防抖。限制时间间隔内的下单次数。
2.  防机器人刷单。对下单操作增加填写验证码步骤，如：55+44=？、“你好”的小写拼音、选出所有飞机等问题，将非法请求过滤掉。
3.  商品下单预扣库存。数据库表设计的时候需要设置锁库存字段。进行秒杀的时候，减少库存将在Redis中使用分布式锁进行操作。其它后续操作可以使用RabbitMQ进行操作。
4.  商品下单预扣库存（库存预热）可以添加延时队列。将超时商品转发到死信路由，然后进行操作。
5.  商品下单可以进行异步操作，如双次验价等操作可以使用多线程。

3\. 支付
------

优化方案：

1.  将支付划分为一个单独的系统，只开放对应的支付接口。因为支付系统是金融敏感的，所以应该保证支付系统的高可用。
2.  回滚机制。建议使用分布式事务，对支付业务进行TCC事务，因为支付系统是金融敏感的。

* * *

于是，秒杀系统一般会引入MQ、Redis、MySQL、Nginx等中间件，需要对每个中间件进行**高性能**、**高并发**、**高可用**的分析。

MQ
--

优化方案：

1.  集群部署。MQ系统一般都是集群部署的，进行镜像集群部署，可以提升系统的可用性。
2.  开启持久化。对MQ系统中的信息开启持久化，将其刷到硬盘内，防止宕机。
3.  关闭消费自动ACK，需要进行手动ACK。防止信息消费异常。

Redis
-----

优化方案：

1.  Redis进行读写分离，Master节点进行写操作，其他节点进行读操作。
2.  Redis进行哨兵部署，让某一个节点宕机后可以迅速有机器顶替上。
3.  Redis进行分片集群部署，让请求分布到每一台Redis机器上。
4.  开启持久化日志。AOF和RDB根据业务状况进行调整。
5.  一个系统可以有多个Redis集群，例如页面数据和商品下单两个方面的Redis可以用多个集群的Redis。

MySQL
-----

优化方案：

1.  根据业务建立索引。唯一索引、普通索引、联合索引等。
2.  看业务是否有优化的地方，减少回表操作。
3.  分库分表。MySQL应该进行集群部署，单台Redis一般只有2000QPS左右。
    1.  分库。使用MyCat或者ShardingSphere等进行分库，将操作通过算法分配到相对应的机器上面。
    2.  分表。分表有垂直划分和水平划分两种。垂直划分是将部分字段分割到其它表上面。水平划分是将数据水平划分到同一数据库中的不同表上面，避免一个表上面的数据过大。
    3.  一般来说，建议分32个库，每个库分32张表，这样完全能够满足大部分企业的需求。
4.  MySQL的瓶颈是磁盘IO，可以更换固态硬盘。

Nginx
-----

优化方案：

1.  动静分离。将静态资源部署到Nginx中，无需到其它中间件中查询。
2.  Nginx可以开启限流操作。令牌桶和露铜算法都支持。
3.  Nginx开启负载均衡，将服务请求打到不同的服务器上，降低单台服务器压力。

* * *

除了上面列出来的，还有很多的优化操作。

热点数据分离
------

热点商品和普通商品使用的系统可以隔离开来，这样即使秒杀系统宕机了，普通的商品下单也不会有任何问题。

1.  秒杀商品放到热点数据系统内。
2.  直播商品也可以放到热点数据系统内。
3.  流量监控。可以将下单比较多的商品放到热点数据系统内。
4.  商家上报。商家可以将未来可能售卖较多的商品上报，放到热点数据系统内。
5.  数据分析。分析以往数据，得出一些未来可能售卖较多的商品，放到热点数据系统内。

* * *

性能优化
----

最后可以进行机器上面的性能优化。

1.  更换CPU
2.  更换内存
3.  更换速度更快的硬盘
4.  更新Linux系统内核
5.  更新软件系统稳定版本
6.  关闭Linux上面一些无用的服务

* * *

秒杀系统主要是有三个特点**高性能**、**高并发**、**高可用**。只要对这三个点进行思考，那么就会慢慢得出一个秒杀系统。