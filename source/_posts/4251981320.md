---
layout: post
title: "è®°ä¸€æ¬¡ .NET æŸå®‰å…¨ç”Ÿäº§ä¿¡æ¯ç³»ç»Ÿ CPUçˆ†é«˜åˆ†æ"
date: "2022-12-19T20:19:07.490Z"
---
è®°ä¸€æ¬¡ .NET æŸå®‰å…¨ç”Ÿäº§ä¿¡æ¯ç³»ç»Ÿ CPUçˆ†é«˜åˆ†æ
==========================

ä¸€ï¼šèƒŒæ™¯
----

### 1.è®²æ•…äº‹

ä»Šå¤©æ˜¯ğŸçš„ç¬¬å››å¤©ï¼Œå¤´ç»ˆäºä¸å·¨ç–¼äº†ï¼Œå†™æ–‡ç« å·²ç»æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œèµ¶ç´§çˆ¬èµ·æ¥å†™ã€‚

è¿™ä¸ªæœˆåˆæœ‰ä½æœ‹å‹æ‰¾åˆ°æˆ‘ï¼Œè¯´ä»–çš„ç¨‹åºå‡ºç°äº†CPUçˆ†é«˜ï¼Œè®©æˆ‘å¸®å¿™çœ‹ä¸‹æ€ä¹ˆå›äº‹ï¼Œç®€å•åˆ†æäº†ä¸‹æœ‰ä¸¤ç‚¹æ¯”è¾ƒæœ‰æ„æ€ã€‚

1.  è¿™æ˜¯ä¸€ä¸ªå®‰å…¨ç”Ÿäº§çš„ä¿¡æ¯ç®¡ç†å¹³å°ï¼Œç¬¬ä¸€æ¬¡å¬è¯´ï¼Œæˆ‘çš„æ ¼å±€å°äº†ã€‚
    
2.  è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„ CPU çˆ†é«˜é—®é¢˜ï¼Œè¿‡å¾€è™½æœ‰åˆ†æï¼Œä½†æ²¡æœ‰åˆ¨æ ¹é—®åº•ï¼Œåˆšå¥½è¿™ä¸€ç¯‡å°±æ¥é—®ä¸€ä¸‹åº•å§ã€‚
    

è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬ä¸Š WinDbg è¯´è¯ã€‚

äºŒï¼šWinDbg åˆ†æ
-----------

### 1\. çœŸçš„ CPU çˆ†é«˜å—ï¼Ÿ

åˆ«äººè¯´çˆ†é«˜ä¸ç®—ï¼Œæˆ‘ä»¬å¾—æ‹¿æ•°æ®è¯´è¯ä¸æ˜¯ï¼ŒéªŒè¯å‘½ä»¤å°±æ˜¯ `!tp`ã€‚

    
    0:085> !tp
    CPU utilization: 100%
    Worker Thread: Total: 40 Running: 26 Idle: 6 MaxLimit: 32767 MinLimit: 8
    Work Request in Queue: 0
    --------------------------------------
    Number of Timers: 0
    --------------------------------------
    Completion Port Thread:Total: 1 Free: 1 MaxFree: 16 CurrentLimit: 1 MaxLimit: 1000 MinLimit: 8
    
    

ä»å¦ä¸­çœ‹æœç„¶æ˜¯è¢«æ‰“æ»¡äº†ï¼Œæ¥ä¸‹æ¥å¯ä»¥ç”¨ `~*e !clrstack` è§‚å¯Ÿå„ä¸ªçº¿ç¨‹éƒ½åœ¨åšä»€ä¹ˆï¼Œç¨å¾®ä¸€è§‚å¯Ÿå°±ä¼šå‘ç°æœ‰å¾ˆå¤šçš„çº¿ç¨‹å¡åœ¨ `FindEntry()` æ–¹æ³•ä¸Šï¼Œæˆªå›¾å¦‚ä¸‹ï¼š

![](https://img2023.cnblogs.com/blog/214741/202212/214741-20221219182141664-566296860.png)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ 25 ä¸ªçº¿ç¨‹éƒ½åœåœ¨ `FindEntry()` ä¹‹ä¸Šï¼Œå¦‚æœä½ çš„ç»éªŒæ¯”è¾ƒä¸°å¯Œçš„è¯ï¼Œæˆ‘ç›¸ä¿¡ä½ é©¬ä¸Šå°±çŸ¥é“è¿™æ˜¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨äº†éçº¿ç¨‹å®‰å…¨é›†åˆ `Dictionary` é€ æˆçš„æ­»å¾ªç¯ï¼ŒæŠŠ CPU ç›´æ¥æ‰“çˆ†ã€‚

æŒ‰ä»¥å¾€å¥—è·¯åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œä»Šå¤©æˆ‘ä»¬ä¸€å®šè¦åˆ¨åˆ°åº•ã€‚

### 2\. ä¸ºä»€ä¹ˆä¼šå‡ºç°æ­»å¾ªç¯

è¦çŸ¥é“æ­»å¾ªç¯çš„æˆå› ï¼Œé‚£å°±ä¸€å®šè¦ä» `FindEntry` ä¸Šå…¥æ‰‹ã€‚

    
    private int FindEntry(TKey key)
    {
        if (key == null)
        {
            ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
        }
        if (buckets != null)
        {
            int num = comparer.GetHashCode(key) & 0x7FFFFFFF;
            for (int num2 = buckets[num % buckets.Length]; num2 >= 0; num2 = entries[num2].next)
            {
                if (entries[num2].hashCode == num && comparer.Equals(entries[num2].key, key))
                {
                    return num2;
                }
            }
        }
        return -1;
    }
    
    

ä»”ç»†è§‚å¯Ÿä¸Šé¢çš„ä»£ç ï¼Œå¦‚æœçœŸæœ‰æ­»å¾ªç¯è‚¯å®šæ˜¯åœ¨ `for` ä¸­å‡ºä¸æ¥ï¼Œå¦‚æœæ˜¯çœŸçš„å‡ºåœ¨ `for` ä¸Šï¼Œé‚£é—®é¢˜è‡ªç„¶åœ¨ `next` æŒ‡é’ˆä¸Šã€‚

> å…³äº Dictionary çš„å†…éƒ¨å¸ƒå±€å’Œè§£æ å¯ä»¥å‚è§æˆ‘çš„ **[é«˜çº§è°ƒè¯•è®­ç»ƒè¥](https://mp.weixin.qq.com/s?__biz=MjM5MzI5Mzg1OA==&mid=2247495943&idx=1&sn=bffc0e4a4b8e324f912bf3d79b8a86ca&chksm=a69b824a91ec0b5c4ff77dbf22c3fb61b54984bf13d386218860bcd44363573210e66d97d142&token=103031729&lang=zh_CN#rd)**ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸ç»†è¯´äº†ã€‚

é‚£æ˜¯ä¸æ˜¯å‡ºåœ¨ next æŒ‡é’ˆä¸Šå‘¢ï¼Ÿ æˆ‘ä»¬æ¥å‰–æä¸‹æ–¹æ³•ä¸Šä¸‹æ–‡ã€‚

### 3\. è§‚å¯Ÿ next æŒ‡é’ˆå¸ƒå±€

ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œå…ˆåˆ‡åˆ° `85` å·çº¿ç¨‹ã€‚

    
    0:085> ~85s
    mscorlib_ni!System.Collections.Generic.Dictionary<string,F2.xxx.ORM.SqlEntity>.FindEntry+0x8f:
    00007ff8`5f128ccf 488b4e10        mov     rcx,qword ptr [rsi+10h] ds:0000017f`39c07d00=0000017eb9ee00c0
    0:085> !clrstack
    OS Thread Id: 0x4124 (85)
            Child SP               IP Call Site
    0000007354ebcc70 00007ff85f128ccf System.Collections.Generic.Dictionary`2[[System.__Canon, mscorlib],[System.__Canon, mscorlib]].FindEntry(System.__Canon) [f:\dd\ndp\clr\src\BCL\system\collections\generic\dictionary.cs @ 305]
    
    

æ¥ä¸‹æ¥æŠŠ `Dictionary` ä¸­çš„ `Entry[]` ä¸­çš„ next ç»™å±•ç¤ºå‡ºæ¥ï¼Œå¯ä»¥ç”¨ `!mdso` å‘½ä»¤ã€‚

    
    0:085> !mdso
    Thread 85:
    Location          Object            Type
    ------------------------------------------------------------
    RCX:              0000017eb9ee00c0  System.Collections.Generic.Dictionary`2+Entry[[System.String, mscorlib],[xx]][]
    RSI:              0000017f39c07cf0  System.Collections.Generic.Dictionary`2[[System.String, mscorlib],[xxx.xxx]]
    
    0:085> !mdt -e:2 0000017eb9ee00c0
    0000017eb9ee00c0 (System.Collections.Generic.Dictionary`2+Entry[[System.String, mscorlib],[xxx.xxx]][], Elements: 3, ElementMT=00007ff816cedc18)
    [0] (System.Collections.Generic.Dictionary`2+Entry[[System.String, mscorlib],[F2.xxx]]) VALTYPE (MT=00007ff816cedc18, ADDR=0000017eb9ee00d0)
        hashCode:0x0 (System.Int32)
        next:0x0 (System.Int32)
        key:NULL (System.__Canon)
        value:NULL (System.__Canon)
    [1] (System.Collections.Generic.Dictionary`2+Entry[[System.String, mscorlib],[F2.xxx]]) VALTYPE (MT=00007ff816cedc18, ADDR=0000017eb9ee00e8)
        hashCode:0x5aba4760 (System.Int32)
        next:0xffffffff (System.Int32)
        key:0000017f39c0ab50 (System.String) Length=20, String="xxxMessage_Select"
        value:0000017f39c0b5d0 (xxx.xxx.ORM.SqlEntity)
    [2] (System.Collections.Generic.Dictionary`2+Entry[[System.String, mscorlib],[F2.xxx]]) VALTYPE (MT=00007ff816cedc18, ADDR=0000017eb9ee0100)
        hashCode:0x65b6e27b (System.Int32)
        next:0x1 (System.Int32)
        key:0000017f39c09d58 (System.String) Length=20, String="xxxMessage_Insert"
        value:0000017f39c0ba50 (xxx.xxx.ORM.SqlEntity)
    
    

ä»å¦ä¸­çœ‹ä¹Ÿè›®å¥‡è‘©çš„ï¼Œåªæœ‰ä¸‰ä¸ªå…ƒç´ çš„ `Dictionary` è¿˜èƒ½æ­»å¾ªç¯ã€‚ã€‚ã€‚å¦‚æœä½ ä»”ç»†è§‚å¯Ÿä¼šå‘ç° `[0]` é¡¹æ˜¯ä¸€ç§æœ‰æŸçŠ¶æ€ï¼Œvalue æ²¡å€¼ä¸è¯´ï¼Œ `next:0x0` å¯æ˜¯æœ‰å¤§é—®é¢˜çš„ï¼Œå®ƒä¼šæ°¸è¿œæŒ‡å‘è‡ªå·±ï¼Œå› ä¸º next æ˜¯æŒ‡å‘ hash æŒ‚é“¾ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°ç»„ä¸‹æ ‡ï¼Œç”»ä¸ªå›¾å¤§æ¦‚æ˜¯è¿™æ ·ã€‚

![](https://img2023.cnblogs.com/blog/214741/202212/214741-20221219182141684-31414010.png)

æ¥ä¸‹æ¥æˆ‘ä»¬éªŒè¯ä¸‹æ˜¯ä¸æ˜¯å…¥å£å‚æ•°ä¸å¹¸è¿›å…¥äº† `[0]` å·å‘ï¼Œç„¶ååœ¨è¿™ä¸ªå‘ä¸­æ°¸è¿œæŒ‡å‘è‡ªå·±å‘¢ï¼Ÿè¦æƒ³å¯»æ‰¾ç­”æ¡ˆï¼Œåªéœ€è¦åœ¨ `FindEntry` çš„æ±‡ç¼–ä»£ç ä¸­æ‰¾åˆ° `int num = comparer.GetHashCode(key) & 0x7FFFFFFF;` ä¸­çš„ num å€¼ï¼Œçœ‹å®ƒæ˜¯ä¸æ˜¯ 0 å³å¯ã€‚

    
    0:085> !U /d 00007ff85f128ccf
    preJIT generated code
    System.Collections.Generic.Dictionary`2[[System.__Canon, mscorlib],[System.__Canon, mscorlib]].FindEntry(System.__Canon)
    Begin 00007ff85f128c40, size 130. Cold region begin 00007ff85ff07ff0, size 11
    ...
    f:\dd\ndp\clr\src\BCL\system\collections\generic\dictionary.cs @ 303:
    00007ff8`5f128c6f 488b5e18        mov     rbx,qword ptr [rsi+18h]
    00007ff8`5f128c73 488b0e          mov     rcx,qword ptr [rsi]
    00007ff8`5f128c76 488b5130        mov     rdx,qword ptr [rcx+30h]
    00007ff8`5f128c7a 488b2a          mov     rbp,qword ptr [rdx]
    00007ff8`5f128c7d 4c8b5d18        mov     r11,qword ptr [rbp+18h]
    00007ff8`5f128c81 4d85db          test    r11,r11
    00007ff8`5f128c84 750f            jne     mscorlib_ni!System.Collections.Generic.Dictionary<string,xxx.SqlEntity>.FindEntry+0x55 (00007ff8`5f128c95)
    00007ff8`5f128c86 488d154d2f1800  lea     rdx,[mscorlib_ni+0x68bbda (00007ff8`5f2abbda)]
    00007ff8`5f128c8d e8ce44f3ff      call    mscorlib_ni+0x43d160 (00007ff8`5f05d160) (mscorlib_ni)
    00007ff8`5f128c92 4c8bd8          mov     r11,rax
    00007ff8`5f128c95 488bcb          mov     rcx,rbx
    00007ff8`5f128c98 488bd7          mov     rdx,rdi
    00007ff8`5f128c9b 3909            cmp     dword ptr [rcx],ecx
    00007ff8`5f128c9d 41ff13          call    qword ptr [r11]
    00007ff8`5f128ca0 8bd8            mov     ebx,eax
    00007ff8`5f128ca2 81e3ffffff7f    and     ebx,7FFFFFFFh
    ...
    
    0:085> ? ebx
    Evaluate expression: 957083499 = 00000000`390bef6b
    
    0:085> ? 0n957083499 % 0n3
    Evaluate expression: 0 = 00000000`00000000
    
    

ä»æ±‡ç¼–ä»£ç ä¸­åˆ†æå¾—å‡ºï¼Œnum æ˜¯æ”¾åœ¨ `ebx` å¯„å­˜å™¨ä¸Šï¼Œæ­¤æ—¶ `num=957083499`ï¼Œå† `%3` ä¹‹åå°±æ˜¯ 0 å·å‘ï¼Œå¤§å®¶å†ç»“åˆæºä»£ç ï¼Œä½ ä¼šå‘ç°è¿™é‡Œæ°¸è¿œéƒ½ä¸ä¼šé€€å‡ºï¼Œæ°¸è¿œéƒ½æ˜¯æŒ‡å‘è‡ªå·±ï¼Œè‡ªç„¶å°±æ˜¯æ­»å¾ªç¯äº†ã€‚

### 3\. .NET6 ä¸‹çš„è¡¥å……

å‰æ®µæ—¶é—´åœ¨æ•´ç†è¯¾ä»¶æ—¶å‘ç°åœ¨ .NET6 ä¸­ä¸å†å‚»å‚»çš„æ­»å¾ªç¯ï¼Œè€Œæ˜¯åœ¨å°è¯• `entries.Length` æ¬¡ä¹‹åè¿˜å¾—ä¸åˆ°ç»“æŸçš„è¯ï¼Œå¼ºåˆ¶æŠ›å‡ºå¼‚å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š

    
    internal ref TValue FindValue(TKey key)
    {
        uint hashCode2 = (uint)comparer.GetHashCode(key);
        int bucket2 = GetBucket(hashCode2);
        Entry[] entries2 = _entries;
        uint num2 = 0u;
        bucket2--;
        while ((uint)bucket2 < (uint)entries2.Length)
        {
            reference = ref entries2[bucket2];
            if (reference.hashCode != hashCode2 || !comparer.Equals(reference.key, key))
            {
                bucket2 = reference.next;
                num2++;
                if (num2 <= (uint)entries2.Length)
                {
                    continue;
                }
                goto IL_0171;
            }
            goto IL_0176;
        }
    
        return ref Unsafe.NullRef<TValue>();
    IL_0176:
        return ref reference.value;
    IL_0171:
        ThrowHelper.ThrowInvalidOperationException_ConcurrentOperationsNotSupported();
        goto IL_0176;
    }
    
    

å¯èƒ½æ˜¯ **.NETå›¢é˜Ÿ** è¢«è¿™æ ·çš„é—®é¢˜å’¨è¯¢çƒ¦äº†ï¼Œå¹²è„†æŠ›ä¸€ä¸ªå¼‚å¸¸å¾—äº†ã€‚ã€‚ã€‚

ä¸‰ï¼š æ€»ç»“
-----

å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨é›†åˆï¼Œé—®é¢˜è™½ç„¶å¾ˆå°ç™½ï¼Œä½†è¿˜æ˜¯æœ‰å¾ˆå¤šæœ‹å‹æ ½åœ¨è¿™ä¸Šé¢ï¼Œå€¼å¾—åæ€å“ˆï¼Œå€Ÿè¿™ä¸€æ¬¡æœºä¼šè¿›ä¸€æ­¥è§£é‡Šä¸‹æ­»å¾ªç¯å½¢æˆçš„å†…éƒ¨æœºç†ã€‚

![å›¾ç‰‡åç§°](https://images.cnblogs.com/cnblogs_com/huangxincheng/345039/o_210929020104æœ€æ–°æ¶ˆæ¯ä¼˜æƒ ä¿ƒé”€å…¬ä¼—å·å…³æ³¨äºŒç»´ç .jpg)