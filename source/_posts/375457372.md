---
layout: post
title: "Grafana ç³»åˆ—æ–‡ç« ï¼ˆåä¸‰ï¼‰ï¼šå¦‚ä½•ç”¨ Loki æ”¶é›†æŸ¥çœ‹ Kubernetes Events"
date: "2023-02-10T05:15:47.489Z"
---
Grafana ç³»åˆ—æ–‡ç« ï¼ˆåä¸‰ï¼‰ï¼šå¦‚ä½•ç”¨ Loki æ”¶é›†æŸ¥çœ‹ Kubernetes Events
================================================

å‰æƒ…æè¦
----

1.  [IoT è¾¹ç¼˜é›†ç¾¤åŸºäº Kubernetes Events çš„å‘Šè­¦é€šçŸ¥å®ç°](https://ewhisper.cn/posts/48832/)
2.  [IoT è¾¹ç¼˜é›†ç¾¤åŸºäº Kubernetes Events çš„å‘Šè­¦é€šçŸ¥å®ç°ï¼ˆäºŒï¼‰ï¼šè¿›ä¸€æ­¥é…ç½®](https://ewhisper.cn/posts/31024/)

æ¦‚è¿°
--

åœ¨åˆ†æ K8S é›†ç¾¤é—®é¢˜æ—¶ï¼ŒKubernetes Events æ˜¯è¶…çº§æœ‰ç”¨çš„ã€‚

Kubernetes Events å¯ä»¥è¢«å½“åšæ˜¯æ—¥å¿—æ¥å¤„ç†ï¼Œæ ¼å¼ä¹Ÿå’Œæ—¥å¿—å¾ˆåƒï¼Œéƒ½åŒ…æ‹¬ï¼š

1.  æ—¶é—´
2.  ç»„ä»¶
3.  åŸå› 
4.  ...

ä½†æ˜¯ï¼ŒKubernetes é»˜è®¤åªæŒä¹…åŒ–äº†ä¸€ä¸ªå°æ—¶çš„äº‹ä»¶ï¼Œä»¥å‡å°‘ etcd çš„è´Ÿè½½ã€‚æ‰€ä»¥ï¼Œè€ƒè™‘åˆ©ç”¨ Loki å­˜å‚¨å’ŒæŸ¥è¯¢è¿™äº› Eventsã€‚

å®ç°
--

çœ‹è¿‡ [æˆ‘ä¹‹å‰çš„æ–‡ç« ](https://ewhisper.cn/posts/48832/) çš„å¯ä»¥çŸ¥é“ï¼Œ[**kubernetes-event-exporter**](https://github.com/opsgenie/kubernetes-event-exporter) å¯ä»¥å®ç°å¯¹ Kubernetes Events çš„æ”¶é›†ã€‚

é‚£æˆ‘ä»¬å°±åˆ©ç”¨ kubernetes-event-exporter, é€šè¿‡æœ€ç®€å•çš„ `stdout` æ–¹å¼æ¥è¾“å‡º json æ ¼å¼çš„ event.

å¦å¤–ï¼Œå†åˆ©ç”¨ Promtail çš„ [ç®¡é“é…ç½®](https://grafana.com/docs/loki/latest/clients/promtail/pipelines)ï¼Œå°† NameSpace ä½œä¸ºé™„åŠ æ ‡ç­¾æ·»åŠ åˆ°å¯¼å‡ºåˆ° Loki çš„æ—¥å¿—ä¸­ã€‚

### kubernetes-event-exporter é…ç½®

å¦‚ä¸‹ï¼š

    logLevel: error
    logFormat: json
    trottlePeriod: 5
    route:
      routes:
        - match:
            - receiver: "dump"
    receivers:
      - name: "dump"
        stdout: { }
    

### Promtail é…ç½®

å¦‚ä¸‹ï¼š

    ...
    scrape_configs:
    - job_name: kubernetes-pods-app
      pipeline_stages:
        - cri: {}
        - match:
            selector: '{app="event-exporter"}'
            stages:
            - json:
                expressions:
                  namespace: involvedObject.namespace
            - labels:
                namespace: ""  
    ...        
    

ä¸Šé¢çš„é…ç½®ä¼šä» Events çš„ JSONPath `involvedObject.namespace` ä¸­è·å– NameSpace ï¼Œå¹¶å°†å…¶ä½œä¸ºä¸€ä¸ªæ ‡ç­¾ - `namespace` æ·»åŠ ã€‚

è‡³æ­¤ï¼Œæˆ‘å¯ä»¥åªæŸ¥çœ‹ç‰¹å®š NameSpaceï¼ˆå¦‚`emqx`) çš„ Events, å¦‚ä¸‹å›¾ï¼š

![æ¥è‡ª emqx NameSpace çš„ Events](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230210095255452-1384011727.png)

ğŸ‰ğŸ‰ğŸ‰

> ğŸ“**Notes**:
> 
> æˆ‘çš„`event-exporter` æ˜¯éƒ¨ç½²åœ¨ `monitoring` NS ä¸­çš„

â“ï¸ç–‘éš¾è§£ç­”
------

åˆšå¼€å§‹åšçš„æ—¶å€™ï¼Œå‘ç°çš„æ—¥å¿—è¾“å‡ºä¸å¯¹ï¼Œæ ¼å¼å®ä¾‹å¦‚ä¸‹ï¼š

![é”™è¯¯çš„æ—¥å¿—æ ¼å¼](https://img2023.cnblogs.com/other/3034537/202302/3034537-20230210095255694-1169095608.png)

    2022-04-20T22:26:19.526448119+08:00 stderr F I0420 {...json...}
    

è¿™æ˜¯å› ä¸ºæˆ‘ç”¨çš„ container runtime æ˜¯ CRI, è€Œé Docker.

ä½†æ˜¯é»˜è®¤å®‰è£… Loki çš„æ—¶å€™ï¼Œé…ç½®æ–‡ä»¶é‡Œå´ç”¨çš„æ˜¯ docker çš„ stage parser, å¯¼è‡´æ—¥å¿—æ ¼å¼å¼‚å¸¸ã€‚åˆå§‹çš„é…ç½®å¦‚ä¸‹:

    ...
    - job_name: kubernetes-pods-name
      pipeline_stages:
        - docker: {}
    ...    
    

Docker çš„æ—¥å¿—æ ¼å¼å¦‚ä¸‹ï¼š

    `{"log":"level=info ts=2019-04-30T02:12:41.844179Z caller=filetargetmanager.go:180 msg=\"Adding target\"\n","stream":"stderr","time":"2019-04-30T02:12:41.8443515Z"}`
    

CRI çš„æ—¥å¿—æ ¼å¼å¦‚ä¸‹ï¼š

    2019-01-01T01:00:00.000000001Z stderr P some log message
    

æ‰€ä»¥å¦‚ä¸Šæ–‡æ‰€ç¤ºï¼Œè¦æ ¹æ®è‡ªå·±çš„ container runtime é€‰æ‹©åˆé€‚çš„ stage parser.

å¯¹äº CRI, `cri: {}` å…¶å®å°±æ˜¯å¦‚ä¸‹ç»†èŠ‚çš„ä¸€ä¸ª"è¯­æ³•ç³–":

    - regex:
        expression: "^(?s)(?P<time>\\S+?) (?P<stream>stdout|stderr) (?P<flags>\\S+?) (?P<content>.*)$"
    - labels:
        stream:
    - timestamp:
        source: time
        format: RFC3339Nano
    - output:
        source: content
    

ğŸ“šï¸å‚è€ƒæ–‡æ¡£
-------

*   [How Grafana Labs Effectively Pairs Loki and Kubernetes Events | Grafana Labs](https://grafana.com/blog/2019/08/21/how-grafana-labs-effectively-pairs-loki-and-kubernetes-events/)
*   [Configuration | Grafana Labs](https://grafana.com/docs/loki/latest/clients/promtail/configuration/)
*   [What is the correct way to parse json logs in loki, promtail - Grafana Loki - Grafana Labs Community Forums](https://community.grafana.com/t/what-is-the-correct-way-to-parse-json-logs-in-loki-promtail/51974)

Grafana ç³»åˆ—æ–‡ç« 
------------

[Grafana ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/Grafana/)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.