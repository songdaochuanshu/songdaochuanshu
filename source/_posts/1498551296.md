---
layout: post
title: "ä½¿ç”¨ Bitnami Helm å®‰è£… Kafka"
date: "2023-01-01T13:18:37.945Z"
---
ä½¿ç”¨ Bitnami Helm å®‰è£… Kafka
========================

æœåŠ¡å™¨ç«¯ K3S ä¸Šéƒ¨ç½² Kafka Server
-------------------------

### Kafka å®‰è£…

> ğŸ“šï¸ **Quote:**
> 
> [charts/bitnami/kafka at master Â· bitnami/charts (github.com)](https://github.com/bitnami/charts/tree/master/bitnami/kafka)

è¾“å…¥å¦‚ä¸‹å‘½ä»¤æ·»åŠ  Helm ä»“åº“ï¼š

    > helm repo add tkemarket https://market-tke.tencentcloudcr.com/chartrepo/opensource-stable
    "tkemarket" has been added to your repositories
    > helm repo add bitnami https://charts.bitnami.com/bitnami
    "bitnami" has been added to your repositories
    

> ğŸ”¥ **Tip:**
> 
> tkemarket é•œåƒæ²¡æœ‰åŠæ—¶æ›´æ–°ï¼Œå»ºè®®ä½¿ç”¨ bitnami ä»“åº“ã€‚
> 
> ä½†æ˜¯ bitmani åœ¨æµ·å¤–ï¼Œæœ‰è¿ä¸ä¸Šçš„é£é™©ã€‚

æŸ¥æ‰¾ Helm Chart kafkaï¼š

    > helm search repo kafka
    NAME            CHART VERSION   APP VERSION     DESCRIPTION                                      
    tkemarket/kafka 11.0.0          2.5.0           Apache Kafka is a distributed streaming platform.
    bitnami/kafka                   15.3.0          3.1.0           Apache Kafka is a distributed streaming platfor...
    bitnami/dataplatform-bp1        9.0.8           1.0.1           OCTO Data platform Kafka-Spark-Solr Helm Chart    
    bitnami/dataplatform-bp2        10.0.8          1.0.1           OCTO Data platform Kafka-Spark-Elasticsearch He...
    

ä½¿ç”¨ bitnami çš„ helm å®‰è£… kafkaï¼š

    helm install kafka bitnami/kafka \
      --namespace kafka --create-namespace \
      --set global.storageClass=<storageClass-name> \
      --set kubeVersion=<theKubeVersion> \
      --set image.tag=3.1.0-debian-10-r22 \
      --set replicaCount=3 \
      --set service.type=ClusterIP \
      --set externalAccess.enabled=true \
      --set externalAccess.service.type=LoadBalancer \
      --set externalAccess.service.ports.external=9094 \
      --set externalAccess.autoDiscovery.enabled=true \
      --set serviceAccount.create=true \
      --set rbac.create=true \
      --set persistence.enabled=true \
      --set logPersistence.enabled=true \
      --set metrics.kafka.enabled=false \
      --set zookeeper.enabled=true \
      --set zookeeper.persistence.enabled=true \
      --wait
    

> ğŸ”¥ **Tip:**
> 
> å‚æ•°è¯´æ˜å¦‚ä¸‹ï¼š
> 
> 1.  `--namespace kafka --create-namespace`: å®‰è£…åœ¨ `kafka` namespace, å¦‚æœæ²¡æœ‰è¯¥ ns å°±åˆ›å»ºï¼›
> 2.  `global.storageClass=<storageClass-name>` ä½¿ç”¨æŒ‡å®šçš„ storageclass
> 3.  `kubeVersion=<theKubeVersion>` è®© bitnami/kafka helm åˆ¤æ–­æ˜¯å¦æ»¡è¶³ç‰ˆæœ¬éœ€æ±‚ï¼Œä¸æ»¡è¶³å°±æ— æ³•åˆ›å»º
> 4.  `image.tag=3.1.0-debian-10-r22`: 20220219 çš„æœ€æ–°é•œåƒï¼Œä½¿ç”¨å®Œæ•´çš„åå­—ä¿è¯å°½é‡å‡å°‘ä»äº’è”ç½‘ pull é•œåƒï¼›
> 5.  `replicaCount=3`: kafka å‰¯æœ¬æ•°ä¸º 3
> 6.  `service.type=ClusterIP` : åˆ›å»º `kafka` service, ç”¨äº k8s é›†ç¾¤å†…éƒ¨ï¼Œæ‰€ä»¥ ClusterIP å°±å¯ä»¥
> 7.  `--set externalAccess.enabled=true --set externalAccess.service.type=LoadBalancer --set externalAccess.service.ports.external=9094 --set externalAccess.autoDiscovery.enabled=true --set serviceAccount.create=true --set rbac.create=true` åˆ›å»ºç”¨äº k8s é›†ç¾¤å¤–è®¿é—®çš„ `kafka-<0|1|2>-external` æœåŠ¡ ï¼ˆå› ä¸ºå‰é¢ kafka å‰¯æœ¬æ•°ä¸º 3ï¼‰
> 8.  `persistence.enabled=true`: Kafka æ•°æ®æŒä¹…åŒ–ï¼Œå®¹å™¨ä¸­çš„ç›®å½•ä¸º `/bitnami/kafka`
> 9.  `logPersistence.enabled=true`: Kafka æ—¥å¿—æŒä¹…åŒ–ï¼Œå®¹å™¨ä¸­çš„ç›®å½•ä¸º `/opt/bitnami/kafka/logs`
> 10.  `metrics.kafka.enabled=false` ä¸å¯ç”¨ kafka çš„ç›‘æ§ (Kafka ç›‘æ§æ”¶é›†æ•°æ®æ˜¯é€šè¿‡ `kafka-exporter` å®ç°çš„ï¼‰
> 11.  `zookeeper.enabled=true`: å®‰è£… kafka éœ€è¦å…ˆå®‰è£… zookeeper
> 12.  `zookeeper.persistence.enabled=true`: Zookeeper æ—¥å¿—æŒä¹…åŒ–ï¼Œå®¹å™¨ä¸­çš„ç›®å½•ä¸ºï¼š`/bitnami/zookeeper`
> 13.  `--wait`: helm å‘½ä»¤ä¼šä¸€ç›´ç­‰å¾…åˆ›å»ºçš„ç»“æœ

è¾“å‡ºå¦‚ä¸‹ï¼š

    creating 1 resource(s)
    creating 12 resource(s)
    beginning wait for 12 resources with timeout of 5m0s
    Service does not have load balancer ingress IP address: kafka/kafka-0-external
    ...
    StatefulSet is not ready: kafka/kafka-zookeeper. 0 out of 1 expected pods are ready
    ...
    StatefulSet is not ready: kafka/kafka. 0 out of 1 expected pods are ready
    NAME: kafka
    LAST DEPLOYED: Sat Feb 19 05:04:53 2022
    NAMESPACE: kafka
    STATUS: deployed
    REVISION: 1
    TEST SUITE: None
    NOTES:
    CHART NAME: kafka
    CHART VERSION: 15.3.0
    APP VERSION: 3.1.0
    ---------------------------------------------------------------------------------------------
     WARNING
    
        By specifying "serviceType=LoadBalancer" and not configuring the authentication
        you have most likely exposed the Kafka service externally without any
        authentication mechanism.
    
        For security reasons, we strongly suggest that you switch to "ClusterIP" or
        "NodePort". As alternative, you can also configure the Kafka authentication.
    
    ---------------------------------------------------------------------------------------------
    
    ** Please be patient while the chart is being deployed **
    
    Kafka can be accessed by consumers via port 9092 on the following DNS name from within your cluster:
    
        kafka.kafka.svc.cluster.local
    
    Each Kafka broker can be accessed by producers via port 9092 on the following DNS name(s) from within your cluster:
    
        kafka-0.kafka-headless.kafka.svc.cluster.local:9092
    
    To create a pod that you can use as a Kafka client run the following commands:
    
        kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.1.0-debian-10-r22 --namespace kafka --command -- sleep infinity
        kubectl exec --tty -i kafka-client --namespace kafka -- bash
    
        PRODUCER:
            kafka-console-producer.sh \
                
                --broker-list kafka-0.kafka-headless.kafka.svc.cluster.local:9092 \
                --topic test
    
        CONSUMER:
            kafka-console-consumer.sh \
                
                --bootstrap-server kafka.kafka.svc.cluster.local:9092 \
                --topic test \
                --from-beginning
    
    To connect to your Kafka server from outside the cluster, follow the instructions below:
    
      NOTE: It may take a few minutes for the LoadBalancer IPs to be available.
            Watch the status with: 'kubectl get svc --namespace kafka -l "app.kubernetes.io/name=kafka,app.kubernetes.io/instance=kafka,app.kubernetes.io/component=kafka,pod" -w'
    
        Kafka Brokers domain: You will have a different external IP for each Kafka broker. You can get the list of external IPs using the command below:
    
            echo "$(kubectl get svc --namespace kafka -l "app.kubernetes.io/name=kafka,app.kubernetes.io/instance=kafka,app.kubernetes.io/component=kafka,pod" -o jsonpath='{.items[*].status.loadBalancer.ingress[0].ip}' | tr ' ' '\n')"
    
        Kafka Brokers port: 9094
    

### Kafka æµ‹è¯•éªŒè¯

æµ‹è¯•æ¶ˆæ¯ï¼š

å…ˆç”¨å¦‚ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ª kafka-client podï¼š

    kubectl run kafka-client --restart='Never' --image docker.io/bitnami/kafka:3.1.0-debian-10-r22 --namespace kafka --command -- sleep infinity
    

ç„¶åè¿›å…¥åˆ° kafka-client ä¸­ï¼Œè¿è¡Œå¦‚ä¸‹å‘½ä»¤æµ‹è¯•ï¼š

    kafka-console-producer.sh  --broker-list kafka-0.kafka-headless.kafka.svc.cluster.local:9092  --topic test
    kafka-console-consumer.sh --bootstrap-server kafka-0.kafka-headless.kafka.svc.cluster.local:9092  --topic test --from-beginning
    
    kafka-console-producer.sh  --broker-list 10.109.205.245:9094  --topic test
    kafka-console-consumer.sh --bootstrap-server 10.109.205.245:9094  --topic test --from-beginning
    

æ•ˆæœå¦‚ä¸‹ï¼š

![å¤–éƒ¨ producer](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230101101841054-2085476401.png)

![external consumer](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230101101841529-1694088450.png)

ğŸ‰è‡³æ­¤ï¼Œkafka å®‰è£…å®Œæˆã€‚

### Kafka å¸è½½

âš¡ **Danger**ï¼š

ï¼ˆæŒ‰éœ€ï¼‰åˆ é™¤æ•´ä¸ª kafka çš„å‘½ä»¤ï¼š

    helm delete kafka --namespace kafka
    

æ€»ç»“
--

### Kafka

1.  Kafka é€šè¿‡ Helm Chart bitnami å®‰è£…ï¼Œå®‰è£…äºï¼šK8S é›†ç¾¤çš„ `kafka` namespace;
    
    1.  å®‰è£…æ¨¡å¼ï¼šä¸‰èŠ‚ç‚¹
    2.  Kafka ç‰ˆæœ¬ï¼š3.1.0
    3.  Kafka å®ä¾‹ï¼š3 ä¸ª
    4.  Zookeeper å®ä¾‹ï¼š1 ä¸ª
    5.  Kafkaã€Zookeeperã€Kafka æ—¥å¿—å‡å·²æŒä¹…åŒ–ï¼Œä½äºï¼š`/data/rancher/k3s/storage`
    6.  æœªé…ç½® sasl åŠ tls
2.  åœ¨ K8S é›†ç¾¤å†…éƒ¨ï¼Œå¯ä»¥é€šè¿‡è¯¥åœ°å€è®¿é—® Kafkaï¼š
    
    `kafka.kafka.svc.cluster.local:9092`
    
3.  åœ¨ K8S é›†ç¾¤å¤–éƒ¨ï¼Œå¯ä»¥é€šè¿‡è¯¥åœ°å€è®¿é—® Kafkaï¼š
    
    `<loadbalancer-ip>:9094`
    

Kafka çš„æŒä¹…åŒ–æ•°æ®æˆªå›¾å¦‚ä¸‹ï¼š

![image-20220219133316787](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230101101841858-520266517.png)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.