---
layout: post
title: "çˆ¬è™«ï¼ˆ14ï¼‰ - Scrapy-Redisåˆ†å¸ƒå¼çˆ¬è™«(1) | è¯¦è§£"
date: "2022-07-06T15:21:40.582Z"
---
çˆ¬è™«ï¼ˆ14ï¼‰ - Scrapy-Redisåˆ†å¸ƒå¼çˆ¬è™«(1) | è¯¦è§£
==================================

1.ä»€ä¹ˆæ˜¯Scrapy-Redis
-----------------

*   Scrapy-Redisæ˜¯scrapyæ¡†æ¶åŸºäºredisçš„åˆ†å¸ƒå¼ç»„ä»¶ï¼Œæ˜¯scrapyçš„æ‰©å±•ï¼›åˆ†å¸ƒå¼çˆ¬è™«å°†å¤šå°ä¸»æœºç»„åˆèµ·æ¥ï¼Œå…±åŒå®Œæˆä¸€ä¸ªçˆ¬å–ä»»åŠ¡ï¼Œå¿«é€Ÿé«˜æ•ˆåœ°æé«˜çˆ¬å–æ•ˆç‡ã€‚
*   åŸå…ˆscrapyçš„è¯·æ±‚æ˜¯æ”¾åœ¨å†…å­˜ä¸­ï¼Œä»å†…å­˜ä¸­è·å–ã€‚scrapy-redisrå°†è¯·æ±‚ç»Ÿä¸€æ”¾åœ¨redisé‡Œé¢ï¼Œå„ä¸ªä¸»æœºæŸ¥çœ‹è¯·æ±‚æ˜¯å¦çˆ¬å–è¿‡ï¼Œæ²¡æœ‰çˆ¬å–è¿‡ï¼Œæ’é˜Ÿå…¥é˜Ÿåˆ—ï¼Œä¸»æœºå–å‡ºæ¥çˆ¬å–ã€‚çˆ¬è¿‡äº†å°±çœ‹ä¸‹ä¸€æ¡è¯·æ±‚ã€‚
*   å„ä¸»æœºçš„spiderså°†æœ€åè§£æçš„æ•°æ®é€šè¿‡ç®¡é“ç»Ÿä¸€å†™å…¥åˆ°redisä¸­
*   ä¼˜ç‚¹ï¼šåŠ å¿«é¡¹ç›®çš„è¿è¡Œé€Ÿåº¦ï¼›å•ä¸ªèŠ‚ç‚¹çš„ä¸ç¨³å®šæ€§ä¸å½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ï¼›æ”¯æŒç«¯ç‚¹çˆ¬å–
*   ç¼ºç‚¹ï¼šéœ€è¦æŠ•å…¥å¤§é‡çš„ç¡¬ä»¶èµ„æºï¼Œç¡¬ä»¶ã€ç½‘ç»œå¸¦å®½ç­‰

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220629204747399-2093134910.png)

*   åœ¨scrapyæ¡†æ¶æµç¨‹çš„åŸºç¡€ä¸Šï¼ŒæŠŠå­˜å‚¨requestå¯¹è±¡æ”¾åˆ°äº†redisçš„æœ‰åºé›†åˆä¸­ï¼Œåˆ©ç”¨è¯¥æœ‰åºé›†åˆå®ç°äº†è¯·æ±‚é˜Ÿåˆ—
*   å¹¶å¯¹requestå¯¹è±¡ç”ŸæˆæŒ‡çº¹å¯¹è±¡ï¼Œä¹Ÿå­˜å‚¨åˆ°åŒä¸€redisçš„é›†åˆä¸­ï¼Œåˆ©ç”¨requestæŒ‡çº¹é¿å…å‘é€é‡å¤çš„è¯·æ±‚

2.Scrapy-Redisåˆ†å¸ƒå¼ç­–ç•¥
-------------------

å‡è®¾æœ‰ä¸‰å°ç”µè„‘ï¼šWindows 10ã€Ubuntu 16.04ã€Windows 10ï¼Œä»»æ„ä¸€å°ç”µè„‘éƒ½å¯ä»¥ä½œä¸º Masterç«¯ æˆ– Slaverç«¯ï¼Œæ¯”å¦‚ï¼š

*   Masterç«¯(æ ¸å¿ƒæœåŠ¡å™¨) ï¼šä½¿ç”¨ Windows 10ï¼Œæ­å»ºä¸€ä¸ªRedisæ•°æ®åº“ï¼Œä¸è´Ÿè´£çˆ¬å–ï¼Œåªè´Ÿè´£urlæŒ‡çº¹åˆ¤é‡ã€Requestçš„åˆ†é…ï¼Œä»¥åŠæ•°æ®çš„å­˜å‚¨ã€‚
*   Slaverç«¯(çˆ¬è™«ç¨‹åºæ‰§è¡Œç«¯) ï¼šä½¿ç”¨ Ubuntu 16.04ã€Windows 10ï¼Œè´Ÿè´£æ‰§è¡Œçˆ¬è™«ç¨‹åºï¼Œè¿è¡Œè¿‡ç¨‹ä¸­æäº¤æ–°çš„Requestç»™Masterã€‚

é¦–å…ˆSlaverç«¯ä»Masterç«¯æ‹¿ä»»åŠ¡ï¼ˆRequestã€urlï¼‰è¿›è¡Œæ•°æ®æŠ“å–ï¼ŒSlaveræŠ“å–æ•°æ®çš„åŒæ—¶ï¼Œäº§ç”Ÿæ–°ä»»åŠ¡çš„Requestä¾¿æäº¤ç»™ Master å¤„ç†

Masterç«¯åªæœ‰ä¸€ä¸ªRedisæ•°æ®åº“ï¼Œè´Ÿè´£å°†æœªå¤„ç†çš„Requestå»é‡å’Œä»»åŠ¡åˆ†é…ï¼Œå°†å¤„ç†åçš„RequeståŠ å…¥å¾…çˆ¬é˜Ÿåˆ—ï¼Œå¹¶ä¸”å­˜å‚¨çˆ¬å–çš„æ•°æ®ã€‚

Scrapy-Redisé»˜è®¤ä½¿ç”¨çš„å°±æ˜¯è¿™ç§ç­–ç•¥ï¼Œæˆ‘ä»¬å®ç°èµ·æ¥å¾ˆç®€å•ï¼Œå› ä¸ºä»»åŠ¡è°ƒåº¦ç­‰å·¥ä½œScrapy-Rediséƒ½å·²ç»å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ç»§æ‰¿RedisSpiderã€æŒ‡å®šredis\_keyå°±è¡Œäº†ã€‚

ç¼ºç‚¹æ˜¯ï¼ŒScrapy-Redisè°ƒåº¦çš„ä»»åŠ¡æ˜¯Requestå¯¹è±¡ï¼Œé‡Œé¢ä¿¡æ¯é‡æ¯”è¾ƒå¤§ï¼ˆä¸ä»…åŒ…å«urlï¼Œè¿˜æœ‰callbackå‡½æ•°ã€headersç­‰ä¿¡æ¯ï¼‰ï¼Œå¯èƒ½å¯¼è‡´çš„ç»“æœå°±æ˜¯ä¼šé™ä½çˆ¬è™«é€Ÿåº¦ã€è€Œä¸”ä¼šå ç”¨Rediså¤§é‡çš„å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å¦‚æœè¦ä¿è¯æ•ˆç‡ï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€å®šç¡¬ä»¶æ°´å¹³ã€‚

3.Scrapy-Redisçš„å®‰è£…å’Œé¡¹ç›®åˆ›å»º
----------------------

### **3.1.å®‰è£…scrapy-redis**

pip install scrapy-redis

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630144641493-1844478204.png)

### **3.2.é¡¹ç›®åˆ›å»ºå‰ç½®å‡†å¤‡**

*   win 10
*   Rediså®‰è£…ï¼šredisç›¸å…³é…ç½®å‚ç…§è¿™ä¸ª[https://www.cnblogs.com/gltou/p/16226721.html](https://www.cnblogs.com/gltou/p/16226721.html)ï¼›å¦‚æœè·Ÿç€ç¬”è®°å­¦åˆ°è¿™çš„ï¼Œå‰é¢é“¾æ¥é‚£ä¸ªredisç‰ˆæœ¬3.0å¤ªè€äº†ï¼Œéœ€è¦é‡æ–°å®‰è£…æ–°ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬ä¸‹è½½é“¾æ¥ï¼š[https://pan.baidu.com/s/1UwhJA1QxDDIi2wZFFIZwow?pwd=thak](https://pan.baidu.com/s/1UwhJA1QxDDIi2wZFFIZwow?pwd=thak)ï¼Œæå–ç ï¼šthakï¼›
*   Another Redis Desktop Managerï¼šè¿™ä¸ªè½¯ä»¶æ˜¯ç”¨äºæŸ¥çœ‹redisä¸­å­˜å‚¨çš„æ•°æ®ï¼Œå®‰è£…ä¹Ÿå¾ˆç®€å•ï¼Œä¸€ç›´ä¸‹ä¸€æ­¥å³å¯ï¼›ä¸‹è½½é“¾æ¥ï¼š[https://pan.baidu.com/s/18CC2N6XtPn\_2NEl7gCgViA?pwd=ju81](https://pan.baidu.com/s/18CC2N6XtPn_2NEl7gCgViA?pwd=ju81)Â Â æå–ç ï¼šju81

Rediaå®‰è£…ç®€å•è®²è§£ï¼šå®‰è£…åŒ…ä¸‹è½½ä¸‹æ¥åï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ä¸€ç›´å®‰è£…å°±è¡Œï¼ŒæŠŠå®‰è£…è·¯å¾„è®°å½•å¥½ï¼›æ³¨æ„å®‰è£…å¥½åéœ€è¦å°†redisçš„å®‰è£…ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼›æ¯å½“ä½ ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ï¼Œéœ€è¦é‡å¯redisæ—¶ï¼Œè¦è®°å¾—å°†æœåŠ¡é‡å¯ä¸‹

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630194958709-959650070.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630195053811-1246469238.png)

Another Redis Desktop Managerç®€å•è®²è§£ï¼šç‚¹å‡»ã€New Connectionã€‘æ·»åŠ redisè¿æ¥ï¼Œè¿æ¥å†…å®¹å¦‚ä¸‹(åœ°å€ã€ç«¯å£ç­‰)ï¼Œå¯†ç Authå’Œæ˜µç§°Nameä¸æ˜¯å¿…å¡«ã€‚

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630145833240-132011690.png)

å¯ä»¥çœ‹åˆ°rediså®‰è£…çš„ç¯å¢ƒã€å½“å‰redisçš„ç‰ˆæœ¬ã€å†…å­˜ã€è¿æ¥æ•°ç­‰ä¿¡æ¯ã€‚åé¢æˆ‘ä»¬çš„ç¬”è®°ä¼šè®²è§£é€šè¿‡è¯¥è½¯ä»¶æŸ¥çœ‹å¾…æŠ“å–çš„URLä»¥åŠURLçš„æŒ‡çº¹![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630195321595-772130133.png)

### **3.3.é¡¹ç›®åˆ›å»º**

åˆ›å»ºæ™®é€šscrapyçˆ¬è™«é¡¹ç›®ï¼Œåœ¨æ™®é€šçš„é¡¹ç›®ä¸Šæ”¹é€ æˆscrapy-redisé¡¹ç›®ï¼›æ™®é€šçˆ¬è™«åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼šåˆ›å»ºé¡¹ç›®ã€æ˜ç¡®ç›®æ ‡ã€åˆ›å»ºçˆ¬è™«ã€ä¿å­˜å†…å®¹ï¼›

scrapyçˆ¬è™«é¡¹ç›®åˆ›å»ºå¥½åï¼Œè¿›è¡Œæ”¹é€ ï¼Œå…·ä½“æ”¹é€ ç‚¹å¦‚ä¸‹ï¼š

*   å¯¼å…¥scrapy-redisä¸­çš„åˆ†å¸ƒå¼çˆ¬è™«ç±»
*   ç»§æ‰¿ç±»
*   æ³¨é‡Šstart\_url & allowed\_domains
*   è®¾ç½®redis\_keyè·å–start\_urls
*   ç¼–è¾‘settingsæ–‡ä»¶

#### 3.3.1.åˆ›å»ºscrapyçˆ¬è™«

**step-1ï¼šåˆ›å»ºé¡¹ç›®**

åˆ›å»ºscrapy\_redis\_demoç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹è¾“å…¥å‘½ä»¤Â scrapy startproject movie\_testÂ ï¼Œç”Ÿæˆscrapyé¡¹ç›®ğŸ‘‰cdåˆ°movie\_testé¡¹ç›®ä¸‹Â cd .\\movie\_test\\Â ğŸ‘‰è¾“å…¥å‘½ä»¤Â scrapy genspider get\_movie 54php.cnÂ ç”Ÿæˆspidersæ¨¡æ¿æ–‡ä»¶ï¼›è¿™ä¸ªè¿‡ç¨‹ä¸æ¸…æ¥šçš„ï¼Œè½¬åˆ°[https://www.cnblogs.com/gltou/p/16400449.html](https://www.cnblogs.com/gltou/p/16400449.html)å­¦ä¹ ä¸‹

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630154252599-407547186.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630154408953-1792339771.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630154423594-1696319283.png)

**step-2ï¼šæ˜ç¡®ç›®æ ‡**

åœ¨items.pyæ–‡ä»¶ä¸­ï¼Œæ˜ç¡®æˆ‘ä»¬æ­¤æ¬¡éœ€è¦çˆ¬å–ç›®æ ‡ç½‘ç«™å“ªäº›æ•°æ®ã€‚

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630155013172-288627349.png)

 1 # Define here the models for your scraped items
 2 #
 3 # See documentation in:
 4 # https://docs.scrapy.org/en/latest/topics/items.html
 5 
 6 import scrapy 7 
 8 
 9 class MovieTestItem(scrapy.Item):
10     # define the fields for your item here like:
11     # name = scrapy.Field()
12 
13     #ç”µå½±çš„åç§°
14     tiele = scrapy.Field()
15 
16     #ç”µå½±çš„è¯¦ç»†æè¿°
17     desc= scrapy.Field()
18 
19     #ç”µå½±çš„URL
20     download\_url=scrapy.Field()

**step-3ï¼šåˆ›å»ºçˆ¬è™«**

**![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630163258806-707285585.png)**

å¯¼å…¥items.pyçš„ç±»,åœ¨get\_movie.pyæ–‡ä»¶ä¸­ç¼–å†™æˆ‘ä»¬çš„çˆ¬è™«æ–‡ä»¶ï¼Œä¸‹é¢ä¸ºget\_movie.pyçš„codeä»£ç 

import scrapy
from ..items import MovieTestItem

class GetMovieSpider(scrapy.Spider):
    name \= 'get\_movie'
    allowed\_domains \= \['54php.cn'\]
    start\_urls \= \['http://movie.54php.cn/movie/'\]

    def parse(self, response):
        movie\_item\=response.xpath("//div\[2\]\[@class='row'\]/div")
        for i in movie\_item:
            #è¯¦æƒ…é¡µurl
            detail\_url=i.xpath(".//a\[@class='thumbnail'\]/@href").extract\_first()
            yield scrapy.Request(url=detail\_url,callback=self.parse\_detail)

        next\_page\=response.xpath("//a\[@aria-label='Next'\]/@href").extract\_first()
        if next\_page:
            next\_page\_url\='http://movie.54php.cn{}'.format(next\_page)
            yield scrapy.Request(url=next\_page\_url,callback=self.parse)

    def parse\_detail(self,response):
        """è§£æè¯¦æƒ…é¡µ"""
        movie\_info\=MovieTestItem()
        movie\_info\["title"\]=response.xpath("//div\[@class='page-header'\]/h1/text()").extract\_first()
        movie\_info\["desc"\]=response.xpath("//div\[@class='panel-body'\]/p\[4\]/text()").extract\_first()
        movie\_info\["download\_url"\]=response.xpath("//div\[@class='panel-body'\]/p\[5\]/text()").extract\_first()
        yield movie\_info

åœ¨settings.pyæ–‡ä»¶ä¸­å¯ç”¨Â USER\_AGENTÂ å¹¶å°†ç½‘ç«™çš„valueæ”¾è¿›å»ï¼›å°†Â ROBOTSTXT\_OBEYÂ åè®®æ”¹ä¸ºFalse

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630163412415-114061101.png)

Â **step-4ï¼šä¿å­˜å†…å®¹**

æ­¤å¤„æš‚æ—¶ä¸å†™ï¼Œå…ˆå¿½ç•¥ï¼Œåé¢æ”¹æˆscrapy-rediså†™å…¥redisæ—¶ï¼Œå†ç¼–å†™ç›¸å…³ä»£ç 

**step-5ï¼šè¿è¡Œçˆ¬è™«ï¼ŒæŸ¥çœ‹ç»“æœ**

è¾“å…¥å‘½ä»¤Â scrapy crawl get\_movieÂ è¿è¡Œçˆ¬è™«ï¼ŒæŸ¥çœ‹ç»“æœï¼›Â finish\_reasonÂ ä¸ºfinishedè¿è¡Œç»“æŸã€Â item\_scraped\_countÂ å…±çˆ¬å–1060æ¡æ•°æ®ã€Â log\_count/DEBUGÂ æ—¥å¿—æ–‡ä»¶ä¸­DEBUGè®°å½•å…±2192æ¡ç­‰ç»“æœä¿¡æ¯ã€‚

**![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630163909242-1897353447.png)**

scrapyé¡¹ç›®åˆ›å»ºä¸”è¿è¡ŒæˆåŠŸï¼Œä¸‹é¢å°†è¿›è¡Œscrapy-redisæ”¹é€ 

#### 3.3.2.æ”¹ä¸ºscrapy-redisçˆ¬è™«

**step-1ï¼šä¿®æ”¹çˆ¬è™«æ–‡ä»¶**

get\_movie.pyçˆ¬è™«æ–‡ä»¶å¼•å…¥Â scrapy\_redisÂ çš„Â RedisSpiderÂ ç±»ï¼Œå¹¶ç»§æ‰¿ä»–ï¼›å°†Â allowed\_domainsÂ å’ŒÂ start\_urlsÂ æ³¨é‡Šæ‰ï¼›æ–°å¢Â redis\_keyÂ ï¼Œå€¼valueÂ æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œkeyå°±æ˜¯nameå€¼å³çˆ¬è™«åå­—ï¼Œvalueå°±æ˜¯start\_urlsè¿™ä¸ªå˜é‡åÂ 

 1 import scrapy 2 from ..items import MovieTestItem 3 from scrapy\_redis.spiders import RedisSpider 4 
 5 class GetMovieSpider(RedisSpider): 6     name = 'get\_movie'
 7     # allowed\_domains = \['54php.cn'\]
 8     # start\_urls = \['http://movie.54php.cn/movie/'\]
 9     redis\_key = "get\_movie:start\_urls"
10 
11     def parse(self, response):
12         movie\_item=response.xpath("//div\[2\]\[@class='row'\]/div")
13         for i in movie\_item:
14             #è¯¦æƒ…é¡µurl
15             detail\_url=i.xpath(".//a\[@class='thumbnail'\]/@href").extract\_first()
16             yield scrapy.Request(url=detail\_url,callback=self.parse\_detail)
17 
18         next\_page=response.xpath("//a\[@aria-label='Next'\]/@href").extract\_first()
19         if next\_page:
20             next\_page\_url='http://movie.54php.cn{}'.format(next\_page)
21             yield scrapy.Request(url=next\_page\_url,callback=self.parse)
22 
23     def parse\_detail(self,response):
24         """è§£æè¯¦æƒ…é¡µ"""
25         movie\_info=MovieTestItem()
26         movie\_info\["title"\]=response.xpath("//div\[@class='page-header'\]/h1/text()").extract\_first()
27         movie\_info\["desc"\]=response.xpath("//div\[@class='panel-body'\]/p\[4\]/text()").extract\_first()
28         movie\_info\["download\_url"\]=response.xpath("//div\[@class='panel-body'\]/p\[5\]/text()").extract\_first()
29         yield movie\_info
30 
31         

**step-2ï¼šä¿®æ”¹redisé…ç½®æ–‡ä»¶**

å°†redis.windows.confå’Œredis.windows-service.confæ–‡ä»¶ä¸­Â bindÂ è®¾ç½®æˆÂ 0.0.0.0Â ,é‡å¯redisæœåŠ¡

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630195629044-1177134994.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630192639466-1130232065.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630192727665-29649991.png)

**step-3ï¼šrediså­˜å…¥ç§å­url**

cmdè¾“å…¥Â redis-cliÂ è¿›å…¥rediså‘½ä»¤è¡Œï¼Œå¦‚æœæœ‰å¯†ç ï¼Œè¿½åŠ å‘½ä»¤Â auth å¯†ç Â å¦‚å›¾

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630193452449-1414089799.png)

å°†çˆ¬è™«get\_movie.pyæ–‡ä»¶ä¸­è®¾ç½®çš„Â redis\_keyÂ (æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œkeyå°±æ˜¯Â nameÂ å€¼å³çˆ¬è™«åå­—ï¼Œvalueå°±æ˜¯Â start\_urlsÂ è¿™ä¸ªå˜é‡å)ï¼Œåœ¨redisä¸­lpushä¸€ä¸‹ï¼›rediså‘½ä»¤è¡Œè¾“å…¥lpushåä¼šå°†å‘½ä»¤æ ¼å¼å¸¦å‡ºæ¥ï¼Œä¸ç”¨ç®¡ä»–ï¼Œåœ¨lpushåé¢è¾“å…¥keyå’Œvalueå€¼

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630195834932-159345406.png)

lpushçš„keyå€¼å°±æ˜¯ä»£ç ä¸­çš„Â redis\_keyÂ çš„å€¼ï¼Œvalueæ˜¯Â start\_urlsÂ çš„å€¼ï¼Œè¾“å…¥å¥½åï¼ŒæŒ‰ä¸‹Enteré”®

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630200023028-574448998.png)

åœ¨Another Redis Desktop Managerè½¯ä»¶ä¸­æ£€æŸ¥æ˜¯å¦æ·»åŠ æˆåŠŸï¼Œå‘ç°æ·»åŠ æˆåŠŸ

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630200140485-965630806.png)

**step-4ï¼šé…ç½®æ–‡ä»¶æ·»åŠ ç»„ä»¶åŠrediså‚æ•°**

settings.pyæ–‡ä»¶ä¸­æ·»åŠ è®¾ç½®å»é‡ç»„ä»¶å’Œè°ƒåº¦ç»„ä»¶ï¼Œæ·»åŠ redisè¿æ¥ä¿¡æ¯ï¼›

 1 # è®¾ç½®å»é‡ç»„ä»¶
 2 DUPEFILTER\_CLASS = "scrapy\_redis.dupefilter.RFPDupeFilter"
 3 # è°ƒåº¦ç»„ä»¶
 4 SCHEDULER = "scrapy\_redis.scheduler.Scheduler"
 5 
 6 #redis è¿æ¥ä¿¡æ¯
 7 REDIS\_HOST = "127.0.0.1"
 8 REDIS\_PORT = 6379
 9 REDIS\_ENCODING = 'utf-8'
10 #REDIS\_PARAMS = {"password":"123456"}

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630203004218-323203158.png)

**ç–‘é—®ï¼š**æœ‰äººè‚¯å®šä¼šé—®ï¼Œæˆ‘åœ¨settings.pyæ–‡ä»¶ä¸­æ·»åŠ äº†redisçš„ä¿¡æ¯ï¼Œscrapyæ¡†æ¶æ˜¯æ€ä¹ˆæ‹¿åˆ°çš„å‘¢ï¼Ÿ

**ç­”æ¡ˆï¼š**å…¶å®åœ¨[https://www.cnblogs.com/gltou/p/16400449.html](https://www.cnblogs.com/gltou/p/16400449.html)è¿™ç¯‡çš„ç¬”è®°ä¸­å·²ç»è®²åˆ°äº†ï¼Œscrapyæ¡†æ¶çš„scrapy.cfgæ–‡ä»¶é‡Œé¢ä¼šå‘Šè¯‰æ¡†æ¶é…ç½®æ–‡ä»¶åœ¨å“ªè¾¹ï¼Œå¦‚å›¾ï¼Œå³åœ¨movie\_testç›®å½•ä¸‹çš„settingsæ–‡ä»¶ä¸­

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630203607397-509029747.png)

ç„¶åscrapyè¿è¡Œæ€•ä»æ–‡ä»¶æ˜¯é€šè¿‡cmdlineçš„executeæ–¹æ³•è¿è¡Œçš„ ï¼Œè¿™ä¸ªæ–¹æ³•å…¶ä¸­æ‰§è¡Œçš„get\_project\_settings( )æ–¹æ³•ï¼Œå°±æ˜¯å¯¼å…¥å…¨å±€é…ç½®æ–‡ä»¶scrapy.cfgï¼Œè¿›è€Œå¯¼å…¥é¡¹ç›®çš„settings .py

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630203655440-1481531510.png)

é€šè¿‡get\_project\_settings( )è¿™ä¸ªæ–¹æ³•çš„project.pyæ–‡ä»¶ï¼Œæˆ‘ä»¬åœ¨froméƒ¨åˆ†çœ‹åˆ°å¯¼å…¥äº†Settingsï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±ç ”ç©¶ä¸‹æºç ![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630203951534-495538283.png)

**step-5ï¼šè¿è¡Œçˆ¬è™«æ–‡ä»¶**

pycharmè¾“å…¥å‘½ä»¤Â scrapy crawl get\_movieÂ è¿è¡Œçˆ¬è™«æ–‡ä»¶

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630200355846-1830720240.png)

å¸¸è§æŠ¥é”™ï¼š

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630201045183-751084062.png)

æŠ¥é”™åˆ†æï¼š è¿™ä¸ªæ˜¯å› ä¸ºæˆ‘ä»¬å®‰è£…scrapyç‰ˆæœ¬é—®é¢˜å¯¼è‡´çš„ï¼Œå®‰è£…Scrapy==2.5.1 ç‰ˆæœ¬å³å¯

è§£å†³æ–¹æ¡ˆï¼š

 pip install -U Scrapy==2.5.1 -i https://pypi.tuna.tsinghua.edu.cn/simple/ 

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630201055649-1505948494.png)

**æ³¨æ„ï¼šåœ¨pycharmä¸­é‡æ–°å®‰è£…åï¼Œå¯åŠ¨çˆ¬è™«æ–‡ä»¶å¦‚æœè¿˜æŠ¥é”™ã€‚åœ¨cmdçª—å£å†æ‰§è¡Œä¸€ä¸‹pipå‘½ä»¤ï¼Œé—®é¢˜å°±è§£å†³äº†**

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630201502616-1639166052.png)

è¿è¡Œçˆ¬è™«è„šæœ¬ï¼Œçˆ¬å–è¿‡ç¨‹ä¸­ï¼Œå‘ç°redisæœ‰ä¸¤å¼ è¡¨(æ˜“äºç†è§£çš„æè¿°)ï¼ŒÂ get\_movie:dupefilterÂ ä»£è¡¨å·²ç»çˆ¬å–è¿‡çš„URLï¼ŒÂ get\_movie:requestsÂ ä»£è¡¨å¾…çˆ¬å–çš„url

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630213154723-297265844.png)

çˆ¬è™«è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼ŒæŸ¥çœ‹redisï¼Œå‘ç°valueé‡Œé¢æœ‰å¥½å¤šæ•°æ®ï¼Œè¿™äº›æ•°æ®éƒ½æ˜¯hashå€¼ï¼Œå·²ç»çˆ¬å–è¿‡çš„urlå°±ä¼šä»¥hashçš„æ–¹å¼å­˜å‚¨åˆ°valueé‡Œé¢ï¼Œè¿™æ ·å°±ä¸ä¼šé‡å¤çˆ¬å–åŒä¸€ä¸ªurlã€‚çˆ¬å–ç»“æŸåï¼Œpycharmä¸­æŒ‰ctrl+cåœæ­¢è„šæœ¬![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630201428925-1552020052.png)

**step-6ï¼šå†æ¬¡çˆ¬å–**

çˆ¬è™«è„šæœ¬æ‰§è¡Œç»“æŸåï¼Œredisé‡Œé¢ç§å­urlæ²¡æœ‰äº†ã€‚æƒ³è¦å†æ¬¡æ‰§è¡Œçˆ¬è™«è„šæœ¬ï¼Œéœ€è¦å°†ç§å­å†ä¸‹å‘ç»™redisï¼Œå³å†æ‰§è¡Œä¸€æ¬¡lpushå‘½ä»¤ï¼Œå°±åˆå¯ä»¥æ‰§è¡Œçˆ¬è™«è„šæœ¬äº†ã€‚

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630212103271-1492511793.png)

å†æ¬¡ä¸‹å‘ç§å­

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630212405341-2091587861.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630212433886-1613484400.png)

æ‰§è¡Œè„šæœ¬å†æ¬¡çˆ¬å–

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630212525004-38755423.png)

#### 3.3.3.æ–­ç‚¹ç»­çˆ¬

å½“çˆ¬è™«çˆ¬å–ä¸€åŠä¸­æ–­æ—¶ï¼Œè®¾ç½®äº†æ–­ç‚¹ç»­çˆ¬åï¼Œçˆ¬è™«ä¼šæ¥ç€çˆ¬å–ï¼Œè€Œä¸ä¼šå†æ¬¡é‡æ–°çˆ¬å–æ•°æ®ã€‚å¦‚ä½•å®ç°æ–­ç‚¹ç»­çˆ¬ï¼Œå¾ˆç®€å•ï¼Œå†settings.pyæ–‡ä»¶ä¸­å¼€å¯æ–­ç‚¹ç»­çˆ¬å³å¯

1 #æ–­ç‚¹ç»­çˆ¬
2 SCHEDULER\_PERSIST = True

**![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630221411524-2056305454.png)**

**ç¤ºä¾‹**

**åœºæ™¯ï¼š**çˆ¬è™«åˆ°ä¸€åŠæˆ‘ä»¬CTRL+Cåœæ­¢çˆ¬è™«è„šæœ¬ğŸ‘‰å†æ¬¡å¯åŠ¨çˆ¬è™«è„šæœ¬ğŸ‘‰çˆ¬å–ç»“æŸåï¼Œæ²¡æœ‰ç§å­urlçš„æƒ…å†µä¸‹å†æ¬¡æ‰§è¡Œçˆ¬è™«è„šæœ¬

**æ­¥éª¤ï¼š**

**step-1ï¼š**redisæ”¾å…¥ç§å­urlæ‰§è¡Œçˆ¬è™«ï¼Œå¼ºåˆ¶åœæ­¢çˆ¬è™«è„šæœ¬

LPUSH get\_movie:start\_urls http://movie.54php.cn/movie/

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630215806639-587366396.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630215955347-171789726.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630220025859-1046648899.png)

ç»“æœï¼šçˆ¬å–åˆ°ä¸€åŠï¼Œæˆ‘ä»¬å¼ºåˆ¶åœæ­¢çˆ¬è™«è„šæœ¬ï¼Œå‘ç°redisé‡Œé¢requestsçš„æ•°æ®è¿˜åœ¨ï¼Œæ²¡æœ‰æ¶ˆå¤±

**step-2ï¼š**å†æ¬¡å¯åŠ¨çˆ¬è™«æ–‡ä»¶

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630220218009-1822264735.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630220335474-1588773791.png)

ç»“æœï¼šæœ€åè„šæœ¬ç»“æŸç»Ÿè®¡çš„çˆ¬å–æ•°é‡æ˜¯ç¬¬äºŒæ¬¡çˆ¬å–çš„æ•°é‡ï¼Œè€Œä¸æ˜¯æ€»çš„æ•°é‡

**step-3ï¼š**å½“çˆ¬å–ç»“æŸåï¼Œæˆ‘ä»¬å†æ¬¡å¯åŠ¨çˆ¬è™«æ–‡ä»¶

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630220554489-1987108698.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630220736792-532269303.png)

ç»“æœï¼šæ§åˆ¶å°å‘Šè¯‰æˆ‘ä»¬Â start\_urlsÂ å·²ç»æŠ“å–è¿‡äº†ï¼Œä½ è¦æŠ“å–çš„urlåœ¨Â get\_movie:dupefilterÂ é‡Œé¢éƒ½æœ‰äº†ï¼Œä¸è¦è¦å†çˆ¬å–äº†

\------------------------------------------------------------------------------------------------------------------------------------

**æ€è€ƒï¼š**åœ¨ä¸é‡æ–°ç»™ç§å­urlçš„æƒ…å†µä¸‹ï¼Œæˆ‘å°±æ˜¯æƒ³å¤šæ¬¡çˆ¬å–æ€ä¹ˆåŠï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**åœ¨çˆ¬è™«æ–‡ä»¶parseæ–¹æ³•é‡Œé¢yieldå›è°ƒçš„æ—¶å€™ï¼ŒåŠ ä¸Šå‚æ•°Â dont\_filter=TrueÂ å³å¯å†æ¬¡çˆ¬å–ï¼›dont\_filteræ˜¯scrapyè¿‡æ»¤é‡å¤è¯·æ±‚çš„ï¼Œé»˜è®¤ä¸ºFalseå¯ä»¥è¿‡æ»¤dupefilterä¸­å·²ç»æŠ“å–è¿‡å»çš„è¯·æ±‚ï¼Œé¿å…é‡å¤æŠ“å–ï¼Œæ”¹ä¸ºTrueåå³ä¸ºä¸è¿‡æ»¤ï¼Œå¯ä»¥å†æ¬¡è¯·æ±‚çˆ¬å–ï¼Œscrapyæä¾›äº†è¿™ä¸ªå‚æ•°å°±æ˜¯è®©è‡ªå·±å»å†³å®šè¿™ä¸ªæ•°æ®æ˜¯åº”è¯¥è¿‡æ»¤æ‰è¿˜æ˜¯å¯ä»¥é‡å¤æŠ“å–

![](https://img2022.cnblogs.com/blog/2281865/202207/2281865-20220701111028797-2107369346.png)

**ç¤ºä¾‹**

**step-1ï¼š**ä¸‹å‘ç§å­urlï¼Œæ‰§è¡Œçˆ¬è™«ï¼Œç­‰å¾…çˆ¬è™«ç»“æŸ

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630222110709-1212150205.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630222123904-470968739.png)

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630222137165-244476649.png)

**step-2ï¼š**çˆ¬å–ç»“æŸï¼ŒæŒ‰ä¸‹CTRL+Cåœæ­¢è„šæœ¬ï¼ŒæŒ‰ç…§å›¾ç¤ºç‚¹å‡»Flush DBæ¸…ç©ºDBï¼Œå†æ¬¡æ‰§è¡Œçˆ¬è™«è„šæœ¬ï¼›æ²¡æœ‰ä¼ å…¥ç§å­URLçš„æƒ…å†µä¸‹ï¼Œçˆ¬è™«å¯ä»¥ç…§å¸¸çˆ¬å–

![](https://img2022.cnblogs.com/blog/2281865/202206/2281865-20220630222259465-995370119.png)

### 3.4.å®ç°åˆ†å¸ƒå¼çˆ¬è™«

é€šè¿‡å®ä¾‹é¡¹ç›®æ¥è®²è§£åˆ†å¸ƒå¼çˆ¬è™«çš„å®ç°ï¼›

å†…å®¹è¾ƒå¤šï¼Œåœ¨æ–°çš„éšç¬”é‡Œé¢ï¼š[https://www.cnblogs.com/gltou/p/16433539.html](https://www.cnblogs.com/gltou/p/16433539.html)