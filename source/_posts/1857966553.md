---
layout: post
title: "CAP 7.1 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š"
date: "2023-03-06T01:15:09.448Z"
---
CAP 7.1 ç‰ˆæœ¬å‘å¸ƒé€šå‘Š
==============

### å‰è¨€

ä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´å®£å¸ƒ CAP å‘å¸ƒ 7.1 ç‰ˆæœ¬æ­£å¼ç‰ˆï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­è§£å†³äº†ä¸€ä¸ªé•¿æœŸä»¥æ¥çš„é—®é¢˜ï¼Œä¹Ÿæ·»åŠ äº†å‡ ä¸ªå°ç‰¹æ€§åŠä¿®å¤äº†å‡ ä¸ªBugã€‚

ä» NuGet æ•°æ®æ¥çœ‹ï¼Œæˆ‘ä»¬äºå»å¹´åº•å‘å¸ƒçš„7.0ç‰ˆæœ¬éå¸¸å—æ¬¢è¿ï¼Œå¦‚æœä½ è¿˜æ²¡æœ‰çœ‹åˆ°æˆ‘ä»¬ 7.0 çš„æ–°ç‰¹æ€§çš„è¯ï¼Œè¿™é‡Œæ˜¯[ä¼ é€é—¨](https://www.cnblogs.com/savorboard/p/cap-7-0.html)ã€‚

ç°åœ¨ CAP åœ¨ NuGet çš„ä¸‹è½½é‡å·²ç»è¶…è¿‡äº†400ä¸‡ï¼Œä½œä¸ºä¸€ä¸ªéå·¥å…·ç±»çš„åº“ï¼Œè¿˜æ˜¯éå¸¸å‰å®³çš„ã€‚å½“ç„¶è¿™ä¸ä»…ä»…æ˜¯ä½œè€…æˆ‘ä¸€ä¸ªäººçš„åŠŸåŠ³ï¼Œè¿˜å¾—ç›Šäºæˆ‘ä»¬çš„ç”¨æˆ·ï¼Œåé¦ˆè€…ï¼Œç‰¹åˆ«æ˜¯è´¡çŒ®è€…ã€‚è¯´åˆ°è´¡çŒ®è€…ï¼Œè‡ª7.0ç‰ˆæœ¬ä»¥æ¥ï¼Œæˆ‘ä»¬åˆå¢åŠ äº†å‡ ä¸ªè´¡çŒ®è€…ã€‚åˆ†åˆ«æ˜¯ï¼š[@å‘¨æ½­æ½­](https://github.com/coolyuwk)ï¼Œ[@Giorgi Lekveishvili](https://github.com/giorgilekveishvili-meama)ï¼Œ[@Taha Ä°PEK](https://github.com/tahaipek)ï¼Œ[@ææ­£æµ©](https://github.com/li-zheng-hao)ï¼Œ[@Mustafa Ã‡aÄŸatay KÄ±zÄ±ltan](https://github.com/cagataykiziltan)ã€‚

ä¸‹é¢ï¼Œå…·ä½“çœ‹ä¸€ä¸‹æˆ‘ä»¬æ–°ç‰ˆæœ¬çš„åŠŸèƒ½å§ã€‚

### æ€»è§ˆ

å¯èƒ½æœ‰äº›äººè¿˜ä¸çŸ¥é“ CAP æ˜¯ä»€ä¹ˆï¼Œè€è§„çŸ©æ¥ä¸€ä¸ªç®€ä»‹ã€‚

[CAP](https://github.com/dotnetcore/CAP) æ˜¯ä¸€ä¸ªç”¨æ¥è§£å†³å¾®æœåŠ¡æˆ–è€…åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜çš„ä¸€ä¸ªå¼€æºé¡¹ç›®è§£å†³æ–¹æ¡ˆï¼ˆ[https://github.com/dotnetcore/CAP](https://github.com/dotnetcore/CAP)ï¼‰åŒæ ·å¯ä»¥ç”¨æ¥ä½œä¸º EventBus ä½¿ç”¨ï¼Œè¯¥é¡¹ç›®è¯ç”Ÿäº2016å¹´ï¼Œç›®å‰åœ¨ Github å·²ç»æœ‰è¶…è¿‡ 5.9k Star å’Œ 90+ è´¡çŒ®è€…ï¼Œä»¥åŠåœ¨ NuGetè¶… 400 ä¸‡çš„ä¸‹è½½é‡ï¼Œå¹¶åœ¨è¶Šæ¥è¶Šå¤šå…¬å¸çš„å’Œé¡¹ç›®ä¸­å¾—åˆ°åº”ç”¨ã€‚

å¦‚æœä½ æƒ³å¯¹ CAP æ›´å¤šäº†è§£ï¼Œè¯·æŸ¥çœ‹æˆ‘ä»¬çš„ [å®˜æ–¹æ–‡æ¡£](http://cap.dotnetcore.xyz)ã€‚

æœ¬æ¬¡åœ¨ CAP 7.1 ç‰ˆæœ¬ä¸­æˆ‘ä»¬ä¸»è¦å¸¦æ¥äº†ä»¥ä¸‹æ–°ç‰¹æ€§ï¼š

*   æ·»åŠ é…ç½®é¡¹å·²å¯ç”¨å¯¹åˆ†å¸ƒå¼é”çš„æ”¯æŒ
*   RabbitMQ æ·»åŠ å¯¹ BasicQos é…ç½®é¡¹çš„æ”¯æŒ
*   Azure Service Bus å®¢æˆ·ç«¯åŒ…æ›´æ–°ä¸º Microsoft.Azure.ServiceBus
*   Azure Service Bus æ”¯æŒå‘å¸ƒæ¶ˆæ¯åˆ°å¤šä¸ªTopic
*   Azure Service Bus æ·»åŠ  SQL Filter çš„æ”¯æŒ
*   æ·»åŠ å¯¹å¼€å¯äº‹åŠ¡å¼‚æ­¥æ–¹æ³•çš„æ”¯æŒ
*   BUG ä¿®å¤
    *   ä¿®å¤ Dashbaord åœ¨ Balzor åº”ç”¨ä¸­æ— æ³•å·¥ä½œçš„é—®é¢˜
    *   ä¿®å¤ä» Dashboard è§¦å‘é‡æ–°æ‰§è¡Œï¼Œæ¶ˆæ¯æ— æ³•æ‰§è¡Œçš„é—®é¢˜
    *   ä¿®å¤ Redis Streams Json åºåˆ—åŒ–é—®é¢˜
    *   ä¿®å¤ Redis Streams è¯»å–æˆ–åˆ›å»ºæµæ—¶å¹‚ç­‰æ£€æŸ¥çš„é—®é¢˜

### æ·»åŠ é…ç½®é¡¹å·²å¯ç”¨å¯¹åˆ†å¸ƒå¼é”çš„æ”¯æŒ

å¯¹CAPæ¯”è¾ƒç†Ÿæ‚‰çš„ç”¨æˆ·çŸ¥é“ï¼ŒCAPå†…éƒ¨æœ‰ä¸€ä¸ªé‡è¯•çš„çº¿ç¨‹é»˜è®¤æ¯éš”1åˆ†é’Ÿæ¥è¯»å–å­˜å‚¨çš„æ¶ˆæ¯ç”¨äºå¯¹å‘é€æˆ–æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯è¿›è¡Œé‡è¯•ï¼Œå•ä¸ªå®ä¾‹æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé‚£ä¹ˆåœ¨å¯ç”¨å¤šä¸ªå®ä¾‹çš„åœºæ™¯ä¸‹ä¼šæœ‰ä¸€å®šå‡ ç‡å‡ºç°å¹¶å‘è¯»çš„æƒ…å†µï¼Œè¿™å°±ä¼šå¯¼è‡´æ¶ˆæ¯è¢«é‡å¤å‘é€æˆ–æ¶ˆè´¹ã€‚è¿‡å»æˆ‘ä»¬è¦æ±‚æ¶ˆè´¹è€…å¯¹å…³é”®æ¶ˆæ¯è¿›è¡Œå¹‚ç­‰æ€§ä¿è¯æ¥é¿å…è´Ÿé¢å½±å“ï¼Œç°åœ¨æˆ‘ä»¬æä¾›äº†ä¸€ç§æ–¹å¼æ¥é¿å…è¿™ç§æƒ…å†µå‘ç”Ÿã€‚

åœ¨ 7.1.0 ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªé…ç½®é¡¹ `UseStorageLock` æ¥æ”¯æŒé…ç½®åŸºäºæ•°æ®åº“çš„åˆ†å¸ƒå¼é”ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šå®ä¾‹å¹¶å‘è¯»çš„é—®é¢˜ï¼Œå¹¶ä¸”å¯¹å¼‚å¸¸åœºæ™¯çš„å¤„ç†ä¹Ÿè¿›è¡Œäº†è€ƒè™‘ã€‚

æ³¨æ„ï¼šåœ¨å¼€å¯ `UseStorageLock` åï¼Œç³»ç»Ÿå°†ä¼šç”Ÿæˆä¸€ä¸ª cap.lock çš„æ•°æ®åº“è¡¨ï¼Œæ­¤è¡¨ç”¨äºé€šè¿‡æ•°æ®åº“æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚

æ„Ÿè°¢ [@ææ­£æµ©](https://github.com/li-zheng-hao) å¯¹æ­¤æäº¤çš„PRã€‚æˆ‘æƒ³ç‰¹åˆ«è¯´ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸è®¤è¯† ï¼Œä½†æ˜¯åŠå¤œ12ç‚¹å¤šè¿˜åœ¨GitHubå’Œæˆ‘è®¨è®ºé—®é¢˜ï¼Œæäº¤ä»£ç ([#1272](https://github.com/dotnetcore/CAP/pull/1272),[#1274](https://github.com/dotnetcore/CAP/pull/1274))ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆåŠªåŠ›çš„å°ä¼™å­ï¼Œæˆ‘ä»¬è¿™æ¬¡è¿™ä¸ªé•¿æœŸä»¥æ¥çš„é—®é¢˜å°±æ˜¯ä»–è´¡çŒ®çš„PRï¼Œæ‰€ä»¥ç‰¹åˆ«æ„Ÿè°¢ï¼Œä»–çš„åšå®¢ [https://www.lizhenghao.site](https://www.lizhenghao.site)

### RabbitMQ æ·»åŠ å¯¹ BasicQos é…ç½®é¡¹çš„æ”¯æŒ

æˆ‘ä»¬åœ¨RabbitMQä¸­æ·»åŠ äº†å¯¹ BasicQos çš„é…ç½®é¡¹æ”¯æŒï¼ŒBasicQosä¸»è¦ç”¨äºé…ç½®RabbitMQä¸­æ¶ˆæ¯åˆ†å‘ç»™æ¶ˆè´¹è€…çš„ PrefetchCountï¼Œä¹Ÿå°±æ˜¯æœªAckçš„æ•°é‡ã€‚

é€šè¿‡åœ¨UseRabbitMQä¸­çš„ `BasicQosOptions` æ¥è®¾ç½®ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š

    services.AddCap(x =>
    {
        x.UseRabbitMQ(y =>
        {
            y.BasicQosOptions = new DotNetCore.CAP.RabbitMQOptions.BasicQos(3);
        });
    });
    

æ„Ÿè°¢ [@nunorelvao](https://github.com/nunorelvao) å¯¹æ­¤æäº¤çš„PRã€‚

### Azure Service Bus å®¢æˆ·ç«¯åŒ…æ›´æ–°ä¸º Azure.Messaging.ServiceBus

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å°† `Microsoft.Azure.ServiceBus` å®¢æˆ·ç«¯åŒ…å˜æ›´ä¸ºäº† `Azure.Messaging.ServiceBus`ã€‚

`Microsoft.Azure.ServiceBus` ç›®å‰å·²ç»è¢«å¼ƒç”¨ï¼Œå®˜æ–¹å»ºè®®å»ºè®®ä½¿ç”¨ Azure.Messaging.ServiceBusã€‚

æ„Ÿè°¢ [@Giorgi Lekveishvili](https://github.com/giorgilekveishvili-meama) å¯¹æ­¤æäº¤çš„ PRã€‚

### Azure Service Bus æ”¯æŒå‘å¸ƒæ¶ˆæ¯åˆ°å¤šä¸ªTopic

è¿‡å»ï¼ŒCAPåªæ”¯æŒå°†æ¶ˆæ¯å‘é€åˆ°Azure Service Busä¸­çš„ä¸€ä¸ªTopic ä¸Šï¼Œä½†æ˜¯å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰æ—¶å€™éœ€è¦å‘é€åˆ°å¤šä¸ªTopicï¼Œæ­¤ç‰ˆæœ¬æä¾›å¯¹æ ¹æ®æ¶ˆæ¯ç±»å‹é…ç½®å‘é€Topicçš„é€‰é¡¹çš„æ”¯æ”¯æŒã€‚

ç”¨æ³•å¦‚ä¸‹ï¼š

    capOptions.UseAzureServiceBus(asb =>
    {
        // other configuration
        asb.ConfigureCustomProducer<EntityCreatedForIntegration>(cfg => cfg.WithTopic("entity-created"));
    });
    

æ„Ÿè°¢ [@mviegas](https://github.com/mviegas) , [@jonekdahl](https://github.com/jonekdahl) å¯¹æ­¤æäº¤çš„PRã€‚

### Azure Service Bus æ·»åŠ  SQL Filter çš„æ”¯æŒ

æˆ‘ä»¬å¯¹ Azure Service Bus æ·»åŠ äº†å¯¹ SQL Filter é…ç½®é¡¹çš„æ”¯æŒï¼Œä½ å¯ä»¥åœ¨è®¢é˜…æ¶ˆæ¯çš„æ—¶å€™ï¼Œé€šè¿‡è®¾ç½®Sql Filter æ¥åªè®¢é˜…ä½ éœ€è¦çš„æ¶ˆæ¯ï¼Œè€Œä¸å¿…åœ¨ä¸šåŠ¡é€»è¾‘ä¸­è¿›è¡Œè¿‡æ»¤ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š

    c.UseAzureServiceBus(asb =>
    {
        asb.ConnectionString = ...
        asb.SQLFilters = new List<KeyValuePair<string, string>> {
                
                new KeyValuePair<string,string>("IOTFilter","FromIOTHub='true'"),//The message will be handled if ApplicationProperties contains IOTFilter and value is true
                new KeyValuePair<string,string>("SequenceFilter","sys.enqueuedSequenceNumber >= 300")
            };
    });
    

æ„Ÿè°¢ [@Giorgi Lekveishvili](https://github.com/giorgilekveishvili-meama) å¯¹æ­¤æä¾›çš„ PRã€‚

### æ·»åŠ å¯¹å¼€å¯äº‹åŠ¡å¼‚æ­¥æ–¹æ³•çš„æ”¯æŒ

åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†æ–°çš„å¼‚æ­¥æ‰©å±•æ–¹æ³•ç”¨äºå¼€å¯äº‹åŠ¡ï¼Œå¹¶ä¸”æ”¯æŒä¼ é€’ IsolationLevel å‚æ•°ï¼Œæ„Ÿè°¢ [@Mahmoud Shaheen](https://github.com/xshaheen) å¯¹æ­¤æäº¤çš„PRï¼

### BUG ä¿®å¤

å¦å¤–åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¿®å¤äº†ä¸€äº›å·²çŸ¥çš„Bugï¼Œä»¥ä¸‹æ˜¯å·²ç»ä¿®å¤çš„é—®é¢˜åˆ—è¡¨ã€‚

*   ä¿®å¤ Dashbaord åœ¨ Balzor åº”ç”¨ä¸­æ— æ³•å·¥ä½œçš„é—®é¢˜
*   ä¿®å¤ä» Dashboard è§¦å‘é‡æ–°æ‰§è¡Œï¼Œæ¶ˆæ¯æ— æ³•æ‰§è¡Œçš„é—®é¢˜
*   ä¿®å¤ Redis Streams Json åºåˆ—åŒ–é—®é¢˜
*   ä¿®å¤ Redis Streams è¯»å–æˆ–åˆ›å»ºæµæ—¶å¹‚ç­‰æ£€æŸ¥çš„é—®é¢˜

### æ€»ç»“

ä»¥ä¸Šï¼Œå°±æ˜¯æœ¬ç‰ˆæœ¬æˆ‘ä»¬åšå‡ºçš„ä¸€äº›æ–°ç‰¹æ€§å’Œæ”¹åŠ¨ï¼Œæ„Ÿè°¢å¤§å®¶çš„æ”¯æŒï¼Œæˆ‘ä»¬å¾ˆå¼€å¿ƒèƒ½å¤Ÿå¸®åŠ©åˆ°å¤§å®¶ ã€‚

å¤§å®¶åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜å¸Œæœ›ä¹Ÿèƒ½å¤Ÿç§¯æçš„åé¦ˆï¼Œå¸®åŠ©CAPå˜å¾—è¶Šæ¥è¶Šå¥½ã€‚ğŸ˜ƒ

å¦‚æœä½ å–œæ¬¢è¿™ä¸ªé¡¹ç›®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„è¿æ¥ç‚¹å‡» Star ç»™æˆ‘ä»¬æ”¯æŒã€‚

[![GitHub stars](https://img.shields.io/github/stars/dotnetcore/CAP.svg?label=github-cap-stars)](https://github.com/dotnetcore/CAP/stargazers)

å¦‚æœä½ è§‰å¾—æœ¬ç¯‡æ–‡ç« å¯¹æ‚¨æœ‰å¸®åŠ©çš„è¯ï¼Œæ„Ÿè°¢æ‚¨çš„ã€æ¨èã€‘ã€‚

* * *

> æœ¬æ–‡åœ°å€ï¼š[http://www.cnblogs.com/savorboard/p/cap-7-1.html](http://www.cnblogs.com/savorboard/p/cap-7-1.html)  
> ä½œè€…åšå®¢ï¼š[Savorboard](http://www.cnblogs.com/savorboard)  
> æœ¬æ–‡åŸåˆ›æˆæƒä¸ºï¼šç½²å - éå•†ä¸šæ€§ä½¿ç”¨ - ç¦æ­¢æ¼”ç»ï¼Œåè®®[æ™®é€šæ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/) | åè®®[æ³•å¾‹æ–‡æœ¬](https://creativecommons.org/licenses/by-nc-nd/4.0/legalcode)