---
layout: post
title: "é‡‘ä¹é“¶åï¼Œæ”¶ä¸‹è¿™ä»½ Java String é¢è¯•é¢˜"
date: "2022-09-06T06:15:51.109Z"
---
é‡‘ä¹é“¶åï¼Œæ”¶ä¸‹è¿™ä»½ Java String é¢è¯•é¢˜
=========================

> **è¯·ç‚¹èµå…³æ³¨ï¼Œä½ çš„æ”¯æŒå¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚**
> 
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°å½­ã€‚æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Android-NoteBook](https://github.com/pengxurui/Android-NoteBook) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œæœ‰å¿—åŒé“åˆçš„æœ‹å‹ï¼Œå…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] å¸¦ä½ å»ºç«‹æ ¸å¿ƒç«äº‰åŠ›ã€‚**

å‰è¨€
--

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

è¿‡å»ä¸¤å¹´ï¼Œæˆ‘ä»¬åœ¨æ˜é‡‘å¹³å°ä¸Šå‘å¸ƒ JetPack ä¸“æ æ–‡ç« ï¼Œå°å½­ä¹Ÿå—åˆ°äº†å¤§å®¶çš„æ„è§å’Œé¼“åŠ±ã€‚æœ€è¿‘ï¼Œå°å½­ä¼šé™†ç»­æ¬è¿åˆ°å…¬ä¼—å·ä¸Šã€‚

åœ¨æ¯ç§ç¼–ç¨‹è¯­è¨€é‡Œï¼Œå­—ç¬¦ä¸²éƒ½æ˜¯ä¸€ä¸ªèº²ä¸å¼€çš„è¯é¢˜ï¼Œä¹Ÿæ˜¯é¢è¯•å¸¸å¸¸å‡ºç°çš„é—®é¢˜ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å°†æ€»ç»“ **Java å­—ç¬¦ä¸²ä¸­é‡è¦çš„çŸ¥è¯†ç‚¹ & é¢è¯•é¢˜** ï¼Œå¦‚æœèƒ½å¸®ä¸Šå¿™ï¼Œè¯·åŠ¡å¿…ç‚¹èµåŠ å…³æ³¨ï¼Œè¿™çœŸçš„å¯¹æˆ‘éå¸¸é‡è¦ã€‚

* * *

**å­¦ä¹ è·¯çº¿å›¾ï¼š**

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/88c655ab4cbf4b8ca71eea0427b36686~tplv-k3u1fbpfcp-watermark.image?)

* * *

1\. C å’Œ Java ä¸­å­—ç¬¦ä¸²å’Œå­—ç¬¦æ•°ç»„çš„å¯¹æ¯”
-------------------------

### 1.1 å†…å­˜è¡¨ç¤ºä¸åŒ

*   åœ¨ C è¯­è¨€ä¸­ï¼Œå­—ç¬¦ä¸²å’Œå­—ç¬¦æ•°ç»„ç›¸åŒã€‚å­—ç¬¦ä¸²æœ¬è´¨ä¸Šæ˜¯ä»¥ `\0` ä¸ºç»“æŸç¬¦çš„å­—ç¬¦æ•°ç»„å­—ç¬¦æ•°ç»„ï¼Œå› æ­¤å­—ç¬¦ä¸²å’Œå­—ç¬¦æ•°ç»„åœ¨æœ¬è´¨ä¸Šç›¸åŒï¼Œéƒ½æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä»¥éœ€è¦è½¬ä¹‰ `\0` ä¸ºç»“æŸç¬¦ã€‚C è¯­è¨€æ˜¯ä¸å…³å¿ƒ char\[\] é‡Œå­˜å‚¨å­—ç¬¦çš„ç¼–ç æ–¹å¼çš„ï¼Œåªæœ‰é€šè¿‡ç¨‹åºçš„ä¸Šä¸‹æ–‡ç¡®å®šï¼›
*   åœ¨ Java ä¸­ï¼Œå­—ç¬¦ä¸²å’Œå­—ç¬¦æ•°ç»„ä¸åŒã€‚å­—ç¬¦ä¸²æ˜¯ String å¯¹è±¡ï¼Œè€Œå­—ç¬¦æ•°ç»„æ˜¯æ•°ç»„å¯¹è±¡ï¼Œå‡ä¸éœ€è¦ç»“æŸç¬¦ã€‚å¦‚æœæ˜¯æ•°ç»„å¯¹è±¡ï¼Œå¯¹è±¡å†…å­˜åŒºåŸŸä¸­æœ‰ä¸€ä¸ªå­—æ®µè¡¨ç¤ºæ•°ç»„çš„é•¿åº¦ï¼Œè€Œ String ç›¸å½“äºå­—ç¬¦æ•°ç»„çš„åŒ…è£…ç±»ã€‚å†…éƒ¨åŒ…è£…äº†ä¸€ä¸ªåŸºäº `UTF-16 BE` ç¼–ç çš„å­—ç¬¦æ•°ç»„ï¼ˆä» Java 9 å¼€å§‹å˜ä¸ºå­—èŠ‚æ•°ç»„ï¼‰ã€‚å…¶ä»–å­—ç¬¦ç¼–ç è¾“å…¥çš„å­—èŠ‚æµåœ¨è¿›å…¥ String æ—¶éƒ½ä¼šè¢«è½¬æ¢ä¸º `UTF-16 BE` ç¼–ç ã€‚

`java.lang.String`

    public final class String {
    
        private final char value[];
    
        private int hash;
    
        ...
    }
    

### 1.2 char ç±»å‹çš„æ•°æ®é•¿åº¦

*   åœ¨ C è¯­è¨€ä¸­ï¼Œchar ç±»å‹å  1 å­—èŠ‚ï¼Œåˆ†ä¸ºæœ‰ç¬¦å·ä¸æ— ç¬¦å·ä¸¤ç§ï¼›
*   åœ¨ Java ä¸­ï¼Œchar ç±»å‹å  2 å­—èŠ‚ï¼Œåªæœ‰æ— ç¬¦å·ç±»å‹ã€‚

è¯­è¨€

ç±»å‹

å­˜å‚¨ç©ºé—´ï¼ˆå­—èŠ‚ï¼‰

æœ€å°å€¼

æœ€å¤§å€¼

Java

char

2

0

65535

C

charï¼ˆç›¸å½“äºsigned charï¼‰

1

\-128

127

C

signed char

1

\-128

127

C

unsigned char

1

0

255

* * *

2\. ä¸ºä»€ä¹ˆ Java 9 String å†…éƒ¨å°† char æ•°ç»„æ”¹ä¸º byte æ•°ç»„ï¼Ÿ
--------------------------------------------

Java String çš„å†…å­˜è¡¨ç¤ºæœ¬è´¨ä¸Šæ˜¯åŸºäº `UTF-16 BE` ç¼–ç çš„å­—ç¬¦æ•°ç»„ã€‚UTF-16 æ˜¯ 2 ä¸ªå­—èŠ‚æˆ– 4 ä¸ªå­—èŠ‚çš„å˜é•¿ç¼–ç ï¼Œè¿™æ„å‘³ç€å³ä½¿æ˜¯ UniCode å­—ç¬¦é›†çš„æ‹‰ä¸å­—æ¯ï¼Œä½¿ç”¨ ASCII ç¼–ç åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯åœ¨ String ä¸­éœ€è¦ä¸¤ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚

**ä¸ºäº†ä¼˜åŒ–å­˜å‚¨ç©ºé—´ï¼Œä» Java 9 å¼€å§‹ï¼ŒString å†…éƒ¨å°† char æ•°ç»„æ”¹ä¸º byte æ•°ç»„ï¼ŒString ä¼šåˆ¤æ–­å­—ç¬¦ä¸²ä¸­æ˜¯å¦åªåŒ…å«æ‹‰ä¸å­—æ¯ã€‚å¦‚æœæ˜¯çš„è¯åˆ™é‡‡ç”¨å•å­—èŠ‚ç¼–ç ï¼ˆLatin-1ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨ UTF-16 ç¼–ç ã€‚**

`String.java (since Java 9)`

    private final byte coder;
    static final boolean COMPACT_STRINGS;
    static {
        COMPACT_STRINGS = true;
    }
    byte coder() {
        return COMPACT_STRINGS ? coder : UTF16;
    }
    @Native static final byte LATIN1 = 0;
    @Native static final byte UTF16  = 1;
    

ä¸åŒç¼–ç å®ç°çš„ç®€å•åŒºåˆ«å¦‚ä¸‹ï¼š

ç¼–ç æ ¼å¼

ç¼–ç å•å…ƒé•¿åº¦

BOM

å­—èŠ‚åº

UTF-8-æ— BOM

1 ~ 4 å­—èŠ‚

æ— 

å¤§ç«¯åº

UTF-8

1 ~ 4 å­—èŠ‚

EF BB BF

å¤§ç«¯åº

UTF-16-æ— BOM

2 / 4 å­—èŠ‚

æ— 

å¤§ç«¯åº

UTF-16BEï¼ˆé»˜è®¤ï¼‰

2 / 4 å­—èŠ‚

FE FF

å¤§ç«¯åº

UTF-16LE

2 / 4 å­—èŠ‚

FF FE

å°ç«¯åº

UTF-32-æ— BOM

4 å­—èŠ‚

æ— 

å¤§ç«¯åº

UTF-32BEï¼ˆé»˜è®¤ï¼‰

4 å­—èŠ‚

00 00 FE FF

å¤§ç«¯åº

UTF-32LE

4 å­—èŠ‚

FF EE 00 00

å°ç«¯åº

å…³äºå­—ç¬¦ç¼–ç çš„æ›´å¤šå†…å®¹ï¼Œè§ï¼š [è®¡ç®—æœºåŸºç¡€ï¼šä»Šå¤©ä¸€æ¬¡æŠŠ Unicode å’Œ UTF-8 è¯´æ¸…æ¥š](https://juejin.cn/post/7126396251322449934)

* * *

3\. String & StringBuilder & StringBuffer çš„åŒºåˆ«
---------------------------------------------

### 3.1 æ•ˆç‡

String æ˜¯ä¸å¯å˜çš„ï¼Œæ¯æ¬¡æ“ä½œéƒ½ä¼šåˆ›å»ºæ–°çš„å˜é‡ï¼Œè€Œå¦å¤–ä¸¤ä¸ªæ˜¯å¯å˜çš„ï¼Œä¸éœ€è¦åˆ›å»ºæ–°çš„å˜é‡ï¼›å¦å¤–ï¼ŒStringBuffer çš„æ¯ä¸ªæ“ä½œæ–¹æ³•éƒ½ä½¿ç”¨ synchronized å…³é”®å­—ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¢åŠ äº†æ›´å¤šåŠ é” & é‡Šæ”¾é”çš„æ—¶é—´ã€‚å› æ­¤ï¼Œæ“ä½œæ•ˆç‡çš„ç®€å•æ’åºä¸ºï¼šStringBuilder > StringBuffer > Stringã€‚

### 3.2 **çº¿ç¨‹å®‰å…¨**

String ä¸å¯å˜ï¼Œæ‰€ä»¥ String å’Œ StringBuffer éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè€Œ StringBuilder æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚

ç±»å‹

æ“ä½œæ•ˆç‡

çº¿ç¨‹å®‰å…¨

String

ä½

å®‰å…¨ï¼ˆfinalï¼‰

StringBuffer

ä¸­

å®‰å…¨ï¼ˆsynchronizedï¼‰

StringBuilder

é«˜

éå®‰å…¨

* * *

4\. ä¸ºä»€ä¹ˆ String è®¾è®¡ä¸ºä¸å¯å˜ç±»ï¼Ÿ
-----------------------

### 4.1 **å¦‚ä½•è®© String ä¸å¯å˜ï¼Ÿ**

ã€ŠEffective Javaã€‹ä¸­ **å¯å˜æ€§æœ€å°åŒ–åŸåˆ™**ï¼Œé˜è¿°äº†ä¸å¯å˜ç±»çš„è§„åˆ™ï¼š

*   1ã€ä¸å¯¹å¤–æä¾›ä¿®æ”¹å¯¹è±¡çŠ¶æ€çš„ä»»ä½•æ–¹æ³•ï¼›
*   2ã€ä¿è¯ç±»ä¸ä¼šè¢«æ‰©å±•ï¼ˆå£°æ˜ä¸º final ç±»æˆ– private æ„é€ å™¨ï¼‰ï¼›
*   3ã€å£°æ˜æ‰€æœ‰åŸŸä¸º finalï¼›
*   4ã€å£°æ˜æ‰€æœ‰åŸŸä¸º privateï¼›
*   5ã€ç¡®ä¿å¯¹äºä»»ä½•å¯å˜æ€§ç»„ä»¶çš„äº’æ–¥è®¿é—®ã€‚

ä»¥ä¸Šè§„åˆ™ String å‡æ»¡è¶³ã€‚

### 4.2 ä¸ºä»€ä¹ˆ String è¦è®¾è®¡ä¸ºä¸å¯å˜**ï¼Ÿ**

*   **1ã€ä¸å¯å˜ç±» String å¯ä»¥é¿å…ä¿®æ”¹åæ— æ³•å®šä½æ•£åˆ—è¡¨é”®å€¼å¯¹ï¼š** å‡è®¾ String æ˜¯å¯å˜ç±»ï¼Œå½“æˆ‘ä»¬åœ¨ HashMap ä¸­æ„å»ºèµ·ä¸€ä¸ªä»¥ String ä¸º Key çš„é”®å€¼å¯¹æ—¶ï¼Œæ­¤æ—¶å¯¹ String è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆé€šè¿‡ä¿®æ”¹åçš„ String æ˜¯æ— æ³•åŒ¹é…åˆ°åˆšæ‰æ„å»ºè¿‡çš„é”®å€¼å¯¹çš„ï¼Œå› ä¸ºä¿®æ”¹åçš„ hashCode å¯èƒ½æ˜¯å˜åŒ–çš„ã€‚è€Œä¸å¯å˜ç±»å¯ä»¥è§„é¿è¿™ä¸ªé—®é¢˜ã€‚
*   **2ã€çº¿ç¨‹å®‰å…¨ï¼š** ä¸å¯å˜å¯¹è±¡æœ¬è´¨æ˜¯çº¿ç¨‹å®‰å…¨ï¼Œä¸éœ€è¦åŒæ­¥ï¼›

> **æç¤ºï¼š** åå°„å¯ä»¥ç ´å String çš„ä¸å¯å˜æ€§ã€‚

* * *

5\. String + çš„å®ç°åŸç†
------------------

String `+` æ“ä½œç¬¦æ˜¯ç¼–è¯‘å™¨è¯­æ³•ç³–ï¼Œç¼–è¯‘åä¼šè¢«æ›¿æ¢ä¸º `StringBuilder#append(...)` è¯­å¥ï¼Œä¾‹å¦‚ï¼š

`ç¤ºä¾‹ç¨‹åº`

    // æºç ï¼š
    
    String string = null;
    for (String str : strings) {
        string += str;
    }
    return string;
    
    // ç¼–è¯‘äº§ç‰©ï¼š
    
    String string = null;
    for(String str : strings) {
        StringBuilder builder = new StringBuilder();
        builder.append(string);
        builder.append(str);
        string = builder.toString();
    }
    
    // å­—èŠ‚ç ï¼š
    
     0 aconst_null
     1 astore_1
     2 aload_0
     3 astore_2
     4 aload_2
     5 arraylength
     6 istore_3
     7 iconst_0
     8 istore 4
    10 iload 4
    12 iload_3
    13 if_icmpge 48 (+35)
    16 aload_2
    17 iload 4
    19 aaload
    20 astore 5
    22 new #7 <java/lang/StringBuilder>
    25 dup
    26 invokespecial #8 <java/lang/StringBuilder.<init>>
    29 aload_1
    30 invokevirtual #9 <java/lang/StringBuilder.append>
    33 aload 5
    35 invokevirtual #9 <java/lang/StringBuilder.append>
    38 invokevirtual #10 <java/lang/StringBuilder.toString>
    41 astore_1
    42 iinc 4 by 1
    45 goto 10 (-35)
    48 aload_1
    49 areturn
    
    

å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœåœ¨å¾ªç¯é‡Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸² `+`ï¼Œä¼šç”Ÿæˆéå¸¸å¤šä¸­é—´å˜é‡ï¼Œæ€§èƒ½éå¸¸å·®ã€‚åº”è¯¥åœ¨å¾ªç¯å¤–æ–°å»ºä¸€ä¸ª `StringBuilder`ï¼Œåœ¨å¾ªç¯å†…ç»Ÿä¸€æ“ä½œè¿™ä¸ªå¯¹è±¡ã€‚

* * *

6\. String å¯¹è±¡çš„å†…å­˜åˆ†é…
------------------

### 6.1 **"abc" ä¸ new String("abc") çš„åŒºåˆ«**

*   `"abc"` => è™šæ‹Ÿæœºé¦–å…ˆæ£€æŸ¥ **è¿è¡Œæ—¶å¸¸é‡æ± ** ä¸­æ˜¯å¦å­˜åœ¨ "abc"ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åœ¨å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­åˆ›å»º "abc" å¯¹è±¡å¹¶è¿”å›ã€‚å› æ­¤ï¼Œå¤šæ¬¡å£°æ˜ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›
*   `new String("abc")` => åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒJavac ä¼šå°† "abc" åŠ å…¥åˆ° **Class æ–‡ä»¶å¸¸é‡æ± ** ä¸­ã€‚åœ¨ç±»åŠ è½½æ—¶æœŸï¼ŒClass æ–‡ä»¶å¸¸é‡æ± ä¼šè¢«åŠ è½½è¿›è¿è¡Œæ—¶å¸¸é‡æ± ã€‚åœ¨è°ƒç”¨ new å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œè™šæ‹Ÿæœºä¼šåœ¨å †ä¸­æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”å¼•ç”¨å¸¸é‡æ± ä¸­çš„ "abc" å¯¹è±¡ã€‚

### 6.2 **String#intern() çš„å®ç°åŸç†**

å¦‚æœå­—ç¬¦ä¸²å¸¸é‡æ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›å¸¸é‡æ± ä¸­çš„è¿™ä¸ªå­—ç¬¦ä¸²ï¼›å¦åˆ™ï¼Œå…ˆå°†æ­¤ String å¯¹è±¡åŒ…å«çš„å­—ç¬¦ä¸²æ‹·è´åˆ°å¸¸é‡æ± ä¸­ï¼Œåœ¨å¸¸é‡æ± ä¸­çš„è¿™ä¸ªå­—ç¬¦ä¸²ã€‚

ä» JDK 1.7 å¼€å§‹ï¼Œ`String#intern()` ä¸å†æ‹·è´å­—ç¬¦ä¸²åˆ°å¸¸é‡æ± ä¸­ï¼Œè€Œæ˜¯åœ¨å¸¸é‡æ± ä¸­ç”Ÿæˆä¸€ä¸ªå¯¹åŸ String å¯¹è±¡çš„å¼•ç”¨ï¼Œå¹¶è¿”å›ã€‚

    // ä¸¾ä¾‹ï¼š
    String s = new String("1");
    s.intern();
    String s2 = "1";
    System.out.println(s == s2);
    
    String s3 = new String("1") + new String("1");
    s3.intern();
    String s4 = "11";
    System.out.println(s3 == s4);
    
    // è¾“å‡ºç»“æœä¸ºï¼š
    JDK1.6ä»¥åŠä»¥ä¸‹ï¼šfalse false
    JDK1.7ä»¥åŠä»¥ä¸Šï¼šfalse true
    

* * *

7\. ä¸ºä»€ä¹ˆ String#haseCode() è¦ä½¿ç”¨ 31 ä½œä¸ºå› å­ï¼Ÿ
--------------------------------------

    public int hashCode() {
        int h = hash;
        if (h == 0 && value.length > 0) {
            char val[] = value;
    
            for (int i = 0; i < value.length; i++) {
                h = 31 * h + val[i];
            }
            hash = h;
        }
        return h;
    }
    
    

*   **åŸå›  1 - 31 å¯ä»¥è¢«ç¼–è¯‘å™¨ä¼˜åŒ–** $31 \* i = (i << 5) - i$ï¼Œä½è¿ç®—å’Œå‡æ³•è¿ç®—çš„æ•ˆç‡æ¯”ä¹˜æ³•è¿ç®—é«˜ã€‚
*   **åŸå›  2 - 31 æ˜¯ä¸€ä¸ªè´¨æ•°ï¼š** è´¨æ•°æ˜¯åªèƒ½è¢« 1 å’Œè‡ªèº«æ•´é™¤çš„æ•°ï¼Œä½¿ç”¨è´¨æ•°ä½œä¸ºä¹˜æ³•å› å­è·å¾—çš„æ•£åˆ—å€¼ï¼Œåœ¨å°†æ¥è¿›è¡Œå–æ¨¡æ—¶ï¼Œå¾—åˆ°ç›¸åŒ index çš„æ¦‚ç‡ä¼šé™ä½ï¼Œå³é™ä½äº†å“ˆå¸Œå†²çªçš„æ¦‚ç‡ã€‚
*   **åŸå›  3 - 31 æ˜¯ä¸€ä¸ªä¸å¤§ä¸å°çš„è´¨æ•°ï¼š** è´¨æ•°å¤ªå°å®¹æ˜“é€ æˆæ•£åˆ—å€¼èšé›†åœ¨ä¸€ä¸ªå°åŒºé—´ï¼Œæä¾›æ•£åˆ—å†²çªæ¦‚ç‡ï¼›è´¨æ•°è¿‡å¤§å®¹æ˜“é€ æˆæ•£åˆ—å€¼è¶…å‡º int çš„å–å€¼èŒƒå›´ï¼ˆä¸Šæº¢ï¼‰ï¼Œä¸¢å¤±éƒ¨åˆ†æ•°å€¼ä¿¡æ¯ï¼Œæ•£åˆ—å†²çªæ¦‚ç‡ä¸ç¨³å®šã€‚

> **æˆ‘æ˜¯å°å½­ï¼Œå¸¦ä½ æ„å»º Android çŸ¥è¯†ä½“ç³»ã€‚æŠ€æœ¯å’ŒèŒåœºé—®é¢˜ï¼Œè¯·å…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\]ç§ä¿¡æˆ‘æé—®ã€‚**