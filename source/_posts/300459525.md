---
layout: post
title: "é«˜å¯ç”¨ç³»åˆ—æ–‡ç« ä¹‹ä¸‰ - NGINX é«˜å¯ç”¨å®æ–½æ–¹æ¡ˆ"
date: "2022-12-19T05:14:59.648Z"
---
é«˜å¯ç”¨ç³»åˆ—æ–‡ç« ä¹‹ä¸‰ - NGINX é«˜å¯ç”¨å®æ–½æ–¹æ¡ˆ
=========================

å‰æ–‡é“¾æ¥
----

1.  [é«˜å¯ç”¨ç³»åˆ—æ–‡ç« ä¹‹ä¸€ - æ¦‚è¿° - ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ (ewhisper.cn)](https://ewhisper.cn/posts/48595/)
2.  [é«˜å¯ç”¨ç³»åˆ—æ–‡ç« ä¹‹äºŒ - ä¼ ç»Ÿåˆ†å±‚æ¶æ„æŠ€æœ¯æ–¹æ¡ˆ - ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ (ewhisper.cn)](https://ewhisper.cn/posts/15216/)

å›› NGINX é«˜å¯ç”¨å®æ–½æ–¹æ¡ˆ
---------------

é«˜å¯ç”¨çš„å®æ–½, ä¸»è¦æ­¥éª¤æ¦‚è¿°å¦‚ä¸‹:

1.  NGINX çš„å®‰è£…åŠåŸºç¡€é…ç½®
2.  è´Ÿè½½å‡è¡¡å±‚é«˜å¯ç”¨: NGINX + Keepalivedé…ç½®
3.  åº”ç”¨æœåŠ¡å±‚é«˜å¯ç”¨: NGINX -> åº”ç”¨æœåŠ¡å±‚ è½¬å‘é…ç½®

**ç³»ç»Ÿè½¯ ç¡¬ä»¶è¯¦ç»†é…ç½®æ¸…å•**

æ ¹æ®åˆ¶é€ ä¸šé«˜å¯ç”¨æ¶æ„è®¾è®¡, ä»¥åŠä¸šåŠ¡éœ€æ±‚, éƒ¨ç½²æ¨¡å‹å»ºè®®é…ç½®å¦‚ä¸‹:

*   è´Ÿè½½å‡è¡¡æœåŠ¡å™¨(å³ NGINX + Keepalived): 2å°, æ“ä½œç³»ç»Ÿ Linux. é…ç½®å»ºè®®å¦‚ä¸‹:

åç§°

è§„æ ¼

å¤‡æ³¨

CPU

2 core

å†…å­˜

4 GB

ç¡¬ç›˜

50 GB

æ“ä½œç³»ç»Ÿ

SUSE12 64ä½åŠè¡¥ä¸

ç½‘å¡

è‡³å°‘1å—ç½‘å¡, æ”¯æŒVRRP æŠ€æœ¯

*   è½¯ä»¶è¿è¡Œé…ç½®ç¯å¢ƒ:

è½¯ä»¶

è§„æ ¼

NGINX

1.16.1

Keepalived

2.0.10

### 4.1 NGINX å®‰è£…åŠé…ç½®

#### 4.1.1 åˆ†åŒºåŠç›®å½•

å»ºè®®è‡³å°‘åˆ†ä¸ºä»¥ä¸‹3ä¸ªåŒº:

åˆ†åŒºåŠç›®å½•

å¤§å°

å¤‡æ³¨

ä¸»åˆ†åŒº( `/`)

é»˜è®¤

nginxç¨‹åºåŠé…ç½®æ–‡ä»¶ä½äºè¯¥åˆ†åŒº(`/etc/nginx`)

æ—¥å¿—åˆ†åŒº(`/var/log/nginx`)

10G-20G

ç¨‹åºç›®å½•åˆ†åŒº(`/usr/share/nginx/html`)

10G

å¯é€‰, nginxç”¨ä½œweb serveræ—¶éœ€è¦ç”¨åˆ°æ­¤ç›®å½•.

#### 4.1.2 ç¨‹åºåŠä¾èµ–ç‰ˆæœ¬

ç¨‹åºç»„ä»¶

å®‰è£…åŒ…å

ç‰ˆæœ¬

md5

nginx

nginx-1.16.1-1.sles12.ngx.x86\_64.rpm

1.16.1

396A359F26DD0100CD59545BAFFAFE85

#### 4.1.3 NGINXç¨‹åºè§„èŒƒ

*   nginxç¨‹åºç›®å½•ï¼š `/etc/nginx`
*   æ‰§è¡Œç¨‹åºè·¯å¾„ï¼š `/usr/sbin/nginx`
*   ä¸»é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`/etc/nginx/conf/nginx.conf`
*   å„ä¸ªåº”ç”¨ç³»ç»Ÿè½¬å‘é…ç½®æ–‡ä»¶ç›®å½•ï¼š`/etc/nginx/conf.d/`
*   æ—¥å¿—ç›®å½•ï¼š`/var/log/nginx`
*   å„ä¸ªåº”ç”¨ç³»ç»Ÿé™æ€æ–‡ä»¶ç›®å½•ï¼š`/usr/share/nginx/html`

#### 4.1.4 ç³»ç»Ÿçº§åˆ«é…ç½®ä¼˜åŒ–

> â•Â æ³¨æ„:
> 
> éœ€è¦ `root` ç”¨æˆ·æ‰§è¡Œ.

1.  å®‰è£…ç»„ä»¶: `logrotate`
2.  ä¿®æ”¹è¿æ¥æ•°:

    vi /etc/security/limits.conf
    # viç¼–è¾‘
    *               soft    nofile          65535
    *               hard    nofile          65535
    

3.  ä¿®æ”¹ç³»ç»Ÿå†…æ ¸é…ç½®:

    vi /etc/sysctl.conf
    # viç¼–è¾‘
    
    # NGINX Tuning Performance
    fs.file-max = 65535
    
    vm.zone_reclaim_mode = 0
    
    net.core.somaxconn = 2048
    
    net.ipv4.tcp_tw_recycle = 0
    net.ipv4.tcp_timestamps = 1
    net.ipv4.tcp_slow_start_after_idle = 0
    net.ipv4.tcp_mtu_probing = 1
    
    # ç”Ÿæ•ˆ
    sysctl -p
    

#### 4.1.5 é…ç½®NGINX repo

> â• æ³¨æ„:
> 
> æœ¬èŠ‚å‘½ä»¤å¯ä»¥æ ¹æ®å…·ä½“æƒ…å†µ, åœ¨å…¬å¸å†…éƒ¨ repo ä»“åº“æœºå™¨ä¸Šè¿›è¡Œæ“ä½œ.
> 
> å…¶ä»–æœºå™¨åªéœ€è¦é…ç½®å†…éƒ¨ repo åœ°å€å³å¯.

é”®å…¥ä»¥ä¸‹ zypper å‘½ä»¤ä»¥æ·»åŠ  SLES çš„ zypper å­˜å‚¨åº“

    $ sudo zypper addrepo -G -t yum -c 'http://nginx.org/packages/sles/12' nginx
    

![Add Pre-Built SLES Packages Repo for Stable Nginx version](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081234963-27175439.jpg)

æ¥ä¸‹æ¥ï¼Œæ‚¨å¿…é¡»éªŒè¯æ•°å­—ç­¾åä»¥ä¿æŒä¸‹è½½åŒ…çš„å®Œæ•´æ€§å’Œæ¥æºã€‚ä½¿ç”¨wgetå‘½ä»¤è·å–nginxç­¾åå¯†é’¥ï¼š

    $ wget http://nginx.org/keys/nginx_signing.key
    

ç¤ºä¾‹è¾“å‡º:

    --2020-01-09 23:48:48--  http://nginx.org/keys/nginx_signing.key
    Resolving nginx.org (nginx.org)... 206.251.255.63, 95.211.80.227, 2001:1af8:4060:a004:21::e3, ...
    Connecting to nginx.org (nginx.org)|206.251.255.63|:80... connected.
    HTTP request sent, awaiting response... 200 OK
    Length: 1561 (1.5K) [text/plain]
    Saving to: â€˜nginx_signing.keyâ€™
     
    100%[==================================================>] 1,561       --.-K/s   in 0s      
     
    2020-01-09 23:48:49 (117 MB/s) - â€˜nginx_signing.keyâ€™ saved [1561/1561]
    

ä½¿ç”¨rpmå‘½ä»¤å°†å¯†é’¥å¯¼å…¥rpmï¼š

    $ sudo rpm --import nginx_signing.key
    

#### 4.1.6 SUSE ä¸Šå®‰è£…NGINX

é”®å…¥ä»¥ä¸‹ `zypper` å‘½ä»¤ï¼š

    $ sudo zypper install nginx=1.16.1
    

![How To Install Nginx on SUSE Linux using zypper command](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081235267-618403932.jpg)

#### 4.1.7 å¯é€‰: é…ç½®é˜²ç«å¢™

> â• æ³¨æ„:
> 
> å¦‚æœæœºæˆ¿æµé‡å…¥å£æœ‰å…¶ä»–ä¸“ç”¨é˜²ç«å¢™, åˆ™å¯ä»¥å…³é—­ nginx æœåŠ¡å™¨ä¸Šçš„é˜²ç«å¢™, ä¸”ä¸éœ€è¦æ‰§è¡Œæ­¤æ­¥éª¤.

é¦–å…ˆåˆ›å»ºNginxç‰¹å®šæœåŠ¡çš„é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨viå‘½ä»¤ç­‰æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ç«¯å£80:

    $ sudo vi /etc/sysconfig/SuSEfirewall2.d/services/nginx
    

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

    ## Name: Nginx web server
    ## Description: Open ports for Nginx Server
     
    # space separated list of allowed TCP ports
    TCP="http"
    

(å¦‚æœä¸éœ€è¦ HTTPS æ”¯æŒï¼Œåˆ™åªéœ€è¦å…è®¸ TCP ç«¯å£å· 80 ä¸Šçš„é€šä¿¡ã€‚)ä¿å­˜å¹¶é€€å‡º VI/VIM æ–‡æœ¬ç¼–è¾‘å™¨ã€‚ç°åœ¨ï¼Œåªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤æ‰“å¼€ç«¯å£80ï¼š

    $ sudo yast firewall
    

å¿…é¡»ä½¿ç”¨ _TAB_ å’Œç®­å¤´é”®åœ¨ YaST ä¸­è·³è½¬ã€‚åœ¨ YaST ä¸­ï¼Œè·³è½¬åˆ°å…è®¸çš„æœåŠ¡ï¼Œç„¶åæŒ‰ _Enter_ é”®ï¼š

![SLES Firewall Config for Nginx server](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081235528-1431071538.jpg)

ä½¿ç”¨ **TAB** è·³è½¬åˆ°â€œ_Allowed Services_â€ï¼Œç„¶åæŒ‰å‘ä¸‹ç®­å¤´é”®é€‰æ‹© _Nginx web server_ï¼Œç„¶åæŒ‰å›è½¦é”®ã€‚å¿…é¡»æŒ‰ _Alt-A_ æ¥å°†NginxæœåŠ¡å™¨æ·»åŠ åˆ°é˜²ç«å¢™ï¼š

![Adjust the SUSE Linux Firewall for Nginx](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081235942-829427093.jpg)

æŒ‰ _Alt-N_ å’Œ _Alt-F_ ä¿å­˜å¹¶å®Œæˆ SLES ä¸Šçš„é˜²ç«å¢™è®¾ç½®ã€‚è¿”å› shell æç¤ºç¬¦åï¼Œåˆ—å‡º sle ä¸Šçš„æ‰€æœ‰ iptables è§„åˆ™ï¼š

    $ sudo iptables -S
    

ç¤ºä¾‹è¾“å‡º:

    -A input_ext -p tcp -m limit --limit 3/min -m tcp --dport 80 --tcp-flags FIN,SYN,RST,ACK SYN -j LOG --log-prefix "SFW2-INext-ACC-TCP " --log-tcp-options --log-ip-options
    -A input_ext -p tcp -m tcp --dport 80 -j ACCEPT
    

ä½¿ç”¨ sudo å‘½ä»¤å’Œ grep å‘½ä»¤çš„ç»„åˆæ¥ç¡®å®šç«¯å£ 80 æ˜¯å¦æ‰“å¼€ï¼š

    sudo sh -c 'iptables -L -n -v | grep :80'
    

#### 4.1.8 å¯åŠ¨ NGINX Server

é”®å…¥ä»¥ä¸‹ `systemctl` å‘½ä»¤ä»¥åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯ç”¨ Nginxï¼š (å¼€æœºè‡ªå¯)

    $ sudo systemctl enable nginx
    

å¯åŠ¨ Nginx web æœåŠ¡å™¨ï¼š

    $ sudo systemctl start nginx
    

éªŒè¯:

    $ systemctl status nginx
    

![Turn On Check Nginx Web Server Service](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081236167-905513360.jpg)

è¦åˆ¤æ–­ 80 ç«¯å£æ˜¯å¦ç›‘å¬, è¿è¡Œä»¥ä¸‹ netstat å‘½ä»¤æˆ– ss å‘½ä»¤:

    $ sudo netstat -tulpn | grep :80
    $ sudo ss -tulpn | grep :80
    

![Is port 80 open on SLES](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081236359-1916314085.jpg)

#### 4.1.9 NGINX åŸºç¡€æ“ä½œ

åœæ­¢:

    $ sudo systemctl stop nginx
    

å¯åŠ¨:

    $ sudo systemctl start nginx
    

é‡æ–°å¯åŠ¨æœåŠ¡ï¼š

    $ sudo systemctl restart nginx
    

æ›´æ”¹é…ç½®åé‡æ–°åŠ è½½ Ngnixï¼š

    $ sudo systemctl reload nginx
    

> â„¹ï¸ å»ºè®®:
> 
> é…ç½®æ›´æ–°åä½¿ç”¨ `reload` æ¥é‡æ–°åŠ è½½nginx.

è®¿é—® nginx é¡µé¢:

å‡è®¾ NGINX IPä¸º: 192.168.0.1. ä½¿ç”¨æµè§ˆå™¨æˆ– `curl` è®¿é—®:

    http://serve_IP
    http://your-domain
    http://192.168.0.1
    

![img](https://img2023.cnblogs.com/other/3034537/202212/3034537-20221219081236587-944275235.jpg)

    $ curl -I 192.168.122.43
    

ç¤ºä¾‹è¾“å‡º:

    HTTP/1.1 200 OK
    Server: nginx/1.16.1
    Date: Sat, 03 Feb 2020 19:18:53 GMT
    Content-Type: text/html
    Content-Length: 612
    Last-Modified: Tue, 17 Oct 2019 13:30:50 GMT
    Connection: keep-alive
    ETag: "59e6060a-264"
    Accept-Ranges: bytes
    

#### 4.1.10 æŸ¥æ‰¾æœ‰å…³ SLES ä¸Š Nginx é…ç½®æ–‡ä»¶çš„ä¿¡æ¯

ç°åœ¨ Nginx å·²ç»å¯åŠ¨å¹¶è¿è¡Œäº†ã€‚æ¥ä¸‹æ¥å¯ä»¥å®šåˆ¶é…ç½®ã€‚

SLES çš„æœåŠ¡å™¨é…ç½®æ–‡ä»¶:

*   `/etc/nginx/`: nginx é»˜è®¤é…ç½®ç›®å½•
*   `/etc/nginx/nginx.conf`: nginx ä¸»é…ç½®æ–‡ä»¶
*   `/etc/nginx/conf.d/default.conf`: é»˜è®¤ virtual host çš„é…ç½®

ä¿®æ”¹ä¸»é…ç½®:

    $ sudo vi /etc/nginx/nginx.conf
    

#### 4.1.11 NGINX æ—¥å¿—

*   `/var/log/nginx/access.log`: è®¿é—®æ—¥å¿—
*   `/var/log/nginx/error.log`: é”™è¯¯æ—¥å¿—

#### 4.1.12 nginx.conf

ä¸»é…ç½®æ–‡ä»¶è¯¦ç»†è¯´æ˜å¦‚ä¸‹:

    #### å…¨å±€å— å¼€å§‹ #####
    # é…ç½®å…è®¸è¿è¡ŒNginxæœåŠ¡å™¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„
    #user  nginx nginx;
    # é…ç½®å…è®¸Nginxè¿›ç¨‹ç”Ÿæˆçš„worker processæ•°
    worker_processes  4;
    #worker_cpu_affinity 0001 0010 0100 1000;
    
    # é…ç½®NginxæœåŠ¡å™¨è¿è¡Œæ—¶çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶å­˜æ”¾è·¯å¾„å’Œåç§°
    #error_log  logs/error.log;
    error_log  logs/error.log  info;
    
    # é…ç½®NginxæœåŠ¡å™¨è¿è¡Œæ—¶çš„pidæ–‡ä»¶å­˜æ”¾è·¯å¾„å’Œåç§°
    pid        logs/nginx.pid;
    #### å…¨å±€å— ç»“æŸ #####
    
    
    #### eventså— å¼€å§‹ ####
    events {
        # é…ç½®äº‹ä»¶é©±åŠ¨æ¨¡å‹
        use epoll;
        accept_mutex off;
        multi_accept off;
        worker_connections  65535;	
    }
    #### eventså— ç»“æŸ ####
    
    
    #### httpå— å¼€å§‹ ####
    http {
        # å®šä¹‰MIME-Type
        include       mime.types;
        default_type  application/octet-stream;
    	
        # é…ç½®è¯·æ±‚å¤„ç†æ—¥å¿—çš„æ ¼å¼
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent $request_time $upstream_response_time "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for" "$host"';
    
        access_log  logs/access.log  main;
    
        # é…ç½®å…è®¸ä½¿ç”¨sendfileæ–¹å¼ä¼ è¾“
        sendfile        on;
        #tcp_nopush     on;
    	
        # é…ç½®è¿æ¥è¶…æ—¶æ—¶é—´
        #keepalive_timeout  0;
        keepalive_timeout  65;
    	
        # nginxå…è®¸çš„å®¢æˆ·ç«¯è¯·æ±‚å¤´éƒ¨çš„ç¼“å†²åŒºå¤§å°
        client_header_buffer_size 4k;
    
        # gzip conf
        gzip  on;
        gzip_min_length 1024;
        gzip_buffers 32 4k;
        gzip_http_version 1.1;
        gzip_comp_level 6;
        gzip_types text/plain application/xml image/x-icon image/svg+xml image/png text/css image/jpeg image/gif application/x-javascript application/javascript application/json;
        gzip_vary on;
        gzip_disable "MSIE [1-6]\.";
    	
        # security
        port_in_redirect off;
        server_tokens off;
    	
        # proxy buffer 
        proxy_buffers 8 4k;
        proxy_buffer_size 4k;
        proxy_temp_file_write_size 4k;
        proxy_temp_path proxy_temp;
    	
        # proxy cache
        # proxy_cache_path cache/ keys_zone=cache_all:10m;
    
    	
        #### serverå— å¼€å§‹ ####
        ## é…ç½®è™šæ‹Ÿä¸»æœºlocalhost
        server {
            listen       80 reuseport;
            server_name  localhost;
    
            #charset koi8-r;
    
            access_log  logs/host.access.log  main;
    
            location / {
               root   html;
                index  index.html index.htm;
            }
    
            error_page  404              /404.html;
    
            # redirect server error pages to the static page /50x.html
            #
            error_page   500 502 503 504  /50x.html;
            location = /50x.html {
                root   html;
            }
    
        }
    	#### server å— ç»“æŸ ####
    	
    
        # HTTPS server
        #
        #server {
        #    listen       443 ssl;
        #    server_name  localhost;
    
        #    ssl_certificate      cert.pem;
        #    ssl_certificate_key  cert.key;
    
        #    ssl_session_cache    shared:SSL:1m;
        #    ssl_session_timeout  5m;
    
        #    ssl_ciphers  HIGH:!aNULL:!MD5;
        #    ssl_prefer_server_ciphers  on;
    
        #    location / {
        #        root   html;
        #        index  index.html index.htm;
        #    }
        #}
    	
        # virtual hosts
        include conf.d/default.conf;
    
    }
    #### httpå— ç»“æŸ ####
    

> âœ”ï¸ å»ºè®®:
> 
> ä¸ºäº†ä¿è¯ä¸»é…ç½®æ–‡ä»¶çš„å¹²å‡€. å»ºè®®é€šè¿‡ `include conf.d/default.conf;` ç±»ä¼¼è¿™æ ·çš„æ–¹å¼æ¥å¼•å…¥å…¶ä»–virtual hostsé…ç½®.

#### 4.1.13 æ—¥å¿—è½¬å‚¨

1.  `sudo vi /etc/logrotate.d/nginx`
    
2.  ç¼–è¾‘å†…å®¹:
    
        /var/log/nginx/*.log {
            daily
            rotate 90  # ä¿ç•™90å¤©, æŒ‰éœ€è°ƒæ•´
            create
            dateext
            #compress  # æ˜¯å¦å¯ç”¨å‹ç¼©, æŒ‰éœ€è°ƒæ•´
            #minsize 1M
            #create 0644 nginx nginx  # nginxæ—¥å¿—æ‰€å±ç”¨æˆ·å’Œç»„, æŒ‰éœ€è°ƒæ•´
            # copytruncate   ç”¨äºè¿˜åœ¨æ‰“å¼€ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŠŠå½“å‰æ—¥å¿—å¤‡ä»½å¹¶æˆªæ–­ï¼›æ˜¯å…ˆæ‹·è´å†æ¸…ç©ºçš„æ–¹å¼ï¼Œæ‹·è´å’Œæ¸…ç©ºä¹‹é—´æœ‰ä¸€ä¸ªæ—¶é—´å·®ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ—¥å¿—æ•°æ®ã€‚
            # delaycompress å’Œcompress ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶åˆ°ä¸‹ä¸€æ¬¡è½¬å‚¨æ—¶æ‰å‹ç¼©
            missingok
            ifempty # default
            nomail
            #noolddir # default
            sharedscripts   # è¿è¡Œpostrotateè„šæœ¬ï¼Œä½œç”¨æ˜¯åœ¨æ‰€æœ‰æ—¥å¿—éƒ½è½®è½¬åç»Ÿä¸€æ‰§è¡Œä¸€æ¬¡è„šæœ¬ã€‚å¦‚æœæ²¡æœ‰é…ç½®è¿™ä¸ªï¼Œé‚£ä¹ˆæ¯ä¸ªæ—¥å¿—è½®è½¬åéƒ½ä¼šæ‰§è¡Œä¸€æ¬¡è„šæœ¬
            postrotate  # åœ¨logrotateè½¬å‚¨ä¹‹åéœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚é‡æ–°å¯åŠ¨ (kill -HUP) æŸä¸ªæœåŠ¡ï¼å¿…é¡»ç‹¬ç«‹æˆè¡Œ
                if [ -f /var/log/nginx/nginx.pid ]; then
                    kill -USR1 `cat /var/log/nginx/nginx.pid`
                fi
            endscript
        }
        
    
3.  å¼ºåˆ¶è¿è¡Œä¸€æ¬¡æ¥æµ‹è¯•:`logrotate -f -v /etc/logrotate.d/nginx`(å¯¹åº”ç›®å½•åªèƒ½ user æœ‰wæƒé™, å¦åˆ™ä¼šæŠ¥é”™)
    
4.  é…ç½®å¥½å³å¯, logrotate ä¼šè‡ªåŠ¨è¯»å–`/etc/logrotate.d`çš„é…ç½®å¹¶è‡ªåŠ¨æ‰§è¡Œ.
    

> ğŸ““ å¤‡æ³¨:
> 
> cron.daily ä¼šåœ¨ `3:22+(5,45)` è¿™ä¸ªæ—¶é—´æ®µæ‰§è¡Œ

### 4.2 NGINX + Keepalivedé…ç½®

> â„¹ï¸ å‡å®š:
> 
> å‡è®¾ç›¸å…³IPå¦‚ä¸‹:
> 
> 1.  VIP: **192.168.0.100**
> 2.  NGINX - ä¸»IP: **192.168.0.1**
> 3.  NGINX - ä»IP: **192.168.0.2**
> 4.  NGINX - ä¸»ä»çš„IPå¯¹åº”çš„ç½‘å¡ä¸º `eth0`

#### 4.2.1 Keepalived å®‰è£…é…ç½®

    $ sudo zypper install keepalived=2.0.10
    

#### 4.2.2 Keepalived é…ç½®

Keepalivedå¯åŠ¨é»˜è®¤è¯»å–é…ç½®æ–‡ä»¶è·¯å¾„ `/etc/keepalived/keepalived.conf` ,æ·»åŠ é…ç½®æ–‡ä»¶:

    sudo vi /etc/keepalived/keepalived.conf
    

**NGINX - ä¸»** æœºå™¨é…ç½®å¦‚ä¸‹:

    vrrp_script chk_nginx {
        script "/etc/keepalived/nginx_pid.sh" # æ£€æµ‹nginxçŠ¶æ€çš„è„šæœ¬è·¯å¾„
        interval 2
        weight -20 
        fall 3
    }
    vrrp_instance VI_1 {
        state MASTER # ä»æœºä¸º BACKUP
        interface eth0  # å…·ä½“çš„ç½‘å¡æ¥å£çœ‹æƒ…å†µè¿›è¡Œå¡«å†™
        virtual_router_id 51 
        priority 110 # å¤‡æœºæƒå€¼ä¸º100
        advert_int 1
        authentication {
        auth_type PASS
        auth_pass 123456
        }
        track_script {
            chk_nginx
        }
        virtual_ipaddress {
        192.168.0.100/24 brd 192.168.0.255 dev eth0 label eth0:vip  # æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹
        }
    }
    
    

é…ç½®è¯´æ˜å¦‚ä¸‹:

1.  `weight -20`: keepalived é…ç½®é‡Œ `priority 110` æ˜¯åˆå§‹æƒé‡ï¼›ä¸»çš„åˆå§‹è®¾ç½®äº† 110ï¼Œå¤‡çš„è®¾ç½®äº† 100ï¼›å¦‚æœæ£€æµ‹å¤±è´¥ï¼Œæƒé‡ -20. ä¸»ä»åˆ‡æ¢.
    
2.  `virtual_router_id 51` è‡ªå·±å®šä¹‰çš„è™šæ‹Ÿè·¯ç”±çš„idã€‚`vrrp_instance VI_1` å—ä¸­ `virtual_router_id` æŒ‡ä»¤çš„å€¼ 51 æ˜¯ä¸€ä¸ªç¤ºä¾‹å€¼;æ ¹æ®éœ€è¦æ”¹å˜å®ƒï¼Œä½¿å…¶åœ¨æ‚¨çš„ç¯å¢ƒä¸­ç‹¬ä¸€æ— äºŒã€‚
    
3.  æ·»åŠ 
    

**NGINX - ä»** æœºå™¨é…ç½®å¦‚ä¸‹:

    vrrp_script chk_nginx {
        script "/etc/keepalived/nginx_pid.sh" # æ£€æµ‹nginxçŠ¶æ€çš„è„šæœ¬è·¯å¾„
        interval 2
        weight -20
    }
    vrrp_instance VI_1 {
        state BACKUP # è¾…æœºä¸º BACKUP
        interface eth0  # å…·ä½“çš„ç½‘å¡æ¥å£çœ‹æƒ…å†µè¿›è¡Œå¡«å†™
        virtual_router_id 51
        priority 100 # å¤‡æœºæƒå€¼ä¸º100
        advert_int 1
        authentication {
        auth_type PASS
        auth_pass 123456
        }
        track_script {
            chk_nginx
        }
        virtual_ipaddress {
        192.168.0.100/24 brd 192.168.0.255 dev eth0 label eth0:vip  # æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œä¿®æ”¹
        }
    }
    
    

#### 4.2.3 é…ç½®æ£€æµ‹è„šæœ¬

> â• å¤‡æ³¨:
> 
> ä½¿ç”¨ `root` ç”¨æˆ·

é…ç½®æ£€æµ‹è„šæœ¬: `/etc/keepalived/nginx_pid.sh`

    #!/bin/bash
    A=`ps -C nginx --no-header|wc -l`
    if [ $A -eq 0 ]
    then
       systemctl start nginx
       exit 1
    else 
       exit 0
    fi
    

èµ‹äºˆæ‰§è¡Œæƒé™: `chmod 750 /etc/keepalived/nginx_pid.sh`

#### 4.2.4 å¯åŠ¨ Keepalived

é”®å…¥ä»¥ä¸‹ systemctl å‘½ä»¤ä»¥åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶å¯ç”¨ keepalivedï¼š (å¼€æœºè‡ªå¯)

    $ sudo systemctl enable keepalived
    

å¯åŠ¨ Nginx web æœåŠ¡å™¨ï¼š

    $ sudo systemctl start keepalived
    

éªŒè¯:

    $ systemctl status keepalived
    

#### 4.2.4 æ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€

è¦æŸ¥çœ‹å½“å‰å“ªä¸ªèŠ‚ç‚¹æ˜¯ç»™å®š VIP çš„ä¸»èŠ‚ç‚¹ï¼Œè¯·åœ¨å®šä¹‰ VRRP å®ä¾‹çš„æ¥å£ä¸Šè¿è¡Œå‘½ä»¤ `ip addr show`ï¼ˆåœ¨ä»¥ä¸‹å‘½ä»¤ä¸­ï¼Œ`eth0`èŠ‚ç‚¹`suse12-1`å’Œä¸Šçš„æ¥å£`suse12-2`ï¼‰ï¼š

    suse12-1 # ip addr show eth0
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state
         UP qlen 1000
        link/ether 52:54:00:33:a5:a5 brd ff:ff:ff:ff:ff:ff
        inet 192.168.0.1/24 brd 192.168.0.255 scope global dynamic eth0
           valid_lft 3071sec preferred_lft 3071sec
        inet 192.168.0.100/32 scope global eth0
           valid_lft forever preferred_lft forever
    
    suse12-2 # ip addr show eth0
    2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state
         UP qlen 1000
        link/ether 52:54:00:33:a5:87 brd ff:ff:ff:ff:ff:ff
        inet 192.168.0.2/24 brd 192.168.0.255 scope global eth0
           valid_lft forever preferred_lft forever
    

åœ¨æ­¤è¾“å‡ºä¸­ï¼Œç¬¬äºŒè¡Œ `inet` è¡¨ç¤º `suse12-1` æ˜¯ä¸»èŠ‚ç‚¹, å·²ä¸ºå…¶åˆ†é…äº†å·²å®šä¹‰çš„ VIP(`192.168.0.100`ï¼‰ã€‚`inet` è¾“å‡ºä¸­çš„å…¶ä»–è¡Œæ˜¾ç¤ºä¸»èŠ‚ç‚¹çš„å®é™…IPåœ°å€ï¼ˆ`192.168.0.1`ï¼‰å’Œå¤‡ç”¨(æˆ– ä»)èŠ‚ç‚¹çš„IPåœ°å€ï¼ˆ`192.168.0.2`ï¼‰ã€‚

è‡³æ­¤, nginx + keepalived çš„**è´Ÿè½½å‡è¡¡å±‚é«˜å¯ç”¨**å·²ç»é…ç½®å®Œæˆ.

### 4.3 NGINX -> åº”ç”¨æœåŠ¡å±‚ è½¬å‘é…ç½®

> â„¹ï¸ å‡å®š:
> 
> å‡è®¾åº”ç”¨ç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯å¦‚ä¸‹:
> 
> 1.  è¯·æ±‚åŠä¸šåŠ¡åè®®ä¸ºHTTPåè®®;
> 2.  åº”ç”¨ç³»ç»ŸèŠ‚ç‚¹1 IPä¸º: 172.30.0.1
> 3.  åº”ç”¨ç³»ç»ŸèŠ‚ç‚¹2 IPä¸º: 172.30.0.2
> 4.  ä¸šåŠ¡ç³»ç»Ÿç›‘å¬ç«¯å£ä¸º: 8080

#### 4.3.1 ä¿®æ”¹é…ç½®æ–‡ä»¶

ä»¥ mes ç³»ç»Ÿé«˜å¯ç”¨é…ç½®ä¸ºä¾‹(åè®®ä¸º HTTP åè®®), æ–°å¢ `/etc/nginx/conf.d/mes.conf`:

    # mes access
    
    upstream mes{
       # ip_hash;  # æºåœ°å€ä¼šè¯ä¿æŒ, æŒ‰éœ€å¼€å¯
       server 172.30.0.1:8080;
       server 172.30.0.2:8080;
    }
    
    server {
        listen       80;
        #server_name  mes.example.com 192.168.0.100;  # server_nameä¸ºå¯¹åº”çš„è®¿é—®åŸŸå, æŒ‰éœ€å¼€å¯
    
        #set max uploading file size to 20m
        client_max_body_size 20m;
    
        #charset koi8-r;
    	
        # keepalive
        # è®¾ç½®ä»£ç†çš„HTTPåè®®ç‰ˆæœ¬ï¼ˆé»˜è®¤æ˜¯1.0ç‰ˆæœ¬ï¼‰
        proxy_http_version 1.1;    # æŒ‰éœ€è°ƒæ•´
        # å…è®¸é‡æ–°å®šä¹‰æˆ–è¿½åŠ å­—æ®µåˆ°ä¼ é€’ç»™ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚å¤´ä¿¡æ¯ï¼ˆé»˜è®¤æ˜¯closeï¼‰
        proxy_set_header Connection "";
    	
        proxy_set_header HOST $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
    	
        access_log  logs/mes_access.log main buffer=16k flush=5m;
        error_log logs/mes_error.log;
        location / {
            #root   html;
            #index  index.html index.htm;
           	proxy_pass http://mes;
            #proxy_redirect off;
            # proxy_cache cache_all;
        }
    
        #error_page  404              /404.html;
    
        # redirect server error pages to the static page /50x.html
        #
        #error_page   500 502 503 504  /50x.html;
        #location = /50x.html {
        #    root   html;
        #}
    }
    

#### 4.3.2 ä¸»é…ç½®æ–‡ä»¶ include

åœ¨ http å—æ–°å¢å¦‚ä¸‹å†…å®¹

    include conf.d/mes.conf;
    

#### 4.3.2 é‡æ–°åŠ è½½ nginx

æ›´æ”¹é…ç½®åé‡æ–°åŠ è½½Ngnixä½¿é…ç½®ç”Ÿæ•ˆï¼š

`sudo systemctl reload nginx`

#### 4.3.3 éªŒè¯

é€šè¿‡ VIP è¿›è¡Œè®¿é—®, æŸ¥çœ‹å¯¹åº”åº”ç”¨ç³»ç»Ÿæ—¥å¿—, è§‚å¯Ÿæ˜¯å¦ 2 ä¸ªèŠ‚ç‚¹éƒ½æ¥æ”¶åˆ°è¯·æ±‚.

äº” å˜æ›´æ§åˆ¶æµç¨‹
--------

â— ä¸¥æ ¼éµå¾ª åˆ¶é€ ä¸šæœ¬å…¬å¸çš„å˜æ›´æ§åˆ¶è§„èŒƒ. è¿›è¡Œç›¸å…³çš„å˜æ›´æ§åˆ¶å’Œå®¡æ‰¹æµç¨‹.

ä¸€ä¸ªæ–°çš„åº”ç”¨éœ€è¦ä¸Šçº¿æˆ–è€…å˜æ›´ï¼Œé€šå¸¸æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š

å¯ä»¥éšæ—¶å®æ–½çš„å˜æ›´:

1.  ç³»ç»Ÿé¡¹ç›®ç»„éœ€è‡³å°‘æä¾›ç«¯å£ã€è·¯å¾„ã€åç«¯åœ°å€(åŸŸåå¯é€‰);
2.  åœ¨ `/etc/nginx/conf.d` ä¸­å¢åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶;
3.  åœ¨ `/etc/nginx/nginx.conf` ä¸­å¢åŠ ä¸€ä¸ª `include`ï¼ŒæŒ‡å‘æ–°å¢çš„é…ç½®æ–‡ä»¶;

â— éœ€è¦åœ¨å˜æ›´çª—å£è¿›è¡Œçš„å˜æ›´:

1.  é‡æ–°è½½å…¥(`sudo systemctl reload nginx`)é…ç½®.
2.  é€šçŸ¥ç”¨æˆ·, è®¿é—®çš„ Server IP ç”±: åŸåº”ç”¨æœåŠ¡å™¨ IP è°ƒæ•´ä¸º NGINX çš„ VIP.
3.  ä¿®æ”¹å®¢æˆ·ç«¯å’Œæµè§ˆå™¨é…ç½®, è®¿é—®çš„ Server IP ç”±: åŸåº”ç”¨æœåŠ¡å™¨ IP è°ƒæ•´ä¸º NGINX çš„ VIP.
4.  éªŒè¯å˜æ›´æ˜¯å¦æˆåŠŸ.

### 5.1 å›é€€æ­¥éª¤

å›é€€è¾ƒä¸ºç®€å•, æ­¥éª¤å¦‚ä¸‹:

1.  é€šçŸ¥ç”¨æˆ·, è®¿é—®çš„ Server IP è°ƒæ•´ä¸º: åŸåº”ç”¨æœåŠ¡å™¨ IP.
2.  ä¿®æ”¹å®¢æˆ·ç«¯å’Œæµè§ˆå™¨é…ç½®, è®¿é—®çš„ Server IP è°ƒæ•´ä¸º: åŸåº”ç”¨æœåŠ¡å™¨ IP.
3.  å›é€€å®Œæˆ
4.  éªŒè¯å›é€€æ˜¯å¦æˆåŠŸ.

å‚è€ƒæ–‡ä»¶
----

å‚è€ƒæ–‡ä»¶

[High Availability Support for NGINX](https://docs.nginx.com/nginx/admin-guide/high-availability/ha-keepalived/)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.