---
layout: post
title: "x64 ç•ªå¤–ç¯‡â€”â€”çŸ¥è¯†é“ºå«"
date: "2022-03-30T10:19:58.736Z"
---
x64 ç•ªå¤–ç¯‡â€”â€”çŸ¥è¯†é“ºå«
=============

x64 ç•ªå¤–ç¯‡ä¹‹çŸ¥è¯†é“ºå«ï¼Œä»‹ç»å…¥é—¨64ä½ Win å†…æ ¸çš„çŸ¥è¯†é“ºå«ã€‚

å†™åœ¨å‰é¢
----

â€ƒâ€ƒæ­¤ç³»åˆ—æ˜¯æœ¬äººä¸€ä¸ªå­—ä¸€ä¸ªå­—ç å‡ºæ¥çš„ï¼ŒåŒ…æ‹¬ç¤ºä¾‹å’Œå®éªŒæˆªå›¾ã€‚**ç”±äºç³»ç»Ÿå†…æ ¸çš„å¤æ‚æ€§ï¼Œæ•…å¯èƒ½æœ‰é”™è¯¯æˆ–è€…ä¸å…¨é¢çš„åœ°æ–¹ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æ‰¹è¯„æŒ‡æ­£ï¼Œæœ¬æ•™ç¨‹å°†ä¼šé•¿æœŸæ›´æ–°ã€‚** å¦‚æœ‰å¥½çš„å»ºè®®ï¼Œæ¬¢è¿åé¦ˆã€‚ç å­—ä¸æ˜“ï¼Œå¦‚æœæœ¬ç¯‡æ–‡ç« æœ‰å¸®åŠ©ä½ çš„ï¼Œå¦‚æœ‰é—²é’±ï¼Œå¯ä»¥æ‰“èµæ”¯æŒæˆ‘çš„åˆ›ä½œã€‚å¦‚æƒ³è½¬è½½ï¼Œè¯·æŠŠæˆ‘çš„è½¬è½½ä¿¡æ¯é™„åœ¨æ–‡ç« åé¢ï¼Œå¹¶å£°æ˜æˆ‘çš„ä¸ªäººä¿¡æ¯å’Œæœ¬äººåšå®¢åœ°å€å³å¯ï¼Œä½†**å¿…é¡»äº‹å…ˆé€šçŸ¥æˆ‘**ã€‚

> ä½ å¦‚æœæ˜¯ä»ä¸­é—´æ’è¿‡æ¥çœ‹çš„ï¼Œè¯·ä»”ç»†é˜…è¯» **[ç¾½å¤çœ‹Winç³»ç»Ÿå†…æ ¸â€”â€”ç®€è¿°](https://www.cnblogs.com/wingsummer/p/15303519.html)** ï¼Œæ–¹ä¾¿å­¦ä¹ æœ¬æ•™ç¨‹ã€‚

â€ƒâ€ƒçœ‹æ­¤æ•™ç¨‹ä¹‹å‰ï¼Œé—®å‡ ä¸ªé—®é¢˜ï¼Œ**åŸºç¡€çŸ¥è¯†å‚¨å¤‡å¥½äº†å—ï¼Ÿä¿æŠ¤æ¨¡å¼ç¯‡å­¦ä¼šäº†å—ï¼Ÿç»ƒä¹ åšå®Œäº†å—ï¼Ÿæ²¡æœ‰çš„è¯å°±ä¸è¦ç»§ç»­äº†ã€‚**

* * *

ğŸ”’ åä¸½çš„åˆ†å‰²çº¿ ğŸ”’

* * *

ç®€è¿°
--

â€ƒâ€ƒåˆå…¥64ä½çš„å†…æ ¸ä¸–ç•Œï¼Œ64ä½çš„æ±‡ç¼–è‚¯å®šæ˜¯åŸºç¡€ã€‚åœ¨64ä½çš„`Win`æ“ä½œç³»ç»Ÿï¼Œè°ƒç”¨çº¦å®šå¹¶ä¸æ˜¯åŸæ¥çš„å¤šç§å¤šæ ·ï¼Œè€Œæ˜¯åªæœ‰ä¸€ç§è°ƒç”¨çº¦å®š`FastCall`ã€‚å¹¶ä¸”åœ¨64ä½ä¸‹ï¼Œæ“ä½œç³»ç»Ÿä»¥åŠåº”ç”¨ç¨‹åºååˆ†æ³¨é‡å¯¹é½ï¼ˆåœ°å€æ•°å€¼å¯ä»¥è¢«16æ•´é™¤ï¼‰å’Œæ ˆå¸§è¿™ä¸ªäº‹æƒ…ï¼Œå¹¶ä¸”`SEH`çš„å®ç°ä¹Ÿä¸å†åŸºäºå †æ ˆï¼Œè¿™ä¸€åˆ‡å°†åœ¨æœ¬ç¯‡æˆ‘ä¼šè¯¦ç»†ä»‹ç»ã€‚  
â€ƒâ€ƒæœ¬éƒ¨åˆ†è®¨è®ºçš„`x64`æ˜¯`AMD64`ä¸`Intel64`çš„åˆç§°ï¼Œæ˜¯æŒ‡ä¸ç°æœ‰`x86`å…¼å®¹çš„64ä½`CPU`ã€‚åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œå†…å­˜åœ°å€ä¸º64ä½ã€‚64ä½ç¯å¢ƒä¸‹å¯„å­˜å™¨æœ‰æ¯”è¾ƒå¤§çš„å˜åŒ–ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220328210555507-161849470.png)

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220328210903936-1010243800.png)

â€ƒâ€ƒåœ¨ä»‹ç»æœ¬èŠ‚ä¸œè¥¿ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆå­¦ä¹ åœ¨64ä½ä¸‹çš„ä»…æœ‰`FastCall`è°ƒç”¨çº¦å®šï¼Œå®è¡Œå¤–å¹³æ ˆï¼š

å‚æ•°

ç±»å‹

æµ®ç‚¹ç±»å‹

ç¬¬1ä¸ªå‚æ•°

RCX

XMM0

ç¬¬2ä¸ªå‚æ•°

RDX

XMMI

ç¬¬3ä¸ªå‚æ•°

R8

XMM2

ç¬¬4ä¸ªå‚æ•°

R9

XMM3

â€ƒâ€ƒäº†è§£è¿™äº›ä¸œè¥¿ä¹‹åï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å¯¹64ä½çš„æ±‡ç¼–è¿›è¡Œé“ºå«ã€‚

æ±‡ç¼–é“ºå«
----

â€ƒâ€ƒå½“æˆ‘ä»¬åˆæ­¥è¸å…¥64ä½æ±‡ç¼–çš„ä¸–ç•Œæ—¶ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹æˆ‘ä»¬å…¥é—¨ **[ç¾½å¤çœ‹Cè¯­è¨€](https://www.cnblogs.com/wingsummer/category/2027360.html)** ç³»åˆ—æ•™ç¨‹çš„æ—¶å€™ä¼šæä¾›ä¸€ä¸ªæœ€ç®€å•çš„ç¤ºä¾‹æ¥ä»æ±‡ç¼–è§’åº¦æ¥çœ‹`C/C++`ï¼Œç°åœ¨æˆ‘ä»¬é‡æ–°ç”¨64ä½æ¥çœ‹çœ‹å®ƒä»¬ç°åœ¨çš„æ ·å­ï¼Œå¦‚ä¸‹æ˜¯ç¤ºä¾‹ä»£ç ï¼š

    #include <iostream>
    
    using namespace std;
    
    int main()
    {
        int a = 1;
        cout << a << endl;
        return 0;
    }
    

â€ƒâ€ƒå®ƒçš„åæ±‡ç¼–å¦‚ä¸‹æ‰€ç¤ºï¼š

    #include <iostream>
    
    using namespace std;
    
    int main()
    {
    00007FF628591860  push        rbp  
    00007FF628591862  push        rdi  
    00007FF628591863  sub         rsp,108h  
    00007FF62859186A  lea         rbp,[rsp+20h]  
        int a = 1;
    00007FF62859186F  mov         dword ptr [a],1  
        cout << a << endl;
    00007FF628591876  mov         edx,dword ptr [a]  
    00007FF628591879  mov         rcx,qword ptr [__imp_std::cout (07FF6285A0170h)]  
    00007FF628591880  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF6285A0158h)]  
    00007FF628591886  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF628591037h)]  
    00007FF62859188D  mov         rcx,rax  
    00007FF628591890  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF6285A0150h)]  
        return 0;
    00007FF628591896  xor         eax,eax  
    }
    00007FF628591898  lea         rsp,[rbp+0E8h]  
    00007FF62859189F  pop         rdi  
    00007FF6285918A0  pop         rbp  
    00007FF6285918A1  ret  
    

â€ƒâ€ƒå¯ä»¥çœ‹å‡ºï¼Œæ±‡ç¼–ä¼¼ä¹æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ï¼Œä¾æ—§é‡‡ç”¨`rbp`å¯»å€ï¼Œä½†æ˜¯è¿™ä¸ªå¯»å€çœ‹èµ·æ¥æ¯”è¾ƒå¥‡æ€ªï¼Œä¸‹é¢æˆ‘æ¥é€æ­¥ä»‹ç»è¿™äº›å¥‡æ€ªä¹‹å¤„ã€‚  
â€ƒâ€ƒ`lea rbp,[rsp+20h]`è¿™å¥æ±‡ç¼–ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒå¥‡æ€ªï¼Œå…¶å®è¿™é‡Œæ˜¯é¢„ç•™ç»™å‚æ•°ä¼ é€’çš„ç©ºé—´ï¼Œæ­£å¥½æ˜¯4ä¸ªå‚æ•°çš„ç©ºé—´ï¼Œåœ¨å‚æ•°ä¸å¤šäº4ä¸ªçš„æ—¶å€™ä¼šé‡‡ç”¨ï¼Œä¸€å…±32ä¸ªå­—èŠ‚ã€‚ç¨åæˆ‘ä»¬ä¼šå¯¹æ­¤è¿›è¡Œå±•å¼€ã€‚  
â€ƒâ€ƒè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥‡æ€ªçš„ç‚¹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    00007FF628591863  sub         rsp,108h  
    00007FF62859186A  lea         rbp,[rsp+20h]  
    
    â€¦â€¦
    
    00007FF628591898  lea         rsp,[rbp+0E8h]  
    

â€ƒâ€ƒçœ‹åˆ°åœ¨æ¢å¤å †æ ˆçš„æ—¶å€™è¿™ä¸¤ä¸ªæ•°å€¼ä¸å¤ªä¸€æ ·äº†å—ï¼Ÿè¿™å°±æ˜¯ä¸­é—´è°ƒç”¨ä¸€äº›å‡½æ•°è¿›è¡Œå†…å¹³æ ˆçš„ç»“æœï¼Œæˆ‘ä»¬å‡½æ•°å°±å†™ä¸€ä¸ª`return 0;`çœ‹çœ‹å®ƒçš„åæ±‡ç¼–ç»“æœï¼š

    int main()
    {
    00007FF704AB1830  push        rbp  
    00007FF704AB1832  push        rdi  
    00007FF704AB1833  sub         rsp,0C8h  
    00007FF704AB183A  mov         rbp,rsp  
    
        return 0;
    00007FF704AB183D  xor         eax,eax  
    }
    00007FF704AB183F  lea         rsp,[rbp+0C8h]  
    00007FF704AB1846  pop         rdi  
    00007FF704AB1847  pop         rbp  
    00007FF704AB1848  ret  
    

â€ƒâ€ƒè¿™æ—¶å€™æå‡çš„å †æ ˆå’Œæ¢å¤çš„å †æ ˆå°±æ˜¯ä¸€æ¨¡ä¸€æ ·äº†ã€‚  
â€ƒâ€ƒä¸‹é¢æˆ‘ä»¬ç»§ç»­æ¥è¯¦ç»†ä»‹ç»æœ‰å…³å‚æ•°è°ƒç”¨çš„ç»†èŠ‚ï¼Œå½“æˆ‘ä»¬ä¼ å‚ä¸å¤šäº4ä¸ªçš„æ—¶å€™ï¼Œå®ƒæ˜¯æ€æ ·ä¼ å‚çš„ï¼Œå¦‚ä¸‹æ˜¯æµ‹è¯•ä»£ç ï¼š

    #include <iostream>
    
    using namespace std;
    
    int add(int a, int b, int c, int d)
    {
        return a + b + c + d;
    }
    
    int main()
    {
        int a = 3, b = 4, c = 5, d = 6;
        int e = add(a, b, c, d);
        return 0;
    }  
    

â€ƒâ€ƒå…ˆçœ‹`add`å‡½æ•°çš„åæ±‡ç¼–ï¼š

    int add(int a, int b, int c, int d)
    {
    00007FF633681830  mov         dword ptr [rsp+20h],r9d  
    00007FF633681835  mov         dword ptr [rsp+18h],r8d  
    00007FF63368183A  mov         dword ptr [rsp+10h],edx  
    00007FF63368183E  mov         dword ptr [rsp+8],ecx  
    00007FF633681842  push        rbp  
    00007FF633681843  push        rdi  
    00007FF633681844  sub         rsp,0C8h  
    00007FF63368184B  mov         rbp,rsp  
        return a + b + c + d;
    00007FF63368184E  mov         eax,dword ptr [b]  
    00007FF633681854  mov         ecx,dword ptr [a]  
    00007FF63368185A  add         ecx,eax  
    00007FF63368185C  mov         eax,ecx  
    00007FF63368185E  add         eax,dword ptr [c]  
    00007FF633681864  add         eax,dword ptr [d]  
    }
    00007FF63368186A  lea         rsp,[rbp+0C8h]  
    00007FF633681871  pop         rdi  
    00007FF633681872  pop         rbp  
    00007FF633681873  ret  
    

â€ƒâ€ƒå¯¹äºå¼€å¤´çš„æ±‡ç¼–ä»£ç ï¼Œå¯èƒ½æœ‰ç‚¹éš¾ç†è§£ï¼š

    mov dword ptr [rsp+20h],r9d
    mov dword ptr [rsp+18h],r8d
    mov dword ptr [rsp+10h],edx
    mov dword ptr [rsp+8],ecx  
    

â€ƒâ€ƒå¦‚ä¸Šå‚æ•°å°±æ˜¯å­˜å‚¨åœ¨æ‰€è°“çš„é¢„ç•™ç©ºé—´ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329100700976-1121336376.png)

â€ƒâ€ƒè¿™é¢„ç•™çš„æ ˆç©ºé—´æ˜¯åœ¨ä¸»å‡½æ•°å†…å®Œæˆçš„ï¼Œè¿™ä¸ªæš‚ä¸”å…ˆä¸å…³æ³¨ã€‚åé¢çš„ä»£ç ç´§æ¥ç€æ˜¯ç»å…¸çš„`rbp`å¯»å€ï¼Œä½†æ˜¯çœ¼å°–çš„åŒå¿—å¯èƒ½ä¼šå‘ç°ï¼Œåé¢çš„è¿ç®—éƒ½æ˜¯ç”¨32ä½å¯„å­˜å™¨ï¼Œæ²¡æœ‰ç”¨64ä½çš„ã€‚  
â€ƒâ€ƒè¿™é‡Œæˆ‘å•°å—¦ä¸€ä¸‹ï¼Œ64ä½å¯„å­˜å™¨æ˜¯å¯¹32ä½çš„æ‰©å±•ï¼Œä½†æ˜¯æœ‰äº›æ±‡ç¼–æŒ‡ä»¤32ä½æœ‰ä½†æ˜¯64ä½æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥æ¢ç©¶è¿™ä¸ªäº‹æƒ…ã€‚  
â€ƒâ€ƒå¯¹32ä½å¯„å­˜å™¨çš„å†™æ“ä½œï¼ŒåŒ…æ‹¬è¿ç®—ç»“æœï¼Œå¯¹ç›¸åº”çš„64ä½å¯„å­˜å™¨çš„é«˜32ä½æ¸…0ã€‚è¿™ä¸ªæ˜¯64ä½ä¸åŒäº32ä½çš„æ“ä½œï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªåŠ¨å›¾æ¥å±•ç¤ºä¸€ä¸‹è¯¥æ•ˆæœï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329101824023-841500291.gif)

â€ƒâ€ƒç”±äº32ä½æŒ‡ä»¤ç¼–ç æ¯”å¯¹åº”çš„64ä½æŒ‡ä»¤ç¼–ç æŒ‡ä»¤è¦çŸ­ï¼Œä¸ºäº†ä¼˜åŒ–å°±ä¼šä½¿ç”¨è¾ƒçŸ­çš„32ä½æŒ‡ä»¤ç¼–ç ã€‚æ¯”å¦‚`xor rax,rax`è¿™æ¡æŒ‡ä»¤ï¼Œå®ƒçš„ç¡¬ç¼–ç ä¸º`48 33 C0`ï¼Œè€Œ`xor eax,eax`å¯ä»¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œå®ƒçš„ç¡¬ç¼–ç ä¸º`33 C0`ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šä¼˜å…ˆä½¿ç”¨`xor eax,eax`ã€‚  
â€ƒâ€ƒæœ‰äº›32ä½çš„æ±‡ç¼–æŒ‡ä»¤å¯¹åº”64ä½æ˜¯æ²¡æœ‰çš„ï¼Œæ¯”å¦‚`push`ï¼Œåœ¨64ä½æ˜¯æ²¡æœ‰çš„ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329102848053-1770121130.png)

â€ƒâ€ƒå†…å­˜ä¼˜å…ˆä½¿ç”¨ç›¸å¯¹åç§»å¯»å€ï¼Œç›´æ¥å¯»å€æŒ‡ä»¤è¾ƒå°‘ã€‚è¿™ä¸ªæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329103157935-149290067.png)

â€ƒâ€ƒå¯ä»¥çœ‹åˆ°ç¡¬ç¼–ç çš„ç»“æœäº†å—ï¼Ÿæ¥çš„å†…å®¹æ˜¯0ï¼Œä½†æ˜¯æŒ‡çš„æ˜¯ä¸‹ä¸€è¡Œåœ°å€ï¼Œå’Œ32ä½ä¸‹çš„`jmp`çš„ç¡¬ç¼–ç æ–¹å¼æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯å¦‚æœé—´æ¥å¯»å€çš„èŒƒå›´æ— æ³•è¡¨ç¤ºäº†ï¼Œå°±å†™æ­»åœ°å€ï¼Œç±»ä¼¼ä¸‹é¢çš„ç»“æœï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329103443944-2006632732.png)

â€ƒâ€ƒå½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†é—´æ¥å¯»å€çš„æ”¹ä¸ºç›´æ¥å¯»å€çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329103821002-1525114877.png)

â€ƒâ€ƒè¿™é‡Œå†æ‰©å±•æ¯”è¾ƒæœ‰æ„æ€çš„`nop`æŒ‡ä»¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéœ€è¦ç¡¬ç¼–ç è¿›è¡Œè¾“å…¥ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220329105611416-1675068441.png)

â€ƒâ€ƒæœ‰å…³64ä½çš„æ±‡ç¼–å°±ä»‹ç»è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬ä¼šè¿‡æ¥å†çœ‹çœ‹`add`å‡½æ•°çš„ä¼ å‚æƒ…å†µã€‚åé¢éƒ½æ˜¯æˆ‘ä»¬å­¦è¿‡32ä½çš„`ebp`å¯»å€éƒ½èƒ½çœ‹æ‡‚çš„ä»£ç äº†ï¼Œæ¥ä¸‹æ¥çœ‹ä¸»å‡½æ•°çš„åæ±‡ç¼–ï¼š

    int main()
    {
    00007FF6336817A0  push        rbp  
    00007FF6336817A2  push        rdi  
    00007FF6336817A3  sub         rsp,188h  
    00007FF6336817AA  lea         rbp,[rsp+20h]  
        int a = 3, b = 4, c = 5, d = 6;
    00007FF6336817AF  mov         dword ptr [rbp+4],3  
    00007FF6336817B6  mov         dword ptr [rbp+24h],4  
    00007FF6336817BD  mov         dword ptr [rbp+44h],5  
    00007FF6336817C4  mov         dword ptr [rbp+64h],6  
        int e = add(a, b, c, d);
    00007FF6336817CB  mov         r9d,dword ptr [rbp+64h]  
    00007FF6336817CF  mov         r8d,dword ptr [rbp+44h]  
    00007FF6336817D3  mov         edx,dword ptr [rbp+24h]  
    00007FF6336817D6  mov         ecx,dword ptr [rbp+4]  
    00007FF6336817D9  call        00007FF6336813C5  
    00007FF6336817DE  mov         dword ptr [rbp+0000000000000084h],eax  
        return 0;
    00007FF6336817E4  xor         eax,eax  
    }
    00007FF6336817E6  lea         rsp,[rbp+0000000000000168h]  
    00007FF6336817ED  pop         rdi  
    00007FF6336817EE  pop         rbp  
    00007FF6336817EF  ret  
    

â€ƒâ€ƒå¼€å¤´æˆ‘è®²äº†ï¼Œåé¢åˆæ¥äº†å¥‡æ€ªçš„å±€éƒ¨å˜é‡åˆ†é…å’Œåˆå§‹åŒ–ï¼š

    mov dword ptr [rbp+4],3  
    mov dword ptr [rbp+24h],4
    mov dword ptr [rbp+44h],5
    mov dword ptr [rbp+64h],6
    

â€ƒâ€ƒå¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªå±€éƒ¨å˜é‡ä¹‹é—´å·®äº†`0x20`ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯32ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç›®å‰æš‚æ—¶æä¸æ¸…æ¥šä¸ºä»€ä¹ˆï¼Œå¯èƒ½æœ‰å¯¹é½çš„æ„å‘³åœ¨è¿™é‡Œã€‚  
â€ƒâ€ƒä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹`IDA`æ˜¯å¦‚ä½•åˆ†æè¿™éƒ¨åˆ†ä»£ç çš„ï¼š

    ; int __fastcall main()
    main proc near
    
    a= dword ptr -16Ch
    b= dword ptr -14Ch
    c= dword ptr -12Ch
    d= dword ptr -10Ch
    
    push    rbp
    push    rdi
    sub     rsp, 188h
    lea     rbp, [rsp+20h]
    mov     [rbp+170h+a], 3
    mov     [rbp+170h+b], 4
    mov     [rbp+170h+c], 5
    mov     [rbp+170h+d], 6
    mov     r9d, [rbp+170h+d] ; d
    mov     r8d, [rbp+170h+c] ; c
    mov     edx, [rbp+170h+b] ; b
    mov     ecx, [rbp+170h+a] ; a
    call    j_?add@@YAHHHHH@Z ; add(int,int,int,int)
    mov     [rbp+84h], eax
    xor     eax, eax
    lea     rsp, [rbp+168h]
    pop     rdi
    pop     rbp
    retn
    main endp
    

â€ƒâ€ƒæˆ‘ä»¬ç»§ç»­ä»‹ç»`FastCall`è°ƒç”¨çº¦å®šï¼š`push`å’Œ`pop`æŒ‡ä»¤ä»…ç”¨æ¥ä¿å­˜éæ˜“å˜å¯„å­˜å™¨ï¼Œå…¶ä»–æ ˆæŒ‡é’ˆæ“ä½œæ˜¾å¼å†™å¯„å­˜å™¨`rsp`ã€‚å®ç°è¿›å…¥`call`ä¹‹å‰`rsp`æ»¡è¶³`0Ã—10`å­—èŠ‚å¯¹é½ã€‚  
é€šå¸¸ä¸ä½¿ç”¨`rbp`å¯»å€æ ˆå†…å­˜ï¼Œæ‰€ä»¥`rsp`åœ¨å‡½æ•°å¸§ä¸­å°½é‡ä¿æŒç¨³å®šï¼Œä¸€æ¬¡æ€§åˆ†é…å±€éƒ¨å˜é‡å’Œå‚æ•°ç©ºé—´ä½†æ˜¯ã€‚åœ¨å’±çš„å®ä¾‹ä¸­ï¼Œç”¨åˆ°äº†`rbp`å¯»å€ï¼Œä½†åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­`rsp`ä¿æŒæ¯”è¾ƒç¨³å®šçš„çŠ¶æ€ã€‚  
â€ƒâ€ƒä¸Šé¢çš„ä»‹ç»ä»…ä»…æ˜¯å†°å±±ä¸€è§’ï¼Œè®©ä½ å¯¹64ä½çš„æ±‡ç¼–æŒ‡ä»¤å’Œè°ƒç”¨çº¦å®šæœ‰ä¸€ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œå…·ä½“ç»†èŠ‚è¯·è‡ªè¡Œæ¢ç´¢ã€‚

SEH
---

### æ¦‚è¿°

â€ƒâ€ƒä¹‹å‰æˆ‘ä»¬åœ¨32ä½ä»‹ç»`SEH`çš„æ—¶å€™ï¼Œå®ƒæ˜¯ç”¨æ ˆå®ç°çš„ï¼Œä½†æ˜¯å¦‚æœé»‘å®¢åˆ©ç”¨æ„é€ ç‰¹æ®Šçš„ä»£ç å¯¹æ ˆè¿›è¡Œæ”»å‡»å¯¼è‡´ä»£ç åŠ«æŒï¼Œè¿™æ˜¯ååˆ†ä¸å®‰å…¨çš„ã€‚æ‰€ä»¥ï¼Œåœ¨64ä½ä¸‹ï¼Œ`SEH`ä¸ä½¿ç”¨æ ˆæ¥å®ç°ã€‚å¯¹äº64ä½æ¥è¯´ï¼Œå‡½æ•°æœ‰æ²¡æœ‰å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒå¹¶æ²¡æœ‰ç±»ä¼¼32ä½æŒ‚`SEH`çš„æ“ä½œã€‚æˆ‘ä»¬é€šè¿‡ä»£ç ç¤ºä¾‹çœ‹ä¸€ä¸‹ï¼š

    #include <iostream>
    
    using namespace std;
    
    int filter()
    {
        return 1;
    }
    
    int main()
    {
    
        __try
        {
            cout << "try1" << endl;
            __try
            {
                cout << "try2" << endl;
                __try
                {
                    cout << "try3" << endl;
                }
                __finally
                {
                    cout << "finally" << endl;
                }
            }
            __except (filter())
            {
                cout << "except filter" << endl;
            }
        }
        __except (1)
        {
            cout << "except 1" << endl;
        }
    
        return 0;
    }
    

â€ƒâ€ƒå®ƒçš„åæ±‡ç¼–å¦‚ä¸‹ï¼š

    int main()
    {
    00007FF72C6222C0  push        rbp  
    00007FF72C6222C2  push        rdi  
    00007FF72C6222C3  sub         rsp,0E8h  
    00007FF72C6222CA  lea         rbp,[rsp+20h]  
    
        __try
        {
            cout << "try1" << endl;
    00007FF72C6222CF  lea         rdx,[string "try1" (07FF72C62AC24h)]  
    00007FF72C6222D6  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C6222DD  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C6222E2  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C6222E9  mov         rcx,rax  
    00007FF72C6222EC  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
    00007FF72C6222F2  nop  
            __try
            {
                cout << "try2" << endl;
    00007FF72C6222F3  lea         rdx,[string "try2" (07FF72C62AC2Ch)]  
    00007FF72C6222FA  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C622301  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C622306  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C62230D  mov         rcx,rax  
    00007FF72C622310  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
    00007FF72C622316  nop  
                __try
                {
                    cout << "try3" << endl;
    00007FF72C622317  lea         rdx,[string "try3" (07FF72C62AC34h)]  
    00007FF72C62231E  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C622325  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C62232A  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C622331  mov         rcx,rax  
    00007FF72C622334  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
    00007FF72C62233A  nop  
                }
                __finally
                {
                    cout << "finally" << endl;
    00007FF72C62233B  lea         rdx,[string "finally" (07FF72C62AC40h)]  
    00007FF72C622342  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C622349  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C62234E  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C622355  mov         rcx,rax  
    00007FF72C622358  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
                }
            }
    00007FF72C62235E  jmp         main+0C4h (07FF72C622384h)  
            __except (filter())
            {
                cout << "except filter" << endl;
    00007FF72C622360  lea         rdx,[string "except filter" (07FF72C62AC50h)]  
    00007FF72C622367  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C62236E  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C622373  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C62237A  mov         rcx,rax  
    00007FF72C62237D  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
    00007FF72C622383  nop  
            }
        }
    00007FF72C622384  jmp         $LN8+24h (07FF72C6223AAh)  
        __except (1)
        {
            cout << "except 1" << endl;
    00007FF72C622386  lea         rdx,[string "except 1" (07FF72C62AC60h)]  
    00007FF72C62238D  mov         rcx,qword ptr [__imp_std::cout (07FF72C631198h)]  
    00007FF72C622394  call        std::operator<<<std::char_traits<char> > (07FF72C62108Ch)  
    00007FF72C622399  lea         rdx,[std::endl<char,std::char_traits<char> > (07FF72C62103Ch)]  
    00007FF72C6223A0  mov         rcx,rax  
    00007FF72C6223A3  call        qword ptr [__imp_std::basic_ostream<char,std::char_traits<char> >::operator<< (07FF72C6311B0h)]  
    00007FF72C6223A9  nop  
        }
    
        return 0;
    00007FF72C6223AA  xor         eax,eax  
    }
    00007FF72C6223AC  lea         rsp,[rbp+0C8h]  
    00007FF72C6223B3  pop         rdi  
    00007FF72C6223B4  pop         rbp  
    00007FF72C6223B5  ret  
    

â€ƒâ€ƒå¯ä»¥çœ‹å‡ºç”Ÿæˆçš„ä»£ç å’Œæˆ‘ä»¬è®¤ä¸ºçš„æ™®é€šä»£ç æ²¡ä»€ä¹ˆä¸¤æ ·ï¼Œæ¯ä¸€ä¸ªå¯¹åº”çš„å¼‚å¸¸å¤„ç†ç¨‹åºå‰éƒ½ä¼šç”¨`jmp`è·³è¿‡ï¼Œæ„Ÿè§‰ååˆ†å¥‡æ€ªã€‚é‚£ä¹ˆ64ä½æ˜¯å¦‚ä½•å®ç°å¼‚å¸¸çš„`SEH`å¤„ç†çš„å‘¢ï¼Ÿ  
â€ƒâ€ƒä¸ºäº†æ–¹ä¾¿ä»‹ç»ï¼Œæˆ‘ä»¬æŠŠç¼–è¯‘åçš„ç¨‹åºæ”¾åˆ°`IDA`é‡Œé¢ï¼Œå°†ä¼šå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

    ; int __fastcall main()
    main            proc near               ; CODE XREF: j_mainâ†‘j
                                            ; DATA XREF: .pdata:000000014001F89Câ†“o
    ; __unwind { // j___C_specific_handler_0
                    push    rbp
                    push    rdi
                    sub     rsp, 0E8h
                    lea     rbp, [rsp+20h]
                    lea     rdx, _Val       ; "try1"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    nop
                    lea     rdx, aTry2      ; "try2"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    nop
                    lea     rdx, aTry3      ; "try3"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    nop
    
    $LN18:
                    lea     rdx, aFinally   ; "finally"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    jmp     short loc_140012384
    ; ---------------------------------------------------------------------------
    
    $LN12:
                    lea     rdx, aExceptFilter ; "except filter"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    nop
    
    loc_140012384:                          ; CODE XREF: main+9Eâ†‘j
                    jmp     short loc_1400123AA
    ; ---------------------------------------------------------------------------
    
    $LN8:
                    lea     rdx, aExcept1   ; "except 1"
                    mov     rcx, cs:__imp_?cout@std@@3V?$basic_ostream@DU?$char_traits@D@std@@@1@A ; _Ostr
                    call    j_??$?6U?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@PEBD@Z ; std::operator<<<std::char_traits<char>>(std::ostream &,char const *)
                    lea     rdx, j_??$endl@DU?$char_traits@D@std@@@std@@YAAEAV?$basic_ostream@DU?$char_traits@D@std@@@0@AEAV10@@Z ; std::endl<char,std::char_traits<char>>(std::ostream &)
                    mov     rcx, rax
                    call    cs:__imp_??6?$basic_ostream@DU?$char_traits@D@std@@@std@@QEAAAEAV01@P6AAEAV01@AEAV01@@Z@Z ; std::ostream::operator<<(std::ostream & (*)(std::ostream &))
                    nop
    
    loc_1400123AA:                          ; CODE XREF: main:loc_140012384â†‘j
                    xor     eax, eax
                    lea     rsp, [rbp+0C8h]
                    pop     rdi
                    pop     rbp
                    retn
    ; } // starts at 1400122C0
    main            endp
    

â€ƒâ€ƒæœ‰å…³`SEH`å¼‚å¸¸å¤„ç†çš„ä¿¡æ¯æ”¾åœ¨äº†`PE`ç»“æ„çš„`Exception`ç›®å½•ï¼Œå¦‚æœå¯¹è¯¥æ–¹é¢ä¸€ç‚¹ä¸æ¸…æ¥šçš„åŒå¿—è¯·å­¦ä¹  **[ç¾½å¤ç¬”è®°â€”â€”PEç»“æ„ï¼ˆä¸åŒ…å«.Netï¼‰](https://www.cnblogs.com/wingsummer/p/15242927.html)** ï¼Œå¦åˆ™ä¸‹é¢çš„ä»‹ç»å¯èƒ½å¯¹ä½ æ¥è¯´æ„ä¹‰ä¸å¤ªå¤§ã€‚

### RUNTIME\_FUNCTION

â€ƒâ€ƒåœ¨64ä½ä¸‹ï¼Œæ¯ä¸€ä¸ªéå¶å‡½æ•°ï¼ˆå¶å‡½æ•°å°±æ˜¯æ—¢ä¸è°ƒç”¨å‡½æ•°ï¼Œåˆæ²¡æœ‰ä¿®æ”¹æ ˆæŒ‡é’ˆï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨`SEH`çš„å‡½æ•°ï¼‰éƒ½æœ‰ä¸€ä¸ªç»“æ„ä½“æ¥æè¿°è¯¥å‡½æ•°çš„`SEH`å¤„ç†ä¿¡æ¯ï¼Œé‚£å°±æ˜¯`RUNTIME_FUNCTION`ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

    typedef struct _RUNTIME_FUNCTION {
        ULONG BeginAddress;
        ULONG EndAddress;
        ULONG UnwindData;
    } RUNTIME_FUNCTION, *PRUNTIME_FUNCTION;
    

â€ƒâ€ƒç¬¬ä¸€ä¸ªæˆå‘˜æ ‡å¿—ç€å¼€å§‹`RVA`ï¼Œç¬¬äºŒä¸ªæˆå‘˜æ ‡å¿—çš„æ˜¯ç»“æŸ`RVA`ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹`main`å‡½æ•°çš„`RUNTIME_FUNCTION`ï¼š

    RUNTIME_FUNCTION <rva main, rva byte_1400123B6, rva stru_14001C600>
    

â€ƒâ€ƒ`IDA`å¸®æˆ‘ä»¬ç»™è¯†åˆ«å¥½äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ç¡¬ç¼–ç ï¼š

    C0 22 01 00 B6 23 01 00 00 C6 01 00
    

â€ƒâ€ƒä¸ºäº†é…åˆè®²è§£ï¼Œæˆ‘ä»¬æŠŠä¸»å‡½æ•°çš„å¼€å§‹åœ°å€å’Œç»“æŸåœ°å€çœ‹ä¸€ä¸‹ï¼š

    .text:00000001400122C0 ; int __fastcall main()
    .text:00000001400122C0 main            proc near               ; CODE XREF: j_mainâ†‘j
    .text:00000001400122C0                                         ; DATA XREF: .pdata:000000014001F89Câ†“o
    .text:00000001400122C0 ; __unwind { // j___C_specific_handler_0
    
    â€¦â€¦
    
    .text:00000001400123B5 main            endp
    .text:00000001400123B5
    .text:00000001400123B5 ; ---------------------------------------------------------------------------
    .text:00000001400123B6 byte_1400123B6  db 3Dh dup(0CCh)        ; DATA XREF: .pdata:000000014001F89Câ†“o
    

â€ƒâ€ƒä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜çš„å€¼å°±æ˜¯`0x122C0`ï¼Œæ­£å¥½æ˜¯æˆ‘ä»¬ç¨‹åºçš„åç§»ï¼ˆé•œåƒåŠ è½½çš„åœ°å€ä¸º`0x140000000`ï¼‰ï¼Œç¬¬äºŒä¸ªæˆå‘˜çš„å€¼æ˜¯`0x123B6`ä¹Ÿå°±æ˜¯ç»“æŸçš„ä½ç½®åç§»ã€‚  
â€ƒâ€ƒè¿˜æœ‰ä¸€ä¸ªæˆå‘˜æˆ‘ä»¬å¹¶æ²¡æœ‰ä»‹ç»ï¼Œé‚£å°±æ˜¯`UnwindData`ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè£…ç€å¼‚å¸¸å‘ç”Ÿæ—¶æ ˆçš„å›æ»šä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    typedef struct _UNWIND_INFO {
           UCHAR Version : 3;
           UCHAR Flags : 5;
           UCHAR SizeOfProlog;
           UCHAR CountOfCodes;
           UCHAR FrameRegister : 4;
           UCHAR FrameOffset : 4;
           UNWIND_CODE UnwindCode[1];
       
       //
       // The unwind codes are followed by an optional DWORD aligned field that
       // contains the exception handler address or a function table entry if
       // chained unwind information is specified. If an exception handler address
       // is specified, then it is followed by the language specified exception
       // handler data.
       //
       //  union {
       //      struct {
       //          ULONG ExceptionHandler;
       //          ULONG ExceptionData[];
       //      };
       //
       //      RUNTIME_FUNCTION FunctionEntry;
       //  };
       //
       
       } UNWIND_INFO, *PUNWIND_INFO;
    

### UNWIND\_INFO

â€ƒâ€ƒè¯¥ç»“æ„å‰ä¸¤ä¸ªæˆå‘˜æ˜¯ä¸ªä½åŸŸï¼Œå ç”¨ä¸€ä¸ª`UCHAR`å¤§å°ã€‚ç¬¬ä¸€ä¸ªæˆå‘˜æ˜¯ç‰ˆæœ¬å·ï¼Œç›®å‰éƒ½æ˜¯1ï¼Œç¬¬äºŒä¸ªæˆå‘˜æ˜¯æ¯”è¾ƒé‡è¦çš„æˆå‘˜ï¼Œå®ƒæ ‡å¿—äº†å®ƒçš„ç±»å‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼š

    #define UNW_FLAG_NHANDLER 0x0
    #define UNW_FLAG_EHANDLER 0x1
    #define UNW_FLAG_UHANDLER 0x2
    #define UNW_FLAG_CHAININFO 0x4
    

â€ƒâ€ƒå¯ä»¥çœ‹åˆ°æœ‰å››ç§ç±»å‹ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒä»¬çš„å«ä¹‰ã€‚

#### UNW\_FLAG\_NHANDLER

â€ƒâ€ƒè¡¨ç¤ºæ—¢æ²¡æœ‰`EXCEPT_FILTER`ä¹Ÿæ²¡æœ‰`EXCEPT_HANDLER`ï¼Œè¿™ä¸ªæ˜¯æœ€ç®€å•çš„ç±»å‹ï¼Œå®ƒçš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220330111433976-1273919933.png)

#### UNW\_FLAG\_EHANDLER

â€ƒâ€ƒ è¡¨ç¤ºè¯¥å‡½æ•°æœ‰`EXCEPT_FILTER`å’Œ`EXCEPT_HANDLER`ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220330111444714-1928043452.png)

#### UNW\_FLAG\_UHANDLER

â€ƒâ€ƒè¡¨ç¤ºè¯¥å‡½æ•°æœ‰`FINALLY_HANDLER`ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹ï¼š

![](https://img2022.cnblogs.com/blog/2520882/202203/2520882-20220330111453988-184933935.png)

#### UNW\_FLAG\_CHAININFO

â€ƒâ€ƒè¡¨ç¤ºè¯¥å‡½æ•°æœ‰å¤šä¸ª`UNWIND_INFO`å¹¶ä¸²æ¥åœ¨ä¸€èµ·ã€‚

#### SizeOfProlog

â€ƒâ€ƒè¡¨ç¤ºè¯¥å‡½æ•°çš„`Prolog`æŒ‡ä»¤çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚

#### CountOfCodes

â€ƒâ€ƒè¡¨ç¤ºå½“å‰`UNWIND_INFO`åŒ…å«å¤šå°‘ä¸ª`UNWIND_CODE`ç»“æ„ã€‚

#### FrameRegister

â€ƒâ€ƒ å¦‚æœå‡½æ•°å»ºç«‹äº†æ ˆå¸§ï¼Œå®ƒè¡¨ç¤ºæ ˆå¸§çš„ç´¢å¼•ï¼Œå¦åˆ™ä¸º0.

#### FrameOffset

â€ƒâ€ƒè¡¨ç¤º`FrameRegister`è·ç¦»å‡½æ•°æœ€åˆæ ˆé¡¶ï¼ˆåˆšè¿›å…¥å‡½æ•°ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œä»»ä½•æŒ‡ä»¤æ—¶çš„æ ˆé¡¶ï¼‰çš„åç§»ï¼Œå•ä½ä¸ºå­—èŠ‚ã€‚

#### UnwindCode

â€ƒâ€ƒæ˜¯ä¸€ä¸ª`UNWIND_CODE`ç±»å‹çš„ä¸å®šé•¿æ•°ç»„ï¼Œå…ƒç´ æ•°é‡ç”±`CountOfCodes`å†³å®šã€‚  
â€ƒâ€ƒè¿™é‡Œåœ¨è¯´æ˜å‡ ç‚¹ï¼šå¦‚æœ`Flags`è®¾ç½®äº†`UNW_FLAG_EHANDLER`æˆ–`UNW_FLAG_UHANDLER`ï¼Œé‚£ä¹ˆåœ¨æœ€åä¸€ä¸ª`UNWIND_CODE`ä¹‹åå­˜æ”¾ç€`ExceptionHandler`ï¼Œå®ƒç›¸å½“äº x86çš„`EXCEPTION_REGISTRATION::handle`ä»¥åŠ`ExceptionData`å®ƒç›¸å½“äºx86çš„`EXCEPTION_REGISTRATION::scopetable`ã€‚`UnwindCode`æ•°ç»„è¯¦ç»†è®°å½•äº†å‡½æ•°ä¿®æ”¹æ ˆã€ä¿å­˜éæ˜“å¤±æ€§å¯„å­˜å™¨çš„æŒ‡ä»¤ã€‚

### UNWIND\_CODE

â€ƒâ€ƒä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹`UNWIND_CODE`ç»“æ„ä½“ï¼š

    typedef enum _UNWIND_OP_CODES {
        UWOP_PUSH_NONVOL = 0,
        UWOP_ALLOC_LARGE,       // 1
        UWOP_ALLOC_SMALL,       // 2
        UWOP_SET_FPREG,         // 3
        UWOP_SAVE_NONVOL,       // 4
        UWOP_SAVE_NONVOL_FAR,   // 5
        UWOP_SPARE_CODE1,       // 6
        UWOP_SPARE_CODE2,       // 7
        UWOP_SAVE_XMM128,       // 8
        UWOP_SAVE_XMM128_FAR,   // 9
        UWOP_PUSH_MACHFRAME     // 10
    } UNWIND_OP_CODES, *PUNWIND_OP_CODES;
    
    typedef union _UNWIND_CODE {
        struct {
            UCHAR CodeOffset;
            UCHAR UnwindOp : 4;
            UCHAR OpInfo : 4;
        };
    
        USHORT FrameOffset;
    } UNWIND_CODE, *PUNWIND_CODE;
    

â€ƒâ€ƒç”±äºæˆ‘ä»¬è¿™é‡Œæ˜¯çŸ¥è¯†é“ºå«ï¼Œå…·ä½“ç»†èŠ‚å°±ä¸å»è¿½ç©¶äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œæ¢ç´¢ã€‚

ä¸‹ä¸€ç¯‡
---

â€ƒâ€ƒx64 ç•ªå¤–ç¯‡â€”â€”ä¿æŠ¤æ¨¡å¼ç›¸å…³

![çŸ¥è¯†å…±äº«è®¸å¯åè®®](https://images.cnblogs.com/cnblogs_com/blogs/702188/galleries/2023299/o_210902075935face.png)  
[![çŸ¥è¯†å…±äº«è®¸å¯åè®®](https://images.cnblogs.com/cnblogs_com/blogs/702188/galleries/2023299/o_211123135827_CC.png)](http://creativecommons.org/licenses/by-nc-sa/4.0/)

æœ¬ä½œå“é‡‡ç”¨ [çŸ¥è¯†å…±äº«ç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®](http://creativecommons.org/licenses/by-nc-sa/4.0/) è¿›è¡Œè®¸å¯  
æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[å¯‚é™çš„ç¾½å¤](https://www.cnblogs.com/wingsummer/) ï¼Œä¸€ä¸ªçƒ­çˆ±è®¡ç®—æœºæŠ€æœ¯çš„èœé¸Ÿ  
è½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/wingsummer/p/16076345.html](https://www.cnblogs.com/wingsummer/p/16076345.html)

![](https://images.cnblogs.com/cnblogs_com/blogs/702188/galleries/2023299/o_211123151344_logo.png)