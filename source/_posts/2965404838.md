---
layout: post
title: "ä½¿ç”¨ Helm å®‰è£… MQTT æœåŠ¡å™¨-EMQX"
date: "2023-01-02T05:15:01.162Z"
---
ä½¿ç”¨ Helm å®‰è£… MQTT æœåŠ¡å™¨-EMQX
========================

EMQX
----

> â„¹ï¸ **Info:**
> 
> ä½¿ç”¨ [EMQX](https://www.emqx.com/zh)
> 
> [é€šè¿‡ Helm3 åœ¨ Kubernetes ä¸Šéƒ¨ç½² EMQX 4.0 é›†ç¾¤ | EMQ](https://www.emqx.com/zh/blog/rapidly-deploy-emqx-clusters-on-kubernetes-via-helm)
> 
> [emqx/deploy/charts/emqx at main-v4.4 Â· emqx/emqx (github.com)](https://github.com/emqx/emqx/tree/main-v4.4/deploy/charts/emqx)
> 
> [emqx/values.yaml at main-v4.4 Â· emqx/emqx (github.com)](https://github.com/emqx/emqx/blob/main-v4.4/deploy/charts/emqx/values.yaml)
> 
> [emqx/emqx-operator: A Kubernetes Operator for EMQ X Broker (github.com)](https://github.com/emqx/emqx-operator)
> 
> [é…ç½®é¡¹ | EMQX æ–‡æ¡£](https://www.emqx.io/docs/zh/v4.3/configuration/configuration.html#cluster)

### EMQX å®‰è£…

> â„¹ï¸ **Info:**
> 
> å³ EMQX æœåŠ¡å™¨ç«¯ã€‚

    > helm repo add emqx https://repos.emqx.io/charts
    "emqx" has been added to your repositories
    > helm repo update
    Hang tight while we grab the latest from your chart repositories...
    ...Successfully got an update from the "emqx" chart repository
    Update Complete. âˆHappy Helming!âˆ
    > helm search repo emqx
    NAME                    CHART VERSION   APP VERSION     DESCRIPTION                              
    emqx/emqx               4.4.0           4.4.0           A Helm chart for EMQ X                   
    emqx/emqx-ee            4.4.1           4.4.1           A Helm chart for EMQ X                   
    emqx/emqx-operator      1.0.1           1.1.2           A Helm chart for EMQX Operator Controller
    emqx/kuiper             0.9.0           0.9.0           A lightweight IoT edge analytic software
    

å®‰è£…ï¼š

`vi values.yaml`:

    replicaCount: 1
    image:
      repository: emqx/emqx
      pullPolicy: IfNotPresent
    
    recreatePods: false
    
    podManagementPolicy: Parallel
    
    extraEnv: []
    
    extraEnvFrom: []
    
    extraArgs: []
    
    extraVolumes: []
    
    extraVolumeMounts: []
    
    persistence:
      enabled: true
      size: 8Gi
      storageClass: "local-path"
      accessMode: ReadWriteOnce
    
    resources: {}
      # limits:
      #   cpu: 500m
      #   memory: 512Mi
      # requests:
      #   cpu: 500m
      #   memory: 512Mi
    
    # Containers that run before the creation of EMQ X containers. They can contain utilities or setup scripts.
    initContainers: {}
      # - name: mysql-probe
      #   image: alpine
      #   command: ["sh", "-c", "for i in $(seq 1 300); do nc -zvw1 mysql 3306 && exit 0 || sleep 3; done; exit 1"]
    
    ## EMQ X configuration item, see the documentation (https://hub.docker.com/r/emqx/emqx)
    emqxConfig:
      EMQX_NAME:  "{{ .Release.Name }}"
      ## Cluster discovery by k8s
      EMQX_CLUSTER__DISCOVERY: "k8s"
      EMQX_CLUSTER__K8S__APP_NAME: "{{ .Release.Name }}"
      EMQX_CLUSTER__K8S__APISERVER: "https://kubernetes.default.svc:443"
      EMQX_CLUSTER__K8S__SERVICE_NAME: "{{ .Release.Name }}-headless"
      EMQX_CLUSTER__K8S__NAMESPACE: "{{ .Release.Namespace }}"
      EMQX_CLUSTER__K8S__ADDRESS_TYPE: "hostname"
      EMQX_CLUSTER__K8S__SUFFIX: "svc.cluster.local"
    
    emqxAclConfig: >
      {allow, {user, "dashboard"}, subscribe, ["$SYS/#"]}.
      {allow, {ipaddr, "127.0.0.1"}, pubsub, ["$SYS/#", "#"]}.
      {deny, all, subscribe, ["$SYS/#", {eq, "#"}]}.
      {allow, all}.
    
    emqxLoadedPlugins: >
      {emqx_management, true}.
      {emqx_recon, true}.
      {emqx_retainer, true}.
      {emqx_dashboard, true}.
      {emqx_telemetry, true}.
      {emqx_rule_engine, true}.
      {emqx_bridge_mqtt, false}.
    
    emqxLoadedModules: >
      {emqx_mod_acl_internal, true}.
      {emqx_mod_presence, true}.
      {emqx_mod_trace, false}.
      {emqx_mod_st_statistics, false}.
      {emqx_mod_delayed, false}.
      {emqx_mod_rewrite, false}.
      {emqx_mod_subscription, false}.
      {emqx_mod_topic_metrics, false}.
    
    service:
      type: LoadBalancer
      mqtt: 1883
      mqttssl: 8883
      mgmt: 8081
      ws: 8083
      wss: 8084
      dashboard: 18083
    
    podSecurityContext:
      enabled: true
      fsGroup: 1000
      fsGroupChangePolicy: Always
      runAsUser: 1000
      supplementalGroups:
        - 1000
    
    containerSecurityContext:
      enabled: true
      runAsNonRoot: true
      runAsUser: 1000
    

    helm install emqx emqx/emqx --namespace emqx --create-namespace -f ./values.yaml --wait
    

å®‰è£…è¾“å‡ºï¼š

    NAME: emqx
    LAST DEPLOYED: Sat Feb 19 20:48:49 2022
    NAMESPACE: emqx
    STATUS: deployed
    REVISION: 1
    TEST SUITE: None
    

### EMQX éªŒè¯

å®‰è£…åæŸ¥çœ‹ EMQX é›†ç¾¤æƒ…å†µï¼š

    # kubectl -n emqx get pods
    NAME               READY   STATUS    RESTARTS   AGE
    svclb-emqx-kbl22   6/6     Running   0          41s
    emqx-0             1/1     Running   0          41s
    
    # kubectl -n emqx  exec -it emqx-0 -- emqx_ctl cluster status
    Cluster status: #{running_nodes =>
                          ['emqx@emqx-0.emqx-headless.emqx.svc.cluster.local'],
                      stopped_nodes => []}
    
    # kubectl -n emqx get svc
    NAME            TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                                                                                      AGE
    emqx-headless   ClusterIP      None            <none>           1883/TCP,8883/TCP,8081/TCP,8083/TCP,8084/TCP,18083/TCP,4370/TCP                              86s
    emqx            LoadBalancer   10.43.193.192   10.<none> .245   1883:31558/TCP,8883:31122/TCP,8081:31592/TCP,8083:30322/TCP,8084:31095/TCP,18083:32427/TCP   86s
    
    

è®¿é—®æ§åˆ¶å°ï¼š

è®¿é—® `URL:18083`ï¼Œè¾“å…¥é»˜è®¤ç”¨æˆ·åï¼š`admin`ï¼Œé»˜è®¤å¯†ç ï¼š`public`ï¼Œç™»é™† EMQX dashboardã€‚

![image-20220219205441661](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230102082958129-2068525636.png)

MQTT æ¶ˆæ¯éªŒè¯ï¼š

å¯ä»¥é€šè¿‡ [MQTT X: Cross-platform MQTT 5.0 Desktop Client](https://mqttx.app/) è¿æ¥å¹¶è¿›è¡Œæ”¶å‘éªŒè¯ã€‚

ğŸ‰è‡³æ­¤ï¼ŒEMQXï¼ˆå³ MQTT æœåŠ¡å™¨ç«¯ï¼‰ å®‰è£…å®Œæˆã€‚

### EMQX å¸è½½

é¦–å…ˆé€šè¿‡ Helm å¸è½½ EMQX é™¤å­˜å‚¨å¤–çš„æ‰€æœ‰èµ„æºï¼š

    helm uninstall emqx --namespace emqx
    

ä¹‹åå†é€šè¿‡ Rancher UI æˆ– kubectl å‘½ä»¤åˆ é™¤å­˜å‚¨ï¼š

    kubectl delete -n emqx pvc emqx-data-emqx-0
    

EMQX Edge
---------

> â„¹ï¸ **Info:**
> 
> å³ EMQX Edge ç«¯ç‰ˆæœ¬
> 
> Edge ç«¯èµ„æºè¾ƒå°ï¼Œå­˜å‚¨ç©ºé—´ç­‰å¯ä»¥é€‚å½“è®¾ç½®ä½ä¸€ç‚¹ã€‚å¦‚ï¼š`size: 5Gi`

éƒ¨ç½² EMQX Edge é›†ç¾¤æŒ‡å®š `image.repository=emqx/emqx-edge`ï¼Œå…¶ä»–è®¾ç½®ä¸éƒ¨ç½² EMQX é›†ç¾¤ä¿æŒä¸€è‡´

    ...
    image:
      repository: emqx/emqx-edge
    ...
    persistence:
    ...
      size: 8Gi
    ...
    

ğŸ‰è‡³æ­¤ï¼ŒEMQX Edgeï¼ˆå³ MQTT Edge ç«¯ Server) å®‰è£…å®Œæˆã€‚

### EMQX Edge ç¦»çº¿å®‰è£…

é€šè¿‡æ“ä½œæœºï¼ˆå¯ä»¥è”ç½‘æˆ–å¯ä»¥é€šè¿‡ä»£ç†ä¸Šç½‘ï¼‰ pull EMQX çš„å®¹å™¨é•œåƒåˆ°å¯¹åº”çš„é•œåƒä»“åº“ï¼š

    ctr -n k8s.io images push --plain-http --platform=linux/arm64/v8 <local-registry>:5000/emqx/emqx-edge:4.4.0
    

ç„¶åæ­£å¸¸å®‰è£…å³å¯ï¼š

> ğŸ”¥ **Tip:**
> 
> å‰ææ˜¯æœ¬åœ°å·²å®‰è£…é•œåƒä»“åº“ï¼Œä¸”æœ¬åœ° docker æˆ–å…¶ä»–å®¹å™¨è¿è¡Œæ—¶å·²ç»é…ç½®æœ¬åœ°é•œåƒä»“åº“åœ°å€ä¸º <docker.io> çš„ mirror

    helm install emqx emqx/emqx --namespace emqx --create-namespace -f ./values.yaml --wait
    

ğŸ‰è‡³æ­¤ï¼ŒEMQX Edgeï¼ˆå³ MQTT Edge ç«¯ Server) ç¦»çº¿æ–¹å¼å®‰è£…å®Œæˆã€‚

æ€»ç»“
--

### MQTT

1.  MQTT Server é€šè¿‡ Helm Chart EMQX å®‰è£…ï¼Œå®‰è£…äºï¼šæœåŠ¡å™¨/Edge ç«¯ K3S çš„ `emqx` namespace;
    1.  å®‰è£…æ¨¡å¼ï¼šå•èŠ‚ç‚¹
    2.  EMQX ç‰ˆæœ¬ï¼š4.4.0
    3.  EMQX å®ä¾‹ï¼š1 ä¸ª
    4.  EMQX æ•°æ®å·²æŒä¹…åŒ–ï¼Œå®¹å™¨æ•°æ®ä½äºï¼š`/opt/emqx/data/mnesia`, æŒä¹…åŒ–åçš„æ•°æ®ä½äºï¼š`/data/rancher/k3s/storage`
2.  EMQX UI ä¸ºï¼š`<locabalaner-ip>:18083`, è´¦å·å¯†ç é»˜è®¤ä¸ºï¼š`admin` å’Œ `public`
3.  MQTT åœ°å€ä¸ºï¼š`<locabalaner-ip>:1883`

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.