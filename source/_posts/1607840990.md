---
layout: post
title: "ä½¿ç”¨Jiralertå®ç°AlertManagerå‘Šè­¦å¯¹æ¥Jira"
date: "2023-01-04T12:31:18.449Z"
---
ä½¿ç”¨Jiralertå®ç°AlertManagerå‘Šè­¦å¯¹æ¥Jira
================================

ç®€ä»‹
--

[Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/) å¤„ç†ç”±å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºï¼ˆå¦‚ Prometheus serverï¼‰å‘é€çš„è­¦æŠ¥ã€‚å®ƒè´Ÿè´£å»é‡(deduplicating)ï¼Œåˆ†ç»„(grouping)ï¼Œå¹¶å°†å®ƒä»¬è·¯ç”±(routing)åˆ°æ­£ç¡®çš„æ¥æ”¶å™¨(receiver)é›†æˆï¼Œå¦‚ç”µå­é‚®ä»¶ï¼Œå¾®ä¿¡ï¼Œæˆ–é’‰é’‰ã€‚å®ƒè¿˜è´Ÿè´£å¤„ç†è­¦æŠ¥çš„é™é»˜/å±è”½(silencing)ã€å®šæ—¶å‘é€/ä¸å‘é€(Mute)å’ŒæŠ‘åˆ¶(inhibition)é—®é¢˜ã€‚

AlertManager ä½œä¸º å¼€æºçš„ä¸º Prometheus è€Œè®¾è®¡çš„å‘Šè­¦åº”ç”¨, å·²ç»å…·å¤‡äº†å‘Šè­¦åº”ç”¨å„ç±»ä¸°å¯Œã€çµæ´»ã€å¯å®šåˆ¶çš„åŠŸèƒ½ï¼š

*   [Prometheus AlertManager ç³»åˆ—æ–‡ç« ](https://ewhisper.cn/tags/AlertManager/)

### Jiralert

**ç”¨äºJIRAçš„Prometheus Alertmanager Webhook Receiver**ã€‚

JIRAlertå®ç°äº†Alertmanagerçš„webhook HTTP APIï¼Œå¹¶è¿æ¥åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªJIRAå®ä¾‹ä»¥åˆ›å»ºé«˜åº¦å¯é…ç½®çš„JIRA Issuesã€‚æ¯ä¸ªä¸åŒçš„ Groupkey åˆ›å»ºä¸€ä¸ªIssue--ç”±Alertmanagerçš„è·¯ç”±é…ç½®éƒ¨åˆ†çš„`group_by`å‚æ•°å®šä¹‰--ä½†åœ¨è­¦æŠ¥è§£å†³æ—¶ä¸ä¼šå…³é—­(é»˜è®¤å‚æ•°, å¯è°ƒæ•´)ã€‚æˆ‘ä»¬çš„æœŸæœ›æ˜¯ï¼Œäººä»¬ä¼šæŸ¥çœ‹è¿™ä¸ªissueã€‚ï¼Œé‡‡å–ä»»ä½•å¿…è¦çš„è¡ŒåŠ¨ï¼Œç„¶åå…³é—­å®ƒã€‚å¦‚æœæ²¡æœ‰äººçš„äº’åŠ¨æ˜¯å¿…è¦çš„ï¼Œé‚£ä¹ˆå®ƒå¯èƒ½é¦–å…ˆå°±ä¸åº”è¯¥æŠ¥è­¦ã€‚ç„¶è€Œï¼Œè¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡è®¾ç½®`auto_resolve`éƒ¨åˆ†è¿›è¡Œä¿®æ”¹ï¼Œå®ƒå°†ä»¥æ‰€éœ€çš„çŠ¶æ€è§£å†³jira issueã€‚

å¦‚æœä¸€ä¸ªç›¸åº”çš„JIRA issueã€‚å·²ç»å­˜åœ¨ï¼Œä½†è¢«è§£å†³äº†ï¼Œå®ƒå°†è¢«é‡æ–°æ‰“å¼€(reopened)ã€‚åœ¨è§£å†³çš„çŠ¶æ€å’Œé‡å¼€çš„çŠ¶æ€ä¹‹é—´å¿…é¡»å­˜åœ¨ä¸€ä¸ª**JIRA transition**\--å¦‚`reopen_state`\--å¦åˆ™é‡å¼€å°†å¤±è´¥ã€‚å¯ä»¥é€‰æ‹©å®šä¹‰ä¸€ä¸ª "won't fix" çš„å†³è®®(**resolution**)--ç”±`wont_fix_resolution`å®šä¹‰ï¼šæœ‰æ­¤å†³è®®çš„JIRAé—®é¢˜å°†ä¸ä¼šè¢«JIRAlerté‡æ–°æ‰“å¼€ã€‚

å®‰è£… Jiralert
-----------

Jiralert çš„å®‰è£…æ¯”è¾ƒç®€å•, ä¸»è¦ç”± Deploymentã€Secretï¼ˆJiralert çš„é…ç½®ï¼‰å’Œ Service ç»„æˆã€‚å…¸å‹ç¤ºä¾‹å¦‚ä¸‹ï¼š

    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: jiralert
    spec:
      selector:
        matchLabels:
          app: jiralert
      template:
        metadata:
          labels:
            app: jiralert
        spec:
          containers:
          - name: jiralert
            image: quay.io/jiralert/jiralert-linux-amd64:latest
            imagePullPolicy: IfNotPresent
            args:
            - "--config=/jiralert-config/jiralert.yml"
            - "--log.level=debug"
            - "--listen-address=:9097"
            readinessProbe:
              tcpSocket:
                port: 9097
              initialDelaySeconds: 15
              periodSeconds: 15
              timeoutSeconds: 5
            livenessProbe:
              tcpSocket:
                port: 9097
              initialDelaySeconds: 15
              periodSeconds: 15
              timeoutSeconds: 5
            ports:
            - containerPort: 9091
              name: metrics
            volumeMounts:
            - mountPath: /jiralert-config
              name: jiralert-config
              readOnly: true
          volumes:
          - name: jiralert-config
            secret:
              secretName: jiralert-config
    ---
    apiVersion: v1
    kind: Secret
    type: Opaque
    metadata:
      name: jiralert-config
    stringData:
      jiralert.tmpl: |-
        {{ define "jira.summary" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join "," }}{{ end }}
        
        {{ define "jira.description" }}{{ range .Alerts.Firing }}Labels:
        {{ range .Labels.SortedPairs }} - {{ .Name }} = {{ .Value }}
        {{ end }}
        
        Annotations:
        {{ range .Annotations.SortedPairs }} - {{ .Name }} = {{ .Value }}
        {{ end }}
        
        Source: {{ .GeneratorURL }}
        {{ end }}
        
        CommonLabels:
        {{ range .CommonLabels.SortedPairs }} - {{ .Name }} = {{ .Value}}
        {{ end }}
        
        GroupLabels:
        {{ range .GroupLabels.SortedPairs }} - {{ .Name }} = {{ .Value}}
        {{ end }}
        {{ end }}
      jiralert.yml: |-
        # Global defaults, applied to all receivers where not explicitly overridden. Optional.
        template: jiralert.tmpl
        defaults:
          # API access fields.
          api_url: https://jira.example.com
          user: foo
          password: bar
          # The type of JIRA issue to create. Required.
          issue_type: Bug
          # Issue priority. Optional.
          priority: Major
          # Go template invocation for generating the summary. Required.
          summary: '{{ template "jira.summary" . }}'
          # Go template invocation for generating the description. Optional.
          description: '{{ template "jira.description" . }}'
          # State to transition into when reopening a closed issue. Required.
          reopen_state: "REOPENED"
          # Do not reopen issues with this resolution. Optional.
          wont_fix_resolution: "Won't Fix"
          # Amount of time after being closed that an issue should be reopened, after which, a new issue is created.
          # Optional (default: always reopen)
          # reopen_duration: 30d
        
        # Receiver definitions. At least one must be defined.
        # Receiver names must match the Alertmanager receiver names. Required.
        receivers:
        - name: 'jiralert'
          project: 'YOUR-JIRA-PROJECT'
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: jiralert
    spec:
      selector:
        app: jiralert
      ports:
      - port: 9097
        targetPort: 9097                
    

ç›¸åº” AlertManager çš„é…ç½®:

    ...
    receivers:
    - name: jiralert
      webhook_configs:
      - send_resolved: true
        url: http://jiralert:9097/alert
    routes:
    - receiver: jiralert
      matchers:
      - severity = critical
      continue: true
    ...
    

ğŸ“ è¯´æ˜:

*   å®˜æ–¹ jiralert é•œåƒåœ°å€: [https://quay.io/repository/jiralert/jiralert-linux-amd64?tab=tags](https://quay.io/repository/jiralert/jiralert-linux-amd64?tab=tags)
    *   å®˜æ–¹ jiralert latest é•œåƒ: <quay.io/jiralert/jiralert-linux-amd64:latest>
*   `jiralert.tmpl` ç±»ä¼¼ AlertManager çš„ Template, å‘é€åˆ° Jira çš„ Issue ä¼šä»¥æ­¤ä¸ºæ¨¡æ¿
*   `jiralert.yml` Jiralert çš„é…ç½®æ–‡ä»¶
    *   `defaults` åŸºç¡€ç‰ˆé…ç½®
    *   `receivers` å¯ä»¥è®¾ç½®å¤šä¸ª receiver, å±Šæ—¶ AlertManager è¦å‘åˆ°å“ªä¸ª Jira çš„receiverå°±éœ€è¦ä¸è¿™ä¸ª jiralert çš„receiver åŒå. (æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­, éƒ½æ˜¯`jiralert`)

Jiralert é…ç½®
-----------

ç»è¿‡ç”Ÿäº§å®è·µçš„ Jiralert å®Œæ•´é…ç½®å¦‚ä¸‹:

    # Global defaults, applied to all receivers where not explicitly overridden. Optional.
    template: jiralert.tmpl
    defaults:
      # API access fields.
      api_url: https://example.atlassian.net
      user: <your-account-email>
      password: '<your-account-api-token>'
      # The type of JIRA issue to create. Required.
      issue_type: Support
      # Issue priority. Optional.
      priority: High
      # Go template invocation for generating the summary. Required.
      summary: '{{ template "jira.summary" . }}'
      # Go template invocation for generating the description. Optional.
      description: '{{ template "jira.description" . }}'
      # State to transition into when reopening a closed issue. Required.
      reopen_state: "Back to in progress"
      # Do not reopen issues with this resolution. Optional.
      wont_fix_resolution: "Won't Do"
      # Amount of time after being closed that an issue should be reopened, after which, a new issue is created.
      # Optional (default: always reopen)
      reopen_duration: 30d
    
    # Receiver definitions. At least one must be defined.
    # Receiver names must match the Alertmanager receiver names. Required.
    receivers:
    - name: 'jiralert'
      project: <your-project-code>
      add_group_labels: true
      auto_resolve:
        state: 'Resolve this issue'
    

ğŸ“è¯¦ç»†è¯´æ˜å¦‚ä¸‹:

1.  `api_url`: Jira çš„åœ°å€, å¦‚æœç”¨çš„æ˜¯ Jira çš„ SaaS æœåŠ¡, å°±æ˜¯`https://<tenant>.atlassian.net`
2.  è®¤è¯:
    1.  å¯¹äºå…¬æœ‰äº‘ç‰ˆçš„ Jira, åªèƒ½ç”¨ `user` å’Œ `password`, å…¶ä¸­:
        1.  `user` å¡«å†™ä½ çš„è´¦å·é‚®ç®±åœ°å€;
        2.  `password` éœ€è¦å…ˆåœ¨ [API Token | Atlassian account](https://id.atlassian.com/manage-profile/security/api-tokens) ç”³è¯· API Token. (ğŸ¾æ³¨æ„: ç™»å½•ç”¨çš„å¯†ç æ˜¯æ— æ³•è®¤è¯é€šè¿‡çš„)
    2.  å¯¹äºå…¶ä»–ç‰ˆæœ¬, ä¹Ÿå¯ä»¥å¡«å†™ä½¿ç”¨ `personal_access_token` è¿›è¡Œè®¤è¯. å…¶å€¼ä¸º: `user@example.com:api_token_string` çš„ base64 ç¼–ç åå­—ç¬¦ä¸². å…·ä½“è¯´æ˜è§: [Basic auth for REST APIs (atlassian.com)](https://developer.atlassian.com/cloud/jira/platform/basic-auth-for-rest-apis/)
3.  `issue_type`: æ ¹æ®æ‚¨çš„ Jira Issue Type æ¥å¡«å†™, å¯èƒ½æ˜¯: `Alert` `Support` `Bug` `New Feature` ç­‰ç­‰æˆ–å…¶ä»–
4.  `priority` æ ¹æ®æ‚¨çš„ Issue priority æ¥å¡«å†™, å¯èƒ½æ˜¯: `Critical` `High` `Medium` `Low` ç­‰ç­‰æˆ–å…¶ä»–
5.  `reopen_state`: Jira çš„é—®é¢˜å·²ç»å…³é—­, è¦é‡æ–°æ‰“å¼€, éœ€è¦çš„ **transition**, å¦‚: `Back to in progress`. (ğŸ¾æ³¨æ„: è¿™é‡Œéœ€è¦å¡«å†™çš„æ˜¯æ‚¨è‡ªå®šä¹‰çš„ **transition**, è€Œé **status**)
6.  `wont_fix_resolution`: å¸¦æœ‰è¿™ä¸ª **resolution** (è§£å†³æ–¹æ¡ˆ)çš„é—®é¢˜å°±ä¸ä¼šé‡æ–°æ‰“å¼€. å¦‚: `Won't Do` `Won't Fix`, éœ€è¦æ ¹æ®è‡ªå·±çš„ **resolution** å®šä¹‰å†…å®¹æ¥å¡«å†™.
7.  `reopen_duration`: å¤šä¹…æ—¶é—´ä¹‹å†…çš„é—®é¢˜ä¼šé‡æ–°æ‰“å¼€, é»˜è®¤æ˜¯ `always reopen`, å¯ä»¥è®¾ç½®ä¸ºå¦‚: `30d`, è¡¨ç¤ºè¿™ä¸ªé—®é¢˜å¦‚æœ30å¤©ä»¥å‰æœ‰åŒæ ·çš„é—®é¢˜, æ–°å¼€ä¸€ä¸ª Issue, è€Œä¸æ˜¯é‡æ–°æ‰“å¼€è€çš„ Issue.
8.  `receivers`: å¯ä»¥å®šä¹‰å¤šä¸ª receivers, æŒ‡å‘ä¸åŒ `project`
9.  `project`: Jira çš„ Project ID, æ˜¯ Project è¯¦ç»†åå­—çš„é¦–å­—æ¯å¤§å†™. å¦‚ Project æ˜¯ `For Example`, è¿™é‡Œå°±å¡«å†™ `FE`
10.  `add_group_labels`: æ˜¯å¦è¦å°† AlertManager çš„ Group Labels åŠ åˆ° Jira çš„ Labels. (ğŸ¾æ³¨æ„: Jira Labels çš„ Value æ˜¯ä¸èƒ½æœ‰ç©ºæ ¼çš„, æ‰€ä»¥å¦‚æœä½ çš„ AlertManager çš„ Group Label çš„Valueå¦‚æœæœ‰ç©ºæ ¼, **ä¸è¦**å¼€å¯æ­¤é¡¹åŠŸèƒ½)
11.  `auto_resolve`: æœ€æ–° 1.2 ç‰ˆæœ¬æ–°å¢çš„åŠŸèƒ½, å½“å‘Šè­¦æ¢å¤äº†, å¯ä»¥è‡ªåŠ¨ resolve å¯¹åº”çš„ Jira Issue.
    1.  `state: 'Resolve this issue'` è¿™é‡Œä¹Ÿæ˜¯è¦å¡«å†™æ‚¨é¢„å®šä¹‰çš„ Jira è§£å†³è¯¥é—®é¢˜çš„ **transition** è€Œé **status**, å¦‚`'Resolve this issue'`.

å…¶ä»–ç–‘éš¾æƒ…å†µ
------

å¦‚æœä½ ç¢°åˆ°å„ç§è¯¡å¼‚çš„æ—¥å¿—, åŸå› å¤§éƒ¨åˆ†éƒ½æ˜¯å› ä¸ºæ²¡æœ‰æ­£ç¡®è®¤è¯ç™»å½•å¯¼è‡´çš„, å…¸å‹çš„æ¯”å¦‚è¿™ä¸ªæŠ¥é”™:

    The value 'XXX' does not exist for the field 'project'.
    

äº‹å®ä¸Šå°±æ˜¯å› ä¸ºæ²¡æœ‰æ­£ç¡®è®¤è¯ç™»å½•å¯¼è‡´çš„.

å…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œ: [Solved: REST error "The value 'XXX' does not exist for the... (atlassian.com)](https://community.atlassian.com/t5/Jira-Software-questions/REST-error-quot-The-value-XXX-does-not-exist-for-the-field/qaq-p/654730)

è¿˜æœ‰ä¸€ç±»æŠ¥é”™, æç¤ºæ‚¨æ— æ³• `transition an issue`, è¿™å¾€å¾€æ˜¯å› ä¸ºä»¥ä¸‹å‡ ç§åŸå› :

1.  Jiralert ä¸­`reopen_state` æˆ– `auto_resolve` çš„ `state` æ²¡æœ‰å¡«å†™æ­£ç¡®çš„ `transition`
2.  æ‚¨ç”¨çš„è´¦å·æ²¡æœ‰ç›¸åº”çš„æƒé™
3.  è¯¥ Issue ç°åœ¨æ‰€å¤„çš„çŠ¶æ€(æ¯”å¦‚ `Closed`)ä¸å…è®¸å†è¿›è¡Œ `transition`

å…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œ: [I can't transition an issue in my Jira project - W... - Atlassian Community](https://community.atlassian.com/t5/Jira-articles/I-can-t-transition-an-issue-in-my-Jira-project-What-now/ba-p/1856945)

æœ€ç»ˆæ•ˆæœ
----

å¦‚ä¸‹å›¾:

![Jiralert æ•ˆæœ](https://img2023.cnblogs.com/other/3034537/202301/3034537-20230104103541823-522365552.png)

å¯ä»¥åˆ›å»º Issue, æ›´æ–° Summary, æ›´æ–° Description, æ›´æ–° Resolution, æ›´æ–° Status; åŒæ ·é—®é¢˜å†æ¬¡å‡ºç°, reopen ä¹‹å‰çš„ Issue...

ğŸ‰ğŸ‰ğŸ‰

ğŸ“šï¸ å‚è€ƒæ–‡æ¡£
--------

*   [jiralert manifests for kubernetes (github.com)](https://gist.github.com/erdii/8db7b5a6356c3d5e023b985b6febd57c)
*   [jiralert/examples at master Â· prometheus-community/jiralert (github.com)](https://github.com/prometheus-community/jiralert/tree/master/examples)
*   [jiralert images | Quay](https://quay.io/repository/jiralert/jiralert-linux-amd64?tab=tags)

> _ä¸‰äººè¡Œ, å¿…æœ‰æˆ‘å¸ˆ; çŸ¥è¯†å…±äº«, å¤©ä¸‹ä¸ºå…¬._ æœ¬æ–‡ç”±ä¸œé£å¾®é¸£æŠ€æœ¯åšå®¢ [EWhisper.cn](https://EWhisper.cn) ç¼–å†™.