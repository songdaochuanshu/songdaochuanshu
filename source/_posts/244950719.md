---
layout: post
title: "ReactæŠ¥é”™ä¹‹Too many re-renders"
date: "2022-12-14T03:20:43.229Z"
---
ReactæŠ¥é”™ä¹‹Too many re-renders
===========================

æ€»è§ˆ
--

äº§ç”Ÿ"Too many re-renders. React limits the number of renders to prevent an infinite loop"é”™è¯¯æœ‰å¤šæ–¹é¢çš„åŸå› ï¼š

1.  åœ¨ä¸€ä¸ªç»„ä»¶çš„æ¸²æŸ“æ–¹æ³•ä¸­è°ƒç”¨ä¸€ä¸ªè®¾ç½®çŠ¶æ€çš„å‡½æ•°ã€‚
2.  ç«‹å³è°ƒç”¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œè€Œä¸æ˜¯ä¼ é€’ä¸€ä¸ªå‡½æ•°ã€‚
3.  æœ‰ä¸€ä¸ªæ— é™è®¾ç½®ä¸é‡æ¸²æŸ“çš„`useEffect`é’©å­ã€‚

![too-many-re-renders-react-limits-the-number.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0f4dfde02264497e894185435e43f6a6~tplv-k3u1fbpfcp-watermark.image?)

è¿™é‡Œæœ‰ä¸ªç¤ºä¾‹æ¥å±•ç¤ºé”™è¯¯æ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼š

    import {useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      // â›”ï¸ Too many re-renders. React limits the number
      // of renders to prevent an infinite loop.
      return (
        <div>
          <button onClick={setCounter(counter + 1)}>Increment</button>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

ä¸Šè¿°ä»£ç é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬åœ¨`onClick`äº‹ä»¶å¤„ç†å™¨ä¸­ç«‹å³è°ƒç”¨äº†`setCounter`å‡½æ•°ã€‚

> è¯¥å‡½æ•°æ˜¯åœ¨é¡µé¢åŠ è½½æ—¶ç«‹å³è¢«è°ƒç”¨ï¼Œè€Œä¸æ˜¯äº‹ä»¶è§¦å‘åè°ƒç”¨ã€‚

ä¼ é€’å‡½æ•°
----

ä¸ºäº†è§£å†³è¯¥é”™è¯¯ï¼Œä¸º`onClick`äº‹ä»¶å¤„ç†å™¨ä¼ é€’å‡½æ•°ï¼Œè€Œä¸æ˜¯ä¼ é€’è°ƒç”¨å‡½æ•°çš„ç»“æœã€‚

    import {useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      return (
        <div>
          <button onClick={() => setCounter(counter + 1)}>Increment</button>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

ç°åœ¨ï¼Œæˆ‘ä»¬ä¸ºäº‹ä»¶å¤„ç†å™¨ä¼ é€’äº†å‡½æ•°ï¼Œè€Œä¸æ˜¯å½“é¡µé¢åŠ è½½æ—¶è°ƒç”¨`setCounter`æ–¹æ³•ã€‚

> å¦‚æœè¯¥æ–¹æ³•åœ¨é¡µé¢åŠ è½½æ—¶è¢«è°ƒç”¨ï¼Œå°±ä¼šè§¦å‘ä¸€ä¸ª`setState`åŠ¨ä½œï¼Œç»„ä»¶å°±ä¼šæ— é™é‡æ–°æ¸²æŸ“ã€‚

å¦‚æœæˆ‘ä»¬è¯•å›¾ç«‹å³è®¾ç½®ä¸€ä¸ªç»„ä»¶çš„çŠ¶æ€ï¼Œè€Œä¸ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶æˆ–äº‹ä»¶å¤„ç†å™¨ï¼Œä¹Ÿä¼šå‘ç”Ÿè¿™ä¸ªé”™è¯¯ã€‚

    import {useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      // â›”ï¸ Too many re-renders. React limits the number
      // of renders to prevent an infinite loop.
      setCounter(counter + 1);
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

é—®é¢˜åœ¨äºï¼Œ`setCounter`å‡½æ•°åœ¨ç»„ä»¶æ¸²æŸ“æ—¶è¢«è°ƒç”¨ã€æ›´æ–°çŠ¶æ€ï¼Œå¹¶å¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œè€Œä¸”æ˜¯æ— é™é‡æ–°æ¸²æŸ“ã€‚

ä½ å¯ä»¥é€šè¿‡å‘`useState()`é’©å­ä¼ é€’ä¸€ä¸ªåˆå§‹å€¼æˆ–ä¸€ä¸ªå‡½æ•°æ¥åˆå§‹åŒ–çŠ¶æ€ï¼Œä»è€Œè§£å†³è¿™ä¸ªé”™è¯¯ã€‚

    import {useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(() => 100 + 100);
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

æˆ‘ä»¬å‘`useState`æ–¹æ³•ä¼ é€’äº†ä¸€ä¸ªå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°åªä¼šåœ¨ç»„ä»¶ç¬¬ä¸€æ¬¡æ¸²æŸ“æ—¶è¢«è°ƒç”¨ï¼Œå¹¶ä¸”ä¼šè®¡ç®—å‡ºåˆå§‹çŠ¶æ€ã€‚ä½ ä¹Ÿå¯ä»¥ç›´æ¥å‘`useState`æ–¹æ³•ä¼ é€’ä¸€ä¸ªåˆå§‹å€¼ã€‚

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥åƒå‰é¢çš„ä¾‹å­é‚£æ ·ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶æˆ–äº‹ä»¶å¤„ç†å™¨ã€‚

    import {useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      // ğŸ‘‡ï¸ your condition here
      if (Math.random() > 0.5) {
        setCounter(counter + 1);
      }
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

> å¦‚æœä½ åƒä¸Šé¢çš„ä¾‹å­é‚£æ ·ä½¿ç”¨ä¸€ä¸ªæ¡ä»¶ï¼Œè¯·ç¡®ä¿è¯¥æ¡ä»¶ä¸æ€»æ˜¯è¿”å›ä¸€ä¸ªçœŸå€¼ï¼Œå› ä¸ºè¿™å°†å¯¼è‡´æ— é™çš„é‡æ–°æ¸²æŸ“å¾ªç¯ã€‚

"Too many re-renders. React limits the number of renders to prevent an infinite loop"é”™è¯¯ä¹Ÿä¼šåœ¨ä½¿ç”¨`useEffect`æ–¹æ³•æ—¶å‘ç”Ÿï¼Œè¯¥æ–¹æ³•çš„ä¾èµ–ä¼šå¯¼è‡´æ— é™é‡æ–°æ¸²æŸ“ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      useEffect(() => {
      // â›”ï¸ Too many re-renders. React limits the number
      // of renders to prevent an infinite loop.
        setCounter(counter + 1);
      }); // ğŸ‘ˆï¸ forgot to pass dependency array
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

ä¸Šè¿°ä»£ç é—®é¢˜åœ¨äºï¼Œæˆ‘ä»¬æ²¡æœ‰ä¸º`useEffect`é’©å­ä¼ é€’ä¾èµ–æ•°ç»„ã€‚

è¿™æ„å‘³ç€è¯¥é’©å­ä¼šåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶è¿è¡Œï¼Œå®ƒä¼šæ›´æ–°ç»„ä»¶çš„çŠ¶æ€ï¼Œç„¶åæ— é™é‡æ–°è¿è¡Œã€‚

ä¼ é€’ä¾èµ–
----

è§£å†³è¯¥é”™è¯¯çš„ä¸€ç§åŠæ³•æ˜¯ï¼Œä¸º`useEffect`æä¾›ç©ºæ•°ç»„ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      useEffect(() => {
        setCounter(counter + 1);
      }, []); // ğŸ‘ˆï¸ empty dependencies array
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

> å¦‚æœä½ ä¸º`useEffect`æ–¹æ³•ä¼ é€’ç©ºæ•°ç»„ä¾èµ–ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œè¯¥æ–¹æ³•åªåœ¨ç»„ä»¶çš„åˆå§‹æ¸²æŸ“æ—¶è¿è¡Œã€‚

è¯¥ä»£ç å°†è®¡æ•°å™¨é€’å¢åˆ°`1`ï¼Œå¹¶ä¸”ä¸å†è¿è¡Œï¼Œæ— è®º`App`ç»„ä»¶æ˜¯å¦è¢«é‡æ–°æ¸²æŸ“ã€‚

å¦‚æœä½ å¿…é¡»æŒ‡å®šä¸€ä¸ªä¾èµ–æ¥æ— é™åœ°é‡æ–°æ¸²æŸ“ä½ çš„ç»„ä»¶ï¼Œè¯•ç€å¯»æ‰¾ä¸€ä¸ªå¯ä»¥é˜²æ­¢è¿™ç§æƒ…å†µçš„æ¡ä»¶ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [counter, setCounter] = useState(0);
    
      useEffect(() => {
        // ğŸ‘‡ï¸ some condition here
        if (Math.random() > 0.5) {
          setCounter(counter + 1);
        }
      }, [counter]);
    
      return (
        <div>
          <h1>Count: {counter}</h1>
        </div>
      );
    }
    

> æœ‰å¯èƒ½æ˜¯æŸäº›é€»è¾‘å†³å®šäº†çŠ¶æ€æ˜¯å¦åº”è¯¥è¢«æ›´æ–°ï¼Œè€ŒçŠ¶æ€ä¸åº”è¯¥åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶è¢«è®¾ç½®ã€‚

ç¡®ä¿ä½ æ²¡æœ‰ä½¿ç”¨ä¸€ä¸ªåœ¨æ¯æ¬¡æ¸²æŸ“æ—¶éƒ½ä¸åŒçš„å¯¹è±¡æˆ–æ•°ç»„ä½œä¸º`useEffect`é’©å­çš„ä¾èµ–ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [address, setAddress] = useState({country: '', city: ''});
    
      const obj = {country: 'Chile', city: 'Santiago'};
    
      useEffect(() => {
        // â›”ï¸ Too many re-renders. React limits the number
        // of renders to prevent an infinite loop.
        setAddress(obj);
        console.log('useEffect called');
      }, [obj]);
    
      return (
        <div>
          <h1>Country: {address.country}</h1>
          <h1>City: {address.city}</h1>
        </div>
      );
    }
    

é—®é¢˜åœ¨äºï¼Œåœ¨JavaScriptä¸­ï¼Œå¯¹è±¡æ˜¯é€šè¿‡å¼•ç”¨è¿›è¡Œæ¯”è¾ƒçš„ã€‚`obj`å˜é‡å­˜å‚¨äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒé”®å€¼å¯¹çš„å¯¹è±¡ï¼Œä½†æ¯æ¬¡æ¸²æŸ“æ—¶çš„å¼•ç”¨ä¸åŒï¼ˆåœ¨å†…å­˜ä¸­çš„ä½ç½®ä¸åŒï¼‰ã€‚

ç§»å…¥ä¾èµ–
----

è§£å†³è¯¥é”™è¯¯çš„ä¸€ç§åŠæ³•æ˜¯ï¼ŒæŠŠè¿™ä¸ªå¯¹è±¡ç§»åˆ°`useEffect`é’©å­é‡Œé¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æŠŠå®ƒä»ä¾èµ–æ•°ç»„ä¸­ç§»é™¤ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [address, setAddress] = useState({country: '', city: ''});
    
      useEffect(() => {
        // ğŸ‘‡ï¸ move object inside of useEffect
        // and remove it from dependencies array
        const obj = {country: 'Chile', city: 'Santiago'};
    
        setAddress(obj);
        console.log('useEffect called');
      }, []);
    
      return (
        <div>
          <h1>Country: {address.country}</h1>
          <h1>City: {address.city}</h1>
        </div>
      );
    }
    

ä¼ é€’å¯¹è±¡å±æ€§
------

å¦ä¸€ä¸ªè§£å†³æ–¹æ¡ˆæ˜¯å°†å¯¹è±¡çš„å±æ€§ä¼ é€’ç»™ä¾èµ–æ•°ç»„ã€‚

    import {useEffect, useState} from 'react';
    
    export default function App() {
      const [address, setAddress] = useState({country: '', city: ''});
    
      const obj = {country: 'Chile', city: 'Santiago'};
    
      useEffect(() => {
    
        setAddress({country: obj.country, city: obj.city});
        console.log('useEffect called');
        // ğŸ‘‡ï¸ object properties instead of the object itself
      }, [obj.country, obj.city]);
    
      return (
        <div>
          <h1>Country: {address.country}</h1>
          <h1>City: {address.city}</h1>
        </div>
      );
    }
    

ç°åœ¨Reactä¸æ˜¯åœ¨æµ‹è¯•ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œæ˜¯åœ¨æµ‹è¯•`obj.country`å’Œ`obj.city`å­—ç¬¦ä¸²åœ¨æ¸²æŸ“ä¹‹é—´æ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ã€‚

è®°å¿†å€¼
---

å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`useMemo`é’©å­æ¥è·å¾—ä¸€ä¸ªåœ¨ä¸åŒæ¸²æŸ“ä¹‹é—´ä¸ä¼šæ”¹å˜çš„è®°å¿†å€¼ã€‚

    import {useEffect, useMemo, useState} from 'react';
    
    export default function App() {
      const [address, setAddress] = useState({country: '', city: ''});
    
      // ğŸ‘‡ï¸ get memoized value
      const obj = useMemo(() => {
        return {country: 'Chile', city: 'Santiago'};
      }, []);
    
      useEffect(() => {
        setAddress(obj);
        console.log('useEffect called');
      }, [obj]);
    
      return (
        <div>
          <h1>Country: {address.country}</h1>
          <h1>City: {address.city}</h1>
        </div>
      );
    }
    

> æˆ‘ä»¬å°†å¯¹è±¡çš„åˆå§‹åŒ–åŒ…è£¹åœ¨`useMemo`é’©å­é‡Œé¢ï¼Œä»¥è·å¾—ä¸€ä¸ªä¸ä¼šåœ¨æ¸²æŸ“ä¹‹é—´æ”¹å˜çš„è®°å¿†å€¼ã€‚

æˆ‘ä»¬ä¼ é€’ç»™`useMemo`é’©å­çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªä¾èµ–æ•°ç»„ï¼Œå®ƒå†³å®šäº†æˆ‘ä»¬ä¼ é€’ç»™`useMemo`çš„å›è°ƒå‡½æ•°ä½•æ—¶è¢«é‡æ–°è¿è¡Œã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°ç»„åœ¨JavaScriptä¸­ä¹Ÿæ˜¯é€šè¿‡å¼•ç”¨è¿›è¡Œæ¯”è¾ƒçš„ã€‚æ‰€ä»¥ä¸€ä¸ªå…·æœ‰ç›¸åŒå€¼çš„æ•°ç»„ä¹Ÿå¯èƒ½å¯¼è‡´ä½ çš„`useEffect`é’©å­è¢«æ— é™æ¬¡è§¦å‘ã€‚

    import {useEffect, useMemo, useState} from 'react';
    
    export default function App() {
      const [nums, setNums] = useState([1, 2, 3]);
    
      const arr = [4, 5, 6];
    
      useEffect(() => {
        // â›”ï¸ Too many re-renders. React limits the number
        // of renders to prevent an infinite loop.
        setNums(arr);
    
        console.log('useEffect called');
      }, [arr]);
    
      return <div>{nums[0]}</div>;
    }
    

æ•°ç»„åœ¨é‡æ–°æ¸²æŸ“ä¹‹é—´å­˜å‚¨ç›¸åŒçš„å€¼ï¼Œä½†æŒ‡å‘å†…å­˜ä¸­çš„ä¸åŒä½ç½®ï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶æœ‰ä¸åŒçš„å¼•ç”¨ã€‚

åœ¨å¤„ç†æ•°ç»„æ—¶ï¼Œæˆ‘ä»¬ç”¨äºå¯¹è±¡çš„æ–¹æ³•åŒæ ·æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`useMemo`é’©å­æ¥è·å¾—ä¸€ä¸ªåœ¨æ¸²æŸ“ä¹‹é—´ä¸ä¼šæ”¹å˜çš„è®°å¿†å€¼ã€‚

    import {useEffect, useMemo, useState} from 'react';
    
    export default function App() {
      const [nums, setNums] = useState([1, 2, 3]);
    
      const arr = useMemo(() => {
        return [4, 5, 6];
      }, []);
    
      useEffect(() => {
        setNums(arr);
        console.log('useEffect called');
      }, [arr]);
    
      return <div>{nums[0]}</div>;
    }
    

æˆ‘ä»¬å°†æ•°ç»„çš„åˆå§‹åŒ–åŒ…è£¹åœ¨`useMemo`é’©å­é‡Œé¢ï¼Œä»¥è·å¾—ä¸€ä¸ªä¸ä¼šåœ¨ä¸åŒæ¸²æŸ“ä¹‹é—´æ”¹å˜çš„è®°å¿†å€¼ã€‚