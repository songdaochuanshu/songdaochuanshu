---
layout: post
title: "å‡çº§äº†Springbootç‰ˆæœ¬åé¡¹ç›®å¯åŠ¨ä¸äº†äº†"
date: "2022-07-17T05:19:10.081Z"
---
å‡çº§äº†Springbootç‰ˆæœ¬åé¡¹ç›®å¯åŠ¨ä¸äº†äº†
=======================

![](https://images.unsplash.com/photo-1501769630498-260b0ac4458d?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxNDY1OTN8MHwxfHNlYXJjaHwxMnx8YW1hemluZ3xlbnwwfDB8fHwxNjU3OTQwNDA1&ixlib=rb-1.2.1&q=100&w=1000)

é—®é¢˜èƒŒæ™¯
----

é¡¹ç›®ä¸Šä½¿ç”¨çš„springbootç‰ˆæœ¬æ˜¯`2.1.1.RELEASE`ï¼Œç°åœ¨å› ä¸ºè¦æ¥å…¥elasticsearch7.xç‰ˆæœ¬ï¼Œå‚è€ƒå®˜æ–¹æ–‡æ¡£è¦æ±‚ï¼Œéœ€è¦å°†springbootç‰ˆæœ¬å‡çº§åˆ°`2.5.14`ã€‚

![springbootä¸elasticsearchç‰ˆæœ¬å¯¹ç…§è¡¨](https://files.mdnice.com/user/23626/dcd3a118-e768-4c96-86ea-a72af2957a00.png)

![springbootç‰ˆæœ¬è¡¨](https://files.mdnice.com/user/23626/88bd2207-093a-4630-bfb4-295f21b00204.png)

æœ¬ä»¥ä¸ºæ˜¯æ”¹ä¸€ä¸‹ç‰ˆæœ¬å·çš„äº‹ï¼Œä½†æ˜¯å‡çº§ä¹‹åå‘ç°æœåŠ¡å¯åŠ¨æŠ¥é”™äº†ğŸ˜±ã€‚  
![](https://files.mdnice.com/user/23626/74fa51e9-afb3-4128-bdb4-0af2cea266d2.png)

* * *

é—®é¢˜åŸå› 
----

`Caused by: org.quartz.SchedulerConfigException: DataSource name not set.`ä»é”™è¯¯ä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼ŒæŠ¥é”™ä¸`quartz`æœ‰å…³ï¼Œæˆ‘ä»¬å…ˆæ¥é¡ºç€å¼‚å¸¸æ ˆçœ‹ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯`JobStoreSupport.initialize()`æ–¹æ³•ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼š

    public void initialize(ClassLoadHelper loadHelper,
            SchedulerSignaler signaler) throws SchedulerConfigException {
    
        if (dsName == null) { 
            throw new SchedulerConfigException("DataSource name not set."); 
        }
        
        ...
    }
    

å‘ä¸Šæº¯æºå¯ä»¥å‘ç°ï¼Œå…¶åˆå§‹è°ƒç”¨æ–¹æ˜¯è¿™é‡Œï¼š

![](https://files.mdnice.com/user/23626/5dd989a5-3993-480a-9d58-2bd3ec37cf01.png)

é‚£ä¹ˆè¿™ä¸ª`js`å¯¹è±¡æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ª`JobStore`å®ä¾‹ï¼Œè€Œ`JobStore`å…¶å®æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæœ‰å¤šä¸ªå®ç°ç±»ï¼š

![](https://files.mdnice.com/user/23626/276e921d-db18-48fd-a740-0c5216852e69.png)

æˆ‘ä»¬å…ˆæ¥æ‰“æ–­ç‚¹çœ‹çœ‹ï¼Œè¿™é‡Œå®é™…ä½¿ç”¨åˆ°çš„æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ï¼Œå…ˆå°†springbootç‰ˆæœ¬æ”¹å›åˆ°`2.1.1.RELEASE`çœ‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„æ˜¯`LocalDataSourceJobStore`ï¼Œè€Œå½“æˆ‘ä»¬ä½¿ç”¨springboot`2.5.14`ç‰ˆæœ¬æ—¶ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`JobStoreTX`æ˜¯å®ä¾‹åŒ–å¯¹è±¡ã€‚

![](https://files.mdnice.com/user/23626/35b6bdc6-d8fb-4946-862c-f3b0a33e12b8.png)

é‚£ä¹ˆï¼Œæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´ä¸¤ä¸ªç‰ˆæœ¬ä½¿ç”¨äº†ä¸åŒçš„`JobStore`å®ç°ç±»å‘¢ï¼Ÿå…ˆæ¥çœ‹çœ‹`js`å¯¹è±¡æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ï¼šé¦–å…ˆè·å–`org.quartz.jobStore.class`å±æ€§å€¼ï¼Œç„¶åé€šè¿‡åå°„å®ä¾‹åŒ–`js`å¯¹è±¡ã€‚

æ˜¾ç„¶ï¼Œåœ¨ä¸åŒç‰ˆæœ¬ä¸‹ï¼Œè¿™é‡Œè·å–åˆ°çš„`org.quartz.jobStore.class`å±æ€§å€¼ä¸ä¸€è‡´å¯¼è‡´äº†åˆ›å»ºäº†ä¸åŒçš„`JobStore`å®ç°ç±»ã€‚

![](https://files.mdnice.com/user/23626/6c5234fd-0acd-4bdb-a9c1-e3e90314449a.png)

æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹é¡¹ç›®ä¸­ä¸`quartz`ç›¸å…³çš„é…ç½®ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ª`SchedulerFactoryBean`çš„åˆå§‹åŒ–æ“ä½œ ï¼Œå…¶ä¸­è®¾ç½®`org.quartz.jobStore.class`å±æ€§å€¼ä¸º`org.quartz.impl.jdbcjobstore.JobStoreTX`ï¼Œä½†æ˜¯ä»ä¸Šé¢åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨çœŸæ­£åˆ›å»º`JobStore`å®ç°ç±»æ—¶ï¼Œè¿™ä¸ªå±æ€§å€¼å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œç”±æ­¤è¯´æ˜è¿™ä¸ªå€¼åœ¨åæœŸè¢«æ›´æ”¹è¿‡ã€‚

    @Configuration
    public class ScheduleConfig
    {
        @Bean
        public SchedulerFactoryBean schedulerFactoryBean(DataSource dataSource)
        {
            SchedulerFactoryBean factory = new SchedulerFactoryBean();
            factory.setDataSource(dataSource);
    
            Properties prop = new Properties();
            prop.put("org.quartz.scheduler.instanceName", "MyScheduler");
            prop.put("org.quartz.scheduler.instanceId", "AUTO");
            prop.put("org.quartz.threadPool.class", "org.quartz.simpl.SimpleThreadPool");
            prop.put("org.quartz.threadPool.threadCount", "20");
            prop.put("org.quartz.threadPool.threadPriority", "5");
            
            // è¿™é‡Œè®¾ç½®org.quartz.jobStore.classå±æ€§å€¼ä¸ºorg.quartz.impl.jdbcjobstore.JobStoreTX
            prop.put("org.quartz.jobStore.class", "org.quartz.impl.jdbcjobstore.JobStoreTX");
            prop.put("org.quartz.jobStore.isClustered", "true");
            prop.put("org.quartz.jobStore.clusterCheckinInterval", "15000");
            prop.put("org.quartz.jobStore.maxMisfiresToHandleAtATime", "1");
            prop.put("org.quartz.jobStore.txIsolationLevelSerializable", "true");
            prop.put("org.quartz.jobStore.misfireThreshold", "12000");
            prop.put("org.quartz.jobStore.tablePrefix", "QRTZ_");
            factory.setQuartzProperties(prop);
    
            factory.setSchedulerName("MyScheduler");
    
            factory.setStartupDelay(1);
            factory.setApplicationContextSchedulerContextKey("applicationContext");
            factory.setOverwriteExistingJobs(true);
            factory.setAutoStartup(true);
    
            return factory;
        }
    }
    

è€Œæˆ‘ä»¬ä»å¼‚å¸¸æ ˆä¸­å¯ä»¥å‘ç°ï¼Œ`SchedulerFactoryBean`åœ¨å®Œæˆåˆå§‹åŒ–æ“ä½œä¹‹åï¼Œæ‰§è¡Œäº†`afterPropertiesSet()`æ–¹æ³•ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ä¸­åšäº†å“ªäº›äº‹æƒ…ï¼š

    public void afterPropertiesSet() throws Exception {
      if (this.dataSource == null && this.nonTransactionalDataSource != null) {
        this.dataSource = this.nonTransactionalDataSource;
      }
    
      if (this.applicationContext != null && this.resourceLoader == null) {
        this.resourceLoader = this.applicationContext;
      }
    
      // Initialize the Scheduler instance...
      // å…ˆæ¥çœ‹çœ‹this.prepareSchedulerFactory()æ–¹æ³•ä¸­åšäº†ä»€ä¹ˆ
      this.scheduler = this.prepareScheduler(this.prepareSchedulerFactory());
    
      try {
        this.registerListeners();
        this.registerJobsAndTriggers();
      } catch (Exception var4) {
        try {
          this.scheduler.shutdown(true);
        } catch (Exception var3) {
          this.logger.debug("Scheduler shutdown exception after registration failure", var3);
        }
    
        throw var4;
      }
    }
    
    
    /**
     * Create a SchedulerFactory if necessary and apply locally defined Quartz properties to it.
     * @return the initialized SchedulerFactory
     */
    private SchedulerFactory prepareSchedulerFactory() throws SchedulerException, IOException {
      SchedulerFactory schedulerFactory = this.schedulerFactory;
      if (schedulerFactory == null) {
        // Create local SchedulerFactory instance (typically a StdSchedulerFactory)
        schedulerFactory = BeanUtils.instantiateClass(this.schedulerFactoryClass);
        if (schedulerFactory instanceof StdSchedulerFactory) {
          // é‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªSchedulerFactoryåˆå§‹åŒ–æ–¹æ³•
          initSchedulerFactory((StdSchedulerFactory) schedulerFactory);
        }
        else if (this.configLocation != null || this.quartzProperties != null ||
            this.taskExecutor != null || this.dataSource != null) {
          throw new IllegalArgumentException(
              "StdSchedulerFactory required for applying Quartz properties: " + schedulerFactory);
        }
        // Otherwise, no local settings to be applied via StdSchedulerFactory.initialize(Properties)
      }
      // Otherwise, assume that externally provided factory has been initialized with appropriate settings
      return schedulerFactory;
    }
    
    

æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥`initSchedulerFactory()`æ–¹æ³•å†…éƒ¨çœ‹çœ‹å…·ä½“éƒ½æœ‰å“ªäº›é€»è¾‘ï¼Œè¿™æ˜¯ä¸€ä¸ª`SchedulerFactory`åˆå§‹åŒ–æ–¹æ³•ï¼Œå®ƒä¼šåº”ç”¨`Quartz`çš„ä¸€äº›æœ¬åœ°é…ç½®å±æ€§ç”¨äº`SchedulerFactory`åˆå§‹åŒ–ï¼š

    /**
     * Initialize the given SchedulerFactory, applying locally defined Quartz properties to it.
     * @param schedulerFactory the SchedulerFactory to initialize
     */
    private void initSchedulerFactory(StdSchedulerFactory schedulerFactory) throws SchedulerException, IOException {
      Properties mergedProps = new Properties();
      if (this.resourceLoader != null) {
        mergedProps.setProperty(StdSchedulerFactory.PROP_SCHED_CLASS_LOAD_HELPER_CLASS,
            ResourceLoaderClassLoadHelper.class.getName());
      }
    
      if (this.taskExecutor != null) {
        mergedProps.setProperty(StdSchedulerFactory.PROP_THREAD_POOL_CLASS,
            LocalTaskExecutorThreadPool.class.getName());
      }
      else {
        // Set necessary default properties here, as Quartz will not apply
        // its default configuration when explicitly given properties.
        mergedProps.setProperty(StdSchedulerFactory.PROP_THREAD_POOL_CLASS, SimpleThreadPool.class.getName());
        mergedProps.setProperty(PROP_THREAD_COUNT, Integer.toString(DEFAULT_THREAD_COUNT));
      }
    
      if (this.configLocation != null) {
        if (logger.isDebugEnabled()) {
          logger.debug("Loading Quartz config from [" + this.configLocation + "]");
        }
        PropertiesLoaderUtils.fillProperties(mergedProps, this.configLocation);
      }
    
      CollectionUtils.mergePropertiesIntoMap(this.quartzProperties, mergedProps);
      if (this.dataSource != null) {
        // é‡ç‚¹æ¥äº†ï¼Œå¦‚æœæœªè®¾ç½®"org.quartz.jobStore.class"å±æ€§ï¼Œå°±å°†å…¶è®¾ç½®ä¸º"org.springframework.scheduling.quartz.LocalDataSourceJobStore"
        mergedProps.putIfAbsent(StdSchedulerFactory.PROP_JOB_STORE_CLASS, LocalDataSourceJobStore.class.getName());
      }
    
      // Determine scheduler name across local settings and Quartz properties...
      if (this.schedulerName != null) {
        mergedProps.setProperty(StdSchedulerFactory.PROP_SCHED_INSTANCE_NAME, this.schedulerName);
      }
      else {
        String nameProp = mergedProps.getProperty(StdSchedulerFactory.PROP_SCHED_INSTANCE_NAME);
        if (nameProp != null) {
          this.schedulerName = nameProp;
        }
        else if (this.beanName != null) {
          mergedProps.setProperty(StdSchedulerFactory.PROP_SCHED_INSTANCE_NAME, this.beanName);
          this.schedulerName = this.beanName;
        }
      }
    
      schedulerFactory.initialize(mergedProps);
    }
    

ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬é…ç½®äº†`org.quartz.jobStore.class`å±æ€§æ—¶ï¼Œåœ¨springboot`2.5.14`ç‰ˆæœ¬ä¸­ä¼šä»¥æˆ‘ä»¬ä»£ç ä¸­é…ç½®çš„ä¸ºå‡†ï¼Œä¹Ÿå°±æ˜¯`org.quartz.impl.jdbcjobstore.JobStoreTX`ã€‚

å†æ¥çœ‹ä¸€ä¸‹springboot`2.1.1.RELEASE`ç‰ˆæœ¬ä¸­æ­¤å¤„çš„é€»è¾‘ï¼Œå®ƒä¼šç›´æ¥æŠŠ`org.quartz.jobStore.class`å±æ€§å€¼è®¾ç½®ä¸º`org.springframework.scheduling.quartz.LocalDataSourceJobStore`ï¼Œä¸å…³å¿ƒä¹‹å‰æœ‰æ²¡æœ‰è®¾ç½®è¿‡è¯¥å€¼ã€‚

![](https://files.mdnice.com/user/23626/1e51d8db-8e6d-4bcc-8fb4-7c749a3260c4.png)

* * *

è§£å†³æ–¹æ¡ˆ
----

æ˜ç™½äº†é—®é¢˜çš„ç—‡ç»“æ‰€åœ¨ï¼Œè§£å†³èµ·æ¥å°±ç›¸å½“å®¹æ˜“äº†ï¼Œä¸¤ç§æ–¹å¼ï¼š

*   å»æ‰`ScheduleConfig`é…ç½®ç±»ä¸­`SchedulerFactoryBean`å¯¹è±¡çš„`org.quartz.jobStore.class`å±æ€§é…ç½®ï¼Œäº¤ç”±`SchedulerFactoryBean#initSchedulerFactor`å»è®¾ç½®ã€‚
*   ç›´æ¥å°†`ScheduleConfig`é…ç½®ç±»ä¸­`SchedulerFactoryBean`å¯¹è±¡çš„`org.quartz.jobStore.class`å±æ€§å€¼è®¾ç½®ä¸º`LocalDataSourceJobStore.class.getName()`ã€‚

å†æ¬¡å¯åŠ¨æœåŠ¡ï¼Œå¤§åŠŸå‘ŠæˆâœŒï¸ã€‚

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[ClockTicking](https://www.cnblogs.com/mindforward/)ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/mindforward/p/16486148.html](https://www.cnblogs.com/mindforward/p/16486148.html)