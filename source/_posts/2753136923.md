---
layout: post
title: "ä½¿ç”¨JAVA CompletableFutureå®ç°æµæ°´çº¿åŒ–çš„å¹¶è¡Œå¤„ç†ï¼Œæ·±åº¦å®è·µæ€»ç»“"
date: "2022-07-25T04:51:09.172Z"
---
ä½¿ç”¨JAVA CompletableFutureå®ç°æµæ°´çº¿åŒ–çš„å¹¶è¡Œå¤„ç†ï¼Œæ·±åº¦å®è·µæ€»ç»“
==========================================

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œç”±äºä¸šåŠ¡è§„åˆ’åŸå› ï¼Œç»å¸¸ä¼šæ¶‰åŠåˆ°èšåˆä¿¡æ¯å¤„ç†ç±»çš„åœºæ™¯ï¼ŒæŒ‰ç…§ç¯èŠ‚ä¸²è¡Œæ‰§è¡Œçš„æ—¶å€™å¾€å¾€æœ€ç»ˆå“åº”è€—æ—¶å¾ˆé•¿ï¼ŒJAVAå¯¹å¹¶è¡Œçš„å¤„ç†åœºæ™¯æ”¯æŒå·²ç»å¾ˆå®Œå–„äº†ï¼Œæœ¬æ–‡æ·±åº¦æ€»ç»“äº†åº”å¯¹ç­–ç•¥ï¼Œå¿«æ¥çœ‹çœ‹å§~

å¤§å®¶å¥½ï¼Œåˆè§é¢å•¦ã€‚

åœ¨é¡¹ç›®å¼€å‘ä¸­ï¼Œåç«¯æœåŠ¡å¯¹å¤–æä¾›**APIæ¥å£**ä¸€èˆ¬éƒ½ä¼šå…³æ³¨`å“åº”æ—¶é•¿`ã€‚ä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œç”±äºä¸šåŠ¡è§„åˆ’é€»è¾‘çš„åŸå› ï¼Œæˆ‘ä»¬çš„æ¥å£å¯èƒ½ä¼šæ˜¯ä¸€ä¸ª**èšåˆä¿¡æ¯å¤„ç†**ç±»çš„å¤„ç†é€»è¾‘ï¼Œæ¯”å¦‚æˆ‘ä»¬ä»å¤šä¸ªä¸åŒçš„åœ°æ–¹è·å–æ•°æ®ï¼Œç„¶åæ±‡æ€»å¤„ç†ä¸ºæœ€ç»ˆçš„ç»“æœå†è¿”å›ç»™è°ƒç”¨æ–¹ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå¾€å¾€ä¼šå¯¼è‡´æˆ‘ä»¬çš„æ¥å£å“åº”ç‰¹åˆ«çš„æ…¢ã€‚

è€Œå¦‚æœæˆ‘ä»¬æƒ³è¦åŠ¨æ‰‹è¿›è¡Œä¼˜åŒ–çš„æ—¶å€™å‘¢ï¼Œå°±ä¼šæ¶‰åŠåˆ°`ä¸²è¡Œ`å¤„ç†æ”¹`å¹¶è¡Œ`å¤„ç†çš„é—®é¢˜ã€‚åœ¨`JAVA`ä¸­å¹¶è¡Œå¤„ç†çš„èƒ½åŠ›æ”¯æŒå·²ç»ç›¸å¯¹å®Œå–„ï¼Œé€šè¿‡å¯¹CompletableFutureçš„åˆç†åˆ©ç”¨ï¼Œå¯ä»¥è®©æˆ‘ä»¬é¢å¯¹è¿™ç§èšåˆç±»å¤„ç†çš„åœºæ™¯ä¼šæ›´åŠ çš„å¾—å¿ƒåº”æ‰‹ã€‚

å¥½å•¦ï¼Œè¯ä¸å¤šè¯´ï¼Œæ¥ä¸‹æ¥å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥å“å°ä¸‹JAVAä¸­ç»„åˆå¼å¹¶è¡Œå¤„ç†è¿™é“é¥•é¤®å¤§é¤å§ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658562407079-21de6ff4-db3b-474c-a6de-2064ecd3ee48.png#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=681&id=u29539c69&name=image.png&originHeight=681&originWidth=1383&originalType=binary&ratio=1&rotation=0&showTitle=false&size=83604&status=done&style=none&taskId=ude25c253-f0cf-4925-a0fc-2afc7e4c011&title=&width=1383)

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561774101-b891b6e8-dd26-4848-adf3-356cf0636c20.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=muons&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9b3478b6-f699-47ea-8dda-6b9a1d5405e&title=)

å‰èœï¼šå…ˆçœ‹ä¸ªå®é™…åœºæ™¯
----------

åœ¨å¼€å§‹äº«ç”¨è¿™é¡¿å¤§é¤å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ä¸ªå‰èœå¼€å¼€èƒƒã€‚

ä¾‹å¦‚ç°åœ¨æœ‰è¿™ä¹ˆä¸ªéœ€æ±‚ï¼š

> **éœ€æ±‚æè¿°**ï¼š  
> å®ç°ä¸€ä¸ªå…¨ç½‘æ¯”ä»·æœåŠ¡ï¼Œæ¯”å¦‚å¯ä»¥ä»æŸå®ã€æŸä¸œã€æŸå¤•å¤•å»è·å–æŸä¸ªå•†å“çš„ä»·æ ¼ã€ä¼˜æƒ é‡‘é¢ï¼Œå¹¶è®¡ç®—å‡ºå®é™…ä»˜æ¬¾é‡‘é¢ï¼Œæœ€ç»ˆè¿”å›ä»·æ ¼æœ€ä¼˜çš„å¹³å°ä¸ä»·æ ¼ä¿¡æ¯ã€‚

ğŸ“¢è¿™é‡Œå‡å®šæ¯ä¸ªå¹³å°è·å–åŸä»·æ ¼ä¸ä¼˜æƒ åˆ¸çš„æ¥å£å·²ç»å®ç°ã€ä¸”éƒ½æ˜¯éœ€è¦è°ƒç”¨HTTPæ¥å£æŸ¥è¯¢çš„è€—æ—¶æ“ä½œï¼ŒMockæ¥å£æ¯ä¸ªè€—æ—¶`1s`å·¦å³ã€‚

æ ¹æ®æœ€åˆçš„éœ€æ±‚ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶çš„å†™å‡ºå¯¹åº”å®ç°ä»£ç ï¼š

    public PriceResult getCheapestPlatAndPrice(String product) {
        // è·å–æŸå®çš„ä»·æ ¼ä»¥åŠä¼˜æƒ ï¼Œå¹¶è®¡ç®—æœ€ç»ˆå®ä»˜ä»·æ ¼
        PriceResult mouBaoPrice = computeRealPrice(HttpRequestMock.getMouBaoPrice(product),
                HttpRequestMock.getMouBaoDiscounts(product));
        // è·å–æŸä¸œçš„ä»·æ ¼ä»¥åŠä¼˜æƒ ï¼Œå¹¶è®¡ç®—æœ€ç»ˆå®ä»˜ä»·æ ¼
        PriceResult mouDongPrice = computeRealPrice(HttpRequestMock.getMouDongPrice(product),
                HttpRequestMock.getMouDongDiscounts(product));
        // è·å–æŸå¤•å¤•çš„ä»·æ ¼ä»¥åŠä¼˜æƒ ï¼Œå¹¶è®¡ç®—æœ€ç»ˆå®ä»˜ä»·æ ¼
        PriceResult mouXiXiPrice = computeRealPrice(HttpRequestMock.getMouXiXiPrice(product),
                HttpRequestMock.getMouXiXiDiscounts(product));
    
        // è®¡ç®—å¹¶é€‰å‡ºå®é™…ä»·æ ¼æœ€ä½çš„å¹³å°
        return Stream.of(mouBaoPrice, mouDongPrice, mouXiXiPrice).
                min(Comparator.comparingInt(PriceResult::getRealPrice))
                .get();
    }
    

ä¸€åˆ‡é¡ºåˆ©æˆç« ï¼Œè¿è¡Œæµ‹è¯•ä¸‹ï¼š

    05:24:53.759[main|1]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼
    05:24:54.779[main|1]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5199
    05:24:54.779[main|1]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ 
    05:24:55.781[main|1]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -200
    05:24:55.781[main|1]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    05:24:55.781[main|1]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼
    05:24:56.784[main|1]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5299
    05:24:56.784[main|1]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ 
    05:24:57.786[main|1]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -150
    05:24:57.786[main|1]æŸä¸œæœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š5149
    05:24:57.786[main|1]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼
    05:24:58.788[main|1]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5399
    05:24:58.788[main|1]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ 
    05:24:59.791[main|1]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -5300
    05:24:59.791[main|1]æŸå¤•å¤•æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š99
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå¤•å¤•, åŸä»·ï¼š5399, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š99ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 6122ms  ------
    

ç»“æœç¬¦åˆé¢„æœŸï¼ŒåŠŸèƒ½ä¸€åˆ‡æ­£å¸¸ï¼Œå°±æ˜¯è€—æ—¶é•¿äº†ç‚¹ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚ä½ åœ¨æŸä¸ªAPPæ“ä½œæŸ¥è¯¢çš„æ—¶å€™ï¼Œç­‰å¾…6sæ‰è¿”å›ç»“æœï¼Œ**ä¼°è®¡ä¼šç›´æ¥æŠŠAPPç»™å¸è½½äº†å§**ï¼Ÿ

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561789217-f9286c07-be19-4573-9770-01385e5d09a2.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=ndaJg&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub647c5cd-a03a-4fb3-87ba-eb1b6ed350a&title=)

æ¢³ç†ä¸‹å‰é¢ä»£ç çš„å®ç°æ€è·¯ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658459306213-1117bbc3-c4cb-42d9-a94d-c6fa70a78d40.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=330&id=u6a521511&margin=%5Bobject%20Object%5D&name=image.png&originHeight=330&originWidth=820&originalType=binary&ratio=1&rotation=0&showTitle=false&size=30054&status=done&style=none&taskId=u38f1e4fd-8518-44fe-a11e-9b47078d549&title=&width=820)

æ‰€æœ‰çš„ç¯èŠ‚éƒ½æ˜¯`ä¸²è¡Œ`çš„ï¼Œæ¯ä¸ªç¯èŠ‚è€—æ—¶åŠ åˆ°ä¸€èµ·ï¼Œæ¥å£æ€»è€—æ—¶è‚¯å®šå¾ˆé•¿ã€‚

ä½†å®é™…ä¸Šï¼Œæ¯ä¸ªå¹³å°ä¹‹é—´çš„æ“ä½œæ˜¯**äº’ä¸å¹²æ‰°**çš„ï¼Œé‚£æˆ‘ä»¬è‡ªç„¶è€Œç„¶çš„å¯ä»¥æƒ³åˆ°ï¼Œå¯ä»¥é€šè¿‡`å¤šçº¿ç¨‹`çš„æ–¹å¼ï¼ŒåŒæ—¶å»åˆ†åˆ«æ‰§è¡Œå„ä¸ªå¹³å°çš„é€»è¾‘å¤„ç†ï¼Œæœ€åå°†å„ä¸ªå¹³å°çš„ç»“æœæ±‡æ€»åˆ°ä¸€èµ·æ¯”å¯¹å¾—åˆ°æœ€ä½ä»·æ ¼ã€‚

æ‰€ä»¥æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¼šå˜æˆå¦‚ä¸‹çš„æ•ˆæœï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658459400093-978b3445-9023-4260-a595-31d987decb37.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=275&id=ueef4acea&margin=%5Bobject%20Object%5D&name=image.png&originHeight=275&originWidth=862&originalType=binary&ratio=1&rotation=0&showTitle=false&size=35382&status=done&style=none&taskId=u4d980d10-5cde-4752-9651-d6d475bd471&title=&width=862)

ä¸ºäº†æå‡æ€§èƒ½ï¼Œæˆ‘ä»¬é‡‡ç”¨**çº¿ç¨‹æ± **æ¥è´Ÿè´£å¤šçº¿ç¨‹çš„å¤„ç†æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¾—åˆ°å„ä¸ªå­çº¿ç¨‹å¤„ç†çš„ç»“æœï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨ `Future`æ¥å®ç°ï¼š

    public PriceResult getCheapestPlatAndPrice2(String product) {
        Future<PriceResult> mouBaoFuture =
            threadPool.submit(() -> computeRealPrice(HttpRequestMock.getMouBaoPrice(product),
                                                     HttpRequestMock.getMouBaoDiscounts(product)));
        Future<PriceResult> mouDongFuture =
            threadPool.submit(() -> computeRealPrice(HttpRequestMock.getMouDongPrice(product),
                                                     HttpRequestMock.getMouDongDiscounts(product)));
        Future<PriceResult> mouXiXiFuture =
            threadPool.submit(() -> computeRealPrice(HttpRequestMock.getMouXiXiPrice(product),
                                                     HttpRequestMock.getMouXiXiDiscounts(product)));
        
        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æœéƒ½å¤„ç†å®Œæˆï¼Œç„¶åä»ç»“æœä¸­è®¡ç®—å‡ºæœ€ä½ä»·
        return Stream.of(mouBaoFuture, mouDongFuture, mouXiXiFuture)
            .map(priceResultFuture -> {
                try {
                    return priceResultFuture.get(5L, TimeUnit.SECONDS);
                } catch (Exception e) {
                    return null;
                }
            })
            .filter(Objects::nonNull)
            .min(Comparator.comparingInt(PriceResult::getRealPrice))
            .get();
    }
    

ä¸Šè¿°ä»£ç ä¸­ï¼Œå°†ä¸‰ä¸ªä¸åŒå¹³å°å¯¹åº”çš„`Callable`å‡½æ•°é€»è¾‘æ”¾å…¥åˆ°`ThreadPool`ä¸­å»æ‰§è¡Œï¼Œè¿”å›`Future`å¯¹è±¡ï¼Œç„¶åå†é€ä¸ªé€šè¿‡`Future.get()`æ¥å£**é˜»å¡**è·å–å„è‡ªå¹³å°çš„ç»“æœï¼Œæœ€åç»æ¯”è¾ƒå¤„ç†åè¿”å›æœ€ä½ä»·ä¿¡æ¯ã€‚

æ‰§è¡Œä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œç»“æœä¸è¿‡ç¨‹å¦‚ä¸‹ï¼š

    05:42:24.270[pool-1-thread-1|12]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼
    05:42:24.270[pool-1-thread-2|13]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼
    05:42:24.270[pool-1-thread-3|14]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼
    05:42:25.291[pool-1-thread-2|13]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5299
    05:42:25.291[pool-1-thread-3|14]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5399
    05:42:25.291[pool-1-thread-1|12]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5199
    05:42:25.291[pool-1-thread-2|13]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ 
    05:42:25.291[pool-1-thread-3|14]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ 
    05:42:25.291[pool-1-thread-1|12]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ 
    05:42:26.294[pool-1-thread-2|13]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -150
    05:42:26.294[pool-1-thread-3|14]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -5300
    05:42:26.294[pool-1-thread-1|12]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -200
    05:42:26.294[pool-1-thread-2|13]æŸä¸œæœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š5149
    05:42:26.294[pool-1-thread-3|14]æŸå¤•å¤•æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š99
    05:42:26.294[pool-1-thread-1|12]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå¤•å¤•, åŸä»·ï¼š5399, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š99ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 2119ms  ------
    

ç»“æœä¸ç¬¬ä¸€ç§å®ç°æ–¹å¼ä¸€è‡´ï¼Œä½†æ˜¯æ¥å£æ€»è€—æ—¶ä»`6s`ä¸‹é™åˆ°äº†`2s`ï¼Œæ•ˆæœè¿˜æ˜¯å¾ˆæ˜¾è‘—çš„ã€‚ä½†æ˜¯ï¼Œæ˜¯å¦è¿˜èƒ½å†å‹ç¼©ä¸€äº›å‘¢ï¼Ÿ

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561804126-dc4fff19-e8ce-4635-ac1c-12961bdb7924.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=AU4uG&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u09037fa5-14ff-4fc6-ab72-bac77986d43&title=)

åŸºäºä¸Šé¢æŒ‰ç…§å¹³å°æ‹†åˆ†å¹¶è¡Œå¤„ç†çš„æ€è·¯ç»§ç»­æ¨è¿›ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¯ä¸ªå¹³å°å†…çš„å¤„ç†é€»è¾‘å…¶å®å¯ä»¥åˆ†ä¸º3ä¸ªä¸»è¦æ­¥éª¤ï¼š

1.  è·å–åŸå§‹ä»·æ ¼ï¼ˆè€—æ—¶æ“ä½œï¼‰
2.  è·å–æŠ˜æ‰£ä¼˜æƒ ï¼ˆè€—æ—¶æ“ä½œï¼‰
3.  å¾—åˆ°åŸå§‹ä»·æ ¼å’ŒæŠ˜æ‰£ä¼˜æƒ ä¹‹åï¼Œè®¡ç®—å®ä»˜ä»·æ ¼

è¿™3ä¸ªæ­¥éª¤ä¸­ï¼Œç¬¬1ã€2ä¸¤ä¸ªè€—æ—¶æ“ä½œä¹Ÿæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œå¦‚æœä¹Ÿèƒ½å¹¶è¡Œå¤„ç†çš„è¯ï¼Œå“åº”æ—¶é•¿ä¸Šåº”è¯¥åˆä¼šç¼©çŸ­ä¸€äº›ï¼Œå³å¦‚ä¸‹çš„å¤„ç†æµç¨‹ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658459603832-5a6375d4-f416-45cd-b124-d6519000f635.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=350&id=u49b41863&margin=%5Bobject%20Object%5D&name=image.png&originHeight=350&originWidth=772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39334&status=done&style=none&taskId=u8e165287-2e9b-438d-8319-00fb384a8a1&title=&width=772)

æˆ‘ä»¬å½“ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨ä¸Šé¢æåˆ°çš„`çº¿ç¨‹æ± +Future`çš„æ–¹å¼ï¼Œä½†`Future`åœ¨åº”å¯¹å¹¶è¡Œç»“æœç»„åˆä»¥åŠåç»­å¤„ç†ç­‰æ–¹é¢æ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼Œ**å¼Šç«¯**æ˜æ˜¾ï¼š

> ä»£ç å†™èµ·æ¥ä¼š**éå¸¸æ‹–æ²“**ï¼šå…ˆå°è£…`Callable`å‡½æ•°æ”¾åˆ°çº¿ç¨‹æ± ä¸­å»æ‰§è¡ŒæŸ¥è¯¢æ“ä½œï¼Œç„¶ååˆ†ä¸‰ç»„`é˜»å¡ç­‰å¾…`ç»“æœå¹¶è®¡ç®—å‡ºå„è‡ªç»“æœï¼Œæœ€åå†`é˜»å¡ç­‰å¾…`ä»·æ ¼è®¡ç®—å®Œæˆåæ±‡æ€»å¾—åˆ°æœ€ç»ˆç»“æœã€‚

è¯´åˆ°è¿™é‡Œå‘¢ï¼Œå°±éœ€è¦æˆ‘ä»¬æ–°çš„ä¸»äººå…¬`CompletableFuture`ç™»åœºäº†ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥å¾ˆè½»æ¾çš„æ¥å®Œæˆä»»åŠ¡çš„å¹¶è¡Œå¤„ç†ï¼Œä»¥åŠå„ä¸ªå¹¶è¡Œä»»åŠ¡ç»“æœä¹‹é—´çš„ç»„åˆå†å¤„ç†ç­‰æ“ä½œã€‚æˆ‘ä»¬ä½¿ç”¨`CompletableFuture`ç¼–å†™å®ç°ä»£ç å¦‚ä¸‹ï¼š

    public PriceResult getCheapestPlatAndPrice3(String product) {
        // è·å–å¹¶è®¡ç®—æŸå®çš„æœ€ç»ˆä»·æ ¼
        CompletableFuture<PriceResult> mouBao =
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoPrice(product))
                        .thenCombine(CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoDiscounts(product)),
                                this::computeRealPrice);
        // è·å–å¹¶è®¡ç®—æŸå®çš„æœ€ç»ˆä»·æ ¼
        CompletableFuture<PriceResult> mouDong =
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouDongPrice(product))
                        .thenCombine(CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouDongDiscounts(product)),
                                this::computeRealPrice);
        // è·å–å¹¶è®¡ç®—æŸå®çš„æœ€ç»ˆä»·æ ¼
        CompletableFuture<PriceResult> mouXiXi =
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiPrice(product))
                        .thenCombine(CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiDiscounts(product)),
                                this::computeRealPrice);
    
        // æ’åºå¹¶è·å–æœ€ä½ä»·æ ¼
        return Stream.of(mouBao, mouDong, mouXiXi)
                .map(CompletableFuture::join)
                .sorted(Comparator.comparingInt(PriceResult::getRealPrice))
                .findFirst()
                .get();
    }
    

çœ‹ä¸‹æ‰§è¡Œç»“æœç¬¦åˆé¢„æœŸï¼Œè€Œæ¥å£è€—æ—¶åˆ™é™åˆ°äº†`1s`ï¼ˆå› ä¸ºæˆ‘ä»¬ä¾èµ–çš„æ¯ä¸€ä¸ªæŸ¥è¯¢å®é™…æ“ä½œçš„æ¥å£è€—æ—¶éƒ½æ˜¯æ¨¡æ‹Ÿçš„1sï¼Œæ‰€ä»¥è¿™ä¸ªç»“æœå·²ç»ç®—æ˜¯æ­¤å¤åˆæ¥å£èƒ½è¾¾åˆ°çš„æé™å€¼äº†ï¼‰ã€‚

    06:01:12.334[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼
    06:01:12.334[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ 
    06:01:12.334[ForkJoinPool.commonPool-worker-11|14]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼
    06:01:12.334[ForkJoinPool.commonPool-worker-13|16]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼
    06:01:12.334[ForkJoinPool.commonPool-worker-4|15]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ 
    06:01:12.334[ForkJoinPool.commonPool-worker-6|17]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ 
    06:01:13.354[ForkJoinPool.commonPool-worker-6|17]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -5300
    06:01:13.354[ForkJoinPool.commonPool-worker-13|16]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5399
    06:01:13.354[ForkJoinPool.commonPool-worker-4|15]è·å–æŸä¸œä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -150
    06:01:13.354[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5199
    06:01:13.354[ForkJoinPool.commonPool-worker-11|14]è·å–æŸä¸œä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5299
    06:01:13.354[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -200
    06:01:13.354[ForkJoinPool.commonPool-worker-13|16]æŸå¤•å¤•æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š99
    06:01:13.354[ForkJoinPool.commonPool-worker-11|14]æŸä¸œæœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š5149
    06:01:13.354[ForkJoinPool.commonPool-worker-2|13]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå¤•å¤•, åŸä»·ï¼š5399, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š99ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 1095ms  ------
    

å¥½å•¦ï¼Œé€šè¿‡é¤å‰çš„å‰èœï¼Œå¤§å®¶åº”è¯¥èƒ½å¤Ÿçœ‹å‡ºæ¥**ä¸²è¡Œ**ä¸**å¹¶è¡Œ**å¤„ç†é€»è¾‘çš„åŒºåˆ«ã€ä»¥åŠ**å¹¶è¡Œå¤„ç†é€»è¾‘çš„å®ç°ç­–ç•¥**äº†å§ï¼Ÿè¿™é‡Œæˆ‘ä»¬åº”è¯¥ä¹Ÿå¯ä»¥çœ‹å‡º`CompletableFuture`åœ¨åº”å¯¹å¹¶è¡Œå¤„ç†åœºæ™¯ä¸‹çš„å¼ºå¤§ä¼˜åŠ¿ã€‚å½“ç„¶å’¯ï¼Œä¸Šé¢ä¹Ÿåªæ˜¯å°å°çš„çª¥è§†äº†ä¸‹`CompletableFuture`åŠŸèƒ½çš„å†°ä¸Šä¸€è§’ï¼Œä¸‹é¢å°±è®©æˆ‘ä»¬ä¸€èµ·æ¥æ·±å…¥äº†è§£ä¸‹ï¼Œäº«ç”¨å¹¶æ¶ˆåŒ–`CompletableFuture`è¿™é“ä¸»èœå§ï¼

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561814125-eb3d213e-83a6-4d71-8d9a-a5299bead931.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=MwwU8&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ufa9a7c31-7011-40c1-b103-3236e7c62a9&title=)

ä¸»èœï¼šCompletableFutureæ·±å…¥äº†è§£
------------------------

å¥½å•¦ï¼Œä¸‹é¢è¯¥ä¸»èœä¸Šåœºäº†ã€‚

ä½œä¸º`JAVA8`ä¹‹ååŠ å…¥çš„æ–°æˆå‘˜ï¼Œ`CompletableFuture`çš„å®ç°ä¸ä½¿ç”¨ä¸Šï¼Œä¹Ÿå¤„å¤„ä½“ç°å‡ºäº†**å‡½æ•°å¼å¼‚æ­¥ç¼–ç¨‹**çš„å‘³é“ã€‚ä¸€ä¸ª`CompletableFuture`å¯¹è±¡å¯ä»¥è¢«ä¸€ä¸ªç¯èŠ‚æ¥ä¸€ä¸ªç¯èŠ‚çš„å¤„ç†ã€ä¹Ÿå¯ä»¥å¯¹ä¸¤ä¸ªæˆ–è€…å¤šä¸ª`CompletableFuture`è¿›è¡Œç»„åˆå¤„ç†æˆ–è€…ç­‰å¾…ç»“æœå®Œæˆã€‚é€šè¿‡å¯¹`CompletableFuture`å„ç§æ–¹æ³•çš„åˆç†ä½¿ç”¨ä¸ç»„åˆæ­é…ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨å¾ˆå¤šçš„åœºæ™¯éƒ½å¯ä»¥åº”ä»˜è‡ªå¦‚ã€‚

ä¸‹é¢å°±æ¥ä¸€èµ·äº†è§£ä¸‹è¿™äº›æ–¹æ³•ä»¥åŠå¯¹åº”çš„ä½¿ç”¨æ–¹å¼å§ã€‚

### Futureä¸CompletableFuture

é¦–å…ˆï¼Œå…ˆæ¥ç†ä¸€ä¸‹Futureä¸CompletableFutureä¹‹é—´çš„å…³ç³»ã€‚

#### Future

å¦‚æœæ¥è§¦è¿‡å¤šçº¿ç¨‹ç›¸å…³çš„æ¦‚å¿µï¼Œé‚£`Future`åº”è¯¥ä¸ä¼šé™Œç”Ÿï¼Œæ—©åœ¨**Java5**ä¸­å°±å·²ç»å­˜åœ¨äº†ã€‚

è¯¥å¦‚ä½•ç†è§£`Future`å‘¢ï¼Ÿä¸¾ä¸ªç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼š

> ä½ å»å’–å•¡åº—ç‚¹äº†ä¸€æ¯å’–å•¡ï¼Œç„¶åæœåŠ¡å‘˜ä¼šç»™ä½ ä¸€ä¸ªè®¢å•å°ç¥¨ã€‚  
> å½“æœåŠ¡å‘˜åœ¨åå°åˆ¶ä½œå’–å•¡çš„æ—¶å€™ï¼Œä½ å¹¶æ²¡æœ‰åœ¨åº—é‡Œç­‰å¾…ï¼Œè€Œæ˜¯å‡ºé—¨åˆ°éš”å£ç”œå“åº—åˆä¹°äº†ä¸ªé¢åŒ…ã€‚  
> å½“é¢åŒ…ä¹°å¥½ä¹‹åï¼Œä½ å›åˆ°å’–å•¡åº—ï¼Œæ‹¿ç€è®¢å•å°ç¥¨å»å–å’–å•¡ã€‚  
> å–åˆ°å’–å•¡åï¼Œä½ è¾¹å–å’–å•¡è¾¹æŠŠé¢åŒ…åƒäº†â€¦â€¦å—~

æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„ç”Ÿæ´»åœºæ™¯ï¼Ÿ å¯¹æ¯”åˆ°æˆ‘ä»¬å¤šçº¿ç¨‹å¼‚æ­¥ç¼–ç¨‹çš„åœºæ™¯ä¸­ï¼Œå’–å•¡åº—çš„è®¢å•å°ç¥¨å…¶å®å°±æ˜¯Futureï¼Œé€šè¿‡Futureå¯ä»¥è®©ç¨åé€‚å½“çš„æ—¶å€™å¯ä»¥è·å–åˆ°å¯¹åº”çš„å¼‚æ­¥æ‰§è¡Œçº¿ç¨‹ä¸­çš„æ‰§è¡Œç»“æœã€‚

ä¸Šé¢çš„åœºæ™¯ï¼Œæˆ‘ä»¬ç¿»è¯‘ä¸ºä»£ç å®ç°é€»è¾‘ï¼š

    public void buyCoffeeAndOthers() throws ExecutionException, InterruptedException {
        goShopping();
        // å­çº¿ç¨‹ä¸­å»å¤„ç†åšå’–å•¡è¿™ä»¶äº‹ï¼Œè¿”å›futureå¯¹è±¡
        Future<Coffee> coffeeTicket = threadPool.submit(this::makeCoffee);
        // ä¸»çº¿ç¨‹åŒæ­¥å»åšå…¶ä»–çš„äº‹æƒ…
        Bread bread = buySomeBread();
        // ä¸»çº¿ç¨‹å…¶ä»–äº‹æƒ…å¹¶è¡Œå¤„ç†å®Œæˆï¼Œé˜»å¡ç­‰å¾…è·å–å­çº¿ç¨‹æ‰§è¡Œç»“æœ
        Coffee coffee = coffeeTicket.get();
        // å­çº¿ç¨‹ç»“æœè·å–å®Œæˆï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ
        eatAndDrink(bread, coffee);
    }
    

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658538639717-36fd8ce1-044a-4519-9fa9-2c07220fe4be.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=500&id=u636f5000&name=image.png&originHeight=500&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&size=68703&status=done&style=none&taskId=ua946a06f-eab4-4497-87df-d3e5d10a777&title=&width=1170)

> ç¼–ç æºäºç”Ÿæ´»ã€ä»£ç ä¸­çš„è®¾è®¡é€»è¾‘ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯ä¸ç”Ÿæ´»å“²å­¦åŒ¹é…çš„ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561833995-d2acae5e-bf5b-4479-97b5-958a68f1f423.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=o3CA2&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ucefb3861-8b3f-435f-bb90-08a87542bfb&title=)

#### CompletableFuture

Futureåœ¨åº”å¯¹ä¸€äº›ç®€å•ä¸”ç›¸äº’ç‹¬ç«‹çš„å¼‚æ­¥æ‰§è¡Œåœºæ™¯å¾ˆä¾¿æ·ï¼Œä½†æ˜¯åœ¨ä¸€äº›å¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚åŒæ—¶éœ€è¦å¤šä¸ªæœ‰ä¾èµ–å…³ç³»çš„å¼‚æ­¥ç‹¬ç«‹å¤„ç†çš„æ—¶å€™ï¼Œæˆ–è€…æ˜¯ä¸€äº›ç±»ä¼¼æµæ°´çº¿çš„å¼‚æ­¥å¤„ç†åœºæ™¯æ—¶ï¼Œå°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ã€‚æ¯”å¦‚ï¼š

*   åŒæ—¶æ‰§è¡Œå¤šä¸ªå¹¶è¡Œä»»åŠ¡ï¼Œç­‰å¾…æœ€å¿«çš„ä¸€ä¸ªå®Œæˆä¹‹åå°±å¯ä»¥ç»§ç»­å¾€åå¤„ç†
*   å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæ¯ä¸ªå¼‚æ­¥ä»»åŠ¡éƒ½éœ€è¦ä¾èµ–å‰ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„ç»“æœå†å»æ‰§è¡Œä¸‹ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œæœ€ååªéœ€è¦ä¸€ä¸ªæœ€ç»ˆçš„ç»“æœ
*   ç­‰å¾…å¤šä¸ªå¼‚æ­¥ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆåè§¦å‘ä¸‹ä¸€ä¸ªåŠ¨ä½œæ‰§è¡Œ
*   ...

æ‰€ä»¥å‘¢ï¼Œ åœ¨JAVA8å¼€å§‹å¼•å…¥äº†å…¨æ–°çš„`CompletableFuture`ç±»ï¼Œå®ƒæ˜¯Futureæ¥å£çš„ä¸€ä¸ªå®ç°ç±»ã€‚ä¹Ÿå°±æ˜¯åœ¨Futureæ¥å£çš„åŸºç¡€ä¸Šï¼Œé¢å¤–å°è£…æä¾›äº†ä¸€äº›æ‰§è¡Œæ–¹æ³•ï¼Œç”¨æ¥è§£å†³Futureä½¿ç”¨åœºæ™¯ä¸­çš„ä¸€äº›ä¸è¶³ï¼Œå¯¹**æµæ°´çº¿**å¤„ç†èƒ½åŠ›æä¾›äº†æ”¯æŒã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658542301649-a4a4a76b-8a3f-46ea-8951-4b5c11e2ec82.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=142&id=u6533976f&name=image.png&originHeight=142&originWidth=489&originalType=binary&ratio=1&rotation=0&showTitle=false&size=4450&status=done&style=none&taskId=uc6f13103-1d33-4f6f-ac59-975397da6de&title=&width=489)

ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°±æ¥è¿›ä¸€æ­¥çš„äº†è§£ä¸‹CompletableFutureçš„å…·ä½“ä½¿ç”¨åœºæ™¯ä¸ä½¿ç”¨æ–¹å¼ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561838446-38bd9a16-01dc-4370-9e8f-2d3de65987fb.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=ItxQb&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub395fca7-5f6e-4bc8-9a46-61566b4bdfd&title=)

### CompletableFutureä½¿ç”¨æ–¹å¼

#### åˆ›å»º**CompletableFuture**å¹¶æ‰§è¡Œ

å½“æˆ‘ä»¬éœ€è¦è¿›è¡Œå¼‚æ­¥å¤„ç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`CompletableFuture.supplyAsync`æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªå…·ä½“çš„è¦æ‰§è¡Œçš„å¤„ç†é€»è¾‘å‡½æ•°ï¼Œè¿™æ ·å°±è½»æ¾çš„å®Œæˆäº†**CompletableFuture**çš„åˆ›å»ºä¸è§¦å‘æ‰§è¡Œã€‚

æ–¹æ³•åç§°

ä½œç”¨æè¿°

supplyAsync

é™æ€æ–¹æ³•ï¼Œç”¨äºæ„å»ºä¸€ä¸ª`CompletableFuture<T>`å¯¹è±¡ï¼Œå¹¶å¼‚æ­¥æ‰§è¡Œä¼ å…¥çš„å‡½æ•°ï¼Œå…è®¸æ‰§è¡Œå‡½æ•°æœ‰è¿”å›å€¼`T`ã€‚

runAsync

é™æ€æ–¹æ³•ï¼Œç”¨äºæ„å»ºä¸€ä¸ª`CompletableFuture<Void>`å¯¹è±¡ï¼Œå¹¶å¼‚æ­¥æ‰§è¡Œä¼ å…¥å‡½æ•°ï¼Œä¸supplyAsyncçš„åŒºåˆ«åœ¨äºæ­¤æ–¹æ³•ä¼ å…¥çš„æ˜¯Callableç±»å‹ï¼Œ**ä»…æ‰§è¡Œï¼Œæ²¡æœ‰è¿”å›å€¼**ã€‚

ä½¿ç”¨ç¤ºä¾‹ï¼š

    public void testCreateFuture(String product) {
        // supplyAsyncï¼Œ æ‰§è¡Œé€»è¾‘æœ‰è¿”å›å€¼PriceResult
        CompletableFuture<PriceResult> supplyAsyncResult =
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoPrice(product));
        // runAsync, æ‰§è¡Œé€»è¾‘æ²¡æœ‰è¿”å›å€¼
        CompletableFuture<Void> runAsyncResult =
                CompletableFuture.runAsync(() -> System.out.println(product));
    }
    

ç‰¹åˆ«è¡¥å……ï¼š

> `supplyAsync`æˆ–è€…`runAsync`åˆ›å»ºåä¾¿ä¼šç«‹å³æ‰§è¡Œï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨è§¦å‘ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561845453-1a84af79-bab0-464c-afad-93227e508d63.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=fdoYj&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u16058dcf-cb96-46f8-b063-0271a20ed7c&title=)

#### ç¯ç¯ç›¸æ‰£å¤„ç†

åœ¨æµæ°´çº¿å¤„ç†åœºæ™¯ä¸­ï¼Œå¾€å¾€éƒ½æ˜¯ä¸€ä¸ªä»»åŠ¡ç¯èŠ‚å¤„ç†å®Œæˆåï¼Œä¸‹ä¸€ä¸ªä»»åŠ¡ç¯èŠ‚æ¥ç€ä¸Šä¸€ç¯èŠ‚å¤„ç†ç»“æœç»§ç»­å¤„ç†ã€‚`CompletableFuture`ç”¨äºè¿™ç§æµæ°´çº¿ç¯èŠ‚é©±åŠ¨ç±»çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œç›¸äº’ä¹‹é—´ä¸»è¦æ˜¯åœ¨è¿”å›å€¼æˆ–è€…ç»™åˆ°ä¸‹ä¸€ç¯èŠ‚çš„å…¥å‚ä¸Šæœ‰äº›è®¸å·®å¼‚ï¼Œä½¿ç”¨æ—¶éœ€è¦æ³¨æ„åŒºåˆ†ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658547703691-482c4429-d0f0-4fb4-a5eb-098d66c6d749.png#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=632&id=eetT4&name=image.png&originHeight=632&originWidth=757&originalType=binary&ratio=1&rotation=0&showTitle=false&size=55410&status=done&style=none&taskId=uc0d047ef-0ffb-4d06-8a6f-117feec8e5b&title=&width=757)

å…·ä½“çš„æ–¹æ³•çš„æè¿°å½’çº³å¦‚ä¸‹ï¼š

æ–¹æ³•åç§°

ä½œç”¨æè¿°

thenApply

å¯¹`CompletableFuture`çš„æ‰§è¡Œåçš„å…·ä½“ç»“æœè¿›è¡Œè¿½åŠ å¤„ç†ï¼Œå¹¶å°†å½“å‰çš„`CompletableFuture`æ³›å‹å¯¹è±¡æ›´æ”¹ä¸ºå¤„ç†åæ–°çš„å¯¹è±¡ç±»å‹ï¼Œè¿”å›å½“å‰`CompletableFuture`å¯¹è±¡ã€‚

thenCompose

ä¸`thenApply`ç±»ä¼¼ã€‚åŒºåˆ«ç‚¹åœ¨äºï¼šæ­¤æ–¹æ³•çš„å…¥å‚å‡½æ•°è¿”å›ä¸€ä¸ª`CompletableFuture`ç±»å‹å¯¹è±¡ã€‚

thenAccept

ä¸`thenApply`æ–¹æ³•ç±»ä¼¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äº`thenAccept`è¿”å›**void**ç±»å‹ï¼Œ**æ²¡æœ‰å…·ä½“ç»“æœè¾“å‡º**ï¼Œé€‚åˆæ— éœ€è¿”å›å€¼çš„åœºæ™¯ã€‚

thenRun

ä¸`thenAccept`ç±»ä¼¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äº`thenAccept`å¯ä»¥å°†å‰é¢`CompletableFuture`æ‰§è¡Œçš„å®é™…ç»“æœä½œä¸ºå…¥å‚è¿›è¡Œä¼ å…¥å¹¶ä½¿ç”¨ï¼Œä½†æ˜¯`thenRun`æ–¹æ³•**æ²¡æœ‰ä»»ä½•å…¥å‚**ï¼Œåªèƒ½æ‰§è¡Œä¸€ä¸ªRunnableå‡½æ•°ï¼Œå¹¶ä¸”**è¿”å›voidç±»å‹**ã€‚

å› ä¸ºä¸Šè¿°`thenApply`ã€`thenCompose`æ–¹æ³•çš„è¾“å‡ºä»ç„¶éƒ½æ˜¯ä¸€ä¸ª**CompletableFuture**å¯¹è±¡ï¼Œæ‰€ä»¥å„ä¸ªæ–¹æ³•æ˜¯å¯ä»¥ä¸€ç¯æ¥ä¸€ç¯çš„è¿›è¡Œè°ƒç”¨ï¼Œå½¢æˆæµæ°´çº¿å¼çš„å¤„ç†é€»è¾‘ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658548155598-ff8152dc-a9f2-433d-baca-d76189714d8c.png#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=138&id=ufb9c6d29&name=image.png&originHeight=138&originWidth=891&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16202&status=done&style=none&taskId=uac076343-9a1d-455d-8662-1c57a133135&title=&width=891)

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561891519-ce6422ab-bd66-40a1-a7a7-1f2cd6798422.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=YOx1v&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf4a5a039-0f38-42bb-8969-b9e474f067f&title=)

æœŸæœ›æ€»æ˜¯ç¾å¥½çš„ï¼Œä½†æ˜¯å®é™…æƒ…å†µå´æ€»ä¸å°½å¦‚äººæ„ã€‚åœ¨æˆ‘ä»¬ç¼–æ’æµæ°´çº¿çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸€ä¸ªç¯èŠ‚æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸äº†ï¼Œä¼šå¯¼è‡´æ•´ä¸ªæµæ°´çº¿åç»­çš„ç¯èŠ‚å°±æ²¡æ³•å†ç»§ç»­ä¸‹å»äº†ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š

    public void testExceptionHandle() {
        CompletableFuture.supplyAsync(() -> {
            throw new RuntimeException("supplyAsync excetion occurred...");
        }).thenApply(obj -> {
            System.out.println("thenApply executed...");
            return obj;
        }).join();
    }
    

æ‰§è¡Œä¹‹åä¼šå‘ç°ï¼ŒsupplyAsyncæŠ›å‡ºå¼‚å¸¸åï¼Œåé¢çš„thenApplyå¹¶æ²¡æœ‰è¢«æ‰§è¡Œã€‚

é‚£å¦‚æœæˆ‘ä»¬æƒ³è¦è®©æµæ°´çº¿çš„æ¯ä¸ªç¯èŠ‚å¤„ç†å¤±è´¥ä¹‹åéƒ½èƒ½è®©æµæ°´çº¿ç»§ç»­å¾€ä¸‹é¢ç¯èŠ‚å¤„ç†ï¼Œè®©åç»­ç¯èŠ‚å¯ä»¥æ‹¿åˆ°å‰é¢ç¯èŠ‚çš„ç»“æœæˆ–è€…æ˜¯æŠ›å‡ºçš„å¼‚å¸¸å¹¶è¿›è¡Œå¯¹åº”çš„åº”å¯¹å¤„ç†ï¼Œå°±éœ€è¦ç”¨åˆ°`handle`å’Œ`whenCompletable`æ–¹æ³•äº†ã€‚

å…ˆçœ‹ä¸‹ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨æè¿°ï¼š

æ–¹æ³•åç§°

ä½œç”¨æè¿°

handle

ä¸`thenApply`ç±»ä¼¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äºhandleæ‰§è¡Œå‡½æ•°çš„å…¥å‚æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯`CompletableFuture`æ‰§è¡Œçš„å®é™…ç»“æœï¼Œä¸€ä¸ªæ˜¯æ˜¯**Throwableå¯¹è±¡**ï¼Œè¿™æ ·å¦‚æœå‰é¢æ‰§è¡Œå‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡handleè·å–åˆ°å¼‚å¸¸å¹¶è¿›è¡Œå¤„ç†ã€‚

whenComplete

ä¸`handle`ç±»ä¼¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äº`whenComplete`æ‰§è¡Œå**æ— è¿”å›å€¼**ã€‚

æˆ‘ä»¬å¯¹ä¸Šé¢ä¸€æ®µä»£ç ç¤ºä¾‹ä¿®æ”¹ä½¿ç”¨handleæ–¹æ³•æ¥å¤„ç†ï¼š

    public void testExceptionHandle() {
        CompletableFuture.supplyAsync(() -> {
            throw new RuntimeException("supplyAsync excetion occurred...");
        }).handle((obj, e) -> {
            if (e != null) {
                System.out.println("thenApply executed, exception occurred...");
            }
            return obj;
        }).join();
    }
    

å†æ‰§è¡Œå¯ä»¥å‘ç°ï¼Œå³ä½¿å‰é¢ç¯èŠ‚å‡ºç°å¼‚å¸¸ï¼Œåé¢ç¯èŠ‚ä¹Ÿå¯ä»¥ç»§ç»­å¤„ç†ï¼Œä¸”å¯ä»¥æ‹¿åˆ°å‰ä¸€ç¯èŠ‚æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ï¼š

    thenApply executed, exception occurred...
    

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561875171-b976f6f0-45d9-4f2f-8e65-fb6b4efa24a2.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=zDXsF&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc3cd6633-494e-4d63-b627-71e275f405e&title=)

#### å¤šä¸ª**CompletableFutureç»„åˆæ“ä½œ**

å‰é¢ä¸€ç›´åœ¨ä»‹ç»æµæ°´çº¿å¼çš„å¤„ç†åœºæ™¯ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™ï¼Œæµæ°´çº¿å¤„ç†åœºæ™¯ä¹Ÿä¸ä¼šæ˜¯ä¸€ä¸ªé“¾è·¯é¡ºåºå¾€ä¸‹èµ°çš„æƒ…å†µï¼Œå¾ˆå¤šæ—¶å€™ä¸ºäº†æå‡å¹¶è¡Œæ•ˆç‡ï¼Œä¸€äº›æ²¡æœ‰ä¾èµ–çš„ç¯èŠ‚æˆ‘ä»¬ä¼šè®©ä»–ä»¬åŒæ—¶å»æ‰§è¡Œï¼Œç„¶ååœ¨æŸäº›ç¯èŠ‚éœ€è¦ä¾èµ–çš„æ—¶å€™ï¼Œè¿›è¡Œç»“æœçš„ä¾èµ–åˆå¹¶å¤„ç†ï¼Œç±»ä¼¼å¦‚ä¸‹å›¾çš„æ•ˆæœã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658496270855-4b7fbec8-60de-45fe-89da-efffc63dada7.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=301&id=J6DsZ&name=image.png&originHeight=301&originWidth=1509&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33689&status=done&style=none&taskId=u0aafe101-103e-463c-ad0f-1cc96559c3c&title=&width=1509)

`CompletableFuture`ç›¸æ¯”äº`Future`çš„ä¸€å¤§ä¼˜åŠ¿ï¼Œå°±æ˜¯å¯ä»¥æ–¹ä¾¿çš„å®ç°å¤šä¸ªå¹¶è¡Œç¯èŠ‚çš„åˆå¹¶å¤„ç†ã€‚ç›¸å…³æ¶‰åŠæ–¹æ³•ä»‹ç»å½’çº³å¦‚ä¸‹ï¼š

æ–¹æ³•åç§°

ä½œç”¨æè¿°

thenCombine

å°†ä¸¤ä¸ª`CompletableFuture`å¯¹è±¡ç»„åˆèµ·æ¥è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œå¯ä»¥æ‹¿åˆ°ä¸¤ä¸ªæ‰§è¡Œç»“æœï¼Œå¹¶ä¼ ç»™è‡ªå·±çš„æ‰§è¡Œå‡½æ•°è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œæœ€åè¿”å›ä¸€ä¸ªæ–°çš„`CompletableFuture`å¯¹è±¡ã€‚

thenAcceptBoth

ä¸`thenCombine`ç±»ä¼¼ï¼ŒåŒºåˆ«ç‚¹åœ¨äº`thenAcceptBoth`ä¼ å…¥çš„æ‰§è¡Œå‡½æ•°æ²¡æœ‰è¿”å›å€¼ï¼Œå³thenAcceptBothè¿”å›å€¼ä¸º`CompletableFuture<Void>`ã€‚

runAfterBoth

ç­‰å¾…ä¸¤ä¸ª`CompletableFuture`éƒ½æ‰§è¡Œå®Œæˆåå†æ‰§è¡ŒæŸä¸ªRunnableå¯¹è±¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªçš„é€»è¾‘ï¼Œç±»ä¼¼thenRunã€‚

applyToEither

ä¸¤ä¸ª`CompletableFuture`ä¸­ä»»æ„ä¸€ä¸ªå®Œæˆçš„æ—¶å€™ï¼Œç»§ç»­æ‰§è¡Œåé¢ç»™å®šçš„æ–°çš„å‡½æ•°å¤„ç†ã€‚å†æ‰§è¡Œåé¢ç»™å®šå‡½æ•°çš„é€»è¾‘ï¼Œç±»ä¼¼thenApplyã€‚

acceptEither

ä¸¤ä¸ª`CompletableFuture`ä¸­ä»»æ„ä¸€ä¸ªå®Œæˆçš„æ—¶å€™ï¼Œç»§ç»­æ‰§è¡Œåé¢ç»™å®šçš„æ–°çš„å‡½æ•°å¤„ç†ã€‚å†æ‰§è¡Œåé¢ç»™å®šå‡½æ•°çš„é€»è¾‘ï¼Œç±»ä¼¼thenAcceptã€‚

runAfterEither

ç­‰å¾…ä¸¤ä¸ª`CompletableFuture`ä¸­ä»»æ„ä¸€ä¸ªæ‰§è¡Œå®Œæˆåå†æ‰§è¡ŒæŸä¸ªRunnableå¯¹è±¡ï¼Œå¯ä»¥ç†è§£ä¸º`thenRun`çš„å‡çº§ç‰ˆï¼Œæ³¨æ„ä¸`runAfterBoth`å¯¹æ¯”ç†è§£ã€‚

allOf

é™æ€æ–¹æ³•ï¼Œ**é˜»å¡**ç­‰å¾…æ‰€æœ‰ç»™å®šçš„`CompletableFuture`æ‰§è¡Œç»“æŸåï¼Œè¿”å›ä¸€ä¸ª`CompletableFuture<Void>`ç»“æœã€‚

anyOf

é™æ€æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…ä»»æ„ä¸€ä¸ªç»™å®šçš„`CompletableFuture`å¯¹è±¡æ‰§è¡Œç»“æŸåï¼Œè¿”å›ä¸€ä¸ª`CompletableFuture<Void>`ç»“æœã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561880902-9aaf9f32-3f76-4d32-b4e8-b6de4e7413e4.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=K4ew6&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub4520cf4-af44-43d5-8da4-afc25593f06&title=)

#### ç»“æœç­‰å¾…ä¸è·å–

åœ¨æ‰§è¡Œçº¿ç¨‹ä¸­å°†ä»»åŠ¡æ”¾åˆ°å·¥ä½œçº¿ç¨‹ä¸­è¿›è¡Œå¤„ç†çš„æ—¶å€™ï¼Œæ‰§è¡Œçº¿ç¨‹ä¸å·¥ä½œçº¿ç¨‹ä¹‹é—´æ˜¯å¼‚æ­¥æ‰§è¡Œçš„æ¨¡å¼ï¼Œå¦‚æœæ‰§è¡Œçº¿ç¨‹éœ€è¦è·å–åˆ°å…±å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œåˆ™å¯ä»¥é€šè¿‡`get`æˆ–è€…`join`æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…å¹¶ä»`CompletableFuture`ä¸­è·å–å¯¹åº”çš„å€¼ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658497100974-d9a6e835-6662-4697-b935-ac03a0915b2d.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=254&id=fZhML&name=image.png&originHeight=254&originWidth=643&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19814&status=done&style=none&taskId=u700dd41f-62bc-41c6-8b6d-a13d5ef7273&title=&width=643)

å¯¹`get`å’Œ`join`çš„æ–¹æ³•åŠŸèƒ½å«ä¹‰è¯´æ˜å½’çº³å¦‚ä¸‹ï¼š

æ–¹æ³•åç§°

ä½œç”¨æè¿°

get()

ç­‰å¾…`CompletableFuture`æ‰§è¡Œå®Œæˆå¹¶è·å–å…¶å…·ä½“æ‰§è¡Œç»“æœï¼Œå¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œ**éœ€è¦**ä»£ç è°ƒç”¨çš„åœ°æ–¹æ‰‹åŠ¨`try...catch`è¿›è¡Œå¤„ç†ã€‚

get(long, TimeUnit)

ä¸get()ç›¸åŒï¼Œåªæ˜¯**å…è®¸è®¾å®šé˜»å¡ç­‰å¾…è¶…æ—¶æ—¶é—´**ï¼Œå¦‚æœç­‰å¾…è¶…è¿‡è®¾å®šæ—¶é—´ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢é˜»å¡ç­‰å¾…ã€‚

join()

ç­‰å¾…`CompletableFuture`æ‰§è¡Œå®Œæˆå¹¶è·å–å…¶å…·ä½“æ‰§è¡Œç»“æœï¼Œå¯èƒ½ä¼šæŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸ï¼Œ**æ— éœ€**ä»£ç è°ƒç”¨çš„åœ°æ–¹æ‰‹åŠ¨try...catchè¿›è¡Œå¤„ç†ã€‚

ä»ä»‹ç»ä¸Šå¯ä»¥çœ‹å‡ºï¼Œä¸¤è€…çš„åŒºåˆ«å°±åœ¨äºæ˜¯å¦éœ€è¦è°ƒç”¨æ–¹**æ˜¾å¼çš„è¿›è¡Œtry...catchå¤„ç†é€»è¾‘**ï¼Œä½¿ç”¨ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š

    public void testGetAndJoin(String product) {
        // joinæ— éœ€æ˜¾å¼try...catch...
        PriceResult joinResult = CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiPrice(product))
                .join();
        
        try {
            // getæ˜¾å¼try...catch...
            PriceResult getResult = CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiPrice(product))
                    .get(5L, TimeUnit.SECONDS);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
    

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561900624-cd4c431f-9aea-4f5c-976d-1946b28123c9.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=QGWMO&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8b0a510b-b28f-42a6-85c5-4c0fcce0918&title=)

### **CompletableFuture**æ–¹æ³•åŠå…¶Asyncç‰ˆæœ¬

æˆ‘ä»¬åœ¨ä½¿ç”¨**CompletableFuture**çš„æ—¶å€™ä¼šå‘ç°ï¼Œæœ‰å¾ˆå¤šçš„æ–¹æ³•ï¼Œéƒ½ä¼šåŒæ—¶æœ‰ä¸¤ä¸ªä»¥**Async**å‘½åç»“å°¾çš„æ–¹æ³•ç‰ˆæœ¬ã€‚ä»¥å‰é¢æˆ‘ä»¬ç”¨çš„æ¯”è¾ƒå¤šçš„`thenCombine`æ–¹æ³•ä¸ºä¾‹ï¼š

1.  thenCombine(CompletionStage, BiFunction)
2.  thenCombineAsync(CompletionStage, BiFunction)
3.  thenCombineAsync(CompletionStage, BiFunction, Executor)

ä»å‚æ•°ä¸Šçœ‹ï¼ŒåŒºåˆ«å¹¶ä¸å¤§ï¼Œä»…ç¬¬ä¸‰ä¸ªæ–¹æ³•å…¥å‚ä¸­å¤šäº†çº¿ç¨‹æ± Executorå¯¹è±¡ã€‚çœ‹ä¸‹ä¸‰ä¸ªæ–¹æ³•çš„æºç å®ç°ï¼Œä¼šå‘ç°å…¶æ•´ä½“å®ç°é€»è¾‘éƒ½æ˜¯ä¸€è‡´çš„ï¼Œä»…ä»…æ˜¯ä½¿ç”¨çº¿ç¨‹æ± è¿™ä¸ªåœ°æ–¹çš„é€»è¾‘æœ‰ä¸€ç‚¹ç‚¹çš„å·®å¼‚ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658467956240-c13a156a-aab6-4cac-a691-0dbf4d1f2fc2.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=426&id=u3bddf72e&name=image.png&originHeight=426&originWidth=735&originalType=binary&ratio=1&rotation=0&showTitle=false&size=50655&status=done&style=none&taskId=ue0858757-f803-4fbc-b96d-aba411324bd&title=&width=735)

æœ‰å…´è¶£çš„å¯ä»¥å»ç¿»ä¸€ä¸‹æ­¤éƒ¨åˆ†çš„æºç å®ç°ï¼Œè¿™é‡Œæ¦‚æ‹¬ä¸‹ä¸‰è€…çš„åŒºåˆ«ï¼š

1.  thenCombineæ–¹æ³•ï¼Œæ²¿ç”¨ä¸Šä¸€ä¸ªæ‰§è¡Œä»»åŠ¡æ‰€ä½¿ç”¨çš„çº¿ç¨‹æ± è¿›è¡Œå¤„ç†
2.  thenCombineAsyncä¸¤ä¸ªå…¥å‚çš„æ–¹æ³•ï¼Œä½¿ç”¨é»˜è®¤çš„ForkJoinPoolçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹è¿›è¡Œå¤„ç†
3.  themCombineAsyncä¸‰ä¸ªå…¥å‚çš„æ–¹æ³•ï¼Œæ”¯æŒè‡ªå®šä¹‰çº¿ç¨‹æ± å¹¶æŒ‡å®šä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ä½œä¸ºå·¥ä½œçº¿ç¨‹å»å¤„ç†å¾…æ‰§è¡Œä»»åŠ¡ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561911212-7cb5f58d-be2a-4971-ab2e-7c8afda5b508.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=XgCYO&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3a6c792e-8a14-4b44-b585-22bca2f2c43&title=)

ä¸ºäº†æ›´å¥½çš„ç†è§£ä¸‹ä¸Šè¿°çš„ä¸‰ä¸ªå·®å¼‚ç‚¹ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥æ¼”ç¤ºä¸‹ï¼š

*   \*\*ç”¨æ³•1ï¼š \*\*å…¶ä¸­ä¸€ä¸ªsupplyAsyncæ–¹æ³•ä»¥åŠthenCombineAsyncæŒ‡å®šä½¿ç”¨è‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œå¦ä¸€ä¸ªsupplyAsyncæ–¹æ³•ä¸æŒ‡å®šçº¿ç¨‹æ± ï¼ˆä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ï¼‰

    public PriceResult getCheapestPlatAndPrice4(String product) {
        // æ„é€ è‡ªå®šä¹‰çº¿ç¨‹æ± 
        ExecutorService executor = Executors.newFixedThreadPool(5);
        
        return
            CompletableFuture.supplyAsync(
                () -> HttpRequestMock.getMouXiXiPrice(product), 
                executor
            ).thenCombineAsync(
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiDiscounts(product)),
                this::computeRealPrice,
                executor
            ).join();
    }
    

å¯¹ä¸Šè¿°ä»£ç å®ç°ç­–ç•¥çš„è§£è¯»ï¼Œä»¥åŠä¸æ‰§è¡Œç»“æœçš„å…³ç³»å±•ç¤ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹å‡ºï¼Œæ²¡æœ‰æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± çš„supplyAsyncæ–¹æ³•ï¼Œå…¶ä½¿ç”¨äº†é»˜è®¤çš„`ForkJoinPool`å·¥ä½œçº¿ç¨‹æ¥è¿è¡Œï¼Œè€Œå¦å¤–ä¸¤ä¸ªæŒ‡å®šäº†è‡ªå®šä¹‰çº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨äº†è‡ªå®šä¹‰çº¿ç¨‹æ± æ¥æ‰§è¡Œã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658470134658-563581fe-1af0-47e0-9d6d-993bd3cf4aa9.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=341&id=u3e0ab29b&name=image.png&originHeight=341&originWidth=1017&originalType=binary&ratio=1&rotation=0&showTitle=false&size=113613&status=done&style=none&taskId=u5b05245b-71a0-4b7b-b14b-9c5df9df6f3&title=&width=1017)

*   **ç”¨æ³•2**ï¼š ä¸æŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± ï¼Œä½¿ç”¨é»˜è®¤çº¿ç¨‹æ± ç­–ç•¥ï¼Œä½¿ç”¨thenCombineæ–¹æ³•

    public PriceResult getCheapestPlatAndPrice5(String product) {
        return
            CompletableFuture.supplyAsync(
                () -> HttpRequestMock.getMouXiXiPrice(product)
            ).thenCombine(
                CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouXiXiDiscounts(product)),
                this::computeRealPrice
            ).join();
    }
    

æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ‰§è¡Œçº¿ç¨‹åç§°ä¸**ç”¨æ³•1**ç¤ºä¾‹ç›¸æ¯”å‘ç”Ÿäº†å˜åŒ–ã€‚å› ä¸ºæ²¡æœ‰æŒ‡å®šçº¿ç¨‹æ± ï¼Œæ‰€ä»¥ä¸¤ä¸ª`supplyAsync`æ–¹æ³•éƒ½æ˜¯ç”¨çš„é»˜è®¤çš„`ForkJoinPool`çº¿ç¨‹æ± ï¼Œè€Œ`thenCombine`ä½¿ç”¨çš„æ˜¯ä¸Šä¸€ä¸ªä»»åŠ¡æ‰€ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯ç”¨çš„`ForkJoinPool`ã€‚

    14:34:27.815[ForkJoinPool.commonPool-worker-1|12]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼
    14:34:27.815[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ 
    14:34:28.831[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä¼˜æƒ å®Œæˆï¼š -5300
    14:34:28.831[ForkJoinPool.commonPool-worker-1|12]è·å–æŸå¤•å¤•ä¸Š Iphone13çš„ä»·æ ¼å®Œæˆï¼š 5399
    14:34:28.831[ForkJoinPool.commonPool-worker-2|13]æŸå¤•å¤•æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š99
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå¤•å¤•, åŸä»·ï¼š5399, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š99ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 1083ms  ------
    

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561931223-1d25c6c3-2feb-40f9-b921-ed88db994f02.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=xfRlx&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u303c3c6a-5455-4999-ba79-70d3cb8dbaa&title=)

ç°åœ¨ï¼Œæˆ‘ä»¬çŸ¥é“äº†æ–¹æ³•åç§°å¸¦æœ‰Asyncå’Œä¸å¸¦Asyncçš„å®ç°ç­–ç•¥ä¸Šçš„å·®å¼‚ç‚¹å°±åœ¨äºä½¿ç”¨å“ªä¸ªçº¿ç¨‹æ± æ¥æ‰§è¡Œè€Œå·²ã€‚é‚£ä¹ˆï¼Œå¯¹æˆ‘ä»¬å®é™…çš„æŒ‡å¯¼æ„ä¹‰æ˜¯å•¥å‘¢ï¼Ÿå®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ€ä¹ˆåˆ¤æ–­è‡ªå·±åº”è¯¥ä½¿ç”¨å¸¦Asyncç»“å°¾çš„æ–¹æ³•ã€è¿˜æ˜¯ä¸å¸¦Asyncç»“å°¾çš„æ–¹æ³•å‘¢ï¼Ÿ

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658472387265-93515393-6b7a-4bd6-b987-ad2583162847.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=228&id=ufceddc1d&name=image.png&originHeight=228&originWidth=788&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24288&status=done&style=none&taskId=u210a0f01-a7ec-43fb-b4c7-9fc1304b35e&title=&width=788)

ä¸Šé¢æ˜¯Asyncç»“å°¾æ–¹æ³•é»˜è®¤ä½¿ç”¨çš„ForkJoinPoolåˆ›å»ºçš„é€»è¾‘ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œé»˜è®¤çš„çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æ•°æ˜¯`CPUæ ¸æ•° - 1`ï¼Œå¹¶ä¸”æŒ‡å®šäº†é»˜è®¤çš„ä¸¢å¼ƒç­–ç•¥ç­‰ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªä¸»è¦å…³é”®ç‚¹ã€‚

æ‰€ä»¥è¯´ï¼Œç¬¦åˆä»¥ä¸‹å‡ ä¸ªæ¡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¸¦æœ‰Asyncåç¼€çš„æ–¹æ³•ï¼ŒæŒ‡å®šè‡ªå®šä¹‰çº¿ç¨‹æ± ï¼š

*   é»˜è®¤çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°æ»¡è¶³ä¸äº†å®é™…è¯‰æ±‚
*   é»˜è®¤çº¿ç¨‹æ± çš„ç±»å‹ä¸ç¬¦åˆè‡ªå·±ä¸šåŠ¡è¯‰æ±‚
*   é»˜è®¤çº¿ç¨‹æ± çš„é˜Ÿåˆ—æ»¡å¤„ç†ç­–ç•¥ä¸æ»¡è¶³è‡ªå·±è¯‰æ±‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561935384-a456e2d8-1431-4afb-83ba-0882840da57f.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=JjJlm&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u435ec3e4-9741-4093-850b-345f1fe8d2c&title=)

### ä¸Streamç»“åˆä½¿ç”¨çš„æ³¨æ„ç‚¹

åœ¨æˆ‘å‰é¢çš„æ–‡æ¡£ä¸­ï¼Œæœ‰ç»†è‡´å…¨é¢çš„ä»‹ç»è¿‡`Stream`æµç›¸å…³çš„ä½¿ç”¨æ–¹å¼ï¼ˆä¸æ¸…æ¥šçš„åŒå­¦é€Ÿç‚¹ğŸ‘‰ğŸ‘‰ã€Š[åƒé€JAVAçš„Streamæµæ“ä½œï¼Œå¤šå¹´å®è·µæ€»ç»“](https://juejin.cn/post/7118991438448164878)ã€‹äº†è§£ä¸‹å•¦ï¼‰ã€‚åœ¨æ¶‰åŠæ‰¹é‡è¿›è¡Œå¹¶è¡Œå¤„ç†çš„æ—¶å€™ï¼Œé€šè¿‡`Stream`ä¸`CompletableFuture`ç»“åˆä½¿ç”¨ï¼Œå¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„å¾ˆå¤šç¼–ç é€»è¾‘ã€‚ä½†æ˜¯**åœ¨ä½¿ç”¨ç»†èŠ‚æ–¹é¢éœ€è¦æ³¨æ„ä¸‹**ï¼Œé¿å…è¾¾ä¸åˆ°ä½¿ç”¨`CompletableFuture`çš„é¢„æœŸæ•ˆæœã€‚

> **éœ€æ±‚åœºæ™¯ï¼š**  
> åœ¨åŒä¸€ä¸ªå¹³å°å†…ï¼Œä¼ å…¥å¤šä¸ªå•†å“ï¼ŒæŸ¥è¯¢ä¸åŒå•†å“å¯¹åº”çš„ä»·æ ¼ä¸ä¼˜æƒ ä¿¡æ¯ï¼Œå¹¶é€‰å‡ºå®ä»˜ä»·æ ¼æœ€ä½çš„å•†å“ä¿¡æ¯ã€‚

ç»“åˆå‰é¢çš„ä»‹ç»åˆ†æï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“æœ€ä½³çš„æ–¹å¼ï¼Œå°±æ˜¯åŒæ—¶å¹¶è¡Œçš„æ–¹å¼å»å„è‡ªè¯·æ±‚æ•°æ®ï¼Œæœ€ååˆå¹¶å¤„ç†å³å¯ã€‚æ‰€ä»¥æˆ‘ä»¬è§„åˆ’æŒ‰ç…§å¦‚ä¸‹çš„ç­–ç•¥æ¥å®ç°ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658453339932-2dd85fe5-dc00-4e2e-81ef-febc9d61d3e3.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=340&id=u24db25fa&margin=%5Bobject%20Object%5D&name=image.png&originHeight=340&originWidth=772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38928&status=done&style=none&taskId=u29584c3d-4e89-4693-a4a7-d06e16e0c38&title=&width=772)

å…ˆçœ‹ç¬¬ä¸€ç§ç¼–ç å®ç°ï¼š

    public PriceResult comparePriceInOnePlat(List<String> products) {
        return products.stream()
                .map(product ->
                        CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoPrice(product))
                                .thenCombine(
                                        CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoDiscounts(product)),
                                        this::computeRealPrice))
                .map(CompletableFuture::join)
                .sorted(Comparator.comparingInt(PriceResult::getRealPrice))
                .findFirst()
                .get();
    }
    

å¯¹äºListçš„å¤„ç†åœºæ™¯ï¼Œè¿™é‡Œé‡‡ç”¨äº†Streamæ–¹å¼æ¥è¿›è¡Œéå†ä¸ç»“æœçš„æ”¶é›†ã€æ’åºä¸è¿”å›ã€‚çœ‹ä¼¼æ­£å¸¸ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šå‘ç°ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘ä»¬é¢„æœŸçš„æ•ˆæœï¼š

    07:37:14.388[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä»·æ ¼
    07:37:14.388[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä¼˜æƒ 
    07:37:15.408[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:37:15.408[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:37:15.408[ForkJoinPool.commonPool-worker-2|13]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    07:37:15.408[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä»·æ ¼
    07:37:15.409[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä¼˜æƒ 
    07:37:16.410[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:37:16.410[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:37:16.410[ForkJoinPool.commonPool-worker-11|14]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    07:37:16.410[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä¼˜æƒ 
    07:37:16.410[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä»·æ ¼
    07:37:17.412[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:37:17.412[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:37:17.412[ForkJoinPool.commonPool-worker-9|12]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå®, åŸä»·ï¼š5199, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š4999ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 3132ms  ------
    

ä»ä¸Šè¿°æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œå…¶å…·ä½“å¤„ç†çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æŒ‰ç…§ä¸‹é¢çš„é€»è¾‘å»å¤„ç†äº†ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658453805053-5cc7cf9f-23ae-440b-bdf7-971c8e24af8b.png#clientId=u384b8e9f-3554-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=353&id=u505a48bb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=353&originWidth=751&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44936&status=done&style=none&taskId=u4bd1f20e-9e80-48ee-8b41-b6c097dff4e&title=&width=751)

ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§å®é™…ä¸é¢„æœŸçš„å·®å¼‚å‘¢ï¼ŸåŸå› å°±åœ¨äºæˆ‘ä»¬ä½¿ç”¨çš„Streamä¸Šé¢ï¼è™½ç„¶Streamä¸­ä½¿ç”¨ä¸¤ä¸ª`map`æ–¹æ³•ï¼Œä½†Streamå¤„ç†çš„æ—¶å€™å¹¶ä¸ä¼šåˆ†åˆ«éå†ä¸¤éï¼Œå…¶å®å†™æ³•ç­‰åŒäºä¸‹é¢è¿™ç§å†™åˆ°`1ä¸ª`mapä¸­å¤„ç†ï¼Œæ”¹ä¸ºä¸‹é¢è¿™ç§å†™æ³•ï¼Œå…¶å®å¤§å®¶ä¹Ÿå°±æ›´å®¹æ˜“æ˜ç™½ä¸ºå•¥ä¼šæ²¡æœ‰è¾¾åˆ°æˆ‘ä»¬é¢„æœŸçš„æ•´ä½“å¹¶è¡Œæ•ˆæœäº†ï¼š

    public PriceResult comparePriceInOnePlat1(List<String> products) {
        return products.stream()
            .map(product ->
                 CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoPrice(product))
                 .thenCombine(
                     CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoDiscounts(product)),
                     this::computeRealPrice)
                 .join())
            .sorted(Comparator.comparingInt(PriceResult::getRealPrice))
            .findFirst()
            .get();
        }
    

æ—¢ç„¶å¦‚æ­¤ï¼Œè¿™ç§åœºæ™¯æ˜¯ä¸æ˜¯å°±ä¸èƒ½ä½¿ç”¨Streamäº†å‘¢ï¼Ÿä¹Ÿä¸æ˜¯ï¼Œå…¶å®æˆ‘ä»¬**æ‹†å¼€æˆä¸¤ä¸ªStream**åˆ†æ­¥æ“ä½œä¸‹å…¶å®å°±å¯ä»¥äº†ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561958746-f93fdb9a-9ce2-4e9e-be8f-4759399c2630.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=uCaV0&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ue3912eae-2fb9-484a-a4ce-9f4d1382428&title=)

å†çœ‹ä¸‹é¢çš„ç¬¬äºŒç§å®ç°ä»£ç ï¼š

    public PriceResult comparePriceInOnePlat2(List<String> products) {
        // å…ˆè§¦å‘å„è‡ªå¹³å°çš„å¹¶è¡Œå¤„ç†
        List<CompletableFuture<PriceResult>> completableFutures = products.stream()
                .map(product ->
                        CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoPrice(product))
                                .thenCombine(
                                        CompletableFuture.supplyAsync(() -> HttpRequestMock.getMouBaoDiscounts(product)),
                                        this::computeRealPrice))
                .collect(Collectors.toList());
        // åœ¨ç‹¬ç«‹çš„æµä¸­ï¼Œç­‰å¾…æ‰€æœ‰å¹¶è¡Œå¤„ç†ç»“æŸï¼Œåšæœ€ç»ˆç»“æœå¤„ç†
        return completableFutures.stream()
                .map(CompletableFuture::join)
                .sorted(Comparator.comparingInt(PriceResult::getRealPrice))
                .findFirst()
                .get();
    }
    

æ‰§è¡Œç»“æœï¼š

    07:39:15.053[ForkJoinPool.commonPool-worker-13|16]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä¼˜æƒ 
    07:39:15.054[ForkJoinPool.commonPool-worker-4|15]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä¼˜æƒ 
    07:39:15.053[ForkJoinPool.commonPool-worker-6|17]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä»·æ ¼
    07:39:15.053[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä»·æ ¼
    07:39:15.053[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä»·æ ¼
    07:39:15.053[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä¼˜æƒ 
    07:39:16.072[ForkJoinPool.commonPool-worker-6|17]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:39:16.072[ForkJoinPool.commonPool-worker-9|12]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:39:16.072[ForkJoinPool.commonPool-worker-2|13]è·å–æŸå®ä¸Š Iphone13é»‘è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:39:16.072[ForkJoinPool.commonPool-worker-11|14]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä»·æ ¼å®Œæˆï¼š 5199
    07:39:16.072[ForkJoinPool.commonPool-worker-4|15]è·å–æŸå®ä¸Š Iphone13ç™½è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:39:16.072[ForkJoinPool.commonPool-worker-13|16]è·å–æŸå®ä¸Š Iphone13çº¢è‰²çš„ä¼˜æƒ å®Œæˆï¼š -200
    07:39:16.072[ForkJoinPool.commonPool-worker-2|13]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    07:39:16.072[ForkJoinPool.commonPool-worker-4|15]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    07:39:16.072[ForkJoinPool.commonPool-worker-13|16]æŸå®æœ€ç»ˆä»·æ ¼è®¡ç®—å®Œæˆï¼š4999
    è·å–æœ€ä¼˜ä»·æ ¼ä¿¡æ¯ï¼šã€å¹³å°ï¼šæŸå®, åŸä»·ï¼š5199, æŠ˜æ‰£ï¼š0, å®ä»˜ä»·ï¼š4999ã€‘
    -----æ‰§è¡Œè€—æ—¶ï¼š 1142ms  ------
    

ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¸‰ä¸ªå•†å“å¹¶è¡Œå¤„ç†ï¼Œæ•´ä½“å¤„ç†è€—æ—¶ç›¸æ¯”å‰é¢ç¼–ç æ–¹å¼æœ‰å¾ˆå¤§æå‡ï¼Œè¾¾åˆ°äº†é¢„æœŸçš„æ•ˆæœã€‚

ğŸ“¢**å½’çº³ä¸‹**ï¼š

> å› ä¸ºStreamçš„æ“ä½œå…·æœ‰**å»¶è¿Ÿæ‰§è¡Œ**çš„ç‰¹ç‚¹ï¼Œä¸”åªæœ‰é‡åˆ°ç»ˆæ­¢æ“ä½œï¼ˆæ¯”å¦‚collectæ–¹æ³•ï¼‰çš„æ—¶å€™æ‰ä¼šçœŸæ­£çš„æ‰§è¡Œã€‚æ‰€ä»¥é‡åˆ°è¿™ç§éœ€è¦å¹¶è¡Œå¤„ç†ä¸”éœ€è¦åˆå¹¶å¤šä¸ªå¹¶è¡Œå¤„ç†æµç¨‹çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å°†å¹¶è¡Œæµç¨‹ä¸åˆå¹¶é€»è¾‘æ”¾åˆ°ä¸¤ä¸ªStreamä¸­ï¼Œè¿™æ ·åˆ†åˆ«è§¦å‘å®Œæˆå„è‡ªçš„å¤„ç†é€»è¾‘ï¼Œå°±å¯ä»¥äº†ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561970313-61722f84-8652-466d-9837-45aed4b9b93f.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=nk2b6&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u167e81ac-0d31-4de9-839d-262df97d8f2&title=)

ç”œç‚¹ï¼šå¹¶å‘å’Œå¹¶è¡Œçš„åŒºåˆ«
-----------

å¯¹ä¸€ä¸ªåƒè´§è€Œè¨€ï¼Œä¸»é¤å®Œæ¯•ï¼Œæ€»å¾—æ¥ç‚¹é¤åç”œç‚¹æ‰å¤Ÿæ»¡è¶³ã€‚

åœ¨å‰é¢çš„å†…å®¹ä¸­å‘¢ï¼Œæˆ‘ä»¬å§‹ç»ˆæ˜¯åœ¨å›´ç»•`å¹¶è¡Œ`å¤„ç†è¿™ä¸ªè¯é¢˜åœ¨å±•å¼€ã€‚å®é™…å·¥ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹äºå¹¶å‘è¿™ä¸ªè¯è‚¯å®šä¹Ÿä¸é™Œç”Ÿï¼Œ`é«˜å¹¶å‘`è¿™ä¸ªè¯ï¼Œå°±åƒé«˜ç«¯äººå£«é…’æ¯ä¸­é‚£å…«äºŒå¹´çš„æ‹‰è²ä¸€èˆ¬ï¼Œæˆäº†æ¯ä¸€ä¸ªå¼€å‘äººå‘˜ç®€å†ä¸Šç”¨æ¥å½°æ˜¾å®åŠ›çš„ä¸€ä¸ªæ ‡ç­¾ã€‚

é‚£ä¹ˆï¼Œ**å¹¶å‘**å’Œ**å¹¶è¡Œ**åˆ°åº•å•¥åŒºåˆ«ï¼Ÿè¿™é‡Œæˆ‘ä»¬ä¹Ÿç®€å•çš„æ¦‚æ‹¬ä¸‹ã€‚

### å¹¶å‘

æ‰€è°“**å¹¶å‘**ï¼Œå…¶å…³æ³¨çš„ç‚¹æ˜¯æœåŠ¡å™¨çš„`ååé‡`æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨å¯ä»¥åœ¨å•ä½æ—¶é—´å†…åŒæ—¶å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ã€‚å¹¶å‘æ˜¯é€šè¿‡`å¤šçº¿ç¨‹`çš„æ–¹å¼æ¥å®ç°çš„ï¼Œå……åˆ†åˆ©ç”¨å½“å‰CPUå¤šæ ¸èƒ½åŠ›ï¼ŒåŒæ—¶ä½¿ç”¨å¤šä¸ªè¿›ç¨‹å»å¤„ç†ä¸šåŠ¡ï¼Œä½¿å¾—åŒä¸€ä¸ªæœºå™¨åœ¨ç›¸åŒæ—¶é—´å†…å¯ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œæå‡ååé‡ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658442438417-ecf6709c-a123-449b-88b7-52b2ad1d60f3.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=228&id=u5c55e3a8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=780&originalType=binary&ratio=1&rotation=0&showTitle=false&size=21429&status=done&style=none&taskId=u869a5381-4e84-4a83-80e5-f51f6c97586&title=&width=780)  
æ‰€æœ‰çš„æ“ä½œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¸²è¡Œæ¨è¿›ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ­¥å¤„ç†ï¼Œåˆ™åŒæ—¶æœ‰å¤šä¸ªè¯·æ±‚å¯ä»¥è¢«å¤„ç†ã€‚ä½†æ˜¯å› ä¸ºæ˜¯ä¸²è¡Œå¤„ç†ï¼Œæ‰€ä»¥å¦‚æœæŸä¸ªç¯èŠ‚éœ€è¦å¯¹å¤–äº¤äº’æ—¶ï¼Œæ¯”å¦‚ç­‰å¾…ç½‘ç»œIOçš„æ“ä½œï¼Œä¼šä½¿å¾—å½“å‰çº¿ç¨‹å¤„äº`é˜»å¡çŠ¶æ€`ï¼Œç›´åˆ°èµ„æºå¯ç”¨æ—¶è¢«å”¤é†’ç»§ç»­å¾€åæ‰§è¡Œã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658445304935-a89f08ff-c0f5-49c6-91c8-d504d6674b89.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=187&id=u223cf0d0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=187&originWidth=942&originalType=binary&ratio=1&rotation=0&showTitle=false&size=19471&status=done&style=none&taskId=u1d50f13d-5229-440f-83f2-09c4d315079&title=&width=942)

å¯¹äº**é«˜å¹¶å‘**åœºæ™¯ï¼ŒæœåŠ¡å™¨çš„çº¿ç¨‹èµ„æºæ˜¯éå¸¸å®è´µçš„ã€‚å¦‚æœé¢‘ç¹çš„å¤„äºé˜»å¡åˆ™ä¼šå¯¼è‡´æµªè´¹ï¼Œä¸”çº¿ç¨‹é¢‘ç¹çš„é˜»å¡ã€å”¤é†’åˆ‡æ¢åŠ¨ä½œï¼Œä¹Ÿä¼šåŠ å‰§æ•´ä½“ç³»ç»Ÿçš„æ€§èƒ½æŸè€—ã€‚æ‰€ä»¥å¹¶å‘è¿™ç§å¤šçº¿ç¨‹åœºæ™¯ï¼Œæ›´é€‚åˆ**CPUå¯†é›†å‹**çš„æ“ä½œã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561977679-38a4768d-e548-4378-ba23-58999ecdf98b.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=Qto2Z&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u02b57e4a-f5fb-4e75-a165-dc5ff0d19c7&title=)

### å¹¶è¡Œ

æ‰€è°“**å¹¶è¡Œ**ï¼Œå°±æ˜¯å°†åŒä¸€ä¸ªå¤„ç†æµç¨‹æ²¡æœ‰ç›¸äº’ä¾èµ–çš„éƒ¨åˆ†æ”¾åˆ°å¤šä¸ªçº¿ç¨‹ä¸­è¿›è¡ŒåŒæ—¶å¹¶è¡Œå¤„ç†ï¼Œä»¥æ­¤æ¥è¾¾åˆ°ç›¸å¯¹äºä¸²è¡Œæ¨¡å¼æ›´çŸ­çš„å•æµç¨‹å¤„ç†è€—æ—¶çš„æ•ˆæœï¼Œè¿›è€Œæå‡ç³»ç»Ÿçš„**æ•´ä½“å“åº”æ—¶é•¿**ä¸**ååé‡**ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658442654218-9a33c102-502d-4889-8da2-a2b2852fda3b.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=228&id=u8e0e5976&margin=%5Bobject%20Object%5D&name=image.png&originHeight=228&originWidth=623&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16243&status=done&style=none&taskId=u0b24fc53-bb5a-4c1c-91c9-6e141a82786&title=&width=623)

åŸºäºå¼‚æ­¥ç¼–ç¨‹å®ç°çš„å¹¶è¡Œæ“ä½œä¹Ÿæ˜¯å€ŸåŠ©çº¿ç¨‹æ± çš„æ–¹å¼ï¼Œé€šè¿‡å¤šçº¿ç¨‹åŒæ—¶æ‰§è¡Œæ¥å®ç°æ•ˆç‡æå‡çš„ã€‚ä¸å¹¶å‘çš„åŒºåˆ«åœ¨äºï¼šå¹¶è¡Œé€šè¿‡å°†ä»»åŠ¡åˆ‡åˆ†ä¸ºä¸€ä¸ªä¸ªå¯ç‹¬ç«‹å¤„ç†çš„å°ä»»åŠ¡å—ï¼Œç„¶ååŸºäºç³»ç»Ÿ`è°ƒåº¦ç­–ç•¥`ï¼Œå°†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å—åˆ†é…ç»™ç©ºé—²å¯ç”¨**å·¥ä½œçº¿ç¨‹**å»å¤„ç†ï¼Œå¦‚æœå‡ºç°éœ€è¦ç­‰å¾…çš„åœºæ™¯ï¼ˆæ¯”å¦‚IOè¯·æ±‚ï¼‰åˆ™å·¥ä½œçº¿ç¨‹ä¼šå°†æ­¤ä»»åŠ¡å…ˆæ”¾ä¸‹ï¼Œç»§ç»­å¤„ç†åç»­çš„ä»»åŠ¡ï¼Œç­‰ä¹‹å‰çš„ä»»åŠ¡IOè¯·æ±‚å¥½äº†ä¹‹åï¼Œç³»ç»Ÿé‡æ–°åˆ†é…å¯ç”¨çš„å·¥ä½œçº¿ç¨‹æ¥å¤„ç†ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/29653775/1658445961280-e2426249-6c92-400d-94cc-1ba68dceaae0.png#clientId=u792a68bd-c8a3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=467&id=u061f7f2f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=467&originWidth=966&originalType=binary&ratio=1&rotation=0&showTitle=false&size=36329&status=done&style=none&taskId=u0236ed4b-de4e-49af-86af-7adc7a4a404&title=&width=966)

æ ¹æ®ä¸Šé¢çš„ç¤ºæ„å›¾ä»‹ç»å¯ä»¥çœ‹å‡ºï¼Œå¼‚æ­¥å¹¶è¡Œç¼–ç¨‹ï¼Œå¯¹äºå·¥ä½œçº¿ç¨‹çš„åˆ©ç”¨ç‡ä¸Šå‡ï¼Œä¸ä¼šå‡ºç°å·¥ä½œçº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œä½†æ˜¯å› ä¸ºä»»åŠ¡æ‹†åˆ†ã€å·¥ä½œçº¿ç¨‹é—´çš„åˆ‡æ¢è°ƒåº¦ç­‰**ç³»ç»Ÿå±‚é¢çš„å¼€é”€**ä¹Ÿä¼šéšä¹‹åŠ å¤§ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561982239-78b9fc99-0dd0-41d7-b630-0d5ea058787c.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=XRTjH&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u82afed68-2215-4be0-a351-2d6c6fd75e1&title=)

### å¦‚ä½•é€‰æ‹©

å‰é¢ä»‹ç»äº†ä¸‹å¹¶å‘ä¸å¹¶è¡Œä¸¤ç§æ¨¡å¼çš„ç‰¹ç‚¹ã€ä»¥åŠå„è‡ªçš„ä¼˜ç¼ºç‚¹ã€‚æ‰€ä»¥é€‰æ‹©é‡‡ç”¨å¹¶å‘è¿˜æ˜¯å¹¶è¡Œæ–¹å¼æ¥æå‡ç³»ç»Ÿçš„å¤„ç†æ€§èƒ½ï¼Œè¿˜éœ€è¦ç»“åˆå®é™…é¡¹ç›®åœºæ™¯æ¥ç¡®å®šã€‚

ç»¼åˆè€Œè¨€ï¼š

1.  å¦‚æœä¸šåŠ¡å¤„ç†é€»è¾‘æ˜¯**CPUå¯†é›†å‹**çš„æ“ä½œï¼Œä¼˜å…ˆä½¿ç”¨åŸºäºçº¿ç¨‹æ± å®ç°å¹¶å‘å¤„ç†æ–¹æ¡ˆï¼ˆå¯ä»¥é¿å…çº¿ç¨‹é—´åˆ‡æ¢å¯¼è‡´çš„ç³»ç»Ÿæ€§èƒ½æµªè´¹ï¼‰ã€‚
2.  å¦‚æœä¸šåŠ¡å¤„ç†é€»è¾‘ä¸­å­˜åœ¨è¾ƒå¤š**éœ€è¦é˜»å¡ç­‰å¾…**çš„è€—æ—¶åœºæ™¯ã€ä¸”ç›¸äº’ä¹‹é—´æ²¡æœ‰ä¾èµ–ï¼Œæ¯”å¦‚æœ¬åœ°IOæ“ä½œã€ç½‘ç»œIOè¯·æ±‚ç­‰ç­‰ï¼Œè¿™ç§æƒ…å†µä¼˜å…ˆé€‰æ‹©ä½¿ç”¨**å¹¶è¡Œå¤„ç†ç­–ç•¥**ï¼ˆå¯ä»¥é¿å…å®è´µçš„çº¿ç¨‹èµ„æºè¢«é˜»å¡ç­‰å¾…ï¼‰ã€‚

![](https://cdn.nlark.com/yuque/0/2022/gif/29653775/1658561985953-43cbddd2-012a-4ea7-8d8e-08c5b8d91657.gif#clientId=u10086dc5-53cc-4&crop=0&crop=0&crop=1&crop=1&id=LslmE&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u90e1ad00-b88b-4ad1-a6e5-636543a2faa&title=)

æ€»ç»“å›é¡¾
----

å¥½å•¦ï¼Œå…³äºJAVAä¸­`CompletableFuture`çš„ä½¿ç”¨ï¼Œä»¥åŠå¹¶è¡Œç¼–ç¨‹ç›¸å…³çš„å†…å®¹å‘¢å°±ä»‹ç»åˆ°è¿™é‡Œå•¦ã€‚çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡æ‚¨åº”è¯¥æœ‰æ‰€æ”¶è·å§ï¼Ÿé‚£ä¹ˆä½ çš„é¡¹ç›®é‡Œæœ‰è¿™ç§é€‚åˆå¹¶è¡Œå¤„ç†çš„åœºæ™¯å—ï¼Ÿä½ åœ¨å¤„ç†å¹¶è¡Œåœºæ™¯çš„æ—¶å€™æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ_è¯„è®ºåŒºä¸€èµ·è®¨è®ºä¸‹å§_~~

**è¡¥å……ï¼š**

æœ¬æ–‡ä¸­æœ‰æåŠ**CompletableFuture**æ‰§è¡Œæ—¶æ‰€ä½¿ç”¨çš„é»˜è®¤çº¿ç¨‹æ± æ˜¯`ForkJoinPool`ï¼Œæ—©åœ¨JAVA7ç‰ˆæœ¬å°±å·²ç»è¢«å¼•å…¥ï¼Œä½†æ˜¯å¾ˆå¤šäººå¯¹`ForkJoinPool`ä¸æ˜¯å¾ˆäº†è§£ï¼Œå®é™…é¡¹ç›®ä¸­ä½¿ç”¨çš„ä¹Ÿæ¯”è¾ƒå°‘ã€‚å…¶å®å¯¹`ForkJoinPool`çš„åˆç†åˆ©ç”¨ï¼Œå¯ä»¥è®©æˆ‘ä»¬åœ¨é¢å¯¹æŸäº›å¤šçº¿ç¨‹åœºæ™¯æ—¶ä¼šæ›´åŠ çš„ä»å®¹é«˜æ•ˆã€‚åœ¨åé¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä¼šé’ˆå¯¹`ForkJoinPool`æœ‰å…³çš„å†…å®¹è¿›è¡Œä¸“é—¨çš„ä»‹ç»ä¸æ¢è®¨ï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥ç‚¹ä¸ªå…³æ³¨ï¼ŒåŠæ—¶è·å–åç»­çš„å†…å®¹ã€‚

**æ­¤å¤–**ï¼š

*   å…³äºæœ¬æ–‡ä¸­æ¶‰åŠçš„**æ¼”ç¤ºä»£ç **çš„å®Œæ•´ç¤ºä¾‹ï¼Œæˆ‘å·²ç»æ•´ç†å¹¶æäº¤åˆ°githubä¸­ï¼Œå¦‚æœæ‚¨æœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªå–ï¼š[https://github.com/veezean/JavaBasicSkills](https://github.com/veezean/JavaBasicSkills)

![](https://veezean-pics-1301558317.cos.ap-nanjing.myqcloud.com/pics/202207102124124.gif#crop=0&crop=0&crop=1&crop=1&id=v37zG&originHeight=40&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

**æˆ‘æ˜¯æ‚Ÿé“ï¼ŒèŠæŠ€æœ¯ã€åˆä¸ä»…ä»…èŠæŠ€æœ¯~**

å¦‚æœè§‰å¾—æœ‰ç”¨ï¼Œè¯·**ç‚¹èµ + å…³æ³¨**è®©æˆ‘æ„Ÿå—åˆ°æ‚¨çš„æ”¯æŒã€‚ä¹Ÿå¯ä»¥å…³æ³¨ä¸‹æˆ‘çš„å…¬ä¼—å·ã€æ¶æ„æ‚Ÿé“ã€‘ï¼Œè·å–æ›´åŠæ—¶çš„æ›´æ–°ã€‚

æœŸå¾…ä¸ä½ ä¸€èµ·æ¢è®¨ï¼Œä¸€èµ·æˆé•¿ä¸ºæ›´å¥½çš„è‡ªå·±ã€‚

![](https://veezean-pics-1301558317.cos.ap-nanjing.myqcloud.com/pics/202207091312656.gif)

æœ¬æ–‡æ¥è‡ªåšå®¢å›­ï¼Œä½œè€…ï¼š[æ¶æ„æ‚Ÿé“](https://www.cnblogs.com/softwarearch/)ï¼Œæ¬¢è¿å…³æ³¨å…¬ä¼—å·\[æ¶æ„æ‚Ÿé“\]æŒç»­è·å–æ›´å¤šå¹²è´§ï¼Œè½¬è½½è¯·æ³¨æ˜åŸæ–‡é“¾æ¥ï¼š[https://www.cnblogs.com/softwarearch/p/16516980.html](https://www.cnblogs.com/softwarearch/p/16516980.html)