---
layout: post
title: "200 è¡Œä»£ç å®ç°åŸºäº Paxos çš„ KV å­˜å‚¨"
date: "2022-05-20T09:20:16.260Z"
---
200 è¡Œä»£ç å®ç°åŸºäº Paxos çš„ KV å­˜å‚¨
=========================

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7951706a24af466b9a30c95572ed1fd5~tplv-k3u1fbpfcp-zoom-1.image)

å‰è¨€
--

å†™å®Œã€[paxos çš„ç›´è§‚è§£é‡Š](http://mp.weixin.qq.com/s?__biz=Mzg4NzYzMzk1Mw==&mid=2247485809&idx=1&sn=fa89551eb15131a6fd721007e3aff621&chksm=cf86283ff8f1a1297033da20e2c178956eeb97c42f2e8d7e4460903ae24b72ae5f6793ee6617&scene=21#wechat_redirect)ã€‘ä¹‹åï¼Œç½‘å‹éƒ½è¯´ç–—æ•ˆç”šå¥½ï¼Œä½†æ˜¯ä¹Ÿä¼šå¯¹è¿™ç¯‡æ•™ç¨‹ä¸­ä¸€äº›ç¯èŠ‚æå‡ºç–‘é—®ï¼ˆæœ‰ç–‘é—®è¯´æ˜çœŸçš„çœ‹æ‡‚äº† ğŸ¤”ï¼‰ï¼Œä¾‹å¦‚æ€ä¹ˆæŠŠåªèƒ½ç¡®å®šä¸€ä¸ªå€¼çš„ paxos åº”ç”¨åˆ°å®é™…åœºæ™¯ä¸­ã€‚

æ—¢ç„¶ **Talk is cheap**ï¼Œé‚£ä¹ˆå°± **Show me the code**ï¼Œè¿™æ¬¡æˆ‘ä»¬æŠŠæ•™ç¨‹ä¸­æè¿°çš„å†…å®¹ç›´æ¥ç”¨ä»£ç å®ç°å‡ºæ¥ï¼Œå¸Œæœ›èƒ½è¦†ç›–åˆ°æ•™ç¨‹ä¸­çš„æ¶‰åŠçš„æ¯ä¸ªç»†èŠ‚ã€‚å¸®åŠ©å¤§å®¶ç†è§£ paxos çš„è¿è¡Œæœºåˆ¶ã€‚

**è¿™æ˜¯ä¸€ä¸ªåŸºäº paxosï¼Œ200 è¡Œä»£ç çš„ kv å­˜å‚¨ç³»ç»Ÿçš„ç®€å•å®ç°ï¼Œä½œä¸º** **ã€** [**paxos çš„ç›´è§‚è§£é‡Š**](http://mp.weixin.qq.com/s?__biz=Mzg4NzYzMzk1Mw==&mid=2247485809&idx=1&sn=fa89551eb15131a6fd721007e3aff621&chksm=cf86283ff8f1a1297033da20e2c178956eeb97c42f2e8d7e4460903ae24b72ae5f6793ee6617&scene=21#wechat_redirect) **ã€‘** **è¿™ç¯‡æ•™ç¨‹ä¸­çš„ä»£ç ç¤ºä¾‹éƒ¨åˆ†**ã€‚Paxos çš„åŸç†æœ¬æ–‡ä¸å†ä»‹ç»äº†ï¼Œæœ¬æ–‡æåˆ°çš„æ•°æ®ç»“æ„ä½¿ç”¨ã€protobufã€‘å®šä¹‰ï¼Œç½‘ç»œéƒ¨åˆ†ä½¿ç”¨ã€grpcã€‘å®šä¹‰ã€‚å¦å¤– 200 è¡Œ go ä»£ç å®ç° paxos å­˜å‚¨ã€‚

æ–‡ä¸­çš„ä»£ç å¯èƒ½åšäº†ç®€åŒ–, å®Œæ•´ä»£ç å®ç°åœ¨ã€paxoskvã€‘è¿™ä¸ªé¡¹ç›®ä¸­ï¼ˆnaive åˆ†æ”¯ï¼‰ã€‚

è¿è¡Œå’Œä½¿ç”¨
-----

**è·‘ä¸€ä¸‹ï¼š**

    git clone https://github.com/openacid/paxoskv.git
    cd paxoskv
    go test -v ./...
    

è¿™ä¸ªé¡¹ç›®ä¸­é™¤äº† paxos å®ç°ï¼Œç”¨ 3 ä¸ª test case æè¿°äº† 3 ä¸ª paxos è¿è¡Œçš„ä¾‹å­ï¼Œ

*   ã€TestCase1SingleProposerã€‘ï¼šæ— å†²çªè¿è¡Œã€‚
*   ã€TestCase2DoubleProposerã€‘ï¼šæœ‰å†²çªè¿è¡Œã€‚
*   ã€Example\_setAndGetByKeyVerã€‘ä½œä¸º key-val ä½¿ç”¨ã€‚

æµ‹è¯•ä»£ç æè¿°äº†å‡ ä¸ª paxos è¿è¡Œä¾‹å­çš„è¡Œä¸ºï¼Œè¿è¡Œæµ‹è¯•å¯ä»¥ç¡®è®¤ paxos çš„å®ç°ç¬¦åˆé¢„æœŸã€‚

æœ¬æ–‡ä¸­ protobuf çš„æ•°æ®ç»“æ„å®šä¹‰å¦‚ä¸‹ï¼š

    service PaxosKV {
        rpc Prepare (Proposer) returns (Acceptor) {}
        rpc Accept (Proposer) returns (Acceptor) {}
    }
    message BallotNum {
        int64 N          = 1;
        int64 ProposerId = 2;
    }
    message Value {
        int64 Vi64 = 1;
    }
    message PaxosInstanceId {
        string Key = 1;
        int64  Ver = 2;
    }
    message Acceptor {
        BallotNum LastBal = 1;
        Value     Val     = 2;
        BallotNum VBal    = 3;
    }
    message Proposer {
        PaxosInstanceId Id  = 1;
        BallotNum       Bal = 2;
        Value           Val = 3;
    }
    

  
ä»¥åŠä¸»è¦çš„å‡½æ•°å®ç°ï¼š

    // struct KVServer
    Storage : map[string]Versions
    func Accept(c context.Context, r *Proposer) (*Acceptor, error)
    func Prepare(c context.Context, r *Proposer) (*Acceptor, error)
    func getLockedVersion(id *PaxosInstanceId) *Version
    
    // struct Proposer
    func Phase1(acceptorIds []int64, quorum int) (*Value, *BallotNum, error)
    func Phase2(acceptorIds []int64, quorum int) (*BallotNum, error)
    func RunPaxos(acceptorIds []int64, val *Value) *Value
    func rpcToAll(acceptorIds []int64, action string) []*Acceptor
    
    func ServeAcceptors(acceptorIds []int64) []*grpc.Server
    

ä»å¤´å®ç° Paxoskv
------------

**Paxos ç›¸å…³çš„æ•°æ®ç»“æ„**

åœ¨è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬çš„æ•°æ®ç»“æ„å’ŒæœåŠ¡æ¡†æ¶ä½¿ç”¨ã€protobufã€‘å’Œã€grpcã€‘å®ç°ï¼Œé¦–å…ˆæ˜¯æœ€åº•å±‚çš„ paxos æ•°æ®ç»“æ„ï¼šProposer å’Œ Acceptoråœ¨ã€slide-27ã€‘ä¸­æˆ‘ä»¬ä»‹ç»äº† 1 ä¸ª Acceptor æ‰€éœ€çš„å­—æ®µï¼š

> åœ¨å­˜å‚¨ç«¯ï¼ˆAcceptorï¼‰ä¹Ÿæœ‰å‡ ä¸ªæ¦‚å¿µï¼š
> 
> *   last\_rnd æ˜¯ Acceptor è®°ä½çš„æœ€åä¸€æ¬¡è¿›è¡Œå†™å‰è¯»å–çš„ Proposerï¼ˆå®¢æˆ·ç«¯ï¼‰æ˜¯è°ï¼Œä»¥æ­¤æ¥å†³å®šè°å¯ä»¥åœ¨åé¢çœŸæ­£æŠŠä¸€ä¸ªå€¼å†™åˆ°å­˜å‚¨ä¸­ã€‚
> *   v æ˜¯æœ€åè¢«å†™å…¥çš„å€¼ã€‚
> *   vrnd è·Ÿ v æ˜¯ä¸€å¯¹, å®ƒè®°å½•äº†åœ¨å“ªä¸ª Round ä¸­ v è¢«å†™å…¥äº†ã€‚

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/149bd02a39fc4121bce7f0f97fd97770~tplv-k3u1fbpfcp-zoom-1.image)

åŸæ–‡ä¸­è¿™äº›åè¯æ˜¯å‚è€ƒäº†ã€paxos made simpleã€‘ä¸­çš„åç§°ï¼Œä½†åœ¨ã€Leslie Lamportã€‘åé¢çš„å‡ ç¯‡ paper ä¸­éƒ½æ¢äº†åç§°ï¼Œä¸ºäº†åç»­æ–¹ä¾¿ï¼Œåœ¨ã€paxoskvã€‘çš„ä»£ç å®ç°ä¸­ä¹Ÿåšäº†ç›¸åº”çš„æ›¿æ¢ï¼š

    rnd      ==> Bal   // æ¯ä¸€è½®paxosçš„ç¼–å·, BallotNum
    vrnd     ==> VBal  // åœ¨å“ªä¸ªBallotä¸­vè¢«Acceptor æ¥å—(voted)
    last_rnd ==> LastBal
    

Proposer çš„å­—æ®µä¹Ÿå¾ˆç®€å•ï¼Œå®ƒéœ€è¦è®°å½•ï¼š

*   å½“å‰çš„ ballot numberï¼šBalï¼Œ
*   ä»¥åŠå®ƒé€‰æ‹©åœ¨ Phase2 è¿è¡Œçš„å€¼ï¼šValï¼ˆã€slide-29ã€‘ï¼‰ã€‚

äºæ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ç”¨ protobuf å®šä¹‰è¿™ä¸¤ä¸ªè§’è‰²çš„æ•°æ®ç»“æ„ï¼Œå¦‚ä»£ç ã€paxoskv.protoã€‘ä¸­çš„å£°æ˜ï¼Œå¦‚ä¸‹ï¼š

    message Acceptor {
      BallotNum LastBal = 1;
      Value     Val = 2;
      BallotNum VBal = 3;
    }
    
    message Proposer {
      PaxosInstanceId Id = 1;
    
      BallotNum Bal = 2;
      Value     Val = 3;
    }
    

å…¶ä¸­ Proposer è¿˜éœ€è¦ä¸€ä¸ª PaxosInstanceIdï¼Œæ¥æ ‡è¯†å½“å‰çš„ paxos å®ä¾‹ä¸ºå“ªä¸ª key çš„å“ªä¸ª version åœ¨åšå†³å®šï¼Œã€paxos made simpleã€‘ä¸­åªæè¿°äº†ä¸€ä¸ª paxos å®ä¾‹çš„ç®—æ³•ï¼ˆå¯¹åº”ä¸€ä¸ª key çš„ä¸€æ¬¡ä¿®æ”¹ï¼‰ï¼Œè¦å®ç°å¤šæ¬¡ä¿®æ”¹ï¼Œå°±éœ€è¦å¢åŠ è¿™ä¸ªå­—æ®µæ¥åŒºåˆ†ä¸åŒçš„ paxos å®ä¾‹ï¼š

    message PaxosInstanceId {
      string Key = 1;
      int64  Ver = 2;
    }
    

ã€paxoskv.protoã€‘è¿˜å®šä¹‰äº†ä¸€ä¸ª BallotNumï¼Œå› ä¸ºè¦ä¿è¯å…¨ç³»ç»Ÿå†…çš„ BallotNum éƒ½æœ‰åºä¸”ä¸é‡å¤ï¼Œä¸€èˆ¬çš„åšæ³•å°±æ˜¯ç”¨ä¸€ä¸ªæœ¬åœ°å•è°ƒé€’å¢çš„æ•´æ•°ï¼Œå’Œä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ id ç»„åˆèµ·æ¥å®ç°ï¼š

    message BallotNum {
        int64 N = 1;
        int64 ProposerId = 2;
    }
    

**å®šä¹‰ RPC æ¶ˆæ¯ç»“æ„**

RPC æ¶ˆæ¯å®šä¹‰äº† Proposer å’Œ Acceptor ä¹‹é—´çš„é€šè®¯ã€‚

åœ¨ä¸€ä¸ª paxos ç³»ç»Ÿä¸­ï¼Œè‡³å°‘è¦æœ‰ 4 ä¸ªæ¶ˆæ¯ï¼š

*   Phase 1 çš„ Prepare-requestï¼ŒPrepare-reply
*   Phase 2 çš„ Accept-requestï¼ŒAccept-reply

å¦‚ã€slide-28ã€‘æ‰€æè¿°çš„ï¼ˆåŸæ–‡ä¸­ä½¿ç”¨ rndï¼Œè¿™é‡Œä½¿ç”¨ Balï¼Œéƒ½æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼‰ï¼š

> Phase- 1ï¼ˆPrepareï¼‰ï¼š
> 
>     request:
>         Bal: int
>     
>     reply:
>         LastBal: int
>         Val:     string
>         VBal:    int
>     
> 
> Phase- 2ï¼ˆAcceptï¼‰ï¼š
> 
>     request:
>         Bal: int
>         Val:   string
>     
>     reply:
>         LastBal: int
>     

åœ¨ Prepare-request æˆ– Accept-request ä¸­ï¼Œå‘é€çš„æ˜¯ä¸€éƒ¨åˆ†æˆ–å…¨éƒ¨çš„ Proposer çš„å­—æ®µï¼Œå› æ­¤æˆ‘ä»¬åœ¨ä»£ç ä¸­ï¼š

*   ç›´æ¥æŠŠ Proposer çš„ç»“æ„ä½“ä½œä¸º request çš„ç»“æ„ä½“
*   åŒæ ·æŠŠ Acceptor çš„ç»“æ„ä½“ä½œä¸º reply çš„ç»“æ„ä½“

åœ¨ä½¿ç”¨çš„æ—¶å€™åªä½¿ç”¨å…¶ä¸­å‡ ä¸ªå­—æ®µï¼Œå¯¹åº”æˆ‘ä»¬çš„ RPC æœåŠ¡ã€PaxosKVã€‘å®šä¹‰å¦‚ä¸‹ï¼š

    service PaxosKV {
        rpc Prepare (Proposer) returns (Acceptor) {}
        rpc Accept (Proposer) returns (Acceptor) {}
    }
    

ä½¿ç”¨ Protobuf å’Œ Grpc ç”ŸæˆæœåŠ¡æ¡†æ¶
-------------------------

ğŸš€

protobuf å¯ä»¥å°†ã€paxoskv.protoã€‘ç›´æ¥ç”Ÿæˆ go ä»£ç ï¼ˆä»£ç åº“ä¸­å·²ç»åŒ…å«äº†ç”Ÿæˆå¥½çš„ä»£ç ï¼šã€paxoskv.pb.goã€‘ï¼Œåªæœ‰ä¿®æ”¹ã€paxoskv.protoã€‘ä¹‹åæ‰éœ€è¦é‡æ–°ç”Ÿæˆï¼‰

*   é¦–å…ˆå®‰è£… protobuf çš„ç¼–è¯‘å™¨ protocï¼Œå¯ä»¥æ ¹æ®ã€install-protocã€‘ä¸­çš„æ­¥éª¤å®‰è£…, ä¸€èˆ¬ç®€å•çš„ä¸€è¡Œå‘½ä»¤å°±å¯ä»¥äº†ï¼šå®‰è£…å¥½ä¹‹åé€šè¿‡ protoc--version ç¡®è®¤ç‰ˆæœ¬ï¼Œè‡³å°‘åº”è¯¥æ˜¯ 3.x: libprotoc 3.13.0
*   *   Linuxï¼šapt install-y protobuf-compiler
    *   Macï¼šbrew install protobuf
*   å®‰è£… protoc çš„ go è¯­è¨€ç”Ÿæˆæ’ä»¶ protoc-gen-goï¼šgo get -u github.com/golang/protobuf/protoc-gen-go
*   é‡æ–°ç¼–è¯‘ protokv.proto æ–‡ä»¶ï¼šç›´æ¥ make gen æˆ–ï¼š

      protoc 
          --proto_path=proto 
          --go_out=plugins=grpc:paxoskv 
          paxoskv.proto
    

ç”Ÿæˆåçš„ã€paxoskv.pb.goã€‘ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä¸­ä¸»è¦çš„æ•°æ®ç»“æ„ä¾‹å¦‚ Acceptor çš„å®šä¹‰ï¼š

    type Acceptor struct {
      LastBal *BallotNum ...
      Val     *Value ...
      VBal    *BallotNum ...
            ...
    }
    

ä»¥åŠ KV æœåŠ¡çš„ client ç«¯å’Œ server ç«¯çš„ä»£ç ï¼Œclient ç«¯æ˜¯å®ç°å¥½çš„ï¼Œserver ç«¯åªæœ‰ä¸€ä¸ª interfaceï¼Œåé¢æˆ‘ä»¬éœ€è¦æ¥å®Œæˆå®ƒçš„å®ç°ï¼š

    type paxosKVClient struct {
      cc *grpc.ClientConn
    }
    type PaxosKVClient interface {
      Prepare(
        ctx context.Context,
        in *Proposer,
        opts ...grpc.CallOption
      ) (*Acceptor, error)
    
      Accept(
        ctx context.Context,
        in *Proposer,
        opts ...grpc.CallOption
      ) (*Acceptor, error)
    }
    
    type PaxosKVServer interface {
      Prepare(context.Context,
              *Proposer) (*Acceptor, error)
      Accept(context.Context,
             *Proposer) (*Acceptor, error)
    }
    

å®ç°å­˜å‚¨çš„æœåŠ¡å™¨ç«¯
---------

ã€impl.goã€‘æ˜¯æ‰€æœ‰å®ç°éƒ¨åˆ†ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª KVServer ç»“æ„ä½“ï¼Œç”¨æ¥å®ç° grpc æœåŠ¡çš„ interface PaxosKVServerï¼›å…¶ä¸­ä½¿ç”¨ä¸€ä¸ªå†…å­˜é‡Œçš„ map ç»“æ„æ¨¡æ‹Ÿæ•°æ®çš„å­˜å‚¨ï¼š

    type Version struct {
      mu       sync.Mutex
      acceptor Acceptor
    }
    type Versions map[int64]*Version
    type KVServer struct {
      mu      sync.Mutex
      Storage map[string]Versions
    }
    

å…¶ä¸­ Version å¯¹åº”ä¸€ä¸ª key çš„ä¸€æ¬¡å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”ä¸€ä¸ª paxos å®ä¾‹ï¼ŒVersions å¯¹åº”ä¸€ä¸ª key çš„ä¸€ç³»åˆ—å˜åŒ–ï¼ŒStorage å°±æ˜¯æ‰€æœ‰ key çš„æ‰€æœ‰å˜åŒ–ã€‚

### å®ç° Acceptor çš„ grpc æœåŠ¡ handler

Acceptorï¼Œæ˜¯è¿™ä¸ªç³»ç»Ÿé‡Œçš„ server ç«¯ï¼Œç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç­‰å¾… Proposer å‘æ¥çš„è¯·æ±‚å¹¶å¤„ç†ï¼Œç„¶åç»™å‡ºåº”ç­”ã€‚

æ ¹æ® paxos çš„å®šä¹‰ï¼ŒAcceptor çš„é€»è¾‘å¾ˆç®€å•ï¼šåœ¨ã€slide-28ã€‘ä¸­æè¿°ï¼š

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9519d8f1860f4f34b3b4833caaf22cb8~tplv-k3u1fbpfcp-zoom-1.image)

æ ¹æ®æ•™ç¨‹é‡Œçš„æè¿°ï¼Œä¸º KVServer å®šä¹‰ handle Prepare-request çš„ä»£ç ï¼š

    func (s *KVServer) Prepare(
        c context.Context,
        r *Proposer) (*Acceptor, error) {
    
      v := s.getLockedVersion(r.Id)
      defer v.mu.Unlock()
    
      reply := v.acceptor
    
      if r.Bal.GE(v.acceptor.LastBal) {
        v.acceptor.LastBal = r.Bal
      }
    
      return &reply, nil
    }
    

è¿™æ®µä»£ç åˆ† 3 æ­¥ï¼š

*   å–å¾— paxos å®ä¾‹ï¼Œ
*   ç”Ÿæˆåº”ç­”ï¼šAcceptor æ€»æ˜¯è¿”å› LastBalï¼ŒValï¼ŒVBal Â è¿™ 3 ä¸ªå­—æ®µï¼Œæ‰€ä»¥ç›´æ¥æŠŠ Acceptor èµ‹å€¼ç»™ replyã€‚
*   æœ€åæ›´æ–° Acceptor çš„çŠ¶æ€ï¼šç„¶åæŒ‰ç…§ paxos ç®—æ³•æè¿°ï¼Œå¦‚æœè¯·æ±‚ä¸­çš„ ballot number æ›´å¤§ï¼Œåˆ™è®°å½•ä¸‹æ¥ï¼Œè¡¨ç¤ºä¸åœ¨æ¥å—æ›´å° ballot number çš„ Proposerã€‚

å…¶ä¸­ getLockedVersion() ä» KVServer.Storage ä¸­æ ¹æ® request å‘æ¥çš„PaxosInstanceId ä¸­çš„å­—æ®µ key å’Œ ver è·å–ä¸€ä¸ªæŒ‡å®š Acceptor çš„å®ä¾‹ï¼š

    func (s *KVServer) getLockedVersion(
        id *PaxosInstanceId) *Version {
    
      s.mu.Lock()
      defer s.mu.Unlock()
    
      key := id.Key
      ver := id.Ver
      rec, found := s.Storage[key]
      if !found {
        rec = Versions{}
        s.Storage[key] = rec
      }
    
      v, found := rec[ver]
      if !found {
        // initialize an empty paxos instance
        rec[ver] = &Version{
          acceptor: Acceptor{
            LastBal: &BallotNum{},
            VBal:    &BallotNum{},
          },
        }
        v = rec[ver]
      }
    
      v.mu.Lock()
      return v
    }
    

handle Accept-request çš„å¤„ç†ç±»ä¼¼ï¼Œåœ¨ã€slide-31ã€‘ä¸­æè¿°ï¼š

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/822af0c52ef34adf978448d79b0b2fc1~tplv-k3u1fbpfcp-zoom-1.image)

Accept() è¦è®°å½• 3 ä¸ªå€¼ï¼Œ

*   LastBalï¼šAcceptor çœ‹åˆ°çš„æœ€å¤§çš„ ballot numberï¼›
*   Valï¼šProposer é€‰æ‹©çš„å€¼ï¼Œ
*   ä»¥åŠ VBalï¼šProposer çš„ ballot numberï¼š

    func (s *KVServer) Accept(
        c context.Context,
        r *Proposer) (*Acceptor, error) {
    
      v := s.getLockedVersion(r.Id)
      defer v.mu.Unlock()
    
      reply := Acceptor{
        LastBal: &*v.acceptor.LastBal,
      }
    
      if r.Bal.GE(v.acceptor.LastBal) {
        v.acceptor.LastBal = r.Bal
        v.acceptor.Val = r.Val
        v.acceptor.VBal = r.Bal
      }
    
      return &reply, nil
    }
    

Acceptor çš„é€»è¾‘åˆ°æ­¤å®Œæ•´äº†ï¼Œå†çœ‹ Proposerï¼š

**å®ç° Proposer é€»è¾‘**

Proposer çš„è¿è¡Œåˆ† 2 ä¸ªé˜¶æ®µï¼ŒPhase1 å’Œ Phase2ï¼Œä¸ Prepare å’Œ Accept å¯¹åº”ã€‚

**Phase1**

åœ¨ã€impl.goã€‘çš„å®ç°ä¸­ï¼ŒProposer.Phase1()Â å‡½æ•°è´Ÿè´£ Phase1 çš„é€»è¾‘ï¼š

    func (p *Proposer) Phase1(
        acceptorIds []int64,
        quorum int) (*Value, *BallotNum, error) {
    
      replies := p.rpcToAll(acceptorIds, "Prepare")
    
      ok := 0
      higherBal := *p.Bal
      maxVoted := &Acceptor{VBal: &BallotNum{}}
    
      for _, r := range replies {
        if !p.Bal.GE(r.LastBal) {
          higherBal = *r.LastBal
          continue
        }
    
        if r.VBal.GE(maxVoted.VBal) {
          maxVoted = r
        }
    
        ok += 1
        if ok == quorum {
          return maxVoted.Val, nil, nil
        }
      }
    
      return nil, &higherBal, NotEnoughQuorum
    }
    

è¿™æ®µä»£ç é¦–å…ˆé€šè¿‡ rpcToAll() å‘æ‰€æœ‰ Acceptor å‘é€ Prepare-request è¯·æ±‚ï¼Œ ç„¶åæ‰¾å‡ºæ‰€æœ‰çš„æˆåŠŸçš„ replyï¼š

*   å¦‚æœå‘ç°ä¸€ä¸ªæ›´å¤§çš„ ballot numberï¼Œè¡¨ç¤ºä¸€ä¸ª Prepare å¤±è´¥ï¼šæœ‰æ›´æ–°çš„Proposer å­˜åœ¨ï¼›
*   å¦åˆ™ï¼Œå®ƒæ˜¯ä¸€ä¸ªæˆåŠŸçš„åº”ç­”ï¼Œå†çœ‹å®ƒæœ‰æ²¡æœ‰è¿”å›ä¸€ä¸ªå·²ç»è¢« Acceptor æ¥å—ï¼ˆvotedï¼‰çš„å€¼ã€‚

æœ€åï¼ŒæˆåŠŸåº”ç­”å¦‚æœè¾¾åˆ°å¤šæ•°æ´¾ï¼ˆquorumï¼‰ï¼Œåˆ™è®¤ä¸º Phase1 å®Œæˆï¼Œè¿”å›æœ€åä¸€ä¸ªè¢« voted çš„å€¼ï¼Œä¹Ÿå°±æ˜¯ VBal æœ€å¤§çš„é‚£ä¸ªã€‚è®©ä¸Šå±‚è°ƒç”¨è€…ç»§ç»­ Phase2ï¼›å¦‚æœæ²¡æœ‰è¾¾åˆ° quorumï¼Œè¿™æ—¶å¯èƒ½æ˜¯æœ‰å¤šä¸ª Proposer å¹¶å‘è¿è¡Œè€Œé€ æˆå†²çªï¼Œæœ‰æ›´å¤§çš„ ballot numberï¼Œè¿™æ—¶åˆ™æŠŠè§åˆ°çš„æœ€å¤§ ballot number è¿”å›ï¼Œç”±ä¸Šå±‚è°ƒç”¨è€…æå‡ ballot number å†é‡è¯•ã€‚

**client ä¸ server ç«¯çš„è¿æ¥**

ä¸Šé¢ç”¨åˆ°çš„ rpcToAll åœ¨è¿™ä¸ªé¡¹ç›®ä¸­çš„å®ç° client ç«¯ï¼ˆProposerï¼‰åˆ° server ç«¯ï¼ˆAcceptorï¼‰çš„é€šè®¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªååˆ† ç®€æ´ç¾è§‚ ç®€é™‹çš„ grpc å®¢æˆ·ç«¯å®ç°ï¼š

    func (p *Proposer) rpcToAll(
        acceptorIds []int64,
        action string) []*Acceptor {
    
      replies := []*Acceptor{}
    
      for _, aid := range acceptorIds {
        var err error
        address := fmt.Sprintf("127.0.0.1:%d",
            AcceptorBasePort+int64(aid))
    
        conn, err := grpc.Dial(
            address, grpc.WithInsecure())
        if err != nil {
          log.Fatalf("did not connect: %v", err)
        }
        defer conn.Close()
    
        c := NewPaxosKVClient(conn)
    
        ctx, cancel := context.WithTimeout(
            context.Background(), time.Second)
        defer cancel()
    
        var reply *Acceptor
        if action == "Prepare" {
          reply, err = c.Prepare(ctx, p)
        } else if action == "Accept" {
          reply, err = c.Accept(ctx, p)
        }
        if err != nil {
          continue
        }
        replies = append(replies, reply)
      }
      return replies
    }
    

#### Phase2

Proposer è¿è¡Œçš„ Phase2 åœ¨ã€slide-30ã€‘ä¸­æè¿°ï¼Œæ¯” Phase1 æ›´ç®€å•ï¼š

> åœ¨ç¬¬ 2 é˜¶æ®µ phase-2ï¼ŒProposer X å°†å®ƒé€‰å®šçš„å€¼å†™å…¥åˆ° Acceptor ä¸­ï¼Œè¿™ä¸ªå€¼å¯èƒ½æ˜¯å®ƒè‡ªå·±è¦å†™å…¥çš„å€¼ï¼Œæˆ–è€…æ˜¯å®ƒä»æŸä¸ª Acceptor ä¸Šè¯»åˆ°çš„ vï¼ˆä¿®å¤ï¼‰ã€‚

    func (p *Proposer) Phase2(
        acceptorIds []int64,
        quorum int) (*BallotNum, error) {
    
      replies := p.rpcToAll(acceptorIds, "Accept")
    
      ok := 0
      higherBal := *p.Bal
      for _, r := range replies {
        if !p.Bal.GE(r.LastBal) {
          higherBal = *r.LastBal
          continue
        }
        ok += 1
        if ok == quorum {
          return nil, nil
        }
      }
    
      return &higherBal, NotEnoughQuorum
    }
    

æˆ‘ä»¬çœ‹åˆ°ï¼Œå®ƒåªéœ€è¦ç¡®è®¤æˆ Phase2 çš„åŠŸåº”ç­”æ•°é‡è¾¾åˆ° quorum å°±å¯ä»¥äº†ã€‚å¦å¤–åŒæ ·å®ƒä¹Ÿæœ‰è´£ä»»åœ¨ Phase2 å¤±è´¥æ—¶è¿”å›çœ‹åˆ°çš„æ›´å¤§çš„ ballot numberï¼Œå› ä¸ºåœ¨ Phase1 å’Œ Phase2 ä¹‹é—´å¯èƒ½æœ‰å…¶ä»– Proposer ä½¿ç”¨æ›´å¤§çš„ ballot number æ‰“æ–­äº†å½“å‰ Proposer çš„æ‰§è¡Œï¼Œå°±åƒã€slide-33ã€‘çš„å†²çªè§£å†³çš„ä¾‹å­ä¸­æè¿°çš„é‚£æ ·ã€‚

å®Œæ•´çš„ Paxos é€»è¾‘
------------

å®Œæ•´çš„ paxos ç”± Proposer è´Ÿè´£ï¼ŒåŒ…æ‹¬ï¼šå¦‚ä½•é€‰æ‹©ä¸€ä¸ªå€¼ï¼Œä½¿å¾—ä¸€è‡´æ€§å¾—ä»¥ä¿è¯ã€‚å¦‚ã€slide-29ã€‘ä¸­æè¿°çš„ï¼š

> Proposer X æ”¶åˆ°å¤šæ•°ï¼ˆquorumï¼‰ä¸ªåº”ç­”ï¼Œå°±è®¤ä¸ºæ˜¯å¯ä»¥ç»§ç»­è¿è¡Œçš„ã€‚å¦‚æœæ²¡æœ‰è”ç³»åˆ°å¤šäºåŠæ•°çš„ acceptorï¼Œæ•´ä¸ªç³»ç»Ÿå°± hang ä½äº†ï¼Œè¿™ä¹Ÿæ˜¯ paxos å£°ç§°çš„åªèƒ½è¿è¡Œå°‘äºåŠæ•°çš„èŠ‚ç‚¹å¤±æ•ˆã€‚è¿™æ—¶ Proposer é¢ä¸´ 2 ç§æƒ…å†µï¼šæ‰€æœ‰åº”ç­”ä¸­éƒ½æ²¡æœ‰ä»»ä½•éç©ºçš„ vï¼Œè¿™è¡¨ç¤ºç³»ç»Ÿä¹‹å‰æ˜¯å¹²å‡€çš„ï¼Œæ²¡æœ‰ä»»ä½•å€¼å·²ç»è¢«å…¶ä»– paxos å®¢æˆ·ç«¯å®Œæˆäº†å†™å…¥ï¼ˆå› ä¸ºä¸€ä¸ªå¤šæ•°æ´¾è¯»ä¸€å®šä¼šçœ‹åˆ°ä¸€ä¸ªå¤šæ•°æ´¾å†™çš„ç»“æœï¼‰ï¼Œè¿™æ—¶ Proposer X ç»§ç»­å°†å®ƒè¦å†™çš„å€¼åœ¨ phase-2 ä¸­çœŸæ­£å†™å…¥åˆ°å¤šäºåŠæ•°çš„ Acceptor ä¸­ã€‚å¦‚æœæ”¶åˆ°äº†æŸä¸ªåº”ç­”åŒ…å«è¢«å†™å…¥çš„ v å’Œ vrndï¼Œè¿™æ—¶ï¼ŒProposer X å¿…é¡»å‡è®¾æœ‰å…¶ä»–å®¢æˆ·ç«¯ï¼ˆProposerï¼‰æ­£åœ¨è¿è¡Œï¼Œè™½ç„¶ X ä¸çŸ¥é“å¯¹æ–¹æ˜¯å¦å·²ç»æˆåŠŸç»“æŸï¼Œä½†ä»»ä½•å·²ç»å†™å…¥çš„å€¼éƒ½ä¸èƒ½è¢«ä¿®æ”¹ï¼æ‰€ä»¥ X å¿…é¡»ä¿æŒåŸæœ‰çš„å€¼ã€‚äºæ˜¯ X å°†çœ‹åˆ°çš„æœ€å¤§ vrnd å¯¹åº”çš„ v ä½œä¸º X çš„ phase-2 å°†è¦å†™å…¥çš„å€¼ã€‚è¿™æ—¶å®é™…ä¸Šå¯ä»¥è®¤ä¸º X æ‰§è¡Œäº†ä¸€æ¬¡ï¼ˆä¸çŸ¥æ˜¯å¦å·²ç»ä¸­æ–­çš„ï¼‰å…¶ä»–å®¢æˆ·ç«¯ï¼ˆProposerï¼‰çš„ä¿®å¤ã€‚

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9770371af0844731af5faa1935c729d8~tplv-k3u1fbpfcp-zoom-1.image)

åŸºäº Acceptor çš„æœåŠ¡ç«¯å’Œ Proposer 2 ä¸ª Phase çš„å®ç°ï¼Œæœ€åæŠŠè¿™äº›ç¯èŠ‚ç»„åˆåˆ°ä¸€èµ·ç»„æˆä¸€ä¸ªå®Œæ•´çš„ paxosï¼Œåœ¨æˆ‘ä»¬çš„ä»£ç ã€RunPaxosã€‘è¿™ä¸ªå‡½æ•°ä¸­å®Œæˆè¿™äº›äº‹æƒ…ï¼š

    func (p *Proposer) RunPaxos(
        acceptorIds []int64,
        val *Value) *Value {
    
      quorum := len(acceptorIds)/2 + 1
    
      for {
        p.Val = val
    
        maxVotedVal, higherBal, err := p.Phase1(
            acceptorIds, quorum)
    
        if err != nil {
          p.Bal.N = higherBal.N + 1
          continue
        }
    
        if maxVotedVal != nil {
          p.Val = maxVotedVal
        }
    
        // val == nil æ˜¯ä¸€ä¸ªè¯»æ“ä½œ,
        // æ²¡æœ‰è¯»åˆ°votedå€¼ä¸éœ€è¦Phase2
        if p.Val == nil {
          return nil
        }
    
        higherBal, err = p.Phase2(
            acceptorIds, quorum)
    
        if err != nil {
          p.Bal.N = higherBal.N + 1
          continue
        }
    
        return p.Val
      }
    }
    

è¿™æ®µä»£ç å®Œæˆäº†å‡ ä»¶äº‹ï¼šè¿è¡Œ Phase1ï¼Œæœ‰ voted çš„å€¼å°±é€‰å®ƒï¼Œæ²¡æœ‰å°±é€‰è‡ªå·±è¦å†™çš„å€¼ valï¼Œç„¶åè¿è¡Œ Phase2ã€‚  
å°±åƒ Phase1 Phase2 ä¸­æè¿°çš„ä¸€æ ·ï¼Œä»»ä½•ä¸€ä¸ªé˜¶æ®µï¼Œå¦‚æœæ²¡è¾¾åˆ° quorumï¼Œå°±éœ€è¦æå‡é‡åˆ°çš„æ›´å¤§çš„ ballot numberï¼Œé‡è¯•å»è§£å†³é‡åˆ°çš„ ballot number å†²çªã€‚è¿™ä¸ªå‡½æ•°æ¥å— 2 ä¸ªå‚æ•°ï¼š

*   æ‰€æœ‰ Acceptor çš„åˆ—è¡¨ï¼ˆç”¨ä¸€ä¸ªæ•´æ•°çš„ id è¡¨ç¤ºä¸€ä¸ª Acceptorï¼‰ï¼Œ
*   ä»¥åŠè¦æäº¤çš„å€¼ã€‚

å…¶ä¸­ï¼ŒæŒ‰ç…§ paxos çš„æè¿°ï¼Œè¿™ä¸ªå€¼ val ä¸ä¸€å®šèƒ½æäº¤ï¼šå¦‚æœ paxos åœ¨ Phase1 å®Œæˆåçœ‹åˆ°äº†å…¶ä»–å·²ç»æ¥å—çš„å€¼ï¼ˆvoted valueï¼‰ï¼Œé‚£å°±è¦é€‰æ‹©å·²æ¥æ”¶çš„å€¼ï¼Œæ”¾å¼ƒ valã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œä¾‹å¦‚è¦å†™å…¥Â  key=fooï¼Œver=3 çš„å€¼ä¸º barï¼Œå¦‚æœæ²¡èƒ½é€‰æ‹© barï¼Œå°±è¦é€‰æ‹©ä¸‹ä¸€ä¸ªç‰ˆæœ¬Â  key=fooï¼Œver=4 å†å°è¯•å†™å…¥ã€‚è¿™æ ·ä¸æ–­çš„é‡è¯•å¾ªç¯, å†™æ“ä½œæœ€ç»ˆéƒ½èƒ½æˆåŠŸå†™å…¥ä¸€ä¸ªå€¼ï¼ˆvoted valueï¼‰ã€‚

å®ç°è¯»æ“ä½œ
-----

åœ¨æˆ‘ä»¬è¿™ä¸ª NBï¼ˆnaive and basicï¼‰çš„ç³»ç»Ÿä¸­ï¼Œè¯»å’Œå†™ä¸€æ ·éƒ½è¦é€šè¿‡ä¸€æ¬¡ paxos ç®—æ³•æ¥å®Œæˆã€‚å› ä¸ºå†™å…¥è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ paxos æ‰§è¡Œï¼Œè€Œ paxos åªä¿è¯åœ¨ä¸€ä¸ª quorum ä¸­å†™å…¥ç¡®å®šçš„å€¼ï¼Œä¸ä¿è¯æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ªå€¼ã€‚å› æ­¤ä¸€æ¬¡è¯»æ“ä½œå¦‚æœè¦è¯»åˆ°æœ€åå†™å…¥çš„å€¼ï¼Œè‡³å°‘è¦è¿›è¡Œä¸€æ¬¡å¤šæ•°æ´¾è¯»ã€‚

ä½†å¤šæ•°æ´¾è¯»è¿˜ä¸å¤Ÿï¼šå®ƒå¯èƒ½è¯»åˆ°ä¸€ä¸ªæœªå®Œæˆçš„ paxos å†™å…¥ï¼Œå¦‚ã€slide-11ã€‘ä¸­æè¿°çš„è„è¯»é—®é¢˜ï¼Œè¯»å–åˆ°çš„æœ€å¤§ VBal çš„å€¼ï¼Œå¯èƒ½ä¸æ˜¯ç¡®å®šçš„å€¼ï¼ˆå†™å…¥åˆ°å¤šæ•°æ´¾ï¼‰ã€‚

ä¾‹å¦‚ä¸‹é¢çš„çŠ¶æ€ï¼š

    Val=foo    Val=bar    ?
    VBal=3     VBal=2     ?
    -------    -------    --
    A0         A1         A2
    

å¦‚æœ Proposer è¯•å›¾è¯»ï¼Œåœ¨ Phase1 è”ç³»åˆ° A0 A1 è¿™ 2 ä¸ª Acceptorï¼Œé‚£ä¹ˆ foo å’Œ bar è¿™ 2 ä¸ªå€¼å“ªä¸ªæ˜¯ç¡®å®šä¸‹æ¥çš„ï¼Œè¦å–å†³äº A2 çš„çŠ¶æ€ã€‚æ‰€ä»¥è¿™æ—¶è¦å†æŠŠæœ€å¤§VBal çš„å€¼è·‘å®Œä¸€æ¬¡ Â Phase2ï¼Œè®©å®ƒè¢«ç¡®å®šä¸‹æ¥ï¼Œç„¶åæ‰èƒ½æŠŠç»“æœè¿”å›ç»™ä¸Šå±‚ï¼ˆå¦åˆ™å¦ä¸€ä¸ª Proposer å¯èƒ½è”ç³»åˆ° A1 å’Œ A2ï¼Œç„¶åè®¤ä¸º Val=bar æ˜¯è¢«ç¡®å®šçš„å€¼ï¼‰ã€‚

å½“ç„¶å¦‚æœ Proposer åœ¨è¯»å–æµç¨‹çš„ Phase1 æˆåŠŸåæ²¡æœ‰çœ‹åˆ°ä»»ä½•å·²ç» voted çš„å€¼ï¼ˆä¾‹å¦‚æ²¡æœ‰çœ‹åˆ° foo æˆ– barï¼‰ï¼Œ å°±ä¸ç”¨è·‘ Phase2 äº†ã€‚

æ‰€ä»¥åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼Œè¯»æ“ä½œä¹Ÿæ˜¯ä¸€æ¬¡ã€RunPaxosã€‘å‡½æ•°çš„è°ƒç”¨ï¼Œé™¤äº†å®ƒå¹¶ä¸ propose ä»»ä½•æ–°çš„å€¼ï¼Œä¸ºäº†æ”¯æŒè¯»æ“ä½œï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ä»£ç ä¸­ Phase2 ä¹‹å‰åŠ å…¥ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœä¼ å…¥çš„ val å’Œå·² voted çš„å€¼éƒ½ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼š

    if p.Val == nil {
      return nil
    }
    

ã€Example\_setAndGetByKeyVerã€‘è¿™ä¸ªæµ‹è¯•ç”¨ä¾‹å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ paxos å®ç°ä¸€ä¸ª kv å­˜å‚¨ï¼Œå®ç°è¯»å’Œå†™çš„ä»£ç å¤§æ¦‚è¿™æ ·ï¼š

    prop := Proposer{
      Id: &PaxosInstanceId{
        Key: "foo",
        Ver: 0,
      },
      Bal: &BallotNum{N: 0, ProposerId: 2},
    }
    
    // å†™:
    v := prop.RunPaxos(acceptorIds, &Value{Vi64: 5})
    
    // è¯»:
    v := prop.RunPaxos(acceptorIds, nil)
    

åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæœ¬æ–‡ä¸­æ¶‰åŠåˆ°çš„åŠŸèƒ½éƒ½å®ç°å®Œäº†ï¼Œå®Œæ•´å®ç°åœ¨ã€impl.goã€‘ä¸­ã€‚

æ¥ç€æˆ‘ä»¬ç”¨æµ‹è¯•ç”¨ä¾‹å®ç° 1 ä¸‹ã€[paxosçš„ç›´è§‚è§£é‡Š](http://mp.weixin.qq.com/s?__biz=MjM5OTMwNjg5OA==&mid=2247483755&idx=1&sn=a003733b34de44e6df5b8b609cd90397&chksm=a73c3296904bbb807a617e188124d980c8b7dcae583d8615436b41f9b3b3d05a0aa3a274877b&scene=21#wechat_redirect)ã€‘ä¸­åˆ—å‡ºçš„ 2 ä¸ªä¾‹å­, ä»ä»£ç çœ‹ poxos çš„è¿è¡Œï¼š

æ–‡ä¸­ä¾‹å­
----

ç¬¬1ä¸ªä¾‹å­æ˜¯ paxos æ— å†²çªçš„è¿è¡Œã€slide-32ã€‘ï¼š

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f2ce566bcb8f4e2fa6ff1a3cd25b9640~tplv-k3u1fbpfcp-zoom-1.image)

æŠŠå®ƒå†™æˆ test caseï¼Œç¡®è®¤æ•™ç¨‹ä¸­æ¯æ­¥æ“ä½œä¹‹åçš„ç»“æœéƒ½å¦‚é¢„æœŸ ã€TestCase1SingleProposerã€‘ï¼š

    func TestCase1SingleProposer(t *testing.T) {
      ta := require.New(t)
    
      acceptorIds := []int64{0, 1, 2}
      quorum := 2
    
      // å¯åŠ¨3ä¸ªAcceptorçš„æœåŠ¡
      servers := ServeAcceptors(acceptorIds)
      defer func() {
        for _, s := range servers {
          s.Stop()
        }
      }()
    
      // ç”¨è¦æ›´æ–°çš„keyå’Œversionå®šä¹‰paxos å®ä¾‹çš„id
      paxosId := &PaxosInstanceId{
        Key: "i",
        Ver: 0,
      }
    
      var val int64 = 10
    
      // å®šä¹‰Proposer, éšä¾¿é€‰ä¸ªProposer id 10.
      var pidx int64 = 10
      px := Proposer{
        Id:  paxosId,
        Bal: &BallotNum{N: 0, ProposerId: pidx},
      }
    
      // ç”¨å·¦è¾¹2ä¸ªAcceptorè¿è¡ŒPhase1,
      // æˆåŠŸ, æ²¡æœ‰çœ‹åˆ°å…¶ä»–çš„ballot number
      latestVal, higherBal, err := px.Phase1(
          []int64{0, 1}, quorum)
    
      ta.Nil(err, "constitued a quorum")
      ta.Nil(higherBal, "no other proposer is seen")
      ta.Nil(latestVal, "no voted value")
    
      // Phase1æˆåŠŸå, å› ä¸ºæ²¡æœ‰çœ‹åˆ°å…¶ä»–votedçš„å€¼,
      // Proposeré€‰æ‹©å®ƒè‡ªå·±çš„å€¼è¿›è¡Œåé¢çš„Phase2
      px.Val = &Value{Vi64: val}
    
      // Phase 2
      higherBal, err = px.Phase2(
          []int64{0, 1}, quorum)
    
      ta.Nil(err, "constitued a quorum")
      ta.Nil(higherBal, "no other proposer is seen")
    }
    

ç¬¬ 2 ä¸ªä¾‹å­å¯¹åº” 2 ä¸ª Proposer é‡åˆ°å†²çªå¹¶è§£å†³å†²çªçš„ä¾‹å­ï¼Œç•¥é•¿ä¸è´´åœ¨æ–‡ä¸­äº†ï¼Œä»£ç å¯ä»¥åœ¨ ã€TestCase2DoubleProposerã€‘çœ‹åˆ°ã€‚

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a89cc6a12af84cd4b32b33a3fcfaaa2f~tplv-k3u1fbpfcp-zoom-1.image)

å·¥ç¨‹
--

Paxos çš„å‡ºè‰²ä¹‹å¤„åœ¨äºå®ƒå°†åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ç®€åŒ–åˆ°æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œæ²¡æœ‰ä»»ä½•å¤šä½™çš„è®¾è®¡ã€‚

å·¥ç¨‹å®ç°ä¸Šæˆ‘ä»¬å¤šæ•°æ—¶å€™ä¼šç”¨ä¸€ä¸ª paxos çš„å˜ä½“ï¼Œå®ƒéœ€è¦å¯¹ paxos ä¸­çš„**å®ä¾‹**æ‰©å±•ä¸ºä¸€ç³»åˆ—å¤šå€¼çš„æ“ä½œæ—¥å¿—ï¼Œæ”¯æŒå®Œæ•´çš„çŠ¶æ€æœºï¼Œä»¥åŠå¯¹è¿ç»´æä¾›æ”¯æŒæˆå‘˜å˜æ›´ï¼Œæ‰€ä»¥ raft åœ¨å·¥ç¨‹ä¸Šæ›´å—æ¬¢è¿ï¼š

[https://github.com/datafuselabs/openraft](https://github.com/datafuselabs/openraft)

åˆ›å»º openraft è¿™ä¸ªé¡¹ç›®çš„ç›®çš„æ˜¯ï¼š

*   ä¼˜åŒ–å’Œæ”¹è‰¯ raft ç®—æ³•æœ¬èº«çš„é—®é¢˜ï¼š

*   *   ä¾‹å¦‚ä¸€ä¸ª term å†…æ— æ³•é€‰å‡ºå¤šä¸ª leaderï¼Œé€ æˆé€‰ä¸¾å†²çªè¿‡å¤šçš„é—®é¢˜ï¼Œ
    *   ä¾‹å¦‚ä¸å¿…è¦çš„ pre-vote é˜¶æ®µçš„å¼•å…¥ï¼Œ
    *   ä¾‹å¦‚ raft ä½œä¸ºä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•å¯¹å¤–éƒ¨æ—¶é’Ÿçš„ä¾èµ–ï¼Œ
    *   ä¾‹å¦‚å¼ºåˆ¶çš„ leader/candidate é˜¶æ®µçš„æ‹†åˆ†ä½¿å¾—æ¢ leader è¦ç»å†ä¸€ä¸ªæ— æ³•æœåŠ¡çš„ candidate-state çš„é˜¶æ®µã€‚  
        openraft æ­£åœ¨è§£å†³çš„è¿™äº›é—®é¢˜ï¼Œä½¿ä¹‹ä¸ä»…ä»…æ˜¯ä¸€ä¸ªä¸ºäº†æ€§èƒ½å’Œå®‰å…¨**ç”¨ rust é‡å†™**çš„é¡¹ç›®ã€‚

*   å…¶æ¬¡åœ¨ç”¨æˆ·æ¥å£ä¸Šï¼Œæä¾›ä¸€ç»„è¯­ä¹‰æ˜ç¡®çš„ async APIã€‚

å‚è€ƒé“¾æ¥
----

æœ¬æ–‡ç”¨åˆ°çš„ä»£ç åœ¨ paxoskv é¡¹ç›®çš„ naive åˆ†æ”¯ä¸Šï¼š

ã€[https://github.com/openacid/paxoskv/tree/naiveã€‘](https://github.com/openacid/paxoskv/tree/naive%E3%80%91)

*   ã€paxos made simpleã€‘ï¼š[http://lamport.azurewebsites.net/pubs/pubs.html#paxos-simple](http://lamport.azurewebsites.net/pubs/pubs.html#paxos-simple)
*   ã€Leslie Lamportã€‘ï¼š[http://www.lamport.org/](http://www.lamport.org/)
*   ã€protobufã€‘ï¼š[https://developers.google.com/protocol-buffers](https://developers.google.com/protocol-buffers)
*   ã€install-protocã€‘ï¼š[https://grpc.io/docs/protoc-installation/](https://grpc.io/docs/protoc-installation/)
*   ã€grpcã€‘ï¼š[https://grpc.io/](https://grpc.io/)
*   ã€paxosçš„ç›´è§‚è§£é‡Šã€‘ï¼š[https://blog.openacid.com/algo/paxos](https://blog.openacid.com/algo/paxos)
*   ã€issueã€‘ï¼š[https://github.com/openacid/paxoskv/issues/new/choose](https://github.com/openacid/paxoskv/issues/new/choose)
*   ã€paxoskvã€‘ï¼š[https://github.com/openacid/paxoskv/tree/naive](https://github.com/openacid/paxoskv/tree/naive)
*   ã€TestCase1SingleProposeã€‘ï¼š[https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos\_slides\_case\_test.go#L11](https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos_slides_case_test.go#L11)
*   ã€TestCase2DoubleProposerã€‘ï¼š[https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos\_slides\_case\_test.go#L57](https://github.com/openacid/paxoskv/blob/naive/paxoskv/paxos_slides_case_test.go#L57)
*   ã€Example\_setAndGetByKeyVerã€‘ï¼š[https://github.com/openacid/paxoskv/blob/naive/paxoskv/example\_set\_get\_test.go](https://github.com/openacid/paxoskv/blob/naive/paxoskv/example_set_get_test.go)
*   ã€Openraftã€‘: [https://github.com/datafuselabs/openraft](https://github.com/datafuselabs/openraft)

å…³äº Databend
-----------

Databend æ˜¯ä¸€æ¬¾å¼€æºã€å¼¹æ€§ã€ä½æˆæœ¬ï¼ŒåŸºäºå¯¹è±¡å­˜å‚¨ä¹Ÿå¯ä»¥åšå®æ—¶åˆ†æçš„æ–°å¼æ•°ä»“ã€‚æœŸå¾…æ‚¨çš„å…³æ³¨ï¼Œä¸€èµ·æ¢ç´¢äº‘åŸç”Ÿæ•°ä»“è§£å†³æ–¹æ¡ˆï¼Œæ‰“é€ æ–°ä¸€ä»£å¼€æº Data Cloudã€‚

*   Databend æ–‡æ¡£ï¼š[https://databend.rs/](https://databend.rs/)
    
*   Twitterï¼š[https://twitter.com/Datafuse\_Labs](https://twitter.com/Datafuse_Labs)
    
*   Slackï¼š[https://datafusecloud.slack.com/](https://datafusecloud.slack.com/)
    
*   Wechatï¼šDatabend
    
*   GitHub ï¼š[https://github.com/datafuselabs/databend](https://github.com/datafuselabs/databend)
    

![å›¾ç‰‡](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e90d107dffaf470f99ab4e8a5d4836f3~tplv-k3u1fbpfcp-zoom-1.image)

æ–‡ç« é¦–å‘äºå…¬ä¼—å·ï¼šDatabend