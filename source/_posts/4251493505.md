---
layout: post
title: "èŠèŠ C++ ä¸­çš„å‡ ç§æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šï¼‰"
date: "2022-07-18T01:55:21.758Z"
---
èŠèŠ C++ ä¸­çš„å‡ ç§æ™ºèƒ½æŒ‡é’ˆ ï¼ˆä¸Šï¼‰
===================

ä¸€ï¼šèƒŒæ™¯
----

æˆ‘ä»¬çŸ¥é“ C++ æ˜¯æ‰‹å·¥ç®¡ç†å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œå¯¹åº”çš„æ“ä½œç¬¦å°±æ˜¯ `new/delete` å’Œ `new[] / delete[]`, è¿™ç»™äº†ç¨‹åºå‘˜æå¤§çš„è‡ªç”±åº¦ä¹Ÿç»™äº†æˆ‘ä»¬æé«˜çš„é—¨æ§›ï¼Œå¼„ä¸å¥½å°±å¾—å†…å­˜æ³„éœ²ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š

    
    void test() {
    	int* i = new int(10);
    	*i = 10;
    }
    
    int main() {
    	test();
    }
    
    

è¿™æ®µä»£ç å› ä¸ºç”¨äº† new è€Œå¿˜äº† deleteï¼Œå¯¼è‡´åœ¨ `nt heap` ä¸Šåˆ†é…çš„ i éšç€æ ˆåœ°å€çš„å›æ”¶è€Œæˆäº†ä¸€å—å­¤æ‚¬æµ·å¤–çš„å†…å­˜å ç”¨ï¼Œæ‰€ä»¥ä¿®æ­£åçš„ä»£ç å¦‚ä¸‹ï¼š

    
    void test() {
    	int* i = new int(10);
    	*i = 10;
    
    	delete i;
    }
    
    int main() {
    	test();
    }
    
    

ä½†è¿™ç§å†™æ³•æ¯”è¾ƒéº»çƒ¦ï¼Œæ™ºè€…åƒè™‘å¿…æœ‰ä¸€å¤±ï¼Œæ€»ä¼šæœ‰å¿˜è®°åŠ  delete çš„æ—¶å€™ï¼Œé‚£æ€ä¹ˆåŠå‘¢ï¼Ÿ å¤§å®¶åº”è¯¥çŸ¥é“`å†…å­˜è‡ªåŠ¨ç®¡ç†`æœ‰ä¸¤ç§æ‰‹æ®µã€‚

1.  å¼•ç”¨è®¡æ•°

ä»£è¡¨ä½œæœ‰ Pythonï¼ŒPHPï¼Œè¿˜æœ‰ windows çš„å¥æŸ„ç®¡ç†ã€‚

2.  å¼•ç”¨è·Ÿè¸ª

ä»£è¡¨ä½œæœ‰ C#ï¼ŒJAVA ç­‰ä¸€ä¼—å·¥ç¨‹åŒ–è¯­è¨€ã€‚

å› ä¸º `å¼•ç”¨è®¡æ•°` å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦å°±æ˜¯è®°å½•ä¸‹å¯¹è±¡çš„å¼•ç”¨æ¬¡æ•°ï¼Œæ¬¡æ•°ä¸º 0 åˆ™é‡Šæ”¾ï¼Œæ‰€ä»¥å¯å®Œå…¨å€ŸåŠ© **ç±»çš„æ„é€ å‡½æ•°ææ„å‡½æ•°** å’Œ **æ ˆçš„è‡ªåŠ¨å›æ”¶ç‰¹æ€§** å¼„ä¸€ä¸ªç®€å•çš„ `å¼•ç”¨è®¡æ•°` ï¼Œå¯¹åº”ç€å¦‚ä¸‹å››ä¸ªå…³é”®è¯ã€‚

1.  auto\_ptr
    
2.  shared\_ptr
    
3.  unique\_ptr
    
4.  weak\_ptr
    

æ¥ä¸‹æ¥æˆ‘ä»¬é€ä¸ªèŠä¸€èŠã€‚

äºŒï¼šå…³é”®è¯è§£æ
-------

### 1\. auto\_ptr

è¿™æ˜¯ C++ æœ€æ—©å‡ºç°ä¸€ä¸ªçš„ `ç®€å•å¼•ç”¨è®¡æ•°æ³•`ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    void test() {
    	auto_ptr<int> ptr = auto_ptr<int>(new int(10));
    }
    
    int main() {
    	test();
    }
    
    

æ¥ä¸‹æ¥çœ‹ä¸‹æ±‡ç¼–ä»£ç ï¼š

    
    	auto_ptr<int> ptr = auto_ptr<int>(new int(10));
    ...
    00771D26  call        std::auto_ptr<int>::auto_ptr<int> (07710FAh)  
    00771D2B  lea         ecx,[ebp-0D8h]  
    00771D31  call        std::auto_ptr<int>::~auto_ptr<int> (0771159h) 
    
    

å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåˆ†åˆ«è°ƒç”¨äº† `æ„é€ å‡½æ•°` å’Œ `ææ„å‡½æ•°`ï¼Œæ¥ä¸‹æ¥æ‰¾ä¸‹ auto\_ptr è¿™ä¸¤ä¸ªå‡½æ•°çš„æºç ã€‚

    
    class auto_ptr {
    
    private:
    	_Ty* _Myptr; // the wrapped object pointer
    
    public:
    	auto_ptr(auto_ptr_ref<_Ty> _Right) noexcept {
    		_Ty* _Ptr = _Right._Ref;
    		_Right._Ref = nullptr; // release old
    		_Myptr = _Ptr; // reset this
    	}
    
    	~auto_ptr() noexcept {
    		delete _Myptr;
    	}
    }
    
    

æºç ä¸€çœ‹å°±æ˜ç™½äº†ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œå°† new int çš„åœ°å€å¡ç»™äº†å†…éƒ¨çš„ `_Myptr` æŒ‡é’ˆï¼Œåœ¨ææ„å‡½æ•°ä¸­å¯¹ `_Myptr` è¿›è¡Œ `delete` ï¼ŒçœŸå¥½ï¼Œè¿™æ ·å°±ä¸ç”¨æ•´å¤©æ‹…å¿ƒæœ‰æ²¡æœ‰åŠ  delete å•¦ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç°åœ¨ C++ ä¸æ¨èè¿™ä¸ªäº†ï¼Œè€Œæ˜¯å»ºè®®ä½¿ç”¨æ–°å¢çš„ï¼š`shared_ptrï¼Œunique_ptrï¼Œweak_ptr`, æ€ä¹ˆè¯´å‘¢ï¼Ÿ auto\_ptr æœ‰ä¸€ä¸ªä¸å¥½å¤„ç†çš„é—®é¢˜ï¼Œå°±æ˜¯ç°å®å¼€å‘ä¸­ä¼šå‡ºç°è¿™ä¹ˆä¸ªåœºæ™¯ï¼Œå¤šä¸ª ptr æŒ‡å‘åŒä¸€ä¸ª å¼•ç”¨ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4b277abd942f4e129a5a8b0238d2679c~tplv-k3u1fbpfcp-zoom-1.image)

### 2\. auto\_ptr å¤šå¼•ç”¨é—®é¢˜

1.  æ–¹å¼1ï¼š

å®šä¹‰ä¸‰ä¸ª ptrï¼Œç„¶ååŒ…è£…åŒä¸€ä¸ª `new int` åœ°å€ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    void test() {
    	int* i = new int(10);
    
    	auto_ptr<int> ptr1(i);
    	auto_ptr<int> ptr2(i);
    	auto_ptr<int> ptr3(i);
    }
    
    

è¿™ç§å†™æ³•æœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿ è‚¯å®šæœ‰é—®é¢˜å•¦ï¼Œè¿˜è®°å¾— auto\_ptr çš„ææ„æ˜¯ delete å—ï¼Ÿ å¯¹åŒä¸€å—å†…å­˜å¤šæ¬¡ delete ä¼šæŠ›å¼‚å¸¸çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c6d6f15f6ca4e5c913d28cd4f58f8df~tplv-k3u1fbpfcp-zoom-1.image)

2.  æ–¹å¼2ï¼š

æ—¢ç„¶å®šä¹‰ä¸‰ä¸ªæœ‰é—®é¢˜, é‚£å°±ç”¨èµ‹å€¼è¿ç®—ç¬¦`=` è®© ptr1,ptr2,ptr3 æŒ‡å‘åŒä¸€ä¸ªåœ°å€æ˜¯ä¸æ˜¯å°±å¯ä»¥å•¦ï¼Ÿ å‚è€ƒä»£ç å¦‚ä¸‹ï¼š

    
    void test() {
    	int* i = new int(10);
    
    	auto_ptr<int> ptr1(i);
    	auto_ptr<int> ptr2 = ptr1;
    	auto_ptr<int> ptr3 = ptr2;
    }
    
    int main() {
    	test();
    }
    
    

é‚£è¿™æ®µä»£ç æœ‰æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿ æœ‰æ²¡æœ‰é—®é¢˜å¾—è¦çœ‹ `=` è¿ç®—ç¬¦æ˜¯å¦‚ä½•é‡å†™çš„ğŸ˜ªï¼Œæ‰’ä¸€ä¸‹æºç çœ‹çœ‹ã€‚

    
    template <class _Other>
    auto_ptr& operator=(auto_ptr<_Other>& _Right) noexcept {
    	reset(_Right.release());
    	return *this;
    }
    _Ty* release() noexcept {
    	_Ty* _Tmp = _Myptr;
    	_Myptr = nullptr;
    	return _Tmp;
    }
    
    

ä»æºç çœ‹æœ‰ä¸€ä¸ªå¾ˆæ¶å¿ƒçš„ç‚¹,ä»–ä¼šå°† `_Right` ä¸‹çš„ `_Myptr` è®¾ä¸º nullptr,ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶çš„ ptr1 æŠ¥åºŸäº†ï¼Œè¨€å¤–ä¹‹æ„å°±æ˜¯åç»­å†è®¿é—® ptr1 ä¼šæŠ› `è®¿é—®è¿ä¾‹`ã€‚

![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/112f5c13e6c240f0bc133398b69ee117~tplv-k3u1fbpfcp-zoom-1.image)

å“ˆå“ˆï¼ŒC++é‡Œé¢çš„ä¸“ä¸šæœ¯è¯­å« `æ§åˆ¶æƒè½¬ç§»`ã€‚

å¥½äº†ï¼Œæœ¬ç¯‡å°±è¯´è¿™ä¹ˆå¤šå§ï¼Œä¸‹ä¸€ç¯‡èŠèŠæ–°å¢çš„è¿™äº›å…³é”®è¯ï¼Œçœ‹çœ‹å¦‚ä½•å°† auto\_ptr æ›´åˆç†çš„åˆ†æƒã€‚