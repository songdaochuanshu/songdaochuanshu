---
layout: post
title: "Clickhouse ç”¨æˆ·è‡ªå®šä¹‰å¤–éƒ¨å‡½æ•°"
date: "2022-03-31T09:18:53.380Z"
---
Clickhouse ç”¨æˆ·è‡ªå®šä¹‰å¤–éƒ¨å‡½æ•°
====================

![](https://img2022.cnblogs.com/blog/720686/202203/720686-20220331095034024-1703147184.png)

### å†™åœ¨å‰é¢

ã€€ã€€Clickhouse ä»Â 21.11Â ç‰ˆæœ¬å¼€å§‹ï¼Œé™¤äº†æä¾›ç±»ä¼¼SqlServerã€MySQL CREATE FUNCTIONÂ çš„è‡ªå®šä¹‰å‡½æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼ˆUDFï¼‰ï¼Œä¸å…¶è¯´æ˜¯â€œç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°â€ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œç§°ä¹‹ä¸ºâ€ç”¨æˆ·è‡ªå®šä¹‰å¤–éƒ¨å‡½æ•°â€œæ›´ä¸ºå‡†ç¡®ã€‚å®˜æ–¹å¯¹æ­¤åŠŸèƒ½çš„è§£é‡Šï¼š

ClickHouse can call any external executable program or script to process data.   
è¯‘æ–‡ï¼šClickHouseå¯ä»¥è°ƒç”¨ä»»ä½•å¤–éƒ¨å¯æ‰§è¡Œç¨‹åºæˆ–è„šæœ¬æ¥å¤„ç†æ•°æ®ã€‚

å¯ä»¥è°ƒç”¨å¤–éƒ¨ç¨‹åºæˆ–è„šæœ¬æ¥å¤„ç†æ•°æ®ï¼Œè¿™å¯¹äºæ•°æ®å»ºæ¨¡ã€æ•°æ®åˆ†æç­‰ç­‰æ¥è¯´ï¼Œæ— ç–‘æ˜¯æ€æ‰‹é”çš„å­˜åœ¨ã€‚

### å¼€å§‹

ã€€ã€€ç¤ºä¾‹æƒ…æ™¯ï¼šè°ƒç”¨pythonè„šæœ¬å®ç°å‘é‡ç‚¹ç§¯è¿ç®—ã€‚

ã€€ã€€ç¯å¢ƒï¼šDockerã€ClickhouseÂ 21.11.4.14 ã€Ubuntu 20.04ã€Python3

#### **1.Â  åœ¨config.xmlé‡Œå†…å¢åŠ **

<user\_defined\_executable\_functions\_config>\*\_function.xml</user\_defined\_executable\_functions\_config>

#### 2.Â  å¢åŠ custom\_function.xmlè‡ªå®šä¹‰å‡½æ•°çš„å£°æ˜æ–‡ä»¶

ã€€ã€€æ–°å»ºcustom\_function.xmlæ–‡ä»¶ï¼Œä¸config.xmlã€users.xmlæ–‡ä»¶æ˜¯åŒçº§ç›®å½•ä¸‹çš„ï¼Œå¦‚å›¾

**![](https://img2022.cnblogs.com/blog/720686/202203/720686-20220330215543958-553513264.png)**

#### **3\. å£°æ˜æ–¹æ³•**

ã€€ã€€æ‰“å¼€custom\_function.xmlæ–‡ä»¶ï¼Œç¼–å†™æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

<functions>
    <function>
        <type>executable</type>
        <name>custom\_dotProduct</name>
        <return\_type>Float32</return\_type>
        <return\_name>result</return\_name>
        <argument>
            <type>Array(Float32)</type>
            <name>v1</name>
        </argument>
        <argument>
            <type>Array(Float32)</type>
            <name>v2</name>
        </argument>
        <format>JSONEachRow</format>
        <execute\_direct>0</execute\_direct>
        <command>python3 /var/lib/clickhouse/user\_scripts/custom\_dotProduct.py</command>
    </function>
</functions>

ã€€ã€€execute\_direct=0ï¼Œé»˜è®¤æ˜¯1ï¼Œ1è¡¨ç¤ºå°†åœ¨clickhouseçš„/data/user\_scriptsæ–‡ä»¶å¤¹å†…æœç´¢è„šæœ¬ï¼Œ0è¡¨æ˜¯æŒ‰ç…§ç”¨æˆ·é…ç½®çš„å‘½ä»¤æœç´¢è„šæœ¬è·¯å¾„ï¼Œå»ºè®®è®¾ç½®ä¸º0ï¼Œé¿å…æ‰¾ä¸åˆ°æ‰§è¡Œçš„è„šæœ¬æ–‡ä»¶ã€‚å…¶ä»–å‚æ•°å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼š[Introduction | ClickHouse Documentation](https://clickhouse.com/docs/en/sql-reference/functions/)

#### **4\. ç¼–å†™pythonè„šæœ¬**

#!/usr/bin/python3
import sys
import json

if \_\_name\_\_ == '\_\_main\_\_':
    for line in sys.stdin:
        dict \= json.loads(line)
        ls \= \[\]
        for v in dict.values():
            ls.insert(1, list(v))
        vector1 \= tuple(ls\[0\])
        vector2 \= tuple(ls\[1\])
        v \= sum(p \* q for p, q in zip(vector1, vector2))
        data \= {'result': str(v)}
        print(json.dumps(data), end='\\n')
        sys.stdout.flush()

ã€€ã€€ä¿å­˜è„šæœ¬å¹¶å‘½åä¸ºÂ custom\_dotProduct.pyÂ ï¼Œå†æ”¾åˆ°Â /var/lib/clickhouse/user\_scriptsÂ æ–‡ä»¶å¤¹å†…ã€‚

ã€€ã€€ç‰¹åˆ«éœ€è¦æ³¨æ„æ˜¯è„šæœ¬è¿è¡Œç¯å¢ƒå’Œå­˜æ”¾è·¯å¾„é—®é¢˜ï¼ŒClickhouseå¦‚æœæ˜¯æ”¾åˆ°dockeré‡Œé¢ï¼Œåˆ™éœ€è¦åœ¨dockerå†…é…ç½®pythonå¯è¿è¡Œçš„ç¯å¢ƒï¼Œå…¶ä»–C++ã€javaä¹Ÿæ˜¯å¦‚æ­¤ï¼Œæœ€èµ·ç èƒ½ä¿è¯æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬çš„æ—¶å€™èƒ½è¿è¡Œã€‚ åœ¨Â custom\_function.xmlÂ å£°æ˜æ–¹æ³•çš„æ—¶å€™ï¼Œç¼–å†™çš„xmlæ–‡ä»¶ä¸­çš„`command`å‘½ä»¤æ˜¯å®¹å™¨é‡Œé¢çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯å®¿ä¸»æœºçš„è·¯å¾„ã€‚

#### 5\. è‡³æ­¤å·²ç»å®Œæˆï¼Œè¿›è¡Œæ–¹æ³•æµ‹è¯•

\--é‡æ–°åŠ è½½æ–¹æ³•
SYSTEM RELOAD FUNCTIONS;

\--æŸ¥çœ‹æ–¹æ³•æ˜¯å¦åŠ è½½æˆåŠŸ
SELECT \* FROM system.functions WHERE name = 'custom\_dotProduct';

![](https://img2022.cnblogs.com/blog/720686/202203/720686-20220330221531680-956810841.png)

Â æ‰§è¡Œæ–¹æ³•ï¼š

select custom\_dotProduct(\[1,2,3\],\[4,5,6\]);

![](https://img2022.cnblogs.com/blog/720686/202203/720686-20220330224304618-2498107.png)

### æœ€å

ã€€ã€€è¿˜éœ€ç‰¹åˆ«æ³¨æ„çš„æ˜¯Clickhouseç‰ˆæœ¬é—®é¢˜ï¼Œåœ¨ç¤ºä¾‹çš„pythonè„šæœ¬ä¸­å’Œå®˜ç½‘æ–‡æ¡£ä¸­çš„ç¤ºä¾‹pythonè„šæœ¬å–å€¼æ–¹æ³•ä¸å¤ªä¸€æ ·ï¼Œ

å®˜æ–¹ç¤ºä¾‹ï¼š

first\_arg = int(value\['argument\_1'\])
second\_arg \= int(value\['argument\_2'\])

å®ƒæ˜¯é€šè¿‡è‡ªå®šä¹‰é…ç½®çš„nameè·å–å€¼ï¼š

<function>
    <type>executable</type>
    <name>test\_function\_sum\_json</name>
    <return\_type>UInt64</return\_type>
    <return\_name>result\_name</return\_name>
    <argument>
        <type>UInt64</type>
        <name>argument\_1</name>
    </argument>
    <argument>
        <type>UInt64</type>
        <name>argument\_2</name>
    </argument>
    <format>JSONEachRow</format>
    <command>test\_function\_sum\_json.py</command>
</function>

è€Œæˆ‘æ˜¯é€šè¿‡éå†å‡ºæ¥çš„ï¼š

for v in dict.values():
            ls.insert(1, list(v))

åŸå› æ˜¯Clickhouseè¿™ç§å–å€¼æ–¹å¼å¿…é¡»è¦æ±‚åœ¨Â 22.3Â ç‰ˆæœ¬ä»¥ä¸Šæ‰æ”¯æŒï¼Œè‹¥ä½äºÂ 22.3çš„ç‰ˆæœ¬ç”¨å®˜æ–¹çš„å–å€¼æ–¹å¼æ˜¯æ°¸è¿œæŠ¥é”™çš„ï¼ˆå·¨å‘ä¹‹ä¸€ï¼‰ã€‚å…·ä½“å¯ä»¥çœ‹æˆ‘ä¹‹å‰æçš„Issueï¼šÂ [UDFs: JSON Bug ? Â· Issue #35562 Â· ClickHouse/ClickHouse (github.com)](https://github.com/ClickHouse/ClickHouse/issues/35562)

ã€€ã€€å¦å¤–ï¼Œä»2022å¹´1æœˆåï¼ŒClickhouseçš„Dockeré•œåƒå°†åœæ­¢Â yandex/clickhouse-serverÂ çš„è¿­ä»£ï¼Œä½¿ç”¨æ–°çš„é•œåƒåœ°å€Â clickhouse/clickhouse-serverÂ  ã€‚

![](https://img2022.cnblogs.com/blog/720686/202203/720686-20220331093337132-834262748.png)

å¦‚ç»§ç»­ä½¿ç”¨Â yandex/clickhouse-serverçš„é•œåƒï¼Œæœ€æ–°çš„ç‰ˆæœ¬å·åœç•™åœ¨Â 22.1.3.7Â ï¼ˆå·¨å‘ä¹‹äºŒï¼‰ã€‚

å¥½äº†ï¼Œä¸‹ç­ï¼ä¸ä¸ä¸ï¼Œç­‰ä¸‹ä¸‹ç­ï¼

ä½œè€…ï¼š[EminemJKï¼ˆå±±æ²»å…ˆç”Ÿï¼‰](https://www.cnblogs.com/EminemJK/)  
å‡ºå¤„ï¼š[https://www.cnblogs.com/EminemJK/](https://www.cnblogs.com/EminemJK/)  
æ‚¨çš„æ”¯æŒæ˜¯å¯¹åšä¸»æœ€å¤§çš„é¼“åŠ±ğŸ‘ï¼Œæ„Ÿè°¢æ‚¨çš„è®¤çœŸé˜…è¯»ã€‚  
æœ¬æ–‡ç‰ˆæƒå½’ä½œè€…æ‰€æœ‰ï¼Œæ¬¢è¿è½¬è½½ï¼Œä½†æœªç»ä½œè€…åŒæ„å¿…é¡»ä¿ç•™æ­¤æ®µå£°æ˜ï¼Œä¸”åœ¨æ–‡ç« é¡µé¢æ˜æ˜¾ä½ç½®ç»™å‡ºåŸæ–‡è¿æ¥ï¼Œå¦åˆ™ä¿ç•™è¿½ç©¶æ³•å¾‹è´£ä»»çš„æƒåˆ©ã€‚  
![](https://images.cnblogs.com/cnblogs_com/EminemJK/945710/o_200704101251%E5%BA%95%E9%83%A8%E5%85%B3%E6%B3%A8%E4%BF%A1%E6%81%AF%EF%BC%88%E7%90%9B%E5%93%A5%EF%BC%89.png)