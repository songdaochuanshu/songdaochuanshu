---
layout: post
title: "大华海康NVR录像JAVA下载及WEB播放"
date: "2022-09-29T15:25:17.488Z"
---
大华海康NVR录像JAVA下载及WEB播放
=====================

　　近期在处理一个将NVR录像机上的录像下载到服务器并通过浏览器播放的需求。 梳理记录下过程，做个备忘，同时遇到的一些细节问题解决，也供需要的同学参考。

　　需求比较简单，就是把指定时间段的录像上传到服务器保存，并且允许用户通过web页面web浏览器，进行播放， 并且可以拖动控制播放进度。效果如。

　　![](https://img2022.cnblogs.com/blog/2753310/202209/2753310-20220929134638334-1989225686.png)

　　 **一、 视频下载**

　　视频下载比较简单，厂商都提供了针对JAVA集成SDK 的DEMO， 照着抄一抄就可以。 JAVA调用C库的SDK，一般使用JNA技术。一些细节问题

　　1. 下载的文件名要唯一，避免相互覆盖，可以用GUID随机生成。

　　2. 注意通道号正确，**海康的通道号不是从0开始， 要根据设备信息取得，起始的数字通道号**，多数是33。 数字通道D1其实对应的channel ID 应该是33.

　　3. JNA调用 发生在 原生的异常会导致整个进程终止，最好不要在主要的服务进程直接通过JNA集成第三方SDK。

　　4. 生产部署别忘了复制SDK依赖的原生\*.so库

　　 **二、 转换处理**

　　下载后的视频格式问题。

　　通俗说的音视频格式如 MP4，MP3等，其实并不严谨。.mp4其实是指封装格式，此封装格式支持多种音视频编码格式。mp4 封装格式可以支持的视频编码格式如 h264,h265,  音频格式如 PCM , aac等。

　　**目前主流web 浏览器，支持良好的视频编码格式是H264， 音频格式是aac**。 这也就是我们转换的目标。

　　而源录像的编码格式视频格式多数可以在NVR中设置，目前主流的是H265.(相较于H264压缩比更高， 解码需要的计算资源也更高)，音频编码是PCM。

　　ffmpeg 是一个开发中经常用到的音视频处理程序，经过测试，其转换H265编码 至 H264编码，还是相当耗时的，时效性基本在生产中无法接受， 转换音频编码效率较高。

　　因此此处建议的方案是， **将NVR的视频编码格式直接指定为H264**，这样视频流编码就不需要经过转换了

　　以下通过 ffmpeg 将 a.dav 文件中的 视频编码保持编码格式，音频格式转换为 aac编码，同时使用 mp4容器封装。

ffmpeg -i a.dav  -c:v copy -c:a aac 264.mp4

　　\* ffmpeg 如需将h265 转码 h264 ,是需要一个编译时额外额外开启 libx264 支持的, 直接copy  则不需要。

　　 **三、 伪流媒体服务**

　　 播放线上视频的几种方案， 1，下载后本地播放， 2， 伪流媒体 3 ， 流媒体。以下为个人大致理解，未必准确

　　 1. 需要下载这个文件完成后，才能够播放。 

　　3. 如HLS协议等，切片较小。 看哪里下哪里，下载的视频片段都是完整可播放的，可以实时直播（边产生，边播放）

　　2. 看哪里从哪里开始下载。 服务器根据浏览端传入的参数，将视频文件定位到对应位置后的内容传输至浏览器解码播放。 不能实时直播？（我猜。。）

　　根据下载视频保存，及在线观看的需求，第二种方案比较适合。 但是是需要服务器支持的。 **这里使用了nginx 做文件服务器，编译时，启用mp4模块**

　　相关信息：[http://nginx.org/en/docs/http/ngx\_http\_mp4\_module.html](http://nginx.org/en/docs/http/ngx_http_mp4_module.html)

　　原理简介：

　　![](https://img2022.cnblogs.com/blog/2753310/202209/2753310-20220929152041939-514434370.png)　　

       **四、 其他**

　　 至此，把下载好，转换好的视频文件，放在正确的nginx文件服务目录下，浏览器中输入文件url路径，应该就能正常的回放视频了。

　　 还有一些其他细节

　　1. 可能需要考虑硬件及网络的扩容， 视频存储需要较大的空间， 可能需要考虑存储扩容， 网络甚至，分布式文件系统等。下载大量视频的带宽占用也不能忽视， 可能需要扩容网络带宽。

　　存储及带宽的占用，需要根据码率需求及预设的场景进行估算。（注意码率及带宽单位通常是bit 不是Byte）

　　2. 跨系统调试可能会用到Java 的远程调试。以下在8000端口开放了远程调试，　　

java -Xdebug -Xrunjdwp:transport=dt\_socket,server=y,suspend=n,address=8000 -jar  test.jar

　　**最后  ！2022国庆快乐　！**

本文来自博客园，作者：[锅叔](https://www.cnblogs.com/uncleguo/)  
转载请注明原文链接：[https://www.cnblogs.com/uncleguo/p/16741261.html](https://www.cnblogs.com/uncleguo/p/16741261.html)