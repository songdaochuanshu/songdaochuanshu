---
layout: post
title: "æˆ‘ä»¬åº”è¯¥æµ‹è¯• DAO å±‚å—ï¼Ÿ"
date: "2022-07-18T11:16:07.560Z"
---
æˆ‘ä»¬åº”è¯¥æµ‹è¯• DAO å±‚å—ï¼Ÿ
==============

åº”è¯¥æµ‹è¯• DAO å±‚å—ï¼Ÿ
------------

ç½‘ä¸Šæœ‰å¾ˆå¤šäººè®¨è®ºå•å…ƒæµ‹è¯•æ˜¯å¦åº”è¯¥åŒ…å« DAO å±‚çš„æµ‹è¯•ã€‚ç¬”è€…è§‰å¾—ï¼Œå¯¹äºä¸€äº›ä¸»è¦æ˜¯crudçš„ä¸šåŠ¡æ¥è¯´ï¼Œserviceå±‚å’Œcontrollerå±‚éƒ½ä¼šéå¸¸è–„ï¼Œè€Œä¸»è¦çš„é€»è¾‘éƒ½è½åœ¨mapperä¸Šã€‚è¿™æ—¶å€™å¯¹serviceå±‚å’Œcontrollerå±‚å†™å•æµ‹æ²¡æœ‰å¤ªå¤šæ„ä¹‰ã€‚å¯ä»¥åªå†™mapperå±‚çš„å•æµ‹ã€‚

å¦ä¸€æ–¹é¢ï¼Œmapperå±‚çš„æµ‹è¯•å¯ä»¥æœ‰æ•ˆåœ°é¿å…ä¸€äº›ä½çº§çš„sqlé”™è¯¯ã€‚

å®šä¹‰å•æµ‹
----

å•å…ƒæµ‹è¯•æ˜¯åªé’ˆå¯¹ä¸€ä¸ªå•å…ƒçš„æµ‹è¯•ï¼Œæ¯”å¦‚è¯´ï¼Œä¸€ä¸ª Service ç±»çš„ä¸€ä¸ªæ¯ä¸ªå…¬å…±å‡½æ•°ã€‚è€Œè¿™ä¸ªå‡½æ•°æ‰€æœ‰è°ƒç”¨äº†å¤–éƒ¨ä¾èµ–çš„åœ°æ–¹éƒ½éœ€è¦è¢«éš”ç¦»ï¼Œæ¯”å¦‚è¯´å¤–éƒ¨ç±»çš„ä¾èµ–ï¼Œæˆ–è€…æ˜¯è¯·æ±‚äº†æŸä¸ªæœåŠ¡å™¨ã€‚  
ä¹Ÿå°±æ˜¯è¯´å•å…ƒæµ‹è¯•ä»…ä»…æ˜¯æµ‹è¯•å½“å‰ç±»çš„æŸä¸ªå‡½æ•°æœ¬èº«çš„é€»è¾‘ï¼Œè€Œä¸æ¶‰åŠåˆ°å¤–éƒ¨çš„é€»è¾‘ã€‚å› æ­¤æ‰§è¡Œå•æµ‹åº”è¯¥æ˜¯å¾ˆå¿«é€Ÿçš„ã€‚

åœ¨ Java ä¸­å•æµ‹å¸¸ç”¨çš„ä¾èµ–ä¸»è¦åˆ†ä¸ºæµ‹è¯•æ¡†æ¶ä¸ Mock æ¡†æ¶ã€‚æµ‹è¯•æ¡†æ¶å°±æ˜¯æ‰§è¡Œå’Œç®¡ç†æµ‹è¯•æ–¹æ³•çš„æ¡†æ¶ï¼Œä¸€èˆ¬ç”¨ JUnitã€‚è€Œ Mock æ¡†æ¶å°±æ˜¯ç”¨äºæ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–ï¼Œå°†è¢«æµ‹è¯•çš„å‡½æ•°çš„æ‰€æœ‰å¤–éƒ¨ä¾èµ–å…¨éƒ¨éš”ç¦»ã€‚

ä¸€äº›è¯¯åŒº
----

åœ¨ç½‘ä¸Šè§åˆ°å¤ªå¤šçš„å•æµ‹æ•™ç¨‹ï¼Œå†™å¾—ä¸€å¡Œç³Šæ¶‚ã€‚ç”šè‡³è¿å•æµ‹çš„æ¦‚å¿µéƒ½æä¸æ¸…æ¥šå°±å‘è¡¨æ–‡ç« ï¼ŒçœŸçš„æ˜¯è¯¯äººå­å¼Ÿã€‚  
å…³äºå¸¸è§çš„è¯¯åŒºï¼Œè¿™ç¯‡åšå®¢åˆ—ä¸¾å¾—å¾ˆåˆ°ä½ï¼š [å¦‚ä½•å†™å¥½å•å…ƒæµ‹è¯•ï¼šMock è„±ç¦»æ•°æ®åº“+ä¸ä½¿ç”¨@SpringBootTest](https://blog.csdn.net/qq_36688143/article/details/97393949)

æœ€å…³é”®çš„ä¸€ç‚¹æ˜¯ä¸è¦ä½¿ç”¨ `@SpringBootTest(classes=XXXApplication.class)` æ³¨è§£æµ‹è¯•ç±»ã€‚è¿™æ ·ä¼šç›´æ¥å¯åŠ¨ä¸€ä¸ª springboot è¿›ç¨‹ï¼Œå¯¹ç¨å¾®å¤æ‚ä¸€ç‚¹çš„é¡¹ç›®å°±è‡³å°‘è¦èŠ± 1 åˆ†é’Ÿä»¥ä¸Šæ¥è¿è¡Œäº†ã€‚å¦‚æœé¡¹ç›®ä½¿ç”¨äº†è¿œç¨‹é…ç½®ä¸­å¿ƒï¼ŒSOA ç­‰ä¸­é—´ä»¶ï¼Œé‚£å»ºè®®å‡ºå»æ³¡æ¯èŒ¶ğŸµã€‚  
æ‰€ä»¥ä¸ºå•¥å¤§å®¶ä¸æƒ³å†™å•æµ‹ï¼Ÿç­‰è¿™ä¹ˆä¹…ï¼Œäººèµ°èŒ¶å‡‰äº†éƒ½ã€‚ä½†æ˜¯å®é™…ä¸Šè¿™éƒ½æ˜¯é”™è¯¯çš„å®ç°æ‰‹æ³•ã€‚ä¸‹é¢è¿™ç¯‡æ–‡ç« è®²è§£äº†åœ¨ SpringBoot é¡¹ç›®ä¸­ä¸åŒé›†æˆå±‚æ¬¡çš„æµ‹è¯•ç±»çš„ä¾‹å­ï¼š [Testing in Spring Boot | Baeldung](https://www.baeldung.com/spring-boot-testing)  
æ€»åœ°æ¥è¯´ï¼Œåˆ†æ¸…æ¥šé›†æˆæµ‹è¯•ä¸å•å…ƒæµ‹è¯•çš„åŒºåˆ«ã€‚ä¸è¦æŠŠå•æµ‹å†™æˆé›†æˆæµ‹è¯•ã€‚

DAO å±‚æµ‹è¯•çš„å®ç°
----------

### é€‰å‹

ä¸‹é¢è¿™ç¯‡æ–‡ç« æ€»ç»“å¾—å¾ˆå¥½ï¼š [å†™æœ‰ä»·å€¼çš„å•å…ƒæµ‹è¯•-é˜¿é‡Œäº‘å¼€å‘è€…ç¤¾åŒº](https://developer.aliyun.com/article/54478?spm=a2c6h.12873639.0.0.6227437bG13TpN#slide-12)  
æ•°æ®åº“æµ‹è¯•éœ€è¦ä¿è¯æµ‹è¯•ä¸ä¼šå½±å“åˆ°å¤–éƒ¨ç¯å¢ƒï¼Œä¸”ç”Ÿæˆçš„æ•°æ®åœ¨æµ‹è¯•å®Œæˆåéœ€è¦è‡ªåŠ¨é”€æ¯ã€‚ä¸€èˆ¬æœ‰å‡ ç§æ–¹æ³•ï¼š

1.  è¿æ¥å¼€å‘ç¯å¢ƒçš„æ•°æ®åº“ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•åå›æ»šã€‚ä¸æ¨è
2.  ä½¿ç”¨ docker å®¹å™¨ï¼štestContainerã€‚åœ¨æµ‹è¯•æ—¶å¯åŠ¨ mysql å®¹å™¨ï¼Œåœ¨ç»“æŸåè‡ªåŠ¨å›æ”¶ã€‚ç¼ºç‚¹ï¼šéœ€è¦æ¯ä¸ªæµ‹è¯•çš„æœºå­éƒ½å®‰è£… docker å¹¶ä¸‹è½½è¯¥å®¹å™¨ã€‚è¿™å°±å¯¼è‡´ï¼š
    1.  éœ€è¦æ¨åŠ¨å…¶ä»–å¼€å‘è€…å®‰è£…è¯¥é•œåƒ
    2.  éœ€è¦æ¨åŠ¨ devops åœ¨çº¿ä¸Š CI/CD æµæ°´çº¿å®‰è£… dockerã€‚ï¼ˆæ”¾å¼ƒå§ï¼‰
3.  ä½¿ç”¨å†…å­˜æ•°æ®åº“ï¼Œä¸ä¼šå¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ã€‚æ¯”è¾ƒå¸¸ç”¨çš„æœ‰ h2ã€‚

å¦‚æœæ˜¯ä¸ªäººå¼€å‘é¡¹ç›®ï¼Œæˆ–è€…ä¸ä¼šç”¨åˆ°é›†æˆéƒ¨ç½²æµæ°´çº¿ã€‚å¯ä»¥å°è¯•ä½¿ç”¨ testContainerï¼Œå› ä¸ºå…¶ä¸ä»…å¯ä»¥å¯¹æ¥ mysql æµ‹è¯•ï¼Œå¯¹ä¸€äº›ä¸­é—´ä»¶å¦‚ redisï¼Œmq ç­‰éƒ½å¯ä»¥æ¨¡æ‹Ÿã€‚ä½†æ˜¯å¯¹å¤§å‹å›¢é˜Ÿå¼€å‘çš„å¤æ‚é¡¹ç›®è¿˜æ˜¯å»ºè®®ç›´æ¥ç”¨å†…å­˜æ•°æ®åº“å§ã€‚  
å¦å¤–ï¼ŒMybatis æä¾›äº†ä¸€ä¸ªæµ‹è¯•ä¾èµ–åŒ…ï¼Œé›†æˆäº† h2ï¼Œå‚è€ƒï¼š [mybatis-spring-boot-test-autoconfigure â€“ Introduction](https://mybatis.org/spring-boot-starter/mybatis-spring-boot-test-autoconfigure/) ã€‚ä½†æ˜¯ç¼ºç‚¹æ˜¯éœ€è¦ä¾èµ–ä¸åŒç‰ˆæœ¬çš„ springbootï¼Œç¬”è€…å¼€å‘çš„é¡¹ç›®ä½¿ç”¨çš„ springboot ç‰ˆæœ¬è¾ƒè€ï¼Œä¸”ä¸å®œæ›´æ–°ï¼Œæ‰€ä»¥å°±ç›´æ¥æ‰‹åŠ¨é…ç½® h2 äº†ã€‚

### ä»£ç 

æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆ›å»º 4 ä¸ª bean æ¥æ³¨å…¥ï¼š

1.  DataSourceï¼Œç”¨äº jdbc è¿æ¥å¯¹åº”çš„ h2 æ•°æ®åº“ã€‚
2.  Serverã€‚h2 çš„ gui server æœåŠ¡ï¼Œå¯ä»¥ç”¨è¿æ¥æ•°æ®åº“æŸ¥çœ‹æ•°æ®ã€‚ä¸æ˜¯å¿…éœ€çš„ã€‚
3.  SqlSessionFactoryã€‚ä¸º mybatis åˆ›å»ºä¸€ä¸ª sqlSessionFactoryï¼ŒæŒ‡æ˜ mapper çš„ xml æ–‡ä»¶æ‰€åœ¨ä½ç½®
4.  MapperScannerConfigurerã€‚ç”¨äºå°† mybatis ä¸­çš„ mapper æ¥å£ç”Ÿæˆä»£ç† beanã€‚  
    å…¶ä¸­å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š
5.  `@ComponentScan` éœ€è¦å¡«ä¸Šå½“å‰é¡¹ç›®ä¸­çš„ mapper æ¥å£çš„ä½ç½®
6.  åˆ›å»º DataSource æ—¶ï¼Œ`addScript()` æŒ‡å®šçš„æ˜¯è‡ªå·±å‡†å¤‡çš„å»ºè¡¨ä¸åˆå§‹åŒ–æ•°æ®çš„ sqlã€‚è·¯å¾„åœ¨ test/resources/db/schema-h2.sql
7.  åˆ›å»º sqlSessionFactory æ—¶ï¼ŒæŒ‡å®š resources ä¸­çš„ mapper.xml æ–‡ä»¶ã€‚
8.  åˆ›å»º mapperScannerConfigurer æ—¶ï¼ŒæŒ‡å®š mapper æ¥å£çš„ package ä»¥åŠä¸Šä¸€æ­¥åˆ›å»ºçš„ factory çš„ bean çš„åå­—ï¼Œè¿™é‡Œä½¿ç”¨çš„éƒ½æ˜¯é»˜è®¤çš„åå­—ï¼Œå³æ–¹æ³•çš„åç§°ã€‚

    @Configuration
    @ComponentScan({ "com.my.app.mapper" })
    public class BaseTestConfig {
        @Bean()
        public DataSource dataSource() {
            EmbeddedDatabaseBuilder databaseBuilder = new EmbeddedDatabaseBuilder();
    
            return databaseBuilder
                    .setType(EmbeddedDatabaseType.H2)
                    //å¯åŠ¨æ—¶åˆå§‹åŒ–å»ºè¡¨è¯­å¥
                    .addScript("classpath:db/schema-h2.sql")
                    .build();
        }
    
        @Bean(name = "h2WebServer", initMethod = "start", destroyMethod = "stop")
        //å¯åŠ¨ä¸€ä¸ªH2çš„web serverï¼Œ è°ƒè¯•æ—¶å¯ä»¥é€šè¿‡localhost:8082è®¿é—®åˆ°H2çš„å†…å®¹
        //JDBC URL: jdbc:h2:mem:testdb
        //User Name: sa
        //Password: æ— 
        //æ³¨æ„å¦‚æœä½¿ç”¨æ–­ç‚¹ï¼Œæ–­ç‚¹ç±»å‹(Suspend Type)ä¸€å®šè¦è®¾ç½®æˆThreadè€Œä¸èƒ½æ˜¯All,å¦åˆ™web serveræ— æ³•æ­£å¸¸è®¿é—®!
        public Server server() throws Exception {
            //åœ¨8082ç«¯å£ä¸Šå¯åŠ¨ä¸€ä¸ªweb server
            return Server.createWebServer("-web", "-webAllowOthers", "-webDaemon", "-webPort", "8082");
        }
    
        @Bean()
        public SqlSessionFactory sqlSessionFactory(DataSource dataSource) throws Exception {
            final SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();
            sessionFactory.setDataSource(dataSource);
            PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
            //åŠ è½½æ‰€æœ‰çš„sqlmapperæ–‡ä»¶
            Resource[] mapperLocations = resolver.getResources("classpath*:mapper/*.xml");
            sessionFactory.setMapperLocations(mapperLocations);
            return sessionFactory.getObject();
        }
    
        @Bean()
        public MapperScannerConfigurer mapperScannerConfigurer() {
            //åªéœ€è¦å†™DAOæ¥å£ï¼Œä¸ç”¨å†™å®ç°ç±»ï¼Œè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆä»£ç†
            MapperScannerConfigurer configurer = new MapperScannerConfigurer();
            configurer.setBasePackage("com.my.app.mapper");
            configurer.setSqlSessionFactoryBeanName("sqlSessionFactory");
            return configurer;
        }
    
    }
    
    

åˆ›å»ºä¸€ä¸ªè¿™æ ·çš„ Configuration ç±»åï¼Œåé¢çš„ MapperTest ç±»åªéœ€è¦ç”¨ `@Import` å¼•å…¥è¿™ä¸ªé…ç½®ç±»å³å¯ï¼Œæˆ–è€…å°†æ³¨è§£å…¨éƒ¨æ”¾åœ¨ä¸€ä¸ªåŸºç±»ä¸Šï¼Œè®©åé¢çš„ mapper æµ‹è¯•ç±»éƒ½ç»§æ‰¿è¿™ä¸ªåŸºç±»ï¼Œå°±ä¸éœ€è¦åœ¨æ¯ä¸ªæµ‹è¯•ç±»ä¸Šéƒ½åŠ æ³¨è§£äº†ï¼š

    @RunWith(SpringJUnit4ClassRunner.class)
    @Import(BaseTestConfig.class)
    public class BaseMapperTest {
        @Autowired
        private MyMapper myMapper;
        @Test
        public void test(){
            Object o = myMapper.selectOne();
            assertNotNull(o);
        }
    }