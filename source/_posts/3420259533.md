---
layout: post
title: "TensorFlowæ·±åº¦å­¦ä¹ ï¼æ„å»ºç¥ç»ç½‘ç»œé¢„æµ‹è‚¡ç¥¨ä»·æ ¼ï¼â›µ"
date: "2022-11-12T22:17:57.186Z"
---
TensorFlowæ·±åº¦å­¦ä¹ ï¼æ„å»ºç¥ç»ç½‘ç»œé¢„æµ‹è‚¡ç¥¨ä»·æ ¼ï¼â›µ
=============================

![TensorFlowæ·±åº¦å­¦ä¹ ï¼æ„å»ºç¥ç»ç½‘ç»œé¢„æµ‹è‚¡ç¥¨ä»·æ ¼ï¼â›µ](https://img2022.cnblogs.com/blog/2637458/202211/2637458-20221112152831907-1670234738.png) è‚¡ç¥¨ä»·æ ¼æ•°æ®æ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—å½¢æ€çš„æ•°æ®ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ã€å¾ªç¯ç¥ç»ç½‘ç»œ(RNN)ã€å¯¹è¿™ç§æ—¶åºç›¸å…³çš„æ•°æ®è¿›è¡Œå»ºæ¨¡ï¼Œå¹¶å°†å…¶åº”ç”¨åœ¨è‚¡ç¥¨æ•°æ®ä¸Šè¿›è¡Œé¢„æµ‹ã€‚

![](https://img-blog.csdnimg.cn/img_convert/a6660fb917d385b447a50402ceac5781.png)

> ğŸ’¡ ä½œè€…ï¼š[éŸ©ä¿¡å­](https://github.com/HanXinzi-AI)@[ShowMeAI](https://www.showmeai.tech/)  
> ğŸ“˜ [æ·±åº¦å­¦ä¹ å®æˆ˜ç³»åˆ—](https://www.showmeai.tech/tutorials/42)ï¼š[https://www.showmeai.tech/tutorials/42](https://www.showmeai.tech/tutorials/42)  
> ğŸ“˜ [TensorFlow å®æˆ˜ç³»åˆ—](https://www.showmeai.tech/tutorials/43)ï¼š[https://www.showmeai.tech/tutorials/43](https://www.showmeai.tech/tutorials/43)  
> ğŸ“˜ [æœ¬æ–‡åœ°å€](https://www.showmeai.tech/article-detail/327)ï¼š[https://www.showmeai.tech/article-detail/327](https://www.showmeai.tech/article-detail/327)  
> ğŸ“¢ å£°æ˜ï¼šç‰ˆæƒæ‰€æœ‰ï¼Œè½¬è½½è¯·è”ç³»å¹³å°ä¸ä½œè€…å¹¶æ³¨æ˜å‡ºå¤„  
> ğŸ“¢ æ”¶è—[ShowMeAI](https://www.showmeai.tech/)æŸ¥çœ‹æ›´å¤šç²¾å½©å†…å®¹

![](https://img-blog.csdnimg.cn/img_convert/cf8c06ea187570c1b5331af6b7ca09aa.png)

è‚¡ç¥¨ä»·æ ¼æ•°æ®æ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—å½¢æ€çš„æ•°æ®ï¼Œè¯šç„¶ï¼Œè‚¡å¸‚çš„æ¶¨è½å’Œå„ç§åˆ©å¥½åˆ©ç©ºæ¶ˆæ¯æ›´ç›¸å…³ï¼Œæ›´å¤šä½“ç°çš„æ˜¯äººä»¬çš„ä¿¡å¿ƒçŠ¶å†µï¼Œä½†æ˜¯å®ƒçš„å½¢æ€ä¸‹ï¼Œæ—¶åºå‰åæ˜¯æœ‰ä¸€å®šçš„ç›¸å…³æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§ç‰¹æ®Šç±»å‹çš„ç¥ç»ç½‘ç»œã€**å¾ªç¯ç¥ç»ç½‘ç»œ** **(RNN)**ã€æ¥å¯¹è¿™ç§æ—¶åºç›¸å…³çš„æ•°æ®è¿›è¡Œå»ºæ¨¡å’Œå­¦ä¹ ã€‚

![](https://img-blog.csdnimg.cn/img_convert/dde22f5191dc34a1b2371f097344d1cc.png)

åœ¨æœ¬ç¯‡å†…å®¹ä¸­ï¼Œ[ShowMeAI](https://www.showmeai.tech/)å°†ç»™å¤§å®¶æ¼”ç¤ºï¼Œå¦‚ä½•æ„å»ºè®­ç»ƒç¥ç»ç½‘ç»œå¹¶å°†å…¶åº”ç”¨åœ¨è‚¡ç¥¨æ•°æ®ä¸Šè¿›è¡Œé¢„æµ‹ã€‚

![](https://img-blog.csdnimg.cn/img_convert/4dfe016166b19ead4a98a79050603825.png)

> å¯¹äºå¾ªç¯ç¥ç»ç½‘ç»œçš„è¯¦ç»†ä¿¡æ¯è®²è§£ï¼Œå¤§å®¶å¯ä»¥é˜…è¯»[ShowMeAI](https://www.showmeai.tech/)æ•´ç†çš„ç³»åˆ—æ•™ç¨‹å’Œæ–‡ç« è¯¦ç»†äº†è§£ï¼š
> 
> *   [**æ·±åº¦å­¦ä¹ æ•™ç¨‹ï¼šå´æ©è¾¾ä¸“é¡¹è¯¾ç¨‹ Â· å…¨å¥—ç¬”è®°è§£è¯»**](https://www.showmeai.tech/tutorials/35)
> *   [**æ·±åº¦å­¦ä¹ æ•™ç¨‹ | åºåˆ—æ¨¡å‹ä¸RNNç½‘ç»œ**](https://www.showmeai.tech/article-detail/225)
> *   [**è‡ªç„¶è¯­è¨€å¤„ç†æ•™ç¨‹ï¼šæ–¯å¦ç¦CS224nè¯¾ç¨‹ Â· è¯¾ç¨‹å¸¦å­¦ä¸å…¨å¥—ç¬”è®°è§£è¯»**](https://www.showmeai.tech/tutorials/36)
> *   [**NLPæ•™ç¨‹(5) - è¯­è¨€æ¨¡å‹ã€RNNã€GRUä¸LSTM**](https://www.showmeai.tech/article-detail/239)

ğŸ’¡ æ•°æ®è·å–
=======

åœ¨å®é™…å»ºæ¨¡ä¸è®­ç»ƒä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆè·å–è‚¡ç¥¨æ•°æ®ã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨ Ameritrade API è·å–å¹¶ç”Ÿæˆæ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ¥æºã€‚

    import matplotlib.pyplot as plt
    import mplfinance as mpl 
    import pandas as pd
    
    td_consumer_key = 'YOUR-KEY-HERE'
    # ç¾å›½èˆªç©ºè‚¡ç¥¨
    ticker = 'AAL'
    ##periodType - day, month, year, ytd
    ##period - number of periods to show
    ##frequencyTYpe - type of frequency for each candle - day, month, year, ytd
    ##frequency - the number of the frequency type in each candle - minute, daily, weekly
    endpoint = 'https://api.tdameritrade.com/v1/marketdata/{stock_ticker}/pricehistory?periodType={periodType}&period={period}&frequencyType={frequencyType}&frequency={frequency}'
    
    # è·å–æ•°æ®
    full_url = endpoint.format(stock_ticker=ticker,periodType='year',period=10,frequencyType='daily',frequency=1)
    page = requests.get(url=full_url,params={'apikey' : td_consumer_key})
    content = json.loads(page.content)
    
    # è½¬æˆpandaså¯å¤„ç†æ ¼å¼
    df = pd.json_normalize(content['candles'])
    
    # è®¾ç½®æ—¶é—´æˆ³ä¸ºç´¢å¼•
    df['timestamp'] = pd.to_datetime(df.datetime, unit='ms')
    df = df.set_index("timestamp")
    
    # ç»˜åˆ¶æ•°æ®
    plt.figure(figsize=(15, 6), dpi=80)
    plt.plot(df['close'])
    plt.legend(['Closing Price'])
    plt.show()
    
    # å­˜å‚¨å‰ä¸€å¤©çš„æ•°æ®
    df["previous_close"] = df["close"].shift(1)
    df = df.dropna() # åˆ é™¤ç¼ºå¤±å€¼
    
    # å­˜å‚¨
    df.to_csv('../data/stock_'+ticker+'.csv', mode='w', index=True, header=True)
    

![](https://img-blog.csdnimg.cn/img_convert/dbf0f23753da8cac83207cd5d4d57f2a.png)

ä¸Šé¢çš„ä»£ç æŸ¥è¯¢ Ameritrade API å¹¶è¿”å› 10 å¹´çš„è‚¡ä»·æ•°æ®ï¼Œä¾‹å­ä¸­çš„è‚¡ç¥¨ä¸ºã€ç¾å›½èˆªç©ºå…¬å¸ã€ã€‚ æ•°æ®ç»˜å›¾ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://img-blog.csdnimg.cn/img_convert/90c7bdd38a916626149253d1048a71fb.png)

ğŸ’¡ æ•°æ®å¤„ç†
=======

æˆ‘ä»¬åŠ è½½åˆšæ‰ä¸‹è½½çš„æ•°æ®æ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¤„ç†é¢„æµ‹ã€‚

    # è¯»å–æ•°æ®
    ticker = 'AAL'
    df = pd.read_csv("../data/stock_"+ticker+".csv")
    
    # è®¾ç½®ç´¢å¼•
    df['DateIndex'] = pd.to_datetime(df['timestamp'], format="%Y/%m/%d")
    df = df.set_index('DateIndex')
    

ä¸‹é¢æˆ‘ä»¬å¯¹æ•°æ®è¿›å¹…åº¦ç¼©æ”¾ï¼Œä»¥ä¾¿æ›´å¥½åœ°é€å…¥ç¥ç»ç½‘ç»œå’Œè®­ç»ƒã€‚ï¼ˆç¥ç»ç½‘ç»œæ˜¯ä¸€ç§å¯¹äºè¾“å…¥æ•°æ®å¹…åº¦æ•æ„Ÿçš„æ¨¡å‹ï¼Œä¸åŒå­—æ®µè¾ƒå¤§çš„å¹…åº¦å·®å¼‚ï¼Œä¼šå½±å“ç½‘ç»œçš„è®­ç»ƒæ”¶æ•›é€Ÿåº¦å’Œç²¾åº¦ã€‚ï¼‰

    # å¹…åº¦ç¼©æ”¾
    df2 = df
    cols = ['close', 'volume', 'previous_close']
    features = df2[cols]
    scaler = MinMaxScaler(feature_range=(0, 1)).fit(features.values)
    features = scaler.transform(features.values)
    df2[cols] = features
    

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é‡ç‚¹å¤„ç†äº†**æ”¶ç›˜ä»·**ã€**æˆäº¤é‡**å’Œ**å‰å‡ å¤©æ”¶ç›˜ä»·åˆ—**ã€‚

ğŸ’¡ æ•°æ®åˆ‡åˆ†
=======

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ•°æ®æ‹†åˆ†ä¸ºè®­ç»ƒå’Œæµ‹è¯•æ•°æ®é›†ã€‚

    # æ”¶ç›˜ä»·è®¾ä¸ºç›®æ ‡å­—æ®µ
    X = df2.drop(['close','timestamp'], axis =1)
    y = df2['close']
    
    import math
    # è®¡ç®—åˆ‡åˆ†ç‚¹ï¼ˆä»¥80%çš„è®­ç»ƒæ•°æ®ä¸ºä¾‹ï¼‰
    train_percentage = 0.8
    split_point = math.floor(len(X) * train_percentage)
    
    # æ—¶åºåˆ‡åˆ†
    train_x, train_y = X[:split_point], y[:split_point]
    test_x, test_y = X[split_point:], y[split_point:]
    

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œæ„å»ºæ»‘çª—æ•°æ®ï¼Œæ²¿æ—¶é—´åºåˆ—åˆ›å»ºæ•°æ®æ ·æœ¬ã€‚ï¼ˆå› ä¸ºæˆ‘ä»¬éœ€è¦åŸºäºå†å²ä¿¡æ¯å¯¹æœªæ¥çš„æ•°å€¼è¿›è¡Œé¢„æµ‹ï¼‰

![](https://img-blog.csdnimg.cn/img_convert/07cb4b5902b203331d4cbc3d194eb904.png)

    # æ„å»ºæ»‘çª—æ•°æ®
    import numpy.lib
    from numpy.lib.stride_tricks import sliding_window_view
    
    def genWindows(X_in, y_in, window_size):
        X_out = []
        y_out = []
        length = X_in.shape[0]
        for i in range(window_size, length):
            X_out.append(X_in[i-window_size:i, 0:4])
            y_out.append(y_in[i-1])
        return np.array(X_out), np.array(y_out)
    
    # çª—å£å¤§å°ä¸º5
    window_size = 5
    X_train_win, y_train_win = genWindows(np.array(train_x), np.array(train_y), window_size)
    X_test_win, y_test_win = genWindows(np.array(test_x), np.array(test_y), window_size)
    

ğŸ’¡ æ¨¡å‹æ„å»º&è®­ç»ƒ
==========

æ„å»ºå®Œæ•°æ®ä¹‹åï¼Œæˆ‘ä»¬å°±è¦æ„å»º RNN æ¨¡å‹äº†ï¼Œå…·ä½“çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚æ³¨æ„åˆ°ä¸‹é¢ä½¿ç”¨äº†1ä¸ªå›è°ƒå‡½æ•°ï¼Œæ¨¡å‹ä¼šåœ¨éªŒè¯é›†æ€§èƒ½æ²¡æœ‰æ”¹å–„çš„æƒ…å†µä¸‹æå‰åœæ­¢è®­ç»ƒï¼Œé˜²æ­¢æ¨¡å‹è¿‡æ‹Ÿåˆå½±å“æ³›åŒ–èƒ½åŠ›ã€‚

    from tensorflow.keras import callbacks
    
    # æ—©åœæ­¢ å›è°ƒå‡½æ•°
    callback_early_stopping = callbacks.EarlyStopping(
        monitor="loss",
        patience=10,#look at last 10 epochs
        min_delta=0.0001,#loss must improve by this amount
        restore_best_weights=True,
    )
    
    
    from tensorflow import keras
    from tensorflow.keras import layers
    from keras.models import Sequential
    
    # æ„å»ºRNNæ¨¡å‹ï¼Œç»“æ„ä¸º è¾“å…¥-RNN-RNN-è¿ç»­å€¼è¾“å‡º
    input_shape=(X_train_win.shape[1],X_train_win.shape[2])
    print(input_shape)
    model = Sequential(
        [
            layers.Input(shape=input_shape),
            layers.SimpleRNN(units=128, return_sequences=True),
            layers.SimpleRNN(64, return_sequences=False),
            layers.Dense(1, activation="linear"),
        ]
    )
    
    # ä¼˜åŒ–å™¨
    optimizer = keras.optimizers.Nadam(learning_rate=0.0001)
    model.compile(optimizer=optimizer, loss="mse")
    
    # æ¨¡å‹ç»“æ„æ€»ç»“
    model.summary()
    
    # æ¨¡å‹è®­ç»ƒ
    batch_size = 20
    epochs = 50
    history = model.fit(X_train_win, y_train_win,
      batch_size=batch_size, epochs=epochs,
      callbacks=[
          callback_early_stopping
        ])
    

æ¨¡å‹è®­ç»ƒè¿‡ç¨‹çš„æŸå¤±å‡½æ•°ï¼ˆè®­ç»ƒé›†ä¸Šï¼‰çš„å˜åŒ–å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚éšç€è®­ç»ƒè¿‡ç¨‹æ¨è¿›ï¼Œæ¨¡å‹æŸå¤±ä¸æ–­ä¼˜åŒ–ï¼ŒåˆæœŸçš„ä¼˜åŒ–å’Œlosså‡å°é€Ÿåº¦å¾ˆå¿«ï¼Œåé€æ¸è¶‹äºå¹³ç¨³ã€‚

![](https://img-blog.csdnimg.cn/img_convert/0bc8dadf088914cb908a8d4dcd63f48e.png)

å¤§çº¦ 10 ä¸ª epoch åè¾¾åˆ°äº†æœ€ä½³ç»“æœï¼Œè®­ç»ƒå¥½çš„æ¨¡å‹å°±å¯ä»¥ç”¨äºåç»­é¢„æµ‹äº†ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¯¹è®­ç»ƒé›†è¿›è¡Œé¢„æµ‹ï¼ŒéªŒè¯ä¸€ä¸‹åœ¨è®­ç»ƒé›†ä¸Šå­¦ä¹ çš„æ•ˆæœã€‚

    # è®­ç»ƒé›†é¢„æµ‹
    pred_train_y = model.predict(X_train_win)
    
    # ç»˜å›¾
    plt.figure(figsize=(15, 6), dpi=80)
    plt.plot(np.array(train_y))
    plt.plot(pred_train_y)
    plt.legend(['Actual', 'Predictions'])
    plt.show()
    

æ¨¡å‹åœ¨è®­ç»ƒé›†ä¸Šå­¦ä¹ çš„æ•ˆæœè¿˜ä¸é”™ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°é¢„æµ‹ç»“æœå’ŒçœŸå®å€¼å¯¹æ¯”ç»˜å›¾å¦‚ä¸‹ï¼š

![](https://img-blog.csdnimg.cn/img_convert/275f7854502d82228a3f71b3e3b2a47d.png)

ğŸ’¡ æ¨¡å‹é¢„æµ‹&åº”ç”¨
==========

æˆ‘ä»¬è¦è¯„ä¼°æ¨¡å‹çš„çœŸå®è¡¨ç°ï¼Œéœ€è¦åœ¨å®ƒæ²¡æœ‰è§è¿‡çš„æµ‹è¯•æ•°æ®ä¸Šè¯„ä¼°ï¼Œå¤§å®¶è®°å¾—æˆ‘ä»¬åœ¨æ•°æ®åˆ‡åˆ†çš„æ—¶å€™é¢„ç•™äº† 20% çš„æ•°æ®ï¼Œä¸‹é¢æˆ‘ä»¬ç”¨æ¨¡å‹åœ¨è¿™éƒ¨åˆ†æ•°æ®ä¸Šé¢„æµ‹å¹¶è¯„ä¼°ã€‚

    # æµ‹è¯•é›†é¢„æµ‹
    pred_test_y = model.predict(X_test_win)
    
    # é¢„æµ‹ç»“æœç»˜åˆ¶
    plt.figure(figsize=(15, 6), dpi=80)
    plt.plot(np.array(test_y))
    plt.plot(pred_test_y)
    plt.legend(['Actual', 'Predictions'])
    plt.show()
    

![](https://img-blog.csdnimg.cn/img_convert/7f44199240534842e68e9cc9c4538bca.png)

ç›¸å¯¹è®­ç»ƒé›†æ¥è¯´ï¼Œå¤§å®¶çœ‹åˆ°æµ‹è¯•é›†ä¸Šçš„æ•ˆæœç¨æœ‰åå·®ï¼Œä½†æ˜¯æ€»ä½“è¶‹åŠ¿è¿˜æ˜¯é¢„æµ‹å¾—ä¸é”™ã€‚

æˆ‘ä»¬è¦è€ƒå¯Ÿè¿™ä¸ªæ¨¡å‹å¯¹äºæ—¶é—´åºåˆ—é¢„æµ‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œå¯ä»¥è¿›è¡Œæ›´ä¸¥æ ¼ä¸€ç‚¹çš„å»ºæ¨¡é¢„æµ‹ï¼Œæ¯”å¦‚å°†è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹åº”ç”¨ä¸å¦ä¸€æ”¯å®Œå…¨æ²¡è§è¿‡çš„è‚¡ç¥¨ä¸Šè¿›è¡Œé¢„æµ‹ã€‚å¦‚ä¸‹ä¸ºæˆ‘ä»¬è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹å¯¹ Microsoft/å¾®è½¯è‚¡ç¥¨ä»·æ ¼çš„é¢„æµ‹ï¼š

![](https://img-blog.csdnimg.cn/img_convert/55e2996be3efa7328a0d66330567f45d.png)

![](https://img-blog.csdnimg.cn/img_convert/afb40e26ea71aafd8eeb9c04fc371c89.png)

æˆ‘ä»¬ä»å›¾ä¸Šå¯ä»¥çœ‹åˆ°ï¼Œæ¨¡å‹è¡¨ç°è‰¯å¥½ï¼ˆé¢„æµ‹å­˜åœ¨ä¸€å®šç¨‹åº¦çš„å™ªéŸ³ï¼Œä½†å®ƒå¯¹æ€»ä½“è¶‹åŠ¿çš„é¢„æµ‹æ¯”è¾ƒå‡†ç¡®ï¼‰ã€‚

å‚è€ƒèµ„æ–™
====

*   ğŸ“˜ **æ·±åº¦å­¦ä¹ æ•™ç¨‹ï¼šå´æ©è¾¾ä¸“é¡¹è¯¾ç¨‹ Â· å…¨å¥—ç¬”è®°è§£è¯»**ï¼š[https://www.showmeai.tech/tutorials/35](https://www.showmeai.tech/tutorials/35)
*   ğŸ“˜ **è‡ªç„¶è¯­è¨€å¤„ç†æ•™ç¨‹ï¼šæ–¯å¦ç¦CS224nè¯¾ç¨‹ Â· è¯¾ç¨‹å¸¦å­¦ä¸å…¨å¥—ç¬”è®°è§£è¯»**ï¼š[https://www.showmeai.tech/tutorials/36](https://www.showmeai.tech/tutorials/36)
*   ğŸ“˜ **æ·±åº¦å­¦ä¹ æ•™ç¨‹ | åºåˆ—æ¨¡å‹ä¸RNNç½‘ç»œ**ï¼š[https://www.showmeai.tech/article-detail/225](https://www.showmeai.tech/article-detail/225)
*   ğŸ“˜ **NLPæ•™ç¨‹(5) - è¯­è¨€æ¨¡å‹ã€RNNã€GRUä¸LSTM**ï¼š[https://www.showmeai.tech/article-detail/239](https://www.showmeai.tech/article-detail/239)

[![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e9190f41b8de4af38c8a1a0c96f0513b~tplv-k3u1fbpfcp-zoom-1.image)](https://www.showmeai.tech/)