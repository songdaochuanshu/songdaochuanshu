---
layout: post
title: "ç”±ASP.NET Coreæ ¹æ®è·¯å¾„ä¸‹è½½æ–‡ä»¶å¼‚å¸¸å¼•å‘çš„æ¢ç©¶"
date: "2022-06-29T03:49:23.778Z"
---
ç”±ASP.NET Coreæ ¹æ®è·¯å¾„ä¸‹è½½æ–‡ä»¶å¼‚å¸¸å¼•å‘çš„æ¢ç©¶
============================

### å‰è¨€

Â Â Â Â æœ€è¿‘åœ¨å¼€å‘æ–°çš„é¡¹ç›®ï¼Œä½¿ç”¨çš„æ˜¯ASP.NET Core6.0ç‰ˆæœ¬çš„æ¡†æ¶ã€‚ç”±äºé¡¹ç›®ä¸­å­˜åœ¨æ–‡ä»¶ä¸‹è½½åŠŸèƒ½ï¼Œæ²¡æœ‰ä½¿ç”¨ç±»ä¼¼`MinIO`æˆ–`OSS`ä¹‹ç±»çš„åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œæ˜¯ä¸‹è½½æœ¬åœ°æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ ¹æ®æœ¬åœ°æ–‡ä»¶è·¯å¾„è¿›è¡Œä¸‹è½½ã€‚è¿™å…¶ä¸­é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæ˜¯å…³äºå¦‚ä½•æä¾›æ–‡ä»¶è·¯å¾„çš„ï¼Œé€šè¿‡æœ¬æ–‡è®°å½•ä¸€ä¸‹ç›¸å…³æ€»ç»“ï¼Œå¸Œæœ›èƒ½å¸®åŠ©æ›´å¤šçš„åŒå­¦é¿å…è¿™ä¸ªé—®é¢˜ã€‚

### ä½¿ç”¨æ–¹å¼

ç”±äºæˆ‘ä»¬çš„ç³»ç»Ÿæ²¡æœ‰å…¬å¸å†…éƒ¨ä½¿ç”¨çš„ä¹Ÿæ²¡æœ‰åšè´Ÿè½½å‡è¡¡ä¹‹ç±»çš„ï¼Œæ‰€ä»¥æ–‡ä»¶æ˜¯å­˜å‚¨åœ¨å½“å‰æœåŠ¡å™¨ä¸­çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥ä½¿ç”¨æ–‡ä»¶ç»å¯¹è·¯å¾„çš„æ–¹å¼æ¥è¿›è¡Œä¸‹è½½çš„ï¼Œä½¿ç”¨çš„æ˜¯ASP.NET Coreè‡ªå¸¦çš„Fileæ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯å¦‚ä¸‹æ–¹æ³•(å®é™…ä¸Šæ–‡ä»¶çš„è·¯å¾„æ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„)

    [HttpGet]
    [Produces("application/msword", Type = typeof(FileResult))]
    public FileResult Virtual()
    {
        // AppContext.BaseDirectoryç”¨æ¥è·å–å½“å‰æ‰§è¡Œç¨‹åºçš„åŸºç›®å½•
        // ç»“æœä¸ºç»å¯¹è·¯å¾„,æ¯”å¦‚ D:\CodeProject\MyTest.WebApi\bin\Debug\net6.0\
        var filePath = Path.Combine(AppContext.BaseDirectory, "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        return File(filePath, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    }
    

è¿™æ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ–¹å¼æ²¡å¤ªåœ¨æ„ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡ï¼Œç­‰è‡ªæµ‹çš„æ—¶å€™å‘ç°æŠ¥äº†ä¸€ä¸ª`System.InvalidOperationException`å¼‚å¸¸ï¼Œå¤§è‡´å†…å®¹å¦‚ä¸‹æ‰€ç¤º

     System.InvalidOperationException: No file provider has been configured to process the supplied file.
             at Microsoft.AspNetCore.Mvc.Infrastructure.VirtualFileResultExecutor.GetFileInformation(VirtualFileResult result, IWebHostEnvironment hostingEnvironment)
             at Microsoft.AspNetCore.Mvc.Infrastructure.VirtualFileResultExecutor.ExecuteAsync(ActionContext context, VirtualFileResult result)
             at Microsoft.AspNetCore.Mvc.VirtualFileResult.ExecuteResultAsync(ActionContext context)
    

çœ‹å¼‚å¸¸å†…å®¹é—®é¢˜æ˜¯å‡ºåœ¨`VirtualFileResultExecutor.GetFileInformation()æ–¹æ³•`ï¼Œå®ƒçš„æ„æ€å¤§æ¦‚æ˜¯æ²¡æœ‰æä¾›æ–‡ä»¶æä¾›æ¥å¤„ç†æ–‡ä»¶ï¼Œå¯¹äºæ–‡ä»¶æä¾›ç¨‹åºå¦‚æœäº†è§£è¿‡ASP.NET Coreé™æ€æ–‡ä»¶ç›¸å…³çš„è¯åº”è¯¥æ˜¯äº†è§£è¿™ä¸ªçš„ã€‚å¦‚æœæƒ³è®¿é—®ASP.NET Coreä¸­çš„é™æ€æ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ä¸å¯ä»¥ç›´æ¥è®¿é—®çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œæƒ³ä½¿ç”¨çš„è¯å¿…é¡»å¼€å¯é™æ€æ–‡ä»¶è®¿é—®æœºåˆ¶ï¼Œä¸”é»˜è®¤çš„é™æ€æ–‡ä»¶è¦å­˜å‚¨åœ¨`wwwroot`è·¯å¾„ä¸‹ã€‚å¦‚æœæƒ³åœ¨å…¶å®ƒè·¯å¾„æä¾›é™æ€æ–‡ä»¶åˆ™å¿…é¡»è¦æä¾›æ–‡ä»¶å¤„ç†ç¨‹åºï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ–¹å¼åˆ™æ˜¯

    var fileProvider = new PhysicalFileProvider($"{env.ContentRootPath}/staticfiles");
    app.UseStaticFiles(new StaticFileOptions {
        RequestPath="/staticfiles",
        FileProvider = fileProvider
    });
    

åŒæ ·çš„åœ¨è¿™é‡Œæˆ‘ä»¬ä¹Ÿéœ€è¦æä¾›`IFileProvider`å®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯ä½¿ç”¨çš„æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥è¦æä¾›`PhysicalFileProvider`å®ä¾‹ï¼Œé€šè¿‡ä¸‹é¢æ–¹æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜

    [HttpGet]
    [Produces("application/msword", Type = typeof(FileResult))]
    public FileResult Virtual()
    {
        var filePath = "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx";
        return new VirtualFileResult(filePath, "application/msword")
        {
            // æä¾›æŒ‡å®šç›®å½•çš„æ–‡ä»¶è®¿é—®ç¨‹åº
            FileProvider = new PhysicalFileProvider(AppContext.BaseDirectory),
            FileDownloadName = "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx"
        };
    }
    

äº¦æˆ–è€…æ˜¯é€šè¿‡åŸå§‹çš„æ–¹å¼ï¼Œæ¯”å¦‚è¯»å–æ–‡ä»¶çš„`Stream`æˆ–è€…`byte[]`çš„æ–¹å¼

    [HttpGet]
    [Produces("application/msword", Type = typeof(FileResult))]
    public FileResult Virtual()
    {
        //è¯»å–byte[]æ–¹å¼
        var filePath = Path.Combine(AppContext.BaseDirectory, @"files\ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        var fileBytes = System.IO.File.ReadAllBytes(filePath);
        return File(fileBytes, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    
        //è¯»å–Streamçš„æ–¹å¼
        //var filePath = Path.Combine(AppContext.BaseDirectory, @"files\ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        //var fileStream = System.IO.File.OpenRead(filePath);
        //return File(fileStream, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    }
    

é€šè¿‡è¿™äº›æ–¹å¼è™½ç„¶å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†æ˜¯çœ‹èµ·æ¥ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œè€Œä¸”å¦‚æœæä¾›ä¸åŒè·¯å¾„çš„æ–‡ä»¶è¿˜å¾—è¦æœ‰è®¸å¤šçš„`PhysicalFileProvider`å®ä¾‹ï¼Œæˆ–è€…è‡ªå·±å°è£…æ–¹æ³•å»è§£å†³é—®é¢˜ã€‚  
å½“æ—¶å°±æƒ³å¾®è½¯ä¸è‡³äºè¿è¯»å–è‡ªå®šä¹‰ç‰©ç†è·¯å¾„çš„æ–¹æ³•éƒ½ä¸æä¾›å§ï¼Œäºæ˜¯å°±åœ¨`ControllerBase`åŸºç±»ä¸­æŸ¥æ‰¾ç›¸å…³æ–¹æ³•ï¼Œç»ˆäºçœ‹åˆ°äº†ä¸€ä¸ªå«`PhysicalFile`çš„æ–¹æ³•ï¼Œçœ‹åå­—å°±çŸ¥é“æ˜¯æä¾›ç‰©ç†æ–‡ä»¶ç”¨çš„ï¼Œä¸çŸ¥é“è¡Œä¸è¡Œå†™ä»£ç è¯•äº†è¯•ï¼Œç¨‹åºå¦‚ä¸‹

    [HttpGet]
    [Produces("application/msword", Type = typeof(FileResult))]
    public FileResult Physical()
    {
        var filePath = Path.Combine(AppContext.BaseDirectory, "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        return PhysicalFile(filePath, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    }
    

ç»“æœè¿˜çœŸçš„æ˜¯å¯ä»¥ï¼Œè¿™ä¸ªæ–¹æ³•å‘¢æä¾›çš„æ–‡ä»¶è·¯å¾„å¯ä»¥æ˜¯æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼Œè€Œä¸éœ€è¦æä¾›åˆ«çš„æ–‡ä»¶æä¾›ç¨‹åºã€‚è¿™å°±å‹¾èµ·äº†æˆ‘çš„å¥½å¥‡å¿ƒï¼Œä¸ºå•¥ä¸¤ä¸ªæ“ä½œè¿˜ä¸ä¸€æ ·å‘¢ï¼Œä¸ºå•¥æœ‰è¿™æ ·çš„åŒºåˆ«ï¼Ÿ

### æºç æ¢ç©¶

é€šè¿‡ä¸Šé¢é‡åˆ°çš„é—®é¢˜çŸ¥é“äº†å¦‚æœæƒ³æä¾›ç»å¯¹è·¯å¾„çš„æ–‡ä»¶ä¸‹è½½éœ€è¦ä½¿ç”¨`PhysicalFile`æ–¹æ³•å»ä¸‹è½½ï¼Œè€Œé»˜è®¤çš„`File`æ–¹æ³•åˆ™ä¸èƒ½ç›´æ¥ä¸‹è½½ç»å¯¹è·¯å¾„çš„æ–‡ä»¶ï¼Œæ€€æ£ç€å¥½å¥‡å¿ƒï¼Œå¤§æ¦‚çœ‹äº†ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„ç›¸å…³æºç å®ç°ã€‚

#### VirtualFileResult

æ¥ä¸‹æ¥å’±ä»¬å°±æ¥çœ‹ä¸€ä¸‹æ–¹æ³•çš„å®šä¹‰åœ¨`ControllerBase`ç±»ä¸­ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹`File(string virtualPath, string contentType, string? fileDownloadName)`æ–¹æ³•çš„å®šä¹‰\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/ControllerBase.cs#L1473)\]

    [NonAction]
    public virtual VirtualFileResult File(string virtualPath, string contentType, string? fileDownloadName)
        => new VirtualFileResult(virtualPath, contentType) { FileDownloadName = fileDownloadName };
    

é€šè¿‡`virtualPath`è¿™ä¸ªå˜é‡æˆ‘ä»¬å¤§æ¦‚èƒ½çŒœå‡ºæ¥ï¼Œé»˜è®¤æä¾›çš„æ˜¯ç›¸å¯¹ç›®å½•ï¼Œå³å½“å‰è¿è¡Œç¨‹åºé…ç½®çš„ç›¸å…³ç›®å½•ã€‚é€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒçš„æœ¬è´¨æ˜¯`VirtualFileResult`è¿™ä¸ªç±»ï¼Œé‚£æˆ‘ä»¬ç»§ç»­æ‰¾åˆ°`VirtualFileResult`ç±»çš„å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/VirtualFileResult.cs)\]

    public class VirtualFileResult : FileResult
    {
        public VirtualFileResult(string fileName, string contentType)
            : this(fileName, MediaTypeHeaderValue.Parse(contentType))
        {
        }
    
        public VirtualFileResult(string fileName, MediaTypeHeaderValue contentType)
            : base(contentType.ToString())
        {
            FileName = fileName ?? throw new ArgumentNullException(nameof(fileName));
        }
    
        // è¿”å›å®¢æˆ·ç«¯çš„æ–‡ä»¶åç§°
        private string _fileName;
        public string FileName
        {
            get => _fileName;
            [MemberNotNull(nameof(_fileName))]
            set => _fileName = value ?? throw new ArgumentNullException(nameof(value));
        }
        
        //æ–‡ä»¶æä¾›ç¨‹åº
        public IFileProvider? FileProvider { get; set; }
    
        /// <summary>
        /// çœŸæ­£ä¸‹è½½æ‰§è¡Œçš„æ–¹æ³•
        /// </summary>
        public override Task ExecuteResultAsync(ActionContext context)
        {
            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }
    
            //æ‰§è¡Œäº†IActionResultExecutor<VirtualFileResult>å®ä¾‹çš„ExecuteAsyncæ–¹æ³•
            var executor = context.HttpContext.RequestServices.GetRequiredService<IActionResultExecutor<VirtualFileResult>>();
            return executor.ExecuteAsync(context, this);
        }
    }
    

åœ¨ASP.NET Coreä¸­Actionçš„ç»“æœéƒ½æ˜¯ç”±`IActionResultExecutor<>`æä¾›ç›¸å…³çš„å®ä¾‹ï¼Œå…·ä½“çš„`ExecuteResultAsync`æ–¹æ³•åªæ˜¯åœ¨æ‰§è¡Œ`IActionResultExecutor<>`é‡Œçš„`ExecuteAsync`å®ç°æ–¹æ³•ï¼Œè¿™ä¸ªæ˜¯åœ¨`AddControllers`æ–¹æ³•çš„æ—¶å€™æ³¨å†Œçš„ï¼Œå¯ä»¥é€šè¿‡æºç æ‰¾åˆ°`IActionResultExecutor<VirtualFileResult>`æ¥å£æ³¨å†Œçš„å®ä¾‹\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/DependencyInjection/MvcCoreServiceCollectionExtensions.cs#L250)\]

    services.TryAddSingleton<IActionResultExecutor<VirtualFileResult>, VirtualFileResultExecutor>();
    

ç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“`IActionResultExecutor<VirtualFileResult>`æ³¨å†Œçš„æ˜¯`VirtualFileResultExecutor`ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥æŸ¥çœ‹`VirtualFileResultExecutor`ç±»çš„`ExecuteAsync`æ–¹æ³•çš„å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/Infrastructure/VirtualFileResultExecutor.cs#L41)\]

    public virtual Task ExecuteAsync(ActionContext context, VirtualFileResult result)
    {
        // çœç•¥éƒ¨åˆ†ä»£ç 
    
        // è·å–æ–‡ä»¶ä¿¡æ¯
        var fileInfo = GetFileInformation(result, _hostingEnvironment);
        // æ–‡ä»¶ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸
        if (!fileInfo.Exists)
        {
            throw new FileNotFoundException(Resources.FormatFileResult_InvalidPath(result.FileName), result.FileName);
        }
    
        Logger.ExecutingFileResult(result, result.FileName);
    
        var lastModified = result.LastModified ?? fileInfo.LastModified;
        var (range, rangeLength, serveBody) = SetHeadersAndLog(
            context,
            result,
            fileInfo.Length,
            result.EnableRangeProcessing,
            lastModified,
            result.EntityTag);
    
        if (serveBody)
        {
            // æ‰§è¡Œä¸‹è½½ç¨‹åº
            return WriteFileAsync(context, result, fileInfo, range, rangeLength);
        }
        return Task.CompletedTask;
    }
    

é€šè¿‡è¿™ä¸ªæ–¹æ³•å¯ä»¥çŸ¥é“åˆ¤æ–­æ–‡ä»¶ä¿¡æ¯å­˜ä¸å­˜åœ¨æ˜¯åœ¨`GetFileInformation`è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„é‚£ä¸ªå¼‚å¸¸ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•é‡ŒæŠ¥å‡ºæ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°çš„ï¼Œçœ‹ä¸€ä¸‹å…·ä½“å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/Infrastructure/VirtualFileResultExecutor.cs#L126)\]

    /// <summary>
    /// è·å–æ–‡ä»¶ä¿¡æ¯
    /// </summary>
    internal static IFileInfo GetFileInformation(VirtualFileResult result, IWebHostEnvironment hostingEnvironment)
    {
        // è·å–æ–‡ä»¶æä¾›ç¨‹åº
        var fileProvider = GetFileProvider(result, hostingEnvironment);
        //å¦‚æœæ˜¯NullFileProvideråˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸
        if (fileProvider is NullFileProvider)
        {
            throw new InvalidOperationException(Resources.VirtualFileResultExecutor_NoFileProviderConfigured);
        }
    
        var normalizedPath = result.FileName;
        //ç‰¹æ®Šå¼€å¤´å¤„ç†
        if (normalizedPath.StartsWith("~", StringComparison.Ordinal))
        {
            normalizedPath = normalizedPath.Substring(1);
        }
        //è·å–è¦ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯
        var fileInfo = fileProvider.GetFileInfo(normalizedPath);
        return fileInfo;
    }
    
    /// <summary>
    /// è·å–æ–‡ä»¶æä¾›ç¨‹åº
    /// </summary>
    internal static IFileProvider GetFileProvider(VirtualFileResult result, IWebHostEnvironment hostingEnvironment)
    {
        //åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†VirtualFileResultçš„FileProviderå±æ€§
        if (result.FileProvider != null)
        {
            return result.FileProvider;
        }
        //æ²¡è®¾ç½®åˆ™ä½¿ç”¨WebRootFileProviderï¼Œå³è®¾ç½®ç›®å½•ä¸ºwwwrootçš„æ–‡ä»¶æä¾›ç¨‹åº
        result.FileProvider = hostingEnvironment.WebRootFileProvider;
        return result.FileProvider;
    }
    

é€šè¿‡è¿™æ®µä»£ç æˆ‘ä»¬çœ‹åˆ°äº†é—®é¢˜çš„æ‰€åœ¨ï¼Œæˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„å¼‚å¸¸ä½ç½®çš„`GetFileInformation`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦æ‰¾åˆ°çš„ä½ç½®ï¼Œè¿™ä¸ªåœ°æ–¹è·å–åˆ°çš„`IFileInfo`æ˜¯åŸºäºFileProviderçš„å› æ­¤é€šè¿‡å®ƒè·å–çš„æ–‡ä»¶çš„ç‰©ç†è·¯å¾„æ˜¯`å½“å‰ç¨‹åºè·¯å¾„/WebRootFileProviderè·¯å¾„/ä¼ é€’çš„è·¯å¾„`ï¼Œæ¯”å¦‚ç¨‹åºè·¯å¾„`D:\CodeProject\MyTest.WebApi\bin\Debug\net6.0\`+WebRootFileProviderè·¯å¾„`wwwroot\`+ä¼ é€’è·¯å¾„`files\ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx`æ‹¼æ¥è€Œæˆï¼Œå› æ­¤åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ç»“è®º

*   ä¸‹è½½çš„æ–‡ä»¶ä¿¡æ¯æ˜¯åœ¨`IFileProvider`å®ä¾‹ä¸­è·å–åˆ°çš„
*   `GetFileProvider`æ–¹æ³•ä¼šåˆ¤æ–­æ˜¯å¦æ‰‹åŠ¨è®¾ç½®äº†ä¸‹è½½æ–‡ä»¶çš„`IFileProvider`,å¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨`IWebHostEnvironment`çš„`WebRootFileProvider`å®ä¾‹ï¼Œå³æ¡†æ¶ä¸­`wwwrootç›®å½•`çš„æ–‡ä»¶æä¾›ç¨‹åº
*   æˆ‘ä»¬æä¾›ç»å¯¹è·¯å¾„ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæœ¬è´¨æ˜¯æˆ‘ä»¬æ²¡æœ‰æä¾›éœ€è¦ä¸‹è½½æ–‡ä»¶çš„æ–‡ä»¶æä¾›ç¨‹åºå®ä¾‹`IFileProvider`ï¼Œæ‰€ä»¥ç¨‹åºä½¿ç”¨äº†`wwwrootç›®å½•`çš„æ–‡ä»¶æä¾›ç¨‹åº

æ‰€ä»¥å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæˆ‘ä»¬å¦‚æœæƒ³ç›´æ¥ä½¿ç”¨ç›®å½•çš„è¯ï¼Œé‚£æŒ‡å®šçš„ç›®å½•å¿…é¡»å¾—æ˜¯åŸºäº`wwwroot`æ–‡ä»¶å¤¹çš„ç›®å½•è¿›è¡Œå­˜å‚¨çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ–‡ä»¶å­˜å‚¨çš„æ–‡ä»¶å¤¹å¾—æ˜¯åœ¨`wwwroot`é‡Œæ‰è¡Œã€‚æ¯”å¦‚æˆ‘ä»¬å°†æˆ‘ä»¬çš„ä¸Šä¼ çš„æ–‡ä»¶ç§»åŠ¨åˆ°`wwwroot/files/`æ–‡ä»¶å¤¹å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ç¼–å†™ä¸‹è½½ç¨‹åºç›¸å…³ä»£ç çš„æ—¶å€™å¯ä»¥ç›´æ¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼

    [HttpGet]
    [Produces("application/msword", Type = typeof(FileResult))]
    public FileResult Virtual()
    {
        var filePath = "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx";
        return File(filePath, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    }
    

è¿™æ ·çš„è¯ç¨‹åºå°±å¯ä»¥è¿è¡ŒæˆåŠŸäº†ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†ä¸Šé¢æä¾›çš„Fileæ–¹æ³•ä¸­æåˆ°çš„æ˜¯`virtualPath`äº†ã€‚å…³äº`wwwroot`æœºåˆ¶åœ¨æºç ä¸­å¯ä»¥çœ‹åˆ°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Hosting/Hosting/src/Internal/HostingEnvironmentExtensions.cs#L33)\]

    var webRoot = options.WebRoot;
    //åˆ¤æ–­é…ç½®é‡ŒWebRootæ˜¯å¦é…ç½®
    if (webRoot == null)
    {
        var wwwroot = Path.Combine(hostingEnvironment.ContentRootPath, "wwwroot");
        //åˆ¤æ–­wwwrootç›®å½•æ˜¯å¦å­˜åœ¨
        if (Directory.Exists(wwwroot))
        {
            hostingEnvironment.WebRootPath = wwwroot;
        }
    }
    else
    {
        hostingEnvironment.WebRootPath = Path.Combine(hostingEnvironment.ContentRootPath, webRoot);
    }
    //åˆ¤æ–­IWebHostEnvironmentä¸­çš„WebRootPathæ˜¯å¦å­˜åœ¨
    if (!string.IsNullOrEmpty(hostingEnvironment.WebRootPath))
    {
        hostingEnvironment.WebRootPath = Path.GetFullPath(hostingEnvironment.WebRootPath);
        //ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»ºwwwrootç›®å½•
        if (!Directory.Exists(hostingEnvironment.WebRootPath))
        {
            Directory.CreateDirectory(hostingEnvironment.WebRootPath);
        }
        //æ ¹æ®wwwrootè·¯å¾„åˆ›å»ºWebRootFileProvideræ–‡ä»¶æä¾›ç¨‹åº
        hostingEnvironment.WebRootFileProvider = new PhysicalFileProvider(hostingEnvironment.WebRootPath);
    }
    else
    {
        //å¦‚æœæ²¡æœ‰æä¾›wwwrootæ–‡ä»¶è·¯å¾„åˆ™èµ‹å€¼NullFileProvider
        hostingEnvironment.WebRootFileProvider = new NullFileProvider();
    }
    

é€šè¿‡è¿™æ®µä»£ç ç›¸ä¿¡å¤§å®¶å¯¹`wwwroot`é»˜è®¤çš„æœºåˆ¶èƒ½æœ‰ä¸€å®šçš„äº†è§£äº†ï¼ŒASP.NET Coreä¼šæ ¹æ®ç¨‹åºæ˜¯å¦åŒ…å«`wwwrootç›®å½•`è‡ªè¡Œåˆ¤æ–­æ¥å¡«å……`IWebHostEnvironment`å®ä¾‹ä¸­`WebRootPath`å±æ€§å’Œ`WebRootFileProvider`å±æ€§çš„å€¼ã€‚æ‰€ä»¥å¯ä»¥å…ˆæ·»åŠ `wwwroot`æ–‡ä»¶å¤¹ï¼Œç„¶ååŸºäºè¿™ä¸ªç›®å½•æ·»åŠ è‡ªå®šä¹‰çš„æ–‡ä»¶å¤¹ï¼Œè¿™æ ·å¯ä»¥ç›´æ¥ä½¿ç”¨`File`æ–¹æ³•è¿›è¡Œä¸‹è½½äº†ã€‚

#### PhysicalFileResult

ä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°äº†VirtualFileResultçš„å·¥ä½œæœºåˆ¶ï¼Œä½¿ç”¨VirtualFileResultä¸‹è½½çš„æ—¶å€™é»˜è®¤éœ€è¦æä¾›è™šæ‹Ÿçš„è·¯å¾„å³åŸºäºå½“å‰åº”ç”¨çš„ç›®å½•ï¼Œé»˜è®¤çš„æ˜¯`wwwroot`ç›®å½•ã€‚äº¦æˆ–è€…ä½ å¯ä»¥è‡ªå·±æä¾›`IFileProvider`æœºåˆ¶æ¥å®Œæˆè‡ªå®šä¹‰ç›®å½•çš„ä¸‹è½½ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨`PhysicalFile()`æ–¹æ³•ä¸‹è½½çš„æ—¶å€™å´å¯ä»¥ç›´æ¥ä¸‹è½½ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼ŸåŒæ ·çš„æˆ‘ä»¬æ‰¾åˆ°æ–¹æ³•å®šä¹‰çš„åœ°æ–¹\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/ControllerBase.cs#L1628)\]

    [NonAction]
    public virtual PhysicalFileResult PhysicalFile(
        string physicalPath,
        string contentType,
        string? fileDownloadName)
        => new PhysicalFileResult(physicalPath, contentType) { FileDownloadName = fileDownloadName };
    

è¿™é‡Œå¯ä»¥çœ‹åˆ°æ–¹æ³•å­—æ®µçš„åå­—æ˜¯`physicalPath`ä¹Ÿå°±æ˜¯ç‰©ç†è·¯å¾„ï¼Œæ–¹æ³•è¿”å›çš„æ˜¯`PhysicalFileResult`ç±»çš„å®ä¾‹ã€‚æˆ‘ä»¬æ‰¾åˆ°PhysicalFileResultç±»çš„`ExecuteResultAsync`æ–¹æ³•çš„ç›¸å…³æºç \[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/PhysicalFileResult.cs#L59)\]

    public class PhysicalFileResult : FileResult
    {
        public PhysicalFileResult(string fileName, string contentType)
            : this(fileName, MediaTypeHeaderValue.Parse(contentType))
        {
            if (fileName == null)
            {
                throw new ArgumentNullException(nameof(fileName));
            }
        }
    
        public PhysicalFileResult(string fileName, MediaTypeHeaderValue contentType)
            : base(contentType.ToString())
        {
            FileName = fileName ?? throw new ArgumentNullException(nameof(fileName));
        }
        
        // è¿”å›å®¢æˆ·ç«¯çš„æ–‡ä»¶åç§°
        private string _fileName;
        public string FileName
        {
            get => _fileName;
            [MemberNotNull(nameof(_fileName))]
            set => _fileName = value ?? throw new ArgumentNullException(nameof(value));
        }
        
        /// <summary>
        /// çœŸæ­£ä¸‹è½½æ‰§è¡Œçš„æ–¹æ³•
        /// </summary>
        public override Task ExecuteResultAsync(ActionContext context)
        {
            if (context == null)
            {
                throw new ArgumentNullException(nameof(context));
            }
    
            var executor = context.HttpContext.RequestServices.GetRequiredService<IActionResultExecutor<PhysicalFileResult>>();
            return executor.ExecuteAsync(context, this);
        }
    }
    

é€šè¿‡è¿™ä¸ªç±»å¯ä»¥çœ‹å‡ºç›¸è¾ƒäº`VirtualFileResult`ç±»å°‘äº†`FileProvider`å±æ€§ï¼Œè¿™ä¹Ÿè¯´æ˜äº†ç¡®å®æ˜¯ä¸éœ€è¦ä¼ é€’æ–‡ä»¶è®¿é—®ç¨‹åºã€‚`ExecuteResultAsync`æ–¹æ³•æ˜¯å®Œå…¨é€æ˜çš„ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨`IActionResultExecutor<PhysicalFileResult>`å®ä¾‹ä¸­\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/DependencyInjection/MvcCoreServiceCollectionExtensions.cs#L249)\]

    services.TryAddSingleton<IActionResultExecutor<PhysicalFileResult>, PhysicalFileResultExecutor>();
    

ç…§æ—§æˆ‘ä»¬ç›´æ¥æ‰¾åˆ°æˆ‘ä»¬å¯ä»¥ç›´æ¥æŸ¥çœ‹`PhysicalFileResultExecutor`ç±»çš„`ExecuteAsync`æ–¹æ³•çš„å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Mvc/Mvc.Core/src/Infrastructure/PhysicalFileResultExecutor.cs#L29)\]

    public virtual Task ExecuteAsync(ActionContext context, PhysicalFileResult result)
    {
        //çœç•¥ä»£ç 
    
        //è·å–æ–‡ä»¶ä¿¡æ¯
        var fileInfo = GetFileInfo(result.FileName);
        //æ–‡ä»¶ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸
        if (!fileInfo.Exists)
        {
            throw new FileNotFoundException(
                Resources.FormatFileResult_InvalidPath(result.FileName), result.FileName);
        }
    
        Logger.ExecutingFileResult(result, result.FileName);
    
        var lastModified = result.LastModified ?? fileInfo.LastModified;
        var (range, rangeLength, serveBody) = SetHeadersAndLog(
            context,
            result,
            fileInfo.Length,
            result.EnableRangeProcessing,
            lastModified,
            result.EntityTag);
        if (serveBody)
        {
            // çœŸæ­£æ‰§è¡Œä¸‹è½½
            return WriteFileAsync(context, result, range, rangeLength);
        }
        return Task.CompletedTask;
    }
    

åŒæ ·çš„æ˜¯åœ¨`GetFileInfo`æ–¹æ³•é‡Œï¼Œçœ‹ä¸€ä¸‹å®šä¹‰

    protected virtual FileMetadata GetFileInfo(string path)
    {
        //ç›´æ¥æ ¹æ®ä¼ è¿›æ¥çš„è·¯å¾„è·å–çš„æ–‡ä»¶ä¿¡æ¯
        var fileInfo = new FileInfo(path);
        return new FileMetadata
        {
            Exists = fileInfo.Exists,
            Length = fileInfo.Length,
            LastModified = fileInfo.LastWriteTimeUtc,
        };
    }
    

åŒºåˆ«ä¸»è¦å°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯ç›´æ¥æ ¹æ®æ–‡ä»¶çš„ç»å¯¹è·¯å¾„è·å–çš„æ–‡ä»¶ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦å€ŸåŠ©`FileProvider`,å› æ­¤å¦‚æœä½ ä¼ é€’çš„æ˜¯`D:\CodeProject\MyTest.WebApi\bin\Debug\net6.0\wwwroot\files\ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx`ï¼Œé‚£ä¹ˆè·å–åˆ°çš„æ–‡ä»¶ä¿¡æ¯ä¹Ÿæ˜¯æ¥è‡ªäºè¿™ä¸ªè·¯å¾„ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚

#### SendFileAsyncæ–¹æ³•

å’±ä»¬çœ‹åˆ°çš„é€»è¾‘éƒ½æ˜¯ä¸ºäº†è·å–åˆ°æ–‡ä»¶çš„çœŸå®è·¯å¾„ï¼Œè€ŒçœŸæ­£æ‰§è¡Œä¸‹è½½çš„æ˜¯`WriteFileAsync`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒé€»è¾‘å…¶å®å°±æ˜¯è°ƒç”¨äº†`HttpResponse`çš„æ‰©å±•æ–¹æ³•`SendFileAsync`æ–¹æ³•ï¼Œæ‰€ä»¥å¦‚æœä½ ä¸æƒ³ç”¨`FileResult`ç±»ç›¸å…³æ–¹æ³•æä¾›ä¸‹è½½çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå”¯ä¸€æ¯”è¾ƒéº»çƒ¦çš„å°±æ˜¯ä¸‹è½½çš„`Header`ä¿¡æ¯ä½ å¾—è‡ªå·±å¡«å……ä¸Šå»ï¼Œç®€å•çš„ç¤ºä¾‹ä¸€ä¸‹

    [HttpGet]
    public Task SendFile()
    {
        var filePath = Path.Combine(AppContext.BaseDirectory, "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        //è·å–fileInfo
        var fileInfo = new FileInfo(filePath);
    
        ContentDispositionHeaderValue contentDispositionHeaderValue = new ContentDispositionHeaderValue("attachment");
        contentDispositionHeaderValue.FileName= fileInfo.Name;
        // è®¾è®¡ContentDispositionå¤´ä¿¡æ¯
        Response.Headers.ContentDisposition = contentDispositionHeaderValue.ToString();
        //è®¾ç½®ContentLengthå¤´ä¿¡æ¯
        Response.ContentLength = new long?(fileInfo.Length);
        //è°ƒç”¨SendFileAsyncæ–¹æ³•
        return Response.SendFileAsync(filePath, 0L, null, default);
    }
    

#### Results.File

ä»ASP.NET Core6.0å¼€å§‹å°±æä¾›äº†MinimalApiå†™æ³•ï¼ŒMinimalApiåŒæ ·å¯ä»¥æ‰§è¡Œæ–‡ä»¶ä¸‹è½½ï¼Œä½¿ç”¨çš„æ˜¯`Results.File`æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚æ— è®ºä½ æ˜¯ä¼ é€’è™šæ‹Ÿè·¯å¾„æˆ–è€…æ˜¯ç‰©ç†è·¯å¾„éƒ½æ˜¯å¯ä»¥çš„ï¼Œä¸ç”¨ä½ å•ç‹¬çš„å»æ“ä½œåˆ«çš„ä»€ä¹ˆäº†ï¼Œæ¯”å¦‚ä»¥ä¸‹ä»£ç 

    //ç›¸å¯¹è·¯å¾„ä¸‹è½½
    app.MapGet("/virtual", () => {
        var virtualPath = "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx";
        return Results.File(virtualPath, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    });
    
    //ç‰©ç†è·¯å¾„ä¸‹è½½
    app.MapGet("/physical", () => {
        var physicalPath = Path.Combine(AppContext.BaseDirectory, "files/ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
        return Results.File(physicalPath, "application/msword", "ç–«æƒ…é˜²æ§è§„èŒƒè¯´æ˜.docx");
    });
    

ä¸Šé¢çš„ä¸¤ç§æ–¹å¼éƒ½æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œçš„ï¼Œè€Œä¸”ä¸ä¼šæŠ¥é”™ï¼Œç›¸å¯¹æ¥è¯´å˜å¾—æ›´é«˜çº§ä¸€ç‚¹äº†ï¼Œé‚£å…·ä½“æ˜¯å¦‚ä½•æ“ä½œçš„å‘¢ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`Results.File`æ–¹æ³•çš„å®ç°\[[ç‚¹å‡»æŸ¥çœ‹æºç ğŸ‘ˆ](https://github.com/dotnet/aspnetcore/blob/v6.0.6/src/Http/Http.Results/src/Results.cs#L318)\]

    public static IResult File(
        string path,
        string? contentType = null,
        string? fileDownloadName = null,
        DateTimeOffset? lastModified = null,
        EntityTagHeaderValue? entityTag = null,
        bool enableRangeProcessing = false)
    {
        //åˆ¤æ–­è·¯å¾„æ˜¯å¦åŒ…å«æ ¹ç›®å½•
        if (Path.IsPathRooted(path))
        {
            // åŒ…å«æ ¹ç›®å½•åˆ™æ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨PhysicalFileResult
            return new PhysicalFileResult(path, contentType)
            {
                FileDownloadName = fileDownloadName,
                LastModified = lastModified,
                EntityTag = entityTag,
                EnableRangeProcessing = enableRangeProcessing,
            };
        }
        else
        {
            // è¡¨ç¤ºè™šæ‹Ÿè·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç¨‹åºæŒ‡å®šçš„è·¯å¾„
            return new VirtualFileResult(path, contentType)
            {
                FileDownloadName = fileDownloadName,
                LastModified = lastModified,
                EntityTag = entityTag,
                EnableRangeProcessing = enableRangeProcessing,
            };
        }
    }
    

é€šè¿‡è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`Results.File`å·²ç»å¸®æˆ‘ä»¬åœ¨å†…éƒ¨è¿›è¡Œäº†åˆ¤æ–­ï¼Œæ˜¯ç¬¦åˆç‰©ç†è·¯å¾„è¿˜æ˜¯è™šæ‹Ÿè·¯å¾„ã€‚å¦‚æœæ˜¯ç‰©ç†è·¯å¾„åˆ™ç›´æ¥è¿”å›`PhysicalFileResult`å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ControllerBaseç±»ä¸­çš„`PhysicalFile`æ–¹æ³•çš„ç±»å‹ã€‚å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„åˆ™è¿”å›`VirtualFileResult`å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ControllerBaseç±»ä¸­çš„`File`æ–¹æ³•ã€‚

### æ€»ç»“

Â Â Â Â æœ¬ç¯‡æ–‡ç« èµ·æºæ˜¯ç”±ç¬”è€…åœ¨å®é™…å¼€å‘é¡¹ç›®ä¸­ï¼Œæ ¹æ®æ–‡ä»¶è·¯å¾„ä¸‹è½½æ–‡ä»¶å‡ºç°å¼‚å¸¸ï¼Œå¹¶æ‰¾åˆ°äº†ç›¸åº”çš„è§£å†³æ–¹æ³•ã€‚å‡ºäºå¥½å¥‡çš„æœ¬å¿ƒï¼Œç ”ç©¶äº†ä¸€ä¸‹ç›¸å…³çš„å®ç°ã€‚åœ¨ASP.NET Coreä¸­æ–‡ä»¶è·¯å¾„åˆ†ä¸ºä¸¤ç±»ã€‚ä¸€ç§æ˜¯ç»å¯¹çš„ç‰©ç†è·¯å¾„ï¼Œä¸€ç§æ˜¯åœ¨ç¨‹åºä¸­è®¾ç½®çš„ç›¸å¯¹è·¯å¾„ï¼Œä¸åŒè·¯å¾„çš„æ–‡ä»¶ä¸‹è½½æœ‰ä¸åŒçš„æ–‡ä»¶å¤„ç†æ–¹æ³•ï¼Œå¤§è‡´æ€»ç»“ä¸€ä¸‹

*   `VirtualFileResult`ç±»å‹çš„æ–‡ä»¶ä¸‹è½½ï¼Œé»˜è®¤è·¯å¾„æ˜¯ç”±`WebRootFileProvider`æä¾›çš„è·¯å¾„ï¼Œå³`wwwroot`æ–‡ä»¶å¤¹çš„è·¯å¾„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™æä¾›çš„æ–‡ä»¶è·¯å¾„æ˜¯ç›¸å¯¹è·¯å¾„ï¼ŒçœŸå®æ–‡ä»¶ä¹Ÿæ˜¯å­˜å‚¨åœ¨`wwwroot`è·¯å¾„ä¸‹çš„ï¼Œä½ å¯ä»¥å¯ä»¥å®šä¹‰è‡ªå·±çš„`IFileProvider`å®ä¾‹æ¥ä¼ é€’è‡ªå·±çš„è·¯å¾„ã€‚
*   `PhysicalFileResult`ç±»å‹çš„æ–‡ä»¶ä¸‹è½½ï¼Œè·¯å¾„åˆ™æ˜¯ç›´æ¥ä¼ é€’è¿›æ¥çš„ç‰©ç†è·¯å¾„ï¼Œæ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç¨‹åºæ‰€åœ¨æœåŠ¡å™¨æˆ–è€…æ“ä½œç³»ç»Ÿçš„çœŸå®è·¯å¾„ã€‚è¿™ä¸ªè·¯å¾„ç¨‹åºä¸ç»è¿‡åŠ å·¥ï¼Œæ˜¯ç¡®å®å­˜åœ¨çš„è·¯å¾„ã€‚
*   MinimalApiçš„`Results.File`æ–¹æ³•ï¼Œä¸éœ€è¦æˆ‘ä»¬è®¤ä¸ºçš„åˆ¤æ–­æ˜¯ç›¸å¯¹è·¯å¾„è¿˜æ˜¯ç»å¯¹è·¯å¾„ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚å› ä¸ºæ–¹æ³•å†…å·²ç»å¸®æˆ‘ä»¬åšäº†åˆ¤æ–­äº†ã€‚
*   æ–‡ä»¶ä¸‹è½½åˆ™æ˜¯è°ƒç”¨äº†`HttpResponse`çš„æ‰©å±•æ–¹æ³•`SendFileAsync`æ–¹æ³•ã€‚

è¿™ä¸€éƒ¨åˆ†é€»è¾‘æ•´ä½“æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œç›¸ä¿¡å¤§å®¶ç†è§£èµ·æ¥ä¹Ÿä¼šæ¯”è¾ƒå®¹æ˜“ã€‚æˆ‘ä»¬å­¦ä¹ çš„è¿‡ç¨‹æœ€æ ¸å¿ƒçš„å°±æ˜¯ç§¯ç´¯ç»éªŒï¼Œä½†æ˜¯ç§¯ç´¯çš„ç»éªŒä¸€å®šæ˜¯ä¸€ç³»åˆ—çš„æŠ½è±¡æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥ç§°å®ƒä¸ºæ€ç»´æ ‡ç­¾ï¼Œè¿™æ˜¯æˆ‘ä»¬å¯ä»¥å¤ç”¨çš„åº•å±‚é€»è¾‘ã€‚å€Ÿç”¨åˆ˜æ¶¦çš„è¯æ¥è¯´ï¼Œåªæœ‰ä¸åŒä¹‹ä¸­çš„ç›¸åŒä¹‹å¤„ã€å˜åŒ–èƒŒåä¸å˜çš„ä¸œè¥¿ï¼Œæ‰æ˜¯åº•å±‚é€»è¾‘ã€‚åªæœ‰åº•å±‚é€»è¾‘ï¼Œæ‰æ˜¯æœ‰ç”Ÿå‘½åŠ›çš„ã€‚åªæœ‰åº•å±‚é€»è¾‘ï¼Œåœ¨æˆ‘ä»¬é¢ä¸´ç¯å¢ƒå˜åŒ–æ—¶ï¼Œæ‰èƒ½è¢«åº”ç”¨åˆ°æ–°çš„å˜åŒ–ä¸­ï¼Œä»è€Œäº§ç”Ÿé€‚åº”æ–°ç¯å¢ƒçš„æ–¹æ³•è®ºã€‚åªæœ‰æŒæ¡äº†åº•å±‚é€»è¾‘ï¼Œåªæœ‰æ¢å¯»åˆ°ä¸‡å˜ä¸­çš„ä¸å˜ï¼Œæ‰èƒ½åŠ¨æ€åœ°ã€æŒç»­åœ°çœ‹æ¸…äº‹ç‰©çš„æœ¬è´¨ã€‚  
  

ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡ ![](https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png)