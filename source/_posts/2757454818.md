---
layout: post
title: "ViewBinding ä¸ Kotlin å§”æ‰˜åŒå‰‘åˆç’§"
date: "2022-09-08T07:32:43.663Z"
---
ViewBinding ä¸ Kotlin å§”æ‰˜åŒå‰‘åˆç’§
===========================

> **è¯·ç‚¹èµå…³æ³¨ï¼Œä½ çš„æ”¯æŒå¯¹æˆ‘æ„ä¹‰é‡å¤§ã€‚**
> 
> ğŸ”¥ **Hiï¼Œæˆ‘æ˜¯å°å½­ã€‚æœ¬æ–‡å·²æ”¶å½•åˆ° [GitHub Â· Android-NoteBook](https://github.com/pengxurui/Android-NoteBook) ä¸­ã€‚è¿™é‡Œæœ‰ Android è¿›é˜¶æˆé•¿çŸ¥è¯†ä½“ç³»ï¼Œæœ‰å¿—åŒé“åˆçš„æœ‹å‹ï¼Œå…³æ³¨å…¬ä¼—å· \[å½­æ—­é”\] å¸¦ä½ å»ºç«‹æ ¸å¿ƒç«äº‰åŠ›ã€‚**

å‰è¨€
==

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å°å½­ã€‚

è¿‡å»ä¸¤å¹´ï¼Œæˆ‘ä»¬åœ¨æ˜é‡‘å¹³å°ä¸Šå‘è¡¨è¿‡ä¸€äº›æ–‡ç« ï¼Œå°å½­ä¹Ÿæ”¶åˆ°äº†å¤§å®¶çš„æ„è§å’Œé¼“åŠ±ã€‚æœ€è¿‘ï¼Œæˆ‘ä¼šé™†ç»­æ¬è¿åˆ°å…¬ä¼—å·ä¸Šã€‚

ViewBinding æ˜¯ Android Gradle Plugin 3.6 ä¸­æ–°å¢çš„ç‰¹æ€§ï¼Œç”¨äºæ›´åŠ è½»é‡åœ°å®ç°è§†å›¾ç»‘å®šï¼ˆå³è§†å›¾ä¸å˜é‡çš„ç»‘å®šï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºè½»é‡ç‰ˆæœ¬çš„ DataBindingã€‚ åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å°†æ€»ç»“ ViewBinding ä½¿ç”¨æ–¹æ³• & åŸç†ï¼Œç¤ºä¾‹ç¨‹åº [AndroidFamilyDemo Â· KotlinDelegate](https://github.com/pengxurui/AndroidFamilyDemo/tree/main/KotlinDelegate) æœ‰ç”¨è¯·è®°å¾—ç»™ Star ï¼Œç»™å°å½­ä¸€ç‚¹åˆ›ä½œçš„åŠ¨åŠ›ã€‚

* * *

å‰ç½®çŸ¥è¯†ï¼š

*   [Kotlin | å§”æ‰˜æœºåˆ¶ & åŸç† & åº”ç”¨](https://juejin.cn/post/6958346113552220173)
*   [Kotlin | æ‰©å±•å‡½æ•°ï¼ˆç»ˆäºçŸ¥é“ä¸ºä»€ä¹ˆ with ç”¨ thisï¼Œlet ç”¨ itï¼‰](https://juejin.cn/post/6935027613542907941)
*   [Java | å…³äºæ³›å‹èƒ½é—®çš„éƒ½åœ¨è¿™é‡Œäº†ï¼ˆå«Kotlinï¼‰](https://juejin.cn/post/6888345234653052941)
*   [Android | Fragment æ ¸å¿ƒåŸç† & é¢è¯•é¢˜ (AndroidX ç‰ˆæœ¬)](https://www.jianshu.com/p/c86b6a77a43f)

* * *

**å­¦ä¹ è·¯çº¿å›¾**

![](https://files.mdnice.com/user/3257/c52dafcb-20a5-4a5a-bc16-a0e7c027fb15.png)

* * *

1\. è®¤è¯† ViewBinding
------------------

### 1.1 ViewBinding ç”¨äºè§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ

ViewBinding æ˜¯ Android Gradle Plugin 3.6 ä¸­æ–°å¢çš„ç‰¹æ€§ï¼Œç”¨äºæ›´åŠ è½»é‡åœ°å®ç°è§†å›¾ç»‘å®šï¼ˆå³è§†å›¾ä¸å˜é‡çš„ç»‘å®šï¼‰ï¼Œå¯ä»¥ç†è§£ä¸ºè½»é‡ç‰ˆæœ¬çš„ DataBindingã€‚

### 1.2 ViewBinding ä¸å…¶ä»–è§†å›¾ç»‘å®šæ–¹æ¡ˆå¯¹æ¯”

åœ¨ ViewBinding ä¹‹å‰ï¼Œä¸šç•Œå·²ç»æœ‰è¿‡å‡ ç§è§†å›¾ç»‘å®šæ–¹æ¡ˆäº†ï¼Œæƒ³å¿…ä½ ä¹Ÿç”¨è¿‡ã€‚é‚£ä¹ˆï¼ŒViewBinding ä½œä¸ºåèµ·ä¹‹ç§€å°±ä¸€å®šæ¯”å‰è€…é¦™å—ï¼Ÿæˆ‘ä»å¤šä¸ªç»´åº¦å¯¹æ¯”å®ƒä»¬çš„åŒºåˆ«ï¼š

è§’åº¦

findViewById

ButterKnife

Kotlin Synthetics

DataBinding

ViewBinding

â“

ç®€æ´æ€§

âœ–

âœ–

âœ”

âœ”

âœ”

â“

ç¼–è¯‘æœŸæ£€æŸ¥

âœ–

âœ–

âœ–

âœ”

âœ”

â“

ç¼–è¯‘é€Ÿåº¦

âœ”

âœ–

âœ”

âœ–

âœ”

â“

æ”¯æŒ Kotlin & Java

âœ”

âœ”

âœ–

âœ”

âœ”

â“

æ”¶æ•›æ¨¡æ¿ä»£ç 

âœ–

âœ–

âœ”

âœ–

âœ–

â“

*   **1ã€ç®€æ´æ€§ï¼š** findViewById å’Œ ButterKnife éœ€è¦åœ¨ä»£ç ä¸­å£°æ˜å¾ˆå¤šå˜é‡ï¼Œå…¶ä»–å‡ ç§æ–¹æ¡ˆä»£ç ç®€æ´è¯»è¾ƒå¥½ï¼›
*   **2ã€ç¼–è¯‘æ£€æŸ¥ï¼š** ç¼–è¯‘æœŸé—´ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹é¢çš„æ£€æŸ¥ï¼šç±»å‹æ£€æŸ¥ + åªèƒ½è®¿é—®å½“å‰å¸ƒå±€ä¸­çš„ idã€‚findViewByIdã€ButterKnife å’Œ Kotlin Synthetics åœ¨è¿™æ–¹é¢è¡¨ç°è¾ƒå·®ï¼›
*   **3ã€ç¼–è¯‘é€Ÿåº¦ï¼š** findViewById çš„ç¼–è¯‘é€Ÿåº¦æ˜¯æœ€å¿«çš„ï¼Œè€Œ ButterKnife å’Œ DataBinding ä¸­å­˜åœ¨æ³¨è§£å¤„ç†ï¼Œç¼–è¯‘é€Ÿåº¦ç•¥é€Šè‰²äº Kotlin Synthetics å’Œ ViewBindingï¼›
*   **4ã€æ”¯æŒ Kotlin & Javaï¼š** Kotlin Synthetics åªæ”¯æŒ Kotlin è¯­è¨€ï¼›
*   **5ã€æ”¶æ•›æ¨¡æ¿ä»£ç ï¼š** åŸºæœ¬ä¸Šæ¯ç§æ–¹æ¡ˆéƒ½å¸¦æœ‰ä¸€å®šé‡çš„æ¨¡æ¿ä»£ç ï¼Œåªæœ‰ Kotlin Synthetics çš„æ¨¡æ¿ä»£ç æ˜¯è¾ƒå°‘çš„ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œå¹¶æ²¡æœ‰ä¸€ç§ç»å¯¹ä¼˜åŠ¿çš„æ–¹æ³•ï¼Œä½†è¶Šå¾€åæ•´ä½“çš„æ•ˆæœæ˜¯æœ‰æå‡çš„ã€‚å¦å¤–ï¼Œâ“æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

### 1.3 **ViewBinding çš„å®ç°åŸç†**

AGP æ’ä»¶ä¼šä¸ºæ¯ä¸ª XML å¸ƒå±€æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç»‘å®šç±»æ–‡ä»¶ `xxxBinding` ï¼Œç»‘å®šç±»ä¸­ä¼šæŒæœ‰å¸ƒå±€æ–‡ä»¶ä¸­æ‰€æœ‰å¸¦ `android:id` å±æ€§çš„ View å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œæœ‰å¸ƒå±€æ–‡ä»¶ä¸º `fragment_test.xml` ï¼Œåˆ™æ’ä»¶ä¼šç”Ÿæˆç»‘å®šç±» `FragmentTestBinding.java` ã€‚

é‚£ä¹ˆï¼Œæ‰€æœ‰ XML å¸ƒå±€æ–‡ä»¶éƒ½ç”Ÿæˆ Java ç±»ï¼Œä¼šä¸ä¼šå¯¼è‡´åŒ…ä½“ç§¯ç¬é—´å¢å¤§ï¼Ÿä¸ä¼šçš„ï¼Œ æœªä½¿ç”¨çš„ç±»ä¼šåœ¨æ··æ·†æ—¶è¢«å‹ç¼©ã€‚

* * *

2\. ViewBinding çš„åŸºæœ¬ç”¨æ³•
---------------------

è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥ä»‹ç» ViewBinding çš„ä½¿ç”¨æ–¹æ³•ï¼Œå†…å®¹ä¸å¤šã€‚

> **æç¤ºï¼š** ViewBinding è¦æ±‚åœ¨ Android Gradle Plugin ç‰ˆæœ¬åœ¨è‡³å°‘åœ¨ 3.6 ä»¥ä¸Šã€‚

### 2.1 æ·»åŠ é…ç½®

è§†å›¾ç»‘å®šåŠŸèƒ½æŒ‰æ¨¡å—çº§åˆ«å¯ç”¨ï¼Œå¯ç”¨çš„æ¨¡å—éœ€è¦åœ¨æ¨¡å—çº§ build.gralde ä¸­æ·»åŠ é…ç½®ã€‚ä¾‹å¦‚ï¼š

`build.gradle`

    android {
        ...
        viewBinding {
            enabled = true
        }
    }
    
    

å¯¹äºä¸éœ€è¦ç”Ÿæˆç»‘å®šç±»çš„å¸ƒå±€æ–‡ä»¶ï¼Œå¯ä»¥åœ¨æ ¹èŠ‚ç‚¹å£°æ˜ `tools:viewBindingIgnore="true"` ã€‚ä¾‹å¦‚ï¼š

    <LinearLayout
        ...
        tools:viewBindingIgnore="true" >
        ...
    </LinearLayout>
    
    

### 2.2 è§†å›¾ç»‘å®š

ç»‘å®šç±»ä¸­æä¾›äº† 3 ä¸ªè§†å›¾ç»‘å®š APIï¼š

    // ç»‘å®šåˆ°è§†å›¾ view ä¸Š
    fun <T> bind(view : View) : T
    
    // ä½¿ç”¨ inflater è§£æå¸ƒå±€ï¼Œå†ç»‘å®šåˆ° View ä¸Š
    fun <T> inflate(inflater : LayoutInflater) : T
    
    // ä½¿ç”¨ inflater è§£æå¸ƒå±€ï¼Œå†ç»‘å®šåˆ° View ä¸Š
    fun <T> inflate(inflater : LayoutInflater, parent : ViewGroup?, attachToParent : Boolean) : T
    

*   **1ã€åœ¨ Activity ä¸­ä½¿ç”¨**

`MainActivity.kt`

    class TestActivity: AppCompatActivity(R.layout.activity_test) {
    
        private lateinit var binding: ActivityTestBinding
    
        override fun onCreate(savedInstanceState: Bundle?) {
            super.onCreate(savedInstanceState)
    
            binding = ActivityTestBinding.inflate(layoutInflater)
            setContentView(binding.root)
            binding.tvDisplay.text = "Hello World."
        }
    }
    

*   **2ã€åœ¨ Fragment ä¸­ä½¿ç”¨**

`TestFragment.kt`

    class TestFragment : Fragment(R.layout.fragment_test) {
    
        private var _binding: FragmentTestBinding? = null
        private val binding get() = _binding!!
    
        override fun onViewCreated(root: View, savedInstanceState: Bundle?) {
            _binding = FragmentTestBinding.bind(root)
    
            binding.tvDisplay.text = "Hello World."
        }
    
        override fun onDestroyView() {
            super.onDestroyView()
    
            // ç½®ç©º
            _binding = null
        }
    }
    

### 2.3 é¿å…å†…å­˜æ³„éœ²

è¿™é‡Œæœ‰ä¸€ä¸ªéšè—çš„å†…å­˜æ³„éœ²é—®é¢˜ï¼Œä½ éœ€è¦ç†è§£æ¸…æ¥šï¼ˆä¸¥æ ¼æ¥è¯´è¿™å¹¶ä¸æ˜¯ ViewBinding çš„é—®é¢˜ï¼Œå³ä½¿ä½ é‡‡ç”¨å…¶å®ƒè§†å›¾ç»‘å®šæ–¹æ¡ˆä¹Ÿè¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼‰ã€‚

**é—®é¢˜ï¼šä¸ºä»€ä¹ˆ Fragment#onDestroyView() é‡Œéœ€è¦ç½®ç©ºç»‘å®šç±»å¯¹è±¡ï¼Œè€Œ Activity é‡Œä¸éœ€è¦ï¼Ÿ**  
ç­”ï¼šActivity å®ä¾‹å’Œ Activity è§†å›¾çš„ç”Ÿå‘½å‘¨æœŸæ˜¯åŒæ­¥çš„ï¼Œè€Œ Fragment å®ä¾‹å’Œ Fragment è§†å›¾çš„ç”Ÿå‘½å‘¨æœŸå¹¶ä¸æ˜¯å®Œå…¨åŒæ­¥çš„ï¼Œå› æ­¤éœ€è¦åœ¨ Fragment è§†å›¾é”€æ¯æ—¶ï¼Œæ‰‹åŠ¨å›æ”¶ç»‘å®šç±»å¯¹è±¡ï¼Œå¦åˆ™é€ æˆå†…å­˜æ³„éœ²ã€‚ä¾‹å¦‚ï¼šdetach Fragmentï¼Œæˆ–è€… remove Fragment å¹¶ä¸”äº‹åŠ¡è¿›å…¥è¿”å›æ ˆï¼Œæ­¤æ—¶ Fragment è§†å›¾é”€æ¯ä½† Fragment å®ä¾‹å­˜åœ¨ã€‚å…³äº Fragment ç”Ÿå‘½å‘¨æœŸå’Œäº‹åŠ¡åœ¨æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« é‡Œè®¨è®ºè¿‡ï¼šAndroid | Fragment æ ¸å¿ƒåŸç† & é¢è¯•é¢˜ (AndroidX ç‰ˆæœ¬)

æ€»ä¹‹ï¼Œåœ¨è§†å›¾é”€æ¯ä½†æ˜¯æ§åˆ¶ç±»å¯¹è±¡å®ä¾‹è¿˜å­˜æ´»çš„æ—¶æœºï¼Œä½ å°±éœ€è¦æ‰‹åŠ¨å›æ”¶ç»‘å®šç±»å¯¹è±¡ï¼Œå¦åˆ™é€ æˆå†…å­˜æ³„éœ²ã€‚

### 2.4 ViewBinding ç»‘å®šç±»æºç 

åç¼–è¯‘å¦‚ä¸‹ï¼š

`ActivityTestBinding.java`

    public final class ActivityTestBinding implements ViewBinding {
        private final ConstraintLayout rootView;
        public final TextView tvDisplay;
    
        private ActivityTestBinding (ConstraintLayout paramConstraintLayout1, TextView paramTextView)
            this.rootView = paramConstraintLayout1;
            this.tvDisplay = paramTextView;
        }
    
        public static ActivityTestBinding bind(View paramView) {
            TextView localTextView = (TextView)paramView.findViewById(2131165363);
            if (localTextView != null) {
                return new ActivityMainBinding((ConstraintLayout)paramView, localTextView);
            }else {
              paramView = "tvDisplay";
            }
            throw new NullPointerException("Missing required view with ID: ".concat(paramView));
        }
    
        public static ActivityMainBinding inflate(LayoutInflater paramLayoutInflater) {
            return inflate(paramLayoutInflater, null, false);
        }
    
        public static ActivityMainBinding inflate(LayoutInflater paramLayoutInflater, ViewGroup paramViewGroup, boolean paramBoolean) {
            paramLayoutInflater = paramLayoutInflater.inflate(2131361821, paramViewGroup, false);
            if (paramBoolean) {
                paramViewGroup.addView(paramLayoutInflater);
            }
            return bind(paramLayoutInflater);
        }
    
        public ConstraintLayout getRoot() {
            return this.rootView;
        }
    }
    

* * *

3\. ViewBinding ä¸ Kotlin å§”æ‰˜åŒå‰‘åˆç’§
-------------------------------

åˆ°è¿™é‡Œï¼ŒViewBinding çš„ä½¿ç”¨æ•™ç¨‹å·²ç»è¯´å®Œäº†ã€‚ä½†æ˜¯å›è¿‡å¤´çœ‹ï¼Œæœ‰æ²¡æœ‰å‘ç°ä¸€äº›å±€é™æ€§å‘¢ï¼Ÿ

*   **1ã€åˆ›å»ºå’Œå›æ”¶ ViewBinding å¯¹è±¡éœ€è¦é‡å¤ç¼–å†™æ ·æ¿ä»£ç ï¼Œç‰¹åˆ«æ˜¯åœ¨ Fragment ä¸­ä½¿ç”¨çš„æ¡ˆä¾‹ï¼›**
*   **2ã€binding å±æ€§æ˜¯å¯ç©ºçš„ï¼Œä¹Ÿæ˜¯å¯å˜çš„ï¼Œä½¿ç”¨èµ·æ¥ä¸æ–¹ä¾¿ã€‚**

é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰å¯ä¼˜åŒ–çš„æ–¹æ¡ˆå‘¢ï¼Ÿæˆ‘ä»¬æƒ³èµ·äº† Kotlin å±æ€§å§”æ‰˜ï¼Œå…³äº Kotlin å§”æ‰˜æœºåˆ¶åœ¨æˆ‘ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« é‡Œè®¨è®ºè¿‡ï¼š[Kotlin | å§”æ‰˜æœºåˆ¶ & åŸç†](https://juejin.cn/post/6958346113552220173)ã€‚å¦‚æœä½ è¿˜ä¸å¤ªäº†è§£ Kotlin å§”æ‰˜ï¼Œä¸‹é¢çš„å†…å®¹å¯¹ä½ ä¼šæœ‰äº›éš¾åº¦ã€‚ä¸‹é¢ï¼Œæˆ‘å°†å¸¦ä½ ä¸€æ­¥æ­¥å°è£… ViewBinding å±æ€§å§”æ‰˜å·¥å…·ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬æ¢³ç†ä¸€ä¸‹æˆ‘ä»¬è¦å§”æ‰˜çš„å†…å®¹ä¸éœ€æ±‚ï¼Œä»¥åŠç›¸åº”çš„è§£å†³åŠæ³•ï¼š

éœ€æ±‚

è§£å†³åŠæ³•

éœ€è¦å§”æ‰˜ ViewBinding#bind() çš„è°ƒç”¨

åå°„

éœ€è¦å§”æ‰˜ binding = null çš„è°ƒç”¨

ç›‘å¬ Fragment è§†å›¾ç”Ÿå‘½å‘¨æœŸ

æœŸæœ› binding å±æ€§å£°æ˜ä¸ºéç©ºä¸å¯å˜å˜é‡

ReadOnlyProperty<F, V>

### 3.1 ViewBinding + Kotlin å§”æ‰˜ 1.0

æˆ‘ä»¬ç°åœ¨è¾ƒå¤æ‚çš„ Fragment ä¸­å°è¯•ä½¿ç”¨ Kotlin å§”æ‰˜ä¼˜åŒ–ï¼š

`FragmentViewBindingPropertyV1.kt`

    private const val TAG = "ViewBindingProperty"
    
    public inline fun <reified V : ViewBinding> viewBindingV1() = viewBindingV1(V::class.java)
    
    public inline fun <reified T : ViewBinding> viewBindingV1(clazz: Class<T>): FragmentViewBindingPropertyV1<Fragment, T> {
        val bindMethod = clazz.getMethod("bind", View::class.java)
        return FragmentViewBindingPropertyV1 {
            bindMethod(null, it.requireView()) as T
        }
    }
    
    /**
     * @param viewBinder åˆ›å»ºç»‘å®šç±»å¯¹è±¡
     */
    class FragmentViewBindingPropertyV1<in F : Fragment, out V : ViewBinding>(
        private val viewBinder: (F) -> V
    ) : ReadOnlyProperty<F, V> {
    
        private var viewBinding: V? = null
    
        @MainThread
        override fun getValue(thisRef: F, property: KProperty<*>): V {
            // å·²ç»ç»‘å®šï¼Œç›´æ¥è¿”å›
            viewBinding?.let { return it }
    
            // Use viewLifecycleOwner.lifecycle other than lifecycle
            val lifecycle = thisRef.viewLifecycleOwner.lifecycle
            val viewBinding = viewBinder(thisRef)
            if (lifecycle.currentState == Lifecycle.State.DESTROYED) {
                Log.w(
                    TAG, "Access to viewBinding after Lifecycle is destroyed or hasn't created yet. " +
                            "The instance of viewBinding will be not cached."
                )
                // We can access to ViewBinding after Fragment.onDestroyView(), but don't save it to prevent memory leak
            } else {
                lifecycle.addObserver(ClearOnDestroyLifecycleObserver())
                this.viewBinding = viewBinding
            }
            return viewBinding
        }
    
        @MainThread
        fun clear() {
            viewBinding = null
        }
    
        private inner class ClearOnDestroyLifecycleObserver : LifecycleObserver {
    
            private val mainHandler = Handler(Looper.getMainLooper())
    
            @MainThread
            @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)
            fun onDestroy(owner: LifecycleOwner) {
                owner.lifecycle.removeObserver(this)
                mainHandler.post { clear() }
            }
        }
    }
    

ä½¿ç”¨ç¤ºä¾‹ï¼š

    class TestFragment : Fragment(R.layout.fragment_test) {
    
        private val binding : FragmentTestBinding by viewBindingV1()
    
        override fun onViewCreated(root: View, savedInstanceState: Bundle?) {
            binding.tvDisplay.text = "Hello World."
        }
    }
    

å¹²å‡€æ¸…çˆ½ï¼å‰é¢æå‡ºçš„ä¸‰ä¸ªéœ€æ±‚ä¹Ÿéƒ½å®ç°äº†ï¼Œç°åœ¨æˆ‘ä¸ºä½ è§£ç­”ç»†èŠ‚ï¼š

*   **é—®é¢˜ 1ã€ä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ V::class.javaï¼Œä¸æ˜¯æ³›å‹æ“¦é™¤äº†å—ï¼Ÿ** åˆ©ç”¨äº† Kotlin å†…æ•›å‡½æ•° + å®åŒ–ç±»å‹å‚æ•°ï¼Œç¼–è¯‘åå‡½æ•°ä½“æ•´ä½“è¢«å¤åˆ¶åˆ°è°ƒç”¨å¤„ï¼ŒV::class.java å…¶å®æ˜¯ FragmentTestBinding::class.javaã€‚å…·ä½“åˆ†æè§ï¼š[Java | å…³äºæ³›å‹èƒ½é—®çš„éƒ½åœ¨è¿™é‡Œäº†ï¼ˆå«Kotlinï¼‰](https://juejin.cn/post/6888345234653052941)
*   **é—®é¢˜ 2ã€ReadOnlyProperty<F, V> æ˜¯ä»€ä¹ˆï¼Ÿ** ReadOnlyProperty æ˜¯ä¸å¯å˜å±æ€§ä»£ç†ï¼Œé€šè¿‡ getValue(...) æ–¹æ³•å®ç°å§”æ‰˜è¡Œä¸ºã€‚ç¬¬ä¸€ä¸ªç±»å‹å‚æ•° F æ˜¯å±æ€§æ‰€æœ‰è€…ï¼Œç¬¬äºŒä¸ªå‚æ•° V æ˜¯å±æ€§ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ Fragment ä¸­å®šä¹‰å±æ€§ï¼Œå±æ€§ç±»å‹ä¸º ViewBindingï¼Œæ‰€è°“å®šä¹‰ç±»å‹å‚æ•°ä¸º <in F : Fragment, out V : ViewBinding>ï¼›
*   **é—®é¢˜ 3ã€è§£é‡Šä¸‹ getValue(...) æ–¹æ³•ï¼Ÿ** ç›´æ¥çœ‹æ³¨é‡Šï¼š

`FragmentViewBindingPropertyV1.kt`

    @MainThread
    override fun getValue(thisRef: F, property: KProperty<*>): V {
        // 1ã€viewBinding ä¸ä¸ºç©ºè¯´æ˜å·²ç»ç»‘å®šï¼Œç›´æ¥è¿”å›
        viewBinding?.let { return it }
    
        // 2ã€Fragment è§†å›¾çš„ç”Ÿå‘½å‘¨æœŸ
        val lifecycle = thisRef.viewLifecycleOwner.lifecycle
    
        // 3ã€å®ä¾‹åŒ–ç»‘å®šç±»å¯¹è±¡
        val viewBinding = viewBinder(thisRef)
    
        if (lifecycle.currentState == Lifecycle.State.DESTROYED) {
            // 4.1 å¦‚æœè§†å›¾ç”Ÿå‘½å‘¨æœŸä¸º DESTROYEDï¼Œè¯´æ˜è§†å›¾è¢«é”€æ¯ï¼Œæ­¤æ—¶ä¸ç¼“å­˜ç»‘å®šç±»å¯¹è±¡ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
        } else {
            // 4.2 å®šä¹‰è§†å›¾ç”Ÿå‘½å‘¨æœŸç›‘å¬è€…
            lifecycle.addObserver(ClearOnDestroyLifecycleObserver())
            // 4.3 ç¼“å­˜ç»‘å®šç±»å¯¹è±¡
            this.viewBinding = viewBinding
        }
        return viewBinding
    }
    

*   **é—®é¢˜ 4ã€ä¸ºä»€ä¹ˆ onDestroy() è¦é‡‡ç”¨ Handler#post(Message) å®Œæˆï¼Ÿ** å› ä¸º Fragment#viewLifecycleOwner é€šçŸ¥ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ ON\_DESTROY çš„æ—¶æœºåœ¨ Fragment#onDestroyView ä¹‹å‰ã€‚å¦‚æœä¸ä½¿ç”¨ post çš„æ–¹å¼ï¼Œé‚£ä¹ˆä¸šåŠ¡æ–¹è¦æ˜¯åœ¨ onDestroyView ä¸­è®¿é—®äº† bindingï¼Œåˆ™ä¼šäºŒæ¬¡æ‰§è¡Œ getValue() è¿™æ˜¯ä¸å¿…è¦çš„ã€‚

### 3.2 ViewBinding + Kotlin å§”æ‰˜ 2.0

V1.0 ç‰ˆæœ¬ä½¿ç”¨äº†åå°„ï¼ŒçœŸçš„ä¸€å®šè¦åå°„å—ï¼Ÿåå°„è°ƒç”¨ bind å‡½æ•°çš„ç›®çš„å°±æ˜¯è·å¾—ä¸€ä¸ª ViewBinding ç»‘å®šç±»å¯¹è±¡ï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥è¯•è¯•æŠŠåˆ›å»ºå¯¹è±¡çš„è¡Œä¸ºäº¤ç»™å¤–éƒ¨å»å®šä¹‰ï¼Œç±»ä¼¼è¿™æ ·ç”¨ä¸€ä¸ª lambda è¡¨è¾¾å¼å®ç°å·¥å‚å‡½æ•°ï¼š

`FragmentViewBindingPropertyV2.kt`

    inline fun <F : Fragment, V : ViewBinding> viewBindingV2(
        crossinline viewBinder: (View) -> V,
        // ç±»ä¼¼äºåˆ›å»ºå·¥å‚
        crossinline viewProvider: (F) -> View = Fragment::requireView
    ) = FragmentViewBindingPropertyV2 { fragment: F ->
        viewBinder(viewProvider(fragment))
    }
    
    class FragmentViewBindingPropertyV2<in F : Fragment, out V : ViewBinding>(
        private val viewBinder: (F) -> V
    ) : ReadOnlyProperty<F, V> {
        // ä»¥ä¸‹æºç ç›¸åŒ ...
    }
    

ä½¿ç”¨ç¤ºä¾‹ï¼š

    class TestFragment : Fragment(R.layout.fragment_test) {
    
        private val binding by viewBindingV2(FragmentTestBinding::bind)
    
        override fun onViewCreated(root: View, savedInstanceState: Bundle?) {
            binding.tvDisplay.text = "Hello World."
        }
    }
    

å¹²å‡€æ¸…çˆ½ï¼ä¸ä½¿ç”¨åå°„ä¹Ÿå¯ä»¥å®ç°ï¼Œç°åœ¨æˆ‘ä¸ºä½ è§£ç­”ç»†èŠ‚ï¼š

*   **é—®é¢˜ 5ã€(View) -> V æ˜¯ä»€ä¹ˆï¼Ÿ** Kotlin é«˜é˜¶å‡½æ•°ï¼Œå¯ä»¥æŠŠ lambda è¡¨è¾¾å¼ç›´æ¥ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå…¶ä¸­ View æ˜¯å‡½æ•°å‚æ•°ï¼Œè€Œ T æ˜¯å‡½æ•°è¿”å›å€¼ã€‚lambda è¡¨è¾¾å¼æœ¬è´¨ä¸Šæ˜¯ ã€Œå¯ä»¥ä½œä¸ºå€¼ä¼ é€’çš„ä»£ç å—ã€ã€‚åœ¨è€ç‰ˆæœ¬ Java ä¸­ï¼Œä¼ é€’ä»£ç å—éœ€è¦ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»å®ç°ï¼Œè€Œä½¿ç”¨ lambda è¡¨è¾¾å¼ç”šè‡³è¿å‡½æ•°å£°æ˜éƒ½ä¸éœ€è¦ï¼Œå¯ä»¥ç›´æ¥ä¼ é€’ä»£ç å—ä½œä¸ºå‡½æ•°å€¼ï¼›
*   **é—®é¢˜ 6ã€Fragment::requireView æ˜¯ä»€ä¹ˆï¼Ÿ** æŠŠå‡½æ•° requireView() ä½œä¸ºå‚æ•°ä¼ é€’ã€‚Fragment#requireView() ä¼šè¿”å› Fragment çš„æ ¹èŠ‚ç‚¹ï¼Œä½†è¦æ³¨æ„åœ¨ onCreateView() ä¹‹å‰è°ƒç”¨ requireView() ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›
*   **é—®é¢˜ 7ã€FragmentTestBinding::bind æ˜¯ä»€ä¹ˆï¼Ÿ** æŠŠå‡½æ•° bind() ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œbind å‡½æ•°çš„å‚æ•°ä¸º Viewï¼Œè¿”å›å€¼ä¸º ViewBindingï¼Œä¸å‡½æ•°å£°æ˜ (View) -> V åŒ¹é…ã€‚

### 3.3 ViewBinding + Kotlin å§”æ‰˜æœ€ç»ˆç‰ˆ

V2.0 ç‰ˆæœ¬å·²ç»å®Œæˆäº†é’ˆå¯¹ Fragment çš„å±æ€§ä»£ç†ï¼Œä½†æ˜¯å®é™…åœºæ™¯ä¸­åªä¼šåœ¨ Fragment ä¸­ä½¿ç”¨ ViewBinding å—ï¼Ÿæ˜¾ç„¶å¹¶ä¸æ˜¯ï¼Œæˆ‘ä»¬è¿˜æœ‰å…¶ä»–ä¸€äº›åœºæ™¯ï¼š

*   Activity
*   Fragment
*   DialogFragment
*   ViewGroup
*   RecyclerView.ViewHolder

æ‰€ä»¥ï¼Œæˆ‘ä»¬æœ‰å¿…è¦å°†å§”æ‰˜å·¥å…·é€‚å½“å°è£…å¾—æ›´é€šç”¨äº›ï¼Œå®Œæ•´ä»£ç å’Œæ¼”ç¤ºå·¥ç¨‹ä½ å¯ä»¥ç›´æ¥ä¸‹è½½æŸ¥çœ‹ï¼š [AndroidFamilyDemo Â· KotlinDelegate](https://github.com/pengxurui/AndroidFamilyDemo/tree/main/KotlinDelegate)

`ViewBindingProperty.kt`

    // -------------------------------------------------------
    // ViewBindingProperty for Activity
    // -------------------------------------------------------
    
    @JvmName("viewBindingActivity")
    inline fun <V : ViewBinding> ComponentActivity.viewBinding(
        crossinline viewBinder: (View) -> V,
        crossinline viewProvider: (ComponentActivity) -> View = ::findRootView
    ): ViewBindingProperty<ComponentActivity, V> = ActivityViewBindingProperty { activity: ComponentActivity ->
        viewBinder(viewProvider(activity))
    }
    
    @JvmName("viewBindingActivity")
    inline fun <V : ViewBinding> ComponentActivity.viewBinding(
        crossinline viewBinder: (View) -> V,
        @IdRes viewBindingRootId: Int
    ): ViewBindingProperty<ComponentActivity, V> = ActivityViewBindingProperty { activity: ComponentActivity ->
        viewBinder(activity.requireViewByIdCompat(viewBindingRootId))
    }
    
    // -------------------------------------------------------
    // ViewBindingProperty for Fragment / DialogFragment
    // -------------------------------------------------------
    
    @Suppress("UNCHECKED_CAST")
    @JvmName("viewBindingFragment")
    inline fun <F : Fragment, V : ViewBinding> Fragment.viewBinding(
        crossinline viewBinder: (View) -> V,
        crossinline viewProvider: (F) -> View = Fragment::requireView
    ): ViewBindingProperty<F, V> = when (this) {
        is DialogFragment -> DialogFragmentViewBindingProperty { fragment: F ->
            viewBinder(viewProvider(fragment))
        } as ViewBindingProperty<F, V>
        else -> FragmentViewBindingProperty { fragment: F ->
            viewBinder(viewProvider(fragment))
        }
    }
    
    @Suppress("UNCHECKED_CAST")
    @JvmName("viewBindingFragment")
    inline fun <F : Fragment, V : ViewBinding> Fragment.viewBinding(
        crossinline viewBinder: (View) -> V,
        @IdRes viewBindingRootId: Int
    ): ViewBindingProperty<F, V> = when (this) {
        is DialogFragment -> viewBinding(viewBinder) { fragment: DialogFragment ->
            fragment.getRootView(viewBindingRootId)
        } as ViewBindingProperty<F, V>
        else -> viewBinding(viewBinder) { fragment: F ->
            fragment.requireView().requireViewByIdCompat(viewBindingRootId)
        }
    }
    
    // -------------------------------------------------------
    // ViewBindingProperty for ViewGroup
    // -------------------------------------------------------
    
    @JvmName("viewBindingViewGroup")
    inline fun <V : ViewBinding> ViewGroup.viewBinding(
        crossinline viewBinder: (View) -> V,
        crossinline viewProvider: (ViewGroup) -> View = { this }
    ): ViewBindingProperty<ViewGroup, V> = LazyViewBindingProperty { viewGroup: ViewGroup ->
        viewBinder(viewProvider(viewGroup))
    }
    
    @JvmName("viewBindingViewGroup")
    inline fun <V : ViewBinding> ViewGroup.viewBinding(
        crossinline viewBinder: (View) -> V,
        @IdRes viewBindingRootId: Int
    ): ViewBindingProperty<ViewGroup, V> = LazyViewBindingProperty { viewGroup: ViewGroup ->
        viewBinder(viewGroup.requireViewByIdCompat(viewBindingRootId))
    }
    
    // -------------------------------------------------------
    // ViewBindingProperty for RecyclerView#ViewHolder
    // -------------------------------------------------------
    
    @JvmName("viewBindingViewHolder")
    inline fun <V : ViewBinding> RecyclerView.ViewHolder.viewBinding(
        crossinline viewBinder: (View) -> V,
        crossinline viewProvider: (RecyclerView.ViewHolder) -> View = RecyclerView.ViewHolder::itemView
    ): ViewBindingProperty<RecyclerView.ViewHolder, V> = LazyViewBindingProperty { holder: RecyclerView.ViewHolder ->
        viewBinder(viewProvider(holder))
    }
    
    @JvmName("viewBindingViewHolder")
    inline fun <V : ViewBinding> RecyclerView.ViewHolder.viewBinding(
        crossinline viewBinder: (View) -> V,
        @IdRes viewBindingRootId: Int
    ): ViewBindingProperty<RecyclerView.ViewHolder, V> = LazyViewBindingProperty { holder: RecyclerView.ViewHolder ->
        viewBinder(holder.itemView.requireViewByIdCompat(viewBindingRootId))
    }
    
    // -------------------------------------------------------
    // ViewBindingProperty
    // -------------------------------------------------------
    
    private const val TAG = "ViewBindingProperty"
    
    interface ViewBindingProperty<in R : Any, out V : ViewBinding> : ReadOnlyProperty<R, V> {
        @MainThread
        fun clear()
    }
    
    class LazyViewBindingProperty<in R : Any, out V : ViewBinding>(
        private val viewBinder: (R) -> V
    ) : ViewBindingProperty<R, V> {
    
        private var viewBinding: V? = null
    
        @Suppress("UNCHECKED_CAST")
        @MainThread
        override fun getValue(thisRef: R, property: KProperty<*>): V {
            // Already bound
            viewBinding?.let { return it }
    
            return viewBinder(thisRef).also {
                this.viewBinding = it
            }
        }
    
        @MainThread
        override fun clear() {
            viewBinding = null
        }
    }
    
    abstract class LifecycleViewBindingProperty<in R : Any, out V : ViewBinding>(
        private val viewBinder: (R) -> V
    ) : ViewBindingProperty<R, V> {
    
        private var viewBinding: V? = null
    
        protected abstract fun getLifecycleOwner(thisRef: R): LifecycleOwner
    
        @MainThread
        override fun getValue(thisRef: R, property: KProperty<*>): V {
            // Already bound
            viewBinding?.let { return it }
    
            val lifecycle = getLifecycleOwner(thisRef).lifecycle
            val viewBinding = viewBinder(thisRef)
            if (lifecycle.currentState == Lifecycle.State.DESTROYED) {
                Log.w(
                    TAG, "Access to viewBinding after Lifecycle is destroyed or hasn't created yet. " +
                            "The instance of viewBinding will be not cached."
                )
                // We can access to ViewBinding after Fragment.onDestroyView(), but don't save it to prevent memory leak
            } else {
                lifecycle.addObserver(ClearOnDestroyLifecycleObserver(this))
                this.viewBinding = viewBinding
            }
            return viewBinding
        }
    
        @MainThread
        override fun clear() {
            viewBinding = null
        }
    
        private class ClearOnDestroyLifecycleObserver(
            private val property: LifecycleViewBindingProperty<*, *>
        ) : LifecycleObserver {
    
            private companion object {
                private val mainHandler = Handler(Looper.getMainLooper())
            }
    
            @MainThread
            @OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)
            fun onDestroy(owner: LifecycleOwner) {
                mainHandler.post { property.clear() }
            }
        }
    }
    
    class FragmentViewBindingProperty<in F : Fragment, out V : ViewBinding>(
        viewBinder: (F) -> V
    ) : LifecycleViewBindingProperty<F, V>(viewBinder) {
    
        override fun getLifecycleOwner(thisRef: F): LifecycleOwner {
            try {
                return thisRef.viewLifecycleOwner
            } catch (ignored: IllegalStateException) {
                error("Fragment doesn't have view associated with it or the view has been destroyed")
            }
        }
    }
    
    class DialogFragmentViewBindingProperty<in F : DialogFragment, out V : ViewBinding>(
        viewBinder: (F) -> V
    ) : LifecycleViewBindingProperty<F, V>(viewBinder) {
    
        override fun getLifecycleOwner(thisRef: F): LifecycleOwner {
            return if (thisRef.showsDialog) {
                thisRef
            } else {
                try {
                    thisRef.viewLifecycleOwner
                } catch (ignored: IllegalStateException) {
                    error("Fragment doesn't have view associated with it or the view has been destroyed")
                }
            }
        }
    }
    
    // -------------------------------------------------------
    // Utils
    // -------------------------------------------------------
    
    @RestrictTo(RestrictTo.Scope.LIBRARY)
    class ActivityViewBindingProperty<in A : ComponentActivity, out V : ViewBinding>(
        viewBinder: (A) -> V
    ) : LifecycleViewBindingProperty<A, V>(viewBinder) {
    
        override fun getLifecycleOwner(thisRef: A): LifecycleOwner {
            return thisRef
        }
    }
    
    fun <V : View> View.requireViewByIdCompat(@IdRes id: Int): V {
        return ViewCompat.requireViewById(this, id)
    }
    
    fun <V : View> Activity.requireViewByIdCompat(@IdRes id: Int): V {
        return ActivityCompat.requireViewById(this, id)
    }
    
    /**
     * Utility to find root view for ViewBinding in Activity
     */
    fun findRootView(activity: Activity): View {
        val contentView = activity.findViewById<ViewGroup>(android.R.id.content)
        checkNotNull(contentView) { "Activity has no content view" }
        return when (contentView.childCount) {
            1 -> contentView.getChildAt(0)
            0 -> error("Content view has no children. Provide root view explicitly")
            else -> error("More than one child view found in Activity content view")
        }
    }
    
    fun DialogFragment.getRootView(viewBindingRootId: Int): View {
        val dialog = checkNotNull(dialog) {
            "DialogFragment doesn't have dialog. Use viewBinding delegate after onCreateDialog"
        }
        val window = checkNotNull(dialog.window) { "Fragment's Dialog has no window" }
        return with(window.decorView) {
            if (viewBindingRootId != 0) requireViewByIdCompat(
                viewBindingRootId
            ) else this
        }
    }
    

* * *

4\. æ€»ç»“
------

ViewBinding æ˜¯ä¸€ä¸ªè½»é‡çº§çš„è§†å›¾ç»‘å®šæ–¹æ¡ˆï¼ŒAndroid Gradle æ’ä»¶ä¼šä¸ºæ¯ä¸ª XML å¸ƒå±€æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç»‘å®šç±»ã€‚åœ¨ Fragment ä¸­ä½¿ç”¨ ViewBinding éœ€è¦æ³¨æ„åœ¨ Fragment#onDestroyView() é‡Œç½®ç©ºç»‘å®šç±»å¯¹è±¡é¿å…å†…å­˜æ³„æ¼ã€‚ä½†è¿™ä¼šå¸¦æ¥å¾ˆå¤šé‡å¤ç¼–å†™æ ·æ¿ä»£ç ï¼Œä½¿ç”¨å±æ€§å§”æ‰˜å¯ä»¥æ”¶æ•›æ¨¡æ¿ä»£ç ï¼Œä¿è¯è°ƒç”¨æ–¹ä»£ç å¹²å‡€æ¸…çˆ½ã€‚

è§’åº¦

findViewById

ButterKnife

Kotlin Synthetics

DataBinding

ViewBinding

ViewBindingProperty

ç®€æ´æ€§

âœ–

âœ–

âœ”

âœ”

âœ”

âœ”

ç¼–è¯‘æœŸæ£€æŸ¥

âœ–

âœ–

âœ–

âœ”

âœ”

âœ”

ç¼–è¯‘é€Ÿåº¦

âœ”

âœ–

âœ”

âœ–

âœ”

âœ”

æ”¯æŒ Kotlin & Java

âœ”

âœ”

âœ–

âœ”

âœ”

âœ”

æ”¶æ•›æ¨¡æ¿ä»£ç 

âœ–

âœ–

âœ”

âœ–

âœ–

âœ”

* * *

### å‚è€ƒèµ„æ–™

*   [View Binding è§†å›¾ç»‘å®š](https://developer.android.google.cn/topic/libraries/view-binding) â€”â€” å®˜æ–¹æ–‡æ¡£
*   [View Binding ä¸ Kotlin å§”æ‰˜å±æ€§çš„å·§å¦™ç»“åˆï¼Œå‘Šåˆ«åƒåœ¾ä»£ç ï¼](https://juejin.cn/post/6844904157808164878) â€”â€” Kirill Rozov è‘—ï¼Œä¾ç„¶èŒƒç‰¹ç¨€è¥¿ è¯‘
*   [è°æ‰æ˜¯ ButterKnife çš„ç»ˆç»“è€…ï¼Ÿ](https://blog.csdn.net/vitaviva/article/details/106174193) â€”â€” fundroid è‘—
*   [æ·±å…¥ç ”ç©¶ ViewBinding åœ¨ include, merge, adapter, fragment, activity ä¸­ä½¿ç”¨](https://juejin.cn/post/6844904065655111693) â€”â€” Flywith24 è‘—