---
layout: post
title: "如何优雅的备份MySQL数据？看这篇文章就够了"
date: "2022-10-10T06:02:47.802Z"
---
如何优雅的备份MySQL数据？看这篇文章就够了
=======================

![如何优雅的备份MySQL数据？看这篇文章就够了](https://img2022.cnblogs.com/blog/734446/202210/734446-20221010093247746-1580267084.png) 先说一下为什么需要备份MySQL数据？ 一句话总结就是：为了保证数据的安全性。 如果我们把数据只存储在一个地方，如果物理机器损坏，会导致数据丢失，无法恢复。 还有就是我们每次手动修改线上数据之前，为了安全起见，都需要先备份数据。防止人为的误操作，导致弄脏数据或弄丢数据。

大家好，我是一灯，今天一块学习一下如何优雅安全的备份MySQL数据？

1\. 为什么要备份数据
------------

先说一下为什么需要备份MySQL数据？

一句话总结就是：**为了保证数据的安全性。**

如果我们把数据只存储在一个地方，如果物理机器损坏，会导致数据丢失，无法恢复。

还有就是我们每次手动修改线上数据之前，为了安全起见，都需要先备份数据。防止人为的误操作，导致弄脏数据或弄丢数据。

2\. 怎样备份MySQL数据？
----------------

想要快速简单粗暴备份MySQL数据，可以使用**mysqldump**命令：

    # 备份test数据库
    mysqldump -uroot -p test > backup.db
    

但是这样备份的可能包含脏数据，比如在我们备份数据的过程中，有个下单的操作正在执行。

下单之后，还没有来得及扣款，就开始执行备份数据的命令，就会出现脏数据。

1.  下单，保存订单表
2.  备份数据
3.  扣款

3\. 怎么安全的备份数据？
--------------

mysqldump命令也提供了以事务的形式备份的参数：

    # 开启一个事务备份test数据库
    mysqldump -uroot -p --single-transaction test > backup.db
    

开启事务后，会跟正常业务操作产生锁资源竞争，可能会阻塞其他的业务操作，严重的可能会导致服务宕机，所以备份操作尽量在业务低峰期执行。

还有一个问题，只有InnoDB引擎支持事务命令，对于不支持的事务MyISAM引擎，备份数据的时候怎么保证数据的安全性呢？

有一个粗暴的办法就是设置全库只读，禁止写操作，这样备份的时候不就能保证数据安全性啦。

先用命令查看一下数据库的只读状态：

    show variables like 'read_only';
    

![image](https://img2022.cnblogs.com/blog/734446/202210/734446-20221010093130204-697020415.png)

OFF表示只读模式关闭，ON表示开启只读模式。

    set global read_only=1;
    

![image](https://img2022.cnblogs.com/blog/734446/202210/734446-20221010093140185-1266918729.png)

这样设置其实是非常危险的，如果客户端连接断开，整个数据库也会一直处于只读模式，无法进行写操作。

更推荐的办法是设置**全局锁 FTWRL（flush tables with read lock）**。

    # 设置全局锁，禁止写操作
    flush tables with read lock;
    # 释放锁
    unlock tables;
    

设置全局锁之后，如果客户端断开，会自动释放锁，更安全。

4\. 怎么恢复数据？
-----------

通过备份文件恢复数据也非常简单：

    # 把备份文件数据导入到test数据库
    mysqldump -uroot -p test < backup.db
    

![image](https://img2022.cnblogs.com/blog/734446/202210/734446-20221010093209363-683380325.png)